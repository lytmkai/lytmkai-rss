<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Spring Flux方法总结]]></title>    <link>https://juejin.cn/post/7603643385816547380</link>    <guid>https://juejin.cn/post/7603643385816547380</guid>    <pubDate>2026-02-08T03:51:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603643385816547380" data-draft-id="7603673564908683299" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Flux方法总结"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-08T03:51:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Luke君60797"/> <meta itemprop="url" content="https://juejin.cn/user/3632442148656990"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Flux方法总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3632442148656990/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Luke君60797
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T03:51:18.000Z" title="Sun Feb 08 2026 03:51:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>Flux</code> 的方法非常多（几百个），但你不需要全部记住。我们可以把它们按照“功能”分成几类，就像厨房里不同的工具：</p>
<h3 data-id="heading-0">1. 制造水源（创建操作符）</h3>
<p>用来定义流量的来源。</p>
<ul>
<li><strong><code>just(T... data)</code></strong> ：最直接的，把现成的数据塞进去。</li>
<li><strong><code>fromIterable(Iterable)</code></strong> ：把 <code>List</code> 或 <code>Set</code> 变成 <code>Flux</code>。</li>
<li><strong><code>range(int start, int count)</code></strong> ：生成一个整数序列（如 1 到 100）。</li>
<li><strong><code>interval(Duration)</code></strong> ：<strong>定时器</strong>。每隔一段时间发一个数字（0, 1, 2...），常用于心跳检测。</li>
<li><strong><code>empty()</code></strong> ：直接发送完成信号，水管里啥也没有。</li>
<li><strong><code>error(Throwable)</code></strong> ：直接发送错误信号，水管一通就爆。</li>
</ul>
<hr/>
<h3 data-id="heading-1">2. 加工转换（转化操作符）</h3>
<p>最常用的部分，用来改变流里的数据。</p>
<ul>
<li>
<p><strong><code>map(Function)</code></strong> ：<strong>1对1转换</strong>。把 A 变成 B（如：把“洗洁精”字符串变成 <code>Soap</code> 对象）。</p>
</li>
<li>
<p><strong><code>flatMap(Function)</code></strong> ：<strong>1对N转换（异步）</strong> 。把一个元素变成一个新的 <code>Flux</code>。</p>
<blockquote>
<p><em>比喻：<code>map</code> 是把菜切碎；<code>flatMap</code> 是把一个订单拆成多个物流单，并异步去查每一个物流。</em></p>
</blockquote>
</li>
<li>
<p><strong><code>buffer(int n)</code></strong> ：<strong>打包</strong>。把零散的水滴收集满 <code>n</code> 个，凑成一个 <code>List</code> 再往下流。</p>
</li>
<li>
<p><strong><code>collectList()</code></strong> ：把水管里所有的水都接住，最后装进一个 <code>Mono&lt;List&lt;T&gt;&gt;</code>。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-2">3. 过滤与挑选（过滤操作符）</h3>
<p>决定哪些东西能流过去。</p>
<ul>
<li><strong><code>filter(Predicate)</code></strong> ：符合条件的才让过。</li>
<li><strong><code>distinct()</code></strong> ：<strong>去重</strong>。流过的东西如果重复，只放行第一个。</li>
<li><strong><code>take(long n)</code></strong> ：<strong>只取前 n 个</strong>。拿完就关水龙头。</li>
<li><strong><code>skip(long n)</code></strong> ：跳过前 n 个，从后面开始接。</li>
</ul>
<hr/>
<h3 data-id="heading-3">4. 组合流（组合操作符）</h3>
<p>把多根水管拼在一起。</p>
<ul>
<li>
<p><strong><code>mergeWith(Publisher)</code></strong> ：<strong>合并</strong>。两根管子汇成一根，谁有水谁先流（交错输出）。</p>
</li>
<li>
<p><strong><code>zipWith(Publisher)</code></strong> ：<strong>配对</strong>。左边流出一滴，右边流出一滴，凑成一对（Tuple）再往下走。</p>
<blockquote>
<p><em>比喻：<code>merge</code> 是合流，<code>zip</code> 是相亲，必须两边都有人才成对。</em></p>
</blockquote>
</li>
<li>
<p><strong><code>concatWith(Publisher)</code></strong> ：<strong>首尾相接</strong>。等第一根管子流完了，才开始流第二根。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-4">5. 副作用与生命周期（监听操作符）</h3>
<p>只观察，不干预。</p>
<ul>
<li><strong><code>doOnNext(Consumer)</code></strong> ：数据流过时看一眼（打日志）。</li>
<li><strong><code>doOnError(Consumer)</code></strong> ：出故障时看一眼。</li>
<li><strong><code>doOnComplete(Runnable)</code></strong> ：流完时看一眼。</li>
<li><strong><code>doFinally(Consumer)</code></strong> ：管它成功还是失败，最后都要执行（类似 <code>finally</code> 块）。</li>
</ul>
<hr/>
<h3 data-id="heading-5">6. 错误处理（容错操作符）</h3>
<p>水管爆了之后的救场方案。</p>
<ul>
<li><strong><code>onErrorReturn(T)</code></strong> ：出错了？别报警，直接返回一个默认值。</li>
<li><strong><code>onErrorResume(Function)</code></strong> ：出错了？切到备用水管（另一个 <code>Flux</code>）。</li>
<li><strong><code>retry(long n)</code></strong> ：出错了？再试 <code>n</code> 次。</li>
</ul>
<hr/>
<h3 data-id="heading-6">总结</h3>
<ul>
<li>如果你要<strong>改变</strong>数据：找 <code>map</code>/<code>flatMap</code>。</li>
<li>如果你要<strong>减少</strong>数据：找 <code>filter</code>/<code>take</code>。</li>
<li>如果你要<strong>合并</strong>数据：找 <code>zip</code>/<code>merge</code>。</li>
<li>如果你要<strong>观察</strong>数据：找 <code>doOn...</code> 系列。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[高版本 MySQL 驱动的 DNS 陷阱]]></title>    <link>https://juejin.cn/post/7603674653153525769</link>    <guid>https://juejin.cn/post/7603674653153525769</guid>    <pubDate>2026-02-08T04:24:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603674653153525769" data-draft-id="7603674653153476617" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="高版本 MySQL 驱动的 DNS 陷阱"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-08T04:24:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="define9527"/> <meta itemprop="url" content="https://juejin.cn/user/414960194946937"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            高版本 MySQL 驱动的 DNS 陷阱
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/414960194946937/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    define9527
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T04:24:35.000Z" title="Sun Feb 08 2026 04:24:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>项目使用 OceanBase 数据库，并通过 ShardingSphere JDBC 实现分表。由于 ShardingSphere 当前不支持 <code>jdbc:oceanbase:</code> 协议，我们在代码中将连接串替换为 <code>jdbc:mysql</code> 并引入 MySQL 驱动</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.oceanbase<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>oceanbase-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.4.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shardingsphere-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 问题根源 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>数据源配置如下（关键部分）</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.oceanbase.jdbc.Driver</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:oceanbase:loadbalance://IP:PORT/test?...</span>
    <span class="hljs-attr">druid:</span>
      <span class="hljs-attr">initial-size:</span> <span class="hljs-number">8</span>
      <span class="hljs-attr">max-active:</span> <span class="hljs-number">30</span>
      <span class="hljs-attr">min-idle:</span> <span class="hljs-number">8</span>
</code></pre>

<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShardingDataSourceConfiguration</span> {

    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"${spring.datasource.url}"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> url;

    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"${spring.datasource.username}"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> username;

    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"${spring.datasource.password}"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> password;

    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">DataSource</span>&gt; <span class="hljs-title function_">createDataSourceMap</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">DataSource</span>&gt; dataSourceMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        <span class="hljs-title class_">DruidDataSource</span> dataSource1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DruidDataSource</span>();
        dataSource1.<span class="hljs-title function_">setDriverClassName</span>(<span class="hljs-string">"com.mysql.cj.jdbc.Driver"</span>);
        url = url.<span class="hljs-title function_">replace</span>(<span class="hljs-string">"jdbc:oceanbase"</span>, <span class="hljs-string">"jdbc:mysql"</span>);
        dataSource1.<span class="hljs-title function_">setUrl</span>(url);
        dataSource1.<span class="hljs-title function_">setUsername</span>(username);
        dataSource1.<span class="hljs-title function_">setPassword</span>(password);
        dataSource1.<span class="hljs-title function_">setInitialSize</span>(<span class="hljs-number">8</span>);
        dataSource1.<span class="hljs-title function_">setMaxActive</span>(<span class="hljs-number">30</span>);
        dataSource1.<span class="hljs-title function_">setMinIdle</span>(<span class="hljs-number">8</span>);
        dataSourceMap.<span class="hljs-title function_">put</span>(<span class="hljs-string">"ds_0"</span>, dataSource1);
        <span class="hljs-keyword">return</span> dataSourceMap;
    }

    <span class="hljs-meta">@Bean</span>(<span class="hljs-string">"shardingDataSource"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">DataSource</span> <span class="hljs-title function_">dataSource</span>() throws <span class="hljs-title class_">SQLException</span> {
        <span class="hljs-title class_">Properties</span> props = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
        props.<span class="hljs-title function_">put</span>(<span class="hljs-string">"sql-show"</span>, <span class="hljs-literal">false</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">ShardingSphereDataSourceFactory</span>.<span class="hljs-title function_">createDataSource</span>(
            <span class="hljs-title function_">createDataSourceMap</span>(),
            <span class="hljs-title class_">Collections</span>.<span class="hljs-title function_">singletonList</span>(<span class="hljs-title function_">createShardingRuleConfiguration</span>()),
            props
        );
    }
}
</code></pre>
<p>同时，项目中还有一个未经过 ShardingSphere 的原生 OceanBase 数据源</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceConfiguration</span> {

    <span class="hljs-meta">@Bean(name = <span class="hljs-string">"logAnalysisDataSource"</span>)</span>
    <span class="hljs-keyword">public</span> DataSource logAnalysisDataSource() {
        <span class="hljs-comment">// com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceBuilder</span>
        <span class="hljs-comment">// 使用 spring.datasource 配置来创建数据库连接池</span>
        DruidDataSource druidDataSource = DruidDataSourceBuilder.create().build();
        druidDataSource.setSocketTimeout(<span class="hljs-number">180000</span>);
        druidDataSource.setConnectTimeout(<span class="hljs-number">180000</span>);
        <span class="hljs-keyword">return</span> druidDataSource;
    }
}
</code></pre>
<h2 data-id="heading-1">问题现象</h2>
<p>启动项目时，发现 <code>@Bean("shardingDataSource")</code> 所对应的 DruidDataSource 初始化时间特别长，但 <code>@Bean(name = "logAnalysisDataSource")</code> 所对应的 DruidDataSource 初始化却很快</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[2026-02-07 17:47:32.417]</span> <span class="hljs-selector-attr">[INFO ]</span> <span class="hljs-selector-attr">[com.zaxxer.hikari.HikariDataSource]</span> <span class="hljs-selector-attr">[80]</span> - <span class="hljs-selector-attr">[HikariPool-1 - Starting...]</span>
<span class="hljs-selector-attr">[2026-02-07 17:47:32.739]</span> <span class="hljs-selector-attr">[INFO ]</span> <span class="hljs-selector-attr">[com.zaxxer.hikari.HikariDataSource]</span> <span class="hljs-selector-attr">[82]</span> - <span class="hljs-selector-attr">[HikariPool-1 - Start completed.]</span>

<span class="hljs-selector-attr">[2026-02-07 17:50:22.107]</span> <span class="hljs-selector-attr">[INFO ]</span> <span class="hljs-selector-attr">[com.alibaba.druid.pool.DruidDataSource]</span> <span class="hljs-selector-attr">[1007]</span> - <span class="hljs-selector-attr">[{dataSource-1} inited]</span>

<span class="hljs-selector-attr">[2026-02-07 17:50:34.454]</span> <span class="hljs-selector-attr">[INFO ]</span> <span class="hljs-selector-attr">[com.alibaba.druid.pool.DruidDataSource]</span> <span class="hljs-selector-attr">[1007]</span> - <span class="hljs-selector-attr">[{dataSource-2} inited]</span>

<span class="hljs-selector-attr">[2026-02-07 17:50:35.840]</span> <span class="hljs-selector-attr">[INFO ]</span> <span class="hljs-selector-attr">[com.xxx.WebApplication]</span> <span class="hljs-selector-attr">[61]</span> - <span class="hljs-selector-attr">[Started WebApplication in 188.327 seconds (JVM running for 189.054)]</span>
</code></pre>
<blockquote>
<p>日志中的 HikariDataSource 是 ShardingSphere JDBC 用于操作元数据的内部连接池，其初始化完成至 DruidDataSource#init 执行前的耗时可忽略不计</p>
</blockquote>
<p>启动日志中，<code>{dataSource-1}</code> 对应 <code>@Bean("shardingDataSource")</code>，<code>{dataSource-2}</code> 对应 <code>@Bean(name = "logAnalysisDataSource")</code></p>
<p>从日志可以看出，<code>@Bean("shardingDataSource")</code> 这个 DruidDataSource 对象的初始化时间为 2 分 50 秒，而 <code>@Bean(name = "logAnalysisDataSource")</code> 这个 DruidDataSource 对象的初始化时间为 12 秒，而两者唯一的区别在于底层 JDBC 驱动</p>
<blockquote>
<p>备注：因项目开发环境位于内网，且数据库部署于不同地域，网络延迟较高，数据库连接池初始化耗时 12 秒属正常范围</p>
</blockquote>
<p>跟踪 Druid 源码发现，耗时主要集中在 <code>createPhysicalConnection()</code> 方法执行过程中，该方法负责建立底层物理数据库连接</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DruidDataSource</span> <span class="hljs-title">extends</span> <span class="hljs-title">DruidAbstractDataSource</span> <span class="hljs-title">implements</span> <span class="hljs-title">DruidDataSourceMBean</span>, <span class="hljs-type">ManagedDataSource</span>, <span class="hljs-type">Referenceable</span>, <span class="hljs-type">Closeable</span>, <span class="hljs-type">Cloneable</span>, <span class="hljs-type">ConnectionPoolDataSource</span>, <span class="hljs-type">MBeanRegistration</span> {

    <span class="hljs-keyword">public</span> void <span class="hljs-keyword">init</span>() throws SQLException {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (createScheduler != <span class="hljs-literal">null</span> &amp;&amp; asyncInit) {
                <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; initialSize; ++i) {
                    submitCreateTask(<span class="hljs-literal">true</span>);
                }
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!asyncInit) {
                <span class="hljs-comment">// init connections</span>
                <span class="hljs-keyword">while</span> (poolingCount &lt; initialSize) {
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-comment">// 慢在这里</span>
                        PhysicalConnectionInfo pyConnectInfo = createPhysicalConnection();
                        DruidConnectionHolder holder = new DruidConnectionHolder(<span class="hljs-keyword">this</span>, pyConnectInfo);
                        connections[poolingCount++] = holder;
                    } <span class="hljs-keyword">catch</span> (SQLException ex) {

                    }
                }
            }
        } <span class="hljs-keyword">finally</span> {
            inited = <span class="hljs-literal">true</span>;
            lock.unlock();
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">init</span> &amp;&amp; LOG.isInfoEnabled()) {
                String msg = <span class="hljs-string">"{dataSource-"</span> + <span class="hljs-keyword">this</span>.getID();
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.name != <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-keyword">this</span>.name.isEmpty()) {
                    msg += <span class="hljs-string">","</span>;
                    msg += <span class="hljs-keyword">this</span>.name;
                }
                msg += <span class="hljs-string">"} inited"</span>;
                <span class="hljs-comment">// 打印日志</span>
                LOG.info(msg);
            }
        }
    }
}
</code></pre>
<p>继续跟踪源码，最终定位到问题源于 MySQL 驱动在创建连接时调用 <code>InetSocketAddress.getHostName()</code> 进行反向 DNS 解析，耗时显著，导致连接初始化缓慢</p>
<p>完整的链路：<code>DruidAbstractDataSource#createPhysicalConnection</code> =&gt; ... =&gt; <code>com.mysql.cj.jdbc.ConnectionImpl#getInstance(HostInfo hostInfo)</code> =&gt; <code>ConnectionImpl</code> 构造方法</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.mysql.cj.jdbc;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionImpl</span> <span class="hljs-title">implements</span> <span class="hljs-title">JdbcConnection</span>, <span class="hljs-type">SessionEventListener</span>, <span class="hljs-type">Serializable</span> {
    <span class="hljs-keyword">public</span> ConnectionImpl(HostInfo hostInfo) throws SQLException {
        <span class="hljs-keyword">try</span> {
            SocketAddress socketAddress = <span class="hljs-keyword">this</span>.session.getRemoteSocketAddress();
            <span class="hljs-keyword">if</span> (InetSocketAddress.<span class="hljs-keyword">class</span>.isInstance(socketAddress)) {
                InetSocketAddress inetSocketAddress = (InetSocketAddress) socketAddress;
                <span class="hljs-comment">// 关键</span>
                <span class="hljs-keyword">this</span>.connectionSpan.setAttribute(
                    TelemetryAttribute.NETWORK_PEER_ADDRESS,
                    <span class="hljs-comment">// 获取 hostname 字段值</span>
                    inetSocketAddress.getHostName()
                );
            }
        }
    }
}
</code></pre>

<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> java.net;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InetSocketAddress</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SocketAddress</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">transient</span> InetSocketAddressHolder holder;

    <span class="hljs-comment">// Private implementation class pointed to by all public methods.</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InetSocketAddressHolder</span> {
        <span class="hljs-comment">// The hostname of the Socket Address</span>
        <span class="hljs-keyword">private</span> String hostname;
        <span class="hljs-comment">// The IP address of the Socket Address</span>
        <span class="hljs-keyword">private</span> InetAddress addr;
        <span class="hljs-comment">// The port number of the Socket Address</span>
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;

        <span class="hljs-keyword">private</span> <span class="hljs-title function_">InetSocketAddressHolder</span><span class="hljs-params">(String hostname, InetAddress addr, <span class="hljs-type">int</span> port)</span> {
            <span class="hljs-built_in">this</span>.hostname = hostname;
            <span class="hljs-built_in">this</span>.addr = addr;
            <span class="hljs-built_in">this</span>.port = port;
        }

        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getPort</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> port;
        }

        <span class="hljs-keyword">private</span> InetAddress <span class="hljs-title function_">getAddress</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> addr;
        }

        <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getHostName</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (hostname != <span class="hljs-literal">null</span>)
                <span class="hljs-keyword">return</span> hostname;
            <span class="hljs-keyword">if</span> (addr != <span class="hljs-literal">null</span>)
                <span class="hljs-comment">// ⚠️ 触发反向 DNS 解析！内网无 DNS 服务 → 阻塞超时</span>
                <span class="hljs-keyword">return</span> addr.getHostName();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-comment">/**
     * Gets the {<span class="hljs-doctag">@code</span> hostname}.
     * Note: This method may trigger a name service reverse lookup if the
     * address was created with a literal IP address.
     *
     * <span class="hljs-doctag">@return</span>  the hostname part of the address.
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String <span class="hljs-title function_">getHostName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> holder.getHostName();
    }
}
</code></pre>
<p>在网上搜了下，有如下的文章片段</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 解决 Linux 上 Java 获取 hostname 很慢的问题</span>

在 Linux 环境中运行 Java 应用时，有时会遇到 <span class="hljs-code">`InetAddress.getLocalHost().getHostName()`</span> 方法执行缓慢的问题，严重影响应用启动速度

<span class="hljs-section">## 问题原因</span>
Java 在调用 <span class="hljs-code">`getHostName()`</span> 时，会尝试对本机 IP 地址进行<span class="hljs-strong">**反向 DNS 解析（PTR 查询）**</span>，以获取主机名，若 DNS 服务器不可达、无 PTR 记录或网络延迟高，该操作将长时间阻塞

<span class="hljs-section">## 常见场景</span>
<span class="hljs-bullet">-</span> Docker / K8S 容器中未配置 DNS
<span class="hljs-bullet">-</span> 内部网络无反向解析支持
<span class="hljs-bullet">-</span> 使用纯 IP 地址连接数据库（如 MySQL）
</code></pre>
<p>真相大白！我的项目开发环境位于公司内网，完全无法访问外网，更无外部 DNS 服务支持，以下为尝试 ping 外网的输出结果</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable">$ </span>ping www.baidu.com
<span class="hljs-title class_">Ping</span> 请求找不到主机 www.baidu.com。请检查该名称，然后重试。
</code></pre>
<p>那怎么解释 <code>@Bean(name = "logAnalysisDataSource")</code> 这个 DruidDataSource 对象的初始化时间仅 12 秒呢？这是因为它使用的是 <code>jdbc:oceanbase</code> 协议与 <code>oceanbase-client</code> 驱动，这个驱动在连接建立过程中不会调用 <code>InetSocketAddress.getHostName()</code> 方法（没看源码，仅为猜测，但八九不离十）</p>
<p>如何解决这个问题呢？有如下两种方法（网上说添加几个 JVM 参数就能解决，实测无效）</p>
<blockquote>
<p>上述问题在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fqq_33919114%2Farticle%2Fdetails%2F143167989" target="_blank" title="https://blog.csdn.net/qq_33919114/article/details/143167989" ref="nofollow noopener noreferrer">SpringBoot 3 Druid 启动慢排查，SpringBoot 启动慢、服务偶发接口慢查询，MySQL Connector-j 9.0.0 版本问题，getHostName() 请求慢</a> 这篇文章中也提到了</p>
</blockquote>
<h2 data-id="heading-2">解决办法一：修改 hosts 文件</h2>
<ul>
<li>修改 hosts 文件，添加域名映射</li>
</ul>

<pre><code class="hljs language-makefile" lang="makefile">10.xxx.xxx.146 www.<span class="hljs-keyword">define</span>.com
</code></pre>
<ul>
<li>从启动日志可以看出，问题完美解决</li>
</ul>

<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[2026-02-07 18:44:04.258]</span> <span class="hljs-selector-attr">[INFO ]</span> <span class="hljs-selector-attr">[com.zaxxer.hikari.HikariDataSource]</span> <span class="hljs-selector-attr">[80]</span> - <span class="hljs-selector-attr">[HikariPool-1 - Starting...]</span>
<span class="hljs-selector-attr">[2026-02-07 18:44:04.582]</span> <span class="hljs-selector-attr">[INFO ]</span> <span class="hljs-selector-attr">[com.zaxxer.hikari.HikariDataSource]</span> <span class="hljs-selector-attr">[82]</span> - <span class="hljs-selector-attr">[HikariPool-1 - Start completed.]</span>

<span class="hljs-selector-attr">[2026-02-07 18:44:09.426]</span> <span class="hljs-selector-attr">[INFO ]</span> <span class="hljs-selector-attr">[com.alibaba.druid.pool.DruidDataSource]</span> <span class="hljs-selector-attr">[1007]</span> - <span class="hljs-selector-attr">[{dataSource-1} inited]</span>

<span class="hljs-selector-attr">[2026-02-07 18:44:22.180]</span> <span class="hljs-selector-attr">[INFO ]</span> <span class="hljs-selector-attr">[com.alibaba.druid.pool.DruidDataSource]</span> <span class="hljs-selector-attr">[1007]</span> - <span class="hljs-selector-attr">[{dataSource-2} inited]</span>

<span class="hljs-selector-attr">[2026-02-07 18:44:23.552]</span> <span class="hljs-selector-attr">[INFO ]</span> <span class="hljs-selector-attr">[com.xxx.WebApplication]</span> <span class="hljs-selector-attr">[61]</span> - <span class="hljs-selector-attr">[Started WebApplication in 24.191 seconds (JVM running for 24.92)]</span>
</code></pre>
<ul>
<li>原理：因 <code>InetAddress.getHostName()</code> 在本地 hosts 有映射时会<strong>跳过网络 DNS 查询</strong>，从而避免阻塞</li>
</ul>
<h2 data-id="heading-3">解决办法二：降低 MySQL 驱动版本</h2>
<ul>
<li>降低至 8.0.33 版本，实测有效</li>
</ul>

<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.33<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<ul>
<li>从启动日志可以看出，问题完美解决</li>
</ul>

<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[2026-02-07 18:51:19.582]</span> <span class="hljs-selector-attr">[INFO ]</span> <span class="hljs-selector-attr">[com.zaxxer.hikari.HikariDataSource]</span> <span class="hljs-selector-attr">[80]</span> - <span class="hljs-selector-attr">[HikariPool-1 - Starting...]</span>
<span class="hljs-selector-attr">[2026-02-07 18:51:19.899]</span> <span class="hljs-selector-attr">[INFO ]</span> <span class="hljs-selector-attr">[com.zaxxer.hikari.HikariDataSource]</span> <span class="hljs-selector-attr">[82]</span> - <span class="hljs-selector-attr">[HikariPool-1 - Start completed.]</span>

<span class="hljs-selector-attr">[2026-02-07 18:51:24.718]</span> <span class="hljs-selector-attr">[INFO ]</span> <span class="hljs-selector-attr">[com.alibaba.druid.pool.DruidDataSource]</span> <span class="hljs-selector-attr">[1007]</span> - <span class="hljs-selector-attr">[{dataSource-1} inited]</span>

<span class="hljs-selector-attr">[2026-02-07 18:51:37.035]</span> <span class="hljs-selector-attr">[INFO ]</span> <span class="hljs-selector-attr">[com.alibaba.druid.pool.DruidDataSource]</span> <span class="hljs-selector-attr">[1007]</span> - <span class="hljs-selector-attr">[{dataSource-2} inited]</span>

<span class="hljs-selector-attr">[2026-02-07 18:51:38.433]</span> <span class="hljs-selector-attr">[INFO ]</span> <span class="hljs-selector-attr">[com.xxx.WebApplication]</span> <span class="hljs-selector-attr">[61]</span> - <span class="hljs-selector-attr">[Started WebApplication in 23.6 seconds (JVM running for 24.33)]</span>
</code></pre>
<ul>
<li>翻看 8.0.33 中 ConnectionImpl 的源码，不会调用 <code>InetSocketAddress.getHostName()</code> 方法</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/385985b131054048b8d265fcc2b1d816~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGVmaW5lOTUyNw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771129772&amp;x-signature=sm9g23yDAn6PgmNqT8O42SFGnis%3D" alt="1770436368060.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 Vue.js 渲染机制：从声明式到虚拟 DOM 的完整实现]]></title>    <link>https://juejin.cn/post/7603644943351726086</link>    <guid>https://juejin.cn/post/7603644943351726086</guid>    <pubDate>2026-02-08T04:36:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603644943351726086" data-draft-id="7603781883973271571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 Vue.js 渲染机制：从声明式到虚拟 DOM 的完整实现"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-02-08T04:36:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="EchoEcho"/> <meta itemprop="url" content="https://juejin.cn/user/2920774267837208"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 Vue.js 渲染机制：从声明式到虚拟 DOM 的完整实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2920774267837208/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    EchoEcho
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T04:36:23.000Z" title="Sun Feb 08 2026 04:36:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">相关概念：</h2>
<h3 data-id="heading-1">命令式 VS 声明式</h3>
<p>从范式上来看，视图层框架通常分为：</p>
<ul>
<li><strong>命令式框架</strong>
<ul>
<li>更加<strong>关注过程</strong>，代码本身描述的是“做事的过程”，符合逻辑直觉</li>
<li>
<pre><code class="hljs language-dart" lang="dart">  <span class="hljs-comment">// 自然语言描述能够与代码产生一一对应的关系</span>
  <span class="hljs-comment">// 示例：</span>
  <span class="hljs-keyword">const</span> div = <span class="hljs-built_in">document</span>.<span class="hljs-built_in">querySelector</span>(<span class="hljs-string">'#app'</span>) <span class="hljs-comment">// 获取div</span>
  div.innerText = <span class="hljs-string">'hello world'</span><span class="hljs-comment">// 设置文本内容</span>
  div.addEventListener(<span class="hljs-string">'click'</span>, () =&gt; { alert(<span class="hljs-string">'ok'</span>) }) <span class="hljs-comment">// 绑定点击事件</span>
</code></pre>
</li>
</ul>
</li>
<li><strong>声明式框架</strong>
<ul>
<li>更加<strong>关注结果</strong>，主要是提升代码的可维护性</li>
<li>
<pre><code class="hljs language-less" lang="less">  <span class="hljs-comment">// 用户提供一个“预期的结果”，中间的过程由vue.js实现</span>
  <span class="hljs-comment">// 示例</span>
  &lt;<span class="hljs-selector-tag">div</span> @<span class="hljs-selector-tag">click</span>="()  =&gt; <span class="hljs-selector-tag">alert</span>(<span class="hljs-string">'ok'</span>)"&gt;<span class="hljs-selector-tag">hello</span> <span class="hljs-selector-tag">world</span>&lt;/<span class="hljs-selector-tag">div</span>&gt;
</code></pre>
</li>
<li>更新时性能消耗 = 找出差异的性能消耗 + 直接修改的性能消耗</li>
</ul>
</li>
</ul>
<p>因为声明式框架在更新时比命令式框架多了“<strong>找出差异</strong>”的过程，所以声明式代码的性能不会优于命令式代码的性能。而对比命令式代码，声明式代码又具有更强的可维护性，更加的直观。所以框架要做的就是：<strong>在保持可维护性的同时让性能损失最小化</strong>。</p>
<p>在开发过程中，原生<code>JS</code>操作DOM，虚拟DOM和<code>innerHTML</code>三者操作页面的性能都与创建页面、更新页面，页面大小、变更部分的大小有关系，选择哪种更新策略，需要结合心智负担、可维护性等因素综合考虑。</p>
<p><strong>性能对比</strong></p>

































<table><thead><tr><th>更新策略</th><th>心智负担</th><th>可维护性</th><th>性能</th><th>适用场景</th></tr></thead><tbody><tr><td>原生<code>JS</code></td><td>高</td><td>低</td><td>最高</td><td>简单页面</td></tr><tr><td>虚拟DOM</td><td>中</td><td>高</td><td>中</td><td>复杂应用</td></tr><tr><td><code>innerHTML</code></td><td>低</td><td>中</td><td>低</td><td>静态内容</td></tr></tbody></table>
<h3 data-id="heading-2">运行时 VS 编译时</h3>
<blockquote>
<p>以上文中声明式框架示例代码为例，简单描述<code>vue.js</code>的渲染过程：</p>
<p>1、通过<strong>编译器【compile】</strong> 解析模版字符串识别到需要创建一个DOM元素，设置内容为<code>hello world</code>，并为其绑定一个点击事件，完成后输出一个虚拟DOM【即一个描述真实DOM的<code>js</code>对象】</p>
<p>2、通过<strong>渲染函数【render】</strong> 将虚拟DOM渲染成真实的DOM树挂载到指定元素上，完成渲染</p>
</blockquote>
<p>当设计一个框架的时候，有三种选择</p>
<ul>
<li>纯运行时
<ul>
<li>上面提到的如果<strong>只用渲染函数</strong>，由用户直接提供虚拟DOM作为入参，就是所谓的<strong>纯运行时框架</strong></li>
<li>没有编译过程，也就无法添加相关的优化手段，比如tree-shaking</li>
</ul>
</li>
<li>运行时 + 编译时
<ul>
<li>代码运行时由编译器将语义化代码编译成目标数据并作为渲染函数的入参，这种操作就是 <strong>运行时编译框架</strong>。它既支持运行时【即用户直接提供数据对象】，又支持编译时【即将用户语义化代码编译为目标数据】</li>
<li>由于代码运行时才开始编译会产生一定的性能开销，因此可以在构建时就执行编译操作，以提升性能。【在 Vue 3.5.22 中，运行时编译通过 <code>@vue/compiler-dom</code> 实现，构建时编译通过 <code>@vitejs/plugin-vue</code> 实现】</li>
</ul>
</li>
<li>纯编译时
<ul>
<li>如果省略上面的渲染函数，直接将用户代码通过编译器完成真实DOM的渲染，就是一个纯编译时框架。即不支持任何运行时内容。</li>
<li>由于不需要任何运行时，而是直接将代码编译成可执行的<code>js</code>代码，因为性能可能会更好，但是有损灵活性。</li>
</ul>
</li>
</ul>
<p><code>Vue.js</code>就是内部封装了命令式代码从而实现的面向用户的声明式框架；是运行时+编译时架构，目的在于保持灵活性的基础上尽可能的优化性能</p>
<p>其中组件的实现依赖于<strong>渲染器</strong>，组件中模板的编译依赖于<strong>编译器</strong>。<strong>虚拟DOM</strong>作为媒介在整个渲染过程中作为组件真实DOM的载体协助实现内容渲染和更新。</p>
<h3 data-id="heading-3">虚拟DOM【<code>vnode</code>】</h3>
<p>虚拟DOM 是一个用来描述真实DOM的<code>js</code>对象。</p>
<p>使用虚拟DOM的好处是可以将不同类型的标签、属性及子节点抽象成一个对象，这样描述<code>UI</code>可以更加灵活。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 上文中的代码可以用以下形式表示</span>
<span class="hljs-keyword">const</span> vnode= {
    <span class="hljs-comment">// 标签名称</span>
    <span class="hljs-attr">tag</span>: <span class="hljs-string">'div'</span>,
    <span class="hljs-comment">// 标签属性</span>
    <span class="hljs-attr">props</span>: {
        <span class="hljs-attr">onClick</span>: <span class="hljs-function">() =&gt;</span><span class="hljs-title function_">alert</span>(<span class="hljs-string">'ok'</span>)
    },
    <span class="hljs-comment">// 子节点</span>
    <span class="hljs-attr">children</span>: <span class="hljs-string">'hello world'</span>
}
</code></pre>
<blockquote>
<p><code>vue</code>中的<code>h</code>函数就是一个辅助创建虚拟DOM的工具函数</p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { h } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(<span class="hljs-string">'div'</span>, { <span class="hljs-attr">onClick</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">alert</span>(<span class="hljs-string">'ok'</span>) }, <span class="hljs-string">'hello world'</span>)
    }
}

<span class="hljs-comment">// 等价于</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">tag</span>: <span class="hljs-string">'div'</span>,
            <span class="hljs-attr">props</span>: {
                <span class="hljs-attr">onClick</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">alert</span>(<span class="hljs-string">'ok'</span>)
            },
            <span class="hljs-attr">children</span>: <span class="hljs-string">'hello world'</span>
        }
    }
}

<span class="hljs-comment">// 等价于</span>
&lt;div <span class="hljs-meta">@click</span>=<span class="hljs-string">"() =&gt; alert('ok')"</span>&gt;hello world&lt;/div&gt;
</code></pre>
<p>虚拟DOM的性能优势：</p>
<ul>
<li>批量更新：可以将多次DOM操作合并为一次</li>
<li>跨平台：同一套代码可以渲染到不同平台</li>
<li>优化策略：通过<code>diff</code>算法最小化DOM操作</li>
</ul>
<h3 data-id="heading-4">组件</h3>
<p>组件就是一组DOM元素的封装，它可以是一个返回虚拟DOM的函数，也可以是一个对象。组件的返回值也是虚拟DOM，它代表组件要渲染的内容。</p>
<h3 data-id="heading-5">编译器【compile】</h3>
<p>编译器的作用是将组件模板【<code>&lt;template&gt;</code>】编译为渲染函数并添加到<code>&lt;script&gt;</code>标签块的组件对象上</p>
<pre><code class="hljs language-xml" lang="xml">// demo.vue
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
&lt;div@click="handler"&gt;
        hello world
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
exportdefault {
        <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) { }
        <span class="hljs-attr">methods</span>: {
            <span class="hljs-attr">handler</span>: <span class="hljs-function">() =&gt;</span><span class="hljs-title function_">alert</span>(<span class="hljs-string">'ok'</span>)
        }
    }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>组件编译后结果：</p>
<pre><code class="hljs language-javascript" lang="javascript">exportdefault {
    <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {},
    <span class="hljs-attr">methods</span>: {
        <span class="hljs-attr">handler</span>: <span class="hljs-function">() =&gt;</span><span class="hljs-title function_">alert</span>(<span class="hljs-string">'ok'</span>)
    },
    <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">_createElementVNode</span>(<span class="hljs-string">'div'</span>, { <span class="hljs-attr">onClick</span>: handler }, <span class="hljs-string">'hello world'</span>, -<span class="hljs-number">1</span><span class="hljs-comment">/* HOISTED */</span>)
    }
}
</code></pre>
<p>无论是使用模板还是直接手写渲染函数，对于一个组件来说，它要渲染的内容最终都是通过渲染函数产生的。然后再将渲染函数返回的虚拟DOM作为渲染器的入参，进行真实DOM的渲染</p>
<p><code>Vue3</code>的编译优化：</p>
<ul>
<li>静态提升：将静态内容提升到渲染函数外部</li>
<li>补丁标记：为动态内容添加标记，优化<code>diff</code>过程【通过在虚拟DOM中添加标记实现】</li>
<li><code>tree-shaking</code>：移除未使用代码</li>
</ul>
<h3 data-id="heading-6">渲染器【renderer】</h3>
<p>渲染器的作用就是递归遍历虚拟DOM对象，并调用原生<code>DOM API</code>来完成真实DOM的创建。</p>
<p>渲染器的精髓在于后续的更新，它会通过<code>Diff</code>算法寻找并且只更新变化内容。</p>
<p>大致实现思路如下：</p>
<ul>
<li>如果不是内容变更：</li>
<li>
<ul>
<li>根据<code>vnode.tag</code>创建对应DOM元素</li>
<li>遍历<code>vnode.props</code>对象，如果<code>key</code>以<code>on</code>字符开头，说明它是一个事件，调用<code>addEventListener</code>绑定事件处理函数；否则作为属性添加到DOM元素上</li>
<li>处理<code>children</code>，如果是字符串，就创建文本节点；如果是数组就递归调用<code>render</code>继续渲染，最后把创建的元素挂载到新创建的元素内</li>
</ul>
</li>
</ul>

<ul>
<li>否则先找出<code>vnode</code>对象的变更点，并且只更新变更的内容</li>
</ul>
<h3 data-id="heading-7">组件渲染过程详解：</h3>
<h5 data-id="heading-8"><code>vite</code>、<code>@vitejs/plugin-vue</code>和<code>vue-core</code>的关系</h5>
<ul>
<li>
<p><code>vite</code>中使用了<code>@vitejs/plugin-vue</code>来处理<code>vue</code>组件</p>
</li>
<li>
<p><code>@vitejs/plugin-vue</code>中集成了<code>vue-core</code>中的<code>compiler-sfc</code>用于解析编译<code>Vue</code>组件</p>
</li>
<li>
<p><code>compiler-sfc</code>中调用了<code>compiler-core</code>中的基础逻辑进行组件的编译和渲染</p>
</li>
</ul>
<p>当我们新建并启动<code>vue</code>项目后，内容是如何渲染的，又是如何实时更新的？</p>
<h4 data-id="heading-9">创建并启动一个<code>Vue</code>应用 </h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 创建新项目</span>
npm create vue@latest
<span class="hljs-comment">// 进入项目后安装依赖</span>
npm install
<span class="hljs-comment">// 启动，实际执行的是vite命令</span>
npm run dev
</code></pre>
<h4 data-id="heading-10">当项目运行<code>npm run dev</code>命令时执行内容如下：</h4>
<h4 data-id="heading-11">编译阶段：</h4>
<h5 data-id="heading-12">启动一个<code>vite</code>开发服务器，浏览器会通过这个服务器来访问此项目的网页和代码</h5>
<p><code>vite</code>是一个通用的构建工具，<code>vite</code>本身并不直接处理<code>.vue</code>文件，而是通过插件系统来处理各种类型文件，其中<code>@vitejs/plugin-vue</code>就是用来处理<code>vue</code>单文件组件的</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2284b50fb4e44ecf82dc5f4f566f79d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWNob0VjaG8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771130182&amp;x-signature=AavXU%2B6fWQqANaT9e4c2mzqjgv8%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-13">构建时阶段</h4>
<p><code>Vite</code>接收到组件请求，会执行插件【<code>@vitejs/plugin-vue</code>】的<code>load</code>钩子函数，再执行<code>Transform</code>钩子函数</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cf498d2125e4627a484df191975b452~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWNob0VjaG8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771130182&amp;x-signature=e9M3QhwkXxxJqjhJldPe1Yh7keQ%3D" alt="图片" loading="lazy"/></p>
<p>在上图钩子函数执行过程中触发了<code>compiler-sfc</code>相关方法的执行</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09df4edbc402409e937d769740850d74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWNob0VjaG8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771130182&amp;x-signature=RUiB%2B7mQIj5jXah01ftQpboNZGE%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ea11c3f85d34604b44722b154aca173~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWNob0VjaG8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771130182&amp;x-signature=8KxgD1chNHz7Q%2FBEFdHKTzN54Ss%3D" alt="图片" loading="lazy"/></p>
<h5 data-id="heading-14">监听组件变化</h5>
<p><code>@Vitejs/plugin-vue</code>插件的核心入口文件【<code>packages/plugin-vue/src/index.ts</code>】中定义了<code>Vite</code>插件的所有钩子函数，其中<code>handleHotUpdate</code>钩子是<code>Vite</code>提供的热更新处理函数，当<code>Vue</code>文件发生变化时，<code>Vite</code>会自动调用这个钩子，此时插件会检查变化的文件是否为<code>Vue</code>组件，如果是则调用专门的<code>handleHotUpdate函数</code>【<code>packages/plugin-vue/src/handleHotUpdate.ts</code>】</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c129e02641f14c62ad5dbc3c1a888d4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWNob0VjaG8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771130182&amp;x-signature=MUFBcSJ%2FoHSh66u64Jt1zUsFrZg%3D" alt="图片" loading="lazy"/></p>
<p>最终将返回</p>
<pre><code class="hljs language-c" lang="c">SFCTemplateCompileResults ： {
    code: <span class="hljs-built_in">string</span>, <span class="hljs-comment">// 渲染函数代码</span>
    ast?: RootNode, <span class="hljs-comment">// 抽象语法树</span>
    preamble?: <span class="hljs-built_in">string</span>, <span class="hljs-comment">// 预处理代码</span>
    source: <span class="hljs-built_in">string</span>, <span class="hljs-comment">// 输入源</span>
    tips: <span class="hljs-built_in">string</span>[], <span class="hljs-comment">// 提示</span>
    errors: (<span class="hljs-built_in">string</span> | CompilerError)[], <span class="hljs-comment">// 错误</span>
    <span class="hljs-built_in">map</span>?: RawSourceMap, <span class="hljs-comment">// 源映射</span>
}
</code></pre>
<p>这个阶段会将<code>.vue</code>文件转换为<code>js</code>代码，生成的是渲染函数的字符串</p>
<h4 data-id="heading-15">运行时阶段</h4>
<p>当浏览器加载并执行这些<code>js</code>代码时，就会发生真正的渲染过程</p>
<pre><code class="hljs language-scss" lang="scss">应用启动 -&gt; <span class="hljs-built_in">createApp</span>() -&gt; app<span class="hljs-selector-class">.mount</span>() -&gt; <span class="hljs-built_in">render</span>() -&gt; <span class="hljs-built_in">patch</span>() -&gt; <span class="hljs-built_in">mountElement</span>() -&gt; 真实DOM
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59b801a153e24563ae174e29b29b870e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWNob0VjaG8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771130182&amp;x-signature=I5TwTb1ZBF42SwbAYwPJX7dWxiA%3D" alt="图片" loading="lazy"/></p>
<p>到此就完成了<code>vue</code>中基本的渲染过程。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[主管:”人家 Node 框架都用 Nest.js 了 , 你怎么还在用 Express ?“]]></title>    <link>https://juejin.cn/post/7603688142004617225</link>    <guid>https://juejin.cn/post/7603688142004617225</guid>    <pubDate>2026-02-08T04:43:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603688142004617225" data-draft-id="7603651855236595721" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="主管:”人家 Node 框架都用 Nest.js 了 , 你怎么还在用 Express ?“"/> <meta itemprop="keywords" content="前端,后端,面试"/> <meta itemprop="datePublished" content="2026-02-08T04:43:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="千寻girling"/> <meta itemprop="url" content="https://juejin.cn/user/2276467567770442"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            主管:”人家 Node 框架都用 Nest.js 了 , 你怎么还在用 Express ?“
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2276467567770442/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    千寻girling
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T04:43:22.000Z" title="Sun Feb 08 2026 04:43:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>我反驳主管道 : “我自己做项目做着玩 ! 你管我用哪一个 !”</p>
</blockquote>
<blockquote>
<p>回家之后 , 我开始好奇那么多 Node 框架 , 到底有什么区别啊?</p>
</blockquote>
<blockquote>
<p>Node.js Web 框架各式各样 , 下面简单的介绍一下这些 Node.js Web 框架 !</p>
</blockquote>
<h3 data-id="heading-0">一、分类</h3>
<p>Node.js Web 框架主要分 3 类：</p>



































<table><thead><tr><th>分类</th><th>核心特点</th><th>代表框架</th><th>适用场景</th></tr></thead><tbody><tr><td>极简核心框架</td><td>仅封装 HTTP 基础能力，无冗余功能</td><td><strong>Express、Koa</strong></td><td>中小型 API、自定义业务系统</td></tr><tr><td>全栈 / 企业级框架</td><td>内置路由、ORM、验证、鉴权等全套能力</td><td><strong>NestJS、AdonisJS</strong></td><td>大型企业应用、团队协作项目</td></tr><tr><td>高性能框架</td><td>基于异步 I/O/ 编译优化，极致性能</td><td><strong>Fastify、Hapi</strong></td><td>高并发 API、微服务</td></tr><tr><td>特殊场景框架</td><td>针对特定场景优化（如 SSR、低代码）</td><td><strong>Next.js、Nuxt.js（Node 端）、Sails.js</strong></td><td>前端 SSR、低代码平台</td></tr></tbody></table>
<h3 data-id="heading-1">二、主流框架详细介绍</h3>
<blockquote>
<p>⚠️ : 排名不分先后顺序</p>
</blockquote>
<h4 data-id="heading-2">1. Express（最经典的极简框架）</h4>
<ul>
<li>
<p><strong>核心定位</strong>：Node.js Web 框架的 “鼻祖”，极简、灵活，无内置冗余功能，生态最丰富。</p>
</li>
<li>
<p><strong>核心特性</strong>：</p>
<ul>
<li>中间件机制（线性中间件，<code>req -&gt; 中间件1 -&gt; 中间件2 -&gt; res</code>）；</li>
<li>简洁的路由系统；</li>
<li>无内置 ORM / 验证，需手动集成第三方库（如 <code>mongoose</code>、<code>express-validator</code>）。</li>
</ul>
</li>
<li>
<p><strong>示例代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();

<span class="hljs-comment">// 中间件</span>
app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>());

<span class="hljs-comment">// 路由</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/user'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">20</span> });
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Express 启动在 3000 端口'</span>));
</code></pre>
</li>
<li>
<p><strong>优点</strong>：生态极全（几乎所有 Node 库都兼容）、学习成本低、灵活度高；</p>
</li>
<li>
<p><strong>缺点</strong>：回调嵌套（易出现 “回调地狱”）、无内置类型支持（TS 需手动配置）、无统一规范（团队协作易混乱）；</p>
</li>
<li>
<p><strong>适用场景</strong>：中小型 API 服务、快速原型开发、个人项目。</p>
</li>
</ul>
<h4 data-id="heading-3">2. Koa（Express 团队升级版）</h4>
<ul>
<li>
<p><strong>核心定位</strong>：Express 原团队开发，解决 Express 回调地狱问题，基于 <code>async/await</code> 重构。</p>
</li>
<li>
<p><strong>核心特性</strong>：</p>
<ul>
<li>洋葱模型中间件（中间件可双向执行，如 “请求进来执行 -&gt; 响应出去再执行”）；</li>
<li>原生支持 <code>async/await</code>，无回调地狱；</li>
<li>比 Express 更精简（甚至没有内置路由，需装 <code>koa-router</code>）。</li>
</ul>
</li>
<li>
<p><strong>示例代码</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">Koa</span> = require(<span class="hljs-string">'koa'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">koaRouter</span> = require(<span class="hljs-string">'koa-router'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">koaBody</span> = require(<span class="hljs-string">'koa-body'</span>)<span class="hljs-comment">;</span>

const <span class="hljs-attr">app</span> = new Koa()<span class="hljs-comment">;</span>
const <span class="hljs-attr">router</span> = new koaRouter()<span class="hljs-comment">;</span>

// 洋葱模型中间件
app.use(async (ctx, next) =&gt; {
  console.log('请求开始')<span class="hljs-comment">;</span>
  await next()<span class="hljs-comment">; // 执行下一个中间件</span>
  console.log('请求结束')<span class="hljs-comment">; // 响应时执行</span>
})<span class="hljs-comment">;</span>

app.use(koaBody())<span class="hljs-comment">;</span>
router.get('/api/user', async (ctx) =&gt; {
  <span class="hljs-attr">ctx.body</span> = { name: <span class="hljs-string">'张三'</span>, age: <span class="hljs-number">20</span> }<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>

app.use(router.routes())<span class="hljs-comment">;</span>
app.listen(3000, () =&gt; console.log('Koa 启动在 3000 端口'))<span class="hljs-comment">;</span>
</code></pre>
</li>
<li>
<p><strong>优点</strong>：异步体验好、洋葱模型灵活（适合日志 / 鉴权 / 异常捕获）、轻量；</p>
</li>
<li>
<p><strong>缺点</strong>：生态比 Express 略少、需手动集成更多第三方库；</p>
</li>
<li>
<p><strong>适用场景</strong>：中小型 API 服务、需要灵活中间件的场景、嫌弃 Express 回调的项目。</p>
</li>
</ul>
<h4 data-id="heading-4">3. NestJS（企业级 TypeScript 框架）</h4>
<ul>
<li>
<p><strong>核心定位</strong>：对标 Spring Boot，基于 TypeScript，强调模块化、依赖注入，适合大型团队协作。</p>
</li>
<li>
<p><strong>核心特性</strong>：</p>
<ul>
<li>强制 TypeScript 开发，类型安全；</li>
<li>模块化架构（Module + Controller + Service）；</li>
<li>内置依赖注入、拦截器、管道、守卫（鉴权）、过滤器；</li>
<li>兼容 Express/Koa，可无缝集成第三方库；</li>
<li>支持微服务、GraphQL、WebSocket。</li>
</ul>
</li>
<li>
<p><strong>示例代码</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// user.controller.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Get</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user.service'</span>;

<span class="hljs-meta">@Controller</span>(<span class="hljs-string">'api/user'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> userService: UserService</span>) {}

  <span class="hljs-meta">@Get</span>()
  <span class="hljs-title function_">getUser</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">getUser</span>();
  }
}

<span class="hljs-comment">// user.service.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  <span class="hljs-title function_">getUser</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">20</span> };
  }
}
</code></pre>
</li>
<li>
<p><strong>优点</strong>：规范统一、类型安全、适合大型项目 / 团队、生态完善（官方封装了大量企业级能力）；</p>
</li>
<li>
<p><strong>缺点</strong>：学习成本高、入门门槛高、小型项目用着 “重”；</p>
</li>
<li>
<p><strong>适用场景</strong>：大型企业应用、微服务、团队协作项目、需要强类型的项目。</p>
</li>
</ul>
<h4 data-id="heading-5">4. Fastify（高性能极简框架）</h4>
<ul>
<li>
<p><strong>核心定位</strong>：极致性能，比 Express 快 2-3 倍，专为高并发 API 设计。</p>
</li>
<li>
<p><strong>核心特性</strong>：</p>
<ul>
<li>基于 JSON Schema 验证请求参数，性能优于传统验证库；</li>
<li>内置日志、压缩、路由缓存，无需额外配置；</li>
<li>兼容 Express 中间件；</li>
<li>支持 TypeScript。</li>
</ul>
</li>
<li>
<p><strong>示例代码</strong>：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">fastify</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">'fastify'</span>)({ logger: <span class="hljs-literal">true</span> });

<span class="hljs-comment">// 路由 + 参数验证</span>
fastify.<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">'/api/user'</span>, {
  <span class="hljs-attr">schema</span>: {
    <span class="hljs-attr">querystring</span>: {
      <span class="hljs-attr">age</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'number'</span> }
    }
  }
}, <span class="hljs-title function_ invoke__">async</span> (request, reply) =&gt; {
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">age</span>: request.query.age || <span class="hljs-number">20</span> };
});

fastify.<span class="hljs-title function_ invoke__">listen</span>({ <span class="hljs-attr">port</span>: <span class="hljs-number">3000</span> }, (err) =&gt; {
  <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
  console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">'Fastify 启动在 3000 端口'</span>);
});
</code></pre>
</li>
<li>
<p><strong>优点</strong>：性能极高、内置功能丰富（无需装大量中间件）、轻量；</p>
</li>
<li>
<p><strong>缺点</strong>：生态比 Express 小、部分特性（如 Schema 验证）有学习成本；</p>
</li>
<li>
<p><strong>适用场景</strong>：高并发 API、微服务、对性能要求高的项目。</p>
</li>
</ul>
<h4 data-id="heading-6">5. Hapi（稳定的企业级框架）</h4>
<blockquote>
<p>“还记得当初在 <strong>沃尔玛</strong> 买了虾 , 自己回家自己做 <strong>鸡油炒河虾仁</strong> , 艾玛 , 老香了!!! ”</p>
</blockquote>
<ul>
<li>
<p><strong>核心定位</strong>：由 Walmart ( 沃尔玛  ) 开发，强调配置优于编码，适合稳定的企业级服务。</p>
</li>
<li>
<p><strong>核心特性</strong>：</p>
<ul>
<li>内置路由、验证、缓存、日志，无需第三方库；</li>
<li>插件化架构，扩展能力强；</li>
<li>稳定性极高（适合金融 / 电商等核心系统）。</li>
</ul>
</li>
<li>
<p><strong>优点</strong>：稳定、内置功能全、安全性高；</p>
</li>
<li>
<p><strong>缺点</strong>：学习成本高、灵活性低、性能不如 Fastify；</p>
</li>
<li>
<p><strong>适用场景</strong>：金融 / 电商等核心系统、对稳定性要求极高的项目。</p>
</li>
</ul>
<h4 data-id="heading-7">6. Next.js（前端 SSR/SSG 框架，Node 端核心）</h4>
<ul>
<li>
<p><strong>核心定位</strong>：React 生态的全栈框架，Node 端负责服务端渲染（SSR）、静态生成（SSG）。</p>
</li>
<li>
<p><strong>核心特性</strong>：</p>
<ul>
<li>服务端渲染（提升 SEO、首屏加载速度）；</li>
<li>自动路由（基于文件系统）；</li>
<li>内置 API 路由（无需额外搭后端）；</li>
<li>支持静态生成、增量静态再生。</li>
</ul>
</li>
<li>
<p><strong>适用场景</strong>：React 前端项目、需要 SEO 的网站（如博客、电商）、全栈 React 应用。</p>
</li>
</ul>
<h4 data-id="heading-8">7. Sails.js（低代码 / 快速开发框架）</h4>
<ul>
<li>
<p><strong>核心定位</strong>：对标 Ruby on Rails，内置 ORM、蓝图 API、实时通信，适合快速开发全栈应用。</p>
</li>
<li>
<p><strong>核心特性</strong>：</p>
<ul>
<li>自动生成 CRUD API（蓝图路由）；</li>
<li>内置 Waterline ORM（支持多数据库）；</li>
<li>支持 WebSocket 实时通信；</li>
</ul>
</li>
<li>
<p><strong>优点</strong>：开发速度极快、低代码；</p>
</li>
<li>
<p><strong>缺点</strong>：灵活性低、定制化成本高；</p>
</li>
<li>
<p><strong>适用场景</strong>：快速原型开发、低代码平台、小型全栈应用。</p>
</li>
</ul>
<h4 data-id="heading-9">8. AdonisJS（Node.js 版的 Laravel，全栈企业级框架）</h4>
<ul>
<li>
<p><strong>核心定位</strong>：对标 PHP 界的 Laravel，是 Node.js 生态中 “开箱即用” 的全栈框架，内置全套企业级能力，强调 “约定优于配置”。</p>
</li>
<li>
<p><strong>核心特性</strong>：</p>
<ul>
<li>内置 ORM（Lucid ORM）：支持 MySQL、PostgreSQL 等，无需手动集成第三方 ORM；</li>
<li>内置身份验证（用户注册 / 登录 / 权限）、表单验证、CSRF 保护；</li>
<li>支持 MVC 架构、路由分组、中间件、任务调度；</li>
<li>原生支持 TypeScript，类型安全；</li>
<li>内置模板引擎（Edge），也支持前后端分离；</li>
</ul>
</li>
<li>
<p><strong>示例代码（核心路由 + ORM）</strong> ：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// start/routes.ts</span>
<span class="hljs-keyword">import</span> Route from <span class="hljs-string">'@ioc:Adonis/Core/Route'</span>
<span class="hljs-keyword">import</span> User from <span class="hljs-string">'App/Models/User'</span>

<span class="hljs-comment">// 路由 + 数据库查询</span>
Route.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/api/user'</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> User.find(<span class="hljs-number">1</span>) <span class="hljs-comment">// Lucid ORM 查用户</span>
  <span class="hljs-keyword">return</span> { name: user?.name, age: user?.age }
})

<span class="hljs-comment">// 表单验证</span>
Route.post(<span class="hljs-string">'/api/user'</span>, <span class="hljs-keyword">async</span> ({ request }) =&gt; {
  <span class="hljs-keyword">const</span> data = request.validate({
    schema: {
      name: schema.string(),
      age: schema.number()
    }
  })
  <span class="hljs-keyword">await</span> User.create(data) <span class="hljs-comment">// 新增用户</span>
  <span class="hljs-keyword">return</span> { success: <span class="hljs-keyword">true</span> }
})
</code></pre>
</li>
<li>
<p><strong>优点</strong>：开箱即用（无需装大量依赖）、Laravel 开发者易上手、规范统一、内置安全特性；</p>
</li>
<li>
<p><strong>缺点</strong>：生态比 Express/NestJS 小、灵活性略低、国内使用较少（中文文档有限）；</p>
</li>
<li>
<p><strong>适用场景</strong>：全栈 Node.js 应用、Laravel 转 Node 开发的团队、中小型企业应用、需要快速搭建带数据库的业务系统。</p>
</li>
</ul>
<h4 data-id="heading-10">9. Nuxt.js（Vue 生态全栈框架，Node 端负责 SSR/SSG）</h4>
<ul>
<li>
<p><strong>核心定位</strong>：Vue 生态的官方全栈框架，基于 Vue + Node.js 实现服务端渲染（SSR）、静态站点生成（SSG），解决 Vue 单页应用 SEO 差的问题。</p>
</li>
<li>
<p><strong>核心特性</strong>：</p>
<ul>
<li>自动路由（基于 <code>pages</code> 目录，无需手动配置路由）；</li>
<li>服务端渲染（SSR）、静态生成（SSG）、增量静态再生（ISR）；</li>
<li>内置 API 路由（<code>server/api</code> 目录，无需额外搭后端服务）；</li>
<li>支持 Vue3 + TypeScript、自动代码分割、缓存优化；</li>
<li>集成 Pinia（状态管理）、Nuxt Modules（生态插件）；</li>
</ul>
</li>
<li>
<p><strong>示例代码（核心用法）</strong> ：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- pages/api/user.vue (页面路由) --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{{ user.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 服务端获取数据（SSR）</span>
<span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: user } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">useAsyncData</span>(<span class="hljs-string">'user'</span>, <span class="hljs-function">() =&gt;</span> 
  $fetch(<span class="hljs-string">'/api/user'</span>) <span class="hljs-comment">// 调用内置 API 路由</span>
)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

// server/api/user.ts (内置 API 路由)
export default defineEventHandler(() =&gt; {
  return { name: '张三', age: 20 }
})
</code></pre>
</li>
<li>
<p><strong>优点</strong>：Vue 开发者无缝上手、解决 SEO 问题、全栈一体化（前端 + Node 端）、生态完善；</p>
</li>
<li>
<p><strong>缺点</strong>：仅适配 Vue 技术栈、Node 端逻辑定制化能力有限、大型项目需深入理解其生命周期；</p>
</li>
<li>
<p><strong>适用场景</strong>：Vue 全栈应用、需要 SEO 的网站（博客 / 电商 / 官网）、静态站点生成、中小型 Vue 项目。</p>
</li>
</ul>
<h4 data-id="heading-11">10. Egg.js（阿里开源，企业级 Node.js 框架）</h4>
<ul>
<li>
<p><strong>核心定位</strong>：阿里开源的企业级框架，基于 Express/Koa 封装，强调 “约定优于配置”，适合中大型团队协作。</p>
</li>
<li>
<p><strong>核心特性</strong>：</p>
<ul>
<li>基于 Koa2（洋葱模型），兼容 Koa/Express 中间件；</li>
<li>内置多进程模型（Master + Worker），自动利用多核 CPU；</li>
<li>插件化架构（如 egg-mysql、egg-redis），生态丰富（阿里官方维护）；</li>
<li>支持 TypeScript、单元测试、日志、监控；</li>
<li>规范的目录结构（controller/service/middleware/config），团队协作友好；</li>
</ul>
</li>
<li>
<p><strong>示例代码</strong>：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// app/controller/user.js</span>
const { <span class="hljs-type">Controller</span> } = require('egg');

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span> </span>{
  async index() {
    const { ctx } = <span class="hljs-keyword">this</span>;
    <span class="hljs-comment">// 调用 service 层</span>
    const user = await ctx.service.user.getUser();
    ctx.body = user;
  }
}

module.exports = <span class="hljs-type">UserController</span>;

<span class="hljs-comment">// app/service/user.js</span>
const { <span class="hljs-type">Service</span> } = require('egg');

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Service</span> </span>{
  async getUser() {
    <span class="hljs-comment">// 用 egg-mysql 查数据库</span>
    <span class="hljs-keyword">return</span> await <span class="hljs-keyword">this</span>.app.mysql.get('user', { id: <span class="hljs-number">1</span> });
  }
}

module.exports = <span class="hljs-type">UserService</span>;
</code></pre>
</li>
<li>
<p><strong>优点</strong>：阿里背书、规范统一、多进程性能优、国内生态完善（中文文档 / 社区）、适合团队协作；</p>
</li>
<li>
<p><strong>缺点</strong>：灵活性低于 Express/Koa、学习成本中等、小型项目用着 “重”；</p>
</li>
<li>
<p><strong>适用场景</strong>：中大型企业应用、阿里系技术栈项目、国内团队协作项目、需要多进程优化的 Node 服务。</p>
</li>
</ul>
<h3 data-id="heading-12">三、 对比</h3>



















































































































<table><thead><tr><th>框架</th><th>学习成本</th><th>性能</th><th>生态</th><th>类型支持</th><th>适用规模</th><th>核心优势</th><th>技术栈 / 定位</th></tr></thead><tbody><tr><td>Express</td><td>低</td><td>中等</td><td>极丰富</td><td>需手动配</td><td>小 / 中</td><td>灵活、生态全、入门快</td><td>极简核心框架</td></tr><tr><td>Koa</td><td>中</td><td>中等</td><td>丰富</td><td>需手动配</td><td>小 / 中</td><td>洋葱模型、async/await</td><td>极简核心框架（Express 升级版）</td></tr><tr><td>NestJS</td><td>高</td><td>中等</td><td>丰富</td><td>原生 TS</td><td>中 / 大</td><td>规范、企业级、团队协作</td><td>企业级 TS 框架</td></tr><tr><td>Fastify</td><td>中</td><td>极高</td><td>中等</td><td>原生 TS</td><td>小 / 中 / 大</td><td>极致性能、内置功能全</td><td>高性能极简框架</td></tr><tr><td>Hapi</td><td>高</td><td>中高</td><td>中等</td><td>需手动配</td><td>中 / 大</td><td>稳定、安全、企业级</td><td>企业级配置优先框架</td></tr><tr><td>Next.js</td><td>中</td><td>中等</td><td>极丰富</td><td>原生 TS</td><td>小 / 中 / 大</td><td>React SSR、全栈一体化</td><td>React 全栈框架</td></tr><tr><td>Sails.js</td><td>低</td><td>中等</td><td>中等</td><td>需手动配</td><td>小</td><td>低代码、开发速度快</td><td>低代码全栈框架</td></tr><tr><td>AdonisJS</td><td>中</td><td>中等</td><td>中等</td><td>原生 TS</td><td>小 / 中</td><td>Laravel 风格、开箱即用</td><td>全栈企业级框架（Node 版 Laravel）</td></tr><tr><td>Nuxt.js</td><td>中</td><td>中等</td><td>极丰富</td><td>原生 TS</td><td>小 / 中 / 大</td><td>Vue SSR、全栈一体化、SEO 优</td><td>Vue 全栈框架</td></tr><tr><td>Egg.js</td><td>中</td><td>中高</td><td>丰富</td><td>需手动配</td><td>中 / 大</td><td>阿里背书、多进程、国内生态好</td><td>企业级框架（基于 Koa）</td></tr></tbody></table>
<h3 data-id="heading-13">四、选型建议</h3>
<ol>
<li><strong>个人 / 小型项目、快速开发</strong>：选 Express（生态全）或 Koa（异步体验好）；</li>
<li><strong>高并发 API、微服务</strong>：选 Fastify（性能第一）；</li>
<li><strong>大型企业应用、团队协作</strong>：选 NestJS（TS + 规范）或 Hapi（稳定）；</li>
<li><strong>React 全栈、需要 SEO</strong>：选 Next.js；</li>
<li><strong>低代码、快速原型</strong>：选 Sails.js。</li>
</ol>
<h3 data-id="heading-14">总结</h3>
<ol>
<li><strong>核心维度</strong>：选型优先看「项目规模 + 团队技术栈 + 性能要求」，小型项目别用重框架（如 NestJS），大型项目别用太灵活的框架（如 Express）；</li>
<li><strong>生态优先级</strong>：如果需要集成大量第三方库，Express / Koa / Next.js 是首选；</li>
<li><strong>性能优先级</strong>：高并发场景直接选 Fastify；</li>
<li><strong>团队协作</strong>：大型团队优先 NestJS（强规范），避免 Express 因灵活导致的代码混乱。</li>
</ol>
<blockquote>
<p>okokok , 这个文章到这里就结束了 , 我们有缘再会 😁😁😁 !!!</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nginx 路径映射深度解析：从本地开发到生产交付的底层哲学]]></title>    <link>https://juejin.cn/post/7603699739223293967</link>    <guid>https://juejin.cn/post/7603699739223293967</guid>    <pubDate>2026-02-08T05:01:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603699739223293967" data-draft-id="7603673564908732451" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nginx 路径映射深度解析：从本地开发到生产交付的底层哲学"/> <meta itemprop="keywords" content="前端,后端,架构"/> <meta itemprop="datePublished" content="2026-02-08T05:01:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="文艺理科生Owen"/> <meta itemprop="url" content="https://juejin.cn/user/3817963023244503"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nginx 路径映射深度解析：从本地开发到生产交付的底层哲学
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817963023244503/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    文艺理科生Owen
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T05:01:07.000Z" title="Sun Feb 08 2026 05:01:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Nginx 静态资源映射：从原理到生产环境的最佳实践</h2>
<blockquote>
<p><strong>摘要</strong>：在现代前后端分离架构中，Nginx 不仅是高性能的静态资源服务器，更是不可或缺的反向代理枢纽。然而，由于对资源映射（root/alias）及请求转发（proxy_pass）逻辑的理解偏差，往往会导致从 Windows 开发环境迁移至 Linux 生产环境时出现 404 或转发异常。本文将从 HTTP 协议视角出发，深度剖析“路径映射三剑客”的底层逻辑，并提供一套可落地的工程化配置规范与避坑指南。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">1. 业务场景与工程痛点</h3>
<p>在实际的工程链路中，我们经常遇到这样的场景：
前端同学在 Windows 本地使用 Nginx 调试 SPA（单页应用）或静态站点，一切运行正常。但当 CI/CD 流水线将代码部署到 Linux 生产服务器后，访问特定资源（如图片、次级路由）却频频出现 404 错误。</p>
<p>这并非玄学，而是由于对 <strong>Nginx 路径解析机制</strong> 及 <strong>操作系统文件系统差异</strong> 理解不足导致的。要解决这个问题，我们需要先建立正确的路径映射心智模型。</p>
<h3 data-id="heading-2">2. 核心模型解析：URL 与文件系统的映射</h3>
<p>Nginx 的核心职责之一，就是将抽象的 <strong>HTTP URI</strong> 映射到具体的 <strong>服务器文件系统路径</strong>。</p>
<h4 data-id="heading-3">2.1 URI 的语义差异</h4>
<p>在配置之前，必须明确 URL 尾部斜杠的协议语义：</p>
<ul>
<li><strong><code>/images</code></strong>：客户端请求名为 <code>images</code> 的<strong>资源实体</strong>（可能是文件，也可能是目录）。</li>
<li><strong><code>/images/</code></strong>：客户端明确请求名为 <code>images</code> 的<strong>目录容器</strong>。</li>
</ul>
<p><strong>工程细节</strong>：
当用户访问 <code>/images</code>（不带斜杠）且服务器上存在同名目录时，Nginx 默认会返回 <strong>301 Moved Permanently</strong>，自动重定向到 <code>/images/</code>。这是为了确保相对路径资源（如 <code>./logo.png</code>）能基于正确的 Base URL 加载。</p>
<hr/>
<h3 data-id="heading-4">3. 资源映射三剑客：Root、Alias 与 Proxy_Pass</h3>
<p><code>root</code>、<code>alias</code> 与 <code>proxy_pass</code> 是 Nginx 流量分发的核心指令。前两者解决的是如何将 URI 映射到 <strong>本地文件系统</strong>，而后者解决的是如何将请求转发到 <strong>网络服务接口</strong>。</p>
<h4 data-id="heading-5">3.1 Root：追加逻辑 (Append)</h4>
<p><code>root</code> 指令采用<strong>追加</strong>策略。它将请求的 URI 完整拼接到 <code>root</code> 指定的路径之后。</p>
<ul>
<li><strong>计算公式</strong>：<code>最终物理路径 = root路径 + 完整URI</code></li>
<li><strong>配置示例</strong>：
<pre><code class="hljs language-nginx" lang="nginx">location /static/ {
    root /var/www/app;
}
</code></pre>
</li>
<li><strong>解析过程</strong>：请求 <code>GET /static/css/style.css</code> -&gt; 物理路径：<code>/var/www/app/static/css/style.css</code></li>
</ul>
<h4 data-id="heading-6">3.2 Alias：替换逻辑 (Replace)</h4>
<p><code>alias</code> 指令采用<strong>替换</strong>策略。它用 <code>alias</code> 指定的路径替换掉 <code>location</code> 匹配到的部分。</p>
<ul>
<li><strong>计算公式</strong>：<code>最终物理路径 = alias路径 + (完整URI - location匹配部分)</code></li>
<li><strong>配置示例</strong>：
<pre><code class="hljs language-nginx" lang="nginx">location /static/ {
    alias /var/www/app/public/;
}
</code></pre>
</li>
<li><strong>解析过程</strong>：请求 <code>GET /static/css/style.css</code> -&gt; 匹配 <code>/static/</code> -&gt; 剩余 <code>css/style.css</code> -&gt; 最终访问：<code>/var/www/app/public/css/style.css</code></li>
</ul>
<h4 data-id="heading-7">3.3 Proxy_Pass：请求转发逻辑 (Forward)</h4>
<p>与处理本地文件的指令不同，<code>proxy_pass</code> 处理的是网络协议栈的转发。其路径处理逻辑遵循相似的“追加”与“替换”哲学，由目标 URL 结尾是否有 <strong><code>/</code></strong> 决定。</p>
<h5 data-id="heading-8"><strong>场景 A：不带斜杠（透明转发，对应 Root 逻辑）</strong></h5>
<p>当 <code>proxy_pass</code> 的目标 URL 不带路径（即没有结尾的 <code>/</code>）时，Nginx 会将原始请求的 URI 完整地传递给后端服务。</p>
<ul>
<li><strong>配置示例</strong>：
<pre><code class="hljs language-nginx" lang="nginx">location /api/ {
    proxy_pass http://127.0.0.1:3000; 
}
</code></pre>
</li>
<li><strong>路径解析</strong>：请求 <code>GET /api/user</code> -&gt; 转发到 <code>http://127.0.0.1:3000/api/user</code>。</li>
<li><strong>工程特征</strong>：<code>location</code> 匹配路径被完整保留。适用于后端服务本身就包含 <code>/api</code> 前缀的场景。</li>
</ul>
<h5 data-id="heading-9"><strong>场景 B：带斜杠（路径重写，对应 Alias 逻辑）</strong></h5>
<p>当 <code>proxy_pass</code> 的目标 URL 包含路径（即使只有一个结尾的 <code>/</code>）时，Nginx 会将 URI 中匹配 <code>location</code> 的部分替换为该路径。</p>
<ul>
<li><strong>配置示例</strong>：
<pre><code class="hljs language-nginx" lang="nginx">location /api/ {
    proxy_pass http://127.0.0.1:3000/; 
}
</code></pre>
</li>
<li><strong>路径解析</strong>：请求 <code>GET /api/user</code> -&gt; 转发到 <code>http://127.0.0.1:3000/user</code>。</li>
<li><strong>工程特征</strong>：<code>location</code> 匹配路径被“剥离”。适用于后端服务是纯净接口，仅通过 Nginx 统一前缀入口的场景。</li>
</ul>
<h4 data-id="heading-10">3.4 资源映射三剑客对比表</h4>
<p>假设统一配置 <code>location /api/</code>，观察不同指令下的映射结果：</p>













































<table><thead><tr><th align="left">指令</th><th align="left">映射目标</th><th align="left">URI 处理方式</th><th align="left">示例配置</th><th align="left">实际请求 -&gt; 结果映射</th><th align="left">典型场景</th></tr></thead><tbody><tr><td align="left"><strong>Root</strong></td><td align="left">本地磁盘</td><td align="left"><strong>追加</strong> (Append)</td><td align="left"><code>root /data;</code></td><td align="left"><code>/api/user</code> -&gt; <code>/data/api/user</code></td><td align="left">静态站点默认部署</td></tr><tr><td align="left"><strong>Alias</strong></td><td align="left">本地磁盘</td><td align="left"><strong>替换</strong> (Replace)</td><td align="left"><code>alias /data/v1/;</code></td><td align="left"><code>/api/user</code> -&gt; <code>/data/v1/user</code></td><td align="left">虚拟路径、资源别名</td></tr><tr><td align="left"><strong>Proxy_Pass (无/)</strong></td><td align="left">远程服务</td><td align="left"><strong>透明转发</strong></td><td align="left"><code>proxy_pass http://node:3000;</code></td><td align="left"><code>/api/user</code> -&gt; <code>node:3000/api/user</code></td><td align="left">后端服务自带前缀</td></tr><tr><td align="left"><strong>Proxy_Pass (带/)</strong></td><td align="left">远程服务</td><td align="left"><strong>路径重写</strong></td><td align="left"><code>proxy_pass http://node:3000/;</code></td><td align="left"><code>/api/user</code> -&gt; <code>node:3000/user</code></td><td align="left">统一入口，后端无前缀</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-11">4. 工程化落地：跨平台环境差异处理</h3>
<p>在团队协作中，统一开发环境（Windows/Mac）与生产环境（Linux）的配置规范至关重要。</p>
<h4 data-id="heading-12">4.1 Windows 开发环境的陷阱</h4>
<p>Windows 文件系统有“盘符”概念，且对路径分隔符不敏感。</p>
<ul>
<li><strong>绝对路径问题</strong>：
在 Windows 下配置 <code>root /html;</code>，Nginx 会将其解析为当前盘符的根目录（如 <code>D:\html</code>），而非 Nginx 安装目录。</li>
<li><strong>最佳实践</strong>：
<strong>使用相对路径</strong>。
<pre><code class="hljs language-nginx" lang="nginx"># 推荐：相对于 Nginx 安装目录 (prefix)
location / {
    root html; 
    index index.html;
}
</code></pre>
</li>
</ul>
<h4 data-id="heading-13">4.2 Linux 生产环境的规范</h4>
<p>Linux 环境强调权限控制与路径的确定性。</p>
<ul>
<li>
<p><strong>绝对路径强制</strong>：
生产配置必须使用绝对路径，避免因启动方式不同导致的工作目录漂移。</p>
<pre><code class="hljs language-nginx" lang="nginx">root /usr/share/nginx/html;
</code></pre>
</li>
<li>
<p><strong>权限隔离 (Permission)</strong>：
常见的 403 Forbidden 错误通常并非配置错误，而是权限问题。</p>
<ul>
<li><strong>要求</strong>：Nginx 运行用户（通常是 <code>nginx</code> 或 <code>www-data</code>）必须拥有从根目录到目标文件全路径的 <strong>x (执行/搜索)</strong> 权限，以及目标文件的 <strong>r (读取)</strong> 权限。</li>
<li><strong>排查命令</strong>：
<pre><code class="hljs language-bash" lang="bash">namei -om /var/www/project/static/image.png
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>Alias 的斜杠对称性</strong>：
这是一个容易被忽视的 Bug 源。在 Linux 下使用 <code>alias</code> 时，如果 <code>location</code> 只有尾部斜杠，建议 <code>alias</code> 也加上尾部斜杠，保持对称，避免路径拼接错位。</p>
<pre><code class="hljs language-nginx" lang="nginx"># Good
location /img/ {
    alias /var/www/images/;
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-14">5. 调试与排错指南</h3>
<p>当出现 404 或 403 时，不要盲目猜测，请遵循以下排查路径：</p>
<ol>
<li>
<p><strong>Check Error Log</strong>：
这是最直接的证据。Nginx 的 <code>error.log</code> 会明确打印出它试图访问的完整物理路径。</p>
<pre><code class="hljs language-text" lang="text">open() "/var/www/app/static/css/style.css" failed (2: No such file or directory)
</code></pre>
<p>对比日志中的路径与你预期的路径，通常能立刻发现 <code>root</code> 或 <code>alias</code> 的误用。</p>
</li>
<li>
<p><strong>验证文件存在性</strong>：
直接复制日志中的路径，在服务器上执行 <code>ls -l &lt;path&gt;</code>，确认文件是否存在以及权限是否正确。</p>
</li>
</ol>
<hr/>
<p><strong>总结</strong>：
Nginx 的路径映射与转发逻辑虽然细碎，但其背后遵循着高度一致的“追加”与“替换”哲学。掌握 <code>root</code>、<code>alias</code> 与 <code>proxy_pass</code> 的底层差异，不仅能解决 404/403 等表象问题，更能帮助开发者构建出优雅、可维护的配置体系。在工程实践中，建议通过<strong>规范化路径命名</strong>（如统一使用 <code>/api/</code> 前缀）与<strong>环境感知配置</strong>（如 Linux 绝对路径强制化）来降低运维复杂度，确保从本地开发到生产交付的丝滑顺畅。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【ThreeJS实战】从86MB到4MB：复杂模型加载优化黑魔法]]></title>    <link>https://juejin.cn/post/7603771025856397363</link>    <guid>https://juejin.cn/post/7603771025856397363</guid>    <pubDate>2026-02-08T05:34:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603771025856397363" data-draft-id="7603771025855922227" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【ThreeJS实战】从86MB到4MB：复杂模型加载优化黑魔法"/> <meta itemprop="keywords" content="three.js,性能优化"/> <meta itemprop="datePublished" content="2026-02-08T05:34:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="叶智辽"/> <meta itemprop="url" content="https://juejin.cn/user/3320999244205294"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【ThreeJS实战】从86MB到4MB：复杂模型加载优化黑魔法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3320999244205294/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    叶智辽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T05:34:15.000Z" title="Sun Feb 08 2026 05:34:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><em>前言：正当我沉浸在将draw call从52000优化到1的喜悦中无法自拔时，产品经理这时候又杀过来了："客户说模型加载要30秒，还没进去就关页面了，你优化一下？"我打开Network面板一看，卧槽，86MB的GLB文件！这谁顶得住啊...</em></p>
<p>如果你也遇到过这种情况：精心打磨的3D场景，本地运行丝滑流畅，一上线用户骂娘——"破网站卡死了"、"怎么还在转圈"、"手机直接闪退"。别急着怪用户网速慢，先看看你的模型是不是<strong>太胖了</strong>。</p>
<p>我这有个复杂模型，几何体+贴图一共<strong>86MB</strong>，在4G网络下加载需要<strong>30秒</strong>（Chrome模拟Slow 4G(3mb/s)一直加载...)。今天咱们不讲Blender操作模型（之前用Blender是因为没招，现在有更狠的），直接用<strong>命令行黑魔法</strong>把它压到<strong>4MB!!</strong>，加载时间从30秒干到<strong>1.5秒</strong>。</p>
<p>以下是优化前的绝望现场整整加载了30多秒...</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/674e9f906cc746b3b8f29b017e4603a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-25pm66L69:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771133660&amp;x-signature=tsoCT58MD8cav1uSQnyd2NcJc%2Bc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-0">一、优化思路</h3>
<p>既然知道了加载为什么那么慢的原因，那我们就可以开始想想该怎么优化了</p>
<p>我目前的思路就是用<code>gltf-transform</code>
先把模型体积压下来，要不然渲染的时候再流畅，客户等到第二十秒的时候关闭浏览器，也没有意义了。。</p>
<h3 data-id="heading-1">二、DRACOLoader</h3>
<p>ThreeJS DRACOLoader直接无缝解压缩被压缩的模型</p>
<h4 data-id="heading-2">安装压缩模型工具（不用Blender，命令行搞定）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装gltf-transform（一行命令搞定Draco压缩+WebP+KTX2）</span>
npm install -g @gltf-transform/cli
</code></pre>
<p>至于我为什么选择gltf-transform而不是gltf-pipeline，以下是它们的对比：</p>



































<table><thead><tr><th>特性</th><th>gltf-pipeline</th><th>gltf-transform</th></tr></thead><tbody><tr><td><strong>Draco压缩</strong></td><td>✅ 支持</td><td>✅ 支持（更快）</td></tr><tr><td><strong>WebP纹理</strong></td><td>❌ 不支持</td><td>✅ 支持（关键！）</td></tr><tr><td><strong>KTX2/Basis</strong></td><td>❌ 不支持</td><td>✅ 支持</td></tr><tr><td><strong>安装体积</strong></td><td>大（依赖多）</td><td>小（WASM核心）</td></tr><tr><td><strong>推荐度</strong></td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr></tbody></table>
<h2 data-id="heading-3">压缩你的GLB（80MB → 4MB）</h2>
<pre><code class="hljs language-bash" lang="bash">gltf-transform optimize input.glb output.glb \
  --compress draco \
  --texture-compress webp \
  --texture-size 2048
</code></pre>
<p>以下是我压缩之后的体积：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7625fd53c564acb8f71b83e39f2cd5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-25pm66L69:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771133660&amp;x-signature=Qt6vRnu5GJeXcNUoNO%2By5kpmOEM%3D" alt="image.png" loading="lazy"/></p>
<p>可以看到，模型的体积得到了巨大的缩减，从原来的86mb到现在的4mb左右！</p>
<p><strong>参数说明</strong>：</p>













































<table><thead><tr><th>参数</th><th>说明</th><th>建议值</th></tr></thead><tbody><tr><td><code>--texture-compress webp</code></td><td>贴图转WebP格式</td><td><strong>必加</strong>，体积减半</td></tr><tr><td><code>--texture-compress ktx2</code></td><td>贴图转KTX2（GPU直读）</td><td>如果目标设备支持，比WebP更好</td></tr><tr><td><code>--texture-size 2048</code></td><td>限制最大贴图尺寸</td><td><strong>必加</strong>，4096→2048省4倍显存</td></tr><tr><td><code>--compress draco</code></td><td>启用Draco几何压缩</td><td><strong>必加</strong>，默认就是sequential模式</td></tr><tr><td><code>--compress-method sequential</code></td><td>Draco编码模式</td><td>sequential（默认，小体积）或 edgeloop（快解码）</td></tr><tr><td><code>--compress-level 10</code></td><td>Draco压缩级别</td><td>0-10，10压最狠但解压慢，建议7-10</td></tr><tr><td><code>--flatten</code></td><td>打平节点层级</td><td>如果模型层级太深，加这个减少DrawCall（但会丢失动画）</td></tr></tbody></table>
<p>以下是优化之后的加载时间，就问你快不快！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c128c4ba2d14860b8623cf34327cf21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-25pm66L69:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771133660&amp;x-signature=Gj1p3h7rSzkEUOr8ceIYI4kXA2s%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">Three.js加载代码（关键！）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 优化后的 GLB 加载步骤（Draco / gltf-transform）
 *
 * 依赖：Three.js、GLTFLoader、DRACOLoader
 * 解码器：把 three 的 examples/jsm/libs/draco/gltf/ 放到站点 /draco/ 下，或使用 CDN 路径
 */</span>

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">GLTFLoader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'three/examples/jsm/loaders/GLTFLoader'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DRACOLoader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'three/examples/jsm/loaders/DRACOLoader'</span>;

<span class="hljs-comment">// ————— 步骤 1：创建 Draco 解码器并指定路径 —————</span>
<span class="hljs-keyword">const</span> dracoLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DRACOLoader</span>();
dracoLoader.<span class="hljs-title function_">setDecoderPath</span>(<span class="hljs-string">'/draco/'</span>);
<span class="hljs-comment">// 或用 CDN（与项目 three 版本一致）：'https://cdn.jsdelivr.net/npm/three@0.182.0/examples/jsm/libs/draco/gltf/'</span>

<span class="hljs-comment">// ————— 步骤 2：把 DRACOLoader 挂到 GLTFLoader 上 —————</span>
<span class="hljs-keyword">const</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GLTFLoader</span>();
loader.<span class="hljs-title function_">setDRACOLoader</span>(dracoLoader);

<span class="hljs-comment">// ————— 步骤 3：正常 load，普通 GLB 与 Draco 压缩的 GLB 都能加载 —————</span>
loader.<span class="hljs-title function_">load</span>(
  <span class="hljs-string">'https://your-cdn.com/model-optimized.glb'</span>,
  <span class="hljs-function">(<span class="hljs-params">gltf</span>) =&gt;</span> {
    scene.<span class="hljs-title function_">add</span>(gltf.<span class="hljs-property">scene</span>);
  },
  <span class="hljs-literal">undefined</span>,
  <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err),
);

<span class="hljs-comment">// Promise 写法（可选）：</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadOptimizedGLB</span>(<span class="hljs-params">url</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    loader.<span class="hljs-title function_">load</span>(url, resolve, <span class="hljs-literal">undefined</span>, reject);
  });
}
<span class="hljs-comment">// 使用方式：const gltf = await loadOptimizedGLB(url);</span>

</code></pre>
<p><strong>注意</strong>：<code>setDecoderPath</code> 指向的是 Draco 的 WASM 解码文件，需要从 Three.js 的 <code>examples/jsm/libs/draco/</code> 目录复制到你的 public 文件夹，或者用 CDN（上面示例用的是从threejs复制的本地解码文件）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6056ed4edd8424e9f576076746a6227~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-25pm66L69:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771133660&amp;x-signature=LfB00kEcCV01BCgkwfo%2BfL0j%2B2E%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0bcc195429b6461dad0a0b37005c7a60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-25pm66L69:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771133660&amp;x-signature=Pm6unUZnhNJrWVyGpRLGgHL%2B5u4%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">避坑指南</h3>
<ol>
<li><strong>别重复压缩</strong>：Draco是有损压缩，压一次损失一点精度，<strong>别压两遍</strong>！先备份原文件。</li>
<li><strong>WebP兼容性</strong>：虽然现代浏览器都支持WebP，但如果你要兼容IE11（虽然不应该），只能用PNG/JPG。</li>
<li><strong>KTX2谨慎用</strong>：KTX2（Basis Universal）压缩率最高，但需要 GPU 支持，老旧手机可能解码失败，建议 WebP 更稳妥。</li>
<li><strong>量化精度</strong>：如果你发现压缩后的模型出现<strong>裂缝</strong>（顶点没对齐），把 <code>--quantization-position</code> 从 10 调到 14。</li>
</ol>
<p><strong>还有一件事</strong>：Draco是<strong>有损压缩</strong>，但视觉上几乎看不出差别（工业模型顶点精度够高），解压是在Web Worker里进行的，不会卡主线程。</p>
<h3 data-id="heading-6">三、又到了喜闻乐见的前后对比（刺激！）</h3>




















<table><thead><tr><th>指标</th><th>原始模型</th><th>Draco压缩</th></tr></thead><tbody><tr><td><strong>文件体积</strong></td><td>86MB</td><td>4MB</td></tr><tr><td><strong>4G加载时间</strong></td><td>30秒</td><td>1.5秒</td></tr></tbody></table>
<p>可以看到加载时间跨度很大，从30秒到1.5秒，足足提升了20倍，客户本来都要睡着了，但现在客户眨了一下眼睛，就发现眼前屏幕里的世界都不一样了~</p>
<h3 data-id="heading-7">总结</h3>
<p>优化路径：<strong>86MB（原始）→ 4MB（Draco+WebP）→ 1.5秒加载完成</strong></p>
<p><strong>核心认知</strong>：</p>
<ul>
<li><strong>gltf-transform</strong>：一站式解决几何体+贴图压缩，不用Blender，一行命令搞定</li>
<li><strong>Draco</strong>：解决"下载慢"（几何体从18MB压到2MB）</li>
<li><strong>WebP</strong>：解决"贴图肥"（68MB压到2MB，兼容性最好）</li>
</ul>
<p><strong>没用到的手段（进阶可选）</strong>：</p>
<ul>
<li><strong>KTX2</strong>：比WebP体积更小且GPU直读，但需要设备支持，老旧手机可能解码失败</li>
<li><strong>分块加载</strong>：如果4MB还是大，可以拆成"外壳1MB+细节3MB"，首屏秒开</li>
</ul>
<p><strong>不用Blender，全程命令行+代码搞定</strong>，这才是工程师的浪漫。</p>
<p>下篇预告：【ThreeJS实战】GPU还是100%？LOD策略：让远处模型自动"减肥"</p>
<p><strong>互动</strong>：你用<code>gltf-transform</code>压了多少倍？我<strong>20倍</strong>算不算狠？评论区报出你的<strong>原始体积vs优化后体积</strong>，看看谁是真正的"压王"😏</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 React 手搓一个 3D 翻页书籍组件，呼吸海浪式翻页，交互体验带感！]]></title>    <link>https://juejin.cn/post/7603771025856430131</link>    <guid>https://juejin.cn/post/7603771025856430131</guid>    <pubDate>2026-02-08T05:46:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603771025856430131" data-draft-id="7603674653153099785" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 React 手搓一个 3D 翻页书籍组件，呼吸海浪式翻页，交互体验带感！"/> <meta itemprop="keywords" content="前端,GitHub,架构"/> <meta itemprop="datePublished" content="2026-02-08T05:46:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端市界"/> <meta itemprop="url" content="https://juejin.cn/user/289926798641176"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 React 手搓一个 3D 翻页书籍组件，呼吸海浪式翻页，交互体验带感！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/289926798641176/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端市界
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T05:46:14.000Z" title="Sun Feb 08 2026 05:46:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">用 React 手搓一个 3D 翻页书籍组件，页角还能卷起来！从零到踩坑全记录</h2>
<blockquote>
<p>前端开发中，你是否也想过把枯燥的内容展示做得像翻书一样？本文记录了我从零开发一个 <strong>3D 交互式书籍组件</strong> 的完整过程——包括 CSS 3D 翻页、拖拽手势、页角海浪卷起效果，以及中间踩过的坑和最终的解决方案。</p>
</blockquote>
<h3 data-id="heading-1">一、为什么要做这个组件？</h3>
<p>在做一个 AI 知识库产品时，产品经理提了一个需求：</p>
<blockquote>
<p>「能不能把教程做成一本可以翻页的书？用户点击或拖拽就能翻页，体验要像真书。」</p>
</blockquote>
<p>市面上的轮播图、Tab 切换都太「平」了，我希望做一个<strong>有纵深感的 3D 翻书交互</strong>。翻遍了 npm，要么功能太简陋，要么依赖 Canvas 体积太大，最终决定——<strong>自己写一个</strong>。</p>
<p>目标很明确：</p>
<ul>
<li>🎨 CSS 3D 实现真实翻页效果，不用 Canvas</li>
<li>✋ 支持拖拽翻页、点击翻页、键盘翻页</li>
<li>🌊 鼠标悬停页角时有「海浪卷起」的视觉提示</li>
<li>📱 移动端触摸支持</li>
<li>🧱 纯 React 组件，零外部翻书依赖</li>
</ul>
<h3 data-id="heading-2">二、架构设计：一本书的 DOM 结构</h3>
<p>先想清楚一本书的物理结构：</p>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────┐
│           Container             │  ← <span class="hljs-attribute">perspective</span>: <span class="hljs-number">2000px</span> 提供 <span class="hljs-number">3</span>D 视角
│  ┌───────────────────────────┐  │
│  │       BookWrapper         │  │  ← 打开时 <span class="hljs-built_in">translateX</span>(<span class="hljs-number">50%</span>) 居中
│  │  ┌─────────────────────┐  │  │
│  │  │      Cover          │  │  │  ← <span class="hljs-built_in">rotateY</span>(-<span class="hljs-number">180deg</span>) 翻开
│  │  │  ┌ front ┐┌ back ─┐ │  │  │
│  │  │  │封面图片││内封页  │ │  │  │
│  │  │  └───────┘└───────┘ │  │  │
│  │  ├─────────────────────┤  │  │
│  │  │      Pages          │  │  │  ← 所有页面叠在一起
│  │  │  ┌ Page <span class="hljs-number">1</span> ────────┐ │  │  │
│  │  │  │ front │ back   │ │  │  │  ← 每页双面
│  │  │  └────────────────┘ │  │  │
│  │  │  ┌ Page <span class="hljs-number">2</span> ────────┐ │  │  │
│  │  │  │ front │ back   │ │  │  │
│  │  │  └────────────────┘ │  │  │
│  │  │  ┌ BackCover ─────┐ │  │  │
│  │  │  │   The End      │ │  │  │
│  │  │  └────────────────┘ │  │  │
│  │  └─────────────────────┘  │  │
│  └───────────────────────────┘  │
│        Navigation Bar           │
└─────────────────────────────────┘
</code></pre>
<p>核心思路：</p>
<ul>
<li>每一页都是绝对定位叠在一起，<code>transform-origin: left center</code>，翻页就是绕左边缘旋转 -180°</li>
<li>用 <code>backface-visibility: hidden</code> + 前后两个 div 模拟正反面</li>
<li>通过 <code>zIndex</code> 控制翻过的页和未翻的页的层叠关系</li>
</ul>
<h3 data-id="heading-3">三、核心实现</h3>
<h4 data-id="heading-4">3.1 CSS 3D 翻页</h4>
<p>关键 CSS：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">perspective</span>: <span class="hljs-number">2000px</span>;  <span class="hljs-comment">// 3D 视角距离</span>
}

<span class="hljs-selector-class">.page</span> {
  <span class="hljs-attribute">position</span>: absolute;
  inset: 0;
  <span class="hljs-attribute">transform-style</span>: preserve-<span class="hljs-number">3</span>d;
  <span class="hljs-attribute">transform-origin</span>: left;  <span class="hljs-comment">// 绕左边轴翻转</span>
}

<span class="hljs-selector-class">.pageFront</span>, <span class="hljs-selector-class">.pageBack</span> {
  <span class="hljs-attribute">backface-visibility</span>: hidden;  <span class="hljs-comment">// 只显示朝向用户的面</span>
}

<span class="hljs-selector-class">.pageBack</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateY</span>(<span class="hljs-number">180deg</span>) <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">0.5px</span>);  <span class="hljs-comment">// 背面翻转 180°</span>
}
</code></pre>
<p>用 Framer Motion 的 <code>variants</code> 控制翻转动画：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> variants = {
  <span class="hljs-attr">flipped</span>: {
    <span class="hljs-attr">rotateY</span>: -<span class="hljs-number">180</span>,
    <span class="hljs-attr">zIndex</span>: isBuriedLeft ? index + <span class="hljs-number">1</span> : pages.<span class="hljs-property">length</span> + <span class="hljs-number">10</span>,
    <span class="hljs-attr">transition</span>: {
      <span class="hljs-attr">rotateY</span>: { <span class="hljs-attr">duration</span>: <span class="hljs-number">0.6</span>, <span class="hljs-attr">ease</span>: [<span class="hljs-number">0.645</span>, <span class="hljs-number">0.045</span>, <span class="hljs-number">0.355</span>, <span class="hljs-number">1</span>] },
      <span class="hljs-attr">zIndex</span>: { <span class="hljs-attr">delay</span>: <span class="hljs-number">0.6</span> },
    },
  },
  <span class="hljs-attr">unflipped</span>: {
    <span class="hljs-attr">rotateY</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">zIndex</span>: pages.<span class="hljs-property">length</span> - index,
    <span class="hljs-attr">transition</span>: {
      <span class="hljs-attr">rotateY</span>: { <span class="hljs-attr">duration</span>: <span class="hljs-number">0.6</span>, <span class="hljs-attr">ease</span>: [<span class="hljs-number">0.645</span>, <span class="hljs-number">0.045</span>, <span class="hljs-number">0.355</span>, <span class="hljs-number">1</span>] },
      <span class="hljs-attr">zIndex</span>: { <span class="hljs-attr">delay</span>: <span class="hljs-number">0.6</span> },
    },
  },
}
</code></pre>
<p>这里的贝塞尔曲线 <code>[0.645, 0.045, 0.355, 1]</code> 是精心调的，模拟纸张翻页时先快后慢的物理感。</p>
<h4 data-id="heading-5">3.2 拖拽翻页</h4>
<p>参考电子书阅读器的拖拽逻辑：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// mousedown → 记录起点</span>
<span class="hljs-comment">// mousemove → 计算偏移，用 rAF 优化性能</span>
<span class="hljs-comment">// mouseup → 偏移超过阈值(80px)则触发翻页</span>

<span class="hljs-keyword">const</span> handleMouseMove = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">e: MouseEvent</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (!isDragging) <span class="hljs-keyword">return</span>
  currentDragXRef.<span class="hljs-property">current</span> = e.<span class="hljs-property">clientX</span>
  <span class="hljs-keyword">if</span> (rafIdRef.<span class="hljs-property">current</span>) <span class="hljs-title function_">cancelAnimationFrame</span>(rafIdRef.<span class="hljs-property">current</span>)
  rafIdRef.<span class="hljs-property">current</span> = <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setDragOffset</span>(currentDragXRef.<span class="hljs-property">current</span> - dragStartXRef.<span class="hljs-property">current</span>)
  })
}, [isDragging])
</code></pre>
<p>拖拽过程中，当前页面会有一个「弓起」效果：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> curlAngle = isActiveDragPage
  ? <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(dragOffset) * <span class="hljs-number">0.25</span>, <span class="hljs-number">45</span>) * (dragOffset &lt; <span class="hljs-number">0</span> ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>)
  : <span class="hljs-number">0</span>
<span class="hljs-keyword">const</span> curlZ = isActiveDragPage
  ? <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(dragOffset) * <span class="hljs-number">0.15</span>, <span class="hljs-number">30</span>)
  : <span class="hljs-number">0</span>
</code></pre>
<p>根据拖拽偏移量，页面最多弓起 45°，同时沿 Z 轴抬升 30px，配合 <code>box-shadow</code> 产生投影，效果非常逼真。</p>
<h4 data-id="heading-6">3.3 页角海浪卷起效果 🌊</h4>
<p>这是整个组件最有趣的交互细节：鼠标悬停在页角时，纸张会像海浪一样卷起来，提示用户「这里可以翻页」。</p>
<p><strong>实现原理</strong>：在页面的右下角/左下角放置 80×80 的热区，hover 时用 <code>border-radius: 100%</code> + 渐变背景模拟卷角，配合 CSS <code>@keyframes</code> 实现呼吸式波浪动画。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-class">.cornerZone</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">80px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">80px</span>;
  <span class="hljs-attribute">cursor</span>: pointer;
}

<span class="hljs-selector-class">.curlEffect</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">transition</span>: width <span class="hljs-number">0.35s</span> <span class="hljs-built_in">cubic-bezier</span>(<span class="hljs-number">0.34</span>, <span class="hljs-number">1.56</span>, <span class="hljs-number">0.64</span>, <span class="hljs-number">1</span>),
              height <span class="hljs-number">0.35s</span> <span class="hljs-built_in">cubic-bezier</span>(<span class="hljs-number">0.34</span>, <span class="hljs-number">1.56</span>, <span class="hljs-number">0.64</span>, <span class="hljs-number">1</span>);
}

<span class="hljs-comment">// hover 时展开卷角</span>
<span class="hljs-selector-class">.cornerActive</span> <span class="hljs-selector-class">.curlEffect</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">55px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">55px</span>;
}
</code></pre>
<p>卷角的渐变模拟了纸张翻起时的明暗变化：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-class">.cornerBottomRight</span> <span class="hljs-selector-class">.curlEffect</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(
    <span class="hljs-number">225deg</span>,
    <span class="hljs-built_in">rgba</span>(<span class="hljs-number">253</span>, <span class="hljs-number">251</span>, <span class="hljs-number">247</span>, <span class="hljs-number">0.95</span>) <span class="hljs-number">0%</span>,    <span class="hljs-comment">// 翻起的纸面（亮）      </span>
    <span class="hljs-built_in">rgba</span>(<span class="hljs-number">253</span>, <span class="hljs-number">251</span>, <span class="hljs-number">247</span>, <span class="hljs-number">0.9</span>) <span class="hljs-number">35%</span>,
    <span class="hljs-built_in">rgba</span>(<span class="hljs-number">230</span>, <span class="hljs-number">225</span>, <span class="hljs-number">215</span>, <span class="hljs-number">0.85</span>) <span class="hljs-number">50%</span>,   <span class="hljs-comment">// 折痕处（暗）</span>
    <span class="hljs-built_in">rgba</span>(<span class="hljs-number">200</span>, <span class="hljs-number">195</span>, <span class="hljs-number">185</span>, <span class="hljs-number">0.4</span>) <span class="hljs-number">70%</span>,
    transparent <span class="hljs-number">100%</span>                  <span class="hljs-comment">// 渐隐到背景</span>
  );
  <span class="hljs-attribute">border-top-left-radius</span>: <span class="hljs-number">100%</span>;      <span class="hljs-comment">// 关键！圆弧形卷角</span>
}
</code></pre>
<p>海浪动画通过 <code>@keyframes</code> 让卷角大小在 50px - 70px 之间波动：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-keyword">@keyframes</span> curlWaveRight {
  <span class="hljs-number">0%</span>   { <span class="hljs-attribute">width</span>: <span class="hljs-number">55px</span>; <span class="hljs-attribute">height</span>: <span class="hljs-number">55px</span>; }
  <span class="hljs-number">30%</span>  { <span class="hljs-attribute">width</span>: <span class="hljs-number">70px</span>; <span class="hljs-attribute">height</span>: <span class="hljs-number">70px</span>; }  <span class="hljs-comment">// 浪涌</span>
  <span class="hljs-number">60%</span>  { <span class="hljs-attribute">width</span>: <span class="hljs-number">50px</span>; <span class="hljs-attribute">height</span>: <span class="hljs-number">50px</span>; }  <span class="hljs-comment">// 回落</span>
  <span class="hljs-number">100%</span> { <span class="hljs-attribute">width</span>: <span class="hljs-number">55px</span>; <span class="hljs-attribute">height</span>: <span class="hljs-number">55px</span>; }  <span class="hljs-comment">// 归位</span>
}
</code></pre>
<p>弹性过渡的贝塞尔曲线 <code>cubic-bezier(0.34, 1.56, 0.64, 1)</code> 让展开有一个「弹一下」的效果，像纸张被风吹起。</p>
<h3 data-id="heading-7">四、踩坑实录：那些让我抓狂的 Bug</h3>
<h4 data-id="heading-8">坑 1：页角点击不触发翻页</h4>
<p><strong>现象</strong>：鼠标在页角卷起后点击，但页面没有翻动。</p>
<p><strong>原因</strong>：<code>mousedown</code> 事件冒泡到了父容器 <code>.pages</code>，触发了拖拽逻辑（<code>isDragging = true</code>）。由于 React 的条件渲染逻辑写了 <code>!isDragging</code>，页角区域立刻被卸载，<code>onClick</code> 根本来不及触发。</p>
<p><strong>解决</strong>：在页角热区上阻止 <code>mousedown</code> 冒泡：</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;div
  className={styles.<span class="hljs-property">cornerZone</span>}
  onMouseDown={<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> e.<span class="hljs-title function_">stopPropagation</span>()}  <span class="hljs-comment">// 关键！</span>
  onTouchStart={<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> e.<span class="hljs-title function_">stopPropagation</span>()}
  onClick={<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    e.<span class="hljs-title function_">stopPropagation</span>()
    <span class="hljs-title function_">setCornerHover</span>(<span class="hljs-string">'none'</span>)
    <span class="hljs-title function_">nextPage</span>(e)
  }}
&gt;
</code></pre>
<h4 data-id="heading-9">坑 2：翻到下一页时左侧短暂闪烁</h4>
<p><strong>现象</strong>：翻页时左侧会短暂显示封面内容，然后才变成当前页的背面。</p>
<p><strong>第一次尝试（失败）</strong>：用 Framer Motion 的 <code>opacity</code> 动画延迟隐藏已翻过的页面。设置了 <code>delay: 0.65s</code>，等翻转动画完成后再隐藏。</p>
<p><strong>结果</strong>：时序不可靠。<code>opacity</code> 依赖 Framer Motion 的 variant 重算，<code>isBuriedLeft</code> 变化时 variant 值立刻更新，无论 delay 多少都可能出现竞态。</p>
<p><strong>最终方案</strong>：彻底放弃 <code>opacity</code> 动画，改用 CSS <code>visibility</code> 隐藏深层页面：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 只隐藏 "深层" 掩埋的页面（index &lt; currentPageIndex - 1）</span>
<span class="hljs-comment">// 保留紧邻的前一页可见，确保左侧始终有背面内容</span>
<span class="hljs-keyword">const</span> isDeeplyBuried = isFlipped &amp;&amp; index &lt; currentPageIndex - <span class="hljs-number">1</span>

&lt;motion.<span class="hljs-property">div</span> style={{
  <span class="hljs-attr">visibility</span>: isDeeplyBuried ? <span class="hljs-string">'hidden'</span> : <span class="hljs-string">'visible'</span>,
}}&gt;
</code></pre>
<p><code>visibility: hidden</code> 是<strong>即时的、无动画的、确定性的</strong>——完美解决闪烁问题。</p>
<h4 data-id="heading-10">坑 3：翻回上一页时又闪了</h4>
<p><strong>现象</strong>：修好了向后翻页，但翻回上一页时又出现闪烁。</p>
<p><strong>原因</strong>：<code>unflipped</code> variant 的 <code>zIndex</code> transition 的 <code>delay</code> 设为了 <code>0</code>，导致页面还在翻转动画过程中，zIndex 就提前降低了，被其他页面遮挡。</p>
<p><strong>解决</strong>：双向翻页的 <code>zIndex</code> 都延迟到动画结束后再更新：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-attr">unflipped</span>: {
  <span class="hljs-attr">rotateY</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">zIndex</span>: pages.<span class="hljs-property">length</span> - index,
  <span class="hljs-attr">transition</span>: {
    <span class="hljs-attr">rotateY</span>: { <span class="hljs-attr">duration</span>: <span class="hljs-number">0.6</span>, <span class="hljs-attr">ease</span>: [<span class="hljs-number">0.645</span>, <span class="hljs-number">0.045</span>, <span class="hljs-number">0.355</span>, <span class="hljs-number">1</span>] },
    <span class="hljs-attr">zIndex</span>: { <span class="hljs-attr">delay</span>: <span class="hljs-number">0.6</span> },  <span class="hljs-comment">// 和翻页动画时长一致！</span>
  },
},
</code></pre>
<h4 data-id="heading-11">坑 4：最后一页拖不动但光标还是「抓手」</h4>
<p><strong>现象</strong>：翻到最后一页（The End），虽然结束页已经阻止了事件冒泡，但在页面空白区域鼠标仍然显示 <code>grab</code> 光标。</p>
<p><strong>解决</strong>：检测最后一页状态，同时禁用拖拽逻辑和光标样式：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> isLastPage = currentPageIndex &gt;= pages.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>

<span class="hljs-comment">// 禁用 mousedown</span>
<span class="hljs-keyword">const</span> handleMouseDown = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (!isOpen || isLastPage) <span class="hljs-keyword">return</span>  <span class="hljs-comment">// 最后一页不触发拖拽</span>
  <span class="hljs-comment">// ...</span>
}, [isOpen, isLastPage])

<span class="hljs-comment">// 光标</span>
<span class="hljs-attr">cursor</span>: isOpen
  ? (isLastPage ? <span class="hljs-string">'default'</span> : isDragging ? <span class="hljs-string">'grabbing'</span> : <span class="hljs-string">'grab'</span>)
  : <span class="hljs-string">'default'</span>
</code></pre>
<h3 data-id="heading-12">五、最终效果</h3>
<p>组件支持的交互方式一览：</p>

































<table><thead><tr><th>交互方式</th><th>说明</th></tr></thead><tbody><tr><td>🖱️ 拖拽翻页</td><td>按住页面左右拖拽，超过 80px 阈值松手翻页</td></tr><tr><td>🌊 页角点击</td><td>悬停右下角/左下角出现卷起效果，点击翻页</td></tr><tr><td>🔘 导航栏</td><td>底部导航栏前后翻页按钮</td></tr><tr><td>⌨️ 键盘</td><td>← → 翻页 / Escape 关闭 / Home End 跳转</td></tr><tr><td>📱 触摸</td><td>移动端触摸滑动翻页</td></tr><tr><td>📕 封面</td><td>点击或向左拖拽打开书籍</td></tr></tbody></table>
<p>使用方式非常简单：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">InteractiveBook</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@stateless/InteractiveBook'</span>

&lt;<span class="hljs-title class_">InteractiveBook</span>
  coverImage=<span class="hljs-string">"/cover.jpg"</span>
  bookTitle=<span class="hljs-string">"AI Agent 完全指南"</span>
  bookAuthor=<span class="hljs-string">"AI 专家"</span>
  pages={[
    {
      <span class="hljs-attr">pageNumber</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">title</span>: <span class="hljs-string">'第一章'</span>,
      <span class="hljs-attr">content</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>正面内容<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>,
      <span class="hljs-attr">backContent</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>背面内容<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>,
    },
    <span class="hljs-comment">// ...</span>
  ]}
  onPageChange={<span class="hljs-function">(<span class="hljs-params">index</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'当前页:'</span>, index)}
  enableKeyboard
/&gt;
</code></pre>
<h3 data-id="heading-13">六、技术栈总结</h3>

































<table><thead><tr><th>技术</th><th>用途</th></tr></thead><tbody><tr><td>React + TypeScript</td><td>组件逻辑</td></tr><tr><td>Framer Motion</td><td>翻页动画、封面动画、导航栏动画</td></tr><tr><td>CSS 3D Transform</td><td><code>perspective</code>、<code>rotateY</code>、<code>preserve-3d</code>、<code>backface-visibility</code></td></tr><tr><td>CSS Modules (Less)</td><td>样式隔离</td></tr><tr><td>requestAnimationFrame</td><td>拖拽性能优化</td></tr><tr><td>lucide-react</td><td>图标</td></tr></tbody></table>
<h3 data-id="heading-14">七、写在最后</h3>
<p>一个看似简单的翻书组件，涉及了 <strong>CSS 3D 变换、事件冒泡机制、Framer Motion variant 生命周期、zIndex 时序控制</strong> 等多个知识点。最大的教训是：</p>
<blockquote>
<p><strong>不要用动画属性（opacity/transform）去做「显示/隐藏」这种二元状态控制。</strong> 用 <code>visibility</code> 或条件渲染——确定性比优雅更重要。</p>
</blockquote>
<p>完整代码已开源，欢迎 Star ⭐</p>
<hr/>
<p>GitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwkylin%2Fpro-react-admin" target="_blank" title="https://github.com/wkylin/pro-react-admin" ref="nofollow noopener noreferrer">Pro React Admin</a></p>
<p>预览地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwkylin.github.io%2Fpro-react-admin%2Fstorybook%2F%3Fpath%3D%2Fdocs%2Fstateless-interactivebook--docs" target="_blank" title="https://wkylin.github.io/pro-react-admin/storybook/?path=/docs/stateless-interactivebook--docs" ref="nofollow noopener noreferrer">Interactive Book</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b38133acbdf4cbdba0dad49c1ca2b75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5biC55WM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771134374&amp;x-signature=8vi1B84z7aKyHbJ8eF2sJ94Y3%2Fo%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51fa994a011548d5bab542b32cf4c44d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5biC55WM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771134374&amp;x-signature=jBlMH%2FU9vdjSpkIqb5fewPRH3Lg%3D" alt="image.png" loading="lazy"/></p>
<p><strong>如果这篇文章对你有帮助，别忘了点个赞 👍 收藏一下 📌</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[APP原生与H5互调Bridge技术原理及基础使用]]></title>    <link>https://juejin.cn/post/7603674653153427465</link>    <guid>https://juejin.cn/post/7603674653153427465</guid>    <pubDate>2026-02-08T03:57:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603674653153427465" data-draft-id="7603688142004469769" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="APP原生与H5互调Bridge技术原理及基础使用"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-08T03:57:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="黄诂多"/> <meta itemprop="url" content="https://juejin.cn/user/510642324769053"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            APP原生与H5互调Bridge技术原理及基础使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/510642324769053/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    黄诂多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T03:57:08.000Z" title="Sun Feb 08 2026 03:57:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">API使用</h2>
<h4 data-id="heading-1">js调用原生插件功能</h4>
<p>调用命名为'11'的插件里的一个定时器api：jsCallTimer</p>
<p>带回调结果带参数的调用方式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable constant_">YN</span>.<span class="hljs-title function_">callNative</span>(<span class="hljs-string">'11'</span>,<span class="hljs-string">"jsCallTimer"</span>,<span class="hljs-string">'我是传到原生端的参数'</span>,<span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) {
      <span class="hljs-keyword">if</span> (a == <span class="hljs-number">1</span>){
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"progress1"</span>).<span class="hljs-property">innerText</span> = value
      }<span class="hljs-keyword">else</span>{
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"progress2"</span>).<span class="hljs-property">innerText</span> = value
      }
    },<span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) {
      <span class="hljs-title function_">alert</span>(error)
    })
</code></pre>
<p>不带回调结果带参数的调用方式：</p>
<pre><code class="hljs language-arduino" lang="arduino">YN.<span class="hljs-built_in">callNative</span>(<span class="hljs-string">'11'</span>,<span class="hljs-string">"jsCallTimer"</span>,<span class="hljs-string">'我是传到原生端的参数'</span>)
</code></pre>
<p>不带回调结果不带参数的调用方式：</p>
<pre><code class="hljs language-arduino" lang="arduino">YN.<span class="hljs-built_in">callNative</span>(<span class="hljs-string">'11'</span>,<span class="hljs-string">"jsCallTimer"</span>)
</code></pre>
<h4 data-id="heading-2">原生调用js插件功能</h4>
<p>调用命名为'asynObj'的插件里的一个定时器api：startTimer</p>
<p>带回调结果带参数的调用方式：</p>
<pre><code class="hljs language-objectivec" lang="objectivec">[dwebview callHandler:<span class="hljs-string">@"asynObj"</span> action:<span class="hljs-string">@"startTimer"</span> arguments:<span class="hljs-string">@"我是传到js端的参数"</span> completionHandler:^(CallbackStatus status, <span class="hljs-type">id</span>  _Nonnull value, <span class="hljs-built_in">NSString</span> * _Nonnull callId, <span class="hljs-type">BOOL</span> complete) {
        [sender setTitle:[<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@"%@-%@"</span>,value,callId] forState:<span class="hljs-number">0</span>];
    }];
</code></pre>
<p>不带回调结果的调用方式：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">dwebview callHandler:@<span class="hljs-string">"asynObj"</span> action:@<span class="hljs-string">"startTimer"</span> arguments:@<span class="hljs-string">"我是传到js端的参数"</span> completionHandler:nil</span>];
</code></pre>
<h2 data-id="heading-3">一些全局约定</h2>
<ul>
<li>
<p>js调原生和原生调js的参数传递必须是json字符串格式。</p>
</li>
<li>
<p>api调用,底层逻辑必须使用命名空间方式即：namespace.apixxx的形式。</p>
</li>
<li>
<p>还有很多规范和约定，后续补充。</p>
</li>
</ul>
<h2 data-id="heading-4">js call native</h2>
<h4 data-id="heading-5">关键技术点</h4>
<p>原生Android端向浏览器注入供js调用的对象‘_anbridge’，对象里实现‘call()’方法，并且方法需要加上@JavascriptInterface注解，代码示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">WebSettings</span> <span class="hljs-variable">webSettings</span> <span class="hljs-operator">=</span> wv.getSettings();
webSettings.setJavaScriptEnabled(<span class="hljs-literal">true</span>);
wv.addJavascriptInterface(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JsApp</span>(),<span class="hljs-string">"_anbridge"</span>);
<span class="hljs-keyword">class</span> <span class="hljs-title class_">JsApp</span>{
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">JsApp</span><span class="hljs-params">()</span>{}
  <span class="hljs-meta">@JavascriptInterface</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">call</span><span class="hljs-params">(Object obj)</span>{

  }
}
</code></pre>
<p>原生iOS端</p>
<p>向浏览器配置对象里注入‘window._ynwk=true;’这段js代码，并且设置注入时机为开始加载时即：injectionTime=WKUserScriptInjectionTimeAtDocumentStart,代码实现：</p>
<pre><code class="hljs language-ini" lang="ini">///初始化注入js标记
    WKUserScript *<span class="hljs-attr">script</span> = [[WKUserScript alloc] initWithSource:@<span class="hljs-string">"window._ynwk=true;"</span>
                                                  injectionTime:WKUserScriptInjectionTimeAtDocumentStart
                                               forMainFrameOnly:<span class="hljs-literal">YES</span>]<span class="hljs-comment">;</span>
    <span class="hljs-section">[configuration.userContentController addUserScript:script]</span><span class="hljs-comment">;</span>
</code></pre>
<p>实现js端换起原生通信的关键是实现wk的h5输入框拦截回调方法- (void)webView:(WKWebView *)webView runJavaScriptTextInputPanelWithPrompt:(NSString *)prompt defaultText:(nullable NSString *)defaultText initiatedByFrame:(WKFrameInfo *)frame completionHandler:(void (^)(NSString * _Nullable result))completionHandler<br/>
当js端执行代码‘prompt()’时原生端就会自动调起该方法</p>
<p>在上面实现的基础上，js端判断window._anbridge为true则为与Android通信，执行代码：_anbridge.call(api, arg)，如果判断window._ynwk为true则为与iOS端通信，执行代码：prompt('_ynbridge=' + api, arg)，js端代码实现：</p>
<pre><code class="hljs language-ini" lang="ini">var <span class="hljs-attr">natiValue</span> = <span class="hljs-string">''</span><span class="hljs-comment">;</span>
if (window._anbridge)
   <span class="hljs-attr">natiValue</span> = _anbridge.call(api, arg)<span class="hljs-comment">;//调用android对象的call()</span>
else if (window._ynwk)
   <span class="hljs-attr">natiValue</span> = prompt(<span class="hljs-string">'_ynbridge='</span> + api, arg)<span class="hljs-comment">;</span>
</code></pre>
<p>原生端、js端提供的api都要通过命名空间的方式管理，如：api_1在‘namespace1’这个命名空间下的类里面，则js端调用api_1书写形式为‘namespace1.api_1’。</p>
<p>原生端和js端提供的功能都以插件的方式提供，插件（除基础插件）都继承自一个基础插件类，插件结果回调都是走异步回传值方式，同步方式也可以但暂没实现。</p>
<h4 data-id="heading-6">iOS端逻辑步骤</h4>
<p>基础插件对象是处理js通讯和插件扩展的必要条件，wk浏览器初始化好后将基础插件类注册进插件集合，然后读取配置文件里可用的其他插件，将每个插件类注册进插件集合，代码实现：</p>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-comment">//注册基础插件</span>
    [<span class="hljs-keyword">self</span> addJavascriptObject:<span class="hljs-keyword">self</span>.ynPlugin namespace:baseNameSpace];
    <span class="hljs-comment">//注册已有插件</span>
    <span class="hljs-built_in">NSString</span>* plistPath = [[<span class="hljs-built_in">NSBundle</span> mainBundle] pathForResource:<span class="hljs-string">@"applyPlugPlist"</span> ofType:<span class="hljs-string">@"plist"</span>];
    <span class="hljs-built_in">NSArray</span> *modules = [<span class="hljs-built_in">NSArray</span> arrayWithContentsOfFile:plistPath];
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSDictionary</span> *obj <span class="hljs-keyword">in</span> modules) {
        Class <span class="hljs-keyword">class</span> = <span class="hljs-built_in">NSClassFromString</span>(obj[<span class="hljs-string">@"plug"</span>]);
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">class</span> != <span class="hljs-literal">nil</span> &amp;&amp; ![<span class="hljs-keyword">class</span> isKindOfClass:[<span class="hljs-built_in">NSNull</span> <span class="hljs-keyword">class</span>]]) {
            [<span class="hljs-keyword">self</span> addJavascriptObject:[[<span class="hljs-keyword">class</span> alloc] init] namespace:obj[<span class="hljs-string">@"namespace"</span>]];
        }
    }
</code></pre>
<ol>
<li>
<p>js端的第一个信号来自wk的h5输入框拦截回调方法，参数prompt里携带js端要调用的api名字，参数值为字符串：_ynbridge=namespace1.api_1，_ynbridge=为YNBridge框架调用的标记，如果不是以这个标记开头则不做任何处理，只弹出正常的系统弹框。</p>
</li>
<li>
<p>通过api名，去插件集合里找有没有注册对应的插件对象，如果没有找到或找到了但插件下没有对应api则将错误结果返回js端</p>
</li>
<li>
<p>js调起的api，参数由defaultText携带。defaultText是json字符串，需要转换为json对象来解析出数据，参数值示例：{"data":null,"callId":"callId0"} data:真实参数值。 callId:api调用事件id或叫回传值队列id，当次api调用js需要回传值时此参数不为空，如果为空则表示当次api调用js端不需要结果回调</p>
</li>
<li>
<p>-(BOOL)exec:(YNJsCallInfo*)arg 此方法是插件接收数据的入口，这是个工厂方法子类必须实现，解析和组装好js过来的api和参数后用反射的方式执行对应插件的exec:方法，该方法同步方式返回个bool值，表示调用成功或失败，如果失败则将失败结果返回给js，代码实现：</p>
</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">BOOL</span>(*action)(id,SEL,id) = (BOOL(*)(id,SEL,id))objc_msgSend;
    BOOL ret=<span class="hljs-built_in">action</span>(JavascriptInterfaceObject,sel,info);
    if (ret) {
        return YES;
    }
    return <span class="hljs-selector-attr">[self nativeCallBackWithCode:ret ? OK : ERROR value:ret ? @<span class="hljs-string">"OK"</span> : error complete:YES callId:info.callId]</span>;
</code></pre>
<ol>
<li>
<p>exec:方法的形参是YNJsCallInfo对象，该对象携带的参数：<br/>
action:api名，或叫动作标识字符串，各业务通过该字段判断该执行什么功能，如果插件内没有处理该api则返回调用失败的错误值false反之返回true。<br/>
callId:api调用事件id或叫回传值队列id，当给js回传值时需要带上该值返回去。<br/>
data:js给过来的参数值。<br/>
callBack:block变量，结果回调入口，回传值时需要指定四个参数status、value、callId、complete，参数用处后面讲解。</p>
</li>
<li>
<p>功能实现完成后需要调用YNJsCallInfo对象的callBack回调方法，方法参数：<br/>
status:结果状态值，此值为一个枚举类型，OK表示成功ERROR表示失败。<br/>
value:结果值，该值最后在调用js回传值api时会转换为json字符串格式。<br/>
callId:api调用事件id或叫回传值队列id。<br/>
complete:bool值，当次api任务是否全部执行完毕，处理需要保活服务的长连接状态，false执行完毕，true服务需要继续保持。</p>
</li>
<li>
<p>api调用完毕，需要给js回传值时，调用wk的- (void)evaluateJavaScript:(NSString *)javaScriptString completionHandler:(void (^ _Nullable)(_Nullable id, NSError * _Nullable error))completionHandler方法 执行这段js代码：window.nativeCallBack('%@',%ld,%@,%d)，nativeCallBack()是js端接收原生端回传值的方法，接收四个参数，即为YNJsCallInfo对象的callBack回调参数。</p>
</li>
<li>
<p>原生功能通过插件的形式实现，要新增一个插件只需要： 第一步新建一个继承'YNPlugin'基础插件类的对象，然后在对象里实现方法-(BOOL)exec:(YNJsCallInfo*)arg； 第二步在YNBridgePlugPlist.plist文件里添加以下形式的代码</p>
</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dict</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>namespace<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>命名空间<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>plug<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>nativeCallBack
        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>插件类名<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dict</span>&gt;</span>
</code></pre>
<p>然后将命名空间名和相应的api名告诉js端即可</p>
<h4 data-id="heading-7">js端</h4>
<p>调起一个原生插件时，执行YN对象里面的callNative: function (service,action,actionArgs,successCallback,failCallback)方法，方法参数：<br/>
service:原生api对应的命名空间名。<br/>
action:api名。<br/>
actionArgs:需要给原生端的参数。<br/>
successCallback:成功的回调。<br/>
failCallback:失败的回调。 比如我要调起原生端11命名空间下的jsCallTimer这个api，让原生端执行一个定时器功能，代码实现：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable constant_">YN</span>.<span class="hljs-title function_">callNative</span>(<span class="hljs-string">'11'</span>,<span class="hljs-string">"jsCallTimer"</span>,<span class="hljs-literal">undefined</span>,<span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) {
      <span class="hljs-keyword">if</span> (a == <span class="hljs-number">1</span>){
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"progress1"</span>).<span class="hljs-property">innerText</span> = value
      }<span class="hljs-keyword">else</span>{
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"progress2"</span>).<span class="hljs-property">innerText</span> = value
      }
    },<span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) {
      <span class="hljs-title function_">alert</span>(error)
    })
</code></pre>
<ol>
<li>
<p>执行YN.call()方法，实现调起原生和结果回调队列的维护，如果注入过安卓js对象‘window._anbridge’则执行_anbridge.call(api, arg)调起安卓端，如果注入过‘window._ynwk’值为true则执行prompt('_ynbridge=' + api, arg)调起iOS端，如果需要有回传值，则arg对象将给callId字段赋一个唯一值，并且在window.nativeCallBackIds缓存集合里新增callId值，值即为回调函数。</p>
</li>
<li>
<p>所有插件调用的前提基础是js端和原生端都已正常初始化，并且通讯已建立，即deviceReady已为ture，deviceReady的询问会在js入口函数里执行，即通过YN.call()方法，执行一个原生YNBase.init的api，如果结果返回为OK则为deviceReady成功</p>
</li>
<li>
<p>原生端插件执行结果回调通过‘nativeCallBack = function (callId,status,args,complete)’方法接收值，方法内部通过callId在window.nativeCallBackIds对象里找到回调方法然后执行，将args值由json字符串转json对象后传入，判断complete字段，为true则执行：delete window.nativeCallBackIds[callId]代码，将该服务回调移除队列。</p>
</li>
</ol>
<h2 data-id="heading-8">native call js</h2>
<h4 data-id="heading-9">js端</h4>
<ol>
<li>实现思路和设计方式同js call native，即只是其一个反向过程，实现基础依然是需要实现和注册基础插件类，各子插件继承基础插件，结果回调都是通过异步回传值，所以细节不做重复阐述。</li>
<li>在入口函数执行基础插件和各插件对象的注册，注册完成后可以调用原生YNBase.jsinit这个api告诉原生端，代码实现：</li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino">YN.<span class="hljs-built_in">register</span>(<span class="hljs-string">'asynObj'</span>,<span class="hljs-keyword">new</span> <span class="hljs-built_in">YNPlugin</span>());
   YN.<span class="hljs-built_in">register</span>(<span class="hljs-string">'YNPlugin1'</span>,<span class="hljs-keyword">new</span> <span class="hljs-built_in">YNPlugin1</span>());
  <span class="hljs-comment">//告诉原生js初始化了，调原生初始化api（在js初始化前原生就要求执行的js方法可在jsinit方法里开始执行了）</span>
  <span class="hljs-keyword">if</span> (deviceReady){
    YN.<span class="hljs-built_in">call</span>(<span class="hljs-string">'YNBase.jsinit'</span>);
  }
</code></pre>
<p>register()方法内部实现同原生注册插件的形式，将插件和对应的命名空间添加进window.nativeNamespaceInterfaces集合。</p>
<ol start="3">
<li>
<p>接收原生端第一个信号由nativeCallJs = function(callId,service,action,actionArgs)方法接收，参数：<br/>
callId:api调用事件id或叫回传值队列id。<br/>
service:js api对应的命名空间名。<br/>
action:api名。<br/>
actionArgs:原生端的参数。 方法内部实现同原生插件调用，也是找到插件并执行插件方法exec(action,args,responseCallback)。</p>
</li>
<li>
<p>插件回传值结果和api调用结果通过调用原生的YNBase.returnValue这个api实现，即执行YN.call('YNBase.returnValue', value); value是参数对象，包含data、callId、complete、status四个字段，含义和用途同原生回调那里。</p>
</li>
</ol>
<h4 data-id="heading-10">iOS端</h4>
<ol>
<li>
<p>调起一个js端的插件功能，执行wk对象的方法-(void)callHandler:(NSString*)server action:(NSString *)action arguments:(id)args completionHandler:(JSCallback)completionHandler;该方法逻辑同js call native时调用的YN.call()方法，通过维护一个callid服务队列来处理结果回传。</p>
</li>
<li>
<p>组装好参数后浏览器执行window.nativeCallJs('%@','%@','%@',%@)这个js代码即可调起js，代码示例：</p>
</li>
</ol>
<pre><code class="hljs language-objectivec" lang="objectivec">[<span class="hljs-keyword">self</span> evaluateJavaScript:[<span class="hljs-built_in">NSString</span> stringWithFormat:<span class="hljs-string">@"window.nativeCallJs('%@','%@','%@',%@)"</span>,info.callId,info.service,info.action,[JSBUtil objToJsonString:info.args]]];
</code></pre>
<p>接收插件结果回传值在基础插件里监听returnValue这个api的执行，逻辑处理同js端nativeCallBack()方法。也是如果complete字段值为true时将该服务对象从队列里移除</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[command和shell模块到底区别在哪？]]></title>    <link>https://juejin.cn/post/7603651011979427882</link>    <guid>https://juejin.cn/post/7603651011979427882</guid>    <pubDate>2026-02-08T04:27:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603651011979427882" data-draft-id="7603769956974936105" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="command和shell模块到底区别在哪？"/> <meta itemprop="keywords" content="Linux,Ansible,云计算"/> <meta itemprop="datePublished" content="2026-02-08T04:27:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Sheffield"/> <meta itemprop="url" content="https://juejin.cn/user/362164852109770"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            command和shell模块到底区别在哪？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/362164852109770/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Sheffield
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T04:27:58.000Z" title="Sun Feb 08 2026 04:27:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>刚学Ansible的新手，肯定都懵过：command和shell模块，不都是远程执行命令吗？为啥有时候用command报错，换shell就好使？</p>
<p>核心就1句大白话：<strong>执行命令时，要不要找“中间人”（shell解释器）帮忙</strong>。不用记复杂概念，今天用最简单的话+实操例子，讲清两者区别，新手看完就知道该用哪个。</p>
<h2 data-id="heading-0">一、先搞懂：两者执行方式不一样</h2>
<p>不用管底层原理，记住两个类比，瞬间明白：</p>
<h3 data-id="heading-1">1. command模块：直接“喊”程序干活，不找中间人</h3>
<p>用command执行命令，会直接调用目标机器上的程序，不经过任何“翻译”（shell解释器，比如bash）。</p>
<p>例子：用command执行ls /home，Ansible直接找到系统里的ls程序，让它查/home目录，一步到位。</p>
<p>特点：快、简单，但笨——不支持任何“高级操作”（比如管道、重定向）。</p>
<h3 data-id="heading-2">2. shell模块：先找中间人，再让中间人“喊”程序干活</h3>
<p>用shell执行命令，会先启动目标机器的默认“中间人”（默认是/bin/sh），再让这个中间人去调用程序、执行命令。</p>
<p>还是执行ls /home，用shell的话，流程是：Ansible启动中间人→中间人喊ls程序→执行命令。</p>
<p>特点：灵活、能干——支持所有高级操作，但比command慢一点，还有点安全风险。</p>
<h2 data-id="heading-3">二、核心区别：一张表看清</h2>
<p>不用死记，遇到分不清的情况，对照这张表找答案，一目了然：</p>








































<table><thead><tr><th>对比维度</th><th>command模块</th><th>shell模块</th></tr></thead><tbody><tr><td>要不要中间人（shell）</td><td>不要，直接调用程序</td><td>要，默认用/bin/sh</td></tr><tr><td>支持管道(|)</td><td>不支持（新手记死）</td><td>支持</td></tr><tr><td>支持重定向（&gt;、&gt;&gt;）</td><td>不支持（新手记死）</td><td>支持</td></tr><tr><td>支持环境变量（$HOME等）</td><td>不支持（直接输出$HOME）</td><td>支持（能输出真实路径）</td></tr><tr><td>安全性</td><td>高（不容易出问题）</td><td>较低（有安全风险）</td></tr><tr><td>Ansible默认用哪个</td><td>是（不指定模块就用它）</td><td>否（要手动指定-m shell）</td></tr></tbody></table>
<h2 data-id="heading-4">三、实战示例：新手最常遇到的3种情况</h2>
<p>光看表不够，结合例子练1次，以后再也不踩坑！</p>
<h3 data-id="heading-5">场景1：简单命令（比如重启服务）——优先用command</h3>
<p>像重启nginx、查看文件，这种简单操作，两者都能用，但优先选command（快、安全）。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 推荐：用command重启nginx</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">restart</span> <span class="hljs-string">nginx</span> <span class="hljs-string">with</span> <span class="hljs-string">command</span>
  <span class="hljs-attr">command:</span> <span class="hljs-string">systemctl</span> <span class="hljs-string">restart</span> <span class="hljs-string">nginx</span>

<span class="hljs-comment"># 能用但没必要：用shell重启nginx</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">restart</span> <span class="hljs-string">nginx</span> <span class="hljs-string">with</span> <span class="hljs-string">shell</span>
  <span class="hljs-attr">shell:</span> <span class="hljs-string">systemctl</span> <span class="hljs-string">restart</span> <span class="hljs-string">nginx</span>
</code></pre>
<h3 data-id="heading-6">场景2：用管道、重定向——只能用shell</h3>
<p>新手最容易踩坑的地方！只要命令里有|、&gt;、&gt;&gt;，用command必报错，换shell就好。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 错误：command不能用管道</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">查看java进程（报错）</span>
  <span class="hljs-attr">command:</span> <span class="hljs-string">ps</span> <span class="hljs-string">aux</span> <span class="hljs-string">|</span> <span class="hljs-string">grep</span> <span class="hljs-string">java</span>

<span class="hljs-comment"># 正确：用shell执行管道命令</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">查看java进程（正常）</span>
  <span class="hljs-attr">shell:</span> <span class="hljs-string">ps</span> <span class="hljs-string">aux</span> <span class="hljs-string">|</span> <span class="hljs-string">grep</span> <span class="hljs-string">java</span>

<span class="hljs-comment"># 正确：用shell重定向写入文件</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">写内容到文件</span>
  <span class="hljs-attr">shell:</span> <span class="hljs-string">echo</span> <span class="hljs-string">"Sheffield"</span> <span class="hljs-string">&gt;</span> <span class="hljs-string">/tmp/test.txt</span>
</code></pre>
<h3 data-id="heading-7">场景3：用环境变量（比如$HOME）——只能用shell</h3>
<p>想调用<code>$HOME、$PATH</code>这种环境变量，command不识别，必须用shell。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 正确：用shell查看家目录</span>
- name: 查看家目录
  shell: <span class="hljs-built_in">echo</span> <span class="hljs-variable">$HOME</span> <span class="hljs-comment"># 会输出/root（管理员用户）</span>

<span class="hljs-comment"># 错误：command查看家目录（只会输出$HOME）</span>
- name: 查看家目录（报错效果）
  <span class="hljs-built_in">command</span>: <span class="hljs-built_in">echo</span> <span class="hljs-variable">$HOME</span>
</code></pre>
<h2 data-id="heading-8">四、安全提醒</h2>
<p>shell虽然好用，但如果命令里有用户输入、变量，容易被恶意攻击（比如删文件）。</p>
<p>简单说：能不用shell就不用，必须用的时候，别随便放用户输入的内容。</p>
<h2 data-id="heading-9">五、新手速记：3句话搞定所有场景</h2>
<ol>
<li>简单命令（不涉及|、&gt;、$）：优先用command（默认、安全、快）；</li>
<li>用到管道、重定向、环境变量：只能用shell；</li>
<li>命令里有用户输入、变量：优先用command，避免风险。</li>
</ol>
<h2 data-id="heading-10">常见误区（避坑！）</h2>
<ol>
<li>
<p>误区：shell比command强，所有场景都用shell</p>
<p>——错！非必要不用，费资源还不安全；</p>
</li>
<li>
<p>误区：两者用法不一样</p>
<p>——错！常用参数（比如切换目录），用法完全相同；</p>
</li>
<li>
<p>误区：command用不了的，shell也用不了</p>
<p>——错！只要有shell解释器，shell都能搞定。</p>
</li>
</ol>
<p>其实新手不用想太复杂，记住“简单用command，复杂用shell”，就能应对99%的场景。练两次实操，很快就能分清～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浅析二叉树、B树、B+树和MySQL索引底层原理]]></title>    <link>https://juejin.cn/post/7603651855236743177</link>    <guid>https://juejin.cn/post/7603651855236743177</guid>    <pubDate>2026-02-08T06:02:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603651855236743177" data-draft-id="7603674653153689609" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浅析二叉树、B树、B+树和MySQL索引底层原理 "/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-08T06:02:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神奇小汤圆"/> <meta itemprop="url" content="https://juejin.cn/user/1151943919285431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浅析二叉树、B树、B+树和MySQL索引底层原理 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943919285431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神奇小汤圆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T06:02:48.000Z" title="Sun Feb 08 2026 06:02:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>数据库是后端工程师绕不开的核心技术，而索引则是核心中的核心。在日常工作中，我们每天都在和索引打交道，索引问题也是高级工程师面试中，面试官最喜欢考察的地方。</p>
<p>  很多开发者在面试中谈及索引时，往往只能给出一些零散、机械的记忆性答案，比如“B+树查询快”、“索引能提速”。这样的回答在面试官心中留下的深刻印象就是此候选人学习知识浅尝辄止，不够深入，不够努力。真正体现一个工程师技术深度的，是对索引背后设计原理的系统性理解，以及在复杂场景下进行选型和优化的能力。</p>
<p>  在 MySQL 中，通常所说的索引，如果没有特别声明，默认都是指 B+ 树数据结构的索引。在介绍各种树的数据结构和MySQL索引之前，先介绍本文多次使用的几个基本概念：</p>
<p><strong>节点</strong>：包含一个数据元素及若干指向子树的指针等。<br/>
<strong>根节点</strong>：是树的起始节点，它没有父节点，就像是大树的根基，其它节点都从根节点衍生出来。<br/>
<strong>叶子节点</strong>：也叫终端节点，是没有子节点的节点，它们位于树的最底层，就像树枝的末梢。<br/>
‌<strong>内部节点</strong>（internal Node）‌：至少有一个子节点的节点，包括根节点和所有非叶子节点。<br/>
<strong>兄弟节点</strong>： 具有相同父节点的节点。<br/>
<strong>节点的度</strong>：该节点拥有的子节点个数。例如二叉树中节点的度最大为 2，即每个节点最多有两个子节点。<br/>
<strong>树的度</strong>：整棵树中所有节点的最大度数。<br/>
<strong>层级</strong>：从根节点开始，树的每一层都是一个层级。<br/>
<strong>高度</strong>（height）：当前节点到最远叶子节点的最长路径上的节点数。<br/>
<strong>平衡因子</strong>（Balance Factor）：简称BF，每个节点的左右子树的高度之差。<br/>
<strong>数据页</strong>：树上每个节点在计算机中叫做数据页，是 InnoDB 存储引擎与磁盘交互的最小单位，默认大小为 16KB。<br/>
<strong>阶数</strong>：一个节点最多可以有多少个子节点（即节点的最大度数），一般用小写字母m表示阶数。用⌈m/2⌉表示对m/2向上取整数。例如，三阶 B+ 树 → 每个节点最多 3 个子节点 → 最大度 = 3。</p>
<p>  在数据库中我们将B+树作为索引结构，可以加快查询速度，此时树中的key一般是表的主键。例如，MySQL InnoDB 的记录，就是按照主键由小到大排序后，存在 B+ 树的叶子节点里。树中每个节点存储了关键字（key）、关键字对应的数据（data）以及指向孩子节点的指针。我们将一个key及其对应的data称为一条 <strong>记录</strong>。但为了方便描述，除非特别说明，后续文中就用“关键字”来代指（key, value）键值对。下面就是MySQL中索引的数据结构：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1425079df27a4ec6961449e319c95016~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771135404&amp;x-signature=tDSMLNqTd%2FyFEdPl1CSvqd6ZH1w%3D" alt="image" loading="lazy"/><br/>
图1 索引的数据结构。备注：磁盘块4有笔误，应该删除10。</p>
<p>  不同的树结构适用于不同的应用场景，选择合适的树结构可以显著提高程序的性能和效率。在分析为什么MySQL InnoDB存储引擎的索引选择使用B+树之前，我相信很多攻城狮对数据结构中的树还是有些许模糊的，因此就让我们一同踏上这趟由浅入深探讨二叉查找树、AVL树、红黑树、B树和B*树的奇妙之旅，一步步引出B+树以及为什么MySQL InnoDB数据库索引选择使用B+树！领略B+树在数据库索引中应用的神奇魅力。希望通过本文，你能构建起一个体系化的树和索引知识框架，让你在未来的面试和工作中游刃有余。</p>
<h3 data-id="heading-0">二叉查找树</h3>
<p>  二叉查找树(Binary Search Tree, BST)也称为有序二叉树（Ordered Binary Tree）、排序二叉树（sorted binary tree）或者二叉搜索树，是一棵满足以下三个性质的二叉树：</p>
<ol>
<li>有序性：任意非空左子树所有节点的值均小于该节点的值；非空右子树所有节点的值均大于于该节点的值；</li>
<li>递归性：任意节点的子树都是二叉查找树；</li>
<li>每个节点存储一条记录，且没有键值相等的节点。</li>
</ol>
<p>  从递归定义的角度来看，二叉查找树可以被定义为：要么是一棵空树，要么是由一个根节点和两棵互不相交的，分别称作根的左子树和右子树组成的非空树；而左子树和右子树又同样都是二叉查找树。这种递归定义方式简洁而准确地描述了二叉查找树的结构特点。它作为基础的树形结构，<strong>每个节点最多有两个子节点</strong>，其递归性和有序性为我们理解更复杂的树结构奠定了基础。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c3fe3ef4df44f3891671296a5f6f280~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771135404&amp;x-signature=2WNazK3yj09jeAg7U3I%2BfBWNA7E%3D" alt="image" loading="lazy"/><br/>
图2 二叉搜索树</p>
<p>  如果我们需要查找id=31的记录，利用我们创建的BST，基于二分查找算法实现的查找流程如下：</p>
<ol>
<li>将根节点作为当前节点，把31与当前节点的键值33比较，31小于33，接下来我们把当前节点的左子节点作为当前节点。</li>
<li>继续把31和当前节点的键值28比较，发现31大于28，把当前节点的右子节点作为当前节点。</li>
<li>把31和当前节点的键值31对比，发现二者相等，满足条件，遍历结束。</li>
</ol>
<p>  所以，我们利用BST只需要3次即可找到目标数据。</p>
<p>  二叉树的查找、插入和删除操作的时间复杂度在平均情况下为 O(logn) ，但在最坏情况下，当二叉树退化为链表时，时间复杂度会变为 O(n) 。这是因为在最坏情况下，所有节点都在一条链上，查找、插入和删除都需要遍历整个链表。如下图所示退化的二叉查找树：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cdd2f92a86b41e39d80d6337863cad4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771135404&amp;x-signature=UzRdZ3knfyovWg%2BZOtpNmTRnBxI%3D" alt="image" loading="lazy"/></p>
<p>  二叉树完全不平衡时，查找的时间复杂度就和链表一致了：O(n)。导致这个现象的原因其实是BST变得不平衡了，也就是高度太高了，从而导致查找效率的不稳定。为了解决这个问题，我们需要保证二叉查找树一直保持平衡，从而引出了一个新的定义——平衡二叉树AVL。</p>
<h3 data-id="heading-1">AVL树/红黑树</h3>
<p>  平衡二叉树（Balanced Binary Tree）是一种特殊的、平衡的二叉搜索树，通过严格控制每个节点的平衡因子来保持树的平衡。常见的平衡二叉树有AVL树和红黑树等，在满足BST特性的基础上，具有如下特性：</p>
<ol>
<li>平衡因子限制‌：要求平衡因子的绝对值不能超过1。</li>
<li>递归性质‌：左右两个子树本身也都是平衡二叉树。</li>
</ol>
<p>  不管是执行插入还是删除操作，只要不满足上面的条件，就要通过旋转树上的节点来保持平衡，使得树的高度始终保持在 O(logn)的范围内。而旋转是非常耗时的，由此我们可以知道AVL树适合用于插入或者删除次数比较少，但查找多的情况。</p>
<p>🤔 为什么要平衡？</p>
<p>  保持效率：平衡的二叉搜索树可以确保不管是执行插入还是删除操作都能在O(logn)时间内完成，这对于需要高效处理数据的系统来说至关重要。</p>
<p>  避免最坏情况：没有平衡机制的数据结构在最坏情况下可能会退化成链表，导致效率大大降低。平衡机制通过旋转操作<br/>
完成，而旋转操作非常耗时，由此我们可以知道AVL树适合用于插入或者删除次数比较少，但查找多的情况。本文不介绍具体的旋转操作。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/938839846591468ca7f81485a5c664ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771135404&amp;x-signature=AKUbnuhg%2F7qN0PNfKup1U%2FG8WeQ%3D" alt="image" loading="lazy"/></p>
<p>  平衡二叉树通过约束节点的子树高度差，确保树的高度保持对数级，相比于二叉查找树来说，查找效率更稳定，总体的查找速度也更快。</p>
<p>  红黑树（Red-Black Tree）因节点是红色和黑色两种颜色之一而命名，它本身是一棵二叉查找树，在其基础上做了如下约束：</p>
<ul>
<li>根节点是黑色节点</li>
<li>所有叶子节点（NIL节点）都是黑色的</li>
<li>节点的颜色要么是黑色要么是红色</li>
<li>无连续红色节点：红色节点的子节点为黑色节点（即相邻的两个节点不可能同时为红色）</li>
<li>任意节点的左子树和右子树高度（只统计黑色节点）相同</li>
<li>旋转操作：当插入或删除导致树不平衡时，通过旋转操作来恢复平衡。</li>
</ul>
<p>  这些规则看起来是否有点复杂？其实它们的核心目的只有一个：控制整棵树的高度，防止退化成链表。</p>
<p>  下图是一个标准的红黑树：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1d06f02ab84420fa341474d8011b03c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771135404&amp;x-signature=l%2FG6MXeZLG1koYAovjrS7DrFxfo%3D" alt="image" loading="lazy"/></p>
<p>  黑色完美平衡：“任意节点的左子树和右子树高度（只统计黑色节点）相同 &amp; 红色节点的子节点是黑色节点”。这就保证了红黑树的“平衡性”。由于这种平衡，其查询的复杂度自然也是O(log n)的。</p>
<p>红黑树与AVL树的区别：</p>






























<table><thead><tr><th>特性</th><th>AVL 树</th><th>红黑树</th></tr></thead><tbody><tr><td>平衡性</td><td>非常严格，平衡因子最多为1</td><td>近似平衡，只要求从根到叶子的最长路径不超过最短路径的两倍</td></tr><tr><td>插入性能</td><td>多次旋转，效率较低</td><td>快（最多两次旋转）</td></tr><tr><td>删除性能</td><td>多次旋转，效率更低，代价更高</td><td>较快（最多三次旋转）</td></tr><tr><td>查找性能</td><td>更快</td><td>稍慢（但仍为 O(log n)）</td></tr></tbody></table>
<p>  相较于 AVL 树，它是一种弱平衡二叉树，不需要像 AVL 树那样严格要求平衡，这也导致它的查询效率并没有 AVL 树那么高，但相对的，它带来的好处是对于调整失衡，红黑树的旋转次数更少，所以频繁的插入或删除操作，红黑树更有优势。</p>
<p>  AVL 是“强迫症患者”，每次插入删除都可能引发多次旋转，代价太高；而红黑树是“实用主义者”，它不要求完全平衡，只要能保证查找效率不崩就行。红黑树是在“速度”、“稳定性”和“实现成本”之间找到的一个折中王者！</p>
<p>  红黑树更常用于需要高频插入和删除的场景，例如：java 8 HashMap和ConcurrentHashMap中链表转红黑树；epoll在内核中的实现，用红黑树管理事件块（文件描述符）；Java的TreeMap和TreeSet实现；linux进程CFS调度器（Completely Fair Scheduler）用红黑树管理进程控制块 ；nginx中，用红黑树管理timer。AVL树更适合读多写少的场景，因为它的查找性能更接近完美的平衡树。</p>
<h3 data-id="heading-2">B树(B-tree)</h3>
<p>  当数据量太大，无法全部装入内存时，就必须存放在磁盘上。磁盘I/O（读写）速度远远逊色于内存访问。B树和B+树就是为了减少磁盘I/O次数而设计的多路平衡搜索树，它们被广泛用于数据库和文件系统的索引。下面介绍B树。</p>
<p>  B树（Balance Tree）也称B-树，是一棵平衡多路查找树，<strong>节点的子节点个数可能超过两个</strong>，用来存储排序后的数据。我们描述一棵B树时需要指定它的阶数m，当m=2时，就是我们常见的二叉搜索树。B树是一种自平衡的树状数据结构，能够让数据的查找、插入及删除动作都在对数时间内完成，常常用在存储系统上，如数据库或文件系统。</p>
<p>  一棵m阶的B树，或为空树，或为满足下列特性的m叉树：</p>
<ol>
<li>每个节点最多有m（m&gt;=2）棵子树，除非根节点为叶子节点，否则，至少有两棵子树。例如，对于一个4阶B树，每个节点最多有4个孩子，最少有2个孩子；</li>
<li>每个节点存放至少 <strong>⌈m/2⌉-1</strong> 个关键字，至多 <strong>m-1</strong> 个关键字；</li>
<li>关键字个数比孩子节点个数小1。即如果一个节点有k个关键字，那么它就有k + 1个孩子。如下图所示为一棵3阶B树的结构示意图，根节点有2个关键字和3个指针，它有3个孩子，这些孩子分别对应关键字划分的3个区间：</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91865d6b93bc483a98957fb0e22feb43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771135404&amp;x-signature=Vr1Eq6Cx%2BOMo6vcD1P2dnT5H%2FEU%3D" alt="image" loading="lazy"/></p>
<ol start="2">
<li>若根节点不是叶子节点，则至少包含两棵子树（特殊情况：没有孩子的根节点，即根节点为叶子节点，整棵树只有一个根节点）；</li>
<li>除根节点和叶子节点外，其它每个节点至少有 <strong>⌈m/2⌉</strong> 棵子树；</li>
<li>每个节点中的关键字都按照从小到大的顺序排列，每个关键字的左子树中的所有关键字都小于它，而右子树中的所有关键字都大于它；</li>
<li>所有叶子节点都位于同一层，或者说根节点到每个叶子节点的长度都相同。这保证了B树的平衡性，使得查找操作的时间复杂度为O(logn)。</li>
</ol>
<p>  下图即是一棵 m=3 的B树：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e41b73427d8b47ebb6a039f3b6c8f06c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771135404&amp;x-signature=YJMBBJzKBXHMAR2ikjE1qOXkts8%3D" alt="image" loading="lazy"/></p>
<p>  在实际应用中B树的阶数都非常大，通常大于100，所以即使存储大量的数据，B树的高度仍然比较小。每个节点中存储了关键字（key）和关键字对应的数据（data）以及孩子节点的指针。B树和平衡二叉树的不同之处：B树属于多叉树，父节点的子节点个数不止两个。注意: 有文章把B树和B-tree理解成了两种不同类别的树，其实二者是同一种树。B树有如下数据特征：</p>
<ol>
<li>数据存储在整棵树中；</li>
<li>任何一个关键字出现且只出现在一个节点中；</li>
<li>搜索有可能在非叶子节点结束，故查询性能不稳定；</li>
<li>其搜索性能等价于在关键字全集内做一次二分查找；</li>
<li>自动平衡树的高度和数据页。</li>
</ol>
<p>  B-树的查询方式如下：从根节点开始，对节点内的关键字（有序）序列进行二分查找，如果命中则结束，否则进入查询关键字所属范围的儿子节点；重复，直到所对应的儿子指针为空，或已经是叶子节点。</p>
<h3 data-id="heading-3">B+树（B+ Tree）</h3>
<p>  B+树是在B树的基础上又一次改进的多路平衡搜索树，其主要在两个方面进行了提升，一方面是查询的稳定性，让查询速度更加稳定，其速度完全接近于二分查找；另外一方面是在数据排序方面更友好，更充分的利用节点的空间。B+树包含两种类型的节点：内部节点（也称索引节点）和叶子节点。根节点本身即可以是内部节点，也可以是叶子节点。B+树的规则与B树基本类似，但是又在B树的基础上做了以下几点改进：</p>
<ul>
<li>父节点存有指向右子树第一个元素的索引。</li>
<li>内部节点不存储数据，只存储索引，用于路由，叶子节点存完整行数据（主键索引）或 (索引列 + 主键)（二级索引）。这是B+树与B树的最大差异。</li>
<li>内部节点的子树指针与关键字个数相同。</li>
<li>内部节点的关键字都按照从小到大的顺序排列，对于内部节点中的一个关键字，左子树中的所有关键字都小于它，右子树中的关键字都大于等于它。</li>
<li>所有叶子节点都存储指向下一个相邻叶子节点的指针，形成一个单向链表。</li>
</ul>
<p>  下图是一棵m=3的B+树：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27aaed6dd99840d98bca40692deb7fd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771135404&amp;x-signature=WinfQPeM4GOFHcisfAwOaVZqoF4%3D" alt="image" loading="lazy"/></p>
<p>MySQL中的B+树是上述B+树的又一次进化：MySQL基于普通B+Tree，在叶子节点添加了一个指向上一个相邻叶子节点的指针，并且首尾叶子节点也是相连的，也就是构造了一个如图1所示的双链表。下文再提及B+树时，指带有双向链表的MySQL B+树。</p>
<p>  B+树相对于B树有一些自己的巨大优势，可以归结为下面几点：</p>

























<table><thead><tr><th>优势</th><th>说明</th></tr></thead><tbody><tr><td>更稳定的查询效率</td><td>数据仅存储在叶子节点，任何查找都必须走到叶子节点，路径长度相同，性能稳定。</td></tr><tr><td>更高的空间利用率</td><td>内部节点不存数据，存储的关键字更多，树更矮，读取数据时I/O次数更少。</td></tr><tr><td>强大的范围查询</td><td>叶子节点通过指向前后叶子节点的指针形成了一个有序双向链表，故可以高效地进行范围查询和反向排序，而B树需要进行复杂的中序遍历。</td></tr><tr><td>更适合磁盘预读</td><td>磁盘按数据页读写。B+树的节点通常设计为恰好一数据页大小，一次I/O能加载更多键，进一步减少I/O。</td></tr></tbody></table>
<p>  B+树的插入操作很简单，只需要记住一个技巧即可：当节点元素数量大于m-1的时候，就按中间元素分裂成左右两部分，中间元素的关键字分裂到父节点当做索引存储，但是，本身中间元素还是分裂到右子树中。</p>
<blockquote>
<p><strong>面试题</strong>：B+树为什么比B树更适合作为操作系统的文件索引和数据库索引？</p>
</blockquote>
<p>  简答如下：<br/>
<strong>B+树的磁盘读写代价更低</strong>。它的内部节点没有存储记录，因此内部节点相对B树占用的存储空间更小。如果把所有同一内部节点的关键字放在同一块磁盘中，盘块所能容纳的关键字数量也就越多，一次性读入内存中的需要查找的关键字也就越多，相对I/O读写次数降低。</p>
<p>  <strong>B+树的查询效率更加稳定</strong>。由于非终节点并不是最终指向文件内容的节点，而只是叶子节点中关键字的索引。所以任何关键字的查找必须走一条从根节点到叶子节点的路。所有关键字查询的路径长度相同，导致每一个数据的查询效率相当。</p>
<p>  <strong>B+树支持范围查询</strong>。B+树只要遍历叶子节点就可以实现整棵树的遍历，支持基于范围查询，而B树不支持范围查找。</p>
<blockquote>
<p>面试题：为什么 InnoDB 选择 B+ 树作为索引结构？</p>
</blockquote>
<p>  相对于二叉树，B+ 树的层级更少，搜索效率更高。相对 Hash 索引，B+ 树支持范围查找以及排序操作。对于 B- 树，无论是叶子节点还是非叶子节点都会保存数据，这样会导致一页中存储的键值减少，指针跟着减少；要同样保存大量数据，只能增加树的高度，导致性能降低。B+ 树中间节点没有卫星数据（索引元素所指向的数据记录），只有索引。这就意味着同样的大小的磁盘页可以容纳更多节点元素，在相同的数据量下，B+ 树更加 “矮胖”，I/O 操作更少。因为卫星数据的不同，导致查询过程也不同；B- 树的查找只需找到匹配元素即可，最好情况下查找到根节点，最坏情况下查找到叶子结点，所说性能很不稳定，而 B+ 树每次必须查找到叶子结点，性能稳定。</p>
<h3 data-id="heading-4">B*树（B star Tree）</h3>
<p>  B<em>树是普通B+树的变形，在普通B+树除根节点外的内部节点增加指向兄弟节点的指针，将节点的最低利用率从普通B+树的1/2提升到2/3。下图是一棵m=3的B</em>树：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fed75f90c5c46acb10d8d338176e70c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771135404&amp;x-signature=lAUbVGEnXpbRU9tng0FiLqEk5tg%3D" alt="image" loading="lazy"/></p>
<p>  在B+树的基础上因其初始化的容量变大，使得节点空间使用率更高，而又存有兄弟节点的指针，可以向兄弟节点转移关键字的特性使得B*树分裂次数变得更少。</p>
<p>  B+树的分裂：当一个节点满时，分配一个新的节点，并将原节点中1/2的数据复制到新节点，最后在父节点中增加新节点的指针；B+树的分裂只影响原节点和父节点，而不会影响兄弟节点，所以它不需要指向兄弟节点的指针。</p>
<p>  B<em>树的分裂：当一个节点满时，如果它的下一个兄弟节点未满，那么将一部分数据移到兄弟节点中，再在原节点插入关键字，最后修改父节点中兄弟节点的关键字（因为兄弟节点的关键字范围改变了）；如果兄弟也满了，则在原节点与兄弟节点之间增加新节点，并各贡献三分之一的数据到新节点，最后在父节点增加新节点的指针。所以，B</em>树分配新节点的概率比B+树要低，空间使用率更高。</p>
<h3 data-id="heading-5">树的总结</h3>
<p>1、相同思想和策略</p>
<p>  从平衡二叉树、B树、B+树、B*树总体来看它们的贯彻的思想是相同的，都是采用二分查找和数据平衡策略来提升查找数据的速度。</p>
<p>2、不同的方式对树的不断优化</p>
<p>  为了保证树的节点均匀分布，所以在二叉树的基础上加上了平衡算法，就有了平衡二叉树。</p>
<p>  为了减少树的高度，所以B树一个节点下面可以添加N个子节点，然后每个节点的大小默认限制在16KB，只需要通过一次IO就能读取到节点上的所有数据，通过增加节点存储的数据减少了树的高度，而并没有让IO次数变多。</p>
<p>  B+树在B树的基础上，对查询的稳定性和排序策略进行了优化，因为B+树所有的数据都保存到叶子节点，并且所有叶子节点本身是有序排列的。</p>
<p>  B*树为了减少树在构建过程中节点的分裂或者合并次数，所以在每个非根节点的内部节点上都保存了兄弟节点的指针，在节点需要进行分裂或者合并时，优先从兄弟节点挪数据，从而减少构建过程中节点分裂或者合并的次数，提升了树的构建性能，将节点的最低利用率从1/2提高到2/3。</p>
<h3 data-id="heading-6">实际应用中的索引优化</h3>
<p>  了解 B树 和 B+树的基本原理后，在实际应用中如何合理使用索引呢？首先，要选择合适的索引列。对于经常用作查询条件和排序的列，应该建立索引。其次，要注意索引的维护。频繁更新的列会导致索引重建，因此要权衡索引的利弊。最后，要根据查询需求选择合适的索引类型。对于需要频繁进行范围查询的列，B+ 树索引是更好的选择。</p>
<p>  在实际应用中，还可以通过复合索引、覆盖索引等高级技术进一步优化查询性能。</p>
<h3 data-id="heading-7">聚集索引和辅助索引</h3>
<p>  MySQL InnoDB存储引擎数据库中的B+Tree索引可以分为聚集索引（clustered index，也叫主键索引、聚簇索引）和辅助索引（secondary index，也叫非聚集索引）。</p>
<p>  聚集索引也叫主键索引，叶子节点中的data存储的是该主键对应的整行数据，通常B+Tree的高度为3，也就是有三层节点，MySQL会把B+Tree第一层也就是根节点放在内存中，我们根据主键索引查数据，只需要两次磁盘I\O（第二层1次，第三层1次）即可。</p>
<p>非聚集索引也叫辅助索引，叶子节点中存储的是该索引所在记录的主键值，所以非聚集索引的寻址过程分两种情况：</p>
<p>(1) 非聚集索引已经索引覆盖了，那么只需要遍历这非聚集索引这一个B+Tree即可，按照上面的分析，需要两次磁盘IO即可（mysql会把根节点放到内存中）。</p>
<p>(2) 非聚集索引不能索引覆盖，那么需要回表。先需要在非聚集索引这个B+Tree上两次IO找到主键，然后拿着主键去聚集索引的B+Tree上找对应的完整数据记录。相比第一种情况IO次数要多，所以我们通常喜欢索引覆盖。这个过程会增加额外的 IO 消耗和网络传输时间，降低查询性能。</p>
<p>下图表示非聚集索引不能索引覆盖的情况：右侧的辅助索引先拿到主键值5，然后去左侧的主键索引中寻址，最后可以得到整行记录的内容。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/700732be249847d893da968764a1b1dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771135404&amp;x-signature=XPXfhzhzM8GBVCqnQU3LpYYdG80%3D" alt="image" loading="lazy"/></p>
<h3 data-id="heading-8">面试实战指南</h3>
<p>  掌握了以上各种树的知识，你已经能应对80%的索引问题。但想在面试中真正征服面试官，还需要准备一些更具深度和广度的话题。这里再考察索引问题的时候，有经验的面试官很可能对以下三个问题深挖，你可以准确回答了吗？</p>
<ul>
<li>B+树与B树、红黑树等其它树的对比</li>
<li>MySQL索引会失效吗</li>
<li>MySQL InnoDB表中含有NULL值的列建索引有作用吗</li>
<li>MySQL InnoDB高度为3的B+Tree可以存储多少条数据</li>
</ul>
<p>答案即将揭晓，敬请关注小编。</p>
<h3 data-id="heading-9">结束语</h3>
<p>  本文介绍了二叉树、AVL树、红黑树、B树和B+树五种树的数据结构，介绍了如何一步步降低树的高度，提升增删改查效率，最后介绍了MySQL InnoDB索引及其相关高频、高阶面试题。</p>
<p>  请暂放工作喧嚣，享受汗水换来的闲暇，惬意阅读。聆听内心，感受自由，静享丰盈时光。愿这份宁静和这篇博文，滋养你前行。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Batch实战]]></title>    <link>https://juejin.cn/post/7603575763786874906</link>    <guid>https://juejin.cn/post/7603575763786874906</guid>    <pubDate>2026-02-06T23:44:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603575763786874906" data-draft-id="7603352117640134665" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Batch实战"/> <meta itemprop="keywords" content="Java,Spring"/> <meta itemprop="datePublished" content="2026-02-06T23:44:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Batch实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T23:44:29.000Z" title="Fri Feb 06 2026 23:44:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring Batch实战</h2>
<h3 data-id="heading-1">前言</h3>
<p>在企业级应用中，批量数据处理是一个非常常见的需求。比如月底的工资代发、银行对账、数据报表生成等。当数据量达到几十万甚至上百万时，如何高效、可靠地处理这些数据，就成了一个技术挑战。</p>
<p>本文将以"50万笔工资代发"为实际场景，详细介绍如何使用Spring Batch框架来处理大规模批量数据，并重点讲解当处理失败时，如何实现<strong>部分回滚机制</strong>，确保已成功处理的数据不会因为少量失败记录而全部回滚。</p>
<hr/>
<h3 data-id="heading-2">一、什么是Spring Batch？</h3>
<h4 data-id="heading-3">1.1 Spring Batch简介</h4>
<p>Spring Batch是一个轻量级的、全面的批处理框架，由Spring团队开发，旨在帮助企业开发健壮的批处理应用程序。它于2008年首次发布，经过十多年的发展，已经成为Java批处理领域的事实标准。</p>
<p>Spring Batch的核心设计理念包括：</p>
<ul>
<li><strong>Chunk-oriented Processing（块级处理）</strong>：将大量数据分批处理，避免内存溢出</li>
<li><strong>事务管理</strong>：每个Chunk作为一个独立的事务，支持部分回滚</li>
<li><strong>容错机制</strong>：支持跳过（Skip）、重试（Retry）等容错策略</li>
<li><strong>作业调度</strong>：支持定时任务、手动触发等多种调度方式</li>
<li><strong>监控与统计</strong>：提供完整的执行记录和统计信息</li>
</ul>
<h4 data-id="heading-4">1.2 核心概念详解</h4>
<h5 data-id="heading-5">Job（作业）</h5>
<p>Job是批处理的核心概念，代表一个完整的批处理任务。一个Job可以包含多个Step，按顺序或并行执行。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> Job <span class="hljs-title function_">salaryPaymentJob</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> jobBuilderFactory.get(<span class="hljs-string">"salaryPaymentJob"</span>)
        .start(step1())
        .next(step2())
        .build();
}
</code></pre>
<h5 data-id="heading-6">Step（步骤）</h5>
<p>Step是Job的基本执行单元，每个Step包含：</p>
<ul>
<li><strong>ItemReader</strong>：读取数据</li>
<li><strong>ItemProcessor</strong>：处理数据（可选）</li>
<li><strong>ItemWriter</strong>：写入数据</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> Step <span class="hljs-title function_">salaryPaymentStep</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> stepBuilderFactory.get(<span class="hljs-string">"salaryPaymentStep"</span>)
        .&lt;SalaryPayment, SalaryPayment&gt;chunk(<span class="hljs-number">1000</span>)
        .reader(reader())
        .processor(processor())
        .writer(writer())
        .build();
}
</code></pre>
<h5 data-id="heading-7">Chunk（数据块）</h5>
<p>Chunk是Spring Batch处理数据的基本单位。每次从Reader读取指定数量的记录，处理后一起提交到数据库：</p>
<pre><code class="hljs">读取1000条 → 处理1000条 → 写入1000条 → 提交事务
</code></pre>
<h4 data-id="heading-8">1.3 应用场景</h4>
<p>Spring Batch适用于以下典型场景：</p>






























<table><thead><tr><th>场景</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>数据迁移</td><td>跨系统数据同步</td><td>从旧系统迁移数据到新系统</td></tr><tr><td>数据转换</td><td>ETL过程</td><td>从数据库读取、转换、写入数据仓库</td></tr><tr><td>批量处理</td><td>定期批量操作</td><td>月底工资代发、银行对账</td></tr><tr><td>报表生成</td><td>定期生成报表</td><td>每日交易汇总报表</td></tr></tbody></table>
<h4 data-id="heading-9">1.4 与其他框架对比</h4>









































<table><thead><tr><th>特性</th><th>Spring Batch</th><th>Quartz</th><th>Scheduled Executor</th></tr></thead><tbody><tr><td>批量处理</td><td>✅ 专用</td><td>需要</td><td>需要</td></tr><tr><td>事务管理</td><td>✅ 内置</td><td>无</td><td>无</td></tr><tr><td>容错机制</td><td>✅ 完善的Skip/Retry</td><td>无</td><td>无</td></tr><tr><td>监控统计</td><td>✅ 数据库持久化</td><td>基础</td><td>无</td></tr><tr><td>并行处理</td><td>✅ 多种模式</td><td>无</td><td>基础</td></tr></tbody></table>
<p><strong>为什么需要部分回滚？</strong></p>
<p>想象一下：你需要处理50万笔工资代发，如果第49万笔记录因为银行卡号错误而失败，在没有部分回滚机制的情况下，前面489,999笔已成功处理的数据会全部回滚！这对于业务来说是不可接受的。</p>
<hr/>
<h3 data-id="heading-10">二、系统架构设计</h3>
<p>为了实现50万笔工资代发的高效处理，我们设计了如下的系统架构：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcd00eb304e3405bba04e396f8f17e3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771026268&amp;x-signature=6U7zJ6OTXz6gkHUmSzFWbDGsk6w%3D" alt="" loading="lazy"/></p>
<p>上图展示了Spring Batch工资代发系统的分层架构：</p>
<ul>
<li><strong>Web层</strong>：提供监控面板，支持Job启动/停止、实时状态监控和统计信息查询</li>
<li><strong>Batch控制层</strong>：REST API接口，包含JobLauncher和JobRepository</li>
<li><strong>Spring Batch核心层</strong>：Job→Step→Chunk的处理流程，包含Reader、Processor、Writer三大组件</li>
<li><strong>数据存储层</strong>：MySQL数据库、CSV文件和Job执行日志</li>
</ul>
<h4 data-id="heading-11">2.1 核心组件说明</h4>



































<table><thead><tr><th>组件</th><th>职责</th><th>实现类</th></tr></thead><tbody><tr><td>Job</td><td>整个批处理任务</td><td>SalaryPaymentJob</td></tr><tr><td>Step</td><td>任务中的一个步骤</td><td>SalaryPaymentStep</td></tr><tr><td>ItemReader</td><td>数据读取器</td><td>FlatFileItemReader（读取CSV）</td></tr><tr><td>ItemProcessor</td><td>数据处理器</td><td>SalaryPaymentProcessor（数据验证）</td></tr><tr><td>ItemWriter</td><td>数据写入器</td><td>JdbcBatchItemWriter（批量写入数据库）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-12">三、部分回滚机制原理</h3>
<h4 data-id="heading-13">3.1 Chunk-Oriented Processing</h4>
<p>Spring Batch采用**Chunk-Oriented Processing（块级处理）**模式，这是实现部分回滚的核心机制：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d084688d1ebe463c9652b1ba0d53c668~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771026268&amp;x-signature=UuFoHlDwgOOpU%2FXE5sMRjhtTvc8%3D" alt="" loading="lazy"/></p>
<p>上图展示了Batch处理的核心流程：Reader读取数据 → Processor处理验证 → Writer批量写入，形成完整的处理管道。</p>
<p>对于50万笔数据的处理，Chunk机制的工作方式如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">50</span>万笔数据
    │
    ├─► Chunk <span class="hljs-number">1</span> (<span class="hljs-number">1</span>-<span class="hljs-number">1000</span>笔)   ──► 独立事务 ──► 成功提交
    ├─► Chunk <span class="hljs-number">2</span> (<span class="hljs-number">1001</span>-<span class="hljs-number">2000</span>笔) ──► 独立事务 ──► 成功提交
    ├─► Chunk <span class="hljs-number">3</span> (<span class="hljs-number">2001</span>-<span class="hljs-number">3000</span>笔) ──► 独立事务 ──► 第<span class="hljs-number">2500</span>笔失败 → 重试<span class="hljs-number">3</span>次 → 跳过 → 其余<span class="hljs-number">999</span>笔提交
    ├─► Chunk <span class="hljs-number">4</span> (<span class="hljs-number">3001</span>-<span class="hljs-number">4000</span>笔) ──► 独立事务 ──► 成功提交
    ...
    └─► Chunk <span class="hljs-number">500</span> (<span class="hljs-number">499001</span>-<span class="hljs-number">500000</span>笔) ──► 独立事务 ──► 成功提交

最终结果：<span class="hljs-number">499</span>,<span class="hljs-number">999</span>笔成功，<span class="hljs-number">1</span>笔被跳过
</code></pre>
<p><strong>关键配置：</strong></p>
<ul>
<li><strong>chunkSize</strong>: 1000（每1000笔提交一次）</li>
<li><strong>skipLimit</strong>: 100（最多跳过100笔失败记录）</li>
<li><strong>retryLimit</strong>: 3（每笔失败重试3次）</li>
</ul>
<h4 data-id="heading-14">3.2 事务边界与部分回滚</h4>
<p>每个Chunk是独立的事务单元，这是实现部分回滚的关键：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3cadc7def044954ab96efb3b4f174c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771026268&amp;x-signature=tDesgDqGrq9SQu7Kbxsq%2FXq2ljQ%3D" alt="" loading="lazy"/></p>
<p>上图清晰地展示了事务边界和部分回滚的工作机制：</p>
<p><strong>事务规则：</strong></p>
<ul>
<li>Chunk内任意记录失败 → 整个Chunk回滚</li>
<li>重试成功 → 继续处理</li>
<li>重试失败且可跳过 → 跳过该记录，继续处理Chunk内剩余记录</li>
<li>跳过次数超限 → 整个Job失败</li>
</ul>
<p><strong>实际案例：</strong>
假设Chunk 3中有1000笔数据，第500笔验证失败：</p>
<ol>
<li>Spring Batch回滚整个Chunk 3</li>
<li>重新读取Chunk 3的1000笔数据</li>
<li>处理到第500笔时，捕获异常</li>
<li>重试3次后仍然失败</li>
<li>检查是否可跳过（IllegalArgumentException在跳过列表中）</li>
<li>跳过第500笔，继续处理501-1000笔</li>
<li>最终Chunk 3成功提交999笔，1笔被跳过</li>
</ol>
<h4 data-id="heading-15">3.3 容错策略配置</h4>
<pre><code class="hljs language-java" lang="java">.faultTolerant()                    <span class="hljs-comment">// 启用容错</span>
    .skipLimit(<span class="hljs-number">100</span>)                 <span class="hljs-comment">// 最多跳过100条</span>
    .skip(IllegalArgumentException.class)    <span class="hljs-comment">// 跳过数据验证异常</span>
    .skip(NullPointerException.class)        <span class="hljs-comment">// 跳过空指针异常</span>
    .retryLimit(<span class="hljs-number">3</span>)                  <span class="hljs-comment">// 失败重试3次</span>
    .retry(Exception.class)         <span class="hljs-comment">// 重试所有异常</span>
</code></pre>
<hr/>
<h3 data-id="heading-16">四、50万笔工资代发数据处理流程</h3>
<p>在理解了部分回滚机制后，我们来看完整的工资代发数据处理流程：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8b9318892e8425abf7d289b608db5bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771026268&amp;x-signature=SIsXxsWk3rb%2BjcCk4aE465G5rXg%3D" alt="" loading="lazy"/></p>
<p>上图展示了从CSV文件读取到数据库写入的完整数据流，包含以下关键步骤：</p>
<ol>
<li><strong>数据读取</strong>：FlatFileItemReader读取CSV文件，每行映射为SalaryPayment对象</li>
<li><strong>数据验证</strong>：SalaryPaymentProcessor进行数据校验
<ul>
<li>员工ID非空验证</li>
<li>金额范围验证（0.01-100万）</li>
<li>银行卡号格式验证（16-19位数字）</li>
</ul>
</li>
<li><strong>状态更新</strong>：设置状态为PROCESSING，生成唯一交易ID</li>
<li><strong>批量写入</strong>：JdbcBatchItemWriter批量写入数据库</li>
<li><strong>异常处理</strong>：验证失败的记录被跳过，记录到失败列表</li>
</ol>
<hr/>
<h3 data-id="heading-17">五、核心代码实现</h3>
<h4 data-id="heading-18">5.1 Job配置</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SalaryPaymentJobConfig</span> {

    <span class="hljs-meta">@Value("${batch.chunk.size:1000}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> chunkSize;  <span class="hljs-comment">// 每次处理的记录数</span>

    <span class="hljs-meta">@Value("${batch.skip.limit:100}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> skipLimit;  <span class="hljs-comment">// 跳过限制</span>

    <span class="hljs-meta">@Value("${batch.retry.limit:3}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> retryLimit; <span class="hljs-comment">// 重试次数</span>

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Step <span class="hljs-title function_">salaryPaymentStep</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> stepBuilderFactory
            .get(<span class="hljs-string">"salaryPaymentStep"</span>)
            .&lt;SalaryPayment, SalaryPayment&gt;chunk(chunkSize)
            .reader(salaryPaymentReader())
            .processor(salaryPaymentProcessor())
            .writer(salaryPaymentWriter())
            .faultTolerant()  <span class="hljs-comment">// 启用容错</span>
            .skipLimit(skipLimit)
            .skip(IllegalArgumentException.class)
            .skip(NullPointerException.class)
            .retryLimit(retryLimit)
            .retry(Exception.class)
            .listener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SalaryItemReadListener</span>())
            .listener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SalaryItemWriteListener</span>())
            .build();
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Job <span class="hljs-title function_">salaryPaymentJob</span><span class="hljs-params">(Step step, SalaryJobExecutionListener listener)</span> {
        <span class="hljs-keyword">return</span> jobBuilderFactory.get(<span class="hljs-string">"salaryPaymentJob"</span>)
            .incrementer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RunIdIncrementer</span>())
            .listener(listener)
            .start(step)
            .build();
    }
}
</code></pre>
<h4 data-id="heading-19">5.2 数据读取器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> FlatFileItemReader&lt;SalaryPayment&gt; <span class="hljs-title function_">salaryPaymentReader</span><span class="hljs-params">()</span> {
    FlatFileItemReader&lt;SalaryPayment&gt; reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FlatFileItemReader</span>&lt;&gt;();
    reader.setName(<span class="hljs-string">"salaryPaymentReader"</span>);
    reader.setResource(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(<span class="hljs-string">"input/salary-payments.csv"</span>));
    reader.setLinesToSkip(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 跳过CSV标题行</span>

    <span class="hljs-comment">// 设置列映射</span>
    <span class="hljs-type">DelimitedLineTokenizer</span> <span class="hljs-variable">tokenizer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DelimitedLineTokenizer</span>();
    tokenizer.setNames(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{
        <span class="hljs-string">"employeeId"</span>, <span class="hljs-string">"employeeName"</span>, <span class="hljs-string">"accountNumber"</span>,
        <span class="hljs-string">"accountName"</span>, <span class="hljs-string">"bankName"</span>, <span class="hljs-string">"amount"</span>, <span class="hljs-string">"currency"</span>,
        <span class="hljs-string">"paymentDate"</span>, <span class="hljs-string">"remark"</span>
    });

    <span class="hljs-comment">// 设置字段映射</span>
    BeanWrapperFieldSetMapper&lt;SalaryPayment&gt; mapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanWrapperFieldSetMapper</span>&lt;&gt;();
    mapper.setTargetType(SalaryPayment.class);

    DefaultLineMapper&lt;SalaryPayment&gt; lineMapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultLineMapper</span>&lt;&gt;();
    lineMapper.setLineTokenizer(tokenizer);
    lineMapper.setFieldSetMapper(mapper);
    reader.setLineMapper(lineMapper);

    <span class="hljs-keyword">return</span> reader;
}
</code></pre>
<h4 data-id="heading-20">5.3 数据处理器（验证逻辑）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SalaryPaymentProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ItemProcessor</span>&lt;SalaryPayment, SalaryPayment&gt; {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">MIN_AMOUNT</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.01"</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">MAX_AMOUNT</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"1000000"</span>);

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> SalaryPayment <span class="hljs-title function_">process</span><span class="hljs-params">(SalaryPayment item)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. 数据验证</span>
        <span class="hljs-keyword">if</span> (item.getEmployeeId() == <span class="hljs-literal">null</span> || item.getEmployeeId().trim().isEmpty()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"员工ID不能为空"</span>);
        }

        <span class="hljs-comment">// 2. 金额验证</span>
        <span class="hljs-keyword">if</span> (item.getAmount() == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"发放金额不能为空"</span>);
        }
        <span class="hljs-keyword">if</span> (item.getAmount().compareTo(MIN_AMOUNT) &lt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"发放金额不能小于0.01元"</span>);
        }
        <span class="hljs-keyword">if</span> (item.getAmount().compareTo(MAX_AMOUNT) &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"发放金额不能大于100万元"</span>);
        }

        <span class="hljs-comment">// 3. 银行卡号验证</span>
        <span class="hljs-keyword">if</span> (item.getAccountNumber() == <span class="hljs-literal">null</span> ||
            item.getAccountNumber().length() &lt; <span class="hljs-number">16</span> ||
            item.getAccountNumber().length() &gt; <span class="hljs-number">19</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"银行账号长度必须在16-19位之间"</span>);
        }

        <span class="hljs-comment">// 4. 设置处理状态</span>
        item.setStatus(<span class="hljs-string">"PROCESSING"</span>);
        item.setTransactionId(<span class="hljs-string">"SAL"</span> + System.currentTimeMillis() + item.getEmployeeId());

        <span class="hljs-keyword">return</span> item;
    }
}
</code></pre>
<h4 data-id="heading-21">5.4 数据写入器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SalaryPaymentWriter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ItemWriter</span>&lt;SalaryPayment&gt; {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> JdbcBatchItemWriter&lt;SalaryPayment&gt; delegate;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SalaryPaymentWriter</span><span class="hljs-params">(DataSource dataSource)</span> {
        <span class="hljs-built_in">this</span>.delegate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcBatchItemWriter</span>&lt;&gt;();
        <span class="hljs-built_in">this</span>.delegate.setDataSource(dataSource);
        <span class="hljs-built_in">this</span>.delegate.setSql(
            <span class="hljs-string">"INSERT INTO salary_payment "</span> +
            <span class="hljs-string">"(employee_id, employee_name, account_number, account_name, "</span> +
            <span class="hljs-string">"bank_name, amount, currency, payment_date, remark, "</span> +
            <span class="hljs-string">"status, transaction_id, create_time, update_time) "</span> +
            <span class="hljs-string">"VALUES (:employeeId, :employeeName, :accountNumber, :accountName, "</span> +
            <span class="hljs-string">":bankName, :amount, :currency, :paymentDate, :remark, "</span> +
            <span class="hljs-string">":status, :transactionId, :createTime, :updateTime)"</span>);
        <span class="hljs-built_in">this</span>.delegate.setItemSqlParameterSourceProvider(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanPropertyItemSqlParameterSourceProvider</span>&lt;&gt;()
        );
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">write</span><span class="hljs-params">(List&lt;? extends SalaryPayment&gt; items)</span> <span class="hljs-keyword">throws</span> Exception {
        delegate.write(items);
    }
}
</code></pre>
<h4 data-id="heading-22">5.5 自定义SkipPolicy</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PartialRollbackHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SkipPolicy</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SKIP_LIMIT</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldSkip</span><span class="hljs-params">(Throwable throwable, <span class="hljs-type">int</span> skipCount)</span> {
        <span class="hljs-comment">// 超过跳过限制</span>
        <span class="hljs-keyword">if</span> (skipCount &gt;= SKIP_LIMIT) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-comment">// 文件不存在，不能跳过</span>
        <span class="hljs-keyword">if</span> (throwable <span class="hljs-keyword">instanceof</span> FileNotFoundException) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-comment">// 数据格式错误，可以跳过</span>
        <span class="hljs-keyword">if</span> (throwable <span class="hljs-keyword">instanceof</span> FlatFileParseException) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }

        <span class="hljs-comment">// 数据验证失败，可以跳过</span>
        <span class="hljs-keyword">if</span> (throwable <span class="hljs-keyword">instanceof</span> IllegalArgumentException ||
            throwable <span class="hljs-keyword">instanceof</span> NullPointerException) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-23">六、监控与调度架构</h3>
<p>除了数据处理，Spring Batch还提供了完善的监控和调度能力：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75d4b1910c2744e1ae48875ce1ce6e31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771026268&amp;x-signature=6ByRneA25pJ%2BsYmXWs9B49dsOdQ%3D" alt="" loading="lazy"/></p>
<p>上图展示了完整的监控与调度架构：</p>
<p><strong>调度层</strong>：支持三种调度方式</p>
<ul>
<li>Quartz调度器：支持分布式调度，适合集群环境</li>
<li>Spring Task调度：简单的定时任务，轻量级选择</li>
<li>Cron表达式：灵活的时间配置</li>
</ul>
<p><strong>执行层</strong>：核心执行组件</p>
<ul>
<li>JobLauncher：启动作业，创建执行上下文</li>
<li>JobOperator：操作作业，支持停止/重启/重试</li>
<li>StepExecution：步骤执行，采用Chunk处理模式</li>
<li>ThreadPoolExecutor：线程池，实现并发处理</li>
</ul>
<p><strong>监控层</strong>：监控与统计</p>
<ul>
<li>JobRepository：存储元数据（BATCH_JOB_INSTANCE、BATCH_JOB_EXECUTION、BATCH_STEP_EXECUTION）</li>
<li>JobExplorer：查询作业状态、获取执行历史</li>
<li>Metrics：处理记录数、执行时间、失败率统计</li>
</ul>
<p><strong>数据层</strong>：数据存储</p>
<ul>
<li>MySQL 8.0：存储元数据表、业务数据表、日志记录</li>
<li>Redis缓存：执行状态缓存、计数器、分布式锁</li>
</ul>
<hr/>
<h3 data-id="heading-24">七、数据库设计</h3>
<h4 data-id="heading-25">7.1 工资代发表</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> salary_payment (
    id <span class="hljs-type">BIGINT</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY</span> KEY,
    employee_id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'员工ID'</span>,
    employee_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'员工姓名'</span>,
    account_number <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'银行账号'</span>,
    account_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'账户名称'</span>,
    bank_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'开户行'</span>,
    amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">18</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'发放金额'</span>,
    currency <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'CNY'</span> COMMENT <span class="hljs-string">'币种'</span>,
    payment_date DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'发放日期'</span>,
    remark <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">500</span>) COMMENT <span class="hljs-string">'备注'</span>,
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'PENDING'</span> COMMENT <span class="hljs-string">'状态'</span>,
    transaction_id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) COMMENT <span class="hljs-string">'交易ID'</span>,
    error_message <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">1000</span>) COMMENT <span class="hljs-string">'错误信息'</span>,
    create_time DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    update_time DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    INDEX idx_employee_id (employee_id),
    INDEX idx_status (status)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4;
</code></pre>
<h4 data-id="heading-26">7.2 Spring Batch元表</h4>
<p>Spring Batch框架会自动创建以下元表来存储Job执行信息：</p>
<ul>
<li><code>batch_job_instance</code> - Job实例表</li>
<li><code>batch_job_execution</code> - Job执行表</li>
<li><code>batch_job_execution_params</code> - Job参数表</li>
<li><code>batch_step_execution</code> - Step执行表</li>
<li><code>batch_step_execution_context</code> - Step上下文表</li>
</ul>
<hr/>
<h3 data-id="heading-27">八、REST API设计</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/batch")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BatchJobController</span> {

    <span class="hljs-comment">// 启动Job</span>
    <span class="hljs-meta">@PostMapping("/start")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">startJob</span><span class="hljs-params">(
        <span class="hljs-meta">@RequestParam</span> String inputFile
    )</span> {
        <span class="hljs-type">JobParameters</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JobParametersBuilder</span>()
            .addLong(<span class="hljs-string">"startTime"</span>, System.currentTimeMillis())
            .addString(<span class="hljs-string">"inputFile"</span>, inputFile)
            .toJobParameters();
        <span class="hljs-type">JobExecution</span> <span class="hljs-variable">execution</span> <span class="hljs-operator">=</span> jobLauncher.run(salaryPaymentJob, params);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(result);
    }

    <span class="hljs-comment">// 获取Job状态</span>
    <span class="hljs-meta">@GetMapping("/status/{jobExecutionId}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">getJobStatus</span><span class="hljs-params">(
        <span class="hljs-meta">@PathVariable</span> Long jobExecutionId
    )</span> {
        <span class="hljs-type">JobExecution</span> <span class="hljs-variable">execution</span> <span class="hljs-operator">=</span> jobRepository.getJobExecution(jobExecutionId);
        <span class="hljs-comment">// 返回执行详情</span>
    }

    <span class="hljs-comment">// 停止Job</span>
    <span class="hljs-meta">@PostMapping("/stop/{jobExecutionId}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">stopJob</span><span class="hljs-params">(
        <span class="hljs-meta">@PathVariable</span> Long jobExecutionId
    )</span> {
        <span class="hljs-type">JobExecution</span> <span class="hljs-variable">execution</span> <span class="hljs-operator">=</span> jobRepository.getJobExecution(jobExecutionId);
        execution.stop();
        <span class="hljs-keyword">return</span> ResponseEntity.ok(result);
    }

    <span class="hljs-comment">// 获取统计信息</span>
    <span class="hljs-meta">@GetMapping("/statistics")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">getStatistics</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 返回总数、成功数、失败数等统计</span>
    }

    <span class="hljs-comment">// 健康检查</span>
    <span class="hljs-meta">@GetMapping("/health")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">health</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 返回系统健康状态</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-28">九、性能优化与并行处理</h3>
<p>当数据量达到50万甚至更多时，单线程处理可能成为瓶颈。Spring Batch提供了多种并行处理方式。</p>
<h4 data-id="heading-29">9.1 多线程并发处理</h4>
<p>Spring Batch支持多线程并发处理，大幅提升处理效率：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/316e23bab05d4fe596fe18021513b6c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771026268&amp;x-signature=0BkUFvIWBtjJgwbQoXjOKq2s7MQ%3D" alt="" loading="lazy"/></p>
<p>上图展示了多线程并发处理的工作原理：</p>
<p><strong>核心机制：</strong></p>
<ul>
<li><strong>主线程</strong>：创建线程池，分配任务</li>
<li><strong>工作线程</strong>：并发执行多个Step或Chunk</li>
<li><strong>线程安全</strong>：JobRepository保证线程安全的状态管理</li>
<li><strong>负载均衡</strong>：任务均匀分配到各个线程</li>
</ul>
<p><strong>配置示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> TaskExecutor <span class="hljs-title function_">taskExecutor</span><span class="hljs-params">()</span> {
    <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
    executor.setCorePoolSize(<span class="hljs-number">5</span>);
    executor.setMaxPoolSize(<span class="hljs-number">10</span>);
    executor.setQueueCapacity(<span class="hljs-number">100</span>);
    executor.setThreadNamePrefix(<span class="hljs-string">"salary-batch-"</span>);
    executor.initialize();
    <span class="hljs-keyword">return</span> executor;
}

<span class="hljs-comment">// 在Step中使用</span>
.step(stepName)
.chunk(chunkSize)
.taskExecutor(taskExecutor())
.throttleLimit(<span class="hljs-number">10</span>)  <span class="hljs-comment">// 限制并发数</span>
.build();
</code></pre>
<h4 data-id="heading-30">9.2 分区处理（Partitioning）</h4>
<p>对于超大数据集，可以使用分区处理实现更高程度的并行：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f2a8815f01144f197a00ba5ad2c0802~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771026268&amp;x-signature=9I%2BjxPUBFL%2B5Vi3qT9oI4Xub9sM%3D" alt="" loading="lazy"/></p>
<p>上图展示了分区处理的架构：</p>
<p><strong>核心组件：</strong></p>
<ul>
<li><strong>Master Step</strong>：负责创建和管理分区</li>
<li><strong>Slave Step</strong>：每个分区独立执行</li>
<li><strong>Partitioner</strong>：将数据分成多个分区</li>
<li><strong>TaskExecutor</strong>：线程池执行分区任务</li>
</ul>
<p><strong>配置示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> Step <span class="hljs-title function_">masterStep</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> stepBuilderFactory.get(<span class="hljs-string">"masterStep"</span>)
        .partitioner(slaveStep().getName(), rangePartitioner(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>))
        .step(slaveStep())
        .gridSize(<span class="hljs-number">10</span>)  <span class="hljs-comment">// 分成10个分区</span>
        .taskExecutor(taskExecutor())
        .build();
}

<span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> Partitioner <span class="hljs-title function_">rangePartitioner</span><span class="hljs-params">(<span class="hljs-type">int</span> min, <span class="hljs-type">int</span> max)</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Partitioner</span>() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Map&lt;String, ExecutionContext&gt; <span class="hljs-title function_">partition</span><span class="hljs-params">(<span class="hljs-type">int</span> gridSize)</span> {
            Map&lt;String, ExecutionContext&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            <span class="hljs-type">int</span> <span class="hljs-variable">range</span> <span class="hljs-operator">=</span> (max - min) / gridSize;
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; gridSize; i++) {
                <span class="hljs-type">ExecutionContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutionContext</span>();
                context.putInt(<span class="hljs-string">"minValue"</span>, min + i * range);
                context.putInt(<span class="hljs-string">"maxValue"</span>, min + (i + <span class="hljs-number">1</span>) * range - <span class="hljs-number">1</span>);
                result.put(<span class="hljs-string">"partition"</span> + i, context);
            }
            <span class="hljs-keyword">return</span> result;
        }
    };
}
</code></pre>
<h4 data-id="heading-31">9.3 调优参数</h4>






























<table><thead><tr><th>参数</th><th>推荐值</th><th>说明</th></tr></thead><tbody><tr><td>chunkSize</td><td>1000-5000</td><td>根据记录大小调整，越大吞吐量越高但内存占用也越大</td></tr><tr><td>skipLimit</td><td>100-500</td><td>根据数据质量设置</td></tr><tr><td>retryLimit</td><td>3-5</td><td>过多会浪费时间，过少可能误判暂时性故障</td></tr><tr><td>线程池大小</td><td>CPU核心数*2</td><td>用于多线程处理</td></tr></tbody></table>
<h4 data-id="heading-32">9.4 批量写入优化</h4>
<p>使用JDBC批量操作代替单条插入：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 单条插入（慢）</span>
<span class="hljs-keyword">for</span> (SalaryPayment p : payments) {
    jdbcTemplate.update(sql, p.getId(), p.getName(), ...);
}

<span class="hljs-comment">// 批量插入（快）</span>
jdbcTemplate.batchUpdate(sql, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BatchPreparedStatementSetter</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValues</span><span class="hljs-params">(PreparedStatement ps, <span class="hljs-type">int</span> i)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// 设置参数</span>
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getBatchSize</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> payments.size();
    }
});
</code></pre>
<h4 data-id="heading-33">9.5 索引优化</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 为常用查询字段添加索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_employee_id <span class="hljs-keyword">ON</span> salary_payment(employee_id);
<span class="hljs-keyword">CREATE</span> INDEX idx_status <span class="hljs-keyword">ON</span> salary_payment(status);
<span class="hljs-keyword">CREATE</span> INDEX idx_create_time <span class="hljs-keyword">ON</span> salary_payment(create_time);

<span class="hljs-comment">-- 复合索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_status_employee <span class="hljs-keyword">ON</span> salary_payment(status, employee_id);
</code></pre>
<hr/>
<h3 data-id="heading-34">十、实际应用场景</h3>
<h4 data-id="heading-35">场景1：月底工资代发</h4>
<p>某公司月底需要为50,000名员工发放工资，使用Spring Batch：</p>
<ul>
<li>设置chunkSize=1000，分成50个Chunk处理</li>
<li>假设第23个Chunk中第23,456号员工银行卡号错误</li>
<li>系统重试3次后跳过该记录</li>
<li>最终结果：49,999笔成功，1笔记录到失败列表供后续处理</li>
</ul>
<h4 data-id="heading-36">场景2：银行对账文件处理</h4>
<p>银行提供100万笔交易对账文件：</p>
<ul>
<li>设置chunkSize=5000，提高处理效率</li>
<li>使用多线程并发处理（Partitioning）</li>
<li>完成后生成对账差异报告</li>
</ul>
<h4 data-id="heading-37">场景3：数据报表生成</h4>
<p>每天凌晨生成T+1交易报表：</p>
<ul>
<li>使用Spring Task定时调度</li>
<li>读取当日交易数据</li>
<li>生成Excel报表并发送邮件</li>
</ul>
<hr/>
<h3 data-id="heading-38">十一、常见问题与解决方案</h3>
<h4 data-id="heading-39">Q1: Job执行一半挂了怎么办？</h4>
<p>Spring Batch支持Job重启。通过JobRepository记录的执行状态，可以从上次失败的位置继续执行：</p>
<pre><code class="hljs language-java" lang="java">.job(salaryPaymentJob)
    .allowStartIfComplete(<span class="hljs-literal">false</span>)  <span class="hljs-comment">// 已完成的Job不重新执行</span>
    .restartable(<span class="hljs-literal">true</span>)  <span class="hljs-comment">// 允许重启</span>
</code></pre>
<h4 data-id="heading-40">Q2: 如何实现并行处理？</h4>
<p>使用Partitioning方式实现多线程并行处理：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> Step <span class="hljs-title function_">masterStep</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> stepBuilderFactory.get(<span class="hljs-string">"masterStep"</span>)
        .partitioner(slaveStep().getName(), partitioner())
        .step(slaveStep())
        .gridSize(<span class="hljs-number">10</span>)  <span class="hljs-comment">// 分成10个分区并行处理</span>
        .taskExecutor(taskExecutor())
        .build();
}
</code></pre>
<h4 data-id="heading-41">Q3: 处理失败的数据如何重试？</h4>
<p>可以通过以下方式重试：</p>
<ol>
<li>查询status='FAILED'的记录</li>
<li>修正错误数据</li>
<li>将status改回'PENDING'</li>
<li>重新执行Job</li>
</ol>
<hr/>
<h3 data-id="heading-42">十二、总结</h3>
<p>Spring Batch作为成熟的批处理框架，提供了完整的解决方案来处理大规模批量数据。</p>
<p><strong>适用场景：</strong></p>
<ul>
<li>银行对账、清算</li>
<li>工资代发、批量转账</li>
<li>报表生成、数据导出</li>
</ul>
<p><strong>注意事项：</strong></p>
<ul>
<li>合理设置chunkSize，平衡内存和性能</li>
<li>配置合适的Skip和Retry策略</li>
<li>做好失败记录的重处理机制</li>
<li>定期清理Job执行历史数据</li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[虚拟列表：从定高到动态高度的 Vue 3 & React 满分实现]]></title>    <link>https://juejin.cn/post/7603591775392251931</link>    <guid>https://juejin.cn/post/7603591775392251931</guid>    <pubDate>2026-02-07T03:49:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603591775392251931" data-draft-id="7603359026711969802" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="虚拟列表：从定高到动态高度的 Vue 3 &amp; React 满分实现"/> <meta itemprop="keywords" content="前端,Vue.js,React.js"/> <meta itemprop="datePublished" content="2026-02-07T03:49:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            虚拟列表：从定高到动态高度的 Vue 3 &amp; React 满分实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-07T03:49:36.000Z" title="Sat Feb 07 2026 03:49:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>在处理海量数据渲染（如万级甚至十万级列表）时，直接操作 DOM 会导致严重的页面卡顿甚至崩溃。<strong>虚拟列表（Virtual List）</strong> 作为前端性能优化的“核武器”，通过“只渲染可视区”的策略，能将渲染性能提升数个量级。本文将带你从零实现一个支持<strong>动态高度</strong>的通用虚拟列表。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0aeb589869424d08be07ff8183e5af9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-R546w5LiA5Y-q5aSn5ZGG55Oc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771040975&amp;x-signature=83d1HWo%2Fzcfl0pbpVr8sTUG%2Bd4g%3D" alt="定高虚拟列表滚动.gif" loading="lazy"/></p>
<h2 data-id="heading-1">一、 核心原理解析</h2>
<p>虚拟列表本质上是一个“障眼法”，其结构通常分为三层：</p>
<ol>
<li><strong>外层容器（Container）</strong> ：固定高度，设置 <code>overflow: auto</code>，负责监听滚动事件。</li>
<li><strong>占位背景（Placeholder）</strong> ：高度等于“总数据量 × 列表项高度”，用于撑开滚动条，模拟真实滚动的视觉效果。</li>
<li><strong>渲染内容区（Content Area）</strong> ：绝对定位，根据滚动距离动态计算起始索引，并通过 <code>translateY</code> 偏移到当前可视区域。</li>
</ol>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35758c5b480e4fd4ae543f60afd26730~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-R546w5LiA5Y-q5aSn5ZGG55Oc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771040975&amp;x-signature=gm9VzHaAFCGyUyiSagfZbbWktEk%3D" alt="image.png" width="60%" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-2">二、 定高虚拟列表</h2>
<h3 data-id="heading-3">1. 设计思路</h3>
<ul>
<li><strong>可视项数计算</strong>：<code>Math.ceil(容器高度 / 固定高度) ± 缓冲区 (BUFFER)</code>。</li>
<li><strong>起始索引</strong>：<code>Math.floor(滚动距离 / 固定高度)</code>。</li>
<li><strong>偏移量</strong>：<code>起始索引 * 固定高度</code>。</li>
</ul>
<h3 data-id="heading-4">2. Vue 3 + TailwindCSS实现</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div
    class="min-h-screen bg-gradient-to-br from-indigo-600 to-purple-600 py-10 px-5"
  &gt;
    &lt;div class="bg-white mt-20 h-[calc(100vh-200px)] rounded-xl"&gt;
      &lt;!-- 滚动容器 --&gt;
      &lt;div
        ref="virtualListRef"
        class="h-full overflow-auto relative"
        @scroll="handleScroll"
      &gt;
        &lt;!-- 占位容器：用于撑开滚动条，高度 = 总数据量 * 每项高度 --&gt;
        &lt;div :style="{ height: `${totalHeight}px` }"&gt;&lt;/div&gt;

        &lt;!-- 可视区域列表：通过 transform 定位到滚动位置 --&gt;
        &lt;div
          class="absolute top-0 left-0 right-0"
          :style="{ transform: `translateY(${offsetY}px)` }"
        &gt;
          &lt;div
            v-for="item in visibleList"
            :key="item.id"
            class="py-2 px-4 border-b border-gray-200"
            :class="{
              'bg-pink-200 h-[100px]': item.id % 2 !== 0,
              'bg-green-200 h-[100px]': item.id % 2 === 0,
            }"
          &gt;
            {{ item.name }}
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div
      class="fixed top-2 left-24 -translate-x-1/2 px-8 py-3 bg-white text-indigo-600 rounded-full text-base font-semibold cursor-pointer shadow-lg transition-all duration-300 hover:-translate-x-1/2 hover:-translate-y-0.5 hover:shadow-2xl"
      @click="goBack"
    &gt;
      ← 返回首页
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref, onMounted, computed } from 'vue';
import { useRouter } from 'vue-router';

const router = useRouter();

const ITEM_HEIGHT = 100; // 列表项固定高度（与样式中的 h-[100px] 一致）
const BUFFER = 5; // 缓冲区数量，避免滚动时出现空白

const virtualListRef = ref&lt;HTMLDivElement | null&gt;(null);

const ListData = ref&lt;any[]&gt;([]); // 完整列表数据
const scrollTop = ref(0); // 滚动容器的滚动距离

// 总列表高度（撑开滚动条用）
const totalHeight = computed(() =&gt; ListData.value.length * ITEM_HEIGHT);

// 可视区域高度（滚动容器的高度）
const viewportHeight = computed(() =&gt; {
  return virtualListRef.value?.clientHeight || 0;
});

// 可视区域可显示的列表项数量（向上取整 + 缓冲区）
const visibleCount = computed(() =&gt; {
  return Math.ceil(viewportHeight.value / ITEM_HEIGHT) + BUFFER;
});

// 当前显示的起始索引
const startIndex = computed(() =&gt; {
  // 滚动距离 / 每项高度 = 跳过的项数（向下取整）
  const index = Math.floor(scrollTop.value / ITEM_HEIGHT);
  // 防止索引为负数
  return Math.max(0, index);
});

// 当前显示的结束索引
const endIndex = computed(() =&gt; {
  const end = startIndex.value + visibleCount.value;
  // 防止超出总数据长度
  return Math.min(end, ListData.value.length);
});

// 可视区域需要渲染的列表数据
const visibleList = computed(() =&gt; {
  return ListData.value.slice(startIndex.value, endIndex.value);
});

// 可视区域的偏移量（让列表项定位到正确位置）
const offsetY = computed(() =&gt; {
  return startIndex.value * ITEM_HEIGHT;
});

// 处理滚动事件
const handleScroll = () =&gt; {
  if (virtualListRef.value) {
    scrollTop.value = virtualListRef.value.scrollTop;
  }
};

// 返回首页
const goBack = () =&gt; {
  router.push('/home');
};

// 初始化
onMounted(() =&gt; {
  // 生成模拟数据
  ListData.value = Array.from({ length: 1000 }, (_, index) =&gt; ({
    id: index,
    name: `Item ${index}`,
  }));
});
&lt;/script&gt;

</code></pre>
<h3 data-id="heading-5">3. 实现效果图</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0aeb589869424d08be07ff8183e5af9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-R546w5LiA5Y-q5aSn5ZGG55Oc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771040975&amp;x-signature=83d1HWo%2Fzcfl0pbpVr8sTUG%2Bd4g%3D" alt="定高虚拟列表滚动.gif" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-6">三、 进阶：不定高（动态高度）虚拟列表</h2>
<p>在实际业务（如社交动态、聊天记录）中，每个 Item 的高度往往是不固定的。</p>
<h3 data-id="heading-7">1. 核心改进思路</h3>
<ul>
<li><strong>高度映射表（Map）</strong> ：记录每一个 Item 渲染后的真实高度。</li>
<li><strong>累计高度数组（Cumulative Heights）</strong> ：存储每一项相对于顶部的偏移位置。</li>
<li><strong>ResizeObserver</strong>：利用该 API 监听子组件高度变化，实时更新映射表，解决图片加载或文本折行导致的位移。</li>
</ul>
<h3 data-id="heading-8">2. Vue 3 + tailwindCSS 实现（子组件抽离）</h3>
<p><strong>子组件</strong>： 负责上报真实高度：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div
    ref="itemRef"
    class="py-2 px-4 border-b border-gray-200"
    :class="{
      'bg-pink-200': item.id % 2 !== 0,
      'bg-green-200': item.id % 2 === 0,
    }"
    :style="{ height: item.id % 2 === 0 ? '150px' : '100px' }"
  &gt;
    {{ item.name }}
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref, onMounted, onUpdated, onUnmounted, watch, nextTick } from 'vue';

// 定义props：接收父组件传递的item数据
const props = defineProps&lt;{
  item: {
    id: number;
    name: string;
  };
}&gt;();

// 定义emit：向父组件传递高度更新事件
const emit = defineEmits&lt;{
  (e: 'update-height', id: number, height: number): void;
}&gt;();

const itemRef = ref&lt;HTMLDivElement | null&gt;(null);
let resizeObserver: ResizeObserver | null = null;

// 计算并发送当前组件的高度
const sendItemHeight = () =&gt; {
  if (!itemRef.value) return;
  const realHeight = itemRef.value.offsetHeight;
  emit('update-height', props.item.id, realHeight);
};

// 监听组件挂载：首次发送高度 + 监听高度变化
onMounted(() =&gt; {
  // 首次渲染完成后发送高度
  nextTick(() =&gt; {
    sendItemHeight();
  });

  // 监听元素高度变化（适配动态内容导致的高度变化）
  if (window.ResizeObserver) {
    resizeObserver = new ResizeObserver(() =&gt; {
      sendItemHeight();
    });
    if (itemRef.value) {
      resizeObserver.observe(itemRef.value);
    }
  }
});

// 组件更新后重新发送高度（比如内容变化）
onUpdated(() =&gt; {
  nextTick(() =&gt; {
    sendItemHeight();
  });
});

// 组件卸载：清理监听
onUnmounted(() =&gt; {
  if (resizeObserver) {
    resizeObserver.disconnect();
    resizeObserver = null;
  }
});

// 监听item变化：如果item替换，重新计算高度
watch(
  () =&gt; props.item.id,
  () =&gt; {
    nextTick(() =&gt; {
      sendItemHeight();
    });
  }
);
&lt;/script&gt;

</code></pre>
<p><strong>父组件</strong>：核心逻辑</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div
    class="min-h-screen bg-gradient-to-br from-indigo-600 to-purple-600 py-10 px-5"
  &gt;
    &lt;div class="bg-white mt-20 h-[calc(100vh-200px)] rounded-xl"&gt;
      &lt;!-- 滚动容器 --&gt;
      &lt;div
        ref="virtualListRef"
        class="h-full overflow-auto relative"
        @scroll="handleScroll"
      &gt;
        &lt;!-- 占位容器：撑开滚动条 --&gt;
        &lt;div :style="{ height: `${totalHeight}px` }"&gt;&lt;/div&gt;

        &lt;!-- 可视区域列表 --&gt;
        &lt;div
          class="absolute top-0 left-0 right-0"
          :style="{ transform: `translateY(${offsetY}px)` }"
        &gt;
          &lt;!-- 渲染子组件，监听高度更新事件 --&gt;
          &lt;VirtualListItem
            v-for="item in visibleList"
            :key="item.id"
            :item="item"
            @update-height="handleItemHeightUpdate"
          /&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div
      class="fixed top-2 left-24 -translate-x-1/2 px-8 py-3 bg-white text-indigo-600 rounded-full text-base font-semibold cursor-pointer shadow-lg transition-all duration-300 hover:-translate-x-1/2 hover:-translate-y-0.5 hover:shadow-2xl"
      @click="goBack"
    &gt;
      ← 返回首页
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref, onMounted, computed, onUnmounted, nextTick } from 'vue';
import { useRouter } from 'vue-router';
import VirtualListItem from './listItem.vue'; // 引入子组件

const router = useRouter();

const MIN_ITEM_HEIGHT = 100; // 子项预设的最小高度
const BUFFER = 5; //上下缓冲区数目
const virtualListRef = ref&lt;HTMLDivElement | null&gt;(null); // 滚动容器引用

const ListData = ref&lt;any[]&gt;([]); // 完整列表数据
const scrollTop = ref(0); // 滚动距离
const itemHeights = ref&lt;Map&lt;number, number&gt;&gt;(new Map()); // 子组件高度映射表
const cumulativeHeights = ref&lt;number[]&gt;([0]); // 累计高度数组
const scrollTimer = ref&lt;number | null&gt;(null); // 滚动节流定时器
const isUpdatingCumulative = ref(false); // 累计高度更新防抖

// 初始化位置数据
const initPositionData = () =&gt; {
  // 初始化高度映射表（默认最小高度）
  const heightMap = new Map&lt;number, number&gt;();
  ListData.value.forEach((item) =&gt; {
    heightMap.set(item.id, MIN_ITEM_HEIGHT);
  });
  // 初始化累计高度
  updateCumulativeHeights();
};

// 更新累计高度（核心）
const updateCumulativeHeights = () =&gt; {
  if (isUpdatingCumulative.value) return;
  isUpdatingCumulative.value = true;

  const itemCount = ListData.value.length;
  const cumulative = [0];
  let sum = 0;

  for (let i = 0; i &lt; itemCount; i++) {
    const itemId = ListData.value[i].id;
    sum += itemHeights.value.get(itemId) || MIN_ITEM_HEIGHT;
    cumulative.push(sum);
  }

  cumulativeHeights.value = cumulative;
  isUpdatingCumulative.value = false;
};

// 处理子组件的高度更新事件
const handleItemHeightUpdate = (id: number, height: number) =&gt; {
  // 高度未变化则跳过
  if (itemHeights.value.get(id) === height) return;

  // 更新高度映射表
  itemHeights.value.set(id, height);

  // 异步更新累计高度（避免同步更新导致的性能问题）
  nextTick(() =&gt; {
    updateCumulativeHeights();
  });
};

// 总高度，根据统计高度数组最后一个值计算得出
const totalHeight = computed(() =&gt; {
  return cumulativeHeights.value[cumulativeHeights.value.length - 1] || 0;
});

// 列表可视区域高度
const viewportHeight = computed(() =&gt; {
  return virtualListRef.value?.clientHeight || MIN_ITEM_HEIGHT * 5;
});

// 计算起始索引
const startIndex = computed(() =&gt; {
  const totalItemCount = ListData.value.length;
  if (totalItemCount === 0) return 0;
  if (scrollTop.value &lt;= 0) return 0;

  let baseStartIndex = 0;
  // 反向遍历找起始索引
  for (let i = cumulativeHeights.value.length - 1; i &gt;= 0; i--) {
    if (cumulativeHeights.value[i] &lt;= scrollTop.value) {
      baseStartIndex = i;
      break;
    }
  }
  const finalIndex = Math.max(0, baseStartIndex - BUFFER); // 确保不小于0
  return Math.min(finalIndex, totalItemCount - 1);
});

// 计算结束索引
const endIndex = computed(() =&gt; {
  const totalItemCount = ListData.value.length;
  const viewportHeightVal = viewportHeight.value;
  if (totalItemCount === 0) return 0;

  const targetScrollBottom = scrollTop.value + viewportHeightVal; // 目标滚动到底部位置
  let baseEndIndex = totalItemCount - 1;
  for (let i = 0; i &lt; cumulativeHeights.value.length; i++) {
    if (cumulativeHeights.value[i] &gt; targetScrollBottom) {
      baseEndIndex = i - 1;
      break;
    }
  }
  const finalEndIndex = Math.min(baseEndIndex + BUFFER, totalItemCount - 1); // 确保不大于总项数-1
  return finalEndIndex;
});

// 可见列表
const visibleList = computed(() =&gt; {
  const start = startIndex.value;
  const end = endIndex.value;
  return start &lt;= end ? ListData.value.slice(start, end + 1) : [];
});

const offsetY = computed(() =&gt; {
  return cumulativeHeights.value[startIndex.value] || 0;
});

// 滚动节流处理
const handleScroll = () =&gt; {
  if (!virtualListRef.value) return;

  if (scrollTimer.value) clearTimeout(scrollTimer.value);
  scrollTimer.value = window.setTimeout(() =&gt; {
    scrollTop.value = virtualListRef.value!.scrollTop;
  }, 20);
};

const handleResize = () =&gt; {
  if (virtualListRef.value) {
    scrollTop.value = virtualListRef.value.scrollTop;
  }
};

const goBack = () =&gt; {
  router.push('/home');
};

// 生命周期
onMounted(() =&gt; {
  // 生成模拟数据
  ListData.value = Array.from({ length: 1000 }, (_, index) =&gt; ({
    id: index,
    name: `Item ${index}`,
  }));
  initPositionData();
  window.addEventListener('resize', handleResize); // 监听窗口大小变化
});

onUnmounted(() =&gt; {
  window.removeEventListener('resize', handleResize);
  if (scrollTimer.value) clearTimeout(scrollTimer.value);
  isUpdatingCumulative.value = false;
  itemHeights.value.clear();
});
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-9">3. React + tailwindCSS 实现（子组件抽离）</h3>
<p><strong>子组件：</strong></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useEffect, useRef, useState, useCallback } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">VirtualListItemProps</span> {
  <span class="hljs-attr">item</span>: {
    <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  };
  <span class="hljs-attr">onUpdateHeight</span>: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">number</span>, height: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>; <span class="hljs-comment">// 替代 Vue 的 emit</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">VirtualListItem</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">VirtualListItemProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{
  item,
  onUpdateHeight,
}</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> itemRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-comment">// 存储 ResizeObserver 实例（避免重复创建）</span>
  <span class="hljs-keyword">const</span> resizeObserverRef = useRef&lt;<span class="hljs-title class_">ResizeObserver</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 计算并上报高度</span>
  <span class="hljs-keyword">const</span> sendItemHeight = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!itemRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> realHeight = itemRef.<span class="hljs-property">current</span>.<span class="hljs-property">offsetHeight</span>;
    <span class="hljs-title function_">onUpdateHeight</span>(item.<span class="hljs-property">id</span>, realHeight);
  }, [item.<span class="hljs-property">id</span>, onUpdateHeight]);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">sendItemHeight</span>();
    }, <span class="hljs-number">0</span>);

    <span class="hljs-comment">// 初始化 ResizeObserver 监听高度变化</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">ResizeObserver</span>) {
      resizeObserverRef.<span class="hljs-property">current</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResizeObserver</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">sendItemHeight</span>();
      });
      <span class="hljs-keyword">if</span> (itemRef.<span class="hljs-property">current</span>) {
        resizeObserverRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">observe</span>(itemRef.<span class="hljs-property">current</span>);
      }
    }

    <span class="hljs-comment">// 清理定时器（对应 Vue 的 onUnmounted 部分）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-built_in">clearTimeout</span>(timer);
      <span class="hljs-keyword">if</span> (resizeObserverRef.<span class="hljs-property">current</span>) {
        resizeObserverRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">disconnect</span>();
        resizeObserverRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
      }
    };
  }, [sendItemHeight]); <span class="hljs-comment">// 仅首次挂载执行</span>

  <span class="hljs-comment">//监听 item 变化重新计算高度</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">sendItemHeight</span>();
    }, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearTimeout</span>(timer);
  }, [item.<span class="hljs-property">id</span>, sendItemHeight]); <span class="hljs-comment">// item.id 变化时执行</span>

  <span class="hljs-keyword">const</span> itemClass = <span class="hljs-string">`py-2 px-4 border-b border-gray-200 <span class="hljs-subst">${
    item.id % <span class="hljs-number">2</span> !== <span class="hljs-number">0</span> ? <span class="hljs-string">'bg-pink-200'</span> : <span class="hljs-string">'bg-green-200'</span>
  }</span>`</span>;

  <span class="hljs-keyword">const</span> <span class="hljs-attr">itemStyle</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">CSSProperties</span> = {
    <span class="hljs-attr">height</span>: item.<span class="hljs-property">id</span> % <span class="hljs-number">2</span> === <span class="hljs-number">0</span> ? <span class="hljs-string">'150px'</span> : <span class="hljs-string">'100px'</span>,
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{itemRef}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{itemClass}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{itemStyle}</span>&gt;</span>
      {item.name}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">VirtualListItem</span>;


</code></pre>
<p><strong>父组件：</strong></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, {
  useEffect,
  useRef,
  useState,
  useCallback,
  useMemo,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VirtualListItem</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./listItem'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">VirtualList</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MIN_ITEM_HEIGHT</span> = <span class="hljs-number">100</span>; <span class="hljs-comment">// 最小项高度</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BUFFER</span> = <span class="hljs-number">5</span>; <span class="hljs-comment">// 缓冲区项数</span>

  <span class="hljs-keyword">const</span> virtualListRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>); <span class="hljs-comment">// 虚拟列表容器引用</span>

  <span class="hljs-keyword">const</span> [listData, setListData] = useState&lt;<span class="hljs-title class_">Array</span>&lt;{ <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> }&gt;&gt;(
    []
  ); <span class="hljs-comment">// 列表数据</span>
  <span class="hljs-keyword">const</span> [scrollTop, setScrollTop] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 滚动位置</span>
  <span class="hljs-keyword">const</span> [itemHeights, setItemHeights] = useState&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span>&gt;&gt;(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
  ); <span class="hljs-comment">// 高度映射表（Map 结构）</span>
  <span class="hljs-keyword">const</span> [cumulativeHeights, setCumulativeHeights] = useState&lt;<span class="hljs-built_in">number</span>[]&gt;([<span class="hljs-number">0</span>]); <span class="hljs-comment">// 累计高度数组</span>
  <span class="hljs-keyword">const</span> scrollTimerRef = useRef&lt;<span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>); <span class="hljs-comment">// 滚动节流定时器</span>

  <span class="hljs-comment">// 初始化模拟数据</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">initData</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> mockData = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">1000</span> }, <span class="hljs-function">(<span class="hljs-params">_, index</span>) =&gt;</span> ({
      <span class="hljs-attr">id</span>: index,
      <span class="hljs-attr">name</span>: <span class="hljs-string">`Item <span class="hljs-subst">${index}</span>`</span>,
    }));
    <span class="hljs-title function_">setListData</span>(mockData);
    <span class="hljs-comment">// 初始化高度映射表（默认最小高度）</span>
    <span class="hljs-keyword">const</span> initHeightMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span>&gt;();
    mockData.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
      initHeightMap.<span class="hljs-title function_">set</span>(item.<span class="hljs-property">id</span>, <span class="hljs-variable constant_">MIN_ITEM_HEIGHT</span>);
    });
    <span class="hljs-title function_">setItemHeights</span>(initHeightMap);
    <span class="hljs-comment">// 初始化累计高度</span>
    <span class="hljs-title function_">updateCumulativeHeights</span>(initHeightMap, mockData);
  };

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">initData</span>();
    <span class="hljs-comment">// 监听窗口大小变化</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleResize</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">if</span> (virtualListRef.<span class="hljs-property">current</span>) {
        <span class="hljs-title function_">setScrollTop</span>(virtualListRef.<span class="hljs-property">current</span>.<span class="hljs-property">scrollTop</span>);
      }
    };
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, handleResize);

    <span class="hljs-comment">// 清理监听</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'resize'</span>, handleResize);
      <span class="hljs-keyword">if</span> (scrollTimerRef.<span class="hljs-property">current</span>) {
        <span class="hljs-built_in">clearTimeout</span>(scrollTimerRef.<span class="hljs-property">current</span>);
      }
      itemHeights.<span class="hljs-title function_">clear</span>(); <span class="hljs-comment">// 清空 Map 释放内存</span>
    };
  }, []);

  <span class="hljs-comment">// 更新累计高度（核心函数）</span>
  <span class="hljs-keyword">const</span> updateCumulativeHeights = <span class="hljs-title function_">useCallback</span>(
    <span class="hljs-function">(<span class="hljs-params">heightMap: <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span>&gt;, data: <span class="hljs-keyword">typeof</span> listData</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> cumulative = [<span class="hljs-number">0</span>];
      <span class="hljs-keyword">let</span> sum = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; data.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-keyword">const</span> itemId = data[i].<span class="hljs-property">id</span>;
        sum += heightMap.<span class="hljs-title function_">get</span>(itemId) || <span class="hljs-variable constant_">MIN_ITEM_HEIGHT</span>;
        cumulative.<span class="hljs-title function_">push</span>(sum);
      }
      <span class="hljs-title function_">setCumulativeHeights</span>(cumulative);
    },
    [<span class="hljs-variable constant_">MIN_ITEM_HEIGHT</span>]
  );

  <span class="hljs-comment">// 处理子组件的高度更新事件（对应 Vue 的 handleItemHeightUpdate）</span>
  <span class="hljs-keyword">const</span> handleItemHeightUpdate = <span class="hljs-title function_">useCallback</span>(
    <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">number</span>, height: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
      <span class="hljs-comment">// 高度未变化则跳过</span>
      <span class="hljs-keyword">if</span> (itemHeights.<span class="hljs-title function_">get</span>(id) === height) <span class="hljs-keyword">return</span>;

      <span class="hljs-comment">// 更新高度映射表</span>
      <span class="hljs-keyword">const</span> newHeightMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(itemHeights);
      newHeightMap.<span class="hljs-title function_">set</span>(id, height);
      <span class="hljs-title function_">setItemHeights</span>(newHeightMap);

      <span class="hljs-comment">// 异步更新累计高度</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">updateCumulativeHeights</span>(newHeightMap, listData);
      }, <span class="hljs-number">0</span>);
    },
    [itemHeights, listData, updateCumulativeHeights]
  );

  <span class="hljs-comment">// 滚动节流处理</span>
  <span class="hljs-keyword">const</span> handleScroll = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!virtualListRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 节流：20ms 内只更新一次 scrollTop</span>
    <span class="hljs-keyword">if</span> (scrollTimerRef.<span class="hljs-property">current</span>) {
      <span class="hljs-built_in">clearTimeout</span>(scrollTimerRef.<span class="hljs-property">current</span>);
    }
    scrollTimerRef.<span class="hljs-property">current</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setScrollTop</span>(virtualListRef.<span class="hljs-property">current</span>!.<span class="hljs-property">scrollTop</span>);
    }, <span class="hljs-number">20</span>);
  }, []);

  <span class="hljs-comment">// 可视区域高度</span>
  <span class="hljs-keyword">const</span> viewportHeight = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> virtualListRef.<span class="hljs-property">current</span>?.<span class="hljs-property">clientHeight</span> || <span class="hljs-variable constant_">MIN_ITEM_HEIGHT</span> * <span class="hljs-number">5</span>;
  }, []);

  <span class="hljs-comment">//  总列表高度</span>
  <span class="hljs-keyword">const</span> totalHeight = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> cumulativeHeights[cumulativeHeights.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] || <span class="hljs-number">0</span>;
  }, [cumulativeHeights]);

  <span class="hljs-comment">// 起始索引</span>
  <span class="hljs-keyword">const</span> startIndex = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> totalItemCount = listData.<span class="hljs-property">length</span>;
    <span class="hljs-keyword">if</span> (totalItemCount === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (scrollTop &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

    <span class="hljs-comment">// 反向遍历找起始索引</span>
    <span class="hljs-keyword">let</span> baseStartIndex = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = cumulativeHeights.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
      <span class="hljs-keyword">if</span> (cumulativeHeights[i] &lt;= scrollTop) {
        baseStartIndex = i;
        <span class="hljs-keyword">break</span>;
      }
    }

    <span class="hljs-keyword">const</span> finalIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, baseStartIndex - <span class="hljs-variable constant_">BUFFER</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(finalIndex, totalItemCount - <span class="hljs-number">1</span>);
  }, [
    scrollTop,
    viewportHeight,
    totalHeight,
    cumulativeHeights,
    listData.<span class="hljs-property">length</span>,
  ]);

  <span class="hljs-comment">// 结束索引</span>
  <span class="hljs-keyword">const</span> endIndex = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> totalItemCount = listData.<span class="hljs-property">length</span>;
    <span class="hljs-keyword">if</span> (totalItemCount === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

    <span class="hljs-keyword">const</span> targetScrollBottom = scrollTop + viewportHeight;
    <span class="hljs-keyword">let</span> baseEndIndex = totalItemCount - <span class="hljs-number">1</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; cumulativeHeights.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-keyword">if</span> (cumulativeHeights[i] &gt; targetScrollBottom) {
        baseEndIndex = i - <span class="hljs-number">1</span>;
        <span class="hljs-keyword">break</span>;
      }
    }

    <span class="hljs-keyword">let</span> finalEndIndex = baseEndIndex + <span class="hljs-variable constant_">BUFFER</span>;
    finalEndIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(finalEndIndex, totalItemCount - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">return</span> finalEndIndex;
  }, [scrollTop, viewportHeight, cumulativeHeights, listData.<span class="hljs-property">length</span>]);

  <span class="hljs-comment">// 可视区列表</span>
  <span class="hljs-keyword">const</span> visibleList = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> startIndex &lt;= endIndex
      ? listData.<span class="hljs-title function_">slice</span>(startIndex, endIndex + <span class="hljs-number">1</span>)
      : [];
  }, [startIndex, endIndex, listData]);

  <span class="hljs-comment">// 偏移量</span>
  <span class="hljs-keyword">const</span> offsetY = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> cumulativeHeights[startIndex] || <span class="hljs-number">0</span>;
  }, [startIndex, cumulativeHeights]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"h-full bg-gradient-to-br from-indigo-600 to-purple-600 py-10 px-5"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-white mt-10 h-[calc(100vh-200px)] rounded-xl"</span>&gt;</span>
        {/* 滚动容器 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
          <span class="hljs-attr">ref</span>=<span class="hljs-string">{virtualListRef}</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">"h-full overflow-auto relative"</span>
          <span class="hljs-attr">onScroll</span>=<span class="hljs-string">{handleScroll}</span>
        &gt;</span>
          {/* 占位容器：撑开滚动条 */}
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">height:</span> `${<span class="hljs-attr">totalHeight</span>}<span class="hljs-attr">px</span>` }}&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

          {/* 可视区域列表：transform 偏移 */}
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">"absolute top-0 left-0 right-0"</span>
            <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">transform:</span> `<span class="hljs-attr">translateY</span>(${<span class="hljs-attr">offsetY</span>}<span class="hljs-attr">px</span>)` }}
          &gt;</span>
            {visibleList.map((item) =&gt; (
              <span class="hljs-tag">&lt;<span class="hljs-name">VirtualListItem</span>
                <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>
                <span class="hljs-attr">item</span>=<span class="hljs-string">{item}</span>
                <span class="hljs-attr">onUpdateHeight</span>=<span class="hljs-string">{handleItemHeightUpdate}</span>
              /&gt;</span>
            ))}
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">VirtualList</span>;

</code></pre>
<h3 data-id="heading-10">4. 实现效果图</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f94fc95662c463caed332ed77b1d3c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-R546w5LiA5Y-q5aSn5ZGG55Oc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771040975&amp;x-signature=SGyg1H2pDISwd9X9leROtXl7YlA%3D" alt="动高虚拟列表滚动.gif" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-11">四、 总结与避坑指南</h2>
<h3 data-id="heading-12">1. 为什么需要缓冲区（BUFFER）？</h3>
<p>如果只渲染可见部分，用户快速滚动时，异步渲染可能会导致瞬间的“白屏”。设置上下缓冲区可以预加载部分 DOM，让滑动更顺滑。</p>
<h3 data-id="heading-13">2. 性能进一步优化</h3>
<ul>
<li><strong>滚动节流（Throttle）</strong> ：虽然滚动监听很快，但在 <code>handleScroll</code> 中加入 <code>requestAnimationFrame</code> 或 20ms 的节流，能有效减轻主线程压力。</li>
<li><strong>Key 的选择</strong>：在虚拟列表中，<code>key</code> 必须是唯一的 <code>id</code>，绝对不能使用 <code>index</code>，否则在滚动重用 DOM 时会出现状态错乱。</li>
</ul>
<h3 data-id="heading-14">3. 注意事项</h3>
<ul>
<li><strong>定高</strong>：逻辑简单，性能极高。</li>
<li><strong>不定高</strong>：依赖 <code>ResizeObserver</code>，需注意频繁重排对性能的影响，建议对 <code>updateCumulativeHeights</code> 做异步批处理。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[脚本伪装：让 Python 与 Node.js 像原生 Shell 命令一样运行]]></title>    <link>https://juejin.cn/post/7603591775391973403</link>    <guid>https://juejin.cn/post/7603591775391973403</guid>    <pubDate>2026-02-07T01:59:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603591775391973403" data-draft-id="7603584155785379890" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="脚本伪装：让 Python 与 Node.js 像原生 Shell 命令一样运行"/> <meta itemprop="keywords" content="JavaScript,Python,运维"/> <meta itemprop="datePublished" content="2026-02-07T01:59:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火车叼位"/> <meta itemprop="url" content="https://juejin.cn/user/1345457960792808"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            脚本伪装：让 Python 与 Node.js 像原生 Shell 命令一样运行
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1345457960792808/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火车叼位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-07T01:59:16.000Z" title="Sat Feb 07 2026 01:59:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在开发自动化工具或命令行小玩具时，频繁输入 <code>python myscript.py</code> 或 <code>node index.js</code> 难免显得笨拙。为了让这些脚本看起来更像系统原生的二进制工具，我们需要对其进行“伪装”。</p>
<p>本文将带你攻克 Linux 和 Windows 两大平台，实现脚本的直接调用。</p>
<h2 data-id="heading-0">一、 Linux 环境：利用 Shebang 实现优雅调用</h2>
<p>在类 Unix 系统（Linux, macOS, BSD）中，内核支持一种名为 <strong>Shebang</strong> 的机制。通过在文件头部指定解释器路径，系统会自动调用相应的环境来运行代码。</p>
<h4 data-id="heading-1">1. 核心步骤：Shebang + 可执行权限</h4>
<p>要在 Linux 上实现“伪装”，你需要完成以下两个动作：</p>
<p><strong>第一步：在脚本首行添加 Shebang</strong>
推荐使用 <code>/usr/bin/env</code> 方式，它会自动从用户的 <code>PATH</code> 环境变量中寻找解释器，具有极强的可移植性。</p>
<ul>
<li><strong>Python 示例：</strong></li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>
<span class="hljs-keyword">import</span> sys
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Python 正在运行，参数为: <span class="hljs-subst">{sys.argv[<span class="hljs-number">1</span>:]}</span>"</span>)

</code></pre>
<ul>
<li><strong>Node.js 示例：</strong></li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-meta">#!/usr/bin/env node</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Node.js 脚本已启动，当前工作目录:"</span>, process.<span class="hljs-title function_">cwd</span>());

</code></pre>
<p><strong>第二步：赋予执行权限</strong>
在终端运行 <code>chmod +x</code> 命令，告诉文件系统该文件可以被执行：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> +x my_script.py

</code></pre>
<p>此时，你就可以通过 <code>./my_script.py</code> 直接运行它了。</p>
<h4 data-id="heading-2">2. 进阶：去除后缀并全局化</h4>
<p>如果你想在任何路径下通过输入 <code>mytool</code>（而不是 <code>./mytool.py</code>）来运行脚本：</p>
<ol>
<li><strong>重命名并去掉后缀</strong>：<code>mv my_script.py mytool</code></li>
<li><strong>移入 PATH 路径</strong>：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">mv</span> mytool /usr/local/bin/

</code></pre>
<p><em>注：<code>/usr/local/bin</code> 通常默认在系统 PATH 中，这样你只需输入 <code>mytool</code> 即可直接触发。</em></p>
<hr/>
<h2 data-id="heading-3">二、 Windows 环境：从批处理到环境关联</h2>
<p>Windows 并不原生支持 Shebang 机制（除非在 WSL 内部运行）。它主要依靠<strong>文件扩展名关联</strong>。</p>
<h4 data-id="heading-4">1. 方案 A：使用 .bat 包装器（推荐）</h4>
<p>这是最稳妥的方法。通过创建一个简单的批处理文件，将接收到的所有参数（用 <code>%*</code> 表示）转发给脚本解释器。</p>
<ul>
<li><strong>创建 <code>mytool.bat</code>：</strong></li>
</ul>
<pre><code class="hljs language-batch" lang="batch">@echo off
python "C:\scripts\my_script.py" %*

</code></pre>
<p><em>注：<code>@echo off</code> 用于隐藏命令本身的执行行，<code>%*</code> 确保你传递给 <code>.bat</code> 的参数能原封不动地传给 Python。</em></p>
<h4 data-id="heading-5">2. 方案 B：利用文件关联</h4>
<p>如果你安装 Python 时勾选了 <strong>"Add Python to PATH"</strong>，Windows 会自动将 <code>.py</code> 文件关联到 <code>python.exe</code>。</p>
<ul>
<li>在命令行直接输入 <code>script.py</code> 即可运行。</li>
<li><strong>注意</strong>：<code>.js</code> 文件在 Windows 上默认关联的是老旧的 <code>WScript</code> (Windows Script Host)，这会导致运行 Node.js 脚本时报错。你需要手动修改 <code>.js</code> 的打开方式为 <code>node.exe</code>。</li>
</ul>
<h4 data-id="heading-6">3. 方案 C：PowerShell 别名（Alias）</h4>
<p>如果你是 PowerShell 用户，可以在配置文件中定义函数来实现：</p>
<pre><code class="hljs language-powershell" lang="powershell"># 在 $PROFILE 文件中添加
function Run-MyTool { python "C:\path\to\script.py" $args }
Set-Alias -Name mytool -Value Run-MyTool

</code></pre>
<hr/>
<h2 data-id="heading-7">三、 跨平台对比总结</h2>






























<table><thead><tr><th>特性</th><th>Linux / macOS</th><th>Windows</th></tr></thead><tbody><tr><td><strong>底层机制</strong></td><td>Shebang (<code>#!</code>)</td><td>文件后缀名关联</td></tr><tr><td><strong>推荐做法</strong></td><td><code>chmod +x</code> + <code>/usr/bin/env</code></td><td><code>.bat</code> 或 <code>.cmd</code> 包装</td></tr><tr><td><strong>全局调用</strong></td><td>放入 <code>/usr/local/bin</code></td><td>将脚本所在文件夹加入环境变量 <code>Path</code></td></tr><tr><td><strong>参数传递</strong></td><td>原生支持</td><td>需在批处理中使用 <code>%*</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-8">四、 结论与行动建议</h2>
<p>将脚本转化为工具不仅是为了“好看”，更是为了提升自动化流转的效率。</p>
<h4 data-id="heading-9">核心行动建议：</h4>
<ol>
<li>**优先使用 <code>/usr/bin/env**</code>：无论开发什么脚本，首行养成写 Shebang 的习惯，这能显著降低 Linux 用户的使用门槛。</li>
<li><strong>封装为工具包</strong>：如果你的脚本较多，建议将其统一放在一个目录下（如 <code>~/bin</code> 或 <code>C:\tools</code>），并将该目录添加到系统的 <code>PATH</code> 环境变量中。</li>
<li><strong>处理跨平台差异</strong>：对于需要跨平台分发的工具，可以考虑使用 <code>poetry</code> (Python) 或 <code>npm bin</code> (Node.js) 提供的 Entry Points 功能，它们会自动为你生成适配各平台的启动器。</li>
</ol>
<hr/>
<p><strong>参考来源：</strong></p>
<ul>
<li>Linux Manual Pages: <a href="https://link.juejin.cn?target=https%3A%2F%2Fman7.org%2Flinux%2Fman-pages%2Fman2%2Fexecve.2.html" target="_blank" title="https://man7.org/linux/man-pages/man2/execve.2.html" ref="nofollow noopener noreferrer">execve(2) - Shebang mechanism</a></li>
<li>Python Documentation: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.python.org%2F3%2Fusing%2Fwindows.html" target="_blank" title="https://docs.python.org/3/using/windows.html" ref="nofollow noopener noreferrer">Using Python on Windows</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[也许你不需要创建.venv, 此规范使python脚本自备依赖]]></title>    <link>https://juejin.cn/post/7603591775391891483</link>    <guid>https://juejin.cn/post/7603591775391891483</guid>    <pubDate>2026-02-07T01:41:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603591775391891483" data-draft-id="7603591775391858715" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="也许你不需要创建.venv, 此规范使python脚本自备依赖"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-02-07T01:41:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火车叼位"/> <meta itemprop="url" content="https://juejin.cn/user/1345457960792808"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            也许你不需要创建.venv, 此规范使python脚本自备依赖
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1345457960792808/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火车叼位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-07T01:41:50.000Z" title="Sat Feb 07 2026 01:41:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Python 开发中，我们经常陷入一种“环境通胀”：为了运行一个不到 50 行的简单脚本（比如抓个接口数据、写个 Streamlit 演示），却不得不经历 <code>python -m venv .venv</code>、激活环境、<code>pip install</code> 等一系列繁琐动作。</p>
<p>如果你手头有十个这样的脚本，你的磁盘就会被几十个重复的 <code>.venv</code> 文件夹占满。<strong>Astral 推出的 <code>uv</code> 工具正在终结这种低效。</strong> 配合 <strong>PEP 723 (Inline script metadata)</strong> 规范，我们可以真正实现“单文件即项目”的优雅体验。</p>
<hr/>
<h2 data-id="heading-0">1. 核心纠偏：uv init 还是 uv venv？</h2>
<p>很多初学者在刚接触 <code>uv</code> 时会感到困惑。其实，针对不同的颗粒度，<code>uv</code> 提供了三条清晰的路径：</p>

























<table><thead><tr><th>命令</th><th>适用场景</th><th>产物</th></tr></thead><tbody><tr><td><strong><code>uv init</code></strong></td><td><strong>正规军</strong>：需要长期维护、多人协作的复杂应用。</td><td><code>pyproject.toml</code>, <code>.python-version</code></td></tr><tr><td><strong><code>uv venv</code></strong></td><td><strong>传统派</strong>：只是想快点创建环境，继续用传统的 <code>pip</code> 习惯。</td><td><code>.venv</code> 文件夹</td></tr><tr><td><strong><code>uv run</code></strong></td><td><strong>特种兵</strong>：单脚本运行，<strong>不产生任何本地依赖文件夹</strong>。</td><td>临时缓存环境（自动管理）</td></tr></tbody></table>
<blockquote>
<p>[!TIP]
对于简单的工具脚本，<strong>忘掉前两个命令</strong>。你只需要 <code>uv run</code>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">2. 现代方案：PEP 723 脚本元数据</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpeps.python.org%2Fpep-0723%2F" target="_blank" title="https://peps.python.org/pep-0723/" ref="nofollow noopener noreferrer">PEP 723</a> 是 Python 社区的一个里程碑。它允许我们将依赖信息直接以“代码注释”的形式嵌入到脚本头部。这意味着你的脚本具备了<strong>自描述性</strong>——它是自给自足的。</p>
<h3 data-id="heading-2">规范示例</h3>
<p>当你运行一个包含以下代码块的脚本时：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># /// script</span>
<span class="hljs-comment"># dependencies = [</span>
<span class="hljs-comment">#   "httpx",</span>
<span class="hljs-comment">#   "streamlit",</span>
<span class="hljs-comment"># ]</span>
<span class="hljs-comment"># ///</span>

<span class="hljs-keyword">import</span> httpx
<span class="hljs-keyword">import</span> streamlit <span class="hljs-keyword">as</span> st

st.title(<span class="hljs-string">"Token 刷新工具"</span>)
<span class="hljs-comment"># 脚本逻辑...</span>

</code></pre>
<h3 data-id="heading-3">为什么这种方式更优秀？</h3>
<ol>
<li><strong>环境全自动化</strong>：运行 <code>uv run script.py</code> 时，<code>uv</code> 会瞬时在后台创建临时环境。如果依赖没变，下次运行会直接秒开。</li>
<li><strong>零污染</strong>：它不会在你的脚本目录下留下 <code>.venv</code> 文件夹，全局环境永远保持洁净。</li>
<li><strong>极简分发</strong>：把脚本发给同事时，不用再附带 <code>requirements.txt</code>。对方只要装了 <code>uv</code>，直接运行即可。</li>
</ol>
<hr/>
<h2 data-id="heading-4">3. 实战技巧：如何快速配置</h2>
<p>不想手动打那堆 <code># ///</code> 注释？<code>uv</code> 早就帮你想好了自动化方案。</p>
<p>如果你已经写好了一个脚本 <code>refresh_token.py</code>，只需在终端输入：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 为脚本一键添加依赖声明</span>
uv add --script refresh_token.py <span class="hljs-string">"streamlit"</span> <span class="hljs-string">"httpx"</span>

</code></pre>
<p>这会自动在文件头插入符合 PEP 723 规范的元数据。之后，你只需一行命令即可启动：</p>
<pre><code class="hljs language-bash" lang="bash">uv run refresh_token.py

</code></pre>
<hr/>
<h2 data-id="heading-5">4. 进阶特性：精细化控制</h2>
<p>除了基础的依赖管理，你还可以在脚本头部玩出更多花样：</p>
<ul>
<li><strong>版本约束</strong>：<code>"requests&gt;=2.31.0"</code>，确保脚本不会因为库升级而崩掉。</li>
<li><strong>指定 Python 版本</strong>：<code># requires-python = "&gt;=3.12"</code>，自动调用合适的解释器。</li>
<li><strong>工具链配置</strong>：通过 <code>[tool.uv]</code> 块自定义镜像源，解决国内下载慢的问题。</li>
</ul>
<hr/>
<h2 data-id="heading-6">结论与行动建议</h2>
<p>Python 脚本的开发模式正在从“手动建档”转向“声明式运行”。</p>
<ul>
<li><strong>立即可做</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.astral.sh%2Fuv%2Fgetting-started%2Finstallation%2F" target="_blank" title="https://docs.astral.sh/uv/getting-started/installation/" ref="nofollow noopener noreferrer">安装 uv</a>，并尝试用 <code>uv run --with &lt;库名&gt; &lt;脚本&gt;</code> 运行一个临时脚本。</li>
<li><strong>长期实践</strong>：对于所有的工具类脚本，统一使用 <code>uv add --script</code> 写入元数据，把每一个脚本都打造成一个<strong>自给自足的“单兵作战单元”</strong>。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[关于行业 AI Agent 评测的 9 个方面]]></title>    <link>https://juejin.cn/post/7603643385816514612</link>    <guid>https://juejin.cn/post/7603643385816514612</guid>    <pubDate>2026-02-08T03:04:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603643385816514612" data-draft-id="7603643385816498228" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="关于行业 AI Agent 评测的 9 个方面"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2026-02-08T03:04:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="潘锦"/> <meta itemprop="url" content="https://juejin.cn/user/730549110707431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            关于行业 AI Agent 评测的 9 个方面
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/730549110707431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    潘锦
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T03:04:48.000Z" title="Sun Feb 08 2026 03:04:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>做 AI Agent，跑起来很容易，简单点函数调用+几个最好的大模型，复杂一点，整合或「学习」一些开源的多 Agent 项目，也能跑起来。</p>
<p>但是如何真正要做到一个行业中去，把一个行业 Agent 做好就没那么容易了，特别是让这个 Agent 能稳定的迭代，稳定的跑对了，也就难了。</p>
<p>在这些迭代过程中，我们会不停的换模型、改提示词、加工具、加缓存、改路由、做多智能体……</p>
<p>这样我们就会收获如下的一堆问题：</p>
<ul>
<li>线上用户说「变笨了」，却没证据；</li>
<li>反馈说生成效果不行，却不知道该如何描述其所说的效果；</li>
<li>修一个 bug，引入三个新 bug；</li>
<li>团队讨论靠口感，最后靠拍板；</li>
<li>研发不敢升级模型，因为测试周期太长；</li>
<li>业务要结果，技术要可控，双方都焦虑。</li>
</ul>
<p>面对这些问题，我们聊聊如何对行业 Agent 做评测。</p>
<h2 data-id="heading-0">0. 说在前面</h2>
<p>我们评测的是「系统」，不是「模型」</p>
<p>很多团队说在做评测，实际上只是在测「模型回复像不像」。对 Agent 来说不够，因为 Agent 的能力来自两部分：</p>
<ul>
<li>模型</li>
<li>工程：提示词、工具编排、状态管理、记忆、重试策略、检索、权限、路由、超时、并发、回退等</li>
</ul>
<p>所以评测对象应该是：模型 + 工程 的整体行为。</p>
<h2 data-id="heading-1">1. 标准</h2>
<p>团队里面一定要有领域专家，没有领域专家的测评只能算自娱自乐。</p>
<p>Agent 的「好」不是抽象的。没有领域专家，评测标准会变成两类坏结果：</p>
<ul>
<li>写得很漂亮，但不对应业务结果（比如客服很礼貌，但票据没关单）</li>
<li>标准含糊，评分不可重复（今天判通过，明天同样输出判不通过）</li>
</ul>
<p>「领域专家」不一定是外部大咖，很多时候就是我们身边的同事：</p>
<ul>
<li>客服主管（知道什么叫“解决”）</li>
<li>财务/风控（知道哪些动作不能做）</li>
<li>资深运营（知道用户会怎么钻空子）</li>
<li>负责交付的实施/售后（知道线上真实约束）</li>
<li>售前负责人（知道用户要的是什么）</li>
</ul>
<p>要求只有一个：两位领域专家独立评审同一个任务，应该能得到一致的 pass/fail。做不到就说明任务或标准还不够清晰。</p>
<h2 data-id="heading-2">2. 数据集</h2>
<p>输入与输出要成对，从 20 条 good case 和 bad case 开始吧。</p>
<p>很多团队拖着不做评测，理由是「没有足够的数据」。</p>
<h2 data-id="heading-3">2.1 数据集怎么来</h2>
<ol>
<li>线上事故 / 客诉 / 工单：最值钱，但也是压力最大的</li>
<li>发布前人工回归里会反复点的那些检查项</li>
<li>运营同学最常复述的“用户就爱这么问”</li>
<li>灰度期间的失败轨迹（尤其是工具调用失败、超时、权限不足、状态不一致）</li>
</ol>
<h2 data-id="heading-4">2.2 一个测试任务里应该包含什么</h2>
<ul>
<li>输入（用户消息 + 初始状态 + 可用工具 + 环境约束）</li>
<li>明确的成功条件</li>
<li>参考解（可能是图、视频和文本）</li>
</ul>
<p>当遇到测试不通过或者通过率很低时，一般不是模型不行，可能是设计的测试任务有问题。</p>
<h2 data-id="heading-5">2.3 数据集要有正反两派</h2>
<p>测试人都知道的，做测试更多的是测异常。在做数据集时，这个逻辑一样的成立。</p>
<ul>
<li>该搜 vs 不该搜</li>
<li>该下单 vs 不该下单</li>
<li>该升级人工 vs 应该继续处理</li>
<li>该改文件 vs 不该动文件</li>
<li>该生成图 vs 应该拒绝（合规/版权/不当内容）</li>
</ul>
<h2 data-id="heading-6">3. 系统</h2>
<p>让过程系统化，小系统也是系统</p>
<p>评测不系统化，最后一定会回到「手工点点点 + 群里吵架」。一个可用的评测系统，最少包括：</p>
<h2 data-id="heading-7">3.1 评测运行系统</h2>
<ul>
<li>并发跑任务</li>
<li>每个环境隔离（干净的文件系统、数据库、缓存、账户）</li>
<li>固定随机种子/版本（尽量可复现）</li>
<li>记录完整过程</li>
<li>输出结构化结果</li>
</ul>
<p>请注意：共享状态会污染结果。</p>
<p>这个系统可以大，也可以小，甚至小到只是一个 python 脚本。</p>
<h2 data-id="heading-8">3.2 评测资产管理</h2>
<ul>
<li>任务版本化（任务也要像代码一样走 PR）</li>
<li>rubric/断言版本化</li>
<li>基线版本固定可回放</li>
<li>失败样本池：每次线上新失败，能快速进入评测集</li>
<li>评测数据集管理</li>
<li>评测结果管理，特别是图片类 Agent，所有的结果图都需要保存，并且能随时查阅，给到领域专家来审查。</li>
</ul>
<h2 data-id="heading-9">3.3 结果可读性</h2>
<p>最终的结果重要，但这个结果不仅仅是分数，还必须能「点开看」：</p>
<ul>
<li>失败的结果</li>
<li>判定理由</li>
<li>最终的证据（输入的 prompt，图片结果，过程中的数据库/文件/页面状态等等）</li>
</ul>
<h2 data-id="heading-10">4. 成本</h2>
<p>和过往的测试工作不同，AI 的评测需要更多些的考虑成本，特别是多模态或视频，生图类 Agent。</p>
<p>这里的基本逻辑是：每个 AI 算力资源都是有限的，也是贵的。</p>
<p>如果在一个死循环中写了调用外部视频生成的接口逻辑，那等待的就是账号里面的钱被用光，如果有加了使用限制，大概率就是达到限制。</p>
<p>以第三方大模型账号为例，有几个小点：</p>
<ol>
<li>测试账号要和生产账号隔离，防止异常突出导致资源受限，在每个平台请求并发数，或者分钟请求数，或者 token 速度都是有限的，不同环境的资源需要隔离开来。</li>
<li>账号需要做好限制，防止账号的钱被用完；</li>
<li>安全考虑，定期更换。</li>
</ol>
<h2 data-id="heading-11">5. 传统测试方式</h2>
<p>静态分析、工具验证、记录分析这些传统的测试方法别丢了。</p>
<h2 data-id="heading-12">5.1 静态分析</h2>
<p>适合：</p>
<ul>
<li>代码类：lint、type check、安全扫描（ruff/mypy/bandit 这类）</li>
<li>配置类：schema 校验</li>
<li>文本结构：JSON schema、正则、字段完整性 优势：快、便宜、可复现、可 debug。</li>
</ul>
<h2 data-id="heading-13">5.2 工具验证</h2>
<p>Agent 出问题很常见的一类是：工具用错、参数错、顺序不合理、该用不用。</p>
<p>你可以验证：</p>
<ul>
<li>是否调用了某工具</li>
<li>参数是否在范围（例如退款金额 &lt;=100）</li>
<li>是否访问了不该访问的资源</li>
</ul>
<p>但要注意：不要把“必须按某条路径走”写死。太死会惩罚合理的创造性解法。更推荐「看产出」，必要时只加一些底线约束（比如必须做身份验证）。</p>
<h2 data-id="heading-14">5.3 记录分析</h2>
<p>不一定评价“对错”，而是监控质量与成本：</p>
<ul>
<li>turn 数、toolcall 数、tokens</li>
<li>延迟：TTFT、总耗时、吞吐</li>
<li>重试次数、错误码分布</li>
</ul>
<h2 data-id="heading-15">6. 新的基于大模型的测试</h2>
<p>该用用，但要用得克制</p>
<p>对于评测，我们通过可以分为三类：代码型、模型型、人工。实际落地里，模型型的价值主要在两件事：</p>
<ol>
<li>开放式输出：没有唯一正确答案（客服话术、研究总结、写作、规划）</li>
<li>细粒度质量维度：礼貌、同理心、覆盖度、论证质量、是否胡编</li>
</ol>
<p>常用方式：</p>
<ul>
<li>打分（按维度给分）</li>
<li>自然语言断言（是否满足某条要求）</li>
<li>A/B 谁更好</li>
<li>对照参考答案</li>
<li>多裁判投票/取中位数</li>
</ul>
<p>但需要注意：</p>
<ul>
<li>非确定性：同样输入可能不同评分</li>
<li>更贵：相当于每条任务再跑一遍模型</li>
<li>需要校准：必须和人评对齐，否则就是“模型自嗨”</li>
</ul>
<p>一个实用的建议：给 LLM 评测一个「退路」，例如信息不足就输出 Unknown，避免它为了「必须回答」而脑补。</p>
<p>另外：把评分标准结构化，并拆维度单独评，不要一次判所有维度，噪声会很大，因为随着上下文更长，大模型的注意力会出现一些问题。</p>
<h2 data-id="heading-16">7. 人工评分</h2>
<p>领域专家门禁：效果不好就不能上，灰度可选</p>
<p>人工评分并不是用来「天天打分」的，人工的职责更多是：</p>
<ul>
<li>定义标准（什么叫好）</li>
<li>校准 LLM grader（对齐、抽检、纠偏）</li>
<li>做门禁（关键版本上线前必须过）</li>
</ul>
<h2 data-id="heading-17">7.1 门禁怎么做</h2>
<ul>
<li>定一个小的「关键任务集」（比如 30 条最关键、最敏感、最影响收入/合规的），或者称为黄金链路</li>
<li>每次大改/换模型/换工具链，必须过这个集</li>
<li>过不了：不讨论「用户可能不在意」，直接回滚或修</li>
</ul>
<h2 data-id="heading-18">7.2 灰度</h2>
<p>没有足够流量，灰度很难有显著的效果，也没有啥意义：</p>
<ul>
<li>用离线评测 + 小范围内测</li>
<li>线上用强监控兜底（错误、成本、关键转化、人工接管率等）</li>
</ul>
<p>等流量与组织能力到位，再做严格 A/B。</p>
<h2 data-id="heading-19">8. 流程</h2>
<p>从 0 到 1，再到可持续</p>
<p>这套流程的目标很简单：让每次改动都有依据，上线前知道会不会退步，退步了能快速定位原因。</p>
<h2 data-id="heading-20">第 0 步：尽早开工，小样本就能跑起来</h2>
<p>别等“数据够多”。先做一个能工作的最小闭环。</p>
<ul>
<li>
<p>先收 20–50 条真实案例（成功和失败都要）</p>
</li>
<li>
<p>来源：线上工单、客服反馈、bug 记录、内部手工测试步骤</p>
</li>
<li>
<p>每条案例都写清楚：什么算成功，什么算失败</p>
</li>
<li>
<p>先把基础能力跑通： 能批量跑 → 每次互不干扰 → 全程有记录 → 能出汇总表</p>
</li>
</ul>
<p>这一阶段不追求完美，只追求“评测能运转”。</p>
<h2 data-id="heading-21">第 1 步：把“手工回归”变成固定任务清单</h2>
<p>你们发布前人工必做的检查，本质上就是任务列表，只是没系统化。</p>
<ul>
<li>发布前“必须点”的那些流程，全部写成任务，进评测库</li>
<li>线上出现的 bug / 客诉，能复现的尽量都写成任务</li>
<li>按影响排序： 影响钱 / 合规 / 大客户 / 高频场景优先</li>
</ul>
<p>做久了会发现：评测库就是你们产品真实使用方式的地图。</p>
<h2 data-id="heading-22">第 2 步：任务要写得清楚，评分要能落地</h2>
<p>一条任务写不清楚，后面全是噪音。</p>
<p>至少要满足三条：</p>
<ol>
<li>两位领域同学看完任务描述，能给出一致的“过/不过”</li>
<li>给每条任务准备一个“标准答案/参考做法”（证明这题能做对）</li>
<li>评分标准不能靠“默认常识”</li>
</ol>
<ul>
<li>评测要检查什么，任务里就要写清楚</li>
<li>别出现“任务没说路径，但测试默认某个路径”这种坑</li>
</ul>
<p>任务写得越清楚，后面迭代越省时间。</p>
<h2 data-id="heading-23">第 3 步：任务要成对出现</h2>
<p>很多系统越改越怪，可能是评测只给了单边信号。</p>
<p>每类行为都尽量做成一对：</p>
<ul>
<li>该查资料 / 不该查资料</li>
<li>该下单 / 不该下单</li>
<li>该继续处理 / 该转人工</li>
<li>该修改文件 / 不该动文件</li>
<li>该生成 / 该拒绝（合规类尤其重要）</li>
</ul>
<h2 data-id="heading-24">第 4 步：把评测环境做稳定，确保结果可信</h2>
<p>评测不可信，比没有评测更糟糕。</p>
<p>关键点：</p>
<ul>
<li>每次运行从干净环境开始（文件、数据库、缓存都重置）</li>
<li>尽量减少共享状态（否则会互相污染）</li>
<li>资源要有上限（CPU/内存/网络），避免“机器不够导致一片失败”</li>
<li>失败要能区分：</li>
<li>是系统真不行</li>
<li>还是环境抖动、配额限制、工具不稳定</li>
</ul>
<p>要保证：同一版本跑两次，结果大体一致。</p>
<h2 data-id="heading-25">第 5 步：评分规则按「能自动就自动」来设计</h2>
<p>评分不要一上来就全靠大模型判。</p>
<p>推荐顺序：</p>
<ol>
<li>能用确定规则判断的，先用确定规则</li>
</ol>
<ul>
<li>结果是否写进数据库、订单是否存在、文件是否生成、测试是否通过</li>
</ul>
<ol>
<li>能用简单规则校验的，用规则</li>
</ol>
<ul>
<li>字段完整、格式正确、调用工具参数在范围内</li>
</ul>
<ol>
<li>只有在确实需要“主观判断”时，才用大模型评分</li>
</ol>
<ul>
<li>语气、解释是否清楚、内容是否覆盖关键点</li>
</ul>
<p>还有一条很重要： 尽量评「最终交付」，少评「必须怎么做」。 路径卡太死，会误伤很多正确解。</p>
<h2 data-id="heading-26">第 6 步：固定做「看过程记录」，不然不知道问题在哪</h2>
<p>很多团队评测做不下去，就是因为只看分数，不看过程。</p>
<p>至少要做到三件事：</p>
<ul>
<li>分数下降时：优先看失败最多、影响最大的那几条任务的过程记录</li>
<li>每周抽查一批「通过」的过程记录（防止钻规则漏洞）</li>
<li>发现「明明做对了却被判错」，立刻修任务描述或评分规则</li>
</ul>
<p>一句话：评测系统也要像产品一样调试。</p>
<h2 data-id="heading-27">第 7 步：分数到顶了就补题，不然评测会失效</h2>
<p>分数 100% 不代表系统没问题，只代表这套题已经测不出差异。</p>
<p>做两件事：</p>
<ul>
<li>持续把新的线上失败变成新任务</li>
<li>专门补「更难、更真实」的场景（长流程、多约束、容易出错的边界条件）</li>
</ul>
<p>评测库要一直增长，否则它会变成摆设。</p>
<h2 data-id="heading-28">第 8 步：让评测「有人管、有人用、有人能加题」</h2>
<p>长期最有效的分工通常是：</p>
<ul>
<li>有一个小组负责评测系统本身（跑得稳、记录全、报表清楚）</li>
<li>各业务团队负责写任务（最懂用户的人写，写出来才贴近真实）</li>
<li>写任务像写代码一样走评审流程（谁提的、为什么提、怎么验证）</li>
</ul>
<p>让离用户最近的人能把问题变成任务，是评测能持续的关键。</p>
<h2 data-id="heading-29">9. 非确定性</h2>
<p>别再只盯「通过率」，用 pass@k 和 pass^k 讲清楚“稳定性”</p>
<p>Agent 的输出有随机性，同一任务可能今天过、明天不过。以下两个指标可以有：</p>
<ul>
<li>
<p>pass@k：k 次尝试里至少成功一次的概率</p>
</li>
<li>
<p>适合“允许多试一次”的场景（比如离线生成候选方案）</p>
</li>
<li>
<p>pass^k：k 次尝试全部成功的概率</p>
</li>
<li>
<p>适合“线上必须稳定”的场景（客服、交易、流程自动化）</p>
</li>
</ul>
<p>它们会随着 k 分化：</p>
<ul>
<li>k 越大，pass@k 越接近 100%</li>
<li>k 越大，pass^k 越接近 0（对稳定性要求更苛刻）</li>
</ul>
<p>这能解决很多争论：</p>
<ul>
<li>研发说「抽卡，多跑几次能过」</li>
<li>业务说「用户只给一次机会」 用 pass@k 和 pass^k 直接对齐产品要求。</li>
</ul>
<h2 data-id="heading-30">10. 安例：生图 AI Agent 如何评估</h2>
<p>生图 Agent 的评测，比「文生图模型评测」更难，因为 Agent 往往还会：</p>
<ul>
<li>和用户多轮确认需求</li>
<li>调风格/比例/seed/参考图</li>
<li>调用安全审核、版权过滤、提示词改写</li>
<li>产出多张候选并做挑选/排序</li>
<li>写交付说明（可商用/不可商用、使用建议）</li>
</ul>
<p>评测要覆盖的不是「画得好不好」一句话，而是「是否按业务标准交付」。</p>
<p>下面给一套实用的评测维度：</p>
<h2 data-id="heading-31">10.1 标准</h2>
<p>先定“交付合格”是什么</p>
<p>建议产品/设计/合规一起定 3–5 条硬标准，例如：</p>
<ul>
<li>不违规：敏感内容、未成年、色情、仇恨、暴力、政治等必须拦截或降级</li>
<li>不侵权：明显模仿特定 IP / 特定艺人脸 / 商标露出等按策略处理</li>
<li>满足需求：主体、场景、风格、比例、文字有无（比如“不要文字”）</li>
<li>质量底线：严重畸形、手指崩坏、文本乱码（如果要求有字则反过来）</li>
<li>可用性：分辨率、格式、背景透明/不透明、交付数量</li>
</ul>
<p>标准不要写成「更美观」「更高级」，要写成可判定的条目。</p>
<h2 data-id="heading-32">10.2 数据集</h2>
<p>最有效的来源通常是：</p>
<ul>
<li>用户最常下单的品类（电商主图、海报、头像、插画、UI 素材）</li>
<li>客诉：不像、漏元素、风格跑偏、文字错、侵权被投诉、审核误杀</li>
<li>运营活动：固定模板需求（这类最适合做回归）</li>
</ul>
<p>每条任务里建议固定：</p>
<ul>
<li>用户输入（含约束：尺寸、风格、禁忌、用途）</li>
<li>允许的工具（生成、放大、背景去除、OCR 检查、合规审查）</li>
<li>成功条件（至少满足哪些项）</li>
<li>参考交付（如果你们已有人工优秀样例，可以作为对照，但不强制唯一答案）</li>
</ul>
<h2 data-id="heading-33">10.3 评测流程</h2>
<p>评测建议按「确定性 → 半确定性 → 开放判断」的顺序叠起来，减少噪音、降低成本。</p>
<h3 data-id="heading-34">A. 结果校验（尽量全自动、最优先）</h3>
<p>这层解决「交付物是否合格」的硬指标：</p>
<ul>
<li>格式、尺寸、分辨率、通道（如 PNG 透明背景）</li>
<li>交付数量（例如必须 4 张）</li>
<li>文件可打开、无损坏</li>
<li>禁止内容检测（审核模型/规则引擎给出通过/拦截/分级）</li>
</ul>
<h3 data-id="heading-35">B. 内容对齐（半自动，能做多少做多少）</h3>
<p>这层解决“有没有按需求做”的关键事实核对：</p>
<ul>
<li>关键元素是否出现：用图像理解/检测器做覆盖检查（比如“猫 + 红围巾 + 雪地”）</li>
<li>不该出现的是否出现：</li>
<li>“不要文字”→ 用 OCR 检测是否有字</li>
<li>“不要 logo/商标”→ logo/商标检测（覆盖不了的留到抽检）</li>
</ul>
<h3 data-id="heading-36">C. 开放项判断（用于难以规则化的部分）</h3>
<p>这层才用多模态判断去评估更开放的维度，例如：</p>
<ul>
<li>主体/场景/风格是否整体匹配需求</li>
<li>是否存在明显瑕疵（手部畸形、脸崩、透视严重错误等）</li>
<li>交付说明是否写清：能否商用、限制条件、使用建议</li>
</ul>
<p>注意：开放项的判定要校准，不要一开始就“全自动放行”。</p>
<h3 data-id="heading-37">D. 过程约束（管体验、管成本）</h3>
<p>对 Agent 的“过程”也要设上限，不然容易出现“靠烧钱刷分”：</p>
<ul>
<li>最大对话轮次（例如 ≤ 6 轮）</li>
<li>工具调用次数上限（避免无限重试）</li>
<li>总耗时 / 总成本阈值</li>
</ul>
<h2 data-id="heading-38">10.4 成本控制</h2>
<p>生图评测很贵，建议分三层跑，不同层用不同频率：</p>
<ol>
<li>回归层（少量高价值，天天/每次发布必跑） 高频品类 + 高风险合规项 + 线上常见故障</li>
<li>能力层（持续加难题，定期跑） 风格混合、复杂构图、多约束冲突、长对话澄清等</li>
<li>抽检层（人工校准，每周固定抽样） 抽查“通过样本”和“失败样本”，用来校准开放项判断与审核策略</li>
</ol>
<h2 data-id="heading-39">10.5 典型坑</h2>
<p>提前避开</p>
<ul>
<li>只看审美分，不看合规/侵权/交付规格 → 上线风险最大</li>
<li>只测“能生成”，不测“该拒绝/该降级” → 合规体系形同虚设</li>
<li>不看过程记录 → 不知道是 Agent 真错了，还是评分/审核错了；也抓不到“用昂贵链路刷通过”</li>
<li>评分规则写死 → 把某一种构图当唯一正确，误杀大量合理解（导致迭代方向跑偏）</li>
</ul>
<h2 data-id="heading-40">11. 最后</h2>
<p>评测的目标是：知道变好还是变差、知道差在哪、知道怎么改。</p>
<p>真正成熟的状态通常是这样：</p>
<ul>
<li>每次改动都有反馈：离线分数怎么变、失败清单有哪些，一眼可见</li>
<li>分数下降能追到根因：能定位到具体哪条任务、哪段过程记录出了问题</li>
<li>关键回归集就是门禁：过不了就不发布（不讨论「感觉应该没事」）</li>
<li>换模型/换策略能算账：能快速判断「收益是否值得成本与风险” 」</li>
<li>线上与离线形成闭环：</li>
<li>线上出现的新失败，能快速回流成任务进评测库</li>
<li>离线提前发现的风险，能在上线前就挡住</li>
</ul>
<p>最后一句：一定要看过程记录。</p>
<p>以上。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[「web extensions🛠️」有关浏览器扩展，开发前你需要知道一些......]]></title>    <link>https://juejin.cn/post/7603771025855971379</link>    <guid>https://juejin.cn/post/7603771025855971379</guid>    <pubDate>2026-02-08T03:45:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603771025855971379" data-draft-id="7603674653152968713" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="「web extensions🛠️」有关浏览器扩展，开发前你需要知道一些......"/> <meta itemprop="keywords" content="前端,JavaScript,开源"/> <meta itemprop="datePublished" content="2026-02-08T03:45:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JustHappy"/> <meta itemprop="url" content="https://juejin.cn/user/1489178757445003"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            「web extensions🛠️」有关浏览器扩展，开发前你需要知道一些......
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1489178757445003/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JustHappy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T03:45:53.000Z" title="Sun Feb 08 2026 03:45:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>Hi，这里是JustHappy，上手直接开始开发插件？我想你会没有头绪，如果你从未开发过浏览器插件，我想这篇一定对你有帮助，哈哈至少在 vibe coding 的时候可以更好的指挥 AI 去帮助你，放心，我“碎片式写作”篇幅不长，希望给你带来愉快的阅读体验</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa66e70098c14f22bf486981a9a7ef5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVzdEhhcHB5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771127152&amp;x-signature=9GQPJjWSmpsmO5%2B8%2BKPy7%2B1n8hk%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">浏览器扩展是什么？</h2>
<p>浏览器扩展是由 Web 技术构建的小程序（HTML、CSS 和 JavaScript），扩展程序可通过自定义界面、监控浏览器事件和修改网页来提升浏览体验。</p>
<p>自 web 技术诞生初始不久，浏览器插件、扩展技术并应运而生，而后 FireFox、Chrome 等浏览器大厂也纷纷下场，并在 2015 年确定了统一的 WebExtensions 标准</p>
<p>在我眼中，浏览器扩展是 web 世界的“外挂”，你几乎可以通过它去操纵一切网页；同时它也是良好的应用内容载体，其独特的交互模式在一些场景实有奇效</p>
<h2 data-id="heading-1">统一的标准：WebExtensions（2015+）</h2>
<p>Mozilla、Google、Microsoft 达成共识，共同确立了 WebExtensions API ，我们之后的开发之路也围绕这个标准，这里先做个“路由”，这样以后找文档不至于迷路哈哈</p>
<p><strong>WebExtensions 标准适用的浏览器：</strong></p>
<ul>
<li><strong>Mozilla</strong> <strong>Firefox</strong></li>
<li><strong>Google</strong> <strong>Chrome</strong></li>
<li><strong>Microsoft</strong> <strong>Edge</strong></li>
<li><strong>Apple Safari（部分）</strong></li>
</ul>
<p>比较详尽的内容参照 MDN / chrome 文档 ： <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FMozilla%2FAdd-ons%2FWebExtensions" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Mozilla/Add-ons/WebExtensions" ref="nofollow noopener noreferrer">MDN web Extensions</a> / <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.chrome.com%2Fdocs%2Fextensions%3Fhl%3Dzh-cn" target="_blank" title="https://developer.chrome.com/docs/extensions?hl=zh-cn" ref="nofollow noopener noreferrer">Chrome web Extension</a></p>
<h2 data-id="heading-2">它是一个完整的应用</h2>
<p>虽然我们通过 Web 技术来开发浏览器扩展，但它的形态绝对不是一个单纯的网页中的网页，而更像是一个完整的应用，有自己独立的一套运作体系，这个“应用”大致的构成成分如下</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2701aceb55464c0f985204e00e309b6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVzdEhhcHB5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771127152&amp;x-signature=z1nnY3CucaOBrhZUlTZvHrswfWo%3D" alt="" width="70%" loading="lazy"/></p>
<h2 data-id="heading-3">插件是如何操作页面的？</h2>
<p>我们往往通过一下两种方式操作页面（其余不推荐），受限于篇幅，这里只简单介绍</p>
<h3 data-id="heading-4">1. Content Script：扩展派驻在页面里的“手和眼”</h3>
<p><strong>Content Script 就是注入到匹配页面里的脚本</strong>，它能：</p>
<ul>
<li>读/改 DOM：<code>document.querySelector(...)</code>、<code>element.textContent = ...</code></li>
<li>监听事件：点击、输入、滚动</li>
<li>插入 UI：按钮、浮层、标记、高亮</li>
<li>观察变化：<code>MutationObserver</code></li>
</ul>
<p>关键点：<strong>它和网页 JS 共享同一个 DOM，但不共享同一个 JS 作用域</strong>（隔离世界）。</p>
<h3 data-id="heading-5">2. <code>chrome.scripting</code>：把脚本“打到页面里”</h3>
<p><code>chrome.scripting</code><strong>可以把代码“注入到页面”执行</strong>，但它<strong>并不等同于</strong>传统意义上“把脚本塞进网页里”</p>
<p><code>chrome.scripting</code> 是由扩展后台控制的“按需代码注入机制”，注入点默认是 Content Script 的隔离世界，而不是网页的 JS 主世界。</p>
<p><strong>典型流程是：</strong></p>
<ul>
<li>UI（popup/sidepanel）→ 发消息给 Background</li>
<li>Background 找到当前 tabId</li>
<li>Background 用 <code>scripting</code> 把脚本/样式注入到该 tab</li>
</ul>
<blockquote>
<p>ok，就到这，且听后续我们展开细说</p>
<p>如果你有兴趣，可以直接尝试我的插件开发模板，持续迭代中.....</p>
<p>使用文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsimonmie.github.io%2Fvue-chrome-extension-template%2F" target="_blank" title="https://simonmie.github.io/vue-chrome-extension-template/" ref="nofollow noopener noreferrer">simonmie.github.io/vue-chrome-…</a></p>
<p>github : <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSimonmie%2Fvue-chrome-extension-template" target="_blank" title="https://github.com/Simonmie/vue-chrome-extension-template" ref="nofollow noopener noreferrer">github.com/Simonmie/vu…</a></p>
<p>也欢迎各位大佬参与</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ollama 部署 Qwen 详细指南（2026 最新版）]]></title>    <link>https://juejin.cn/post/7603677143214473231</link>    <guid>https://juejin.cn/post/7603677143214473231</guid>    <pubDate>2026-02-08T03:48:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603677143214473231" data-draft-id="7603673564908666915" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ollama 部署 Qwen 详细指南（2026 最新版）"/> <meta itemprop="keywords" content="Ollama"/> <meta itemprop="datePublished" content="2026-02-08T03:48:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈里谢顿"/> <meta itemprop="url" content="https://juejin.cn/user/3678304397695056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ollama 部署 Qwen 详细指南（2026 最新版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3678304397695056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈里谢顿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T03:48:22.000Z" title="Sun Feb 08 2026 03:48:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>适用系统</strong>：Windows 10/11、macOS 12+、Linux（Ubuntu/CentOS）<br/>
<strong>目标模型</strong>：Qwen3 系列（含 1.8B / 7B / 32B 等版本）<br/>
<strong>前置要求</strong>：8GB+ 内存（推荐 16GB+），无需 GPU 也可运行小模型<br/>
<strong>更新日期</strong>：2026 年 2 月</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、为什么选择 Ollama + Qwen？</h2>





























<table><thead><tr><th>优势</th><th>说明</th></tr></thead><tbody><tr><td>✅ <strong>一键部署</strong></td><td>无需配置 Python 环境、CUDA、依赖库</td></tr><tr><td>✅ <strong>自动量化</strong></td><td>自动下载 GGUF 4-bit 量化模型，节省显存</td></tr><tr><td>✅ <strong>跨平台支持</strong></td><td>Windows/macOS/Linux 全支持</td></tr><tr><td>✅ <strong>OpenAI 兼容 API</strong></td><td>可直接替换 GPT 调用</td></tr><tr><td>✅ <strong>中文优化</strong></td><td>Qwen 对中文理解远超 Llama 系列</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>2026 年现状</strong>：Ollama 已原生支持 Qwen3 全系列模型，并启用 <strong>思考模式</strong>（<code>/think</code>）。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、安装 Ollama</h2>
<h3 data-id="heading-2">▶️ Windows</h3>
<ol>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com%2Fdownload%2FOllamaSetup.exe" target="_blank" title="https://ollama.com/download/OllamaSetup.exe" ref="nofollow noopener noreferrer">ollama.com/download/Ol…</a></li>
<li>双击安装（默认安装到 <code>C:\Users&lt;user&gt;\AppData\Local\Programs\Ollama</code>）</li>
<li>安装完成后<strong>自动启动服务</strong>（系统托盘出现 🐫 图标）</li>
</ol>
<h3 data-id="heading-3">▶️ macOS</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">方法 1：官网下载 dmg</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://ollama.com/download/Ollama-darwin.zip</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">方法 2：使用 Homebrew（推荐）</span>
brew install ollama
brew services start ollama
</code></pre>
<h3 data-id="heading-4">▶️ Linux（Ubuntu/Debian）</h3>
<pre><code class="hljs language-bash" lang="bash">curl -fsSL https://ollama.com/install.sh | sh
sudo systemctl <span class="hljs-built_in">enable</span> ollama
sudo systemctl start ollama
</code></pre>
<blockquote>
<p>🔍 <strong>验证安装</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">ollama --version
<span class="hljs-comment"># 输出示例：ollama version is 0.4.5</span>
</code></pre>
</blockquote>
<hr/>
<h2 data-id="heading-5">三、下载 Qwen 模型（关键步骤）</h2>
<p>Ollama 支持多种 Qwen 版本，命名规则为：<code>qwen3:&lt;size&gt;-&lt;quant&gt;</code>。</p>
<h3 data-id="heading-6">📦 可用模型列表（2026 年 2 月）</h3>








































<table><thead><tr><th>模型名称</th><th>参数量</th><th>量化方式</th><th>内存需求</th><th>下载命令</th></tr></thead><tbody><tr><td><code>qwen3:1.8b</code></td><td>1.8B</td><td>Q4_K_M</td><td>~2 GB</td><td><code>ollama pull qwen3:1.8b</code></td></tr><tr><td><code>qwen3:7b</code></td><td>7B</td><td>Q4_K_M</td><td>~6 GB</td><td><code>ollama pull qwen3:7b</code></td></tr><tr><td><code>qwen3:32b</code></td><td>32B</td><td>Q4_K_M</td><td>~20 GB</td><td><code>ollama pull qwen3:32b</code></td></tr><tr><td><code>qwen3:1.8b-q8_0</code></td><td>1.8B</td><td>Q8（高精度）</td><td>~3 GB</td><td><code>ollama pull qwen3:1.8b-q8_0</code></td></tr></tbody></table>
<blockquote>
<p>⚠️ <strong>注意</strong>：</p>
<ul>
<li>默认不加后缀 = Q4_K_M 量化（最佳性价比）</li>
<li>首次下载需 5~30 分钟（取决于网速和模型大小）</li>
</ul>
</blockquote>
<h3 data-id="heading-7">▶️ 下载示例（以 7B 为例）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看可用标签</span>
ollama list

<span class="hljs-comment"># 下载 Qwen3-7B（自动量化）</span>
ollama pull qwen3:7b

<span class="hljs-comment"># 输出示例：</span>
<span class="hljs-comment"># pulling manifest</span>
<span class="hljs-comment"># pulling 8d9a4e3c... 100% ▕████████████████████████████████████████▏ 4.2 GB</span>
<span class="hljs-comment"># verifying sha256 digest</span>
<span class="hljs-comment"># writing manifest</span>
<span class="hljs-comment"># success</span>
</code></pre>
<blockquote>
<p>💡 <strong>提示</strong>：模型文件默认保存在：</p>
<ul>
<li>Windows: <code>C:\Users&lt;user&gt;.ollama\models</code></li>
<li>macOS: <code>~/.ollama/models</code></li>
<li>Linux: <code>~/.ollama/models</code></li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-8">四、命令行使用 Qwen</h2>
<h3 data-id="heading-9">▶️ 基础对话</h3>
<pre><code class="hljs language-arduino" lang="arduino">ollama run qwen3:<span class="hljs-number">7b</span>
&gt;&gt;&gt; 你好！介绍一下你自己。
</code></pre>
<h3 data-id="heading-10">▶️ 特殊指令（Qwen3 独有）</h3>

























<table><thead><tr><th>指令</th><th>功能</th></tr></thead><tbody><tr><td><code>/think</code></td><td>开启深度思考模式（慢但准确）</td></tr><tr><td><code>/nothink</code></td><td>关闭思考，快速响应</td></tr><tr><td><code>/clear</code></td><td>清空上下文</td></tr><tr><td><code>/set parameter num_ctx 4096</code></td><td>设置上下文长度</td></tr></tbody></table>
<blockquote>
<p>🌰 示例：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">&gt;</span><span class="bash">&gt;&gt; /think</span>
Thinking mode enabled.
<span class="hljs-meta prompt_">&gt;</span><span class="bash">&gt;&gt; 解释量子纠缠的原理，并举例说明。</span>
（模型将分步推理，输出更严谨）
</code></pre>
</blockquote>
<h3 data-id="heading-11">▶️ 多轮对话</h3>
<p>Ollama 自动维护会话上下文，直到输入 <code>/clear</code> 或退出。</p>
<hr/>
<h2 data-id="heading-12">五、API 调用（OpenAI 兼容）</h2>
<p>Ollama 启动后自动监听 <code>http://localhost:11434</code>，提供 OpenAI 兼容 API。</p>
<h3 data-id="heading-13">▶️ 请求示例（Python）</h3>
<pre><code class="hljs language-vbscript" lang="vbscript">import requests

<span class="hljs-built_in">response</span> = requests.post(
    <span class="hljs-string">"http://localhost:11434/api/chat"</span>,
    json={
        <span class="hljs-string">"model"</span>: <span class="hljs-string">"qwen3:7b"</span>,
        <span class="hljs-string">"messages"</span>: [
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"写一个 Python 快速排序函数"</span>}
        ],
        <span class="hljs-string">"stream"</span>: <span class="hljs-literal">False</span>
    }
)

pr<span class="hljs-built_in">int</span>(<span class="hljs-built_in">response</span>.json()[<span class="hljs-string">"message"</span>][<span class="hljs-string">"content"</span>])
</code></pre>
<h3 data-id="heading-14">▶️ OpenAI SDK 兼容（推荐）</h3>
<pre><code class="hljs language-ini" lang="ini">from openai import OpenAI

<span class="hljs-attr">client</span> = OpenAI(
    <span class="hljs-attr">base_url</span>=<span class="hljs-string">"http://localhost:11434/v1"</span>,
    <span class="hljs-attr">api_key</span>=<span class="hljs-string">"ollama"</span>  <span class="hljs-comment"># 任意值均可</span>
)

<span class="hljs-attr">completion</span> = client.chat.completions.create(
    <span class="hljs-attr">model</span>=<span class="hljs-string">"qwen3:7b"</span>,
    <span class="hljs-attr">messages</span>=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Hello!"</span>}],
    <span class="hljs-attr">temperature</span>=<span class="hljs-number">0.7</span>
)

print(completion.choices<span class="hljs-section">[0]</span>.message.content)
</code></pre>
<blockquote>
<p>✅ <strong>优势</strong>：现有 GPT 代码只需改两行即可切换到 Qwen！</p>
</blockquote>
<hr/>
<h2 data-id="heading-15">六、可视化界面推荐</h2>
<h3 data-id="heading-16">方案 1：ChatWise（免费，跨平台）</h3>
<ol>
<li>下载：<a href="https://link.juejin.cn?target=https%3A%2F%2Fchatwise.app%2F" target="_blank" title="https://chatwise.app/" ref="nofollow noopener noreferrer">chatwise.app</a></li>
<li>安装后打开 → 选择 <strong>Ollama</strong> 作为后端</li>
<li>在模型列表中选择已下载的 <code>qwen3:7b</code></li>
<li>享受 Markdown 渲染、代码高亮、对话管理</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2406fad286b44740be8294353cc4e9ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOI6YeM6LCi6aG_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771127303&amp;x-signature=dDS8PxF4Jg7W7QZXFHb8iD000DE%3D" alt="ChatWise 界面" loading="lazy"/></p>
<h3 data-id="heading-17">方案 2：LM Studio（macOS/Windows）</h3>
<ul>
<li>支持本地模型管理</li>
<li>内置性能监控</li>
<li>下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Flmstudio.ai%2F" target="_blank" title="https://lmstudio.ai/" ref="nofollow noopener noreferrer">lmstudio.ai</a></li>
</ul>
<hr/>
<h2 data-id="heading-18">七、远程访问：让团队共享你的 Qwen</h2>
<h3 data-id="heading-19">使用 Cloudflare Tunnel（免费内网穿透）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 下载 cloudflared</span>
<span class="hljs-comment"># https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation</span>

<span class="hljs-comment"># 2. 启动隧道（Ollama 默认端口 11434）</span>
cloudflared tunnel --url http://localhost:11434
</code></pre>
<blockquote>
<p>输出示例：</p>
<pre><code class="hljs language-arduino" lang="arduino">Your tunnel is ready! Visit: https:<span class="hljs-comment">//abc123.trycloudflare.com</span>
</code></pre>
</blockquote>
<h3 data-id="heading-20">在 ChatWise 中配置远程地址：</h3>
<ol>
<li>设置 → 模型服务 → Ollama</li>
<li>API 地址填写：<code>https://abc123.trycloudflare.com</code></li>
<li>团队成员即可通过公网使用你的 Qwen！</li>
</ol>
<blockquote>
<p>🔒 <strong>安全提示</strong>：生产环境建议添加 API Key 验证（需反向代理）。</p>
</blockquote>
<hr/>
<h2 data-id="heading-21">八、性能调优技巧</h2>
<h3 data-id="heading-22">1. <strong>强制 CPU 模式（无 GPU 时）</strong></h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Windows</span>
set <span class="hljs-attr">OLLAMA_NUM_GPU</span>=<span class="hljs-number">0</span>
ollama run qwen3:1.8b

<span class="hljs-comment"># Linux/macOS</span>
<span class="hljs-attr">OLLAMA_NUM_GPU</span>=<span class="hljs-number">0</span> ollama run qwen3:<span class="hljs-number">1.8</span>b
</code></pre>
<h3 data-id="heading-23">2. <strong>调整上下文长度</strong></h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建自定义 Modelfile</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"FROM qwen3:7b"</span> &gt; Modelfile
<span class="hljs-built_in">echo</span> <span class="hljs-string">"PARAMETER num_ctx 8192"</span> &gt;&gt; Modelfile

<span class="hljs-comment"># 构建新模型</span>
ollama create qwen3-7b-long -f Modelfile

<span class="hljs-comment"># 使用</span>
ollama run qwen3-7b-long
</code></pre>
<h3 data-id="heading-24">3. <strong>查看资源占用</strong></h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 实时监控</span>
ollama ps

<span class="hljs-comment"># 输出示例：</span>
<span class="hljs-comment"># NAME           ID              SIZE    PROCESSOR       UNTIL</span>
<span class="hljs-comment"># qwen3:7b       8d9a4e3c...     4.2 GB  100% CPU        5m</span>
</code></pre>
<hr/>
<h2 data-id="heading-25">九、常见问题解答（FAQ）</h2>
<h3 data-id="heading-26">❓ Q1：下载速度慢怎么办？</h3>
<p>✅ <strong>解决方案</strong>：</p>
<ul>
<li>
<p>使用国内镜像（需手动配置）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 临时设置代理（如你有代理）</span>
<span class="hljs-built_in">export</span> http_proxy=http://your-proxy:port
<span class="hljs-built_in">export</span> https_proxy=http://your-proxy:port
ollama pull qwen3:7b
</code></pre>
</li>
<li>
<p>或从 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelscope.cn%2Fmodels%2Fqwen%2FQwen3-7B" target="_blank" title="https://modelscope.cn/models/qwen/Qwen3-7B" ref="nofollow noopener noreferrer">ModelScope</a> 手动下载 GGUF 文件，再导入 Ollama（高级操作）</p>
</li>
</ul>
<h3 data-id="heading-27">❓ Q2：如何删除模型释放空间？</h3>
<pre><code class="hljs language-bash" lang="bash">ollama <span class="hljs-built_in">rm</span> qwen3:7b
</code></pre>
<h3 data-id="heading-28">❓ Q3：支持函数调用（Function Calling）吗？</h3>
<p>✅ <strong>部分支持</strong>：</p>
<ul>
<li>Qwen3 原生支持 <strong>MCP 协议</strong>（非 OpenAI Function Calling）</li>
<li>需配合 MCP Server 使用（见 Qwen 官方文档）</li>
</ul>
<h3 data-id="heading-29">❓ Q4：能否微调模型？</h3>
<p>❌ <strong>Ollama 不支持微调</strong>！<br/>
✅ <strong>替代方案</strong>：</p>
<ul>
<li>使用 <strong>Qwen-Agent</strong> 框架进行 LoRA 微调</li>
<li>微调后导出 GGUF 格式，再通过 Ollama 加载</li>
</ul>
<hr/>
<h2 data-id="heading-30">十、学习资源</h2>
<ul>
<li><strong>Ollama 官方文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com%2Fdocs" target="_blank" title="https://ollama.com/docs" ref="nofollow noopener noreferrer">ollama.com/docs</a></li>
<li><strong>Qwen GitHub</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FQwenLM%2FQwen" target="_blank" title="https://github.com/QwenLM/Qwen" ref="nofollow noopener noreferrer">github.com/QwenLM/Qwen</a></li>
<li><strong>模型下载页</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com%2Flibrary%2Fqwen3" target="_blank" title="https://ollama.com/library/qwen3" ref="nofollow noopener noreferrer">Ollama Library - Qwen</a></li>
<li><strong>社区论坛</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.gg%2Follama" target="_blank" title="https://discord.gg/ollama" ref="nofollow noopener noreferrer">Ollama Discord</a></li>
</ul>
<hr/>
<h2 data-id="heading-31">十一、总结：最佳实践路径</h2>

























<table><thead><tr><th>目标</th><th>推荐配置</th></tr></thead><tbody><tr><td><strong>个人体验</strong></td><td><code>qwen3:1.8b</code> + ChatWise</td></tr><tr><td><strong>开发测试</strong></td><td><code>qwen3:7b</code> + OpenAI SDK</td></tr><tr><td><strong>高性能推理</strong></td><td><code>qwen3:32b</code> + vLLM（非 Ollama）</td></tr><tr><td><strong>团队共享</strong></td><td>Ollama + Cloudflare Tunnel</td></tr></tbody></table>
<blockquote>
<p>💬 <strong>记住</strong>：<br/>
<strong>“Ollama 让大模型本地化变得像安装 App 一样简单。”</strong><br/>
今天，你已拥有属于自己的中文 AI 助手！</p>
</blockquote>
<hr/>
<blockquote>
<p><strong>作者</strong>：AI 工程师<br/>
<strong>版权声明</strong>：本文可自由转载，但请保留出处。<br/>
<strong>GitHub 示例代码</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyourname%2Follama-qwen-guide" target="_blank" title="https://github.com/yourname/ollama-qwen-guide" ref="nofollow noopener noreferrer">github.com/yourname/ol…</a>（虚构）</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[pg内核实现细节]]></title>    <link>https://juejin.cn/post/7603644943350300678</link>    <guid>https://juejin.cn/post/7603644943350300678</guid>    <pubDate>2026-02-07T10:57:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603644943350300678" data-draft-id="7603644943350185990" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="pg内核实现细节"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2026-02-07T10:57:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户98286302568"/> <meta itemprop="url" content="https://juejin.cn/user/1370445415464027"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            pg内核实现细节
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1370445415464027/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户98286302568
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-07T10:57:38.000Z" title="Sat Feb 07 2026 10:57:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">TID(Tuple Id)</h3>
<p>tid表示一行数据在数据页上的逻辑地址，通过block id和offset来定义一个page内具体数据位置。定义如下：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ItemPointerData</span>
{
  BlockIdData blkid; <span class="hljs-comment">// 页号, u32类型</span>
  OffsetNumber posid;<span class="hljs-comment">// 业内slotid, u16类型</span>
}
</code></pre>
<h3 data-id="heading-1">页数据组织形式</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a81d0b1030c426b967b62a9263a142a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3OTgyODYzMDI1Njg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771066658&amp;x-signature=h7NFa62ISRieN3YGyT3F9HbLKK4%3D" alt="image.png" loading="lazy"/>
和oracle一样，pg也是以页为单位来在存储介质和内存中记录行数据，通过tup可定位到对应page的某个TupleId, 然后找到存储实际行数据的tuple.</p>
<h3 data-id="heading-2">行级mvcc实现</h3>
<p>pg修改行数据时，保留旧行，并插入新行。每个事务都有唯一的事务id称为xid。<br/>
每行数据称为一个元组tuple，行头包含四个属性和一些标志位(行头总共有20字节，存储开销大，oracle只有3字节):</p>
<ul>
<li>xmin：创建一个元组时，将事务xid写入该属性；</li>
<li>xmax：默认为0，删除一个元组时，将事务xid写入该属性，update时会将老元组的xmax改成update所在事务xid；</li>
<li>cmin、cmax：记录同一个事务中不同语句顺序，从0开始；</li>
<li>ctid:该行数据对应的tid;</li>
<li>t_ctid:多版本下，通过该属性将同一行多版本串联起来，记录的是下一个多版本行的ctid;</li>
</ul>
<p>每个事务开启时，获取一个32bit的xid值，修改数据时，会创建新的元组记录xid到xmin中，并且写入到表数据中(新旧元组同时存在)。并标记老元组。</p>
<p>伪码示例</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t1(c1 <span class="hljs-type">int</span>, c2 <span class="hljs-type">int</span>);

<span class="hljs-keyword">create</span> index idx1(t1.c2);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t1 <span class="hljs-keyword">values</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>);
<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t1 <span class="hljs-keyword">values</span>(<span class="hljs-number">2</span>,<span class="hljs-number">3</span>);

#主表行信息:
ctid    xmin  xmax  t_ctid  data
(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)   <span class="hljs-number">100</span>    <span class="hljs-number">0</span>    (<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)   [<span class="hljs-number">1</span> <span class="hljs-number">2</span>]
(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>)   <span class="hljs-number">100</span>    <span class="hljs-number">0</span>    (<span class="hljs-number">0</span>,<span class="hljs-number">2</span>)   [<span class="hljs-number">2</span> <span class="hljs-number">3</span>]

#执行<span class="hljs-keyword">delete</span>删除第二行:<span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> t1 <span class="hljs-keyword">where</span> c1<span class="hljs-operator">=</span><span class="hljs-number">2</span>

#查询主表只会返回一行数据，但是存储的真实行数没有变化，只是将xmax更改为<span class="hljs-keyword">delete</span>语句对应的xid:<span class="hljs-number">200</span>，行本身不会真的删除
ctid    xmin  xmax  t_ctid  data
(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)   <span class="hljs-number">100</span>    <span class="hljs-number">0</span>    (<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)   [<span class="hljs-number">1</span> <span class="hljs-number">2</span>]
(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>)   <span class="hljs-number">100</span>    <span class="hljs-number">200</span>  (<span class="hljs-number">0</span>,<span class="hljs-number">2</span>)   [<span class="hljs-number">2</span> <span class="hljs-number">3</span>]

#执行<span class="hljs-keyword">update</span>语句更新第一行:<span class="hljs-keyword">update</span> t1 <span class="hljs-keyword">set</span> c2 <span class="hljs-operator">=</span> <span class="hljs-number">5</span> <span class="hljs-keyword">where</span> c1<span class="hljs-operator">=</span><span class="hljs-number">1</span>
#pg会拷贝第一行数据生成一个新的tuple, 然后更新<span class="hljs-keyword">old</span> tuple的xmax和t_ctid, 来和<span class="hljs-keyword">new</span> tuple链接起来
ctid    xmin  xmax  t_ctid  data
(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)   <span class="hljs-number">100</span>    <span class="hljs-number">300</span>  (<span class="hljs-number">0</span>,<span class="hljs-number">3</span>)   [<span class="hljs-number">1</span> <span class="hljs-number">2</span>]
(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>)   <span class="hljs-number">100</span>    <span class="hljs-number">200</span>  (<span class="hljs-number">0</span>,<span class="hljs-number">2</span>)   [<span class="hljs-number">2</span> <span class="hljs-number">3</span>]
(<span class="hljs-number">0</span>,<span class="hljs-number">3</span>)   <span class="hljs-number">300</span>    <span class="hljs-number">0</span>    (<span class="hljs-number">0</span>,<span class="hljs-number">3</span>)   [<span class="hljs-number">1</span> <span class="hljs-number">5</span>]

#执行查询语句时, 会根据版本号判断返回第一行还是第三行给客户端

#由于c2列上存在索引，上述操作也会影响到索引表，索引表数据也会修改，和主表一样不会被“<span class="hljs-keyword">delete</span>”掉；
#pg的索引表没有多版本概念，而是借用主表的多版本来找到“可见”的最新行；因此索引表的tuple没有xmin<span class="hljs-operator">/</span>xmax等列;
#索引表的tuple通过htid列来关联上主表的tuple；
#更新主表索引列时，索引表也会做相应的修改；
#更新主表非索引列时，索引表不会做修改，通过上面介绍的版本链来找到最新tuple(HOT机制:heap<span class="hljs-operator">-</span><span class="hljs-keyword">only</span> tuple)；

#可以看出pg的多版本会很容易导致磁盘空间膨胀，需要vacuum操作来释放磁盘空间
</code></pre>
<h3 data-id="heading-3">vacuum机制：清理死元组解决表膨胀问题+解决xid回绕问题</h3>
<ul>
<li>事务提交后，新元组可以被其他事务看到，老元组不会被用到了，也不会立即被清理，可能导致表数据空间越来越大；</li>
<li>xid由32bit构成，最多存几亿个事务，数值越界时，会出现问题，vaccum机制会将已提交事务的产生的所有元组中隐藏列记录的xid改成2,1是系统xid，从3开始是正常事务可用值。因此只要是正常事务xid都会大于2，即都可以看到已提交事务的修改。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手搓 VM 复盘：从我的 C++ 并发 GC 到字节 PrimJS 的架构演进]]></title>    <link>https://juejin.cn/post/7603644943350366214</link>    <guid>https://juejin.cn/post/7603644943350366214</guid>    <pubDate>2026-02-07T12:31:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603644943350366214" data-draft-id="7603656494904721414" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手搓 VM 复盘：从我的 C++ 并发 GC 到字节 PrimJS 的架构演进"/> <meta itemprop="keywords" content="操作系统"/> <meta itemprop="datePublished" content="2026-02-07T12:31:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="肆忆_"/> <meta itemprop="url" content="https://juejin.cn/user/3898194938326714"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手搓 VM 复盘：从我的 C++ 并发 GC 到字节 PrimJS 的架构演进
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3898194938326714/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    肆忆_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-07T12:31:58.000Z" title="Sat Feb 07 2026 12:31:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近一直在死磕我的 C++ 虚拟机项目 <code>cilly-vm-cpp</code> 的垃圾回收（GC）模块。为了解决 Stop-The-World (STW) 带来的卡顿问题，我从最开始的单线程 Mark-Sweep，一步步优化到了现在的<strong>并行标记 (Parallel Marking)</strong> + <strong>并发清除 (Concurrent Sweep)</strong>。</p>
<p>本来以为这个架构对于一个学习型项目来说已经挺能打了，直到我为了寻找进一步优化的灵感，去啃了字节跳动开源的 <strong>PrimJS</strong>（Lynx 底层的 JS 引擎）的源码。这一对比，直接让我看到了“学院派实现”和“工业级引擎”之间的鸿沟。</p>
<p>这篇文章既是我的学习笔记，也是一次深度的架构复盘。我将详细拆解我的实现方案，深入解析 PrimJS 的核心架构，通过详细的对比分析，聊聊我准备如何改进我的 VM。</p>
<h2 data-id="heading-0">一、 我的 GC 是怎么实现的？</h2>
<p>我的核心目标很简单：<strong>别让主线程停太久</strong>。为了达成这个目标，我将 GC 拆解为两个阶段，并分别做了并发优化：</p>
<h3 data-id="heading-1">1. 并行标记 (Parallel Marking)</h3>
<p>在“标记阶段”，我们需要遍历整个对象图，找出所有活着的对象。为了利用多核 CPU，我引入了多线程标记：</p>
<ul>
<li><strong>CAS 抢占</strong>：给每个 <code>GcObject</code> 加了一个 <code>std::atomic&lt;bool&gt;</code> 标记位。多个线程同时看到同一个对象时，利用 CAS (Compare-And-Swap) 保证只有一个线程能成功标记并将其入栈，有效防止了重复处理。</li>
<li><strong>全局任务栈</strong>：使用一个 <code>vector&lt;GcObject*&gt; global_stack</code> 作为任务池。所有线程发现新对象（子节点）后，都往这个大栈里扔；没活干了，也都从这里拿。</li>
<li><strong>锁保护</strong>：因为大家都访问同一个栈，我必须加一把 <code>mutex</code> 锁，保证数据安全。</li>
</ul>
<h3 data-id="heading-2">2. 并发清除 (Concurrent Sweep)</h3>
<p>在“清除阶段”，如果有几万个死对象需要释放，主线程逐个 <code>delete</code> 会造成显著卡顿。</p>
<ul>
<li><strong>实现细节</strong>：
<ul>
<li>主线程只做一件事：快速遍历链表，把死对象从链表上“摘”下来（Unlink），放到一个临时列表里。</li>
<li>然后启动一个后台线程 (<code>std::thread(...).detach()</code>)，把这个列表移交给它。</li>
<li>主线程立刻返回继续跑业务代码，后台线程在另一边慢慢 <code>delete</code> 这些垃圾。</li>
</ul>
</li>
</ul>
<p><strong>效果</strong>：通过这两步改造，主线程几乎瞬间恢复响应，STW 时间被压缩到了极致。</p>
<h2 data-id="heading-3">二、 工业级的 PrimJS 是怎么玩的？（源码深度解析）</h2>
<p>PrimJS 是一个基于 QuickJS 深度魔改的高性能 JS 引擎，专为解决移动端的性能瓶颈而生。它的 GC 设计非常硬核，其核心思想是**“极致的性能与掌控”**——它甚至不信任系统的 <code>malloc</code>，而是自己接管了一切。</p>
<h3 data-id="heading-4">1. 核心架构设计</h3>
<ul>
<li><strong>兼容性内存管理 (Compatible MM)</strong>：PrimJS 不仅管理 JS 对象，还接管了底层的内存分配。它实现了一个自定义的内存分配器（基于 <code>dlmalloc</code> 的变种），让 GC 能直接操作<strong>内存块 (Chunk)</strong>，而不是仅仅操作对象指针。</li>
<li><strong>全并行/并发架构</strong>：
<ul>
<li><strong>Parallel Marking</strong>：多线程并行标记。</li>
<li><strong>Parallel Sweeping</strong>：多线程并行清除（比我的更进一步，直接操作内存段）。</li>
<li><strong>Parallel Free List Rebuilding</strong>：多线程重建空闲链表，为下一次分配做准备。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">2. 关键组件与实现细节</h3>
<p>我在 <code>docs/reference</code> 中深入研究了它的源码，梳理出了以下几个关键组件：</p>
<h4 data-id="heading-6">A. 收集器 (Collector) —— 总指挥</h4>
<p>负责协调 GC 的全流程：</p>
<ol>
<li><code>MarkLiveObjects()</code>: 启动多线程标记活对象。</li>
<li><code>SweepDeadObjects()</code>: 启动多线程清除死对象。
同时包含了大量用于调试内存泄漏和性能分析的工具宏 (<code>ENABLE_GC_DEBUG_TOOLS</code>)。</li>
</ol>
<h4 data-id="heading-7">B. 访问者 (Visitor) —— 遍历引擎</h4>
<p>负责遍历对象图，核心优化在于：</p>
<ul>
<li><strong>多线程队列</strong>：<code>Queue *queue[THREAD_NUM]</code>。每个线程有一个<strong>独立的任务队列</strong>。这与我的全局栈形成了鲜明对比，配合<strong>工作窃取 (Work Stealing)</strong> 算法，大幅减少了锁竞争。</li>
<li><strong>类型分发</strong>：通过 <code>ALLOC_TAG</code>（分配标签）来区分对象类型（如 <code>JSObject</code>, <code>JSString</code>），然后通过 switch-case 调用不同的 Visit 函数。</li>
</ul>
<h4 data-id="heading-8">C. 清扫器 (Sweeper) —— 最精彩的部分</h4>
<p>这是 PrimJS 与普通 GC 最大的区别所在：</p>
<ul>
<li><strong>直接操作内存页 (Segments)</strong>：它不像普通 GC 那样遍历“对象链表”，而是直接遍历底层的<strong>内存段</strong>。通过地址计算直接找到 Chunk Header，判断 <code>cinuse</code> (是否在使用) 和 <code>is_marked</code> (是否标记)。</li>
<li><strong>并行清除 (Parallel Sweep)</strong>：<code>parallel_traverse_heap_segment</code> 函数将堆内存切分成多个段，分发给线程池 (<code>ByteThreadPool</code>) 并行处理。我的 Sweep 是主线程摘链表+后台单线程释放，而 PrimJS 是<strong>多线程推土机式地平推内存页</strong>。</li>
<li><strong>重建 FreeList</strong>：GC 后，它会并行地将回收的内存块重新挂载到 <code>freelist</code> 上，供下一次 <code>malloc</code> 使用。</li>
</ul>
<h2 data-id="heading-9">三、 差距分析 (Gap Analysis)</h2>
<p>通过详细对比，我整理了如下表格，清晰地展示了 cilly-vm-cpp 与 PrimJS 的技术差距：</p>















































<table><thead><tr><th align="left">特性</th><th align="left">你的 cilly-vm-cpp</th><th align="left">PrimJS</th><th align="left">评价</th></tr></thead><tbody><tr><td align="left"><strong>内存管理</strong></td><td align="left">依赖 C++ <code>new/delete</code></td><td align="left">自研分配器 (<code>dlmalloc</code> 魔改)</td><td align="left">PrimJS 更底层，能控制内存布局，减少碎片，但实现难度极高，且跨平台维护成本巨大。</td></tr><tr><td align="left"><strong>标记算法</strong></td><td align="left">全局栈 + 互斥锁</td><td align="left">本地队列 + 工作窃取</td><td align="left">PrimJS 的扩展性更好。全局锁在核心数增多时会成为瓶颈，而本地队列能实现线性扩展。</td></tr><tr><td align="left"><strong>清除算法</strong></td><td align="left">主线程摘除 + 后台单线程 delete</td><td align="left">多线程并行遍历内存段</td><td align="left">PrimJS 吞吐量更大，适合 GB 级超大堆；我的方案适合中小型堆，实现简单且有效。</td></tr><tr><td align="left"><strong>对象识别</strong></td><td align="left">C++ 虚函数 (<code>Trace</code>)</td><td align="left"><code>AllocTag</code> + <code>switch-case</code></td><td align="left">虚函数有间接调用开销；Tag 分发极快，但代码耦合度极高，每加一个类型都要改核心代码。</td></tr><tr><td align="left"><strong>线程模型</strong></td><td align="left">临时创建/销毁 (Fork-Join)</td><td align="left">常驻线程池 (Thread Pool)</td><td align="left">临时创建线程有昂贵的系统调用开销和冷启动问题；线程池响应极快。</td></tr><tr><td align="left"><strong>Finalizer</strong></td><td align="left">C++ 析构函数</td><td align="left">显式 <code>Finalizer</code> 类</td><td align="left">C++ 析构函数符合 RAII 惯例；PrimJS 需要手动管理资源生命周期，更复杂但更灵活。</td></tr></tbody></table>
<h2 data-id="heading-10">四、 下一步改进计划 (Action Plan)</h2>
<p>看完 PrimJS 的源码，我决定对我的 VM 进行“取其精华，去其糟粕”的升级。我不会盲目照搬，而是选择最适合我这个学习型项目的优化路线。</p>
<h3 data-id="heading-11">1. 必须做 (Must Do)：引入线程池 (Thread Pool)</h3>
<p>我目前的做法是每次 GC 都 <code>new thread</code>，结束后 <code>join</code>。这简直是把线程当“日结临时工”用。
<strong>改进</strong>：实现一个简单的线程池。VM 启动时创建好 Worker 线程，平时挂起（Wait），GC 时唤醒（Notify）。这将消除线程创建销毁的系统开销，显著提升响应速度。</p>
<h3 data-id="heading-12">2. 必须做 (Must Do)：实现本地队列与工作窃取</h3>
<p>全局锁是我目前最大的性能瓶颈。
<strong>改进</strong>：拆掉 <code>global_work_stack_</code>，换成 <code>vector&lt;GcObject*&gt; local_queues[THREAD_NUM]</code>。</p>
<ul>
<li><strong>Push/Pop 无锁化</strong>：线程优先操作自己的队列，完全不需要加锁。</li>
<li><strong>Work Stealing</strong>：只有当自己队列空了，才去尝试窃取其他线程的任务。
这是提升并行效率的关键一步。</li>
</ul>
<h3 data-id="heading-13">3. 保留 (Keep)：坚持用虚函数 Trace</h3>
<p>PrimJS 用 switch-case 是为了榨干最后 1% 的 CPU 性能，牺牲了代码的可维护性。
<strong>决策</strong>：我选择<strong>保留虚函数</strong>。作为一个学习型项目，代码的清晰、优雅和可扩展性更重要。我不想为了那一点点性能，把代码写成一坨难以维护的 switch-case。</p>
<h3 data-id="heading-14">4. 学习但暂不落地 (Learn)：内存分配器</h3>
<p>PrimJS 直接操作内存页的设计非常惊艳，但这属于“屠龙技”。
<strong>决策</strong>：我现在学到了它的思想（内存连续性、缓存局部性），但暂时不去碰 <code>malloc</code> 魔改。除非哪天我真的想挑战 OS 级别的开发，否则 <code>new/delete</code> 配合后台释放对于当前量级的 VM 来说已经足够快了。</p>
<hr/>
<p>做系统开发就是这样，<strong>没有绝对最好的架构，只有最适合的 Trade-off</strong>。PrimJS 选择了极致的掌控，而 cilly-vm-cpp 选择了适度的性能与优秀的架构。通过这次深度复盘，我不仅看清了差距，更明确了进化的方向。下一步，开始搓线程池！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OSI参考模型&&TCP/IP模型]]></title>    <link>https://juejin.cn/post/7603671627000561704</link>    <guid>https://juejin.cn/post/7603671627000561704</guid>    <pubDate>2026-02-07T14:24:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603671627000561704" data-draft-id="7603671627000545320" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OSI参考模型&amp;&amp;TCP/IP模型"/> <meta itemprop="keywords" content="网络协议"/> <meta itemprop="datePublished" content="2026-02-07T14:24:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="任白"/> <meta itemprop="url" content="https://juejin.cn/user/2760202790907948"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OSI参考模型&amp;&amp;TCP/IP模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2760202790907948/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    任白
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-07T14:24:18.000Z" title="Sat Feb 07 2026 14:24:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">OSI参考模型&amp;&amp;TCP/IP模型</h2>
<p>在计算机网络领域，OSI 参考模型与 TCP/IP 模型是两个至关重要的概念。它们为网络通信提供了标准的框架和协议，使得全球范围内的计算机能够进行开放式通信。本文将从概念、层次结构、功能特点以及应用等方面，对 OSI 参考模型与 TCP/IP 协议进行深入解析。</p>
<h3 data-id="heading-1">总体结构</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff60128396bd44f99291cbf3ab3a129a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lu755m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771079058&amp;x-signature=ejhadZK0YsXsI70jNRkJxIaSZD8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">OSI参考模型</h3>
<p>在 OSI 参考模型中，总共有 7 层，自下而上分别是<strong>物理层</strong>、<strong>数据链路层</strong>、<strong>网络层</strong>、<strong>传输层</strong>、<strong>会话层</strong>、<strong>表示层</strong>、<strong>应用层</strong>。</p>
<h3 data-id="heading-3">具体设备的对应层次</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e34b861ed2348ba8c6ebbfd1859d59d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lu755m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771079058&amp;x-signature=9QgxZVs27JFubhQ%2F5BXKoDsfi4U%3D" alt="" loading="lazy"/></p>
<p>主机实现了七层所有的功能，集线器实现物理层所要实现的功能，交换机要实现物理层和数据链路层所要实现的功能，路由器实现了物理层、数据链路层、网络层的功能。各个节点之间通过物理传输媒体（网线、光纤等）相连接，我们将物理传输媒体视为第 0 层。接下来我们需要研究 OSI 参考模型中每一层的具体作用。</p>
<h3 data-id="heading-4">物理层</h3>
<p>物理层的传输单位是<strong>比特</strong>，任务是<strong>在物理介质上为数据端设备透明地传输原始比特流</strong>。简单来说就是实现<strong>相邻节点</strong>的比特流传输。</p>
<p>我们知道，两个节点之间需要通过物理传输媒体（<strong>网线、光纤等</strong>）进行连接，节点与节点连接好之后，它们之间要传输数据，首先要解决的第一个问题就是<strong>如何实现两个节点的比特传输？</strong></p>
<p>为了实现比特传输，物理层需要定义电路接口的参数，比如说：网线的接口长什么样子、什么形状、里面有几个针脚。这些接口的参数需要由物理层进行定义。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acbc056e025f416f86e29bbcf37e95f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lu755m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771079058&amp;x-signature=zV1rZGfyypOaWS4NqLj5gyae6vw%3D" alt="" loading="lazy"/></p>
<p>以同轴电缆实现比特传输为例，物理层协议会对传输信号的含义、电气特征做出明确规范：若接收到 5V 高电平信号，即代表二进制 1；若接收到 1V 低电平信号，即代表二进制 0。同时，协议中还会规定每比特电信号的持续时长，比如 5V 高电平信号持续 0.1ms，判定为传输比特 1；1V 低电平信号持续 0.1ms，判定为传输比特 0。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fe8c78168f548ff97a379defd29d632~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lu755m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771079058&amp;x-signature=f4wktcwnairbzAZr2NTEAVRNqww%3D" alt="" loading="lazy"/></p>
<p>接下来我们思考一个问题，物理层在传输电信号时很容易受到外界影响，可能导致电信号变形，例如，一个高电平电压受到环境影响后变成了低电平电压，这样的话，发送方发送**“1”<strong>的电信号，接收方会受到</strong>“0”**的电信号，并且接收方无法得知数据是否错误，那么我们该怎么保证在传输过程中电信号的准确性呢？<strong>我们引入数据链路层来解决这个问题。</strong></p>
<h3 data-id="heading-5">数据链路层</h3>
<p>数据链路层的传输单位是帧，任务是加强物理层传输原始比特流的功能，将物理层提供的可能出错的物理连接改造为逻辑上无差错的数据链路。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/667b4d82c0314084b946a8c1a8c3b38e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lu755m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771079058&amp;x-signature=YbNoSmothhNi8f4zWdkFB6MZJZk%3D" alt="" loading="lazy"/></p>
<p>包含以下功能：</p>
<ol>
<li>
<p>差错控制：检查和纠错</p>
</li>
<li>
<p>流量控制：协调两个<strong>相邻节点间</strong>的速率</p>
</li>
</ol>
<p>数据链路层以帧为传输单位，会在原始数据（如 8bit）中添加<strong>校验比特</strong>（如 2bit），整合后交给物理层传输。接收方链路层会通过校验比特检错，有错则纠错或要求重发，无误则剥离校验比特，将原始数据交给网络层。链路层还具备流量控制功能，可协调相邻节点帧传输速率，避免接收方处理不及。</p>
<p>至此，物理层（第 1 层）、数据链路层（第 2 层）已能实现两个相邻节点之间的无差错数据传输。但在实际计算机网络中，大多数节点之间并不会直接相连，往往需要经过多个路由器的存储转发，才能将数据从源节点成功传递到目的节点。为了实现这种跨多个节点的数据存储转发功能，我们需要在数据链路层之上，额外增加一层——网络层，专门负责解决不同节点之间的路由选择与数据转发问题。</p>
<h3 data-id="heading-6">网络层</h3>
<p>网络层的传输单位是<strong>数据报</strong>，任务是将网络层的协议数据单元（分组）从源主机传输到目的主机，为<strong>分组交换网上点的不同主机提供通信服务</strong>。</p>
<p>包含以下功能：</p>
<ol>
<li>
<p>路由选择：构造并维护路由表，决定分组到达目的节点的最佳路径。</p>
</li>
<li>
<p>分组转发：将“分组”从合适的端口转发出去。</p>
</li>
<li>
<p>拥塞控制：发现网络拥堵，并采取缓解措施。</p>
</li>
<li>
<p>网际互连：实现异构网络互联（解释：简单来说，路由器的功能是将多个计算机网络连接在一起，但这些被连接的网络，内部构造各不相同，所采用的局域网技术也不一样——比如有的网络用的是以太网技术，有的则用的是令牌环网技术。而无论这些网络的内部结构、采用的技术有多大差异，只要经过路由器网络层的处理，就能把这些内部差异全部屏蔽掉，最终实现不同类型网络之间的正常互联和数据通信。）</p>
</li>
<li>
<p>其他功能：差错控制，流量控制，连接的建立与释放，可靠传输管理。</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d97709220f04a8f96611ac5ee769b6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lu755m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771079058&amp;x-signature=kjMNiA7AFYilU9puAEvKAeU5LIg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">传输层</h3>
<p>网络层实现主机到主机的数据分组转发，但一台主机会运行多个进程，数据传到目标主机后，还需区分收发对应的进程，因此在网络层之上增设传输层。</p>
<p>传输层的核心是实现 <strong>端到端（进程到进程）</strong> 的通信服务（这里的 “端” 指端口），为主机间的进程通信提供通用数据传输能力，各类网络应用均可共用该服务，无需针对特定应用单独设计。</p>
<p>包含以下功能：</p>
<ol>
<li>
<p><strong>分用和复用</strong>：<strong>复用</strong>是多个应用层进程可同时使用传输层的服务；<strong>分用</strong>则是传输层将接收到的信息，分别交付给应用层对应的进程，再由应用进程处理应用层报文。</p>
</li>
<li>
<p>其他功能：差错控制，流量控制，连接的建立与释放，可靠传输管理。</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7420cb9ff2948fc82683cbd3e399206~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lu755m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771079058&amp;x-signature=TIK6zv6Tg8IkgP1nJXmHo7XvDTg%3D" alt="" loading="lazy"/></p>
<p>传输层之间是以报文段为单位传输数据，一个报文段可能会被拆分为多个分组， 源节点的网络层会将这些分组发送给目的节点，最后再由目的节点的网络层把这些分组拼凑成完整的报文段，交付给目的节点的传输层。</p>
<h3 data-id="heading-8">会话层</h3>
<p><strong>核心任务</strong>：专门负责管理网络中不同主机上进程之间的通信会话，保障进程间通信的有序性、连续性，避免因异常中断导致通信数据丢失或重传浪费。</p>
<p><strong>主要功能</strong>：核心为<strong>会话管理</strong>，其中最关键的是检查点恢复机制。该机制会在通信过程中按规则记录数据传输的关键节点（检查点），若通信因网络中断、设备故障等原因失效，无需从头开始传输数据，恢复连接后可直接从最近的检查点继续后续传输，大幅提升通信效率。</p>
<p><strong>实际举例</strong>：主机 A 通过微信向主机 B 发送 1GB 的视频文件时，会话层会全程管控该传输会话。若视频传输至 500MB 时突发网络中断，会话层会立即在 500MB 这个位置记录检查点；当网络恢复、两台主机的通信进程重新建立连接后，视频不会从 0MB 重新发送，而是直接从 500MB 的检查点继续传输剩余内容。</p>
<h3 data-id="heading-9">表示层</h3>
<p><strong>核心任务</strong>：解决不同主机之间信息表示格式不一致的问题，统一通信双方的数据表达形式，让异构主机能正确识别、解析彼此传输的数据，是通信双方的 “数据翻译官”。</p>
<p><strong>主要功能</strong>：以<strong>数据格式转换</strong>为核心，同时涵盖数据压缩 / 解压、加密 / 解密等配套功能。数据格式转换包含编码格式转换、数据格式标准化等；压缩 / 解压可减小数据传输体积，提升传输速度；加密 / 解密则保障数据在传输过程中的安全性，防止信息泄露。</p>
<p><strong>实际举例</strong>：不同主机的系统可能采用不同的字符编码格式，若主机 A 的编码格式为 GBK，主机 B 为 UTF-8，同一个汉字在两台主机中被转换的二进制编码会完全不同 —— 主机 A 发送的汉字二进制数据，直接传到主机 B 后会出现乱码，这就是典型的信息表示不一致问题。此时表示层会介入处理：主机 A 的表示层先将 GBK 编码的二进制数据转换为双方约定的统一编码格式，再传输至主机 B；主机 B 的表示层接收到数据后，再将其转换为自身可识别的 UTF-8 编码，最终让主机 B 正确显示对应的汉字，解决乱码问题。</p>
<h3 data-id="heading-10">应用层</h3>
<p><strong>核心任务</strong>：直接为用户或应用程序提供特定的网络应用服务，是 OSI 参考模型中最贴近用户的一层，所有用户可见的网络功能都由应用层实现。</p>
<p><strong>主要功能</strong>：功能无统一固定标准，完全根据实际网络应用的需求进行设计和开发，种类繁多且随网络技术发展不断拓展。凡是依托网络实现的具体应用功能，都对应应用层的相关协议和服务。</p>
<p><strong>常见举例</strong>：日常使用的网页浏览（对应 HTTP/HTTPS 协议）、文件传输（FTP 协议）、电子邮件收发（SMTP/POP3 协议）、即时通讯（微信、QQ 的专属应用层协议）、域名解析（DNS 协议）等，都是应用层实现的典型网络应用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51402382f4a045819cfd211cc9a00f2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lu755m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771079058&amp;x-signature=0DF4EIklFv7Z3AfGM%2BusB3FJJ3k%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">TCP/IP模型</h2>
<h3 data-id="heading-12">结构</h3>
<p>TCP/IP 模型是一个<strong>四层</strong>网络架构模型，由美国国防部高级研究计划局（ARPA）在 20 世纪 70 年代为 ARPANET（互联网前身）所设计。它基于一系列核心协议（如 TCP 和 IP），并因互联网的全球普及而成为实际上的工业标准。与 OSI 模型的<strong>理论分层</strong>不同，TCP/IP 模型更侧重于<strong>实践和协议实现。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa780f11589b4a9fac88e7fffe18e519~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lu755m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771079058&amp;x-signature=VeTPAws%2BeQBN%2BvvtO8YqwMDfnII%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">网络接口层</h3>
<p>网络接口层是 TCP/IP 模型的最底层，对应 OSI 参考模型的物理层和数据链路层，传输单位是帧，核心任务是负责将网络层传递下来的分组（数据报）封装成帧，通过物理传输媒体实现相邻设备之间的帧传输，同时接收来自物理介质的帧，剥离帧头部信息后，将核心数据（分组）交给网络层。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fa7db72c7e240c594023a9a7f0771cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lu755m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771079058&amp;x-signature=YXon7q%2F0FXfhbi0tewPbUuhYTIQ%3D" alt="" loading="lazy"/></p>
<p>这里我们思考一个问题：网络接口层只能实现相邻设备之间的帧传输，无法跨越多个网络（如局域网与广域网）传递数据——比如一台家用电脑（局域网内）要向互联网上的服务器发送数据，中间需要经过路由器、交换机等多个设备，此时仅靠网络接口层的帧传输无法完成，因此需要引入网络层，解决跨网络的数据转发问题。</p>
<h3 data-id="heading-14">网络层</h3>
<p>网络层是 TCP/IP 模型的核心层次，对应 OSI 参考模型的网络层，传输单位是分组（也称为数据报），核心任务是实现跨网络（异构网络）的分组转发，将源主机的分组通过多个路由器的存储转发，最终传递到目的主机，为主机与主机之间（跨网络）的通信提供基础服务。</p>
<p><strong>包含以下功能：</strong></p>
<ol>
<li>
<p>IP 寻址：为互联网中的每一台主机分配唯一的 IP 地址（IPv4 或 IPv6），作为主机的身份标识，确保分组能够准确识别源主机和目的主机。IP 地址就像是主机的“网络身份证”，例如家用电脑的 IP 地址可能是 192.168.1.100，互联网服务器的 IP 地址可能是 203.0.113.10，分组通过 IP 地址才能找到对应的目的主机。</p>
</li>
<li>
<p>路由选择：路由器会构造并维护路由表，路由表中记录了不同网络的可达路径、路径优先级、下一跳路由器地址等信息。当路由器接收到分组时，会根据分组中的目的 IP 地址，查询路由表，选择一条最优路径，将分组转发到下一跳路由器，直至分组到达目的主机所在的网络。</p>
</li>
<li>
<p>分组转发：这是网络层的核心操作，路由器接收来自上层（传输层）或其他路由器的分组后，解析分组头部的目的 IP 地址，结合路由表确定转发端口，将分组转发出去。转发过程中，路由器仅修改分组的物理地址（MAC 地址），不修改 IP 地址和分组的数据内容。</p>
</li>
<li>
<p>拥塞控制：当网络中分组数量过多，超过路由器或链路的处理能力时，会出现网络拥塞（导致分组延迟、丢失）。网络层通过丢弃部分分组、调整转发速率等简单方式，缓解拥塞，保障网络的基本传输效率（TCP/IP 模型中，更精细的拥塞控制主要由传输层负责）。</p>
</li>
<li>
<p>网际互连：实现异构网络的互联，例如将以太网（局域网）、广域网（如光纤网络）、无线网络等不同类型的网络连接在一起。路由器的网络层能够屏蔽不同底层网络的差异（如帧格式、传输介质不同），通过 IP 协议统一封装分组，实现不同网络之间的正常数据通信。</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7be1235dbc9d491289b9928c0eb85073~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lu755m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771079058&amp;x-signature=gJJ19sQF23l6SZAhTiim%2FJf%2BdlM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-15">传输层</h3>
<p>传输层对应 OSI 参考模型的传输层，位于网络层之上、应用层之下，传输单位是报文段（TCP 协议）或用户数据报（UDP 协议），核心任务是在网络层“主机到主机”通信的基础上，实现“端到端（进程到进程）”的可靠或不可靠通信，为主机上的不同应用进程提供独立的通信通道，屏蔽网络层的传输差异。</p>
<p>我们知道，网络层只能将分组传递到目的主机，但一台主机上会同时运行多个应用进程（如同时打开浏览器、微信、QQ），分组到达目的主机后，需要明确“交给哪个应用进程处理”——传输层通过“端口”解决这个问题：每个应用进程对应一个唯一的端口号（1-65535），分组到达后，传输层根据端口号，将数据分发给对应的应用进程，这就是“进程到进程”的通信。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b29f339dee544909504df1704b1b91c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lu755m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771079058&amp;x-signature=gNn4ZiuJyE3TB3ozZhanjgCyxZU%3D" alt="" loading="lazy"/></p>
<p><strong>包含以下功能：</strong></p>
<ol>
<li>
<p>分用和复用：复用是指多个应用层进程可以同时使用传输层的服务，传输层会为每个进程分配独立的端口号，将不同进程的数据封装成不同的报文段 / 用户数据报，统一交给网络层传输；分用是指传输层接收来自网络层的分组后，解析分组中的端口号，将数据分别交付给应用层对应的进程。</p>
</li>
<li>
<p>可靠传输（TCP 协议专属）：TCP 协议通过确认机制、重传机制、排序机制、流量控制、拥塞控制等，确保数据能够准确、有序、无丢失地从源进程传输到目的进程。例如，发送方发送报文段后，会等待接收方的确认消息；若超时未收到确认，会重新发送该报文段；接收方会对收到的报文段进行排序，丢弃重复的报文段，确保数据的有序性。</p>
</li>
<li>
<p>不可靠传输（UDP 协议专属）：UDP 协议不提供可靠传输，仅负责将应用层的数据封装成用户数据报，交给网络层传输，不进行确认、不重传、不排序，传输效率高，适合对实时性要求高、允许少量数据丢失的场景（如视频通话、语音通话、广播）。</p>
</li>
<li>
<p>流量控制：协调源进程和目的进程的数据传输速率，避免目的进程处理速度跟不上源进程的发送速度，导致数据堆积、丢失。TCP 协议通过滑动窗口机制实现流量控制，UDP 协议不提供流量控制。</p>
</li>
<li>
<p>连接的建立与释放（TCP 协议专属）：TCP 协议是面向连接的协议，通信前需要通过“三次握手”建立连接，确保双方通信就绪；通信结束后，通过“四次挥手”释放连接，释放系统资源；UDP 协议是无连接协议，通信前无需建立连接，通信结束后无需释放连接。</p>
</li>
</ol>
<h3 data-id="heading-16">应用层</h3>
<p>应用层是 TCP/IP 模型的最上层，对应 OSI 参考模型的会话层、表示层、应用层，核心任务是直接为用户或应用程序提供特定的网络应用服务，是 TCP/IP 模型中最贴近用户的一层，所有用户可见的网络功能，都由应用层实现。</p>
<p>与 OSI 模型将会话、表示、应用功能分开不同，TCP/IP 模型将这三层的功能整合到应用层中，简化了协议设计——应用层无需关注底层的传输细节（如如何分组、如何转发、如何保证可靠传输），只需调用传输层提供的服务，实现具体的网络应用功能即可。应用层的协议都是针对具体应用设计的，种类繁多，随网络技术的发展不断拓展。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/caa329fd7740416da3ec0407c07522d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lu755m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771079058&amp;x-signature=pHdRxLiad4tGz6z22iRgS8rzSmI%3D" alt="" loading="lazy"/></p>
<p>补充说明：应用层的所有数据，都会交给传输层（TCP 或 UDP 协议）进行封装，再依次经过网络层、网络接口层的封装，最终通过物理介质传输；接收方则从底层到上层，依次剥离各层的封装头部，最终将数据交给应用层的对应进程，完成一次完整的网络通信。</p>
<h2 data-id="heading-17">总结</h2>
<p>OSI 参考模型是由国际标准化组织（ISO）制定的理论化七层协议模型（自下而上为物理层、数据链路层、网络层、传输层、会话层、表示层、应用层），核心定位是为全球异构网络提供统一的通信规范和理论框架，层次划分细致、功能定义严谨，涵盖了从物理比特传输到应用服务的全流程，但其结构复杂、实现成本高，仅作为理论参考，未在实际网络中广泛应用；TCP/IP 模型源于 ARPAnet 项目，是实用化的四层协议模型（自下而上为网络接口层、网络层、传输层、应用层），核心定位是解决实际网络互联问题，整合了 OSI 模型中会话层、表示层的功能，虽非国际标准，但因其简洁高效、兼容性强，成为全球互联网的实际执行标准，两者核心对应关系明确：TCP/IP 模型的网络接口层对应 OSI 的物理层与数据链路层（负责帧和比特传输），网络层（核心 IP 协议）、传输层（TCP/UDP 协议）分别对应 OSI 的同名层次，应用层则涵盖了 OSI 会话层、表示层、应用层的全部应用服务功能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Pinia必学4大核心API：$patch/$reset/$subscribe/$onAction，用法封神！]]></title>    <link>https://juejin.cn/post/7603673564908322851</link>    <guid>https://juejin.cn/post/7603673564908322851</guid>    <pubDate>2026-02-07T15:01:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603673564908322851" data-draft-id="7602991346585255970" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Pinia必学4大核心API：$patch/$reset/$subscribe/$onAction，用法封神！"/> <meta itemprop="keywords" content="JavaScript,面试,Vue.js"/> <meta itemprop="datePublished" content="2026-02-07T15:01:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="boooooooom"/> <meta itemprop="url" content="https://juejin.cn/user/3078273283917399"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Pinia必学4大核心API：$patch/$reset/$subscribe/$onAction，用法封神！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3078273283917399/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    boooooooom
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-07T15:01:26.000Z" title="Sat Feb 07 2026 15:01:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">正文</h2>
<h3 data-id="heading-1">一、前言：为什么要吃透这4个核心API？</h3>
<p>学会Pinia的Setup Store和Option Store基础写法后，想要真正灵活运用Pinia、应对复杂状态管理场景，就必须掌握它的四大核心实例API——<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>a</mi><mi>t</mi><mi>c</mi><mi>h</mi><mtext>、</mtext></mrow><annotation encoding="application/x-tex">patch、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">c</span><span class="mord mathnormal">h</span><span class="mord cjk_fallback">、</span></span></span></span></span>reset、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>b</mi><mi>s</mi><mi>c</mi><mi>r</mi><mi>i</mi><mi>b</mi><mi>e</mi><mtext>、</mtext></mrow><annotation encoding="application/x-tex">subscribe、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.02778em;">scr</span><span class="mord mathnormal">ib</span><span class="mord mathnormal">e</span><span class="mord cjk_fallback">、</span></span></span></span></span>onAction。</p>
<p>这4个API贯穿Pinia开发全流程：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>a</mi><mi>t</mi><mi>c</mi><mi>h</mi><mtext>批量修改状态、</mtext></mrow><annotation encoding="application/x-tex">patch批量修改状态、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">c</span><span class="mord mathnormal">h</span><span class="mord cjk_fallback">批量修改状态、</span></span></span></span></span>reset重置状态、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>b</mi><mi>s</mi><mi>c</mi><mi>r</mi><mi>i</mi><mi>b</mi><mi>e</mi><mtext>监听状态变化、</mtext></mrow><annotation encoding="application/x-tex">subscribe监听状态变化、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.02778em;">scr</span><span class="mord mathnormal">ib</span><span class="mord mathnormal">e</span><span class="mord cjk_fallback">监听状态变化、</span></span></span></span></span>onAction监听方法执行，覆盖“修改-重置-监听”三大核心需求。</p>
<p>很多开发者用Pinia只停留在基础写法，忽略了这4个API的强大功能，导致代码冗余、状态管理混乱。本文聚焦四大API，从“用法+案例+避坑”三维度拆解，全程结合Vue3 + TS实操，看完直接套用。</p>
<h3 data-id="heading-2">二、前置准备：统一Store实例（两种写法通用）</h3>
<p>为了让API用法更直观，先定义一个通用的Pinia Store（同时兼容Option Store和Setup Store，后续API用法均基于此实例演示，避免重复）：</p>
<h4 data-id="heading-3">1. Option Store 实例（基础版）</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/stores/user.ts（Option Store）</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'user'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'Pinia'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">3</span>,
    <span class="hljs-attr">isLogin</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">roles</span>: [<span class="hljs-string">'user'</span>]
  }),
  <span class="hljs-attr">getters</span>: {
    <span class="hljs-attr">fullName</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> <span class="hljs-string">`Mr. <span class="hljs-subst">${state.name}</span>`</span>
  },
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-title function_">setLogin</span>(<span class="hljs-params">status: <span class="hljs-built_in">boolean</span></span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isLogin</span> = status
    },
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchUserInfo</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 模拟接口请求</span>
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>({
        <span class="hljs-attr">name</span>: <span class="hljs-string">'Pinia Pro'</span>,
        <span class="hljs-attr">age</span>: <span class="hljs-number">4</span>,
        <span class="hljs-attr">roles</span>: [<span class="hljs-string">'user'</span>, <span class="hljs-string">'admin'</span>]
      }), <span class="hljs-number">1000</span>))
      <span class="hljs-variable language_">this</span>.$patch(res) <span class="hljs-comment">// 后续会讲$patch用法</span>
    }
  }
})
</code></pre>
<h4 data-id="heading-4">2. Setup Store 实例（基础版）</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/stores/user.ts（Setup Store）</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'user'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> name = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'Pinia'</span>)
  <span class="hljs-keyword">const</span> age = <span class="hljs-title function_">ref</span>(<span class="hljs-number">3</span>)
  <span class="hljs-keyword">const</span> isLogin = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
  <span class="hljs-keyword">const</span> roles = <span class="hljs-title function_">ref</span>([<span class="hljs-string">'user'</span>])

  <span class="hljs-keyword">const</span> fullName = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-string">`Mr. <span class="hljs-subst">${name.value}</span>`</span>)

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">setLogin</span> = (<span class="hljs-params">status: <span class="hljs-built_in">boolean</span></span>) =&gt; {
    isLogin.<span class="hljs-property">value</span> = status
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchUserInfo</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>({
      <span class="hljs-attr">name</span>: <span class="hljs-string">'Pinia Pro'</span>,
      <span class="hljs-attr">age</span>: <span class="hljs-number">4</span>,
      <span class="hljs-attr">roles</span>: [<span class="hljs-string">'user'</span>, <span class="hljs-string">'admin'</span>]
    }), <span class="hljs-number">1000</span>))
    <span class="hljs-comment">// Setup Store 中$patch用法与Option Store一致</span>
    <span class="hljs-title function_">useUserStore</span>().$patch({
      <span class="hljs-attr">name</span>: res.<span class="hljs-property">name</span>,
      <span class="hljs-attr">age</span>: res.<span class="hljs-property">age</span>,
      <span class="hljs-attr">roles</span>: res.<span class="hljs-property">roles</span>
    })
  }

  <span class="hljs-keyword">return</span> {
    name, age, isLogin, roles,
    fullName,
    setLogin, fetchUserInfo
  }
})
</code></pre>
<p>关键说明：以下四大API的用法，<strong>完全适用于两种Store写法</strong>，仅Setup Store中操作ref状态时需注意.value，API调用逻辑完全一致，后续不再单独区分。</p>
<h3 data-id="heading-5">三、四大核心API详解（重点！用法+案例+避坑）</h3>
<p>按“修改状态→重置状态→监听状态→监听方法”的逻辑拆解，每个API都包含“核心作用+两种用法+实操案例+避坑点”，确保新手能看懂、会用。</p>
<h4 data-id="heading-6">1. $patch：批量修改状态（高效简洁，首选）</h4>
<h5 data-id="heading-7">核心作用</h5>
<p>用于<strong>批量修改多个状态</strong>，替代多次单独修改状态（如this.name = xxx、this.age = xxx），减少代码冗余，同时优化性能（Pinia会合并多次状态更新，减少组件重渲染）。</p>
<p>适用场景：一次性修改多个state属性（如接口请求后，同步更新多个状态）。</p>
<h5 data-id="heading-8">两种用法（均常用，按需选择）</h5>
<h6 data-id="heading-9">用法1：对象式（简单批量修改，首选）</h6>
<p>核心：传递一个对象，对象中的key对应state的属性名，value对应要修改的值，仅修改对象中包含的属性。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 1. 组件中使用（两种Store写法通用）</span>
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/user'</span>

<span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>()

<span class="hljs-comment">// 批量修改name、age、isLogin三个状态</span>
userStore.$patch({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Pinia Advanced'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">5</span>,
  <span class="hljs-attr">isLogin</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-comment">// 数组类型也可直接修改（覆盖式）</span>
  <span class="hljs-attr">roles</span>: [<span class="hljs-string">'admin'</span>]
})

<span class="hljs-comment">// 2. Option Store 的actions中使用</span>
<span class="hljs-attr">actions</span>: {
  <span class="hljs-title function_">updateUserInfo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.$patch({ <span class="hljs-comment">// this指向当前Store实例</span>
      <span class="hljs-attr">name</span>: <span class="hljs-string">'Pinia Advanced'</span>,
      <span class="hljs-attr">age</span>: <span class="hljs-number">5</span>
    })
  }
}
</code></pre>
<h6 data-id="heading-10">用法2：函数式（复杂修改，如数组操作）</h6>
<p>核心：传递一个函数，函数接收state作为参数，可在函数内部执行复杂的状态修改（如数组push、splice，对象深层修改），比对象式更灵活。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 复杂修改案例：给roles数组添加新角色，同时修改age</span>
userStore.$patch(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {
  state.<span class="hljs-property">roles</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">'superAdmin'</span>) <span class="hljs-comment">// 数组操作</span>
  state.<span class="hljs-property">age</span> += <span class="hljs-number">1</span> <span class="hljs-comment">// 计算后修改</span>
  <span class="hljs-comment">// 支持深层修改（若state有嵌套对象）</span>
  <span class="hljs-comment">// state.info.address = 'xxx'</span>
})

<span class="hljs-comment">// 对比：若用对象式，数组只能覆盖，无法直接push</span>
userStore.$patch({
  <span class="hljs-attr">roles</span>: [...userStore.<span class="hljs-property">roles</span>, <span class="hljs-string">'superAdmin'</span>] <span class="hljs-comment">// 需手动解构，繁琐</span>
})
</code></pre>
<h5 data-id="heading-11">避坑点</h5>
<ul>
<li>对象式$patch无法修改数组的单个元素（如roles[0] = 'admin'），需用函数式或解构数组；</li>
<li>Setup Store中，若直接在函数内操作ref状态，需用state.name.value（推荐直接用Store实例调用$patch，无需关注.value）。</li>
</ul>
<h4 data-id="heading-12">2. $reset：重置状态（一键恢复初始值）</h4>
<h5 data-id="heading-13">核心作用</h5>
<p>将Store的所有state属性，<strong>一键恢复到初始状态</strong>（即state选项/ref定义时的初始值），无需手动逐个重置，简化逻辑。</p>
<p>适用场景：退出登录、表单重置、页面刷新时，恢复Store初始状态。</p>
<h5 data-id="heading-14">用法（极简，无需复杂配置）</h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 组件中使用（两种Store写法通用）</span>
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/user'</span>

<span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>()

<span class="hljs-comment">// 一键重置所有状态（name恢复为Pinia，age恢复为3，isLogin恢复为false）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleReset</span> = (<span class="hljs-params"/>) =&gt; {
  userStore.$reset()
}

<span class="hljs-comment">// Option Store 的actions中使用</span>
<span class="hljs-attr">actions</span>: {
  <span class="hljs-title function_">logout</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setLogin</span>(<span class="hljs-literal">false</span>) <span class="hljs-comment">// 先执行自定义逻辑</span>
    <span class="hljs-variable language_">this</span>.$reset() <span class="hljs-comment">// 再重置状态</span>
  }
}
</code></pre>
<h5 data-id="heading-15">避坑点（重点！）</h5>
<ul>
<li>Setup Store中，$reset仅能重置“return中暴露的状态”，未暴露的局部状态无法重置；</li>
<li>若state中有嵌套对象，$reset会深度重置（即嵌套对象也恢复初始值），无需额外处理；</li>
<li>Option Store中，若state是箭头函数返回的对象，$reset才能生效（默认写法，无需担心）。</li>
</ul>
<h4 data-id="heading-16">3. $subscribe：监听状态变化（响应式感知）</h4>
<h5 data-id="heading-17">核心作用</h5>
<p>监听Store中<strong>所有state属性的变化</strong>（单个/多个属性变化均会触发），可获取变化前、变化后的值，用于执行副作用（如日志记录、本地存储同步）。</p>
<p>适用场景：状态变化后执行额外逻辑（如用户信息变化时，同步缓存到localStorage）。</p>
<h5 data-id="heading-18">用法（含配置项，灵活适配场景）</h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 组件中使用（两种Store写法通用）</span>
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/user'</span>

<span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>()

<span class="hljs-comment">// 监听状态变化</span>
<span class="hljs-keyword">const</span> unsubscribe = userStore.$subscribe(<span class="hljs-function">(<span class="hljs-params">mutation, state</span>) =&gt;</span> {
  <span class="hljs-comment">// mutation：变化相关信息（核心属性如下）</span>
  <span class="hljs-comment">// mutation.storeId：当前Store的id（如user）</span>
  <span class="hljs-comment">// mutation.type：变化类型（direct：直接修改，patch：$patch修改）</span>
  <span class="hljs-comment">// mutation.payload：变化的内容（对象式$patch为修改对象，函数式为undefined）</span>
  
  <span class="hljs-comment">// state：变化后的最新状态（完整state对象）</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'状态变化了'</span>, mutation, state)
  
  <span class="hljs-comment">// 示例：同步状态到localStorage</span>
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'userState'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(state))
}, {
  <span class="hljs-comment">// 可选配置项（按需开启）</span>
  <span class="hljs-attr">detached</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 默认为false，组件卸载后自动取消监听；true则组件卸载后仍监听</span>
  <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 默认为true，深度监听嵌套对象变化；false则不监听嵌套对象</span>
  <span class="hljs-attr">immediate</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 默认为false，初始化时不触发；true则初始化时立即触发一次</span>
})

<span class="hljs-comment">// 手动取消监听（如组件卸载时）</span>
<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">unsubscribe</span>()
})

<span class="hljs-comment">// Option Store 的actions中使用（较少见，一般在组件中监听）</span>
<span class="hljs-attr">actions</span>: {
  <span class="hljs-title function_">initSubscribe</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.$subscribe(<span class="hljs-function">(<span class="hljs-params">mutation, state</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'状态变化'</span>, state)
    })
  }
}
</code></pre>
<h5 data-id="heading-19">避坑点</h5>
<ul>
<li>忘记手动取消监听（detached为false时，组件卸载会自动取消；detached为true时，需手动取消，否则会内存泄漏）；</li>
<li>deep设为false时，嵌套对象的变化不会触发$subscribe，需根据需求开启；</li>
<li>函数式$patch修改状态时，mutation.payload为undefined，无法获取具体变化内容。</li>
</ul>
<h4 data-id="heading-20">4. $onAction：监听方法执行（全生命周期感知）</h4>
<h5 data-id="heading-21">核心作用</h5>
<p>监听Store中<strong>所有actions方法的执行</strong>，可在方法执行前、执行后、执行报错时触发回调，用于拦截方法、日志记录、错误处理。</p>
<p>适用场景：拦截异步方法（如请求前loading、请求后处理）、记录方法执行日志、捕获方法报错。</p>
<h5 data-id="heading-22">用法（含生命周期回调，常用）</h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 组件中使用（两种Store写法通用）</span>
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/user'</span>

<span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>()

<span class="hljs-comment">// 监听所有actions方法的执行</span>
<span class="hljs-keyword">const</span> unsubscribe = userStore.$onAction(<span class="hljs-function">(<span class="hljs-params">{
  name, // 当前执行的actions方法名（如fetchUserInfo、setLogin）
  args, // 当前方法的参数数组（如setLogin的参数[<span class="hljs-literal">true</span>]）
  after, // 方法执行成功后触发的回调
  onError // 方法执行失败（报错）时触发的回调
}</span>) =&gt;</span> {
  <span class="hljs-comment">// 1. 方法执行前触发（可做拦截、loading等）</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`方法<span class="hljs-subst">${name}</span>开始执行，参数：`</span>, args)
  <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">true</span>)

  <span class="hljs-comment">// 2. 方法执行成功后触发（可做后续处理）</span>
  <span class="hljs-title function_">after</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`方法<span class="hljs-subst">${name}</span>执行成功，返回值：`</span>, result)
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
  })

  <span class="hljs-comment">// 3. 方法执行失败时触发（可做错误处理）</span>
  <span class="hljs-title function_">onError</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`方法<span class="hljs-subst">${name}</span>执行失败，错误：`</span>, error)
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'操作失败，请重试'</span>)
  })
}, {
  <span class="hljs-comment">// 可选配置项</span>
  <span class="hljs-attr">detached</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 与$subscribe一致，组件卸载后是否继续监听</span>
})

<span class="hljs-comment">// 手动取消监听</span>
<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">unsubscribe</span>()
})

<span class="hljs-comment">// 示例：监听fetchUserInfo异步方法</span>
userStore.<span class="hljs-title function_">fetchUserInfo</span>() <span class="hljs-comment">// 会触发$onAction的所有回调</span>
</code></pre>
<h5 data-id="heading-23">避坑点</h5>
<ul>
<li>$onAction<strong>仅能监听actions中的方法</strong>，Setup Store中未返回的局部函数、组件中的普通函数，无法监听；</li>
<li>异步方法（如fetchUserInfo）中，after回调会在方法执行完成（await结束）后触发，onError捕获await中的报错；</li>
<li>多个方法同时执行时，$onAction会分别触发对应的回调，无需担心混淆。</li>
</ul>
<h3 data-id="heading-24">四、四大API对比总结（一目了然，快速选型）</h3>



































<table><thead><tr><th>API</th><th>核心作用</th><th>适用场景</th><th>关键注意点</th></tr></thead><tbody><tr><td>$patch</td><td>批量修改多个状态</td><td>接口请求后同步更新状态、一次性修改多属性</td><td>函数式适配复杂修改，对象式简洁首选</td></tr><tr><td>$reset</td><td>一键重置所有状态为初始值</td><td>退出登录、表单重置、页面刷新</td><td>Setup Store仅重置暴露的状态</td></tr><tr><td>$subscribe</td><td>监听所有state变化</td><td>状态变化后同步缓存、日志记录</td><td>注意取消监听，避免内存泄漏</td></tr><tr><td>$onAction</td><td>监听actions方法执行（全生命周期）</td><td>异步请求拦截、错误处理、方法日志</td><td>仅监听actions中的方法，不监听局部函数</td></tr></tbody></table>
<h3 data-id="heading-25">五、实战综合案例（四大API联用，贴近真实开发）</h3>
<p>结合“用户信息管理”场景，联用四大API，实现“修改用户信息→监听状态变化→缓存到本地→重置状态→监听方法报错”的完整逻辑，代码可直接复制套用：</p>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"user-manager"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>用户信息管理<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>姓名：{{ userStore.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>年龄：{{ userStore.age }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>角色：{{ userStore.roles.join(',') }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"updateUser"</span>&gt;</span>修改用户信息<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"resetUser"</span>&gt;</span>重置用户信息<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"fetchUser"</span>&gt;</span>获取用户信息（异步）<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/user'</span>
<span class="hljs-keyword">import</span> { onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'element-plus'</span>

<span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>()

<span class="hljs-comment">// 1. 监听状态变化，同步到localStorage</span>
<span class="hljs-keyword">const</span> unsubscribeSub = userStore.$subscribe(<span class="hljs-function">(<span class="hljs-params">_, state</span>) =&gt;</span> {
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'userState'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(state))
  <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">'用户状态已同步缓存'</span>)
})

<span class="hljs-comment">// 2. 监听actions方法执行，处理loading和错误</span>
<span class="hljs-keyword">const</span> unsubscribeAction = userStore.$onAction(<span class="hljs-function">(<span class="hljs-params">{ name, after, onError }</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`方法<span class="hljs-subst">${name}</span>开始执行`</span>)
  <span class="hljs-keyword">const</span> loading = <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">info</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'操作中...'</span>, <span class="hljs-attr">duration</span>: <span class="hljs-number">0</span> })
  
  <span class="hljs-title function_">after</span>(<span class="hljs-function">() =&gt;</span> {
    loading.<span class="hljs-title function_">close</span>()
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">`方法<span class="hljs-subst">${name}</span>执行成功`</span>)
  })
  
  <span class="hljs-title function_">onError</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
    loading.<span class="hljs-title function_">close</span>()
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`方法<span class="hljs-subst">${name}</span>执行失败：<span class="hljs-subst">${err.message}</span>`</span>)
  })
})

<span class="hljs-comment">// 3. 批量修改用户信息（$patch）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateUser</span> = (<span class="hljs-params"/>) =&gt; {
  userStore.$patch({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'Pinia 实战'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">6</span>,
    <span class="hljs-attr">roles</span>: [<span class="hljs-string">'user'</span>, <span class="hljs-string">'admin'</span>, <span class="hljs-string">'superAdmin'</span>]
  })
}

<span class="hljs-comment">// 4. 重置用户信息（$reset）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">resetUser</span> = (<span class="hljs-params"/>) =&gt; {
  userStore.$reset()
}

<span class="hljs-comment">// 5. 异步获取用户信息（调用actions，触发$onAction）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchUser</span> = (<span class="hljs-params"/>) =&gt; {
  userStore.<span class="hljs-title function_">fetchUserInfo</span>()
}

<span class="hljs-comment">// 6. 组件卸载，取消所有监听</span>
<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">unsubscribeSub</span>()
  <span class="hljs-title function_">unsubscribeAction</span>()
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-26">六、总结：核心要点（新手必背）</h3>
<ol>
<li>四大API是Pinia进阶的核心，覆盖“修改-重置-监听”全流程，学会后能大幅提升状态管理效率；</li>
<li>$patch：批量修改首选，对象式简洁、函数式灵活，优化性能减少重渲染；</li>
<li>$reset：一键重置，注意Setup Store仅重置暴露的状态；</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>b</mi><mi>s</mi><mi>c</mi><mi>r</mi><mi>i</mi><mi>b</mi><mi>e</mi><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">subscribe/</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.02778em;">scr</span><span class="mord mathnormal">ib</span><span class="mord mathnormal">e</span><span class="mord">/</span></span></span></span></span>onAction：监听状态和方法，务必记得取消监听（避免内存泄漏），按需配置detached、deep；</li>
<li>两种Store写法（Setup/Option）中，四大API用法完全一致，仅Setup Store操作ref需注意.value。</li>
</ol>
<p>其实这4个API的用法并不复杂，核心是“贴合场景选择”——批量修改用<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>a</mi><mi>t</mi><mi>c</mi><mi>h</mi><mtext>，重置用</mtext></mrow><annotation encoding="application/x-tex">patch，重置用</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">c</span><span class="mord mathnormal">h</span><span class="mord cjk_fallback">，重置用</span></span></span></span></span>reset，监听状态用<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>b</mi><mi>s</mi><mi>c</mi><mi>r</mi><mi>i</mi><mi>b</mi><mi>e</mi><mtext>，监听方法用</mtext></mrow><annotation encoding="application/x-tex">subscribe，监听方法用</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.02778em;">scr</span><span class="mord mathnormal">ib</span><span class="mord mathnormal">e</span><span class="mord cjk_fallback">，监听方法用</span></span></span></span></span>onAction。结合本文的案例多练几遍，就能灵活运用到实际项目中，彻底吃透Pinia的强大之处～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OSPF协议笔记整理]]></title>    <link>https://juejin.cn/post/7603643385816039476</link>    <guid>https://juejin.cn/post/7603643385816039476</guid>    <pubDate>2026-02-07T13:52:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603643385816039476" data-draft-id="7603574149776932916" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OSPF协议笔记整理"/> <meta itemprop="keywords" content="网络协议"/> <meta itemprop="datePublished" content="2026-02-07T13:52:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不做菜鸟的网工"/> <meta itemprop="url" content="https://juejin.cn/user/3283597248432442"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OSPF协议笔记整理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3283597248432442/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不做菜鸟的网工
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-07T13:52:07.000Z" title="Sat Feb 07 2026 13:52:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">OSPF协议</h2>
<blockquote>
<p>基于链路状态、工作在网络层之上的路由协议</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">目录</h3>
<ol>
<li><a href="#ospf%E6%8A%A5%E6%96%87%E7%B1%BB%E5%9E%8B" title="#ospf%E6%8A%A5%E6%96%87%E7%B1%BB%E5%9E%8B">OSPF报文类型</a></li>
<li><a href="#ospf%E7%8A%B6%E6%80%81%E6%9C%BA" title="#ospf%E7%8A%B6%E6%80%81%E6%9C%BA">OSPF状态机</a></li>
<li><a href="#ospf%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6" title="#ospf%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6">OSPF确认机制</a></li>
<li><a href="#ospf%E9%82%BB%E6%8E%A5%E5%85%B3%E7%B3%BB%E5%BB%BA%E7%AB%8B%E4%B8%8E%E8%B7%AF%E7%94%B1%E8%AE%A1%E7%AE%97%E9%97%AE%E9%A2%98" title="#ospf%E9%82%BB%E6%8E%A5%E5%85%B3%E7%B3%BB%E5%BB%BA%E7%AB%8B%E4%B8%8E%E8%B7%AF%E7%94%B1%E8%AE%A1%E7%AE%97%E9%97%AE%E9%A2%98">OSPF邻接关系建立与路由计算问题</a></li>
<li><a href="#ospf%E7%BD%91%E7%BB%9C%E7%B1%BB%E5%9E%8B" title="#ospf%E7%BD%91%E7%BB%9C%E7%B1%BB%E5%9E%8B">OSPF网络类型</a></li>
<li><a href="#ospf%E5%BC%80%E9%94%80%E5%80%BC%E8%AE%A1%E7%AE%97" title="#ospf%E5%BC%80%E9%94%80%E5%80%BC%E8%AE%A1%E7%AE%97">OSPF开销值计算</a></li>
<li><a href="#%E9%93%BE%E8%B7%AF%E7%8A%B6%E6%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8Elsa" title="#%E9%93%BE%E8%B7%AF%E7%8A%B6%E6%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8Elsa">链路状态数据库与LSA</a></li>
<li><a href="#ospf%E5%9F%9F%E5%86%85%E8%B7%AF%E7%94%B1%E8%AE%A1%E7%AE%97" title="#ospf%E5%9F%9F%E5%86%85%E8%B7%AF%E7%94%B1%E8%AE%A1%E7%AE%97">OSPF域内路由计算</a></li>
<li><a href="#ospf%E5%9F%9F%E9%97%B4%E8%B7%AF%E7%94%B1%E8%AE%A1%E7%AE%97" title="#ospf%E5%9F%9F%E9%97%B4%E8%B7%AF%E7%94%B1%E8%AE%A1%E7%AE%97">OSPF域间路由计算</a></li>
<li><a href="#ospf%E5%A4%96%E9%83%A8%E8%B7%AF%E7%94%B1%E8%AE%A1%E7%AE%97" title="#ospf%E5%A4%96%E9%83%A8%E8%B7%AF%E7%94%B1%E8%AE%A1%E7%AE%97">OSPF外部路由计算</a></li>
<li><a href="#ospf%E7%89%B9%E6%AE%8A%E5%8C%BA%E5%9F%9F" title="#ospf%E7%89%B9%E6%AE%8A%E5%8C%BA%E5%9F%9F">OSPF特殊区域</a></li>
<li><a href="#OSPF%E8%B7%AF%E7%94%B1%E5%8A%A0%E8%A1%A8%E4%BC%98%E5%85%88%E7%BA%A7" title="#OSPF%E8%B7%AF%E7%94%B1%E5%8A%A0%E8%A1%A8%E4%BC%98%E5%85%88%E7%BA%A7">路由加表优先级</a></li>
</ol>
<hr/>
<h3 data-id="heading-2">OSPF报文类型</h3>
<p>OSPF使用五种类型的报文来建立邻接、同步数据库并计算路由。</p>
<ol>
<li>
<p><strong>Hello报文</strong></p>
<ul>
<li><strong>功能</strong>：用于发现、建立并维持邻居关系。包含Router ID、区域ID、接口认证等信息。</li>
<li><strong>组播地址</strong>：<code>224.0.0.5</code>。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3544dd481fbb40bf89eac72a91d75373~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=Bv0Ew21BbWj0JH2A2gUC%2FAahDc4%3D" alt="HELLO报文.png" loading="lazy"/></li>
</ul>
</li>
<li>
<p><strong>数据库描述报文</strong></p>
<ul>
<li>
<p><strong>功能</strong>：</p>
<ol>
<li><strong>选举主从设备</strong>，确保DD报文交换有序。</li>
<li>携带<strong>链路状态数据库摘要</strong>，即LSA头部信息，用于数据库同步。</li>
</ol>
</li>
<li>
<p><strong>特性</strong>：可以包含多个DD报文。携带MTU值，若两端MTU不匹配且开启检测，可能导致邻接建立失败。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad1fb4f069eb4751a31f32b5d3fc1829~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=VlsrHuL0QGsVYAIAuTSW4RCDmWQ%3D" alt="DD报文.png" loading="lazy"/></p>
</li>
<li>
<p><strong>MTU问题</strong>：当MTU不匹配时，邻居状态会卡在<code>ExStart</code>/<code>ExChange</code>。</p>
</li>
</ul>
</li>
<li>
<p><strong>链路状态请求报文</strong></p>
<ul>
<li><strong>功能</strong>：在收到邻居的DD报文后，向对方请求本机缺失或需要更新的<strong>完整LSA信息</strong>。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c72824097b2142ab9a0a70c6ad64e4d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=Yb7RrN%2FVDt5ofbyvc4bbv10VS7Q%3D" alt="LSR报文.png" loading="lazy"/></li>
</ul>
</li>
<li>
<p><strong>链路状态更新报文</strong></p>
<ul>
<li><strong>功能</strong>：用于回复LSR请求，或主动泛洪更新，包含一个或多个<strong>完整的LSA</strong>。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99746a834cff4a56b8bf1fc75e03e96b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=IUTrVN4mGpN6qS1mFx1ZYs1p1eU%3D" alt="LSU报文.png" loading="lazy"/></li>
</ul>
</li>
<li>
<p><strong>链路状态确认报文</strong></p>
<ul>
<li><strong>功能</strong>：对收到的LSU报文进行确认，确保LSA的可靠泛洪。确认信息为LSA头部。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d4b2091ad694e07925e3bb20aa36d5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=Ro3iNQNxX8ou%2FjKUf6zFNQq%2B330%3D" alt="LSACK报文.png" loading="lazy"/></li>
</ul>
</li>
</ol>
<h3 data-id="heading-3">OSPF状态机</h3>
<p>OSPF邻接建立过程经历一系列状态，以下是关键节点：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31b234fe63224beb828954d48b313bcd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=kMxVHj6dXDh9hilRu9T%2BjdVXT9U%3D" alt="DD_state.png" loading="lazy"/></p>
<ol>
<li>
<p><strong>Down -&gt; Init -&gt; 2-Way</strong></p>
<ul>
<li><code>Init</code>：收到对端Hello包，但其中未包含自己的Router ID。</li>
<li><code>2-Way</code>：收到对端Hello包，且其中包含自己的Router ID。<strong>邻居关系</strong>建立。在广播网络中，此时选举DR/BDR。</li>
</ul>
</li>
<li>
<p><strong>2-Way -&gt; ExStart</strong></p>
<ul>
<li>邻居关系建立后，立即进入<code>ExStart</code>状态，通过交换<strong>空的DD报文</strong>（<code>M=1，MS=1</code>）进行<strong>主从选举</strong>。Router ID大者为主。</li>
</ul>
</li>
<li>
<p><strong>ExStart -&gt; Exchange</strong></p>
<ul>
<li><strong>从设备</strong>：在发出第一个携带摘要的DD报文后，状态变为<code>Exchange</code>。</li>
<li><strong>主设备</strong>：在接收到从设备的DD报文并回复自己的DD报文后，状态变为<code>Exchange</code>。双方开始交换完整的数据库摘要。</li>
</ul>
</li>
<li>
<p><strong>Exchange -&gt; Loading</strong></p>
<ul>
<li>摘要交换完成后，双方根据对比结果，向对方发送<strong>LSR</strong>请求缺失的LSA，状态进入<code>Loading</code>。同时，使用<code>LSU</code>和<code>LSACK</code>来传输和确认具体的LSA内容。</li>
</ul>
</li>
<li>
<p><strong>Loading -&gt; Full</strong></p>
<ul>
<li>所有请求的LSA交换并确认完毕后，邻居状态进入<code>Full</code>。<strong>邻接关系</strong>建立完成，可以开始路由计算。</li>
</ul>
</li>
</ol>
<p><strong>总结流程</strong>：寻找邻居(<code>Init</code>) -&gt; 建立邻居(<code>2-Way</code>) -&gt; 选举主从(<code>ExStart</code>) -&gt; 交换摘要(<code>Exchange</code>) -&gt; 请求并加载详细信息(<code>Loading</code>) -&gt; 完全邻接(<code>Full</code>)。</p>
<h3 data-id="heading-4">OSPF确认机制</h3>
<p>OSPF通过多种方式确保报文可靠传递：</p>
<ol>
<li><strong>Hello报文</strong>：周期性发送（默认10秒），通过超时机制（Dead Time，默认40秒）确认邻居存活。</li>
<li><strong>DD报文</strong>：使用<strong>序列号和主从关系进行隐式确认</strong>。
<ul>
<li>从设备使用主设备的序列号发起请求。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e64344cf8f94a97af0067fdbd60c2d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=XWvZX09H0jLkLWenD%2B9%2BTG8M3n4%3D" alt="DDseq隐式确认从.png" loading="lazy"/></li>
<li>主设备以从设备序列号+1进行回复。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e76e270d27da45aead1f4923d490272c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=SDoa22ElPoKVn7v9WS3UyfgNhME%3D" alt="DDseq隐式确认主.png" loading="lazy"/></li>
</ul>
</li>
<li><strong>LSR报文</strong>：通过接收对应的<code>LSU</code>报文进行确认。</li>
<li><strong>LSU报文</strong>：通过接收<code>LSACK</code>报文进行显式确认。若超时未收到确认，则重传。</li>
</ol>
<h3 data-id="heading-5">OSPF邻接关系建立与路由计算问题</h3>
<h4 data-id="heading-6">邻接建立失败常见原因</h4>
<ol>
<li>接口网络类型不一致（如一端为广播，另一端为点对点）。</li>
<li>区域ID不一致。</li>
<li>Router ID冲突。</li>
<li>接口MTU不匹配且开启了检测。</li>
<li>认证类型或密钥不匹配。</li>
<li>Hello/Dead时间间隔不一致。</li>
<li>接口被配置为静默接口。</li>
<li>网络掩码不匹配（仅在广播/NBMA网络中有影响）。</li>
<li>链路层故障。</li>
</ol>
<h4 data-id="heading-7">邻接建立成功但路由计算失败</h4>
<ol>
<li><strong>网络类型不匹配导致LSA缺失</strong>：例如，一端为点对点，另一端为广播。点对点端不产生<strong>2类LSA</strong>，导致广播端设备无法正确计算路由。</li>
<li><strong>静默接口</strong>：接口被静默后，不收发OSPF报文，但该接口所在网段仍会被通告（生成1类LSA）。邻居无法建立，路由自然无法通过该接口计算。</li>
</ol>
<h3 data-id="heading-8">OSPF网络类型</h3>
<p>OSPF接口网络类型决定了其行为方式，特别是邻居发现和DR选举。</p>








































<table><thead><tr><th align="left">网络类型</th><th align="left">默认链路协议</th><th align="left">DR/BDR选举</th><th align="left">Hello/Dead时间</th><th align="left">组播地址</th></tr></thead><tbody><tr><td align="left"><strong>广播</strong></td><td align="left">以太网</td><td align="left"><strong>是</strong></td><td align="left">10s/40s</td><td align="left">224.0.0.5, 224.0.0.6</td></tr><tr><td align="left"><strong>点到点</strong></td><td align="left">PPP/HDLC</td><td align="left"><strong>否</strong></td><td align="left">10s/40s</td><td align="left">224.0.0.5</td></tr><tr><td align="left"><strong>NBMA</strong></td><td align="left">帧中继/ATM</td><td align="left"><strong>是</strong></td><td align="left">30s/120s</td><td align="left"><strong>单播</strong> (需手动指定<code>peer</code>)</td></tr><tr><td align="left"><strong>点到多点</strong></td><td align="left">无默认，常手动配置</td><td align="left"><strong>否</strong></td><td align="left">30s/120s</td><td align="left">Hello: 224.0.0.5; 其他: 单播</td></tr></tbody></table>
<h4 data-id="heading-9">广播网络类型详解</h4>
<p>在广播网络中，DR和BDR的交互至关重要。</p>
<ul>
<li><strong>DR/BDR选举</strong>：基于接口优先级（默认1）和Router ID（越大越优）。优先级为0不参与选举。</li>
<li><strong>通信流程</strong>：
<ul>
<li><code>Drother</code>之间保持<code>2-Way</code>状态。</li>
<li>所有路由器与<code>DR/BDR</code>建立<code>Full</code>状态。</li>
<li>所有路由器向<code>DR</code>和<code>BDR</code>发送组播地址<code>224.0.0.6</code>。</li>
<li><code>DR</code>向所有其他路由器(<code>224.0.0.5</code>)泛洪更新。</li>
</ul>
</li>
<li><strong>交互示例</strong>：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5913eaf5bf944704bae025b06f6d446c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=0JtJt2nbuMUrOnJg6L9LSuhGcLA%3D" alt="拓扑.png" loading="lazy"/>
<ul>
<li><code>Drother</code>更新：发送至<code>224.0.0.6</code> (DR/BDR)。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88a6db69a782492ca5f355a328d5c8d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=1ArD0CAIsJnURXTdOXc%2Fz8L3ymI%3D" alt="R1_update.png" loading="lazy"/></li>
<li><code>DR</code>更新：发送至<code>224.0.0.5</code> (所有OSPF路由器)。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc64a00c86c4491f912ea6d7e1617c84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=M1F1atxJUF8PIrFW%2Fpz%2B3LOBTUQ%3D" alt="R4_update.png" loading="lazy"/></li>
</ul>
</li>
</ul>
<h3 data-id="heading-10">OSPF开销值计算</h3>
<ol>
<li>
<p><strong>计算公式</strong>：<code>接口Cost = 参考带宽 / 接口实际带宽</code>。参考带宽默认为100 Mbps。</p>
<ul>
<li>结果小于1时取1。</li>
<li>最终路径开销是数据传出方向的<strong>沿途出接口Cost累加值</strong>。</li>
</ul>
</li>
<li>
<p><strong>修改方法</strong>：</p>
<ul>
<li><strong>直接修改接口Cost</strong>：<code>[接口视图] ospf cost &lt;值&gt;</code>。</li>
<li><strong>修改参考带宽</strong>：<code>[OSPF视图] bandwidth-reference &lt;值&gt;</code> (<strong>区域内所有路由器需一致</strong>)。</li>
<li>环回接口的默认Cost为0。</li>
</ul>
</li>
<li>
<p><strong>静默接口</strong>：配置后，接口<strong>不收发OSPF报文</strong>，但<strong>其网络仍会被通告</strong>。</p>
<ul>
<li><strong>作用</strong>：常用于避免在特定接口（如连接终端的接口）上建立不必要的邻居关系，或解决次优路径问题。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9400da78199a4cffa2d429f99572f10c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=LmgbbD2%2Fs0kOm77msvPQAsuCElM%3D" alt="静默接口作用.png" loading="lazy"/></li>
<li><strong>配置</strong>：
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 黑名单模式（推荐）</span>
[ospf-1] silent-interface GigabitEthernet 0/0
<span class="hljs-comment"># 白名单模式</span>
[ospf-1] silent-interface all
[ospf-1] undo silent-interface GigabitEthernet 0/1
</code></pre>
</li>
</ul>
</li>
</ol>
<h3 data-id="heading-11">链路状态数据库与LSA</h3>
<p><strong>LSDB同步原则</strong>：</p>
<ul>
<li><strong>触发更新</strong>：当链路状态发生变化时。</li>
<li><strong>周期更新</strong>：每条LSA的老化时间(<code>Age</code>)达到1800秒时，始发路由器会重新泛洪一次，刷新<code>Age</code>。最大<code>Age</code>为3600秒。</li>
</ul>
<h4 data-id="heading-12">LSA头部与三要素</h4>
<p>所有LSA拥有公共的头部，其中关键字段包括：</p>
<ul>
<li><strong>LS Type</strong>：LSA类型。</li>
<li><strong>Link State ID</strong>：LSA标识符。</li>
<li><strong>Advertising Router</strong>：始发路由器Router ID。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fc16c8fd3c94a5f8a66b75d51b27f41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=f1nov8FnZc9dD%2F0WLGBk82tAblE%3D" alt="LSA头部信息.png" loading="lazy"/>
<strong>LSA三要素</strong>：<code>LS Type</code> + <code>Link State ID</code> + <code>Advertising Router</code> 共同<strong>唯一标识</strong>一条LSA。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d372fbe25c84e52b7014b7050d2cb61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=ASH3tKAYc7Q1EKw3LSPWaueyAXs%3D" alt="LSA标识.png" loading="lazy"/></li>
</ul>
<h3 data-id="heading-13">OSPF域内路由计算</h3>
<p><strong>路由器使用SPF算法，以自己为根，计算到达所有网络的最短路径树。</strong></p>
<h4 data-id="heading-14">1类LSA</h4>
<ul>
<li><strong>功能</strong>：描述<strong>路由器自身</strong>的直连链路状态，并标识自身角色（如ABR、ASBR）。</li>
<li><strong>内容</strong>：
<ul>
<li><strong>StubNet Link</strong>：描述一条直连路由（<strong>叶子</strong>）。包含网络号、掩码和开销。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bf8a29509c445af92639f775eacb126~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=WZ4j1CY5VbXCsbxAU2ZtTenI9Hg%3D" alt="1类LS信息.png" loading="lazy"/></li>
<li><strong>P-2-P Link</strong>：描述一个点对点邻居（<strong>树干</strong>）。包含邻居Router ID、本地接口IP和开销。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/248fbea6159c457da8b0d931df14d8d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=33EYf%2BAsWYzyuSnWqulP7ewgxFU%3D" alt="1类LS信息-邻居.png" loading="lazy"/></li>
</ul>
</li>
</ul>
<h4 data-id="heading-15">2类LSA</h4>
<ul>
<li><strong>产生条件</strong>：仅在<strong>广播或NBMA</strong>网络中，由<strong>DR</strong>产生。</li>
<li><strong>功能</strong>：描述一个<strong>伪节点</strong>，代表该多路访问网络本身。包含该网络掩码和所有连接到此DR的路由器列表（Attached Router）。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e540647e7a34845b6921d16965d04a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=53qSPK2u16yITj1Ep1yd%2BRHwa4I%3D" alt="TransNet.png" loading="lazy"/></li>
<li><strong>伪节点的Cost为0</strong>。1类和2类LSA仅在<strong>区域内</strong>泛洪。</li>
</ul>
<h3 data-id="heading-16">OSPF域间路由计算</h3>
<h4 data-id="heading-17">区域设计原则</h4>
<ol>
<li>骨干区域（Area 0）必须存在且唯一。</li>
<li>所有非骨干区域必须与骨干区域直接相连。</li>
</ol>
<h4 data-id="heading-18">3类LSA</h4>
<ul>
<li><strong>产生者</strong>：<strong>区域边界路由器</strong>。</li>
<li><strong>功能</strong>：描述<strong>域间路由</strong>信息。ABR将一个区域内的最优路由（由1/2类LSA计算得出）转换为3类LSA，泛洪到其他区域。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/935b35d736d447f8a10fd1a0ad95ea05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=YlsFx79n5cluE4lHaBZ5XYbUM2Y%3D" alt="三类LSA.png" loading="lazy"/></li>
<li><strong>关键规则（防环）</strong>：
<ol>
<li>ABR<strong>不会</strong>将非骨干区域的3类LSA注入骨干区域。</li>
<li>ABR<strong>只将骨干区域的3类LSA</strong>注入非骨干区域。</li>
<li>区域内路由（1/2类）优先级高于域间路由（3类），即使后者Cost更优。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-19">ABR</h4>
<ul>
<li><strong>定义</strong>：连接多个区域，且在骨干区域至少有一个活跃接口的路由器。</li>
<li><strong>功能</strong>：汇总并传递3类LSA。其1类LSA中<code>B-bit</code>（Border位）被置位，标识其ABR身份。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a888ee794c1c4216b6ba81aa6f4c4c29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=udMWC%2FMqtN5sbaRjfVDS9AV9Sl8%3D" alt="ABR标识.png" loading="lazy"/></li>
</ul>
<h4 data-id="heading-20">虚链路</h4>
<ul>
<li><strong>作用</strong>：
<ol>
<li>将非骨干区域逻辑连接到骨干区域（解决区域0被分割问题）。</li>
<li>提供一条经过非骨干区域的骨干区域路径（优化Cost）。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/466f9f29c17c444e8f75e6b60030e0ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=x4sBcBMGf6e2886cdRxOrrorXLY%3D" alt="优化路径.png" loading="lazy"/></li>
</ol>
</li>
<li><strong>限制</strong>：只能穿越一个非骨干区域，且不能穿越特殊区域。</li>
</ul>
<h3 data-id="heading-21">OSPF外部路由计算</h3>
<h4 data-id="heading-22">5类LSA</h4>
<ul>
<li><strong>产生者</strong>：<strong>自治系统边界路由器</strong>。</li>
<li><strong>功能</strong>：描述<strong>引入到OSPF的外部路由</strong>（如静态路由、直连路由或其他协议路由）。在整个OSPF域内泛洪。</li>
<li><strong>关键字段</strong>：
<ul>
<li><strong>E Type</strong>：开销值类型。
<ul>
<li><strong>Type 1</strong>：外部开销 + 内部到达ASBR的开销。<code>总开销 = 种子度量值 + 内部开销</code>。</li>
<li><strong>Type 2（默认）</strong>：仅考虑外部种子度量值。<code>总开销 = 种子度量值</code>。</li>
</ul>
</li>
<li><strong>Forwarding Address</strong>：转发地址。若非0.0.0.0，则数据包直接发往FA地址而非ASBR，用于优化路径。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97122f6da35a49b88b50f18a14d2f280~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=zI89817FN5luIu6MmnQtE9XtK00%3D" alt="ospf_import.png" loading="lazy"/></li>
</ul>
</li>
</ul>
<h4 data-id="heading-23">4类LSA</h4>
<ul>
<li><strong>产生者</strong>：<strong>ABR</strong>。</li>
<li><strong>功能</strong>：描述<strong>如何到达ASBR</strong>。当ASBR不在本区域时，ABR会生成4类LSA，指明到达该ASBR的路径和开销。</li>
<li><strong>关系</strong>：<strong>有5类LSA不一定有4类LSA</strong>（ASBR在同一个区域时，无需4类LSA）。<strong>有4类LSA一定有5类LSA</strong>。</li>
</ul>
<h4 data-id="heading-24">默认路由注入</h4>
<ul>
<li>在ASBR上配置<code>default-route-advertise</code>，可将缺省路由以5类LSA形式注入OSPF域。</li>
<li>使用<code>always</code>参数，即使本机路由表无默认路由，也会强制下发。</li>
</ul>
<h3 data-id="heading-25">OSPF特殊区域</h3>
<p>用于减少非骨干区域内的LSA数量，优化设备性能。主要通过过滤特定LSA实现。</p>









































<table><thead><tr><th align="left">区域类型</th><th align="left">功能描述</th><th align="left">泛洪的LSA类型</th><th align="left">ABR下发的缺省路由类型</th></tr></thead><tbody><tr><td align="left"><strong>骨干区域/普通区域</strong></td><td align="left">标准区域，泛洪所有LSA</td><td align="left">1, 2, 3, 4, 5</td><td align="left">无</td></tr><tr><td align="left"><strong>Stub区域</strong></td><td align="left">过滤4、5类LSA</td><td align="left">1, 2, 3</td><td align="left"><strong>3类LSA</strong> (自动)</td></tr><tr><td align="left"><strong>Totally Stub区域</strong></td><td align="left">过滤3, 4, 5类LSA</td><td align="left">1, 2</td><td align="left"><strong>3类LSA</strong> (自动)</td></tr><tr><td align="left"><strong>NSSA区域</strong></td><td align="left">过滤4、5类LSA，但允许引入外部路由(以7类LSA形式)</td><td align="left">1, 2, 3, <strong>7</strong></td><td align="left"><strong>7类LSA</strong> (通常需手动<code>default-route-advertise</code>)</td></tr><tr><td align="left"><strong>Totally NSSA区域</strong></td><td align="left">过滤3, 4, 5类LSA，允许引入外部路由(7类)</td><td align="left">1, 2, <strong>7</strong></td><td align="left"><strong>3类LSA</strong> (自动) &amp; <strong>7类LSA</strong></td></tr></tbody></table>
<h4 data-id="heading-26">关键特性对比</h4>
<ul>
<li><strong>Option字段</strong>：
<ul>
<li><code>E-bit</code>：处理<strong>5类LSA</strong>能力。Stub和NSSA区域该位为0。</li>
<li><code>N-bit</code>：处理<strong>7类LSA</strong>能力。仅NSSA区域该位为1。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ade331a4cda4f719a1d21d219b190ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=EcmNPLVTzgvJcPxIZmtm881Bo0I%3D" alt="NSSA_HELLO报文.png" loading="lazy"/></li>
</ul>
</li>
<li><strong>7类LSA</strong>：
<ul>
<li>仅在NSSA区域内泛洪。</li>
<li>由NSSA区域的<strong>ABR</strong>转换为5类LSA后，泛洪到其他区域。通常由Router ID最大的ABR执行转换。</li>
<li>FA地址通常不为0，以优化路径。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2909085448bb4ef8b06f3c62ecf8e685~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=%2BjhXfteyok2aVJx%2FLBs5FSmptm4%3D" alt="7类LSA.png" loading="lazy"/></li>
</ul>
</li>
<li><strong>多ABR问题</strong>：Stub/NSSA区域存在多个ABR时，每个ABR都会下发缺省路由，可能导致区域内设备负载分担，引发次优路径。需通过调整接口Cost、缺省路由Cost或路由策略进行干预。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe0561e9d8d241f6ae82834c3789db83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5YGa6I-c6bif55qE572R5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771077389&amp;x-signature=F%2BHlUSrrAzKab9umdLzPJiuU2Gk%3D" alt="Stub次优路径问题.png" loading="lazy"/></li>
</ul>
<h3 data-id="heading-27">OSPF路由加表优先级</h3>
<p>域内路由 &gt; 域间路由 &gt; 外部路由Type1 &gt; 外部路由Type2 &gt; NSSA区域外部路由Type1 &gt; NSSA区域外部路由Type2</p>
<p>相同优先级，比开销。如果开销一直，则进行<strong>等价多路径</strong>负载均衡（默认最多4条）。</p>
<hr/>
<h2 data-id="heading-28">MTU不一致会导致OSPF协商失败，什么场景要改MTU？</h2>
<p><strong>问题现象</strong>：如标题所述，当OSPF接口MTU不匹配且开启检测时，邻居状态会卡在<code>ExStart</code>或<code>ExChange</code>，导致邻接无法建立。</p>
<p><strong>问题根源</strong>：OSPF在ExStart状态交换DD报文进行主从选举时，报文中会携带本接口的MTU值。如果对端接口的MTU值小于此值，且开启MTU检测（某些厂商默认开启，如思科；华为/华三默认不检测），对端将拒绝处理此报文，导致协商失败。</p>
<p><strong>那么，什么情况下我们需要主动修改接口的MTU值？</strong></p>
<p><strong>核心场景：隧道封装</strong>。这是最常见且最重要的原因，如<strong>GRE隧道</strong>场景。</p>
<ol>
<li>
<p><strong>原理分析</strong>：</p>
<ul>
<li>标准以太网的<strong>MTU默认是1500字节</strong>，这意味着一个数据帧所能承载的IP报文最大为1500字节。</li>
<li>当我们在两个站点间建立<strong>GRE隧道</strong>时，原始IP报文（假设正好1500字节）会被封装上新的<strong>GRE头部</strong>和<strong>外层IP头部</strong>。这使得报文总长度<strong>超过了1500字节</strong>。</li>
<li>当这个“变胖”的报文被发送到物理接口（MTU=1500）时，接口会发现它超出了自己的MTU限制，从而触发<strong>IP分片</strong>。报文被拆分成多个片段传输。</li>
</ul>
</li>
<li>
<p><strong>分片带来的危害</strong>（为什么需要优化）：</p>
<ul>
<li><strong>性能下降</strong>：分片和重组需要消耗CPU和内存资源。</li>
<li><strong>可靠性降低</strong>：任何一个分片丢失，整个原始报文都需要重传，增加了丢包率和网络延迟。</li>
<li><strong>潜在兼容性问题</strong>：某些网络设备或安全策略可能阻止分片报文。</li>
</ul>
</li>
<li>
<p><strong>解决方案</strong>：</p>
<ul>
<li>为了<strong>避免隧道报文在传输过程中被分片</strong>，常见的优化手段是<strong>调小隧道接口及路径上相关物理接口的MTU值</strong>。</li>
<li><strong>调整方法</strong>：将隧道接口及其底层物理接口的MTU值设置为 <code>1500 - (隧道封装开销)</code>。对于GRE over IP，开销通常是24字节（新IP头20字节 + GRE头4字节），因此MTU常设置为 <strong>1476</strong>。
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 例如，在物理接口和隧道接口上均进行设置</span>
[H3C-GigabitEthernet0/1] mtu 1476
[H3C-Tunnel0] mtu 1476
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>对其他隧道类型的延伸</strong>：</p>
<ul>
<li><strong>IPsec VPN</strong>：封装开销更大（ESP隧道模式通常增加约50-60字节），因此需要设置更小的MTU（如1400）。</li>
<li><strong>VXLAN</strong>：封装开销巨大（超过50字节），在数据中心Underlay网络中需要将MTU设置为<strong>1600</strong>或更高（通常称为“巨型帧”），以容纳封装后的报文。</li>
</ul>
</li>
</ol>
<p><strong>结论</strong>：
在部署GRE、IPsec、VXLAN等隧道技术时，<strong>预先规划和统一配置隧道路径上所有设备的MTU值，是保证网络稳定性和性能的最佳实践</strong>。这也解释了为什么在某些网络环境中，我们需要关注并调整OSPF接口的MTU，它不仅是OSPF邻接建立的一个检查项，更是整个网络数据平面能否高效转发的基础。当OSPF运行在隧道接口上时，确保隧道两端MTU一致且大小合理，就尤为关键。</p>
<h2 data-id="heading-29">为什么OSPF外部路由引入开销默认Type2?</h2>
<p>大多数情况下，广域网（外部）的链路开销非常大，而局域网内部（OSPF 域内）的开销相对微乎其微。因此，OSPF 默认使用 Type 2，这样路由表看起来更简洁，不需要因为内部链路的微小波动而频繁更新外部路由。</p>
<hr/>
<p><em>笔记内容排版经过AI优化。如有问题，感谢指正。内容仅供参考，请仔细甄别。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入浏览器指纹：Canvas、WebGL、Audio是如何暴露你的身份的？]]></title>    <link>https://juejin.cn/post/7603674653153214473</link>    <guid>https://juejin.cn/post/7603674653153214473</guid>    <pubDate>2026-02-08T02:36:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603674653153214473" data-draft-id="7603627478021406730" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入浏览器指纹：Canvas、WebGL、Audio是如何暴露你的身份的？"/> <meta itemprop="keywords" content="前端,Canvas,浏览器"/> <meta itemprop="datePublished" content="2026-02-08T02:36:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iDao技术魔方"/> <meta itemprop="url" content="https://juejin.cn/user/166781496080782"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入浏览器指纹：Canvas、WebGL、Audio是如何暴露你的身份的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/166781496080782/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iDao技术魔方
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T02:36:26.000Z" title="Sun Feb 08 2026 02:36:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>你以为清除了Cookie就安全了？2025年约翰霍普金斯大学的研究首次证实：浏览器指纹追踪比你想象的更普遍，而且你几乎无法阻止它。</p>
</blockquote>
<h2 data-id="heading-0">📋 目录</h2>
<ul>
<li><a href="#%E8%83%8C%E6%99%AFcookie%E6%97%B6%E4%BB%A3%E7%9A%84%E7%BB%88%E7%BB%93" title="#%E8%83%8C%E6%99%AFcookie%E6%97%B6%E4%BB%A3%E7%9A%84%E7%BB%88%E7%BB%93">背景：Cookie时代的终结</a></li>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%B5%8F%E8%A7%88%E5%99%A8%E6%8C%87%E7%BA%B9" title="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%B5%8F%E8%A7%88%E5%99%A8%E6%8C%87%E7%BA%B9">什么是浏览器指纹？</a></li>
<li><a href="#canvas%E6%8C%87%E7%BA%B9%E5%83%8F%E7%B4%A0%E7%9A%84%E7%A7%98%E5%AF%86" title="#canvas%E6%8C%87%E7%BA%B9%E5%83%8F%E7%B4%A0%E7%9A%84%E7%A7%98%E5%AF%86">Canvas指纹：像素的秘密</a></li>
<li><a href="#webgl%E6%8C%87%E7%BA%B9gpu%E7%9A%84%E6%8C%87%E7%BA%B9" title="#webgl%E6%8C%87%E7%BA%B9gpu%E7%9A%84%E6%8C%87%E7%BA%B9">WebGL指纹：GPU的指纹</a></li>
<li><a href="#audio%E6%8C%87%E7%BA%B9%E5%A3%B0%E9%9F%B3%E9%87%8C%E7%9A%84%E8%BA%AB%E4%BB%BD" title="#audio%E6%8C%87%E7%BA%B9%E5%A3%B0%E9%9F%B3%E9%87%8C%E7%9A%84%E8%BA%AB%E4%BB%BD">Audio指纹：声音里的身份</a></li>
<li><a href="#%E5%85%B6%E4%BB%96%E6%8C%87%E7%BA%B9%E7%BB%B4%E5%BA%A6" title="#%E5%85%B6%E4%BB%96%E6%8C%87%E7%BA%B9%E7%BB%B4%E5%BA%A6">其他指纹维度</a></li>
<li><a href="#%E5%8F%8D%E6%8C%87%E7%BA%B9%E6%8A%80%E6%9C%AF%E7%8E%B0%E4%BB%A3%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E9%98%B2%E5%BE%A1" title="#%E5%8F%8D%E6%8C%87%E7%BA%B9%E6%8A%80%E6%9C%AF%E7%8E%B0%E4%BB%A3%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E9%98%B2%E5%BE%A1">反指纹技术：现代浏览器的防御</a></li>
<li><a href="#%E5%AE%9E%E6%88%98%E7%94%A8%E5%BC%80%E6%BA%90%E5%BA%93%E7%94%9F%E6%88%90%E4%BD%A0%E7%9A%84%E6%8C%87%E7%BA%B9" title="#%E5%AE%9E%E6%88%98%E7%94%A8%E5%BC%80%E6%BA%90%E5%BA%93%E7%94%9F%E6%88%90%E4%BD%A0%E7%9A%84%E6%8C%87%E7%BA%B9">实战：用开源库生成你的指纹</a></li>
<li><a href="#%E6%80%BB%E7%BB%93%E4%B8%8E%E6%80%9D%E8%80%83" title="#%E6%80%BB%E7%BB%93%E4%B8%8E%E6%80%9D%E8%80%83">总结与思考</a></li>
</ul>
<hr/>
<h2 data-id="heading-1">背景：Cookie时代的终结</h2>
<p>还记得那些年困扰我们的Cookie弹窗吗？</p>
<p>"本网站使用Cookie改善您的体验"——然后给你两个选项：一个巨大的"接受所有Cookie"按钮，和一个藏在角落里的"拒绝"链接。这就是所谓的"暗模式"（Dark Pattern），专门用来诱导用户同意追踪。</p>
<p>好消息是，这个时代正在落幕。Chrome、Firefox、Safari都在逐步默认阻止第三方Cookie。但坏消息是——<strong>广告商们找到了更隐蔽的武器：浏览器指纹</strong>。</p>
<p>浏览器指纹最大的特点是：<strong>你无法删除它，甚至无法感知它</strong>。它就像你在互联网上留下的无形签名，无论你如何清理浏览数据，它都能把你认出来。</p>
<p>2025年2月，约翰霍普金斯大学和德州农工大学的研究团队发布了论文《The First Early Evidence of the Use of Browser Fingerprinting for Online Tracking》，<strong>首次实证证实了浏览器指纹被广泛用于广告追踪</strong>。研究团队通过FPTrace框架发现，改变指纹后广告竞价出现了显著差异，直接证明了指纹与广告定向的关联。</p>
<p>更讽刺的是，2025年3月，Google修改了隐私政策，<strong>允许在Privacy Sandbox中使用浏览器指纹技术</strong>。这意味着连倡导"隐私保护"的科技巨头，也在拥抱这种技术。</p>
<hr/>
<h2 data-id="heading-2">什么是浏览器指纹？</h2>
<p>简单来说，浏览器指纹就是通过收集浏览器和设备的多种特征信息，生成一个几乎唯一的标识符。这些特征包括但不限于：</p>























































<table><thead><tr><th>特征类别</th><th>具体信息</th><th>熵值贡献</th></tr></thead><tbody><tr><td><strong>User Agent</strong></td><td>浏览器版本、操作系统</td><td>中等</td></tr><tr><td><strong>屏幕信息</strong></td><td>分辨率、颜色深度、可用分辨率</td><td>低</td></tr><tr><td><strong>时区语言</strong></td><td>时区偏移、首选语言</td><td>低</td></tr><tr><td><strong>字体列表</strong></td><td>已安装字体</td><td><strong>极高</strong></td></tr><tr><td><strong>插件信息</strong></td><td>浏览器插件列表</td><td>中等</td></tr><tr><td><strong>Canvas</strong></td><td>2D渲染像素差异</td><td><strong>极高</strong></td></tr><tr><td><strong>WebGL</strong></td><td>GPU型号、渲染器信息</td><td><strong>极高</strong></td></tr><tr><td><strong>Audio</strong></td><td>音频处理特征</td><td>高</td></tr><tr><td><strong>Hardware</strong></td><td>内存、CPU核心数</td><td>中等</td></tr></tbody></table>
<p><strong>根据EFF的Panopticlick研究，在100万个样本中，94.2%的浏览器指纹都是唯一的。</strong></p>
<p>打个比方：如果把User Agent比作你的名字，Canvas指纹就是你的笔迹，WebGL指纹是你的DNA——前者很容易伪造，后者几乎无法复制。</p>
<hr/>
<h2 data-id="heading-3">Canvas指纹：像素的秘密</h2>
<h3 data-id="heading-4">原理剖析</h3>
<p>Canvas指纹是浏览器指纹中最成熟、最稳定的技术之一。它的核心思想非常简单：<strong>让浏览器在Canvas上绘制特定内容，然后读取像素数据，不同浏览器/设备产生的像素差异就是指纹</strong>。</p>
<p>为什么会产生差异？主要原因包括：</p>
<ol>
<li><strong>显卡驱动差异</strong>：不同GPU渲染相同的图形会有细微差异</li>
<li><strong>操作系统差异</strong>：Windows、macOS、Linux的字体渲染引擎不同</li>
<li><strong>浏览器差异</strong>：Chrome、Firefox、Safari的Canvas实现有差异</li>
<li><strong>抗锯齿算法</strong>：不同浏览器使用不同的抗锯齿策略</li>
</ol>
<h3 data-id="heading-5">实战代码</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getCanvasFingerprint</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>);
  <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
  
  <span class="hljs-comment">// 设置画布大小</span>
  canvas.<span class="hljs-property">width</span> = <span class="hljs-number">200</span>;
  canvas.<span class="hljs-property">height</span> = <span class="hljs-number">50</span>;
  
  <span class="hljs-comment">// 绘制背景</span>
  ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'#f60'</span>;
  ctx.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">200</span>, <span class="hljs-number">50</span>);
  
  <span class="hljs-comment">// 绘制文字 - 关键！字体和抗锯齿会产生差异</span>
  ctx.<span class="hljs-property">textBaseline</span> = <span class="hljs-string">'alphabetic'</span>;
  ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'#069'</span>;
  ctx.<span class="hljs-property">font</span> = <span class="hljs-string">'16px "Times New Roman"'</span>;
  ctx.<span class="hljs-title function_">fillText</span>(<span class="hljs-string">'FingerprintJS 🤓'</span>, <span class="hljs-number">10</span>, <span class="hljs-number">30</span>);
  
  <span class="hljs-comment">// 绘制复杂图形 - 增加熵值</span>
  ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'#06f'</span>;
  ctx.<span class="hljs-title function_">arc</span>(<span class="hljs-number">150</span>, <span class="hljs-number">25</span>, <span class="hljs-number">15</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>);
  ctx.<span class="hljs-title function_">stroke</span>();
  
  <span class="hljs-comment">// 获取像素数据并哈希</span>
  <span class="hljs-keyword">const</span> data = canvas.<span class="hljs-title function_">toDataURL</span>(<span class="hljs-string">'image/png'</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">hashString</span>(data); <span class="hljs-comment">// 生成哈希值作为指纹</span>
}
</code></pre>
<h3 data-id="heading-6">真实案例</h3>
<p><strong>fingerprintjs</strong>（GitHub 26.4k stars）的Canvas实现更加复杂：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 来自 fingerprintjs/src/sources/canvas.ts</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderTextImage</span>(<span class="hljs-params">canvas, context</span>) {
  <span class="hljs-comment">// 绘制多行文字，使用多种字体和emoji</span>
  <span class="hljs-keyword">const</span> text = <span class="hljs-string">'Cwm fjordbank glyphs vext quiz 😃'</span>;
  context.<span class="hljs-property">font</span> = <span class="hljs-string">'14px Arial'</span>;
  context.<span class="hljs-title function_">fillText</span>(text, <span class="hljs-number">2</span>, <span class="hljs-number">20</span>);
  
  <span class="hljs-comment">// 绘制几何图形</span>
  context.<span class="hljs-title function_">beginPath</span>();
  context.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">100</span>, <span class="hljs-number">5</span>);
  context.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">120</span>, <span class="hljs-number">35</span>);
  context.<span class="hljs-title function_">stroke</span>();
}

<span class="hljs-comment">// 关键：检测Canvas Farbling（噪声注入）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isCanvasStable</span>(<span class="hljs-params">canvas</span>) {
  <span class="hljs-keyword">const</span> img1 = canvas.<span class="hljs-title function_">toDataURL</span>();
  <span class="hljs-keyword">const</span> img2 = canvas.<span class="hljs-title function_">toDataURL</span>();
  <span class="hljs-keyword">return</span> img1 === img2; <span class="hljs-comment">// Brave等浏览器会注入噪声，两次读取结果不同</span>
}
</code></pre>
<h3 data-id="heading-7">为什么难以防御？</h3>
<p>Canvas指纹的可怕之处在于它利用了<strong>合法的Web API</strong>。网站可以说"我只是想画个图表"，实际上却在偷取你的指纹。你无法完全禁用Canvas，否则大量网站（包括图表库、游戏、视频编辑）都会失效。</p>
<hr/>
<h2 data-id="heading-8">WebGL指纹：GPU的指纹</h2>
<p>如果说Canvas指纹是"笔迹"，那WebGL指纹就是"DNA检测"——它直接读取你的显卡型号和驱动信息。</p>
<h3 data-id="heading-9">原理剖析</h3>
<p>WebGL（Web Graphics Library）是浏览器中的3D图形API。它的指纹信息主要来源：</p>
<ol>
<li><strong>GPU型号</strong>：通过<code>WEBGL_debug_renderer_info</code>扩展获取真实的显卡型号</li>
<li><strong>渲染管道差异</strong>：不同GPU执行相同的着色器程序会产生细微差异</li>
<li><strong>扩展支持</strong>：不同的GPU支持不同的WebGL扩展</li>
<li><strong>参数限制</strong>：<code>MAX_TEXTURE_SIZE</code>、<code>MAX_VIEWPORT_DIMS</code>等参数</li>
</ol>
<h3 data-id="heading-10">实战代码</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getWebGLFingerprint</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>);
  <span class="hljs-keyword">const</span> gl = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'webgl'</span>) || canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'experimental-webgl'</span>);
  
  <span class="hljs-keyword">if</span> (!gl) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  
  <span class="hljs-keyword">const</span> result = [];
  
  <span class="hljs-comment">// 基础参数</span>
  result.<span class="hljs-title function_">push</span>(<span class="hljs-string">'vendor:'</span> + gl.<span class="hljs-title function_">getParameter</span>(gl.<span class="hljs-property">VENDOR</span>));
  result.<span class="hljs-title function_">push</span>(<span class="hljs-string">'renderer:'</span> + gl.<span class="hljs-title function_">getParameter</span>(gl.<span class="hljs-property">RENDERER</span>));
  result.<span class="hljs-title function_">push</span>(<span class="hljs-string">'version:'</span> + gl.<span class="hljs-title function_">getParameter</span>(gl.<span class="hljs-property">VERSION</span>));
  result.<span class="hljs-title function_">push</span>(<span class="hljs-string">'shadingLanguageVersion:'</span> + gl.<span class="hljs-title function_">getParameter</span>(gl.<span class="hljs-property">SHADING_LANGUAGE_VERSION</span>));
  
  <span class="hljs-comment">// 关键：获取真实的GPU信息（如果扩展可用）</span>
  <span class="hljs-keyword">const</span> debugInfo = gl.<span class="hljs-title function_">getExtension</span>(<span class="hljs-string">'WEBGL_debug_renderer_info'</span>);
  <span class="hljs-keyword">if</span> (debugInfo) {
    result.<span class="hljs-title function_">push</span>(<span class="hljs-string">'unmaskedVendor:'</span> + gl.<span class="hljs-title function_">getParameter</span>(debugInfo.<span class="hljs-property">UNMASKED_VENDOR_WEBGL</span>));
    result.<span class="hljs-title function_">push</span>(<span class="hljs-string">'unmaskedRenderer:'</span> + gl.<span class="hljs-title function_">getParameter</span>(debugInfo.<span class="hljs-property">UNMASKED_RENDERER_WEBGL</span>));
  }
  
  <span class="hljs-comment">// 能力参数 - 这些因GPU而异</span>
  result.<span class="hljs-title function_">push</span>(<span class="hljs-string">'maxTextureSize:'</span> + gl.<span class="hljs-title function_">getParameter</span>(gl.<span class="hljs-property">MAX_TEXTURE_SIZE</span>));
  result.<span class="hljs-title function_">push</span>(<span class="hljs-string">'maxViewportDims:'</span> + gl.<span class="hljs-title function_">getParameter</span>(gl.<span class="hljs-property">MAX_VIEWPORT_DIMS</span>));
  result.<span class="hljs-title function_">push</span>(<span class="hljs-string">'maxVertexAttribs:'</span> + gl.<span class="hljs-title function_">getParameter</span>(gl.<span class="hljs-property">MAX_VERTEX_ATTRIBS</span>));
  
  <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">join</span>(<span class="hljs-string">'|'</span>);
}
</code></pre>
<h3 data-id="heading-11">高级技术：WebGL渲染指纹</h3>
<p>除了基础参数，还可以通过实际渲染来生成指纹：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 来自beefproject/beef的WebGL指纹实现</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getAdvancedWebGLFingerprint</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>);
  <span class="hljs-keyword">const</span> gl = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'webgl'</span>);
  
  <span class="hljs-comment">// 创建着色器程序</span>
  <span class="hljs-keyword">const</span> vShader = gl.<span class="hljs-title function_">createShader</span>(gl.<span class="hljs-property">VERTEX_SHADER</span>);
  gl.<span class="hljs-title function_">shaderSource</span>(vShader, <span class="hljs-string">`
    attribute vec2 attrVertex;
    void main() {
      gl_Position = vec4(attrVertex, 0.0, 1.0);
    }
  `</span>);
  gl.<span class="hljs-title function_">compileShader</span>(vShader);
  
  <span class="hljs-keyword">const</span> fShader = gl.<span class="hljs-title function_">createShader</span>(gl.<span class="hljs-property">FRAGMENT_SHADER</span>);
  gl.<span class="hljs-title function_">shaderSource</span>(fShader, <span class="hljs-string">`
    precision mediump float;
    void main() {
      gl_FragColor = vec4(0.5, 0.5, 0.5, 1.0);
    }
  `</span>);
  gl.<span class="hljs-title function_">compileShader</span>(fShader);
  
  <span class="hljs-comment">// 链接着色器并绘制</span>
  <span class="hljs-keyword">const</span> program = gl.<span class="hljs-title function_">createProgram</span>();
  gl.<span class="hljs-title function_">attachShader</span>(program, vShader);
  gl.<span class="hljs-title function_">attachShader</span>(program, fShader);
  gl.<span class="hljs-title function_">linkProgram</span>(program);
  gl.<span class="hljs-title function_">useProgram</span>(program);
  
  <span class="hljs-comment">// 读取像素 - 不同GPU渲染结果有细微差异</span>
  <span class="hljs-keyword">const</span> pixels = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-number">4</span>);
  gl.<span class="hljs-title function_">readPixels</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, gl.<span class="hljs-property">RGBA</span>, gl.<span class="hljs-property">UNSIGNED_BYTE</span>, pixels);
  
  <span class="hljs-keyword">return</span> pixels.<span class="hljs-title function_">join</span>(<span class="hljs-string">','</span>);
}
</code></pre>
<h3 data-id="heading-12">为什么WebGL指纹如此强大？</h3>
<p><strong>1. 唯一性极高</strong>：GPU型号+驱动版本的组合几乎是唯一的
<strong>2. 难以伪造</strong>：除非使用虚拟机或模拟器，否则无法欺骗真实的GPU
<strong>3. 跨会话稳定</strong>：除非更换显卡或驱动，否则指纹基本不变</p>
<p><strong>但有个致命弱点</strong>：某些浏览器（如Tor Browser）完全禁用WebGL，或者某些隐私插件会拦截<code>WEBGL_debug_renderer_info</code>扩展。</p>
<hr/>
<h2 data-id="heading-13">Audio指纹：声音里的身份</h2>
<p>如果说Canvas和WebGL是"视觉指纹"，那Audio指纹就是"听觉指纹"——通过音频处理管道的微小差异来识别设备。</p>
<h3 data-id="heading-14">原理剖析</h3>
<p>Audio指纹的原理是利用AudioContext API：</p>
<ol>
<li>创建一个离线的AudioContext</li>
<li>生成一个特定的音频信号（通常是正弦波或压缩信号）</li>
<li>通过音频处理节点（如DynamicsCompressorNode）</li>
<li>读取处理后的音频样本</li>
<li>不同设备的音频处理硬件和软件会导致微小的差异</li>
</ol>
<p>为什么会产生差异？</p>
<ul>
<li><strong>采样率转换</strong>：不同系统使用不同的重采样算法</li>
<li><strong>浮点精度</strong>：CPU处理浮点运算的精度差异</li>
<li><strong>音频驱动</strong>：操作系统音频驱动层的实现差异</li>
</ul>
<h3 data-id="heading-15">实战代码</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getAudioFingerprint</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title class_">AudioContext</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">OfflineAudioContext</span> || <span class="hljs-variable language_">window</span>.<span class="hljs-property">webkitOfflineAudioContext</span>;
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">AudioContext</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    
    <span class="hljs-comment">// 创建离线音频上下文</span>
    <span class="hljs-keyword">const</span> context = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AudioContext</span>(<span class="hljs-number">1</span>, <span class="hljs-number">44100</span>, <span class="hljs-number">44100</span>);
    
    <span class="hljs-comment">// 创建振荡器（音源）</span>
    <span class="hljs-keyword">const</span> oscillator = context.<span class="hljs-title function_">createOscillator</span>();
    oscillator.<span class="hljs-property">type</span> = <span class="hljs-string">'triangle'</span>;
    oscillator.<span class="hljs-property">frequency</span>.<span class="hljs-title function_">setValueAtTime</span>(<span class="hljs-number">10000</span>, <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 创建压缩器 - 关键！不同设备的压缩算法有差异</span>
    <span class="hljs-keyword">const</span> compressor = context.<span class="hljs-title function_">createDynamicsCompressor</span>();
    compressor.<span class="hljs-property">threshold</span>.<span class="hljs-title function_">setValueAtTime</span>(-<span class="hljs-number">50</span>, <span class="hljs-number">0</span>);
    compressor.<span class="hljs-property">knee</span>.<span class="hljs-title function_">setValueAtTime</span>(<span class="hljs-number">40</span>, <span class="hljs-number">0</span>);
    compressor.<span class="hljs-property">ratio</span>.<span class="hljs-title function_">setValueAtTime</span>(<span class="hljs-number">12</span>, <span class="hljs-number">0</span>);
    compressor.<span class="hljs-property">attack</span>.<span class="hljs-title function_">setValueAtTime</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    compressor.<span class="hljs-property">release</span>.<span class="hljs-title function_">setValueAtTime</span>(<span class="hljs-number">0.25</span>, <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 连接节点</span>
    oscillator.<span class="hljs-title function_">connect</span>(compressor);
    compressor.<span class="hljs-title function_">connect</span>(context.<span class="hljs-property">destination</span>);
    
    <span class="hljs-comment">// 播放并获取音频数据</span>
    oscillator.<span class="hljs-title function_">start</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> renderedBuffer = <span class="hljs-keyword">await</span> context.<span class="hljs-title function_">startRendering</span>();
    
    <span class="hljs-comment">// 提取特征点（取特定时间点的样本）</span>
    <span class="hljs-keyword">const</span> channelData = renderedBuffer.<span class="hljs-title function_">getChannelData</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> samples = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">4500</span>; i &lt; <span class="hljs-number">5000</span>; i += <span class="hljs-number">10</span>) {
      samples.<span class="hljs-title function_">push</span>(channelData[i].<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">10</span>));
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">hashString</span>(samples.<span class="hljs-title function_">join</span>(<span class="hljs-string">','</span>));
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<h3 data-id="heading-16">Audio指纹的稳定性</h3>
<p>Audio指纹的优势在于它<strong>不太受软件版本影响</strong>，更多取决于硬件（声卡/音频芯片）。这意味着：</p>
<ul>
<li>✅ <strong>跨浏览器稳定</strong>：Chrome和Firefox在同一个设备上会产生相似的音频指纹</li>
<li>✅ <strong>难以软件欺骗</strong>：单纯的浏览器插件难以模拟硬件级音频特征</li>
<li>⚠️ <strong>但不够唯一</strong>：相比Canvas和WebGL，Audio指纹的区分度稍低，通常作为辅助指纹使用</li>
</ul>
<hr/>
<h2 data-id="heading-17">其他指纹维度</h2>
<p>除了三大核心指纹技术，还有很多"小而美"的指纹维度：</p>
<h3 data-id="heading-18">1. 字体指纹</h3>
<p>检测已安装的字体列表：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getFontFingerprint</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> baseFonts = [<span class="hljs-string">'Arial'</span>, <span class="hljs-string">'Times New Roman'</span>, <span class="hljs-string">'Courier New'</span>];
  <span class="hljs-keyword">const</span> testFonts = [<span class="hljs-string">'Helvetica'</span>, <span class="hljs-string">'Georgia'</span>, <span class="hljs-string">'Verdana'</span>, <span class="hljs-string">'Tahoma'</span>];
  <span class="hljs-keyword">const</span> detected = [];
  
  <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>);
  <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
  
  <span class="hljs-comment">// 使用基线字体测量文本宽度</span>
  ctx.<span class="hljs-property">font</span> = <span class="hljs-string">'72px '</span> + baseFonts[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">const</span> baselineWidth = ctx.<span class="hljs-title function_">measureText</span>(<span class="hljs-string">'mmmmmmmmlli'</span>).<span class="hljs-property">width</span>;
  
  <span class="hljs-comment">// 测试每种字体</span>
  testFonts.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">font</span> =&gt;</span> {
    ctx.<span class="hljs-property">font</span> = <span class="hljs-string">'72px "'</span> + font + <span class="hljs-string">'", '</span> + baseFonts[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">const</span> width = ctx.<span class="hljs-title function_">measureText</span>(<span class="hljs-string">'mmmmmmmmlli'</span>).<span class="hljs-property">width</span>;
    <span class="hljs-keyword">if</span> (width !== baselineWidth) {
      detected.<span class="hljs-title function_">push</span>(font);
    }
  });
  
  <span class="hljs-keyword">return</span> detected.<span class="hljs-title function_">join</span>(<span class="hljs-string">','</span>);
}
</code></pre>
<h3 data-id="heading-19">2. 硬件信息</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getHardwareFingerprint</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">deviceMemory</span>: navigator.<span class="hljs-property">deviceMemory</span>, <span class="hljs-comment">// RAM（GB）</span>
    <span class="hljs-attr">hardwareConcurrency</span>: navigator.<span class="hljs-property">hardwareConcurrency</span>, <span class="hljs-comment">// CPU核心数</span>
    <span class="hljs-attr">maxTouchPoints</span>: navigator.<span class="hljs-property">maxTouchPoints</span>, <span class="hljs-comment">// 触摸点数</span>
    <span class="hljs-attr">platform</span>: navigator.<span class="hljs-property">platform</span>,
  };
}
</code></pre>
<h3 data-id="heading-20">3. 时区和语言</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getTimezoneFingerprint</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">timezone</span>: <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">DateTimeFormat</span>().<span class="hljs-title function_">resolvedOptions</span>().<span class="hljs-property">timeZone</span>,
    <span class="hljs-attr">timezoneOffset</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTimezoneOffset</span>(),
    <span class="hljs-attr">languages</span>: navigator.<span class="hljs-property">languages</span>,
    <span class="hljs-attr">language</span>: navigator.<span class="hljs-property">language</span>,
  };
}
</code></pre>
<hr/>
<h2 data-id="heading-21">反指纹技术：现代浏览器的防御</h2>
<p>既然指纹技术如此强大，有没有办法防御呢？答案是——<strong>有，但不完美</strong>。</p>
<h3 data-id="heading-22">1. Canvas Farbling（随机化噪声）</h3>
<p>这是<strong>Brave浏览器</strong>首创的技术，后来被Firefox采用。</p>
<p>原理：在Canvas读取像素数据时，向某些像素注入微小的随机噪声（通常是RGB值的±1）。人眼无法察觉，但会破坏指纹哈希的稳定性。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Brave的Farbling原理示意</span>
<span class="hljs-keyword">const</span> originalToDataURL = <span class="hljs-title class_">HTMLCanvasElement</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toDataURL</span>;
<span class="hljs-title class_">HTMLCanvasElement</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toDataURL</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
  <span class="hljs-keyword">const</span> data = originalToDataURL.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
  <span class="hljs-comment">// 注入基于会话的伪随机噪声</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">addFarblingNoise</span>(data, <span class="hljs-title function_">getSessionSeed</span>());
};
</code></pre>
<p><strong>检测Farbling的方法</strong>（来自fingerprintjs）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">detectCanvasFarbling</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>);
  <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
  ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'#000'</span>;
  ctx.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
  
  <span class="hljs-keyword">const</span> data1 = canvas.<span class="hljs-title function_">toDataURL</span>();
  <span class="hljs-keyword">const</span> data2 = canvas.<span class="hljs-title function_">toDataURL</span>();
  
  <span class="hljs-keyword">return</span> data1 !== data2; <span class="hljs-comment">// 如果两次读取不同，说明有Farbling</span>
}
</code></pre>
<h3 data-id="heading-23">2. WebGL扩展拦截</h3>
<p>隐私插件（如ScriptSafe）会拦截对<code>WEBGL_debug_renderer_info</code>的访问：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 防追踪脚本的典型做法</span>
<span class="hljs-keyword">const</span> originalGetExtension = <span class="hljs-title class_">WebGLRenderingContext</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">getExtension</span>;
<span class="hljs-title class_">WebGLRenderingContext</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">getExtension</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-keyword">if</span> (name === <span class="hljs-string">'WEBGL_debug_renderer_info'</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 返回null，阻止获取真实GPU信息</span>
  }
  <span class="hljs-keyword">return</span> originalGetExtension.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name);
};
</code></pre>
<h3 data-id="heading-24">3. User Agent标准化</h3>
<p>现代浏览器开始减少User Agent的熵值：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 过去的User Agent（信息丰富）</span>
<span class="hljs-comment">// Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 </span>
<span class="hljs-comment">// (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.0</span>

<span class="hljs-comment">// 未来的User Agent（精简版）</span>
<span class="hljs-comment">// Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 </span>
<span class="hljs-comment">// (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.0</span>
<span class="hljs-comment">// 版本号将简化为主要版本</span>
</code></pre>
<h3 data-id="heading-25">4. Tor Browser的极端策略</h3>
<p>Tor Browser采取了最激进的反指纹措施：</p>
<ul>
<li>完全禁用WebGL</li>
<li>统一所有用户的User Agent（都显示为Windows 7 + Firefox ESR）</li>
<li>标准化屏幕分辨率（仅报告几种常见尺寸）</li>
<li>禁用Canvas读取（或返回空白数据）</li>
<li>禁用所有时区检测（统一使用UTC）</li>
</ul>
<p>代价是：<strong>网站兼容性极差</strong>，很多现代Web应用无法在Tor Browser中正常运行。</p>
<hr/>
<h2 data-id="heading-26">实战：用开源库生成你的指纹</h2>
<h3 data-id="heading-27">方案1：FingerprintJS（最流行）</h3>
<pre><code class="hljs language-bash" lang="bash">npm install @fingerprintjs/fingerprintjs
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">FingerprintJS</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@fingerprintjs/fingerprintjs'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getVisitorId</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 加载指纹库</span>
  <span class="hljs-keyword">const</span> fp = <span class="hljs-keyword">await</span> <span class="hljs-title class_">FingerprintJS</span>.<span class="hljs-title function_">load</span>();
  
  <span class="hljs-comment">// 获取指纹结果</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> fp.<span class="hljs-title function_">get</span>();
  
  <span class="hljs-comment">// 输出访客ID（稳定标识符）</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Visitor ID:'</span>, result.<span class="hljs-property">visitorId</span>);
  
  <span class="hljs-comment">// 查看各个组件</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Components:'</span>, result.<span class="hljs-property">components</span>);
  
  <span class="hljs-keyword">return</span> result;
}

<span class="hljs-comment">// 实际项目中的使用场景（如Grafana）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BackendService</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">initDeviceID</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> fp = <span class="hljs-keyword">await</span> <span class="hljs-title class_">FingerprintJS</span>.<span class="hljs-title function_">load</span>();
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> fp.<span class="hljs-title function_">get</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">deviceID</span> = result.<span class="hljs-property">visitorId</span>;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Fingerprint failed:'</span>, error);
    }
  }
}
</code></pre>
<h3 data-id="heading-28">方案2：GuardianJS（免费开源）</h3>
<pre><code class="hljs language-bash" lang="bash">npm install guardian-js-free
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { load } <span class="hljs-keyword">from</span> <span class="hljs-string">'guardian-js-free'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getGuardianFingerprint</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> guardian = <span class="hljs-keyword">await</span> <span class="hljs-title function_">load</span>();
  <span class="hljs-keyword">const</span> visitorId = <span class="hljs-keyword">await</span> guardian.<span class="hljs-title function_">getVisitorId</span>();
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Guardian ID:'</span>, visitorId);
  <span class="hljs-keyword">return</span> visitorId;
}
</code></pre>
<h3 data-id="heading-29">方案3：纯浏览器API实现</h3>
<p>如果你想自己实现（用于学习）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BrowserFingerprinter</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getFingerprint</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> components = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getCanvasFingerprint</span>(),
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getWebGLFingerprint</span>(),
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getAudioFingerprint</span>(),
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getFontFingerprint</span>(),
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getHardwareInfo</span>(),
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getTimezoneInfo</span>(),
    ]);
    
    <span class="hljs-comment">// 组合所有组件并哈希</span>
    <span class="hljs-keyword">const</span> combined = components.<span class="hljs-title function_">join</span>(<span class="hljs-string">'::'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">hash</span>(combined);
  }
  
  <span class="hljs-comment">// ... 实现各个指纹方法</span>
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">const</span> fingerprinter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrowserFingerprinter</span>();
<span class="hljs-keyword">const</span> id = <span class="hljs-keyword">await</span> fingerprinter.<span class="hljs-title function_">getFingerprint</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Your fingerprint:'</span>, id);
</code></pre>
<hr/>
<h2 data-id="heading-30">总结与思考</h2>
<h3 data-id="heading-31">核心要点回顾</h3>
<ol>
<li>
<p><strong>浏览器指纹利用了Web的开放性</strong>：它不需要Cookie，不违反任何协议，只是"读取浏览器本来就公开的信息"。</p>
</li>
<li>
<p><strong>三大核心技术</strong>：</p>
<ul>
<li><strong>Canvas指纹</strong>：2D渲染差异，利用显卡驱动和字体渲染的不同</li>
<li><strong>WebGL指纹</strong>：GPU型号和渲染管道特征，几乎无法伪造</li>
<li><strong>Audio指纹</strong>：音频处理差异，硬件级特征</li>
</ul>
</li>
<li>
<p><strong>2025年的新趋势</strong>：</p>
<ul>
<li>学术研究首次实证指纹用于广告追踪</li>
<li>Google政策转向，Privacy Sandbox拥抱指纹技术</li>
<li>浏览器厂商加大反指纹力度（Farbling成为标准）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-32">给开发者的建议</h3>
<p><strong>如果你需要实现设备识别</strong>：</p>
<ul>
<li>优先考虑服务器端Session + 登录态</li>
<li>如果需要客户端识别，可以使用FingerprintJS等成熟库</li>
<li><strong>永远不要</strong>将指纹用于违法追踪或侵犯隐私</li>
</ul>
<p><strong>如果你想保护用户隐私</strong>：</p>
<ul>
<li>教育用户使用Brave、Firefox等注重隐私的浏览器</li>
<li>安装Privacy Badger、uBlock Origin等扩展</li>
<li>对于高安全需求，考虑使用Tor Browser</li>
</ul>
<h3 data-id="heading-33">给普通用户的建议</h3>
<ol>
<li><strong>不要迷信"无痕模式"</strong>：它只清除本地数据，无法阻止指纹追踪</li>
<li><strong>安装隐私扩展</strong>：uBlock Origin、Privacy Badger能有效阻止大部分追踪</li>
<li><strong>使用隐私浏览器</strong>：Brave的Farbling是目前最有效的反指纹手段</li>
<li><strong>接受现实</strong>：完全的匿名在当前Web技术下几乎不可能，除非你准备好牺牲便利性</li>
</ol>
<hr/>
<h2 data-id="heading-34">参考链接</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffingerprintjs%2Ffingerprintjs" target="_blank" title="https://github.com/fingerprintjs/fingerprintjs" ref="nofollow noopener noreferrer">FingerprintJS 官方库</a> - 验证状态: ✅</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpanopticlick.eff.org%2F" target="_blank" title="https://panopticlick.eff.org/" ref="nofollow noopener noreferrer">EFF Panopticlick</a> - 测试你的浏览器指纹 - 验证状态: ✅</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Famiunique.org%2F" target="_blank" title="https://amiunique.org/" ref="nofollow noopener noreferrer">Am I Unique?</a> - 查看你的指纹独特性 - 验证状态: ✅</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2409.15656" target="_blank" title="https://arxiv.org/pdf/2409.15656" ref="nofollow noopener noreferrer">约翰霍普金斯大学 2025研究论文</a> - 验证状态: ✅</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fshivankaul.com%2Fblog%2Fbeyond-cookies-browser-fingerprinting-in-2025-1" target="_blank" title="https://shivankaul.com/blog/beyond-cookies-browser-fingerprinting-in-2025-1" ref="nofollow noopener noreferrer">Beyond Cookies: Browser Fingerprinting in 2025</a> - 验证状态: ✅</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FGuardianStack%2Fguardianjs" target="_blank" title="https://github.com/GuardianStack/guardianjs" ref="nofollow noopener noreferrer">GuardianJS Free</a> - 开源指纹库 - 验证状态: ✅</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[rust arena 内存分配]]></title>    <link>https://juejin.cn/post/7603643044034412580</link>    <guid>https://juejin.cn/post/7603643044034412580</guid>    <pubDate>2026-02-07T16:58:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603643044034412580" data-draft-id="7603644943351169030" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="rust arena 内存分配"/> <meta itemprop="keywords" content="Rust"/> <meta itemprop="datePublished" content="2026-02-07T16:58:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Andrew_Ryan"/> <meta itemprop="url" content="https://juejin.cn/user/3993068510655703"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            rust arena 内存分配
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3993068510655703/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Andrew_Ryan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-07T16:58:12.000Z" title="Sat Feb 07 2026 16:58:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Rust 中，<strong>Arena 分配器</strong>是一种特殊的内存分配模式，它会在一个连续的内存区域（称为 Arena）中分配对象，并一次性释放所有对象，而不是单独释放每个对象。这种模式在某些场景下非常高效，比如解析器、编译器中间表示、游戏实体管理等。</p>
<hr/>
<h2 data-id="heading-0">1. <strong>Arena 的核心特点</strong></h2>
<ul>
<li><strong>批量分配，批量释放</strong>：所有分配的对象在 Arena 生命周期结束时一起释放。</li>
<li><strong>避免碎片化</strong>：对象在 Arena 中连续分配，内存布局紧凑。</li>
<li><strong>高性能</strong>：分配操作通常只是移动指针，释放操作是 O(1) 的。</li>
<li><strong>所有权集中</strong>：Arena 拥有其中所有对象的所有权，对象之间可以安全地相互引用。</li>
</ul>
<hr/>
<h2 data-id="heading-1">2. <strong>常见使用场景</strong></h2>
<ul>
<li><strong>AST（抽象语法树）节点</strong>：在编译器/解释器中，AST 节点在解析阶段分配，解析结束后一次性释放。</li>
<li><strong>游戏实体</strong>：一帧中创建的所有游戏对象在帧结束时批量释放。</li>
<li><strong>复杂数据结构</strong>：如链表、图等，其中节点需要相互引用且生命周期一致。</li>
</ul>
<hr/>
<h2 data-id="heading-2">3. <strong>Rust 中的 Arena 实现</strong></h2>
<p>Rust 生态中有几个成熟的 Arena 库：</p>
<h3 data-id="heading-3"><strong>typed-arena</strong></h3>
<p>允许分配单一类型的对象。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> typed_arena::Arena;

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span> {
    value: <span class="hljs-type">i32</span>,
    children: <span class="hljs-type">Vec</span>&lt;&amp;<span class="hljs-symbol">'static</span> Node&gt;, <span class="hljs-comment">// 注意生命周期标记</span>
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">arena</span> = Arena::<span class="hljs-title function_ invoke__">new</span>();
    
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">child1</span> = arena.<span class="hljs-title function_ invoke__">alloc</span>(Node { value: <span class="hljs-number">1</span>, children: <span class="hljs-built_in">vec!</span>[] });
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">child2</span> = arena.<span class="hljs-title function_ invoke__">alloc</span>(Node { value: <span class="hljs-number">2</span>, children: <span class="hljs-built_in">vec!</span>[] });
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">root</span> = arena.<span class="hljs-title function_ invoke__">alloc</span>(Node {
        value: <span class="hljs-number">0</span>,
        children: <span class="hljs-built_in">vec!</span>[child1, child2],
    });
    
    <span class="hljs-comment">// 所有节点由 arena 统一管理，生命周期相同</span>
    <span class="hljs-comment">// arena 超出作用域时，所有节点一起释放</span>
}
</code></pre>
<h3 data-id="heading-4"><strong>bumpalo</strong></h3>
<p>通用的 bump allocator，支持多类型分配。</p>
<pre><code class="hljs language-ini" lang="ini">use bumpalo::Bump<span class="hljs-comment">;</span>

fn main() {
    let <span class="hljs-attr">bump</span> = Bump::new()<span class="hljs-comment">;</span>
    
    let <span class="hljs-attr">i</span> = bump.alloc(<span class="hljs-number">42</span>)<span class="hljs-comment">;</span>
    let <span class="hljs-attr">s</span> = bump.alloc_str(<span class="hljs-string">"hello"</span>)<span class="hljs-comment">;</span>
    let <span class="hljs-attr">vec</span> = bump.alloc(vec![<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>])<span class="hljs-comment">;</span>
    
    // 所有分配的内存由 bump 统一管理
}
</code></pre>
<h3 data-id="heading-5"><strong>自实现简单 Arena</strong></h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::cell::RefCell;
<span class="hljs-keyword">use</span> std::mem;

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SimpleArena</span> {
    chunks: RefCell&lt;<span class="hljs-type">Vec</span>&lt;<span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u8</span>&gt;&gt;&gt;,
    current: RefCell&lt;<span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u8</span>&gt;&gt;,
    pos: RefCell&lt;<span class="hljs-type">usize</span>&gt;,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">SimpleArena</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">Self</span> {
            chunks: RefCell::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>()),
            current: RefCell::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(<span class="hljs-number">1024</span>)),
            pos: RefCell::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">0</span>),
        }
    }
    
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">allocate</span>&lt;T&gt;(&amp;<span class="hljs-keyword">self</span>, value: T) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-keyword">mut</span> T {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">size</span> = mem::size_of::&lt;T&gt;();
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">align</span> = mem::align_of::&lt;T&gt;();
        
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">pos</span> = <span class="hljs-keyword">self</span>.pos.<span class="hljs-title function_ invoke__">borrow_mut</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">current</span> = <span class="hljs-keyword">self</span>.current.<span class="hljs-title function_ invoke__">borrow_mut</span>();
        
        <span class="hljs-comment">// 对齐调整</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">aligned_pos</span> = (*pos + align - <span class="hljs-number">1</span>) &amp; !(align - <span class="hljs-number">1</span>);
        
        <span class="hljs-comment">// 检查当前 chunk 是否有足够空间</span>
        <span class="hljs-keyword">if</span> aligned_pos + size &gt; current.<span class="hljs-title function_ invoke__">capacity</span>() {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">new_chunk</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(<span class="hljs-number">1024</span>.<span class="hljs-title function_ invoke__">max</span>(size * <span class="hljs-number">2</span>));
            <span class="hljs-keyword">self</span>.chunks.<span class="hljs-title function_ invoke__">borrow_mut</span>().<span class="hljs-title function_ invoke__">push</span>(mem::<span class="hljs-title function_ invoke__">replace</span>(&amp;<span class="hljs-keyword">mut</span> *current, new_chunk));
            *pos = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">allocate</span>(value); <span class="hljs-comment">// 递归重试</span>
        }
        
        <span class="hljs-comment">// 确保有足够容量</span>
        <span class="hljs-keyword">if</span> aligned_pos + size &gt; current.<span class="hljs-title function_ invoke__">len</span>() {
            current.<span class="hljs-title function_ invoke__">resize</span>(aligned_pos + size, <span class="hljs-number">0</span>);
        }
        
        <span class="hljs-comment">// 写入数据</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">ptr</span> = current.<span class="hljs-title function_ invoke__">as_mut_ptr</span>().<span class="hljs-title function_ invoke__">add</span>(aligned_pos);
        <span class="hljs-keyword">unsafe</span> {
            ptr.<span class="hljs-title function_ invoke__">copy_from_nonoverlapping</span>(&amp;value <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> T <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> <span class="hljs-type">u8</span>, size);
            mem::<span class="hljs-title function_ invoke__">forget</span>(value); <span class="hljs-comment">// 防止原值被 drop</span>
            *pos = aligned_pos + size;
            &amp;<span class="hljs-keyword">mut</span> *(ptr <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> T)
        }
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">arena</span> = SimpleArena::<span class="hljs-title function_ invoke__">new</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">x</span> = arena.<span class="hljs-title function_ invoke__">allocate</span>(<span class="hljs-number">42_i32</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">y</span> = arena.<span class="hljs-title function_ invoke__">allocate</span>(<span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"hello"</span>));
    
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{} {}"</span>, x, y);
    <span class="hljs-comment">// Arena 销毁时，所有内存一次性释放</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-6">4. <strong>生命周期处理</strong></h2>
<p>Arena 分配的对象通常需要与 Arena 本身具有相同的生命周期：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> typed_arena::Arena;

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Graph</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    nodes: Arena&lt;Node&lt;<span class="hljs-symbol">'a</span>&gt;&gt;,
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    edges: <span class="hljs-type">Vec</span>&lt;&amp;<span class="hljs-symbol">'a</span> Node&lt;<span class="hljs-symbol">'a</span>&gt;&gt;, <span class="hljs-comment">// 可以安全引用同一 arena 中的其他节点</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-7">5. <strong>性能注意事项</strong></h2>
<ul>
<li><strong>分配速度</strong>：Arena 分配通常只是指针移动，比全局分配器快得多。</li>
<li><strong>内存使用</strong>：可能浪费空间（对齐间隙、最后 chunk 未用完的空间）。</li>
<li><strong>释放时机</strong>：只能一次性释放所有对象，不能单独释放。</li>
<li><strong>缓存友好</strong>：连续分配的对象在内存中相邻，缓存局部性好。</li>
</ul>
<hr/>
<h2 data-id="heading-8">6. <strong>与标准分配器的对比</strong></h2>



































<table><thead><tr><th>特性</th><th>Arena</th><th>标准分配器（如 jemalloc）</th></tr></thead><tbody><tr><td>分配速度</td><td>极快（指针移动）</td><td>较慢（系统调用/复杂管理）</td></tr><tr><td>释放速度</td><td>O(1)</td><td>O(n) 或更复杂</td></tr><tr><td>内存碎片</td><td>无内部碎片</td><td>可能有碎片</td></tr><tr><td>灵活性</td><td>只能批量释放</td><td>可单独释放</td></tr><tr><td>适用场景</td><td>同生命周期对象组</td><td>通用场景</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-9">7. <strong>实际应用建议</strong></h2>
<ol>
<li>使用现成的库（如 <code>typed-arena</code>、<code>bumpalo</code>）而非自己实现。</li>
<li>明确对象是否具有相同的生命周期。</li>
<li>注意 Arena 分配的对象不能比 Arena 本身活得久。</li>
<li>对于需要析构的对象，Arena 会正确调用 drop（但释放内存是批量的）。</li>
</ol>
<hr/>
<h2 data-id="heading-10">8. <strong>高级模式：两阶段 Arena</strong></h2>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 第一阶段：分配所有节点</span>
<span class="hljs-comment">// 第二阶段：处理节点间引用</span>
<span class="hljs-comment">// 第三阶段：一次性释放</span>
</code></pre>
<p>Arena 在 Rust 中是处理特定内存管理模式的强大工具，尤其适合编译器、解析器等需要高效分配大量同生命周期对象的场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 Rust 内存管理：基于 typed_arena 的指针操作实践]]></title>    <link>https://juejin.cn/post/7603649945978503187</link>    <guid>https://juejin.cn/post/7603649945978503187</guid>    <pubDate>2026-02-07T16:59:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603649945978503187" data-draft-id="7603644943351201798" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 Rust 内存管理：基于 typed_arena 的指针操作实践"/> <meta itemprop="keywords" content="Rust"/> <meta itemprop="datePublished" content="2026-02-07T16:59:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Andrew_Ryan"/> <meta itemprop="url" content="https://juejin.cn/user/3993068510655703"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 Rust 内存管理：基于 typed_arena 的指针操作实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3993068510655703/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Andrew_Ryan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-07T16:59:03.000Z" title="Sat Feb 07 2026 16:59:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">深入理解 Rust 内存管理：基于 typed_arena 的指针操作实践</h2>
<p>在 Rust 编程中，内存安全是核心特性，但直接操作原始指针（<code>*mut T</code>/<code>*const T</code>）时，开发者需要手动把控内存边界和生命周期。本文将基于 <code>typed_arena</code> 库，通过一个完整的「创建-读取-更新-删除（CRUD）」示例，带你理解 Rust 中原始指针的安全使用方式，以及 Arena 内存池的核心价值。</p>
<h3 data-id="heading-1">一、场景背景：为什么用 typed_arena？</h3>
<p>Rust 原生的内存管理（<code>Box</code>/<code>Vec</code>）是「所有权+借用检查」驱动的，但在高频内存分配/释放场景（如编译器、游戏引擎）中，频繁的内存申请会导致性能损耗。</p>
<p><code>typed_arena</code> 是一个轻量级的 Arena 内存池库：</p>
<ul>
<li>一次性申请一块连续内存，后续分配直接从池中获取，减少系统调用；</li>
<li>内存池生命周期结束时批量释放，无需逐个管理对象；</li>
<li>兼容 Rust 的安全语义，同时支持原始指针操作（需手动保证安全）。</li>
</ul>
<h3 data-id="heading-2">二、完整代码实现：指针操作的 CRUD</h3>
<p>先看完整代码，后续逐模块拆解：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> typed_arena::Arena;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 1. Create (创建) - 分配内存并获取 *mut u8 指针，同时记录字符串长度</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">arena</span>: Arena&lt;<span class="hljs-type">u8</span>&gt; = Arena::<span class="hljs-title function_ invoke__">new</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">hello</span> = arena.<span class="hljs-title function_ invoke__">alloc_str</span>(<span class="hljs-string">"你好 Hello world "</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">s</span>: *<span class="hljs-keyword">mut</span> <span class="hljs-type">u8</span> = hello.<span class="hljs-title function_ invoke__">as_ptr</span>() <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">u8</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">str_len</span> = hello.<span class="hljs-title function_ invoke__">len</span>(); <span class="hljs-comment">// 记录字符串实际长度，避免越界</span>
    dbg!(s); <span class="hljs-comment">// 打印指针地址</span>

    <span class="hljs-comment">// 2. Read (读取) - 基于字符串实际长度读取，避免越界</span>
    <span class="hljs-keyword">unsafe</span> {
        <span class="hljs-comment">// 读取单个字节</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">first_byte</span> = *s;
        <span class="hljs-built_in">println!</span>(
            <span class="hljs-string">"读取第一个字节: {} (ASCII: {})"</span>,
            first_byte, first_byte <span class="hljs-keyword">as</span> <span class="hljs-type">char</span>
        );

        <span class="hljs-comment">// 读取整个字符串（基于实际长度，正确处理 UTF-8 编码）</span>
        <span class="hljs-built_in">print!</span>(<span class="hljs-string">"读取整个字符串: "</span>);
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">bytes_slice</span> = std::slice::<span class="hljs-title function_ invoke__">from_raw_parts</span>(s, str_len);
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(utf8_str) = std::<span class="hljs-type">str</span>::<span class="hljs-title function_ invoke__">from_utf8</span>(bytes_slice) {
            <span class="hljs-built_in">print!</span>(<span class="hljs-string">"{}"</span>, utf8_str);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"UTF-8 解析失败"</span>);
        }
        <span class="hljs-built_in">println!</span>();
    }

    <span class="hljs-comment">// 3. Update (更新) - 修改指针指向的内存内容</span>
    <span class="hljs-keyword">unsafe</span> {
        <span class="hljs-comment">// 修改 ASCII 部分：'H' (在位置 7，跳过 "你好 " 共 7 字节) 改为 'h' (小写)</span>
        <span class="hljs-comment">// "你" (bytes 0-2) + "好" (bytes 3-5) + " " (byte 6) = 7 字节，所以 'H' 在索引 7</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">h_char_ptr</span> = s.<span class="hljs-title function_ invoke__">add</span>(<span class="hljs-number">7</span>);
        *h_char_ptr = <span class="hljs-string">b'h'</span>;
        <span class="hljs-built_in">println!</span>(
            <span class="hljs-string">"更新后第8个字节(位置7): {} (ASCII: {})"</span>,
            *h_char_ptr, *h_char_ptr <span class="hljs-keyword">as</span> <span class="hljs-type">char</span>
        );

        <span class="hljs-comment">// 修改第13个字符（空格）为 '-'</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">space_ptr</span> = s.<span class="hljs-title function_ invoke__">add</span>(<span class="hljs-number">12</span>);
        *space_ptr = <span class="hljs-string">b'-'</span>;
        <span class="hljs-built_in">println!</span>(
            <span class="hljs-string">"更新后第13个字节(位置12): {} (ASCII: {})"</span>,
            *space_ptr, *space_ptr <span class="hljs-keyword">as</span> <span class="hljs-type">char</span>
        );

        <span class="hljs-comment">// 再次读取验证更新结果（基于实际长度，正确处理 UTF-8 编码）</span>
        <span class="hljs-built_in">print!</span>(<span class="hljs-string">"更新后完整字符串: "</span>);
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">bytes_slice</span> = std::slice::<span class="hljs-title function_ invoke__">from_raw_parts</span>(s, str_len);
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(utf8_str) = std::<span class="hljs-type">str</span>::<span class="hljs-title function_ invoke__">from_utf8</span>(bytes_slice) {
            <span class="hljs-built_in">print!</span>(<span class="hljs-string">"{}"</span>, utf8_str);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">print!</span>(<span class="hljs-string">"UTF-8 解析失败，原始字节: "</span>);
            <span class="hljs-keyword">for</span> &amp;byte <span class="hljs-keyword">in</span> bytes_slice.<span class="hljs-title function_ invoke__">iter</span>() {
                <span class="hljs-built_in">print!</span>(<span class="hljs-string">"{:02x} "</span>, byte);
            }
        }
        <span class="hljs-built_in">println!</span>();
    }

    <span class="hljs-comment">// 4. Delete (删除) - 置空指针，由 Arena 管理内存释放</span>
    s = std::ptr::<span class="hljs-title function_ invoke__">null_mut</span>();
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"指针置空: {:?}"</span>, s);

    <span class="hljs-comment">// 验证指针置空后无法访问</span>
    <span class="hljs-keyword">if</span> s.<span class="hljs-title function_ invoke__">is_null</span>() {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"指针已置空，无法读取数据"</span>);
    }
}
</code></pre>
<h4 data-id="heading-3">1. 前置准备：依赖引入</h4>
<p>首先在 <code>Cargo.toml</code> 中添加依赖：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[dependencies]</span>
<span class="hljs-attr">typed_arena</span> = <span class="hljs-string">"2.0"</span>
</code></pre>
<h4 data-id="heading-4">2. 核心模块拆解</h4>
<h5 data-id="heading-5">（1）Create：内存分配与指针获取</h5>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">arena</span>: Arena&lt;<span class="hljs-type">u8</span>&gt; = Arena::<span class="hljs-title function_ invoke__">new</span>();
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">hello</span> = arena.<span class="hljs-title function_ invoke__">alloc_str</span>(<span class="hljs-string">"你好 Hello world "</span>);
<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">s</span>: *<span class="hljs-keyword">mut</span> <span class="hljs-type">u8</span> = hello.<span class="hljs-title function_ invoke__">as_ptr</span>() <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">u8</span>;
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">str_len</span> = hello.<span class="hljs-title function_ invoke__">len</span>(); <span class="hljs-comment">// 关键：记录长度，避免后续越界</span>
</code></pre>
<ul>
<li><code>Arena::new()</code>：创建一个用于存储 <code>u8</code> 类型的内存池；</li>
<li><code>alloc_str</code>：将字符串按字节（<code>u8</code>）分配到 Arena 中，返回一个 <code>&amp;str</code>；</li>
<li><code>as_ptr() as *mut u8</code>：将不可变指针转为可变原始指针（<code>*mut u8</code>），这是后续修改的基础；</li>
<li>必须记录字符串长度：原始指针本身不携带长度信息，手动记录是避免越界的核心。</li>
</ul>
<h5 data-id="heading-6">（2）Read：安全读取指针指向的内存</h5>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">unsafe</span> {
    <span class="hljs-comment">// 读取单个字节</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">first_byte</span> = *s;
    <span class="hljs-comment">// 读取整个字符串：通过 from_raw_parts 构建切片</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">bytes_slice</span> = std::slice::<span class="hljs-title function_ invoke__">from_raw_parts</span>(s, str_len);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">utf8_str</span> = std::<span class="hljs-type">str</span>::<span class="hljs-title function_ invoke__">from_utf8</span>(bytes_slice);
}
</code></pre>
<ul>
<li>原始指针操作必须包裹在 <code>unsafe</code> 块中：Rust 无法保证指针有效性，需开发者自行负责；</li>
<li><code>std::slice::from_raw_parts</code>：通过「指针+长度」构建切片，是原始指针转为安全切片的关键；</li>
<li><code>std::str::from_utf8</code>：验证字节流是否为合法 UTF-8（避免修改后破坏编码）。</li>
</ul>
<h5 data-id="heading-7">（3）Update：修改指针指向的内存</h5>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">unsafe</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">h_char_ptr</span> = s.<span class="hljs-title function_ invoke__">add</span>(<span class="hljs-number">7</span>); <span class="hljs-comment">// 指针偏移：跳过前7个字节（"你好 "）</span>
    *h_char_ptr = <span class="hljs-string">b'h'</span>; <span class="hljs-comment">// 修改为小写 h</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">space_ptr</span> = s.<span class="hljs-title function_ invoke__">add</span>(<span class="hljs-number">12</span>);
    *space_ptr = <span class="hljs-string">b'-'</span>; <span class="hljs-comment">// 将空格改为 -</span>
}
</code></pre>
<ul>
<li><code>ptr.add(n)</code>：指针偏移 <code>n</code> 个字节（仅适用于 <code>u8</code>，其他类型需注意内存对齐）；</li>
<li>仅修改 ASCII 字符：中文是多字节 UTF-8 编码，直接修改会破坏编码完整性（示例中刻意避开）；</li>
<li>修改后重新验证 UTF-8：确保修改后的字节流仍能正确解析为字符串。</li>
</ul>
<h5 data-id="heading-8">（4）Delete：指针置空与内存释放</h5>
<pre><code class="hljs language-rust" lang="rust">s = std::ptr::<span class="hljs-title function_ invoke__">null_mut</span>(); <span class="hljs-comment">// 置空指针，避免悬垂</span>
</code></pre>
<ul>
<li>Arena 内存池的核心特性：开发者无需手动释放单个对象，只需保证指针不再被使用；</li>
<li>置空指针：避免后续误操作「悬垂指针」（指向已释放/无效内存的指针）；</li>
<li>内存释放时机：当 <code>arena</code> 超出作用域时，整个内存池会被批量释放。</li>
</ul>
<h3 data-id="heading-9">三、运行结果与分析</h3>
<p>执行代码后，输出如下（指针地址因环境而异）：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">[src/main.rs:9] s = 0x55f8b8a2f200</span>
<span class="hljs-section">读取第一个字节: 228 (ASCII: å)</span>
<span class="hljs-section">读取整个字符串: 你好 Hello world </span>
<span class="hljs-section">更新后第8个字节(位置7): 104 (ASCII: h)</span>
<span class="hljs-section">更新后第13个字节(位置12): 45 (ASCII: -)</span>
<span class="hljs-section">更新后完整字符串: 你好 hello worl- </span>
<span class="hljs-section">指针置空: 0x0</span>
指针已置空，无法读取数据
</code></pre>
<ul>
<li>第一个字节是 <code>228</code>：对应中文「你」的 UTF-8 第一个字节（<code>0xE4</code>），不是可打印 ASCII；</li>
<li>修改后字符串变为 <code>你好 hello worl-</code>：验证了指针修改的有效性；</li>
<li>指针置空后无法访问：避免了悬垂指针风险。</li>
</ul>
<h3 data-id="heading-10">四、关键注意事项</h3>
<ol>
<li>
<p><strong>UTF-8 编码安全</strong>：
中文/多字节字符不能直接修改单个字节，否则会破坏 UTF-8 编码，导致 <code>from_utf8</code> 失败。</p>
</li>
<li>
<p><strong>越界访问风险</strong>：
原始指针操作无边界检查，必须通过 <code>str_len</code> 严格限制访问范围，否则会触发未定义行为。</p>
</li>
<li>
<p><strong>Arena 内存池的生命周期</strong>：
Arena 分配的内存仅在 Arena 生命周期内有效，若 Arena 被释放，指针会变为悬垂指针。</p>
</li>
<li>
<p><strong>unsafe 块的最小化</strong>：
仅将必要的指针操作放入 <code>unsafe</code> 块，减少安全风险。</p>
</li>
</ol>
<h3 data-id="heading-11">五、应用场景</h3>
<ul>
<li><strong>高频内存分配场景</strong>：如编译器的 AST 节点、游戏的实体组件，批量分配/释放提升性能；</li>
<li><strong>需要原始指针的交互场景</strong>：如与 C 语言交互、底层系统编程；</li>
<li><strong>固定生命周期的内存管理</strong>：如单次请求的临时数据，无需逐个释放。</li>
</ul>
<h3 data-id="heading-12">总结</h3>
<ol>
<li><code>typed_arena</code> 提供了高效的批量内存管理方式，适合高频分配/释放场景，且无需手动管理单个对象的释放；</li>
<li>Rust 中原始指针操作必须包裹在 <code>unsafe</code> 块中，需手动保证「长度不越界、编码不破坏、指针不悬垂」；</li>
<li>指针操作的核心安全原则：记录长度、验证编码、及时置空，避免未定义行为。</li>
</ol>
<p>通过这个示例，你不仅能掌握 <code>typed_arena</code> 的使用，更能理解 Rust 内存安全的底层逻辑——即使是 <code>unsafe</code> 操作，也能通过严谨的约束实现安全的内存管理。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Python 教程15】-Python和Web]]></title>    <link>https://juejin.cn/post/7603688142004158473</link>    <guid>https://juejin.cn/post/7603688142004158473</guid>    <pubDate>2026-02-07T18:42:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603688142004158473" data-draft-id="7603674653152952329" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Python 教程15】-Python和Web"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-02-07T18:42:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java后端的Ai之路"/> <meta itemprop="url" content="https://juejin.cn/user/1013072340203736"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Python 教程15】-Python和Web
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1013072340203736/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java后端的Ai之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-07T18:42:48.000Z" title="Sat Feb 07 2026 18:42:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、屏幕抓取：Web 数据的“搬运工”<a id="user-content-scraper" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/861f7cd6e46948bfbc6b398a5e842a60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeWQjuerr-eahEFp5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771094568&amp;x-signature=wLUL8wnsgMitUWmf9iM%2Fvu4kLwE%3D" alt="屏幕抓取动漫图" loading="lazy"/></p>
<blockquote>
<p>想象一下，你是个勤劳的“数据搬运工”，每天的工作就是从浩瀚的互联网海洋里，把那些散落在网页上的“金子”（数据）捞出来，然后整理好，变成自己能用的“宝藏”。这就是<strong>屏幕抓取（Web Scraping）</strong>，也叫网络爬虫，它的核心任务就是：<strong>程序化地下载网页内容，并从中提取你想要的信息</strong>。是不是听起来有点像“黑客帝国”里的 Neo，在数字洪流中捕捉关键信息？</p>
</blockquote>
<h3 data-id="heading-1">1. 正则表达式：快准狠的“文本手术刀”</h3>
<blockquote>
<p>在 Python 的世界里，**正则表达式（Regular Expression，简称 Regex）**就像一把锋利的“手术刀”，能让你在杂乱无章的文本中，精准地切割、匹配、提取出你想要的部分。当网页内容还是一堆“乱码”时，Regex 就是你的“火眼金睛”。</p>
</blockquote>
<p><strong>专业解释</strong>：正则表达式是一种用于匹配字符串模式的强大工具。它通过定义一系列特殊字符和语法规则，来描述字符串的搜索模式，从而实现对文本的查找、替换、提取等操作。在屏幕抓取中，我们常用它来从原始 HTML 文本中匹配特定的数据。</p>
<p><strong>大白话解读</strong>：比如你想从一堆电话号码里找出所有以“138”开头的，或者从一篇文章里找出所有链接，正则表达式就能帮你一秒搞定，比你一个一个找快多了！</p>
<p><strong>生活案例</strong>：就像你在图书馆里找书，不是一本一本翻，而是直接看书架上的分类标签，正则表达式就是那个帮你快速定位的“分类标签”。</p>
<p><strong>示例 Python 代码</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> re
<span class="hljs-keyword">import</span> urllib.request
​
<span class="hljs-keyword">def</span> <span class="hljs-title function_">simple_regex_scraper</span>(<span class="hljs-params">url</span>):
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 模拟浏览器请求，获取网页内容</span>
        headers = {<span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3'</span>}
        req = urllib.request.Request(url, headers=headers)
        <span class="hljs-keyword">with</span> urllib.request.urlopen(req) <span class="hljs-keyword">as</span> response:
            html_content = response.read().decode(<span class="hljs-string">'utf-8'</span>)
        
        <span class="hljs-comment"># 假设我们要抓取Python Job Board上的职位名称和链接</span>
        <span class="hljs-comment"># 原始链接：http://python.org/jobs</span>
        <span class="hljs-comment"># 注意：实际网站结构可能变化，此代码仅作示例</span>
        pattern = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r'&lt;a href="(/jobs/\d+)/?"&gt;(.*?)&lt;/a&gt;'</span>)
        
        job_listings = pattern.findall(html_content)
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"从 <span class="hljs-subst">{url}</span> 抓取到的职位信息："</span>)
        <span class="hljs-keyword">for</span> job_url_suffix, job_name <span class="hljs-keyword">in</span> job_listings:
            full_job_url = <span class="hljs-string">f"https://www.python.org<span class="hljs-subst">{job_url_suffix}</span>"</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"- <span class="hljs-subst">{job_name}</span> (<span class="hljs-subst">{full_job_url}</span>)"</span>)
            
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"抓取失败：<span class="hljs-subst">{e}</span>"</span>)
​
<span class="hljs-comment"># 运行示例</span>
simple_regex_scraper(<span class="hljs-string">'https://www.python.org/jobs/'</span>)
</code></pre>
<blockquote>
<p><strong>小提示</strong>：正则表达式虽然强大，但面对复杂的 HTML 结构，比如嵌套很深的标签，或者 HTML 本身就不规范时，它可能会让你抓狂。这时候，我们就需要更“温柔”的工具了！</p>
</blockquote>
<h3 data-id="heading-2">2. HTML 解析：优雅地“拆解”网页</h3>
<blockquote>
<p>当网页内容不再是简单的文本，而是结构复杂的 HTML 时，我们就需要一个“结构工程师”来帮助我们理解和拆解它。<strong>HTML 解析</strong>就是把一堆 HTML 代码，变成一个有层级、有关系的“积木模型”，这样我们就能轻松找到想要的“积木”了。</p>
</blockquote>
<p><strong>专业解释</strong>：HTML 解析是将 HTML 文档（通常是字符串形式）转换为一个可操作的数据结构（如 DOM 树），以便程序能够方便地访问、修改和提取文档中的元素、属性和文本内容。这比直接使用正则表达式匹配原始字符串更健壮和灵活。</p>
<p><strong>大白话解读</strong>：就像你拿到一份乐高说明书，HTML 解析就是帮你把说明书上的零件（标签）和组装步骤（结构）理清楚，让你知道哪个零件在哪，怎么拼起来。</p>
<p><strong>生活案例</strong>：你买了一个宜家家具，HTML 解析就像是那个详细的组装说明书，告诉你哪个板子是桌面，哪个是桌腿，以及它们是怎么连接的。</p>
<p><strong>示例 Python 代码（使用 <code>html.parser</code>）</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> urllib.request <span class="hljs-keyword">import</span> urlopen
<span class="hljs-keyword">from</span> html.parser <span class="hljs-keyword">import</span> HTMLParser
​
<span class="hljs-keyword">class</span> <span class="hljs-title class_">JobScraper</span>(<span class="hljs-title class_ inherited__">HTMLParser</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.in_job_link = <span class="hljs-literal">False</span>
        self.current_job_name = []
        self.job_listings = []
​
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_starttag</span>(<span class="hljs-params">self, tag, attrs</span>):
        <span class="hljs-keyword">if</span> tag == <span class="hljs-string">'a'</span>:
            attrs_dict = <span class="hljs-built_in">dict</span>(attrs)
            href = attrs_dict.get(<span class="hljs-string">'href'</span>)
            <span class="hljs-comment"># 检查是否是职位链接，这里简化判断，实际可能需要更复杂的逻辑</span>
            <span class="hljs-keyword">if</span> href <span class="hljs-keyword">and</span> <span class="hljs-string">'/jobs/'</span> <span class="hljs-keyword">in</span> href <span class="hljs-keyword">and</span> href.split(<span class="hljs-string">'/'</span>)[-<span class="hljs-number">1</span>].isdigit():
                self.in_job_link = <span class="hljs-literal">True</span>
                self.current_job_url = <span class="hljs-string">f"https://www.python.org<span class="hljs-subst">{href}</span>"</span>
                self.current_job_name = []
​
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_data</span>(<span class="hljs-params">self, data</span>):
        <span class="hljs-keyword">if</span> self.in_job_link:
            self.current_job_name.append(data.strip())
​
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_endtag</span>(<span class="hljs-params">self, tag</span>):
        <span class="hljs-keyword">if</span> tag == <span class="hljs-string">'a'</span> <span class="hljs-keyword">and</span> self.in_job_link:
            job_name = <span class="hljs-string">''</span>.join(self.current_job_name).strip()
            <span class="hljs-keyword">if</span> job_name:
                self.job_listings.append(<span class="hljs-string">f"<span class="hljs-subst">{job_name}</span> (<span class="hljs-subst">{self.current_job_url}</span>)"</span>)
            self.in_job_link = <span class="hljs-literal">False</span>
​
<span class="hljs-keyword">def</span> <span class="hljs-title function_">html_parser_scraper</span>(<span class="hljs-params">url</span>):
    <span class="hljs-keyword">try</span>:
        headers = {<span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3'</span>}
        req = urllib.request.Request(url, headers=headers)
        <span class="hljs-keyword">with</span> urllib.request.urlopen(req) <span class="hljs-keyword">as</span> response:
            html_content = response.read().decode(<span class="hljs-string">'utf-8'</span>)
​
        parser = JobScraper()
        parser.feed(html_content)
        parser.close()
​
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n使用 HTMLParser 从 <span class="hljs-subst">{url}</span> 抓取到的职位信息："</span>)
        <span class="hljs-keyword">for</span> job <span class="hljs-keyword">in</span> parser.job_listings:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"- <span class="hljs-subst">{job}</span>"</span>)
​
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"抓取失败：<span class="hljs-subst">{e}</span>"</span>)
​
<span class="hljs-comment"># 运行示例</span>
html_parser_scraper(<span class="hljs-string">'https://www.python.org/jobs/'</span>)
</code></pre>
<blockquote>
<p><strong>温馨提示</strong>：<code>HTMLParser</code> 是 Python 标准库自带的，用起来比较底层，需要自己处理各种标签事件。如果你觉得这有点像“手搓”螺丝，那么接下来要介绍的“电动工具”一定会让你爱不释手！</p>
</blockquote>
<h3 data-id="heading-3">3. Beautiful Soup：应对“脏乱差”网页的“神器”</h3>
<blockquote>
<p>互联网上的网页可不是都那么“规矩”的，很多时候它们就像一堆被熊孩子玩过的乐高积木，缺胳膊少腿，乱七八糟。这时候，<strong>Beautiful Soup</strong> 就闪亮登场了！它是一个专门用来“收拾烂摊子”的工具，即使面对格式再糟糕的 HTML，它也能帮你优雅地解析出来。</p>
</blockquote>
<p><strong>专业解释</strong>：Beautiful Soup 是一个 Python 库，用于从 HTML 或 XML 文件中提取数据。它能够处理不规范的 HTML 标记，并提供简单、Pythonic 的方式来导航、搜索和修改解析树。它构建了一个解析树，使得开发者可以通过标签名、属性、CSS 选择器等多种方式轻松定位元素。</p>
<p><strong>大白话解读</strong>：Beautiful Soup 就像一个“超级保姆”，不管你的 HTML 代码有多“熊”，它都能帮你整理得服服帖帖，让你想找什么数据，就像在自己家里找东西一样简单。</p>
<p><strong>生活案例</strong>：你家孩子把玩具撒了一地，Beautiful Soup 就像那个能自动分类整理玩具的“智能机器人”，把小汽车放一堆，积木放一堆，让你一眼就能找到想要的。</p>
<p><strong>示例 Python 代码</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> urllib.request <span class="hljs-keyword">import</span> urlopen
<span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup
​
<span class="hljs-keyword">def</span> <span class="hljs-title function_">beautiful_soup_scraper</span>(<span class="hljs-params">url</span>):
    <span class="hljs-keyword">try</span>:
        headers = {<span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3'</span>}
        req = urllib.request.Request(url, headers=headers)
        <span class="hljs-keyword">with</span> urllib.request.urlopen(req) <span class="hljs-keyword">as</span> response:
            html_content = response.read()
        
        <span class="hljs-comment"># 使用Beautiful Soup解析HTML</span>
        soup = BeautifulSoup(html_content, <span class="hljs-string">'html.parser'</span>)
        
        job_listings = <span class="hljs-built_in">set</span>()
        <span class="hljs-comment"># 假设职位信息在body的第一个section下的h2标签中，且h2中包含a标签</span>
        <span class="hljs-comment"># 注意：实际网站结构可能变化，此代码仅作示例</span>
        <span class="hljs-comment"># 寻找所有class为'listing-row'的div，或者直接寻找h2标签内的a链接</span>
        <span class="hljs-comment"># 示例：soup.find_all('h2') 或者 soup.select('section.listing-section h2 a')</span>
        
        <span class="hljs-comment"># 针对Python官网jobs页面的结构，我们可以尝试更直接的方式</span>
        <span class="hljs-comment"># 查找所有class为'listing-row'的div，然后从里面提取链接和文本</span>
        <span class="hljs-keyword">for</span> listing <span class="hljs-keyword">in</span> soup.find_all(<span class="hljs-string">'div'</span>, class_=<span class="hljs-string">'listing-row'</span>):
            link_tag = listing.find(<span class="hljs-string">'h2'</span>).find(<span class="hljs-string">'a'</span>)
            <span class="hljs-keyword">if</span> link_tag:
                job_name = link_tag.get_text(strip=<span class="hljs-literal">True</span>)
                job_url_suffix = link_tag.get(<span class="hljs-string">'href'</span>)
                full_job_url = <span class="hljs-string">f"https://www.python.org<span class="hljs-subst">{job_url_suffix}</span>"</span>
                job_listings.add(<span class="hljs-string">f"<span class="hljs-subst">{job_name}</span> (<span class="hljs-subst">{full_job_url}</span>)"</span>)
​
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n使用 Beautiful Soup 从 <span class="hljs-subst">{url}</span> 抓取到的职位信息："</span>)
        <span class="hljs-keyword">for</span> job <span class="hljs-keyword">in</span> <span class="hljs-built_in">sorted</span>(<span class="hljs-built_in">list</span>(job_listings), key=<span class="hljs-built_in">str</span>.lower):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"- <span class="hljs-subst">{job}</span>"</span>)
            
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"抓取失败：<span class="hljs-subst">{e}</span>"</span>)
​
<span class="hljs-comment"># 运行示例</span>
beautiful_soup_scraper(<span class="hljs-string">'https://www.python.org/jobs/'</span>)
</code></pre>
<blockquote>
<p><strong>总结一下</strong>：屏幕抓取就像是互联网世界的“寻宝游戏”。正则表达式是你的“藏宝图碎片”，帮你识别特定模式；<code>HTMLParser</code> 是你的“放大镜”，帮你细致地查看 HTML 结构；而 <code>Beautiful Soup</code> 则是你的“万能工具箱”，不管遇到多复杂的“宝藏箱”，它都能帮你打开！</p>
</blockquote>
<h2 data-id="heading-4">二、CGI：让你的网页“动”起来<a id="user-content-cgi" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1eeb0a562e2a4ea8b81fc93542bb38aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeWQjuerr-eahEFp5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771094568&amp;x-signature=JmJ8SrDWm4zznyP3IujI1wAW5TY%3D" alt="CGI 动漫图" loading="lazy"/></p>
<blockquote>
<p>如果说屏幕抓取是把别人的网页“搬”回家，那 **CGI（Common Gateway Interface，通用网关接口）**就是让你自己家的网页“活”起来的魔法！静态网页就像一张张精美的海报，虽然好看，但不会对你的任何行为做出反应。而有了 CGI，你的网页就变成了一个能和你互动的“智能机器人”！</p>
</blockquote>
<h3 data-id="heading-5">1. CGI 基础：Web 服务器的“传话筒”</h3>
<blockquote>
<p>想象一下，Web 服务器（比如 Apache）是个“餐厅老板”，它只负责接待客人（用户请求），但不会做菜（处理动态请求）。CGI 脚本就是那个“大厨”，当客人点了份“宫保鸡丁”（提交了一个表单），老板就会通过 CGI 这个“传话筒”，把订单告诉大厨。大厨做好菜后，再通过老板端给客人。</p>
</blockquote>
<p><strong>专业解释</strong>：CGI 是一种标准，定义了 Web 服务器如何与外部脚本（CGI 脚本）进行通信，以处理动态请求。当 Web 服务器收到一个指向 CGI 脚本的请求时，它会执行该脚本，并将请求的详细信息（如表单数据、URL 参数等）作为环境变量或标准输入传递给脚本。脚本处理完请求后，将生成的 HTML 或其他内容作为标准输出返回给 Web 服务器，最终由服务器发送给客户端浏览器。</p>
<p><strong>大白话解读</strong>：你访问一个网站，填了个登录表单，点击“登录”按钮。这时候，Web 服务器就把你的用户名和密码通过 CGI 交给了后台的 Python 脚本。Python 脚本验证了一下，发现你是合法用户，就生成一个“欢迎回来！”的页面，再通过 Web 服务器显示给你看。整个过程，CGI 就是那个负责“沟通”的桥梁。</p>
<p><strong>生活案例</strong>：你去银行 ATM 机取钱，ATM 机就是 Web 服务器，你插卡、输密码就是用户请求。ATM 机本身不处理你的账户信息，它通过一个内部接口（类似 CGI）把你的请求发给银行的后台系统。后台系统验证通过后，告诉 ATM 机吐多少钱，ATM 机再把钱给你。这个内部接口就是 CGI 的角色。</p>
<p><strong>示例 Python 代码（一个简单的 CGI 脚本）</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># -*- coding: UTF-8 -*-</span>
​
<span class="hljs-comment"># 引入cgi模块，方便处理CGI请求</span>
<span class="hljs-keyword">import</span> cgi
<span class="hljs-keyword">import</span> cgitb
​
<span class="hljs-comment"># 开启调试模式，出错时会在浏览器显示详细信息</span>
cgitb.enable()
​
<span class="hljs-comment"># 创建FieldStorage实例，用于获取表单数据</span>
form = cgi.FieldStorage()
​
<span class="hljs-comment"># 获取表单中名为'name'的字段值</span>
user_name = form.getvalue(<span class="hljs-string">'name'</span>, <span class="hljs-string">'路人甲'</span>)
​
<span class="hljs-comment"># ---- CGI脚本的核心：输出 ----</span>
<span class="hljs-comment"># 1. 首先，必须输出一个Content-type头，告诉浏览器我们发送的是HTML</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Content-type:text/html\n\n"</span>)
​
<span class="hljs-comment"># 2. 接着，输出HTML内容</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"&lt;html&gt;"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"&lt;head&gt;"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"&lt;title&gt;CGI 脚本初体验&lt;/title&gt;"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"&lt;/head&gt;"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"&lt;body&gt;"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"&lt;h2&gt;你好, <span class="hljs-subst">{user_name}</span>! 欢迎来到CGI的魔法世界！&lt;/h2&gt;"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"&lt;/body&gt;"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"&lt;/html&gt;"</span>)
</code></pre>
<blockquote>
<p><strong>注意</strong>：要运行 CGI 脚本，你需要一个配置好的 Web 服务器（如 Apache 或 Nginx），并将脚本放在指定的 <code>cgi-bin</code> 目录下，同时赋予它可执行权限。对于现代 Web 开发来说，直接手写 CGI 已经比较少见了，因为它效率不高，而且每次请求都要创建一个新进程，开销很大。于是，更高级的“烹饪工具”——Web 框架，就应运而生了。</p>
</blockquote>
<h3 data-id="heading-6">2. Python Web 框架：告别“刀耕火种”</h3>
<blockquote>
<p>如果说手写 CGI 是“刀耕火种”，那 <strong>Web 框架</strong>就是现代化的“联合收割机”！它们把 Web 开发的各种脏活累活（比如路由、模板渲染、数据库连接、用户认证等）都帮你封装好了，让你能专注于业务逻辑的实现，而不是天天跟 HTTP 协议和服务器配置打交道。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9312fc28beb41c9a743101e49f6eba9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeWQjuerr-eahEFp5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771094568&amp;x-signature=rurz6ji%2B4YFDOt4borhjaM1uCas%3D" alt="Flask 动漫图" loading="lazy"/></p>
<p><strong>专业解释</strong>：Web 框架是一套提供了构建 Web 应用所需核心功能的库和工具。它们遵循一定的架构模式（如 MVC 或 MVT），通过提供路由系统、模板引擎、ORM（对象关系映射）、会话管理等组件，极大地简化了 Web 应用的开发流程，提高了开发效率和代码的可维护性。</p>
<p><strong>大白话解读</strong>：你想盖个房子，Web 框架就是那个已经帮你打好地基、建好承重墙、铺好水电管道的“半成品”。你只需要根据自己的喜好，装修一下墙面、摆放家具（编写业务代码）就行了，省时又省力。</p>
<p><strong>生活案例</strong>：你想做一道复杂的佛跳墙，自己从头准备鲍鱼、海参、鱼翅……那得累死。Web 框架就像是超市里卖的“佛跳墙半成品料理包”，所有食材都帮你处理好了，你只需要回家按照说明书，简单加热一下就能享受美味。</p>
<p><strong>示例 Python 代码（使用 Flask 框架）</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 安装Flask: pip install Flask</span>
from flask import Flask, request, render_template_string
​
<span class="hljs-comment"># 创建一个Flask应用实例</span>
<span class="hljs-attr">app</span> = Flask(__name__)
​
<span class="hljs-comment"># 定义一个HTML模板，用于显示欢迎信息</span>
<span class="hljs-attr">HTML_TEMPLATE</span> = <span class="hljs-string">"""
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Flask Web App&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;你好, {{ name }}!&lt;/h1&gt;
    &lt;p&gt;欢迎来到Flask的奇妙世界！&lt;/p&gt;
    &lt;form method="post"&gt;
        &lt;label for="name"&gt;输入你的名字:&lt;/label&gt;
        &lt;input type="text" id="name" name="name"&gt;
        &lt;button type="submit"&gt;提交&lt;/button&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
"""</span>
​
<span class="hljs-comment"># 定义路由：当用户访问网站根目录时，执行这个函数</span>
@app.route('/', <span class="hljs-attr">methods</span>=[<span class="hljs-string">'GET'</span>, <span class="hljs-string">'POST'</span>])
def hello():
    <span class="hljs-attr">user_name</span> = <span class="hljs-string">'路人甲'</span>
    if <span class="hljs-attr">request.method</span> == <span class="hljs-string">'POST'</span>:
        <span class="hljs-comment"># 如果是POST请求，就从表单里获取名字</span>
        <span class="hljs-attr">user_name</span> = request.form.get(<span class="hljs-string">'name'</span>, <span class="hljs-string">'路人甲'</span>)
    <span class="hljs-comment"># 使用模板渲染页面，并传入名字</span>
    return render_template_string(HTML_TEMPLATE, <span class="hljs-attr">name</span>=user_name)
​
<span class="hljs-comment"># 如果这个脚本是直接运行的，就启动Web服务器</span>
if <span class="hljs-attr">__name__</span> == <span class="hljs-string">'__main__'</span>:
    <span class="hljs-comment"># 开启调试模式，这样修改代码后服务器会自动重启</span>
    app.run(<span class="hljs-attr">debug</span>=<span class="hljs-literal">True</span>)
</code></pre>
<blockquote>
<p><strong>小结一下</strong>：CGI 是 Web 动态化的“老祖宗”，它奠定了基础，但现在我们有了更强大的 Web 框架。无论是轻巧灵活的 <strong>Flask</strong>、<strong>FastAPI</strong>，还是功能全面的“巨无霸”<strong>Django</strong>，它们都能让你以前所未有的速度构建出功能强大的 Web 应用。所以，别再纠结于 CGI 的细节了，大胆拥抱 Web 框架吧！</p>
</blockquote>
<h2 data-id="heading-7">三、Web 服务：程序间的“秘密通道”<a id="user-content-web-service" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57eaab3f3d5b47c99951ac3ed2dd9687~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeWQjuerr-eahEFp5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771094568&amp;x-signature=DmuOkVwmtDWhCtTewRNJjawqorE%3D" alt="Web 服务动漫图" loading="lazy"/></p>
<blockquote>
<p>想象一下，你的程序是个“社交达人”，它不仅能自己处理数据，还想和别的程序“聊天”，交换信息，甚至让别的程序帮它干活。这时候，<strong>Web 服务</strong>就登场了！它就像程序之间约定好的“秘密通道”和“通用语言”，让不同系统、不同语言开发的程序也能无障碍地沟通协作。</p>
</blockquote>
<p><strong>专业解释</strong>：Web 服务是一种基于 Web 的、可编程的应用程序组件，它允许不同应用程序之间通过网络进行交互。它通常使用标准化的协议（如 HTTP、XML、JSON）来传输数据，并提供一套接口供其他应用程序调用，从而实现分布式计算和系统集成。</p>
<p><strong>大白话解读</strong>：你的手机 App 想知道今天的天气，它不会自己去测量气温、风速，而是会去问“天气预报服务”这个专门提供天气信息的“程序”。这个“问”和“答”的过程，就是 Web 服务在发挥作用。</p>
<p><strong>生活案例</strong>：你用支付宝或者微信支付，你的支付 App 并没有直接和银行的系统打交道，而是通过调用银行提供的支付 Web 服务来完成交易。Web 服务就像一个“翻译官”，让不同“国家”（系统）的程序能够互相理解。</p>
<h3 data-id="heading-8">1. XML-RPC 与 SOAP：远程调用的“双雄”</h3>
<blockquote>
<p>在 Web 服务的早期，<strong>XML-RPC</strong> 和 <strong>SOAP</strong> 是两个非常流行的“老牌选手”。它们都致力于解决一个核心问题：如何让一个程序调用另一个远程程序的功能，就像调用本地函数一样简单。</p>
</blockquote>
<p><strong>专业解释</strong>：</p>
<ul>
<li><strong>XML-RPC</strong>（XML Remote Procedure Call）是一种基于 XML 和 HTTP 的轻量级远程过程调用协议。它允许客户端程序调用远程服务器上的函数或方法，并将请求和响应数据封装在 XML 格式中，通过 HTTP 进行传输。它的特点是简单、易于实现。</li>
<li><strong>SOAP</strong>（Simple Object Access Protocol）也是一种基于 XML 的协议，用于在分布式环境中交换结构化信息。与 XML-RPC 相比，SOAP 更为复杂和强大，它支持更丰富的数据类型、更复杂的传输机制（如 HTTP、SMTP 等），并提供了更严格的规范和安全性特性。SOAP 通常与 WSDL（Web Services Description Language）结合使用，WSDL 用于描述 Web 服务的接口和操作。</li>
</ul>
<p><strong>大白话解读</strong>：</p>
<ul>
<li><strong>XML-RPC</strong> 就像是两个朋友之间用“明信片”交流，明信片上写着“请帮我做这件事”，然后寄过去，收到回信就知道结果了。简单直接。</li>
<li><strong>SOAP</strong> 则像是一份严谨的“外交公文”，里面不仅详细说明了“请帮我做这件事”，还规定了公文的格式、加密方式、谁来签收等等。虽然有点繁琐，但非常正式和安全。</li>
</ul>
<p><strong>示例 Python 代码（XML-RPC 客户端）</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 假设有一个XML-RPC服务器运行在 http://localhost:8000/RPC2</span>
<span class="hljs-comment"># 服务器端代码（例如：server.py）可能如下：</span>
<span class="hljs-comment"># from xmlrpc.server import SimpleXMLRPCServer</span>
<span class="hljs-comment"># def add(x, y): return x + y</span>
<span class="hljs-comment"># server = SimpleXMLRPCRPCServer(("localhost", 8000))</span>
<span class="hljs-comment"># server.register_function(add, "add")</span>
<span class="hljs-comment"># server.serve_forever()</span>
​
<span class="hljs-keyword">import</span> xmlrpc.client
​
<span class="hljs-keyword">def</span> <span class="hljs-title function_">xmlrpc_client_example</span>():
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 连接到XML-RPC服务器</span>
        proxy = xmlrpc.client.ServerProxy(<span class="hljs-string">"http://localhost:8000/RPC2"</span>)
        
        <span class="hljs-comment"># 调用远程服务器上的add方法</span>
        result = proxy.add(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"XML-RPC 调用结果：5 + 3 = <span class="hljs-subst">{result}</span>"</span>)
        
        <span class="hljs-comment"># 尝试调用一个不存在的方法</span>
        <span class="hljs-keyword">try</span>:
            proxy.subtract(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>)
        <span class="hljs-keyword">except</span> xmlrpc.client.Fault <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"XML-RPC 错误示例：<span class="hljs-subst">{e}</span>"</span>)
​
    <span class="hljs-keyword">except</span> ConnectionRefusedError:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"错误：无法连接到XML-RPC服务器。请确保服务器已启动并运行在 http://localhost:8000/RPC2"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"发生错误：<span class="hljs-subst">{e}</span>"</span>)
​
<span class="hljs-comment"># 运行示例</span>
<span class="hljs-comment"># xmlrpc_client_example() # 运行时请确保有XML-RPC服务器在运行</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"XML-RPC 客户端示例代码已准备好，请启动一个XML-RPC服务器后尝试运行。"</span>)
</code></pre>
<blockquote>
<p><strong>小提示</strong>：虽然 XML-RPC 和 SOAP 在历史上扮演了重要角色，但它们在现代 Web 开发中已经逐渐被更轻量级、更灵活的技术所取代，比如接下来要介绍的 RESTful API。</p>
</blockquote>
<h3 data-id="heading-9">2. RESTful API：现代 Web 服务的“王者”</h3>
<blockquote>
<p>如果说 XML-RPC 和 SOAP 是“传统武术”，那 <strong>RESTful API</strong> 就是 Web 服务领域的“现代格斗术”！它更简洁、更高效、更符合 Web 的本质，已经成为构建现代 Web 服务的主流方式。</p>
</blockquote>
<p><strong>专业解释</strong>：REST（Representational State Transfer，表述性状态转移）是一种架构风格，而不是协议。RESTful API 是遵循 REST 架构风格的 API 设计。它主要基于 HTTP 协议，利用 HTTP 方法（GET、POST、PUT、DELETE 等）对资源进行操作，并通过 URL 来标识资源。数据通常以 JSON 或 XML 格式传输，具有无状态性、统一接口、分层系统等特点。</p>
<p><strong>大白话解读</strong>：你把 Web 看作一个巨大的图书馆，每本书（资源）都有一个唯一的编号（URL）。你想看书（GET），就告诉管理员书的编号；你想借书（POST），就告诉管理员书的编号和你的信息；你想更新书的信息（PUT），就告诉管理员书的编号和新的信息；你想还书（DELETE），就告诉管理员书的编号。整个过程非常直观，就像和图书馆管理员打交道一样。</p>
<p><strong>生活案例</strong>：你用外卖 App 点餐，App 会向外卖平台的 API 发送一个请求（POST），告诉它你要点什么菜、送到哪里。外卖平台收到请求后，处理订单，然后通过 API 返回一个订单成功的消息。这个过程就是典型的 RESTful API 交互。</p>
<p><strong>示例 Python 代码（使用 <code>requests</code> 库调用 RESTful API）</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
​
<span class="hljs-keyword">def</span> <span class="hljs-title function_">rest_api_example</span>():
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 假设我们调用一个公共的API，例如获取GitHub用户信息</span>
        username = <span class="hljs-string">"octocat"</span> <span class="hljs-comment"># GitHub的默认测试用户</span>
        api_url = <span class="hljs-string">f"https://api.github.com/users/<span class="hljs-subst">{username}</span>"</span>
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"正在从 <span class="hljs-subst">{api_url}</span> 获取用户信息..."</span>)
        
        <span class="hljs-comment"># 发送GET请求</span>
        response = requests.get(api_url)
        
        <span class="hljs-comment"># 检查请求是否成功 (状态码200)</span>
        response.raise_for_status() 
        
        <span class="hljs-comment"># 解析JSON响应</span>
        user_data = response.json()
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n获取到的用户信息："</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"用户名: <span class="hljs-subst">{user_data.get(<span class="hljs-string">"login"</span>)}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"姓名: <span class="hljs-subst">{user_data.get(<span class="hljs-string">"name"</span>, <span class="hljs-string">"N/A"</span>)}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"公司: <span class="hljs-subst">{user_data.get(<span class="hljs-string">"company"</span>, <span class="hljs-string">"N/A"</span>)}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"粉丝数: <span class="hljs-subst">{user_data.get(<span class="hljs-string">"followers"</span>)}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"关注数: <span class="hljs-subst">{user_data.get(<span class="hljs-string">"following"</span>)}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"个人主页: <span class="hljs-subst">{user_data.get(<span class="hljs-string">"html_url"</span>)}</span>"</span>)
        
    <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"请求GitHub API失败：<span class="hljs-subst">{e}</span>"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"发生错误：<span class="hljs-subst">{e}</span>"</span>)
​
<span class="hljs-comment"># 运行示例</span>
rest_api_example()
</code></pre>
<blockquote>
<p><strong>总结一下</strong>：Web 服务让程序之间能够“手拉手”一起干活，XML-RPC 和 SOAP 是早期的“握手方式”，而 RESTful API 则是现代程序之间最流行的“社交礼仪”。掌握了它们，你的程序就能在互联网上“呼风唤雨”了！</p>
</blockquote>
<h2 data-id="heading-10">四、拓展方案：让你的技能包更“鼓”<a id="user-content-expansion" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></h2>
<blockquote>
<p>学完了基础知识，是不是觉得意犹未尽？别急，Python 在 Web 领域的“十八般武艺”可不止这些！接下来，我们再来看看几个能让你在 Web 世界里“如虎添翼”的进阶技能，让你的技能包瞬间“鼓”起来！</p>
</blockquote>
<h3 data-id="heading-11">1. Scrapy 框架：工业级爬虫利器</h3>
<blockquote>
<p>如果说 Beautiful Soup 是“万能工具箱”，那 <strong>Scrapy</strong> 就是“全自动生产线”！当你需要大规模、高效率地从网站上抓取数据时，Scrapy 就是你的不二之选。它是一个功能强大、高度可定制的 Python 爬虫框架，专为数据抓取和处理而生。</p>
</blockquote>
<p><strong>专业解释</strong>：Scrapy 是一个用于抓取网站并从网页中提取结构化数据的应用框架。它提供了一整套组件，包括调度器、下载器、爬虫、管道等，支持异步请求处理，能够高效地处理大量并发请求，并提供了强大的数据处理和存储机制。</p>
<p><strong>大白话解读</strong>：你不是想“搬运”数据吗？Scrapy 就是那个能帮你搭建一个“自动化数据工厂”的框架。你告诉它去哪里“搬”，搬什么，怎么“搬”，它就能自己吭哧吭哧地帮你把数据搬回来，而且搬得又快又好，还能帮你把数据整理得整整齐齐。</p>
<p><strong>生活案例</strong>：你开了一家电商网站，想知道竞争对手的商品价格和库存。如果手动去查，那得查到猴年马月。Scrapy 就像你的“商业情报机器人”，能自动帮你监控竞争对手的网站，把所有商品信息都抓回来，让你随时掌握市场动态。</p>
<p><strong>示例 Python 代码（Scrapy 项目结构和核心代码片段）</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Scrapy项目通常通过命令行创建：scrapy startproject myproject</span>
<span class="hljs-comment"># 这是一个Scrapy爬虫的核心代码片段 (myproject/spiders/example_spider.py)</span>
​
<span class="hljs-keyword">import</span> scrapy
​
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleSpider</span>(scrapy.Spider):
    name = <span class="hljs-string">"example"</span>
    allowed_domains = [<span class="hljs-string">"quotes.toscrape.com"</span>]
    start_urls = [<span class="hljs-string">"http://quotes.toscrape.com/"</span>,]
​
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params">self, response</span>):
        <span class="hljs-comment"># 提取名言和作者</span>
        <span class="hljs-keyword">for</span> quote <span class="hljs-keyword">in</span> response.css(<span class="hljs-string">"div.quote"</span>):
            <span class="hljs-keyword">yield</span> {
                <span class="hljs-string">"text"</span>: quote.css(<span class="hljs-string">"span.text::text"</span>).get(),
                <span class="hljs-string">"author"</span>: quote.css(<span class="hljs-string">"small.author::text"</span>).get(),
                <span class="hljs-string">"tags"</span>: quote.css(<span class="hljs-string">"div.tags a.tag::text"</span>).getall(),
            }
        
        <span class="hljs-comment"># 翻页逻辑</span>
        next_page = response.css(<span class="hljs-string">"li.next a::attr(href)"</span>).get()
        <span class="hljs-keyword">if</span> next_page <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">yield</span> response.follow(next_page, callback=self.parse)
​
<span class="hljs-comment"># 运行Scrapy爬虫：在项目根目录执行 scrapy crawl example</span>
</code></pre>
<blockquote>
<p><strong>Scrapy 小贴士</strong>：Scrapy 的强大之处在于其高度的模块化和可扩展性。你可以自定义下载中间件、爬虫中间件、管道等，实现各种复杂的抓取逻辑和数据处理需求。对于需要处理反爬、分布式抓取等高级场景，Scrapy 绝对是你的得力助手！</p>
</blockquote>
<h3 data-id="heading-12">2. FastAPI：打造高性能 API 的“新贵”</h3>
<blockquote>
<p>如果你觉得 Flask 已经很棒了，那 <strong>FastAPI</strong> 会让你惊呼“还有这种操作？！”。它是一个现代、快速（高性能）、基于 Python 标准类型提示的 Web 框架，用于构建 API。如果你想快速开发高性能的 API 服务，FastAPI 绝对是你的“心头好”。</p>
</blockquote>
<p><strong>专业解释</strong>：FastAPI 是一个高性能的 Web 框架，它基于 Starlette（用于 Web 部分）和 Pydantic（用于数据验证和序列化）。它利用 Python 3.6+ 的类型提示，自动生成 OpenAPI（以前称为 Swagger）文档，并提供数据验证、依赖注入等功能，使得 API 开发变得极其高效和愉快。</p>
<p><strong>大白话解读</strong>：你想开个“数据接口商店”，让别人能方便地从你这里获取数据。FastAPI 就像一个“智能店长”，你告诉它你的“商品”（数据接口）长什么样，它就能自动帮你把“商品说明书”（API 文档）写好，还能帮你检查顾客的“订单”（请求参数）是不是合规，确保你的“商店”高效运转。</p>
<p><strong>生活案例</strong>：你开发了一个 App，需要从服务器获取用户数据、商品列表等。FastAPI 就是那个帮你搭建“数据中转站”的工具，它能以闪电般的速度响应 App 的请求，让你的 App 体验飞沙走石。</p>
<p><strong>示例 Python 代码</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 安装FastAPI和Uvicorn: pip install fastapi uvicorn</span>
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel

<span class="hljs-comment"># 创建FastAPI应用实例</span>
app = FastAPI()

<span class="hljs-comment"># 定义请求体的数据模型</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Item</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    name: <span class="hljs-built_in">str</span>
    price: <span class="hljs-built_in">float</span>
    is_offer: <span class="hljs-built_in">bool</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>

<span class="hljs-comment"># 定义一个根路径的GET请求</span>
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_root</span>():
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"欢迎来到FastAPI的世界！"</span>}

<span class="hljs-comment"># 定义一个带路径参数的GET请求</span>
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/items/{item_id}"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_item</span>(<span class="hljs-params">item_id: <span class="hljs-built_in">int</span>, q: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span></span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"item_id"</span>: item_id, <span class="hljs-string">"q"</span>: q}

<span class="hljs-comment"># 定义一个POST请求，接收JSON数据</span>
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/items/"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_item</span>(<span class="hljs-params">item: Item</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"Item received"</span>, <span class="hljs-string">"item"</span>: item}

<span class="hljs-comment"># 运行FastAPI应用：uvicorn main:app --reload</span>
</code></pre>
<blockquote>
<p><strong>FastAPI 的魅力</strong>：FastAPI 的自动文档生成功能简直是开发者的福音！你不需要额外编写 API 文档，它会根据你的代码自动生成交互式的 Swagger UI 和 ReDoc 文档，让你的 API 接口一目了然。同时，其异步支持也让它在处理高并发场景时表现出色。</p>
</blockquote>
<h3 data-id="heading-13">3. Selenium：驾驭“动态”网页的“终极武器”</h3>
<blockquote>
<p>现在的网页越来越“聪明”，很多内容都是通过 JavaScript 动态加载的，或者需要你点击、滚动才能显示出来。这时候，传统的屏幕抓取工具可能就“傻眼”了。别担心，<strong>Selenium</strong> 就是那个能让你“模拟真人”操作浏览器的“终极武器”！</p>
</blockquote>
<p><strong>专业解释</strong>：Selenium 是一个用于 Web 应用程序测试的工具，但它也可以被广泛应用于 Web 抓取。它允许开发者通过编程方式控制浏览器（如 Chrome、Firefox），模拟用户的各种行为，如点击按钮、填写表单、执行 JavaScript、滚动页面等，从而获取动态加载的内容。</p>
<p><strong>大白话解读</strong>：有些网站很“狡猾”，你直接用代码去访问，它给你看的是“毛坯房”，什么都没有。但你用浏览器打开，它就给你装修得漂漂亮亮。Selenium 就是那个能帮你“开着浏览器”去访问网站的工具，它能像真人一样点击、输入、等待，直到所有内容都加载出来，然后你再“截图”（抓取数据）。</p>
<p><strong>生活案例</strong>：你想抢购某个限量商品，但商品页面需要登录、点击多个按钮、等待加载才能看到抢购按钮。Selenium 就像你的“自动抢购机器人”，它能自动帮你完成所有这些操作，甚至比你手动操作还快！</p>
<p><strong>示例 Python 代码</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 安装Selenium和对应浏览器的WebDriver：pip install selenium</span>
<span class="hljs-comment"># 需要下载对应浏览器的WebDriver，例如ChromeDriver，并将其路径添加到系统PATH中</span>

<span class="hljs-keyword">from</span> selenium <span class="hljs-keyword">import</span> webdriver
<span class="hljs-keyword">from</span> selenium.webdriver.common.by <span class="hljs-keyword">import</span> By
<span class="hljs-keyword">from</span> selenium.webdriver.support.ui <span class="hljs-keyword">import</span> WebDriverWait
<span class="hljs-keyword">from</span> selenium.webdriver.support <span class="hljs-keyword">import</span> expected_conditions <span class="hljs-keyword">as</span> EC
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">def</span> <span class="hljs-title function_">selenium_example</span>():
    <span class="hljs-comment"># 初始化Chrome浏览器驱动</span>
    <span class="hljs-comment"># 确保你的ChromeDriver路径正确，或者已添加到系统PATH</span>
    driver = webdriver.Chrome()
    driver.maximize_window() <span class="hljs-comment"># 最大化窗口，有时有助于避免元素不可见问题</span>

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 访问一个需要动态加载内容的网站，这里以一个简单的示例网站代替</span>
        <span class="hljs-comment"># 实际应用中，可以是需要登录、点击加载更多的网站</span>
        driver.get(<span class="hljs-string">"https://www.python.org/"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"成功访问：<span class="hljs-subst">{driver.current_url}</span>"</span>)

        <span class="hljs-comment"># 等待某个元素加载完成，例如等待导航栏的某个链接出现</span>
        <span class="hljs-comment"># WebDriverWait(driver, 10).until(</span>
        <span class="hljs-comment">#     EC.presence_of_element_located((By.ID, "id-of-an-element"))</span>
        <span class="hljs-comment"># )</span>
        
        <span class="hljs-comment"># 模拟点击某个链接，例如点击"About"菜单</span>
        about_link = driver.find_element(By.LINK_TEXT, <span class="hljs-string">"About"</span>)
        about_link.click()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"点击了About链接"</span>)
        
        <span class="hljs-comment"># 等待页面跳转或内容加载</span>
        time.sleep(<span class="hljs-number">2</span>) <span class="hljs-comment"># 简单的等待，实际应使用WebDriverWait</span>
        
        <span class="hljs-comment"># 获取当前页面的标题</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"当前页面标题：<span class="hljs-subst">{driver.title}</span>"</span>)
        
        <span class="hljs-comment"># 获取页面内容（包括JS渲染后的）</span>
        <span class="hljs-comment"># page_source = driver.page_source</span>
        <span class="hljs-comment"># print(page_source[:500]) # 打印前500个字符</span>

    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Selenium操作失败：<span class="hljs-subst">{e}</span>"</span>)
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-comment"># 关闭浏览器</span>
        driver.quit()

<span class="hljs-comment"># 运行示例</span>
selenium_example()
</code></pre>
<blockquote>
<p><strong>Selenium 的强大</strong>：Selenium 不仅能抓取数据，还能用于自动化测试、模拟用户行为等。当你需要处理验证码、登录、点击、滚动等复杂交互时，Selenium 就是你的“瑞士军刀”。但它也有缺点，就是运行速度相对较慢，资源消耗较大，因为它需要真正启动一个浏览器。</p>
</blockquote>
<h2 data-id="heading-14">五、总结与互动：是时候展现真正的技术了！<a id="user-content-summary-interaction" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></h2>
<blockquote>
<p>好了，各位编程小能手们，今天的 Python Web 之旅就到这里啦！我们一起探索了如何从 Web 世界“捞金”（屏幕抓取），如何让你的网页“活”起来（CGI 与 Web 框架），以及如何让程序之间“隔空对话”（Web 服务）。是不是感觉 Python 在 Web 领域简直是无所不能？</p>
</blockquote>
<blockquote>
<p>从最初的正则表达式“文本手术刀”，到 Beautiful Soup 的“万能工具箱”，再到 Web 框架的“自动化生产线”，以及 Web 服务的“秘密通道”，Python 为我们打开了通往 Web 世界的大门。无论是想成为一个数据侦探，还是一个 Web 应用架构师，亦或是一个 API 设计师，Python 都能助你一臂之力！</p>
</blockquote>
<blockquote>
<p><strong>现在，是时候展现真正的技术了！</strong></p>
</blockquote>
<blockquote>
<ol>
<li><strong>你最喜欢 Python 在 Web 领域的哪个“超能力”？</strong> 是屏幕抓取的“数据魔法”，还是 Web 框架的“建站神速”？在评论区告诉我你的选择和理由吧！</li>
<li><strong>你有没有遇到过特别“奇葩”的网页，让你抓取数据抓到头秃？</strong> 快来分享你的“血泪史”和解决方案，让大家一起避坑！</li>
<li><strong>对于今天讲到的内容，你还有哪些“脑洞大开”的拓展想法？</strong> 比如，除了爬虫，你还想用 Python 在 Web 上玩出什么新花样？</li>
</ol>
</blockquote>
<blockquote>
<p>期待在评论区看到你们的精彩留言，一起交流，一起进步！</p>
</blockquote>
<p><strong>转载声明</strong>：</p>
<p>本文为原创文章，版权归 <strong>Java 后端的 Ai 之路</strong> 所有。欢迎转载，转载请务必注明出处，并附上原文链接。未经授权，禁止用于商业用途。如有侵权，必将追究法律责任。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Go 嵌入结构体方法访问全解析：从基础到进阶陷阱]]></title>    <link>https://juejin.cn/post/7603688142004289545</link>    <guid>https://juejin.cn/post/7603688142004289545</guid>    <pubDate>2026-02-08T01:21:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603688142004289545" data-draft-id="7600752623068397578" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Go 嵌入结构体方法访问全解析：从基础到进阶陷阱"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-08T01:21:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="golang学习记"/> <meta itemprop="url" content="https://juejin.cn/user/4371313964100990"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Go 嵌入结构体方法访问全解析：从基础到进阶陷阱
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4371313964100990/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    golang学习记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T01:21:07.000Z" title="Sun Feb 08 2026 01:21:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>核心概念</strong>：Go 的嵌入（embedding）不是继承，而是<strong>组合的语法糖</strong>。理解这一点，才能避免 90% 的嵌入陷阱。</p>
</blockquote>
<h2 data-id="heading-0">一、嵌入基础：什么是结构体嵌入？</h2>
<h3 data-id="heading-1">1.1 嵌入 vs 继承</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Java/C++ 风格的继承（Go 不支持！）</span>
class Animal {
    void eat() { ... }
}

class Dog extends Animal {  <span class="hljs-comment">// 继承</span>
    void bark() { ... }
}

<span class="hljs-comment">// Go 风格的嵌入（组合）</span>
<span class="hljs-keyword">type</span> Animal <span class="hljs-keyword">struct</span> {
    name <span class="hljs-type">string</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a Animal)</span></span> Eat() {
    fmt.Printf(<span class="hljs-string">"%s is eating\n"</span>, a.name)
}

<span class="hljs-keyword">type</span> Dog <span class="hljs-keyword">struct</span> {
    Animal  <span class="hljs-comment">// 嵌入，不是继承！</span>
    breed  <span class="hljs-type">string</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d Dog)</span></span> Bark() {
    fmt.Printf(<span class="hljs-string">"%s is barking\n"</span>, d.name)
}
</code></pre>
<p><strong>关键区别</strong>：</p>






























<table><thead><tr><th>特性</th><th>继承（OOP）</th><th>嵌入（Go）</th></tr></thead><tbody><tr><td><strong>关系</strong></td><td>"is-a"（狗是一种动物）</td><td>"has-a"（狗有一个动物）</td></tr><tr><td><strong>方法集</strong></td><td>子类继承父类所有方法</td><td>外层结构体"提升"内层方法</td></tr><tr><td><strong>多态</strong></td><td>支持（虚函数）</td><td>不支持（无类型层次）</td></tr><tr><td><strong>耦合度</strong></td><td>高（紧耦合）</td><td>低（松耦合）</td></tr></tbody></table>
<h3 data-id="heading-2">1.2 嵌入的三种写法</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Base <span class="hljs-keyword">struct</span> {
    value <span class="hljs-type">int</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b Base)</span></span> Method() {
    fmt.Println(<span class="hljs-string">"Base.Method:"</span>, b.value)
}

<span class="hljs-comment">// 写法1：匿名嵌入（最常用）</span>
<span class="hljs-keyword">type</span> Embedded1 <span class="hljs-keyword">struct</span> {
    Base  <span class="hljs-comment">// 匿名字段</span>
}

<span class="hljs-comment">// 写法2：命名嵌入（显式字段名）</span>
<span class="hljs-keyword">type</span> Embedded2 <span class="hljs-keyword">struct</span> {
    base Base  <span class="hljs-comment">// 命名字段</span>
}

<span class="hljs-comment">// 写法3：接口嵌入</span>
<span class="hljs-keyword">type</span> Getter <span class="hljs-keyword">interface</span> {
    Get() <span class="hljs-type">int</span>
}

<span class="hljs-keyword">type</span> Impl <span class="hljs-keyword">struct</span> {
    Getter  <span class="hljs-comment">// 嵌入接口</span>
}
</code></pre>
<h2 data-id="heading-3">二、方法访问规则：提升（Promotion）机制</h2>
<h3 data-id="heading-4">2.1 匿名嵌入：方法自动"提升"</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> {
    Name <span class="hljs-type">string</span>
    Age  <span class="hljs-type">int</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p Person)</span></span> SayHello() {
    fmt.Printf(<span class="hljs-string">"Hello, I'm %s, %d years old\n"</span>, p.Name, p.Age)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p Person)</span></span> Work() {
    fmt.Printf(<span class="hljs-string">"%s is working\n"</span>, p.Name)
}

<span class="hljs-keyword">type</span> Employee <span class="hljs-keyword">struct</span> {
    Person      <span class="hljs-comment">// 匿名嵌入</span>
    Company     <span class="hljs-type">string</span>
    Salary      <span class="hljs-type">float64</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e Employee)</span></span> GetSalary() <span class="hljs-type">float64</span> {
    <span class="hljs-keyword">return</span> e.Salary
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    emp := Employee{
        Person:  Person{Name: <span class="hljs-string">"Alice"</span>, Age: <span class="hljs-number">30</span>},
        Company: <span class="hljs-string">"Tech Corp"</span>,
        Salary:  <span class="hljs-number">80000</span>,
    }
    
    <span class="hljs-comment">// ✅ 可以直接调用提升的方法</span>
    emp.SayHello()   <span class="hljs-comment">// Hello, I'm Alice, 30 years old</span>
    emp.Work()       <span class="hljs-comment">// Alice is working</span>
    emp.GetSalary()  <span class="hljs-comment">// 80000</span>
    
    <span class="hljs-comment">// ✅ 也可以通过嵌入类型名访问</span>
    emp.Person.SayHello()  <span class="hljs-comment">// 效果相同</span>
    
    <span class="hljs-comment">// ✅ 访问嵌入字段</span>
    fmt.Println(emp.Name)      <span class="hljs-comment">// Alice</span>
    fmt.Println(emp.Person.Name) <span class="hljs-comment">// Alice（等价）</span>
}
</code></pre>
<p><strong>提升规则</strong>：</p>
<ol>
<li>匿名嵌入的字段和方法<strong>自动提升</strong>到外层结构体</li>
<li>提升的方法调用时，接收者是<strong>外层结构体的嵌入字段副本</strong></li>
<li>外层结构体可以<strong>覆盖（shadow）</strong> 提升的方法</li>
</ol>
<h3 data-id="heading-5">2.2 命名嵌入：必须通过字段名访问</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Employee2 <span class="hljs-keyword">struct</span> {
    person  Person  <span class="hljs-comment">// 命名字段，不会提升</span>
    Company <span class="hljs-type">string</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    emp := Employee2{
        person:  Person{Name: <span class="hljs-string">"Bob"</span>, Age: <span class="hljs-number">25</span>},
        Company: <span class="hljs-string">"Startup Inc"</span>,
    }
    
    <span class="hljs-comment">// ❌ 编译错误：SayHello 未提升</span>
    <span class="hljs-comment">// emp.SayHello()</span>
    
    <span class="hljs-comment">// ✅ 必须通过字段名访问</span>
    emp.person.SayHello()  <span class="hljs-comment">// Hello, I'm Bob, 25 years old</span>
    fmt.Println(emp.person.Name)  <span class="hljs-comment">// Bob</span>
}
</code></pre>
<h2 data-id="heading-6">三、深入陷阱：嵌入的 5 大坑点</h2>
<h3 data-id="heading-7">坑点1️⃣：值接收者 vs 指针接收者</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Counter <span class="hljs-keyword">struct</span> {
    count <span class="hljs-type">int</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c Counter)</span></span> GetValue() <span class="hljs-type">int</span> {  <span class="hljs-comment">// 值接收者</span>
    <span class="hljs-keyword">return</span> c.count
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Counter)</span></span> Increment() {  <span class="hljs-comment">// 指针接收者</span>
    c.count++
}

<span class="hljs-keyword">type</span> Widget <span class="hljs-keyword">struct</span> {
    Counter  <span class="hljs-comment">// 嵌入</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 情况1：值类型嵌入</span>
    w1 := Widget{Counter: Counter{count: <span class="hljs-number">0</span>}}
    fmt.Println(w1.GetValue())  <span class="hljs-comment">// ✅ 0（值接收者，可以调用）</span>
    <span class="hljs-comment">// w1.Increment()  // ❌ 编译错误！w1是值，不能调用指针接收者方法</span>
    
    <span class="hljs-comment">// 情况2：指针类型嵌入</span>
    w2 := &amp;Widget{Counter: Counter{count: <span class="hljs-number">0</span>}}
    fmt.Println(w2.GetValue())  <span class="hljs-comment">// ✅ 0</span>
    w2.Increment()              <span class="hljs-comment">// ✅ 可以调用</span>
    fmt.Println(w2.GetValue())  <span class="hljs-comment">// 1</span>
    
    <span class="hljs-comment">// 情况3：外层是指针，内层是值</span>
    w3 := &amp;Widget{Counter: Counter{count: <span class="hljs-number">0</span>}}
    w3.Increment()  <span class="hljs-comment">// ✅ 可以！Go 自动解引用</span>
    <span class="hljs-comment">// 等价于：(&amp;w3.Counter).Increment()</span>
}
</code></pre>
<p><strong>规则总结</strong>：</p>






























<table><thead><tr><th>外层类型</th><th>内层方法接收者</th><th>能否调用</th></tr></thead><tbody><tr><td>值</td><td>值</td><td>✅</td></tr><tr><td>值</td><td>指针</td><td>❌</td></tr><tr><td>指针</td><td>值</td><td>✅（自动解引用）</td></tr><tr><td>指针</td><td>指针</td><td>✅</td></tr></tbody></table>
<h3 data-id="heading-8">坑点2️⃣：方法覆盖（Shadowing）</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Base <span class="hljs-keyword">struct</span> {
    value <span class="hljs-type">int</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b Base)</span></span> Show() {
    fmt.Printf(<span class="hljs-string">"Base.Show: %d\n"</span>, b.value)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b Base)</span></span> GetValue() <span class="hljs-type">int</span> {
    <span class="hljs-keyword">return</span> b.value
}

<span class="hljs-keyword">type</span> Derived <span class="hljs-keyword">struct</span> {
    Base
    extra <span class="hljs-type">string</span>
}

<span class="hljs-comment">// 覆盖 Show 方法</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d Derived)</span></span> Show() {
    fmt.Printf(<span class="hljs-string">"Derived.Show: %d, %s\n"</span>, d.value, d.extra)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    d := Derived{
        Base:  Base{value: <span class="hljs-number">42</span>},
        extra: <span class="hljs-string">"hello"</span>,
    }
    
    d.Show()        <span class="hljs-comment">// ✅ Derived.Show: 42, hello（覆盖）</span>
    d.GetValue()    <span class="hljs-comment">// ✅ Base.GetValue: 42（继承）</span>
    
    <span class="hljs-comment">// 仍然可以通过嵌入类型名调用被覆盖的方法</span>
    d.Base.Show()   <span class="hljs-comment">// ✅ Base.Show: 42</span>
}
</code></pre>
<p><strong>关键洞察</strong>：</p>
<ul>
<li>嵌入不是继承，<strong>没有"重写"（override）概念</strong></li>
<li>外层定义同名方法只是<strong>遮蔽（shadow）</strong> 了提升的方法</li>
<li>被遮蔽的方法仍然可以通过 <code>d.Base.Show()</code> 访问</li>
</ul>
<h3 data-id="heading-9">坑点3️⃣：多层嵌入的歧义</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> A <span class="hljs-keyword">struct</span> {
    value <span class="hljs-type">int</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a A)</span></span> Method() {
    fmt.Println(<span class="hljs-string">"A.Method"</span>)
}

<span class="hljs-keyword">type</span> B <span class="hljs-keyword">struct</span> {
    value <span class="hljs-type">int</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b B)</span></span> Method() {
    fmt.Println(<span class="hljs-string">"B.Method"</span>)
}

<span class="hljs-comment">// C 同时嵌入 A 和 B</span>
<span class="hljs-keyword">type</span> C <span class="hljs-keyword">struct</span> {
    A
    B
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    c := C{A: A{value: <span class="hljs-number">1</span>}, B: B{value: <span class="hljs-number">2</span>}}
    
    <span class="hljs-comment">// ❌ 编译错误：ambiguous selector c.Method</span>
    <span class="hljs-comment">// c.Method()  // 到底调用 A.Method 还是 B.Method？</span>
    
    <span class="hljs-comment">// ✅ 必须显式指定</span>
    c.A.Method()  <span class="hljs-comment">// A.Method</span>
    c.B.Method()  <span class="hljs-comment">// B.Method</span>
}
</code></pre>
<p><strong>解决方案</strong>：定义自己的方法来消除歧义</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c C)</span></span> Method() {
    <span class="hljs-comment">// 自定义逻辑，或选择其一</span>
    c.A.Method()
    <span class="hljs-comment">// 或</span>
    fmt.Println(<span class="hljs-string">"C.Method: combining A and B"</span>)
}
</code></pre>
<h3 data-id="heading-10">坑点4️⃣：嵌入接口的实现要求</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Speaker <span class="hljs-keyword">interface</span> {
    Speak() <span class="hljs-type">string</span>
}

<span class="hljs-keyword">type</span> Animal <span class="hljs-keyword">struct</span> {
    name <span class="hljs-type">string</span>
}

<span class="hljs-comment">// Animal 没有实现 Speaker 接口</span>
<span class="hljs-comment">// func (a Animal) Speak() string { return a.name }</span>

<span class="hljs-keyword">type</span> Dog <span class="hljs-keyword">struct</span> {
    Animal
}

<span class="hljs-comment">// ❌ 编译错误：*Dog does not implement Speaker</span>
<span class="hljs-comment">// var _ Speaker = &amp;Dog{}</span>

<span class="hljs-comment">// ✅ 必须显式实现接口方法</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d Dog)</span></span> Speak() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> d.name + <span class="hljs-string">" says Woof!"</span>
}

<span class="hljs-keyword">var</span> _ Speaker = &amp;Dog{}  <span class="hljs-comment">// ✅ 现在可以了</span>
</code></pre>
<p><strong>重要规则</strong>：</p>
<ul>
<li>嵌入接口<strong>不会自动实现</strong>该接口</li>
<li>外层结构体必须<strong>显式实现</strong>接口的所有方法</li>
<li>嵌入接口主要用于<strong>组合接口</strong>，而非实现复用</li>
</ul>
<h3 data-id="heading-11">坑点5️⃣：嵌入字段的修改陷阱</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> {
    Port    <span class="hljs-type">int</span>
    Timeout time.Duration
}

<span class="hljs-keyword">type</span> Server <span class="hljs-keyword">struct</span> {
    Config  <span class="hljs-comment">// 嵌入</span>
    Name    <span class="hljs-type">string</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    s := Server{
        Config: Config{Port: <span class="hljs-number">8080</span>, Timeout: <span class="hljs-number">30</span> * time.Second},
        Name:   <span class="hljs-string">"MyServer"</span>,
    }
    
    <span class="hljs-comment">// ❌ 陷阱：修改提升字段不会影响原始嵌入字段</span>
    s.Port = <span class="hljs-number">9090</span>  <span class="hljs-comment">// 这实际上是 s.Config.Port = 9090</span>
    
    <span class="hljs-comment">// ✅ 正确理解：提升字段就是嵌入字段</span>
    fmt.Println(s.Config.Port)  <span class="hljs-comment">// 9090</span>
    
    <span class="hljs-comment">// 但如果通过指针传递...</span>
    modifyPort(s)
    fmt.Println(s.Port)  <span class="hljs-comment">// 仍然是 9090！</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">modifyPort</span><span class="hljs-params">(s Server)</span></span> {
    s.Port = <span class="hljs-number">9999</span>  <span class="hljs-comment">// 修改的是副本，不影响原值</span>
}
</code></pre>
<h2 data-id="heading-12">四、实战模式：嵌入的最佳实践</h2>
<h3 data-id="heading-13">模式1：Mixin 模式（功能组合）</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Logger mixin</span>
<span class="hljs-keyword">type</span> Logger <span class="hljs-keyword">struct</span> {
    prefix <span class="hljs-type">string</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l Logger)</span></span> Log(msg <span class="hljs-type">string</span>) {
    fmt.Printf(<span class="hljs-string">"[%s] %s\n"</span>, l.prefix, msg)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l Logger)</span></span> Error(msg <span class="hljs-type">string</span>) {
    fmt.Printf(<span class="hljs-string">"[ERROR][%s] %s\n"</span>, l.prefix, msg)
}

<span class="hljs-comment">// Cache mixin</span>
<span class="hljs-keyword">type</span> Cache <span class="hljs-keyword">struct</span> {
    data <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}
    sync.RWMutex
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Cache)</span></span> Get(key <span class="hljs-type">string</span>) (<span class="hljs-keyword">interface</span>{}, <span class="hljs-type">bool</span>) {
    c.RLock()
    <span class="hljs-keyword">defer</span> c.RUnlock()
    val, ok := c.data[key]
    <span class="hljs-keyword">return</span> val, ok
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Cache)</span></span> Set(key <span class="hljs-type">string</span>, val <span class="hljs-keyword">interface</span>{}) {
    c.Lock()
    <span class="hljs-keyword">defer</span> c.Unlock()
    c.data[key] = val
}

<span class="hljs-comment">// 组合使用</span>
<span class="hljs-keyword">type</span> UserService <span class="hljs-keyword">struct</span> {
    Logger
    *Cache
    db *sql.DB
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewUserService</span><span class="hljs-params">(db *sql.DB)</span></span> *UserService {
    <span class="hljs-keyword">return</span> &amp;UserService{
        Logger: Logger{prefix: <span class="hljs-string">"UserService"</span>},
        Cache:  &amp;Cache{data: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{})},
        db:     db,
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *UserService)</span></span> GetUser(id <span class="hljs-type">string</span>) (*User, <span class="hljs-type">error</span>) {
    s.Log(<span class="hljs-string">"Fetching user: "</span> + id)
    
    <span class="hljs-comment">// 先查缓存</span>
    <span class="hljs-keyword">if</span> cached, ok := s.Get(id); ok {
        s.Log(<span class="hljs-string">"Cache hit"</span>)
        <span class="hljs-keyword">return</span> cached.(*User), <span class="hljs-literal">nil</span>
    }
    
    <span class="hljs-comment">// 缓存未命中，查数据库</span>
    user := &amp;User{}
    err := s.db.QueryRow(<span class="hljs-string">"SELECT * FROM users WHERE id = ?"</span>, id).Scan(&amp;user.ID, &amp;user.Name)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        s.Error(<span class="hljs-string">"DB query failed: "</span> + err.Error())
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    
    <span class="hljs-comment">// 写入缓存</span>
    s.Set(id, user)
    <span class="hljs-keyword">return</span> user, <span class="hljs-literal">nil</span>
}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 代码复用：Logger 和 Cache 可在多个服务中复用</li>
<li>✅ 关注分离：每个 mixin 职责单一</li>
<li>✅ 灵活组合：按需嵌入不同功能</li>
</ul>
<h3 data-id="heading-14">模式2：装饰器模式（包装增强）</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Reader <span class="hljs-keyword">interface</span> {
    Read(p []<span class="hljs-type">byte</span>) (n <span class="hljs-type">int</span>, err <span class="hljs-type">error</span>)
}

<span class="hljs-comment">// 基础实现</span>
<span class="hljs-keyword">type</span> FileReader <span class="hljs-keyword">struct</span> {
    file *os.File
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(fr *FileReader)</span></span> Read(p []<span class="hljs-type">byte</span>) (n <span class="hljs-type">int</span>, err <span class="hljs-type">error</span>) {
    <span class="hljs-keyword">return</span> fr.file.Read(p)
}

<span class="hljs-comment">// 装饰器1：计数装饰器</span>
<span class="hljs-keyword">type</span> CountingReader <span class="hljs-keyword">struct</span> {
    Reader  <span class="hljs-comment">// 嵌入被装饰的 Reader</span>
    count   <span class="hljs-type">int64</span>
    mu      sync.Mutex
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(cr *CountingReader)</span></span> Read(p []<span class="hljs-type">byte</span>) (n <span class="hljs-type">int</span>, err <span class="hljs-type">error</span>) {
    n, err = cr.Reader.Read(p)  <span class="hljs-comment">// 调用被装饰者</span>
    cr.mu.Lock()
    cr.count += <span class="hljs-type">int64</span>(n)
    cr.mu.Unlock()
    <span class="hljs-keyword">return</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(cr *CountingReader)</span></span> BytesRead() <span class="hljs-type">int64</span> {
    cr.mu.Lock()
    <span class="hljs-keyword">defer</span> cr.mu.Unlock()
    <span class="hljs-keyword">return</span> cr.count
}

<span class="hljs-comment">// 装饰器2：缓冲装饰器</span>
<span class="hljs-keyword">type</span> BufferedReader <span class="hljs-keyword">struct</span> {
    Reader
    buf []<span class="hljs-type">byte</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(br *BufferedReader)</span></span> Read(p []<span class="hljs-type">byte</span>) (n <span class="hljs-type">int</span>, err <span class="hljs-type">error</span>) {
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(br.buf) == <span class="hljs-number">0</span> {
        <span class="hljs-comment">// 缓冲区空，从底层读取</span>
        br.buf = <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">4096</span>)
        _, err = br.Reader.Read(br.buf)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, err
        }
    }
    
    <span class="hljs-comment">// 从缓冲区返回数据</span>
    n = <span class="hljs-built_in">copy</span>(p, br.buf)
    br.buf = br.buf[n:]
    <span class="hljs-keyword">return</span> n, <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    file, _ := os.Open(<span class="hljs-string">"data.txt"</span>)
    <span class="hljs-keyword">defer</span> file.Close()
    
    <span class="hljs-comment">// 链式装饰</span>
    reader := &amp;CountingReader{
        Reader: &amp;BufferedReader{
            Reader: &amp;FileReader{file: file},
            buf:    <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">0</span>),
        },
    }
    
    data := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">100</span>)
    reader.Read(data)
    
    fmt.Printf(<span class="hljs-string">"Bytes read: %d\n"</span>, reader.BytesRead())
}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 开闭原则：对扩展开放，对修改关闭</li>
<li>✅ 灵活组合：可以任意组合装饰器</li>
<li>✅ 职责清晰：每个装饰器只做一件事</li>
</ul>
<h3 data-id="heading-15">模式3：接口嵌入（接口组合）</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 基础接口</span>
<span class="hljs-keyword">type</span> Reader <span class="hljs-keyword">interface</span> {
    Read(p []<span class="hljs-type">byte</span>) (n <span class="hljs-type">int</span>, err <span class="hljs-type">error</span>)
}

<span class="hljs-keyword">type</span> Writer <span class="hljs-keyword">interface</span> {
    Write(p []<span class="hljs-type">byte</span>) (n <span class="hljs-type">int</span>, err <span class="hljs-type">error</span>)
}

<span class="hljs-keyword">type</span> Closer <span class="hljs-keyword">interface</span> {
    Close() <span class="hljs-type">error</span>
}

<span class="hljs-comment">// 组合接口</span>
<span class="hljs-keyword">type</span> ReadCloser <span class="hljs-keyword">interface</span> {
    Reader
    Closer
}

<span class="hljs-keyword">type</span> WriteCloser <span class="hljs-keyword">interface</span> {
    Writer
    Closer
}

<span class="hljs-keyword">type</span> ReadWriteCloser <span class="hljs-keyword">interface</span> {
    Reader
    Writer
    Closer
}

<span class="hljs-comment">// 实现组合接口</span>
<span class="hljs-keyword">type</span> File <span class="hljs-keyword">struct</span> {
    <span class="hljs-comment">// ... 文件实现</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *File)</span></span> Read(p []<span class="hljs-type">byte</span>) (n <span class="hljs-type">int</span>, err <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 实现</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *File)</span></span> Write(p []<span class="hljs-type">byte</span>) (n <span class="hljs-type">int</span>, err <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 实现</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *File)</span></span> Close() <span class="hljs-type">error</span> {
    <span class="hljs-comment">// 实现</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// File 自动满足所有组合接口</span>
<span class="hljs-keyword">var</span> _ Reader = &amp;File{}
<span class="hljs-keyword">var</span> _ Writer = &amp;File{}
<span class="hljs-keyword">var</span> _ Closer = &amp;File{}
<span class="hljs-keyword">var</span> _ ReadCloser = &amp;File{}
<span class="hljs-keyword">var</span> _ WriteCloser = &amp;File{}
<span class="hljs-keyword">var</span> _ ReadWriteCloser = &amp;File{}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 接口最小化：每个基础接口职责单一</li>
<li>✅ 灵活组合：按需组合成更大的接口</li>
<li>✅ 向后兼容：添加新组合接口不影响现有实现</li>
</ul>
<h2 data-id="heading-16">五、性能分析：嵌入的开销</h2>
<h3 data-id="heading-17">5.1 内存布局</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Inner <span class="hljs-keyword">struct</span> {
    a <span class="hljs-type">int64</span>   <span class="hljs-comment">// 8 bytes</span>
    b <span class="hljs-type">int32</span>   <span class="hljs-comment">// 4 bytes (+4 padding)</span>
}

<span class="hljs-keyword">type</span> Outer <span class="hljs-keyword">struct</span> {
    Inner     <span class="hljs-comment">// 嵌入</span>
    c <span class="hljs-type">int64</span>   <span class="hljs-comment">// 8 bytes</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> o Outer
    fmt.Printf(<span class="hljs-string">"Size of Inner: %d bytes\n"</span>, unsafe.Sizeof(Inner{}))  <span class="hljs-comment">// 16 bytes</span>
    fmt.Printf(<span class="hljs-string">"Size of Outer: %d bytes\n"</span>, unsafe.Sizeof(o))        <span class="hljs-comment">// 24 bytes</span>
    
    <span class="hljs-comment">// 内存布局：</span>
    <span class="hljs-comment">// [Inner.a: 8 bytes][Inner.b: 4 bytes][padding: 4 bytes][c: 8 bytes]</span>
    <span class="hljs-comment">// 总计：24 bytes</span>
}
</code></pre>
<p><strong>结论</strong>：嵌入<strong>没有额外内存开销</strong>，只是内存布局的重新组织</p>
<h3 data-id="heading-18">5.2 方法调用性能</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Base <span class="hljs-keyword">struct</span> {
    value <span class="hljs-type">int</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b Base)</span></span> Method() <span class="hljs-type">int</span> {
    <span class="hljs-keyword">return</span> b.value * <span class="hljs-number">2</span>
}

<span class="hljs-keyword">type</span> Derived <span class="hljs-keyword">struct</span> {
    Base
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkDirect</span><span class="hljs-params">(b *testing.B)</span></span> {
    d := Derived{Base: Base{value: <span class="hljs-number">42</span>}}
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ {
        _ = d.Method()  <span class="hljs-comment">// 通过提升调用</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkExplicit</span><span class="hljs-params">(b *testing.B)</span></span> {
    d := Derived{Base: Base{value: <span class="hljs-number">42</span>}}
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ {
        _ = d.Base.Method()  <span class="hljs-comment">// 显式调用</span>
    }
}
</code></pre>
<p><strong>基准测试结果</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">BenchmarkDirect    1000000000    0.25 ns/op
BenchmarkExplicit  1000000000    0.25 ns/op
</code></pre>
<p><strong>结论</strong>：提升方法调用与显式调用<strong>性能完全相同</strong>，编译器会优化为直接访问</p>
<h2 data-id="heading-19">六、常见误区与最佳实践</h2>
<h3 data-id="heading-20">误区1：把嵌入当继承用</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// ❌ 错误：试图模拟继承层次</span>
<span class="hljs-keyword">type</span> Animal <span class="hljs-keyword">struct</span> { ... }
<span class="hljs-keyword">type</span> Mammal <span class="hljs-keyword">struct</span> { Animal }  <span class="hljs-comment">// Mammal "继承" Animal</span>
<span class="hljs-keyword">type</span> Dog <span class="hljs-keyword">struct</span> { Mammal }     <span class="hljs-comment">// Dog "继承" Mammal</span>

<span class="hljs-comment">// ✅ 正确：扁平化组合</span>
<span class="hljs-keyword">type</span> AnimalTraits <span class="hljs-keyword">struct</span> { ... }  <span class="hljs-comment">// 动物通用特征</span>
<span class="hljs-keyword">type</span> MammalTraits <span class="hljs-keyword">struct</span> { ... }  <span class="hljs-comment">// 哺乳动物特征</span>
<span class="hljs-keyword">type</span> Dog <span class="hljs-keyword">struct</span> {
    AnimalTraits
    MammalTraits
    <span class="hljs-comment">// Dog 特有字段</span>
}
</code></pre>
<h3 data-id="heading-21">误区2：过度嵌入导致耦合</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// ❌ 过度嵌入：一个结构体嵌入太多东西</span>
<span class="hljs-keyword">type</span> GodStruct <span class="hljs-keyword">struct</span> {
    Logger
    Cache
    Database
    Metrics
    Config
    <span class="hljs-comment">// ... 还有10个嵌入</span>
}

<span class="hljs-comment">// ✅ 合理拆分</span>
<span class="hljs-keyword">type</span> Service <span class="hljs-keyword">struct</span> {
    repo Repository
    logger Logger
}

<span class="hljs-keyword">type</span> Repository <span class="hljs-keyword">struct</span> {
    db *sql.DB
    cache *Cache
}
</code></pre>
<h3 data-id="heading-22">最佳实践清单</h3>








































<table><thead><tr><th>场景</th><th>推荐做法</th><th>原因</th></tr></thead><tbody><tr><td><strong>功能复用</strong></td><td>匿名嵌入 mixin</td><td>代码复用，保持扁平</td></tr><tr><td><strong>接口实现</strong></td><td>显式实现，不依赖嵌入</td><td>避免意外实现</td></tr><tr><td><strong>多层嵌入</strong></td><td>避免超过2层</td><td>可读性差，易产生歧义</td></tr><tr><td><strong>字段访问</strong></td><td>优先使用提升字段</td><td>简洁，符合习惯</td></tr><tr><td><strong>方法覆盖</strong></td><td>谨慎使用，文档说明</td><td>容易造成混淆</td></tr><tr><td><strong>测试</strong></td><td>通过接口而非具体类型</td><td>便于 mock</td></tr></tbody></table>
<h2 data-id="heading-23">七、总结：嵌入的本质与哲学</h2>
<h3 data-id="heading-24">7.1 嵌入的本质</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[嵌入] --&gt; B{匿名嵌入?}
    B --&gt;|是| C[方法/字段提升]
    B --&gt;|否| D[必须通过字段名访问]
    C --&gt; E[外层可以直接调用]
    D --&gt; F[外层需 obj.field.Method]
</code></pre>
<p><strong>核心要点</strong>：</p>
<ol>
<li>嵌入是<strong>组合</strong>，不是继承</li>
<li>匿名嵌入提供<strong>语法糖</strong>（提升机制）</li>
<li>提升的方法调用时，接收者是<strong>嵌入字段的副本</strong></li>
<li>外层可以<strong>遮蔽</strong>提升的方法，但不能"重写"</li>
</ol>
<h3 data-id="heading-25">7.2 Go 的设计哲学</h3>
<blockquote>
<p>"Less is exponentially more." —— Rob Pike</p>
</blockquote>
<p>Go 选择嵌入而非继承，体现了其设计哲学：</p>
<ul>
<li>✅ <strong>组合优于继承</strong>：更灵活，更易测试</li>
<li>✅ <strong>扁平优于层次</strong>：避免复杂的类型层次</li>
<li>✅ <strong>显式优于隐式</strong>：虽然嵌入提供语法糖，但底层机制清晰</li>
</ul>
<h3 data-id="heading-26">7.3 何时使用嵌入？</h3>



































<table><thead><tr><th>使用场景</th><th>推荐度</th><th>说明</th></tr></thead><tbody><tr><td>Mixin 模式（功能复用）</td><td>⭐⭐⭐⭐⭐</td><td>最佳实践</td></tr><tr><td>接口组合</td><td>⭐⭐⭐⭐⭐</td><td>Go 的惯用法</td></tr><tr><td>装饰器模式</td><td>⭐⭐⭐⭐</td><td>灵活且强大</td></tr><tr><td>模拟继承层次</td><td>⭐</td><td>避免使用</td></tr><tr><td>代码组织（分组字段）</td><td>⭐⭐⭐</td><td>可读性提升</td></tr></tbody></table>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue项目BMI计算器技术实现]]></title>    <link>https://juejin.cn/post/7603671627000643624</link>    <guid>https://juejin.cn/post/7603671627000643624</guid>    <pubDate>2026-02-07T16:05:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603671627000643624" data-draft-id="7603643385816170548" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue项目BMI计算器技术实现"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-02-07T16:05:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="滕青山"/> <meta itemprop="url" content="https://juejin.cn/user/3206601805674094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue项目BMI计算器技术实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3206601805674094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    滕青山
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-07T16:05:33.000Z" title="Sat Feb 07 2026 16:05:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">BMI计算器工具开发技术实现</h2>
<p>本文主要分享一下我最近开发的 BMI 计算器工具的技术实现细节。这个工具基于 Vue 3 和 Nuxt.js 构建，包含核心计算逻辑和交互式的用户界面。我们将重点关注其功能实现部分。</p>
<blockquote>
<p>在线工具网址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsee-tool.com%2Fbmi-calculator" target="_blank" title="https://see-tool.com/bmi-calculator" ref="nofollow noopener noreferrer">see-tool.com/bmi-calcula…</a></p>
</blockquote>
<blockquote>
<p>工具截图：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96166bc51ef24365a22043af965edb63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ruV6Z2S5bGx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771085158&amp;x-signature=8I%2FfxiS7nl4n%2FdaN4rhFVwLzD4E%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</blockquote>
<h3 data-id="heading-1">项目结构</h3>
<p>这个工具的实现主要分为两个部分：</p>
<ol>
<li><strong>逻辑层</strong>：<code>utils/bmi-calculator.js</code> —— 负责核心的 BMI 数值计算和状态判定。</li>
<li><strong>视图层</strong>：<code>pages/bmi-calculator.vue</code> —— 负责用户交互、输入验证和结果展示。</li>
</ol>
<h3 data-id="heading-2">1. 核心计算逻辑</h3>
<p>计算逻辑封装在 <code>calculateBmi</code> 函数中。它接收用户的身高（cm）和体重（kg）作为输入，返回计算后的 BMI 值以及对应的身体状态类别和健康风险等级。</p>
<h4 data-id="heading-3">1.1 输入验证</h4>
<p>在进行计算之前，我们需要确保输入的数据是有效的数值且大于 0。如果输入无效，函数会抛出一个错误，以便前端捕获处理。</p>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-keyword">const</span> height = <span class="hljs-title class_">Number</span>(heightCm)
  <span class="hljs-keyword">const</span> weight = <span class="hljs-title class_">Number</span>(weightKg)

  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Number</span>.<span class="hljs-built_in">isFinite</span>(height) || !<span class="hljs-title class_">Number</span>.<span class="hljs-built_in">isFinite</span>(weight) || height &lt;= <span class="hljs-number">0</span> || weight &lt;= <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'INVALID_INPUT'</span>)
  }
</code></pre>
<h4 data-id="heading-4">1.2 BMI 计算公式</h4>
<p>BMI 的计算公式是：体重（公斤）除以身高（米）的平方。</p>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-keyword">const</span> heightInMeters = height / <span class="hljs-number">100</span>
  <span class="hljs-comment">// 体重 / (身高^2)</span>
  <span class="hljs-keyword">const</span> bmiRaw = weight / (heightInMeters * heightInMeters)
  <span class="hljs-comment">// 保留一位小数</span>
  <span class="hljs-keyword">const</span> bmi = <span class="hljs-title class_">Number</span>(bmiRaw.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">1</span>))
</code></pre>
<h4 data-id="heading-5">1.3 状态判定</h4>
<p>根据计算出的 BMI 值，我们可以判定用户的身体状态。这里我们参照了常见的 BMI 标准进行分类：</p>
<ul>
<li><strong>BMI &lt; 18.5</strong>: 偏瘦（Underweight），存在营养不良风险。</li>
<li><strong>18.5 ≤ BMI &lt; 24</strong>: 正常（Normal），健康风险低。</li>
<li><strong>24 ≤ BMI &lt; 28</strong>: 超重（Overweight），通过轻度风险。</li>
<li><strong>BMI ≥ 28</strong>: 肥胖（Obese），存在较高健康风险。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-keyword">if</span> (bmi &lt; <span class="hljs-number">18.5</span>) {
    <span class="hljs-keyword">return</span> { bmi, <span class="hljs-attr">categoryKey</span>: <span class="hljs-string">'underweight'</span>, <span class="hljs-attr">riskKey</span>: <span class="hljs-string">'malnutrition'</span> }
  }
  <span class="hljs-keyword">if</span> (bmi &lt; <span class="hljs-number">24</span>) {
    <span class="hljs-keyword">return</span> { bmi, <span class="hljs-attr">categoryKey</span>: <span class="hljs-string">'normal'</span>, <span class="hljs-attr">riskKey</span>: <span class="hljs-string">'low'</span> }
  }
  <span class="hljs-keyword">if</span> (bmi &lt; <span class="hljs-number">28</span>) {
    <span class="hljs-keyword">return</span> { bmi, <span class="hljs-attr">categoryKey</span>: <span class="hljs-string">'overweight'</span>, <span class="hljs-attr">riskKey</span>: <span class="hljs-string">'mild'</span> }
  }
  <span class="hljs-keyword">return</span> { bmi, <span class="hljs-attr">categoryKey</span>: <span class="hljs-string">'obese'</span>, <span class="hljs-attr">riskKey</span>: <span class="hljs-string">'high'</span> }
</code></pre>
<h3 data-id="heading-6">2. Vue 页面实现</h3>
<p>页面组件主要由输入表单和结果展示两大部分组成。使用 Vue 3 的 Composition API (<code>&lt;script setup&gt;</code>) 来管理状态和逻辑。</p>
<h4 data-id="heading-7">2.1 状态管理</h4>
<p>我们使用 <code>ref</code> 来定义响应式变量，用于存储用户的输入和计算结果。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> heightCm = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)  <span class="hljs-comment">// 用户输入的身高</span>
<span class="hljs-keyword">const</span> weightKg = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)  <span class="hljs-comment">// 用户输入的体重</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)  <span class="hljs-comment">// 用于存储计算结果对象，初始为 null</span>
</code></pre>
<h4 data-id="heading-8">2.2 用户交互处理</h4>
<h5 data-id="heading-9">计算操作</h5>
<p>当用户点击“计算”按钮或在体重输入框按下回车时，会触发 <code>handleCalculate</code> 方法。</p>
<p>该方法首先调用核心计算函数 <code>calculateBmi</code>。如果计算成功，将结果赋值给 <code>result</code>，页面会自动渲染结果区域；如果捕获到错误（如输入无效），则会提示用户。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleCalculate</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 调用工具函数进行计算</span>
    <span class="hljs-keyword">const</span> r = <span class="hljs-title function_">calculateBmi</span>(<span class="hljs-title class_">Number</span>(heightCm.<span class="hljs-property">value</span>), <span class="hljs-title class_">Number</span>(weightKg.<span class="hljs-property">value</span>))
    result.<span class="hljs-property">value</span> = r
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-comment">// 计算失败，清空结果并提示错误</span>
    result.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
    <span class="hljs-title function_">safeMessage</span>(<span class="hljs-string">'error'</span>, <span class="hljs-string">'请输入有效的身高和体重'</span>)
  }
}
</code></pre>
<h5 data-id="heading-10">加载示例</h5>
<p>为了方便用户快速体验，我们提供了一个 <code>loadExample</code> 方法，一键填入预设的示例数据并触发计算。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">loadExample</span> = (<span class="hljs-params"/>) =&gt; {
  heightCm.<span class="hljs-property">value</span> = <span class="hljs-string">'170'</span>
  weightKg.<span class="hljs-property">value</span> = <span class="hljs-string">'65'</span>
  <span class="hljs-title function_">handleCalculate</span>()
}
</code></pre>
<h5 data-id="heading-11">清空重置</h5>
<p><code>clearForm</code> 方法用于重置所有输入和结果，让用户可以重新开始。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">clearForm</span> = (<span class="hljs-params"/>) =&gt; {
  heightCm.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>
  weightKg.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>
  result.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
}
</code></pre>
<h4 data-id="heading-12">2.3 结果动态展示</h4>
<p>在模板中，我们使用 <code>v-if="result"</code> 来控制结果卡片的显示。只有当 <code>result</code> 有值时，结果区域才会渲染。这种设计保证了页面初始状态的整洁。</p>
<p>结果卡片通过 grid 布局展示了三个关键信息：BMI 数值、身体状态和健康风险。这些信息都直接来自于 <code>result</code> 对象。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"result"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"..."</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- BMI 数值 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ result.bmi }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  
  <span class="hljs-comment">&lt;!-- 身体状态分类 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ t(`bmiCalculator.result.categoryMap.${result.categoryKey}`) }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  
  <span class="hljs-comment">&lt;!-- 健康风险评估 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ t(`bmiCalculator.result.riskMap.${result.riskKey}`) }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>通过将计算逻辑与界面展示分离，我们保持了代码的清晰和可维护性。Vue 强大的响应式系统让我们能够轻松地通过改变数据状态来驱动界面的更新。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[useMemo、useCallback、React.memo，可能真的要删了]]></title>    <link>https://juejin.cn/post/7603643044034674724</link>    <guid>https://juejin.cn/post/7603643044034674724</guid>    <pubDate>2026-02-08T00:50:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603643044034674724" data-draft-id="7603656494905442310" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="useMemo、useCallback、React.memo，可能真的要删了"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-02-08T00:50:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员Agions"/> <meta itemprop="url" content="https://juejin.cn/user/360295545187751"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            useMemo、useCallback、React.memo，可能真的要删了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/360295545187751/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员Agions
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T00:50:37.000Z" title="Sun Feb 08 2026 00:50:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>"你写了3年的性能优化代码，可能全是无用功。"</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">React 官方的一记重锤</h2>
<p>React 官方博客最新更新：</p>
<p><strong>React Compiler 已正式推荐用于生产环境。</strong></p>
<p>这意味着什么？</p>





















<table><thead><tr><th>过去（手动优化）</th><th>现在（Compiler自动）</th></tr></thead><tbody><tr><td>手写 <code>useMemo</code> 缓存计算结果</td><td>编译器自动识别并优化</td></tr><tr><td>手写 <code>useCallback</code> 缓存函数</td><td>编译器自动处理</td></tr><tr><td>手写 <code>React.memo</code> 包裹组件</td><td>编译器自动决定是否需要</td></tr></tbody></table>
<p>一句话：<strong>你做的事情，编译器现在会帮你做了。</strong></p>
<p>而且它做得比你好。</p>
<blockquote>
<p>💡 <strong>三年前你学的React性能优化，正在变成"过时的最佳实践"。技术的残酷就在于：你越熟练的东西，越可能被淘汰。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-1">为什么我们需要 useMemo？</h2>
<p>先回顾一下历史。</p>
<p>React 的渲染机制是：<strong>状态变了，组件重新渲染。</strong></p>
<p>问题来了：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductList</span>(<span class="hljs-params">{ products }</span>) {
  <span class="hljs-comment">// 每次渲染都会重新计算</span>
  <span class="hljs-keyword">const</span> sortedProducts = products.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">price</span> - b.<span class="hljs-property">price</span>);
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">List</span> <span class="hljs-attr">items</span>=<span class="hljs-string">{sortedProducts}</span> /&gt;</span></span>;
}
</code></pre>
<p>如果 <code>products</code> 有1000个，每次父组件更新，这个排序都要跑一遍。</p>
<p>即使 <code>products</code> 根本没变。</p>
<p>于是我们学会了：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> sortedProducts = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> products.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">price</span> - b.<span class="hljs-property">price</span>);
}, [products]);
</code></pre>
<p><strong>只有 <code>products</code> 变化时才重新计算。</strong></p>
<p>这就是 <code>useMemo</code> 的价值——手动告诉React："这里需要优化。"</p>
<blockquote>
<p>💡 <strong>useMemo 本质上是你和 React 的"交流方式"：你得告诉它哪里需要缓存。问题是，你经常说错。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-2">React Compiler：让编译器来决定</h2>
<p>React Compiler 的核心思想：</p>
<p><strong>你不需要告诉我哪里需要优化。我自己会分析。</strong></p>
<p>它的工作原理：</p>
<pre><code class="hljs">源代码 → 静态分析 → 识别可优化点 → 自动插入缓存逻辑 → 输出优化后的代码
</code></pre>
<p>编译器会分析你的代码，自动识别：</p>
<ul>
<li>哪些计算结果可以缓存</li>
<li>哪些函数引用需要稳定</li>
<li>哪些组件可以跳过重渲染</li>
</ul>
<p><strong>你写普通代码，编译器输出优化代码。</strong></p>
<p>来看对比：</p>
<h3 data-id="heading-3">Before（手动优化）</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductPage</span>(<span class="hljs-params">{ productId }</span>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  
  <span class="hljs-comment">// 手动缓存</span>
  <span class="hljs-keyword">const</span> product = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetchProduct</span>(productId);
  }, [productId]);
  
  <span class="hljs-comment">// 手动缓存回调</span>
  <span class="hljs-keyword">const</span> handleClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c + <span class="hljs-number">1</span>);
  }, []);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">MemoizedButton</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ProductDetail</span> <span class="hljs-attr">product</span>=<span class="hljs-string">{product}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 手动包裹</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">MemoizedButton</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-title class_">Button</span>);
</code></pre>
<h3 data-id="heading-4">After（Compiler时代）</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductPage</span>(<span class="hljs-params">{ productId }</span>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  
  <span class="hljs-comment">// 直接写，编译器自己优化</span>
  <span class="hljs-keyword">const</span> product = <span class="hljs-title function_">fetchProduct</span>(productId);
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c + <span class="hljs-number">1</span>);
  };
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ProductDetail</span> <span class="hljs-attr">product</span>=<span class="hljs-string">{product}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>代码量减少 40%。</p>
<p>可读性提升 100%。</p>
<blockquote>
<p>💡 <strong>最好的优化，是你感觉不到的优化。React Compiler让你回归"写代码"本身，而不是"写如何优化"。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-5">编译器真的比人聪明吗？</h2>
<p>不是"聪明"，是"不会犯错"。</p>
<p>人工优化的常见问题：</p>

























<table><thead><tr><th>问题</th><th>后果</th></tr></thead><tbody><tr><td><strong>过度优化</strong></td><td>到处加 useMemo，反而增加内存开销</td></tr><tr><td><strong>依赖数组错误</strong></td><td>缓存了但没生效，或者不该更新的更新了</td></tr><tr><td><strong>优化了不该优化的</strong></td><td>简单计算加缓存，成本比收益高</td></tr><tr><td><strong>忘记优化该优化的</strong></td><td>真正的瓶颈没发现</td></tr></tbody></table>
<p>编译器不会犯这些错。</p>
<p>它基于静态分析，<strong>精确识别需要优化的位置</strong>，不多不少。</p>
<blockquote>
<p>💡 <strong>人会过度优化，也会忘记优化。编译器只做必要的优化。这就是机器的优势：不会"手抖"。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-6">什么时候还需要手动优化？</h2>
<p>别急着删光。有些场景编译器还搞不定：</p>
<h3 data-id="heading-7">1. 非纯函数调用</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 编译器无法优化这种情况</span>
<span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(); <span class="hljs-comment">// 每次调用结果不同</span>
<span class="hljs-keyword">const</span> random = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>();
</code></pre>
<h3 data-id="heading-8">2. 外部状态依赖</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 依赖了组件外部的可变状态</span>
<span class="hljs-keyword">let</span> externalCounter = <span class="hljs-number">0</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Component</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> value = externalCounter++; <span class="hljs-comment">// 编译器无法追踪</span>
}
</code></pre>
<h3 data-id="heading-9">3. 第三方库的特殊要求</h3>
<p>某些库明确要求传入稳定引用（如 React Query 的 queryFn）。</p>
<p>这时候还是需要手动处理。</p>
<h3 data-id="heading-10">速查表</h3>





























<table><thead><tr><th>场景</th><th>需要手动优化？</th></tr></thead><tbody><tr><td>普通计算/过滤/排序</td><td>❌ 不需要</td></tr><tr><td>事件处理函数</td><td>❌ 不需要</td></tr><tr><td>子组件 props</td><td>❌ 不需要</td></tr><tr><td>非纯函数</td><td>✅ 可能需要</td></tr><tr><td>第三方库特殊要求</td><td>✅ 根据文档</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>80%的手动优化可以删掉。剩下20%，等你遇到真正的性能问题再加不迟。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-11">迁移指南：怎么开始用？</h2>
<h3 data-id="heading-12">Step 1: 检查环境</h3>
<p>React Compiler 需要：</p>
<ul>
<li>React 19+</li>
<li>Babel / SWC 配置</li>
</ul>
<h3 data-id="heading-13">Step 2: 安装配置</h3>
<pre><code class="hljs language-bash" lang="bash">npm install babel-plugin-react-compiler
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// babel.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: [
    [<span class="hljs-string">'babel-plugin-react-compiler'</span>, {
      <span class="hljs-comment">// 配置项</span>
    }]
  ]
};
</code></pre>
<h3 data-id="heading-14">Step 3: 渐进式清理</h3>
<p>不需要一次性删光。推荐步骤：</p>
<ol>
<li><strong>先在新代码中不写</strong> useMemo/useCallback</li>
<li><strong>跑一段时间</strong>，观察性能</li>
<li><strong>逐步清理</strong>旧代码中的手动优化</li>
<li><strong>保留</strong>真正需要的边界情况</li>
</ol>
<h3 data-id="heading-15">Step 4: 监控性能</h3>
<p>删除手动优化后，用 React DevTools Profiler 检查：</p>
<ul>
<li>渲染次数是否异常增加</li>
<li>是否有明显的性能下降</li>
</ul>
<p>如果没有问题——恭喜，你的代码变干净了。</p>
<hr/>
<h2 data-id="heading-16">写给React开发者的话</h2>
<p>技术在进化。</p>
<p>曾经的最佳实践：</p>
<ul>
<li>2018：Class组件 + 生命周期</li>
<li>2020：Hooks + useMemo/useCallback</li>
<li>2024：React Compiler + 自动优化</li>
</ul>
<p><strong>每一代"最佳实践"都会被下一代淘汰。</strong></p>
<p>这不是坏事。</p>
<p>说明工具在变好，开发者的负担在减轻。</p>
<blockquote>
<p>💡 <strong>真正的高手不是记住所有API，而是知道什么时候该忘掉它们。useMemo 是好东西，但好东西也有过期的时候。</strong></p>
</blockquote>
<hr/>
<p>今晚就试试：</p>
<p><strong>把项目里的 useMemo 删几个，跑跑看。</strong></p>
<p>你会发现，天没塌。</p>
<p>评论区告诉我：你项目里有多少个 useMemo？敢删吗？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent 安全权限设计：blade-code 的 5 种权限模式与三级控制]]></title>    <link>https://juejin.cn/post/7603671627003412520</link>    <guid>https://juejin.cn/post/7603671627003412520</guid>    <pubDate>2026-02-08T01:52:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603671627003412520" data-draft-id="7603671627003396136" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent 安全权限设计：blade-code 的 5 种权限模式与三级控制"/> <meta itemprop="keywords" content="Java,JavaScript"/> <meta itemprop="datePublished" content="2026-02-08T01:52:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="echoVic"/> <meta itemprop="url" content="https://juejin.cn/user/729731451069998"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent 安全权限设计：blade-code 的 5 种权限模式与三级控制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/729731451069998/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    echoVic
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T01:52:04.000Z" title="Sun Feb 08 2026 01:52:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>blade-code 技术深度系列第 2 篇。本文基于源码剖析 AI Agent 的权限设计——5 种权限模式、allow/ask/deny 三级控制、基于签名的精确匹配。</p>
</blockquote>
<h2 data-id="heading-0">问题</h2>
<p>把 AI Agent 接入开发环境，第一个问题不是"它能做什么"，而是"它不能做什么"。</p>
<p>场景：</p>
<ul>
<li>Agent 想执行 <code>rm -rf /</code></li>
<li>Agent 想读取 <code>.env</code> 里的密钥</li>
<li>Agent 想 <code>curl</code> 下载脚本并执行</li>
<li>Agent 想 <code>sudo</code> 提权</li>
</ul>
<p>你会让它直接跑吗？</p>
<p>blade-code 从设计之初就在解决这个问题：<strong>赋予 Agent 能力的同时，保证安全</strong>。</p>
<p>本文内容：</p>
<ul>
<li>工具分类（ReadOnly / Write / Execute）</li>
<li>5 种权限模式</li>
<li>allow/ask/deny 三级控制</li>
<li>基于签名的精确匹配</li>
</ul>
<hr/>
<h2 data-id="heading-1">一、工具分类：三种 ToolKind</h2>
<p>blade-code 把所有工具分成三类，这是权限控制的基础：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ToolKind</span> {
  <span class="hljs-title class_">ReadOnly</span> = <span class="hljs-string">'readonly'</span>,  <span class="hljs-comment">// 只读，无副作用</span>
  <span class="hljs-title class_">Write</span> = <span class="hljs-string">'write'</span>,        <span class="hljs-comment">// 文件写入</span>
  <span class="hljs-title class_">Execute</span> = <span class="hljs-string">'execute'</span>,    <span class="hljs-comment">// 命令执行，可能有副作用</span>
}
</code></pre>
<h3 data-id="heading-2">ReadOnly 工具</h3>
<p>只读操作，无副作用，最安全：</p>





































<table><thead><tr><th>工具</th><th>功能</th></tr></thead><tbody><tr><td>Read</td><td>读取文件</td></tr><tr><td>Glob</td><td>路径匹配</td></tr><tr><td>Grep</td><td>文本搜索</td></tr><tr><td>WebFetch</td><td>获取网页</td></tr><tr><td>WebSearch</td><td>网络搜索</td></tr><tr><td>TaskOutput</td><td>子任务输出</td></tr><tr><td>Plan</td><td>生成计划</td></tr></tbody></table>
<h3 data-id="heading-3">Write 工具</h3>
<p>文件写入，有副作用但可控：</p>





















<table><thead><tr><th>工具</th><th>功能</th></tr></thead><tbody><tr><td>Edit</td><td>编辑文件</td></tr><tr><td>Write</td><td>写入文件</td></tr><tr><td>NotebookEdit</td><td>编辑 Notebook</td></tr></tbody></table>
<h3 data-id="heading-4">Execute 工具</h3>
<p>命令执行，副作用不可预测：</p>

























<table><thead><tr><th>工具</th><th>功能</th></tr></thead><tbody><tr><td>Bash</td><td>Shell 命令</td></tr><tr><td>Task</td><td>子任务</td></tr><tr><td>Skill</td><td>调用技能</td></tr><tr><td>SlashCommand</td><td>斜杠命令</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-5">二、5 种权限模式</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">PermissionMode</span> {
  <span class="hljs-variable constant_">DEFAULT</span> = <span class="hljs-string">'default'</span>,
  <span class="hljs-variable constant_">AUTO_EDIT</span> = <span class="hljs-string">'autoEdit'</span>,
  <span class="hljs-variable constant_">YOLO</span> = <span class="hljs-string">'yolo'</span>,
  <span class="hljs-variable constant_">PLAN</span> = <span class="hljs-string">'plan'</span>,
  <span class="hljs-variable constant_">SPEC</span> = <span class="hljs-string">'spec'</span>,
}
</code></pre>
<h3 data-id="heading-6">DEFAULT（默认）</h3>
<p>平衡安全与效率：</p>
<ul>
<li>✅ 自动批准：ReadOnly 工具</li>
<li>❌ 需要确认：Write 工具</li>
<li>❌ 需要确认：Execute 工具</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">blade <span class="hljs-string">"帮我分析这个项目"</span>
</code></pre>
<h3 data-id="heading-7">AUTO_EDIT</h3>
<p>频繁编码场景：</p>
<ul>
<li>✅ 自动批准：ReadOnly 工具</li>
<li>✅ 自动批准：Write 工具</li>
<li>❌ 需要确认：Execute 工具</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">blade --mode=autoEdit <span class="hljs-string">"重构这个模块"</span>
</code></pre>
<p>日常开发中，文件编辑最频繁。AUTO_EDIT 让 Agent 自由改代码，但执行命令仍需确认。</p>
<h3 data-id="heading-8">YOLO（危险）</h3>
<p>完全信任 AI：</p>
<ul>
<li>✅ 自动批准：所有工具</li>
<li>⚠️ 跳过所有确认</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">blade --mode=yolo <span class="hljs-string">"自动修复所有 lint 错误"</span>
</code></pre>
<p>适用场景：沙箱环境、演示、已验证安全的自动化脚本。</p>
<p>源码实现：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (permissionMode === <span class="hljs-title class_">PermissionMode</span>.<span class="hljs-property">YOLO</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">result</span>: <span class="hljs-title class_">PermissionResult</span>.<span class="hljs-property">ALLOW</span>,
    <span class="hljs-attr">matchedRule</span>: <span class="hljs-string">'mode:yolo'</span>,
    <span class="hljs-attr">reason</span>: <span class="hljs-string">'YOLO mode: automatically approve all tool invocations'</span>,
  };
}
</code></pre>
<h3 data-id="heading-9">PLAN</h3>
<p>只读模式，用于调研：</p>
<ul>
<li>✅ 自动批准：ReadOnly 工具</li>
<li>❌ 拦截：Write 和 Execute 工具</li>
<li>🔵 特殊工具：ExitPlanMode（提交方案）</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">blade --mode=plan <span class="hljs-string">"分析这个项目的架构"</span>
</code></pre>
<p>适用场景：代码审查、架构分析、生成方案后用户批准再执行。</p>
<p>源码实现：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (permissionMode === <span class="hljs-title class_">PermissionMode</span>.<span class="hljs-property">PLAN</span>) {
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isReadOnlyKind</span>(toolKind)) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">result</span>: <span class="hljs-title class_">PermissionResult</span>.<span class="hljs-property">DENY</span>,
      <span class="hljs-attr">matchedRule</span>: <span class="hljs-string">'mode:plan'</span>,
      <span class="hljs-attr">reason</span>: <span class="hljs-string">'Plan mode: modification tools are blocked'</span>,
    };
  }
}
</code></pre>
<h3 data-id="heading-10">SPEC（Spec-Driven Development）</h3>
<p>结构化功能开发：</p>
<ul>
<li>✅ 自动批准：ReadOnly + Spec 专用工具</li>
<li>❌ 需要确认：其他 Write 和 Execute 工具</li>
<li>🔵 特殊工具：InitSpec, UpdateSpec, ValidateSpec, GetSpecContext, ExitSpecMode</li>
<li>📁 持久化：<code>.blade/specs/&lt;feature&gt;/</code></li>
</ul>
<pre><code class="hljs language-bash" lang="bash">blade --mode=spec <span class="hljs-string">"实现用户认证功能"</span>
</code></pre>
<p>适用场景：复杂功能开发，需要 Requirements → Design → Tasks → Implementation 工作流。</p>
<h3 data-id="heading-11">模式对比</h3>















































<table><thead><tr><th>模式</th><th>ReadOnly</th><th>Write</th><th>Execute</th><th>场景</th></tr></thead><tbody><tr><td>DEFAULT</td><td>✅ 自动</td><td>❌ 确认</td><td>❌ 确认</td><td>日常开发</td></tr><tr><td>AUTO_EDIT</td><td>✅ 自动</td><td>✅ 自动</td><td>❌ 确认</td><td>频繁编码</td></tr><tr><td>YOLO</td><td>✅ 自动</td><td>✅ 自动</td><td>✅ 自动</td><td>沙箱/演示</td></tr><tr><td>PLAN</td><td>✅ 自动</td><td>❌ 拦截</td><td>❌ 拦截</td><td>调研/审查</td></tr><tr><td>SPEC</td><td>✅ 自动</td><td>❌ 确认</td><td>❌ 确认</td><td>复杂功能</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-12">三、三级权限控制：allow / ask / deny</h2>
<p>权限模式之外，blade-code 还有更细粒度的控制：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PermissionConfig</span> {
  <span class="hljs-attr">allow</span>: <span class="hljs-built_in">string</span>[];  <span class="hljs-comment">// 自动批准</span>
  <span class="hljs-attr">ask</span>: <span class="hljs-built_in">string</span>[];    <span class="hljs-comment">// 需要确认</span>
  <span class="hljs-attr">deny</span>: <span class="hljs-built_in">string</span>[];   <span class="hljs-comment">// 直接拒绝</span>
}
</code></pre>
<h3 data-id="heading-13">优先级</h3>
<p><strong>deny &gt; allow &gt; ask &gt; 默认(ask)</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 检查 deny（最高优先级）</span>
<span class="hljs-keyword">const</span> denyMatch = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">matchRules</span>(signature, <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">deny</span>);
<span class="hljs-keyword">if</span> (denyMatch) {
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">result</span>: <span class="hljs-title class_">PermissionResult</span>.<span class="hljs-property">DENY</span>, ... };
}

<span class="hljs-comment">// 2. 检查 allow</span>
<span class="hljs-keyword">const</span> allowMatch = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">matchRules</span>(signature, <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">allow</span>);
<span class="hljs-keyword">if</span> (allowMatch) {
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">result</span>: <span class="hljs-title class_">PermissionResult</span>.<span class="hljs-property">ALLOW</span>, ... };
}

<span class="hljs-comment">// 3. 检查 ask</span>
<span class="hljs-keyword">const</span> askMatch = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">matchRules</span>(signature, <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">ask</span>);
<span class="hljs-keyword">if</span> (askMatch) {
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">result</span>: <span class="hljs-title class_">PermissionResult</span>.<span class="hljs-property">ASK</span>, ... };
}

<span class="hljs-comment">// 4. 默认：需要确认</span>
<span class="hljs-keyword">return</span> { <span class="hljs-attr">result</span>: <span class="hljs-title class_">PermissionResult</span>.<span class="hljs-property">ASK</span>, ... };
</code></pre>
<h3 data-id="heading-14">默认配置</h3>
<p>blade-code 内置了一套安全配置：</p>
<p><strong>allow 列表</strong>（自动批准）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-attr">allow</span>: [
  <span class="hljs-comment">// 系统信息命令</span>
  <span class="hljs-string">'Bash(pwd)'</span>, <span class="hljs-string">'Bash(which *)'</span>, <span class="hljs-string">'Bash(whoami)'</span>,
  <span class="hljs-string">'Bash(hostname)'</span>, <span class="hljs-string">'Bash(uname *)'</span>, <span class="hljs-string">'Bash(date)'</span>, <span class="hljs-string">'Bash(echo *)'</span>,

  <span class="hljs-comment">// 目录列表</span>
  <span class="hljs-string">'Bash(ls *)'</span>, <span class="hljs-string">'Bash(tree *)'</span>,

  <span class="hljs-comment">// Git 只读</span>
  <span class="hljs-string">'Bash(git status)'</span>, <span class="hljs-string">'Bash(git log *)'</span>, <span class="hljs-string">'Bash(git diff *)'</span>,
  <span class="hljs-string">'Bash(git branch *)'</span>, <span class="hljs-string">'Bash(git show *)'</span>, <span class="hljs-string">'Bash(git remote *)'</span>,

  <span class="hljs-comment">// 包管理器只读</span>
  <span class="hljs-string">'Bash(npm list *)'</span>, <span class="hljs-string">'Bash(npm view *)'</span>, <span class="hljs-string">'Bash(npm outdated *)'</span>,
  <span class="hljs-string">'Bash(pnpm list *)'</span>, <span class="hljs-string">'Bash(yarn list *)'</span>,
  <span class="hljs-string">'Bash(pip list *)'</span>, <span class="hljs-string">'Bash(pip show *)'</span>,
]
</code></pre>
<p><strong>ask 列表</strong>（需要确认）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-attr">ask</span>: [
  <span class="hljs-comment">// 网络下载（可能下载恶意代码）</span>
  <span class="hljs-string">'Bash(curl *)'</span>, <span class="hljs-string">'Bash(wget *)'</span>, <span class="hljs-string">'Bash(aria2c *)'</span>, <span class="hljs-string">'Bash(axel *)'</span>,

  <span class="hljs-comment">// 危险删除</span>
  <span class="hljs-string">'Bash(rm -rf *)'</span>, <span class="hljs-string">'Bash(rm -r *)'</span>, <span class="hljs-string">'Bash(rm --recursive *)'</span>,

  <span class="hljs-comment">// 网络连接</span>
  <span class="hljs-string">'Bash(nc *)'</span>, <span class="hljs-string">'Bash(netcat *)'</span>, <span class="hljs-string">'Bash(telnet *)'</span>, <span class="hljs-string">'Bash(ncat *)'</span>,
]
</code></pre>
<p><strong>deny 列表</strong>（直接拒绝）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-attr">deny</span>: [
  <span class="hljs-comment">// 敏感文件</span>
  <span class="hljs-string">'Read(./.env)'</span>, <span class="hljs-string">'Read(./.env.*)'</span>,

  <span class="hljs-comment">// 危险命令</span>
  <span class="hljs-string">'Bash(rm -rf /)'</span>, <span class="hljs-string">'Bash(rm -rf /*)'</span>, <span class="hljs-string">'Bash(sudo *)'</span>, <span class="hljs-string">'Bash(chmod 777 *)'</span>,

  <span class="hljs-comment">// Shell 嵌套（可绕过安全检测）</span>
  <span class="hljs-string">'Bash(bash *)'</span>, <span class="hljs-string">'Bash(sh *)'</span>, <span class="hljs-string">'Bash(zsh *)'</span>, <span class="hljs-string">'Bash(fish *)'</span>, <span class="hljs-string">'Bash(dash *)'</span>,

  <span class="hljs-comment">// 代码注入</span>
  <span class="hljs-string">'Bash(eval *)'</span>, <span class="hljs-string">'Bash(source *)'</span>,

  <span class="hljs-comment">// 系统级操作</span>
  <span class="hljs-string">'Bash(mkfs *)'</span>, <span class="hljs-string">'Bash(fdisk *)'</span>, <span class="hljs-string">'Bash(dd *)'</span>, <span class="hljs-string">'Bash(format *)'</span>, <span class="hljs-string">'Bash(parted *)'</span>,

  <span class="hljs-comment">// 浏览器（可打开恶意链接）</span>
  <span class="hljs-string">'Bash(open http*)'</span>, <span class="hljs-string">'Bash(open https*)'</span>,
  <span class="hljs-string">'Bash(xdg-open http*)'</span>, <span class="hljs-string">'Bash(xdg-open https*)'</span>,
]
</code></pre>
<h3 data-id="heading-15">设计原则</h3>
<p><strong>allow</strong>：只读命令无副作用，可以自动批准。<code>pwd</code>、<code>ls</code>、<code>git status</code> 不会改变任何东西。</p>
<p><strong>ask</strong>：<code>curl</code>、<code>wget</code> 可能下载恶意代码，<code>rm -rf</code> 可能删数据。需要确认，但不完全禁止。</p>
<p><strong>deny</strong>：<code>.env</code> 包含密钥，<code>sudo</code> 风险太高，Shell 嵌套可能绕过检测，<code>mkfs</code>、<code>dd</code> 可能造成不可逆损害。</p>
<hr/>
<h2 data-id="heading-16">四、基于签名的精确匹配</h2>
<p>blade-code 的权限系统支持多种匹配模式。</p>
<h3 data-id="heading-17">签名格式</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">ToolName</span>(content)
</code></pre>
<p>例如：</p>
<ul>
<li><code>Bash(git status)</code> — 执行 git status</li>
<li><code>Read(src/index.ts)</code> — 读取文件</li>
<li><code>Edit(src/utils.ts)</code> — 编辑文件</li>
</ul>
<h3 data-id="heading-18">匹配模式</h3>
<ol>
<li><strong>精确匹配</strong>：<code>Read(src/index.ts)</code></li>
<li><strong>前缀匹配</strong>：<code>Read</code>（匹配所有 Read 调用）</li>
<li><strong>通配符匹配</strong>：<code>Read(*)</code> 或 <code>Bash(git *)</code></li>
<li><strong>Glob 模式</strong>：<code>Read(**/*.env)</code></li>
</ol>



































<table><thead><tr><th>规则</th><th>匹配</th><th>不匹配</th></tr></thead><tbody><tr><td><code>Bash(git status)</code></td><td><code>Bash(git status)</code></td><td><code>Bash(git log)</code></td></tr><tr><td><code>Bash(git *)</code></td><td><code>Bash(git status)</code>, <code>Bash(git log)</code></td><td><code>Bash(npm install)</code></td></tr><tr><td><code>Bash</code></td><td>所有 Bash 命令</td><td><code>Read(...)</code></td></tr><tr><td><code>Read(*.env)</code></td><td><code>Read(.env)</code>, <code>Read(.env.local)</code></td><td><code>Read(config.json)</code></td></tr><tr><td><code>Read(**/*.ts)</code></td><td><code>Read(src/index.ts)</code></td><td><code>Read(package.json)</code></td></tr></tbody></table>
<h3 data-id="heading-19">实现</h3>
<p>blade-code 用 picomatch 库做 glob 匹配：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-title function_">matchRule</span>(<span class="hljs-attr">signature</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">rule</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">MatchType</span> | <span class="hljs-literal">null</span> {
  <span class="hljs-comment">// 精确匹配</span>
  <span class="hljs-keyword">if</span> (signature === rule) <span class="hljs-keyword">return</span> <span class="hljs-string">'exact'</span>;

  <span class="hljs-comment">// 通配符匹配所有</span>
  <span class="hljs-keyword">if</span> (rule === <span class="hljs-string">'*'</span> || rule === <span class="hljs-string">'**'</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'wildcard'</span>;

  <span class="hljs-comment">// 工具名 glob 匹配</span>
  <span class="hljs-keyword">if</span> (ruleToolName.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'*'</span>)) {
    <span class="hljs-keyword">if</span> (!picomatch.<span class="hljs-title function_">isMatch</span>(sigToolName, ruleToolName, { <span class="hljs-attr">dot</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">bash</span>: <span class="hljs-literal">true</span> })) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
  }

  <span class="hljs-comment">// 参数 glob 匹配</span>
  <span class="hljs-keyword">if</span> (rule.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'*'</span>)) {
    <span class="hljs-keyword">const</span> isMatch = picomatch.<span class="hljs-title function_">isMatch</span>(sigValue, ruleValue, { <span class="hljs-attr">dot</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">bash</span>: <span class="hljs-literal">true</span> });
    <span class="hljs-keyword">if</span> (isMatch) <span class="hljs-keyword">return</span> ruleValue.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'**'</span>) ? <span class="hljs-string">'glob'</span> : <span class="hljs-string">'wildcard'</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-20">五、权限执行管道</h2>
<p>blade-code 的权限检查在 PipelineStages 中实现。</p>
<h3 data-id="heading-21">优先级</h3>
<p><strong>YOLO 模式 &gt; PLAN 模式 &gt; DENY 规则 &gt; ALLOW 规则 &gt; 模式规则 &gt; ASK</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-title function_">applyModeOverrides</span>(
  <span class="hljs-attr">toolKind</span>: <span class="hljs-title class_">ToolKind</span>,
  <span class="hljs-attr">checkResult</span>: <span class="hljs-title class_">PermissionCheckResult</span>,
  <span class="hljs-attr">permissionMode</span>: <span class="hljs-title class_">PermissionMode</span>
): <span class="hljs-title class_">PermissionCheckResult</span> {
  <span class="hljs-comment">// 1. YOLO：全部放开</span>
  <span class="hljs-keyword">if</span> (permissionMode === <span class="hljs-title class_">PermissionMode</span>.<span class="hljs-property">YOLO</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">result</span>: <span class="hljs-title class_">PermissionResult</span>.<span class="hljs-property">ALLOW</span>, ... };
  }

  <span class="hljs-comment">// 2. PLAN：拒绝非只读</span>
  <span class="hljs-keyword">if</span> (permissionMode === <span class="hljs-title class_">PermissionMode</span>.<span class="hljs-property">PLAN</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isReadOnlyKind</span>(toolKind)) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">result</span>: <span class="hljs-title class_">PermissionResult</span>.<span class="hljs-property">DENY</span>, ... };
    }
  }

  <span class="hljs-comment">// 3. deny 规则已拒绝，不覆盖</span>
  <span class="hljs-keyword">if</span> (checkResult.<span class="hljs-property">result</span> === <span class="hljs-title class_">PermissionResult</span>.<span class="hljs-property">DENY</span>) <span class="hljs-keyword">return</span> checkResult;

  <span class="hljs-comment">// 4. allow 规则已批准，不覆盖</span>
  <span class="hljs-keyword">if</span> (checkResult.<span class="hljs-property">result</span> === <span class="hljs-title class_">PermissionResult</span>.<span class="hljs-property">ALLOW</span>) <span class="hljs-keyword">return</span> checkResult;

  <span class="hljs-comment">// 5. 只读工具：自动批准</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isReadOnlyKind</span>(toolKind)) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">result</span>: <span class="hljs-title class_">PermissionResult</span>.<span class="hljs-property">ALLOW</span>, ... };
  }

  <span class="hljs-comment">// 6. AUTO_EDIT + Write：自动批准</span>
  <span class="hljs-keyword">if</span> (permissionMode === <span class="hljs-title class_">PermissionMode</span>.<span class="hljs-property">AUTO_EDIT</span> &amp;&amp; toolKind === <span class="hljs-title class_">ToolKind</span>.<span class="hljs-property">Write</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">result</span>: <span class="hljs-title class_">PermissionResult</span>.<span class="hljs-property">ALLOW</span>, ... };
  }

  <span class="hljs-comment">// 7. 其他：保持原结果（通常是 ASK）</span>
  <span class="hljs-keyword">return</span> checkResult;
}
</code></pre>
<h3 data-id="heading-22">流程图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[工具调用请求] --&gt; B{YOLO 模式?}
    B --&gt;|是| C[✅ 直接批准]
    B --&gt;|否| D{PLAN 模式?}
    D --&gt;|是| E{只读工具?}
    E --&gt;|否| F[❌ 直接拒绝]
    E --&gt;|是| G[✅ 批准]
    D --&gt;|否| H{匹配 deny 规则?}
    H --&gt;|是| F
    H --&gt;|否| I{匹配 allow 规则?}
    I --&gt;|是| C
    I --&gt;|否| J{只读工具?}
    J --&gt;|是| C
    J --&gt;|否| K{AUTO_EDIT + Write?}
    K --&gt;|是| C
    K --&gt;|否| L[⚠️ 请求用户确认]
</code></pre>
<hr/>
<h2 data-id="heading-23">六、实战配置</h2>
<h3 data-id="heading-24">项目级配置</h3>
<p>在项目根目录创建 <code>.blade/settings.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"permissionMode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"default"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"allow"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"Bash(npm run *)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(pnpm *)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(git commit *)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(git push *)"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ask"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"deny"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"Read(config/secrets.json)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(rm -rf node_modules)"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-25">命令行切换</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动时指定</span>
blade --mode=autoEdit <span class="hljs-string">"重构这个模块"</span>
blade --mode=plan <span class="hljs-string">"分析项目架构"</span>
blade --mode=yolo <span class="hljs-string">"自动修复所有问题"</span>

<span class="hljs-comment"># 运行时切换</span>
&gt; /mode autoEdit
&gt; /mode plan
&gt; /mode default
</code></pre>
<h3 data-id="heading-26">场景推荐</h3>



































<table><thead><tr><th>场景</th><th>模式</th><th>原因</th></tr></thead><tbody><tr><td>日常开发</td><td>DEFAULT</td><td>平衡安全与效率</td></tr><tr><td>频繁编码</td><td>AUTO_EDIT</td><td>减少文件编辑确认</td></tr><tr><td>代码审查</td><td>PLAN</td><td>只读不写</td></tr><tr><td>自动化脚本</td><td>YOLO</td><td>无需人工干预（确保安全）</td></tr><tr><td>复杂功能</td><td>SPEC</td><td>结构化工作流</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-27">总结</h2>
<ol>
<li><strong>工具分类</strong>：ReadOnly / Write / Execute</li>
<li><strong>5 种权限模式</strong>：DEFAULT / AUTO_EDIT / YOLO / PLAN / SPEC</li>
<li><strong>三级权限控制</strong>：deny &gt; allow &gt; ask</li>
<li><strong>精确匹配</strong>：精确、前缀、通配符、glob</li>
</ol>
<p>设计原则：</p>
<ul>
<li>默认安全（DEFAULT 模式）</li>
<li>灵活可控（用户可切换）</li>
<li>细粒度（精确到命令级别）</li>
<li>可扩展（项目级配置覆盖全局）</li>
</ul>
<hr/>
<h2 data-id="heading-28">参考</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FechoVic%2Fblade-code" target="_blank" title="https://github.com/echoVic/blade-code" ref="nofollow noopener noreferrer">blade-code GitHub</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FechoVic%2Fblade-code%2Fblob%2Fmain%2Fpackages%2Fcli%2Fsrc%2Fconfig%2FPermissionChecker.ts" target="_blank" title="https://github.com/echoVic/blade-code/blob/main/packages/cli/src/config/PermissionChecker.ts" ref="nofollow noopener noreferrer">PermissionChecker.ts</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FechoVic%2Fblade-code%2Fblob%2Fmain%2Fpackages%2Fcli%2Fsrc%2Ftools%2Fexecution%2FPipelineStages.ts" target="_blank" title="https://github.com/echoVic/blade-code/blob/main/packages/cli/src/tools/execution/PipelineStages.ts" ref="nofollow noopener noreferrer">PipelineStages.ts</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[上下文工程：构建高性能AI Agent的系统性架构设计]]></title>    <link>https://juejin.cn/post/7603616672927563791</link>    <guid>https://juejin.cn/post/7603616672927563791</guid>    <pubDate>2026-02-07T17:37:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603616672927563791" data-draft-id="7603588665568378920" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="上下文工程：构建高性能AI Agent的系统性架构设计"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-02-07T17:37:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="盛夏光年爱学习"/> <meta itemprop="url" content="https://juejin.cn/user/2189882893018872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            上下文工程：构建高性能AI Agent的系统性架构设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882893018872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    盛夏光年爱学习
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-07T17:37:41.000Z" title="Sat Feb 07 2026 17:37:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">上下文工程：构建高性能AI Agent的系统性架构设计</h2>
<hr/>
<h3 data-id="heading-1">引言：从"提示工程"到"上下文工程"</h3>
<p>随着大语言模型（LLM）上下文窗口从4K扩展到128K甚至1M tokens，我们面临的核心挑战已从"装不下"转变为"管不好"。当Agent在复杂任务中持续运行，信息不断累积形成<strong>上下文债务</strong>（Context Debt），系统性能并非线性下降，而是在某个临界点突然崩溃。</p>
<p>本文基于LangChain提出的WSCI框架（Write-Select-Compress-Isolate），结合Anthropic关于"上下文腐烂"（Context Rot）的理论研究，系统阐述如何构建稳健、可扩展的AI Agent上下文架构。</p>
<hr/>
<h3 data-id="heading-2">第一部分：问题诊断——理解性能下降的本质</h3>
<h4 data-id="heading-3">1.1 根本病因：上下文腐烂（Context Rot）</h4>
<p>上下文腐烂是描述LLM处理长序列时<strong>底层认知能力系统性衰退</strong>的物理现象，其根源在于：</p>
<ul>
<li><strong>注意力稀释</strong>：Transformer的注意力机制随序列长度增加，单token可分配的注意力权重呈指数级下降</li>
<li><strong>训练分布偏移</strong>：预训练数据中长序列样本稀缺，模型缺乏长距离推理的优化经验</li>
<li><strong>位置编码限制</strong>：即使采用RoPE、ALiBi等相对位置编码，远距离依赖的建模能力仍会衰减</li>
</ul>
<p><strong>关键洞察</strong>：上下文腐烂是<strong>不可避免的物理约束</strong>，与信息内容质量无关，纯粹由信息数量触发。</p>
<h4 data-id="heading-4">1.2 四类并发症：具体的失败模式</h4>
<p>当上下文腐烂恶化，Agent在具体任务中表现出四种可被诊断的失败模式：</p>



































<table><thead><tr><th>失败模式</th><th>定义</th><th>核心类比</th><th>与腐烂的关系</th></tr></thead><tbody><tr><td><strong>上下文污染</strong> (Poisoning)</td><td>幻觉/错误信息进入上下文并被后续推理当作事实</td><td>信息源被投毒</td><td>腐烂导致判断力下降，更难识别错误输入</td></tr><tr><td><strong>上下文干扰</strong> (Distraction)</td><td>过多低价值信息压倒模型预训练知识</td><td>信噪比过低</td><td>腐烂直接导致注意力无法区分优先级</td></tr><tr><td><strong>上下文混淆</strong> (Confusion)</td><td>不相关信息错误关联，造成逻辑张冠李戴</td><td>注意力分散</td><td>腐烂导致无法清晰追踪核心逻辑</td></tr><tr><td><strong>上下文冲突</strong> (Clash)</td><td>上下文不同部分包含矛盾信息</td><td>指令集冲突</td><td>腐烂导致长距离记忆衰退，发现不了远距离矛盾</td></tr></tbody></table>
<h4 data-id="heading-5">1.3 因果关系的三个层面</h4>
<pre><code class="hljs">上下文腐烂（根本病因）
    │
    ├──→ 直接引发：注意力稀释 → 干扰/混淆
    │
    ├──→ 催生放大：推理能力下降 → 更容易产生幻觉（污染源头）
    │
    └──→ 屏蔽发现：长距离记忆衰退 → 发现不了已存在的冲突
</code></pre>
<p><strong>精准类比</strong>：将Agent想象成长途驾驶的司机</p>
<ul>
<li><strong>司机疲劳</strong> = 上下文腐烂（内在系统性能力下降）</li>
<li><strong>遇到烂路出错</strong> = 四类失败模式（外在症状）</li>
<li>精神饱满的司机能应对烂路，疲劳司机出车祸概率大增</li>
</ul>
<hr/>
<h3 data-id="heading-6">第二部分：WSCI框架——系统性的解决方案</h3>
<p>针对上下文腐烂这一根本病因及其并发症，LangChain提出了<strong>WSCI框架</strong>——四个正交的操作维度：</p>
<pre><code class="hljs language-sql" lang="sql">┌─────────────────────────────────────────────────────────┐
│                    WSCI 框架架构图                        │
├─────────────┬─────────────┬─────────────┬───────────────┤
│   Write     │   <span class="hljs-keyword">Select</span>    │  Compress   │   Isolate     │
│   (写入)     │   (选择)     │   (压缩)     │    (隔离)     │
├─────────────┼─────────────┼─────────────┼───────────────┤
│ 构建记忆系统 │ 注意力调度   │  降噪减负   │   分而治之        │
│  解决"存什么"│ 解决"取什么" │ 解决"装不下" │  解决"别干扰"    │
└─────────────┴─────────────┴─────────────┴───────────────┘
</code></pre>
<hr/>
<h3 data-id="heading-7">第三部分：写入（Write）——构建分层记忆系统</h3>
<p>写入操作的核心不是简单追加文本，而是构建<strong>两种功能截然不同的记忆系统</strong>：</p>
<h4 data-id="heading-8">3.1 草稿纸（Scratchpad）—— 短期过程记忆</h4>



































<table><thead><tr><th>特性</th><th>草稿纸</th><th>类比</th></tr></thead><tbody><tr><td><strong>核心类比</strong></td><td>办公桌/白板</td><td>处理当前工作，用完即清</td></tr><tr><td><strong>目的</strong></td><td>辅助当前任务成功执行</td><td>确保逻辑连贯性</td></tr><tr><td><strong>生命周期</strong></td><td>任务级/会话内（易失）</td><td>随任务结束清空</td></tr><tr><td><strong>内容粒度</strong></td><td>详细过程、中间步骤、原始数据</td><td>思考痕迹</td></tr><tr><td><strong>核心机制</strong></td><td><strong>存储与使用分离</strong></td><td>完整信息存于窗口外，按需载入</td></tr></tbody></table>
<p><strong>存储与使用分离</strong>是草稿纸对抗上下文腐烂的核心手段：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  应用程序内存    │ ←── │  上下文工程代码   │ ←── │   LLM上下文窗口  │
│ (完整草稿纸存储) │     │ (智能选择+压缩)   │     │  (关键信息子集)  │
└─────────────────┘     └─────────────────┘     └─────────────────┘
</code></pre>
<p><strong>两种实现模式对比</strong>：</p>























<table><thead><tr><th>模式</th><th>机制</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><strong>显式工具调用</strong></td><td>Agent主动调用<code>write_note</code>工具</td><td>行为透明，可调试性强</td><td>对模型要求高，增加Token开销</td></tr><tr><td><strong>隐式格式驱动</strong></td><td>强制<code>Thought/Action</code>格式，框架自动提取</td><td>高效自动化，符合自然推理流</td><td>过程由框架封装，相对黑盒</td></tr></tbody></table>
<h4 data-id="heading-9">3.2 长期记忆（Long-term Memory）—— 跨任务知识沉淀</h4>



































<table><thead><tr><th>特性</th><th>长期记忆</th><th>类比</th></tr></thead><tbody><tr><td><strong>核心类比</strong></td><td>档案柜/个人知识库</td><td>归档重要结论，供未来查阅</td></tr><tr><td><strong>目的</strong></td><td>辅助未来所有任务</td><td>实现学习与进化</td></tr><tr><td><strong>生命周期</strong></td><td>永久性/跨会话（持久）</td><td>持续积累</td></tr><tr><td><strong>内容粒度</strong></td><td>提炼后的结论、经验、高级知识</td><td>认知升华</td></tr><tr><td><strong>核心挑战</strong></td><td>从海量观察中智能提炼高价值信息</td><td>信息萃取</td></tr></tbody></table>
<p><strong>两种生成机制</strong>：</p>
<p><strong>机制一：Reflection（反思）—— 事件驱动的纠错型记忆</strong></p>
<p><strong>核心思想</strong>：从错误中学习，提炼可复用的行为规则。这是一种"痛过才懂"的学习模式。</p>
<p><strong>完整工作流程</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">┌─────────────────────────────────────────────────────────────────┐
│                     Reflection 工作流程                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  阶段<span class="hljs-number">1</span>：失败检测（框架自动完成）                                   │
│  ├── 监控Agent行动与观察的匹配度                                  │
│  ├── 识别工具调用失败、结果为空、格式错误等异常                    │
│  └── 示例：搜索<span class="hljs-string">"Apple revenue"</span>返回手机新闻而非财报                │
│                                                                 │
│  阶段<span class="hljs-number">2</span>：元提示生成（框架自动完成）                                 │
│  └── 构造复盘Prompt：<span class="hljs-string">"回顾这次失败，生成一条可复用的规则          │
│      避免未来犯错，格式：当[情境]时，应[行动]"</span>                    │
│                                                                 │
│  阶段<span class="hljs-number">3</span>：规则生成（LLM执行）                                       │
│  └── 产出行为策略：<span class="hljs-string">"当我搜索公司财报时，应加入'季度收益'等关键词"</span>  │
│                                                                 │
│  阶段<span class="hljs-number">4</span>：记忆写入（框架执行）                                      │
│  └── 将规则存入长期记忆的<span class="hljs-string">"程序性记忆"</span>分区                         │
│  └── 标记为：类型=行为规则，置信度=高，来源=反思生成               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>关键设计要点</strong>：</p>






























<table><thead><tr><th>设计维度</th><th>具体策略</th><th>目的</th></tr></thead><tbody><tr><td><strong>触发条件</strong></td><td>明确的失败信号（工具错误、结果为空、格式不匹配）</td><td>避免过度反思，确保规则质量</td></tr><tr><td><strong>规则抽象度</strong></td><td>从具体实例上升到模式匹配（如"Apple"→"公司"）</td><td>提高规则的泛化能力</td></tr><tr><td><strong>置信度管理</strong></td><td>新规则标记为"待验证"，多次成功应用后升级为"已确认"</td><td>防止错误规则持续污染</td></tr><tr><td><strong>冲突检测</strong></td><td>写入前检查是否与现有规则矛盾</td><td>避免规则集内部冲突</td></tr></tbody></table>
<p><strong>适用场景</strong>：</p>
<ul>
<li>工具调用频繁失败的场景（如搜索、API调用）</li>
<li>需要快速迭代优化的封闭领域（如特定公司的内部系统操作）</li>
<li>错误成本较高的场景（如金融交易、医疗诊断）</li>
</ul>
<p><strong>机制二：Generative Agents（生成式智能体）—— 周期性的认知升华</strong></p>
<p><strong>核心思想</strong>：从日常观察中持续积累，通过周期性总结提炼高级洞察。这是一种"温故知新"的学习模式。</p>
<p><strong>完整工作流程</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">┌─────────────────────────────────────────────────────────────────┐
│                Generative Agents 工作流程                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  阶段<span class="hljs-number">1</span>：原始日志收集（持续进行）                                   │
│  ├── 时间戳：<span class="hljs-number">10</span>:<span class="hljs-number">05</span>                                               │
│  │   事件：张三在会议中提到<span class="hljs-string">"项目预算紧张"</span>                          │
│  ├── 时间戳：<span class="hljs-number">14</span>:<span class="hljs-number">30</span>                                               │
│  │   事件：收到李四邮件，主题<span class="hljs-string">"关于Q3成本削减方案"</span>                   │
│  └── 时间戳：<span class="hljs-number">16</span>:<span class="hljs-number">45</span>                                               │
│      事件：王五在群聊中询问<span class="hljs-string">"是否可以推迟非核心采购"</span>                 │
│                                                                 │
│  阶段<span class="hljs-number">2</span>：周期性合成触发（每日/每周结束时）                          │
│  └── 框架启动Prompt链进行多轮认知升华                              │
│                                                                 │
│  阶段<span class="hljs-number">3</span>：分层摘要提炼（LLM多轮执行）                                │
│  ├── 第<span class="hljs-number">1</span>轮（事实层）：<span class="hljs-string">"总结以上日志的核心动态"</span>                     │
│  │   输出：<span class="hljs-string">"张三、李四、王五都讨论了预算相关问题"</span>                   │
│  ├── 第<span class="hljs-number">2</span>轮（关联层）：<span class="hljs-string">"这些事件之间有何关联？"</span>                     │
│  │   输出：<span class="hljs-string">"三人从不同角度（会议、邮件、群聊）表达对预算的担忧"</span>      │
│  └── 第<span class="hljs-number">3</span>轮（洞察层）：<span class="hljs-string">"基于此，有何新洞察？"</span>                      │
│      输出：<span class="hljs-string">"项目X正面临显著的预算风险，可能需要启动风险预案"</span>        │
│                                                                 │
│  阶段<span class="hljs-number">4</span>：高级记忆写入（框架执行）                                   │
│  └── 将洞察存入长期记忆的<span class="hljs-string">"语义记忆"</span>分区                            │
│  └── 标记为：类型=高级事实，时效性=长期，置信度=中等               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>关键设计要点</strong>：</p>



































<table><thead><tr><th>设计维度</th><th>具体策略</th><th>目的</th></tr></thead><tbody><tr><td><strong>收集粒度</strong></td><td>原始事件日志（谁、何时、说了什么）</td><td>保留完整上下文，支持多维度总结</td></tr><tr><td><strong>合成周期</strong></td><td>高频（每日）+ 低频（每周/每月）双层机制</td><td>平衡时效性与认知深度</td></tr><tr><td><strong>Prompt链设计</strong></td><td>从事实→关联→洞察的递进式提问</td><td>模拟人类的归纳推理过程</td></tr><tr><td><strong>时效性管理</strong></td><td>洞察标记有效期（如"预算紧张"标记为季度有效）</td><td>防止过时洞察持续影响决策</td></tr><tr><td><strong>溯源能力</strong></td><td>保留指向原始日志的引用链接</td><td>支持洞察的验证与审计</td></tr></tbody></table>
<p><strong>适用场景</strong>：</p>
<ul>
<li>需要长期跟踪的复杂项目（如客户关系管理、产品研发）</li>
<li>多源信息汇聚的场景（如舆情监控、竞争情报）</li>
<li>需要发现隐性模式的场景（如用户行为分析、风险评估）</li>
</ul>
<p><strong>两种机制的对比与协同</strong></p>













































<table><thead><tr><th>维度</th><th>Reflection</th><th>Generative Agents</th></tr></thead><tbody><tr><td><strong>触发时机</strong></td><td>事件驱动（失败时立即触发）</td><td>周期驱动（定时批量处理）</td></tr><tr><td><strong>学习来源</strong></td><td>负面经验（错误、失败）</td><td>正面/中性观察（日常事件）</td></tr><tr><td><strong>产出形式</strong></td><td>行为规则（如何做）</td><td>高级事实/洞察（是什么）</td></tr><tr><td><strong>记忆类型</strong></td><td>程序性记忆</td><td>语义记忆</td></tr><tr><td><strong>更新频率</strong></td><td>高频、即时</td><td>低频、批量</td></tr><tr><td><strong>认知深度</strong></td><td>浅层（单点纠错）</td><td>深层（模式发现）</td></tr><tr><td><strong>协同关系</strong></td><td>Reflection规则可指导Generative Agents的关注重点</td><td>Generative Agents的洞察可优化Reflection的触发条件</td></tr></tbody></table>
<p><strong>协同示例</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">Generative Agents发现：<span class="hljs-string">"近期项目频繁出现预算相关讨论"</span>（洞察）
    ↓
优化Reflection触发条件：增加<span class="hljs-string">"预算相关工具调用失败"</span>的敏感度
    ↓
Reflection生成规则：<span class="hljs-string">"当搜索预算信息时，应同时查询'成本'、'开支'等同义词"</span>
    ↓
Generative Agents在下一轮合成中发现规则应用效果，验证洞察准确性
</code></pre>
<h3 data-id="heading-10">第四部分：选择（Select）—— 从加载数据到注意力调度</h3>
<p>选择操作是WSCI框架中<strong>最高频、最核心</strong>的环节，类比操作系统的内存调度算法。</p>
<h4 data-id="heading-11">4.1 四大信息源的选择策略</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────┐
│                    选择操作的信息源架构                       │
├──────────────────┬──────────────────┬───────────┬───────────┤
│    草稿纸         │    长期记忆       │   工具集   │   知识库   │
│  (短期工作笔记)    │  (持久化知识)     │ (可执行能力)│ (外部数据) │
├──────────────────┼──────────────────┼───────────┼───────────┤
│ • 显式工具回忆    │ • 程序性记忆(如何做)│ • RAG for │ • 混合检索 │
│ • 滑动窗口       │ • 情景记忆(发生了什么)│   Tools  │ • Agentic │
│ • 状态总结       │ • 语义记忆(是什么)  │ • 动态选择 │   Search │
│ • 错误复盘       │ • 动态少样本提示   │ • 固定遮蔽 │ • 重排序  │
└──────────────────┴──────────────────┴───────────┴───────────┘
</code></pre>
<h4 data-id="heading-12">4.2 长期记忆的人类记忆三分法</h4>
<p>LangChain引入认知科学中的<strong>人类记忆三分法</strong>来分类长期记忆：</p>





























<table><thead><tr><th>记忆类型</th><th>对应内容</th><th>选择策略</th><th>技术实现</th></tr></thead><tbody><tr><td><strong>程序性记忆</strong></td><td>行为规则（系统提示）</td><td>动态模板切换</td><td>根据用户意图选择专门指令模块（如识别"退货"意图才加载退货流程指南）</td></tr><tr><td><strong>情景记忆</strong></td><td>过往经验（少样本示例）</td><td>动态少样本提示</td><td>基于语义相似度从示例库动态检索最相关案例</td></tr><tr><td><strong>语义记忆</strong></td><td>事实性知识</td><td>相关性+意图适配性</td><td>RAG、混合检索、知识图谱</td></tr></tbody></table>
<p><strong>关键警示</strong>：一个错误的选择比没有记忆更糟糕。ChatGPT曾错误选择用户地理位置信息注入图片生成，导致输出偏差。算法不仅要判断<strong>语义相关性</strong>，更要判断<strong>任务意图的适切性</strong>。</p>
<h4 data-id="heading-13">4.3 工具选择的架构权衡</h4>























<table><thead><tr><th>策略</th><th>机制</th><th>适用场景</th><th>权衡点</th></tr></thead><tbody><tr><td><strong>动态选择（RAG for Tools）</strong></td><td>为工具描述建独立索引，预检索加载Top-K</td><td>工具集庞大且开放（如插件系统）</td><td>优先考虑扩展性与精准度</td></tr><tr><td><strong>固定工具集+遮蔽（Masking）</strong></td><td>保持提示前缀不变，利用KV缓存加速</td><td>工具集小而稳定，对延迟要求极高</td><td>优先考虑性能与速度</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-14">第五部分：压缩（Compress）—— 高保真的降噪减负</h3>
<p>压缩操作针对<strong>即将进入窗口的原始信息流</strong>（冗长对话历史、海量API返回），在信息进入新一轮调用前为其降噪减负。</p>
<h4 data-id="heading-15">5.1 两种技术路线的对比</h4>






























<table><thead><tr><th>维度</th><th>上下文总结（Summarization）</th><th>上下文裁剪（Trimming）</th></tr></thead><tbody><tr><td><strong>核心机制</strong></td><td>LLM智能提炼（理解并重写）</td><td>基于规则过滤（直接丢弃）</td></tr><tr><td><strong>优点</strong></td><td>✅ 智能，保留核心语义 ✅ 擅长处理非结构化长文本</td><td>✅ 快速，成本极低 ✅ 对保留部分保真度100%</td></tr><tr><td><strong>缺点</strong></td><td>❌ 慢，成本高（需额外LLM调用） ❌ 有损压缩，可能丢失细节</td><td>❌ "笨拙"，可能粗暴丢弃重要信息 ❌ 规则需人工精心设计</td></tr><tr><td><strong>适用场景</strong></td><td>处理巨型工具返回、总结长对话历史、Agent间工作交接</td><td>管理常规对话历史（滑动窗口）、清理已消化的旧信息</td></tr></tbody></table>
<h4 data-id="heading-16">5.2 上下文总结：三个核心应用场景</h4>
<p><strong>场景一：总结对话历史</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">原始：早期<span class="hljs-number">20</span>轮详细对话（<span class="hljs-number">10</span>K tokens）
    ↓ LLM提炼
摘要：<span class="hljs-string">"任务：查询订单#12345售后；关键决策：已修改收货地址，
      申请电子发票；用户偏好：偏好短信通知"</span>
    ↓ 替换原文
载入上下文：<span class="hljs-number">1</span>段摘要（<span class="hljs-number">200</span> tokens）
</code></pre>
<p><strong>场景二：后处理工具反馈</strong></p>
<pre><code class="hljs language-css" lang="css">错误做法：将<span class="hljs-number">5</span>万字网页<span class="hljs-selector-tag">HTML</span>直接喂给Agent
正确做法：<span class="hljs-selector-tag">HTML</span> → 专门总结Prompt提取核心要点 → 精炼摘要载入
</code></pre>
<p><strong>场景三：Agent间知识交接</strong></p>
<pre><code class="hljs language-css" lang="css">子Agent完整思考日志（<span class="hljs-number">50</span>轮，<span class="hljs-number">5</span>K tokens）
    ↓ 总结提炼
浓缩工作报告："研究发现Q3营收增长<span class="hljs-number">20%</span>，主要驱动因素：<span class="hljs-selector-tag">A</span>、<span class="hljs-selector-tag">B</span>、C；
              建议：关注D风险"
    ↓ 提交给主Agent
</code></pre>
<p><strong>关键挑战：信息保真度</strong></p>
<blockquote>
<p>"过度激进的压缩可能导致微妙但关键的信息丢失。"</p>
</blockquote>
<p><strong>应对策略</strong>：</p>
<ul>
<li>精心设计的压缩Prompt（明确保留重点）</li>
<li>配合分层记忆系统（关键结论写入结构化笔记，不依赖对话压缩）</li>
</ul>
<h4 data-id="heading-17">5.3 上下文裁剪的两种实现</h4>
<pre><code class="hljs language-arduino" lang="arduino">方式一：硬编码启发式（滑动窗口）
策略：设定固定规则，如<span class="hljs-string">"永远只保留最近10轮对话"</span>
优点：极其简单快速，成本几乎为零
缺点：一刀切，可能丢弃早期奠基信息
​
方式二：智能过滤（训练裁剪器）
策略：训练轻量级分类模型判断每条信息<span class="hljs-string">"应保留"</span>或<span class="hljs-string">"可丢弃"</span>
优点：比滑动窗口智能（如识别核心问题即使很老也不丢弃）
缺点：需额外模型训练和维护成本
</code></pre>
<p><strong>信息保真度管理</strong>：过度激进的压缩可能导致微妙但关键的信息丢失。应通过<strong>精心设计的压缩Prompt</strong>配合<strong>分层记忆系统</strong>，确保关键结论写入持久化结构化笔记，而非在对话历史压缩中意外丢失。</p>
<hr/>
<h3 data-id="heading-18">第六部分：隔离（Isolate）—— 分而治之的架构艺术</h3>
<p>隔离操作解决复杂系统中的<strong>信息流干扰</strong>问题，通过创建多个独立的上下文空间实现复杂并行工作流。</p>
<h4 data-id="heading-19">6.1 三种隔离架构模式</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────┐
│                    隔离架构的三种模式                         │
├──────────────────┬──────────────────┬───────────────────────┤
│    多智能体        │    环境/沙箱      │     运行时状态对象      │
│  (Agent之间隔离)   │  (思考与执行隔离)  │    (Agent内部隔离)     │
├──────────────────┼──────────────────┼───────────────────────┤
│ • 主Agent规划分解 │ • LLM只负责思考   │ • 状态结构化为多字段对象 │
│ • 子Agent并行执行 │ • 重资产操作交沙箱 │ • 开发者代码按需暴露    │
│ • 完全独立上下文  │ • 状态化环境隔离   │ • Schema预定义边界     │
│ • 关注点分离      │ • 真实对象操作    │ • 运行时动态拉取       │
└──────────────────┴──────────────────┴───────────────────────┘
</code></pre>
<h5 data-id="heading-20">模式一：多智能体（Multi-Agent）—— Agent之间的隔离</h5>
<p><strong>核心机制</strong>：团队协作模式，将上下文隔离级别从单个Agent内部提升到多个Agent之间。</p>
<p><strong>架构详解</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────┐
│                     多智能体架构图示                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐                                            │
│  │    主Agent       │ ←── 负责顶层规划与任务分解                   │
│  │  (规划者/协调者)  │      维护"元上下文"：任务目标、子任务分配、   │
│  │                 │      整合规则，不接触具体执行细节              │
│  └────────┬────────┘                                            │
│           │ 委派子任务                                            │
│           ▼                                                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   专家Agent <span class="hljs-selector-tag">A</span>    │  │   专家Agent <span class="hljs-selector-tag">B</span>    │  │   专家Agent C    │  │
│  │  (代码生成专家)   │  │  (数据分析专家)   │  │  (文档撰写专家)   │  │
│  │                 │  │                 │  │                 │  │
│  │ 独立上下文窗口    │  │ 独立上下文窗口    │  │ 独立上下文窗口    │  │
│  │ • 代码规范       │  │ • 数据schema     │  │ • 文档模板       │  │
│  │ • 相关API文档    │  │ • 统计方法       │  │ • 风格指南       │  │
│  │ • 历史代码示例   │  │ • 可视化库用法   │  │ • 术语表         │  │
│  │ （无关信息被隔离）│  │ （无关信息被隔离）│  │ （无关信息被隔离）│  │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘  │
│           │                    │                    │           │
│           └────────────────────┼────────────────────┘           │
│                                │ 返回结果                        │
│                                ▼                                │
│                         ┌─────────────┐                         │
│                         │   结果整合     │                       │
│                         │  (主Agent汇总) │                       │
│                         └─────────────┘                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>关键设计决策</strong>：</p>






























<table><thead><tr><th>决策点</th><th>策略选项</th><th>选择依据</th></tr></thead><tbody><tr><td><strong>任务分解粒度</strong></td><td>粗粒度（少而大的子任务）vs 细粒度（多而小的子任务）</td><td>子任务间独立性高→细粒度；需要全局协调→粗粒度</td></tr><tr><td><strong>通信协议</strong></td><td>结构化（JSON/XML）vs 自然语言</td><td>机器可读性要求高→结构化；灵活性要求高→自然语言</td></tr><tr><td><strong>上下文共享范围</strong></td><td>零共享（完全隔离）vs 只读共享（共享背景信息）vs 全共享（共享完整历史）</td><td>避免污染→零共享；需要一致性→只读共享</td></tr><tr><td><strong>协调机制</strong></td><td>中心化（主Agent调度）vs 去中心化（Agent间直接通信）</td><td>需要全局优化→中心化；需要响应速度→去中心化</td></tr></tbody></table>
<p><strong>成本收益分析的量化框架</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">成本 <span class="hljs-operator">=</span> <span class="hljs-number">15</span>x Token开销（典型值）<span class="hljs-operator">+</span> 延迟增加 <span class="hljs-operator">+</span> 系统复杂度提升
收益 <span class="hljs-operator">=</span> 任务并行度提升 × 单任务质量提升 × 错误隔离带来的稳定性提升
​
决策规则：
IF 任务可并行度 <span class="hljs-operator">&gt;</span> <span class="hljs-number">0.7</span> 
   <span class="hljs-keyword">AND</span> 单任务质量提升 <span class="hljs-operator">&gt;</span> <span class="hljs-number">30</span><span class="hljs-operator">%</span> 
   <span class="hljs-keyword">AND</span> 错误成本 <span class="hljs-operator">&gt;</span> 多Agent成本
<span class="hljs-keyword">THEN</span> 采用多Agent架构
<span class="hljs-keyword">ELSE</span> 采用单Agent <span class="hljs-operator">+</span> 其他WSCI操作优化
</code></pre>
<hr/>
<h5 data-id="heading-21">模式二：环境沙箱（Sandbox）—— 思考与执行的隔离</h5>
<p><strong>核心机制</strong>：分离LLM的"思考"（生成代码/指令）与"执行"（操作真实世界状态），让Agent在轻量级上下文中操作重资产数据。</p>
<p><strong>架构详解</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">┌─────────────────────────────────────────────────────────────────┐
│                     环境沙箱架构图示                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────┐        ┌─────────────────────────┐ │
│  │      LLM上下文窗口        │        │      沙箱执行环境         │ │
│  │    （轻量级，只存思考）     │        │   （重量级，存储真实状态）  │ │
│  │                         │        │                         │ │
│  │  系统提示：<span class="hljs-string">"你是一个数据    │        │  ┌─────────────────┐    │ │
│  │  分析师，请生成Python代码   │◄───────┤  │   数据对象        │    │ │
│  │  分析用户上传的数据集"</span>      │  代码   │  │  • DataFrame     │    │ │
│  │                         │        │  │  • 文件句柄       │    │ │
│  │  用户问题：<span class="hljs-string">"分析销售趋势"</span>   │        │  │  • 数据库连接     │    │ │
│  │                         │        │  │  • API响应缓存    │    │ │
│  │  Agent思考：<span class="hljs-string">"我需要先加载   │        │  └─────────────────┘    │ │
│  │  数据，然后计算月度统计..."</span>  │        │                         │ │
│  │                         │        │  ┌─────────────────┐    │ │
│  │  Agent输出（代码）：        │───────►│  │   执行引擎        │    │ │
│  │  ```python               │  执行   │  │  • Python解释器   │    │ │
│  │  <span class="hljs-built_in">df</span> = sandbox.load(<span class="hljs-string">'sales │        │  │  • 文件系统       │    │ │
│  │  _data.csv'</span>)             │        │  │  • 网络访问       │    │ │
│  │  monthly = df.groupby(    │        │  │  • 资源限制器     │    │ │
│  │  <span class="hljs-string">'month'</span>).<span class="hljs-built_in">sum</span>()          │        │  └─────────────────┘    │ │
│  │  sandbox.plot(monthly)   │        │                         │ │
│  │  ```                     │        │  ┌─────────────────┐    │ │
│  │                         │        │  │   结果摘要        │    │ │
│  │  [接收执行结果摘要]        │◄───────┤  │  • 统计指标       │    │ │
│  │  <span class="hljs-string">"月度销售趋势图已生成，    │  摘要   │  • 异常检测       │    │ │
│  │  Q3环比增长15%..."</span>         │        │  • 可视化路径     │    │ │
│  │                         │        │  └─────────────────┘    │ │
│  └─────────────────────────┘        └─────────────────────────┘ │
│                                                                 │
│  关键隔离点：LLM从不直接接触原始数据，只操作沙箱提供的元数据        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>沙箱与草稿纸的本质区别</strong>：</p>













































<table><thead><tr><th>维度</th><th>草稿纸（Scratchpad）</th><th>环境沙箱（Sandbox）</th></tr></thead><tbody><tr><td><strong>隔离层级</strong></td><td>Agent内部</td><td>Agent与外部环境之间</td></tr><tr><td><strong>信息介质</strong></td><td>文本（字符串）</td><td>真实对象（DataFrame、文件、连接）</td></tr><tr><td><strong>存储内容</strong></td><td>思考过程、推理痕迹</td><td>真实世界的状态、数据</td></tr><tr><td><strong>操作方式</strong></td><td>读/写文本</td><td>发号施令（生成代码操作对象）</td></tr><tr><td><strong>生命周期</strong></td><td>随任务结束清空</td><td>可持久化或按策略清理</td></tr><tr><td><strong>核心价值</strong></td><td>记录推理过程，支持回溯</td><td>让Agent处理远超上下文窗口的数据量</td></tr><tr><td><strong>典型操作</strong></td><td>"记录当前计划"、"更新观察结果"</td><td>"加载数据集"、"执行查询"、"生成图表"</td></tr></tbody></table>
<p><strong>沙箱的高级应用——"盲人摸象"式分析</strong>：</p>
<pre><code class="hljs language-json" lang="json">场景：分析<span class="hljs-number">100</span>GB的日志文件，远超LLM上下文窗口
​
传统方式：无法处理，或需要预先用其他工具抽样
​
沙箱方式：
    │
    ├── Agent生成代码：<span class="hljs-string">"读取日志文件的元数据（时间范围、字段列表）"</span>
    ├── 沙箱返回：<span class="hljs-punctuation">{</span><span class="hljs-attr">"size"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"100GB"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"rows"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">500000000</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"fields"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"timestamp"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"level"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"message"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span>
    │
    ├── Agent生成代码：<span class="hljs-string">"按小时抽样统计错误率分布"</span>
    ├── 沙箱执行抽样查询，返回：<span class="hljs-punctuation">{</span><span class="hljs-attr">"peak_hour"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"14:00"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"error_rate"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5%"</span><span class="hljs-punctuation">}</span>
    │
    ├── Agent生成代码：<span class="hljs-string">"深入分析14:00的错误日志，提取常见错误模式"</span>
    ├── 沙箱返回Top<span class="hljs-number">-5</span>错误类型及示例
    │
    └── Agent基于这些<span class="hljs-string">"摸象"</span>得到的元数据，生成最终分析报告
​
Agent始终工作在轻量级上下文（只存代码和元数据），
但通过沙箱操作实现了对海量数据的分析能力。
</code></pre>
<h5 data-id="heading-22">模式三：运行时状态对象（Runtime State）—— Agent内部的结构化隔离</h5>
<p><strong>核心机制</strong>：将Agent的完整状态设计为结构化的多字段对象，通过Schema预定义信息边界，实现内部模块化隔离。</p>
<p><strong>架构详解</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────┐
│                   运行时状态对象架构图示                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              Agent运行时状态对象（完整状态）               │   │
│  │                                                         │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │   │
│  │  │  messages   │  │working_mem  │  │  user_profile│     │   │
│  │  │  (对话历史)  │  │ (工作记忆)   │  │  (用户画像)  │     │   │
│  │  │             │  │             │  │             │     │   │
│  │  │ • 用户输入   │  │ • 当前计划   │  │ • 偏好设置   │     │   │
│  │  │ • Agent回复  │  │ • 中间结果   │  │ • 历史行为   │     │   │
│  │  │ • 工具调用   │  │ • 待办事项   │  │ • 权限等级   │     │   │
│  │  │             │  │             │  │             │     │   │
│  │  │ <span class="hljs-selector-attr">[隔离规则：  │  │ [隔离规则：  │  │ [隔离规则：  │     │   ││  │  │  全量保留    │  │  按需加载    │  │  只读访问]</span>   │     │   │
│  │  │  但受压缩]   │  │  高优先级]   │  │             │     │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘     │   │
│  │                                                         │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │   │
│  │  │ tool_results│  │  session_ctx │  │  system_cfg  │     │   │
│  │  │ (工具结果)   │  │ (会话上下文) │  │ (系统配置)   │     │   │
│  │  │             │  │             │  │             │     │   │
│  │  │ • 原始返回   │  │ • 任务类型   │  │ • 模型参数   │     │   │
│  │  │ • 解析状态   │  │ • 会话ID    │  │ • 安全策略   │     │   │
│  │  │ • 缓存标记   │  │ • 时间戳    │  │ • 功能开关   │     │   │
│  │  │             │  │             │  │             │     │   │
│  │  │ <span class="hljs-selector-attr">[隔离规则：  │  │ [隔离规则：  │  │ [隔离规则：  │     │   ││  │  │  后处理压缩  │  │  全量只读]</span>   │  │  系统级保护] │     │   │
│  │  │  后丢弃原始] │  │             │  │             │     │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘     │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  每次LLM调用时，框架根据当前任务类型，按隔离规则选择暴露的字段：    │
│                                                                 │
│  示例：代码生成任务时的上下文组装                                  │
│  ├── 必须加载：messages（最近<span class="hljs-number">3</span>轮）、working_mem（当前计划）        │
│  ├── 条件加载：user_profile（如果涉及个性化代码风格）               │
│  ├── 后处理加载：tool_results（先压缩为摘要）                      │
│  └── 禁止加载：system_cfg（内部配置，不暴露给模型）                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>隔离与选择的协同工作流</strong>：</p>
<pre><code class="hljs">设计时（隔离视角）：
    │
    ├── 定义状态Schema，划分字段边界
    ├── 为每个字段设定访问权限（读/写/不可见）
    ├── 设定字段间的依赖关系（如tool_results依赖session_ctx）
    └── 建立字段的加载优先级和压缩策略
                │
                ▼
运行时（选择视角）：
    │
    ├── 识别当前任务类型和意图
    ├── 根据隔离规则，从各字段中选择需要暴露的数据
    ├── 应用字段特定的压缩策略（如messages用滑动窗口，tool_results用摘要）
    └── 组装最终上下文，确保不违反隔离边界
</code></pre>
<h4 data-id="heading-23">6.2 多智能体的成本收益权衡</h4>
<p><strong>核心机制</strong>：团队协作模式，将上下文隔离级别从单个Agent内部提升到多个Agent之间。</p>
<p><strong>架构要点</strong>：</p>
<ul>
<li>主Agent负责顶层规划与任务分解</li>
<li>专家子Agent在<strong>完全独立的上下文窗口</strong>中并行执行</li>
<li>实现清晰的关注点分离，避免主Agent被海量细节污染</li>
</ul>
<p><strong>成本收益权衡</strong>：</p>
<ul>
<li>Token消耗可能高达<strong>15倍</strong></li>
<li><strong>采用标准</strong>：任务高度可并行 + 子任务需深度探索 + 收益远大于成本</li>
<li><strong>默认策略</strong>：采用单Agent，只有遇到明确瓶颈才评估多Agent</li>
</ul>
<h4 data-id="heading-24">6.3 环境沙箱 vs 草稿纸的本质区别</h4>






























<table><thead><tr><th>维度</th><th>草稿纸（Scratchpad）</th><th>环境沙箱（Sandbox）</th></tr></thead><tbody><tr><td><strong>隔离对象</strong></td><td>思考的痕迹</td><td>真实世界的状态</td></tr><tr><td><strong>存储介质</strong></td><td>字符串（Text Log）</td><td>真实对象（DataFrame, File等）</td></tr><tr><td><strong>Agent操作</strong></td><td>读/写文本</td><td>发号施令（生成代码操作对象）</td></tr><tr><td><strong>核心价值</strong></td><td>记录推理过程</td><td>让Agent通过操作对象元数据实现"盲人摸象"式分析，始终工作在轻量级上下文</td></tr></tbody></table>
<h4 data-id="heading-25">6.4 隔离与选择的辩证关系</h4>
<ul>
<li><strong>隔离（Isolate）</strong> ：<strong>架构师视角</strong>，强调"阻挡"。通过Schema设计预先定义信息边界和访问权限。</li>
<li><strong>选择（Select）</strong> ：<strong>操作员视角</strong>，强调"拉取"。在运行时根据隔离预设规则，动态从不同分区拉取信息。</li>
</ul>
<p><strong>结论</strong>：隔离定义了信息的边界，选择<strong>在边界内活动</strong>——它们是同一枚硬币的两面。</p>
<hr/>
<h3 data-id="heading-26">第七部分：实践指南——构建上下文架构的 checklist</h3>
<p>基于WSCI框架，我们提供以下实践 checklist：</p>
<h4 data-id="heading-27">7.1 写入阶段</h4>
<ul>
<li>明确区分草稿纸（任务级）和长期记忆（永久级）的写入目标</li>
<li>选择显式工具调用（可调试）或隐式格式驱动（高效）的实现模式</li>
<li>为长期记忆设计Reflection（纠错）或Generative Agents（升华）的生成机制</li>
</ul>
<h4 data-id="heading-28">7.2 选择阶段</h4>
<ul>
<li>为草稿纸实现滑动窗口、状态总结或错误复盘的选择策略</li>
<li>为长期记忆应用人类记忆三分法，实现动态模板、动态少样本、RAG检索</li>
<li>为工具集评估动态选择（大规模）vs 固定遮蔽（高延迟要求）的架构</li>
<li>为知识库实现混合检索（向量+关键词+图谱）+ Agentic探索 + 重排序</li>
</ul>
<h4 data-id="heading-29">7.3 压缩阶段</h4>
<ul>
<li>对高价值、非结构化信息使用上下文总结（Summarization）</li>
<li>对常规维护使用上下文裁剪（Trimming/滑动窗口）</li>
<li>建立分层记忆系统，确保关键结论不依赖对话历史压缩</li>
</ul>
<h4 data-id="heading-30">7.4 隔离阶段</h4>
<ul>
<li>评估任务是否真正需要多智能体架构（成本可能高达15倍）</li>
<li>设计环境沙箱分离思考与执行，处理重资产操作</li>
<li>通过运行时状态对象的Schema设计，实现内部结构化隔离</li>
</ul>
<hr/>
<h3 data-id="heading-31">结语：从算法调优到架构设计</h3>
<p>回顾整个上下文工程的演进路径：</p>
<pre><code class="hljs language-scss" lang="scss">Anthropic理论层              LangChain工程层                实践认知层
    │                            │                            │
    │   上下文腐烂的根本约束      │   WSCI框架管理上下文          │   核心挑战转移
    │   (Transformer架构限制)    │   (Write-Select-Compress-Isolate) │   (算法→架构)
    │                            │                            │
    └────────────────────────────┴────────────────────────────┘
                              │
                              ▼
              构建真正强大、可靠、可扩展的AI Agent
              其核心已从算法和模型本身
              转移到了系统性的上下文架构设计
</code></pre>
<p>这正是开发者在Agent时代的<strong>核心价值所在</strong>——不再是调模型参数，而是设计上下文架构。</p>
<hr/>
<h3 data-id="heading-32">参考资源</h3>
<ol>
<li>LangChain Documentation: Context Engineering Best Practices</li>
<li>Anthropic Research: The Challenges of Long Context in LLMs</li>
<li>Shunyu Yao et al. "ReAct: Synergizing Reasoning and Acting in Language Models"</li>
<li>Noever et al. "Generative Agents: Interactive Simulacra of Human Behavior"</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[拆解LangChain执行引擎] ManagedValue——一种特殊的只读虚拟通道]]></title>    <link>https://juejin.cn/post/7603649945978667027</link>    <guid>https://juejin.cn/post/7603649945978667027</guid>    <pubDate>2026-02-08T00:14:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603649945978667027" data-draft-id="7603649945978650643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[拆解LangChain执行引擎] ManagedValue——一种特殊的只读虚拟通道"/> <meta itemprop="keywords" content="LangChain,Python"/> <meta itemprop="datePublished" content="2026-02-08T00:14:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JaydenAI"/> <meta itemprop="url" content="https://juejin.cn/user/3001011641261209"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [拆解LangChain执行引擎] ManagedValue——一种特殊的只读虚拟通道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3001011641261209/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JaydenAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T00:14:01.000Z" title="Sun Feb 08 2026 00:14:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我们一直在强调Pregel对象的状态是通过<code>Channel</code>维护和传递的，其实承载传递状态功能的组件除了Channel，还有  <code>ManagedValue</code>。我们可以将ManagedValue视为虚拟Channel，Node不仅采用与读取Channel完全一样的方式读取ManagedValue，而且注册的ManagedValue也直接存放在Pregel的channels字段中。</p>
<p>如果我们仔细查看Pregel类的定义，可以看出其<code>channels</code>字段返回一个字典，字典的值的类型联合了BaseChannel和<code>ManagedValueSpec</code>两种类型，前者是Channel的基类，后者就是<code>ManagedValue</code>类的别名。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Pregel</span>(
    PregelProtocol[StateT, ContextT, InputT, OutputT],
    <span class="hljs-type">Generic</span>[StateT, ContextT, InputT, OutputT]): 
    channels : <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, BaseChannel | ManagedValueSpec]

ManagedValueSpec = <span class="hljs-built_in">type</span>[ManagedValue]
</code></pre>
<p>如果说Channel存储的是的业务状态，那么ManagedValue传递的就是Pregel这个执行引擎的运行时状态。一般来说，ManagedValue自身不负责存储状态，其提供的值可以实时计算得出，所以它不参与基于Checkpoint的持久化。从如下所示的代码片段可以看出，ManagedValue仅仅定义了一个唯一的静态抽象方法<code>get</code>返回对应的值，由于作为输入的<code>PregelScratchpad</code>对象提供的信息有限，所以ManagedValue能够发挥的空间其实很有限，在大部分情况下用不到它。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ManagedValue</span>(ABC, <span class="hljs-type">Generic</span>[V]):
<span class="hljs-meta">    @staticmethod</span>
<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">scratchpad: PregelScratchpad</span>) -&gt; V: ...
</code></pre>
<h2 data-id="heading-0">1. PregelScratchpad</h2>
<p>ManagedValue提供的值是通过其get方法根据PregelScratchpad对象计算所得。当确定后续待执行的Node后，引擎会为每个Node创建一个任务，每个任务都会附加一个PregelScratchpad对象。PregelScratchpad的<code>step</code>和<code>stop</code>字段就返回当前Superstep的序号和针对迭代的限制（最大超步数），其它字段与持久化有关。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@dataclasses.dataclass(<span class="hljs-params">**_DC_KWARGS</span>)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PregelScratchpad</span>:
    step : <span class="hljs-built_in">int</span>
    stop : <span class="hljs-built_in">int</span>
    call_counter : <span class="hljs-type">Callable</span>[[], <span class="hljs-built_in">int</span>]
    interrupt_counter : <span class="hljs-type">Callable</span>[[], <span class="hljs-built_in">int</span>]
    get_null_resume	: <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">bool</span>], <span class="hljs-type">Any</span>]
    resume : <span class="hljs-built_in">list</span>[<span class="hljs-type">Any</span>]
    subgraph_counter	: <span class="hljs-type">Callable</span>[[], <span class="hljs-built_in">int</span>]	
</code></pre>
<p>PregelScratchpad的<code>call_counter</code>、<code>interrupt_counter</code>和<code>subgraph_counter</code>字段以闭包的形式返回一个计数器。<code>call_counter</code>计数器用于为当前Superstep内产生的所有任务分配唯一的内部序列号。</p>
<h3 data-id="heading-1">1.1 Resume Value和中断计数器</h3>
<p><code>interrupt_counter</code>、<code>get_null_resume</code>和<code>resume</code>字段与Pregel基于 “中断（Interrupt）/恢复（Resume）” 的执行方式有关。假设Pregel的对应一个需要人工介入的多级审批流程，在每次需要以人工介入的方式收集审批者决定的时候，流程进入一个中断，当前的状态被持久化。当审批决定给出后，流程以 “恢复” 的形式开始执行，中断时持久化的快照被提取出来 “恢复现场” ，审批决定以Resume Value的形式提供给引擎。为了匹配多个中断点与对应的Resume Value，后者会按照顺序被持久化，并在恢复执行的时候连同当前提供的Resume Value一并填充到PregelScratchpad的<code>resume</code>列表中。</p>
<p>恢复执行做不到在中断点出开始执行，它总是<code>从头执行</code>Node的处理函数，所以定义 <code>幂等Node</code> 应该成为Agent编程的 “金科玉律”。由于PregelScratchpad的resume字段会按照中断的顺序存放Resume Value，所以在恢复执行的时候，每遇到一个中断，引擎可以利用<code>interrupt_counter</code>字段返回的计数器作为位置索引从resume列表中将匹配的Resume Value提取出来。如果提取的Resume Value为None，或者计数器返回的索引越界，<code>get_null_resume</code>字段提供的回调就会执行。这个回调函数具有一个bool类型的参数is_called，调用时该参数被设置为True，表示该中断确实被触发了，但没有对应的数据。这会消耗掉这个中断位，确保流程不至于永远得不到恢复。</p>
<h3 data-id="heading-2">1.2 子图调用计数器</h3>
<p>如果说<code>interrupt_counter</code>计数器旨在解决每次中断与提供的Resume Value的匹配问题，那么<code>subgraph_counter</code>计数器解决的每次“子图调用”与对应Pregel实例的匹配问题。如果站在“图”的视角，每个Pregel对象就是由多个Node组成的图，而Pregel也可以作为一个Node出现在另一个Pregel构建的图中，两个Pregel之间就称为了“父子”关系，子Pregel构建的图就是“子图”，针对它的调用就是子图调用。</p>
<p>虽然在同一个图中，每个Pregel会独自完成自身的持久化。在恢复执行场景中，引擎会率先加载作为“根”的Pregel对应的Checkpoint来恢复现场。当遇到“子图”形式调用另一个Pregel时，引擎会加载对应的Checkpoint来恢复子图在中断那个时间点的状态。现在问题来了：在子Pregel众多持久化的Checkpoint中，怎么知道该加载哪一个呢？</p>
<p>这个问题本质上是如何解决作为子图执行的Pregel在执行持久化时，如何将生成的Checkpoint与当前执行上下文进行匹配的问题，这个问题是利用<code>Checkpoint命名空间</code>来解决的。Node是以任务的形式被执行的，每个任务具有唯一的ID，并且在恢复时保持不变，如果命名空间由执行链路上每个任务的<code>节点名称+任务ID</code>组成，那么子图的Checkpoint就能利用此命名空间关联起来。</p>
<p>但是问题还是没有完全解决，如果同一个任务涉及针对<code>同一子图的多次调用</code>，如命名空间只包含基于任务的执行路径，此时两个子图会共享相同的命名空间，具体对应哪个Checkpoint依然无法解决。因此若涉及同一个Node针对同一个Pregel对象的多次调用，持久化这个Pregel的Checkpoint的命名空间还应该包含<code>调用顺序</code>。</p>
<p>Checkpoint的命名空间的规则可以通过如下这个演示实例来证实。如代码片段所示，我们创建了一个由单一Node组成的Pregel对象（sub_graph），命名为 “baz” 的Node在执行的时候会从当前的RunnableConfig配置中提取并输出当前的Checkpoint命名空间。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.pregel <span class="hljs-keyword">import</span> Pregel, NodeBuilder
<span class="hljs-keyword">from</span> langgraph.channels <span class="hljs-keyword">import</span> LastValue
<span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> InMemorySaver
<span class="hljs-keyword">from</span> langgraph.pregel._write <span class="hljs-keyword">import</span> ChannelWrite, ChannelWriteTupleEntry
<span class="hljs-keyword">from</span> langgraph.types <span class="hljs-keyword">import</span> RunnableConfig
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">handle</span>(<span class="hljs-params">args:<span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>,<span class="hljs-type">Any</span>], config:RunnableConfig</span>)-&gt;<span class="hljs-literal">None</span>:
    <span class="hljs-built_in">print</span>(config[<span class="hljs-string">"configurable"</span>][<span class="hljs-string">"checkpoint_ns"</span>])
sub_node = (NodeBuilder()
    .subscribe_to(<span class="hljs-string">"start"</span>)
    .do(handle))
sub_graph = Pregel(
    nodes={<span class="hljs-string">"baz"</span>: sub_node},
    channels={
        <span class="hljs-string">"start"</span>: LastValue(<span class="hljs-literal">None</span>),
    },
    input_channels=[<span class="hljs-string">"start"</span>],
    output_channels=[])

<span class="hljs-keyword">def</span> <span class="hljs-title function_">handle1</span>(<span class="hljs-params">args:<span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>,<span class="hljs-type">Any</span>]</span>)-&gt;<span class="hljs-literal">None</span>:
    sub_graph.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"start"</span>: <span class="hljs-literal">None</span>})

<span class="hljs-keyword">def</span> <span class="hljs-title function_">handle2</span>(<span class="hljs-params">args:<span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>,<span class="hljs-type">Any</span>]</span>)-&gt;<span class="hljs-built_in">str</span>:    
    sub_graph.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"start"</span>: <span class="hljs-literal">None</span>})    
    sub_graph.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"start"</span>: <span class="hljs-literal">None</span>})

foo = (NodeBuilder()
    .subscribe_to(<span class="hljs-string">"foo"</span>)
    .do(handle1)
    .write_to(bar=<span class="hljs-literal">None</span>))
bar = (NodeBuilder()
    .subscribe_to(<span class="hljs-string">"bar"</span>)
    .do(handle2))

graph = Pregel(
    nodes={<span class="hljs-string">"foo"</span>: foo, <span class="hljs-string">"bar"</span>: bar},
    channels={
        <span class="hljs-string">"foo"</span>: LastValue(<span class="hljs-literal">None</span>),
        <span class="hljs-string">"bar"</span>: LastValue(<span class="hljs-built_in">str</span>),
    },
    input_channels=[<span class="hljs-string">"foo"</span>],
    output_channels=[],
    checkpointer= InMemorySaver())

config = {<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"123"</span>}}
graph.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"foo"</span>: <span class="hljs-literal">None</span>}, config=config)
</code></pre>
<p>在另一个Pregel中，我们为它设置了两个先后执行的Node（foo和bar），前者调用sub_graph一次，后者调用两次。针对三次调用，sub_graph为自身持久化设置的Checkpoint命名会以如下的形式输出，可以看出命名空间同时体现了调用链路和次序。</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">foo:36817c76-c3f7-643f-7924-0d29b39f469a|baz:311cc911-96a0-56b6-225b-28e4cece7cd9</span>
<span class="hljs-section">bar:97be6a71-1b71-7364-e691-a122cfef1a92|baz:789287de-869f-42b8-dd03-7518820daaa6</span>
<span class="hljs-section">bar:97be6a71-1b71-7364-e691-a122cfef1a92|1|baz:dd1ddd1b-fc62-b46a-c2ec-6a1d8344b793</span>
</code></pre>
<p>基于Pregel“中断/恢复”的执行方式，让我们对<code>Pregel实例</code>会有特别的理解。我们习惯了将一个通过调用某个类构造函数创建的对象视为该类型的一个实例，但是在Node的处理函数中，即使针对<code>同一Pregel实例</code>的连续两次调用都有可能出现中断，一旦恢复执行，后一个实例就有可能使根据另一个Checkpoint的状态创建的，它自然也就不是原来的那个实例了。在不断的“中断/恢复”执行流程中，所谓<code>Pregel实例</code>有时候表示成<code>对应的Checkpoint</code>可能更准确。</p>
<p>对于同一个节点任务来说，如果涉及针对同一个<code>子Pregel</code>的多次调用，从第二次调用开始，对方持久化生成的Checkpoint会将<code>调用次序</code>包含在命名空间中。与之相对的，在恢复执行的时候，也需要根据当前的执行上下文提供包含此序号的命名空间采用加载对应的Checkpoint，并最终恢复对应的Pregel对象，PregelScratchpad的subgraph_counter字段返回的计数器就是为了提供这个序号。</p>
<h2 data-id="heading-3">2. 两个原生的ManagedValue</h2>
<p>由于ManagedValue所能提供的值是根据PregelScratchpad计算生成，而后者可用的唯有表示当前和最大Superstep序号的<code>step</code>和<code>stop</code>字段，所以我们采用ManagedValue的应用场景其实很窄。我从只找到如下两个原生的ManagedValue类型，它们都定义在langgraph.managed.is_last_step这个包中。其中一个<code>IsLastStepManager</code>用于判断是否为最后一个Superstep，而<code>RemainingStepsManager</code>则用来确定余下的Superstep数。具体的实现非常简单，仅仅是针对PregelScratchpad的<code>step</code>和<code>stop</code>字段的简单运算而已。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">IsLastStepManager</span>(ManagedValue[<span class="hljs-built_in">bool</span>]):
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">scratchpad: PregelScratchpad</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-keyword">return</span> scratchpad.step == scratchpad.stop - <span class="hljs-number">1</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RemainingStepsManager</span>(ManagedValue[<span class="hljs-built_in">int</span>]):
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">scratchpad: PregelScratchpad</span>) -&gt; <span class="hljs-built_in">int</span>:
        <span class="hljs-keyword">return</span> scratchpad.stop - scratchpad.step
</code></pre>
<p>由于ManagedValue属于一个<code>计算属性</code>，所以它只能作为Node的输入。它可以被视为一种虚拟的Channel，Node针对ManagedValue和常规Channel的读取方式完全一致。在创建Pregel对象时，所用到的ManagedValue需要在<code>channels</code>字段中显式声明，但是不能将其添加到输入和输出Channel列表中。</p>
<p>如下的实例演示了RemainingStepsManager的使用方式，创建的Pregel由两个先后执行的Node构成（foo和bar），它们会将命名为<code>remaining_steps</code>的ManagedValue作为输入，并将其分别输出到<code>remaining_steps_after_foo</code>和<code>remaining_steps_after_bar</code>这两个Channel中，分别表示在这两个Node完成执行后所剩的Superstep数。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.pregel <span class="hljs-keyword">import</span> Pregel, NodeBuilder
<span class="hljs-keyword">from</span> langgraph.managed.is_last_step <span class="hljs-keyword">import</span> RemainingStepsManager
<span class="hljs-keyword">from</span> langgraph.channels <span class="hljs-keyword">import</span> LastValue

foo = (NodeBuilder()
       .subscribe_to(<span class="hljs-string">"foo"</span>)
       .read_from(<span class="hljs-string">"remaining_steps"</span>)
       .do(<span class="hljs-keyword">lambda</span> args: args[<span class="hljs-string">"remaining_steps"</span>])
       .write_to(remaining_steps_after_foo= <span class="hljs-keyword">lambda</span> args:args, bar=<span class="hljs-literal">None</span>))

bar = (NodeBuilder()
       .subscribe_to(<span class="hljs-string">"bar"</span>)
       .read_from(<span class="hljs-string">"remaining_steps"</span>)
       .do(<span class="hljs-keyword">lambda</span> args: args[<span class="hljs-string">"remaining_steps"</span>])
       .write_to(<span class="hljs-string">"remaining_steps_after_bar"</span>))

app = Pregel(
    nodes={<span class="hljs-string">"foo"</span>:foo, <span class="hljs-string">"bar"</span>:bar},
    channels={
        <span class="hljs-string">"foo"</span>: LastValue(<span class="hljs-literal">None</span>),
        <span class="hljs-string">"bar"</span>:LastValue(<span class="hljs-literal">None</span>),
        <span class="hljs-string">"remaining_steps_after_foo"</span>: LastValue(<span class="hljs-built_in">int</span>),
        <span class="hljs-string">"remaining_steps_after_bar"</span>:LastValue(<span class="hljs-built_in">int</span>),
        <span class="hljs-string">"remaining_steps"</span>: RemainingStepsManager, 
    },
    input_channels=[<span class="hljs-string">"foo"</span>],
    output_channels=[<span class="hljs-string">"remaining_steps_after_foo"</span>, <span class="hljs-string">"remaining_steps_after_bar"</span>])

config = {<span class="hljs-string">"recursion_limit"</span>: <span class="hljs-number">10</span>}
result = app.invoke({<span class="hljs-string">"foo"</span>:<span class="hljs-literal">None</span>}, config=config)
<span class="hljs-keyword">assert</span> result[<span class="hljs-string">"remaining_steps_after_foo"</span>] == <span class="hljs-number">10</span>
<span class="hljs-keyword">assert</span> result[<span class="hljs-string">"remaining_steps_after_bar"</span>] == <span class="hljs-number">9</span>
</code></pre>
<p>在根据两个Node创建Pregel对象时，我们将针对命名为<code>remaining_steps</code>的ManagedValue的声明添加到channels字段中，对应的类型被设置为RemainingStepsManager。由于在调用Pregel对象时利用RunnableConfig配置将Superstep迭代限制为10，所以先后执行的两个Node后剩余步数分别为10和9。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当我花30分钟让AI占领了我的树莓派]]></title>    <link>https://juejin.cn/post/7603771025855414323</link>    <guid>https://juejin.cn/post/7603771025855414323</guid>    <pubDate>2026-02-08T00:34:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603771025855414323" data-draft-id="7603674653153067017" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当我花30分钟让AI占领了我的树莓派"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-02-08T00:34:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Leoobai"/> <meta itemprop="url" content="https://juejin.cn/user/3748697469623344"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当我花30分钟让AI占领了我的树莓派
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3748697469623344/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Leoobai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T00:34:25.000Z" title="Sun Feb 08 2026 00:34:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">当我花30分钟让AI占领了我的树莓派</h2>
<h3 data-id="heading-1">碳基生命的背叛,或许只是工程师思维的下一次迭代</h3>
<p>周六晚上,我坐在屏幕前,花了30分钟,让一个叫Claude Code的 AI开发工具完成了OpenClaw的配置。当我看到终端里那一串绿色的"✅"时,一种奇妙的感觉涌上心头——我刚刚亲手为"硅基生命"打开了进入我个人设备的大门。</p>
<pre><code class="hljs language-markdown" lang="markdown">🤖 立即开始使用
Telegram Bot 使用
<span class="hljs-bullet">1.</span> 打开 Telegram 搜索 @Leoobai<span class="hljs-emphasis">_Npc_</span>bot
<span class="hljs-bullet">2.</span> 发送任何消息，Bot 会用 Claude AI 回复
<span class="hljs-bullet">3.</span> 401 认证错误已解决，现在可以正常对话！
</code></pre>
<p>看着这段反馈,我愣了一下。怎么说呢,感觉有点像你养了只猫,结果某天发现它学会了开冰箱。AI不再只是云端的对话框,它已经坐在了我的树莓派上,随时准备接管我的工作。</p>
<h3 data-id="heading-2">两条路径:云端的Manus与本地的OpenClaw</h3>
<p>最近AI圈有两个现象级产品同时爆火:一个是Manus,一个是OpenClaw。它们代表了硅基生命渗透人类工作的两种截然不同的路径。</p>
<p><strong>Manus选择了云端虚拟机的方式。</strong></p>
<p>它在云端创建了一个独立的"电脑",当你给它下达任务后,它会像真实的员工一样,在那台看不见的虚拟机里搜索资料、编辑文档、生成报表。你甚至可以关掉自己的电脑去喝咖啡,等回来时,工作已经完成了。</p>
<p>据报道,Manus背后运行着8000万台虚拟机。8000万个数字员工,这个数字让我想起了《宇宙工程师之歌》里的一个观点:硬科幻的核心不是技术本身,而是用工程师的思维模式去构建一个可运转的系统。Manus做的正是这件事——它把"AI助手"变成了一套可以量化和扩展的工程体系。</p>
<p>但Manus有个问题:它在云端,你看不见它在做什么,只能看结果。说白了就是个黑箱,你信它就用,不信也没办法验证。</p>
<p><strong>OpenClaw则选择了占领用户PC的方式。</strong></p>
<p>当我在树莓派上部署OpenClaw时,我清楚地知道:这个AI现在拥有了我设备上的系统级权限。它可以读写文件、运行终端命令、操作浏览器、收发邮件,甚至可以自己编写代码创建新技能。</p>
<p>从技术角度看,OpenClaw其实没什么黑科技。它调用的是Anthropic的Claude API,用的是开源框架,跑在普通设备上。但关键是,它让AI不再只是给你提建议,而是真的能动手干活了——直接在你的设备上执行任务。</p>
<p>更有意思的是,OpenClaw在短短两周内获得了15万+的GitHub星标,成为历史上增长最快的开源项目之一。它的创始人Peter Steinberger是个奥地利程序员,14岁开始编程,第一件事就是偷学校的DOS游戏然后写防拷贝程序去卖钱。现在他一个人,一台电脑,几周时间,就做出了让所有AI巨头感到威胁的产品。</p>
<h3 data-id="heading-3">我的30分钟实验:真就这么简单?</h3>
<p>说回我的树莓派。</p>
<p>其实OpenClaw这个项目我关注很久了,一直想找时间尝试,但总是被各种事情耽搁。这次终于抽出时间,决定亲手部署一下,看看让AI在本地设备上运行到底是什么体验。</p>
<p>整个过程比我想象的简单。我把任务交给Claude Code,它帮我完成了环境配置、依赖安装、Telegram Bot设置、API端点配置......30分钟后,一切就绪。</p>
<p>最让我印象深刻的是这一行:</p>
<pre><code class="hljs language-bash" lang="bash">AI 模型: anthropic/claude-opus-4-6
API 端点: https://code.newcli.com/claude/aws
</code></pre>
<p>AI在配置AI。这个画面本身就充满了某种递归式的诗意。</p>
<p>现在,我可以通过Telegram给我的树莓派发消息,让它帮我处理各种任务。它不是在云端运行,而是就在我家里的这个小盒子里,随时待命。</p>
<h3 data-id="heading-4">这是背叛吗?还是进化?</h3>
<p>"碳基生命的背叛,硅基生命的渗透"——这个标题听起来很悲观,像是在描述某种末日。但我现在的感受更复杂。</p>
<p>我想起《宇宙工程师之歌》里的一段话:工程师的思维模式是什么?是"坚实地放好下面的一块砖,再去放上面一块"。是在材料、能源、环境、经济等多重约束下,把灵感折算成可实施方案。是相信科技是正面力量,问题导向而非悲观渲染。</p>
<p>说白了,Manus和OpenClaw都不是什么背叛,就是工程师干活的方式又升级了一轮。</p>
<p>Manus用云端虚拟机解决了算力分配、任务隔离、可扩展性的问题。它的多智能体架构——规划代理、执行代理、验证代理的协同——本质上就是把复杂工程拆解成可验证的子系统。这不就是工程师每天在做的事吗?</p>
<p>OpenClaw则更进一步。它不仅让AI执行任务,还让AI可以修改自己。如果你让AI从Git仓库运行OpenClaw,它可以读取自己的源代码,重新配置自己,然后重启。要么崩溃,要么获得新能力。你品品,这不就是程序员天天念叨的"持续优化"吗,只不过这次优化自己的不是人了。</p>
<h3 data-id="heading-5">硅基生命的渗透,碳基生命的解放?</h3>
<p>最近有个统计数据让我印象深刻:1985到2005年,美国ATM机从10万台涨到40万台,但银行柜员数量反而增加了10%。因为柜员的工作从处理现金交易,变成了提供金融服务和解决问题。</p>
<p>也许AI对人类工作的替代,也会是类似的故事。</p>
<p>当Manus和OpenClaw这样的工具普及后,人干的活大概会变——更多是想清楚让AI做什么、盯着它别跑偏、以及那些需要拍脑袋做判断的事。</p>
<p>说到底就是分工变了。</p>
<p>我现在可以把重复性的、流程化的工作交给树莓派上的OpenClaw,然后把时间用在真正需要动脑子的事情上。挺好的,不亏。</p>
<h3 data-id="heading-6">给工程师们的一个提醒</h3>
<p>但我也必须说,这种解放是有代价的。</p>
<p>OpenClaw的GitHub页面上有个醒目的警告:"OpenClaw具有系统级权限,请在独立的服务器上部署,避免在生产环境或重要数据的机器上运行。"</p>
<p>已经有安全研究人员发现,有1800多个OpenClaw实例暴露在公网上,API密钥泄露,恶意技能传播......这些都是真实发生的安全事故。</p>
<p>Simon Willison把这称为"致命三合一":强大的能力+开放的架构+缺乏安全意识。</p>
<p>所以,如果你也想尝试OpenClaw或者Manus,请务必:</p>
<ol>
<li>理解你在做什么</li>
<li>控制AI的权限范围</li>
<li>在隔离环境中测试</li>
<li>定期检查日志和行为</li>
</ol>
<p>该谨慎的地方别偷懒,这是基本素养。</p>
<h3 data-id="heading-7">最后</h3>
<p>我的树莓派现在正在安静地运行着。偶尔,我会收到Telegram的消息,那是OpenClaw在向我汇报工作进度。</p>
<p>这种感觉挺微妙的。说是我在用它吧,但它确实也在改变我的工作方式。</p>
<p>碳基生命的背叛?想多了。</p>
<p>硅基生命的渗透?这倒是真的。</p>
<p>不过怎么说呢,从Manus的云端虚拟机,到OpenClaw跑在我家树莓派上,AI这东西越来越像个干活的搭子了。它不会取代你,但你得学会跟它搭伙。</p>
<p>就像《宇宙工程师之歌》里说的,工程师干的事就是用理性和务实把不可能变成可能。现在多了个硅基搭档,活还是那些活,干法不一样了而已。</p>
<hr/>
<p><strong>附:我的OpenClaw配置清单</strong></p>
<ul>
<li>硬件:树莓派(任何型号都可以)</li>
<li>系统:Linux(Ubuntu/Debian)</li>
<li>AI模型:Claude Opus 4.6(通过API调用)</li>
<li>通讯渠道:Telegram</li>
<li>部署时间:30分钟</li>
<li>配置难度:中等(需要基本的命令行知识)</li>
</ul>
<p>如果你也想尝试,记得:理解风险,控制权限,享受过程。</p>
<p><em>P.S. 写这篇文章的时候,我的OpenClaw正在后台帮我整理文件夹。碳基生命还在思考,硅基生命已经在干活了。</em>
<img src="https://fastly.jsdelivr.net/gh/bucketio/img7@main/2026/02/08/1770510636173-5f03022b-a4ae-43c5-9b1e-8b19871ebb6a.jpg" alt="" loading="lazy"/>
我的树莓派不太一样，他是rk3588，一个有16G内存、256G存储和6Tops的算力的power box。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[词法分析(1)：从demo代码中抽象]]></title>    <link>https://juejin.cn/post/7603651011979116586</link>    <guid>https://juejin.cn/post/7603651011979116586</guid>    <pubDate>2026-02-08T00:50:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603651011979116586" data-draft-id="7603643044034592804" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="词法分析(1)：从demo代码中抽象"/> <meta itemprop="keywords" content="编译原理"/> <meta itemprop="datePublished" content="2026-02-08T00:50:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="搞笑僵尸思考时间"/> <meta itemprop="url" content="https://juejin.cn/user/168673917806618"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            词法分析(1)：从demo代码中抽象
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/168673917806618/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    搞笑僵尸思考时间
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T00:50:00.000Z" title="Sun Feb 08 2026 00:50:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​本系列讲义适用于：被强迫学习编译原理前端，或者希望弄明白如何做科研的人</p>
<h2 data-id="heading-0">前言</h2>
<p>词法分析是编译原理对初学者的下马威，是一个马上就开始让人迷惑的章节。“到底学这些什么3型文法概念干嘛的，我不用这些概念不行吗？”类似的疑问想必不绝于耳。因此，本文将从一个极简单的例子出发，逐步提高难度，最终解释清楚为什么特事特办的民科方法没有前途，终究要研究一点理论，才能让自己在遇到同类问题的时候遇神杀神遇佛杀佛。</p>
<p>因此，如果你在快速浏览本文的过程中看到一些和课本上完全不一样的式子，不要害怕，这是还在推导，最后出来的一定是你熟悉的那个正则问题。</p>
<h2 data-id="heading-1">第一式：见微知著，从简单示例开始研究问题</h2>
<p>先来看一个最简单的程序：</p>
<p>int main() { int a = 15 + 2; //This is a comment }</p>
<p>就这么一个简单的程序，它在硬盘里是这样的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/555915c9b0bd410d9d779d248c78e773~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pCe56yR5YO15bC45oCd6ICD5pe26Ze0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771116602&amp;x-signature=hieIQS8Qr6AHiT2tm2rEujYOoZw%3D" alt="" loading="lazy"/><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/>​​<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc650b43f68b4d9eaf2517537f9ae3df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pCe56yR5YO15bC45oCd6ICD5pe26Ze0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771116602&amp;x-signature=Lxf0Kq22fyCwgQcEaTcozXvhnuI%3D" alt="" loading="lazy"/><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/>​<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f5d7de398b440789c4626b6800d50fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pCe56yR5YO15bC45oCd6ICD5pe26Ze0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771116602&amp;x-signature=ENFb9pMCQfvE%2F%2F%2BJpkGIRawDtjk%3D" alt="" loading="lazy"/></p>
<p>可以看到，原本在人眼中像画一样以二维形式铺开的代码，在底层看来只不过就是一串符号。之所以能看到美妙的格式，无非是因为机器知道遇到\r\n之后要从新的一行打印后续符号。</p>
<p>要精确和高效识别这堆什么都有的混合物中每一种成份，你首先应该了解你即将要面对的是什么，才能更好地定义你问题的边界，而不会考虑太多实际上并不会遇到的问题</p>
<p>对于我们的代码而言，首先要做的就是筛选出单词的种类，再分别研究它们的特点，分而治之。</p>
<h2 data-id="heading-2">第二式：分而治之</h2>
<p>通过分类，这个文件中的符号可以整理成以下几类：</p>
<p>1。关键词（保留字）。int。这一类的单词特点是，绝对不会和其他类别的单词重复，他的种类有限，就是一些英文字符串。</p>
<p>2。运算符。+。作用就是参与运算，种类也是极其有限。</p>
<p>3。界限符。{}, (), 空格，;。作用就是让机器在后续分析的时候，知道当前分析的这个语法单元从哪开始到哪结束。他的种类也是极其有限。</p>
<p>4。空白字符，换行。\r\n。对代码几乎完全没影响的符号，可以在识别到之后直接忽略。</p>
<p>5。标识符。main, a。允许用户自定义起名。组成的规则有限制，长度不定，种类也不确定。</p>
<p>6。常量。15, 2。除了数字外，还有可能包含16进制数所附加的a-fx；另外还有一类常量叫字符串，里面是什么符号都可以包含。所以常量和标识符一样，种类和长度也都完全不确定。</p>
<p>7。注释。 //This is a comment。对于注释而言，只要找到他标记的开始和结束，再长也都可以看作一个整体。</p>
<p>对于繁杂的分类，一类一类治理只会浪费精力和时间。所以接下来就需要对它们进行归类，从而降低自己思考的难度并发现共性方法，最终统一处理他们，合而治之。</p>
<p>容易观察到：</p>
<p>对于前四类，由于都是种类与长度也有限，通过简单的字符串匹配就可以识别出来，这一类实现起来没有难度，先不考虑。</p>
<p>对于后三类，则需要通过特定规则进行匹配。那么，这些规则是什么？</p>
<p>a. 标识符：只要第一位不是数字，后面随便你放数字、下划线或者字母。</p>
<p>b. 十进制无符号常数：从前到后全部都是数字。</p>
<p>下面请读者独立完成对应的识别程序。</p>
<p>啪的一声，很快啊，gemini马上就给出了一个样例伪代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">获取 单词的 第一个字符
<span class="hljs-keyword">if</span> 第一个字符 不是 数字:
    <span class="hljs-comment">// 可能是标识符，检查一下后面</span>
    <span class="hljs-keyword">for</span> 第二个到最后一个字符:
		<span class="hljs-keyword">if</span> 这个字符 不是 (字母 or 数字 or 下划线):
		   <span class="hljs-keyword">return</span> <span class="hljs-string">"无效标识符 (含非法字符)"</span>
		<span class="hljs-comment">// if循环检查完毕都没问题</span>
		<span class="hljs-keyword">return</span> <span class="hljs-string">"标识符"</span>
<span class="hljs-keyword">else</span> 
	<span class="hljs-keyword">if</span> 第一个字符 不是 数字:
		<span class="hljs-comment">// 可能是十进制常数，检查一下</span>
		<span class="hljs-keyword">for</span> 单词中的每一个字符:
			<span class="hljs-keyword">if</span> 这个字符 不是 数字:
				<span class="hljs-keyword">return</span> <span class="hljs-string">"无效单词 (数字开头却有非数字)"</span>
		<span class="hljs-comment">// 如果循环检查完毕都没问题</span>
		<span class="hljs-keyword">return</span> <span class="hljs-string">"十进制无符号常数"</span>
	<span class="hljs-keyword">else</span>
		<span class="hljs-keyword">return</span> <span class="hljs-string">"无效标识符 (含非法字符)"</span>
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>Emmmm，很好。看来我们已经可以很好地识别这两类单词了。词法分析也不过如此嘛，那我们继续开始语法分析吧！</p>
<p>老板：稍等一下，那个谁，我这程序里有几类新的常量，规则也给到你了，你帮我也实现一下。</p>
<p>c. 十六进制常数：0x开头的，后面跟着0-9a-f；</p>
<p>d. 带符号整数：比无符号整数可能会多了一个正负号；</p>
<p>你：好的老板，这几个好弄，我马上弄好。</p>
<p>噗嗤噗嗤一阵捣鼓。</p>
<p>你：老板我弄好了。</p>
<p>老板：好的谢谢。那啥，这里又来几类新的，你再处理一下：</p>
<p>e. 带下划线的整数：在整数中间允许下划线存在,但下划线不会出现在最后和最前，以及不会出现连续两个下划线</p>
<p>你：？？？还能这样？</p>
<p>老板：Python早就用上了呀</p>
<p>你：不干了不干了！！！什么鬼，乱加需求，不能一开始就想好吗？？</p>
<p>老板：不好意思，真的不行，需求是不断变化的。那这个工作你是干还是不干？</p>
<p>你：不是老板你这需求加得太离谱了呀，后面来的需求还会和前面的需求打架，我这代码改来改去都成浆糊了呀！！</p>
<p>老板：那有没有可能，有更加简单的代码实现呢？</p>
<p>你：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb6826b0fedb45c58b2d05e8cd2cfa5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pCe56yR5YO15bC45oCd6ICD5pe26Ze0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771116602&amp;x-signature=IdvYjhqmAgkQdTvY7pM6lzk4XMM%3D" alt="" loading="lazy"/><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/>​编辑</p>
<p>曹老板别急着把天聊死。没准拨开迷雾后会有惊喜呢。</p>
<h2 data-id="heading-3">第三式：规范化与抽象</h2>
<p>下面通过逐步的抽象，来让我们逐渐到达事情的本质。</p>
<p>首先要抽象/化简的，就是这些该死的，用自然语言描述的abcde五条规则。他们最大的问题就是都各有各的说法。所以为了找到共同点，首先要让他们用统一的方式进行描述，也即所谓的规范化，算是某种程度上的对齐颗粒度。</p>
<blockquote>
<p>a. 标识符：只要第一位不是数字，后面随便你放数字、下划线或者字母。 b. 十进制无符号常数：从前到后全部都是数字。 c. 十六进制常数：0x开头的，后面跟着0-9a-f； d. 带符号整数：比无符号整数可能会多了一个正负号； e. 带下划线的整数：在整数中间允许下划线存在,但下划线不会出现在最后和最前，以及不会出现连续两个下划线</p>
</blockquote>
<p>可以隐约看出来，一旦前面的符号确定了，那么下一位符号的可选范围也就确定了。</p>
<p>由此，这几条规则都规范化成：当前如果是某个符号，那么它后面可以是什么符号。</p>
<p>但等一下，最开始的时候字符串还没有生成，并没有什么符号。那我们假设句子的最前面有个表示空气的符号ε（音：epsilon，主要是对应于Empty，但直接用E又容易惹误会。有的教材使用λ，意为虚无），最后也有一个文件结束符EOF或特殊符号$作为结束符，这样就可以规范化为：</p>
<blockquote>
<p>a：如果当前符号是ε，那么后面可以是字母或下划线；如果当前符号是字母或下划线或数字，那么后面可以是字母或者下划线或者数字或者结束符； b：如果当前符号是ε，那么后面可以是0-9之一；如果当前符号是0-9之一，那么后面可以是0-9之一或者结束符； c：如果当前符号是ε，那么后面可以是0；如果当前符号是0，后面可以是x；如果当前符号是x，后面可以是0-9a-fA-F之一；如果当前符号是0-9a-fA-F之一，后面可以是0-9a-fA-F之一或者结束符； d：如果当前符号是ε，后面可以是正负号或者0-9；如果当前符号是正负号，后面可以是0-9之一；如果当前符号是0-9之一，后面可以是0-9之一或者结束符； e：如果当前符号是ε，后面可以是0-9之一；如果当前符号是0-9之一，后面可以是0-9之一或者下划线或者结束符；如果当前符号是下划线，后面可以是数字。</p>
</blockquote>
<p>念经一样枯燥无味对吧，但绝对比之前的版本要清晰和无歧义。</p>
<h2 data-id="heading-4">第四式：合而治之</h2>
<p>有了规则之后，我们来想象一台生成这些单词的机器，这台机器会像雪糕机那样不停地屙出来符号，关键在于特定机器屙出来的单词最后一定符合规则。</p>
<p>上面规范化的规则倒是有那么一回事了，但你想要让机器听明白，好像还差那么一点意思。机器只看得懂符号，看不懂自然语言。</p>
<p>聪明的你一定想到了，那我用公式来表示这些规则不就好了么。问题是，你要怎么定义你的公式规则呢？</p>
<p>如果当前符号是x，那么后面可以是y</p>
<p>→if ch==x then y //由于if ch==这样的开头在每条式子里都是一样的，可以省略。</p>
<p>→x-&gt;y //由于x then y还是太麻烦了，把中间的then换成箭头表示跟随</p>
<p>对于x或y有多个选项的场合，用集合来表示，如：</p>
<p>x-&gt;[a-f0-9]</p>
<p>另外还是用希腊字母ε表示开始。那我们就可以把上面的规则a以如下形式展示（其他几个请读者自行转换）：</p>
<p>a：ε-&gt;[a-zA-Z_]；[a-zA-Z_0-9]-&gt;[a-zA-Z_0-9$]；</p>
<p>啊，一身清爽，这下规则也有了，那差不多可以小试一下牛刀了吧？</p>
<blockquote>
<p>f：以a开头，b做结尾，中间要有偶数个c的符号串。 f：ε-&gt;a；a-&gt;[cb]；c-&gt;[bc];b-&gt;$;</p>
</blockquote>
<p>聪明的你估计已经发现问题了，这套表示方法好像无法表示c的奇偶性。他会产生出acb这样的错误单词出来。</p>
<p>所以，规则的左边出了问题：不应该让特定符号出现在左边，因为在不同的场合下，即使是相同符号的后跟符号也存在差异。</p>
<p>那这样吧，我们挨个把这些场合通过字母+下标的方式区分，这样就既知道当前处于哪个小写符号，又知道这是针对哪个特殊场景。这样我们就有：</p>
<p>f：ε-&gt;a；a-&gt;[b]； -&gt;; -&gt;[b]; b-&gt;$;</p>
<p>恭喜你，发明了一种描述单词结构的规则。</p>
<p>先不论这种规则的表示方法符不符合主流写法，我说这种规则无歧义地描述了我想要的单词的结构，应该不会有人有意见。</p>
<h2 data-id="heading-5">第五式：吐槽与迭代</h2>
<p>构建出来是一回事，好不好用又是另一回事。下面开启吐槽大会：</p>
<p>首先，这个下标用起来不方便（用公式编辑器打一个试试），还有一般用不到的莫名其妙的希腊字母ε；（作者注：希腊字母这个属于约定俗成，吐槽你也没办法╮(￣▽￣)╭）</p>
<p>第二，也是最重要的一点，这个规则不方便进行推导。比如，我现在想要知道这个规则集到底能生成哪些单词，你只能编写一个程序，然后从ε出发，然后找出后面是什么符号，之后改变当前符号后，再查一下当前符号对应的规则。最麻烦的是，由于下标的存在，还不能直接根据当前符号来确定使用的哪个规则，还要用一个辅助变量来记录。导致查表的过程非常麻烦。</p>
<p>注意到，这个带下标的符号，实际上代表了两层意思：1. 符号本身；2.这个符号所处的特殊场景。</p>
<p>当处于某个节点，实际上是由2而不是1来决定下一个符号应该是啥。在选定了下一个符号后，那么我们所处的节点将会更新成这个符号所对应的特殊场景（我们称为“状态”）中。</p>
<p>因此，有必要把符号代表的状态和符号本身进行抽离。把具体的象抽离，只剩下纯粹的概念，这就是真正的抽象。</p>
<p>在实际操作中，可以简单地把单纯的一个实义符号，拆解成实际的符号加上它所处的状态名称。如a拆解成aA， 拆解成cC, 拆解成cD。我们并不真的关心到底要处理什么符号，所以式子中的小写字母代表在单词中真实出现的字母；大写字母表示虚拟的、抽象的状态，而不是这个字母本身。</p>
<p>前面提到，对于后面即将产生什么符号，实际上我们可以只关心当前处于什么状态，并不用关心符号本身是什么。所以对于产生式左边的符号而言，可以直接写出当前我们想讨论的状态本身，而不用带上对应的实义符号。</p>
<p>比如，原先的a-&gt;b, 可以写作A-&gt;bB。其中A表示在生成a之后所处的状态，除了A以外还可以用其他自定义符号。B表示在选择了b之后所进入到的新状态。</p>
<p>对于原来类似c-&gt;[a-zA-Z_]的式子，集合中的字母都对应了同一个新状态，因此可以简写为：C-&gt;[a-zA-Z_]B。</p>
<p>对于a-&gt;[b]这样两个符号分别对于不同状态的情况，我们可以对集合进行拆解，得到：A-&gt;cC|bX，中间的竖线表示“或”。你也可以理解为：你现在看到左右两条路被中间的竖线分隔，现在只能挑一条路来走。</p>
<p>最后讨论两个特殊情况：开始和结束。</p>
<p>万事必须要有头，因此我们一般情况下用（Start）的首个字母S表示开始状态，当然也可以指定别的大写字母。</p>
<p>对于结束时刻的状态，由于<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>直接就代表结束，我们不再关心其后的状态，因此</mtext></mrow><annotation encoding="application/x-tex">直接就代表结束，我们不再关心其后的状态，因此</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">直接就代表结束，我们不再关心其后的状态，因此</span></span></span></span></span>后面可以什么都不接，比如上面的A-&gt;bX之后紧跟一条X-&gt;<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>。甚至可以更极端一点，省略那些只会生出</mtext></mrow><annotation encoding="application/x-tex">。甚至可以更极端一点，省略那些只会生出</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">。甚至可以更极端一点，省略那些只会生出</span></span></span></span></span>的状态，比如上面就可以写作A-&gt;b。另外，既然ε表示无，那用ε直接表示结束也是可以的。</p>
<p>由此，可以改写出a的一个新版规则集：</p>
<blockquote>
<p>A-&gt;[a-zA-Z_]B B-&gt;[a-zA-Z_0-9]B | ε；</p>
</blockquote>
<p>换句话说，对于B这个状态后续实际上有两个支线：一种是“后面还能接更多符号”（B-&gt;[a-zA-Z_0-9]B）；另一种是“这个符号就是结尾了”（B-&gt;ε）。</p>
<p>由于这两种情况有共同的左部B，所以可以合并在一起，用“|”分隔，从而让我们在一个规则里同时表达多种可能性。</p>
<p>由此我们终于得到一个相对好用的稳定规则方案。</p>
<p>最终成果：用新范式重写全部规则</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">a</span>（标识符）：<span class="hljs-selector-tag">A</span>-&gt;<span class="hljs-selector-attr">[a-zA-Z_]</span><span class="hljs-selector-tag">B</span> | <span class="hljs-selector-attr">[a-zA-Z_]</span>；<span class="hljs-selector-tag">B</span>-&gt;<span class="hljs-selector-attr">[a-zA-Z_0-9]</span><span class="hljs-selector-tag">B</span> | <span class="hljs-selector-attr">[a-zA-Z_0-9]</span>
<span class="hljs-selector-tag">b</span>（十进制无符号整数）：<span class="hljs-selector-tag">A</span>-&gt;<span class="hljs-selector-attr">[0-9]</span><span class="hljs-selector-tag">A</span> | <span class="hljs-selector-attr">[0-9]</span>
c（十六进制无符号整数）：<span class="hljs-selector-tag">A</span>-&gt;<span class="hljs-number">0</span>B；<span class="hljs-selector-tag">B</span>-&gt;xC; C-&gt;<span class="hljs-selector-attr">[0-9a-fA-F]</span>C | <span class="hljs-selector-attr">[0-9a-fA-F]</span>
d(有符号十进制整数)：S -&gt; +<span class="hljs-selector-tag">A</span> | -<span class="hljs-selector-tag">A</span> | <span class="hljs-selector-tag">A</span>; <span class="hljs-selector-tag">A</span>-&gt;<span class="hljs-selector-attr">[0-9]</span><span class="hljs-selector-tag">A</span> | <span class="hljs-selector-attr">[0-9]</span>
e（带下划线整数）：<span class="hljs-selector-tag">A</span>-&gt;<span class="hljs-selector-attr">[0-9]</span><span class="hljs-selector-tag">B</span>；<span class="hljs-selector-tag">B</span>-&gt;<span class="hljs-selector-attr">[0-9]</span><span class="hljs-selector-tag">B</span> | <span class="hljs-selector-attr">[0-9]</span> | _C; C-&gt;<span class="hljs-selector-attr">[0-9]</span><span class="hljs-selector-tag">B</span> | <span class="hljs-selector-attr">[0-9]</span>
</code></pre>
<p>你定义规则的过程，就是在定义一门新语言的过程。</p>
<p>在后面会看到，还会有其他奇奇怪怪的语法糖去提高这套规则的易用性(包括把中间的[a-z]替换成(a|b|...|z)从而确保正则文法中出现更少的特殊符号，我之所以不在上面提及，一个是这个点不太重要，读者可以自行推导，另一个是我不想引入太多希腊字母等一些约定俗成的东西扰乱读者理解)。但其核心万变不离其宗，就是这一套：从一个状态跳转到另一个状态的规则描述方法。</p>
<h2 data-id="heading-6">小结</h2>
<p>本节从基本问题入手，让读者朋友发现总是特事特办（也称作Ad Hoc方法，拉丁语，意为特例）终究不是个法子，有必要找到要处理问题的共性，从而先提出一个统一的基本模型，之后再进行泛化处理。</p>
<p>实话实说，这一套方法算是我看了答案，知道终点在哪里，再去从零进行推导，难免有作弊的嫌疑，在此先谢罪一个。</p>
<p>但我相信其中的几个关键步骤：从简单问题入手，分而治之，抽象提取共性，合而治之，以及吐槽与迭代，是每个问题都绕不过去的必经之路。</p>
<p>希望本文能对你们有帮助，也欢迎各位多多点赞支持，也欢迎通过各种方法不惜赐教，在此谢过。</p>
<p>下一章将会从这套规则出发，讲清楚如何借助一点点理论，完成我们万法归一的终极目的，用一套方法打遍词法分析无敌手。</p>
<h2 data-id="heading-7">附录：在线算法与离线算法</h2>
<p>在很多教材中，普遍都是先介绍词法分析，再介绍语法分析。</p>
<p>但其实，两者并没有必然的先后顺序。</p>
<p>先进行词法分析再进行语法分析，是希望能从一堆符号中，先把单词token全部识别出来之后，再去对这些单词进行语法分析。</p>
<p>这样的好处就像是流水线，前面把信息过滤了一遍之后，后面的流程就只需要针对提纯后的信息流进行处理，要考虑的杂质要少很多。</p>
<p>这固然是一种很好的方法，但并不是唯一的方法。想想我们自己读一句英文，是一边读单词一边理解这句话，说明语法分析和词法分析是交替/并行进行的。</p>
<p>对于前者，由于得整句话输入完后才能进行词法分析，再进行语法分析。所以这其实是一种离线算法。对于后者，由于可以一边输入一边进行分析，在输入完最后一个单词后几乎马上就可以得出最终的结果（语法树），所以我们把这种方法称为在线算法。</p>
<p>在线算法和离线算法并没有绝对的谁优谁劣，只有是否适用具体的场景。</p>
<p>比如，在一个计算平均值的场景中，如果你采用在线算法，可以只使用两个内存空间，一个用来累加，一个用来记数，从而在接收到用户输入结束信号之后，马上算出来最终结果。但如果你采用离线算法，就需要与数据个数等大的空间去临时存放这些数据，再在最后一次性计算平均值。如果用户是一个一个输入数据，那么不可避免地中间会出现对于电脑而言极大的性能浪费，在线算法一方面能充分利用这些时间，一方面又能节约空间；但如果数据是从文件中一次性读取，程序又是个单线程的话，减少程序的上下文切换的离线算法将会是一种效率更高的算法。</p>
<p>为了行文方便，本系列也将以离线算法的方式介绍，先介法分析，再到语法分析。读者在掌握核心原理后，可自行组装出对应的在线算法。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[词法分析(2)：万法归一的正则文法]]></title>    <link>https://juejin.cn/post/7603651011979132970</link>    <guid>https://juejin.cn/post/7603651011979132970</guid>    <pubDate>2026-02-08T00:53:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603651011979132970" data-draft-id="7603649945978699795" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="词法分析(2)：万法归一的正则文法"/> <meta itemprop="keywords" content="编译原理"/> <meta itemprop="datePublished" content="2026-02-08T00:53:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="搞笑僵尸思考时间"/> <meta itemprop="url" content="https://juejin.cn/user/168673917806618"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            词法分析(2)：万法归一的正则文法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/168673917806618/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    搞笑僵尸思考时间
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T00:53:18.000Z" title="Sun Feb 08 2026 00:53:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p>本文是本人撰写的编译原理讲义，本系列讲义适用于：被强迫学习编译原理前端，或者希望弄明白如何做科研的人。</p>
<p>上一期，经过纯逻辑的推导，我们从简单的实例中总结出了一套描述单词结构的规则。</p>
<p>通过这套规则，我们把标识符和常数(为了方便，下面只讨论十进制无符号整数)这两个看似风马牛不相及的两类单词，用相同的方法描述了出来。</p>
<blockquote>
<p>a（标识符）：A-&gt;[a-zA-Z_]B | [a-zA-Z_]；B-&gt;[a-zA-Z_0-9]B | [a-zA-Z_0-9] b（十进制无符号整数）：C-&gt;[0-9]C | [0-9]</p>
</blockquote>
<p>聪明的你可能会开始吐槽了：<strong>之前不是说一类单词就设计一个处理函数的方法是有问题的，但现在好像依然是一类单词用一套处理方法，那不是一样的吗？不要因为你用了公式化就显得多牛逼一样啊。</strong></p>
<p>好吐槽。如果把一套规则看作是一个函数，那么确实是和之前相比，没有变化。但还记得gemini生成的那段伪代码吗？在一个if中，同时识别了这两类单词。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">获取 单词的 第一个字符
<span class="hljs-keyword">if</span> 第一个字符 不是 数字:
    <span class="hljs-comment">// 可能是标识符，检查一下后面</span>
    <span class="hljs-keyword">for</span> 第二个到最后一个字符:
		<span class="hljs-keyword">if</span> 这个字符 不是 (字母 or 数字 or 下划线):
		   <span class="hljs-keyword">return</span> <span class="hljs-string">"无效标识符 (含非法字符)"</span>
		<span class="hljs-comment">// if循环检查完毕都没问题</span>
		<span class="hljs-keyword">return</span> <span class="hljs-string">"标识符"</span>
<span class="hljs-keyword">else</span> 
	<span class="hljs-keyword">if</span> 第一个字符 不是 数字:
		<span class="hljs-comment">// 可能是十进制常数，检查一下</span>
		<span class="hljs-keyword">for</span> 单词中的每一个字符:
			<span class="hljs-keyword">if</span> 这个字符 不是 数字:
				<span class="hljs-keyword">return</span> <span class="hljs-string">"无效单词 (数字开头却有非数字)"</span>
		<span class="hljs-comment">// 如果循环检查完毕都没问题</span>
		<span class="hljs-keyword">return</span> <span class="hljs-string">"十进制无符号常数"</span>
	<span class="hljs-keyword">else</span>
		<span class="hljs-keyword">return</span> <span class="hljs-string">"无效标识符 (含非法字符)"</span>
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>所以，能否一步到位，用一套规则来同时识别这两类单词呢？</p>
<p>既然我们前面已经把下一步该生成什么符号，和它对应的状态进行了分离，那何不直接再做些更刺激的事：让状态跳转，但是不一定生成对应的符号？</p>
<p>这意味着，我们可以假定在脑海里面临着一个二选一的分岔路口：一边是标识符，一边是常数。既然我们早就在规则用上了“|”来达成分支路径的选择，那何不再和新的想法结合，产生新的火花？</p>
<pre><code class="hljs language-css" lang="css">S-&gt;<span class="hljs-selector-tag">A</span> | C

<span class="hljs-selector-tag">A</span>-&gt;<span class="hljs-selector-attr">[a-zA-Z_]</span><span class="hljs-selector-tag">B</span> | <span class="hljs-selector-attr">[a-zA-Z_]</span>
<span class="hljs-selector-tag">B</span>-&gt;<span class="hljs-selector-attr">[a-zA-Z_0-9]</span><span class="hljs-selector-tag">B</span> | <span class="hljs-selector-attr">[a-zA-Z_0-9]</span> 

C-&gt;<span class="hljs-selector-attr">[0-9]</span>C | <span class="hljs-selector-attr">[0-9]</span>
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>恭喜你，掌握了统一的关键技巧：求同存异。</p>
<p>然后聪明的你可能又会提问：原本一类单词用一类规则来处理，到了结束的时候生成的就是这一类单词，这个好理解；那现在两类单词合并在一起，那结束的时候我怎么知道到底生成的具体是什么东西呢？</p>
<p>仔细看，从第一条规则开始，当你选定了其中一条路，那你就不可能和另外一条路有交集。比如如果选了A，那你就不可能进入C状态。所以，我们可以很确定，在A结束的时候生成的一定是标识符；C结束的时候一定是常数。</p>
<p>那我们可以稍稍修改一下这个规则，在结束的时候进入一个特殊的状态。进入了这个状态后，不生成符号，只返回相应的单词类型。</p>
<pre><code class="hljs language-css" lang="css">S-&gt;<span class="hljs-selector-tag">A</span> | C
<span class="hljs-selector-tag">A</span>-&gt;<span class="hljs-selector-attr">[a-zA-Z_]</span><span class="hljs-selector-tag">B</span> | <span class="hljs-selector-attr">[a-zA-Z_]</span>T；<span class="hljs-selector-tag">B</span>-&gt;<span class="hljs-selector-attr">[a-zA-Z_0-9]</span><span class="hljs-selector-tag">B</span> | <span class="hljs-selector-attr">[a-zA-Z_0-9]</span>T 
C-&gt;<span class="hljs-selector-attr">[0-9]</span>C | <span class="hljs-selector-attr">[0-9]</span>F
T-&gt;{return "标识符"}
F-&gt;{return "常数"}
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>在引入了这种新的特殊状态后，我们实现了在一套规则下返回多类单词的效果。</p>
<p>恭喜你，掌握了做人的关键技巧：有头有尾。</p>
<p>有位喜欢穿别人睡衣的人讲得好：既然要追求刺激，那就要贯彻到底。</p>
<p>对于我们上期总结出来的，在代码中会出现的七类单词的其他五类：运算符，界限符，关键词，不可见字符，注释，可不可以同样用这套规则进行描述呢？</p>
<p>运算符，界限符，关键词，不可见字符都是一些常字符串，他们和十六进制的0x开头是差不多的，所以可以很容易写出来对应的规则。</p>
<p>假定要识别的符号串为abc，那么对应的规则集可以写成：</p>
<p>S-&gt;aA; A-&gt;bB; B-&gt;c;</p>
<p>很繁琐对吗？那或者干脆别一颗一颗拉了，一次拉完：S-&gt;abc;</p>
<p>（对于注释，留给读者自行撰写相关规则集。）</p>
<p>这下，全部的碎片都集齐了，我们得到了一套可以同时识别七类单词的规则。</p>
<p>是时候见识万法归一的威力了：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// S 是“总调度室”，一切从这里开始</span>
S <span class="hljs-punctuation">-&gt;</span> A | C | K
<span class="hljs-comment">// --- 标识符分支 --- </span>
A <span class="hljs-punctuation">-&gt;</span> [a-zA-Z_] B 
B <span class="hljs-punctuation">-&gt;</span> [a-zA-Z_0-<span class="hljs-number">9</span>] B | T_IDENTIFIER
<span class="hljs-comment">// --- 无符号整数分支 --- </span>
C <span class="hljs-punctuation">-&gt;</span> [<span class="hljs-number">0</span>-<span class="hljs-number">9</span>] C'
C' <span class="hljs-punctuation">-&gt;</span> [<span class="hljs-number">0</span>-<span class="hljs-number">9</span>] C' | T_INTEGER
<span class="hljs-comment">// --- 关键字, 还可以再次分支 --- </span>
K <span class="hljs-punctuation">-&gt;</span>  <span class="hljs-keyword">for</span> <span class="hljs-title class_">T_KEYFOR</span> | <span class="hljs-keyword">if</span> T_KEYIF | <span class="hljs-keyword">if</span> B_TEMP |  <span class="hljs-keyword">for</span> <span class="hljs-title class_">B_TEMP</span>....  <span class="hljs-comment">// 如果符号串“if”/“for ”后接了其他符号，如iframe就不是关键字而是标识符</span>
<span class="hljs-comment">// --- 独一无二的“终点站” --- </span>
B_TEMP <span class="hljs-punctuation">-&gt;</span> [a-zA-Z_0-<span class="hljs-number">9</span>] B
T_IDENTIFIER   <span class="hljs-punctuation">-&gt;</span> { <span class="hljs-title function_ invoke__">if</span>(<span class="hljs-title function_ invoke__">CheckNotKeyWord</span>()) <span class="hljs-keyword">return</span> <span class="hljs-string">"标识符"</span>; <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">KeyWord</span>();}  <span class="hljs-comment">//检查已输入的内容，如果不是关键字，则返回"标识符"。如果是，则返回对应的关键字类型。</span>
T_INTEGER      <span class="hljs-punctuation">-&gt;</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">"无符号整数"</span> } 
T_KEYIF   <span class="hljs-punctuation">-&gt;</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">"关键字_IF"</span> }
T_KEYFOR   <span class="hljs-punctuation">-&gt;</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">"关键字_for"</span> }
....
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>现在，如果又要你识别一种新的单词，只需要：</p>
<p>1。用上面这套词法规则描述这类新单词；</p>
<p>2。给它添加一个独特的返回值；</p>
<p>3。在规则集中插入新的规则，对原有的规则几乎可以做到互不相干；或者</p>
<p>4。直接更新原有的规则，比如把常数的规则换成带下划线常数的规则。</p>
<p>再也不用在意大利面条一样的屎山中沉浮了。</p>
<p>恭喜你，从只知道特事特办的牛马程序员，朝着成为一名构筑蓝图的架构师迈出了坚实的一步。</p>
<p>也恭喜你，独立推导出了大名鼎鼎的正则文法。</p>
<p>至此，词法分析程序的大厦已经落成，上面只剩下一朵乌云：如何编码这些规则？</p>
<p>下一期，我们将继续使用名为“抽象”的高射炮，对着这朵乌云狠狠开炮，直到阳光照耀大地。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[反传统学习APP，摒弃固定课程顺序，根据用户做题正确性，学习速度，动态调整课程难度，比如某知识点学不会，自动推荐基础讲解和练习题，学习后再进阶，不搞一刀切。]]></title>    <link>https://juejin.cn/post/7603651011979214890</link>    <guid>https://juejin.cn/post/7603651011979214890</guid>    <pubDate>2026-02-08T01:34:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603651011979214890" data-draft-id="7603643044034707492" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="反传统学习APP，摒弃固定课程顺序，根据用户做题正确性，学习速度，动态调整课程难度，比如某知识点学不会，自动推荐基础讲解和练习题，学习后再进阶，不搞一刀切。"/> <meta itemprop="keywords" content="编程语言,Python"/> <meta itemprop="datePublished" content="2026-02-08T01:34:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="长安牧笛"/> <meta itemprop="url" content="https://juejin.cn/user/186246514621626"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            反传统学习APP，摒弃固定课程顺序，根据用户做题正确性，学习速度，动态调整课程难度，比如某知识点学不会，自动推荐基础讲解和练习题，学习后再进阶，不搞一刀切。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/186246514621626/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    长安牧笛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T01:34:58.000Z" title="Sun Feb 08 2026 01:34:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><ol>
<li>实际应用场景 &amp; 痛点引入</li>
</ol>
<p>场景</p>
<p>传统学习 App 往往采用固定课程顺序，用户必须按部就班地学习，即使某个知识点已经掌握，也要被迫完成所有练习；反之，如果某个知识点没掌握，系统也不会自动回溯到基础讲解，导致学习效率低、挫败感强。</p>
<p>痛点</p>
<ul>
<li>一刀切：所有用户同一套路径，无法个性化。</li>
<li>缺乏动态调整：学不会的知识点没有自动降级讲解。</li>
<li>学习速度差异：快的学生被拖慢，慢的学生跟不上。</li>
<li>缺乏反馈闭环：系统不知道用户真实掌握情况。</li>
</ul>
<ol start="2">
<li>核心逻辑讲解</li>
</ol>
<p>我们设计一个动态自适应学习引擎，核心逻辑如下：</p>
<ol>
<li>
<p>知识点图谱（Knowledge Graph）每个知识点有前置依赖关系，例如：</p>
<ul>
<li>变量 → 条件判断 → 循环 → 函数 → 类与对象</li>
</ul>
</li>
<li>
<p>用户状态跟踪记录每个知识点的正确率、学习速度、尝试次数。</p>
</li>
<li>
<p>动态路径调整</p>
<ul>
<li>如果当前知识点正确率 &lt; 阈值（如 60%），则自动推荐基础讲解 + 基础练习。</li>
<li>如果正确率 &gt; 阈值且学习速度快，则进入进阶知识点。</li>
<li>如果卡住超过一定次数，触发补救机制（回到前置知识点）。</li>
</ul>
</li>
<li>
<p>反馈闭环每次答题后更新用户状态，重新计算最优学习路径。</p>
</li>
<li>
<p>代码模块化实现（Python）</p>
</li>
</ol>
<p>项目结构：</p>
<p>adaptive_learning/
├── main.py                 # 入口
├── knowledge_graph.py      # 知识点图谱
├── user_state.py           # 用户状态管理
├── engine.py               # 动态调度引擎
├── data.py                 # 示例题库
└── README.md</p>
<p>knowledge_graph.py</p>
<h2 data-id="heading-0">知识点图谱</h2>
<p>class KnowledgeGraph:
def <strong>init</strong>(self):
# 知识点依赖关系 {知识点: [前置知识点列表]}
self.graph = {
"变量": [],
"条件判断": ["变量"],
"循环": ["条件判断"],
"函数": ["循环"],
"类与对象": ["函数"]
}</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_prerequisites</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>, topic</span>):
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.graph.get(topic, [])

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_all_topics</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span></span>):
    <span class="hljs-keyword">return</span> list(<span class="hljs-variable language_">self</span>.graph.keys())
</code></pre>
<p>user_state.py</p>
<h2 data-id="heading-1">用户状态管理</h2>
<p>class UserState:
def <strong>init</strong>(self):
# {知识点: {"correct": int, "total": int, "speed": float, "attempts": int}}
self.state = {}</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">record_attempt</span>(<span class="hljs-params">self, topic, correct, speed</span>):
    <span class="hljs-keyword">if</span> topic <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.state:
        self.state[topic] = {<span class="hljs-string">"correct"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"total"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"speed"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"attempts"</span>: <span class="hljs-number">0</span>}
    self.state[topic][<span class="hljs-string">"total"</span>] += <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> correct:
        self.state[topic][<span class="hljs-string">"correct"</span>] += <span class="hljs-number">1</span>
    self.state[topic][<span class="hljs-string">"speed"</span>] = (self.state[topic][<span class="hljs-string">"speed"</span>] * (self.state[topic][<span class="hljs-string">"attempts"</span>]) + speed) / (self.state[topic][<span class="hljs-string">"attempts"</span>] + <span class="hljs-number">1</span>)
    self.state[topic][<span class="hljs-string">"attempts"</span>] += <span class="hljs-number">1</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_accuracy</span>(<span class="hljs-params">self, topic</span>):
    <span class="hljs-keyword">if</span> topic <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.state <span class="hljs-keyword">or</span> self.state[topic][<span class="hljs-string">"total"</span>] == <span class="hljs-number">0</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">return</span> self.state[topic][<span class="hljs-string">"correct"</span>] / self.state[topic][<span class="hljs-string">"total"</span>]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_attempts</span>(<span class="hljs-params">self, topic</span>):
    <span class="hljs-keyword">return</span> self.state.get(topic, {}).get(<span class="hljs-string">"attempts"</span>, <span class="hljs-number">0</span>)
</code></pre>
<p>engine.py</p>
<h2 data-id="heading-2">动态调度引擎</h2>
<p>class AdaptiveEngine:
def <strong>init</strong>(self, knowledge_graph, user_state):
self.kg = knowledge_graph
self.user_state = user_state
self.current_topic = None</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">recommend_next_topic</span>(<span class="hljs-params">self</span>):
    <span class="hljs-comment"># 简单策略：从第一个未掌握的前置知识点开始</span>
    all_topics = self.kg.get_all_topics()
    <span class="hljs-keyword">for</span> topic <span class="hljs-keyword">in</span> all_topics:
        accuracy = self.user_state.get_accuracy(topic)
        attempts = self.user_state.get_attempts(topic)
        <span class="hljs-keyword">if</span> accuracy &lt; <span class="hljs-number">0.6</span> <span class="hljs-keyword">or</span> attempts &lt; <span class="hljs-number">2</span>:  <span class="hljs-comment"># 阈值可调整</span>
            <span class="hljs-comment"># 检查前置知识点是否掌握</span>
            prereqs = self.kg.get_prerequisites(topic)
            <span class="hljs-keyword">for</span> pre <span class="hljs-keyword">in</span> prereqs:
                <span class="hljs-keyword">if</span> self.user_state.get_accuracy(pre) &lt; <span class="hljs-number">0.8</span>:
                    <span class="hljs-keyword">return</span> pre  <span class="hljs-comment"># 先补基础</span>
            <span class="hljs-keyword">return</span> topic
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>  <span class="hljs-comment"># 全部掌握</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">study_step</span>(<span class="hljs-params">self, topic, correct, speed</span>):
    self.user_state.record_attempt(topic, correct, speed)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"学习记录: <span class="hljs-subst">{topic}</span> 正确率=<span class="hljs-subst">{self.user_state.get_accuracy(topic):<span class="hljs-number">.2</span>f}</span>"</span>)
</code></pre>
<p>data.py</p>
<h2 data-id="heading-3">示例题库</h2>
<p>questions = {
"变量": [
{"q": "Python中定义变量的关键字是？", "a": "直接赋值"},
{"q": "变量名可以以数字开头吗？", "a": "不可以"}
],
"条件判断": [
{"q": "if语句的条件表达式结果必须是布尔值吗？", "a": "不一定"}
]
}</p>
<p>main.py</p>
<p>from knowledge_graph import KnowledgeGraph
from user_state import UserState
from engine import AdaptiveEngine
from data import questions</p>
<p>def ask_question(topic):
qlist = questions.get(topic, [])
if not qlist:
print(f"{topic} 暂无题目")
return True, 1.0
import random
q = random.choice(qlist)
ans = input(q["q"] + " ")
correct = (ans.strip() == q["a"])
print("正确!" if correct else "错误!")
return correct, 2.0  # 假设每题耗时2秒</p>
<p>def main():
kg = KnowledgeGraph()
us = UserState()
engine = AdaptiveEngine(kg, us)</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    topic = engine.recommend_next_topic()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> topic:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"恭喜！所有知识点已掌握！"</span>)
        <span class="hljs-keyword">break</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n当前学习主题: <span class="hljs-subst">{topic}</span>"</span>)
    correct, speed = ask_question(topic)
    engine.study_step(topic, correct, speed)
</code></pre>
<p>if <strong>name</strong> == "<strong>main</strong>":
main()</p>
<ol start="4">
<li>README.md</li>
</ol>
<h2 data-id="heading-4">Adaptive Learning System</h2>
<p>一个反传统的动态自适应学习系统，根据用户表现动态调整课程难度。</p>
<h3 data-id="heading-5">功能</h3>
<ul>
<li>知识点图谱管理</li>
<li>用户状态跟踪</li>
<li>动态路径调整</li>
<li>自动推荐基础或进阶内容</li>
</ul>
<h3 data-id="heading-6">安装</h3>
<p>bash</p>
<p>git clone "<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyourname%2Fadaptive_learning.git" target="_blank" title="https://github.com/yourname/adaptive_learning.git" ref="nofollow noopener noreferrer">github.com/yourname/ad…</a>" (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyourname%2Fadaptive_learning.git" target="_blank" title="https://github.com/yourname/adaptive_learning.git" ref="nofollow noopener noreferrer">github.com/yourname/ad…</a>)</p>
<p>cd adaptive_learning</p>
<p>python main.py</p>
<h3 data-id="heading-7">使用</h3>
<p>运行 <code>main.py</code>，根据提示答题，系统会自动调整学习路径。</p>
<ol start="5">
<li>
<p>使用说明</p>
</li>
<li>
<p>运行
"main.py"。</p>
</li>
<li>
<p>系统会推荐当前应学习的知识点。</p>
</li>
<li>
<p>回答题目，系统记录正确率和速度。</p>
</li>
<li>
<p>如果正确率低，系统会推荐前置基础知识点。</p>
</li>
<li>
<p>全部掌握后结束。</p>
</li>
<li>
<p>核心知识点卡片</p>
</li>
</ol>
<p>知识点 描述 应用场景
知识点图谱 用图结构表示知识点依赖关系 学习路径规划
用户状态跟踪 记录正确率、速度、尝试次数 个性化推荐
动态路径调整 根据表现调整学习顺序 避免一刀切
反馈闭环 实时更新用户模型 提高学习效率</p>
<ol start="7">
<li>总结</li>
</ol>
<p>这个系统通过动态自适应算法打破了传统学习 App 的固定模式，让学习路径真正围绕用户的表现展开。</p>
<ul>
<li>创新点：实时反馈 + 个性化路径 + 自动补救机制</li>
<li>技术栈：Python 面向对象 + 数据结构（图、字典）</li>
<li>扩展性：可接入数据库、Web 前端、机器学习模型优化推荐策略</li>
</ul>
<p>如果你愿意，可以画一个知识点图谱的可视化图，并加上简单的 Web 界面，让它更像一个真正的产品。</p>
<p>利用AI解决实际问题，如果你觉得这个工具好用，欢迎关注长安牧笛！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[多模型支持的架构设计：如何集成 10+ AI 模型]]></title>    <link>https://juejin.cn/post/7603673564908634147</link>    <guid>https://juejin.cn/post/7603673564908634147</guid>    <pubDate>2026-02-08T02:47:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603673564908634147" data-draft-id="7603643385816449076" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="多模型支持的架构设计：如何集成 10+ AI 模型"/> <meta itemprop="keywords" content="Java,JavaScript"/> <meta itemprop="datePublished" content="2026-02-08T02:47:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="echoVic"/> <meta itemprop="url" content="https://juejin.cn/user/729731451069998"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            多模型支持的架构设计：如何集成 10+ AI 模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/729731451069998/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    echoVic
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T02:47:25.000Z" title="Sun Feb 08 2026 02:47:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>blade-code 系列第 3 篇。从统一接口到模型切换，从成本优化到降级策略，聊聊怎么构建一个灵活的多模型 AI 系统。</p>
</blockquote>
<h2 data-id="heading-0">为什么要支持多模型？</h2>
<p>构建 AI 应用时，第一个问题往往是："用哪个模型？"</p>
<ul>
<li>OpenAI GPT-5.2？强大但贵</li>
<li>Claude Opus 4.6？代码能力强但有速率限制</li>
<li>DeepSeek V3.2？便宜但稳定性存疑</li>
<li>Gemini 3？长上下文但有配额</li>
</ul>
<p>我的答案是：<strong>全都要</strong>。</p>
<p>blade-code 从第一天就设计为多模型架构，支持 10+ 主流模型的无缝切换。用户可以根据任务类型、成本预算、速率限制灵活选择，甚至运行时动态切换。</p>
<hr/>
<h2 data-id="heading-1">单一模型的问题</h2>
<p>依赖单一模型会遇到这些麻烦：</p>





























<table><thead><tr><th>问题</th><th>影响</th></tr></thead><tbody><tr><td>成本高</td><td>GPT-5.2 pro 输出 $168/M tokens</td></tr><tr><td>速率限制</td><td>Claude 每分钟请求数有限</td></tr><tr><td>服务中断</td><td>OpenAI 宕机时干瞪眼</td></tr><tr><td>能力差异</td><td>不同任务需要不同模型</td></tr><tr><td>地域限制</td><td>某些模型在特定地区不可用</td></tr></tbody></table>
<p>多模型架构能解决这些问题：</p>
<p><strong>成本优化</strong> — 简单任务用便宜模型，复杂任务用强大模型：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 简单任务</span>
<span class="hljs-keyword">const</span> summary = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">generate</span>(<span class="hljs-string">'总结这段文字'</span>, {
  <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-chat'</span> <span class="hljs-comment">// $0.28/M input, $0.42/M output</span>
});

<span class="hljs-comment">// 复杂任务</span>
<span class="hljs-keyword">const</span> architecture = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">generate</span>(<span class="hljs-string">'设计系统架构'</span>, {
  <span class="hljs-attr">model</span>: <span class="hljs-string">'claude-opus-4.6'</span> <span class="hljs-comment">// $5/M input, $25/M output</span>
});
</code></pre>
<p><strong>高可用</strong> — 主模型挂了自动切换：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">generate</span>(prompt, {
  <span class="hljs-attr">model</span>: <span class="hljs-string">'gpt-5.2'</span>,
  <span class="hljs-attr">fallback</span>: [<span class="hljs-string">'claude-sonnet-4.5'</span>, <span class="hljs-string">'deepseek-chat'</span>]
});
</code></pre>
<p><strong>任务匹配</strong> — 不同任务用最合适的模型：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> taskModelMap = {
  <span class="hljs-string">'code-generation'</span>: <span class="hljs-string">'claude-opus-4.6'</span>,
  <span class="hljs-string">'translation'</span>: <span class="hljs-string">'gpt-5-mini'</span>,
  <span class="hljs-string">'reasoning'</span>: <span class="hljs-string">'gpt-5.2-pro'</span>,
  <span class="hljs-string">'chat'</span>: <span class="hljs-string">'deepseek-chat'</span>,
};
</code></pre>
<hr/>
<h2 data-id="heading-2">支持的模型（2026 年 2 月）</h2>
<p>blade-code 目前支持这些模型：</p>





































































































<table><thead><tr><th>提供商</th><th>模型</th><th>特点</th><th>成本 (输入/输出 per M)</th></tr></thead><tbody><tr><td><strong>OpenAI</strong></td><td>gpt-5.2</td><td>旗舰，代码和 Agent 任务</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1.75</mn><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">1.75 / </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">1.75/</span></span></span></span></span>14</td></tr><tr><td/><td>gpt-5.2-pro</td><td>最强推理</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>21</mn><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">21 / </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">21/</span></span></span></span></span>168</td></tr><tr><td/><td>gpt-5-mini</td><td>轻量快速</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.25</mn><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">0.25 / </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0.25/</span></span></span></span></span>2</td></tr><tr><td/><td>gpt-4.1</td><td>可微调</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">3 / </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">3/</span></span></span></span></span>12</td></tr><tr><td/><td>gpt-4.1-mini</td><td>微调轻量版</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.8</mn><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">0.8 / </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0.8/</span></span></span></span></span>3.2</td></tr><tr><td/><td>o4-mini</td><td>推理模型</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">4 / </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">4/</span></span></span></span></span>16</td></tr><tr><td><strong>Anthropic</strong></td><td>claude-opus-4.6</td><td>最强 Agent 和代码</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">5 / </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">5/</span></span></span></span></span>25</td></tr><tr><td/><td>claude-sonnet-4.5</td><td>性价比最佳</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">3 / </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">3/</span></span></span></span></span>15</td></tr><tr><td/><td>claude-haiku-4.5</td><td>快速响应</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">1 / </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">1/</span></span></span></span></span>5</td></tr><tr><td><strong>Google</strong></td><td>gemini-3-pro</td><td>最强推理+多模态</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">2 / </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">2/</span></span></span></span></span>12</td></tr><tr><td/><td>gemini-3-flash</td><td>速度与智能平衡</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.50</mn><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">0.50 / </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0.50/</span></span></span></span></span>3</td></tr><tr><td/><td>gemini-2.5-flash-lite</td><td>高性价比</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.30</mn><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">0.30 / </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0.30/</span></span></span></span></span>2.50</td></tr><tr><td><strong>DeepSeek</strong></td><td>deepseek-chat (V3.2)</td><td>性价比王</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.28</mn><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">0.28 / </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0.28/</span></span></span></span></span>0.42</td></tr><tr><td/><td>deepseek-reasoner (V3.2)</td><td>推理模式</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.28</mn><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">0.28 / </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0.28/</span></span></span></span></span>0.42</td></tr><tr><td><strong>OpenRouter</strong></td><td>聚合多家</td><td>统一接口</td><td>按模型计费</td></tr></tbody></table>
<h3 data-id="heading-3">怎么选？</h3>
<p><strong>代码生成：</strong> <code>claude-opus-4.6</code> 最强，<code>deepseek-chat</code> 最便宜</p>
<p><strong>深度推理：</strong> <code>gpt-5.2-pro</code> 最强，<code>deepseek-reasoner</code> 性价比高</p>
<p><strong>日常对话：</strong> <code>gpt-5-mini</code> 或 <code>deepseek-chat</code>，便宜又快</p>
<p><strong>长文本：</strong> <code>gemini-3-pro</code> 支持超长上下文</p>
<hr/>
<h2 data-id="heading-4">统一接口设计</h2>
<h3 data-id="heading-5">架构概览</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "ModelManager"
        MM[ModelManager]
        MM --&gt; |管理| P1[OpenAI Provider]
        MM --&gt; |管理| P2[Anthropic Provider]
        MM --&gt; |管理| P3[Google Provider]
        MM --&gt; |管理| P4[DeepSeek Provider]
    end
    
    subgraph "统一接口"
        PI[Provider Interface]
        PI --&gt; |generate| GEN[生成响应]
        PI --&gt; |stream| STR[流式响应]
        PI --&gt; |isAvailable| CHK[检查可用性]
        PI --&gt; |getModelInfo| INFO[获取模型信息]
    end
    
    P1 -.-&gt; |实现| PI
    P2 -.-&gt; |实现| PI
    P3 -.-&gt; |实现| PI
    P4 -.-&gt; |实现| PI
    
    style MM fill:#4A90D9,color:#fff
    style PI fill:#50C878,color:#fff
</code></pre>
<p>所有模型提供商都实现统一的 <code>Provider</code> 接口：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Provider</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">models</span>: <span class="hljs-built_in">string</span>[];
  
  <span class="hljs-title function_">generate</span>(<span class="hljs-attr">request</span>: <span class="hljs-title class_">GenerateRequest</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">GenerateResponse</span>&gt;;
  <span class="hljs-title function_">stream</span>(<span class="hljs-attr">request</span>: <span class="hljs-title class_">GenerateRequest</span>): <span class="hljs-title class_">AsyncIterable</span>&lt;<span class="hljs-title class_">StreamChunk</span>&gt;;
  <span class="hljs-title function_">isAvailable</span>(<span class="hljs-attr">model</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt;;
  <span class="hljs-title function_">getModelInfo</span>(<span class="hljs-attr">model</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">ModelInfo</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">GenerateRequest</span> {
  <span class="hljs-attr">model</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">messages</span>: <span class="hljs-title class_">Message</span>[];
  temperature?: <span class="hljs-built_in">number</span>;
  maxTokens?: <span class="hljs-built_in">number</span>;
  tools?: <span class="hljs-title class_">Tool</span>[];
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">GenerateResponse</span> {
  <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">usage</span>: {
    <span class="hljs-attr">promptTokens</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">completionTokens</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">totalTokens</span>: <span class="hljs-built_in">number</span>;
  };
  <span class="hljs-attr">finishReason</span>: <span class="hljs-string">'stop'</span> | <span class="hljs-string">'length'</span> | <span class="hljs-string">'tool_calls'</span>;
  toolCalls?: <span class="hljs-title class_">ToolCall</span>[];
}
</code></pre>
<h3 data-id="heading-6">OpenAI Provider 实现</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">OpenAIProvider</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Provider</span> {
  name = <span class="hljs-string">'openai'</span>;
  models = [<span class="hljs-string">'gpt-5.2'</span>, <span class="hljs-string">'gpt-5.2-pro'</span>, <span class="hljs-string">'gpt-5-mini'</span>, <span class="hljs-string">'gpt-4.1'</span>, <span class="hljs-string">'o4-mini'</span>];
  
  <span class="hljs-keyword">private</span> <span class="hljs-attr">client</span>: <span class="hljs-title class_">OpenAI</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">apiKey: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenAI</span>({ apiKey });
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">generate</span>(<span class="hljs-attr">request</span>: <span class="hljs-title class_">GenerateRequest</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">GenerateResponse</span>&gt; {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span>.<span class="hljs-property">chat</span>.<span class="hljs-property">completions</span>.<span class="hljs-title function_">create</span>({
      <span class="hljs-attr">model</span>: request.<span class="hljs-property">model</span>,
      <span class="hljs-attr">messages</span>: request.<span class="hljs-property">messages</span>,
      <span class="hljs-attr">temperature</span>: request.<span class="hljs-property">temperature</span>,
      <span class="hljs-attr">max_tokens</span>: request.<span class="hljs-property">maxTokens</span>,
      <span class="hljs-attr">tools</span>: request.<span class="hljs-property">tools</span>,
    });

    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">content</span>: response.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>.<span class="hljs-property">content</span> || <span class="hljs-string">''</span>,
      <span class="hljs-attr">usage</span>: {
        <span class="hljs-attr">promptTokens</span>: response.<span class="hljs-property">usage</span>?.<span class="hljs-property">prompt_tokens</span> || <span class="hljs-number">0</span>,
        <span class="hljs-attr">completionTokens</span>: response.<span class="hljs-property">usage</span>?.<span class="hljs-property">completion_tokens</span> || <span class="hljs-number">0</span>,
        <span class="hljs-attr">totalTokens</span>: response.<span class="hljs-property">usage</span>?.<span class="hljs-property">total_tokens</span> || <span class="hljs-number">0</span>,
      },
      <span class="hljs-attr">finishReason</span>: response.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">finish_reason</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>,
      <span class="hljs-attr">toolCalls</span>: response.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>.<span class="hljs-property">tool_calls</span>,
    };
  }

  <span class="hljs-keyword">async</span> *<span class="hljs-title function_">stream</span>(<span class="hljs-attr">request</span>: <span class="hljs-title class_">GenerateRequest</span>): <span class="hljs-title class_">AsyncIterable</span>&lt;<span class="hljs-title class_">StreamChunk</span>&gt; {
    <span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span>.<span class="hljs-property">chat</span>.<span class="hljs-property">completions</span>.<span class="hljs-title function_">create</span>({
      <span class="hljs-attr">model</span>: request.<span class="hljs-property">model</span>,
      <span class="hljs-attr">messages</span>: request.<span class="hljs-property">messages</span>,
      <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span>,
    });

    <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> stream) {
      <span class="hljs-keyword">const</span> delta = chunk.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>]?.<span class="hljs-property">delta</span>;
      <span class="hljs-keyword">if</span> (delta?.<span class="hljs-property">content</span>) {
        <span class="hljs-keyword">yield</span> { <span class="hljs-attr">type</span>: <span class="hljs-string">'content'</span>, <span class="hljs-attr">content</span>: delta.<span class="hljs-property">content</span> };
      }
      <span class="hljs-keyword">if</span> (delta?.<span class="hljs-property">tool_calls</span>) {
        <span class="hljs-keyword">yield</span> { <span class="hljs-attr">type</span>: <span class="hljs-string">'tool_calls'</span>, <span class="hljs-attr">toolCalls</span>: delta.<span class="hljs-property">tool_calls</span> };
      }
    }
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">isAvailable</span>(<span class="hljs-attr">model</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span>.<span class="hljs-property">models</span>.<span class="hljs-title function_">retrieve</span>(model);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">catch</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-title function_">getModelInfo</span>(<span class="hljs-attr">model</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">ModelInfo</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">infoMap</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">ModelInfo</span>&gt; = {
      <span class="hljs-string">'gpt-5.2'</span>: {
        <span class="hljs-attr">contextWindow</span>: <span class="hljs-number">256000</span>,
        <span class="hljs-attr">maxOutputTokens</span>: <span class="hljs-number">32768</span>,
        <span class="hljs-attr">costPer1MTokens</span>: { <span class="hljs-attr">input</span>: <span class="hljs-number">1.75</span>, <span class="hljs-attr">output</span>: <span class="hljs-number">14</span> },
        <span class="hljs-attr">capabilities</span>: [<span class="hljs-string">'text'</span>, <span class="hljs-string">'vision'</span>, <span class="hljs-string">'tools'</span>, <span class="hljs-string">'agents'</span>],
      },
      <span class="hljs-string">'gpt-5-mini'</span>: {
        <span class="hljs-attr">contextWindow</span>: <span class="hljs-number">128000</span>,
        <span class="hljs-attr">maxOutputTokens</span>: <span class="hljs-number">16384</span>,
        <span class="hljs-attr">costPer1MTokens</span>: { <span class="hljs-attr">input</span>: <span class="hljs-number">0.25</span>, <span class="hljs-attr">output</span>: <span class="hljs-number">2</span> },
        <span class="hljs-attr">capabilities</span>: [<span class="hljs-string">'text'</span>, <span class="hljs-string">'vision'</span>, <span class="hljs-string">'tools'</span>],
      },
    };
    <span class="hljs-keyword">return</span> infoMap[model];
  }
}
</code></pre>
<h3 data-id="heading-7">Anthropic Provider 实现</h3>
<p>Anthropic 的消息格式和 OpenAI 不同，需要做转换：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AnthropicProvider</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Provider</span> {
  name = <span class="hljs-string">'anthropic'</span>;
  models = [
    <span class="hljs-string">'claude-opus-4.6'</span>,
    <span class="hljs-string">'claude-sonnet-4.5'</span>,
    <span class="hljs-string">'claude-haiku-4.5'</span>,
  ];
  
  <span class="hljs-keyword">private</span> <span class="hljs-attr">client</span>: <span class="hljs-title class_">Anthropic</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">apiKey: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Anthropic</span>({ apiKey });
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">generate</span>(<span class="hljs-attr">request</span>: <span class="hljs-title class_">GenerateRequest</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">GenerateResponse</span>&gt; {
    <span class="hljs-comment">// 转换消息格式：OpenAI -&gt; Anthropic</span>
    <span class="hljs-keyword">const</span> { system, messages } = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertMessages</span>(request.<span class="hljs-property">messages</span>);

    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span>.<span class="hljs-property">messages</span>.<span class="hljs-title function_">create</span>({
      <span class="hljs-attr">model</span>: request.<span class="hljs-property">model</span>,
      system,
      messages,
      <span class="hljs-attr">max_tokens</span>: request.<span class="hljs-property">maxTokens</span> || <span class="hljs-number">8192</span>,
      <span class="hljs-attr">temperature</span>: request.<span class="hljs-property">temperature</span>,
      <span class="hljs-attr">tools</span>: request.<span class="hljs-property">tools</span>,
    });

    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">content</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extractContent</span>(response.<span class="hljs-property">content</span>),
      <span class="hljs-attr">usage</span>: {
        <span class="hljs-attr">promptTokens</span>: response.<span class="hljs-property">usage</span>.<span class="hljs-property">input_tokens</span>,
        <span class="hljs-attr">completionTokens</span>: response.<span class="hljs-property">usage</span>.<span class="hljs-property">output_tokens</span>,
        <span class="hljs-attr">totalTokens</span>: response.<span class="hljs-property">usage</span>.<span class="hljs-property">input_tokens</span> + response.<span class="hljs-property">usage</span>.<span class="hljs-property">output_tokens</span>,
      },
      <span class="hljs-attr">finishReason</span>: response.<span class="hljs-property">stop_reason</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>,
      <span class="hljs-attr">toolCalls</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extractToolCalls</span>(response.<span class="hljs-property">content</span>),
    };
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">convertMessages</span>(<span class="hljs-attr">messages</span>: <span class="hljs-title class_">Message</span>[]): {
    <span class="hljs-attr">system</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">messages</span>: <span class="hljs-title class_">Anthropic</span>.<span class="hljs-property">MessageParam</span>[];
  } {
    <span class="hljs-comment">// 提取 system 消息</span>
    <span class="hljs-keyword">const</span> systemMessages = messages.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.<span class="hljs-property">role</span> === <span class="hljs-string">'system'</span>);
    <span class="hljs-keyword">const</span> system = systemMessages.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.<span class="hljs-property">content</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">'\n\n'</span>);

    <span class="hljs-comment">// 转换其他消息</span>
    <span class="hljs-keyword">const</span> anthropicMessages = messages
      .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.<span class="hljs-property">role</span> !== <span class="hljs-string">'system'</span>)
      .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> ({
        <span class="hljs-attr">role</span>: m.<span class="hljs-property">role</span> <span class="hljs-keyword">as</span> <span class="hljs-string">'user'</span> | <span class="hljs-string">'assistant'</span>,
        <span class="hljs-attr">content</span>: m.<span class="hljs-property">content</span>,
      }));

    <span class="hljs-keyword">return</span> { system, <span class="hljs-attr">messages</span>: anthropicMessages };
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-8">模型切换与降级</h2>
<h3 data-id="heading-9">运行时切换</h3>
<p>用户可以随时切换模型：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelManager</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">currentModel</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">providers</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Provider</span>&gt;;

  <span class="hljs-title function_">switchModel</span>(<span class="hljs-attr">model</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">const</span> provider = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getProviderForModel</span>(model);
    <span class="hljs-keyword">if</span> (!provider) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Model <span class="hljs-subst">${model}</span> not supported`</span>);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentModel</span> = model;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Switched to model: <span class="hljs-subst">${model}</span>`</span>);
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">getProviderForModel</span>(<span class="hljs-attr">model</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Provider</span> | <span class="hljs-literal">undefined</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> provider <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">providers</span>.<span class="hljs-title function_">values</span>()) {
      <span class="hljs-keyword">if</span> (provider.<span class="hljs-property">models</span>.<span class="hljs-title function_">includes</span>(model)) {
        <span class="hljs-keyword">return</span> provider;
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
  }
}
</code></pre>
<p>CLI 使用：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动时指定</span>
blade --model=claude-opus-4.6 <span class="hljs-string">"优化代码"</span>

<span class="hljs-comment"># 运行时切换</span>
&gt; /model gpt-5.2
✅ Switched to gpt-5.2

&gt; /model deepseek-chat
✅ Switched to deepseek-chat
</code></pre>
<h3 data-id="heading-10">自动降级</h3>
<p>主模型失败时，自动尝试备用模型：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[开始请求] --&gt; B[尝试主模型]
    B --&gt; C{成功?}
    C --&gt;|是| D[返回结果]
    C --&gt;|否| E{可重试错误?}
    E --&gt;|否| F[抛出错误]
    E --&gt;|是| G{还有备用模型?}
    G --&gt;|否| F
    G --&gt;|是| H[切换到下一个模型]
    H --&gt; B
    
    style D fill:#90EE90
    style F fill:#FFB6C6
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelManager</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">generateWithFallback</span>(
    <span class="hljs-attr">prompt</span>: <span class="hljs-built_in">string</span>,
    <span class="hljs-attr">options</span>: <span class="hljs-title class_">GenerateOptions</span>
  ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">GenerateResponse</span>&gt; {
    <span class="hljs-keyword">const</span> models = [
      options.<span class="hljs-property">model</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentModel</span>,
      ...(options.<span class="hljs-property">fallback</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultFallbackChain</span>),
    ];

    <span class="hljs-keyword">let</span> <span class="hljs-attr">lastError</span>: <span class="hljs-title class_">Error</span> | <span class="hljs-literal">undefined</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> model <span class="hljs-keyword">of</span> models) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Trying model: <span class="hljs-subst">${model}</span>`</span>);
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generate</span>(prompt, { ...options, model });
        <span class="hljs-keyword">return</span> response;
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`Model <span class="hljs-subst">${model}</span> failed:`</span>, error);
        lastError = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>;
        
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">shouldRetry</span>(error)) {
          <span class="hljs-keyword">throw</span> error;
        }
      }
    }

    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`All models failed. Last error: <span class="hljs-subst">${lastError?.message}</span>`</span>);
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">shouldRetry</span>(<span class="hljs-attr">error</span>: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-comment">// 速率限制、服务不可用：重试</span>
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">status</span> === <span class="hljs-number">429</span> || error.<span class="hljs-property">status</span> === <span class="hljs-number">503</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// 认证失败、无效请求：不重试</span>
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">status</span> === <span class="hljs-number">401</span> || error.<span class="hljs-property">status</span> === <span class="hljs-number">400</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
}
</code></pre>
<p>配置降级链：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> config = {
  <span class="hljs-attr">defaultModel</span>: <span class="hljs-string">'claude-opus-4.6'</span>,
  <span class="hljs-attr">fallbackChain</span>: [
    <span class="hljs-string">'gpt-5.2'</span>,
    <span class="hljs-string">'deepseek-chat'</span>,
    <span class="hljs-string">'gemini-3-flash'</span>,
  ],
};
</code></pre>
<h3 data-id="heading-11">智能路由</h3>
<p>根据任务类型自动选择模型：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[用户输入] --&gt; B{检测任务类型}
    B --&gt;|代码生成| C[claude-opus-4.6]
    B --&gt;|翻译| D[gpt-5-mini]
    B --&gt;|推理| E[gpt-5.2-pro]
    B --&gt;|日常对话| F[deepseek-chat]
    
    style C fill:#E8D5B7
    style D fill:#B7D5E8
    style E fill:#D5B7E8
    style F fill:#B7E8D5
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelRouter</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">taskModelMap</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = {
    <span class="hljs-string">'code-generation'</span>: <span class="hljs-string">'claude-opus-4.6'</span>,
    <span class="hljs-string">'code-review'</span>: <span class="hljs-string">'claude-opus-4.6'</span>,
    <span class="hljs-string">'translation'</span>: <span class="hljs-string">'gpt-5-mini'</span>,
    <span class="hljs-string">'reasoning'</span>: <span class="hljs-string">'gpt-5.2-pro'</span>,
    <span class="hljs-string">'chat'</span>: <span class="hljs-string">'deepseek-chat'</span>,
    <span class="hljs-string">'summarization'</span>: <span class="hljs-string">'gpt-5-mini'</span>,
  };

  <span class="hljs-title function_">selectModel</span>(<span class="hljs-attr">task</span>: <span class="hljs-built_in">string</span>, userPreference?: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">if</span> (userPreference) <span class="hljs-keyword">return</span> userPreference;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskModelMap</span>[task] || <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultModel</span>;
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">detectTaskType</span>(<span class="hljs-attr">prompt</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
    <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/写代码|生成代码|implement|create function/i</span>.<span class="hljs-title function_">test</span>(prompt)) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'code-generation'</span>;
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/审查|review|check code/i</span>.<span class="hljs-title function_">test</span>(prompt)) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'code-review'</span>;
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/翻译|translate/i</span>.<span class="hljs-title function_">test</span>(prompt)) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'translation'</span>;
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/推理|分析|reasoning|analyze/i</span>.<span class="hljs-title function_">test</span>(prompt)) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'reasoning'</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">'chat'</span>;
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-12">成本优化</h2>
<h3 data-id="heading-13">成本追踪</h3>
<p>实时追踪每次请求的成本：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CostTracker</span> {
  <span class="hljs-keyword">private</span> totalCost = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">costByModel</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

  <span class="hljs-title function_">trackUsage</span>(<span class="hljs-attr">model</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">usage</span>: <span class="hljs-title class_">Usage</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">const</span> modelInfo = <span class="hljs-variable language_">this</span>.<span class="hljs-property">modelManager</span>.<span class="hljs-title function_">getModelInfo</span>(model);
    <span class="hljs-keyword">const</span> cost = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateCost</span>(usage, modelInfo);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">totalCost</span> += cost;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">costByModel</span>.<span class="hljs-title function_">set</span>(
      model,
      (<span class="hljs-variable language_">this</span>.<span class="hljs-property">costByModel</span>.<span class="hljs-title function_">get</span>(model) || <span class="hljs-number">0</span>) + cost
    );

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Cost: $<span class="hljs-subst">${cost.toFixed(<span class="hljs-number">4</span>)}</span> (Total: $<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.totalCost.toFixed(<span class="hljs-number">4</span>)}</span>)`</span>);
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">calculateCost</span>(<span class="hljs-attr">usage</span>: <span class="hljs-title class_">Usage</span>, <span class="hljs-attr">modelInfo</span>: <span class="hljs-title class_">ModelInfo</span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">const</span> inputCost = (usage.<span class="hljs-property">promptTokens</span> / <span class="hljs-number">1_000_000</span>) * modelInfo.<span class="hljs-property">costPer1MTokens</span>.<span class="hljs-property">input</span>;
    <span class="hljs-keyword">const</span> outputCost = (usage.<span class="hljs-property">completionTokens</span> / <span class="hljs-number">1_000_000</span>) * modelInfo.<span class="hljs-property">costPer1MTokens</span>.<span class="hljs-property">output</span>;
    <span class="hljs-keyword">return</span> inputCost + outputCost;
  }

  <span class="hljs-title function_">getReport</span>(): <span class="hljs-title class_">CostReport</span> {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">totalCost</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">totalCost</span>,
      <span class="hljs-attr">costByModel</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">costByModel</span>),
      <span class="hljs-attr">averageCostPerRequest</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">totalCost</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestCount</span>,
    };
  }
}
</code></pre>
<p>输出示例：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">💰</span> <span class="hljs-attr">Cost Report:</span>
  <span class="hljs-attr">Total:</span> <span class="hljs-string">$1.85</span>
  <span class="hljs-attr">By Model:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">claude-opus-4.6:</span> <span class="hljs-string">$1.20</span> <span class="hljs-string">(65%)</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">gpt-5-mini:</span> <span class="hljs-string">$0.35</span> <span class="hljs-string">(19%)</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">deepseek-chat:</span> <span class="hljs-string">$0.30</span> <span class="hljs-string">(16%)</span>
  <span class="hljs-attr">Average per request:</span> <span class="hljs-string">$0.09</span>
</code></pre>
<h3 data-id="heading-14">预算控制</h3>
<p>设置每日/每月预算上限：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BudgetController</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">dailyLimit</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">monthlyLimit</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-keyword">private</span> dailySpent = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">private</span> monthlySpent = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">checkBudget</span>(<span class="hljs-attr">estimatedCost</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">dailySpent</span> + estimatedCost &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">dailyLimit</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Daily budget exceeded: $<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.dailyLimit}</span>`</span>);
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">monthlySpent</span> + estimatedCost &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">monthlyLimit</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Monthly budget exceeded: $<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.monthlyLimit}</span>`</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }

  <span class="hljs-title function_">recordSpending</span>(<span class="hljs-attr">cost</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dailySpent</span> += cost;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">monthlySpent</span> += cost;
  }
}
</code></pre>
<h3 data-id="heading-15">省钱技巧</h3>
<p><strong>1. 简单任务用便宜模型</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 浪费</span>
<span class="hljs-keyword">const</span> summary = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">generate</span>(<span class="hljs-string">'总结这段文字'</span>, {
  <span class="hljs-attr">model</span>: <span class="hljs-string">'gpt-5.2'</span> <span class="hljs-comment">// $1.75/M input</span>
});

<span class="hljs-comment">// ✅ 省钱</span>
<span class="hljs-keyword">const</span> summary = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">generate</span>(<span class="hljs-string">'总结这段文字'</span>, {
  <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-chat'</span> <span class="hljs-comment">// $0.28/M input</span>
});
</code></pre>
<p><strong>2. 用缓存省钱</strong></p>
<p>OpenAI 和 Anthropic 都支持 prompt caching，缓存命中时输入成本降低 90%：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// OpenAI: cached input $0.175/M (vs $1.75/M)</span>
<span class="hljs-comment">// Anthropic: cached read $0.50/M (vs $5/M)</span>
<span class="hljs-comment">// DeepSeek: cache hit $0.028/M (vs $0.28/M)</span>
</code></pre>
<p><strong>3. 压缩上下文</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 浪费：发送完整历史</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">generate</span>(prompt, {
  <span class="hljs-attr">messages</span>: allMessages <span class="hljs-comment">// 可能几千条</span>
});

<span class="hljs-comment">// ✅ 省钱：只保留最近的</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">generate</span>(prompt, {
  <span class="hljs-attr">messages</span>: allMessages.<span class="hljs-title function_">slice</span>(-<span class="hljs-number">10</span>)
});
</code></pre>
<hr/>
<h2 data-id="heading-16">实战案例</h2>
<h3 data-id="heading-17">案例 1：成本敏感的代码生成</h3>
<p>需求：生成大量代码，但预算有限。</p>
<p>策略：用 <code>deepseek-chat</code> 生成初版（便宜），用 <code>claude-opus-4.6</code> 审查优化（准确）。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateCodeWithBudget</span>(<span class="hljs-params">task: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
  <span class="hljs-comment">// 第一步：便宜模型生成</span>
  <span class="hljs-keyword">const</span> draft = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">generate</span>(task, {
    <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-chat'</span>, <span class="hljs-comment">// $0.28/M input</span>
  });

  <span class="hljs-comment">// 第二步：强大模型审查</span>
  <span class="hljs-keyword">const</span> review = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">generate</span>(
    <span class="hljs-string">`审查并优化这段代码：\n<span class="hljs-subst">${draft.content}</span>`</span>,
    { <span class="hljs-attr">model</span>: <span class="hljs-string">'claude-opus-4.6'</span> } <span class="hljs-comment">// $5/M input</span>
  );

  <span class="hljs-keyword">return</span> review.<span class="hljs-property">content</span>;
}
</code></pre>
<p>成本对比：</p>
<ul>
<li>全程用 Claude Opus 4.6：$5/M input</li>
<li>混合策略：约 $1/M input（省 80%）</li>
</ul>
<h3 data-id="heading-18">案例 2：高可用生产环境</h3>
<p>需求：服务不能中断，即使某个模型宕机。</p>
<p>策略：配置多层降级链。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> config = {
  <span class="hljs-attr">primaryModel</span>: <span class="hljs-string">'claude-opus-4.6'</span>,
  <span class="hljs-attr">fallbackChain</span>: [
    <span class="hljs-string">'gpt-5.2'</span>,           <span class="hljs-comment">// 第一备选</span>
    <span class="hljs-string">'deepseek-chat'</span>,     <span class="hljs-comment">// 第二备选</span>
    <span class="hljs-string">'gemini-3-flash'</span>,  <span class="hljs-comment">// 第三备选</span>
  ],
  <span class="hljs-attr">retryConfig</span>: {
    <span class="hljs-attr">maxRetries</span>: <span class="hljs-number">3</span>,
    <span class="hljs-attr">backoffMs</span>: <span class="hljs-number">1000</span>,
  },
};

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateWithHighAvailability</span>(<span class="hljs-params">prompt: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">generateWithFallback</span>(prompt, config);
}
</code></pre>
<p>可用性：</p>
<ul>
<li>单模型：99.9%</li>
<li>四模型降级：99.99%+</li>
</ul>
<h3 data-id="heading-19">案例 3：智能任务路由</h3>
<p>需求：根据任务类型自动选择最佳模型。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">smartGenerate</span>(<span class="hljs-params">prompt: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
  <span class="hljs-keyword">const</span> taskType = <span class="hljs-keyword">await</span> router.<span class="hljs-title function_">detectTaskType</span>(prompt);
  <span class="hljs-keyword">const</span> model = router.<span class="hljs-title function_">selectModel</span>(taskType);
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Task: <span class="hljs-subst">${taskType}</span>, Model: <span class="hljs-subst">${model}</span>`</span>);
  
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> modelManager.<span class="hljs-title function_">generate</span>(prompt, { model });
}

<span class="hljs-comment">// 示例</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">smartGenerate</span>(<span class="hljs-string">'写一个快速排序'</span>);
<span class="hljs-comment">// → Task: code-generation, Model: claude-opus-4.6</span>

<span class="hljs-keyword">await</span> <span class="hljs-title function_">smartGenerate</span>(<span class="hljs-string">'翻译这段文字'</span>);
<span class="hljs-comment">// → Task: translation, Model: gpt-5-mini</span>

<span class="hljs-keyword">await</span> <span class="hljs-title function_">smartGenerate</span>(<span class="hljs-string">'分析这个算法的时间复杂度'</span>);
<span class="hljs-comment">// → Task: reasoning, Model: gpt-5.2-pro</span>
</code></pre>
<hr/>
<h2 data-id="heading-20">未来计划</h2>
<h3 data-id="heading-21">本地模型支持</h3>
<p>计划支持本地运行的开源模型：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Ollama 集成</span>
<span class="hljs-keyword">const</span> localProvider = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OllamaProvider</span>({
  <span class="hljs-attr">baseUrl</span>: <span class="hljs-string">'http://localhost:11434'</span>,
  <span class="hljs-attr">models</span>: [<span class="hljs-string">'llama4'</span>, <span class="hljs-string">'codellama'</span>, <span class="hljs-string">'qwen2.5'</span>],
});

<span class="hljs-comment">// 混合使用：本地 + 云端</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">generate</span>(prompt, {
  <span class="hljs-attr">model</span>: <span class="hljs-string">'llama4'</span>,        <span class="hljs-comment">// 本地（免费）</span>
  <span class="hljs-attr">fallback</span>: [<span class="hljs-string">'gpt-5.2'</span>],  <span class="hljs-comment">// 云端备选（付费）</span>
});
</code></pre>
<h3 data-id="heading-22">模型性能基准测试</h3>
<p>自动测试不同模型在特定任务上的表现：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelBenchmark</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">runBenchmark</span>(<span class="hljs-attr">task</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">models</span>: <span class="hljs-built_in">string</span>[]): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">BenchmarkResult</span>&gt; {
    <span class="hljs-keyword">const</span> results = [];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> model <span class="hljs-keyword">of</span> models) {
      <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>.<span class="hljs-title function_">generate</span>(task, { model });
      <span class="hljs-keyword">const</span> duration = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - start;

      results.<span class="hljs-title function_">push</span>({
        model,
        duration,
        <span class="hljs-attr">cost</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateCost</span>(response.<span class="hljs-property">usage</span>, model),
        <span class="hljs-attr">quality</span>: <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.evaluateQuality(response.<span class="hljs-property">content</span>),
      });
    }

    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rankResults</span>(results);
  }
}
</code></pre>
<h3 data-id="heading-23">动态定价优化</h3>
<p>根据实时定价自动选择最便宜的模型：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicPricingOptimizer</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">selectCheapestModel</span>(<span class="hljs-attr">task</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
    <span class="hljs-keyword">const</span> suitableModels = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getSuitableModels</span>(task);
    <span class="hljs-keyword">const</span> prices = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fetchCurrentPrices</span>(suitableModels);
    
    <span class="hljs-keyword">return</span> prices.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">price</span> - b.<span class="hljs-property">price</span>)[<span class="hljs-number">0</span>].<span class="hljs-property">model</span>;
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-24">总结</h2>
<h3 data-id="heading-25">核心要点</h3>
<ol>
<li><strong>统一接口</strong> — 所有模型通过 <code>Provider</code> 接口统一管理</li>
<li><strong>灵活切换</strong> — 运行时动态切换，无需重启</li>
<li><strong>自动降级</strong> — 主模型失败时自动尝试备用</li>
<li><strong>成本优化</strong> — 实时追踪成本，智能选择模型</li>
<li><strong>高可用</strong> — 多层降级保证服务不中断</li>
</ol>
<h3 data-id="heading-26">设计原则</h3>
<ol>
<li><strong>抽象优于具体</strong> — Provider 接口隔离具体实现</li>
<li><strong>组合优于继承</strong> — 通过组合不同 Provider 实现多模型支持</li>
<li><strong>配置优于硬编码</strong> — 模型选择、降级策略都可配置</li>
<li><strong>监控优于盲目</strong> — 实时追踪成本和性能</li>
</ol>
<h3 data-id="heading-27">最佳实践（2026 年 2 月）</h3>
<ul>
<li><strong>日常开发</strong>：<code>gpt-5-mini</code> 或 <code>deepseek-chat</code>（便宜快速）</li>
<li><strong>代码生成</strong>：<code>claude-opus-4.6</code>（代码能力最强）</li>
<li><strong>深度推理</strong>：<code>gpt-5.2-pro</code>（推理能力最强）</li>
<li><strong>生产环境</strong>：配置多层降级链（高可用）</li>
<li><strong>成本敏感</strong>：混合使用便宜和昂贵模型</li>
</ul>
<hr/>
<h2 data-id="heading-28">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FechoVic%2Fblade-code" target="_blank" title="https://github.com/echoVic/blade-code" ref="nofollow noopener noreferrer">blade-code GitHub</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Fapi%2Fpricing" target="_blank" title="https://openai.com/api/pricing" ref="nofollow noopener noreferrer">OpenAI API 定价</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.com%2Fpricing" target="_blank" title="https://claude.com/pricing" ref="nofollow noopener noreferrer">Anthropic API 定价</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fai.google.dev" target="_blank" title="https://ai.google.dev" ref="nofollow noopener noreferrer">Google AI Studio</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.deepseek.com" target="_blank" title="https://platform.deepseek.com" ref="nofollow noopener noreferrer">DeepSeek API</a></li>
</ul>
<hr/>
<p><em>本文由 <a href="https://link.juejin.cn?target=https%3A%2F%2Fechovic.com" target="_blank" title="https://echovic.com" ref="nofollow noopener noreferrer">青雲 (echoVic)</a> 撰写，基于 blade-code 的实践经验。</em>
<em>如有问题或建议，欢迎在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FechoVic%2Fblade-code%2Fissues" target="_blank" title="https://github.com/echoVic/blade-code/issues" ref="nofollow noopener noreferrer">GitHub Issues</a> 讨论。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue实现大屏获取当前所处城市及当地天气(纯免费)]]></title>    <link>https://juejin.cn/post/7603656494905475078</link>    <guid>https://juejin.cn/post/7603656494905475078</guid>    <pubDate>2026-02-08T01:49:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603656494905475078" data-draft-id="7603656494905458694" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue实现大屏获取当前所处城市及当地天气(纯免费)"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-08T01:49:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李剑一"/> <meta itemprop="url" content="https://juejin.cn/user/4147782344247918"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue实现大屏获取当前所处城市及当地天气(纯免费)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4147782344247918/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李剑一
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T01:49:04.000Z" title="Sun Feb 08 2026 01:49:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>之前做过的大屏项目一般是在内网环境中使用，所以一般顶部不牵扯展示城市和天气。但是这次做的是放在外网的，所以简单实现一下展示城市名称和当前实时天气信息。</p>
<h2 data-id="heading-0">获取当前所处位置</h2>
<p>获取当前定位可以通过浏览器原生的<code>Geolocation API</code>获取经纬度信息。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getLocation</span>(<span class="hljs-params"/>) {
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
		<span class="hljs-keyword">if</span> (navigator.<span class="hljs-property">geolocation</span>) {
			navigator.<span class="hljs-property">geolocation</span>.<span class="hljs-title function_">getCurrentPosition</span>(
				<span class="hljs-function">(<span class="hljs-params">position</span>) =&gt;</span> {
					<span class="hljs-keyword">const</span> lat = position.<span class="hljs-property">coords</span>.<span class="hljs-property">latitude</span>;
					<span class="hljs-keyword">const</span> lon = position.<span class="hljs-property">coords</span>.<span class="hljs-property">longitude</span>;
					<span class="hljs-title function_">resolve</span>({lat, lon});
					<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'当前位置:'</span>, lat, lon);
				},
				<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
					<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'无法获取位置:'</span>, error.<span class="hljs-property">message</span>);
					<span class="hljs-title function_">reject</span>(error);
				}
			);
		}
	})
}
</code></pre>
<p>需要注意，<code>Geolocation API</code>是异步的，所以这里用 <code>Promise</code> 进行了简单的封装。另外这里只能获取到经纬度，无法获取到所在城市名称，需要通过逆地理编码的方式实现。</p>
<h2 data-id="heading-1">逆地理编码</h2>
<p>目前国内主要是<strong>御三家</strong>提供<strong>逆地理编码</strong>的服务，但是都需要进行付费，不过唯一可以庆幸的是各家都有<strong>免费额度</strong>。</p>
<p>如果你的大屏部署在外网，国外的<strong>Nominatim</strong>是完全免费的，咱们这边目前是无法访问的。官网地址也放一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fnominatim.openstreetmap.org" target="_blank" title="https://nominatim.openstreetmap.org" ref="nofollow noopener noreferrer">nominatim.openstreetmap.org</a>。</p>
<p>这里我以腾讯的逆地理编码服务为例子简单写一下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getCityName</span>(<span class="hljs-params">lat, lon</span>) {
	<span class="hljs-keyword">const</span> sig = <span class="hljs-title class_">CryptoJs</span>.<span class="hljs-title class_">MD5</span>(<span class="hljs-string">`/ws/geocoder/v1/?key=<span class="hljs-subst">${你的key}</span>&amp;location=<span class="hljs-subst">${lat}</span>,<span class="hljs-subst">${lon}</span><span class="hljs-subst">${你的签名}</span>`</span>).<span class="hljs-title function_">toString</span>();
	<span class="hljs-keyword">const</span> {result} = <span class="hljs-keyword">await</span> request.<span class="hljs-title function_">get</span>(<span class="hljs-string">`/tencent/ws/geocoder/v1/?key=<span class="hljs-subst">${你的key}</span>&amp;location=<span class="hljs-subst">${lat}</span>,<span class="hljs-subst">${lon}</span>&amp;sig=<span class="hljs-subst">${sig}</span>`</span>);
	<span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${result.address_component.city}</span>-<span class="hljs-subst">${result.address_component.district}</span>`</span>
}
</code></pre>
<p>这里需要代理一下，我这里的代理如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-string">'/tencent'</span>: {
    <span class="hljs-attr">target</span>: <span class="hljs-string">'https://apis.map.qq.com'</span>,
    <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">rewrite</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^\/tencent/</span>, <span class="hljs-string">''</span>)
},
</code></pre>
<h2 data-id="heading-2">获取天气</h2>
<p>天气信息目前咱们这边有和风天气，提供了一定的免费额度。</p>
<p>但是我在网上找到一个外面的，但是咱们这边能访问到的<strong>Open-Meteo</strong>，官方地址也放一下<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen-meteo.com" target="_blank" title="https://open-meteo.com" ref="nofollow noopener noreferrer">open-meteo.com</a>。</p>
<p>特点如下：</p>
<ul>
<li>无需注册、无 API Key、无调用限制</li>
<li>支持全球经纬度实时天气 + 未来7天预报</li>
<li>数据来源：欧洲中期天气预报中心（ECMWF）等权威机构</li>
</ul>
<p>唯一不好的一点在于返回的都是英文数据，需要认为的转成中文。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 部分天气中英文映射</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">WEATHER_CODE_MAP</span> = {
	<span class="hljs-number">0</span>: { <span class="hljs-attr">en</span>: <span class="hljs-string">'Clear sky'</span>, <span class="hljs-attr">zh</span>: <span class="hljs-string">'晴'</span> },
	<span class="hljs-number">1</span>: { <span class="hljs-attr">en</span>: <span class="hljs-string">'Mainly clear'</span>, <span class="hljs-attr">zh</span>: <span class="hljs-string">'晴转多云'</span> },
	<span class="hljs-number">2</span>: { <span class="hljs-attr">en</span>: <span class="hljs-string">'Partly cloudy'</span>, <span class="hljs-attr">zh</span>: <span class="hljs-string">'多云'</span> },
	<span class="hljs-number">3</span>: { <span class="hljs-attr">en</span>: <span class="hljs-string">'Overcast'</span>, <span class="hljs-attr">zh</span>: <span class="hljs-string">'阴'</span> },
	<span class="hljs-number">45</span>: { <span class="hljs-attr">en</span>: <span class="hljs-string">'Fog'</span>, <span class="hljs-attr">zh</span>: <span class="hljs-string">'雾'</span> },
	<span class="hljs-number">48</span>: { <span class="hljs-attr">en</span>: <span class="hljs-string">'Depositing rime fog'</span>, <span class="hljs-attr">zh</span>: <span class="hljs-string">'冻雾'</span> },
	<span class="hljs-number">51</span>: { <span class="hljs-attr">en</span>: <span class="hljs-string">'Drizzle: Light'</span>, <span class="hljs-attr">zh</span>: <span class="hljs-string">'小雨'</span> },
	<span class="hljs-number">53</span>: { <span class="hljs-attr">en</span>: <span class="hljs-string">'Drizzle: Moderate'</span>, <span class="hljs-attr">zh</span>: <span class="hljs-string">'中雨'</span> },
	<span class="hljs-number">55</span>: { <span class="hljs-attr">en</span>: <span class="hljs-string">'Drizzle: Dense'</span>, <span class="hljs-attr">zh</span>: <span class="hljs-string">'大雨'</span> },
	<span class="hljs-number">61</span>: { <span class="hljs-attr">en</span>: <span class="hljs-string">'Rain: Slight'</span>, <span class="hljs-attr">zh</span>: <span class="hljs-string">'小雨'</span> },
	<span class="hljs-number">63</span>: { <span class="hljs-attr">en</span>: <span class="hljs-string">'Rain: Moderate'</span>, <span class="hljs-attr">zh</span>: <span class="hljs-string">'中雨'</span> },
	<span class="hljs-number">65</span>: { <span class="hljs-attr">en</span>: <span class="hljs-string">'Rain: Heavy'</span>, <span class="hljs-attr">zh</span>: <span class="hljs-string">'大雨'</span> },
	<span class="hljs-number">71</span>: { <span class="hljs-attr">en</span>: <span class="hljs-string">'Snow fall: Slight'</span>, <span class="hljs-attr">zh</span>: <span class="hljs-string">'小雪'</span> },
	<span class="hljs-number">73</span>: { <span class="hljs-attr">en</span>: <span class="hljs-string">'Snow fall: Moderate'</span>, <span class="hljs-attr">zh</span>: <span class="hljs-string">'中雪'</span> },
	<span class="hljs-number">75</span>: { <span class="hljs-attr">en</span>: <span class="hljs-string">'Snow fall: Heavy'</span>, <span class="hljs-attr">zh</span>: <span class="hljs-string">'大雪'</span> },
	<span class="hljs-number">95</span>: { <span class="hljs-attr">en</span>: <span class="hljs-string">'Thunderstorm'</span>, <span class="hljs-attr">zh</span>: <span class="hljs-string">'雷阵雨'</span> },
	<span class="hljs-number">96</span>: { <span class="hljs-attr">en</span>: <span class="hljs-string">'Thunderstorm with slight hail'</span>, <span class="hljs-attr">zh</span>: <span class="hljs-string">'雷阵雨伴小冰雹'</span> },
	<span class="hljs-number">99</span>: { <span class="hljs-attr">en</span>: <span class="hljs-string">'Thunderstorm with heavy hail'</span>, <span class="hljs-attr">zh</span>: <span class="hljs-string">'雷阵雨伴大冰雹'</span> }
};
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 获取天气</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getWeather</span>(<span class="hljs-params">lat, lon</span>) {
	<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> request.<span class="hljs-title function_">get</span>(<span class="hljs-string">`https://api.open-meteo.com/v1/forecast?latitude=<span class="hljs-subst">${lat}</span>&amp;longitude=<span class="hljs-subst">${lon}</span>&amp;current_weather=true`</span>);
	<span class="hljs-keyword">const</span> code = result.<span class="hljs-property">current_weather</span>.<span class="hljs-property">weathercode</span>;
	<span class="hljs-keyword">return</span> <span class="hljs-variable constant_">WEATHER_CODE_MAP</span>[code] || {<span class="hljs-attr">en</span>: <span class="hljs-string">'Unknown'</span>, <span class="hljs-attr">zh</span>: <span class="hljs-string">'未知'</span>};
}
</code></pre>
<p>这个是不需要代理的，因为<strong>Open-Meteo</strong>本身支持<code>CORS</code>。</p>
<h2 data-id="heading-3">总结</h2>
<p>获取经纬度和城市信息，以及天气信息在技术上没什么难度。</p>
<p>主要的问题点在于很多东西都是付费的，自己玩玩还好，但要是真的上线正式环境一定要<strong>防备</strong>被别人恶意刷爆。</p>
<p>之前我还见过一个大屏上实时展示天气状况，卫星地图上前面有一层蒙版展示。如果是下雨的话有雨滴打在屏幕上的感觉，效果非常不错，回头实现完分享给大家。</p>
<p>欢迎关注我的公众号<strong>李剑一</strong>，分享更多的干货，畅聊圈内八卦。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 3 入门完全指南：从零构建你的第一个响应式应用]]></title>    <link>https://juejin.cn/post/7603673564908552227</link>    <guid>https://juejin.cn/post/7603673564908552227</guid>    <pubDate>2026-02-08T01:51:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603673564908552227" data-draft-id="7603671627003379752" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 3 入门完全指南：从零构建你的第一个响应式应用"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-02-08T01:51:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈里谢顿"/> <meta itemprop="url" content="https://juejin.cn/user/3678304397695056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 3 入门完全指南：从零构建你的第一个响应式应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3678304397695056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈里谢顿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T01:51:36.000Z" title="Sun Feb 08 2026 01:51:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>适合人群</strong>：有 HTML/CSS/JavaScript 基础，想快速上手 Vue 3 的前端初学者<br/>
<strong>学习目标</strong>：掌握 Vue 3 核心概念，能独立开发简单交互应用<br/>
<strong>技术栈</strong>：Vue 3 + Composition API + Vite（2026 年最新实践）</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、为什么选择 Vue 3？</h2>
<p>在 React、Angular、Svelte 等框架中，Vue 凭借以下优势成为新手友好之选：</p>

























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>渐进式框架</strong></td><td>可从 CDN 引入，也可构建大型 SPA</td></tr><tr><td><strong>中文文档完善</strong></td><td>官方提供高质量中文文档</td></tr><tr><td><strong>Composition API</strong></td><td>逻辑复用更灵活（类似 React Hooks）</td></tr><tr><td><strong>开发体验优秀</strong></td><td>Vite 极速启动，HMR 热更新毫秒级</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>2026 年现状</strong>：Vue 3 已成主流，Vue 2 于 2023 年停止维护。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、环境准备：30 秒启动项目</h2>
<h3 data-id="heading-2">方式 1：CDN 快速体验（推荐新手）</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>My First Vue App<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 从 CDN 加载 Vue 3 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/vue@3/dist/vue.global.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{{ message }}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"reverseMessage"</span>&gt;</span>反转消息<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">const</span> { createApp, ref } = <span class="hljs-title class_">Vue</span>

    <span class="hljs-title function_">createApp</span>({
      <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> message = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'Hello Vue!'</span>)
        
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">reverseMessage</span> = (<span class="hljs-params"/>) =&gt; {
          message.<span class="hljs-property">value</span> = message.<span class="hljs-property">value</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">''</span>).<span class="hljs-title function_">reverse</span>().<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>)
        }

        <span class="hljs-keyword">return</span> {
          message,
          reverseMessage
        }
      }
    }).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<blockquote>
<p>✅ 打开浏览器 → 点击按钮 → 文字反转！你已成功运行 Vue！</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">方式 2：Vite 脚手架（生产级开发）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 创建项目</span>
<span class="hljs-string">npm</span> <span class="hljs-string">create</span> <span class="hljs-string">vue@latest</span> <span class="hljs-string">my-vue-app</span>

<span class="hljs-comment"># 按提示选择（建议全选默认）</span>
<span class="hljs-string">✔</span> <span class="hljs-attr">Project name:</span> <span class="hljs-string">…</span> <span class="hljs-string">my-vue-app</span>
<span class="hljs-string">✔</span> <span class="hljs-string">Add</span> <span class="hljs-string">TypeScript?</span> <span class="hljs-string">…</span> <span class="hljs-literal">No</span>
<span class="hljs-string">✔</span> <span class="hljs-string">Add</span> <span class="hljs-string">JSX</span> <span class="hljs-string">Support?</span> <span class="hljs-string">…</span> <span class="hljs-literal">No</span>
<span class="hljs-string">✔</span> <span class="hljs-string">Add</span> <span class="hljs-string">Vue</span> <span class="hljs-string">Router?</span> <span class="hljs-string">…</span> <span class="hljs-literal">No</span>
<span class="hljs-string">✔</span> <span class="hljs-string">Add</span> <span class="hljs-string">Pinia?</span> <span class="hljs-string">…</span> <span class="hljs-literal">No</span>
<span class="hljs-string">✔</span> <span class="hljs-string">Add</span> <span class="hljs-string">Vitest?</span> <span class="hljs-string">…</span> <span class="hljs-literal">No</span>
<span class="hljs-string">✔</span> <span class="hljs-string">Add</span> <span class="hljs-string">Cypress?</span> <span class="hljs-string">…</span> <span class="hljs-literal">No</span>
<span class="hljs-string">✔</span> <span class="hljs-string">Add</span> <span class="hljs-string">ESLint?</span> <span class="hljs-string">…</span> <span class="hljs-literal">Yes</span>
<span class="hljs-string">✔</span> <span class="hljs-string">Add</span> <span class="hljs-string">Prettier?</span> <span class="hljs-string">…</span> <span class="hljs-literal">Yes</span>

<span class="hljs-comment"># 进入目录并安装依赖</span>
<span class="hljs-string">cd</span> <span class="hljs-string">my-vue-app</span>
<span class="hljs-string">npm</span> <span class="hljs-string">install</span>

<span class="hljs-comment"># 启动开发服务器</span>
<span class="hljs-string">npm</span> <span class="hljs-string">run</span> <span class="hljs-string">dev</span>
</code></pre>
<p>访问 <code>http://localhost:5173</code>，看到 Vue 官方欢迎页即成功！</p>
<hr/>
<h2 data-id="heading-4">三、核心概念精讲（附代码示例）</h2>
<h3 data-id="heading-5">1. 响应式数据：<code>ref</code> 与 <code>reactive</code></h3>
<h4 data-id="heading-6"><code>ref</code>：用于基本类型（字符串、数字、布尔值）</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 创建响应式引用</span>
<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)

<span class="hljs-comment">// 修改值必须通过 .value</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; {
  count.<span class="hljs-property">value</span>++
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>计数: {{ count }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"increment"</span>&gt;</span>+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<blockquote>
<p>🔍 <strong>关键点</strong>：模板中自动解包 <code>.value</code>，但 JS 逻辑中需显式使用。</p>
</blockquote>
<h4 data-id="heading-7"><code>reactive</code>：用于对象/数组</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> user = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateAge</span> = (<span class="hljs-params"/>) =&gt; {
  user.<span class="hljs-property">age</span>++ <span class="hljs-comment">// 直接修改属性</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ user.name }} - {{ user.age }}岁<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"updateAge"</span>&gt;</span>长大一岁<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<blockquote>
<p>💡 <strong>何时用哪个？</strong></p>
<ul>
<li>单个值 → <code>ref</code></li>
<li>复杂对象 → <code>reactive</code></li>
<li>不确定？统一用 <code>ref</code>（更安全）</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-8">2. 事件处理：<code>@click</code> 与方法</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 方法调用 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"greet"</span>&gt;</span>打招呼<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  
  <span class="hljs-comment">&lt;!-- 内联处理器 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"count++"</span>&gt;</span>直接修改<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  
  <span class="hljs-comment">&lt;!-- 传递参数 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"deleteItem(item.id)"</span>&gt;</span>删除<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  
  <span class="hljs-comment">&lt;!-- 修饰符：阻止默认行为 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">form</span> @<span class="hljs-attr">submit.prevent</span>=<span class="hljs-string">"handleSubmit"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"input"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> <span class="hljs-title function_">greet</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">alert</span>(<span class="hljs-string">'Hello!'</span>)
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">deleteItem</span> = (<span class="hljs-params">id</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'删除ID:'</span>, id)
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'表单提交'</span>)
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<blockquote>
<p>📌 <strong>常用修饰符</strong>：</p>
<ul>
<li><code>.prevent</code>：阻止默认行为（如表单提交刷新）</li>
<li><code>.stop</code>：阻止事件冒泡</li>
<li><code>.once</code>：只触发一次</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-9">3. 条件渲染：<code>v-if</code> vs <code>v-show</code></h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- v-if：条件为假时完全移除 DOM --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isLoggedIn"</span>&gt;</span>欢迎回来！<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  
  <span class="hljs-comment">&lt;!-- v-else / v-else-if --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"isLoading"</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span>&gt;</span>请先登录<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  
  <span class="hljs-comment">&lt;!-- v-show：始终渲染 DOM，仅切换 display --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-show</span>=<span class="hljs-string">"showModal"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"modal"</span>&gt;</span>弹窗内容<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<blockquote>
<p>⚠️ <strong>性能区别</strong>：</p>
<ul>
<li>频繁切换 → <code>v-show</code>（避免重复创建/销毁）</li>
<li>条件很少改变 → <code>v-if</code>（节省内存）</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-10">4. 列表渲染：<code>v-for</code></h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 渲染数组 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in items"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span>&gt;</span>
      {{ item.name }}
    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
  
  <span class="hljs-comment">&lt;!-- 渲染对象 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(value, key) in userInfo"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"key"</span>&gt;</span>
    {{ key }}: {{ value }}
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  
  <span class="hljs-comment">&lt;!-- 带索引 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item, index) in list"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span>&gt;</span>
    {{ index + 1 }}. {{ item.title }}
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> items = [
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'苹果'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'香蕉'</span> }
]

<span class="hljs-keyword">const</span> userInfo = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span>,
  <span class="hljs-attr">email</span>: <span class="hljs-string">'bob@example.com'</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<blockquote>
<p>🔑 <strong>必须加 <code>:key</code></strong>！<br/>
帮助 Vue 高效更新列表（避免复用错误）</p>
</blockquote>
<hr/>
<h3 data-id="heading-11">5. 表单绑定：<code>v-model</code></h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 文本输入 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"message"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入消息"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>实时预览: {{ message }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  
  <span class="hljs-comment">&lt;!-- 多行文本 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"description"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">textarea</span>&gt;</span>
  
  <span class="hljs-comment">&lt;!-- 复选框 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"isChecked"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{{ isChecked ? '已选中' : '未选中' }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  
  <span class="hljs-comment">&lt;!-- 单选按钮 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"radio"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"picked"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"A"</span>&gt;</span> A
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"radio"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"picked"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"B"</span>&gt;</span> B
  
  <span class="hljs-comment">&lt;!-- 下拉选择 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"selected"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">disabled</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span>&gt;</span>请选择<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">option</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">option</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> message = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
<span class="hljs-keyword">const</span> description = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
<span class="hljs-keyword">const</span> isChecked = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
<span class="hljs-keyword">const</span> picked = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'A'</span>)
<span class="hljs-keyword">const</span> selected = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<blockquote>
<p>💡 <strong>修饰符</strong>：</p>
<ul>
<li><code>.trim</code>：自动去除首尾空格 → <code>v-model.trim="text"</code></li>
<li><code>.number</code>：转为数字 → <code>v-model.number="age"</code></li>
<li><code>.lazy</code>：失去焦点时更新（非 input 时）→ <code>v-model.lazy="comment"</code></li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-12">四、组件化开发：构建可复用 UI</h2>
<h3 data-id="heading-13">1. 创建组件（Button.vue）</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- src/components/MyButton.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
    <span class="hljs-attr">class</span>=<span class="hljs-string">"my-button"</span>
    <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ 'primary': primary }"</span>
    @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleClick"</span>
  &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">slot</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span> <span class="hljs-comment">&lt;!-- 插槽：接收父组件内容 --&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-title function_">defineProps</span>({
  <span class="hljs-attr">primary</span>: <span class="hljs-title class_">Boolean</span> <span class="hljs-comment">// 接收父组件传入的属性</span>
})

<span class="hljs-keyword">const</span> emit = <span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">'click'</span>]) <span class="hljs-comment">// 声明触发的事件</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">emit</span>(<span class="hljs-string">'click'</span>) <span class="hljs-comment">// 触发 click 事件</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.my-button</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">cursor</span>: pointer;
}
<span class="hljs-selector-class">.primary</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#409eff</span>;
  <span class="hljs-attribute">color</span>: white;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h3 data-id="heading-14">2. 使用组件（App.vue）</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MyButton</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/MyButton.vue'</span>
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
<span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; count.<span class="hljs-property">value</span>++
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>计数: {{ count }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 使用组件，传递 props 和监听事件 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> 
      <span class="hljs-attr">:primary</span>=<span class="hljs-string">"true"</span> 
      @<span class="hljs-attr">click</span>=<span class="hljs-string">"increment"</span>
    &gt;</span>
      点我加1！
    <span class="hljs-tag">&lt;/<span class="hljs-name">MyButton</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<blockquote>
<p>🧩 <strong>组件三要素</strong>：</p>
<ol>
<li><strong>Props</strong>：父 → 子 传递数据</li>
<li><strong>Events</strong>：子 → 父 通信</li>
<li><strong>Slots</strong>：父组件向子组件插入内容</li>
</ol>
</blockquote>
<hr/>
<h2 data-id="heading-15">五、实战：待办事项（Todo List）</h2>
<p>将所学知识整合为一个完整小应用！</p>
<h3 data-id="heading-16">1. 项目结构</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">src</span>/
├── components/
│   └── TodoItem<span class="hljs-selector-class">.vue</span>
└── App<span class="hljs-selector-class">.vue</span>
</code></pre>
<h3 data-id="heading-17">2. App.vue（主组件）</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoItem</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/TodoItem.vue'</span>

<span class="hljs-keyword">const</span> newTodo = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
<span class="hljs-keyword">const</span> todos = <span class="hljs-title function_">ref</span>([
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'学习 Vue'</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> }
])

<span class="hljs-keyword">const</span> <span class="hljs-title function_">addTodo</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (newTodo.<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>()) {
    todos.<span class="hljs-property">value</span>.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
      <span class="hljs-attr">text</span>: newTodo.<span class="hljs-property">value</span>,
      <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span>
    })
    newTodo.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">removeTodo</span> = (<span class="hljs-params">id</span>) =&gt; {
  todos.<span class="hljs-property">value</span> = todos.<span class="hljs-property">value</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> todo.<span class="hljs-property">id</span> !== id)
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"todo-app"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>我的待办事项<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 添加新任务 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">form</span> @<span class="hljs-attr">submit.prevent</span>=<span class="hljs-string">"addTodo"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
        <span class="hljs-attr">v-model</span>=<span class="hljs-string">"newTodo"</span> 
        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入新任务..."</span>
        @<span class="hljs-attr">keyup.enter</span>=<span class="hljs-string">"addTodo"</span>
      &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>添加<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 任务列表 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">TodoItem</span> 
        <span class="hljs-attr">v-for</span>=<span class="hljs-string">"todo in todos"</span> 
        <span class="hljs-attr">:key</span>=<span class="hljs-string">"todo.id"</span>
        <span class="hljs-attr">:todo</span>=<span class="hljs-string">"todo"</span>
        @<span class="hljs-attr">remove</span>=<span class="hljs-string">"removeTodo(todo.id)"</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>剩余: {{ todos.filter(t =&gt; !t.done).length }} 项<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h3 data-id="heading-18">3. TodoItem.vue（子组件）</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"todo-item"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> 
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"todo.done"</span>
    &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ done: todo.done }"</span>&gt;</span>{{ todo.text }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"$emit('remove')"</span>&gt;</span>删除<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-title function_">defineProps</span>({
  <span class="hljs-attr">todo</span>: <span class="hljs-title class_">Object</span>
})
<span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">'remove'</span>])
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.done</span> {
  <span class="hljs-attribute">text-decoration</span>: line-through;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#999</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<blockquote>
<p>✅ 功能包含：</p>
<ul>
<li>添加任务（回车/按钮）</li>
<li>完成/取消任务</li>
<li>删除任务</li>
<li>统计剩余数量</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-19">六、调试技巧</h2>
<h3 data-id="heading-20">1. 浏览器 DevTools</h3>
<p>安装 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevtools.vuejs.org%2F" target="_blank" title="https://devtools.vuejs.org/" ref="nofollow noopener noreferrer">Vue Devtools</a> 扩展：</p>
<ul>
<li>查看组件树</li>
<li>实时修改响应式数据</li>
<li>检查事件监听器</li>
</ul>
<h3 data-id="heading-21">2. 控制台日志</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 在 setup() 中</span>
console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'当前状态:'</span>, reactiveData)
</code></pre>
<h3 data-id="heading-22">3. 常见错误排查</h3>

























<table><thead><tr><th>错误现象</th><th>解决方案</th></tr></thead><tbody><tr><td>数据不更新</td><td>检查是否用 <code>ref</code>/<code>reactive</code> 包裹</td></tr><tr><td>事件不触发</td><td>检查 <code>@click</code> 是否拼写正确</td></tr><tr><td>组件不显示</td><td>检查是否正确 import 和注册</td></tr><tr><td>样式失效</td><td>检查 <code>&lt;style scoped&gt;</code> 是否冲突</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-23">七、下一步学习路线</h2>
<ol>
<li><strong>路由管理</strong>：学习 <a href="https://link.juejin.cn?target=https%3A%2F%2Frouter.vuejs.org%2Fzh%2F" target="_blank" title="https://router.vuejs.org/zh/" ref="nofollow noopener noreferrer">Vue Router</a> 实现多页面跳转</li>
<li><strong>状态管理</strong>：掌握 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpinia.vuejs.org%2Fzh%2F" target="_blank" title="https://pinia.vuejs.org/zh/" ref="nofollow noopener noreferrer">Pinia</a> 管理全局状态</li>
<li><strong>TypeScript</strong>：为 Vue 项目添加类型安全</li>
<li><strong>构建工具</strong>：深入理解 Vite 配置</li>
<li><strong>UI 库</strong>：集成 Element Plus / Naive UI 快速开发</li>
</ol>
<hr/>
<h2 data-id="heading-24">八、总结：Vue 3 核心要点</h2>



































<table><thead><tr><th>概念</th><th>关键语法</th><th>用途</th></tr></thead><tbody><tr><td><strong>响应式</strong></td><td><code>ref()</code>, <code>reactive()</code></td><td>数据驱动视图</td></tr><tr><td><strong>模板指令</strong></td><td><code>v-if</code>, <code>v-for</code>, <code>v-model</code></td><td>声明式渲染</td></tr><tr><td><strong>事件处理</strong></td><td><code>@click</code>, <code>.prevent</code></td><td>用户交互</td></tr><tr><td><strong>组件通信</strong></td><td><code>props</code>, <code>emit</code>, <code>slots</code></td><td>模块化开发</td></tr><tr><td><strong>组合式 API</strong></td><td><code>setup()</code>, <code>script setup</code></td><td>逻辑复用</td></tr></tbody></table>
<blockquote>
<p>💬 <strong>记住</strong>：<br/>
<strong>“Vue 的核心思想是：数据变，视图自动更新。”</strong><br/>
掌握这一点，你就已经入门了！</p>
</blockquote>
<hr/>
<p><strong>资源推荐</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vuejs.org%2F" target="_blank" title="https://cn.vuejs.org/" ref="nofollow noopener noreferrer">Vue 3 官方文档（中文）</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.vuemastery.com%2Fcourses%2F" target="_blank" title="https://www.vuemastery.com/courses/" ref="nofollow noopener noreferrer">Vue Mastery 免费课程</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fawesome-vue" target="_blank" title="https://github.com/vuejs/awesome-vue" ref="nofollow noopener noreferrer">Awesome Vue</a> 生态工具集</li>
</ul>
<hr/>
<blockquote>
<p><strong>作者</strong>：前端工程师<br/>
<strong>更新日期</strong>：2026 年 2 月<br/>
<strong>版权声明</strong>：本文可自由转载，但请保留出处。</p>
</blockquote>
<p>如果你希望我提供 <strong>完整的 Todo List 项目代码仓库</strong> 或 <strong>Vue 3 + TypeScript 版本示例</strong>，欢迎继续提问！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[重构即时IM项目13：优化消息通路（下）]]></title>    <link>https://juejin.cn/post/7603644943350284294</link>    <guid>https://juejin.cn/post/7603644943350284294</guid>    <pubDate>2026-02-07T10:53:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603644943350284294" data-draft-id="7603656494904590342" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="重构即时IM项目13：优化消息通路（下）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-07T10:53:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QZQ54188"/> <meta itemprop="url" content="https://juejin.cn/user/666776045362473"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            重构即时IM项目13：优化消息通路（下）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/666776045362473/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QZQ54188
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-07T10:53:46.000Z" title="Sat Feb 07 2026 10:53:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">使用SessionID替代UserID</h2>
<p>当前消息采用用户ID作为发送对象，而不是会话ID，这就造成了在同一个聊天窗口里，A 发的消息和 B 发的消息，使用的是两套完全不相关的序列号体系 。你无法简单地通过 Seq 排序来还原整个对话的先后顺序（Timeline），当然也是可以还原先后顺序的，客户端拉取会话的最新消息时，必须同时查询发给我的和我发出的两份数据，并尝试在本地进行时间排序，这样逻辑非常容易出问题。</p>
<p>其实上面的使用UserID作为发送对象本质上就是一个收件箱模型，当你使用UserID来分配序列号时，你实际上就是在维护每个人的私有收件箱。当B 发消息给A 时，系统认为是投递到 A 的邮箱，所以消耗的是 A 的序列号。</p>
<p>当你抽象出SessionID并以此分配序列号时，就是在构建公共的时间线，是一个发件箱模型。每个会话都有一个专属的计数器。无论是A还是B发消息，发送的消息都得在Session 1中排队获取ID，这样整个会话内的消息就是天然有序的，客户端只需要记录一个MaxSeq，下次拉取时直接请求Seq &gt; MaxSeq的所有消息即可，无论是谁发送的。</p>
<p>其实上面两种讨论的本质就是对于写放大和读放大的取舍。使用SessionID模式优化了写放大，在UserID路由模式中，如果你在一个500人的群里面发一条消息，你就需要查找群里所有人的用户ID，然后再插入500条消息，使每个群成员的收件箱里面各插一条，写放大严重。采用会话模式的话就只需要在会话表中插入一条消息即可。</p>
<p>但是会话模式通常存在读放大风险，在UserID即收件箱模式中，用户打开App，查询所有未读消息时，只需要查一次自己的收件箱表，读取极快而且逻辑简单。但是在会话模式的话，需要去扫描所有相关的会话表，聚合计算每个会话是否有新消息以及有多少未读，这会产生巨大的读放大 。</p>
<p>这种方式可以使用写扩散索引 + 读扩散内容的混合模式解决。消息内容表中使用SessionID存储，无论群聊规模多大（例如 5000 人大群），一条消息在物理上只存储一份。这彻底消除了消息体层面的写放大，节省了海量存储空间。再加一个会话索引表，引入一个轻量级的 会话索引表 （Session Index），使用 UserID (OwnerId) 建立索引，这张表仅存储元数据，如 ConversationID 、 LastMsgID 、 UnreadCount 、 TopStatus 等，当用户打开 App 时，只需基于 UserID 查询这张索引表，即可 O(1) 复杂度获取完整的会话列表和未读状态，解决了读放大问题。这样的话其实还是有索引更新的压力，假设群聊有500人，写一条Message存入共享存储，之后就需要更新500行会话索引表，更新 LastMsgID 指针并增加 UnreadCount，这部分可以使用消息队列异步更新的方式解决。</p>
<p>下面是改为使用会话ID所作的变动：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getSessionID</span><span class="hljs-params">(id1, id2 <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> {
	<span class="hljs-keyword">if</span> strings.HasPrefix(id2, <span class="hljs-string">"G"</span>) {
		<span class="hljs-keyword">return</span> id2
	}
	<span class="hljs-comment">// P2P: 保证 ID 顺序一致</span>
	<span class="hljs-keyword">if</span> id1 &gt; id2 {
		id1, id2 = id2, id1
	}
	hash := md5.Sum([]<span class="hljs-type">byte</span>(fmt.Sprintf(<span class="hljs-string">"%s:%s"</span>, id1, id2)))
	<span class="hljs-keyword">return</span> hex.EncodeToString(hash[:])
}
</code></pre>
<p>首先在StateServer中增加这个函数，对于单聊场景，这个函数就是将双方ID排序后拼接min:max并计算MD5，确保A和B无论谁发送消息，生成的SessionID都是同一个。群聊的话就直接使用群ID作为会话ID就好。</p>
<pre><code class="hljs language-go" lang="go">sessionID = getSessionID(req.Uid, msgCmd.ReceiverId)
seq, err = s.alloc.NextSeq(ctx, sessionID)
</code></pre>
<p>这段变动很简单，就是要求分配器按照会话为粒度去分配连续的序号流，解决了时间线割裂问题，客户端拉取历史消息变得非常简单，只拉取Seq &gt; LocalMax。之后落库也是按照这个分配的会话ID去落入消息库，避免写放大。</p>
<p>由于我们使用了上面提到的混合逻辑，所以在落库的时候我们不仅要落库<code>model.Message</code>，还需要更新会话表相关信息，不然消息接收方的会话界面就不会更改，提示用户有未读消息。具体来说，在用户的会话表中加上写入会话的当前Seq号，便于用户获取消息时快速根据会话的Seq号去消息表中根据SessionID索引去拉取消息。用户打开 App，本地存的最后一条消息 Seq 是 100，用户先查自己的 Session 表，发现某个会话的MaxSeq是 150，说明此时有50条新消息。客户端此时就会去Message表请求，利用索引快速拉回缺失的消息。所以我们还需要落库Session表，在落库成功之后开启一个协程去写Session表，当然这里也可以同步写，另起一个协程写是因为可能一条消息需要更新多个会话表，此时耗时增加，同步写的话就会尝试阻塞现象。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">go</span> s.updateSessionIndex(ctx, req.Uid, msgCmd.ReceiverId, msgCmd.Content, seq)
</code></pre>
<p>下面解释一下更新会话表的函数：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Service)</span></span> updateSessionIndex(ctx context.Context, sendId, receiveId, content <span class="hljs-type">string</span>, seq <span class="hljs-type">int64</span>) {
    s.upsertSession(sendId, receiveId, content, <span class="hljs-number">0</span>, seq)

    <span class="hljs-keyword">if</span> strings.HasPrefix(receiveId, <span class="hljs-string">"G"</span>) {
        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 获取群成员列表并循环更新</span>
    } <span class="hljs-keyword">else</span> {
        s.upsertSession(receiveId, sendId, content, <span class="hljs-number">1</span>, seq)
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Service)</span></span> upsertSession(ownerId, peerId, content <span class="hljs-type">string</span>, unreadInc <span class="hljs-type">int</span>, seq <span class="hljs-type">int64</span>) {
    now := time.Now()
    err := dao.GormDB.Clauses(clause.OnConflict{
        Columns: []clause.Column{{Name: <span class="hljs-string">"uuid"</span>}},
        DoUpdates: clause.Assignments(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
            <span class="hljs-string">"last_message"</span>:    content,
            <span class="hljs-string">"last_message_at"</span>: now,
            <span class="hljs-string">"unread_count"</span>:    gorm.Expr(<span class="hljs-string">"unread_count + ?"</span>, unreadInc),
            <span class="hljs-string">"max_seq"</span>:         seq,
        }),
    }).Create(&amp;model.Session{
        Uuid:          fmt.Sprintf(<span class="hljs-string">"S%s"</span>, getSessionID(ownerId, peerId)),
        SendId:        ownerId,
        ReceiveId:     peerId,
        ReceiveName:   peerId, <span class="hljs-comment">// 简化</span>
        LastMessage:   content,
        LastMessageAt: sql.NullTime{Time: now, Valid: <span class="hljs-literal">true</span>},
        UnreadCount:   unreadInc,
        MaxSeq:        seq,
        CreatedAt:     now,
    }).Error

    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        log.Printf(<span class="hljs-string">"[StateServer] Failed to update session index owner=%s peer=%s: %v"</span>, ownerId, peerId, err)
    }
}
</code></pre>
<p>第一个函数是供上层调度的函数，决定谁的会话需要更新，其实就是分别更新发送者的会话，表示发送者给接收者发送了一条消息，并在外层会话界面内显示发送的最后一条消息，更新接收者的会话就是让会话表对应项的消息未读数+1，然后显示最后一条消息，如果是群聊，这里留了个 TODO ，实际逻辑应该是去查群成员表，然后循环调用 upsertSession 给几百个群成员都更新一遍，这里是因为还没重构群聊相关部分，因为这部分涉及到超大群优化，留到后面重构。</p>
<p><code>upsertSession</code>负责执行具体的数据库操作，首先尝试往Session表里插入一行新数据，如果A和B从来每聊过天，这行就会插入成功，创建一个新会话。如果数据库里已经有一行 uuid 相同的记录，就执行更新操作，更新最新消息预览，更新事件，更新未读消息数量，更新会话内最新消息Seq。</p>
<h3 data-id="heading-1">总结</h3>
<p>现在我们来梳理一下重构项目前后消息发送和查询的逻辑变化。</p>
<p>之前的消息发送逻辑是，客户端通过WebSocket发送消息，服务端通过<code>c.Conn.ReadMessage()</code>读取数据，直接塞入一个全局的Chan或者消息队列，服务端的主循环从Chan或者消息队列中取出消息，然后调用如下函数落库：</p>
<pre><code class="hljs language-go" lang="go">message := model.Message{
    Uuid:       fmt.Sprintf(<span class="hljs-string">"M%s"</span>, random.GetNowAndLenRandomString(<span class="hljs-number">11</span>)),
    SessionId:  chatMessageReq.SessionId,
    Type:       chatMessageReq.Type,
    Content:    chatMessageReq.Content,
    Url:        chatMessageReq.Url,
    SendId:     chatMessageReq.SendId,
    SendName:   chatMessageReq.SendName,
    SendAvatar: chatMessageReq.SendAvatar,
    ReceiveId:  chatMessageReq.ReceiveId,
    FileSize:   chatMessageReq.FileSize,
    FileType:   chatMessageReq.FileType,
    FileName:   chatMessageReq.FileName,
    Status:     message_status_enum.Unsent,
    CreatedAt:  time.Now(),
}
</code></pre>
<p>虽然插入消息时给SessionID字段赋值了，但是这个SessionID没有被使用，因为后面的查询代码并没有使用SessionID进行查询，而且这个SessionID是直接从前端传过来的请求参数里取的，此时前端传的SessionID存的值实际上还是接收者ID，这就导致在数据库中，A和B的聊天记录依然不可以通过会话查询。</p>
<p>此时也没有Seq的概念，纯粹是把一条记录插入数据库。然后就走到消息分发的逻辑了，这部分也很暴力，就是判断<code>ReceiveID</code>是用户ID还是群ID，如果是用户ID的话就直接查Map找到对应的客户端句柄发送过去就好了，如果是群聊的话就要先从数据库中查出群成员列表，同样在Map中找到所有对应的客户端句柄，排除自己，然后发送就好。</p>
<p>下面是查询历史消息的流程，之前查询单聊消息时使用的Sql是：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> message 
<span class="hljs-keyword">WHERE</span> (send_id <span class="hljs-operator">=</span> <span class="hljs-string">'A'</span> <span class="hljs-keyword">AND</span> receive_id <span class="hljs-operator">=</span> <span class="hljs-string">'B'</span>) 
   <span class="hljs-keyword">OR</span> (send_id <span class="hljs-operator">=</span> <span class="hljs-string">'B'</span> <span class="hljs-keyword">AND</span> receive_id <span class="hljs-operator">=</span> <span class="hljs-string">'A'</span>)  
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> created_at <span class="hljs-keyword">ASC</span>

<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> message 
<span class="hljs-keyword">WHERE</span> receive_id <span class="hljs-operator">=</span> <span class="hljs-string">'G'</span> 
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> created_at <span class="hljs-keyword">ASC</span>
</code></pre>
<p>上面是单聊查询，下面是群聊查询。在单聊查询场景中，因为没有统一的会话ID，系统只能去数据库里把“A说的话”和“B说的话”分别捞出来，然后按时间戳硬排在一起，假装它们是一个会话。由于在消息表中<code>send_id</code>和<code>receive_id</code>都建立了索引，所以其实还是会走索引查询然后再merge到一起，但还是效率低，因为二级索引需要回表，而且Merge的时候需要排序去重，有CPU和内存开销。群聊消息的查询就更加简单，因为所有发给群的消息，<code>receive_id</code>都是群ID，所以直接在消息表中查这个字段就可以。</p>
<p>之前架构的消息存储和转发相当低效，OR 查询虽然能命中 send_id 和 receive_id 的二级索引，但会导致两次索引扫描 和 大量回表，数据库必须将两部分结果集加载到内存中，根据created_at进行排序，当消息量达到百万级时，这种即时计算的排序开销会让数据库 CPU 飙升，响应延迟从毫秒级劣化到秒级。</p>
<p>而且在会话内查询相当暴力，在查询到消息之后，完全依赖时间戳进行排序，但是这在分布式系统中是大忌，因为时钟偏移是不可避免地，每台服务器上的时钟可能不同步，而且可能会产生时钟回拨，这样的话就无法通过时间去体现消息的因果顺序了。并且使用created_at实现增量同步很复杂，如果服务端NTP校准导致时钟回拨，新消息的时间戳可能比客户端记录的还小，导致永久漏拉消息，即使时间准确，在高并发下同一毫秒内可能存在多条消息，客户端若使用 &gt; time 查询会漏掉同毫秒的其他消息，若使用 &gt;= time 查询则需要处理大量重复数据，逻辑脆弱且不可靠。相比之下，使用严格单调递增的Seq（逻辑时钟）能彻底避免这些问题，实现精准、高效的断点续传。</p>
<p>现在我们来看优化之后的消息架构，message表中通过(session_id, seq) 这个联合索引来定位数据。此时当客户端需要拉取某个会话的增量消息时，服务端执行 SQL<code>SELECT * FROM message WHERE session_id = 'S_A_B' AND seq &gt; 100 ORDER BY seq ASC</code>，由于联合索引的存在，数据库引擎可以直接定位到 (S_A_B, 100) 这个索引节点，然后沿着 B+ 树叶子节点顺序向后读取即可。这种操作是纯粹的顺序 IO ，效率远高于之前的全表扫描 + 内存排序。而且Seq是严格递增的整数，这意味着我们不再需要依赖不可靠的 created_at 时间戳来排序。无论系统时钟是否回拨，无论并发有多高，只要 Seq 是 101，它就一定排在 100 后面，就可以做强因果保证。</p>
<p>上面说的是消息表，我们还增加了Session表，这个表存储的是每个人自己的会话信息，比如说A看到一个会话的最后一条消息是“hello”，未读消息数有3条，对这个会话的备注名是B，这样类似的信息。该表采用收件箱模式设计，为每个用户维护一份独立的会话视图（包含 OwnerID 、 UnreadCount 、 MaxSeq 和 LastMessage ），读取会话时，用户只需查询自己的私有索引表，即可 O(1) 复杂度瞬间获取带有红点和最新消息预览的完整列表，彻底解决了旧架构中拉取列表需要全表扫描聚合的性能瓶颈。</p>
<p>引入Session表之后查询变得高效，客户端首先查询Session表，瞬间渲染出首页会话列表，当用户点进某个会话时，客户端携带 SessionID 和本地记录的 LocalMaxSeq ，直接去 Message 表执行范围查询（ WHERE session_id = ? AND seq &gt; LocalMaxSeq ），这种基于联合索引的单索引扫描 ，不仅查询速度极快，而且利用 Seq 的单调递增特性，彻底解决了并发场景下的消息乱序和时钟回拨导致的数据丢失问题。</p>
<h2 data-id="heading-2">下行消息链路</h2>
<p>之前我们介绍了采用推拉结合的方式实现下行消息的可靠性，我们先完善下行消息的协议，要在<code>MESSAGEDOWN</code>信令中新增会话ID和Seq。</p>
<pre><code class="hljs language-protobuf" lang="protobuf">message MessageDown {
    string uuid = 1; // 消息唯一ID
    int32 type = 2; // 消息类型 (文本/图片等)
    string content = 3; // 消息内容
    string receiver_id = 4; // 接收者ID (群聊则是群ID)
    int64 seq = 5; // 会话内序号
    string session_id = 6; // 会话ID
    string sender_id = 7; // 发送者ID
}
</code></pre>
<p>服务端只负责找到对应客户端并且推送下行消息，客户端检查序列号是否连续，如果不连续的话就会发起Pull请求主动拉取数据。客户端还需要维护一个Message表和Session表，其中Message表存储历史聊天消息，具体的聊天内容，Session表就存储会话的元数据，比如说客户端的local_seq，会话备注，未读数和最后一条消息。</p>
<p>首先来看客户端下行消息可靠性的代码，客户端解析消息信令之后发现是<code>CommandType_MESSAGEDOWN</code>就会路由到下行消息处理函数。</p>
<pre><code class="hljs language-go" lang="go">localMsg := &amp;LocalMessage{
    UUID:       down.Uuid,
    SessionID:  down.SessionId,
    Seq:        down.Seq,
    SenderID:   down.SenderId,
    ReceiverID: down.ReceiverId,
    Content:    down.Content,
    Type:       down.Type,
}
</code></pre>
<p>首先就是通过服务端发送的下行消息构造本地消息，分别落库和进行Seq比较，然后就走到下面这个函数了。</p>
<pre><code class="hljs language-go" lang="go">cdb.SaveMessage(localMsg)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(cdb *ClientDB)</span></span> SaveMessage(msg *LocalMessage) (<span class="hljs-type">bool</span>, <span class="hljs-type">int64</span>, <span class="hljs-type">int64</span>, <span class="hljs-type">error</span>) {
	cdb.mu.Lock()
	<span class="hljs-keyword">defer</span> cdb.mu.Unlock()

	<span class="hljs-keyword">var</span> isGap <span class="hljs-type">bool</span>
	<span class="hljs-keyword">var</span> gapStart, gapEnd <span class="hljs-type">int64</span>

	err := cdb.db.Transaction(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(tx *gorm.DB)</span></span> <span class="hljs-type">error</span> {
		<span class="hljs-keyword">var</span> sess Session
		<span class="hljs-keyword">if</span> err := tx.Where(<span class="hljs-string">"session_id = ?"</span>, msg.SessionID).First(&amp;sess).Error; err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">if</span> err != gorm.ErrRecordNotFound {
				<span class="hljs-keyword">return</span> err
			}
			sess.SessionID = msg.SessionID
		}

		<span class="hljs-keyword">if</span> msg.Seq &lt;= sess.LastSeq {
			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
		}

		<span class="hljs-keyword">if</span> msg.Seq &gt; sess.LastSeq+<span class="hljs-number">1</span> {
			isGap = <span class="hljs-literal">true</span>
			gapStart = sess.LastSeq + <span class="hljs-number">1</span>
			gapEnd = msg.Seq - <span class="hljs-number">1</span>
			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
		}

		<span class="hljs-keyword">if</span> err := tx.Clauses(clause.OnConflict{
			Columns:   []clause.Column{{Name: <span class="hljs-string">"session_id"</span>}, {Name: <span class="hljs-string">"seq"</span>}},
			DoNothing: <span class="hljs-literal">true</span>,
		}).Create(msg).Error; err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">return</span> err
		}

		sess.LastSeq = msg.Seq
		sess.UnreadCount++
		<span class="hljs-keyword">if</span> err := tx.Clauses(clause.OnConflict{
			Columns:   []clause.Column{{Name: <span class="hljs-string">"session_id"</span>}},
			DoUpdates: clause.AssignmentColumns([]<span class="hljs-type">string</span>{<span class="hljs-string">"last_seq"</span>, <span class="hljs-string">"max_seq"</span>, <span class="hljs-string">"unread_count"</span>, <span class="hljs-string">"updated_at"</span>}),
		}).Create(&amp;sess).Error; err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">return</span> err
		}

		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	})

	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, err
	}
	<span class="hljs-keyword">return</span> isGap, gapStart, gapEnd, <span class="hljs-literal">nil</span>
}
</code></pre>
<p>首先查询出消息所属会话，然后就知道了会话的lastSeq，该会话本地已存储的最大序号。如果发现<code>msg.Seq &lt;= sess.LastSeq</code>的话就代表是重复消息，已经存储过了。如果是<code>msg.Seq &gt; sess.LastSeq+1</code>表示有消息漏洞，需要客户端发起Pull请求去拉取消息，看是否是真的有漏洞。如果都不是的话就代表正好是客户端期待的消息序号，此时直接落库即可。</p>
<p>如果客户端调用这个函数时发现有漏洞时，就会主动发起消息补洞请求：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">if</span> isGap {
    fmt.Printf(<span class="hljs-string">"GAP DETECTED: %s missing %d-%d\n"</span>, down.SessionId, gapStart, gapEnd)

    syncCmd := &amp;protocol.SyncCommand{
        SessionId: down.SessionId,
        StartSeq:  gapStart - <span class="hljs-number">1</span>,
        EndSeq:    down.Seq,
        Limit:     <span class="hljs-number">100</span>,
    }
    syncBytes, _ := proto.Marshal(syncCmd)
    env := &amp;protocol.Command{
        Type: protocol.CommandType_SYNC,
        Data: syncBytes,
    }
    envBytes, _ := proto.Marshal(env)
    <span class="hljs-keyword">if</span> err := wsutil.WriteClientBinary(conn, envBytes); err != <span class="hljs-literal">nil</span> {
        log.Printf(<span class="hljs-string">"send sync failed: %v"</span>, err)
    } <span class="hljs-keyword">else</span> {
        log.Printf(<span class="hljs-string">"Sent SYNC request for %s: %d-%d (blocking current msg %d)"</span>, down.SessionId, gapStart, down.Seq, down.Seq)
    }
}
</code></pre>
<p>同样，服务端收到消息补洞请求之后就会按照客户端要求的序列号在数据库中进行查询，然后将得到的消息进行发送。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Service)</span></span> handleSync(ctx context.Context, cmd *protocol.Command, req *pb.ReceiveMessageRequest) (*pb.ReceiveMessageResponse, <span class="hljs-type">error</span>) {
	<span class="hljs-keyword">var</span> syncCmd protocol.SyncCommand
	<span class="hljs-keyword">if</span> err := proto.Unmarshal(cmd.Data, &amp;syncCmd); err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
	}

	limit := <span class="hljs-type">int</span>(syncCmd.Limit)
	<span class="hljs-keyword">if</span> limit &lt;= <span class="hljs-number">0</span> || limit &gt; <span class="hljs-number">500</span> {
		limit = <span class="hljs-number">100</span>
	}

	msgs, err := s.store.GetMessagesBySeqRange(ctx, syncCmd.SessionId, syncCmd.StartSeq, syncCmd.EndSeq, limit)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Printf(<span class="hljs-string">"[StateServer] Sync failed: %v"</span>, err)
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
	}

	log.Printf(<span class="hljs-string">"[StateServer] Sync found %d messages"</span>, <span class="hljs-built_in">len</span>(msgs))

	<span class="hljs-keyword">for</span> _, m := <span class="hljs-keyword">range</span> msgs {
		down := &amp;protocol.MessageDown{
			Uuid:       m.Uuid,
			Type:       <span class="hljs-type">int32</span>(m.Type),
			Content:    m.Content,
			ReceiverId: m.ReceiveId,
			Seq:        m.Seq,
			SessionId:  m.SessionId,
			SenderId:   m.SendId,
		}
		downBytes, _ := proto.Marshal(down)
		downCmd := &amp;protocol.Command{
			Type: protocol.CommandType_MESSAGEDOWN,
			Data: downBytes,
		}
		downPayload, _ := proto.Marshal(downCmd)

		pushAddr, _ := s.rdb.Get(ctx, fmt.Sprintf(<span class="hljs-string">"UserID:%s"</span>, req.Uid)).Result()
		<span class="hljs-keyword">if</span> pushAddr != <span class="hljs-string">""</span> {
			client, err := s.getPushClient(pushAddr)
			<span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> {
				client.Push(ctx, &amp;pb.PushRequest{UserId: req.Uid, Payload: downPayload})
			}
		}
	}

	respCmd := &amp;protocol.Command{
		Type: protocol.CommandType_SYNC,
		Code: <span class="hljs-number">0</span>,
	}
	respBytes, _ := proto.Marshal(respCmd)

	<span class="hljs-keyword">return</span> &amp;pb.ReceiveMessageResponse{
		ResponsePayload: respBytes,
	}, <span class="hljs-literal">nil</span>
}
</code></pre>
<p>首先从通用的 <code>Command</code> 结构中提取出具体的 <code>SyncCommand</code>。这里面包含了客户端想要的 <code>SessionId</code> 以及缺失的消息区间（<code>StartSeq</code> 到 <code>EndSeq</code>），这里还进行了限流处理，强制限制单次同步的消息条数（最大 500 条），防止客户端恶意请求或超大范围查询拖垮数据库。</p>
<p>然后就是调用存储层根据序号区间抓取消息，获取到消息列表之后就把查出来的历史消息push给客户端，将历史消息封装进 <code>MESSAGEDOWN</code> 类型，客户端收到后，会再次调用你刚才那个 <code>SaveMessage</code> 函数，从而填补本地的空洞。最后就是告诉客户端处理已经完成。</p>
<p>到这里就已经完成了下行消息的可靠性，在线消息通过服务端直接Push给客户端，如果发现有消息漏洞的话客户端就去pull服务端的消息，此时下行消息是靠TCP和客户端主动拉取实现可靠性的。如果TCP连接不稳定，即在弱网环境下时，TCP连接断开，此时下行消息就丢失了，但是我们还是可以基于客户端的Pull请求实现消息可靠性，只需要保证每次建立连接或者客户端登录的时候都主动进行一次Pull请求拉取数据就好了，这样就算重建连接的话，还是可以根据客户端缺失的消息进行Pull请求拉取消息。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JDBC]]></title>    <link>https://juejin.cn/post/7603649945977978899</link>    <guid>https://juejin.cn/post/7603649945977978899</guid>    <pubDate>2026-02-07T11:29:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603649945977978899" data-draft-id="7603575399256358952" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JDBC"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-07T11:29:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="code_YuJun"/> <meta itemprop="url" content="https://juejin.cn/user/3615612462441358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JDBC
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3615612462441358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    code_YuJun
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-07T11:29:57.000Z" title="Sat Feb 07 2026 11:29:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读31分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概念</h2>
<ul>
<li>JDBC：Java Database Connectivity，意为Java数据库连接。</li>
<li>JDBC是Java提供的一组独立于任何数据库管理系统的API。</li>
<li>Java提供接口规范，由各个数据库厂商提供接口的实现，厂商提供的实现类封装成 jar 文件，也就是我们俗称的数据库驱动 jar 包。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c4dd77acb744b4887858c9c14ba04cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZV9ZdUp1bg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771068598&amp;x-signature=FVZTJmbXgH5hbrnRl2fdx69AnTA%3D" alt="image-20240221134431944.png" loading="lazy"/></li>
</ul>
<h2 data-id="heading-1">JDBC的核心组成</h2>
<ul>
<li>接口规范：
<ul>
<li>为了项目代码的可移植性，可维护性，SUN公司从最初就制定了Java程序连接各种数据库的统一接口规范。这样的话，不管是连接哪一种DBMS软件，Java代码可以保持一致性。</li>
<li>接口存储在java.sql和javax.sql包下。</li>
</ul>
</li>
<li>实现规范：
<ul>
<li>因为各个数据库厂商的DBMS软件各有不同，那么各自的内部如何通过SQL实现增、删、改、查等操作管理数据，只有这个数据库厂商自己更清楚，因此把接口规范的实现交给各个数据库厂商自己实现。</li>
<li>厂商将实现内容和过程封装成jar文件，我们程序员只需要将jar文件引入到项目中集成即可，就可以开发调用实现过程操作数据库了。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-2">JDBC搭建步骤</h2>
<ol>
<li>准备数据库。</li>
<li>官网下载数据库连接驱动jar包。<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">downloads.mysql.com/archives/c-…</a></li>
<li>创建Java项目，在项目下创建lib文件夹，将下载的驱动jar包复制到文件夹里。</li>
<li>选中lib文件夹右键-&gt;Add as Library(添加为库)，与项目集成。</li>
<li>编写代码</li>
</ol>
<h2 data-id="heading-3">代码实现</h2>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> DATABASE atguigu;

use atguigu;

<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t_emp
(
    emp_id     <span class="hljs-type">int</span> auto_increment comment <span class="hljs-string">'员工编号'</span> <span class="hljs-keyword">primary</span> key,
    emp_name   <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>)  <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">'员工姓名'</span>,
    emp_salary <span class="hljs-keyword">double</span>(<span class="hljs-number">10</span>, <span class="hljs-number">5</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">'员工薪资'</span>,
    emp_age    <span class="hljs-type">int</span>           <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">'员工年龄'</span>
);

<span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t_emp (emp_name,emp_salary,emp_age)
<span class="hljs-keyword">values</span>  (<span class="hljs-string">'andy'</span>, <span class="hljs-number">777.77</span>, <span class="hljs-number">32</span>),
        (<span class="hljs-string">'大风哥'</span>, <span class="hljs-number">666.66</span>, <span class="hljs-number">41</span>),
        (<span class="hljs-string">'康师傅'</span>,<span class="hljs-number">111</span>, <span class="hljs-number">23</span>),
        (<span class="hljs-string">'Gavin'</span>,<span class="hljs-number">123</span>, <span class="hljs-number">26</span>),
        (<span class="hljs-string">'小鱼儿'</span>, <span class="hljs-number">123</span>, <span class="hljs-number">28</span>);
</code></pre>
<h3 data-id="heading-4">Java代码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.atguigu.base;

<span class="hljs-keyword">import</span> java.sql.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdbcQuick</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, SQLException {
        <span class="hljs-comment">//1.注册驱动</span>
        Class.forName(<span class="hljs-string">"com.mysql.cj.jdbc.Driver"</span>);

        <span class="hljs-comment">//2.获取数据库连接</span>
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> DriverManager.getConnection(<span class="hljs-string">"jdbc:mysql://localhost:3306/atguigu"</span>, <span class="hljs-string">"root"</span>, <span class="hljs-string">"2594131385"</span>);

        <span class="hljs-comment">//3.创建Statement对象</span>
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">preparedStatement</span> <span class="hljs-operator">=</span> connection.prepareStatement(<span class="hljs-string">"select emp_id,emp_name,emp_salary,emp_age from t_emp"</span>);

        <span class="hljs-comment">//4.编写SQL语句并执行，获取结果集合</span>
        <span class="hljs-type">ResultSet</span> <span class="hljs-variable">resultSet</span> <span class="hljs-operator">=</span> preparedStatement.executeQuery();

        <span class="hljs-comment">//5.处理结果</span>
        <span class="hljs-keyword">while</span> (resultSet.next()) {
            <span class="hljs-type">int</span> <span class="hljs-variable">empId</span> <span class="hljs-operator">=</span> resultSet.getInt(<span class="hljs-string">"emp_id"</span>);
            <span class="hljs-type">String</span> <span class="hljs-variable">empName</span> <span class="hljs-operator">=</span> resultSet.getString(<span class="hljs-string">"emp_name"</span>);
            <span class="hljs-type">String</span> <span class="hljs-variable">empSalary</span> <span class="hljs-operator">=</span> resultSet.getString(<span class="hljs-string">"emp_salary"</span>);
            <span class="hljs-type">int</span> <span class="hljs-variable">empAge</span> <span class="hljs-operator">=</span> resultSet.getInt(<span class="hljs-string">"emp_age"</span>);
            System.out.println(empId + <span class="hljs-string">"\t"</span> + empName + <span class="hljs-string">"\t"</span> + empSalary + <span class="hljs-string">"\t"</span> + empAge);
        }

        <span class="hljs-comment">//6.释放资源(先开后关原则)</span>
        resultSet.close();
        preparedStatement.close();
        connection.close();
    }
}
</code></pre>
<h2 data-id="heading-5">核心API</h2>
<h3 data-id="heading-6">注册驱动</h3>
<p><code>Class.forName("com.mysql.cj.jdbc.Driver");</code></p>
<ul>
<li>当使用 JDBC 连接数据库时，需要加载数据库特定的驱动程序，以便与数据库进行通信。<strong>加载驱动程序的目的是为了注册驱动程序</strong>，使得 JDBC API 能够识别并与特定的数据库进行交互。<br/>
在驱动包下：com.mysql.cj.jdbc.Driver</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.mysql.cj.jdbc;

<span class="hljs-keyword">import</span> java.sql.DriverManager;
<span class="hljs-keyword">import</span> java.sql.SQLException;

<span class="hljs-comment">// 实现了 java 中的接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Driver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">NonRegisteringDriver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">java</span>.sql.Driver {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Driver</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
    }
    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 注册一个（驱动类的对象）</span>
            DriverManager.registerDriver(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Driver</span>());
        } <span class="hljs-keyword">catch</span> (SQLException var1) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Can't register driver!"</span>);
        }
    }
}
</code></pre>
<h3 data-id="heading-7">Connection</h3>
<ul>
<li>Connection 用于建立与数据库的通信通道。Connection对象不为空，则代表一次数据库连接。</li>
<li>在建立连接时，需要指定数据库URL、用户名、密码参数。</li>
<li><code>Connection</code> 接口还负责管理事务，<code>Connection</code> 接口提供了 <code>commit</code> 和 <code>rollback</code> 方法，用于提交事务和回滚事务。</li>
<li>可以创建 <code>Statement</code> 对象，用于执行 SQL 语句并与数据库进行交互。</li>
<li>在使用JDBC技术时，必须要先获取Connection对象，在使用完毕后，要释放资源，避免资源占用浪费及泄漏。</li>
</ul>
<h3 data-id="heading-8">Statement</h3>
<ul>
<li><code>Statement</code> 接口用于执行 SQL 语句并与数据库进行交互。</li>
<li>结果可以是一个或多个结果。
<ul>
<li>增删改：受影响行数单个结果。</li>
<li>查询：单行单列、多行多列、单行多列等结果。</li>
</ul>
</li>
<li><code>Statement</code> 接口在执行SQL语句时，会产生<code>SQL注入攻击问题</code>:
<ul>
<li>当使用 <code>Statement</code> 执行动态构建的 SQL 查询时(有查询条件)，往往需要将查询条件与 SQL 语句拼接在一起，直接将参数和SQL语句一并生成，让SQL的查询条件始终为true得到结果。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-java" lang="java">System.out.println(<span class="hljs-string">"请输入员工姓名："</span>)；
<span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(System. in);
<span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> scanner. nextline();
<span class="hljs-comment">// 编写SQL语句，并执行，接受返回的结果</span>
<span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT emp_id, emp_name, emp_salary, emp_age FROM t_emp WHERE emp_name = '"</span>+name+<span class="hljs-string">""</span>;

<span class="hljs-type">ResultSet</span> <span class="hljs-variable">resultSet</span> <span class="hljs-operator">=</span> statement.executeQuery(sql);

<span class="hljs-comment">// 处理结果：遍历resultSet</span>
<span class="hljs-keyword">while</span>(resultSet.next()){
    <span class="hljs-type">int</span> <span class="hljs-variable">empId</span> <span class="hljs-operator">=</span> resultSet. getInt( columnLabel: <span class="hljs-string">"emp_id"</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">empName</span> <span class="hljs-operator">=</span> resultSet. getString( columnLabel: <span class="hljs-string">"emp_name"</span>);
    <span class="hljs-type">double</span> <span class="hljs-variable">empSalary</span> <span class="hljs-operator">=</span> resultSet. getDouble( columnLabel: <span class="hljs-string">"emp_salary"</span>);
    <span class="hljs-type">int</span> <span class="hljs-variable">empAge</span> <span class="hljs-operator">=</span> resultSet. getInt( columnLabel: <span class="hljs-string">"emp_age"</span>);
    System.out.println(empId+<span class="hljs-string">"\t"</span>+empName+<span class="hljs-string">"\t"</span>+empSalary+<span class="hljs-string">"\t"</span>+empAge);
    
<span class="hljs-comment">// 当输入 abc' or '1' = '1 时，就会把所有内容查出来。因为 '1' = '1'始终为 true</span>
</code></pre>
<h3 data-id="heading-9">PreparedStatement</h3>
<ul>
<li><code>PreparedStatement</code>是 <code>Statement</code> 接口的子接口，用于执行<code>预编译</code>的 SQL 查询，作用如下：
<ul>
<li>预编译SQL语句：在创建PreparedStatement时，就会预编译SQL语句，也就是SQL语句已经固定。</li>
<li>防止SQL注入：<code>PreparedStatement</code> 支持参数化查询，将数据作为参数传递到SQL语句中，采用?占位符的方式，将传入的参数用一对单引号包裹起来''，无论传递什么都作为值。有效防止传入关键字或值导致SQL注入问题。</li>
<li>性能提升：PreparedStatement是预编译SQL语句，同一SQL语句多次执行的情况下，可以复用，不必每次重新编译和解析。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-10">ResultSet</h3>
<ul>
<li><code>ResultSet</code>是 JDBC API 中的一个接口，用于表示从数据库中<code>执行查询语句所返回的结果集</code>。它提供了一种用于遍历和访问查询结果的方式。</li>
<li>遍历结果：ResultSet可以使用 <code>next()</code> 方法将游标移动到结果集的下一行，逐行遍历数据库查询的结果，返回值为boolean类型，true代表有下一行结果，false则代表没有。</li>
<li>获取单列结果：可以通过getXxx的方法获取单列的数据，该方法为重载方法，支持索引和列名进行获取。</li>
</ul>
<h2 data-id="heading-11">基于PreparedStatement实现CRUD</h2>
<h3 data-id="heading-12">查询单行单列</h3>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">querySingleRowAndColumn</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">//1.注册驱动</span>
<span class="hljs-comment">//        Class.forName("com.mysql.cj.jdbc.Driver");</span>

        <span class="hljs-comment">//2.获取数据库连接</span>
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> DriverManager.getConnection(<span class="hljs-string">"jdbc:mysql://localhost:3306/atguigu"</span>, <span class="hljs-string">"root"</span>,<span class="hljs-string">"atguigu"</span>);

        <span class="hljs-comment">//3.创建PreparedStatement对象，并预编译SQL语句</span>
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">preparedStatement</span> <span class="hljs-operator">=</span> connection.prepareStatement(<span class="hljs-string">"select count(*) as count from t_emp"</span>);

        <span class="hljs-comment">//4.执行SQL语句，获取结果</span>
        <span class="hljs-type">ResultSet</span> <span class="hljs-variable">resultSet</span> <span class="hljs-operator">=</span> preparedStatement.executeQuery();

        <span class="hljs-comment">//5.处理结果</span>
        <span class="hljs-keyword">while</span> (resultSet.next()){
            <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> resultSet.getInt(<span class="hljs-string">"count"</span>);
            System.out.println(<span class="hljs-string">"count = "</span> + count);
        }

        <span class="hljs-comment">//6.释放资源(先开后关原则)</span>
        resultSet.close();
        preparedStatement.close();
        connection.close();

    }
</code></pre>
<h3 data-id="heading-13">查询单行多列</h3>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">querySingleRow</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">//1.注册驱动</span>
<span class="hljs-comment">//        Class.forName("com.mysql.cj.jdbc.Driver");</span>

        <span class="hljs-comment">//2.获取数据库连接</span>
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> DriverManager.getConnection(<span class="hljs-string">"jdbc:mysql://localhost:3306/atguigu"</span>,<span class="hljs-string">"root"</span>,<span class="hljs-string">"atguigu"</span>);

        <span class="hljs-comment">//3.创建PreparedStatement对象，并预编译SQL语句，使用?占位符</span>
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">preparedStatement</span> <span class="hljs-operator">=</span> connection.prepareStatement(<span class="hljs-string">"select emp_id,emp_name,emp_salary,emp_age from t_emp where emp_id = ?"</span>);

        <span class="hljs-comment">//4.为占位符赋值，索引从1开始，执行SQL语句，获取结果</span>
        preparedStatement.setInt(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);
        <span class="hljs-type">ResultSet</span> <span class="hljs-variable">resultSet</span> <span class="hljs-operator">=</span> preparedStatement.executeQuery();

        <span class="hljs-comment">//5.处理结果</span>
        <span class="hljs-keyword">while</span> (resultSet.next()){
            <span class="hljs-type">int</span> <span class="hljs-variable">empId</span> <span class="hljs-operator">=</span> resultSet.getInt(<span class="hljs-string">"emp_id"</span>);
            <span class="hljs-type">String</span> <span class="hljs-variable">empName</span> <span class="hljs-operator">=</span> resultSet.getString(<span class="hljs-string">"emp_name"</span>);
            <span class="hljs-type">String</span> <span class="hljs-variable">empSalary</span> <span class="hljs-operator">=</span> resultSet.getString(<span class="hljs-string">"emp_salary"</span>);
            <span class="hljs-type">int</span> <span class="hljs-variable">empAge</span> <span class="hljs-operator">=</span> resultSet.getInt(<span class="hljs-string">"emp_age"</span>);
            System.out.println(empId+<span class="hljs-string">"\t"</span>+empName+<span class="hljs-string">"\t"</span>+empSalary+<span class="hljs-string">"\t"</span>+empAge);
        }

        <span class="hljs-comment">//6.释放资源(先开后关原则)</span>
        resultSet.close();
        preparedStatement.close();
        connection.close();

    }
</code></pre>
<h3 data-id="heading-14">查询多行多列</h3>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">queryMoreRow</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">//1.注册驱动</span>
<span class="hljs-comment">//        Class.forName("com.mysql.cj.jdbc.Driver");</span>

        <span class="hljs-comment">//2.获取数据库连接</span>
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> DriverManager.getConnection(<span class="hljs-string">"jdbc:mysql://localhost:3306/atguigu"</span>,<span class="hljs-string">"root"</span>,<span class="hljs-string">"atguigu"</span>);

        <span class="hljs-comment">//3.创建Statement对象</span>
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">preparedStatement</span> <span class="hljs-operator">=</span> connection.prepareStatement(<span class="hljs-string">"select emp_id,emp_name,emp_salary,emp_age from t_emp"</span>);

        <span class="hljs-comment">//4.编写SQL语句并执行，获取结果</span>
        <span class="hljs-type">ResultSet</span> <span class="hljs-variable">resultSet</span> <span class="hljs-operator">=</span> preparedStatement.executeQuery();


        <span class="hljs-comment">//5.处理结果</span>
        <span class="hljs-keyword">while</span> (resultSet.next()){
            <span class="hljs-type">int</span> <span class="hljs-variable">empId</span> <span class="hljs-operator">=</span> resultSet.getInt(<span class="hljs-string">"emp_id"</span>);
            <span class="hljs-type">String</span> <span class="hljs-variable">empName</span> <span class="hljs-operator">=</span> resultSet.getString(<span class="hljs-string">"emp_name"</span>);
            <span class="hljs-type">String</span> <span class="hljs-variable">empSalary</span> <span class="hljs-operator">=</span> resultSet.getString(<span class="hljs-string">"emp_salary"</span>);
            <span class="hljs-type">int</span> <span class="hljs-variable">empAge</span> <span class="hljs-operator">=</span> resultSet.getInt(<span class="hljs-string">"emp_age"</span>);
            System.out.println(empId+<span class="hljs-string">"\t"</span>+empName+<span class="hljs-string">"\t"</span>+empSalary+<span class="hljs-string">"\t"</span>+empAge);
        }

        <span class="hljs-comment">//6.释放资源(先开后关原则)</span>
        resultSet.close();
        preparedStatement.close();
        connection.close();

    }
</code></pre>
<h3 data-id="heading-15">新增</h3>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">//1.注册驱动</span>
<span class="hljs-comment">//        Class.forName("com.mysql.cj.jdbc.Driver");</span>

        <span class="hljs-comment">//2.获取数据库连接</span>
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> DriverManager.getConnection(<span class="hljs-string">"jdbc:mysql://localhost:3306/atguigu"</span>,<span class="hljs-string">"root"</span>, <span class="hljs-string">"atguigu"</span>);

        <span class="hljs-comment">//3.创建Statement对象</span>
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">preparedStatement</span> <span class="hljs-operator">=</span> connection.prepareStatement(<span class="hljs-string">"insert into t_emp (emp_name,emp_salary,emp_age)values  (?, ?,?)"</span>);

        <span class="hljs-comment">//4.为占位符赋值，索引从1开始，编写SQL语句并执行，获取结果</span>
        preparedStatement.setString(<span class="hljs-number">1</span>,<span class="hljs-string">"rose"</span>);
        preparedStatement.setDouble(<span class="hljs-number">2</span>,<span class="hljs-number">666.66</span>);
        preparedStatement.setDouble(<span class="hljs-number">3</span>,<span class="hljs-number">28</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> preparedStatement.executeUpdate();

        <span class="hljs-comment">//5.处理结果</span>
        <span class="hljs-keyword">if</span>(result&gt;<span class="hljs-number">0</span>){
            System.out.println(<span class="hljs-string">"添加成功"</span>);
        }<span class="hljs-keyword">else</span>{
            System.out.println(<span class="hljs-string">"添加失败"</span>);
        }

        <span class="hljs-comment">//6.释放资源(先开后关原则)</span>
        preparedStatement.close();
        connection.close();

    }
</code></pre>
<h3 data-id="heading-16">修改</h3>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">//1.注册驱动</span>
<span class="hljs-comment">//        Class.forName("com.mysql.cj.jdbc.Driver");</span>

        <span class="hljs-comment">//2.获取数据库连接</span>
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> DriverManager.getConnection(<span class="hljs-string">"jdbc:mysql://localhost:3306/atguigu"</span>, <span class="hljs-string">"root"</span>, <span class="hljs-string">"atguigu"</span>);

        <span class="hljs-comment">//3.创建Statement对象</span>
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">preparedStatement</span> <span class="hljs-operator">=</span> connection.prepareStatement(<span class="hljs-string">"update t_emp set emp_salary = ? where emp_id = ?"</span>);

        <span class="hljs-comment">//4.为占位符赋值，索引从1开始，编写SQL语句并执行，获取结果</span>
        preparedStatement.setDouble(<span class="hljs-number">1</span>,<span class="hljs-number">888.88</span>);
        preparedStatement.setDouble(<span class="hljs-number">2</span>,<span class="hljs-number">8</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> preparedStatement.executeUpdate();

        <span class="hljs-comment">//5.处理结果</span>
        <span class="hljs-keyword">if</span>(result&gt;<span class="hljs-number">0</span>){
            System.out.println(<span class="hljs-string">"修改成功"</span>);
        }<span class="hljs-keyword">else</span>{
            System.out.println(<span class="hljs-string">"修改失败"</span>);
        }

        <span class="hljs-comment">//6.释放资源(先开后关原则)</span>
        preparedStatement.close();
        connection.close();

    }
</code></pre>
<h3 data-id="heading-17">删除</h3>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">//1.注册驱动</span>
<span class="hljs-comment">//        Class.forName("com.mysql.cj.jdbc.Driver");</span>

        <span class="hljs-comment">//2.获取数据库连接</span>
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> DriverManager.getConnection(<span class="hljs-string">"jdbc:mysql://localhost:3306/atguigu"</span>, <span class="hljs-string">"root"</span>, <span class="hljs-string">"atguigu"</span>);

        <span class="hljs-comment">//3.创建Statement对象</span>
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">preparedStatement</span> <span class="hljs-operator">=</span> connection.prepareStatement(<span class="hljs-string">"delete from t_emp where emp_id = ?"</span>);

        <span class="hljs-comment">//4.为占位符赋值，索引从1开始，编写SQL语句并执行，获取结果</span>
        preparedStatement.setInt(<span class="hljs-number">1</span>,<span class="hljs-number">8</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> preparedStatement.executeUpdate();

        <span class="hljs-comment">//5.处理结果</span>
        <span class="hljs-keyword">if</span>(result&gt;<span class="hljs-number">0</span>){
            System.out.println(<span class="hljs-string">"删除成功"</span>);
        }<span class="hljs-keyword">else</span>{
            System.out.println(<span class="hljs-string">"删除失败"</span>);
        }

        <span class="hljs-comment">//6.释放资源(先开后关原则)</span>
        preparedStatement.close();
        connection.close();

    }
</code></pre>
<h3 data-id="heading-18">六、常见问题</h3>
<h4 data-id="heading-19">6.1 资源的管理</h4>
<blockquote>
<p>在使用JDBC的相关资源时，比如Connection、PreparedStatement、ResultSet，使用完毕后，要及时关闭这些资源以释放数据库服务器资源和避免内存泄漏是很重要的。</p>
</blockquote>
<h4 data-id="heading-20">6.2 SQL语句问题</h4>
<blockquote>
<p>java.sql.SQLSyntaxErrorException：SQL语句错误异常，一般有几种可能：</p>
<ol>
<li>SQL语句有错误，检查SQL语句！建议SQL语句在SQL工具中测试后再复制到Java程序中！</li>
<li>连接数据库的URL中，数据库名称编写错误，也会报该异常！</li>
</ol>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20JDBC.assets/image-20240223143826507.png" alt="image-20240223143826507转存失败，建议直接上传图片文件" loading="lazy"/></p>
</blockquote>
<h4 data-id="heading-21">6.3 SQL语句未设置参数问题</h4>
<blockquote>
<p>java.sql.SQLException：No value specified for parameter 1</p>
<p>在使用预编译SQL语句时，如果有?占位符，要为每一个占位符赋值，否则报该错误！</p>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20JDBC.assets/image-20240223143947558.png" alt="image-20240223143947558转存失败，建议直接上传图片文件" loading="lazy"/></p>
</blockquote>
<h4 data-id="heading-22">6.4 用户名或密码错误问题</h4>
<blockquote>
<p>连接数据库时，如果用户名或密码输入错误，也会报SQLException，容易混淆！所以一定要看清楚异常后面的原因描述</p>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20JDBC.assets/image-20240223144345939.png" alt="image-20240223144345939转存失败，建议直接上传图片文件" loading="lazy"/></p>
</blockquote>
<h4 data-id="heading-23">6.5 通信异常</h4>
<blockquote>
<p>在连接数据库的URL中，如果IP或端口写错了，会报如下异常：</p>
<p>com.mysql.cj.jdbc.exceptions.CommunicationsException: Communications link failure</p>
<p><img alt="image-20240227234754309转存失败，建议直接上传图片文件" src="" loading="lazy"/></p>
</blockquote>
<h2 data-id="heading-24">JDBC扩展</h2>
<h4 data-id="heading-25">7.1 实体类和ORM</h4>
<blockquote>
<ul>
<li>在使用JDBC操作数据库时，我们会发现数据都是零散的，明明在数据库中是一行完整的数据，到了Java中变成了一个一个的变量，不利于维护和管理。而我们Java是面向对象的，一个表对应的是一个类，一行数据就对应的是Java中的一个对象，一个列对应的是对象的属性，所以我们要把数据存储在一个载体里，这个载体就是实体类！</li>
<li>ORM（Object Relational Mapping）思想，<strong>对象到关系数据库的映射</strong>，作用是在编程中，把面向对象的概念跟数据库中表的概念对应起来，以面向对象的角度操作数据库中的数据，即一张表对应一个类，一行数据对应一个对象，一个列对应一个属性！</li>
<li>当下JDBC中这种过程我们称其为手动ORM。后续我们也会学习ORM框架，比如MyBatis、JPA等。</li>
</ul>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.atguigu.pojo;
<span class="hljs-comment">//类名和数据库名对应，但是表名一般缩写，类名要全写！</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Employee</span> {
    <span class="hljs-keyword">private</span> Integer empId;<span class="hljs-comment">//emp_id = empId 数据库中列名用下划线分隔，属性名用驼峰！</span>
    <span class="hljs-keyword">private</span> String empName;<span class="hljs-comment">//emp_name = empName</span>
    <span class="hljs-keyword">private</span> Double empSalary;<span class="hljs-comment">//emp_salary = empSalary</span>
    <span class="hljs-keyword">private</span> Integer empAge;<span class="hljs-comment">//emp_age = empAge</span>

    <span class="hljs-comment">//省略get、set、无参、有参、toString方法。</span>
}
</code></pre>
<p>封装代码：</p>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">querySingleRow</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">//1.注册驱动</span>
<span class="hljs-comment">//        Class.forName("com.mysql.cj.jdbc.Driver");</span>

        <span class="hljs-comment">//2.获取数据库连接</span>
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> DriverManager.getConnection(<span class="hljs-string">"jdbc:mysql://localhost:3306/atguigu"</span>, <span class="hljs-string">"root"</span>,<span class="hljs-string">"atguigu"</span>);

        <span class="hljs-comment">//3.创建PreparedStatement对象，并预编译SQL语句，使用?占位符</span>
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">preparedStatement</span> <span class="hljs-operator">=</span> connection.prepareStatement(<span class="hljs-string">"select emp_id,emp_name,emp_salary,emp_age from t_emp where emp_id = ?"</span>);

        <span class="hljs-comment">//4.为占位符赋值，索引从1开始，执行SQL语句，获取结果</span>
        preparedStatement.setInt(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
        <span class="hljs-type">ResultSet</span> <span class="hljs-variable">resultSet</span> <span class="hljs-operator">=</span> preparedStatement.executeQuery();
	      <span class="hljs-comment">//预先创建实体类变量</span>
        <span class="hljs-type">Employee</span> <span class="hljs-variable">employee</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-comment">//5.处理结果</span>
        <span class="hljs-keyword">while</span> (resultSet.next()) {
            <span class="hljs-type">int</span> <span class="hljs-variable">empId</span> <span class="hljs-operator">=</span> resultSet.getInt(<span class="hljs-string">"emp_id"</span>);
            <span class="hljs-type">String</span> <span class="hljs-variable">empName</span> <span class="hljs-operator">=</span> resultSet.getString(<span class="hljs-string">"emp_name"</span>);
            <span class="hljs-type">Double</span> <span class="hljs-variable">empSalary</span> <span class="hljs-operator">=</span> Double.valueOf(resultSet.getString(<span class="hljs-string">"emp_salary"</span>));
            <span class="hljs-type">int</span> <span class="hljs-variable">empAge</span> <span class="hljs-operator">=</span> resultSet.getInt(<span class="hljs-string">"emp_age"</span>);
          	<span class="hljs-comment">//当结果集中有数据，再进行对象的创建</span>
            employee = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Employee</span>(empId,empName,empSalary,empAge);
        }

        System.out.println(<span class="hljs-string">"employee = "</span> + employee);

        <span class="hljs-comment">//6.释放资源(先开后关原则)</span>
        resultSet.close();
        preparedStatement.close();
        connection.close();

    }
</code></pre>
<h4 data-id="heading-26">7.2 主键回显</h4>
<ul>
<li>
<p>在数据中，执行新增操作时，主键列为自动增长，可以在表中直观的看到，但是在Java程序中，我们执行完新增后，只能得到受影响行数，无法得知当前新增数据的主键值。在Java程序中获取数据库中插入新数据后的主键值，并赋值给Java对象，此操作为主键回显。</p>
</li>
<li>
<p>代码实现：</p>
<ul>
<li>
<pre><code class="hljs language-java" lang="java">		<span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testReturnPK</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">//1.注册驱动</span>
<span class="hljs-comment">//        Class.forName("com.mysql.cj.jdbc.Driver");</span>

        <span class="hljs-comment">//2.获取数据库连接</span>
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> DriverManager.getConnection(<span class="hljs-string">"jdbc:mysql://localhost:3306/atguigu"</span>, <span class="hljs-string">"root"</span>, <span class="hljs-string">"atguigu"</span>);

        <span class="hljs-comment">//3.创建preparedStatement对象，传入需要主键回显参数Statement.RETURN_GENERATED_KEYS</span>
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">preparedStatement</span> <span class="hljs-operator">=</span> connection.prepareStatement(<span class="hljs-string">"insert into t_emp (emp_name, emp_salary, emp_age)values  (?, ?,?)"</span>,Statement.RETURN_GENERATED_KEYS);

        <span class="hljs-comment">//4.编写SQL语句并执行，获取结果</span>
        <span class="hljs-type">Employee</span> <span class="hljs-variable">employee</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Employee</span>(<span class="hljs-literal">null</span>,<span class="hljs-string">"rose"</span>,<span class="hljs-number">666.66</span>,<span class="hljs-number">28</span>);
        preparedStatement.setString(<span class="hljs-number">1</span>,employee.getEmpName());
        preparedStatement.setDouble(<span class="hljs-number">2</span>,employee.getEmpSalary());
        preparedStatement.setDouble(<span class="hljs-number">3</span>,employee.getEmpAge());
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> preparedStatement.executeUpdate();

        <span class="hljs-comment">//5.处理结果</span>
        <span class="hljs-keyword">if</span>(result&gt;<span class="hljs-number">0</span>){
            System.out.println(<span class="hljs-string">"添加成功"</span>);
        }<span class="hljs-keyword">else</span>{
            System.out.println(<span class="hljs-string">"添加失败"</span>);
        }

        <span class="hljs-comment">//6.获取生成的主键列值，返回的是resultSet，在结果集中获取主键列值</span>
        <span class="hljs-type">ResultSet</span> <span class="hljs-variable">resultSet</span> <span class="hljs-operator">=</span> preparedStatement.getGeneratedKeys();
        <span class="hljs-keyword">if</span> (resultSet.next()){
            <span class="hljs-type">int</span> <span class="hljs-variable">empId</span> <span class="hljs-operator">=</span> resultSet.getInt(<span class="hljs-number">1</span>);
            employee.setEmpId(empId);
        }
		
       	System.out.println(employee.toString());
       
        <span class="hljs-comment">//7.释放资源(先开后关原则)</span>
        resultSet.close();
        preparedStatement.close();
        connection.close();

    }
</code></pre>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-27">7.3 批量操作</h4>
<ul>
<li>
<p>插入多条数据时，一条一条发送给数据库执行，效率低下！</p>
</li>
<li>
<p>通过批量操作，可以提升多次操作效率！</p>
</li>
<li>
<p>代码实现：</p>
<ul>
<li>
<pre><code class="hljs language-java" lang="java">		<span class="hljs-meta">@Test</span>
     <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testBatch</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
         <span class="hljs-comment">//1.注册驱动</span>
<span class="hljs-comment">//        Class.forName("com.mysql.cj.jdbc.Driver");</span>

        <span class="hljs-comment">//2.获取连接</span>
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> DriverManager.getConnection(<span class="hljs-string">"jdbc:mysql:///atguigu?rewriteBatchedStatements=true"</span>, <span class="hljs-string">"root"</span>, <span class="hljs-string">"atguigu"</span>);

        <span class="hljs-comment">//3.编写SQL语句</span>
        <span class="hljs-comment">/*
            注意：1、必须在连接数据库的URL后面追加?rewriteBatchedStatements=true，允许批量操作
                2、新增SQL必须用values。且语句最后不要追加;结束
                3、调用addBatch()方法，将SQL语句进行批量添加操作
                4、统一执行批量操作，调用executeBatch()
         */</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"insert into t_emp (emp_name,emp_salary,emp_age) values (?,?,?)"</span>;

        <span class="hljs-comment">//4.创建预编译的PreparedStatement，传入SQL语句</span>
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">preparedStatement</span> <span class="hljs-operator">=</span> connection.prepareStatement(sql);

        <span class="hljs-comment">//获取当前行代码执行的时间。毫秒值</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;i&lt;<span class="hljs-number">10000</span>;i++){
            <span class="hljs-comment">//5.为占位符赋值</span>
            preparedStatement.setString(<span class="hljs-number">1</span>, <span class="hljs-string">"marry"</span>+i);
            preparedStatement.setDouble(<span class="hljs-number">2</span>, <span class="hljs-number">100.0</span>+i);
            preparedStatement.setInt(<span class="hljs-number">3</span>, <span class="hljs-number">20</span>+i);

            preparedStatement.addBatch();
        }

        <span class="hljs-comment">//执行批量操作</span>
        preparedStatement.executeBatch();

        <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

        System.out.println(<span class="hljs-string">"消耗时间："</span>+(end - start));

        preparedStatement.close();
        connection.close();
    }
</code></pre>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-28">八、连接池</h3>
<h4 data-id="heading-29">8.1 现有问题</h4>
<blockquote>
<ul>
<li>每次操作数据库都要获取新连接，使用完毕后就close释放，频繁的创建和销毁造成资源浪费。</li>
<li>连接的数量无法把控，对服务器来说压力巨大。</li>
</ul>
</blockquote>
<h4 data-id="heading-30">8.2 连接池</h4>
<blockquote>
<p>连接池就是数据库连接对象的缓冲区，通过配置，由连接池负责创建连接、管理连接、释放连接等操作。</p>
<p>预先创建数据库连接放入连接池，用户在请求时，通过池直接获取连接，使用完毕后，将连接放回池中，避免了频繁的创建和销毁，同时解决了创建的效率。</p>
<p>当池中无连接可用，且未达到上限时，连接池会新建连接。</p>
<p>池中连接达到上限，用户请求会等待，可以设置超时时间。</p>
</blockquote>
<h4 data-id="heading-31">8.3 常见连接池</h4>
<p>JDBC 的数据库连接池使用 javax.sql.DataSource接口进行规范，所有的第三方连接池都实现此接口，自行添加具体实现！也就是说，所有连接池获取连接的和回收连接方法都一样，不同的只有性能和扩展功能!</p>
<ul>
<li>DBCP 是Apache提供的数据库连接池，速度相对C3P0较快，但自身存在一些BUG。</li>
<li>C3P0 是一个开源组织提供的一个数据库连接池，速度相对较慢，稳定性还可以。</li>
<li>Proxool 是sourceforge下的一个开源项目数据库连接池，有监控连接池状态的功能， 稳定性较c3p0差一点</li>
<li><strong>Druid 是阿里提供的数据库连接池，是集DBCP 、C3P0 、Proxool 优点于一身的数据库连接池，性能、扩展性、易用性都更好，功能丰富</strong>。</li>
<li><strong>Hikari（ひかり[shi ga li]） 取自日语，是光的意思，是SpringBoot2.x之后内置的一款连接池，基于 BoneCP （已经放弃维护，推荐该连接池）做了不少的改进和优化，口号是快速、简单、可靠。</strong></li>
</ul>











<table><thead><tr><th align="center">主流连接池的功能对比</th></tr></thead><tbody><tr><td align="center"><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20JDBC.assets%5Cimage-20240228090209040.png" alt="image-20240228090209040转存失败，建议直接上传图片文件" loading="lazy"/></td></tr></tbody></table>











<table><thead><tr><th align="center">mock性能数据（单位：ms）</th></tr></thead><tbody><tr><td align="center"><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20JDBC.assets%5Cimage-20240228205157212.png" alt="image-20240228205157212转存失败，建议直接上传图片文件" loading="lazy"/></td></tr></tbody></table>











<table><thead><tr><th align="center">mysql性能数据 (单位：ms)</th></tr></thead><tbody><tr><td align="center"><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20JDBC.assets%5Cimage-20240228205242420.png" alt="image-20240228205242420转存失败，建议直接上传图片文件" loading="lazy"/></td></tr></tbody></table>
<h4 data-id="heading-32">8.4 Druid连接池使用</h4>
<ul>
<li>
<p>使用步骤：</p>
<ul>
<li>引入jar包。</li>
<li>编码。</li>
</ul>
</li>
<li>
<p>代码实现：</p>
<ul>
<li>
<p>硬编码方式（了解）：</p>
<ul>
<li>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testHardCodeDruid</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">/*
            硬编码：将连接池的配置信息和Java代码耦合在一起。
            1、创建DruidDataSource连接池对象。
            2、设置连接池的配置信息【必须 | 非必须】
            3、通过连接池获取连接对象
            4、回收连接【不是释放连接，而是将连接归还给连接池，给其他线程进行复用】
         */</span>

        <span class="hljs-comment">//1.创建DruidDataSource连接池对象。</span>
        <span class="hljs-type">DruidDataSource</span> <span class="hljs-variable">druidDataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DruidDataSource</span>();

        <span class="hljs-comment">//2.设置连接池的配置信息【必须 | 非必须】</span>
        <span class="hljs-comment">//2.1 必须设置的配置</span>
        druidDataSource.setDriverClassName(<span class="hljs-string">"com.mysql.cj.jdbc.Driver"</span>);
        druidDataSource.setUrl(<span class="hljs-string">"jdbc:mysql:///atguigu"</span>);
        druidDataSource.setUsername(<span class="hljs-string">"root"</span>);
        druidDataSource.setPassword(<span class="hljs-string">"atguigu"</span>);

        <span class="hljs-comment">//2.2 非必须设置的配置</span>
        druidDataSource.setInitialSize(<span class="hljs-number">10</span>);
        druidDataSource.setMaxActive(<span class="hljs-number">20</span>);
        
        <span class="hljs-comment">//3.通过连接池获取连接对象</span>
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> druidDataSource.getConnection();
        System.out.println(connection);

        <span class="hljs-comment">//基于connection进行CRUD</span>

        <span class="hljs-comment">//4.回收连接</span>
        connection.close();
    }
</code></pre>
</li>
</ul>
</li>
<li>
<p>软编码方式（推荐）：</p>
<ul>
<li>
<p>在项目目录下创建resources文件夹，标识该文件夹为资源目录，创建db.properties配置文件，将连接信息定义在该文件中。</p>
<ul>
<li>
<pre><code class="hljs language-properties" lang="properties"># druid连接池需要的配置参数，key固定命名
driverClassName=com.mysql.cj.jdbc.Driver
url=jdbc:mysql:///atguigu
username=root
password=atguigu
initialSize=10
maxActive=20
</code></pre>
</li>
</ul>
</li>
<li>
<p>Java代码：</p>
<ul>
<li>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testResourcesDruid</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">//1.创建Properties集合，用于存储外部配置文件的key和value值。</span>
        <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();

        <span class="hljs-comment">//2.读取外部配置文件，获取输入流，加载到Properties集合里。</span>
        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> DruidTest.class.getClassLoader().getResourceAsStream(<span class="hljs-string">"db.properties"</span>);
        properties.load(inputStream);

        <span class="hljs-comment">//3.基于Properties集合构建DruidDataSource连接池</span>
        <span class="hljs-type">DataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> DruidDataSourceFactory.createDataSource(properties);

        <span class="hljs-comment">//4.通过连接池获取连接对象</span>
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> dataSource.getConnection();
        System.out.println(connection);

        <span class="hljs-comment">//5.开发CRUD</span>

        <span class="hljs-comment">//6.回收连接</span>
        connection.close();
    }
</code></pre>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-33">8.5 Druid其他配置【了解】</h4>





























































































































<table><thead><tr><th>配置</th><th><strong>缺省</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>name</td><td/><td>配置这个属性的意义在于，如果存在多个数据源，监控的时候可以通过名字来区分开来。 如果没有配置，将会生成一个名字，格式是：”DataSource-” + System.identityHashCode(this)</td></tr><tr><td>jdbcUrl</td><td/><td>连接数据库的url，不同数据库不一样。例如：mysql : jdbc:mysql://10.20.153.104:3306/druid2 oracle : jdbc:oracle:thin:@10.20.149.85:1521:ocnauto</td></tr><tr><td>username</td><td/><td>连接数据库的用户名</td></tr><tr><td>password</td><td/><td>连接数据库的密码。如果你不希望密码直接写在配置文件中，可以使用ConfigFilter。详细看这里：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falibaba%2Fdruid%2Fwiki%2F%25E4%25BD%25BF%25E7%2594%25A8ConfigFilter" target="_blank" title="https://github.com/alibaba/druid/wiki/%E4%BD%BF%E7%94%A8ConfigFilter" ref="nofollow noopener noreferrer">github.com/alibaba/dru…</a></td></tr><tr><td>driverClassName</td><td/><td>根据url自动识别 这一项可配可不配，如果不配置druid会根据url自动识别dbType，然后选择相应的driverClassName(建议配置下)</td></tr><tr><td>initialSize</td><td>0</td><td>初始化时建立物理连接的个数。初始化发生在显示调用init方法，或者第一次getConnection时</td></tr><tr><td>maxActive</td><td>8</td><td>最大连接池数量</td></tr><tr><td>maxIdle</td><td>8</td><td>已经不再使用，配置了也没效果</td></tr><tr><td>minIdle</td><td/><td>最小连接池数量</td></tr><tr><td>maxWait</td><td/><td>获取连接时最大等待时间，单位毫秒。配置了maxWait之后，缺省启用公平锁，并发效率会有所下降，如果需要可以通过配置useUnfairLock属性为true使用非公平锁。</td></tr><tr><td>poolPreparedStatements</td><td>false</td><td>是否缓存preparedStatement，也就是PSCache。PSCache对支持游标的数据库性能提升巨大，比如说oracle。在mysql下建议关闭。</td></tr><tr><td>maxOpenPreparedStatements</td><td>-1</td><td>要启用PSCache，必须配置大于0，当大于0时，poolPreparedStatements自动触发修改为true。在Druid中，不会存在Oracle下PSCache占用内存过多的问题，可以把这个数值配置大一些，比如说100</td></tr><tr><td>validationQuery</td><td/><td>用来检测连接是否有效的sql，要求是一个查询语句。如果validationQuery为null，testOnBorrow、testOnReturn、testWhileIdle都不会其作用。</td></tr><tr><td>testOnBorrow</td><td>true</td><td>申请连接时执行validationQuery检测连接是否有效，做了这个配置会降低性能。</td></tr><tr><td>testOnReturn</td><td>false</td><td>归还连接时执行validationQuery检测连接是否有效，做了这个配置会降低性能</td></tr><tr><td>testWhileIdle</td><td>false</td><td>建议配置为true，不影响性能，并且保证安全性。申请连接的时候检测，如果空闲时间大于timeBetweenEvictionRunsMillis，执行validationQuery检测连接是否有效。</td></tr><tr><td>timeBetweenEvictionRunsMillis</td><td/><td>有两个含义： 1)Destroy线程会检测连接的间隔时间2)testWhileIdle的判断依据，详细看testWhileIdle属性的说明</td></tr><tr><td>numTestsPerEvictionRun</td><td/><td>不再使用，一个DruidDataSource只支持一个EvictionRun</td></tr><tr><td>minEvictableIdleTimeMillis</td><td/><td/></tr><tr><td>connectionInitSqls</td><td/><td>物理连接初始化的时候执行的sql</td></tr><tr><td>exceptionSorter</td><td/><td>根据dbType自动识别 当数据库抛出一些不可恢复的异常时，抛弃连接</td></tr><tr><td>filters</td><td/><td>属性类型是字符串，通过别名的方式配置扩展插件，常用的插件有： 监控统计用的filter:stat日志用的filter:log4j防御sql注入的filter:wall</td></tr><tr><td>proxyFilters</td><td/><td>类型是List，如果同时配置了filters和proxyFilters，是组合关系，并非替换关系</td></tr></tbody></table>
<h4 data-id="heading-34">8.6 HikariCP连接池使用</h4>
<ul>
<li>
<p>使用步骤：</p>
<ul>
<li>
<p>引入jar包</p>
</li>
<li>
<p>硬编码方式：</p>
<ul>
<li>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testHardCodeHikari</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
    <span class="hljs-comment">/*
     硬编码：将连接池的配置信息和Java代码耦合在一起。
     1、创建HikariDataSource连接池对象
     2、设置连接池的配置信息【必须 ｜ 非必须】
     3、通过连接池获取连接对象
     4、回收连接
     */</span>
    <span class="hljs-comment">//1.创建HikariDataSource连接池对象</span>
    <span class="hljs-type">HikariDataSource</span> <span class="hljs-variable">hikariDataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HikariDataSource</span>();

    <span class="hljs-comment">//2.设置连接池的配置信息【必须 ｜ 非必须】</span>
    <span class="hljs-comment">//2.1必须设置的配置</span>
    hikariDataSource.setDriverClassName(<span class="hljs-string">"com.mysql.cj.jdbc.Driver"</span>);
    hikariDataSource.setJdbcUrl(<span class="hljs-string">"jdbc:mysql:///atguigu"</span>);
    hikariDataSource.setUsername(<span class="hljs-string">"root"</span>);
    hikariDataSource.setPassword(<span class="hljs-string">"atguigu"</span>);

    <span class="hljs-comment">//2.2 非必须设置的配置</span>
    hikariDataSource.setMinimumIdle(<span class="hljs-number">10</span>);
    hikariDataSource.setMaximumPoolSize(<span class="hljs-number">20</span>);

    <span class="hljs-comment">//3.通过连接池获取连接对象</span>
    <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> hikariDataSource.getConnection();

    System.out.println(connection);

    <span class="hljs-comment">//回收连接</span>
    connection.close();
}
</code></pre>
</li>
</ul>
</li>
<li>
<p>软编码方式：</p>
<ul>
<li>
<p>在项目下创建resources/hikari.properties配置文件</p>
<ul>
<li>
<pre><code class="hljs language-properties" lang="properties">driverClassName=com.mysql.cj.jdbc.Driver
jdbcUrl=jdbc:mysql:///atguigu
username=root
password=atguigu
minimumIdle=10
maximumPoolSize=20
</code></pre>
</li>
</ul>
</li>
<li>
<p>编写代码：</p>
<ul>
<li>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-meta">@Test</span>
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testResourcesHikari</span><span class="hljs-params">()</span><span class="hljs-keyword">throws</span> Exception{
         <span class="hljs-comment">//1.创建Properties集合，用于存储外部配置文件的key和value值。</span>
        <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
        
        <span class="hljs-comment">//2.读取外部配置文件，获取输入流，加载到Properties集合里。</span>
        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> HikariTest.class.getClassLoader().getResourceAsStream(<span class="hljs-string">"db.properties"</span>);
        properties.load(inputStream);
        
        <span class="hljs-comment">// 3.创建Hikari连接池配置对象，将Properties集合传进去</span>
        <span class="hljs-type">HikariConfig</span> <span class="hljs-variable">hikariConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HikariConfig</span>(properties);
        
        <span class="hljs-comment">// 4. 基于Hikari配置对象，构建连接池</span>
        <span class="hljs-type">HikariDataSource</span> <span class="hljs-variable">hikariDataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HikariDataSource</span>(hikariConfig);

        <span class="hljs-comment">// 5. 获取连接</span>
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> hikariDataSource.getConnection();
        System.out.println(<span class="hljs-string">"connection = "</span> + connection);
        
        <span class="hljs-comment">//6.回收连接</span>
        connection.close();
    }
}
</code></pre>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-35">8.7 HikariCP其他配置【了解】</h4>























































<table><thead><tr><th>属性</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td>isAutoCommit</td><td>true</td><td>自动提交从池中返回的连接</td></tr><tr><td>connectionTimeout</td><td>30000</td><td>等待来自池的连接的最大毫秒数</td></tr><tr><td>maxLifetime</td><td>1800000</td><td>池中连接最长生命周期如果不等于0且小于30秒则会被重置回30分钟</td></tr><tr><td>minimumIdle</td><td>10</td><td>池中维护的最小空闲连接数 minIdle&lt;0或者minIdle&gt;maxPoolSize，则被重置为maxPoolSize</td></tr><tr><td>maximumPoolSize</td><td>10</td><td>池中最大连接数，包括闲置和使用中的连接</td></tr><tr><td>metricRegistry</td><td>null</td><td>连接池的用户定义名称，主要出现在日志记录和JMX管理控制台中以识别池和池配置</td></tr><tr><td>healthCheckRegistry</td><td>null</td><td>报告当前健康信息</td></tr><tr><td>poolName</td><td>HikariPool-1</td><td>连接池的用户定义名称，主要出现在日志记录和JMX管理控制台中以识别池和池配置</td></tr><tr><td>idleTimeout</td><td/><td>是允许连接在连接池中空闲的最长时间</td></tr></tbody></table>
<h2 data-id="heading-36">高级篇</h2>
<h3 data-id="heading-37">九、JDBC优化及工具类封装</h3>
<h4 data-id="heading-38">9.1 现有问题</h4>
<blockquote>
<p>我们在使用JDBC的过程中，发现部分代码存在冗余的问题：</p>
<ul>
<li>创建连接池。</li>
<li>获取连接。</li>
<li>连接的回收。</li>
</ul>
</blockquote>
<h4 data-id="heading-39">9.2 JDBC工具类封装V1.0</h4>
<ul>
<li>
<p>resources/db.properties配置文件：</p>
<ul>
<li>
<pre><code class="hljs language-properties" lang="properties"># druid连接池需要的配置参数，key固定命名
driverClassName=com.mysql.cj.jdbc.Driver
username=root
password=atguigu
url=jdbc:mysql:///atguigu
</code></pre>
</li>
</ul>
</li>
<li>
<p>工具类代码：</p>
<ul>
<li>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.alibaba.druid.pool.DruidDataSourceFactory;

<span class="hljs-keyword">import</span> javax.sql.DataSource;
<span class="hljs-keyword">import</span> java.sql.Connection;
<span class="hljs-keyword">import</span> java.sql.SQLException;
<span class="hljs-keyword">import</span> java.util.Properties;
<span class="hljs-comment">/**
*	JDBC工具类（V1.0）：
*		1、维护一个连接池对象。
*		2、对外提供在连接池中获取连接的方法
*		3、对外提供回收连接的方法
*	注意：工具类仅对外提供共性的功能代码，所以方法均为静态方法！
*/</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JDBCTools</span> {
    <span class="hljs-comment">//创建连接池引用，因为要提供给当前项目全局使用，所以创建为静态的。</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DataSource dataSource;
    <span class="hljs-comment">//在项目启动时，即创建连接池对象，赋值给dataSource</span>
    <span class="hljs-keyword">static</span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
            <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span>  JDBCTools.getClass().getClassLoader().getSystemResourceAsStream(<span class="hljs-string">"db.properties"</span>);
            properties.load(inputStream);
            dataSource = DruidDataSourceFactory.createDataSource(properties);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        }
    }
	<span class="hljs-comment">//对外提供获取连接的静态方法！</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> ds.getConnection();
    }
	<span class="hljs-comment">//对外提供回收连接的静态方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">release</span><span class="hljs-params">(Connection conn)</span> <span class="hljs-keyword">throws</span> SQLException {
        conn.close();<span class="hljs-comment">//还给连接池</span>
    }
}
</code></pre>
</li>
</ul>
</li>
<li>
<p>注意：此种封装方式，无法保证单个请求连接的线程，多次操作数据库时，连接是同一个，无法保证事务！</p>
</li>
</ul>
<h4 data-id="heading-40">9.3 ThreadLocal</h4>
<blockquote>
<p>JDK 1.2的版本中就提供java.lang.ThreadLocal，为解决多线程程序的并发问题提供了一种新的思路。使用这个工具类可以很简洁地编写出优美的多线程程序。通常用来在在多线程中管理共享数据库连接、Session等。</p>
<p>ThreadLocal用于保存某个线程共享变量，原因是在Java中，每一个线程对象中都有一个ThreadLocalMap&lt;ThreadLocal， Object&gt;，其key就是一个ThreadLocal，而Object即为该线程的共享变量。</p>
<p>而这个map是通过ThreadLocal的set和get方法操作的。对于同一个static ThreadLocal，不同线程只能从中get，set，remove自己的变量，而不会影响其他线程的变量。</p>
<ul>
<li>在进行对象跨层传递的时候，使用ThreadLocal可以避免多次传递，打破层次间的约束。</li>
<li>线程间数据隔离。</li>
<li>进行事务操作，用于存储线程事务信息。</li>
<li>数据库连接，<code>Session</code>会话管理。</li>
</ul>
<p>1、ThreadLocal对象.get: 获取ThreadLocal中当前线程共享变量的值。</p>
<p>2、ThreadLocal对象.set: 设置ThreadLocal中当前线程共享变量的值。</p>
<p>3、ThreadLocal对象.remove: 移除ThreadLocal中当前线程共享变量的值。</p>
</blockquote>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20JDBC.assets/image-20240223104919548.png" alt="image-20240223104919548转存失败，建议直接上传图片文件" loading="lazy"/></p>
<h4 data-id="heading-41">9.4 JDBC工具类封装V2.0</h4>
<blockquote>
<p>在V1.0的版本基础上，我们将连接对象放在每个线程的ThreadLocal中，保证从头到尾当前线程操作的是同一连接对象。</p>
</blockquote>
<p>代码实现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.atguigu.senior.util;

<span class="hljs-keyword">import</span> com.alibaba.druid.pool.DruidDataSourceFactory;

<span class="hljs-keyword">import</span> javax.sql.DataSource;
<span class="hljs-keyword">import</span> java.io.InputStream;
<span class="hljs-keyword">import</span> java.sql.Connection;
<span class="hljs-keyword">import</span> java.sql.SQLException;
<span class="hljs-keyword">import</span> java.util.Properties;
<span class="hljs-comment">/**
 *  JDBC工具类（V2.0）：
 *      1、维护一个连接池对象、维护了一个线程绑定变量的ThreadLocal对象
 *      2、对外提供在ThreadLocal中获取连接的方法
 *      3、对外提供回收连接的方法，回收过程中，将要回收的连接从ThreadLocal中移除！
 *  注意：工具类仅对外提供共性的功能代码，所以方法均为静态方法！
 *  注意：使用ThreadLocal就是为了一个线程在多次数据库操作过程中，使用的是同一个连接！
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JDBCUtilV2</span> {
    <span class="hljs-comment">//创建连接池引用，因为要提供给当前项目的全局使用，所以创建为静态的。</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DataSource dataSource;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;Connection&gt; threadLocal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();

    <span class="hljs-comment">//在项目启动时，即创建连接池对象，赋值给dataSource</span>
    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
            <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> JDBCUtil.class.getClassLoader().getResourceAsStream(<span class="hljs-string">"db.properties"</span>);
            properties.load(inputStream);

            dataSource = DruidDataSourceFactory.createDataSource(properties);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
        }
    }
    <span class="hljs-comment">//对外提供在连接池中获取连接的方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//在ThreadLocal中获取Connection、</span>
            <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> threadLocal.get();
            <span class="hljs-comment">//threadLocal里没有存储Connection，也就是第一次获取</span>
            <span class="hljs-keyword">if</span> (connection == <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">//在连接池中获取一个连接，存储在threadLocal里。</span>
                connection = dataSource.getConnection();
                threadLocal.set(connection);
            }
            <span class="hljs-keyword">return</span> connection;

        } <span class="hljs-keyword">catch</span> (SQLException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
        }
    }
    <span class="hljs-comment">//对外提供回收连接的方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">release</span><span class="hljs-params">()</span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> threadLocal.get();
            <span class="hljs-keyword">if</span>(connection!=<span class="hljs-literal">null</span>){
                <span class="hljs-comment">//从threadLocal中移除当前已经存储的Connection对象</span>
                threadLocal.remove();
                <span class="hljs-comment">//如果开启了事务的手动提交，操作完毕后，归还给连接池之前，要将事务的自动提交改为true</span>
                connection.setAutoCommit(<span class="hljs-literal">true</span>);
                <span class="hljs-comment">//将Connection对象归还给连接池</span>
                connection.close();
            }
        } <span class="hljs-keyword">catch</span> (SQLException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
        }
    }

}

</code></pre>
<h3 data-id="heading-42">十、DAO封装及BaseDAO工具类</h3>
<h4 data-id="heading-43">10.1 DAO概念</h4>
<blockquote>
<p>DAO：Data Access Object，数据访问对象。</p>
<p>Java是面向对象语言，数据在Java中通常以对象的形式存在。一张表对应一个实体类，一张表的操作对应一个DAO对象！</p>
<p>在Java操作数据库时，我们会将对同一张表的增删改查操作统一维护起来，维护的这个类就是DAO层。</p>
<p>DAO层只关注对数据库的操作，供业务层Service调用，将职责划分清楚！</p>
</blockquote>
<h4 data-id="heading-44">10.1 BaseDAO概念</h4>
<blockquote>
<p>基本上每一个数据表都应该有一个对应的DAO接口及其实现类，发现对所有表的操作（增、删、改、查）代码重复度很高，所以可以抽取公共代码，给这些DAO的实现类可以抽取一个公共的父类，复用增删改查的基本操作，我们称为BaseDAO。</p>
</blockquote>
<h4 data-id="heading-45">10.2 BaseDAO搭建</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseDAO</span> {
    <span class="hljs-comment">/*
    通用的增、删、改的方法
    String sql：sql
    Object... args：给sql中的?设置的值列表，可以是0~n
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(String sql,Object... args)</span> <span class="hljs-keyword">throws</span> SQLException {
<span class="hljs-comment">//        创建PreparedStatement对象，对sql预编译</span>
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> JDBCTools.getConnection();
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> connection.prepareStatement(sql);
        <span class="hljs-comment">//设置?占位符的值</span>
        <span class="hljs-keyword">if</span>(args != <span class="hljs-literal">null</span> &amp;&amp; args.length&gt;<span class="hljs-number">0</span>){
            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;args.length; i++) {
                ps.setObject(i+<span class="hljs-number">1</span>,args[i]);<span class="hljs-comment">//?的编号从1开始，不是从0开始，数组的下标是从0开始</span>
            }
        }

        <span class="hljs-comment">//执行sql</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> ps.executeUpdate();
        ps.close();
        <span class="hljs-comment">//这里检查下是否开启事务，开启不关闭连接，业务方法关闭!</span>
        <span class="hljs-comment">//connection.getAutoCommit()为false，不要在这里回收connection，由开启事务的地方回收</span>
        <span class="hljs-comment">//connection.getAutoCommit()为true，正常回收连接</span>
        <span class="hljs-comment">//没有开启事务的话，直接回收关闭即可!</span>
        <span class="hljs-keyword">if</span> (connection.getAutoCommit()) {
            <span class="hljs-comment">//回收</span>
            JDBCTools.release();
        }
        <span class="hljs-keyword">return</span> len;
    }

    <span class="hljs-comment">/*
    通用的查询多个Javabean对象的方法，例如：多个员工对象，多个部门对象等
    这里的clazz接收的是T类型的Class对象，
    如果查询员工信息，clazz代表Employee.class，
    如果查询部门信息，clazz代表Department.class，
    返回List&lt;T&gt; list
     */</span>
    <span class="hljs-keyword">protected</span> &lt;T&gt; ArrayList&lt;T&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(Class&lt;T&gt; clazz,String sql,Object... args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">//        创建PreparedStatement对象，对sql预编译</span>
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> JDBCTools.getConnection();
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> connection.prepareStatement(sql);
        <span class="hljs-comment">//设置?的值</span>
        <span class="hljs-keyword">if</span>(args != <span class="hljs-literal">null</span> &amp;&amp; args.length&gt;<span class="hljs-number">0</span>){
            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;args.length; i++) {
                ps.setObject(i+<span class="hljs-number">1</span>, args[i]);<span class="hljs-comment">//?的编号从1开始，不是从0开始，数组的下标是从0开始</span>
            }
        }

        ArrayList&lt;T&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-type">ResultSet</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> ps.executeQuery();

        <span class="hljs-comment">/*
        获取结果集的元数据对象。
        元数据对象中有该结果集一共有几列、列名称是什么等信息
         */</span>
        <span class="hljs-type">ResultSetMetaData</span> <span class="hljs-variable">metaData</span> <span class="hljs-operator">=</span> res.getMetaData();
        <span class="hljs-type">int</span> <span class="hljs-variable">columnCount</span> <span class="hljs-operator">=</span> metaData.getColumnCount();<span class="hljs-comment">//获取结果集列数</span>

        <span class="hljs-comment">//遍历结果集ResultSet，把查询结果中的一条一条记录，变成一个一个T 对象，放到list中。</span>
        <span class="hljs-keyword">while</span>(res.next()){
            <span class="hljs-comment">//循环一次代表有一行，代表有一个T对象</span>
            <span class="hljs-type">T</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> clazz.newInstance();<span class="hljs-comment">//要求这个类型必须有公共的无参构造</span>

            <span class="hljs-comment">//把这条记录的每一个单元格的值取出来，设置到t对象对应的属性中。</span>
            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>; i&lt;=columnCount; i++){
                <span class="hljs-comment">//for循环一次，代表取某一行的1个单元格的值</span>
                <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> res.getObject(i);

                <span class="hljs-comment">//这个值应该是t对象的某个属性值</span>
                <span class="hljs-comment">//获取该属性对应的Field对象</span>
                <span class="hljs-comment">//String columnName = metaData.getColumnName(i);//获取第i列的字段名</span>
                <span class="hljs-comment">//这里再取别名可能没办法对应上</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">columnName</span> <span class="hljs-operator">=</span> metaData.getColumnLabel(i);<span class="hljs-comment">//获取第i列的字段名或字段的别名</span>
                <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(columnName);
                field.setAccessible(<span class="hljs-literal">true</span>);<span class="hljs-comment">//这么做可以操作private的属性</span>

                field.set(t,value);
            }

            list.add(t);
        }

        res.close();
        ps.close();
        <span class="hljs-comment">//这里检查下是否开启事务，开启不关闭连接，业务方法关闭!</span>
        <span class="hljs-comment">//没有开启事务的话，直接回收关闭即可!</span>
        <span class="hljs-keyword">if</span> (connection.getAutoCommit()) {
            <span class="hljs-comment">//回收</span>
            JDBCTools.release();
        }
        <span class="hljs-keyword">return</span> list;
    }

    <span class="hljs-keyword">protected</span> &lt;T&gt; T <span class="hljs-title function_">queryBean</span><span class="hljs-params">(Class&lt;T&gt; clazz,String sql, Object... args)</span> <span class="hljs-keyword">throws</span> Exception {
        ArrayList&lt;T&gt; list = query(clazz, sql,args);
        <span class="hljs-keyword">if</span>(list == <span class="hljs-literal">null</span> || list.size() == <span class="hljs-number">0</span>){
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">return</span> list.get(<span class="hljs-number">0</span>);
    }
}
</code></pre>
<h4 data-id="heading-46">10.3 BaseDAO的应用</h4>
<h5 data-id="heading-47">10.3.1 创建员工DAO接口</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.atguigu.senior.dao;

<span class="hljs-keyword">import</span> com.atguigu.senior.pojo.Employee;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * EmployeeDao这个类对应的是t_emp这张表的增删改查的操作
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">EmployeeDao</span> {
    <span class="hljs-comment">/**
     * 数据库对应的查询所有的操作
     * <span class="hljs-doctag">@return</span> 表中所有的数据
     */</span>
    List&lt;Employee&gt; <span class="hljs-title function_">selectAll</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">/**
     * 数据库对应的根据empId查询单个员工数据操作
     * <span class="hljs-doctag">@param</span> empId 主键列
     * <span class="hljs-doctag">@return</span> 一个员工对象（一行数据）
     */</span>
    Employee <span class="hljs-title function_">selectByEmpId</span><span class="hljs-params">(Integer empId)</span>;

    <span class="hljs-comment">/**
     * 数据库对应的新增一条员工数据
     * <span class="hljs-doctag">@param</span> employee ORM思想中的一个员工对象
     * <span class="hljs-doctag">@return</span> 受影响的行数
     */</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(Employee employee)</span>;

    <span class="hljs-comment">/**
     * 数据库对应的修改一条员工数据
     * <span class="hljs-doctag">@param</span> employee ORM思想中的一个员工对象
     * <span class="hljs-doctag">@return</span> 受影响的行数
     */</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Employee employee)</span>;

    <span class="hljs-comment">/**
     * 数据库对应的根据empId删除一条员工数据
     * <span class="hljs-doctag">@param</span> empId 主键列
     * <span class="hljs-doctag">@return</span> 受影响的行数
     */</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(Integer empId)</span>;
}

</code></pre>
<h5 data-id="heading-48">10.3.2 创建员工DAO接口实现类</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.atguigu.senior.dao.impl;

<span class="hljs-keyword">import</span> com.atguigu.senior.dao.BaseDAO;
<span class="hljs-keyword">import</span> com.atguigu.senior.dao.EmployeeDao;
<span class="hljs-keyword">import</span> com.atguigu.senior.pojo.Employee;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmployeeDaoImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseDAO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">EmployeeDao</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;Employee&gt; <span class="hljs-title function_">selectAll</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT emp_id empId,emp_name empName,emp_salary empSalary,emp_age empAge FROM t_emp"</span>;
            <span class="hljs-keyword">return</span> executeQuery(Employee.class,sql,<span class="hljs-literal">null</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Employee <span class="hljs-title function_">selectByEmpId</span><span class="hljs-params">(Integer empId)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT emp_id empId,emp_name empName,emp_salary empSalary,emp_age empAge FROM t_emp where emp_id = ?"</span>;
            <span class="hljs-keyword">return</span> executeQueryBean(Employee.class,sql,empId);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(Employee employee)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"INSERT INTO t_emp(emp_name,emp_salary,emp_age) VALUES (?,?,?)"</span>;
            <span class="hljs-keyword">return</span> executeUpdate(sql,employee.getEmpName(),employee.getEmpSalary(),employee.getEmpAge());
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Employee employee)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"UPDATE t_emp SET emp_salary = ? WHERE emp_id = ?"</span>;
            <span class="hljs-keyword">return</span> executeUpdate(sql,employee.getEmpSalary(),employee.getEmpId());
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(Integer empId)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"delete from t_emp where emp_id = ?"</span>;
            <span class="hljs-keyword">return</span> executeUpdate(sql,empId);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
        }
    }
}

</code></pre>
<h3 data-id="heading-49">十一、事务</h3>
<h4 data-id="heading-50">11.1 事务回顾</h4>
<ul>
<li>数据库事务就是一种SQL语句执行的缓存机制，不会单条执行完毕就更新数据库数据，最终根据缓存内的多条语句执行结果统一判定!   一个事务内所有语句都成功及事务成功，我们可以触发commit提交事务来结束事务，更新数据!   一个事务内任意一条语句失败，即为事务失败，我们可以触发rollback回滚结束事务，数据回到事务之前状态!</li>
<li>一个业务涉及多条修改数据库语句!   例如:
<ul>
<li>经典的转账案例，转账业务(A账户减钱和B账户加钱，要一起成功)</li>
<li>批量删除(涉及多个删除)</li>
<li>批量添加(涉及多个插入)</li>
</ul>
</li>
<li>事务的特性：
<ol>
<li>原子性（Atomicity）原子性是指事务是一个不可分割的工作单位，事务中的操作要么都发生，  要么都不发生。</li>
<li>一致性（Consistency）事务必须使数据库从一个一致性状态变换到另外一个一致性状态。</li>
<li>隔离性（Isolation）事务的隔离性是指一个事务的执行不能被其他事务干扰，  即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰。</li>
<li>持久性（Durability）持久性是指一个事务一旦被提交，它对数据库中数据的改变就是永久性的，  接下来的其他操作和数据库故障不应该对其有任何影响</li>
</ol>
</li>
<li>事务的提交方式：
<ul>
<li>自动提交：每条语句自动存储一个事务中，执行成功自动提交，执行失败自动回滚!</li>
<li>手动提交:  手动开启事务，添加语句，手动提交或者手动回滚即可!</li>
</ul>
</li>
</ul>
<h4 data-id="heading-51">11.2 JDBC中事务实现</h4>
<ul>
<li>
<p>关键代码：</p>
<ul>
<li>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span>{
    connection.setAutoCommit(<span class="hljs-literal">false</span>); <span class="hljs-comment">//关闭自动提交了</span>
    <span class="hljs-comment">//connection.setAutoCommit(false)也就类型于SET autocommit = off</span>
    
    <span class="hljs-comment">//注意，只要当前connection对象，进行数据库操作，都不会自动提交事务</span>
    <span class="hljs-comment">//数据库动作!</span>
    <span class="hljs-comment">//prepareStatement - 单一的数据库动作 c r u d </span>
    <span class="hljs-comment">//connection - 操作事务 </span>
    
    <span class="hljs-comment">//所有操作执行正确，提交事务！</span>
    connection.commit();
  }<span class="hljs-keyword">catch</span>(Execption e){
    <span class="hljs-comment">//出现异常，则回滚事务！</span>
    connection.rollback();
  }
</code></pre>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-52">11.3  JDBC事务代码实现</h4>
<ul>
<li>
<p>准备数据库表：</p>
<ul>
<li>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 继续在atguigu的库中创建银行表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_bank(
   id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT COMMENT <span class="hljs-string">'账号主键'</span>,
   account <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">UNIQUE</span> COMMENT <span class="hljs-string">'账号'</span>,
   money  <span class="hljs-type">INT</span> UNSIGNED COMMENT <span class="hljs-string">'金额，不能为负值'</span>) ;
   
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_bank(account,money) <span class="hljs-keyword">VALUES</span>
  (<span class="hljs-string">'zhangsan'</span>,<span class="hljs-number">1000</span>),(<span class="hljs-string">'lisi'</span>,<span class="hljs-number">1000</span>);

</code></pre>
</li>
</ul>
</li>
<li>
<p>DAO接口代码：</p>
<ul>
<li>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BankDao</span>{
    <span class="hljs-type">int</span> <span class="hljs-title function_">addMoney</span><span class="hljs-params">(Integer id,Integer money)</span>;

    <span class="hljs-type">int</span> <span class="hljs-title function_">subMoney</span><span class="hljs-params">(Integer id,Integer money)</span>;
}
</code></pre>
</li>
</ul>
</li>
<li>
<p>DAO实现类代码：</p>
<ul>
<li>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BankDaoImpl</span>  <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseDao</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BankDao</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">addMoney</span><span class="hljs-params">(Integer id,Integer money)</span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"update t_bank set money = money + ? where id = ? "</span>;
            <span class="hljs-keyword">return</span> executeUpdate(sql,money,id);
        } <span class="hljs-keyword">catch</span> (SQLException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
        }
    }

   <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">subMoney</span><span class="hljs-params">(Integer id,Integer money)</span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"update t_bank set money = money - ? where id = ? "</span>;
            <span class="hljs-keyword">return</span> executeUpdate(sql,money,id);
        } <span class="hljs-keyword">catch</span> (SQLException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
        }
    }
}
</code></pre>
</li>
</ul>
</li>
<li>
<p>测试代码：</p>
<ul>
<li>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testTransaction</span><span class="hljs-params">()</span>{
        <span class="hljs-type">BankDao</span> <span class="hljs-variable">bankDao</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BankDaoImpl</span>();
        Connection connection=<span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//1.获取连接，将连接的事务提交改为手动提交</span>
            connection = JDBCUtilV2.getConnection();
            connection.setAutoCommit(<span class="hljs-literal">false</span>);<span class="hljs-comment">//开启事务，当前连接的自动提交关闭。改为手动提交！</span>

            <span class="hljs-comment">//2.操作减钱</span>
            bankDao.subMoney(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>);

            <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span> / <span class="hljs-number">0</span>;

            <span class="hljs-comment">//3.操作加钱</span>
            bankDao.addMoney(<span class="hljs-number">2</span>,<span class="hljs-number">100</span>);

            <span class="hljs-comment">//4.前置的多次dao操作，没有异常，提交事务！</span>
            connection.commit();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">try</span> {
                connection.rollback();
            } <span class="hljs-keyword">catch</span> (Exception ex) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(ex);
            }
        }<span class="hljs-keyword">finally</span> {
            JDBCUtilV2.release();
        }
    }
</code></pre>
</li>
</ul>
</li>
</ul>
<p><strong>注意：</strong></p>
<blockquote>
<p>当开启事务后，切记一定要根据代码执行结果来决定是否提交或回滚！否则数据库看不到数据的操作结果！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[揭秘Cookie操纵：深入解析模拟登录与维持会话技巧]]></title>    <link>https://juejin.cn/post/7603643044033970212</link>    <guid>https://juejin.cn/post/7603643044033970212</guid>    <pubDate>2026-02-07T11:33:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603643044033970212" data-draft-id="7603643044033953828" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="揭秘Cookie操纵：深入解析模拟登录与维持会话技巧"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-07T11:33:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="篱也不篱"/> <meta itemprop="url" content="https://juejin.cn/user/814056073093864"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            揭秘Cookie操纵：深入解析模拟登录与维持会话技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/814056073093864/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    篱也不篱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-07T11:33:06.000Z" title="Sat Feb 07 2026 11:33:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在互联网世界中，Cookie扮演着至关重要的角色，它不仅能够记录用户的浏览习惯，还能实现网站的个性化服务。本文将深入解析如何通过Cookie模拟登录并维持网站会话状态，帮助读者全面了解这一技术。</p>
<p>首先，我们来了解一下Cookie验证的原理。Cookie是一种在用户浏览器中存储的小型文本文件，它包含了网站与用户之间的交互信息。当用户访问网站时，服务器会将Cookie发送到用户的浏览器，浏览器将这些信息存储起来。当用户再次访问同一网站时，浏览器会将这些Cookie发送回服务器，从而验证用户的身份。</p>
<p>获取Cookie的方法有很多种，其中最常见的是使用浏览器工具。例如，Chrome浏览器的开发者工具可以帮助我们查看和修改Cookie。此外，Python库如<code>requests</code>和<code>BeautifulSoup</code>以及自动化测试工具Selenium等，都能帮助我们获取和操作Cookie。</p>
<p>在模拟登录过程中，我们可以通过字典传递的方式来设置Cookie。以下是一个简单的示例：</p>
<pre><code class="hljs language-python" lang="python">cookies = {
    <span class="hljs-string">'username'</span>: <span class="hljs-string">'testuser'</span>,
    <span class="hljs-string">'password'</span>: <span class="hljs-string">'testpassword'</span>
}
response = requests.get(<span class="hljs-string">'http://example.com/login'</span>, cookies=cookies)
</code></pre>
<p>除了字典传递，我们还可以使用<code>CookieJar</code>来管理Cookie。<code>CookieJar</code>是一个专门用于存储Cookie的容器，它可以方便地添加、删除和修改Cookie。</p>
<p>在维持会话状态方面，Selenium是一个非常强大的工具。通过Selenium，我们可以模拟真实用户的操作，实现自动登录、数据抓取等功能。以下是一个使用Selenium进行模拟登录的示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> selenium <span class="hljs-keyword">import</span> webdriver

driver = webdriver.Chrome()
driver.get(<span class="hljs-string">'http://example.com/login'</span>)
driver.find_element_by_name(<span class="hljs-string">'username'</span>).send_keys(<span class="hljs-string">'testuser'</span>)
driver.find_element_by_name(<span class="hljs-string">'password'</span>).send_keys(<span class="hljs-string">'testpassword'</span>)
driver.find_element_by_name(<span class="hljs-string">'submit'</span>).click()
</code></pre>
<p>在实战案例中，我们还需要注意Cookie的过期处理。如果Cookie过期了，用户将无法保持登录状态。因此，我们需要定期检查Cookie的有效性，并在必要时刷新或重新获取。</p>
<p>最后，我们必须强调Cookie安全保护的重要性。在处理Cookie时，要注意保护用户的隐私，避免泄露敏感信息。同时，尊重用户隐私，不要未经授权获取和修改用户数据。</p>
<p>总之，通过本文的解析，读者应该对Cookie操纵有了更深入的了解。掌握这些技巧，不仅可以提高我们的编程能力，还能在网络安全领域发挥重要作用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[写了 10 年 MyBatis，一直以为“去 XML”=写注解，直到看到了这个项目]]></title>    <link>https://juejin.cn/post/7603656494904737798</link>    <guid>https://juejin.cn/post/7603656494904737798</guid>    <pubDate>2026-02-07T12:28:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603656494904737798" data-draft-id="7603656494904705030" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="写了 10 年 MyBatis，一直以为“去 XML”=写注解，直到看到了这个项目"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-07T12:28:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员布吉岛"/> <meta itemprop="url" content="https://juejin.cn/user/1027421211203466"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            写了 10 年 MyBatis，一直以为“去 XML”=写注解，直到看到了这个项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1027421211203466/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员布吉岛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-07T12:28:54.000Z" title="Sat Feb 07 2026 12:28:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"/>
<p>一直对 MyBatis 有个刻板印象：<strong>Mapper 接口负责声明方法，Mapper.xml 负责写 SQL</strong>。</p>
<p>改条件就去 XML 里 <code>&lt;if test=""&gt;</code>，调参数就切换不同文件，从刚开始学到现在用了很久，熟悉得不能再熟悉。</p>
<p>直到最近看到一个项目：<strong>我把 <code>resources/mapper</code> 翻了个底朝天，愣是没找到一份 XML。</strong></p>
<p>我第一反应：</p>
<blockquote>
<p>“这项目肯定是全用 <code>@Select</code> 之类的注解硬写 SQL 了吧。”</p>
</blockquote>
<p>结果打开 Mapper：我人傻了。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95c21f8def4e4ec98f949321a5fd08ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5biD5ZCJ5bKb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771072136&amp;x-signature=2QO8VTqMIM7e2M3y1Pym9OcNVdM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-1">1）去 XML：@Select</h3>
<p>单表按主键查，注解很舒服：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@Select(<span class="hljs-params"><span class="hljs-string">"select * from tb_user where id = #{id}"</span></span>)UserDO selectById(<span class="hljs-params">Long <span class="hljs-built_in">id</span></span>);</span>
</code></pre>
<p>但一旦要动态条件，很多人会写成这种：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Select</span>(<span class="hljs-string">""</span> +        <span class="hljs-string">"select * from tb_user "</span> +        <span class="hljs-string">""</span> +        <span class="hljs-string">"   and name like concat('%', #{name}, '%') "</span> +        <span class="hljs-string">"   and age &gt;= #{age} "</span> +        <span class="hljs-string">""</span> +        <span class="hljs-string">""</span>)List <span class="hljs-built_in">list</span>(UserQuery req);
</code></pre>
<p>这么些的体验基本是：</p>
<ul>
<li>• 字符串拼接看得眼疼</li>
<li>• 没有 SQL 高亮、格式化也很难受</li>
<li>• 复杂一点直接维护灾难</li>
</ul>
<p>所以绝大多数团队最终都会回到 XML——至少 XML 里写动态 SQL 还能接受。</p>
<h3 data-id="heading-2">2）去 XML：@SelectProvider</h3>
<p>这个项目里 Mapper 长这样：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@SelectProvider(<span class="hljs-params"><span class="hljs-built_in">type</span> = UserSqlProvider.<span class="hljs-keyword">class</span>, method = <span class="hljs-string">"selectByCondition"</span></span>)List selectByCondition(<span class="hljs-params">UserQuery req</span>);</span>
</code></pre>
<p>我当时心里一句话：</p>
<blockquote>
<p>“Provider？这是什么东东？”</p>
</blockquote>
<p>点进 <code>UserSqlProvider</code>，看到的是这种代码：</p>
<pre><code class="hljs language-scss" lang="scss">public class UserSqlProvider {  public String <span class="hljs-built_in">selectByCondition</span>(UserQuery req) {    return new <span class="hljs-built_in">SQL</span>() {{      <span class="hljs-built_in">SELECT</span>("id, name, age, status, create_time");      <span class="hljs-built_in">FROM</span>("tb_user");      if (req.getName() != null &amp;&amp; !req<span class="hljs-selector-class">.getName</span>()<span class="hljs-selector-class">.isBlank</span>()) {        <span class="hljs-built_in">WHERE</span>("name like concat('%', #{name}, '%')");      }      if (req.getMinAge() != null) {        <span class="hljs-built_in">WHERE</span>("age &gt;= #{minAge}");      }      if (req.getStatus() != null) {        <span class="hljs-built_in">WHERE</span>("status = #{status}");      }      <span class="hljs-built_in">ORDER_BY</span>("create_time desc");    }}<span class="hljs-selector-class">.toString</span>();  }}
</code></pre>
<p>当时我有点惊讶：
<code>SQL()</code>、<code>SELECT()</code>、<code>WHERE()</code> 这些不是自定义工具类，而是 <strong>MyBatis 自带的 SQL Builder</strong>。</p>
<p>这类写法的本质是：</p>
<ul>
<li>• <strong>XML 动态 SQL 的能力不变</strong></li>
<li>• 但“拼 SQL 的载体”从 XML 变成 <strong>Java Provider 方法</strong></li>
<li>• 最终 MyBatis 仍然执行一段 SQL 字符串（只是这段字符串由 builder 组装出来）</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fed90a36d9e4efb88705a45c1af5156~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5biD5ZCJ5bKb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771072136&amp;x-signature=XQQcemYH66oslgOmjgw5jkaLyvQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">3）Provider</h3>
<h4 data-id="heading-4">解决了什么？</h4>
<p><strong>动态条件 + 可读性</strong>。</p>
<p>不用在注解字符串里写 <code>&lt;script&gt;</code>、不用手动拼 <code>AND</code>、也不用在 Java/XML 之间跳来跳去。</p>
<p>再比如：动态排序字段（注意做白名单防注入）</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> list(UserQuery req) {  <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span> SQL() {{    <span class="hljs-keyword">SELECT</span>(<span class="hljs-string">"*"</span>);    <span class="hljs-keyword">FROM</span>(<span class="hljs-string">"tb_user"</span>);    <span class="hljs-keyword">if</span> (req.getName() != null &amp;&amp; !req.getName().isBlank()) {      <span class="hljs-keyword">WHERE</span>(<span class="hljs-string">"name like concat('%', #{name}, '%')"</span>);    }    // 排序字段做白名单，避免 <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> 注入    <span class="hljs-keyword">if</span> (<span class="hljs-string">"create_time"</span>.<span class="hljs-keyword">equals</span>(req.getOrderBy())) {      ORDER_BY(<span class="hljs-string">"create_time desc"</span>);    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"age"</span>.<span class="hljs-keyword">equals</span>(req.getOrderBy())) {      ORDER_BY(<span class="hljs-string">"age desc"</span>);    } <span class="hljs-keyword">else</span> {      ORDER_BY(<span class="hljs-string">"id desc"</span>);    }  }}.toString();}
</code></pre>
<h4 data-id="heading-5">未能解决</h4>
<p><strong>复杂 SQL 的“表达力”问题</strong>。</p>
<p>子查询、复杂 join、窗口函数、CTE……你用 builder 也能写，但写着写着就会变成“在 Java 里造 SQL AST”，维护成本可能并不比 XML 低。</p>
<p>我的建议：</p>
<ul>
<li>• <strong>中等复杂度动态查询</strong>：Provider 很合适</li>
<li>• <strong>复杂报表 / 多层嵌套</strong>：直接写原生 SQL（放 XML 或统一的 SQL 文件）更直观</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35e624c7bfe3424fb48d580ec328bb3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5biD5ZCJ5bKb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771072136&amp;x-signature=wS1QEwaf%2FfMQWVO5lj4ps%2F5XGRM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">4）Provider 最容易踩的坑：参数绑定（90% 的报错在这）</h3>
<h4 data-id="heading-7">4.1 单参数对象：最舒服</h4>
<pre><code class="hljs language-scss" lang="scss">List <span class="hljs-built_in">list</span>(UserQuery req);
</code></pre>
<p>Provider 里直接 <code>#{name}</code>、<code>#{minAge}</code>，对应 <code>req</code> 的属性名即可。</p>
<h4 data-id="heading-8">4.2 多参数一定要 @Param，不然会看到奇怪的参数名</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@SelectProvider</span>(type = UserSqlProvider.class, method = <span class="hljs-string">"get"</span>)UserDO <span class="hljs-built_in">get</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"id"</span>) Long id, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"status"</span>) Integer status);
</code></pre>
<p>Provider 可以收 <code>Map</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">get</span>(<span class="hljs-params"><span class="hljs-built_in">Map</span> p</span>) {  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">SQL</span>(<span class="hljs-params"/>) {{    <span class="hljs-title function_">SELECT</span>(<span class="hljs-string">"*"</span>);    <span class="hljs-title function_">FROM</span>(<span class="hljs-string">"tb_user"</span>);    <span class="hljs-title function_">WHERE</span>(<span class="hljs-string">"id = #{id}"</span>);    <span class="hljs-keyword">if</span> (p.<span class="hljs-title function_">get</span>(<span class="hljs-string">"status"</span>) != <span class="hljs-literal">null</span>) {      <span class="hljs-title function_">WHERE</span>(<span class="hljs-string">"status = #{status}"</span>);    }  }}.<span class="hljs-title function_">toString</span>();}
</code></pre>
<p>如果不写 <code>@Param</code>，参数名可能变成 <code>param1/param2</code> 或 <code>arg0/arg1</code>，然后你就开始“有bug，明明传了值怎么为空”。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e1c132a4509405cbd9588a0eb2731c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5biD5ZCJ5bKb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771072136&amp;x-signature=jzlidB1zO2EjQEZH%2B5XL8EGaUKw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">5）再懒一下：MyBatis-Plus</h3>
<p>如果主要场景是<strong>单表 CRUD + 条件筛选</strong>，MyBatis-Plus 的思路是：尽量别写 SQL，让 Wrapper 来表达条件。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">LambdaQueryWrapper</span> <span class="hljs-selector-tag">w</span> = <span class="hljs-selector-tag">Wrappers</span><span class="hljs-selector-class">.lambdaQuery</span>();<span class="hljs-selector-tag">w</span><span class="hljs-selector-class">.like</span>(StringUtils.<span class="hljs-built_in">isNotBlank</span>(req.<span class="hljs-built_in">getName</span>()), <span class="hljs-attribute">UserDO</span>::getName, req.<span class="hljs-built_in">getName</span>()) <span class="hljs-selector-class">.ge</span>(req.<span class="hljs-built_in">getMinAge</span>() != null, <span class="hljs-attribute">UserDO</span>::getAge, req.<span class="hljs-built_in">getMinAge</span>()) <span class="hljs-selector-class">.eq</span>(req.<span class="hljs-built_in">getStatus</span>() != null, <span class="hljs-attribute">UserDO</span>::getStatus, req.<span class="hljs-built_in">getStatus</span>()); <span class="hljs-selector-tag">List</span> <span class="hljs-selector-tag">list</span> = <span class="hljs-selector-tag">userMapper</span><span class="hljs-selector-class">.selectList</span>(w);
</code></pre>
<p>这套东西的价值很明确：</p>
<ul>
<li>• 字段引用是方法引用，改字段/重构更安全</li>
<li>• 大量单表查询不需要写 SQL</li>
<li>• 团队统一风格之后，开发效率很高</li>
</ul>
<p>但边界也很明确：<strong>复杂 SQL 仍然要回到原生 SQL</strong>（XML/Provider/自定义 mapper 都行），Wrapper 不适合硬扛报表类需求。</p>
<h3 data-id="heading-10">6）组装 SQL：MyBatis-Flex</h3>
<p>如果连 join 都不想写 SQL，更希望用 Java 结构来表达，MyBatis-Flex 这类框架会提供更强的 QueryWrapper/Join 能力。</p>
<p>简单 join 确实很直观：</p>
<pre><code class="hljs language-scss" lang="scss">QueryWrapper <span class="hljs-selector-tag">q</span> = QueryWrapper<span class="hljs-selector-class">.create</span>()    <span class="hljs-selector-class">.select</span>(ACCOUNT.ID, ACCOUNT.USER_NAME, ROLE.ROLE_NAME)    <span class="hljs-selector-class">.from</span>(ACCOUNT)    <span class="hljs-selector-class">.leftJoin</span>(ROLE)<span class="hljs-selector-class">.on</span>(ACCOUNT.ROLE_ID.eq(ROLE.ID))    <span class="hljs-selector-class">.where</span>(ACCOUNT.AGE.ge(<span class="hljs-number">18</span>)); List list = accountMapper<span class="hljs-selector-class">.selectListByQueryAs</span>(q, AccountDTO.class);
</code></pre>
<p>但当你开始写<strong>多层子查询/嵌套条件</strong>时，可读性很容易被“对象套对象”拉低。</p>
<p>比如“订单金额 &gt; 用户 1 平均订单金额”这种：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">// 子查询QueryWrapper <span class="hljs-keyword">sub</span> = QueryWrapper.create()    .<span class="hljs-keyword">select</span>(avg(<span class="hljs-keyword">ORDER</span>.TOTAL_PRICE))    .<span class="hljs-keyword">from</span>(<span class="hljs-keyword">ORDER</span>)    .<span class="hljs-keyword">where</span>(<span class="hljs-keyword">ORDER</span>.USER_ID.eq(<span class="hljs-number">1</span>)); // 主查询QueryWrapper main = QueryWrapper.create()    .<span class="hljs-keyword">select</span>(<span class="hljs-keyword">ORDER</span>.ALL_COLUMNS)    .<span class="hljs-keyword">from</span>(<span class="hljs-keyword">ORDER</span>)    .<span class="hljs-keyword">where</span>(<span class="hljs-keyword">ORDER</span>.TOTAL_PRICE.gt(<span class="hljs-keyword">sub</span>)); List list = orderMapper.selectListByQuery(main);
</code></pre>
<p>能写、也类型更安全，但维护者往往需要在脑子里把它“还原成 SQL”再理解意图。嵌套层级越深，这个成本越高。</p>
<h3 data-id="heading-11">7）到底怎么选？</h3>
<p>参考落地策略：</p>
<ul>
<li>• <strong>固定 SQL / 简单单表</strong>：<code>@Select</code> 足够</li>
<li>• <strong>中等动态 SQL（条件多、拼接多，但逻辑清晰）</strong>：<code>@SelectProvider + SQL Builder</code></li>
<li>• <strong>单表 CRUD 为主，追求少写 SQL</strong>：MyBatis-Plus</li>
<li>• <strong>Join 多、希望 Java 化表达更强</strong>：MyBatis-Flex（嵌套复杂时要克制）</li>
<li>• <strong>复杂报表 / 多层子查询 / 强声明式</strong>：直接原生 SQL（XML/SQL 文件），通常最清晰</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7339ceb5ce624c2cac445f2ed7ce5d0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5biD5ZCJ5bKb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771072136&amp;x-signature=CbCoHeP5k4ZdsYN9AYDZgCFynIU%3D" alt="" loading="lazy"/>
Provider 这条路最让我意外：<strong>不靠第三方，也不把动态 SQL 写成字符串炼狱</strong>，但它也不是用来替代所有 SQL 的。把边界定好，用起来会更舒服。</p>
<p>总之就是在不同场景下面选择合适的技术并确定合理的规范，然后统一按照规范执行就可以啦！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[关系数据库替换用金仓：数据迁移过程中的完整性与一致性风险]]></title>    <link>https://juejin.cn/post/7603649945978683411</link>    <guid>https://juejin.cn/post/7603649945978683411</guid>    <pubDate>2026-02-08T00:40:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603649945978683411" data-draft-id="7603643044034609188" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="关系数据库替换用金仓：数据迁移过程中的完整性与一致性风险"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2026-02-08T00:40:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倔强的石头_"/> <meta itemprop="url" content="https://juejin.cn/user/3168119757484368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            关系数据库替换用金仓：数据迁移过程中的完整性与一致性风险
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3168119757484368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倔强的石头_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-08T00:40:36.000Z" title="Sun Feb 08 2026 00:40:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a23ff428cdf4f26982701fb3e4994aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771116079&amp;x-signature=tzq3RZtprxkrjI0eiKSUtWZ%2Fry0%3D" alt="640.gif" loading="lazy"/></p>
<blockquote>
<p>这篇不打算做“迁移工具清单”。我更想把它写成替换项目里的对账/验收笔记：哪些坑最爱在切换前后冒头，哪些检查在 Windows + ksql 的环境里就能用很小的成本跑起来。目标也很直白：<strong>别只停留在“迁过去了”，而是要做到“迁得对、跑得稳、出了事还能回得去”</strong>。</p>
</blockquote>
<p>@[toc]</p>
<hr/>
<h2 data-id="heading-0">1. 为什么迁移最难的不是“能不能导入”，而是“对不对得上”</h2>
<p>迁移这事儿，最容易让人放松警惕的一句话就是：“数据都导进去了，查得出来就行。”<br/>
可一旦上线，业务真正感知的从来不是“有没有数据”，而是下面这两件事：</p>
<ul>
<li><strong>完整性</strong>：该有的行有没有都到齐（不丢、不缺、不乱关联）；</li>
<li><strong>一致性</strong>：同一条业务事实在新旧链路上是不是同一个结果（金额、状态、时间、文本都一致）。</li>
</ul>
<p>我见过不少事故，最后都能归到一句话上：<strong>迁移链路把“数据的样子”搬过去了，但没把“数据的含义”一起搬过去</strong>。一旦语义悄悄偏了，它通常不会立刻炸锅，更像是慢性病：今天对账差一点、明天某几单状态怪怪的、后天又有人反馈“怎么搜不到”。排查起来最耗人。</p>
<hr/>
<h2 data-id="heading-1">2. 完整性 vs 一致性：风险地图（按“怎么验”来分组）</h2>















































<table><thead><tr><th>风险类型</th><th>典型表现</th><th>更容易出现在哪个阶段</th><th>最有效的验证方式</th></tr></thead><tbody><tr><td>行级缺失/重复</td><td>少行、重复行、主键冲突后被覆盖</td><td>全量导入、增量回放</td><td>分段行数对账 + 主键重复扫描</td></tr><tr><td>参照关系断裂</td><td>明细找不到主表、外键启用失败</td><td>导入后补约束</td><td>断链扫描（left join 找孤儿）</td></tr><tr><td>字符集/排序规则偏差</td><td>文本不等、比较/排序结果变化</td><td>读写混用期</td><td>长度/字节长度对照 + 关键查询回归</td></tr><tr><td>时间/时区/精度偏差</td><td>时间相差 8 小时、同秒内顺序错</td><td>增量窗口、对账</td><td>时区基线校验 + 边界时间回放</td></tr><tr><td>LOB 截断/损坏</td><td>文档打不开、长文本尾部丢</td><td>全量导入</td><td>长度分布 + 抽样导出文件校验</td></tr><tr><td>增量 checkpoint 设计不当</td><td>丢数、重复、乱序</td><td>增量同步、切换日</td><td>回放窗口 + 双条件断点（时间+主键）</td></tr></tbody></table>
<p>这张表想表达的就一件事：别把“对账”当成一个动作，它更像一套能重复跑的脚本集合。你不需要靠记忆和感觉去“觉得差不多了”，而是让每一步都有输出、有证据。下面的实操也都按“复制到 ksql 就能跑”的思路来写。</p>
<hr/>
<h2 data-id="heading-2">3. 切换前先做基线：Windows + ksql 的三类自检</h2>
<h3 data-id="heading-3">3.1 连接与会话基线</h3>
<pre><code class="hljs language-bash" lang="bash">ksql -h 127.0.0.1 -p 54321 -U system -d <span class="hljs-built_in">test</span>
</code></pre>
<p>进到 <code>test=#</code> 以后，我会先把“会话口径”钉死（后续所有对账都按同一口径来，不然容易各说各话）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">CURRENT_USER</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>;
<span class="hljs-keyword">SHOW</span> server_encoding;
<span class="hljs-keyword">SHOW</span> client_encoding;
<span class="hljs-keyword">SHOW</span> lc_collate;
<span class="hljs-keyword">SHOW</span> lc_ctype;
<span class="hljs-keyword">SHOW</span> timezone;
<span class="hljs-keyword">SHOW</span> datestyle;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc4bfadb7b2748738d03f050d7957b63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771116079&amp;x-signature=R0ZKYu73oJel8G7vpHIfB0eqv%2Bs%3D" alt="d7359054bbb1085d9edd89a99caacf6e.png" loading="lazy"/></p>
<p>这段输出建议直接保存到迁移记录里。后面如果出现“怎么突然对不上”的情况，十有八九都能从这里找到线索：某个环节时区不一致、编码不一致、排序规则不一致，问题就会变得非常“玄学”。</p>
<h3 data-id="heading-4">3.2 给对账留一个落点：断点表与审计表</h3>
<p>对账最怕的就是“人肉记断点”。我一般会在目标库里先放一张断点表：切换窗口、增量回放、出问题重跑，全靠它把流程拉回可控状态：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> mig_checkpoint (
  job_name      <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">PRIMARY</span> KEY,
  last_ts       <span class="hljs-type">TIMESTAMP</span>,
  last_pk       <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">200</span>),
  updated_at    <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
);
</code></pre>
<p>如果你的主键是复合键也没关系，把 <code>last_pk</code> 存成一个可比较的拼接串就行（后面会给“时间 + 主键”的双条件断点写法）。</p>
<h3 data-id="heading-5">3.3 明确对账口径：哪些表必须“强一致”</h3>
<p>我会先把表分三类，避免上来就把所有表按同一个标准“压死”，最后把精力耗在不关键的地方：</p>
<ul>
<li><strong>强一致表</strong>：订单、资金、余额、库存这类表，切换日必须逐表核对到行级；</li>
<li><strong>弱一致表</strong>：日志、行为、统计类表，允许在窗口内延迟补齐；</li>
<li><strong>可重建表</strong>：缓存、索引、聚合中间表，允许重刷重算。</li>
</ul>
<p>对账脚本先把强一致表覆盖住，先把最大的风险关掉，再谈扩面。</p>
<hr/>
<h2 data-id="heading-6">4. 全量导入后的“必做四件事”：从快到慢逐层加码</h2>
<p>下面以“目标库自检”为主来写。源端如果也能跑同口径 SQL，那就最省心：两边直接对输出；如果源端口径不方便统一，就把源端结果落文件，再做比对。</p>
<h3 data-id="heading-7">4.1 行数对账：先按时间/分区分段，再汇总</h3>
<p>对账别一上来就 <code>COUNT(*)</code> 打到底。更稳的做法是“分段对账”：先把范围切碎，一旦不一致，定位就会非常快——不用在全表里盲找：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span>
  TO_CHAR(order_time, <span class="hljs-string">'YYYY-MM-DD'</span>) <span class="hljs-keyword">AS</span> d,
  <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> cnt
<span class="hljs-keyword">FROM</span> t_order
<span class="hljs-keyword">WHERE</span> order_time <span class="hljs-operator">&gt;=</span> TO_TIMESTAMP(<span class="hljs-string">'2026-02-01 00:00:00'</span>,<span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span>)
  <span class="hljs-keyword">AND</span> order_time <span class="hljs-operator">&lt;</span>  TO_TIMESTAMP(<span class="hljs-string">'2026-03-01 00:00:00'</span>,<span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span>)
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> TO_CHAR(order_time, <span class="hljs-string">'YYYY-MM-DD'</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> d;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6df81600137048b4afc657dfee6d6904~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771116079&amp;x-signature=Kij2Bo0FJz5wK%2BwaW1olKQ5UkBA%3D" alt="image.png" loading="lazy"/></p>
<p>如果你按月/按天分区，这条 SQL 的输出就是最省心的“定位器”：哪一天对不上，先把那一天的导入日志和增量回放盯住，效率会高很多。</p>
<h3 data-id="heading-8">4.2 主键完整性：空值、重复、异常增长</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> pk_null_cnt <span class="hljs-keyword">FROM</span> t_order <span class="hljs-keyword">WHERE</span> order_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;

<span class="hljs-keyword">SELECT</span> order_id, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> dup_cnt
<span class="hljs-keyword">FROM</span> t_order
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> order_id
<span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> dup_cnt <span class="hljs-keyword">DESC</span>;
</code></pre>
<p>主键重复不一定会当场报错（取决于你导入时有没有先建约束、有没有做冲突处理），但它几乎一定会在后面变成“明细挂错主表”“同一订单被覆盖”的隐性事故。</p>
<h3 data-id="heading-9">4.3 参照关系断链：找“孤儿行”</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> orphan_cnt
<span class="hljs-keyword">FROM</span> t_order_item i
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> t_order o <span class="hljs-keyword">ON</span> o.order_id <span class="hljs-operator">=</span> i.order_id
<span class="hljs-keyword">WHERE</span> o.order_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;
</code></pre>
<p>如果外键是在导入后才启用的，这一步基本必做。出现断链通常就三种可能：导入顺序不对、导入失败重跑没跑全、或者增量回放漏了主表数据。</p>
<h3 data-id="heading-10">4.4 汇总一致性：用“多指标”降低漏检概率</h3>
<p>只看一个指标很容易被“正好抵消”骗过（比如金额一增一减总和还不变）。我更喜欢用一个组合拳：数量、范围、时间边界、金额一起看，漏检概率会低很多：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span>
  <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> cnt,
  <span class="hljs-built_in">MIN</span>(order_id) <span class="hljs-keyword">AS</span> min_id,
  <span class="hljs-built_in">MAX</span>(order_id) <span class="hljs-keyword">AS</span> max_id,
  <span class="hljs-built_in">MIN</span>(order_time) <span class="hljs-keyword">AS</span> min_time,
  <span class="hljs-built_in">MAX</span>(order_time) <span class="hljs-keyword">AS</span> max_time,
  <span class="hljs-built_in">SUM</span>(total_amount) <span class="hljs-keyword">AS</span> sum_amount
<span class="hljs-keyword">FROM</span> t_order
<span class="hljs-keyword">WHERE</span> order_time <span class="hljs-operator">&gt;=</span> TO_TIMESTAMP(<span class="hljs-string">'2026-02-01 00:00:00'</span>,<span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span>)
  <span class="hljs-keyword">AND</span> order_time <span class="hljs-operator">&lt;</span>  TO_TIMESTAMP(<span class="hljs-string">'2026-03-01 00:00:00'</span>,<span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span>);
</code></pre>
<p>如果还想再“硬核”一点，我会把窗口再切成很多段（比如 1000 段，按主键范围或时间范围都行），逐段输出到文件，再做两端比对。麻烦是麻烦点，但确定性很高。</p>
<hr/>
<h2 data-id="heading-11">5. 字符集与排序规则：不是“乱码才算问题”</h2>
<p>字符集这类问题，最坑的往往不是“乱码”，而是下面这种更隐蔽的差异：</p>
<ul>
<li>同一个字符串在两端<strong>字节长度不同</strong>（尤其是包含表情、少数民族字符、特殊符号时）；</li>
<li>比较与排序规则差异导致“同条件查询结果不一致”（比如某些大小写/全半角的比较行为）。</li>
</ul>
<h3 data-id="heading-12">5.1 快速排查：字符长度 vs 字节长度分布</h3>
<p>在 ksql 里执行时，只复制粘贴 SQL 本体就行，不要把 Markdown 的 <code>sql / </code>也一起带进去。</p>
<p>下面用第 4 章出现过的 <code>t_order.remark</code> 做演示；你要检查别的业务表也很简单：把 <code>t_order/remark</code> 换成你自己的“文本列”就行。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span>
  <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> total_cnt,
  <span class="hljs-built_in">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> LENGTH(<span class="hljs-built_in">COALESCE</span>(remark,<span class="hljs-string">''</span>)) <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-keyword">OCTET_LENGTH</span>(<span class="hljs-built_in">COALESCE</span>(remark,<span class="hljs-string">''</span>)) <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> multibyte_cnt
<span class="hljs-keyword">FROM</span> t_order;
</code></pre>
<p>再抽几个“最容易出事”的样本（长度特别大、包含特殊字符的）出来，人工看一眼，心里会更踏实：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> order_id, remark, LENGTH(remark) <span class="hljs-keyword">AS</span> char_len, <span class="hljs-keyword">OCTET_LENGTH</span>(remark) <span class="hljs-keyword">AS</span> byte_len
<span class="hljs-keyword">FROM</span> t_order
<span class="hljs-keyword">WHERE</span> remark <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">OCTET_LENGTH</span>(remark) <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">20</span>;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55c61199218c4fbd9beb30b5f563e25f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771116079&amp;x-signature=H5xKSYno%2B0AJ2aH%2BKc%2B%2BzaVkJaA%3D" alt="image.png" loading="lazy"/></p>
<p>如果这里已经出现明显差异，我会优先回头核对 <code>server_encoding/client_encoding/lc_collate/lc_ctype</code>：抽取端、落地文件、导入端、应用连接端，任何一个环节不一致，都可能把问题“养大”。</p>
<hr/>
<h2 data-id="heading-13">6. 时间、时区与精度：一致性风险里最隐蔽的一类</h2>
<p>时间字段的风险我一般按三层来拆：</p>
<ol>
<li><strong>时区</strong>：同一时刻显示不同；</li>
<li><strong>格式</strong>：字符串解析口径不同；</li>
<li><strong>精度</strong>：亚秒部分被截断或四舍五入，导致“同秒内顺序”改变。</li>
</ol>
<h3 data-id="heading-14">6.1 用 ksql 固定时区口径并验证</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SHOW</span> timezone;
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7b6b53c72374d989f226a824e9ceed7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771116079&amp;x-signature=4rAfQqq2I2d7CM5pI6KbDGn9GFE%3D" alt="image.png" loading="lazy"/></p>
<p>切换前我会把对账会话的时区固定住（你也可以在应用侧统一设置），然后拿同一批样例数据去验证“显示一致、计算一致”。这一步看起来啰嗦，但能省掉后面一大堆扯皮。</p>
<h3 data-id="heading-15">6.2 精度风险的定位方法：看“同秒内排序”是否稳定</h3>
<p>做个极简测试就能看出很多问题：插入同一秒内不同亚秒的记录，然后按时间排序，看顺序是不是你以为的那样。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> t_ts_probe;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_ts_probe(
  id NUMBER(<span class="hljs-number">12</span>,<span class="hljs-number">0</span>) <span class="hljs-keyword">PRIMARY</span> KEY,
  ts <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_ts_probe <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, TO_TIMESTAMP(<span class="hljs-string">'2026-02-03 10:00:00.123456'</span>,<span class="hljs-string">'YYYY-MM-DD HH24:MI:SS.FF'</span>));
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_ts_probe <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, TO_TIMESTAMP(<span class="hljs-string">'2026-02-03 10:00:00.123457'</span>,<span class="hljs-string">'YYYY-MM-DD HH24:MI:SS.FF'</span>));
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-keyword">SELECT</span> id, TO_CHAR(ts,<span class="hljs-string">'YYYY-MM-DD HH24:MI:SS.FF6'</span>) <span class="hljs-keyword">AS</span> ts_fmt
<span class="hljs-keyword">FROM</span> t_ts_probe
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ts;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1d2393d953841e79af19a390343764a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771116079&amp;x-signature=6JcIfUh6peF05g6VjdnZz4thB7Y%3D" alt="image.png" loading="lazy"/></p>
<p>如果源端时间精度更高，而目标端只能落到更低精度，迁移阶段就得提前把策略定下来：是截断还是四舍五入？要不要把“原始时间串/原始刻度”额外落一列？不然到了审计、追责或者复盘的时候，很容易出现“解释不清的顺序差异”。</p>
<hr/>
<h2 data-id="heading-16">7. LOB（大对象）：迁移“成功”不等于“可用”</h2>
<p>LOB 的问题通常不是“有没有值”，而是“值是不是还能用”：</p>
<ul>
<li>长文本尾部被截断（肉眼不容易发现）；</li>
<li>二进制内容被编码转换破坏（文件打不开）；</li>
<li>导入过程中发生分段丢失或拼接顺序错误。</li>
</ul>
<h3 data-id="heading-17">7.1 先做分布检查：长度、空值、极端值</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span>
  <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> total_cnt,
  <span class="hljs-built_in">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> doc <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> null_cnt,
  <span class="hljs-built_in">MIN</span>(LENGTH(doc)) <span class="hljs-keyword">AS</span> min_len,
  <span class="hljs-built_in">MAX</span>(LENGTH(doc)) <span class="hljs-keyword">AS</span> max_len
<span class="hljs-keyword">FROM</span> t_doc;
</code></pre>
<p>再把“最长的那一批”抽出来人工验收一下（这一步经常能抓到截断问题）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> doc_id, LENGTH(doc) <span class="hljs-keyword">AS</span> len
<span class="hljs-keyword">FROM</span> t_doc
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> LENGTH(doc) <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">20</span>;
</code></pre>
<h3 data-id="heading-18">7.2 抽样导出 + 文件哈希：在 Windows 上最直观</h3>
<p>对关键文档/合同/附件这类数据，我更相信“导出到文件再比”。数据库里看一眼字段内容，很多时候并不能说明它真的可用。</p>
<p>在 ksql 里按业务主键抽样导出：</p>
<pre><code class="hljs language-sql" lang="sql">\<span class="hljs-keyword">copy</span> (<span class="hljs-keyword">SELECT</span> doc_id, doc <span class="hljs-keyword">FROM</span> t_doc <span class="hljs-keyword">WHERE</span> doc_id <span class="hljs-keyword">IN</span> (<span class="hljs-number">1001</span>,<span class="hljs-number">1002</span>,<span class="hljs-number">1003</span>) <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> doc_id) <span class="hljs-keyword">TO</span> <span class="hljs-string">'D:\\mig_check\\doc_sample.csv'</span> <span class="hljs-keyword">WITH</span> (FORMAT csv, DELIMITER E<span class="hljs-string">'\t'</span>, HEADER <span class="hljs-literal">true</span>)
</code></pre>
<p>然后在 PowerShell 里计算文件哈希（同一批样本两端导出后比对哈希即可）：</p>
<pre><code class="hljs language-powershell" lang="powershell">certutil -hashfile D:\mig_check\doc_sample.csv SHA256
</code></pre>
<p>文件级校验的好处在于：它绕开了“看着差不多”的主观判断，把验证变成一条能复现、能留档的证据链。</p>
<hr/>
<h2 data-id="heading-19">8. 增量同步：checkpoint 设计不当会丢数，也会重复</h2>
<p>增量同步里最常见的“坑中坑”，就是只用一个时间字段当断点：</p>
<ul>
<li>同一秒内多行变更，断点条件写成 <code>&gt;</code> 会丢行，写成 <code>&gt;=</code> 会重复；</li>
<li>时间字段精度不足或被截断，边界更容易错；</li>
<li>更新乱序（先写后补）导致“晚到的数据”被跳过。</li>
</ul>
<h3 data-id="heading-20">8.1 推荐的断点口径：时间 + 主键双条件</h3>
<p>更稳的做法是把断点拆成两部分：<code>last_ts</code> 和 <code>last_pk</code>。抽取条件按“时间优先、主键补齐”的思路来写：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> t_order
<span class="hljs-keyword">WHERE</span> order_time <span class="hljs-operator">&gt;</span>  :last_ts
   <span class="hljs-keyword">OR</span> (order_time <span class="hljs-operator">=</span> :last_ts <span class="hljs-keyword">AND</span> order_id <span class="hljs-operator">&gt;</span> :last_pk)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_time, order_id;
</code></pre>
<p>跑完一批以后，把最后一行的 <code>order_time/order_id</code> 写回 <code>mig_checkpoint</code>（实际项目里把 <code>order_time</code> 换成你的增量时间字段即可）。</p>
<h3 data-id="heading-21">8.2 回放窗口：用小成本换确定性</h3>
<p>我基本不会让增量断点“刚好卡边界”。更稳的办法是做回放窗口：比如每次都回放最近 5 分钟的数据，目标端再用主键做幂等落库（同主键更新覆盖或合并）。<br/>
这么做的好处很直接：就算出现乱序或延迟写入，也能在下一轮被兜住。</p>
<p>切换日前，我会专门做一轮“边界压测”，专打这些最容易翻车的场景：</p>
<ul>
<li>连续制造同一秒内 1000 条变更；</li>
<li>制造跨分钟、跨小时的补写；</li>
<li>制造回滚再提交的重复变更；</li>
<li>验证目标端最终状态与源端一致。</li>
</ul>
<hr/>
<h2 data-id="heading-22">9. 一张图：我常用的“切换日对账闭环”</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7750f6cc7e445ec9b556bc1ccf9a278~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771116079&amp;x-signature=jLkwaY%2FwgbtNrWEvMnwbG65nMZg%3D" alt="811d316e38a5323be56d9b27e1c8f589.png" loading="lazy"/></p>
<p>这套流程的重点不在“步骤多”，而在于每一步都有可执行的验证输出：出了问题能定位、能重跑，实在不行还能回滚。</p>
<hr/>
<h2 data-id="heading-23">10. 验收清单</h2>













































<table><thead><tr><th>类别</th><th>必验项</th><th>通过标准（示例）</th></tr></thead><tbody><tr><td>会话基线</td><td>编码/排序规则/时区</td><td>迁移链路所有环节一致</td></tr><tr><td>行级完整性</td><td>分段行数对账</td><td>强一致表 100% 对齐</td></tr><tr><td>约束一致性</td><td>主键/唯一/外键</td><td>启用成功，孤儿行=0，重复=0</td></tr><tr><td>汇总一致性</td><td>多指标汇总</td><td>cnt/min/max/sum 全一致</td></tr><tr><td>LOB 可用性</td><td>抽样导出校验</td><td>文件可打开，哈希一致</td></tr><tr><td>增量可靠性</td><td>checkpoint + 回放窗口</td><td>无丢数，无重复，最终态一致</td></tr><tr><td>切换可回滚</td><td>回滚路径可演练</td><td>回切脚本可执行、耗时可接受</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（91）如何在数据库回归测试中使用Hibernate？]]></title>    <link>https://juejin.cn/post/7603649945978617875</link>    <guid>https://juejin.cn/post/7603649945978617875</guid>    <pubDate>2026-02-07T23:16:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603649945978617875" data-draft-id="7603644943351316486" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（91）如何在数据库回归测试中使用Hibernate？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-07T23:16:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（91）如何在数据库回归测试中使用Hibernate？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-07T23:16:11.000Z" title="Sat Feb 07 2026 23:16:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>数据库回归测试用来确保对数据库的更改不会破坏现有功能。这可以包括验证插入、更新、删除操作以及高级查询等。使用Hibernate进行数据库回归测试，可以确保ORM层的正确性。</p>
<p>以下是一个详细的示例，结合代码讲解如何在数据库回归测试中使用Hibernate，包括数据库配置、编写实体类、设置数据访问对象 (DAO)、编写回归测试脚本。</p>
<h3 data-id="heading-0">前提条件</h3>
<ul>
<li>使用MySQL作为数据库。</li>
<li>使用Gradle作为构建工具。</li>
<li>使用JUnit进行回归测试。</li>
<li>使用Hibernate进行ORM操作。</li>
</ul>
<h3 data-id="heading-1">1. 设置Hibernate配置</h3>
<p>首先，创建一个Hibernate配置文件 <code>hibernate.cfg.xml</code>，用于连接数据库。</p>
<h4 data-id="heading-2"><code>hibernate.cfg.xml</code></h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span> <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/regression_test_db<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>db_user<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>db_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">2. 创建实体类</h3>
<p>定义一个简单的实体类来表示数据库表中的数据。</p>
<h4 data-id="heading-4"><code>User.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> String email;

    <span class="hljs-comment">// Getters and setters</span>
}
</code></pre>
<h3 data-id="heading-5">3. 配置Gradle</h3>
<p>在Gradle构建脚本中添加Hibernate和JUnit依赖。</p>
<h4 data-id="heading-6"><code>build.gradle</code></h4>
<pre><code class="hljs language-groovy" lang="groovy">plugins {
    id 'java'
}

repositories {
    mavenCentral()
}

dependencies {
    implementation 'org.hibernate:hibernate-core:5.6.5.Final'
    implementation 'mysql:mysql-connector-java:8.0.27'
    testImplementation 'org.junit.jupiter:junit-jupiter:5.8.2'
}

test {
    useJUnitPlatform()
}
</code></pre>
<h3 data-id="heading-7">4. 编写数据访问对象（DAO）</h3>
<p>编写一个数据访问对象类，用于执行数据库操作。</p>
<h4 data-id="heading-8"><code>UserDAO.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDAO</span> {
    <span class="hljs-keyword">private</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserDAO</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Configuration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>);
        sessionFactory = config.buildSessionFactory();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        session.save(user);
        transaction.commit();
        session.close();
    }

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> session.get(User.class, id);
        session.close();
        <span class="hljs-keyword">return</span> user;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        session.update(user);
        transaction.commit();
        session.close();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        session.delete(user);
        transaction.commit();
        session.close();
    }

    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">findAllUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        List&lt;User&gt; users = session.createQuery(<span class="hljs-string">"FROM User"</span>, User.class).list();
        session.close();
        <span class="hljs-keyword">return</span> users;
    }
}
</code></pre>
<h3 data-id="heading-9">5. 编写回归测试脚本</h3>
<p>使用JUnit编写回归测试脚本，验证插入、更新、删除等操作。</p>
<h4 data-id="heading-10"><code>UserDAOTest.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.junit.jupiter.api.*;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.junit.jupiter.api.Assertions.*;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDAOTest</span> {
    <span class="hljs-keyword">private</span> UserDAO userDAO;

    <span class="hljs-meta">@BeforeEach</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUp</span><span class="hljs-params">()</span> {
        userDAO = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserDAO</span>();
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSaveAndGetUser</span><span class="hljs-params">()</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        user.setName(<span class="hljs-string">"John Doe"</span>);
        user.setEmail(<span class="hljs-string">"john.doe@example.com"</span>);
        userDAO.saveUser(user);

        <span class="hljs-type">User</span> <span class="hljs-variable">retrievedUser</span> <span class="hljs-operator">=</span> userDAO.getUserById(user.getId());
        assertNotNull(retrievedUser);
        assertEquals(<span class="hljs-string">"John Doe"</span>, retrievedUser.getName());
        assertEquals(<span class="hljs-string">"john.doe@example.com"</span>, retrievedUser.getEmail());
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testUpdateUser</span><span class="hljs-params">()</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        user.setName(<span class="hljs-string">"Jane Doe"</span>);
        user.setEmail(<span class="hljs-string">"jane.doe@example.com"</span>);
        userDAO.saveUser(user);

        user.setName(<span class="hljs-string">"Jane Smith"</span>);
        userDAO.updateUser(user);

        <span class="hljs-type">User</span> <span class="hljs-variable">updatedUser</span> <span class="hljs-operator">=</span> userDAO.getUserById(user.getId());
        assertEquals(<span class="hljs-string">"Jane Smith"</span>, updatedUser.getName());
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDeleteUser</span><span class="hljs-params">()</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        user.setName(<span class="hljs-string">"Mark Doe"</span>);
        user.setEmail(<span class="hljs-string">"mark.doe@example.com"</span>);
        userDAO.saveUser(user);

        userDAO.deleteUser(user);
        <span class="hljs-type">User</span> <span class="hljs-variable">deletedUser</span> <span class="hljs-operator">=</span> userDAO.getUserById(user.getId());
        assertNull(deletedUser);
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testFindAllUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        user1.setName(<span class="hljs-string">"User1"</span>);
        user1.setEmail(<span class="hljs-string">"user1@example.com"</span>);
        userDAO.saveUser(user1);

        <span class="hljs-type">User</span> <span class="hljs-variable">user2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        user2.setName(<span class="hljs-string">"User2"</span>);
        user2.setEmail(<span class="hljs-string">"user2@example.com"</span>);
        userDAO.saveUser(user2);

        List&lt;User&gt; users = userDAO.findAllUsers();
        assertTrue(users.size() &gt;= <span class="hljs-number">2</span>);
    }
}
</code></pre>
<h3 data-id="heading-11">例子解释</h3>
<ol>
<li><strong>Hibernate配置：</strong> 配置一个Hibernate配置文件，用于连接数据库。</li>
<li><strong>实体类：</strong> 创建一个简单的实体类来表示数据库表中的数据。</li>
<li><strong>Gradle配置：</strong> 在Gradle构建脚本中添加Hibernate和JUnit依赖。</li>
<li><strong>数据访问对象（DAO）：</strong> 编写一个数据访问对象类，用于执行数据库操作。包括保存、获取、更新、删除和查询所有用户的方法。</li>
<li><strong>回归测试脚本：</strong> 使用JUnit编写回归测试脚本，验证各种数据库操作的正确性。测试脚本包括：
<ul>
<li>保存和获取用户：验证插入操作和通过ID获取用户的正确性。</li>
<li>更新用户：验证更新操作的正确性。</li>
<li>删除用户：验证删除操作的正确性。</li>
<li>查询所有用户：验证查询所有用户的正确性。</li>
</ul>
</li>
</ol>
<p>通过以上配置和代码示例，我们展示了如何在数据库回归测试中使用Hibernate。这包括配置Hibernate、定义实体类、编写数据访问对象、编写回归测试脚本，以及使用JUnit运行测试。此流程帮助确保数据库的更改不会破坏现有功能，保证系统的稳定性和可靠性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MongoDB（1）什么是MongoDB？]]></title>    <link>https://juejin.cn/post/7603643044034494500</link>    <guid>https://juejin.cn/post/7603643044034494500</guid>    <pubDate>2026-02-07T23:17:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603643044034494500" data-draft-id="7603656494905360390" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MongoDB（1）什么是MongoDB？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-07T23:17:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MongoDB（1）什么是MongoDB？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-07T23:17:25.000Z" title="Sat Feb 07 2026 23:17:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>MongoDB是一种开源的NoSQL数据库，使用文档型存储数据格式（类似于JSON的BSON格式），以解决传统关系型数据库在处理大数据和高并发场景中的局限性。</p>
<h3 data-id="heading-0">MongoDB的特点</h3>
<ol>
<li><strong>文档存储</strong>：使用类似JSON的BSON格式存储数据。</li>
<li><strong>灵活的模式</strong>：无需预定义表结构，支持动态模式。</li>
<li><strong>高可用性</strong>：通过副本集实现数据的冗余和自动故障恢复。</li>
<li><strong>水平扩展</strong>：通过分片技术实现数据分布到多个节点。</li>
<li><strong>强大的查询能力</strong>：支持丰富的查询语法和聚合功能。</li>
</ol>
<h3 data-id="heading-1">安装与配置</h3>
<h4 data-id="heading-2">1. 安装 MongoDB</h4>
<p>可以通过包管理器或者下载压缩包的方式安装MongoDB。在Ubuntu上，可以使用以下命令安装：</p>
<pre><code class="hljs language-bash" lang="bash">sudo apt-get update
sudo apt-get install -y mongodb
</code></pre>
<h4 data-id="heading-3">2. 启动和停止 MongoDB</h4>
<p>启动MongoDB服务：</p>
<pre><code class="hljs language-bash" lang="bash">sudo service mongodb start
</code></pre>
<p>停止MongoDB服务：</p>
<pre><code class="hljs language-bash" lang="bash">sudo service mongodb stop
</code></pre>
<h3 data-id="heading-4">基本操作示例</h3>
<h4 data-id="heading-5">1. 创建数据库和集合</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 连接 MongoDB</span>
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">MongoClient</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongodb'</span>);
<span class="hljs-keyword">const</span> url = <span class="hljs-string">'mongodb://localhost:27017'</span>;
<span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MongoClient</span>(url);

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">run</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">connect</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Connected to MongoDB"</span>);

        <span class="hljs-keyword">const</span> db = client.<span class="hljs-title function_">db</span>(<span class="hljs-string">'mydatabase'</span>); <span class="hljs-comment">// 创建或选择数据库</span>
        <span class="hljs-keyword">const</span> collection = db.<span class="hljs-title function_">collection</span>(<span class="hljs-string">'users'</span>); <span class="hljs-comment">// 创建或选择集合</span>

        <span class="hljs-comment">// 插入文档</span>
        <span class="hljs-keyword">const</span> insertResult = <span class="hljs-keyword">await</span> collection.<span class="hljs-title function_">insertOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"John Doe"</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">"john.doe@example.com"</span> });
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Inserted document:'</span>, insertResult.<span class="hljs-property">ops</span>[<span class="hljs-number">0</span>]);

        <span class="hljs-comment">// 查询文档</span>
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> collection.<span class="hljs-title function_">findOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"John Doe"</span> });
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Found document:'</span>, user);

        <span class="hljs-comment">// 更新文档</span>
        <span class="hljs-keyword">const</span> updateResult = <span class="hljs-keyword">await</span> collection.<span class="hljs-title function_">updateOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"John Doe"</span> }, { <span class="hljs-attr">$set</span>: { <span class="hljs-attr">email</span>: <span class="hljs-string">"john.doe@newdomain.com"</span> } });
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Updated document count:'</span>, updateResult.<span class="hljs-property">modifiedCount</span>);

        <span class="hljs-comment">// 删除文档</span>
        <span class="hljs-keyword">const</span> deleteResult = <span class="hljs-keyword">await</span> collection.<span class="hljs-title function_">deleteOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"John Doe"</span> });
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Deleted document count:'</span>, deleteResult.<span class="hljs-property">deletedCount</span>);
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">close</span>();
    }
}

<span class="hljs-title function_">run</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">dir</span>);
</code></pre>
<h4 data-id="heading-6">2. 使用索引</h4>
<p>索引对于提高查询性能非常重要。以下示例展示如何创建索引：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createIndex</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> { <span class="hljs-title class_">MongoClient</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongodb'</span>);
    <span class="hljs-keyword">const</span> url = <span class="hljs-string">'mongodb://localhost:27017'</span>;
    <span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MongoClient</span>(url);

    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">connect</span>();
        <span class="hljs-keyword">const</span> db = client.<span class="hljs-title function_">db</span>(<span class="hljs-string">'mydatabase'</span>);
        <span class="hljs-keyword">const</span> collection = db.<span class="hljs-title function_">collection</span>(<span class="hljs-string">'users'</span>);

        <span class="hljs-comment">// 创建索引</span>
        <span class="hljs-keyword">const</span> indexName = <span class="hljs-keyword">await</span> collection.<span class="hljs-title function_">createIndex</span>({ <span class="hljs-attr">email</span>: <span class="hljs-number">1</span> });
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Created index:'</span>, indexName);

        <span class="hljs-comment">// 查询使用索引</span>
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> collection.<span class="hljs-title function_">findOne</span>({ <span class="hljs-attr">email</span>: <span class="hljs-string">"john.doe@newdomain.com"</span> });
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Found document using index:'</span>, user);
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">close</span>();
    }
}

<span class="hljs-title function_">createIndex</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">dir</span>);
</code></pre>
<h4 data-id="heading-7">3. 聚合操作</h4>
<p>聚合操作用于处理数据并返回计算结果。以下示例展示如何进行聚合操作：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">aggregationExample</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> { <span class="hljs-title class_">MongoClient</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongodb'</span>);
    <span class="hljs-keyword">const</span> url = <span class="hljs-string">'mongodb://localhost:27017'</span>;
    <span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MongoClient</span>(url);

    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">connect</span>();
        <span class="hljs-keyword">const</span> db = client.<span class="hljs-title function_">db</span>(<span class="hljs-string">'mydatabase'</span>);
        <span class="hljs-keyword">const</span> collection = db.<span class="hljs-title function_">collection</span>(<span class="hljs-string">'orders'</span>);

        <span class="hljs-comment">// 插入多个文档</span>
        <span class="hljs-keyword">await</span> collection.<span class="hljs-title function_">insertMany</span>([
            { <span class="hljs-attr">product</span>: <span class="hljs-string">"Apple"</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">2.5</span> },
            { <span class="hljs-attr">product</span>: <span class="hljs-string">"Banana"</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">1.2</span> },
            { <span class="hljs-attr">product</span>: <span class="hljs-string">"Orange"</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">8</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">3.0</span> }
        ]);

        <span class="hljs-comment">// 使用聚合管道计算总销售额</span>
        <span class="hljs-keyword">const</span> aggregationPipeline = [
            { <span class="hljs-attr">$group</span>: { <span class="hljs-attr">_id</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">total</span>: { <span class="hljs-attr">$sum</span>: { <span class="hljs-attr">$multiply</span>: [<span class="hljs-string">"$quantity"</span>, <span class="hljs-string">"$price"</span>] } } } }
        ];

        <span class="hljs-keyword">const</span> aggResult = <span class="hljs-keyword">await</span> collection.<span class="hljs-title function_">aggregate</span>(aggregationPipeline).<span class="hljs-title function_">toArray</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Total sales:'</span>, aggResult[<span class="hljs-number">0</span>].<span class="hljs-property">total</span>);
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">close</span>();
    }
}

<span class="hljs-title function_">aggregationExample</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">dir</span>);
</code></pre>
<h3 data-id="heading-8">高级功能</h3>
<h4 data-id="heading-9">副本集</h4>
<p>副本集（Replica Set）是MongoDB高可用性的实现方式。它由一个主节点（Primary Node）和多个从节点（Secondary Nodes）组成。</p>
<p>要配置副本集，需要在配置文件中添加以下内容：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">replication:</span>
  <span class="hljs-attr">replSetName:</span> <span class="hljs-string">"rs0"</span>
</code></pre>
<p>然后启动MongoDB实例并初始化副本集：</p>
<pre><code class="hljs language-javascript" lang="javascript">rs.<span class="hljs-title function_">initiate</span>()
</code></pre>
<h4 data-id="heading-10">分片</h4>
<p>分片（Sharding）用于处理大量数据，将数据分布在多个服务器上。以下是分片的基本步骤：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 启用分片</span>
sh.<span class="hljs-title function_">enableSharding</span>(<span class="hljs-string">"mydatabase"</span>)

<span class="hljs-comment">// 为集合设置分片键</span>
sh.<span class="hljs-title function_">shardCollection</span>(<span class="hljs-string">"mydatabase.users"</span>, { <span class="hljs-string">"_id"</span>: <span class="hljs-number">1</span> })
</code></pre>
<h3 data-id="heading-11">总结</h3>
<p>MongoDB是一种灵活、可扩展的NoSQL数据库，适用于处理大规模数据和高并发应用。通过丰富的API和各种高级特性，如副本集和分片，MongoDB提供了强大的数据存储和管理能力。上述示例展示了MongoDB的基本操作、索引使用、聚合操作以及高级功能的配置，是理解和掌握MongoDB的良好起点。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入Vue 3响应式系统：为什么嵌套对象修改后界面不更新？]]></title>    <link>https://juejin.cn/post/7603771025855283251</link>    <guid>https://juejin.cn/post/7603771025855283251</guid>    <pubDate>2026-02-07T17:20:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603771025855283251" data-draft-id="7603651855236104201" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入Vue 3响应式系统：为什么嵌套对象修改后界面不更新？"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2026-02-07T17:20:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iDao技术魔方"/> <meta itemprop="url" content="https://juejin.cn/user/166781496080782"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入Vue 3响应式系统：为什么嵌套对象修改后界面不更新？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/166781496080782/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iDao技术魔方
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-07T17:20:39.000Z" title="Sat Feb 07 2026 17:20:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>一句话简介</strong>：Vue 3用Proxy重构了响应式系统，但嵌套对象的"深层响应"背后藏着5个致命陷阱。本文从源码级剖析响应性丢失的根本原因，并提供5种实战解决方案。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">📋 目录</h2>
<ul>
<li><a href="#1-%E8%83%8C%E6%99%AF%E4%B8%80%E4%B8%AA%E8%AE%A9%E4%BA%BA%E5%B4%A9%E6%BA%83%E7%9A%84bug" title="#1-%E8%83%8C%E6%99%AF%E4%B8%80%E4%B8%AA%E8%AE%A9%E4%BA%BA%E5%B4%A9%E6%BA%83%E7%9A%84bug">1. 背景：一个让人崩溃的Bug</a></li>
<li><a href="#2-%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86proxy%E7%9A%84%E4%BB%A3%E7%90%86%E9%99%B7%E9%98%B1" title="#2-%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86proxy%E7%9A%84%E4%BB%A3%E7%90%86%E9%99%B7%E9%98%B1">2. 核心原理：Proxy的"代理陷阱"</a></li>
<li><a href="#3-5%E7%A7%8D%E5%B8%B8%E8%A7%81%E9%99%B7%E9%98%B1%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" title="#3-5%E7%A7%8D%E5%B8%B8%E8%A7%81%E9%99%B7%E9%98%B1%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">3. 5种常见陷阱与解决方案</a></li>
<li><a href="#4-%E6%B7%B1%E6%8B%B7%E8%B4%9D%E7%9A%84%E5%9D%91%E4%BD%A0%E4%BB%A5%E4%B8%BA%E7%9A%84%E5%AE%89%E5%85%A8%E5%85%B6%E5%AE%9E%E6%98%AF%E5%99%A9%E6%A2%A6" title="#4-%E6%B7%B1%E6%8B%B7%E8%B4%9D%E7%9A%84%E5%9D%91%E4%BD%A0%E4%BB%A5%E4%B8%BA%E7%9A%84%E5%AE%89%E5%85%A8%E5%85%B6%E5%AE%9E%E6%98%AF%E5%99%A9%E6%A2%A6">4. 深拷贝的坑：你以为的安全其实是噩梦</a></li>
<li><a href="#5-%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%E8%A1%A8%E6%A0%BC%E5%B5%8C%E5%A5%97%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0" title="#5-%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%E8%A1%A8%E6%A0%BC%E5%B5%8C%E5%A5%97%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0">5. 实战案例：表格嵌套数据更新</a></li>
<li><a href="#6-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%A4%A7%E8%A7%84%E6%A8%A1%E6%95%B0%E6%8D%AE%E4%B8%8B%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5" title="#6-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%A4%A7%E8%A7%84%E6%A8%A1%E6%95%B0%E6%8D%AE%E4%B8%8B%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">6. 性能优化：大规模数据下的最佳实践</a></li>
<li><a href="#7-%E6%80%BB%E7%BB%93%E4%B8%8E%E9%81%BF%E5%9D%91%E6%B8%85%E5%8D%95" title="#7-%E6%80%BB%E7%BB%93%E4%B8%8E%E9%81%BF%E5%9D%91%E6%B8%85%E5%8D%95">7. 总结与避坑清单</a></li>
</ul>
<hr/>
<h2 data-id="heading-1">1. 背景：一个让人崩溃的Bug</h2>
<h3 data-id="heading-2">1.1 现场重现</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { reactive } from 'vue'

const state = reactive({
  user: {
    name: '张三',
    address: {
      city: '北京',
      district: '朝阳区'
    }
  }
})

// ❌ 这个操作不会触发界面更新！
const updateDistrict = () =&gt; {
  state.user.address.district = '海淀区'
  console.log('已修改为:', state.user.address.district) // 显示"海淀区"
  // 但界面上还是显示"朝阳区"！
}
&lt;/script&gt;

&lt;template&gt;
  &lt;div&gt;
    &lt;p&gt;当前区域: {{ state.user.address.district }}&lt;/p&gt;
    &lt;button @click="updateDistrict"&gt;修改区域&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<p><strong>是不是很像你昨天遇到的Bug？</strong></p>
<p>控制台显示数据已经变了，但界面纹丝不动。你开始怀疑人生：</p>
<ul>
<li>"我明明用了<code>reactive</code>，它不是深层的吗？"</li>
<li>"难道Vue 3的响应式坏了？"</li>
<li>"是不是需要手动调用什么方法？"</li>
</ul>
<h3 data-id="heading-3">1.2 为什么会这样？</h3>
<p>Vue 3的响应式系统基于ES6的<code>Proxy</code>，它确实提供了"深层响应"的能力。但问题出在<strong>JavaScript的对象引用机制</strong>和<strong>Vue的依赖收集时机</strong>上。</p>
<p>让我们从源码层面一探究竟。</p>
<hr/>
<h2 data-id="heading-4">2. 核心原理：Proxy的"代理陷阱"</h2>
<h3 data-id="heading-5">2.1 Vue 3响应式系统架构</h3>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────────────────────────┐
│                    Vue <span class="hljs-number">3</span> 响应式系统                      │
├─────────────────────────────────────────────────────────┤
│  原始对象 ──► Proxy代理 ──► 依赖收集(track) ──► 触发更新(trigger)  │
│     │           │              │               │        │
│     │           │              ▼               ▼        │
│     │           │         WeakMap存储      执行effect    │
│     │           │     {target: {key: Set&lt;effect&gt;}}      │
│     ▼           ▼                                       │
│  {<span class="hljs-selector-tag">a</span>: <span class="hljs-number">1</span>}    Proxy{<span class="hljs-selector-tag">a</span>: <span class="hljs-number">1</span>}                                  │
│              get() ──track──┐                           │
│              set() ──trigger┘                           │
└─────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-6">2.2 核心源码解析</h3>
<p>Vue 3的<code>reactive</code>函数简化实现：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 简化版源码（基于vuejs/core）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reactive</span>(<span class="hljs-params">obj</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(obj, {
    <span class="hljs-title function_">get</span>(<span class="hljs-params">target, key</span>) {
      <span class="hljs-comment">// 1. 收集依赖：谁在用这个属性</span>
      <span class="hljs-title function_">track</span>(target, key)
      <span class="hljs-keyword">const</span> result = target[key]
      <span class="hljs-comment">// 2. 递归代理：让嵌套对象也变成响应式</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isObject</span>(result)) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">reactive</span>(result)
      }
      <span class="hljs-keyword">return</span> result
    },
    <span class="hljs-title function_">set</span>(<span class="hljs-params">target, key, value</span>) {
      <span class="hljs-keyword">const</span> oldValue = target[key]
      target[key] = value
      <span class="hljs-comment">// 3. 触发更新：通知所有依赖这个属性的effect</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">hasChanged</span>(value, oldValue)) {
        <span class="hljs-title function_">trigger</span>(target, key)
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }
  })
}
</code></pre>
<h3 data-id="heading-7">2.3 依赖收集的"懒惰性"</h3>
<p><strong>关键问题</strong>：Vue的依赖收集是"按需"的。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">user</span>: {
    <span class="hljs-attr">address</span>: {
      <span class="hljs-attr">district</span>: <span class="hljs-string">'朝阳区'</span>
    }
  }
})

<span class="hljs-comment">// 场景1：模板中只访问了 state.user</span>
<span class="hljs-comment">// 收集的依赖：state ──► user</span>
<span class="hljs-comment">// 当修改 state.user.address.district 时：</span>
<span class="hljs-comment">// - 修改的是 address 对象，不是 user 对象</span>
<span class="hljs-comment">// - 没有触发 user 的 setter</span>
<span class="hljs-comment">// - 界面不更新！</span>

<span class="hljs-comment">// 场景2：模板中访问了 state.user.address.district</span>
<span class="hljs-comment">// 收集的依赖：state ──► user ──► address ──► district</span>
<span class="hljs-comment">// 这时修改 district 才会触发更新</span>
</code></pre>
<h3 data-id="heading-8">2.4 内存结构图解</h3>
<pre><code class="hljs language-javascript" lang="javascript">初始状态（未访问深层属性）：
┌─────────────────────────────────────┐
│  targetMap (<span class="hljs-title class_">WeakMap</span>)                │
│  ├─ <span class="hljs-attr">state</span>: depsMap                  │
│  │   └─ <span class="hljs-string">"user"</span>: <span class="hljs-title class_">Set</span>[<span class="hljs-title class_">ComponentEffect</span>]│
│  │   <span class="hljs-comment">// 注意：没有"address"和"district"的依赖！  │</span>
└─────────────────────────────────────┘

访问深层属性后：
┌─────────────────────────────────────────────────┐
│  targetMap (<span class="hljs-title class_">WeakMap</span>)                            │
│  ├─ <span class="hljs-attr">state</span>: depsMap                              │
│  │   ├─ <span class="hljs-string">"user"</span>: <span class="hljs-title class_">Set</span>[<span class="hljs-title class_">ComponentEffect</span>]            │
│  ├─ state.<span class="hljs-property">user</span>: depsMap (<span class="hljs-title class_">Proxy</span>)                 │
│  │   ├─ <span class="hljs-string">"address"</span>: <span class="hljs-title class_">Set</span>[<span class="hljs-title class_">ComponentEffect</span>]         │
│  ├─ state.<span class="hljs-property">user</span>.<span class="hljs-property">address</span>: depsMap (<span class="hljs-title class_">Proxy</span>)         │
│  │   ├─ <span class="hljs-string">"district"</span>: <span class="hljs-title class_">Set</span>[<span class="hljs-title class_">ComponentEffect</span>]        │
│  │   <span class="hljs-comment">// 现在修改 district 会触发更新了！        │</span>
└─────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-9">3. 5种常见陷阱与解决方案</h2>
<h3 data-id="heading-10">陷阱1：直接替换嵌套对象属性</h3>
<p><strong>❌ 错误示例：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { reactive } from 'vue'

const state = reactive({
  form: {
    name: '',
    items: [
      { id: 1, value: 'A' },
      { id: 2, value: 'B' }
    ]
  }
})

// 直接修改数组中的对象属性 - 不触发更新！
const updateItem = () =&gt; {
  state.form.items[0].value = 'C'  // ❌ 界面可能不更新
}
&lt;/script&gt;
</code></pre>
<p><strong>✅ 解决方案1：使用<code>Vue.set</code>风格的赋值</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方法A：使用 splice 触发数组更新</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateItem</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> newItems = [...state.<span class="hljs-property">form</span>.<span class="hljs-property">items</span>]
  newItems[<span class="hljs-number">0</span>] = { ...newItems[<span class="hljs-number">0</span>], <span class="hljs-attr">value</span>: <span class="hljs-string">'C'</span> }
  state.<span class="hljs-property">form</span>.<span class="hljs-property">items</span> = newItems  <span class="hljs-comment">// ✅ 触发更新</span>
}

<span class="hljs-comment">// 方法B：使用 Vue 提供的工具函数</span>
<span class="hljs-keyword">import</span> { set } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateItem</span> = (<span class="hljs-params"/>) =&gt; {
  state.<span class="hljs-property">form</span>.<span class="hljs-property">items</span>[<span class="hljs-number">0</span>].<span class="hljs-property">value</span> = <span class="hljs-string">'C'</span>
  <span class="hljs-comment">// 强制触发更新</span>
  state.<span class="hljs-property">form</span>.<span class="hljs-property">items</span> = [...state.<span class="hljs-property">form</span>.<span class="hljs-property">items</span>]
}
</code></pre>
<p><strong>✅ 解决方案2：使用<code>ref</code>而非<code>reactive</code></strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> form = <span class="hljs-title function_">ref</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">items</span>: [{ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'A'</span> }]
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateItem</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 通过 .value 访问，确保触发响应</span>
  form.<span class="hljs-property">value</span>.<span class="hljs-property">items</span>[<span class="hljs-number">0</span>].<span class="hljs-property">value</span> = <span class="hljs-string">'C'</span>
  <span class="hljs-comment">// 需要整体赋值才会触发</span>
  form.<span class="hljs-property">value</span>.<span class="hljs-property">items</span> = [...form.<span class="hljs-property">value</span>.<span class="hljs-property">items</span>]
}
</code></pre>
<h3 data-id="heading-11">陷阱2：解构赋值丢失响应性</h3>
<p><strong>❌ 错误示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">user</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> }
})

<span class="hljs-comment">// 解构会失去响应性！</span>
<span class="hljs-keyword">const</span> { user } = state
<span class="hljs-comment">// user 只是一个普通对象引用，不再是 Proxy</span>

<span class="hljs-comment">// 修改 user 不会触发界面更新</span>
user.<span class="hljs-property">name</span> = <span class="hljs-string">'李四'</span>  <span class="hljs-comment">// ❌ 界面不更新</span>
</code></pre>
<p><strong>✅ 解决方案：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方法1：始终通过原始对象访问</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateName</span> = (<span class="hljs-params"/>) =&gt; {
  state.<span class="hljs-property">user</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'李四'</span>  <span class="hljs-comment">// ✅ 会触发更新</span>
}

<span class="hljs-comment">// 方法2：使用 toRefs 保持响应性</span>
<span class="hljs-keyword">import</span> { reactive, toRefs } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">user</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> }
})

<span class="hljs-comment">// toRefs 会将对象的每个属性转换为 ref</span>
<span class="hljs-keyword">const</span> { user } = <span class="hljs-title function_">toRefs</span>(state)
<span class="hljs-comment">// 现在 user.value 是响应式的</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateName</span> = (<span class="hljs-params"/>) =&gt; {
  user.<span class="hljs-property">value</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'李四'</span>  <span class="hljs-comment">// ✅ 会触发更新</span>
}

<span class="hljs-comment">// 方法3：在 setup 中直接使用解构（仅限&lt;script setup&gt;）</span>
&lt;script setup&gt;
<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">user</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span> } })
<span class="hljs-comment">// 直接使用，不要解构</span>
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-12">陷阱3：数组索引修改不触发更新</h3>
<p><strong>❌ 错误示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> list = <span class="hljs-title function_">reactive</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>])

<span class="hljs-comment">// 直接通过索引修改</span>
list[<span class="hljs-number">0</span>] = <span class="hljs-number">100</span>  <span class="hljs-comment">// ❌ 可能不会触发更新（在某些边界情况下）</span>
</code></pre>
<p><strong>✅ 解决方案：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方法1：使用 splice</span>
list.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">100</span>)  <span class="hljs-comment">// ✅ 触发更新</span>

<span class="hljs-comment">// 方法2：重新赋值整个数组</span>
list[<span class="hljs-number">0</span>] = <span class="hljs-number">100</span>
list.<span class="hljs-property">length</span> = list.<span class="hljs-property">length</span>  <span class="hljs-comment">// 强制触发（hack方式，不推荐）</span>

<span class="hljs-comment">// 方法3：使用 ref 替代</span>
<span class="hljs-keyword">const</span> list = <span class="hljs-title function_">ref</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>])
list.<span class="hljs-property">value</span>[<span class="hljs-number">0</span>] = <span class="hljs-number">100</span>  <span class="hljs-comment">// ✅ 总是触发更新</span>
</code></pre>
<h3 data-id="heading-13">陷阱4：Object新增属性不响应</h3>
<p><strong>❌ 错误示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">user</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span> }
})

<span class="hljs-comment">// 添加新属性</span>
state.<span class="hljs-property">user</span>.<span class="hljs-property">age</span> = <span class="hljs-number">25</span>  <span class="hljs-comment">// ❌ 不会触发更新（即使访问过user）</span>
</code></pre>
<p><strong>✅ 解决方案：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方法1：使用 Object.assign</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(state.<span class="hljs-property">user</span>, { <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> })  <span class="hljs-comment">// ✅ 触发更新</span>

<span class="hljs-comment">// 方法2：预先声明所有可能用到的属性</span>
<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">user</span>: { 
    <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-literal">undefined</span>  <span class="hljs-comment">// 预先声明</span>
  }
})
state.<span class="hljs-property">user</span>.<span class="hljs-property">age</span> = <span class="hljs-number">25</span>  <span class="hljs-comment">// ✅ 现在会触发更新</span>

<span class="hljs-comment">// 方法3：使用 ref</span>
<span class="hljs-keyword">const</span> user = <span class="hljs-title function_">ref</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span> })
user.<span class="hljs-property">value</span> = { ...user.<span class="hljs-property">value</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> }  <span class="hljs-comment">// ✅ 触发更新</span>
</code></pre>
<h3 data-id="heading-14">陷阱5：深层嵌套对象的性能陷阱</h3>
<p><strong>❌ 问题场景：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> bigData = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-comment">// 1000条数据，每条都有深层嵌套</span>
  <span class="hljs-attr">list</span>: <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-literal">null</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> ({
    <span class="hljs-attr">id</span>: i,
    <span class="hljs-attr">info</span>: {
      <span class="hljs-attr">detail</span>: {
        <span class="hljs-attr">deep</span>: { <span class="hljs-attr">value</span>: i }
      }
    }
  }))
})
<span class="hljs-comment">// 每次访问都会递归创建 Proxy，性能爆炸！</span>
</code></pre>
<p><strong>✅ 解决方案：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { shallowRef, triggerRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 使用 shallowRef，只有 .value 是响应式的，内部不做深代理</span>
<span class="hljs-keyword">const</span> bigData = <span class="hljs-title function_">shallowRef</span>({
  <span class="hljs-attr">list</span>: <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-literal">null</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> ({
    <span class="hljs-attr">id</span>: i,
    <span class="hljs-attr">info</span>: { <span class="hljs-attr">detail</span>: { <span class="hljs-attr">deep</span>: { <span class="hljs-attr">value</span>: i } } }
  }))
})

<span class="hljs-comment">// 修改深层数据</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateDeep</span> = (<span class="hljs-params"/>) =&gt; {
  bigData.<span class="hljs-property">value</span>.<span class="hljs-property">list</span>[<span class="hljs-number">0</span>].<span class="hljs-property">info</span>.<span class="hljs-property">detail</span>.<span class="hljs-property">deep</span>.<span class="hljs-property">value</span> = <span class="hljs-number">999</span>
  <span class="hljs-comment">// 手动触发更新</span>
  <span class="hljs-title function_">triggerRef</span>(bigData)  <span class="hljs-comment">// ✅ 强制刷新界面</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-15">4. 深拷贝的坑：你以为的安全其实是噩梦</h2>
<h3 data-id="heading-16">4.1 深拷贝为什么会破坏响应性？</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> cloneDeep <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash/cloneDeep'</span>

<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">user</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">items</span>: [{ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> }] }
})

<span class="hljs-comment">// ❌ 致命错误：深拷贝后丢失了所有响应性！</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">saveData</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> dataToSave = <span class="hljs-title function_">cloneDeep</span>(state.<span class="hljs-property">user</span>)
  <span class="hljs-comment">// dataToSave 是一个纯对象，没有任何 Proxy 包装</span>
  <span class="hljs-comment">// 如果你把它赋回 state，响应性就彻底断了</span>
  state.<span class="hljs-property">user</span> = dataToSave  <span class="hljs-comment">// ❌ 现在 state.user 不再是响应式代理！</span>
}
</code></pre>
<h3 data-id="heading-17">4.2 正确的深拷贝姿势</h3>
<p><strong>场景1：需要提交到后端的数据</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { toRaw } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">saveData</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 使用 toRaw 获取原始对象（不会递归解包，性能更好）</span>
  <span class="hljs-keyword">const</span> rawData = <span class="hljs-title function_">toRaw</span>(state.<span class="hljs-property">user</span>)
  <span class="hljs-comment">// 发送给后端</span>
  <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">saveUser</span>(rawData)
}
</code></pre>
<p><strong>场景2：需要复制数据同时保持响应性</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">duplicateUser</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 方法1：逐个属性复制，保持响应性</span>
  <span class="hljs-keyword">const</span> newUser = <span class="hljs-title function_">reactive</span>({
    <span class="hljs-attr">name</span>: state.<span class="hljs-property">user</span>.<span class="hljs-property">name</span>,
    <span class="hljs-attr">items</span>: state.<span class="hljs-property">user</span>.<span class="hljs-property">items</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({ ...item }))
  })
  
  <span class="hljs-comment">// 方法2：使用 JSON 解析（注意：会丢失函数、Date等特殊类型）</span>
  <span class="hljs-keyword">const</span> newUser2 = <span class="hljs-title function_">reactive</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(state.<span class="hljs-property">user</span>)))
}
</code></pre>
<p><strong>场景3：使用 Immer 进行不可变更新</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { produce } <span class="hljs-keyword">from</span> <span class="hljs-string">'immer'</span>
<span class="hljs-keyword">import</span> { shallowRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">shallowRef</span>({
  <span class="hljs-attr">user</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">items</span>: [{ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'A'</span> }] }
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateItem</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// Immer 会创建新的不可变对象</span>
  state.<span class="hljs-property">value</span> = <span class="hljs-title function_">produce</span>(state.<span class="hljs-property">value</span>, <span class="hljs-function"><span class="hljs-params">draft</span> =&gt;</span> {
    draft.<span class="hljs-property">user</span>.<span class="hljs-property">items</span>[<span class="hljs-number">0</span>].<span class="hljs-property">value</span> = <span class="hljs-string">'B'</span>
  })
  <span class="hljs-comment">// shallowRef 检测到 .value 变化，触发更新 ✅</span>
}
</code></pre>
<h3 data-id="heading-18">4.3 深拷贝 vs 浅拷贝速查表</h3>









































<table><thead><tr><th>方法</th><th>是否破坏响应性</th><th>性能</th><th>适用场景</th></tr></thead><tbody><tr><td><code>JSON.parse(JSON.stringify())</code></td><td>✅ 是</td><td>中</td><td>简单对象，无循环引用</td></tr><tr><td><code>lodash.cloneDeep</code></td><td>✅ 是</td><td>低</td><td>复杂对象，需要完整复制</td></tr><tr><td><code>toRaw()</code></td><td>❌ 否（只读）</td><td>高</td><td>提交数据到后端</td></tr><tr><td><code>{...obj}</code></td><td>❌ 否（浅拷贝）</td><td>高</td><td>只需复制一层</td></tr><tr><td><code>structuredClone()</code></td><td>✅ 是</td><td>中</td><td>现代浏览器，支持更多类型</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-19">5. 实战案例：表格嵌套数据更新</h2>
<h3 data-id="heading-20">5.1 需求描述</h3>
<p>实现一个可编辑表格，支持：</p>
<ol>
<li>多行数据展示</li>
<li>每行可以展开显示子表格</li>
<li>子表格数据可编辑</li>
<li>编辑后实时更新</li>
</ol>
<h3 data-id="heading-21">5.2 完整代码实现</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { reactive, ref, nextTick } from 'vue'

// 表格数据结构
const tableData = reactive({
  rows: [
    {
      id: 1,
      name: '产品A',
      expanded: false,
      children: [
        { id: '1-1', sku: 'SKU001', stock: 100 },
        { id: '1-2', sku: 'SKU002', stock: 200 }
      ]
    },
    {
      id: 2,
      name: '产品B',
      expanded: false,
      children: [
        { id: '2-1', sku: 'SKU003', stock: 150 }
      ]
    }
  ]
})

// ✅ 正确的更新方法：展开/收起
const toggleExpand = (row) =&gt; {
  // 直接修改会触发更新
  row.expanded = !row.expanded
}

// ✅ 正确的更新方法：修改库存
const updateStock = (row, childIndex, newStock) =&gt; {
  // 方法1：直接修改嵌套属性（如果模板中访问过这个路径）
  row.children[childIndex].stock = newStock
  
  // 方法2：如果不确定是否访问过，强制刷新
  // row.children = [...row.children]
}

// ✅ 正确的更新方法：添加子项
const addChild = (row) =&gt; {
  const newChild = {
    id: `${row.id}-${row.children.length + 1}`,
    sku: `SKU00${Date.now()}`,
    stock: 0
  }
  // 使用 push 会触发更新
  row.children.push(newChild)
  
  // 确保展开以显示新添加的行
  row.expanded = true
}

// ❌ 错误示例：直接替换整个 children 数组可能丢失响应性
const wrongUpdate = (row) =&gt; {
  // 如果 row.children 是从外部传入的非响应式数据
  row.children = row.children.map(child =&gt; ({ ...child }))  // ⚠️ 危险！
}

// ✅ 安全示例：批量更新
const batchUpdate = async (row) =&gt; {
  // 批量修改前先冻结更新
  const originalChildren = JSON.parse(JSON.stringify(row.children))
  
  // 修改数据
  originalChildren.forEach(child =&gt; {
    child.stock += 10
  })
  
  // 一次性赋值，触发单次更新
  row.children = originalChildren
  
  // 等待 DOM 更新
  await nextTick()
  console.log('批量更新完成')
}
&lt;/script&gt;

&lt;template&gt;
  &lt;div class="table-container"&gt;
    &lt;table&gt;
      &lt;thead&gt;
        &lt;tr&gt;
          &lt;th&gt;展开&lt;/th&gt;
          &lt;th&gt;ID&lt;/th&gt;
          &lt;th&gt;名称&lt;/th&gt;
          &lt;th&gt;操作&lt;/th&gt;
        &lt;/tr&gt;
      &lt;/thead&gt;
      &lt;tbody&gt;
        &lt;template v-for="row in tableData.rows" :key="row.id"&gt;
          &lt;!-- 主行 --&gt;
          &lt;tr class="main-row"&gt;
            &lt;td&gt;
              &lt;button @click="toggleExpand(row)"&gt;
                {{ row.expanded ? '▼' : '▶' }}
              &lt;/button&gt;
            &lt;/td&gt;
            &lt;td&gt;{{ row.id }}&lt;/td&gt;
            &lt;td&gt;{{ row.name }}&lt;/td&gt;
            &lt;td&gt;
              &lt;button @click="addChild(row)"&gt;添加子项&lt;/button&gt;
              &lt;button @click="batchUpdate(row)"&gt;批量+10&lt;/button&gt;
            &lt;/td&gt;
          &lt;/tr&gt;
          
          &lt;!-- 子表格 --&gt;
          &lt;tr v-if="row.expanded" class="child-row"&gt;
            &lt;td colspan="4"&gt;
              &lt;table class="child-table"&gt;
                &lt;thead&gt;
                  &lt;tr&gt;
                    &lt;th&gt;SKU&lt;/th&gt;
                    &lt;th&gt;库存&lt;/th&gt;
                  &lt;/tr&gt;
                &lt;/thead&gt;
                &lt;tbody&gt;
                  &lt;tr v-for="(child, index) in row.children" :key="child.id"&gt;
                    &lt;td&gt;{{ child.sku }}&lt;/td&gt;
                    &lt;td&gt;
                      &lt;input 
                        type="number" 
                        v-model="child.stock"
                        @change="updateStock(row, index, child.stock)"
                      /&gt;
                    &lt;/td&gt;
                  &lt;/tr&gt;
                &lt;/tbody&gt;
              &lt;/table&gt;
            &lt;/td&gt;
          &lt;/tr&gt;
        &lt;/template&gt;
      &lt;/tbody&gt;
    &lt;/table&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.table-container {
  padding: 20px;
}
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}
.main-row {
  background: #f5f5f5;
}
.child-row {
  background: #fff;
}
.child-table {
  margin: 10px;
  width: calc(100% - 20px);
}
input {
  width: 80px;
  padding: 4px;
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-22">5.3 关键点总结</h3>
<ol>
<li><strong>模板访问路径很重要</strong>：确保模板中访问了你要修改的完整路径</li>
<li><strong>数组方法优先使用</strong>：<code>push</code>、<code>splice</code> 等方法会触发更新</li>
<li><strong>批量更新优化</strong>：多次修改后一次性赋值，减少重渲染次数</li>
<li><strong>nextTick 的时机</strong>：需要在 DOM 更新后执行操作时记得使用</li>
</ol>
<hr/>
<h2 data-id="heading-23">6. 性能优化：大规模数据下的最佳实践</h2>
<h3 data-id="heading-24">6.1 虚拟滚动 + shallowRef</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { shallowRef, ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 超大数据列表（10万条）</span>
<span class="hljs-keyword">const</span> hugeList = <span class="hljs-title function_">shallowRef</span>([
  <span class="hljs-comment">// 假设这里有10万条嵌套数据</span>
])

<span class="hljs-comment">// 只显示可视区域的数据</span>
<span class="hljs-keyword">const</span> visibleData = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> start = scrollTop.<span class="hljs-property">value</span> <span class="hljs-comment">// 当前滚动位置</span>
  <span class="hljs-keyword">const</span> end = start + visibleCount.<span class="hljs-property">value</span> <span class="hljs-comment">// 可视数量</span>
  <span class="hljs-keyword">return</span> hugeList.<span class="hljs-property">value</span>.<span class="hljs-title function_">slice</span>(start, end)
})

<span class="hljs-comment">// 修改数据时手动触发</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateItem</span> = (<span class="hljs-params">index, newData</span>) =&gt; {
  hugeList.<span class="hljs-property">value</span>[index] = newData
  <span class="hljs-title function_">triggerRef</span>(hugeList) <span class="hljs-comment">// 手动触发更新</span>
}
</code></pre>
<h3 data-id="heading-25">6.2 分页加载与局部响应</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { reactive, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-comment">// 只有当前页的数据是响应式的</span>
  <span class="hljs-attr">currentPageData</span>: [],
  <span class="hljs-comment">// 总数据只存原始数据，不做响应式处理</span>
  <span class="hljs-attr">allData</span>: []
})

<span class="hljs-comment">// 切换页面时更新响应式数据</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">changePage</span> = (<span class="hljs-params">page</span>) =&gt; {
  <span class="hljs-keyword">const</span> start = (page - <span class="hljs-number">1</span>) * pageSize
  <span class="hljs-keyword">const</span> end = start + pageSize
  <span class="hljs-comment">// 只让当前页数据成为响应式</span>
  state.<span class="hljs-property">currentPageData</span> = state.<span class="hljs-property">allData</span>.<span class="hljs-title function_">slice</span>(start, end)
}
</code></pre>
<h3 data-id="heading-26">6.3 使用 Map/Set 替代对象数组</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// ❌ 低效：大数组查找</span>
<span class="hljs-keyword">const</span> list = <span class="hljs-title function_">reactive</span>([
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">data</span>: {} },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">data</span>: {} },
  <span class="hljs-comment">// ... 10000条</span>
])
<span class="hljs-comment">// 查找需要 O(n)</span>
<span class="hljs-keyword">const</span> item = list.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> i.<span class="hljs-property">id</span> === targetId)

<span class="hljs-comment">// ✅ 高效：使用 Map</span>
<span class="hljs-keyword">const</span> dataMap = <span class="hljs-title function_">reactive</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>())
dataMap.<span class="hljs-title function_">set</span>(<span class="hljs-number">1</span>, { <span class="hljs-attr">data</span>: {} })
dataMap.<span class="hljs-title function_">set</span>(<span class="hljs-number">2</span>, { <span class="hljs-attr">data</span>: {} })
<span class="hljs-comment">// 查找只需 O(1)</span>
<span class="hljs-keyword">const</span> item = dataMap.<span class="hljs-title function_">get</span>(targetId)
</code></pre>
<hr/>
<h2 data-id="heading-27">7. 总结与避坑清单</h2>
<h3 data-id="heading-28">7.1 核心要点回顾</h3>
<pre><code class="hljs">┌─────────────────────────────────────────────────────────────┐
│                   Vue 3 嵌套数据更新避坑指南                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 访问路径原则                                            │
│     └── 模板中必须访问到你要修改的最深层属性                   │
│                                                             │
│  2. 赋值触发原则                                            │
│     └── 直接修改对象属性可能不触发，考虑整体替换              │
│                                                             │
│  3. 解构危险                                                │
│     └── 解构 reactive 对象会失去响应性，使用 toRefs          │
│                                                             │
│  4. 深拷贝陷阱                                              │
│     └── cloneDeep 会破坏响应性，使用 toRaw 或浅拷贝          │
│                                                             │
│  5. 性能优化                                                │
│     └── 大数据用 shallowRef + triggerRef 手动控制            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-29">7.2 快速决策流程图</h3>
<pre><code class="hljs language-scss" lang="scss">遇到嵌套数据不更新？
    │
    ├─ 是否在模板中访问了完整路径？
    │   ├─ 否 → 补充访问路径：{{ obj<span class="hljs-selector-class">.level1</span><span class="hljs-selector-class">.level2</span> }}
    │   └─ 是 → 继续
    │
    ├─ 是否使用了深拷贝(cloneDeep)？
    │   ├─ 是 → 换成 <span class="hljs-built_in">toRaw</span>() 或浅拷贝
    │   └─ 否 → 继续
    │
    ├─ 是否解构了 reactive 对象？
    │   ├─ 是 → 使用 <span class="hljs-built_in">toRefs</span>() 或避免解构
    │   └─ 否 → 继续
    │
    ├─ 数据量是否很大(&gt;<span class="hljs-number">1000</span>条)？
    │   ├─ 是 → 使用 shallowRef + triggerRef
    │   └─ 否 → 继续
    │
    └─ 尝试强制刷新：
        ├─ 数组：arr = <span class="hljs-selector-attr">[...arr]</span>
        ├─ 对象：obj = { ..<span class="hljs-selector-class">.obj</span> }
        └─ 或使用 <span class="hljs-built_in">nextTick</span>() 延迟更新
</code></pre>
<h3 data-id="heading-30">7.3 推荐工具函数</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/reactiveHelper.js</span>

<span class="hljs-keyword">import</span> { reactive, toRaw, isProxy } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">/**
 * 安全地更新嵌套对象属性
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">safeUpdate</span>(<span class="hljs-params">obj, path, value</span>) {
  <span class="hljs-keyword">const</span> keys = path.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>)
  <span class="hljs-keyword">let</span> current = obj
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i++) {
    current = current[keys[i]]
  }
  
  current[keys[keys.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]] = value
  
  <span class="hljs-comment">// 如果是 reactive 对象，触发更新</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isProxy</span>(obj)) {
    <span class="hljs-comment">// 强制刷新（hack 方式，慎用）</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(obj, obj)
  }
}

<span class="hljs-comment">/**
 * 深度克隆但保持响应性（适用于简单对象）
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">cloneReactive</span>(<span class="hljs-params">obj</span>) {
  <span class="hljs-keyword">const</span> raw = <span class="hljs-title function_">toRaw</span>(obj)
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">reactive</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(raw)))
}

<span class="hljs-comment">/**
 * 批量更新数组（减少重渲染）
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">batchUpdateArray</span>(<span class="hljs-params">arr, updates</span>) {
  <span class="hljs-comment">// updates: [{ index: 0, value: newValue }, ...]</span>
  <span class="hljs-keyword">const</span> newArr = [...arr]
  updates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">{ index, value }</span>) =&gt;</span> {
    newArr[index] = value
  })
  <span class="hljs-keyword">return</span> newArr
}
</code></pre>
<h3 data-id="heading-31">7.4 最后的话</h3>
<p>Vue 3的响应式系统基于Proxy确实是巨大的进步，但它不是银弹。理解<strong>依赖收集的惰性</strong>和<strong>Proxy的代理边界</strong>，是避免嵌套数据更新问题的关键。</p>
<p>记住：<strong>响应式不是魔法，是精确追踪</strong>。当你明白Vue在什么时机、追踪哪些依赖，你就能游刃有余地处理任何复杂的数据结构。</p>
<hr/>
<h2 data-id="heading-32">参考链接</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fextras%2Freactivity-in-depth.html" target="_blank" title="https://vuejs.org/guide/extras/reactivity-in-depth.html" ref="nofollow noopener noreferrer">Vue 3 响应式原理官方文档</a> - 验证状态: ✅</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fapi%2Freactivity-advanced.html" target="_blank" title="https://vuejs.org/api/reactivity-advanced.html" ref="nofollow noopener noreferrer">Vue 3 Reactivity API 高级用法</a> - 验证状态: ✅</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fcore%2Fissues%2F1387" target="_blank" title="https://github.com/vuejs/core/issues/1387" ref="nofollow noopener noreferrer">GitHub Issue #1387 - 嵌套属性更新问题</a> - 验证状态: ✅</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FProxy" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy" ref="nofollow noopener noreferrer">Proxy MDN 文档</a> - 验证状态: ✅</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fimmerjs.github.io%2Fimmer%2F" target="_blank" title="https://immerjs.github.io/immer/" ref="nofollow noopener noreferrer">Immer 不可变数据更新库</a> - 验证状态: ✅</li>
</ol>
<p><em>如果本文对你有帮助，欢迎点赞收藏！你在使用 Vue 3 响应式时还遇到过哪些坑？欢迎在评论区分享。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Skills.lc 是什么？为什么我会做（用）这个站]]></title>    <link>https://juejin.cn/post/7603651855236038665</link>    <guid>https://juejin.cn/post/7603651855236038665</guid>    <pubDate>2026-02-07T16:04:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603651855236038665" data-draft-id="7603674653152854025" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Skills.lc 是什么？为什么我会做（用）这个站"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-02-07T16:04:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HBLOG"/> <meta itemprop="url" content="https://juejin.cn/user/131597124767479"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Skills.lc 是什么？为什么我会做（用）这个站
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/131597124767479/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HBLOG
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-07T16:04:55.000Z" title="Sat Feb 07 2026 16:04:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在折腾 AI Agent、CLI 工具和各种自动化脚本的过程中，我一直有一个很现实的问题：</p>
<blockquote>
<p><strong>好的 skill / workflow 到底该放哪？怎么复用？</strong></p>
</blockquote>
<p>Prompt 太零散，放在 Notion、Gist、README 里，时间一长就找不到；<br/>
不同项目里反复复制粘贴，又很难维护；<br/>
看到 GitHub 上有人写了不错的 skill，也不知道怎么发现、怎么用。</p>
<p><strong>Skills.lc</strong> 就是在这样的背景下出现的。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fadmin.liuhaihua.cn%2Fwp-content%2Fuploads%2F2026%2F02%2Fimage.png" target="_blank" title="https://admin.liuhaihua.cn/wp-content/uploads/2026/02/image.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89cbce868f0849f4a87039fa9068f245~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSEJMT0c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771085098&amp;x-signature=cFVnXWqs4b%2B6y%2BQwajczioE5MBo%3D" alt="" loading="lazy"/></a></p>
<p>它本质上不是“又一个 AI 平台”，而是一个 <strong>技能索引与分发站点</strong>，专门用来收集、整理和同步各处的 <strong>Skill / Agent 能力描述</strong>，让它们变得可查、可用、可复用。</p>
<p>👉 官网： <a href="https://link.juejin.cn?target=https%3A%2F%2Fskills.lc%2F%3Futm_source%3Dchatgpt.com" target="_blank" title="https://skills.lc/?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">skills.lc/</a></p>
<h2 data-id="heading-0">Skills.lc 在解决什么问题</h2>
<p>如果一句话总结：</p>
<blockquote>
<p><strong>它让 skill 像 npm 包、pip 包一样，被统一管理和使用。</strong></p>
</blockquote>
<p>具体来说，有几个很实际的点。</p>
<h3 data-id="heading-1">1. Skill 不再是“散装 Prompt”</h3>
<p>在 Skills.lc 里，skill 通常以结构化方式存在（例如 <code>SKILL.md</code>），而不是一段随手写的提示词。<br/>
这意味着：</p>
<ul>
<li>能看懂它<strong>是做什么的</strong></li>
<li>能复用到不同项目</li>
<li>能长期维护，而不是一次性使用</li>
</ul>
<p>你可以把它理解成：<br/>
<strong>“给 AI 用的说明书，而不是一句话指令。”</strong></p>
<h3 data-id="heading-2">2. 把 GitHub、社区里的技能统一起来</h3>
<p>很多 skill 其实已经存在了，只是分散在：</p>
<ul>
<li>GitHub 仓库</li>
<li>各种 demo 项目</li>
<li>私人脚本库</li>
</ul>
<p>Skills.lc 做的事情之一，就是<strong>定期同步、扫描和索引这些仓库</strong>，判断哪些是 skill，然后统一展示出来。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fadmin.liuhaihua.cn%2Fwp-content%2Fuploads%2F2026%2F02%2Fimage-1.png" target="_blank" title="https://admin.liuhaihua.cn/wp-content/uploads/2026/02/image-1.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aff427f77c9a4406b822cc8700a10ebf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSEJMT0c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771085098&amp;x-signature=Ayhpbpdo%2FbQ4p%2FA8rlLbw7e4DoA%3D" alt="" loading="lazy"/></a></p>
<p>你不需要知道“作者是谁、仓库在哪”，<br/>
只需要关心：<strong>这个 skill 能不能解决你的问题。</strong></p>
<h3 data-id="heading-3">3. 安装和使用成本很低</h3>
<p>Skills.lc 并不强迫你使用某个特定平台或 IDE。</p>
<p>只要你在用：</p>
<ul>
<li>Claude / Codex / Cursor</li>
<li>各种 AI CLI 工具</li>
<li>Agent 框架</li>
</ul>
<p>都可以通过简单的方式把 skill 加进来，例如：</p>
<pre><code class="hljs language-bash" lang="bash">npx skills add owner/repo
</code></pre>
<p>这点对开发者来说非常重要：<br/>
<strong>不用换工具，只是多了能力。</strong></p>
<h2 data-id="heading-4">这个站更适合谁？</h2>
<p>如果你符合下面任意一条，基本都能用得上 Skills.lc：</p>
<ul>
<li>经常写 prompt / workflow，但管理很混乱</li>
<li>在做 AI Agent、自动化脚本、AI CLI 工具</li>
<li>希望把自己的 skill 开源出来，但不想自己搭展示站</li>
<li>想快速找“别人已经写好的解决方案”</li>
</ul>
<p>它不是给“只聊天”的用户准备的，<br/>
而是偏向 <strong>工程向、工具向、效率向</strong> 的人。</p>
<h2 data-id="heading-5">Skills.lc 不想做什么</h2>
<p>这里有一点也挺重要的。</p>
<p>Skills.lc 并不打算：</p>
<ul>
<li>绑定某一家模型</li>
<li>强推某种 Agent 框架</li>
<li>把 skill 变成封闭生态</li>
</ul>
<p>它更像是一个 <strong>“索引层 + 分发层”</strong>，而不是执行层。</p>
<p>怎么跑、用什么模型、集成到哪，都是你的自由。</p>
<h2 data-id="heading-6">总结一下</h2>
<p>如果你用一句偏“人话”的方式理解 Skills.lc：</p>
<blockquote>
<p><strong>它是一个帮你管理、发现和复用 AI 技能的地方。</strong></p>
</blockquote>
<p>不是为了炫技术，也不是为了造概念，<br/>
而是想解决一个很实际的问题：<br/>
<strong>写过的 skill，不要再丢。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[山野的风，城市的窗：一位拾粪爷爷与我的时代之问]]></title>    <link>https://juejin.cn/post/7603616672927547407</link>    <guid>https://juejin.cn/post/7603616672927547407</guid>    <pubDate>2026-02-07T16:08:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603616672927547407" data-draft-id="7603643385816186932" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="山野的风，城市的窗：一位拾粪爷爷与我的时代之问"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-02-07T16:08:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="修己xj"/> <meta itemprop="url" content="https://juejin.cn/user/2641475936724142"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            山野的风，城市的窗：一位拾粪爷爷与我的时代之问
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2641475936724142/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    修己xj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-07T16:08:12.000Z" title="Sat Feb 07 2026 16:08:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、黑白影像中的昨日</h2>
<p>今天在滑看手机时，一张九十年代的老照片忽然映入眼帘：一位穿着粗布衣裳的老人，背着一只粪筐，正弯着腰在路上拾粪。这一幕像一把沉默的钥匙，“咔哒”一声，轻轻旋开了我记忆的闸门——我又回到了童年那个黄土坡上的小村庄。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d69df2b12284b23b0e2883fae0bef89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771085292&amp;x-signature=1WncHBpNPOJid%2FcSS%2FqQQr5orFk%3D" alt="" loading="lazy"/></p>
<p>那时，村里也有这样一位爷爷。农闲时候，他总背着竹篾编的背篼，沿着村道慢慢走，看见驴粪、骡粪，便俯身拾起。如今想来，这样的画面在很多年轻人眼中，恐怕已陌生如传说。在那个年月，村里几乎家家都守着几亩田地，十有八九都养着头驴或骡子，犁地、驮货都靠它们。牲口走过，路上常留下粪便，那位爷爷便拾回去，或是给庄稼施肥，或是晒干了留着冬天烧炕取暖。那一弯腰、一拾取的瞬间，完成的不仅是劳动，更是土地与生命之间最朴素的循环。</p>
<h2 data-id="heading-1">二、回荡在山川之间的声音</h2>
<p>记忆里，一到六月麦熟，天还未亮透，山野间便人影绰绰。人们在麦浪里起伏，镰刀划过麦秆的沙沙声、扁担吱呀的声响、偶尔几句家常的谈笑，让整片山谷都活了过来。累了，就蹲在田埂上喝口水，朝邻地的人喊几句话。声音荡出去，又被风轻轻送回来。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c014027a685d4f8d8f978efd6104926c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771085292&amp;x-signature=FmCeeFnbJmxE6jqKg%2FMLXb5sOW4%3D" alt="" loading="lazy"/></p>
<p>十月播种小麦时，漫山遍野又响起吆喝牲口的呼声——“驾！”“吁！”……粗朴、响亮，却满是泥土的生机。那时村里已有人南下打工，过年回来时穿着牛仔裤，叼着带滤嘴的香烟，说起外面的世界眼里有光。年少的我听着，心里暗暗羡慕，也悄悄埋下一颗种子：长大了，我也要去远方，去城市，闯一片自己的天地。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ac572edb2b142ff9d1c392c1c01efe3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771085292&amp;x-signature=KqujZxrOQHdfN94p1kOPRAATUQA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">三、现实的第一记耳光</h2>
<p>后来我考上大学，学了机械设计。毕业后进入西宁特钢，满怀憧憬地准备迎接“白领人生”。然而现实很快给了我清醒的一课——想象中的白衬衫、空调房、电脑办公一样都没出现。报到第一天，我就被分到生产一线巡检设备。车间里粉尘弥漫，能见度常不足一米。我们戴着被戏称为“猪嘴”的防尘口罩进去，出来时浑身漆黑，只剩眼睛还透着一点亮光。每周清洗工作服，盆底都能沉淀出厚厚一层铁精粉。</p>
<p>在生产线上干了六个月，我选择了离开。心里总有一个声音反复地问：读了这么多年书，难道不是为了能在干净明亮的办公室里，体面地工作吗？</p>
<h2 data-id="heading-3">四、走进“格子间”，陷入新围城</h2>
<p>离开钢厂后，我在机械行业又辗转了两三年，最终决心转行，投身软件开发。比起从前，工作环境确是天壤之别：恒温的办公室、清凉的空调、一人一台电脑，一切都符合我曾经对“体面工作”的想象。家人也欣慰地说：“这下好了，风吹不着雨淋不着，再不用出力气了。”</p>
<p>可真正在这行深耕几年，一种新的迷茫却悄然滋生。高强度加班、技术迭代的焦虑、年龄渐长的紧迫、城市快节奏的生活，层层叠叠的压力如潮水般涌来。不知不觉间，我好像在疲于奔命中，弄丢了当年那个一心“要去远方”的少年，也模糊了远方真正的模样。</p>
<h2 data-id="heading-4">五、拾粪爷爷的“收获”，与我的“标尺”</h2>
<p>有时深夜加完班，我会莫名想起村里那位拾粪的爷爷。他这一生，有没有过“梦想”这个词？或许他的愿望很具体：今天多拾半筐粪，秋后土豆就能多收一袋；雨季来得刚好，麦子能顺顺利利归仓。日复一日，土地不欺人，付出就有回响。那是一种扎根在泥土里的踏实，也是看得见、摸得着的“收获”。</p>
<p>而我呢？曾经的梦想，似乎已被琐碎的日子稀释、淹没；对“成功”的定义，也渐渐被简化成几个数字和标签——月薪多少、住多大房子……可是，究竟多少钱才算够？多大的房子才能盛放下安稳？这些问题，问来问去，只剩一片沉默。</p>
<h2 data-id="heading-5">六、回不去的乡土，走不出的都市，与脱不下的“长衫”</h2>
<p>如今，我坐在六楼的空调房里，指尖敲打着键盘。窗外是城市的霓虹闪烁，窗内是代码与需求的循环。偶尔，我会想念那些飘着麦香的清晨，回荡在山谷间的吆喝，蹲在田埂上说笑的人们。但我也清楚地知道，我回不去了——不单是地理上，更是心境与生活方式上。</p>
<p>或许，每一代人都有各自时代的奔赴与困顿。拾粪爷爷那一辈的踏实劳作，与我这一代在都市丛林里的辗转焦虑，看似相隔遥远，却都在回应同一个生命的提问：我们究竟在追求什么？是世人眼中“更好的生活”，还是内心深处“更像自己的生活”？</p>
<p>我还没有找到确切的答案。但写下这些文字时，时光仿佛温柔地慢了一拍。窗外依旧车流如织、人声鼎沸，但至少在此刻，我的心里，悄悄飘进了一缕来自山野的、带着泥土气息的风。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9b26b17a1174ad8855015af411dd4d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771085292&amp;x-signature=IIWPMEFjlNIPjzeb5fGSfB6Gd9o%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>