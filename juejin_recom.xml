<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Spring Boot 实现单账号登录控制]]></title>    <link>https://juejin.cn/post/7582077175001366571</link>    <guid>https://juejin.cn/post/7582077175001366571</guid>    <pubDate>2025-12-11T00:04:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582077175001366571" data-draft-id="7582067084839796790" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 实现单账号登录控制"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-11T00:04:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风象南"/> <meta itemprop="url" content="https://juejin.cn/user/2524134428655159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 实现单账号登录控制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134428655159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风象南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T00:04:50.000Z" title="Thu Dec 11 2025 00:04:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在很多业务场景中，我们需要控制单个账号的登录数量。本文介绍一种轻量级实现方案，灵活支持单账号单登录和多登录两种模式。</p>
<p><strong>付费系统场景</strong>：某在线教育平台销售VIP会员账号，如果不限制登录数量，一个账号可能被多个用户共享，导致收入损失。平台需要确保一个付费账号只能有一个用户同时在线。</p>
<p><strong>企业办公系统</strong>：为了保证数据安全，企业OA系统通常要求员工账号只能在指定设备上登录。当员工在新设备登录时，需要自动踢出其他设备上的会话，防止账号被滥用。</p>
<h4 data-id="heading-0">传统方案的痛点</h4>
<p>传统的账号登录控制方案存在各种问题：</p>
<p><strong>Session方案的局限</strong>：使用HttpSession实现虽然简单，但在分布式环境下会面临Session共享的难题。引入Spring Session虽然可以解决问题，但增加了系统的复杂度和依赖，对于简单的需求来说有些"杀鸡用牛刀"。</p>
<p><strong>Spring Security的复杂性</strong>：Spring Security提供了强大的安全框架，但对于仅仅需要登录控制的需求来说，学习成本过高，配置复杂，而且引入了很多不必要的功能。</p>
<p><strong>数据库存储的性能问题</strong>：将登录状态存储在数据库中会导致每次请求都需要查询数据库，在高并发场景下会成为性能瓶颈。虽然可以通过缓存优化，但又增加了系统复杂度。</p>
<p><strong>前端状态管理的麻烦</strong>：传统的页面跳转方式已经不适应现代前端框架的需求。前后端分离架构需要统一的API接口和状态管理机制。</p>
<h2 data-id="heading-1">二、方案概述</h2>
<h4 data-id="heading-2">2.1 核心思路</h4>
<p>本文提出的方案基于以下几个核心理念：</p>
<p><strong>Token认证</strong>：使用自定义Token替代传统的Session机制。Token是无状态的，可以在分布式环境下轻松扩展，同时避免了Session共享的复杂性问题。</p>
<p><strong>拦截器验证</strong>：通过Spring MVC的拦截器机制统一处理登录验证。这种方式的优点是不需要修改业务代码，通过配置即可实现对所有请求的拦截。</p>
<p><strong>接口抽象</strong>：定义清晰的SessionManager接口，将存储逻辑与业务逻辑分离。这样既可以使用Map实现，也可以轻松切换到Redis，为系统扩展提供可能。</p>
<p><strong>模式切换</strong>：通过简单的配置项即可在"单登录"和"多登录"模式之间切换，满足不同业务场景的需求。</p>
<h4 data-id="heading-3">2.2 技术选型</h4>
<p><strong>核心依赖</strong></p>
<p>仅使用Spring Boot Web Starter，不引入任何额外的安全框架或中间件。</p>
<p><strong>存储方案</strong></p>
<p>单机部署：使用ConcurrentHashMap
分布式部署：通过接口抽象无缝切换到Redis</p>
<h2 data-id="heading-4">三、核心实现</h2>
<h4 data-id="heading-5">3.1 会话管理接口</h4>
<p>SessionManager接口是整个方案的核心，它定义了会话管理的所有基本操作：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SessionManager</span> {
    <span class="hljs-comment">// 登录：生成并返回Token</span>
    String <span class="hljs-title function_">login</span><span class="hljs-params">(String username, LoginInfo loginInfo)</span>;

    <span class="hljs-comment">// 登出：使指定Token失效</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">logout</span><span class="hljs-params">(String token)</span>;

    <span class="hljs-comment">// 验证：检查Token是否有效</span>
    TokenInfo <span class="hljs-title function_">validateToken</span><span class="hljs-params">(String token)</span>;

    <span class="hljs-comment">// 查询：获取用户的所有活跃Token</span>
    List <span class="hljs-title function_">getUserTokens</span><span class="hljs-params">(String username)</span>;

    <span class="hljs-comment">// 管理：强制用户下线</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">kickoutUser</span><span class="hljs-params">(String username)</span>;
}
</code></pre>
<h4 data-id="heading-6">3.2 Map实现方案</h4>
<p>MapSessionManager是基于ConcurrentHashMap的具体实现，它使用两个Map来管理会话状态：</p>
<p><strong>tokenMap</strong>：存储Token到TokenInfo的映射，用于快速验证Token的有效性。TokenInfo包含用户名、登录时间、过期时间等关键信息。</p>
<p><strong>userTokenMap</strong>：存储用户名到Token集合的映射，用于管理用户的所有会话。这样设计的好处是，当需要踢出用户时，可以快速找到该用户的所有Token并使其失效。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapSessionManager</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SessionManager</span> {
    <span class="hljs-comment">// Token -&gt; TokenInfo 的映射，用于验证</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Map</span> <span class="hljs-variable">tokenMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-comment">// Username -&gt; Token集合的映射，用于管理</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&gt; userTokenMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">login</span><span class="hljs-params">(String username, LoginInfo loginInfo)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> generateToken();
        <span class="hljs-type">TokenInfo</span> <span class="hljs-variable">tokenInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TokenInfo</span>(token, username, loginInfo,
            System.currentTimeMillis() + properties.getTokenExpireTime() * <span class="hljs-number">1000</span>);

        <span class="hljs-comment">// 单登录模式：先踢出旧会话</span>
        <span class="hljs-keyword">if</span> (properties.getMode() == LoginMode.SINGLE) {
            kickoutUser(username);
        }

        <span class="hljs-comment">// 存储新Token</span>
        tokenMap.put(token, tokenInfo);
        userTokenMap.computeIfAbsent(username, k -&gt; ConcurrentHashMap.newKeySet())
                   .add(token);

        <span class="hljs-keyword">return</span> token;
    }
}
</code></pre>
<h4 data-id="heading-7">3.3 拦截器设计</h4>
<p>LoginInterceptor负责拦截所有需要认证的请求，验证Token的有效性。它的设计要点包括：</p>
<p><strong>路径排除</strong>：静态资源、登录接口等不需要认证的路径需要被排除。</p>
<p><strong>Token提取</strong>：从HTTP请求头中提取Token，支持自定义Header名称。</p>
<p><strong>验证逻辑</strong>：调用SessionManager验证Token，将验证结果存入请求属性。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SessionManager sessionManager;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request,
                           HttpServletResponse response,
                           Object handler)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> getTokenFromRequest(request);
        <span class="hljs-keyword">if</span> (token == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> handleUnauthorized(response, &amp;#<span class="hljs-number">34</span>;请先登录&amp;#<span class="hljs-number">34</span>;);
        }

        <span class="hljs-type">TokenInfo</span> <span class="hljs-variable">tokenInfo</span> <span class="hljs-operator">=</span> sessionManager.validateToken(token);
        <span class="hljs-keyword">if</span> (tokenInfo == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> handleUnauthorized(response, &amp;#<span class="hljs-number">34</span>;登录已过期&amp;#<span class="hljs-number">34</span>;);
        }

        <span class="hljs-comment">// 将用户信息存入请求上下文</span>
        request.setAttribute(&amp;#<span class="hljs-number">34</span>;username&amp;#<span class="hljs-number">34</span>;, tokenInfo.getUsername());
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<h4 data-id="heading-8">3.4 配置管理</h4>
<p>LoginProperties集中管理所有可配置的参数，通过Spring Boot的配置机制，可以在application.yml中灵活调整：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">app:</span>
  <span class="hljs-attr">login:</span>
    <span class="hljs-comment"># 登录模式控制</span>
    <span class="hljs-attr">mode:</span> <span class="hljs-string">MULTIPLE</span>  <span class="hljs-comment"># SINGLE-单登录, MULTIPLE-多登录</span>

    <span class="hljs-comment"># Token相关配置</span>
    <span class="hljs-attr">token-expire-time:</span> <span class="hljs-number">1800</span>  <span class="hljs-comment"># 有效期30分钟</span>
    <span class="hljs-attr">token-header:</span> <span class="hljs-string">Authorization</span>  <span class="hljs-comment"># 请求头名称</span>
    <span class="hljs-attr">token-prefix:</span> <span class="hljs-string">TOKEN_</span>  <span class="hljs-comment"># Token前缀</span>

    <span class="hljs-comment"># 维护配置</span>
    <span class="hljs-attr">enable-auto-clean:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 启用自动清理</span>
    <span class="hljs-attr">clean-interval:</span> <span class="hljs-number">5</span>  <span class="hljs-comment"># 清理间隔（分钟）</span>
</code></pre>
<h2 data-id="heading-9">四、API接口设计</h2>
<h4 data-id="heading-10">4.1 接口定义</h4>
<p>系统提供了一套RESTful API接口，支持完整的用户会话管理功能：</p>






















































<table><thead><tr><th>接口路径</th><th>请求方法</th><th>功能说明</th><th>请求参数</th><th>响应数据</th></tr></thead><tbody><tr><td>/api/auth/login</td><td>POST</td><td>用户登录</td><td>username, password</td><td>Token信息</td></tr><tr><td>/api/auth/logout</td><td>POST</td><td>用户退出</td><td>无</td><td>操作结果</td></tr><tr><td>/api/auth/current</td><td>GET</td><td>当前用户</td><td>无</td><td>用户信息</td></tr><tr><td>/api/auth/online</td><td>GET</td><td>在线列表</td><td>无</td><td>用户名列表</td></tr><tr><td>/api/auth/tokens</td><td>GET</td><td>用户Tokens</td><td>username</td><td>Token列表</td></tr><tr><td>/api/auth/kickout</td><td>POST</td><td>踢出用户</td><td>username</td><td>操作结果</td></tr></tbody></table>
<h4 data-id="heading-11">4.2 统一响应格式</h4>
<p>所有API接口都遵循统一的响应格式，便于前端处理：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    &amp;#<span class="hljs-number">34</span>;code&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// 状态码</span>
    &amp;#<span class="hljs-number">34</span>;message&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;成功&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>   <span class="hljs-comment">// 提示信息</span>
    &amp;#<span class="hljs-number">34</span>;data&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>          <span class="hljs-comment">// 业务数据</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>状态码规范</strong>：</p>
<ul>
<li>200：请求成功</li>
<li>401：未认证或Token失效</li>
<li>403：权限不足</li>
<li>500：服务器内部错误</li>
</ul>
<h4 data-id="heading-12">4.3 登录认证流程</h4>
<p>完整的登录流程包括以下几个步骤：</p>
<p><strong>1. 用户提交凭据</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable constant_">POST</span> /api/auth/login
<span class="hljs-title class_">Content</span>-<span class="hljs-title class_">Type</span>: application/json

{
    &amp;#<span class="hljs-number">34</span>;username&amp;#<span class="hljs-number">34</span>;: &amp;#<span class="hljs-number">34</span>;admin&amp;#<span class="hljs-number">34</span>;,
    &amp;#<span class="hljs-number">34</span>;password&amp;#<span class="hljs-number">34</span>;: &amp;#<span class="hljs-number">34</span>;admin123&amp;#<span class="hljs-number">34</span>;
}
</code></pre>
<p><strong>2. 服务端验证并生成Token</strong>
服务端验证用户名密码后，生成一个唯一的Token，包含：</p>
<ul>
<li>Token字符串（UUID）</li>
<li>用户信息</li>
<li>登录时间</li>
<li>过期时间</li>
</ul>
<p><strong>3. 返回Token给客户端</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    &amp;#<span class="hljs-number">34</span>;code&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><span class="hljs-punctuation">,</span>
    &amp;#<span class="hljs-number">34</span>;message&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;登录成功&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
    &amp;#<span class="hljs-number">34</span>;data&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        &amp;#<span class="hljs-number">34</span>;token&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;TOKEN_550e8400-e29b<span class="hljs-number">-41</span>d4-a716<span class="hljs-number">-446655440000</span>&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
        &amp;#<span class="hljs-number">34</span>;username&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;admin&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
        &amp;#<span class="hljs-number">34</span>;expireTime&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-number">1704067200000</span><span class="hljs-punctuation">,</span>
        &amp;#<span class="hljs-number">34</span>;loginMode&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;MULTIPLE&amp;#<span class="hljs-number">34</span>;
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>4. 客户端存储Token</strong>
根据用户选择，Token可以存储在localStorage（长期有效）或sessionStorage（会话级别）。</p>
<p><strong>5. 后续请求携带Token</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable constant_">GET</span> /api/auth/current
<span class="hljs-title class_">Authorization</span>: TOKEN_550e8400-e29b-41d4-a716-<span class="hljs-number">446655440000</span>
</code></pre>
<p><strong>6. 服务端验证Token</strong>
拦截器自动验证Token的有效性，包括：</p>
<ul>
<li>Token是否存在</li>
<li>Token是否过期</li>
<li>Token是否被踢出</li>
</ul>
<h4 data-id="heading-13">4.4 错误处理机制</h4>
<p>当认证失败时，系统会返回明确的错误信息：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    &amp;#<span class="hljs-number">34</span>;code&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-number">401</span><span class="hljs-punctuation">,</span>
    &amp;#<span class="hljs-number">34</span>;message&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;Token已过期，请重新登录&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
    &amp;#<span class="hljs-number">34</span>;data&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>前端收到401响应后，会自动清除本地存储的Token，并跳转到登录页面。</p>
<h4 data-id="heading-14">4.5 管理功能接口</h4>
<p>管理员可以通过专门的接口管理系统用户：</p>
<p><strong>获取在线用户</strong>：返回当前所有在线用户的用户名列表，可用于监控和统计。</p>
<p><strong>踢出指定用户</strong>：强制指定用户下线，清除其所有Token，常用于处理异常情况。</p>
<p><strong>查看用户会话</strong>：获取指定用户的所有活跃Token，了解用户的登录状态。</p>
<h2 data-id="heading-15">五、前端实现</h2>
<h4 data-id="heading-16">5.1 核心实现</h4>
<p><strong>api.js</strong>：负责所有API请求的封装，包括Token管理、请求拦截、错误处理等。</p>
<p><strong>页面模块</strong>：login.html、index.html、admin.html各自负责独立的功能，通过import导入api模块。</p>
<p><strong>状态管理</strong>：使用localStorage和sessionStorage管理Token状态，支持"记住我"功能。</p>
<h4 data-id="heading-17">5.2 Token管理机制</h4>
<p>Token管理是前端的核心功能，实现了完整的生命周期管理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Token获取策略</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getToken</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 优先从localStorage获取（长期有效）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'token'</span>)
        || sessionStorage.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'token'</span>);  <span class="hljs-comment">// 再从sessionStorage获取</span>
}

<span class="hljs-comment">// Token存储策略</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setToken</span>(<span class="hljs-params">token, remember</span>) {
    <span class="hljs-keyword">if</span> (remember) {
        <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'token'</span>, token);  <span class="hljs-comment">// 用户选择&amp;#34;记住我&amp;#34;</span>
    } <span class="hljs-keyword">else</span> {
        sessionStorage.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'token'</span>, token);  <span class="hljs-comment">// 仅本次会话有效</span>
    }
}
</code></pre>
<p>这种设计的优势是给了用户选择权：隐私敏感的场景可以使用sessionStorage，确保关闭浏览器后自动清除；个人设备上可以使用localStorage，提供更好的用户体验。</p>
<h4 data-id="heading-18">5.3 请求拦截器</h4>
<p>前端实现了一个轻量级的请求拦截器，自动处理认证相关的逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">apiRequest</span>(<span class="hljs-params">url, options = {}</span>) {
    <span class="hljs-comment">// 自动添加Token</span>
    <span class="hljs-keyword">const</span> token = <span class="hljs-title function_">getToken</span>();
    <span class="hljs-keyword">if</span> (token) {
        options.<span class="hljs-property">headers</span> = {
            ...options.<span class="hljs-property">headers</span>,
            <span class="hljs-string">'Authorization'</span>: token
        };
    }

    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url, options);

    <span class="hljs-comment">// 统一处理401响应</span>
    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">status</span> === <span class="hljs-number">401</span>) {
        <span class="hljs-title function_">clearToken</span>();
        <span class="hljs-comment">// 避免在登录页重复跳转</span>
        <span class="hljs-keyword">if</span> (location.<span class="hljs-property">pathname</span> !== <span class="hljs-string">'/login.html'</span>) {
            location.<span class="hljs-property">href</span> = <span class="hljs-string">'/login.html'</span>;
        }
    }

    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();
}
</code></pre>
<p>这个拦截器实现了：</p>
<ul>
<li>自动携带Token，减少重复代码</li>
<li>统一的401处理，确保用户在Token失效时能够及时重新登录</li>
</ul>
<h2 data-id="heading-19">六、总结</h2>
<p>整个方案仅依赖Spring Boot Web，不需要引入任何额外的安全框架、缓存中间件或数据库。这使得项目的依赖保持最小化。</p>
<p>通过SessionManager接口抽象，实现了业务逻辑与存储逻辑的完全分离。当需要从单机扩展到分布式时，只需要实现一个基于Redis的SessionManager即可，业务代码无需任何修改。</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/yuboon</span><span class="hljs-regexp">/java-examples/tree</span><span class="hljs-regexp">/master/springboot</span>-single-login
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C# Params Collections 详解：比 params T[] 更强大的新语法]]></title>    <link>https://juejin.cn/post/7582090790181879846</link>    <guid>https://juejin.cn/post/7582090790181879846</guid>    <pubDate>2025-12-11T00:10:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582090790181879846" data-draft-id="7582041304655413294" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C# Params Collections 详解：比 params T[] 更强大的新语法"/> <meta itemprop="keywords" content="C#,.NET"/> <meta itemprop="datePublished" content="2025-12-11T00:10:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐青枫"/> <meta itemprop="url" content="https://juejin.cn/user/3737995266234280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C# Params Collections 详解：比 params T[] 更强大的新语法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3737995266234280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐青枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T00:10:11.000Z" title="Thu Dec 11 2025 00:10:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">简介</h3>
<p><code>Params Collections</code> 是 <code>C# 12</code> 中引入的新特性，它扩展了传统的 <code>params</code> 关键字功能，使其不仅支持数组，还能支持各种集合类型。这个特性使得方法能够接受可变数量的参数，并且这些参数可以自动转换为指定的集合类型。</p>
<p>关键特点：</p>
<ul>
<li>
<p>可变参数：调用者可以传递任意数量的参数（包括零个）。</p>
</li>
<li>
<p>类型安全：<code>params</code> 参数是强类型的，编译器确保参数类型匹配。</p>
</li>
<li>
<p>单一 <code>params</code> 参数：一个方法只能有一个 <code>params</code> 参数，且必须是最后一个参数。</p>
</li>
<li>
<p><code>C# 12</code> 扩展：支持非数组集合类型（如 <code>List</code>, <code>Span</code>），适合高性能或特定场景。</p>
</li>
</ul>
<h3 data-id="heading-1">核心特性</h3>
<h4 data-id="heading-2">支持任意集合类型</h4>
<ul>
<li>可指定 <code>List、Span、IReadOnlyCollection</code> 等作为参数类型</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">LogEntries</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> List messages</span>)</span> { ... }
</code></pre>
<h4 data-id="heading-3">自动集合构造</h4>
<ul>
<li>编译器自动将离散参数转换为目标集合类型实例</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">AnalyzeNumbers(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>); 
<span class="hljs-comment">// 等效于：</span>
AnalyzeNumbers(<span class="hljs-keyword">new</span> List { <span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span> });
</code></pre>
<h4 data-id="heading-4">与现有 params 兼容</h4>
<ul>
<li>
<p>传统 <code>params T[]</code> 仍然有效</p>
</li>
<li>
<p>新语法不会破坏已有代码</p>
</li>
</ul>
<h3 data-id="heading-5">传统 params 关键字</h3>
<p>在 <code>C# 12</code> 之前，<code>params</code> 关键字只能用于数组：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 传统的 params 数组用法</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessNumbers</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> <span class="hljs-built_in">int</span>[] numbers</span>)</span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> number <span class="hljs-keyword">in</span> numbers)
    {
        Console.WriteLine(number);
    }
}

<span class="hljs-comment">// 调用方式</span>
ProcessNumbers(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);
</code></pre>
<h3 data-id="heading-6">Params Collections 的新特性</h3>
<p><code>C# 12</code> 扩展了 <code>params</code> 关键字，使其能够用于任何集合类型，只要该类型满足特定条件。</p>
<h4 data-id="heading-7">基本语法</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 使用 params 与集合类型</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessNumbers</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> List numbers</span>)</span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> number <span class="hljs-keyword">in</span> numbers)
    {
        Console.WriteLine(number);
    }
}

<span class="hljs-comment">// 调用方式不变</span>
ProcessNumbers(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);
</code></pre>
<h3 data-id="heading-8">支持的条件</h3>
<p>要使集合类型能够与 <code>params</code> 关键字一起使用，必须满足以下条件之一：</p>
<ul>
<li>
<p>集合类型必须有一个无参数的构造函数</p>
</li>
<li>
<p>集合类型必须有一个 <code>Add</code> 方法，用于添加元素</p>
</li>
<li>
<p>集合类型必须实现 <code>IEnumerable</code></p>
</li>
</ul>
<h4 data-id="heading-9">自定义集合与 params</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 自定义集合类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">NumberCollection</span> : <span class="hljs-title">IEnumerable</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> List _numbers = <span class="hljs-keyword">new</span>();
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Add</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> number</span>)</span> =&gt; _numbers.Add(number);
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerator <span class="hljs-title">GetEnumerator</span>()</span> =&gt; _numbers.GetEnumerator();
    
    IEnumerator IEnumerable.GetEnumerator() =&gt; GetEnumerator();
}

<span class="hljs-comment">// 使用自定义集合作为 params 参数</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessNumbers</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> NumberCollection numbers</span>)</span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> number <span class="hljs-keyword">in</span> numbers)
    {
        Console.WriteLine(number);
    }
}

<span class="hljs-comment">// 调用</span>
ProcessNumbers(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);
</code></pre>
<h3 data-id="heading-10">实际应用示例</h3>
<h4 data-id="heading-11">与 Span 和 ReadOnlySpan 结合使用</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 使用 Span 作为 params 参数</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessData</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> Span data</span>)</span>
{
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; data.Length; i++)
    {
        data[i] *= <span class="hljs-number">2</span>;
    }
}

<span class="hljs-comment">// 调用</span>
<span class="hljs-built_in">int</span>[] array = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];
ProcessData(array);
Console.WriteLine(<span class="hljs-built_in">string</span>.Join(&amp;<span class="hljs-meta">#34;, &amp;#34;, array)); // 输出: 2, 4, 6, 8, 10</span>
</code></pre>
<h4 data-id="heading-12">与 Immutable Collections 结合使用</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> System.Collections.Immutable;

<span class="hljs-comment">// 使用不可变集合作为 params 参数</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessItems</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> ImmutableArray items</span>)</span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> items)
    {
        Console.WriteLine(item);
    }
}

<span class="hljs-comment">// 调用</span>
ProcessItems(&amp;<span class="hljs-meta">#34;apple&amp;#34;, &amp;#34;banana&amp;#34;, &amp;#34;cherry&amp;#34;);</span>
</code></pre>
<h3 data-id="heading-13">高级用法</h3>
<h4 data-id="heading-14">泛型方法与 params 集合</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 泛型方法中使用 params 集合</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessCollection</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> List collection</span>)
    <span class="hljs-keyword">where</span> T : <span class="hljs-keyword">notnull</span></span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> collection)
    {
        Console.WriteLine(item);
    }
}

<span class="hljs-comment">// 调用</span>
ProcessCollection(&amp;<span class="hljs-meta">#34;a&amp;#34;, &amp;#34;b&amp;#34;, &amp;#34;c&amp;#34;); // 字符串列表</span>
ProcessCollection(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>);       <span class="hljs-comment">// 整数列表</span>
</code></pre>
<h4 data-id="heading-15">与模式匹配结合使用</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 使用模式匹配处理 params 集合</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">HandleValues</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> <span class="hljs-built_in">int</span>[] values</span>)</span>
{
    <span class="hljs-keyword">switch</span> (values)
    {
        <span class="hljs-keyword">case</span> [<span class="hljs-keyword">var</span> first, .. <span class="hljs-keyword">var</span> middle, <span class="hljs-keyword">var</span> last]:
            Console.WriteLine($&amp;<span class="hljs-meta">#34;首: {first}, 尾: {last}, 中间有 {middle.Length} 个元素&amp;#34;);</span>
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> [<span class="hljs-keyword">var</span> single]:
            Console.WriteLine($&amp;<span class="hljs-meta">#34;单个值: {single}&amp;#34;);</span>
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> []:
            Console.WriteLine(&amp;<span class="hljs-meta">#34;空集合&amp;#34;);</span>
            <span class="hljs-keyword">break</span>;
    }
}

<span class="hljs-comment">// 调用</span>
HandleValues(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>); <span class="hljs-comment">// 输出: 首: 1, 尾: 5, 中间有 3 个元素</span>
HandleValues(<span class="hljs-number">42</span>);            <span class="hljs-comment">// 输出: 单个值: 42</span>
HandleValues();              <span class="hljs-comment">// 输出: 空集合</span>
</code></pre>
<h4 data-id="heading-16">与接口结合使用</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 使用接口作为 params 参数</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessEnumerables</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> IEnumerable[] collections</span>)</span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> collection <span class="hljs-keyword">in</span> collections)
    {
        <span class="hljs-built_in">int</span> sum = collection.Sum();
        Console.WriteLine($&amp;<span class="hljs-meta">#34;集合总和: {sum}&amp;#34;);</span>
    }
}

<span class="hljs-comment">// 调用</span>
ProcessEnumerables(
    <span class="hljs-keyword">new</span> List { <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span> },
    <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>[] { <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span> },
    <span class="hljs-keyword">new</span> HashSet { <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span> }
);
</code></pre>
<h4 data-id="heading-17">高性能求和（使用 <code>Span</code>）</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">decimal</span> <span class="hljs-title">Average</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> Span numbers</span>)</span>
{
    <span class="hljs-keyword">if</span> (numbers.Length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-built_in">decimal</span> sum = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> num <span class="hljs-keyword">in</span> numbers)
    {
        sum += num;
    }
    <span class="hljs-keyword">return</span> sum / numbers.Length;
}

Console.WriteLine(Average(<span class="hljs-number">1.5</span>m, <span class="hljs-number">2.5</span>m, <span class="hljs-number">3.5</span>m)); <span class="hljs-comment">// 输出: 2.5</span>
</code></pre>
<ul>
<li>
<p>使用 <code>Span</code> 避免数组分配，提高性能。</p>
</li>
<li>
<p>适合处理大量数值计算。</p>
</li>
</ul>
<h3 data-id="heading-18">适用场景</h3>
<ul>
<li>
<p>简化方法调用：允许调用者传递任意数量的参数，减少重载需求。</p>
</li>
<li>
<p>处理集合数据：适合处理列表、数组或序列，例如日志记录、字符串连接、数学计算。</p>
</li>
<li>
<p>高性能场景（<code>C# 12+</code>）：使用 <code>Span</code> 或 <code>ReadOnlySpan</code> 减少堆分配，优化性能。</p>
</li>
<li>
<p>与本机代码交互：<code>Span</code> 类型的 <code>params</code> 参数适合传递连续内存块。</p>
</li>
<li>
<p>灵活接口设计：为方法提供通用接口，支持不同数量的输入。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis 性能翻倍的 5 个冷门技巧，90%开发者都不知道的底层优化！]]></title>    <link>https://juejin.cn/post/7582039917217906688</link>    <guid>https://juejin.cn/post/7582039917217906688</guid>    <pubDate>2025-12-11T00:16:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582039917217906688" data-draft-id="7582044568721621032" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis 性能翻倍的 5 个冷门技巧，90%开发者都不知道的底层优化！"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-11T00:16:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis 性能翻倍的 5 个冷门技巧，90%开发者都不知道的底层优化！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T00:16:46.000Z" title="Thu Dec 11 2025 00:16:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Redis 性能翻倍的 5 个冷门技巧，90%开发者都不知道的底层优化！</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>Redis 作为高性能的内存数据库，被广泛应用于缓存、消息队列、实时统计等场景。大多数开发者熟悉基础命令和配置调优（如 <code>maxmemory</code>、<code>expire</code>），但 Redis 的性能潜力远不止于此。本文将深入探讨 <strong>5 个鲜为人知的底层优化技巧</strong>，结合源码实现和硬件特性，帮助你将 Redis 性能提升一倍甚至更多。</p>
<hr/>
<h2 data-id="heading-2">1. Pipeline + MULTI/EXEC：隐藏的网络优化</h2>
<h3 data-id="heading-3">问题背景</h3>
<p>常规的 Redis 操作是“请求-响应”模式，每条命令都需要一次网络往返（RTT）。在高延迟网络中（如跨机房调用），这会成为性能瓶颈。</p>
<h3 data-id="heading-4">冷门技巧</h3>
<p>使用 <strong>Pipeline</strong> 批量发送命令可以减少 RTT，但更进一步的是结合 <code>MULTI/EXEC</code> 事务：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 传统 Pipeline  </span>
<span class="hljs-built_in">echo</span> -e &amp;<span class="hljs-comment">#34;SET k1 v1\nGET k1&amp;#34; | redis-cli --pipe  </span>

<span class="hljs-comment"># Pipeline + MULTI/EXEC（原子性批量操作）  </span>
<span class="hljs-built_in">echo</span> -e &amp;<span class="hljs-comment">#34;MULTI\nSET k1 v1\nSET k2 v2\nEXEC&amp;#34; | redis-cli --pipe  </span>
</code></pre>
<h4 data-id="heading-5"><strong>底层原理</strong></h4>
<ul>
<li>Pipeline 通过缓冲命令一次性发送，减少 TCP/IP 协议栈的上下文切换。</li>
<li><code>MULTI/EXEC</code> 在服务端将多个操作合并为一个原子操作，避免中间状态导致的锁竞争（尤其在 Lua 脚本中更明显）。</li>
</ul>
<h4 data-id="heading-6"><strong>性能对比</strong></h4>

























<table><thead><tr><th>方式</th><th>QPS (本地测试)</th><th>RTT消耗</th></tr></thead><tbody><tr><td>Single Command</td><td>~50k</td><td>High</td></tr><tr><td>Pipeline</td><td>~200k</td><td>Low</td></tr><tr><td>Pipeline+MULTI/EXEC</td><td>~300k</td><td>Lowest</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-7">2. Hash Slot Prefetching：集群模式下的秘密武器</h2>
<h3 data-id="heading-8">问题背景</h3>
<p>Redis Cluster 使用哈希槽（16384 slots）分片数据。跨节点访问需要额外的 <code>MOVED</code> 重定向开销。</p>
<h3 data-id="heading-9">冷门技巧</h3>
<p>通过 <strong>预计算 Key 的哈希槽</strong>，客户端可以直连目标节点：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> rediscluster  

<span class="hljs-comment"># CRC16算法预计算slot（与Redis源码一致）  </span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_slot</span>(<span class="hljs-params">key</span>):  
    crc = binascii.crc16(key.encode()) &amp; <span class="hljs-number">0xFFFF</span>  
    <span class="hljs-keyword">return</span> crc % <span class="hljs-number">16384</span>  

slot = get_slot(&amp;<span class="hljs-comment">#34;user:1000&amp;#34;)  </span>
node = cluster_nodes[slot]   <span class="hljs-comment"># client维护slot-node映射</span>
node.execute(&amp;<span class="hljs-comment">#34;GET&amp;#34;, &amp;#34;user:1000&amp;#34;) </span>
</code></pre>
<h4 data-id="heading-10"><strong>底层原理</strong></h4>
<ul>
<li>Redis Cluster Client （如 Lettuce）默认会缓存 <code>MOVED</code>响应，但首次访问仍需重定向。预计算完全避免此开销。</li>
<li>CRC16 (<em>src/crc16.c</em>)是轻量级计算，几乎无额外成本。</li>
</ul>
<h4 data-id="heading-11"><strong>适用场景</strong></h4>
<p>长连接+固定Key模式（如会话存储）。</p>
<hr/>
<h2 data-id="heading-12">3. Memory Alignment：数据结构的内存玄机</h2>
<h3 data-id="heading-13">RedisObject的秘密布局</h3>
<p>Redis所有值都被封装为 <code>redisObject</code> (<em>server.h</em>)：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">redisObject</span> {</span>    
    <span class="hljs-type">unsigned</span> type:<span class="hljs-number">4</span>;       <span class="hljs-comment">// e.g. OBJ_STRING    </span>
    <span class="hljs-type">unsigned</span> encoding:<span class="hljs-number">4</span>;   <span class="hljs-comment">// e.g. OBJ_ENCODING_INT    </span>
    <span class="hljs-type">unsigned</span> lru:<span class="hljs-number">24</span>;       <span class="hljs-comment">// LRU时间戳    </span>
    <span class="hljs-type">int</span> refcount;          <span class="hljs-comment">//引用计数    </span>
    <span class="hljs-type">void</span> *ptr;             <span class="hljs-comment">//指向实际数据    </span>
} robj;    
</code></pre>
<h3 data-id="heading-14">CPU Cache Line优化</h3>
<p>现代CPU以Cache Line（通常64字节）为单位读取内存。如果<code>robj</code>跨越两个Cache Line，会导致多次内存访问。通过调整字段顺序或编译器指令强制对齐：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">attribute__</span>((<span class="hljs-title">aligned</span>(64))) <span class="hljs-title">redisObject</span> {</span> ... } robj;   
</code></pre>
<h4 data-id="heading-15"><strong>实测影响</strong></h4>
<p>在ARM架构服务器上（如AWS Graviton），对齐后的QPS提升可达15%。</p>
<hr/>
<h2 data-id="heading-16">TLS Session Resumption：加密连接的性能救星</h2>
<h3 data-id="heading-17">SSL/TLS握手开销</h3>
<p>启用TLS后，每次连接需要完整的握手流程（~2 RTT + RSA计算）。</p>
<h3 data-id="heading-18">Session复用配置</h3>
<p>在<code>redis.conf</code>中启用TLS会话复用：</p>
<pre><code class="hljs language-ini" lang="ini">tls-session-caching yes     
tls-session-cache-size  50000      <span class="hljs-comment">#保持大量会话      </span>
tls-session-cache-timeout  300     <span class="hljs-comment">#超时时间(秒)     </span>
</code></pre>
<h4 data-id="heading-19"><strong>OpenSSL的妙用</strong></h4>
<p>Redis使用OpenSSL的 <code>SSL_CTX_set_session_cache_mode</code> API实现会话票据复用(<em>src/tls.c</em>)。对于短连接场景（如Serverless），吞吐量可提升3倍以上。</p>
<hr/>
<h2 data-id="heading-20">Shared Memory结构体池化</h2>
<h3 data-id="heading-21">SDS的动态分配问题</h3>
<p>Redis字符串采用SDS (<em>sds.h</em>)结构存储频繁修改的字符串可能导致内存碎片化 。</p>
<h3 data-id="heading-22">HACK方案：自定义内存分配器</h3>
<p>替换默认的<code>zmalloc()</code> (<em>zmalloc.c</em>) ，为SDS预分配对象池 ：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">//示例伪代码 </span>
sds <span class="hljs-title function_">sdsnewlen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *init, <span class="hljs-type">size_t</span> initlen)</span> {     
    <span class="hljs-keyword">if</span> (initlen &lt; SDS_MAX_POOLED_SIZE) {         
        sdshdr *sh = sds_pool_get(initlen); <span class="hljs-comment">//从池中获取         </span>
        <span class="hljs-keyword">if</span> (sh) <span class="hljs-keyword">return</span> sh-&gt;buf();      
    }     
    <span class="hljs-comment">//原始分配逻辑...    </span>
}    
</code></pre>
<h4 data-id="heading-23"><strong>风险与收益并存</strong></h4>
<ul>
<li>Pros:  减少malloc/free调用 ，尤其适合高频计数器场景 （如INCR）。</li>
<li>Cons:  需谨慎处理线程安全性和内存泄漏 。</li>
</ul>
<hr/>
<h2 data-id="heading-24">Conclusion</h2>
<p>以上5个技巧从协议、算法、内存、加密和资源管理五个维度挖掘Redis的深层性能潜力 。值得注意的是 ：</p>
<ol>
<li>Pipeline+MULTI适合批处理但会牺牲原子性隔离级别 ；</li>
<li>Slot预计算要求客户端维护集群拓扑 ；</li>
<li>Memory Alignment的效果依赖CPU架构 ；</li>
</ol>
<p>真正的性能调优需结合具体业务场景和数据特征 。建议通过 <code>redis-benchmark -A pipeline=32... </code>针对性压测验证效果 。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[对于《目前程序语言与软件工程研究中真正严重的缺陷是什么？》一文的解读]]></title>    <link>https://juejin.cn/post/7582044568721637416</link>    <guid>https://juejin.cn/post/7582044568721637416</guid>    <pubDate>2025-12-11T00:19:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582044568721637416" data-draft-id="7582096212662288384" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="对于《目前程序语言与软件工程研究中真正严重的缺陷是什么？》一文的解读"/> <meta itemprop="keywords" content="后端,架构,领域驱动设计"/> <meta itemprop="datePublished" content="2025-12-11T00:19:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="canonical_entropy"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289694429"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            对于《目前程序语言与软件工程研究中真正严重的缺陷是什么？》一文的解读
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289694429/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    canonical_entropy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T00:19:33.000Z" title="Thu Dec 11 2025 00:19:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在我的前一篇文章<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FlJyGfNa3psbVxeSO1sji-A" target="_blank" title="https://mp.weixin.qq.com/s/lJyGfNa3psbVxeSO1sji-A" ref="nofollow noopener noreferrer">《目前程序语言与软件工程研究中真正严重的缺陷是什么？》</a>中，我提出了一个核心观点：当代编程语言与软件工程的主流理论，把注意力几乎全部集中在“单个程序的静态快照”上，却缺乏一套以“变化本身”为一等公民、面向程序族长期演化的统一理论框架。为此，我引入了“广义可逆计算（GRC）”及其核心公式 <code>Y = F(X) ⊕ Δ</code>，试图把“生成”和“演化”统一在一条方程之中。</p>
<p>这篇补充说明的目的，是把原文中一些隐含但关键的思想明确拉到前台：</p>
<ul>
<li>Δ 并不是对文本做 diff，而是相对于某个<strong>结构空间</strong>中的“位移/扰动”；</li>
<li>构造与修改在形式上都是差量：全量构造可以视为“从空状态出发的一次大 Δ”；</li>
<li><code>Y = F(X) ⊕ Δ</code> 的要求不仅是“生成 + 手工补充”，而是要求 F(X) 和 Δ 处在<strong>同一结构坐标系</strong>中，并且这条方程在应用层、DSL 层、元模型层、工具层以“分形”方式层层复用；</li>
<li>“可逆性”不仅意味着可以 undo 某次修改，还意味着可以在“构造逻辑空间”中重排、插入、回溯构造步骤，从而在演化中控制熵增；</li>
<li>GRC 不是要取代 DDD、MDA、SPL、DSL 工程，而是希望为它们提供一个共同的“数学母体”：用“结构空间 + Δ/⊕”来统一表达这些方法论中的生成、变体和定制逻辑。</li>
</ul>
<p>通过对这些前提的澄清，我们可以更清晰地看到：<br/>
GRC 想补的，不是一两个工程技巧的缺口，而是一整块“关于变化的科学”的理论空白——让差量 Δ、合并 ⊕、结构空间与可逆性，真正回到软件理论的中心位置。</p>
<h2 data-id="heading-0">一、原文在讲“差量（Δ）”时，其实暗含了一个“结构空间”的概念</h2>
<p>原文一直在讲：</p>
<ul>
<li>差量 Δ；</li>
<li>合并 ⊕；</li>
<li>程序族与演化路径。</li>
</ul>
<p>容易遗漏的是：这些概念不是悬空存在的，它们总是相对于某个“空间”而言。</p>
<h3 data-id="heading-1">1. 什么叫“结构空间”？</h3>
<p>原文在多个地方隐含地用了这个想法：</p>
<blockquote>
<p>一门语言/一个建模体系，并不只是一堆语法规则，<br/>
而是定义了“它能生成的所有程序/模型”这一整片空间。</p>
</blockquote>
<p>你可以这么看：</p>
<ul>
<li>对 C 语言而言，“所有合法 C 程序的抽象语法树集合”，就是一个结构空间；</li>
<li>对某个 DSL（比如工作流 DSL）而言，“所有合法的流程图结构”，也是一个结构空间。</li>
</ul>
<p>原文提议：<br/>
当我们谈 Δ 时，要明确<strong>它是这片空间内部的一种“位移/微扰”</strong>，而不是文件上的文本差异。</p>
<p>换句话说：</p>
<ul>
<li>文本 diff = 文件行的增删改；</li>
<li>结构差量 = 在“可解释的程序结构空间”中操作某些节点/关系。</li>
</ul>
<p>这就是为什么原文不停强调：</p>
<ul>
<li>不能只停留在 Git diff、JSON Patch 那种文本/语法层；</li>
<li>必须在“程序/模型结构本身”的层级来定义 Δ。</li>
</ul>
<p>我这里用“结构空间”这个词，是为了把这点显式化：<br/>
<strong>Δ 一定是相对于某个结构化的程序空间而言的，而不是随便对字节比一比。</strong></p>
<hr/>
<h2 data-id="heading-2">二、“一切皆差量”背后，其实是想把“从零构造”和“修改”统一起来</h2>
<p>原文有一句很容易被当成哲学感叹的话：“一切皆差量”。<br/>
这句话其实有一个非常具体的工程含义：</p>
<h3 data-id="heading-3">1. 把全量构造看成“相对于空”的一次大 Δ</h3>
<p>在代数里，如果有一个“零元素 0”，就可以写：</p>
<blockquote>
<p>A = 0 ⊕ A</p>
</blockquote>
<p>原文借用了这个思路：</p>
<ul>
<li>一个系统从“无”到“有”的过程，可以看作对“空系统”应用了一个“大差量”；</li>
<li>之后的每一次修改/定制，又是在原有状态上叠加更多 Δ。</li>
</ul>
<p>这意味着：</p>
<ul>
<li><strong>“生成出来的初始系统”</strong> 和</li>
<li><strong>“后面针对这个系统做的一次修改”</strong></li>
</ul>
<p>在形式上可以用同一种 Δ/⊕ 机制描述，只是基底不同：</p>
<ul>
<li>从 0 叠加 → “构造全量”；</li>
<li>从 Base 叠加 → “在已有系统上演化”。</li>
</ul>
<p>很多人初读时只注意到：<br/>
“哦，Δ 是用来描述修改/定制的”，但容易忽略：</p>
<blockquote>
<p>原文其实是在说：<br/>
<strong>构造 ≈ 一次大的 Δ，<br/>
演化 ≈ 继续叠加 Δ。</strong></p>
</blockquote>
<p>这才是“生成（F(X））和演化（⊕ Δ）可以统一进一条方程”的深层含义。</p>
<hr/>
<h2 data-id="heading-4">三、Y = F(X) ⊕ Δ 这条公式最关键的两个“强要求”</h2>
<p>对很多人来说，这个公式很直观：</p>
<ul>
<li>用 F(X) 表示“从模型 X 自动生成的部分”；</li>
<li>用 Δ 表示“手工补充/修正的部分”。</li>
</ul>
<p>但原文真正苛刻的地方不在这个分解，而在它对两件事情提出的“强要求”：</p>
<h3 data-id="heading-5">1. 要求 Δ 和 F(X) 在同一个“坐标系”里</h3>
<p>原文提出“坐标系”的比喻，很多人会理解为“领域模型就是一种坐标系”。<br/>
这里有一个隐含但非常重要的意思：</p>
<blockquote>
<p>不管是生成的 F(X)，还是后续叠加的 Δ，<br/>
都必须在同一个结构坐标系里表达。</p>
</blockquote>
<p>什么意思？</p>
<ul>
<li>如果 F(X) 生成的是某种结构化模型（例如一棵“页面组件树”）；</li>
<li>那 Δ 也应该是对这棵树中具体节点的“定点修改/扩展”，而不是在生成结果上随便写脚本“乱 patch”。</li>
</ul>
<p>反例是常见的做法：</p>
<ul>
<li>模型生成一堆代码；</li>
<li>手工改动直接写在代码上；</li>
<li>改动不再以“模型上的差量”存在，而是变成对生成产物的不可追踪修改。</li>
</ul>
<p>原文的态度是：<br/>
<strong>这样的修改其实已经逃出了原来的结构空间，Δ 失去了“结构坐标”意义。</strong></p>
<p>想真正满足 Y = F(X) ⊕ Δ 的“统一精神”，就意味着：</p>
<ul>
<li>Δ 必须在“生成物的结构空间”里有明确坐标（类似“在这个组件树的这个节点上增加这个子节点”）；</li>
<li>而不是“在这个 .java 文件第 123 行插入几行”。</li>
</ul>
<p>这点在原文里没有公式化，但埋了很多铺垫，很多读者会下意识略过。</p>
<h3 data-id="heading-6">2. 要求这条公式能在多层级上重复使用（分形递归）</h3>
<p>原文不只是说“在应用层可以写出 Y = F(X) ⊕ Δ”，而是暗示：</p>
<ul>
<li>在模型层也可以：领域模型 = (基础元模型) 经过某个 F，再 ⊕ Δ；</li>
<li>在 DSL 层也可以：某 DSL = 从更抽象元语言 F 出来，再 ⊕ Δ；</li>
<li>在工具层也可以：生成器本身 = 某基础生成器 F₀，加上 Δ_generator 形成 F₁。</li>
</ul>
<p>区别在于：</p>
<ul>
<li>很多工程实践只在某一两层用“生成+手改”的模式，局部使用类似思路；</li>
<li>原文希望的是：<strong>整个软件构造/演化链条，从元模型到代码/配置，都能在同一模式下描述。</strong></li>
</ul>
<p>这就是为什么它会用“分形”“结构空间”“路径积分”等物理/数学比喻：<br/>
它想要的是<strong>一条贯通多层的统一表达</strong>，不只是说“在某处引入 Δ 比较方便”。</p>
<hr/>
<h2 data-id="heading-7">四、“可逆性”三层含义里，最容易被忽略的是“过程可逆性”</h2>
<p>原文没有系统分层定义“可逆性”，但隐含了三个层次：</p>
<ol>
<li>
<p><strong>代数可逆性</strong></p>
<ul>
<li>有 Δ 的逆元 −Δ，可以表达“撤销某个变化”，使得 Δ ⊕ (−Δ) 约等于“无变化”。</li>
</ul>
</li>
<li>
<p><strong>变换可逆性</strong></p>
<ul>
<li>类似双向变换（BX）：<br/>
从高层模型到低层表示有 F，从低层返回高层有 F⁻¹；<br/>
变换尽量信息不丢失。</li>
</ul>
</li>
<li>
<p><strong>过程可逆性</strong>（最容易一笔带过）</p>
<ul>
<li>构建流程通常被视为：先有库，再构建应用；先有 v1，再演化出 v2。</li>
<li>原文在讲“用未来的 Δ 修正历史产物”时，其实在重新理解这个时间顺序：
<ul>
<li>你不一定要修改库源码；</li>
<li>可以在“后来”的一个地方定义 Δ，让运行时或重构时“向后作用”于已存在的东西；</li>
<li>在逻辑构造空间里，相当于把这步 Δ 插入到了更早的位置。</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>这第三层的意思是：</p>
<blockquote>
<p>我们平时把构造视为严格单向的时间线，<br/>
GRC 主张在“构造逻辑空间”里，这条线可以被重排、可逆、可插入。</p>
</blockquote>
<p>工程上对应的形态包括：</p>
<ul>
<li>对第三方库做“非侵入式定制/修复”，却还保留体系结构上的可追踪和可撤销；</li>
<li>对已发布系统做“热修复”，其逻辑可被归入统一的 Δ/⊕ 模型中，而不是某种“特殊手段”。</li>
</ul>
<p>很多人看到“可逆计算”容易想到的只是“能不能 undo”，而忽略了这一层“重新编排构造过程”的含义。</p>
<hr/>
<h2 data-id="heading-8">五、文章对现有理论的批评，其实是在“拉高度”，而不是“否定其价值”</h2>
<p>原文对类型论、形式方法、范畴论在 PL 中的用法提出了不少批评。初看会有一种“你是不是过于看轻这些领域”的感觉。但如果结合全文逻辑，可以这样更准确理解：</p>
<ol>
<li>它不否认现有成果在“单程序静态性质”上的成功；</li>
<li>它指出的是：<strong>在“程序族 + 演化”维度上，我们还没有类似类型论那样成熟的统一主干。</strong></li>
<li>它批评的重点不是“现在做的错了”，而是“我们到目前为止，重心选在了一个偏静态的切面上，而另一个维度还没有被当成‘中心任务’。”</li>
</ol>
<p>换句话说，文章想传达的并不是：</p>
<blockquote>
<p>你们研究类型/形式方法都错了，应该来搞 GRC。</p>
</blockquote>
<p>而更接近：</p>
<blockquote>
<p>静态安全这块基础已经很牢了，<br/>
但“变化/演化”的基础理论还没立起来，<br/>
GRC 是一个尝试在这个空白处立新柱子的方向。</p>
</blockquote>
<p>这一点如果没有意识到，很容易误解为一种“旧山不如新山”的姿态。实际上，它希望的是<strong>多一座“关于变化”的山</strong>，而不是要把原有那座推倒。</p>
<hr/>
<h2 data-id="heading-9">六、原文和 DDD/MDA/SPL 的关系：GRC 不是来“取代”它们，而是要给它们一个统一的“数学母体”</h2>
<p>原文多次提到：</p>
<ul>
<li>模型驱动（MDA/MDD）；</li>
<li>软件产品线（SPL）；</li>
<li>领域驱动设计（DDD）；</li>
<li>DSL 工程。</li>
</ul>
<p>容易出现的误读是：</p>
<ul>
<li>GRC 是一套“更好的 MDE/SPL/DDD”；</li>
<li>旧的方法论不够好，现在要换用 GRC。</li>
</ul>
<p>更准确的理解是：</p>
<ul>
<li>MDA/MDD 主要关注从模型到实现的<strong>一次性生成</strong>；</li>
<li>SPL 关注的是产品族的<strong>特性组合</strong>；</li>
<li>DDD 关注的是如何在业务领域建立好的<strong>语言与模型边界</strong>；</li>
<li>GRC 想做的是：<strong>把这些东西都放进同一个“结构空间 + Δ/⊕”的统一框架中来解释</strong>。</li>
</ul>
<p>举例：</p>
<ul>
<li>
<p>MDA：传统是 <code>App = Transform(Model)</code>；<br/>
GRC 视角下是 <code>App = F(Model) ⊕ Δ</code>，迁移了“生成后手改”的那块到 Δ 中。</p>
</li>
<li>
<p>SPL：一般谈 feature 组合、变体；<br/>
GRC 视角下是 <code>Variant = Base ⊕ Δ_feature ⊕ Δ_customer ⊕ …</code>，特性/客户定制都成为差量层。</p>
</li>
<li>
<p>DDD：谈限界上下文、领域事件；<br/>
GRC 视角下，限界上下文可以理解为不同的结构子空间，领域事件则是状态空间上的 Δ：</p>
<p><code>NewState = OldState ⊕ EventΔ</code></p>
</li>
</ul>
<p>所以，更合适的比喻是：</p>
<blockquote>
<p>GRC 希望当“母语言”，<br/>
用同一套 Δ/⊕ 结构去表达 MDA/SPL/DDD/DSL 等已有方法论的构造和演化逻辑，<br/>
而不是要发明一套与它们竞争的“新方法论”。</p>
</blockquote>
<h2 data-id="heading-10">七、如果读完原文还觉得模糊，可以用一个简化图景来帮助理解</h2>
<p>把原文的主要思想压缩成一个简单的比喻：</p>
<ol>
<li>
<p><strong>先想象一张地图（结构空间）</strong></p>
<ul>
<li>这张地图上每个点都是一个系统版本/模型版本；</li>
<li>靠近的点表示结构相似。</li>
</ul>
</li>
<li>
<p><strong>差量 Δ 就是从一个点到另一个点的“矢量”</strong></p>
<ul>
<li>一次修复、一次定制、一次迁移，都是一个箭头 Δ；</li>
<li>多次变化就是 Δ1, Δ2, … 的接力。</li>
</ul>
</li>
<li>
<p><strong>合并 ⊕ 是箭头的“串联”运算</strong></p>
<ul>
<li>Δ1 ⊕ Δ2 表示先走 Δ1 再走 Δ2；</li>
<li>希望它满足封闭性、结合律等良好性质。</li>
</ul>
</li>
<li>
<p><strong>Y = F(X) ⊕ Δ 表示：从某个模型 X 出发，先走一段由生成器 F 自动画出的路径，再加上人工画的那段 Δ</strong></p>
</li>
<li>
<p><strong>可逆性是说：尽量让箭头可以反向走，或者至少搞清楚“能走回头路的是哪几类箭头”</strong></p>
</li>
<li>
<p><strong>原文的批评是：我们在研究“地图上的某一个点（程序 P）性质或者特定两点之间的转换”上已经很强，但对整个地图的形状、箭头的组合与可逆性质，没有一门真正系统的理论；GRC 是在提出这样一门理论的初步轮廓。</strong></p>
</li>
</ol>
<p>更进一步:</p>
<ol start="7">
<li><strong>软件世界是一本“动态地图集（Atlas）”，而非单一地图</strong></li>
</ol>
<ul>
<li>现实中的复杂软件系统无法用单一视图完整描述，就像真实世界无法用一张地图呈现所有信息。</li>
<li>每个 <strong>DSL</strong>（领域特定语言）就是一本专题地图：
<ul>
<li><strong>数据库Schema图</strong>（数据模型空间）</li>
<li><strong>业务流程图</strong>（工作流空间）</li>
<li><strong>UI组件树</strong>（界面空间）</li>
<li><strong>部署拓扑图</strong>（基础设施空间）</li>
</ul>
</li>
<li>这些地图共同构成了一本<strong>地图集</strong>，每个视图都是同一现实在不同关注点/不同抽象切面的投影。</li>
</ul>
<ol start="8">
<li><strong>Generator（F）是地图制图学中的“投影变换规则”</strong></li>
</ol>
<ul>
<li>地质学家通过测量数据，<strong>按照投影规则</strong>生成可视化的地质图。</li>
<li>同样，<strong>Generator</strong> 是领域模型空间到具体实现空间的映射规则：
<ul>
<li><code>F_orm</code>：领域模型 → 数据库Schema</li>
<li><code>F_api</code>：领域模型 → API接口规范</li>
<li><code>F_ui</code>：业务对象 → 界面组件树</li>
</ul>
</li>
<li>每个Generator定义了两个结构空间之间的<strong>可计算映射关系</strong>。</li>
</ul>
<ol start="9">
<li><strong>差量Δ是地图上的“结构化编辑图层”</strong></li>
</ol>
<ul>
<li>在传统GIS中，你不能直接在印刷地图上修改河流走向。</li>
<li>但在现代数字地图系统中，所有修改都是<strong>分层的</strong>：
<ul>
<li><strong>基底图层</strong>：由Generator从核心模型自动生成的“标准地图”</li>
<li><strong>差量图层（Δ）</strong>：本地化的修正、客户特定的覆盖、紧急修复</li>
</ul>
</li>
<li><strong>关键区别</strong>：Δ不是随意涂改，而是在<strong>同一坐标系</strong>中的精确标记：
<blockquote>
<p>“在坐标(业务对象.订单.状态)处增加‘已复核’状态”
而不是“在Order.java第123行插入代码”</p>
</blockquote>
</li>
</ul>
<ol start="10">
<li><strong>可逆性：地图集的“同步更新机制”</strong>
真正的挑战在于多地图协同：</li>
</ol>
<ul>
<li><strong>代数可逆性</strong>：如果在地质图上标记“此处实际为沉积岩而非花岗岩”（+Δ），应该能撤销此标记（-Δ）</li>
<li><strong>变换可逆性</strong>：从地质数据到地质图的投影（F），最好能反向从地图修改回数据（F⁻¹）</li>
<li><strong>过程可逆性</strong>：当交通图上某条道路被封闭（Δ_traffic），这个变化可以被<strong>反向传播</strong>：
<ul>
<li>自动提醒地质图：“此处可能有地质勘探受影响”</li>
<li>自动更新行政区划图：“此处边界通行规则需调整”</li>
<li>而不是让各地图维护者手动发现和同步</li>
</ul>
</li>
</ul>
<blockquote>
<p>“哪些变化需要自动传播、传播到哪几张地图”是具体工程设计的问题，不是 GRC 在理论层面直接强制的。</p>
</blockquote>
<p>这三种可逆性共同构成了GRC控制‘熵增’的机制：代数可逆确保修改可撤销（局部熵不变），变换可逆力求在表象之间保持信息守恒（跨视图熵不变），过程可逆则允许重构演化路径（全局熵可控）。</p>
<ol start="12">
<li><strong>Y = F(X) ⊕ Δ 在地图集中的多层含义</strong>
这个公式在不同层级递归出现：</li>
</ol>






























<table><thead><tr><th>层级</th><th>公式</th><th>地图集比喻</th></tr></thead><tbody><tr><td><strong>应用层</strong></td><td>App = F_app(DomainModel) ⊕ Δ_custom</td><td>最终用户看到的“综合地图” = （标准投影 + 本地覆盖层）</td></tr><tr><td><strong>模型层</strong></td><td>DSL = F_dsl(MetaModel) ⊕ Δ_dsl</td><td>“交通图规范” = （标准制图规则 + 本地图例扩展）</td></tr><tr><td><strong>元模型层</strong></td><td>MetaModel' = MetaModel ⊕ Δ_meta</td><td>“整个地图集的坐标基准”自身的演进</td></tr><tr><td><strong>工具层</strong></td><td>Generator' = Generator ⊕ Δ_gen</td><td>“投影规则”本身也可以版本化和定制</td></tr></tbody></table>
<p>如果读者带着这个图景，再回头看原文中关于“结构空间”、“坐标系”、“可逆性”、“分形递归”等概念，以及它对类型论、范畴论当前用法的批评，就会更加透彻——GRC是在呼吁将软件研究的重心，从“单个程序的静态快照”，扩展到“整个程序族在多空间协同下的动态演化轨迹以及这些轨迹所构成的空间整体”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如果我问你 Context，你扛得住吗？]]></title>    <link>https://juejin.cn/post/7582039917217988608</link>    <guid>https://juejin.cn/post/7582039917217988608</guid>    <pubDate>2025-12-11T00:29:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582039917217988608" data-draft-id="7577284771447685160" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如果我问你 Context，你扛得住吗？"/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2025-12-11T00:29:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如果我问你 Context，你扛得住吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T00:29:49.000Z" title="Thu Dec 11 2025 00:29:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;color:#282d36}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px;color:#2f845e}.markdown-body h2{font-size:22px;display:inline-block;font-weight:700;background:#2f845e;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(47,132,194,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 32px);border-bottom:3px solid #2f845e}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%;box-shadow:6px 6px 6px #888}.markdown-body hr{border:none;border-top:1px solid rgba(66,185,131,.15);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:16px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#262626;border:1px solid #2f845e;border-top:8px solid #2f845e;background:linear-gradient(180deg,rgba(66,185,131,.1),transparent)!important}.markdown-body pre&gt;code.hljs[lang]:before{top:8px!important;color:#2f845e!important}.markdown-body pre&gt;code.language-awesome_error{border:1px solid #ff4d4f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ff4d4f!important;background:#fff2f0!important}.markdown-body pre&gt;code.language-awesome_error:before{content:"!"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ff4d4f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_warn{border:1px solid #ffc46f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ffc46f!important;background:#fffbe6!important}.markdown-body pre&gt;code.language-awesome_warn:before{content:"☂"!important;position:absolute;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ffc46f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_success{border:1px solid #52c41a!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#52c41a!important;background:#f6ffed!important}.markdown-body pre&gt;code.language-awesome_success:before{content:"✓"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#52c41a!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_info{border:1px solid #1890ff!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#1890ff!important;background:#e6f7ff!important}.markdown-body pre&gt;code.language-awesome_info:before{content:"i"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#1890ff!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body strong{background-color:inherit;color:#2f845e}.markdown-body em{background-color:inherit;color:#949415}.markdown-body a{text-decoration:none;color:#2f8e54;border-bottom:1px solid #3f9e64}.markdown-body a:active,.markdown-body a:hover{color:#3f9e64}.markdown-body a[class^=footnote]{margin-left:4px}.markdown-body a:before{content:"➤ "}.markdown-body table{font-size:12px;width:100%;max-width:100%;overflow:auto;border:2px solid #2f8e54}.markdown-body thead{background:#2f8e54;color:#fff;text-align:left;font-weight:700}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:22px}.markdown-body td{min-width:120px}.markdown-body blockquote{padding:1px 22px;margin:22px 0;border-left:6px solid #2f845e;background-color:rgba(66,185,131,.1);border-radius:2px}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#2f845e}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px;color:#282d36}.markdown-body del{color:#2f845e}.markdown-body input[type=checkbox]:checked:before{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA/klEQVQ4T72TMU7DQBBF318XdFR06egQEnAXRINEGlqgowoIR8AF4AZOZ4JEGq5AC5EixBU4A55BNrEVHAcSBTHlaubt37/zxZKlcn7n6mDPXJvz8IJ89HzWu8t7C8D2dfsY52ae4apHnLx0ktsCsHXZjiUuFgG40x2eJ/H/AhztB+zDUTpLwWj8jGkzxSHiHaMPrDQC8sMoilKzLAUqiKQjmb+ZuAdW80tmelCHODoNgSfP7AFprTTaRTzsJN1GEyuIZ7uW6TEEHwCtyV/6EVBKJHhfzgC0Xv/iXwEFBF4FG0378bd7sPQq5xK/hSnk6sdlX3mZrKkwLZKBeu8n9XuWEUE7X+YAAAAASUVORK5CYII=);position:relative;top:-1px;left:-1px}.markdown-body .math .katex{font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}@media (max-width:720px){.markdown-body h1{font-size:22px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><em>本系列为小说《逆袭西二旗》的技术讲解，用于详细说明<a href="https://juejin.cn/post/7581348660824506368" target="_blank" title="https://juejin.cn/post/7581348660824506368">剧情</a>里涉及的开发细节。</em></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f1b5f6096214ccf89f001ee015b88b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766017789&amp;x-signature=3%2FBmrHIGgXFGVwT2TftDraD7vEI%3D" alt="0.jpg" loading="lazy"/></p>
<h2 data-id="heading-0">什么是 Context，Context 有哪些类型</h2>
<p><code>Context</code> 代表应用程序的环境或状态，提供对应用专属资源和类的访问。它充当应用与 Android 系统之间的桥梁，让组件能够访问资源、数据库、系统服务等。在执行诸如启动 <code>Activity</code>、读取 <code>assets</code> 文件或加载布局等任务时，<code>Context</code> 至关重要。</p>
<p>Android 中有多种类型的 <code>Context</code>。</p>
<h3 data-id="heading-1">面试问题</h3>
<p>在 Android 应用中，为何使用正确的 <code>Context</code> 类型至关重要？<br/>
持有 <code>Activit Context</code> 的长生命周期引用又可能带来哪些风险？</p>
<h3 data-id="heading-2">Application Context</h3>
<p><code>Application Context</code> 与整个应用程序的生命周期绑定。当你需要一个全局、长生命周期且独立于当前 <code>Activity</code> 或 <code>Fragment</code> 的 <code>Context</code> 时，就应使用它。可通过调用 <code>getApplicationContext()</code> 获取。</p>
<p>适用场景：</p>
<ul>
<li>访问全局资源，如 <code>SharedPreferences</code> 或数据库；</li>
<li>注册需贯穿整个应用生命周期的广播接收器；</li>
<li>初始化在整个应用生命周期内持续存在的库或组件。</li>
</ul>
<h3 data-id="heading-3">Activity Context</h3>
<p><code>Activity Context</code>（即 <code>Activity</code> 中的 <code>this</code>）与 <code>Activity</code> 的生命周期绑定，用于访问资源、启动其他 <code>Activity</code>，或加载该 <code>Activity</code> 特有的布局。</p>
<p>适用场景：</p>
<ul>
<li>创建或修改 UI 组件；</li>
<li>启动另一个 <code>Activity</code>；</li>
<li>访问限定于当前 <code>Activity</code> 的资源或主题。</li>
</ul>
<h3 data-id="heading-4">Service Context</h3>
<p><code>Service Context</code> 与 <code>Service</code> 的生命周期绑定，主要用于后台任务，例如执行网络请求或播放音乐。它可访问 <code>Service</code> 所需的系统级服务。</p>
<h3 data-id="heading-5">Broadcast Context</h3>
<p><code>Broadcast Context</code> 在 <code>BroadcastReceiver</code> 被调用时提供。它的生命周期很短，通常仅用于响应特定广播事件。<strong>切勿在此上下文中执行耗时操作。</strong></p>
<h3 data-id="heading-6">Context 的常见使用场景</h3>
<ol>
<li><strong>访问资源</strong>：通过 <code>getString()</code>、<code>getDrawable()</code> 等方法，<code>Context</code> 可用于获取字符串、图片、尺寸等资源。</li>
<li><strong>加载布局</strong>：使用 <code>Context</code> 通过 <code>LayoutInflater</code> 将 XML 布局文件转换为 <code>View</code> 对象。</li>
<li><strong>启动 Activity 和 Service</strong>：调用 <code>startActivity()</code> 或 <code>startService()</code> 时必须传入 <code>Context</code>。</li>
<li><strong>访问系统服务</strong>：通过 <code>getSystemService()</code>，<code>Context</code> 能获取如 <code>ClipboardManager</code>、<code>ConnectivityManager</code> 等系统级服务。</li>
<li><strong>数据库与 <code>SharedPreferences</code> 操作</strong>：<code>Context</code> 用于访问 <strong>SQLite</strong> 数据库或 <code>SharedPreferences</code> 等持久化存储机制。</li>
</ol>
<h3 data-id="heading-7">总结</h3>
<p><code>Context</code> 是 Android 中的核心组件，使应用能够与系统资源进行交互。Android 提供了多种 <code>Context</code> 类型，如 <code>Application Context</code>、<code>Activity Context</code> 和 <code>Service Context</code>，各自适用于不同场景。正确使用 <code>Context</code> 不仅能高效管理资源，还能避免内存泄漏和崩溃。因此，务必根据实际需求选择合适的 <code>Context</code>，并避免不必要的长期持有。</p>
<h3 data-id="heading-8">进阶：使用 Context 时要注意什么</h3>
<p><code>Context</code> 是 Android 中一种便捷的机制，但使用不当会引发严重问题，比如内存泄漏、崩溃，或者资源处理效率低下。为避免这些陷阱，务必了解其细微差别以及有效使用 <code>Context</code> 的最佳实践。</p>
<p>最常见的问题之一，是在 <code>Activity</code> 或 <code>Fragment</code> 等 <code>Context</code> 的生命周期之外，仍然保留对它们的引用。这会导致内存泄漏，因为垃圾回收器无法回收该 <code>Context</code> 及其相关资源所占用的内存。</p>
<p>例如，下面的示例代码可能会导致内存泄漏：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">object</span> Singleton {
    <span class="hljs-keyword">var</span> context: Context? = <span class="hljs-literal">null</span> <span class="hljs-comment">// If this retains the Activity context, causing a memory leak</span>
}
</code></pre>
<p>相反，对于需要 <code>Context</code> 的长生命周期对象，应使用 <code>Application Context</code>：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">object</span> Singleton {
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> applicationContext: Context
}
</code></pre>
<p>因此，使用合适类型的 <code>Context</code> 至关重要。不同类型的 <code>Context</code> 用途各异，用错类型可能导致意外行为：</p>
<ul>
<li>执行与界面（UI）相关的任务，如加载布局或显示对话框时，使用 <code>Activity Context</code>。</li>
<li>进行与 UI 生命周期无关的操作，如初始化库时，使用 <code>Application Context</code>。</li>
</ul>
<p>下面的示例展示了误用 <code>Application Context</code> 的情况：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">val</span> dialog = AlertDialog.Builder(context.getApplicationContext()) <span class="hljs-comment">// Incorrect</span>
</code></pre>
<p>应使用 <code>Activity Context</code> 以确保正确的主题设置：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">val</span> dialog = AlertDialog.Builder(activityContext) <span class="hljs-comment">// Correct</span>
</code></pre>
<p>另一个关键考量点是，当关联组件（如 <code>Activity</code> 或 <code>Fragment</code>）被销毁后，要避免使用 <code>Context</code>。访问与已销毁组件绑定的 <code>Context</code>，可能会导致程序崩溃或出现未定义行为，因为与该 <code>Context</code> 关联的资源可能已不复存在。</p>
<p>下面的示例展示了对 <code>Context</code> 的误用，其中自定义视图的创建方式不当：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin">activity.finish() <span class="hljs-comment">// The activity is destroyed</span>
<span class="hljs-keyword">val</span> text = TextView(activity) <span class="hljs-comment">// but the TextView retains a reference</span>
</code></pre>
<p><em>如果在 <code>activity</code> 销毁后依然使用 <code>text</code>，是非常危险的行为（例如 <code>activity</code> 销毁后，才请求到数据，然后更新 <code>text</code> 的显示）。</em></p>
<p>避免在后台线程使用 <code>Context</code>。</p>
<p><code>Context</code> 是为主线程设计的，尤其适用于访问资源或与用户界面（UI）交互。在后台线程使用它可能会导致意外崩溃或线程问题。在与 UI 相关的 <code>Context</code> 资源交互前，需切换回主线程：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin">viewModelScope.launch {
    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = fetchData()
    withContext(Dispatchers.Main) {
        Toast.makeText(context, &amp;#<span class="hljs-number">34</span>;Data fetched&amp;#<span class="hljs-number">34</span>;, Toast.LENGTH_SHORT).show()
    }
}
</code></pre>
<p>总之。</p>
<p>要有效使用 <code>Context</code>，需谨慎考量，规避常见陷阱。不应在 <code>Activity</code> 或 <code>Fragment</code> 的生命周期结束后仍保留其 <code>Context</code>，否则可能导致内存泄漏。针对特定任务，务必选择正确类型的 <code>Context</code>，避免在后台线程，或关联组件销毁后使用它。此外，使用匿名内部类和回调时要小心，它们可能会不经意间持有对 <code>Context</code> 的引用。正确管理 <code>Context</code> 能确保高效利用资源，有助于防止内存泄漏或应用程序崩溃。</p>
<h3 data-id="heading-9">进阶：ContextWrapper</h3>
<p><code>ContextWrapper</code> 是 Android 中的一个基类，它具备包装 <code>Context</code> 对象的能力，将调用委托给被包装的 <code>Context</code>。它充当中间层，用于修改或扩展原始 <code>Context</code> 的行为。通过使用 <code>ContextWrapper</code>，你可以在不改变底层 <code>Context</code> 的情况下定制功能。</p>
<p>当你需要增强或覆盖现有 <code>Context</code> 的特定行为时，就会用到 <code>ContextWrapper</code>。它允许你拦截对原始 <code>Context</code> 的调用，并提供额外功能或定制化行为。</p>
<p>以 <code>Activity</code> 的继承关系为例：<code>Activity</code> -&gt; <code>ContextThemeWrapper</code> -&gt; <code>ContextWrapper</code>。</p>
<p>而 <code>ContextWrapper</code> 源码如下：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ContextWrapper</span> <span class="hljs-title">extends</span> <span class="hljs-title">Context</span> {
    <span class="hljs-meta">@UnsupportedAppUsage</span>
    Context mBase;
    ...
}
</code></pre>
<p>使用场景：</p>
<ol>
<li><strong>自定义 <code>Context</code></strong>：当你出于特定目的需要创建自定义 <code>Context</code> 时，例如应用不同的主题，或以特定方式处理资源。</li>
<li><strong>动态资源处理</strong>：包装 <code>Context</code> 以动态提供或修改诸如字符串、尺寸或样式等资源。</li>
<li><strong>依赖注入</strong>：像 <strong>Dagger</strong> 和 <strong>Hilt</strong> 这样的库会创建 <code>ContextWrapper</code>，以便将自定义 <code>Context</code> 附加到组件上进行依赖注入。</li>
</ol>
<p>下面的代码展示了如何使用 <code>ContextWrapper</code> 来应用自定义主题：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomThemeContextWrapper</span>(base: Context) : ContextWrapper(base) {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getTheme</span><span class="hljs-params">()</span></span>: Resources.Theme {
        <span class="hljs-keyword">val</span> theme = <span class="hljs-keyword">super</span>.getTheme()
        theme.applyStyle(R.style.CustomTheme, <span class="hljs-literal">true</span>) <span class="hljs-comment">// Apply a custom theme</span>
        <span class="hljs-keyword">return</span> theme
    }
}
</code></pre>
<p>你可以在 <code>Activity</code> 中使用这个自定义包装器：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">attachBaseContext</span><span class="hljs-params">(newBase: <span class="hljs-type">Context</span>)</span></span> {
        <span class="hljs-keyword">super</span>.attachBaseContext(CustomThemeContextWrapper(newBase))
    }
}
</code></pre>
<p>在此示例中，<code>CustomThemeContextWrapper</code> 为 <code>Activity</code> 应用了特定主题，覆盖了基础上下文的默认行为。</p>
<p>这样做有很多好处：</p>
<ul>
<li><strong>可复用性</strong>：你能将自定义逻辑封装在包装器类中，并在多个组件间复用。</li>
<li><strong>封装性</strong>：增强或修改行为的同时，无需更改原始 <code>Context</code> 的实现。</li>
<li><strong>兼容性</strong>：与现有 <code>Context</code> 对象无缝协作，保持向后兼容性。</li>
</ul>
<p>总之。</p>
<p><code>ContextWrapper</code> 是 Android 中用于定制 <code>Context</code> 行为的灵活且可复用的工具。它使开发者能够拦截并修改对原始 <code>Context</code> 的调用，而无需直接更改它，这使其成为构建模块化且适应性强的应用程序必不可少的类。</p>
<h3 data-id="heading-10">进阶：Activity 中的 baseContext 是什么</h3>
<p>在 <code>Activity</code> 中，<code>this</code> 和 <code>baseContext</code> 都能用于访问 <code>Context</code>，但它们用途不同，代表着 Android 上下文层级结构中的不同层次。清楚何时使用它们，对避免代码混淆或潜在问题至关重要。</p>
<p>在 <code>Activity</code> 中，关键字 <code>this</code> 指的是 <code>Activity</code> 类的当前实例。由于 <code>Activity</code> 是 <code>ContextWrapper</code> 的子类（因而间接是 <code>Context</code> 的子类），<code>this</code> 提供了对 <code>Activity</code> 特定上下文的访问，包括诸如生命周期管理以及与用户界面（UI）交互等额外功能。</p>
<p>当在 <code>Activity</code> 中使用 <code>this</code> 时，它通常指向 <code>Activity</code> 的当前上下文，允许你调用特定于该 <code>Activity</code> 的方法。例如，如果你需要启动另一个 <code>Activity</code> 或显示与这个特定 <code>Activity</code> 相关联的对话框，就可以使用 <code>this</code>。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">val</span> intent = Intent(<span class="hljs-keyword">this</span>, AnotherActivity::<span class="hljs-keyword">class</span>.java)
startActivity(intent)

<span class="hljs-keyword">val</span> dialog = AlertDialog.Builder(<span class="hljs-keyword">this</span>)
    .setTitle(&amp;#<span class="hljs-number">34</span>;Example&amp;#<span class="hljs-number">34</span>;)
    .setMessage(&amp;#<span class="hljs-number">34</span>;This dialog <span class="hljs-keyword">is</span> tied to <span class="hljs-keyword">this</span> Activity instance.&amp;#<span class="hljs-number">34</span>;)
    .show()
</code></pre>
<p><code>baseContext</code> 代表 <code>Activity</code> 所基于的基础上下文。它是 <code>ContextWrapper</code> 类的一部分，而 <code>Activity</code> 继承自 <code>ContextWrapper</code>。<code>baseContext</code> 通常是 <code>ContextImpl</code> 实例，为 <code>Context</code> 方法提供核心实现。</p>
<p><code>baseContext</code> 一般通过 <code>getBaseContext()</code> 方法来访问。你很少直接使用它，但在处理自定义 <code>ContextWrapper</code> 实现，或者需要引用被包装上下文背后的原始上下文时，它就会派上用场。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-comment">// 和直接通过 this 返回的相比，此处的 baseContext 不携带当前 Activity 的主题信息</span>
<span class="hljs-keyword">val</span> systemService = baseContext.getSystemService(Context.LAYOUT_INFLATER_SERVICE)
</code></pre>
<p>总结一下他们之间的区别：</p>
<ol>
<li><strong>作用域</strong>：<code>this</code> 代表当前的 <code>Activity</code> 实例及其生命周期，而 <code>baseContext</code> 指的是 <code>Activity</code> 构建所基于的更低层次的上下文。</li>
<li><strong>用法</strong>：<code>this</code> 通常用于与 <code>Activity</code> 生命周期或用户界面（UI）相关的操作，例如启动 <code>Activity</code> 或显示对话框。<code>baseContext</code> 一般在与 <code>Context</code> 的核心实现进行交互时使用，特别是在自定义 <code>ContextWrapper</code> 的场景中。</li>
<li><strong>层级关系</strong>：<code>baseContext</code> 是 <code>Activity</code> 的基础上下文。访问 <code>baseContext</code> 会绕过 <code>Activity</code> 作为 <code>ContextWrapper</code> 所提供的额外功能。</li>
</ol>
<p>总之。</p>
<p>在 <code>Activity</code> 中，<code>this</code> 指向当前的 <code>Activity</code> 实例，提供了具有生命周期和特定于用户界面（UI）功能的高级上下文。而 <code>baseContext</code> 代表 <code>Activity</code> 所基于的基础上下文，常用于诸如自定义 <code>ContextWrapper</code> 实现等高级场景。虽然在 Android 开发中 <code>this</code> 使用最为普遍，但理解 <code>baseContext</code> 有助于调试以及创建模块化、可复用的组件。</p>
<h2 data-id="heading-11">番外</h2>
<p>本文讲述的技术细节完全是基于面试下的，如果你想对 <code>Context</code> 有个更加完整的认识，请看下面两篇文章：</p>
<p><a href="https://juejin.cn/post/7531888045412663348" target="_blank" title="https://juejin.cn/post/7531888045412663348">憋了一周了，12000字深入浅出Android的Context机制</a></p>
<p><a href="https://juejin.cn/post/7527953491890274319" target="_blank" title="https://juejin.cn/post/7527953491890274319">2025年了，万字长文带你了解Context</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[祖传项目二开快上线了，却还有很多旧的资源，怎么办？]]></title>    <link>https://juejin.cn/post/7582047554090254345</link>    <guid>https://juejin.cn/post/7582047554090254345</guid>    <pubDate>2025-12-11T00:49:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582047554090254345" data-draft-id="7582047554090221577" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="祖传项目二开快上线了，却还有很多旧的资源，怎么办？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-11T00:49:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亿元程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1972988307323236"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            祖传项目二开快上线了，却还有很多旧的资源，怎么办？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972988307323236/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亿元程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T00:49:20.000Z" title="Thu Dec 11 2025 00:49:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>点击上方亿元程序员+关注和★星标</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d37f61c1b0a24fdc9d8f8cabe7af6a1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766018959&amp;x-signature=1gTzZRzeppWCybmhWQHR47JHzCs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p><strong>哈喽大家好</strong>，欢迎小伙伴提供的素材：</p>
<blockquote>
<p><strong>亿哥</strong>晚上好，上次压缩了<code>PNG</code>图片后，图片资源还是非常大。</p>
<p><strong>仔细</strong>研究了一下，发现项目里面居然还有很多没用到的祖传资源！</p>
<p><strong>游戏快要上线了，项目里却还有很多旧的资源，怎么办？</strong></p>
</blockquote>
<p><strong>通常</strong>这样的情况出现于项目的二次开发阶段或者界面效果不好频繁更换的情况。</p>
<p><strong>由于</strong>界面的布局发生变化，图片没办法直接覆盖替换，一不小心就有可能会导致旧资源遗忘在项目里，造成“泄漏”。</p>
<p><strong>那</strong>我们把遗忘的资源删掉不就好了？</p>
<p><strong>是的</strong>，前提是要知道哪些资源是已经没被引用了！</p>
<p><strong>言归正传</strong>，本期一起来看看，如何在<code>Cocos</code>游戏开发中，自定义插件<strong>查看资源被什么资源引用</strong>。</p>
<p><strong>本文源工程可在文末获取，小伙伴们自行前往。</strong></p>
<h2 data-id="heading-1">直接上实例</h2>
<p><strong>客官</strong>请留步，倒杯茶，咱们本期直接上实例，废话最后再说。</p>
<h3 data-id="heading-2">1.创建插件</h3>
<p><strong>想要自定义插件查看资源被什么引用</strong>，首先要创建我们的插件，通过菜单<code>扩展-&gt;创建扩展</code>打开扩展创建面板,选择一个空白模板进行创建并启用插件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b16bcdd42f74bb2b68af650cacba3e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766018959&amp;x-signature=3nirqIUY6yeQ2s1LUYoflaLPGYU%3D" alt="" loading="lazy"/></p>
<p><strong>添加</strong>个消息<code>findReferences</code>和快捷键<code>ctrl+shift+f</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3ce30d4f4724c1ab3c7a58badafa8c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766018959&amp;x-signature=5Gxwunlm%2BvXNjqX%2FMQgN69WSDfg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">2.插件原理</h3>
<blockquote>
<p><strong>每个</strong>导入项目的资源（图片、音频、<code>prefab</code>、脚本等）都会自动分配一个<code>uuid</code>。</p>
<p><strong>这个</strong><code>uuid</code>用于在项目中唯一标识该资源。</p>
<p><strong>通常</strong><code>uuid</code>会在资源文件或者资源的<code>meta</code>文件中。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98f4f29b5a8a436d94c309ecacfe79d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766018959&amp;x-signature=8I5a0qZGFbI83t5UPOtrWDFx0HI%3D" alt="" loading="lazy"/></p>
<p><strong>如上图</strong>，<code>Main.scene</code>的<code>uuid</code>，或者是在下图的<code>Main.scene.meta</code>文件中:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/506a022e64634689890e331686302681~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766018959&amp;x-signature=x1gBoXE15zEt99AAi6cXpzIOrww%3D" alt="" loading="lazy"/></p>
<p><strong>原理很简单</strong>，就是获取当前资源的<code>uuid</code>，然后再去查找其他所有资源，如果其他资源文件的数据中包含了当前资源的<code>uuid</code>，说明当前资源被引用。</p>
<h3 data-id="heading-4">3.插件流程</h3>
<blockquote>
<p><code>开始-&gt;获取选中的资源的uuid-&gt;遍历asset目录所有的资源-&gt;判断uuid是否在遍历资源的数据中-&gt;结束</code></p>
</blockquote>
<ul>
<li>
<p><strong>获取选中的资源的uuid</strong>：<code>const selectedUuids = Editor.Selection.getSelected(&amp;#34;asset&amp;#34;);</code>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ac48a296e144965bf27e1bf925a04ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766018959&amp;x-signature=SqPfa6P8O9sQE%2FvYDHyeLsRjd0Q%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p><strong>遍历asset目录所有的资源</strong>: <code>const allAssets = await Editor.Message.request('asset-db', 'query-assets', { pattern: 'db://assets/**/*' }); </code>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9034bf915a948c1917a68b5c19ba169~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766018959&amp;x-signature=4JRpRXX%2FM3kjFUkSM9jH4vSHHp4%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p><strong>判断uuid是否在遍历资源的数据中</strong>: <code>let assetFile = fs.readFileSync(assetInfo.file, 'utf-8');</code>通过<code>fs</code>模块读取文件内容然后判断是否包含选中资源的<code>uuid</code>。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bba76712b3e34161b6a4feee502c141b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766018959&amp;x-signature=OcNr9NWg6UfWjeRDp6v7N7KmSpU%3D" alt="" loading="lazy"/></p>
</li>
</ul>
<h3 data-id="heading-5">4.效果演示</h3>
<p><strong>在插件目录</strong>，安装依赖<code>npm install</code>和构建插件<code>npm run build</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30ab53fbc76a48d4a15b2b69d25fe9a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766018959&amp;x-signature=33rswlodpy88WUFLTRqWi0j0ohk%3D" alt="" loading="lazy"/></p>
<p><strong>选中</strong>图片资源，按下<code>crtl+shift+f</code>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fb87c7111c44974a6d323ac13a0ddd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766018959&amp;x-signature=xyShvTZl9nKTD5ZtqfMbvHDjt6c%3D" alt="" loading="lazy"/></p>
<p><strong>选中</strong>脚本资源，按下<code>crtl+shift+f</code>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/daa9c570c1894df982cb8edee67ba533~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766018959&amp;x-signature=Z%2FCI6diCJrV3hzW2XsVYWSGdMjI%3D" alt="" loading="lazy"/></p>
<p><strong>整体</strong>预览如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0d22e7c30584fa58941775bb5de8b4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766018959&amp;x-signature=9FQ2TohKg0r%2B%2BVUeQIAMO85s3qI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">温馨提示</h2>
<ul>
<li>
<p><strong>以上</strong>插件功能仅显示选中资源的被引用情况，要查询所有资源的小伙伴可自行修改扩展遍历所有图片资源。</p>
</li>
<li>
<p><strong>插件</strong>仅查找资源被其他资源引用情况，代码中动态加载的资源，需要自行扩展(检索接口或配置)。</p>
</li>
<li>
<p><strong>除了</strong>在<code>Bundle</code>包中(包括<code>resources</code>文件夹)，没被依赖的资源不会被打到包中。</p>
</li>
<li>
<p><strong>工具检索</strong>是需要的，但是也需要人工对资源进行辨别，特别在上线前，保证不误删在用资源。</p>
</li>
</ul>
<h2 data-id="heading-7">结语</h2>
<p><strong>以上</strong>就是如何查看资源被什么资源引用的全部内容，如有不对，还请小伙伴们指出，欢迎更多的小伙伴进行投稿(素材、文章，硬币等等)，感谢支持！</p>
<p><strong>小伙伴们在游戏开发中还遇到哪些有趣的事情呢？</strong></p>
<p>本文<strong>源工程</strong>可通过<strong>私信</strong>发送 <strong>resfinder</strong> 获取，更多<strong>不实用资源</strong>可通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fstore.cocos.com%2Fapp%2Fdetail%2F6576" target="_blank" title="https://store.cocos.com/app/detail/6576" ref="nofollow noopener noreferrer">阅读原文</a>获取。</p>
<hr/>
<p><strong>我是"亿元程序员"，一位有着8年游戏行业经验的主程。在游戏开发中，希望能给到您帮助, 也希望通过您能帮助到大家。</strong></p>
<p>AD:笔者线上的小游戏《打螺丝闯关》《贪吃蛇掌机经典》《重力迷宫球》《填色之旅》《方块掌机经典》大家可以自行点击搜索体验。</p>
<p>实不相瞒，想要个<strong>赞</strong>和<strong>爱心</strong>！请把该文章<strong>分享</strong>给你觉得有需要的其他小伙伴。谢谢！</p>
<p>推荐专栏：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3175880857546129410%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3175880857546129410#wechat_redirect" ref="nofollow noopener noreferrer">知识付费专栏</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26mid%3D2247487282%26idx%3D1%26sn%3De3cb8ab6f5c0d5f804d5c29e2e90b9ad%26chksm%3Dc00daec5f77a27d33933e877464d8cde24c4c947d3755f5e8262c634634617e7c26de3953a54%26token%3D336413522%26lang%3Dzh_CN%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=Mzg5NTY2MjIzMg==&amp;mid=2247487282&amp;idx=1&amp;sn=e3cb8ab6f5c0d5f804d5c29e2e90b9ad&amp;chksm=c00daec5f77a27d33933e877464d8cde24c4c947d3755f5e8262c634634617e7c26de3953a54&amp;token=336413522&amp;lang=zh_CN#rd" ref="nofollow noopener noreferrer">你知道和不知道的微信小游戏常用API整理，赶紧收藏用起来~</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3207702867494305797%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3207702867494305797#wechat_redirect" ref="nofollow noopener noreferrer">100个Cocos实例</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3073771187570999299%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3073771187570999299#wechat_redirect" ref="nofollow noopener noreferrer">8年主程手把手打造Cocos独立游戏开发框架</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3121583619634626562%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3121583619634626562#wechat_redirect" ref="nofollow noopener noreferrer">和8年游戏主程一起学习设计模式</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3Faction%3Dgetalbum%26__biz%3DMzg5NTY2MjIzMg%3D%3D%26scene%3D1%26album_id%3D3038883468588089350%26count%3D3%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?action=getalbum&amp;__biz=Mzg5NTY2MjIzMg==&amp;scene=1&amp;album_id=3038883468588089350&amp;count=3#wechat_redirect" ref="nofollow noopener noreferrer">从零开始开发贪吃蛇小游戏到上线系列</a></p>
<p>点击下方灰色按钮+关注。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[剑指offer-49、把字符串转换成整数]]></title>    <link>https://juejin.cn/post/7582063437414449190</link>    <guid>https://juejin.cn/post/7582063437414449190</guid>    <pubDate>2025-12-11T00:56:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582063437414449190" data-draft-id="7580277964341510154" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 剑指offer-49、把字符串转换成整数"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-11T00:56:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             剑指offer-49、把字符串转换成整数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T00:56:56.000Z" title="Thu Dec 11 2025 00:56:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题⽬描述</h2>
<p>请你来实现⼀个 myAtoi(string s) 函数，使其能将字符串转换成⼀个 32 位有符号整数（类似C/C++ 中的 atoi 函数）。</p>
<p>函数 myAtoi(string s) 的算法如下：</p>
<ul>
<li>读⼊字符串并丢弃⽆⽤的前导空格</li>
<li>检查下⼀个字符（假设还未到字符末尾）为正还是负号，读取该字符（如果有）。 确定最终结果是负数，还是正数。 如果两者都不存在，则假定结果为正。</li>
<li>读⼊下⼀个字符，直到到达下⼀个⾮数字字符或到达输⼊的结尾。字符串的其余部分将被忽略。</li>
<li>将前⾯步骤读⼊的这些数字转换为整数（即，" 123 " -&gt; 123 ， " 0032 " -&gt; 32 ）。</li>
<li>如果没有读⼊数字，则整数为 0 。必要时更改符号（从步骤 2 开始）。</li>
<li>如果整数数超过 32 位有符号整数范围 [−2^31, 2^(31 − 1)] ，需要截断这个整数，使其保持在这个范围内。具体来说，⼩于 −2^31 的整数应该被固定为 2^31 ，⼤于 2^(31 − 1) 的整数应该被固定为2^(31 − 1)</li>
<li>返回整数作为最终结果。</li>
</ul>
<p>注意：</p>
<ul>
<li>本题中的空⽩字符只包括空格字符 ' ' 。</li>
<li>除前导空格或数字后的其余字符串外，请勿忽略 任何其他字符。</li>
</ul>
<p>示例1：
输⼊：s = "42"
输出：42
解释：加粗的字符串为已经读⼊的字符，插⼊符号是当前读取的字符。</p>
<ol>
<li>第 1 步："42"（当前没有读⼊字符，因为没有前导空格）</li>
<li>第 2 步："42"（当前没有读⼊字符，因为这⾥不存在 '-' 或者 '+'）</li>
<li>第 3 步："42"（读⼊ "42"）</li>
<li>解析得到整数 42 。</li>
<li>由于 "42" 在范围 [-231, 231 - 1] 内，最终结果为 42 。</li>
</ol>
<p>示例2：
输⼊：s = " -42"
输出：-42
解释：</p>
<ol>
<li>第 1 步：" -42"（读⼊前导空格，但忽视掉）</li>
<li>第 2 步：" -42"（读⼊ '-' 字符，所以结果应该是负数）</li>
<li>第 3 步：" -42"（读⼊ "42"）</li>
<li>解析得到整数 -42 。</li>
<li>由于 "-42" 在范围 [-231, 231 - 1] 内，最终结果为 -42 。</li>
</ol>
<p>示例3：
输⼊：s = "4193 with words"
输出：4193
解释：</p>
<ol>
<li>第 1 步："4193 with words"（当前没有读⼊字符，因为没有前导空格）</li>
<li>第 2 步："4193 with words"（当前没有读⼊字符，因为这⾥不存在 '-' 或者 '+'）</li>
<li>第 3 步："4193 with words"（读⼊ "4193"；由于下⼀个字符不是⼀个数字，所以读⼊停⽌）</li>
<li>解析得到整数 4193 。</li>
<li>由于 "4193" 在范围 [-231, 231 - 1] 内，最终结果为 4193 。</li>
</ol>
<p>示例4：
输⼊：s = "words and 987"
输出：0
解释：</p>
<ol>
<li>第 1 步："words and 987"（当前没有读⼊字符，因为没有前导空格）</li>
<li>第 2 步："words and 987"（当前没有读⼊字符，因为这⾥不存在 '-' 或者 '+'）</li>
<li>第 3 步："words and 987"（由于当前字符 'w' 不是⼀个数字，所以读⼊停⽌）</li>
<li>解析得到整数 0 ，因为没有读⼊任何数字。</li>
<li>由于 0 在范围 [-231, 231 - 1] 内，最终结果为 0 。</li>
</ol>
<p>示例5：
输⼊：s = "-91283472332"
输出：-2147483648
解释：</p>
<ol>
<li>第 1 步："-91283472332"（当前没有读⼊字符，因为没有前导空格）</li>
<li>第 2 步："-91283472332"（读⼊ '-' 字符，所以结果应该是负数）</li>
<li>第 3 步："-91283472332"（读⼊ "91283472332"）</li>
<li>解析得到整数 -91283472332 。</li>
<li>由于 -91283472332 ⼩于范围 [-231, 231 - 1] 的下界，最终结果被截断为 -231 = -2147483648</li>
</ol>
<p>提示：</p>
<ul>
<li>0 &lt;= s.length &lt;= 200</li>
<li>s 由英⽂字⺟（⼤写和⼩写）、数字（0-9）、' '、'+'、'-' 和 '.' 组成</li>
</ul>
<h2 data-id="heading-1">思路与解答</h2>
<h3 data-id="heading-2">基础遍历法</h3>
<p>这道题⽬看起来很⻓，但是实际上逻辑很清晰，就是将字符串解析成为数字，⾥⾯有⼏个特殊的则：</p>
<ol>
<li>前⾯的空格去掉，不读取</li>
<li>接下来的字符必须是数字，“ + ”号或者“ - ”号
<ol>
<li>如果是“ + ”号或者“ - ”号，将符号记录下来</li>
<li>没有符号默认是“ + ”号，正数。</li>
</ol>
</li>
<li>接下来的字符必须是数字，遇到其他字符会直接结束</li>
<li>需要考虑溢出的问题</li>
</ol>
<p>在将字符串转换成数字的时候，⽤下⾯这句核⼼代码：</p>
<pre><code class="hljs language-java" lang="java">sum = sum * <span class="hljs-number">10</span> + (str.charAt(i) - <span class="hljs-string">'0'</span>);
</code></pre>
<p>但是在这个过程中，我们依然需要考虑数字溢出的问题，针对这种情况，我们可以在加和之前判断，针对⼤于0的情况，如果⼤于最⼤值整除10，或者等于最⼤值整除10，但是个位数超过了，都直接返回0。</p>
<p>假设最⼤值是127，那么sum如果⼤于12，肯定会超过，如果sum == 12，但是个位数⼤于7，乘以10相加，也肯定会超。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">if</span> (sum &gt; Integer.MAX_VALUE/<span class="hljs-number">10</span> || (sum == Integer.MAX_VALUE / <span class="hljs-number">10</span> &amp;&amp;
(str.charAt(i) - <span class="hljs-string">'0'</span>) &gt; <span class="hljs-number">7</span>)) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
</code></pre>
<p>对于⼩于0 的情况，假设最⼩值是-128 ，那么sum 是数字部分 128 , 如果当前sum ⼤于 12 ，那么就⼀定超出，或者sum == 12 ，但是个位数⼤于8 ，乘以10 ，相加也会⼤于128 ，不符合要求，所以直接返回0 。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">if</span> (sum &lt; Integer.MIN_VALUE/<span class="hljs-number">10</span> || (sum == Integer.MIN_VALUE / <span class="hljs-number">10</span> &amp;&amp; x
(str.charAt(i) - <span class="hljs-string">'0'</span>) &gt; <span class="hljs-number">8</span>)) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
</code></pre>
<p>具体代码实现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">myAtoi</span><span class="hljs-params">(String str)</span> {
        <span class="hljs-keyword">if</span> (str == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span> (i &lt; str.length() &amp;&amp; str.charAt(i) == <span class="hljs-string">' '</span>) {
            i++;
        }
        <span class="hljs-keyword">if</span> (i &gt;= str.length() || (str.charAt(i) != <span class="hljs-string">'-'</span> &amp;&amp; str.charAt(i) != <span class="hljs-string">'+'</span> &amp;&amp; !((str.charAt(i) &gt;= <span class="hljs-string">'0'</span>) &amp;&amp;
                (str.charAt(i) &lt;= <span class="hljs-string">'9'</span>)))) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
        <span class="hljs-type">int</span> <span class="hljs-variable">sign</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (i &lt; str.length() &amp;&amp; (str.charAt(i) == <span class="hljs-string">'-'</span> || i &lt; str.length() &amp;&amp;
                str.charAt(i) == <span class="hljs-string">'+'</span>)) {
            sign = str.charAt(i) == <span class="hljs-string">'-'</span> ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>;
            i++;
        }
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (; i &lt; str.length(); i++) {
            <span class="hljs-keyword">if</span> (str.charAt(i) &gt;= <span class="hljs-string">'0'</span> &amp;&amp; str.charAt(i) &lt;= <span class="hljs-string">'9'</span>) {
                <span class="hljs-keyword">if</span> (sign == <span class="hljs-number">1</span>) {
                    <span class="hljs-keyword">if</span> (sum &gt; Integer.MAX_VALUE / <span class="hljs-number">10</span> || sum == Integer.MAX_VALUE / <span class="hljs-number">10</span> &amp;&amp; (str.charAt(i) - <span class="hljs-string">'0'</span>) &gt; <span class="hljs-number">7</span>) {
                        <span class="hljs-keyword">return</span> Integer.MAX_VALUE;
                    }
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">if</span> (sum &gt; (Integer.MAX_VALUE) / <span class="hljs-number">10</span> || sum ==
                        (Integer.MAX_VALUE) / <span class="hljs-number">10</span> &amp;&amp; (str.charAt(i) - <span class="hljs-string">'0'</span>) &gt; <span class="hljs-number">8</span>) {
                        <span class="hljs-keyword">return</span> Integer.MIN_VALUE;
                    }
                }
                sum = sum * <span class="hljs-number">10</span> + (str.charAt(i) - <span class="hljs-string">'0'</span>);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> sum * sign;
            }
        }
        <span class="hljs-keyword">return</span> sum * sign;
    }
}
</code></pre>
<ul>
<li>时间复杂度为 O(n)</li>
<li>空间复杂度为 O(1)。</li>
</ul>
<h3 data-id="heading-3">正则表达式</h3>
<p>使用正则表达式来匹配数字模式，代码更加简洁</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">myAtoi</span><span class="hljs-params">(String s)</span> {
        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        
        s = s.trim();
        <span class="hljs-keyword">if</span> (s.length() == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// 使用正则表达式匹配数字模式：可选符号位+数字[3](@ref)</span>
        <span class="hljs-type">Pattern</span> <span class="hljs-variable">pattern</span> <span class="hljs-operator">=</span> Pattern.compile(&amp;#<span class="hljs-number">34</span>;^[+-]?\\d+&amp;#<span class="hljs-number">34</span>;);
        <span class="hljs-type">Matcher</span> <span class="hljs-variable">matcher</span> <span class="hljs-operator">=</span> pattern.matcher(s);
        
        <span class="hljs-keyword">if</span> (!matcher.find()) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 没有匹配到数字模式</span>
        }
        
        <span class="hljs-type">String</span> <span class="hljs-variable">numStr</span> <span class="hljs-operator">=</span> matcher.group();
        <span class="hljs-type">int</span> <span class="hljs-variable">sign</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">startIndex</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// 处理符号位</span>
        <span class="hljs-keyword">if</span> (numStr.charAt(<span class="hljs-number">0</span>) == <span class="hljs-string">'+'</span>) {
            startIndex = <span class="hljs-number">1</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (numStr.charAt(<span class="hljs-number">0</span>) == <span class="hljs-string">'-'</span>) {
            sign = -<span class="hljs-number">1</span>;
            startIndex = <span class="hljs-number">1</span>;
        }
        
        <span class="hljs-type">long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 使用long防止转换过程中溢出</span>
        
        <span class="hljs-comment">// 转换数字部分</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> startIndex; i &lt; numStr.length(); i++) {
            <span class="hljs-type">int</span> <span class="hljs-variable">digit</span> <span class="hljs-operator">=</span> numStr.charAt(i) - <span class="hljs-string">'0'</span>;
            result = result * <span class="hljs-number">10</span> + digit;
            
            <span class="hljs-comment">// 检查是否溢出int范围</span>
            <span class="hljs-keyword">if</span> (sign == <span class="hljs-number">1</span> &amp;&amp; result &gt; Integer.MAX_VALUE) {
                <span class="hljs-keyword">return</span> Integer.MAX_VALUE;
            }
            <span class="hljs-keyword">if</span> (sign == -<span class="hljs-number">1</span> &amp;&amp; -result &lt; Integer.MIN_VALUE) {
                <span class="hljs-keyword">return</span> Integer.MIN_VALUE;
            }
        }
        
        <span class="hljs-keyword">return</span> (<span class="hljs-type">int</span>) result * sign;
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n)，正则匹配和数字转换都是线性时间</li>
<li><strong>空间复杂度</strong>：O(n)，需要存储匹配到的子字符串</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Pinia 入门：为什么说它是 Vuex 更具魅力的现代继任者？]]></title>    <link>https://juejin.cn/post/7582067084840534070</link>    <guid>https://juejin.cn/post/7582067084840534070</guid>    <pubDate>2025-12-10T23:31:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582067084840534070" data-draft-id="7582067084840517686" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Pinia 入门：为什么说它是 Vuex 更具魅力的现代继任者？"/> <meta itemprop="keywords" content="Vue.js,JavaScript,前端"/> <meta itemprop="datePublished" content="2025-12-10T23:31:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小马写码"/> <meta itemprop="url" content="https://juejin.cn/user/3940246036939358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Pinia 入门：为什么说它是 Vuex 更具魅力的现代继任者？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3940246036939358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小马写码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T23:31:16.000Z" title="Wed Dec 10 2025 23:31:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：Vue 状态管理的时代变迁</h2>
<p>在 Vue.js 应用开发的世界里，状态管理一直是构建复杂应用的核心课题。多年来，Vuex 作为官方状态管理库，几乎成为 Vue 项目的标准配置。然而，随着 Vue 3 的推出和开发理念的演进，一个全新的挑战者——<strong>Pinia</strong>——悄然登场，并迅速赢得了开发者的青睐。它不仅被 Vue 官方推荐为“默认的状态管理解决方案”，更以其简洁、直观和强大的特性，正在重新定义我们对 Vue 状态管理的认知。</p>
<h2 data-id="heading-1">一、Pinia 是什么？不仅仅是“另一个状态库”</h2>
<p>Pinia 是一个为 Vue.js 设计的状态管理库。它由 Vue 核心团队成员开发，旨在提供更直观、类型安全且模块化的状态管理体验。</p>
<p>与 Vuex 相比，Pinia 最显著的哲学转变是：<strong>它摒弃了 mutations 的概念</strong>。这个设计决策看似简单，却带来了开发体验的质变。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Pinia 的 Store 示例 - 简洁直观</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCounterStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'counter'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({ <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> }),
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++ <span class="hljs-comment">// 直接修改状态，无需 mutations</span>
    },
  },
  <span class="hljs-attr">getters</span>: {
    <span class="hljs-attr">doubleCount</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">count</span> * <span class="hljs-number">2</span>,
  },
})
</code></pre>
<h2 data-id="heading-2">二、为什么选择 Pinia？五大核心优势</h2>
<h3 data-id="heading-3">1. 更简洁的 API 设计</h3>
<p>Pinia 的 API 极度精简，学习曲线平缓。去掉了 Vuex 中的 <code>mutations</code>，状态修改可以通过 actions 直接完成，也可以直接赋值修改（配合响应式系统）。这种设计减少了概念数量，让代码更易读易写。</p>
<h3 data-id="heading-4">2. 完美的 TypeScript 支持</h3>
<p>Pinia 从一开始就为 TypeScript 设计，提供了出色的类型推断。你的 store、state、actions 和 getters 都能获得完整的类型安全，大幅提升开发效率和代码可靠性。</p>
<h3 data-id="heading-5">3. 模块化的自然实现</h3>
<p>在 Pinia 中，每个 store 都是独立的模块，无需像 Vuex 那样在单一 store 中注册模块。这种设计让代码组织更加灵活，也便于代码分割和按需加载。</p>
<h3 data-id="heading-6">4. 更友好的开发体验</h3>
<ul>
<li><strong>Composition API 风格</strong>：与 Vue 3 的 Composition API 完美契合</li>
<li><strong>DevTools 集成</strong>：支持 Vue DevTools，提供时间旅行调试</li>
<li><strong>热模块替换</strong>：支持开发时的热更新，保持状态不丢失</li>
</ul>
<h3 data-id="heading-7">5. 轻量且高性能</h3>
<p>Pinia 体积小巧，同时通过智能的设计避免了不必要的性能开销。它的响应式系统直接构建在 Vue 的 reactive API 之上，确保了高效的状态更新。</p>
<h2 data-id="heading-8">三、从 Vuex 迁移到 Pinia：一个平滑的过渡</h2>
<p>对于 Vuex 用户，迁移到 Pinia 是一个相对平滑的过程。两者核心概念有相似之处，但 Pinia 提供了更简洁的实现：</p>



































<table><thead><tr><th>特性</th><th>Vuex 4</th><th>Pinia</th></tr></thead><tbody><tr><td>状态定义</td><td><code>state</code> 函数</td><td><code>state</code> 函数</td></tr><tr><td>获取状态</td><td><code>getters</code></td><td><code>getters</code></td></tr><tr><td>修改状态</td><td><code>mutations</code> + <code>actions</code></td><td><code>actions</code>（可直接修改）</td></tr><tr><td>模块系统</td><td>嵌套模块</td><td>独立 store</td></tr><tr><td>TypeScript 支持</td><td>需要额外配置</td><td>开箱即用</td></tr></tbody></table>
<p>迁移示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vuex 方式</span>
<span class="hljs-attr">mutations</span>: {
  <span class="hljs-title function_">SET_COUNT</span>(<span class="hljs-params">state, value</span>) {
    state.<span class="hljs-property">count</span> = value
  }
},
<span class="hljs-attr">actions</span>: {
  <span class="hljs-title function_">updateCount</span>(<span class="hljs-params">{ commit }, value</span>) {
    <span class="hljs-title function_">commit</span>(<span class="hljs-string">'SET_COUNT'</span>, value)
  }
}

<span class="hljs-comment">// Pinia 方式（更简洁）</span>
<span class="hljs-attr">actions</span>: {
  <span class="hljs-title function_">updateCount</span>(<span class="hljs-params">value</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> = value <span class="hljs-comment">// 直接赋值，响应式系统自动处理</span>
  }
}
</code></pre>
<h2 data-id="heading-9">四、实战：构建你的第一个 Pinia Store</h2>
<p>让我们通过一个简单的用户管理示例，快速上手 Pinia：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// stores/user.js</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'user'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">user</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">isAuthenticated</span>: <span class="hljs-literal">false</span>,
  }),
  
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">credentials</span>) {
      <span class="hljs-comment">// 模拟 API 调用</span>
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">login</span>(credentials)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span> = response.<span class="hljs-property">user</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isAuthenticated</span> = <span class="hljs-literal">true</span>
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'token'</span>, response.<span class="hljs-property">token</span>)
    },
    
    <span class="hljs-title function_">logout</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span> = <span class="hljs-literal">null</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isAuthenticated</span> = <span class="hljs-literal">false</span>
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'token'</span>)
    },
  },
  
  <span class="hljs-attr">getters</span>: {
    <span class="hljs-attr">userName</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">user</span>?.<span class="hljs-property">name</span> || <span class="hljs-string">'Guest'</span>,
    <span class="hljs-attr">isAdmin</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">user</span>?.<span class="hljs-property">role</span> === <span class="hljs-string">'admin'</span>,
  },
})
</code></pre>
<p>在组件中使用：</p>
<pre><code class="hljs language-vue" lang="vue">
  &lt;div&gt;
    &lt;p&gt;Welcome, {{ userStore.userName }}&lt;/p&gt;
    Logout
  &lt;/div&gt;



import { useUserStore } from '@/stores/user'

const userStore = useUserStore()
// 可以直接访问状态和操作

</code></pre>
<h2 data-id="heading-10">五、高级特性：探索 Pinia 的强大能力</h2>
<h3 data-id="heading-11">1. Store 组合</h3>
<p>Pinia 允许 stores 之间相互调用，便于组织复杂的状态逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// stores/cart.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCartStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'cart'</span>, {
  <span class="hljs-comment">// ... cart 逻辑</span>
})

<span class="hljs-comment">// stores/checkout.js  </span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCheckoutStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'checkout'</span>, {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> cartStore = <span class="hljs-title function_">useCartStore</span>()
    
    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 可以访问其他 store</span>
      <span class="hljs-attr">cartItems</span>: cartStore.<span class="hljs-property">items</span>,
    }
  }
})
</code></pre>
<h3 data-id="heading-12">2. 插件系统</h3>
<p>Pinia 支持插件，可以轻松扩展功能，如持久化存储、日志记录等：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 持久化插件示例</span>
<span class="hljs-keyword">import</span> { createPinia } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-keyword">const</span> pinia = <span class="hljs-title function_">createPinia</span>()

pinia.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">{ store }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> key = <span class="hljs-string">`pinia-<span class="hljs-subst">${store.$id}</span>`</span>
  <span class="hljs-keyword">const</span> saved = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(key)
  <span class="hljs-keyword">if</span> (saved) {
    store.$patch(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(saved))
  }
  
  store.$subscribe(<span class="hljs-function">(<span class="hljs-params">mutation, state</span>) =&gt;</span> {
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(key, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(state))
  })
})
</code></pre>
<h2 data-id="heading-13">六、注意事项与最佳实践</h2>
<ol>
<li><strong>命名规范</strong>：建议使用 <code>use</code> 前缀命名 store（如 <code>useUserStore</code>），以符合 Composition API 惯例</li>
<li><strong>避免过度使用</strong>：不是所有状态都需要放入 Pinia，组件本地状态仍应使用 <code>ref</code> 或 <code>reactive</code></li>
<li><strong>保持 Actions 纯净</strong>：虽然可以直接修改状态，但建议通过 actions 进行修改，便于维护和调试</li>
<li><strong>利用 DevTools</strong>：充分利用 Vue DevTools 的 Pinia 面板进行状态调试</li>
</ol>
<h2 data-id="heading-14">结语：迎接 Vue 状态管理的新时代</h2>
<p>Pinia 的出现并非偶然，它代表了 Vue 生态向更简洁、更类型安全、更符合现代开发体验的方向演进。它保留了 Vuex 的核心思想，同时去除了其中的繁复部分，提供了更优雅的解决方案。</p>
<p>对于新项目，Pinia 无疑是默认的最佳选择；对于现有 Vuex 项目，也可以考虑逐步迁移，享受更优的开发体验。正如 Vue 创始人尤雨溪所言："Pinia 就是 Vuex 5，只不过我们决定叫它 Pinia"。</p>
<p>在状态管理的世界里，没有绝对的"最好"，只有"最适合"。而 Pinia，凭借其简洁的设计、出色的 TypeScript 支持和与 Vue 3 的完美融合，正成为越来越多 Vue 开发者的首选。它不仅是一个工具，更是 Vue 生态成熟和进步的标志——让我们以更少的代码，实现更强大的功能，享受更愉快的开发过程。</p>
<p>拥抱 Pinia，就是拥抱 Vue 状态管理的未来。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Mistral 掀桌了：Devstral 2 与 Vibe CLI 重塑开源编程体验]]></title>    <link>https://juejin.cn/post/7582063437414219814</link>    <guid>https://juejin.cn/post/7582063437414219814</guid>    <pubDate>2025-12-10T16:52:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582063437414219814" data-draft-id="7582063437414203430" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Mistral 掀桌了：Devstral 2 与 Vibe CLI 重塑开源编程体验"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-12-10T16:52:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Mistral 掀桌了：Devstral 2 与 Vibe CLI 重塑开源编程体验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T16:52:43.000Z" title="Wed Dec 10 2025 16:52:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025 年的年末，AI 编程圈子比以往任何时候都要热闹。就在大家都以为今年的大模型混战已经尘埃落定的时候，Mistral AI 在 12 月 9 日突然杀了个回马枪，发布了全新的 <strong>Devstral 2</strong> 编程模型家族，以及一个让人眼前一亮的终端工具 <strong>Mistral Vibe CLI</strong>。</p>
<p>这次发布不仅仅是丢出两个权重文件那么简单，Mistral 显然是看准了现在最火的“Agentic Coding”（代理式编程）赛道，试图用开源方案去动一动闭源巨头们的奶酪。</p>
<p>如果你是开发者，或者是对本地部署感兴趣的技术极客，这次更新里有几个必须要关注的硬核细节。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2FDevstral-Model-Performance-Comparison-Dark-1-1024x500.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/Devstral-Model-Performance-Comparison-Dark-1-1024x500.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54073f9490704ae19ea094f02cc3a66d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765990363&amp;x-signature=jEzm0u6nxK7gq70TAzWVI4NTKPg%3D" alt="Devstral - Model Performance Comparison (Dark) (1)" loading="lazy"/></a></p>
<h3 data-id="heading-0">所谓的“Vibe Coding”到底是什么？</h3>
<p>Mistral 这次主打的概念很有意思，叫“Vibe Coding”。听起来玄乎，但落地到产品 <strong>Mistral Vibe CLI</strong> 上，逻辑其实非常简单粗暴：把 AI 从单纯的“聊天框”里解放出来，直接塞进你的终端（Terminal）。</p>
<p>以往我们用 ChatGPT 写代码，流程通常是：复制需求 -&gt; 粘贴代码 -&gt; 报错 -&gt; 再复制报错。而 Vibe CLI 是一个原生的命令行 Agent。它能直接读取你的本地文件结构，理解 Git 状态，甚至帮你执行 Shell 命令。</p>
<p>这意味着你可以直接在终端里对它说：“帮我重构一下 <code>auth.py</code>，顺便把相关的测试文件也改了。”它拥有多文件编辑的能力，不再是“只动口不动手”，而是直接对代码库进行手术。对于习惯在 UNIX 环境下工作的开发者来说，这种无需离开终端的体验，确实很“Vibe”。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2FDevstral-SWE-Bench-Verified-Regular-Performance-xModelsize-Dark-1024x589.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/Devstral-SWE-Bench-Verified-Regular-Performance-xModelsize-Dark-1024x589.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b874aa8980544ef8a4dfc7fd11c0642~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765990363&amp;x-signature=h29zdEfm3JEiTuvz0zhv6Wv3%2Bl8%3D" alt="Devstral - SWE-Bench Verified Regular Performance xModelsize (Dark)" loading="lazy"/></a></p>
<h3 data-id="heading-1">硬菜上桌：两款模型，两种打法</h3>
<p>这次发布的 Devstral 2 家族包含两个版本，刀法精准，分别瞄准了企业级生产力和个人开发者。</p>
<p><strong>1. 旗舰猛兽：Devstral 2 (123B)</strong></p>
<p>这是一头参数量约为 1230 亿的庞然大物。它的定位非常明确：对标目前市面上最强的闭源模型（比如 Claude 3.5 Sonnet）。</p>
<ul>
<li><strong>能力：</strong> 拥有 256k 的超长上下文，这意味着它可以一次性吞下整个项目的代码库。在 SWE-bench Verified 基准测试中，它拿下了 72.2% 的高分。这个成绩相当惊人，要知道它是一个开源权重的模型。</li>
<li><strong>擅长：</strong> 复杂的跨文件重构、架构层面的理解、以及作为 Agent 调用各种工具。</li>
<li><strong>注意点：</strong> 它的开源协议是 <strong>Modified MIT</strong>。虽然允许商用，但 Mistral 留了一手：如果你的公司月收入超过 2000 万美元，使用条款会有所限制。这显然是为了防止科技巨头直接白嫖。</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2FDevstral-SWE-Bench-Verified_-OpenWeights-vs-Proprietary-Models-Dark-1-1024x664.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/Devstral-SWE-Bench-Verified_-OpenWeights-vs-Proprietary-Models-Dark-1-1024x664.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e76be34094a4f8c988d7fdbfa1692f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765990363&amp;x-signature=WlBchjNSdB2I8zu7lhIPHI49XWg%3D" alt="Devstral - SWE-Bench Verified_ OpenWeights vs Proprietary Models (Dark) (1)" loading="lazy"/></a></p>
<p><strong>2. 桌面小钢炮：Devstral Small 2 (24B)</strong></p>
<p>对于大多数想在本地跑模型的开发者来说，这个 240 亿参数的版本才是真正的甜点。</p>
<ul>
<li><strong>性价比：</strong> 它使用了更宽松的 <strong>Apache 2.0</strong> 协议，完全开源。</li>
<li><strong>配置需求：</strong> 24B 的大小意味着你不需要拥有 H100 这种核弹级显卡。高端消费级显卡（如 4090）或者 Mac Studio 配合适当的量化，完全可以在本地流畅运行。</li>
<li><strong>性能：</strong> 别看它小，它在基准测试中达到了 68.0% 的分数。官方宣称它的效率极高，不仅推理速度快，而且在处理多文件编辑时的逻辑并不输给很多大参数模型。</li>
</ul>
<h3 data-id="heading-2">为什么这次发布很重要？</h3>
<p>在 Devstral 2 之前，开源编程模型虽然多（比如 DeepSeek 早期版本、CodeLlama 等），但在“Agent”能力上总是差一口气。所谓的 Agent 能力，就是模型不仅要会写代码，还要知道怎么使用工具、怎么自我纠错、怎么在不破坏原有逻辑的情况下修改多个文件。</p>
<p>Mistral 这次直接把“软件工程（SWE）”作为核心训练目标。官方数据显示，Devstral 2 在工具调用和多步推理上的表现非常稳健。这填补了开源领域的一个空白：我们需要一个能真正像“工程师”一样思考，而不仅仅是像“自动补全机器”一样工作的模型。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2FiShot_2025-12-11_00.39.55-1024x353.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/iShot_2025-12-11_00.39.55-1024x353.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3e7baba7b004e88b478fb3aed4257a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765990363&amp;x-signature=Sfziefk7Pj2meSOBw3sJNAzxuq8%3D" alt="iShot_2025-12-11_00.39.55" loading="lazy"/></a></p>
<h3 data-id="heading-3">如何上手？</h3>
<p>目前体验这套系统主要有三条路：</p>
<ol>
<li><strong>尝鲜党：</strong> 直接去 Mistral 官方平台申请 API，目前有一段免费使用期。这是体验满血版 123B 模型最快的方式。</li>
<li><strong>本地党：</strong> 既然开源了，Hugging Face 上已经有了权重。如果你有显卡资源，拉取 Devstral Small 2 (24B)，配合 vLLM 或者 Ollama（等待社区适配），就能在离线环境下拥有一个强力的编程助手。</li>
<li><strong>极客党：</strong> 安装 <code>mistral-vibe</code> CLI 工具。只要配置好环境，你就能体验那种“对着终端说话，代码自动生成”的感觉。当然，官方也提醒了，在让 AI 修改核心代码前，最好在一个受控的测试分支里进行，毕竟 AI 偶尔也会“发疯”。</li>
</ol>
<h3 data-id="heading-4">写在最后</h3>
<p>Devstral 2 的出现，让开源编程模型的水平又上了一个台阶。它不再满足于代码补全，而是试图接管更复杂的工程任务。</p>
<p>对于个人开发者而言，24B 版本的 Apache 2.0 协议是一份大礼；对于企业而言，123B 版本则提供了一个可以在私有环境部署的强力选项。虽然目前还需要时间来验证它在真实复杂项目中的稳定性，但至少 Mistral 证明了一件事：在代码智能这条赛道上，开源社区依然拥有与闭源巨头叫板的底气。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Netty（4）Netty的Channel是什么？它有哪些类型？]]></title>    <link>https://juejin.cn/post/7582039917217824768</link>    <guid>https://juejin.cn/post/7582039917217824768</guid>    <pubDate>2025-12-10T23:07:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582039917217824768" data-draft-id="7582044568721473576" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Netty（4）Netty的Channel是什么？它有哪些类型？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-10T23:07:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Netty（4）Netty的Channel是什么？它有哪些类型？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T23:07:15.000Z" title="Wed Dec 10 2025 23:07:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Netty中，Channel（通道）是网络操作的抽象概念，它代表一个开放的连接，可以进行数据的读取和写入。Channel提供了异步的、事件驱动的方式处理数据的传输和操作。</p>
<p>Netty提供了多种类型的Channel，以适应不同的网络协议和传输方式。以下是一些常见的Channel类型：</p>
<ol>
<li>
<p>NioSocketChannel：基于Java NIO的SocketChannel，用于TCP客户端。</p>
</li>
<li>
<p>NioServerSocketChannel：基于Java NIO的ServerSocketChannel，用于TCP服务器。</p>
</li>
<li>
<p>NioDatagramChannel：基于Java NIO的DatagramChannel，用于UDP通信。</p>
</li>
<li>
<p>EmbeddedChannel：用于测试和内嵌式处理。</p>
</li>
<li>
<p>OioSocketChannel：基于传统的阻塞式I/O的SocketChannel，用于TCP客户端。</p>
</li>
<li>
<p>OioServerSocketChannel：基于传统的阻塞式I/O的ServerSocketChannel，用于TCP服务器。</p>
</li>
</ol>
<p>下面是一个简单的示例代码，展示了如何使用Netty的NioSocketChannel：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.bootstrap.Bootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelFuture;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;
<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringDecoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringEncoder;
<span class="hljs-keyword">import</span> io.netty.handler.logging.LogLevel;
<span class="hljs-keyword">import</span> io.netty.handler.logging.LoggingHandler;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChannelExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">HOST</span> <span class="hljs-operator">=</span> &amp;#<span class="hljs-number">34</span>;localhost&amp;#<span class="hljs-number">34</span>;;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">PORT</span> <span class="hljs-operator">=</span> <span class="hljs-number">8080</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Bootstrap</span> <span class="hljs-variable">bootstrap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bootstrap</span>();
            bootstrap.group(group)
                    .channel(NioSocketChannel.class)
                    .handler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoggingHandler</span>(LogLevel.INFO))
                    .handler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>() {
                        <span class="hljs-meta">@Override</span>
                        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
                            ch.pipeline().addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringDecoder</span>(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringEncoder</span>(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">EchoClientHandler</span>());
                        }
                    });

            <span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">future</span> <span class="hljs-operator">=</span> bootstrap.connect(HOST, PORT).sync();
            future.channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            group.shutdownGracefully();
        }
    }
}

<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EchoClientHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChannelInboundHandlerAdapter</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelActive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> &amp;#<span class="hljs-number">34</span>;Hello, Netty!&amp;#<span class="hljs-number">34</span>;;
        ctx.writeAndFlush(message); <span class="hljs-comment">// 发送消息给服务器</span>
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> (String) msg;
        System.out.println(&amp;#<span class="hljs-number">34</span>;Received message: &amp;#<span class="hljs-number">34</span>; + message);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception {
        cause.printStackTrace();
        ctx.close(); <span class="hljs-comment">// 发生异常时关闭连接</span>
    }
}
</code></pre>
<p>在上面的示例中，我们使用了NioSocketChannel作为客户端的Channel类型。在Bootstrap的配置中，我们指定了通道类型（NioSocketChannel）和日志处理器（LoggingHandler）。在initChannel方法中，我们添加了自定义的ChannelHandler（EchoClientHandler）来处理事件和数据。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[编程界 语言神 : 赶紧起来学 Rust 了！]]></title>    <link>https://juejin.cn/post/7582048028393373746</link>    <guid>https://juejin.cn/post/7582048028393373746</guid>    <pubDate>2025-12-10T16:04:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582048028393373746" data-draft-id="7582021506190671918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="编程界 语言神 :  赶紧起来学 Rust 了！"/> <meta itemprop="keywords" content="Rust"/> <meta itemprop="datePublished" content="2025-12-10T16:04:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Pomelo_刘金"/> <meta itemprop="url" content="https://juejin.cn/user/3450694359320669"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            编程界 语言神 :  赶紧起来学 Rust 了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3450694359320669/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Pomelo_刘金
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T16:04:53.000Z" title="Wed Dec 10 2025 16:04:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">大家对 Rust 的印象</h3>
<h4 data-id="heading-1">没接触过的：</h4>
<p>编程界语言神</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c41de4bc9dd44d385e4eb9ad5825f61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUG9tZWxvX-WImOmHkQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765987714&amp;x-signature=Jofl81ph00TkT7yfruU%2FF4Joe1U%3D" alt="" loading="lazy"/></p>
<p>整天重构这重构那</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f0cb62cb94945b28a52dd6a8c753840~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUG9tZWxvX-WImOmHkQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765987714&amp;x-signature=7%2F2aauWbpkFYgUlc3cL%2BsYQn6dk%3D" alt="" loading="lazy"/></p>
<p>还要 要干掉 c++ ？！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d39230df4feb43609e29d3ed746e30ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUG9tZWxvX-WImOmHkQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765987714&amp;x-signature=P%2BteFptRNIorUS7ECNNaISWzb7w%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-2">稍微了解过的：</h4>
<p>学习曲线：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d5a3e2eb19f4b54a86bc041e0255107~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUG9tZWxvX-WImOmHkQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765987714&amp;x-signature=QZ0YHpW1AqFHDs1DwOoJzPr6aZ8%3D" alt="" loading="lazy"/></p>
<p>但实际上是：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02b26ef56db8422fb822791344cfd65a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUG9tZWxvX-WImOmHkQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765987714&amp;x-signature=thEHuZ%2BuHYyoxsmmrT1bd1zJVrw%3D" alt="" loading="lazy"/></p>
<p>第一个高峰是 借用检查器，第二个是异步，第三个是unsafe，第四个是宏怎么玩？</p>
<h4 data-id="heading-3">开始接触之后</h4>
<p>编译器不让我写代码，怎么写都报错</p>
<p>写 rust 代码像是在跟 rust 编译器谈对象 ，</p>
<p>我只是传个参数，你跟我讲所有权、借用、生命周期？”</p>
<h4 data-id="heading-4">写的代码上线之后，还不错哦</h4>
<blockquote>
<ul>
<li>“别的语言项目上线流程”</li>
<li>内容：</li>
<li>编译 ✔</li>
<li>测试（偶尔挂一两条）✔</li>
<li>上线后：半夜被电话叫醒：❌</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>“Rust 项目上线流程”</li>
<li>内容：</li>
<li>编译 ❌ ❌ ❌ ❌ ❌ （三天后）</li>
<li>编译 ✔</li>
<li>测试 （偶尔挂一两条）✔</li>
<li>上线：基本没人打电话 ✅</li>
</ul>
</blockquote>
<p>由此大家可能有点感受到我想下一步想说什么了</p>
<p>以及大家可能产生了一个疑惑</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f49a2a6b0f04f3f8dcd97ad6490b13e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUG9tZWxvX-WImOmHkQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765987714&amp;x-signature=fk7vTEnoxg771EB0VrLqX3xCl%2Fc%3D" alt="" loading="lazy"/></p>
<p>Rust 真的能减少 bug 么，吹牛吧</p>
<h3 data-id="heading-5">Rust 是否能减少 bug ？</h3>
<p>Rust 最著名的承诺是<strong>内存安全（Memory Safety）和线程安全（Thread Safety）</strong> ，如果是真的，这直接消灭了两类最让大公司头疼的 Bug。</p>
<h4 data-id="heading-6">Google (Android 安全团队)</h4>
<ul>
<li>
<p>文章链接：</p>
</li>
<li>
<p>关键点</p>
<ul>
<li>  We adopted Rust for its security and are seeing <strong>a 1000x reduction in memory safety vulnerability density compared to Android’s C and C++ code</strong>. But the biggest surprise was Rust's impact on software delivery. With Rust changes having <strong>a 4x lower rollback rate</strong> and spending <strong>25% less time</strong> <strong>in</strong> <strong>code review</strong>, the safer path is now also the faster one.</li>
<li>  我们采用 Rust 是因为它安全性高，与 Android 的 C 和 C++ 代码相比，内存安全漏洞密度降低了 1000 倍。但最大的惊喜是 Rust 对软件交付的影响。Rust 的变更回滚率降低了 4 倍，代码审查时间也减少了 25% ，更安全的路径现在也更快了。</li>
<li/>
</ul>
</li>
<li>
<p>文章链接：</p>
</li>
<li>
<p><strong>关键句</strong></p>
<ul>
<li>
<p>  To date, there have been zero memory safety vulnerabilities discovered in Android’s Rust code.</p>
</li>
<li>
<p>  We don’t expect that number to stay zero forever, but given the volume of new Rust code across two Android releases, and the security-sensitive components where it’s being used, it’s a significant result. It demonstrates that Rust is fulfilling its intended purpose of preventing Android’s most common source of vulnerabilities. Historical vulnerability density is greater than 1/kLOC (1 vulnerability per thousand lines of code) in many of Android’s C/C++ components (e.g. media, Bluetooth, NFC, etc). Based on this historical vulnerability density, it’s likely that using Rust has already prevented hundreds of vulnerabilities from reaching production.</p>
</li>
<li>
<p>  迄今为止，Android 的 Rust 代码中尚未发现任何内存安全漏洞。</p>
</li>
<li>
<p>  我们并不指望这个数字永远为零，但考虑到两个 Android 版本中新增的 Rust 代码量，以及 Rust 被用于安全敏感组件，这确实是一个意义重大的结果。它表明 Rust 正在实现其预期目标，即防止 Android 最常见的漏洞来源。在 Android 的许多 C/C++ 组件（例如媒体、蓝牙、NFC 等）中，历史漏洞密度超过 1/kLOC（每千行代码一个漏洞）。基于这种历史漏洞密度，Rust 的使用很可能已经阻止了数百个漏洞进入生产环境。</p>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-7">Microsoft (MSRC)</h4>
<p>这是微软承认 C/C++ 局限性的里程碑式文章，也是“70% 漏洞论”的出处。</p>
<ul>
<li>
<p>文章链接：-</p>
</li>
<li>
<p>关键句：</p>
<ul>
<li>
<p>  roughly 70% of the security issues that the MSRC assigns a CVE to are memory safety issues. This means that if that software had been written in Rust, 70% of these security issues would most likely have been eliminated</p>
</li>
<li>
<p>  大约 70% 是内存安全问题。这意味着，如果这些软件是用 Rust 编写的，那么其中 70% 的安全问题很可能已被消除。</p>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-8">AWS</h4>
<ul>
<li>
<p>文章链接：</p>
</li>
<li>
<p>关键点</p>
<ul>
<li>
<p>   Rust uses a strict type system and ownership model to achieve compile-time verification of memory and concurrency safety, making the cost of testing and validating Rust implementations significantly lower than C/C++. Carl Lerche, a principal AWS engineer, says Rust and Tokio give AWS the ability to write services that respond fast, reliably, and that help us offer a better customer experience.</p>
</li>
<li>
<p>  Rust 使用严格的类型系统和所有权模型，实现了内存和并发安全性的编译时验证，使得 Rust 实现的测试和验证成本远低于 C/C++。AWS 首席工程师 Carl Lerche 表示，Rust 和 Tokio 让 AWS 能够编写响应迅速、可靠且有助于提供更佳客户体验的服务。</p>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-9">为什么 bug 少？</h4>
<p>Rust 的设计理念以及思路是</p>
<p>我不相信程序员能写出健壮的程序，你要想你的程序没有内存安全问题，按照我说的做。</p>
<p>结果呢，就是 将上线期才会暴露的 问题，提前到编译期就告诉你，这样写不行，会出问题。</p>
<p>那具体怎么实现的呢？</p>
<p><strong>Rust 的 3 条“约法三章”：</strong></p>
<ol>
<li>
<p>所有权 / 借用（不讲名词，只讲规则）</p>
</li>
<li>
<p>空值 / Optional 的态度</p>
</li>
<li>
<p>并发 / 数据竞争的限制</p>
</li>
</ol>
<p>约法一：谁负责资源，写死，不许糊弄</p>
<blockquote>
<p>“Rust 的第一个原则： <strong>‘每一块资源，必须有明确的唯一“负责人”。’</strong></p>
<ul>
<li>谁创建它</li>
<li>它能活多久</li>
<li>谁可以动它</li>
</ul>
<p>这些东西不是靠约定，而是编译器在帮你追踪。”</p>
</blockquote>
<p>约法二：可能失败 / 可能为空，必须写在类型上</p>
<p>从 Go / JS 角度解释 <code>Result</code> / <code>Option</code> 的思想，而不是语法。</p>
<p>你可以这样讲：</p>
<blockquote>
<p>“第二个原则： <strong>‘可能失败、可能为 null 的地方，必须在类型上写清楚，不能偷偷摸摸。’</strong></p>
<p>在 Go 里：</p>
<ul>
<li>很多函数签名是：<code>(T, error)</code></li>
<li>但我们可以选择忽略 <code>error</code>，甚至 <code>_ = xxx</code>。</li>
</ul>
<p>在 Rust 里，类似的东西会是：</p>
<ul>
<li><code>Result</code>：我可能成功也可能失败</li>
<li><code>Option</code>：我可能有值也可能没值</li>
</ul>
<p>区别在于： <strong>Rust 不太允许你装作‘它一定没问题’。</strong> <strong>你不处理，这段代码就过不了编译。</strong> ”</p>
</blockquote>
<blockquote>
<p>“Rust：你可以菜，但你不能不认真。 Go / JS：你要是想糊弄一下，我也不拦你。”</p>
</blockquote>
<p>让大家感受到： <strong>Rust 把“错误/空值”从“约定”变成了“制度”。</strong></p>
<p>约法三：并发访问数据，先说清楚怎么用</p>
<blockquote>
<p>“Rust 的并发哲学： <strong>‘要么你保证这份数据只有一个人能改，要么大家都只能看不能改。’</strong></p>
<p>编译器会在你启动线程的那一刻，就检查：</p>
<ul>
<li>你是不是把一个会被多处同时修改的东西到处乱传</li>
<li>你是不是把一个短命的数据借给了活得比它久的线程</li>
</ul>
<p>如果有这种可能性： <strong>——直接不给你编译通过。</strong></p>
</blockquote>
<h3 data-id="heading-10">Rust 性能怎么样呢？</h3>
<p>开发者根据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oschina.net%2Faction%2FGoToLink%3Furl%3Dhttps%253A%252F%252Fbenchmarksgame-team.pages.debian.net%252Fbenchmarksgame%252Findex.html" target="_blank" title="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fbenchmarksgame-team.pages.debian.net%2Fbenchmarksgame%2Findex.html" ref="nofollow noopener noreferrer">The Benchmarks Game</a> 的测试数据制作了一份可视化图表，如下所示，灰色反映的是时间效率，越短代表性能越好，棕色则是基于执行时间和内存开销的加权值。 （计算机语言基准测试游戏（以前称为计算机语言大比拼）是一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FFree_software" target="_blank" title="https://en.wikipedia.org/wiki/Free_software" ref="nofollow noopener noreferrer">自由软件项目，用于比较给定的简单</a><a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FAlgorithms" target="_blank" title="https://en.wikipedia.org/wiki/Algorithms" ref="nofollow noopener noreferrer">算法</a>子集如何在各种流行的<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FProgramming_languages" target="_blank" title="https://en.wikipedia.org/wiki/Programming_languages" ref="nofollow noopener noreferrer">编程语言</a>中实现。）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c11ef98abb9d41ce8e328359cdb300c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUG9tZWxvX-WImOmHkQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765987714&amp;x-signature=5%2BI0sPGzuvsWPup7GZGfD%2BQX2%2Fo%3D" alt="" loading="lazy"/></p>
<p>Web 框架性能对比</p>
<p>可以看到最快的10个框架中 Rust 前十占七</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cbd9f3b806d42acaa2501fd629af153~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUG9tZWxvX-WImOmHkQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765987714&amp;x-signature=dFz%2F3pAya%2B2hfa%2FPdqS1ea7UHp8%3D" alt="" loading="lazy"/></p>
<p>AWS Lambda 冷启动时间（Serverless 场景）“冷启动”就是你的程序从“沉睡”到“完全唤醒并开始工作”所需的时间。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5300c75b748c46908c92c7c6e018a1c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUG9tZWxvX-WImOmHkQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765987714&amp;x-signature=AainNr9ju2SP9EVPp77DQoWhvlo%3D" alt="" loading="lazy"/></p>
<p>还有个特殊视角：能耗：</p>
<p>跑完同一个任务需要消耗多少焦耳的电 ，这对于云原生时代（电费即成本）非常重要。</p>
<p>论文：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e20fbda1f2a247969ddbf9ebae45631f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUG9tZWxvX-WImOmHkQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765987714&amp;x-signature=60B7tQag6I8TiWdm%2FGdc72i6nuk%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-11">为什么快？</h4>
<p>没有“垃圾回收”（No Garbage Collection）—— 最关键的差异</p>
<ul>
<li>Rust 没有垃圾回收器。它通过一套独特的**所有权（Ownership）**机制，在代码编译的时候，就已经精确计算出了每一个变量应该在什么时候被销毁。相比较于 带 GC 的语言的优势就是不会出现随机的“卡顿”（Latency Spikes）。</li>
</ul>
<p>极其激进的编译器优化 (LLVM)</p>
<p>Rust 的编译器是出了名的“严格”和“慢”，但这是为了生成极致的机器码。</p>
<ul>
<li><strong>静态分析</strong>：因为 Rust 的语法规则非常严格（比如强类型、不可变性），编译器能确信代码的某些部分永远不会改变，从而进行极其大胆的优化（比如直接删除冗余代码、内联函数调用），而动态语言（如 Python/JS）不敢这么做。</li>
</ul>
<p>基于 Rust 的三大杀手锏——<strong>内存安全（不崩溃）</strong> 、<strong>极高性能（跑得快）</strong> 、<strong>无</strong> <strong>GC</strong> <strong>（不卡顿）</strong> ，导致其适合的是那些“既要高可靠性，又要极限性能”的场景。</p>
<h3 data-id="heading-12">适用场景</h3>
<p>例如 ：</p>
<ul>
<li>
<p>基础设施与底层系统：Linux Kernel 6.1 正式接纳 Rust 为第二官方语言（历史上只有 C 语言）；Windows 内核重写部分组件。</p>
</li>
<li>
<p>高并发网络服务与网关（解决“长尾延迟”）这是 Rust 正在疯狂增长的领域，主要用来解决 Go 或 Java 在超高并发下遇到的 GC 瓶颈。</p>
</li>
<li>
<p>嵌入式开发 (Embedded) &amp; IoT 在资源受限的设备</p>
</li>
<li>
<p>命令行工具 (CLI) 与开发者生态，这是普通开发者最容易感知到 Rust 威力的地方。Rust 正在重写几乎所有经典的 Linux 命令行工具。</p>
</li>
<li>
<p>WebAssembly (Wasm) 与边缘计算，Rust 是目前 WebAssembly 生态中支持最好的语言，没有之一。</p>
</li>
<li>
<p>区块链 (Blockchain &amp; Web3) Solana，Polkadot，Near Protocol，Aptos / Sui 等等</p>
</li>
<li>
<p>交易系统与量化金融 (Trading Systems &amp; HFT)：Binance 的许多核心撮合引擎和高性能网关，都在逐渐迁移到 Rust。</p>
</li>
</ul>
<p>可以看到，大部分都是 c++ 的使用场景</p>
<p>没错！，c++ 干的了的 我 Rust 干，c++ 干不了的 我 Rust 更要干，统统重构，Linus 特许，这就是 Rust</p>
<h3 data-id="heading-13">感觉有点厉害，那 Rust实际好不好用呢 ？</h3>
<p>当然除了学习难度我们县抛开不谈，在日常开发上，Rust 工具链可谓简洁实用，借鉴了 go/jRuby/Node.js 前辈的优点</p>
<ul>
<li>
<p>Cargo：公认为是当今编程界最完美的包管理器 数据来源：</p>
<ul>
<li>  在 C/C++ 时代，构建一个跨平台项目简直是灾难。Rust 的 <strong>Cargo</strong> 不仅仅是一个包管理器，它是<strong>构建系统 + 包管理 + 测试运行器 + 文档生成器</strong>的四合一。</li>
</ul>
</li>
<li>
<p>Rustfmt：代码格式化借鉴了gofmt。在团队开发中，最浪费时间的事情之一就是争论“花括号换不换行”或者“缩进用 2 个空格还是 4 个空格” Rust 官方直接提供 rustfmt。它有一套官方定义的“标准格式”。Code Review（代码审查）时，没有任何人会再评论格式问题，所有人的精力都集中在<strong>业务逻辑</strong>和<strong>架构设计</strong>上。</p>
</li>
<li>
<p>Clippy：全自动的“高级导师”与“代码守门员”（重点）Clippy 是 Rust 的官方 Linter（静态分析工具），但它比普通的 Linter 强大得多。它不仅仅是检查错误，它是在教你写“地道”的 Rust 代码（Idiomatic Rust）。Clippy 的作用就是拉平这个差距：</p>
<ul>
<li>
<p>纠正“方言”，强制“普通话”： Clippy 内置了超过 700 条 规则。它会识别出那些“能跑，但是写得很丑/很慢/很危险”的代码，并给出修改建议。</p>
</li>
<li>
<p>不仅指出问题，还自动修复： 很多时候，Clippy 可以直接通过 cargo clippy --fix 自动帮你把代码改成最优写法。</p>
</li>
</ul>
</li>
</ul>
<p>从仓库创建， 依赖拉取，格式统一，代码风格统一，代码检查，自动修复，代码测试，文档生成，crate 发布 Rust 工具链直接一条龙服务。</p>
<p>当然我其他语言用的比较少，这个可以问下会多种语言的 大佬们，实际体验是不是这样。</p>
<p>简单总结：</p>
<p>对大公司来说</p>
<ul>
<li>
<p>优点：</p>
<ul>
<li><strong>更少的服务器</strong>：因为性能高（Cloudflare 案例）。</li>
<li><strong>更少的维护</strong>：因为 Bug 少（Google 案例）。</li>
<li><strong>更好的体验</strong>：因为无卡顿（Discord 案例）。</li>
</ul>
</li>
<li>
<p>缺点：因为学习门槛高，开发人员少。招不到人</p>
</li>
</ul>
<p>对个人来说：</p>
<ul>
<li>
<p>优点：有第一梯队的 性能，有额外的安全检查，有好用的开发工具链</p>
</li>
<li>
<p>缺点： 学习门槛高，需要反复入门</p>
</li>
</ul>
<p>到这里，大家对公司来说 Rust 的优缺点应该没什么异议，</p>
<p>对个人来说的观点 可能大多数程序员不敢苟同</p>
<p>你说这个编程语言，这么厉害，有什么用啊，能让我早下班，能给我多发点工资么？</p>
<p>来看一个 2024-2025 年 不同编程语言薪资水平 数据</p>
<p>数据分析平台 DevJobsScanner 分析了来自世界各地超过 1000 万个开发职位，以帮助我们了解市场以及最热门、薪资最高的语言。在本研究中，仅关注来自<strong>美国</strong>的职位。这确保了结果更加一致和具有代表性，并显著降低了任何潜在的数据偏差</p>
<p>链接：</p>
<p>Solidity 是运行在 evm虚 拟机上的 智能合约语言</p>
<p>Clojure 是运行在 Java 虚拟机（JVM）上的现代 Lisp 方言。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b39c71e68ac4e59a208627ef413218b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUG9tZWxvX-WImOmHkQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765987714&amp;x-signature=rGz4yVCO2iwspIDMmTGJb%2FPFA4g%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6db610e973d24a30a5e24e2d7a21eb01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUG9tZWxvX-WImOmHkQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765987714&amp;x-signature=Z7XGfBVDPWLp9PG4%2F6q6CL3tuyE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25de2fb6f95c42acb6cc72cea8839f99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUG9tZWxvX-WImOmHkQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765987714&amp;x-signature=fjfLf3yUyqeuOcTjKJr%2FkLmAjI0%3D" alt="" loading="lazy"/></p>
<p>还有人说了：那你也只是现在工资高，未来呢？我好不容易学会了，Rust 不火了那不白学了</p>
<p>未来发展</p>
<p>未来什么样，谁也说不了，但是我们可以来看这样一组数据：</p>
<p>2025 年 Stackoverflow 统计的最 Admired 的编程语言（指用了还想用，用户满意度高） （ 在过去一年里使用了该语言，并且在来年还想继续使用该语言的开发者比例）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f1fe906585d48a9b8fb258506a61907~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUG9tZWxvX-WImOmHkQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765987714&amp;x-signature=6zoqi3dSi3NGuoKDf7GtOvlAwK4%3D" alt="" loading="lazy"/></p>
<p>至此 自 Rust 2015 年 5 月发布以来， 从2016-2025年 连续 10 年并持续霸榜成为用户满意度最高的语言。</p>
<p>达成了 <strong>“</strong> <strong>出道 10 年，霸榜 10 年</strong> <strong>”</strong> 的成就。</p>
<p>能否说明未来发展前景广阔</p>
<p>大家问那2015年呢？2015年是空降第三。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/454384b707414c4eac7f5f5b66d41a06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUG9tZWxvX-WImOmHkQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765987714&amp;x-signature=QjjjnWbDfCHE41htq4Nq8CjLFYw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-14">最终结论：</h3>
<p>对个人来说</p>
<p>喜欢高性能，高 安全性 -&gt; Rust!</p>
<p>提前布局未来，选有发展的 编程语言 -&gt; Rust!</p>
<p>想要多赚钱 -&gt; Rust!</p>
<p>所以，这样 狂拽炫酷吊炸天，程序猿用了都说好，并且薪资拉满的 Rust 真的不学一下么？</p>
<p>Pomelo_刘金。转载请注明原文链接。感谢！</p>
<p>不学错过未来，错过一个亿哦</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Perfetto从入门到精通】2. 使用 Perfetto 追踪/分析 APP 的 Native/Java 内存]]></title>    <link>https://juejin.cn/post/7582041304655249454</link>    <guid>https://juejin.cn/post/7582041304655249454</guid>    <pubDate>2025-12-10T16:27:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582041304655249454" data-draft-id="7582048028393226290" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Perfetto从入门到精通】2. 使用 Perfetto 追踪/分析 APP 的 Native/Java 内存"/> <meta itemprop="keywords" content="Android,性能优化,架构"/> <meta itemprop="datePublished" content="2025-12-10T16:27:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lei_official"/> <meta itemprop="url" content="https://juejin.cn/user/2351234021066314"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Perfetto从入门到精通】2. 使用 Perfetto 追踪/分析 APP 的 Native/Java 内存
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2351234021066314/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lei_official
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T16:27:50.000Z" title="Wed Dec 10 2025 16:27:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>这个世界就是这样，你从失败中学到的东西可能比成功中学到的东西更多——《Android 传奇》</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96da1c986c7f488ebbcbd5279fc0a176~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765988870&amp;x-signature=M7SiapCro%2B87iY33xT2f2937wgE%3D" alt="image.png" loading="lazy"/></p>
<p>说起 Android APP 内存分析，我们第一时间想到的，往往是 Android Studio Profiler、MAT 这样的老牌工具，而 Perfetto 的出现，又为其提供了一种更加贴近底层的视角。而且相比于现有的工具，Perfetto 更加擅长于分析 Native 内存占用，可以说是补齐了工程师在这方面的短板。</p>
<p><strong>在内存方向，我计划用2~3篇文章来介绍 Perfetto 的功能、特点、使用方法等</strong> 。作为第1篇，本文包含以下内容：</p>
<ul>
<li>Android APP 所申请的内存分类（Java、Native）</li>
<li>如何抓取、分析这两类内存占用情况，并提供对应的 Perfetto 操作实例</li>
</ul>
<h2 data-id="heading-0">APP 占用内存分类</h2>
<p>Android 系统框架是由 Linux 发展而来的，对于每一个应用程序（APP），框架为其初始分配一个进程，并启动了一个 ART 虚拟机（更早时候是 Dalvik），这个虚拟机用于解释执行 Java 字节码。因此，一个 APP 所占用的内存，可以归结为两类：在 Linux 层申请的 Native 内存，以及在 JVM 上申请的 Java 内存。</p>
<ul>
<li><strong>Native 内存</strong> ：由 C/C++/Rust 进程申请，其底层使用 <code>libc</code> 的 <code>malloc()/free()</code> 函数进行内存申请/释放。此外，APP 通过 JNI 也可申请此部分内存，例如 <code>java.util.regex.Pattern</code> 类的大部分功能，就同时申请了 Native 内存和 Java 内存。</li>
<li><strong>Java 内存</strong> ：由应用内的 Java/Kotlin 代码，通过 <code>new X()</code> 的方式申请，位于 <strong>堆</strong> 上，由系统自动进行回收。</li>
</ul>
<p>针对上述内存使用场景，Perfetto 提供了两种技术进行分析。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fgetting-started%2Fmemory-profiling%23native-c-c-rust-heap-profling" target="_blank" title="https://perfetto.dev/docs/getting-started/memory-profiling#native-c-c-rust-heap-profling" ref="nofollow noopener noreferrer">heap profiling（堆分析）</a> 适用于 Native 代码，通过 AOP，追踪 <code>malloc/free</code> 函数调用链，从而识别出每个函数引起的内存变化，集成在火焰图当中展示。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fgetting-started%2Fmemory-profiling%23java-managed-heap-dumps" target="_blank" title="https://perfetto.dev/docs/getting-started/memory-profiling#java-managed-heap-dumps" ref="nofollow noopener noreferrer">heap dump（堆转储）</a> 适用于 Java 代码，展示对象之间的引用关系，但不包含调用链。</li>
</ul>
<h2 data-id="heading-1">Native (C/C++/Rust) 内存分析</h2>
<p>在 C/C++/Rust 语言中，使用底层的 <code>malloc/free</code> 函数进行内存申请和释放，Perfetto 通过 AOP 技术，在这些函数内部注入代码进行拦截，因此能够识别每一次内存的细微变动。出于在应用性能和抓取效果之间保持平衡的考虑，还提供了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fdesign-docs%2Fheapprofd-sampling" target="_blank" title="https://perfetto.dev/docs/design-docs/heapprofd-sampling" ref="nofollow noopener noreferrer">sampling（采样）</a> 机制。</p>
<p>需要注意的是，Native 内存分析是 <strong>不可追溯</strong> 的，它只能记录从 <strong>启动 Perfetto 的时间点之后</strong> 的内存分配。这意味着，如果内存问题已经发生后，再进行 Native 内存追踪，会有无法识别引起内存问题的函数的风险（内存泄漏则不一样，因为它无时无刻不在发生）。</p>
<h3 data-id="heading-2">案例：NowInAndroid</h3>
<p>我们知道，在 Android 7.1（API 25）之前，Bitmap 对象的像素数据是使用 Dalvik heap 存储的，在拿到 heap 文件后，可以直接导出并看到图片内容。从 Android 7.1 开始，Bitmap 的存储位置从 Dalvik heap 转移到了 Native heap。这样一来，虽然可以避免大量图片资源耗尽 JVM 内存，但也容易让人忽视掉 Native 内存管理，导致 OOM 发生。</p>
<p>Perfetto 的 Native 内存分析，可以用来识别这种落在 Native heap 的内存分配调用链。我们以 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fnowinandroid" target="_blank" title="https://github.com/android/nowinandroid" ref="nofollow noopener noreferrer">NowInAndroid</a> 项目为例。</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21771e680e7a4828908a89d5d7d024f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765988870&amp;x-signature=a7PtuG5UXzJ%2F9TR37R%2Be2aK4TBs%3D" alt="nowinandroid_homepage.png" width="30%" loading="lazy"/>
<p>APP 的首页是图文元素构成的瀑布流，在频繁滑动的情况下，会产生大量 Native 内存申请/回收的现象，我们通过 Perfetto 对此进行观察。</p>
<p>在网页端开启 Memory 目录下的 Native heap profiling 开关，同时填入待分析的包名 <code>com.google.samples.apps.nowinandroid.demo.debug</code>，可以通过命令 <code>adb shell ps -A</code> 来查看进程对应的包名。</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6df13ec90a854c42abe34f51eea2c9af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765988870&amp;x-signature=9bvAT0T%2Bbm5jQQHX%2FnoGHeMdRfo%3D" alt="perfetto_native_profiling.png" width="70%" loading="lazy"/>
<p>控制台参数如下：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">buffers {
  size_kb: 65536
  fill_policy: DISCARD
}
data_sources {
  config {
    name: &amp;#34;android.heapprofd&amp;#34;
    heapprofd_config {
      sampling_interval_bytes: 4096
      process_cmdline: &amp;#34;com.google.samples.apps.nowinandroid.demo.debug&amp;#34;
      shmem_size_bytes: 8388608
      block_client: true
      all_heaps: false
    }
  }
}
duration_ms: 10000
</code></pre>
<p>接下来点击 <code>Start tracing</code> 开始抓取，在 10s 的抓取过程中，上滑页面，以加载更多图片和文字。抓取结果如下：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ede55f4c37424b06a388851b68580ba6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765988870&amp;x-signature=OpIAvRmfCu05ODIA%2FWCzEN23K8U%3D" alt="perfetto_native_profiling_result.png" width="70%" loading="lazy"/>
<p>图例比较简单，分成左上角的“<strong>数据选择</strong>”、右上角的“<strong>展示方式</strong>”和占据正中央大部分的“<strong>火焰图</strong>”，依次介绍之。</p>
<p>“<strong>数据选择</strong>”区域，共有4种排序方式，分别是：</p>
<ul>
<li><strong>Unreleased Malloc Size（未释放内存分配大小）</strong>：默认模式，按未释放内存 <code>字节数</code> 的总和聚合调用栈。</li>
<li><strong>Unreleased Malloc Count（未释放内存分配计数）</strong>：按 <code>计数</code>聚合未释放的内存分配，忽略每次分配的大小。这有助于发现小规模的内存泄漏，即每个对象都很小，但随着时间的推移，大量对象会累积起来。通常称之为 <code>内存碎片</code>。</li>
<li><strong>Total Malloc Size（总内存分配大小）</strong>：按通过 <code>malloc()</code> 分配的内存字节数聚合调用栈，无论这些内存是否已被释放。这有助于调查堆频繁调用，即即使最终释放了内存，也会对分配器造成很大压力的代码路径。通常称之为 <code>内存波动</code>。</li>
<li><strong>Total Malloc Count（总内存分配计数）</strong>：与上述类似，但按 <code>malloc()</code> 调用次数聚合，忽略每次分配的大小。</li>
</ul>
<p>我们目前选择的是默认的 <code>Unreleased Malloc Size</code> 选项。</p>
<p>“<strong>展示方式</strong>”区域，分为“自顶向下”和“自底向上”，前者的火焰向下生长，后者反之，不赘述。</p>
<p>“<strong>火焰图</strong>”区域，是性能分析的重点，通过层叠的形式展示函数调用链路，每个色块（Block）的面积表示该函数引起的内存增加，发生在相同层级的同一个函数，会被聚合展示。图中的火焰图可以看出，NowInAndroid 代码写的相对健壮，回收和复用都做得比较好，因此 RecyclerView 中未见内存泄漏。</p>
<h2 data-id="heading-3">Java 内存快照</h2>
<p>在 JVM 系语言中，通过自动回收机制管理内存，大部分 Profiling 工具都是进行内存快照，计算当前虚拟机的 <code>全部对象</code> 及其 <code>引用关系</code>，从而形成一张完整的对象图。</p>
<p><strong>Java 内存快照的不足之处是，无法通过它查看函数调用链路，即哪些函数引起了多大的内存增长。</strong></p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ea458224cbc42e28a888a8babfd9f57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765988870&amp;x-signature=nC527ATpMA2BWMeM6TOVBySqZmo%3D" alt="perfetto_java_profiling.png" width="70%" loading="lazy"/>
<p>开始抓取后，上滑页面直至完成10s的抓取，以下是抓取到的结果。</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3ca3959a6a14f1bad35506ee1e9a3b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765988870&amp;x-signature=mxHl2AIyC%2BxKFPXXUevjOkjXp5c%3D" alt="perfetto_java_profiling_result.png" width="70%" loading="lazy"/>
<p>可以看到，<code>Bitmap</code> 占据了内存的大部分。此外，String数量有 <code>96433</code> 个，也同样值得关注。</p>
<blockquote>
<p>未完待续……</p>
</blockquote>
<h2 data-id="heading-4">参考资料</h2>
<ul>
<li/>
<li/>
<li/>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔗 深度解析 SystemUI 进程间通信机制（一）]]></title>    <link>https://juejin.cn/post/7582047554090057737</link>    <guid>https://juejin.cn/post/7582047554090057737</guid>    <pubDate>2025-12-10T15:47:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582047554090057737" data-draft-id="7581752787563626536" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔗 深度解析 SystemUI 进程间通信机制（一）"/> <meta itemprop="keywords" content="Android,APP,操作系统"/> <meta itemprop="datePublished" content="2025-12-10T15:47:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="愤怒的代码"/> <meta itemprop="url" content="https://juejin.cn/user/4125023358426190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔗 深度解析 SystemUI 进程间通信机制（一）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023358426190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    愤怒的代码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T15:47:02.000Z" title="Wed Dec 10 2025 15:47:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🚀 0x00. 引言：SystemUI 的核心职责与通信必要性</h2>
<p>在 Android 的世界里，<strong>SystemUI</strong> 扮演着“系统门面”的角色。无论是顶部的<strong>状态栏</strong>（显示时间、电量、信号）、底部的<strong>导航栏</strong>（手势或按键），还是下拉的<strong>通知中心</strong>与<strong>锁屏界面</strong>，都是 SystemUI 的一部分。</p>
<p>然而，在 AOSP（Android Open Source Project）的架构中，SystemUI 并不是系统内核的一部分，而是一个运行在独立进程（<code>com.android.systemui</code>）中的<strong>应用程序</strong>。</p>
<p>这就带来了一个巨大的挑战：</p>
<p>SystemUI 只是一个 UI 展示层，但它展示的数据（如电量、通知、正在运行的任务）和执行的操作（如杀掉进程、切换应用）都掌握在系统核心进程（system_server）或桌面启动器（Launcher）手中。</p>
<p>如果把 Android 系统比作一家大公司：</p>
<ul>
<li><strong>SystemUI</strong> 是前台接待员（负责展示和简单交互）。</li>
<li><strong>Framework (system_server)</strong> 是总经理和各个职能部门（掌握核心权力和数据）。</li>
<li><strong>Launcher</strong> 是档案室管理员（管理应用列表和任务栈）。</li>
</ul>
<p>前台接待员要完成工作，就必须时刻保持与总经理和档案管理员的通话。这种“通话”机制，就是我们今天要深挖的 <strong>IPC（进程间通信）</strong> ，而在 Android 中，其基石便是 <strong>Binder</strong>。</p>
<h2 data-id="heading-1">🌉 0x01. 核心通信机制（一）：与 Launcher/Recents 的通信（多任务管理）</h2>
<h3 data-id="heading-2">背景</h3>
<p>在 Android 9.0 (Pie) 之前，“最近任务” (Recents) 界面通常由 SystemUI 自己绘制。但为了实现手势操作中“从应用平滑过渡到桌面”的动画效果，Google 工程师将 Recents 的 UI 逻辑移交给了 <strong>Launcher</strong> 进程（即 QuickStep）。</p>
<p>这就出现了一个典型的跨进程协作场景：用户在 SystemUI 的导航栏区域上滑 -&gt; SystemUI 捕获手势 -&gt; 通知 Launcher 显示 Recents 界面并跟随手指运动。</p>
<h3 data-id="heading-3">技术解析：IOverviewProxy 的桥梁作用</h3>
<p>SystemUI 和 Launcher 之间的通信主要依赖于一个名为 <code>IOverviewProxy</code> 的 AIDL 接口。</p>
<ol>
<li>
<p><strong>建立连接：</strong></p>
<ul>
<li>SystemUI 启动时，会通过 <code>OverviewProxyService</code> 监听 Launcher 服务的状态。</li>
<li>当 Launcher 启动后，它会实现 <code>IOverviewProxy</code> 接口，并将其 Binder 对象传递给 SystemUI。</li>
<li><strong>通俗理解：</strong> Launcher 上班了，把自己的“专线电话号码”告诉了 SystemUI。</li>
</ul>
</li>
<li>
<p><strong>数据流向与交互：</strong></p>
<ul>
<li><strong>手势触发：</strong> 当你在导航条上滑动时，SystemUI 的导航栏组件捕获触摸事件。</li>
<li><strong>Binder 调用：</strong> SystemUI 通过持有的 <code>IOverviewProxy</code> 代理对象，调用 Launcher 中的方法（如 <code>onOverviewShown()</code> 或 <code>onMotionDown()</code>）。</li>
<li><strong>UI 响应：</strong> Launcher 接收到指令，开始绘制 Recents 的缩略图，并根据手指位置更新动画。</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    autonumber
    %% 参与者定义
    participant SysUI as SystemUI进程&lt;br/&gt;(OverviewProxyService)
    participant BinderDriver as Binder驱动&lt;br/&gt;(Kernel)
    participant Launcher as Launcher进程&lt;br/&gt;(TouchInteractionService)

    %% --- 阶段一：建立连接 (Binding) ---
    rect rgb(240, 248, 255)
        note right of SysUI: 阶段一：建立连接 (Binding)
        SysUI-&gt;&gt;SysUI: 系统启动，初始化服务
        SysUI-&gt;&gt;BinderDriver: bindService(Intent=&amp;#34;android.intent.action.QUICKSTEP_SERVICE&amp;#34;)
        BinderDriver-&gt;&gt;Launcher: 唤醒 Launcher 进程
        Launcher-&gt;&gt;Launcher: onCreate() -&gt; onBind()
        note right of Launcher: 创建 IOverviewProxy.Stub 实体
        Launcher--&gt;&gt;BinderDriver: 返回 Binder 对象
        BinderDriver--&gt;&gt;SysUI: onServiceConnected(IBinder)
        note right of SysUI: 将 IBinder 转换为 IOverviewProxy 对象
    end

    %% --- 阶段二：双向握手 (Handshake) ---
    rect rgb(255, 250, 240)
        note right of SysUI: 阶段二：双向握手 (Handshake)
        note over SysUI, Launcher: SystemUI 也需要把自己的接口给 Launcher
        SysUI-&gt;&gt;SysUI: 创建 ISystemUiProxy (实现者)
        SysUI-&gt;&gt;Launcher: 调用 IOverviewProxy.onInitialize(ISystemUiProxy)
        Launcher-&gt;&gt;Launcher: 保存 SystemUI 的代理对象
        note right of Launcher: 至此，双方建立了双向通信通道
    end

    %% --- 阶段三：运行时通信 (Runtime IPC) ---
    rect rgb(240, 255, 240)
        note right of SysUI: 阶段三：手势交互 (Runtime)
        
        participant User as 用户手指
        User-&gt;&gt;SysUI: 在导航栏上滑 (Touch Event)
        SysUI-&gt;&gt;SysUI: InputMonitor 捕获事件
        
        note over SysUI, Launcher: 跨进程调用开始
        SysUI-&gt;&gt;BinderDriver: mOverviewProxy.onMotionDown()
        BinderDriver-&gt;&gt;Launcher: 传输数据 (Parcel)
        Launcher-&gt;&gt;Launcher: Stub.onMotionDown()
        
        Launcher-&gt;&gt;Launcher: 绘制 Recents 动画 (跟随手指)
        Launcher--&gt;&gt;User: 界面更新 (UI Feedback)
    end
</code></pre>
<h4 data-id="heading-4">A. 请求连接 (Connection)</h4>
<ul>
<li><strong>SystemUI 端</strong>：使用 <code>Context.bindService()</code> 绑定 Launcher 的<strong>Service</strong> (<code>TouchInteractionService</code>)。</li>
<li><strong>Launcher 端</strong>：在 <code>onBind()</code> 中返回 <code>mTISBinder</code>。这个 Binder 对象继承自 <code>IOverviewProxy.Stub</code>。</li>
</ul>
<p>SystemUI 端在 <code>OverviewProxyService</code> 与 Launcher 建立连接并把SystemUI的代理对象传给Launcher，其代码片段为</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-comment">// SystemUI 进程建立连接的方法</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startConnectionToCurrentUser</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (mHandler.getLooper() != Looper.myLooper()) {
        mHandler.post(mConnectionRunnable);
    } <span class="hljs-keyword">else</span> {
        internalConnectToCurrentUser();
    }
}
<span class="hljs-comment">// 实际发起连接的逻辑</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">internalConnectToCurrentUser</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">//...</span>
    <span class="hljs-comment">// 查询 Launcher 的服务Action实际上就是Launcher 进程中 Manifest中定义的</span>
    <span class="hljs-comment">// &amp;#34;android.intent.action.QUICKSTEP_SERVICE&amp;#34;</span>
    <span class="hljs-type">Intent</span> <span class="hljs-variable">launcherServiceIntent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(ACTION_QUICKSTEP)
            .setPackage(mRecentsComponentName.getPackageName());
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 1.绑定服务，SystemUI 请求服务，将获取 Launcher 中的 IOverviewProxy 代理对象</span>
        mBound = mContext.bindServiceAsUser(launcherServiceIntent,
                mOverviewServiceConnection,
                Context.BIND_AUTO_CREATE | Context.BIND_FOREGROUND_SERVICE_WHILE_AWAKE,
                UserHandle.of(getCurrentUserId()));
    } <span class="hljs-keyword">catch</span> (SecurityException e) {
        Log.e(TAG_OPS, &amp;#<span class="hljs-number">34</span>;Unable to bind because of security error&amp;#<span class="hljs-number">34</span>;, e);
    }
    <span class="hljs-comment">//...</span>
}

<span class="hljs-comment">// 服务连接监听</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ServiceConnection</span> <span class="hljs-variable">mOverviewServiceConnection</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceConnection</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onServiceConnected</span><span class="hljs-params">(ComponentName name, IBinder service)</span> {
        <span class="hljs-comment">//...</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 2. 监听连接链路的生命周期，如果服务死亡则重新发起连接</span>
            service.linkToDeath(mOverviewServiceDeathRcpt, <span class="hljs-number">0</span>);
        } <span class="hljs-keyword">catch</span> (RemoteException e) {
           <span class="hljs-comment">//...</span>
        }

        mCurrentBoundedUserId = getCurrentUserId();
        <span class="hljs-comment">// 3. 获取 Launcher 得代理对象 IOverviewProxy</span>
        mOverviewProxy = IOverviewProxy.Stub.asInterface(service);

        <span class="hljs-type">Bundle</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bundle</span>();
        <span class="hljs-comment">// 4. 把 SystemUI 的代理对象 mSysUiProxy 通过 Bundle 进行传输</span>
        params.putBinder(KEY_EXTRA_SYSUI_PROXY, mSysUiProxy.asBinder());
        params.putFloat(KEY_EXTRA_WINDOW_CORNER_RADIUS, mWindowCornerRadius);
        params.putBoolean(KEY_EXTRA_SUPPORTS_WINDOW_CORNERS, mSupportsRoundedCornersOnWindows);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 4. 建立双向通行，把 SystemUI 的代理对象 告知 Launcher</span>
            <span class="hljs-comment">// 至此 SystemUI 与 Launcher 都获得了对方的代理对象</span>
            <span class="hljs-comment">// 这是一个两个进程双向通行、保活机制的标准实现方式，实际项目中请直接照抄此模式！</span>
            mOverviewProxy.onInitialize(params);
        } <span class="hljs-keyword">catch</span> (RemoteException e) {
            mCurrentBoundedUserId = -<span class="hljs-number">1</span>;
            Log.e(TAG_OPS, &amp;#<span class="hljs-number">34</span>;Failed to call <span class="hljs-title function_">onInitialize</span><span class="hljs-params">()</span>&amp;#<span class="hljs-number">34</span>;, e);
        }
        <span class="hljs-comment">// ...</span>
    }

    <span class="hljs-comment">//... 省略代码</span>
};

</code></pre>
<p>Launcher 端在 <code>TouchInteractionService</code> 实现了<code>IOverviewProxy.Stub</code> 接口，代码片段为</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TISBinder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IOverviewProxy</span>.Stub {

        <span class="hljs-meta">@BinderThread</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onInitialize</span><span class="hljs-params">(Bundle bundle)</span> {
            <span class="hljs-comment">// 这里直接从Bundle 中获取 SystemUI 的代理对象 并转成 ISystemUiProxy</span>
            <span class="hljs-type">ISystemUiProxy</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> ISystemUiProxy.Stub.asInterface(
                    bundle.getBinder(KEY_EXTRA_SYSUI_PROXY));
               ...
            });
            sIsInitialized = <span class="hljs-literal">true</span>;
        }
        ...
</code></pre>
<h4 data-id="heading-5">B. 数据传输 (Transaction)</h4>
<p>当在 SystemUI 调用 <code>mOverviewProxy.onOverviewShown()</code> 时，底层发生了什么？</p>
<ol>
<li><strong>序列化 (Marshalling)</strong> ：SystemUI 的 IOverviewProxy 将方法 ID（如 <code>TRANSACTION_onOverviewShown</code>）和参数写入一个 <code>Parcel</code> 对象。</li>
<li><strong>陷入内核 (Kernel Trap)</strong> ：Proxy 调用 <code>transact()</code>，线程挂起，进入 Linux 内核态。</li>
<li><strong>驱动搬运</strong>：Binder 驱动找到 Launcher 进程，将数据从 SystemUI 的内存空间拷贝（映射）到 Launcher 的内存空间。</li>
<li><strong>分发 (Dispatch)</strong> ：Launcher 进程中的 Binder 线程池被唤醒，收到数据。</li>
<li><strong>执行 (Execution)</strong> ：Launcher 的 Stub 调用 <code>onTransact()</code>，解析出是哪个方法，然后调用 <code>TouchInteractionService</code> 中具体的 <code>onOverviewShown()</code> 实现逻辑。</li>
</ol>
<h4 data-id="heading-6">C. 双向通信 (Bi-directional)</h4>
<p>注意图中 <strong>阶段二</strong> 的“握手”。</p>
<ul>
<li>Launcher 不仅仅是被控制，它有时也需要控制 SystemUI（例如：在多任务界面点击“分屏”，Launcher 需要通知 SystemUI 进入分屏模式）。</li>
<li>因此，SystemUI 连接上 Launcher 后，立刻调用 <code>onInitialize(ISystemUiProxy proxy)</code>，把<strong>自己的 Binder</strong> 传给 Launcher。</li>
<li>这样，<strong>双方手中都握着对方的“遥控器”（Binder 代理对象）</strong> ，都可以给对方发送消息。</li>
</ul>
<h2 data-id="heading-7">📞 0x02. 核心通信机制（二）：与 Framework 的通信（CommandQueue）</h2>
<h3 data-id="heading-8">背景</h3>
<p>Framework 层（主要是 <code>system_server</code> 进程）包含着 Android 的大脑，如 <code>WindowManagerService</code> (WMS) 和 <code>StatusBarManagerService</code>。当系统状态发生改变时——例如电话来了需要全屏通知，或者应用请求隐藏状态栏（沉浸模式）——Framework 需要“命令” SystemUI 更新界面。</p>
<h3 data-id="heading-9">CommandQueue 深度解析</h3>
<p><strong>CommandQueue</strong> 是 SystemUI 中极其关键的一个类，它是 Framework 向 SystemUI 发号施令的“总线”。</p>
<h4 data-id="heading-10">1. 定义与原理</h4>
<ul>
<li><strong>本质：</strong> <code>CommandQueue</code> 继承自 <code>IStatusBar.Stub</code>。这意味着它本质上是一个 <strong>Binder 本地对象</strong>。</li>
<li><strong>位置：</strong> 它运行在 SystemUI 进程中。</li>
<li><strong>作用：</strong> 它是 SystemUI 在 Binder 通信中的“接收端”。</li>
</ul>
<p>在 SystemUI 端 <code>CommandQueue</code> 监听到 Framework 的通知后通过 Handler 进行分发，其代码片段为</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommandQueue</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IStatusBar</span>.Stub {
    
    <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">animateCollapsePanels</span><span class="hljs-params">(<span class="hljs-type">int</span> flags, <span class="hljs-type">boolean</span> force)</span> {
        <span class="hljs-keyword">synchronized</span> (mLock) {
            mHandler.removeMessages(MSG_COLLAPSE_PANELS);
            mHandler.obtainMessage(MSG_COLLAPSE_PANELS, flags, force ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>).sendToTarget();
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">togglePanel</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span> (mLock) {
            mHandler.removeMessages(MSG_TOGGLE_PANEL);
            mHandler.obtainMessage(MSG_TOGGLE_PANEL, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>).sendToTarget();
        }
    }
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p><code>CommandQueue</code> 作为 SystemUI 的服务端接口，那它是如何告知 Framework 中的 <code>system_server</code> 进程的呢?</p>
<p>答案是在 <code>StatusBar</code> 或者高版本的 <code>CentralSurfacesImpl</code> 的 <code>start()</code> 中，通过系统服务 <code>StatusBarService</code> 进行传递的。</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> {
    ...
    <span class="hljs-comment">// 这里通过 ServiceManager 获取到 StatusBarService 的对象</span>
    mBarService = IStatusBarService.Stub.asInterface(
          ServiceManager.getService(Context.STATUS_BAR_SERVICE));
    ...
    
    <span class="hljs-type">RegisterStatusBarResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 然后通过 registerStatusBar 方法把 CommandQueue 对象传输到</span>
        <span class="hljs-comment">// system_server 进程，这样system_server 就可以与 SystemUI 进行通信了</span>
        result = mBarService.registerStatusBar(mCommandQueue);
    } <span class="hljs-keyword">catch</span> (RemoteException ex) {
        ex.rethrowFromSystemServer();
    }

    createAndAddWindows(result);

    ...
}
</code></pre>
<h4 data-id="heading-11">2. 数据流向</h4>
<ol>
<li>
<p><strong>发送指令 (Framework)：</strong></p>
<ul>
<li>当 App 调用 <code>setSystemUiVisibility()</code> 请求全屏时，WMS 会处理该请求。</li>
<li>WMS 通过 <code>StatusBarManagerService</code> 找到 SystemUI 注册过来的 Binder 代理（即 <code>IStatusBar</code> 接口）。</li>
<li>调用 <code>bar.setSystemUiVisibility(...)</code>。</li>
</ul>
</li>
<li>
<p><strong>跨进程传输 (Binder)：</strong></p>
<ul>
<li>指令通过 Binder 驱动从 <code>system_server</code> 传输到 SystemUI 进程。</li>
</ul>
</li>
<li>
<p><strong>接收与分发 (SystemUI)：</strong></p>
<ul>
<li><code>CommandQueue</code> 接收到 Binder 调用。</li>
<li><strong>关键点：</strong> Binder 调用通常发生在 Binder 线程池中，不能直接更新 UI。因此，<code>CommandQueue</code> 内部维护了一个 <code>Handler</code>，将这些指令封装成 Message，发送到 SystemUI 的<strong>主线程 (Main Thread)</strong> 队列中排队执行。</li>
<li>最终，SystemUI 的各个组件（如 <code>StatusBar</code> 类）通过回调接口（<code>Callbacks</code>）响应这些变化，更新图标或隐藏导航栏。</li>
</ul>
</li>
</ol>
<p>它们三者的关系时序图为</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    autonumber

    participant SysUI as SystemUI进程&lt;br/&gt;(CommandQueue)
    participant SBMS as SystemServer&lt;br/&gt;(StatusBarManagerService)
    participant BinderDriver as Binder驱动/ServiceManager

    Note over SysUI: SystemUI 进程启动
    
    %% --- 阶段一：CommandQueue 对象创建与初始化 ---
    SysUI-&gt;&gt;SysUI: 创建 CommandQueue 实例
    Note right of SysUI: CommandQueue 继承 IStatusBar.Stub&lt;br/&gt;(SystemUI 的 Binder 实体)
    
    %% --- 阶段二：向 SystemServer 注册服务 ---
    Note over SysUI, SBMS: SystemUI 将自身 Stub 对象注册到 Framework
    
    SysUI-&gt;&gt;SBMS: getSystemService(STATUS_BAR_SERVICE)&lt;br/&gt;(获取 SBMS 代理)
    
    SysUI-&gt;&gt;SBMS: registerStatusBar(IStatusBar.Stub)
    
    %% 3. Binder 传输
    Note right of SBMS: SBMS 接收 Stub 对象&lt;br/&gt;并转换为 IStatusBar 代理
    
    SBMS-&gt;&gt;SBMS: 保存 IStatusBar 代理引用 (mCallbacks)
    
    Note over SBMS, SysUI: 连接建立完成：&lt;br/&gt;SystemServer 现持有 SystemUI 的“遥控器”
    
    %% --- 阶段三：后续指令准备就绪 ---
    SBMS-&gt;&gt;SysUI: (连接确认，但无返回值)
    
    loop 后续指令发送
        SBMS-&gt;&gt;SysUI: IStatusBar.disable(StateFlags)&lt;br/&gt;(通过代理对象调用)
        SysUI-&gt;&gt;SysUI: CommandQueue 接收并处理指令
    end
</code></pre>
<h3 data-id="heading-12">应用实例：沉浸模式</h3>
<p>当你在看视频时，App 请求隐藏状态栏：</p>
<ol>
<li><strong>App</strong> -&gt; <code>View.setSystemUiVisibility(SYSTEM_UI_FLAG_FULLSCREEN)</code></li>
<li><strong>WMS</strong> (Framework) 计算出新的标志位。</li>
<li><strong>Binder</strong> 调用 <code>IStatusBar.setSystemUiVisibility</code>。</li>
<li><strong>SystemUI</strong> 的 <code>CommandQueue</code> 收到调用 -&gt; 切回主线程 -&gt; 通知状态栏 View 播放淡出动画。</li>
</ol>
<p><strong>总结：</strong><br/>
本文讲解 SystemUI 中两种比较常见的 Binder 的业务：</p>
<ul>
<li>与系统层 Framework 通信（CommandQueue机制）</li>
<li>与App层 Launcher 通信（双向通信）</li>
</ul>
<p>掌握 SystemUI 的 IPC 机制，是理解 Android 系统交互逻辑的钥匙，也是进行深度系统定制的必经之路。希望本文能为您揭开这层神秘的面纱。<br/>
下一篇将剖析更为复杂精妙的<strong>全面屏手势导航</strong>的机制，这里不仅有进程间通信还有各种事件的在不同应用的分发传递与协调。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SDWebImage深度解析：高效图片加载背后的架构设计与卓越实践]]></title>    <link>https://juejin.cn/post/7582067084840304694</link>    <guid>https://juejin.cn/post/7582067084840304694</guid>    <pubDate>2025-12-10T15:48:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582067084840304694" data-draft-id="7582047623739080758" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SDWebImage深度解析：高效图片加载背后的架构设计与卓越实践"/> <meta itemprop="keywords" content="iOS,图片资源"/> <meta itemprop="datePublished" content="2025-12-10T15:48:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sweet丶"/> <meta itemprop="url" content="https://juejin.cn/user/3227821869921646"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SDWebImage深度解析：高效图片加载背后的架构设计与卓越实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821869921646/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sweet丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T15:48:23.000Z" title="Wed Dec 10 2025 15:48:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在移动应用开发中，图片加载和缓存是影响用户体验的关键环节。SDWebImage作为iOS平台上最受欢迎的图片加载库，以其高性能、丰富的功能和稳定的表现赢得了全球开发者的信赖。本文将深入探讨SDWebImage的核心原理、架构设计，并解答实际使用中的常见问题。</p>
</blockquote>
<h3 data-id="heading-0">一、整体架构设计：模块化与职责分离</h3>
<p>为了让你能迅速抓住核心，我们先用一张图，从宏观视角看懂它的工作原理与核心流程。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f7b2aecc97b438bb945a3b1fbefc46a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dlZXTkuLY=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765986502&amp;x-signature=KCbOGYB5Ijkfa77oKQtmhsD9WWY%3D" alt="deepseek_mermaid_20251210_9277be.png" loading="lazy"/></p>
<p>SDWebImage采用了清晰的分层架构设计，将复杂的图片加载过程分解为独立的模块，各司其职：</p>
<p><strong>1. 核心协调者：SDWebImageManager</strong></p>
<p>这是SDWebImage的"大脑"，负责协调缓存查找、下载和图片处理流程。它使用组合模式将<code>SDImageCache</code>和<code>SDWebImageDownloader</code>组合在一起，实现了对图片加载全生命周期的管理。</p>
<p><strong>2. 缓存模块：SDImageCache</strong>
负责内存和磁盘缓存的双层存储。内存缓存基于NSCache实现，提供快速访问；磁盘缓存将图片持久化存储到文件系统中，支持自定义缓存策略。</p>
<p><strong>3. 下载模块：SDWebImageDownloader</strong>
基于NSURLSession构建的异步下载器，支持并发控制、请求优先级设置和身份验证等高级功能。它通过操作队列管理下载任务，确保高效利用网络资源。</p>
<p><strong>4. 解码与处理模块</strong>
负责图片解码、缩放、裁剪等后处理操作。SDWebImage在后台线程执行这些操作，避免阻塞主线程。</p>
<p><strong>5. 视图扩展：UIImageView+WebCache</strong>
为UIKit组件提供的便捷接口，开发者可以通过一行代码实现图片的异步加载和缓存管理。</p>
<p>这种模块化设计不仅使代码结构清晰，还提高了库的可扩展性和可维护性。</p>
<h3 data-id="heading-1">二、图片解码机制：后台线程的高效处理</h3>
<p>iOS系统在渲染图片时需要将其解码为位图格式，这个过程默认在主线程进行，可能导致界面卡顿。SDWebImage对此进行了重要优化：</p>
<p><strong>解码时机与线程策略</strong>
SDWebImage在图片从磁盘加载或网络下载完成后，立即在后台线程进行解码。解码器使用专门的<code>NSOperationQueue</code>，避免了解码任务阻塞主线程。</p>
<p><strong>空间换时间的缓存策略</strong>
解码后的位图数据会被缓存到内存中。当同一图片再次请求时，可以直接使用缓存的解码结果，无需重复解码，显著提升了性能。</p>
<p><strong>渐进式解码支持</strong>
对于网络下载的大图片，SDWebImage支持渐进式解码。图片在下载过程中逐步显示，用户可以更快地看到图片内容，提升等待体验。</p>
<h3 data-id="heading-2">三、缓存机制：智能的双层存储系统</h3>
<p>SDWebImage的缓存系统是其高性能的核心保障：</p>
<p><strong>1. 内存缓存（Memory Cache）</strong>
基于NSCache实现，具有自动清理机制。当系统内存紧张时，NSCache会自动释放部分缓存。默认情况下，SDWebImage不限制内存缓存大小，但支持通过<code>totalCostLimit</code>和<code>countLimit</code>进行自定义限制。</p>
<p><strong>2. 磁盘缓存（Disk Cache）</strong>
图片以文件形式存储在Cache目录中，文件名经过MD5哈希处理，确保唯一性和安全性。</p>
<p><strong>3. 默认最大缓存大小</strong>
SDWebImage默认的磁盘缓存大小为<strong>100MB</strong>。当缓存超过此限制时，SDWebImage会基于文件的最后访问时间进行清理，优先移除最久未访问的图片。这一设置可以在<code>SDImageCacheConfig</code>中自定义。</p>
<h3 data-id="heading-3">四、缓存清理机制：灵活的资源管理</h3>
<p>SDWebImage提供了多种缓存清理方式，满足不同场景的需求：</p>
<p><strong>1. 自动清理机制</strong></p>
<ul>
<li><strong>基于时间的清理</strong>：默认配置下，SDWebImage会自动清理超过一周的缓存文件</li>
<li><strong>基于大小的清理</strong>：当缓存超过设定的大小时，自动清理最旧的图片文件</li>
</ul>
<p><strong>2. 手动清理接口</strong></p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 清理所有内存缓存</span>
[[SDImageCache sharedImageCache] clearMemory];

<span class="hljs-comment">// 清理所有磁盘缓存（异步）</span>
[[SDImageCache sharedImageCache] clearDiskOnCompletion:<span class="hljs-literal">nil</span>];

<span class="hljs-comment">// 清理过期的磁盘缓存（异步）</span>
[[SDImageCache sharedImageCache] deleteOldFilesWithCompletionBlock:<span class="hljs-literal">nil</span>];
</code></pre>
<p><strong>3. 细粒度控制</strong>
开发者可以针对特定URL或key清理缓存，实现更精准的缓存管理。</p>
<h3 data-id="heading-4">五、动态图支持：从GIF到现代动画格式</h3>
<p>SDWebImage对动态图的支持经历了显著的演进：</p>
<p><strong>早期方案</strong>
早期版本通过将GIF分解为帧序列，使用UIImage的动画API播放，这种方式内存占用高且功能有限。</p>
<p><strong>现代方案：SDAnimatedImage协议</strong>
从SDWebImage 5.0开始，引入了<code>SDAnimatedImage</code>协议，提供了统一的动画图片接口，支持多种格式：</p>
<ul>
<li>GIF：完整的解码和播放支持</li>
<li>APNG：Apple原生支持的动画格式</li>
<li>WebP：Google的高效图片格式（需要额外编码器）</li>
<li>HEIC：高效的现代图片格式</li>
</ul>
<p><strong>内存优化</strong>
<code>SDAnimatedImageView</code>采用惰性解码策略，仅解码当前显示和预加载的帧，大幅降低了内存占用。开发者还可以通过<code>maxBufferSize</code>属性控制缓冲帧数，在流畅度和内存消耗之间找到平衡。</p>
<h3 data-id="heading-5">六、视图可见性触发加载：按需加载的智能策略</h3>
<p>在列表等场景中，实现"视图出现在屏幕才开始加载图片"是提升性能的关键。SDWebImage与UIKit的协同工作实现了这一目标：</p>
<p><strong>UITableView/UICollectionView的优化加载</strong></p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 在cellForRowAtIndexPath中设置图片</span>
- (<span class="hljs-built_in">UITableViewCell</span> *)tableView:(<span class="hljs-built_in">UITableView</span> *)tableView 
         cellForRowAtIndexPath:(<span class="hljs-built_in">NSIndexPath</span> *)indexPath {
    <span class="hljs-built_in">UITableViewCell</span> *cell = [tableView dequeueReusableCellWithIdentifier:@&amp;#<span class="hljs-number">34</span>;Cell&amp;#<span class="hljs-number">34</span>;];
    
    <span class="hljs-comment">// 获取图片URL</span>
    <span class="hljs-built_in">NSURL</span> *imageURL = [<span class="hljs-keyword">self</span> imageURLForIndexPath:indexPath];
    
    <span class="hljs-comment">// 使用SDWebImage加载图片</span>
    [cell.imageView sd_setImageWithURL:imageURL
                      placeholderImage:[<span class="hljs-built_in">UIImage</span> imageNamed:@&amp;#<span class="hljs-number">34</span>;placeholder&amp;#<span class="hljs-number">34</span>;]
                             completed:^(<span class="hljs-built_in">UIImage</span> *image, <span class="hljs-built_in">NSError</span> *error, SDImageCacheType cacheType, <span class="hljs-built_in">NSURL</span> *imageURL) {
        <span class="hljs-comment">// 加载完成处理</span>
    }];
    
    <span class="hljs-keyword">return</span> cell;
}

<span class="hljs-comment">// 在prepareForReuse中取消未完成的加载</span>
- (<span class="hljs-type">void</span>)prepareForReuse {
    [<span class="hljs-variable language_">super</span> prepareForReuse];
    [<span class="hljs-keyword">self</span>.imageView sd_cancelCurrentImageLoad];
}
</code></pre>
<p><strong>工作原理</strong></p>
<ol>
<li>当cell准备显示时，<code>tableView:cellForRowAtIndexPath:</code>被调用，开始图片加载</li>
<li>如果cell滚出屏幕，<code>prepareForReuse</code>会被调用，取消未完成的图片加载</li>
<li>SDWebImage内部会管理加载队列，优先处理可见cell的请求</li>
</ol>
<p><strong>高级优化技巧</strong></p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 1. 预加载：提前加载即将显示的图片</span>
- (<span class="hljs-type">void</span>)tableView:(<span class="hljs-built_in">UITableView</span> *)tableView 
  willDisplayCell:(<span class="hljs-built_in">UITableViewCell</span> *)cell 
forRowAtIndexPath:(<span class="hljs-built_in">NSIndexPath</span> *)indexPath {
    <span class="hljs-comment">// 预加载下一批图片</span>
    <span class="hljs-keyword">if</span> (indexPath.row + <span class="hljs-number">5</span> &lt; [<span class="hljs-keyword">self</span>.dataSource count]) {
        <span class="hljs-built_in">NSURL</span> *preloadURL = [<span class="hljs-keyword">self</span> imageURLForIndexPath:[<span class="hljs-built_in">NSIndexPath</span> indexPathForRow:indexPath.row + <span class="hljs-number">5</span> inSection:indexPath.section]];
        [[SDWebImagePrefetcher sharedImagePrefetcher] prefetchURLs:@[preloadURL]];
    }
}

<span class="hljs-comment">// 2. 设置不同的加载优先级</span>
SDWebImageOptions options = SDWebImageLowPriority | SDWebImageProgressiveLoad;
[cell.imageView sd_setImageWithURL:imageURL placeholderImage:<span class="hljs-literal">nil</span> options:options];
</code></pre>
<h3 data-id="heading-6">七、静态图与动态图的选择策略</h3>
<p>在实际开发中，我们经常面临选择：使用<code>UIImageView</code>还是<code>SDAnimatedImageView</code>？以下是明确的指导原则：</p>
<p><strong>1. 静态图片场景</strong></p>
<ul>
<li>使用标准的<code>UIImageView</code></li>
<li>通过<code>sd_setImageWithURL:</code>方法加载</li>
<li>性能最佳，内存占用最低</li>
</ul>
<p><strong>2. 动态图片场景</strong></p>
<ul>
<li>使用<code>SDAnimatedImageView</code></li>
<li>通过<code>sd_setImageWithURL:</code>方法加载（SDWebImage会自动检测图片类型）</li>
<li>支持GIF、APNG、WebP等多种动态格式</li>
</ul>
<p><strong>3. 未知图片类型的处理策略</strong>
当不确定图片是静态还是动态时，推荐采用以下方案：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 方案1：统一使用SDAnimatedImageView（推荐）</span>
<span class="hljs-comment">// 优点：自动适应所有图片类型，代码简洁</span>
<span class="hljs-comment">// 缺点：对静态图有轻微性能开销</span>
SDAnimatedImageView *imageView = [SDAnimatedImageView new];
[imageView sd_setImageWithURL:imageURL];

<span class="hljs-comment">// 方案2：根据URL或响应头动态选择</span>
<span class="hljs-comment">// 在知道图片类型的情况下优化性能</span>
<span class="hljs-keyword">if</span> ([url.pathExtension isEqualToString:@&amp;#<span class="hljs-number">34</span>;gif&amp;#<span class="hljs-number">34</span>;] || 
    [url.absoluteString containsString:@&amp;#<span class="hljs-number">34</span>;animated&amp;#<span class="hljs-number">34</span>;]) {
    <span class="hljs-comment">// 使用SDAnimatedImageView</span>
    SDAnimatedImageView *animatedImageView = [SDAnimatedImageView new];
    [animatedImageView sd_setImageWithURL:url];
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 使用普通UIImageView</span>
    <span class="hljs-built_in">UIImageView</span> *staticImageView = [<span class="hljs-built_in">UIImageView</span> new];
    [staticImageView sd_setImageWithURL:url];
}

<span class="hljs-comment">// 方案3：使用SDWebImage的自动检测功能</span>
<span class="hljs-comment">// SDWebImage 5.0+ 可以自动检测图片类型并选择合适的视图</span>
<span class="hljs-built_in">UIImageView</span> *imageView = [<span class="hljs-built_in">UIImageView</span> new];
SDWebImageOptions options = SDWebImageAutoHandleAnimatedImage;
[imageView sd_setImageWithURL:url options:options];
</code></pre>
<p><strong>性能对比与建议</strong></p>








































<table><thead><tr><th>场景</th><th>推荐视图</th><th>内存占用</th><th>CPU使用</th><th>兼容性</th></tr></thead><tbody><tr><td>已知静态图</td><td>UIImageView</td><td>低</td><td>低</td><td>最佳</td></tr><tr><td>已知动态图</td><td>SDAnimatedImageView</td><td>中等</td><td>中等</td><td>最佳</td></tr><tr><td>未知类型</td><td>SDAnimatedImageView</td><td>中等</td><td>中等</td><td>最佳</td></tr><tr><td>大量静态图列表</td><td>UIImageView</td><td>低</td><td>低</td><td>最佳</td></tr></tbody></table>
<p><strong>最佳实践建议</strong></p>
<ol>
<li>对于图片社交应用（如Instagram），用户上传内容类型未知，建议统一使用<code>SDAnimatedImageView</code></li>
<li>对于电商应用，商品主图大多是静态图，使用<code>UIImageView</code>即可</li>
<li>在性能敏感的场景（如大规模图片列表），可以考虑先获取图片元信息再决定视图类型</li>
</ol>
<h3 data-id="heading-7">八、高级功能与定制扩展</h3>
<p><strong>自定义缓存策略</strong></p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 创建自定义缓存配置</span>
SDImageCacheConfig *config = [SDImageCacheConfig defaultCacheConfig];
config.maxDiskAge = <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span>; <span class="hljs-comment">// 一周</span>
config.maxDiskSize = <span class="hljs-number">200</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>; <span class="hljs-comment">// 200MB</span>
config.maxMemoryCost = <span class="hljs-number">100</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>; <span class="hljs-comment">// 100MB内存缓存</span>
config.diskCacheExpireType = SDImageCacheConfigExpireTypeAccessDate; <span class="hljs-comment">// 按访问时间过期</span>

<span class="hljs-comment">// 创建自定义缓存实例</span>
SDImageCache *customCache = [[SDImageCache alloc] initWithNamespace:@&amp;#<span class="hljs-number">34</span>;Custom&amp;#<span class="hljs-number">34</span>; diskCacheDirectory:customPath config:config];
</code></pre>
<p><strong>图片转换器</strong></p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 创建圆角图片转换器</span>
SDImageRoundCornerTransformer *transformer = [SDImageRoundCornerTransformer transformerWithRadius:<span class="hljs-number">10</span> corners:<span class="hljs-built_in">UIRectCornerAllCorners</span> borderWidth:<span class="hljs-number">1</span> borderColor:[<span class="hljs-built_in">UIColor</span> whiteColor]];

<span class="hljs-comment">// 加载时应用转换器</span>
[imageView sd_setImageWithURL:url placeholderImage:<span class="hljs-literal">nil</span> options:<span class="hljs-number">0</span> context:@{SDWebImageContextImageTransformer: transformer}];
</code></pre>
<h3 data-id="heading-8">九、性能监控与调试</h3>
<p><strong>内存使用监控</strong></p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 获取缓存统计信息</span>
<span class="hljs-built_in">NSUInteger</span> memCost = [[SDImageCache sharedImageCache] totalMemoryCost];
<span class="hljs-built_in">NSUInteger</span> diskCount = [[SDImageCache sharedImageCache] totalDiskCount];
<span class="hljs-built_in">NSUInteger</span> diskSize = [[SDImageCache sharedImageCache] totalDiskSize];

<span class="hljs-comment">// 监控图片加载性能</span>
[SDWebImageManager.sharedManager setCacheKeyFilter:^<span class="hljs-built_in">NSString</span> * _Nullable(<span class="hljs-built_in">NSURL</span> * _Nullable url) {
    <span class="hljs-comment">// 记录加载时间</span>
    <span class="hljs-built_in">CFTimeInterval</span> startTime = <span class="hljs-built_in">CACurrentMediaTime</span>();
    <span class="hljs-keyword">return</span> [url absoluteString];
}];
</code></pre>
<h3 data-id="heading-9">十、总结与展望</h3>
<p>SDWebImage通过其精良的架构设计，在图片加载的各个关键环节都做了深度优化。从后台解码到智能缓存，从动态图支持到可见性触发加载，每一个设计决策都体现了对性能与用户体验的极致追求。</p>
<p>随着iOS开发技术的演进，SDWebImage也在不断发展。未来，我们期待看到：</p>
<ol>
<li>对Swift Concurrency的更好支持</li>
<li>与SwiftUI的更深度集成</li>
<li>对新型图片格式的更快适配</li>
<li>更智能的缓存预取和淘汰算法</li>
</ol>
<p>无论你是刚刚接触SDWebImage的新手，还是希望深入优化图片加载性能的资深开发者，理解SDWebImage的核心原理都将帮助你构建更流畅、更高效的iOS应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型量化部署终极指南:让700亿参数的AI跑进你的显卡]]></title>    <link>https://juejin.cn/post/7582073642868555791</link>    <guid>https://juejin.cn/post/7582073642868555791</guid>    <pubDate>2025-12-10T15:59:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582073642868555791" data-draft-id="7582073642868539407" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型量化部署终极指南:让700亿参数的AI跑进你的显卡 "/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-10T15:59:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吴佳浩"/> <meta itemprop="url" content="https://juejin.cn/user/2696441245481975"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型量化部署终极指南:让700亿参数的AI跑进你的显卡 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2696441245481975/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吴佳浩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T15:59:55.000Z" title="Wed Dec 10 2025 15:59:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial;color:#00325e}.markdown-body ::selection{background-color:#00325e;color:#fff}.markdown-body blockquote{padding:10px 20px;background-color:#fffaf0;box-shadow:0 3px 10px 0 rgba(255,172,194,.24);border:1px solid #f3ca8e;transition:all .2s;margin:1em 0;border-radius:5px}.markdown-body blockquote p{font-size:14px;line-height:25px;color:#795548}.markdown-body blockquote p:last-child{margin:0}.markdown-body blockquote:hover{border-color:#ff9800;background-color:#fff8e0;box-shadow:0 6px 10px -5px rgba(225,173,98,.3803921569)}.markdown-body blockquote code{color:#ff502c}.markdown-body pre{border:1px solid #8cc0f3;box-shadow:0 3px 10px 0 rgba(255,198,198,.28);border-radius:5px;transition:all .2s;overflow-x:auto;white-space:pre-wrap}.markdown-body pre:hover{border-color:#6d9dce}.markdown-body pre&gt;code{padding:10px 20px;color:#00325e;background:#f0f8ff;font-size:12px;line-height:1.6;display:block}.markdown-body code{background:#f6fbff;color:#0b5393;padding:2px 4px;border-radius:4px;font-size:12px}.markdown-body p{font-size:14px;line-height:28px;text-align:justify;margin-bottom:17px;color:#595959}.markdown-body a{color:#00325e;text-decoration:none}.markdown-body a:after{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAQdJREFUKFNt0DtLA0EUBeBzZle0Eks7rcUfEfBRCha7NorYa6NmVJzgyi4smUgKtdZGCJktLMVH4Y8QeztLWyE7VyLEuNFbXj4Oh0P8c8mZm+uJrEN4BJFTeP/MUVe3bnocfALwkOlo1zS7iZAzf6Cx7oXgbaqjxiDEWCcVaGyxQ8pSWo9XhqhoQ/xUFbaKjhe5V+CmR7mnSplEEF6GSmJ+F/d0KHvbCIIJCLc85U6BC5mONgbJNM3uFag++sX7z8O8MzsWBucifMx0dDGE1kmm458KDVukAlnNdDz/exEeW3dNkbfsYC0xtmgDWP6ELLZ0/F6BJu/UoFQN5AkoeUjeJPvx6+i+X5Sjah4tA6gYAAAAAElFTkSuQmCC);margin-left:2px}.markdown-body a:hover{box-shadow:0 1px}.markdown-body table{max-width:100%;border-collapse:collapse;border-spacing:0;box-shadow:0 3px 10px 0 rgba(255,238,172,.24);transition:all .2s}.markdown-body table:hover{box-shadow:0 3px 10px 0 rgba(185,169,103,.24)}.markdown-body table tr th{border:1px solid #8cc0f3;background-color:#f0f8ff;padding:12px 15px}.markdown-body table tr td{border:1px solid rgba(243,202,142,.4);padding:12px 15px}.markdown-body table tbody tr{transition:all .2s}.markdown-body table tbody tr:hover td{border-color:#f3ca8e;background-color:#fff8e0;z-index:1}.markdown-body img{max-width:100%}.markdown-body h1{font-size:20px;margin-top:30px;margin-bottom:10px;padding-left:30px;position:relative}.markdown-body h1&gt;code{font-size:20px}.markdown-body h1:before{content:"🍺";display:block;font-size:18px;width:18px;height:18px;left:0;position:absolute}.markdown-body h2{font-size:18px;margin-top:30px;margin-bottom:10px;padding-left:28px;position:relative}.markdown-body h2&gt;code{font-size:18px}.markdown-body h2:before{content:"🍻";display:block;font-size:16px;width:16px;height:16px;left:0;position:absolute}.markdown-body h3{font-size:16px;margin-top:30px;margin-bottom:10px;padding-left:26px;position:relative}.markdown-body h3&gt;code{font-size:16px}.markdown-body h3:before{content:"🥂";display:block;font-size:14px;width:14px;height:14px;left:0;position:absolute}.markdown-body h4{font-size:14px;margin-top:30px;margin-bottom:10px;padding-left:24px;position:relative}.markdown-body h4&gt;code{font-size:14px}.markdown-body h4:before{content:"🥃";display:block;font-size:12px;width:12px;height:12px;left:0;position:absolute}.markdown-body h5{font-size:12px;margin-top:30px;margin-bottom:10px}.markdown-body h5&gt;code{font-size:12px}.markdown-body h6{font-size:10px;margin-top:30px;margin-bottom:10px}.markdown-body h6&gt;code{font-size:10px}.markdown-body h1,.markdown-body h2{color:#ff502c}.markdown-body hr{height:4px;border:none;margin-top:32px;margin-bottom:32px;background-size:4px 1px;background-image:linear-gradient(270deg,#6d9dce,#8cc0f3 25%,transparent 50%)}.markdown-body hr:nth-child(2n){background-image:linear-gradient(270deg,#ff9800,#fff8e0 25%,transparent 50%)}.markdown-body ul{padding-inline-start:20px}.markdown-body ul li{list-style-type:"🔸"}.markdown-body ul li li{list-style-type:"◻️"}.markdown-body ul li li li{list-style-type:"▫️"}.markdown-body ol{padding-inline-start:20px}.markdown-body ol ::marker{color:#ff9800}.markdown-body ol,.markdown-body ul{line-height:2em}.markdown-body li{padding-inline-start:1ch}.markdown-body li.task-list-item{list-style:none;padding-inline-start:0}.markdown-body li input{padding-right:2px}.markdown-body li input[type=checkbox i]{appearance:none}.markdown-body li input:before{content:"🟩";display:block;width:13px;height:13px}.markdown-body li input:checked:before{content:"✅"}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">大模型量化部署终极指南:让700亿参数的AI跑进你的显卡</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e53064d7b28447568f9ce11ce5ee2bec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC05L2z5rWp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765987195&amp;x-signature=95wlmXDLbrjvKRrRE1mJMKj01BY%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p><strong>核心问题</strong>:一个70B(700亿参数)的大模型原本需要140GB显存,怎么塞进24GB的显卡? <strong>答案</strong>:量化 —— AI界的"压缩包技术"</p>
</blockquote>
<p>想象一下,你有一本精美的4K画册,但手机存储不够。你有三个选择:</p>
<ul>
<li>转成JPG(有损但能用)→ 这就是<strong>GGUF</strong></li>
<li>只保留关键色块(智能压缩)→ 这就是<strong>AWQ</strong></li>
<li>用专业工具批量转换(通用方案)→ 这就是<strong>GPTQ</strong></li>
</ul>
<hr/>
<h3 data-id="heading-1">第一部分:量化的三大门派(必须搞懂的分类逻辑)</h3>
<pre><code class="hljs">量化分类
静态量化
GGUF/GPTQ/AWQ
动态量化
BitsAndBytes
混合精度
FP16/BF16/FP8
</code></pre>
<h4 data-id="heading-2">门派A:预制菜派 —— 模型文件级量化</h4>
<p><strong>核心理念</strong>:"出厂前就压缩好,拿来即用"</p>
<p>就像买速冻水饺,厂家已经帮你包好、冻好,回家直接下锅。</p>
<p><strong>代表选手</strong>:</p>
<ul>
<li><strong>GGUF</strong> → 全平台通吃的"万金油"</li>
<li><strong>GPTQ</strong> → GPU老司机的最爱</li>
<li><strong>AWQ</strong> → 激活感知的"精准狙击手"</li>
</ul>
<p><strong>适用场景</strong>: ✅ 生产环境部署 ✅ 显存吃紧 ✅ 追求极致性能</p>
<hr/>
<h4 data-id="heading-3">⚡ 门派B:现炒现卖派 —— 动态量化</h4>
<p><strong>核心理念</strong>:"原材料是完整的,加载时现场压缩"</p>
<p>像去餐厅点菜,厨师拿到新鲜食材后现场处理。</p>
<p><strong>代表选手</strong>:</p>
<ul>
<li><strong>BitsAndBytes</strong> (4bit/8bit)</li>
<li><strong>Transformers量化配置</strong></li>
</ul>
<p><strong>适用场景</strong>: ✅ 快速实验 ✅ 调试模型 ✅ 不想折腾转换</p>
<p><strong>三行代码搞定</strong>:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">model</span> = AutoModelForCausalLM.from_pretrained(
    &amp;<span class="hljs-comment">#34;Qwen/Qwen-7B&amp;#34;,</span>
    <span class="hljs-attr">load_in_4bit</span>=<span class="hljs-literal">True</span>  <span class="hljs-comment"># 就这么简单!</span>
)
</code></pre>
<hr/>
<h4 data-id="heading-4">💎 门派C:精度派 —— 硬件原生压缩</h4>
<p><strong>核心理念</strong>:"不是真量化,只是换了个'容器'"</p>
<p>像把水从玻璃瓶倒进塑料瓶,容量不变但更轻便。</p>
<p><strong>代表选手</strong>:</p>
<ul>
<li><strong>FP16/BF16</strong>(半精度)</li>
<li><strong>TensorRT FP8</strong>(企业级)</li>
</ul>
<p><strong>适用场景</strong>: ✅ 土豪显卡(A100/H100) ✅ 追求极致精度 ✅ 企业级部署</p>
<hr/>
<h3 data-id="heading-5">第二部分:三大天王详解(你绕不开的主流方案)</h3>
<h4 data-id="heading-6">GGUF:平民之王,能在任何设备上跑AI</h4>
<p><strong>为什么它这么火?</strong></p>
<p>想象你有个游戏,能在Switch、PS5、电脑上无缝运行 —— GGUF就是LLM界的"跨平台神器"。</p>
<p><strong>硬核优势</strong>:</p>
<ul>
<li>✅ CPU跑AI?可以! (虽然慢但能跑)</li>
<li>✅ Mac M芯片?完美适配!</li>
<li>✅ GTX 1060老显卡?照样能用!</li>
<li>✅ 文件体积最小(7B模型只需3-4GB)</li>
</ul>
<p><strong>适配表</strong>(越多星越好):</p>






























<table><thead><tr><th>设备类型</th><th>推荐度</th><th>备注</th></tr></thead><tbody><tr><td>CPU(Intel/AMD)</td><td>⭐⭐⭐⭐⭐</td><td>速度慢但稳定</td></tr><tr><td>Mac M1/M2/M3</td><td>⭐⭐⭐⭐⭐</td><td>金属加速,体验丝滑</td></tr><tr><td>老显卡(GTX系列)</td><td>⭐⭐⭐⭐</td><td>量化版救星</td></tr><tr><td>RTX 30/40系列</td><td>⭐⭐⭐</td><td>能用但不是最优解</td></tr></tbody></table>
<p><strong>真实案例</strong>:</p>
<blockquote>
<p>"我用MacBook M2跑33B模型(330亿参数,Q4量化),输出速度5 tokens/s,写代码够用了!" —— 某独立开发者</p>
</blockquote>
<hr/>
<h4 data-id="heading-7">GPTQ:最成熟的GPU量化方案</h4>
<p><strong>为什么选它?</strong></p>
<p>如果GGUF是"瑞士军刀",GPTQ就是"专业级工具箱" —— 专为NVIDIA显卡优化。</p>
<p><strong>核心特点</strong>:</p>
<ul>
<li>✅ 社区支持最广(90%开源模型都有GPTQ版)</li>
<li>✅ 兼容性最强(从GTX 1080到RTX 4090通吃)</li>
<li>✅ 文档完善(遇到问题Google一下就有答案)</li>
</ul>
<p><strong>硬件适配</strong>:</p>

























<table><thead><tr><th>GPU系列</th><th>推荐度</th><th>实战表现</th></tr></thead><tbody><tr><td>RTX 20/30/40/50</td><td>⭐⭐⭐⭐⭐</td><td>完美运行</td></tr><tr><td>T4(云服务器常见)</td><td>⭐⭐⭐⭐⭐</td><td>性价比之王</td></tr><tr><td>A10/A100</td><td>⭐⭐⭐⭐⭐</td><td>专业级选择</td></tr></tbody></table>
<p><strong>文件结构</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">model-GPTQ/
├── model.safetensors      <span class="hljs-comment"># 量化后的权重</span>
├── quantize_config.json   <span class="hljs-comment"># 量化配置</span>
└── config.json            <span class="hljs-comment"># 模型配置</span>
</code></pre>
<p><strong>小缺点</strong>:</p>
<ul>
<li>❌ 推理速度比AWQ慢10-15%</li>
<li>❌ 对激活值不够"敏感"</li>
</ul>
<hr/>
<h4 data-id="heading-8">AWQ:激活感知的"精准狙击手"</h4>
<p><strong>为什么它最省显存?</strong></p>
<p>想象你要搬家,大部分东西都能压缩,但有些"易碎品"必须原样保护。AWQ就是这样 —— 它知道模型哪些权重重要,重点保护。</p>
<p><strong>黑科技</strong>:</p>
<ul>
<li><strong>激活感知</strong>:分析推理时哪些神经元最活跃</li>
<li><strong>分层量化</strong>:重要层保留高精度,次要层激进压缩</li>
<li><strong>结果</strong>:INT4精度≈INT8效果,但显存省50%!</li>
</ul>
<p><strong>实战数据</strong>(7B模型,即70亿参数):</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">FP16:   14GB显存</span>
<span class="hljs-section">GPTQ:    6GB显存</span>
<span class="hljs-section">AWQ:     4GB显存 ← 最省!</span>
</code></pre>
<p><strong>硬件要求</strong>(略挑食):</p>

























<table><thead><tr><th>GPU</th><th>推荐度</th><th>说明</th></tr></thead><tbody><tr><td>RTX 30/40/50</td><td>⭐⭐⭐⭐⭐</td><td>推理速度最快</td></tr><tr><td>A100/H100</td><td>⭐⭐⭐⭐⭐</td><td>企业级首选</td></tr><tr><td>T4</td><td>⭐⭐⭐</td><td>能跑但不如GPTQ快</td></tr></tbody></table>
<p><strong>为什么T4不推荐?</strong> T4的TensorCore是7.5架构(较老),AWQ的INT4优化吃不满,反而GPTQ的INT8更适合。</p>
<hr/>
<h3 data-id="heading-9">第三部分:其他重要选手</h3>
<h4 data-id="heading-10">TensorRT:工业级的"F1赛车"</h4>
<p><strong>定位</strong>:企业生产环境的终极方案</p>
<p><strong>为什么快?</strong></p>
<ul>
<li>算子融合(把10步操作合成1步)</li>
<li>内存优化(减少CPU-GPU数据搬运)</li>
<li>硬件直通(直接调用TensorCore)</li>
</ul>
<p><strong>速度对比</strong>(70B模型,即700亿参数推理):</p>
<pre><code class="hljs language-bash" lang="bash">PyTorch FP16:   120ms/token
GPTQ:           80ms/token
TensorRT FP8:   35ms/token ← 快3倍!
</code></pre>
<p><strong>代价</strong>:</p>
<ul>
<li>❌ 需要导出ONNX</li>
<li>❌ 需要校准数据集</li>
<li>❌ 调试难度高</li>
</ul>
<p><strong>适用场景</strong>: ✅ 视频平台实时字幕 ✅ 客服机器人(秒级响应) ✅ 金融风控(高并发)</p>
<hr/>
<h4 data-id="heading-11">BitsAndBytes:懒人的福音</h4>
<p><strong>一句话总结</strong>:"不想转换模型?那就用我!"</p>
<p><strong>使用体验</strong>:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 传统方式:下载→转换→加载(30分钟起步)</span>
<span class="hljs-comment"># BitsAndBytes:直接加载(3分钟搞定)</span>
​
from transformers import AutoModelForCausalLM, BitsAndBytesConfig
​
<span class="hljs-attr">model</span> = AutoModelForCausalLM.from_pretrained(
    &amp;<span class="hljs-comment">#34;Qwen/Qwen-7B&amp;#34;,</span>
    <span class="hljs-attr">quantization_config</span>=BitsAndBytesConfig(
        <span class="hljs-attr">load_in_4bit</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">bnb_4bit_compute_dtype</span>=torch.float16
    )
)
<span class="hljs-comment"># 就这么简单,开箱即用!</span>
</code></pre>
<p><strong>优点</strong>: ✅ 零转换成本 ✅ Transformers原生支持 ✅ 适合快速实验</p>
<p><strong>缺点</strong>: ❌ 性能比预量化方案慢10-20% ❌ 需要较新显卡(&gt;=RTX 20系列)</p>
<hr/>
<h4 data-id="heading-12">FP16/BF16:精度党的坚守</h4>
<p><strong>核心观念</strong>:"我不缺显存,只要精度!"</p>
<p><strong>实战场景</strong>:</p>
<ul>
<li>学术研究(需要可复现结果)</li>
<li>医疗AI(精度要求极高)</li>
<li>大规模实验(A100集群)</li>
</ul>
<p><strong>数据对比</strong>:</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">FP32</span>(全精度):  <span class="hljs-number">100%</span>精度, <span class="hljs-number">28</span>GB显存
<span class="hljs-built_in">FP16</span>(半精度):  <span class="hljs-number">99.9%</span>精度, <span class="hljs-number">14</span>GB显存 ← 性价比高
<span class="hljs-built_in">INT8</span>(GPTQ):    <span class="hljs-number">98%</span>精度,    <span class="hljs-number">7</span>GB显存
<span class="hljs-built_in">INT4</span>(AWQ):     <span class="hljs-number">95%</span>精度,    <span class="hljs-number">4</span>GB显存
</code></pre>
<hr/>
<h3 data-id="heading-13">第四部分:终极对比矩阵(选型必看!)</h3>
<h4 data-id="heading-14">全方案对比表</h4>




































































<table><thead><tr><th>方案</th><th>精度</th><th>显存</th><th>速度</th><th>兼容性</th><th>特点</th><th>推荐指数</th></tr></thead><tbody><tr><td><strong>GGUF</strong></td><td>中等</td><td>🏆最低</td><td>中等</td><td>🏆全平台</td><td>跨平台之王</td><td>⭐⭐⭐⭐</td></tr><tr><td><strong>GPTQ</strong></td><td>良好</td><td>低</td><td>良好</td><td>🏆最广</td><td>最稳妥选择</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>AWQ</strong></td><td>🏆最佳</td><td>🏆更低</td><td>快</td><td>新卡优</td><td>显存杀手</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>TensorRT</strong></td><td>极佳</td><td>中等</td><td>🏆最快</td><td>企业级</td><td>生产环境</td><td>⭐⭐⭐⭐</td></tr><tr><td><strong>BitsAndBytes</strong></td><td>中等</td><td>中等</td><td>较快</td><td>新卡</td><td>懒人福音</td><td>⭐⭐⭐⭐</td></tr><tr><td><strong>FP16</strong></td><td>🏆原生</td><td>高</td><td>快</td><td>大显卡</td><td>精度党</td><td>⭐⭐⭐</td></tr></tbody></table>
<p>很多人会问：</p>
<ul>
<li>vLLM 支持谁？（GPTQ? AWQ? GGUF?）</li>
<li>SGLang 支持谁？</li>
<li>llama.cpp 支持什么格式？</li>
</ul>





























































<table><thead><tr><th>框架</th><th>GGUF</th><th>GPTQ</th><th>AWQ</th><th>BnB</th><th>备注</th></tr></thead><tbody><tr><td>llama.cpp</td><td>✅</td><td>❌</td><td>❌</td><td>❌</td><td>GGUF专属</td></tr><tr><td>Transformers</td><td>❌</td><td>❌</td><td>❌</td><td>✅</td><td>原生支持4/8bit</td></tr><tr><td>AutoGPTQ</td><td>❌</td><td>✅</td><td>❌</td><td>❌</td><td>GPTQ专用</td></tr><tr><td>AWQ repo</td><td>❌</td><td>❌</td><td>✅</td><td>❌</td><td>AWQ专用</td></tr><tr><td>vLLM</td><td>❌</td><td>部分</td><td>部分</td><td>❌</td><td>2024后逐步支持 INT4/INT8 插件</td></tr><tr><td>SGLang</td><td>❌</td><td>部分</td><td>部分</td><td>❌</td><td>性能非常强</td></tr></tbody></table>
<p>那么显存怎么选？<a href="https://link.juejin.cn?target=https%3A%2F%2Fxiaobingan.github.io%2Fgpu-calculator%2F" target="_blank" title="https://xiaobingan.github.io/gpu-calculator/" ref="nofollow noopener noreferrer">可以看一下我前几天做的显存计算器</a>做个简单的参考</p>





































<table><thead><tr><th>70B 模型格式</th><th>显存需求</th></tr></thead><tbody><tr><td>FP16</td><td>~140GB</td></tr><tr><td>BF16</td><td>~140GB</td></tr><tr><td>FP8 (TensorRT)</td><td>~80GB</td></tr><tr><td>GPTQ (INT4)</td><td>~38GB</td></tr><tr><td>AWQ (INT4)</td><td>~32GB</td></tr><tr><td>GGUF Q4</td><td>~28GB</td></tr><tr><td>GGUF Q5</td><td>~36GB</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-15">第五部分:5秒选型指南(按硬件直接选!)</h3>
<h4 data-id="heading-16">🎯 快速决策树</h4>
<pre><code class="hljs language-scss" lang="scss">你的设备是什么?
│
├─ 💻 CPU / Mac / 老显卡
│   └─ → GGUF (唯一之选)
│
├─ 🎮 RTX <span class="hljs-number">20</span>/<span class="hljs-number">30</span>/<span class="hljs-number">40</span>系列显卡
│   └─ → GPTQ (最稳妥)
│
├─ 💡 显存不够用(想跑大模型)
│   └─ → AWQ (压缩率最高)
│
├─ ⚡ 企业级<span class="hljs-built_in">GPU</span>(A100/H100)
│   └─ → TensorRT FP8 (追求极致)
│
├─ 🛠️ 不想折腾(快速实验)
│   └─ → BitsAndBytes (开箱即用)
│
└─ 🧪 大显卡 + 要精度
    └─ → FP16/BF16 (接近原生)
</code></pre>
<hr/>
<h4 data-id="heading-17">💡 实战场景匹配</h4>
<p><strong>场景1:个人学习/开发</strong></p>
<ul>
<li>预算: 没有最好的方案,只有最适合你硬件的方案。先看显卡,再选量化!</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JS 高手必会：手写 new 与 instanceof]]></title>    <link>https://juejin.cn/post/7582016579858317346</link>    <guid>https://juejin.cn/post/7582016579858317346</guid>    <pubDate>2025-12-10T16:02:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582016579858317346" data-draft-id="7581670270844682280" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JS 高手必会：手写 new 与 instanceof"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-10T16:02:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="谎言西西里"/> <meta itemprop="url" content="https://juejin.cn/user/332466136029851"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JS 高手必会：手写 new 与 instanceof
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/332466136029851/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    谎言西西里
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T16:02:15.000Z" title="Wed Dec 10 2025 16:02:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">手写 instanceof</h2>
<p>首先我们需要了解 <code>instanceof</code>是啥？</p>
<p>在其他面向对象编程语言中<code>instanceof</code>大多为<strong>实例判断运算符</strong>，即检查对象是否是某个构造函数的实例。</p>
<p>但是在 JS 中，<code>instanceof</code>为<strong>原型关系判断运算符</strong>，用于检测构造函数的<code>prototype</code>属性是否出现在某个对象的原型链上。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// object instanceof Constructor</span>
A <span class="hljs-keyword">instanceof</span> B <span class="hljs-comment">// A 的原型链上是否有 B 的原型 </span>
</code></pre>
<p>而在大型项目、多人协作的情况下，在搞不懂对象上有哪些属性和方法，通过<code>instanceof</code>来查找继承关系</p>
<h3 data-id="heading-1">原型链关系：</h3>
<ul>
<li><code>__proto__</code>: 指向原型对象（上一位的 .prototype），用于属性查找</li>
<li><code>constructor</code>: 指向构造函数本身，用于标识对象的创建者</li>
<li><code>prototype</code>： 函数的属性，指向原型对象（内置构造函数的 prototype 上通常有默认方法）</li>
</ul>
<pre><code class="hljs language-js" lang="js">子.<span class="hljs-property">__proto__</span> === 父.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
父.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> === 父
子.<span class="hljs-property">__proto__</span>.<span class="hljs-property">constructor</span> === 父（通过原型链访问）
</code></pre>
<p>举个最简单的例子：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
    arr.<span class="hljs-property">__proto__</span>, <span class="hljs-comment">// Array.prototype</span>
    arr.<span class="hljs-property">__proto__</span>.<span class="hljs-property">__proto__</span>, <span class="hljs-comment">// Object.prototype</span>
    arr.<span class="hljs-property">__proto__</span>.<span class="hljs-property">__proto__</span>.<span class="hljs-property">__proto__</span> <span class="hljs-comment">// null</span>
)
</code></pre>
<p>那么arr的原型链关系就是：<code>arr -&gt; Array.prototype -&gt; Object.prototype -&gt; null</code></p>
<p>而我们要手写<code>instanceof</code>，也就是只需要沿着原型链去查找，那么用简单的循环即可。</p>
<h3 data-id="heading-2">手写代码如下</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// right 是否出现在 left 的原型链上</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isInstanceOf</span>(<span class="hljs-params">left, right</span>) {
    <span class="hljs-keyword">let</span> proto = left.<span class="hljs-property">__proto__</span>;
    <span class="hljs-comment">// 循环查找原型链</span>
    <span class="hljs-keyword">while</span> (proto) {
        <span class="hljs-keyword">if</span> (proto === right.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        proto = proto.<span class="hljs-property">__proto__</span>; <span class="hljs-comment">// null 结束循环</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<h2 data-id="heading-3">手写 new</h2>
<p><code>new</code>对我们来说并不陌生，也就是<strong>实例运算符</strong></p>
<p>在之前的文章我也提到过<code>new</code>的伪代码，让我们再来复习一下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 从空对象开始</span>
<span class="hljs-keyword">let</span> obj = {}
<span class="hljs-comment">// this -&gt; 创建空对象，运行构造函数</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">call</span>(obj)
<span class="hljs-comment">// 将空对象的__proto__ 指向 构造函数的原型对象</span>
obj.<span class="hljs-property">__proto__</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
<span class="hljs-comment">// 返回新对象</span>
<span class="hljs-keyword">return</span> obj
</code></pre>
<h3 data-id="heading-4">写法一：（es6 新写法）</h3>
<p>假如我们要<code>new</code>一个实例对象，但是不知道构造函数上的参数数量，而在es6中有一个新的运算符，也就是<code>...</code>运算符，它的诸多功能就可以满足我们的需求。</p>
<h4 data-id="heading-5"><code>...</code>扩展运算符</h4>
<p><code>...</code>有双重身份，在不同情况下的作用也不同</p>
<ul>
<li>
<p><strong>函数调用 / 数组 / 对象字面量中</strong>：<code>...</code>称为扩展运算符，将可迭代对象“展开”为独立元素</p>
</li>
<li>
<p><strong>函数参数 / 解构赋值中</strong>: <code>...</code>称为剩余参数/剩余元素，将多个值“收集”为一个数组</p>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 展开数组</span>
<span class="hljs-keyword">const</span> arr1 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]; 
<span class="hljs-keyword">const</span> arr2 = [...arr1, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]; <span class="hljs-comment">// [1, 2, 3, 4, 5] </span>

<span class="hljs-comment">// 收集数组</span>
<span class="hljs-keyword">const</span> [first, ...rest] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(first); <span class="hljs-comment">// 1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(rest);  <span class="hljs-comment">// [2, 3, 4]</span>
</code></pre>
<p>而依据我们的伪代码即可模拟 <code>new</code>的功能</p>
<h3 data-id="heading-6">手写代码如下</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">objectFactory</span>(<span class="hljs-params">Construstor, ...args</span>) {
    <span class="hljs-comment">// 创建空对象</span>
    <span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>(); 
    <span class="hljs-comment">// 绑定 this 并执行构造函数</span>
    <span class="hljs-title class_">Construstor</span>.<span class="hljs-title function_">apply</span>(obj, args); <span class="hljs-comment">// 不能使用call，因为apply调用数组</span>
    <span class="hljs-comment">// 设置原型链</span>
    obj.<span class="hljs-property">__proto__</span> = <span class="hljs-title class_">Construstor</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>; 
    <span class="hljs-keyword">return</span> obj;
}

<span class="hljs-comment">// 使用：完全不需要知道 Person 需要几个参数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name, age, city</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">city</span> = city;
}

<span class="hljs-keyword">const</span> p = <span class="hljs-title function_">objectFactory</span>(<span class="hljs-title class_">Person</span>, <span class="hljs-string">'Alice'</span>, <span class="hljs-number">25</span>, <span class="hljs-string">'Beijing'</span>); <span class="hljs-comment">// 自动适配</span>
</code></pre>
<hr/>
<h3 data-id="heading-7">写法二：（根据arguments es5）</h3>
<p>当然，在es6之前我们并没有<code>...</code>运算符，那么如何手写<code>new</code>呢？这就不得不提到<code>arguments</code>了。</p>
<h4 data-id="heading-8"><code>arguments</code> 是什么？</h4>
<p><code>arguments</code> 是 JS 中的一个<strong>类数组对象</strong>，它在所有非箭头函数内部自动可用，用于<strong>访问传递给该函数的所有实参</strong>。</p>
<blockquote>
<p>类数组对象：</p>
<ul>
<li>
<p>拥有 <code>length</code> 属性和若干索引属性，但不具备数组原型方法（如 <code>.push()</code>, <code>.map()</code>, <code>.forEach()</code> 等）的对象，所以<strong>其不是真正的数组</strong></p>
</li>
<li>
<p>在<strong>普通函数</strong>中自动绑定。</p>
</li>
<li>
<p><strong>箭头函数内部没有自己的 <code>arguments</code></strong>，但是会沿作用域链查找外层函数的 <code>arguments</code>，如果外层有就用外层的。</p>
</li>
</ul>
</blockquote>
<p>不妨来看个例子理解一下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">arguments</span>); <span class="hljs-comment">// 类数组对象</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">arguments</span>.<span class="hljs-property">length</span>); <span class="hljs-comment">// 实际传入参数个数</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">arguments</span>[<span class="hljs-number">0</span>]);     <span class="hljs-comment">// 第一个参数</span>
}
<span class="hljs-title function_">greet</span>(<span class="hljs-string">'Alice'</span>, <span class="hljs-string">'Bob'</span>); <span class="hljs-comment">// 输出: { '0': 'Alice', '1': 'Bob' }, length: 2, 'Alice'</span>
</code></pre>
<h4 data-id="heading-9">如何将 <code>arguments</code> 转为真数组？</h4>
<p>因为 <code>arguments</code> 不是数组，不能直接用数组方法。但是可以将其转换为数组：</p>
<p><strong>方法 1：扩展运算符（ES6+，最简洁）</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> args = [...<span class="hljs-variable language_">arguments</span>];
  args.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x * <span class="hljs-number">2</span>); <span class="hljs-comment">// 可用数组方法</span>
}
</code></pre>
<p><strong>方法 2：<code>Array.from()</code></strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> args = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">arguments</span>);
</code></pre>
<p><strong>方法 3：<code>[].slice.call()</code></strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> args = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">slice</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">arguments</span>);
<span class="hljs-comment">// 或简写（更推荐）</span>
<span class="hljs-keyword">const</span> args = [].<span class="hljs-property">slice</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">arguments</span>);
</code></pre>
<p><code>slice</code>是数组原型上的一个方法，用于<strong>返回一个从原数组或类数组中浅拷贝出来的新数组</strong>（实现将类数组转换成数组）</p>
<p><code>[].slice</code>是因为<code>arguments</code>上没有这个方法，所以需要去空数组中“借用”，并且通过
<code>.call()</code> 将<code>slice</code>的<code>this</code>指向<code>arguments</code>，变相的让<code>arguments</code>可以使用这个方法。</p>
<p>在了解了<code>arguments</code>后，聪明的你已经想到了如何通过它来实现手写<code>new</code>了</p>
<h3 data-id="heading-10">手写代码如下</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">objectFactory</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 创建空对象</span>
    <span class="hljs-keyword">var</span> obj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>(); 
    <span class="hljs-comment">// 将 arugments 的第一项提出来（也就是 构造函数）</span>
    <span class="hljs-keyword">var</span> <span class="hljs-title class_">Construstor</span> = [].<span class="hljs-property">shift</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">arguments</span>);
    <span class="hljs-comment">// 绑定 this 并执行构造函数</span>
    <span class="hljs-title class_">Construstor</span>.<span class="hljs-title function_">apply</span>(obj, <span class="hljs-variable language_">arguments</span>); <span class="hljs-comment">// 不能使用call，因为 apply调用数组</span>
    <span class="hljs-comment">// 设置原型链</span>
    obj.<span class="hljs-property">__proto__</span> = <span class="hljs-title class_">Construstor</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>; 
    <span class="hljs-keyword">return</span> obj;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name, age, city</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">city</span> = city;
}

<span class="hljs-keyword">const</span> p = <span class="hljs-title function_">objectFactory</span>(<span class="hljs-title class_">Person</span>, <span class="hljs-string">'Alice'</span>, <span class="hljs-number">25</span>, <span class="hljs-string">'Beijing'</span>); <span class="hljs-comment">// 自动适配</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GLM-4.6V 初探：国产 AI 能边写边自己配图了]]></title>    <link>https://juejin.cn/post/7582102297480740906</link>    <guid>https://juejin.cn/post/7582102297480740906</guid>    <pubDate>2025-12-10T14:34:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582102297480740906" data-draft-id="7582102297480724522" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GLM-4.6V 初探：国产 AI 能边写边自己配图了"/> <meta itemprop="keywords" content="ChatGLM (智谱),人工智能"/> <meta itemprop="datePublished" content="2025-12-10T14:34:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GLM-4.6V 初探：国产 AI 能边写边自己配图了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T14:34:58.000Z" title="Wed Dec 10 2025 14:34:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>写文章时总会遇到需要插图解释的地方，之前分享过<code>即梦</code>可以为文章全文配图了。</p>
<p>《<a href="https://juejin.cn/post/7566526381727924266" target="_blank" title="https://juejin.cn/post/7566526381727924266">即梦AI竟然可以全文一键配图了？ - 掘金</a>》</p>
<p>但终归还需要手动复制、粘贴，体验没有那么完美。</p>
<p>常用的 AI 我当时也尝试了，只有 <code>Gemini</code> 给出了图文混排的结果。</p>
<p>如今，国产模型给出了选择——<code>GLM-4.6V</code>，一键搞定图文混排内容创作。</p>
<h2 data-id="heading-0">GLM-4.6V</h2>
<p><code>GLM</code> 的 V 系列是智谱模型中的多模态大模型，效果一直不错。</p>
<p>本次发布包括两款模型：</p>
<ul>
<li><strong>GLM-4.6V（106B-A12B）</strong>：面向云端与高性能集群场景的基础版；</li>
<li><strong>GLM-4.6V-Flash（9B）</strong>：面向本地部署与低延迟应用的轻量版。</li>
</ul>
<p>其中，<code>Flash</code> 版本依然免费提供给大家使用。</p>
<p>这次发布的主要内容如下：</p>
<ul>
<li>训练时上下文窗口提升到 <code>128k tokens</code>，在视觉理解精度上达到同参数规模 <code>SOTA</code>。</li>
<li>首次在模型架构中将 <code>Function Call</code>（工具调用）能力原生融入视觉模型，打通从**「视觉感知」<strong>到</strong>「可执行行动（Action）」**的链路。</li>
</ul>
<p>我们直接到 <code>z.ai</code> 上体验下“工具调用能力原生融入视觉模型”是什么感受。</p>
<h2 data-id="heading-1">原生多模态工具调用实测</h2>
<p>场景比较简单，我让 <code>GLM-4.6V</code> 帮我写一篇 <code>Gemini 3 Pro</code> 的科普文章，重要的是输出要图文混排。</p>
<p><strong>提示词</strong></p>
<pre><code class="hljs">帮我写一篇介绍 Gemini 3 pro 的科普文章，需要图文并茂
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1e8826a8cca4bcbba31f8b44b1a42a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765982098&amp;x-signature=Q209VOJIxpVk%2BCB6EPE7kzOipm0%3D" alt="" loading="lazy"/></p>
<p>截图中可以看到思考过程中就可以调用图片搜索工具（<code>Function</code>），查找适合的图片以供使用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e5ddf442c704204a875bdee0c0da20b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765982098&amp;x-signature=924RGg%2BDpS5X%2F2k7ol%2Bz4cT4Bqc%3D" alt="" loading="lazy"/></p>
<p>后续也确实在文章中使用了上面的图片，并针对图片进行了文字解释。</p>
<p>整个过程完全自动化，一轮对话就能得到一篇图文并茂的高质量文章了。</p>
<h2 data-id="heading-2">结语</h2>
<p>这意味着，以后的内容创作，终于不用在不同模型间来回切换了。</p>
<p>但我认为意义远不止这一点。</p>
<p><strong>多模态大模型中的“多”一直指的是可以支持的种类多，而不是一轮对话中的语料模态“多”</strong>。</p>
<p>现在，使用 GLM-4.6V，我们可以一次性传递文字、图片两种模态，后续语音、视频估计也会陆续出现。</p>
<p>这种模型能力的提升，将会更加精准的描述真实世界，相应的，模型后续的服务水平也一定会再次提升。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[聊聊协程里的 Semaphore：别让协程挤爆门口]]></title>    <link>https://juejin.cn/post/7582016579858169890</link>    <guid>https://juejin.cn/post/7582016579858169890</guid>    <pubDate>2025-12-10T14:18:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582016579858169890" data-draft-id="7582036070159695872" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="聊聊协程里的 Semaphore：别让协程挤爆门口"/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2025-12-10T14:18:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RainyJiang"/> <meta itemprop="url" content="https://juejin.cn/user/2287404300943566"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            聊聊协程里的 Semaphore：别让协程挤爆门口
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2287404300943566/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RainyJiang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T14:18:11.000Z" title="Wed Dec 10 2025 14:18:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-dune-light">.hljs-comment,.hljs-quote{color:#7d7a68}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d73737}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#b65611}.hljs-bullet,.hljs-string,.hljs-symbol{color:#60ac39}.hljs-section,.hljs-title{color:#6684e1}.hljs-keyword,.hljs-selector-tag{color:#b854d4}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefbec;color:#6e6b5e}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>最近在工作中遇到了一个非常普通的小需求，客户端需要从云端上拉取一堆图片链接，并且针对图片做升序处理后展示最终列表。听起来是不是很简单呢，不就是“下载 → 看大小 → 排排序“就搞定了。结果一跑，服务器差点被我按在地上摩擦。因为图片一多，协程一个个像打了鸡血一样，<strong>同时起飞！同时请求！同时冲向服务器！</strong> 这边的客户端是觉得很爽，很嗨了。但云服务器那边就不太乐观了：“兄der你冷静点，我不是 CDN，我只是个普通打工人 API 啊！”</p>
<p>是的，当成百上千万个协程一起拉图片的时候，网络连接开始爆满，服务端响应变慢，客户端排序逻辑还没跑起来，先被自己的并发压垮了。这时候恭喜你，体验到了<strong>无限制并发的恐怖后果</strong>。</p>
<p>就是在这混乱的“协程暴走事件”中，笔者意识到：<strong>需要有人来控场，需要一个能让协程排队、有序、文明办事的存在。</strong></p>
<p>于是<em>Kotlin</em>的 <em>Semaphore</em>信号量闪亮登场了，相信各位小伙伴都不陌生了。它像一个经验丰富的交通指挥员，站在网络请求入口处，对协程们说：“别挤别挤，一个一个来，最多五个同时下载，懂？”。从那以后，图片请求不再挤爆服务器，排序流程顺顺利利。</p>
<p>OK, 相信小伙伴们已经知道今天我们要聊什么了，没错，今天要聊的主角，就是那个能帮大家<strong>维持秩序、防止过度热情</strong>的小家伙：<em>Semaphore(信号量)</em> 。</p>
<h2 data-id="heading-1">一句话解释协程中的<em>Semaphore</em></h2>
<p>这时候就有同学要问了，啥是协程中的<em>Semaphore</em>，它和Java当中的<em>Semaphore</em>是一个东西么？</p>
<p>我们打个比方，假如我们刚刚开了一家火锅店，但店里此时只有 5 个炉子。顾客排成长龙，每个顾客都想自己涮菜。这时候怎么办？</p>
<p>于是你定了以下的规则：</p>
<ul>
<li>同时最多5个顾客拿到烤炉（许可证）</li>
<li>当有顾客吃完了（<em>release</em>），下一个顾客再接着上(<em>acquire</em>)</li>
</ul>
<p>这就是信号量的职责所在，Kotlin的<em>Semaphore</em>也干着类似的事情，它控制着<strong>同时能有多少个协程进入某段代码</strong>。一旦超过了？那后面就<strong>乖乖排队、挂起等待</strong>。</p>
<p>Java中同样也叫这个，但很可惜，它们并不算是同一个东西。我们可以简单理解为：一个是 <strong>“协程世界的交警”</strong> ，一个是 <strong>“线程世界的交警”</strong> ，都不在一个地方，工作方式也有所不同。具体这里就不过多延展，感兴趣的小伙伴可以仔细研究研究，下面笔者用一个表格简单概括下它们之前的区别</p>


















































<table><thead><tr><th/><th>Java Semaphore</th><th>Kotlin Coroutine Semaphore</th></tr></thead><tbody><tr><td>所属包</td><td><em>java.util.concurrent</em></td><td><em>kotlinx.coroutines.sync</em></td></tr><tr><td>控制对象</td><td>线程</td><td>协程</td></tr><tr><td>阻塞方式</td><td>阻塞线程（<em>Blocking</em>）</td><td>挂起协程（<em>Suspending</em>）</td></tr><tr><td>性能特征</td><td>线程上下文切换开销大</td><td>非阻塞、轻量、可扩展</td></tr><tr><td>使用语法</td><td><em>acquire()</em> / <em>release()</em></td><td><em>withPermit { ... }</em> （挂起安全的）</td></tr><tr><td>出错后释放</td><td>手动 <em>try...finally</em></td><td>自动（<em>withPermit</em>）</td></tr><tr><td>使用场景</td><td>多线程同步、并发限流</td><td>协程并发控制、异步限流</td></tr><tr><td>公平性</td><td>可选公平模式</td><td>默认不公平（可自定义逻辑）</td></tr></tbody></table>
<h2 data-id="heading-2">如何使用<em>Semaphore</em></h2>
<p>Kotlin的<em>Semaphore</em>核心用户其实就是两个字：进出</p>
<ul>
<li><em>acquire</em>:申请许可证（进门）</li>
<li>release: 释放许可证（出门）</li>
</ul>
<p>由于Kotlin中懒得使用<em>try..finally</em>, 所以官方非常贴心的封装了个函数，自动帮你 acquire + release，就像门禁刷脸自动出入，不必担心忘记带卡而被关在了外面。</p>
<pre><code class="hljs language-arduino" lang="arduino">semaphore.withPermit {
    <span class="hljs-comment">// 受保护的代码区</span>
}
</code></pre>
<h2 data-id="heading-3">聊聊一些使用<em>Semaphore</em>的场景</h2>
<h3 data-id="heading-4">场景1：限流请求，不被封号</h3>
<p>假设我们要抓取几十个网页，但网站规定每次最多 5 个并发。直接上<em>Sempahore</em></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchAll</span><span class="hljs-params">(urls: <span class="hljs-type">List</span>)</span></span> = coroutineScope {
    <span class="hljs-keyword">val</span> semaphore = Semaphore(<span class="hljs-number">5</span>)
    urls.map { url -&gt;
        async {
            semaphore.withPermit {
                println(&amp;#<span class="hljs-number">34</span>;开始抓取 $url&amp;#<span class="hljs-number">34</span>;)
                delay(<span class="hljs-number">500</span>) <span class="hljs-comment">// 模拟网络请求</span>
                &amp;#<span class="hljs-number">34</span>;内容来自 $url&amp;#<span class="hljs-number">34</span>;
            }
        }
    }.awaitAll()
}
</code></pre>
<p><em>Semaphore</em>在这里就是我们的“爬虫节流阀”，优雅地让你在不被 ban 掉的边缘反复试探。兄弟，别试探了</p>
<h3 data-id="heading-5">场景2：CPU 密集任务的节流阀</h3>
<p>如果我们有一些非常重且耗时的计算任务Task,</p>
<pre><code class="hljs language-scss" lang="scss">(<span class="hljs-number">1</span>..<span class="hljs-number">10000000</span>)<span class="hljs-selector-class">.map</span> {
    async { <span class="hljs-built_in">heavyCompute</span>(it) }
}<span class="hljs-selector-class">.awaitAll</span>()
​
</code></pre>
<p>CPU迟早被我们榨干了，改用<em>Samphore</em>试试吧</p>
<pre><code class="hljs language-scss" lang="scss">val semaphore = <span class="hljs-built_in">Semaphore</span>(Runtime.getRuntime()<span class="hljs-selector-class">.availableProcessors</span>())
(<span class="hljs-number">1</span>..<span class="hljs-number">10000000</span>)<span class="hljs-selector-class">.map</span> {
    async {
        semaphore<span class="hljs-selector-class">.withPermit</span> {
            <span class="hljs-built_in">heavyCompute</span>(it)
        }
    }
}<span class="hljs-selector-class">.awaitAll</span>()
</code></pre>
<p>CPU终于能喘口气，不再进行成千上百万个计算内卷中。</p>
<h2 data-id="heading-6">注意事项：一些容易翻车的点</h2>
<h3 data-id="heading-7">1. 忘记 <em>release()</em> → 协程永远卡在门口</h3>
<p>如果我们手动使用 <em>acquire()</em> ，却在中途代码块中报错了、return、或者忘记在 <em>finally</em>中调用 <em>release()</em> ，那许可证就“丢了”。剩余<em>permits</em>会越来越少，最后所有协程都会停在 <em>acquire()</em> 这一步，再也不继续执行。</p>
<p>就像饭店一共 3 个炉子，有个客人用完忘了还炉子，还把炉子带走了，全店从此只能开 2 个炉子，之后客人纷纷效仿，以至于最后厨房彻底瘫痪。</p>
<pre><code class="hljs language-scss" lang="scss">semaphore<span class="hljs-selector-class">.acquire</span>()
<span class="hljs-built_in">doSomething</span>()  <span class="hljs-comment">// 这里如果抛异常了...</span>
semaphore<span class="hljs-selector-class">.release</span>() <span class="hljs-comment">// 根本进不到这行</span>
</code></pre>
<p><strong>解决办法：一般情况下，用 <em>withPermit {}</em> 永远不会忘记释放！</strong></p>
<h3 data-id="heading-8">2. 重入信号量 → 协程“自锁成仙”</h3>
<p>这是啥意思呢？我们要知道<em>Semaphore</em> <strong>不是可重入的</strong>。同一个协程内部如果还没有释放前一个许可证，又再次 <em>acquire()</em> ，就会陷入死锁。因为自己拿着许可证，却又在等自己释放它。</p>
<pre><code class="hljs language-scss" lang="scss">semaphore<span class="hljs-selector-class">.withPermit</span> {
    <span class="hljs-built_in">println</span>(&amp;#<span class="hljs-number">34</span>;外层开始&amp;#<span class="hljs-number">34</span>;)
    semaphore<span class="hljs-selector-class">.withPermit</span> {  <span class="hljs-comment">// 冲突点就在这里</span>
        <span class="hljs-built_in">println</span>(&amp;#<span class="hljs-number">34</span>;内层：永远进不来&amp;#<span class="hljs-number">34</span>;)
    }
}
</code></pre>
<p>这段代码永远执行不到内层，因为外层拿着许可证不放。</p>
<p><strong>解决方法：</strong></p>
<ul>
<li>不要在受控区域里再次调用受控区域。</li>
<li>如果确实需要嵌套结构，改用别的机制（如<em>Mutex</em>）。</li>
</ul>
<h3 data-id="heading-9">3. 不公平调度 → 你以为是排队，其实是“插队现场”</h3>
<p>协程的<em>Semaphore</em> 是<strong>不保证公平性的</strong>。它不会确保“先等待的协程先获得许可证”。只要许可证释放时，有协程竞争到，它就上，谁先谁后，调度器说了算。</p>
<p><strong>这意味着：</strong></p>
<ul>
<li>某些协程可能一直抢不到许可证。</li>
<li>这在大量协程等待 + 高竞争的情况下更明显。</li>
</ul>
<p>就好比在网红店门口排队买奶茶，店员一开门让客人进来，结果永远是站得近的那几个人挤进去了。排在远处的几个倒霉蛋可能等了 10 分钟还是没进去。</p>
<pre><code class="hljs language-scss" lang="scss">val semaphore = <span class="hljs-built_in">Semaphore</span>(<span class="hljs-number">1</span>)
​
repeat(<span class="hljs-number">100</span>) { <span class="hljs-selector-tag">i</span> -&gt;
    launch {
        if (i == <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// 0号协程：可怜娃，可能永远等不到</span>
            semaphore<span class="hljs-selector-class">.withPermit</span> {
                <span class="hljs-built_in">println</span>(&amp;#<span class="hljs-number">34</span>;<span class="hljs-number">0</span>号终于进来了&amp;#<span class="hljs-number">34</span>;)
            }
        } else {
            semaphore<span class="hljs-selector-class">.withPermit</span> {
                <span class="hljs-comment">// 其他协程执行得更快，可能一直占着节奏</span>
            }
        }
    }
}
</code></pre>
<p>因为调度器会更“偏爱”执行速度快、生命周期短的协程，0 号协程可能一直抢不到时机。</p>
<p>好了，<strong>那么我们如何避免不公平引起的问题？</strong></p>
<p><strong>如果我们业务确实需要“先来先服务（FIFO）”，可以直接用手动队列：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> mutex = Mutex()
<span class="hljs-keyword">val</span> queue = ArrayDeque&gt;()
​
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fairAcquire</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> waiter = CompletableDeferred()
    mutex.lock()
    <span class="hljs-keyword">val</span> first = queue.isEmpty()
    queue.add(waiter)
    mutex.unlock()
    <span class="hljs-keyword">if</span> (!first) {
        waiter.await() <span class="hljs-comment">// 等前面的协程释放</span>
    }
}
​
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fairRelease</span><span class="hljs-params">()</span></span> {
    mutex.lock()
    queue.removeFirstOrNull()?.complete(<span class="hljs-built_in">Unit</span>)
    mutex.unlock()
}
</code></pre>
<p>此时我们再在 <em>withPermit</em> 外层套这套“公平队列”，就能实现真正的<strong>公平信号量</strong>。但大多数业务其实不需要这么严格，只要并发数量不夸张，默认的<em>Semaphore</em>是完全够用的。</p>
<h2 data-id="heading-10">尾声</h2>
<p>如果把协程世界比作一座城市：<em>launch</em> 是汽车 ，<em>delay</em> 是红灯，那 <em>Semaphore</em> 就是交通指挥员 。没有它，协程就会像一群没刹车的司机，挤成一锅粥。有了它，大家文明出行，井然有序。</p>
<p>那么什么时候该用<em>Semaphore</em>？</p>
<ul>
<li>
<p>当你想限制“同时干活的人数”，比如说一次只允许 <strong>5 个协程下载图片</strong>。</p>
</li>
<li>
<p>当你要保护一个“有限资源”，比如说数据库连接池只有 <strong>5 个连接</strong>，必须排队使用。</p>
</li>
<li>
<p>当你担心 API 被你打到 429，比如说云端接口规定 <strong>每秒最多 10 个请求</strong>，那必须乖乖遵守。</p>
</li>
<li>
<p>当你想让 CPU 活得久一点，比如说图片处理、AI 推理、压缩等重操作，不适合让几十个协程一起上。</p>
</li>
</ul>
<p>简单来说，当你需要“允许最多 N 个协程同时执行某段代码”的时候，可以考虑考虑<em>Semaphore</em>。</p>
<p>好了，就写到这里吧。</p>
<p>祝各位早安午安晚安，祉猷并茂，顺遂无虞。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Expo 进阶指南：赋予 TanStack Query “原生感知力” —— 深度解析 AppState 与 NetInfo]]></title>    <link>https://juejin.cn/post/7582036070159941632</link>    <guid>https://juejin.cn/post/7582036070159941632</guid>    <pubDate>2025-12-10T14:58:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582036070159941632" data-draft-id="7582067084840124470" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Expo 进阶指南：赋予 TanStack Query “原生感知力” —— 深度解析 AppState 与 NetInfo"/> <meta itemprop="keywords" content="前端,React Native"/> <meta itemprop="datePublished" content="2025-12-10T14:58:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Expo 进阶指南：赋予 TanStack Query “原生感知力” —— 深度解析 AppState 与 NetInfo
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T14:58:54.000Z" title="Wed Dec 10 2025 14:58:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Web 开发中，我们习惯了浏览器的“智能”：切换标签页时页面会自动刷新，断网重连后请求会自动重试。这是因为浏览器底层自动处理了窗口聚焦（Window Focus）和网络状态（Online Status）的事件。</p>
<p>然而，在 <strong>React Native (Expo)</strong> 环境中，App 默认是“盲”和“聋”的。TanStack Query 不知道用户什么时候把 App 切到了后台，也不知道手机什么时候断了网。</p>
<p>为了让 App 拥有极致的用户体验（如：切回来自动刷新、断网自动暂停重试），我们需要手动配置 <strong>“感官系统”</strong> 。本文将深入解读 <strong><code>AppStateStatus</code></strong> 和 <strong><code>setOnline</code></strong>，并提供生产环境的完整配置方案。</p>
<hr/>
<h2 data-id="heading-0">一、 深度解读：App 的“感官系统”</h2>
<h3 data-id="heading-1">1. 视觉神经：<code>AppStateStatus</code> (应用状态)</h3>
<p>AppStateStatus 是 React Native 原生提供的一个状态类型，用于描述 App 当前处于什么处境。</p>
<p><strong>三个核心状态：</strong></p>
<ul>
<li><strong><code>active</code> (前台/活跃)</strong> ：用户正在盯着屏幕，App 在最上层运行。这是我们唯一希望触发数据刷新的状态。</li>
<li><strong><code>background</code> (后台)</strong> ：用户按了 Home 键，或者切换到了微信。App 还在内存中运行，但界面不可见。</li>
<li><strong><code>inactive</code> (非活跃)</strong> ：App 处于“半死不活”的过渡态（如被来电画面覆盖、拉下了通知栏、iOS 多任务切换界面）。</li>
</ul>
<p>为什么要配置它？</p>
<p>TanStack Query 有一个核心功能叫 Window Focus Refetching。</p>
<ul>
<li><strong>问题</strong>：RN 默认没有 <code>window.onfocus</code> 事件。</li>
<li><strong>解决</strong>：我们需要监听 <code>AppState</code> 的变化。当状态变为 <code>active</code> 时，手动调用 <code>focusManager.setFocused(true)</code>。</li>
<li><strong>效果</strong>：TanStack Query 收到信号后，会立即检查页面上的数据是否过期（Stale）。如果过期，它会在后台悄悄发起请求，用户切回来的一瞬间看到的就是最新数据。</li>
</ul>
<h3 data-id="heading-2">2. 听觉神经：<code>setOnline</code> (联网回调)</h3>
<p>setOnline 不是一个你可以直接导入的函数，它是 TanStack Query 的 onlineManager.setEventListener 方法传递给你的一个回调函数（参数）。你可以把它理解为 TanStack Query 递给你的一把“开关”。</p>
<p><strong>逻辑流程图：从断网到重连</strong></p>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">---------------------------+</span>
| 📡 物理层                  |
| 手机 <span class="hljs-number">4</span>G/WiFi 信号变化       |
+<span class="hljs-comment">-------------+-------------+</span>
              |
              v (触发系统事件)
+<span class="hljs-comment">-------------+-------------+</span>
| 🎧 B: NetInfo 监听器       |
+<span class="hljs-comment">-------------+-------------+</span>
              |
              v (获取状态: isConnected)
+<span class="hljs-comment">-------------+-------------+</span>
| 💻 C: 开发者代码逻辑        |
| (app/_layout.tsx)         |
+<span class="hljs-comment">-------------+-------------+</span>
              |
              v (调用 setOnline)
+<span class="hljs-comment">-------------+-------------+</span>
| ⚙️ D: TanStack Query      |
|     (onlineManager)       |
+<span class="hljs-comment">-------------+-------------+</span>
       /             \
      / (<span class="hljs-literal">false</span>)       \ (<span class="hljs-literal">true</span>)
     v                 v
+<span class="hljs-comment">---------+       +---------+</span>
| E: 🛑   |       | F: 🚀   |
| 暂停     |       | 恢复    |
| (Pause) |       | (Resume)|
| 停止重试 |       | 立即重试 |
+<span class="hljs-comment">---------+       +---------+</span>
</code></pre>
<p><strong>为什么要配置它？</strong></p>
<ul>
<li><strong>省电保护</strong>：如果没配置，断网时 TanStack Query 会傻傻地一直重试请求，消耗用户电量。配置后，断网即休眠。</li>
<li><strong>体验优化</strong>：如果没配置，网络恢复后，App 不会有反应，用户必须手动下拉刷新。配置后，<strong>信号恢复的瞬间，数据自动加载成功</strong>（“电梯效应”）。</li>
</ul>
<hr/>
<h2 data-id="heading-3">二、 生产环境完整配置 (<code>app/_layout.tsx</code>)</h2>
<p>这是融合了上述原理的完整配置代码。请确保你已安装了 <code>@react-native-community/netinfo</code>。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppState</span>, <span class="hljs-title class_">AppStateStatus</span>, <span class="hljs-title class_">Platform</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Slot</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'expo-router'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">NetInfo</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@react-native-community/netinfo'</span>;
<span class="hljs-keyword">import</span> { 
  <span class="hljs-title class_">QueryClient</span>, 
  <span class="hljs-title class_">QueryClientProvider</span>, 
  focusManager, 
  onlineManager 
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@tanstack/react-query'</span>;

<span class="hljs-comment">// =================================================================</span>
<span class="hljs-comment">// 1. 配置网络监听 (给 App 装上“耳朵”)</span>
<span class="hljs-comment">// =================================================================</span>
onlineManager.<span class="hljs-title function_">setEventListener</span>(<span class="hljs-function">(<span class="hljs-params">setOnline</span>) =&gt;</span> {
  <span class="hljs-comment">// setOnline 是 Query 传进来的一个函数，用来接收网络状态</span>
  <span class="hljs-comment">// 我们使用 NetInfo 来监听真实的网络变化</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">NetInfo</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {
    <span class="hljs-comment">// state.isConnected 可能为 null，用 !! 强转为 boolean</span>
    <span class="hljs-comment">// 当这里调用 setOnline(true) 时，Query 会立即重试刚才失败的请求</span>
    <span class="hljs-title function_">setOnline</span>(!!state.<span class="hljs-property">isConnected</span>);
  });
});

<span class="hljs-comment">// =================================================================</span>
<span class="hljs-comment">// 2. 配置 App 状态监听 (给 App 装上“眼睛”)</span>
<span class="hljs-comment">// =================================================================</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">onAppStateChange</span>(<span class="hljs-params">status: AppStateStatus</span>) {
  <span class="hljs-comment">// Web 浏览器会自动处理窗口聚焦，只有原生 App 需要手动处理</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Platform</span>.<span class="hljs-property">OS</span> !== <span class="hljs-string">'web'</span>) {
    <span class="hljs-comment">// 核心逻辑：</span>
    <span class="hljs-comment">// 当 AppState 变为 'active' (前台) 时</span>
    <span class="hljs-comment">// 我们手动告诉 Query 的 focusManager：“用户现在聚焦在 App 上了”</span>
    <span class="hljs-comment">// Query 收到信号后，会检查页面数据是否过期 (stale)，如果过期则自动 Refetch</span>
    focusManager.<span class="hljs-title function_">setFocused</span>(status === <span class="hljs-string">'active'</span>);
  }
}

<span class="hljs-comment">// =================================================================</span>
<span class="hljs-comment">// 3. 初始化 QueryClient (配置全局策略)</span>
<span class="hljs-comment">// =================================================================</span>
<span class="hljs-keyword">const</span> queryClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryClient</span>({
  <span class="hljs-attr">defaultOptions</span>: {
    <span class="hljs-attr">queries</span>: {
      <span class="hljs-attr">retry</span>: <span class="hljs-number">2</span>,             <span class="hljs-comment">// 失败后自动重试 2 次</span>
      <span class="hljs-attr">staleTime</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span>, <span class="hljs-comment">// 数据 1 分钟内算“新鲜”，切回来也不刷新</span>
                            <span class="hljs-comment">// 超过 1 分钟后切回来，会触发自动刷新</span>
    },
  },
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RootLayout</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 注册 AppState 监听器</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 开始监听系统状态变化</span>
    <span class="hljs-keyword">const</span> subscription = <span class="hljs-title class_">AppState</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'change'</span>, onAppStateChange);
    
    <span class="hljs-comment">// 组件卸载时取消监听，这是防止内存泄漏的标准做法</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> subscription.<span class="hljs-title function_">remove</span>();
  }, []);

  <span class="hljs-keyword">return</span> (
    
      {<span class="hljs-comment">/* Slot 是 Expo Router 的页面入口 */</span>}
      
    
  );
}
</code></pre>
<hr/>
<h2 data-id="heading-4">三、 总结</h2>
<p>在 React Native 中使用 TanStack Query，<strong>90% 的人只做了“安装”，而忽略了“配置”</strong> 。</p>
<p>如果不配置这两个管理器，你的 App 就失去了灵魂：</p>
<ol>
<li><strong><code>AppStateStatus</code> + <code>focusManager</code></strong>：让 App 知道“<strong>我醒了</strong>”，从而实现微信切回来的自动刷新。</li>
<li><strong><code>setOnline</code> + <code>onlineManager</code></strong>：让 App 知道“<strong>我有网了</strong>”，从而实现走出电梯后的自动重连。</li>
</ol>
<p>只要在 <code>_layout.tsx</code> 中写好配置代码，你应用里所有的 <code>useQuery</code> 就都自动拥有了这些原生级别的感知能力。这就是从“能用”到“好用”的关键跨越。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从美团全栈化看 AI 冲击：前端转全栈，是自救还是必然 🤔🤔🤔]]></title>    <link>https://juejin.cn/post/7581999251368460340</link>    <guid>https://juejin.cn/post/7581999251368460340</guid>    <pubDate>2025-12-10T14:30:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581999251368460340" data-draft-id="7582036070159745024" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从美团全栈化看 AI 冲击：前端转全栈，是自救还是必然 🤔🤔🤔"/> <meta itemprop="keywords" content="前端,后端,面试"/> <meta itemprop="datePublished" content="2025-12-10T14:30:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Moment"/> <meta itemprop="url" content="https://juejin.cn/user/3782764966460398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从美团全栈化看 AI 冲击：前端转全栈，是自救还是必然 🤔🤔🤔
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782764966460398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Moment
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T14:30:11.000Z" title="Wed Dec 10 2025 14:30:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>我正在开发 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxun082%2FDocFlow" target="_blank" title="https://github.com/xun082/DocFlow" ref="nofollow noopener noreferrer">DocFlow</a>，它是一个完整的 AI 全栈协同文档平台。该项目融合了多个技术栈，包括基于 <code>Tiptap</code> 的富文本编辑器、<code>NestJs</code> 后端服务、<code>AI</code> 集成功能和实时协作。在开发过程中，我积累了丰富的实战经验，涵盖了 <code>Tiptap</code> 的深度定制、性能优化和协作功能的实现等核心难点。</p>
</blockquote>
<p>如果你对 AI 全栈开发、Tiptap 富文本编辑器定制或 DocFlow 项目的完整技术方案感兴趣，欢迎加我微信 <code>yunmz777</code> 进行私聊咨询，获取详细的技术分享和最佳实践。</p>
<p>据 <code>大厂日报</code> 称，美团履约团队近期正在推行"全栈化"转型。据悉，终端组的部分前端同学在 11 月末左右转到了后端组做全栈（前后端代码一起写），主要是 agent 相关项目。内部打听了一下，团子目前全栈开发还相对靠谱，上线把控比较严格。</p>
<p>这一消息在技术圈引起了广泛关注，也反映了 AI 时代下前端工程师向全栈转型的必然趋势。但更重要的是，我们需要深入思考：AI 到底给前端带来了什么冲击？为什么前端转全栈成为了必然选择？</p>
<p>最近，前端圈里不断有"前端已死"的话语流出。有人说 AI 工具会替代前端开发，有人说低代码平台会让前端失业，还有人说前端工程师的价值正在快速下降。这些声音虽然有些极端，但确实反映了 AI 时代前端面临的真实挑战。</p>
<h2 data-id="heading-0">一、AI 对前端的冲击：挑战与机遇并存</h2>
<h3 data-id="heading-1">1. 代码生成能力的冲击</h3>
<p>冲击点：</p>
<ul>
<li>低复杂度页面生成：AI 工具（如 Claude Code、Cursor）已经能够快速生成常见的 UI 组件、页面布局</li>
<li>重复性工作被替代：表单、列表、详情页等标准化页面，AI 生成效率远超人工</li>
<li>学习门槛降低：新手借助 AI 也能快速产出基础代码，前端"入门红利"消失</li>
</ul>
<p>影响：
传统前端开发中，大量时间花在"写页面"上。AI 的出现，让这部分工作变得极其高效，甚至可以说，只会写页面的前端工程师，价值正在快速下降。这也正是"前端已死"论调的主要依据之一。</p>
<h3 data-id="heading-2">2. 业务逻辑前移的冲击</h3>
<p>冲击点：</p>
<ul>
<li>AI Agent 项目激增：如美团案例中的 agent 相关项目，需要前后端一体化开发</li>
<li>实时交互需求：AI 应用的流式响应、实时对话，要求前后端紧密配合</li>
<li>数据流转复杂化：AI 模型调用、数据处理、状态管理，都需要全栈视角</li>
</ul>
<p>影响：
纯前端工程师在 AI 项目中往往只能负责 UI 层，无法深入业务逻辑。而 AI 项目的核心价值在于业务逻辑和数据处理，这恰恰是后端能力。</p>
<h3 data-id="heading-3">3. 技术栈边界的模糊</h3>
<p>冲击点：</p>
<ul>
<li>前后端一体化趋势：Next.js、Remix 等全栈框架兴起，前后端代码同仓库</li>
<li>Serverless 架构：边缘函数、API 路由，前端开发者需要理解后端逻辑</li>
<li>AI 服务集成：调用 AI API、处理流式数据、管理状态，都需要后端知识</li>
</ul>
<p>影响：
前端和后端的边界正在消失。只会前端的前端工程师，在 AI 时代会发现自己"够不着"核心业务。</p>
<h3 data-id="heading-4">4. 职业发展的天花板</h3>
<p>冲击点：</p>
<ul>
<li>技术深度要求：AI 项目需要理解数据流、算法逻辑、系统架构</li>
<li>业务理解能力：全栈开发者能更好地理解业务全貌，做出技术决策</li>
<li>团队协作效率：全栈开发者减少前后端沟通成本，提升交付效率</li>
</ul>
<p>影响：
在 AI 时代，只会前端的前端工程师，职业天花板明显。而全栈开发者能够：</p>
<ul>
<li>独立负责完整功能模块</li>
<li>深入理解业务逻辑</li>
<li>在技术决策中发挥更大作用</li>
</ul>
<h2 data-id="heading-5">二、为什么前端转全栈是必然选择？</h2>
<h3 data-id="heading-6">1. AI 项目的本质需求</h3>
<p>正如美团案例所示，AI 项目（特别是 Agent 项目）的特点：</p>
<ul>
<li>前后端代码一起写：业务逻辑复杂，需要前后端协同</li>
<li>数据流处理：AI 模型的输入输出、流式响应处理</li>
<li>状态管理复杂：对话状态、上下文管理、错误处理</li>
</ul>
<p>这些需求，纯前端工程师无法独立完成，必须掌握后端能力。</p>
<h3 data-id="heading-7">2. 技术发展的趋势</h3>
<ul>
<li>全栈框架普及：Next.js、Remix、SvelteKit 等，都在推动全栈开发</li>
<li>边缘计算兴起：Cloudflare Workers、Vercel Edge Functions，前端需要写后端逻辑</li>
<li>微前端 + 微服务：前后端一体化部署，降低系统复杂度</li>
</ul>
<h3 data-id="heading-8">3. 市场需求的转变</h3>
<ul>
<li>招聘要求变化：越来越多的岗位要求"全栈能力"</li>
<li>项目交付效率：全栈开发者能独立交付功能，减少沟通成本</li>
<li>技术决策能力：全栈开发者能更好地评估技术方案</li>
</ul>
<h2 data-id="heading-9">三、后端技术栈的选择：Node.js、Python、Go</h2>
<p>对于前端转全栈，后端技术栈的选择至关重要。不同技术栈有不同优势，需要根据项目需求选择。</p>
<h3 data-id="heading-10">1. Node.js + Nest.js：前端转全栈的最佳起点</h3>
<p>优势：</p>
<ul>
<li>零语言切换：JavaScript/TypeScript 前后端通用</li>
<li>生态统一：npm 包前后端共享，工具链一致</li>
<li>学习成本低：利用现有技能，快速上手</li>
<li>AI 集成友好：LangChain.js、OpenAI SDK 等完善支持</li>
</ul>
<p>适用场景：</p>
<ul>
<li>Web 应用后端</li>
<li>实时应用（WebSocket、SSE）</li>
<li>微服务架构</li>
<li>AI Agent 项目（如美团案例）</li>
</ul>
<p>学习路径：</p>
<ol>
<li>Node.js 基础（事件循环、模块系统）</li>
<li>Nest.js 框架（模块化、依赖注入）</li>
<li>数据库集成（TypeORM、Prisma）</li>
<li>AI 服务集成（OpenAI、流式处理）</li>
</ol>
<h3 data-id="heading-11">2. Python + FastAPI：AI 项目的首选</h3>
<p>优势：</p>
<ul>
<li>AI 生态最完善：OpenAI、LangChain、LlamaIndex 等原生支持</li>
<li>数据科学能力：NumPy、Pandas 等数据处理库</li>
<li>快速开发：语法简洁，开发效率高</li>
<li>模型部署：TensorFlow、PyTorch 等模型框架</li>
</ul>
<p>适用场景：</p>
<ul>
<li>AI/ML 项目</li>
<li>数据分析后端</li>
<li>科学计算服务</li>
<li>Agent 项目（需要复杂 AI 逻辑）</li>
</ul>
<p>学习路径：</p>
<ol>
<li>Python 基础（语法、数据结构）</li>
<li>FastAPI 框架（异步、类型提示）</li>
<li>AI 库集成（OpenAI、LangChain）</li>
<li>数据处理（Pandas、NumPy）</li>
</ol>
<h3 data-id="heading-12">3. Go：高性能场景的选择</h3>
<p>优势：</p>
<ul>
<li>性能优秀：编译型语言，执行效率高</li>
<li>并发能力强：Goroutine 并发模型</li>
<li>部署简单：单文件部署，资源占用少</li>
<li>云原生友好：Docker、Kubernetes 生态完善</li>
</ul>
<p>适用场景：</p>
<ul>
<li>高并发服务</li>
<li>微服务架构</li>
<li>云原生应用</li>
<li>性能敏感场景</li>
</ul>
<p>学习路径：</p>
<ol>
<li>Go 基础（语法、并发模型）</li>
<li>Web 框架（Gin、Echo）</li>
<li>数据库操作（GORM）</li>
<li>微服务开发</li>
</ol>
<h3 data-id="heading-13">4. 技术栈选择建议</h3>
<p>对于前端转全栈的开发者：</p>
<ol>
<li>
<p>首选 Node.js：如果目标是快速转全栈，Node.js 是最佳选择</p>
<ul>
<li>学习成本最低</li>
<li>前后端代码复用</li>
<li>适合大多数 Web 应用</li>
</ul>
</li>
<li>
<p>考虑 Python：如果专注 AI 项目</p>
<ul>
<li>AI 生态最完善</li>
<li>适合复杂 AI 逻辑</li>
<li>数据科学能力</li>
</ul>
</li>
<li>
<p>学习 Go：如果追求性能</p>
<ul>
<li>高并发场景</li>
<li>微服务架构</li>
<li>云原生应用</li>
</ul>
</li>
</ol>
<p>建议：</p>
<ul>
<li>第一阶段：选择 Node.js，快速转全栈</li>
<li>第二阶段：根据项目需求，学习 Python 或 Go</li>
<li>长期目标：掌握多种技术栈，根据场景选择</li>
</ul>
<h2 data-id="heading-14">四、总结</h2>
<p>AI 时代的到来，给前端带来了深刻冲击：</p>
<ol>
<li>代码生成能力：低复杂度页面生成被 AI 替代</li>
<li>业务逻辑前移：AI 项目需要前后端一体化</li>
<li>技术边界模糊：前后端边界正在消失</li>
<li>职业天花板：只会前端的前端工程师，发展受限</li>
</ol>
<p>前端转全栈，是 AI 时代的必然选择。</p>
<p>对于技术栈选择：</p>
<ul>
<li>Node.js：前端转全栈的最佳起点，学习成本低</li>
<li>Python：AI 项目的首选，生态完善</li>
<li>Go：高性能场景的选择，云原生友好</li>
</ul>
<p>正如美团的全栈化实践所示，全栈开发还相对靠谱，关键在于：</p>
<ul>
<li>选择合适的技术栈</li>
<li>建立严格的开发流程</li>
<li>持续学习和实践</li>
</ul>
<p>对于前端开发者来说，AI 时代既是挑战，也是机遇。转全栈，不仅能应对 AI 冲击，更能打开职业发展的新空间。那些"前端已死"的声音，其实是在提醒我们：只有不断进化，才能在这个时代立足。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[亲历外企裁员：上午还在写代码，下午工位就空了]]></title>    <link>https://juejin.cn/post/7582048028393144370</link>    <guid>https://juejin.cn/post/7582048028393144370</guid>    <pubDate>2025-12-10T15:03:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582048028393144370" data-draft-id="7581893894176473098" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="亲历外企裁员：上午还在写代码，下午工位就空了"/> <meta itemprop="keywords" content="程序员,面试,求职"/> <meta itemprop="datePublished" content="2025-12-10T15:03:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Konata_9"/> <meta itemprop="url" content="https://juejin.cn/user/888061123629997"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            亲历外企裁员：上午还在写代码，下午工位就空了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/888061123629997/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Konata_9
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T15:03:33.000Z" title="Wed Dec 10 2025 15:03:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/880839605848438f9804473043fa7eab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS29uYXRhXzk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765983813&amp;x-signature=reIjBJw%2BHfgqkvnA4V3NXxxTRdE%3D" alt="jimeng-2025-12-09-9499-现代办公室内部，冷色调，蓝色和灰色为主，空荡荡的工位，几台亮着的显示器，窗外是阴..._cleanup.png" loading="lazy"/></p>
<h2 data-id="heading-0">引子：不再是“主动的选择”</h2>
<p>记得 2018 年的时候，年轻与互联网的兴起，只要简历挂在求职 APP 上，立马就会有猎头或者 HR 来联系。在那时，离职通常伴随着的是薪资增长和职级的跃升。</p>
<p>那时候的我们，仿佛是在草原上逐水草而居的游牧民族，哪里水草丰美就去哪里，从未想过草原也会有枯黄的一天。</p>
<p>然而今天，我第一次以旁观者的身份，见证了一场并非出于自愿的离别。当大环境不再安定、当时代的红利退潮，裸泳的不仅是企业，还有每一个身处其中的个体。</p>
<h2 data-id="heading-1">现场：两小时的“消失术”</h2>
<p>早在一个月前，空气中就已经弥漫着不安的味道。或者说早在 HC（Headcount）冻结时，就已经埋下了伏笔。</p>
<p>11月的时候，一些原本该续签的合同被搁置，那时候我们就知道，暴风雨要来了。但我没想到，它来得如此迅猛且安静。</p>
<p>早上 9 点，无意间瞥见 Leader 们聚在一间会议室中开会。原以为是他们的例会，没曾想会是裁员的开始键：</p>
<p>Leader 谈话 -&gt; 确认赔偿 -&gt; 签字 -&gt; 交还电脑 -&gt; 离开。</p>
<p>这场“斩首行动”持续了不到两个小时，迅速且安静。整个过程持续到了上午 11 点，尘埃落定。整个部门合计少了四分之一的人。</p>
<p>外企的体面在这一刻展现得淋漓尽致，同时也冷酷得令人心惊。没有多余的废话，只有流程和结果。前一分钟还在和我说要修 CI 错误的同事，后一分钟工位就已经回来和我们告别了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01d87d8803d641c88b9d35d15b92d0db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS29uYXRhXzk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765983813&amp;x-signature=R6hhlK08SlzoNNQHm%2Bcp7iDlDpA%3D" alt="jimeng-2025-12-09-6938-咖啡厅的一角，桌上放着两杯咖啡，模糊的背景是繁华的城市CBD，透过玻璃窗看外面，..._cleanup.png" loading="lazy"/></p>
<h2 data-id="heading-2">午餐：焦虑的泡沫</h2>
<p>中午，“幸存”下来的同事不约而同地一起去吃饭。</p>
<p>话题不再是往日的“最近哪个 AI 技术栈很火”、“哪个 Node.js 的库可以用到项目里”，而是变成了“现在出去了能做什么”、“还会有下一波吗”。</p>
<p>谈到赔偿，由于不方便透露，只能算是“中规中矩”。即不会像佳能那样上新闻，也不会闹到仲裁。</p>
<p>在六七年前，这笔钱可能是一笔快乐的旅游基金；而在当下的环境中，它更像是一笔“过冬费”，是面对未知的漫长寒冬时，手里仅有的一点余粮。</p>
<p>吃完饭后，大家也是心照不宣地散着步。专门挑了太阳最大的地方走了好久，仿佛可以驱散身上的寒气。</p>
<p>但我们都清楚，我们这些留下来的人，也没有太多庆幸。更多的是一种“兔死狐悲”的无力感。谁也不知道，下一次名单上会不会有自己的名字。</p>
<h2 data-id="heading-3">下午：沉默的办公室</h2>
<p>回到工位，工作还得继续。代码还在那里，Bug 还没修完，PR 还等着 Merge。</p>
<p>但当看到 PR 中那些点了 Approve 或者留下 Comments 的“前”同事的头像，竟有一丝不想 Merge 的冲动。</p>
<p>发生了这么大的事情后，办公室的氛围自然变了。往常到了下班点，大家可能还会为了赶进度再多待一会儿或者一起聊会天。但今天，一到时间，Leader 们就示意大家早点回去，不要再加班了。</p>
<p>这不仅是一种体恤，更像是一种无声的宣告：当“努力”已经无法对抗“趋势”时，大家默契地选择了“节能模式”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/596a116a9413405193ac5f31db691cc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS29uYXRhXzk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765983813&amp;x-signature=SUJthrxWEZFvtxHGMilMp4LAF8w%3D" alt="jimeng-2025-12-09-2436-一个人孤独地站在高楼的落地窗前，背影，俯瞰着下面繁忙但渺小的城市车流，夕阳西下或..._cleanup.png" loading="lazy"/></p>
<h2 data-id="heading-4">结语</h2>
<p>古人云：“山雨欲来风满楼”。今天的这场裁员，或许只是时代大潮中的一朵浪花。</p>
<p>外企曾经是我们心中的避风港，意味着高薪、体面、Work-Life Balance。但今天的一切告诉我们，在这个充满不确定性的时代，没有绝对的安全岛。</p>
<p>对于我们每一个技术人来说，或许是时候重新审视自己的核心竞争力了。当大潮退去，我们手里握着的，究竟是可以随时变现的技能，还是一张随时可能失效的工牌？</p>
<p>最后的最后，我想说我们组本来人也不多，大家关系也都很好，平时说说笑笑也很开心。衷心祝愿他们能在后面的日子顺利。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[css的臂膀，前端动效的利器，还是布局的“隐形陷阱”？]]></title>    <link>https://juejin.cn/post/7582016579857989666</link>    <guid>https://juejin.cn/post/7582016579857989666</guid>    <pubDate>2025-12-10T13:07:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582016579857989666" data-draft-id="7582016579857973282" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="css的臂膀，前端动效的利器，还是布局的“隐形陷阱”？"/> <meta itemprop="keywords" content="前端,CSS,HTML"/> <meta itemprop="datePublished" content="2025-12-10T13:07:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="胡gh"/> <meta itemprop="url" content="https://juejin.cn/user/494101298678516"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            css的臂膀，前端动效的利器，还是布局的“隐形陷阱”？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/494101298678516/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    胡gh
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T13:07:47.000Z" title="Wed Dec 10 2025 13:07:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h3 data-id="heading-0">前言</h3>
<p>在现代 Web 开发中，<code>transform</code> 几乎成了动效与居中的代名词。它高效、灵活、支持硬件加速，一句 <code>transform: translate(-50%, -50%)</code> 就能优雅实现未知尺寸元素的绝对居中——这曾是多少前端开发者梦寐以求的解决方案。然而，在赞美其强大之余，我们是否忽略了它那“温柔面具”下的另一面？<strong><code>transform</code> 不仅改变视觉，更悄然重塑了 CSS 的底层规则——尤其是与 <code>position</code> 的交互，常常成为布局崩坏的隐形元凶。</strong></p>
<hr/>
<h3 data-id="heading-1">一、<code>transform</code> 的“理想面”：高效、无侵入、表现力强</h3>
<h4 data-id="heading-2">核心优势：不扰动文档流</h4>
<p>这是 <code>transform</code> 最被称道的特性：<strong>它只作用于合成层（compositing layer），不影响文档流中的占位</strong>。<br/>
对比传统方案：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 低效：触发重排（reflow） */</span>
<span class="hljs-selector-class">.box</span> { <span class="hljs-attribute">top</span>: <span class="hljs-number">10px</span>; <span class="hljs-attribute">left</span>: <span class="hljs-number">20px</span>; }

<span class="hljs-comment">/* 高效：仅触发合成（compositing） */</span>
<span class="hljs-selector-class">.box</span> { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(<span class="hljs-number">20px</span>, <span class="hljs-number">10px</span>); }
</code></pre>
<p>前者会迫使浏览器重新计算整个布局树，而后者直接由 GPU 处理，帧率更高、能耗更低。</p>
<h4 data-id="heading-3">经典用例：绝对居中</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.centered</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
}
</code></pre>
<ul>
<li><strong>无需知道宽高</strong>：<code>-50%</code> 基于元素自身尺寸，完美适配动态内容。</li>
<li><strong>语义清晰</strong>：意图明确，代码简洁。</li>
<li><strong>性能优异</strong>：远胜 <code>margin: auto</code> 或 <code>calc()</code> 方案。</li>
</ul>
<h4 data-id="heading-4">交互增强：微动效提升体验</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.card</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">4px</span>) <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.02</span>);
  <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.2s</span> ease;
}
</code></pre>
<p>这种“浮起”效果已成为现代 UI 的标配，而 <code>transform</code> 是实现它的最佳载体。</p>
<hr/>
<h3 data-id="heading-5">二、<code>transform</code> 的“暗面”：当它遇上 <code>position</code></h3>
<p>问题来了：<strong>如果 <code>transform</code> 如此美好，为何无数开发者在使用 Modal、Tooltip 时遭遇“fixed 元素跟着滚动”的诡异现象？</strong></p>
<p>答案就藏在 CSS 规范的一个角落里：</p>
<blockquote>
<p><strong>“任何非 <code>none</code> 的 <code>transform</code> 值，都会使该元素成为其 <code>position: fixed</code> 后代的包含块（containing block）。”</strong></p>
</blockquote>
<p>这意味着：<strong><code>fixed</code> 元素的定位参考系，不再是视口，而是最近的带 <code>transform</code> 的祖先！</strong></p>
<h4 data-id="heading-6">实例：一个“失效”的固定导航栏</h4>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"app"</span>&gt;
  &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"animated-section"</span>&gt; 
    &lt;nav <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar"</span>&gt;我是导航栏&lt;/nav&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.animated-section</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">/* 哪怕是“无操作”变换！ */</span>
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200vh</span>; <span class="hljs-comment">/* 足够滚动 */</span>
}

<span class="hljs-selector-class">.navbar</span> {
  <span class="hljs-attribute">position</span>: fixed;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">background</span>: black;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">1000</span>;
}
</code></pre>
<p><strong>预期行为</strong>：导航栏固定在顶部，页面滚动时不动。<br/>
<strong>实际行为</strong>：导航栏随 <code>.animated-section</code> 一起滚动！</p>
<blockquote>
<p><strong>原因</strong>：<code>.animated-section</code> 因 <code>transform</code> 成为新的包含块，<code>fixed</code> 的 <code>top: 0</code> 变成了“相对于该容器顶部”，而非视口。</p>
</blockquote>
<p>这并非浏览器 bug，而是 <strong>CSS 规范的明确设计</strong>。但对开发者而言，这却是一个典型的“符合规范但违背直觉”的陷阱。</p>
<hr/>
<h2 data-id="heading-7">补充</h2>
<hr/>
<h5 data-id="heading-8">关键补充属性</h5>
<h6 data-id="heading-9">1. <code>transform-origin</code>：修改变换原点</h6>
<p>默认变换原点是元素中心（<code>50% 50%</code> 或 <code>center center</code>），可通过该属性自定义：</p>
<ul>
<li>
<p>语法：<code>transform-origin: x y;</code>（x/y 支持 px、%、关键字（left/right/top/bottom/center））；</p>
</li>
<li>
<p>示例：</p>
<p>css</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotate</span>(<span class="hljs-number">45deg</span>);
  <span class="hljs-attribute">transform-origin</span>: left top; <span class="hljs-comment">/* 绕左上角旋转 */</span>
}
</code></pre>
</li>
</ul>
<h6 data-id="heading-10">2. <code>transform-style</code>：3D 变换层级</h6>
<p>当使用 3D 变换（如 <code>rotateX/rotateY</code>）时，需设置该属性让子元素继承 3D 空间：</p>
<ul>
<li><code>transform-style: preserve-3d;</code>：保留 3D 变换效果（常用）；</li>
<li><code>transform-style: flat;</code>：默认值，子元素扁平化到 2D 平面。</li>
</ul>
<hr/>
<h3 data-id="heading-11">三、不止 <code>transform</code>：<code>filter</code> 与 <code>perspective</code> 的共谋</h3>
<p>更令人头疼的是，<strong><code>transform</code> 并非孤例</strong>。以下属性同样会创建新的包含块：</p>
<ul>
<li><code>filter: blur(0)</code>（哪怕无视觉变化）</li>
<li><code>perspective: 1000px</code></li>
<li><code>will-change: transform</code></li>
</ul>
<p>它们常被用于：</p>
<ul>
<li>动画库（Framer Motion、GSAP）自动注入 <code>transform</code></li>
<li>组件库内部使用 <code>filter</code> 实现毛玻璃效果</li>
<li>3D 卡片组件启用 <code>perspective</code></li>
</ul>
<p>结果就是：<strong>你的 <code>fixed</code> Modal 突然无法覆盖全屏，Tooltip 错位，悬浮按钮失效……</strong></p>
<hr/>
<h3 data-id="heading-12">四、反思：我们是否过度依赖 <code>transform</code>？</h3>
<p><code>transform</code> 的流行，某种程度上掩盖了我们对 CSS 布局模型理解的不足。我们习惯性地用它解决一切位置问题，却忘了问：</p>
<blockquote>
<p><strong>“这个元素真的需要脱离文档流吗？它的祖先是否干净？”</strong></p>
</blockquote>
<p>在 React/Vue 等组件化框架中，问题被进一步放大：</p>
<ul>
<li>组件嵌套深，难以追踪哪个祖先加了 <code>transform</code></li>
<li>第三方库内部实现不可控</li>
<li>动画与布局逻辑耦合，调试困难</li>
</ul>
<p>于是，<code>transform</code> 从“解决方案”变成了“问题源头”。</p>
<hr/>
<h3 data-id="heading-13">五、破局之道：理性使用 + 架构规避</h3>
<h4 data-id="heading-14">1. <strong>浮层组件必须脱离当前上下文</strong></h4>
<p>在 React 中，<strong>永远使用 <code>ReactDOM.createPortal</code> 渲染 Modal/Toast/Dropdown</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Modal</span> = (<span class="hljs-params">{ children }</span>) =&gt; 
  <span class="hljs-title function_">createPortal</span>(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>,
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>
  );
</code></pre>
<p>这样可确保其祖先无 <code>transform</code>，<code>fixed</code> 行为符合预期。</p>
<h4 data-id="heading-15">2. <strong>避免在可能包含浮层的区域使用 <code>transform</code></strong></h4>
<ul>
<li>导航区域、主内容区慎用动画</li>
<li>若必须用，确保浮层不在其子树中</li>
</ul>
<h4 data-id="heading-16">3. <strong>调试时牢记“包含块”概念</strong></h4>
<p>当 <code>fixed</code> 行为异常，立即检查：</p>
<ul>
<li>所有祖先是否有 <code>transform</code> / <code>filter</code> / <code>perspective</code></li>
<li>是否意外创建了层叠上下文</li>
</ul>
<hr/>
<h3 data-id="heading-17">结语：工具无善恶，认知定成败</h3>
<p><code>transform</code> 本身并无过错。它是 CSS 进化的重要里程碑，极大提升了 Web 的表现力与性能。<br/>
<strong>真正的风险，来自于我们对其副作用的无知，以及对“简单一行代码就能解决问题”的盲目信任。</strong></p>
<p>前端开发不仅是写代码，更是理解系统。当我们熟练运用 <code>transform: translate(-50%, -50%)</code> 的同时，也应深知：</p>
<blockquote>
<p><strong>每一个看似优雅的解决方案背后，都有一套严密的规则在运行。忽视规则，终将被规则反噬。</strong></p>
</blockquote>
<p>因此，请继续热爱 <code>transform</code>，但请带着敬畏之心使用它——尤其是在与 <code>position</code> 共舞之时。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文讲清：AI大模型预训练与后训练的数据选择]]></title>    <link>https://juejin.cn/post/7581893894176325642</link>    <guid>https://juejin.cn/post/7581893894176325642</guid>    <pubDate>2025-12-10T13:07:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581893894176325642" data-draft-id="7582063437413728294" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文讲清：AI大模型预训练与后训练的数据选择"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-12-10T13:07:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文讲清：AI大模型预训练与后训练的数据选择
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T13:07:25.000Z" title="Wed Dec 10 2025 13:07:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>一、预训练的数据选择</strong></p>
<p><strong>模型影响力驱动（Influence / Importance-based Selection）</strong></p>
<p>MATES: Model-Aware Data Selection for Efficient Pretraining with Data Influence Models</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de65d2c485d0479291b89d50a8bcec2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=hyHRbLGFgx1axPSY1ir5Nx3LXvw%3D" alt="图片" loading="lazy"/></p>
<p>MATES创新性地设计了一种动态适应模型需求的数据筛选机制。</p>
<p>区别于传统静态过滤方法，该研究指出模型在训练进程中会持续改变对不同数据特征的"偏好倾向"，因此数据筛选策略需实现与训练进度的同步动态优化。</p>
<p>其方法论核心在于建立"数据价值评估模型"。</p>
<p>实施流程包含：训练周期内通过周期性探测（probe）量化各数据样本对模型性能的实际贡献度，利用该评估结果训练轻量级预测模型，进而预判海量语料中每项数据的潜在价值权重。</p>
<p>在后续训练阶段中，系统将优先采用预测价值较高的数据样本。</p>
<p>跨多种规模语言模型的验证实验显示，相较于随机采样或静态规则过滤，MATES在多项任务中实现平均性能的显著提升，且达成同等性能所需的计算资源可降低约50%。</p>
<p>该成果证实：基于模型实时状态的动态数据筛选机制，相比固定规则策略具有显著优势，代表了预训练数据管理技术的重要发展方向。</p>
<p><strong>更多AI大模型学习视频及资源，都在<a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</strong></p>
<p><strong>质量 + 多样性平衡（Quality–Diversity Joint Methods）</strong></p>
<p>Harnessing Diversity for Important Data Selection in Pretraining Large Language Models</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13c87bdc62a3490b96d3f030ee5977c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=q6YXg%2Bc4CCJmBxMKTNAm3ysOdLI%3D" alt="图片" loading="lazy"/></p>
<p>这篇论文聚焦于一个经典却易被忽略的挑战：仅依据"重要性"（如影响力或质量）筛选数据，往往会导致所选数据在语言风格、知识领域和语义分布上呈现高度同质化，进而削弱模型的泛化性能。</p>
<p>研究者提出的Quad方法创新性地通过同步优化数据的重要性和多样性来应对这一难题。</p>
<p>该方法首先采用高效的反向Hessian计算技术，量化每条数据对模型训练的影响权重。随后将语料库基于语义表示划分为多个簇，每个簇被建模为多臂赌博机问题中的一个独立"臂"。</p>
<p>在数据选择过程中，算法不仅优先筛选高影响力数据，还会主动挖掘那些被低频选择却具备潜在价值的簇，从而确保数据集的整体多样性。</p>
<p>实验验证显示，Quad在多个基准测试中均优于传统数据选择方法，并能显著增强模型的零样本学习能力。</p>
<p>该研究有力证明了在预训练数据筛选中，多样性与质量具有同等关键价值，同时提供了一个兼具可扩展性和实用性的解决方案。</p>
<p>QuaDMix: Quality–Diversity Balanced Data Selection for Efficient LLM Pretraining</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13c796dac68845f48d56d62749c9ed58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=VuWC0tGKta%2Fhq%2FNfLzdcvnc7MIQ%3D" alt="图片" loading="lazy"/></p>
<p>QuaDMix 的研究表明，在预训练数据选择中，"质量"与"多样性"的传统独立处理方式会导致显著失衡，典型表现为高质量数据在特定领域的过度集中。</p>
<p>针对这一问题，QuaDMix 创新性地开发了一个集成框架，通过参数化采样分布同步整合两个关键维度。</p>
<p>该方法实施包含三个核心步骤：</p>
<p><strong>‌多维质量评估‌</strong>：对每项数据实施语言流畅性、文本复杂度及数据清洁度等多元指标量化</p>
<p><strong>‌领域特征标注‌</strong>：采用分类算法明确数据所属领域类别</p>
<p><strong>‌动态采样机制‌</strong>：基于"质量向量+领域标签"的复合函数计算采样概率，并通过小规模实验优化参数配置</p>
<p>实验数据证实，相较于单一优化质量或多样性的基准方法，QuaDMix 的协同优化策略在跨任务测试中实现了7%以上的性能增益。</p>
<p>这一成果验证了质量-多样性统一框架在数据筛选中的优越性。</p>
<p>Learning from the Best, Differently: A Diversity-Driven Rethinking on Data Selection</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2b3bbeff73a4e0f8dbf142d6d4166ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=CV6UCRHgtryOCro35jyGTg8nAdA%3D" alt="图片" loading="lazy"/></p>
<p>这篇论文对数据筛选的常规方法——"按评分排序并选取前k名（最高分数据）"——提出了质疑。</p>
<p>作者指出，该方法的局限性在于：评分体系往往融合了多个关联维度（如语言质量、知识密度、语义复杂度等），导致高分数据虽然在综合评分上表现优异，却容易在多个维度上呈现高度趋同，造成数据多样性的显著不足。</p>
<p>尤为严重的是，这种单一化的筛选策略甚至可能损害下游任务的表现。</p>
<p>针对这一问题，研究团队创新性地提出了ODiS（正交多样性感知选择框架）。其核心流程包括：</p>
<p>1）对数据进行多维度评估，涵盖语言质量（language quality）、知识/事实质量（knowledge quality）、语义理解难度（comprehension difficulty）等关键指标；</p>
<p>2）通过主成分分析（PCA）实现维度正交化处理，消除各维度间的相关性，确保特征独立性；</p>
<p>3）为每个正交维度训练独立评分模型，将PCA投影得分回归到数据层面，实现大规模语料的快速评分。</p>
<p>在构建训练集时，该方法并非简单选取总体评分最高的数据，而是从每个正交维度分别筛选高分数据（或按比例采样），从而既保证多维覆盖又维持数据多样性（因不同维度的最优数据通常具有差异性）。</p>
<p>实验结果表明，采用ODiS筛选的数据训练的模型，在多个下游任务中均显著优于传统单一评分基准。研究特别发现，当维度间重叠率被控制在2%以下时，模型性能表现更为稳定优异。</p>
<p>该研究的理论价值在于：颠覆了"高分即优质训练数据"的传统认知，系统论证了通过细分质量指标和主动引入多样性来提升模型泛化能力的重要性，而非盲目追求总分最高的数据。</p>
<p><strong>多策略集成驱动（Collaborative / Ensemble Methods）</strong></p>
<p>Efficient Pretraining Data Selection via Multi-Actor Collaboration</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/442a3c20bc3646a0965321aacd9df5a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=th9AaVcWWJqTYBORzdv7FgZ8yrk%3D" alt="图片" loading="lazy"/></p>
<p>当前数据选择领域已发展出多种先进方法论（质量导向/影响力导向/多样性感知/领域混合等），如何通过协同整合这些方法以最大化优势并规避潜在矛盾？</p>
<p>研究团队创新性地设计了多智能体协同的数据筛选框架。</p>
<p>将各类数据选择策略视为独立运行的"智能体"：例如，质量过滤智能体(quality filtering)专注数据纯度，多样性智能体(diversity)维护样本分布均衡。</p>
<p>影响力智能体(influence)评估数据对模型的关键作用，领域混合智能体(domain mixing)优化跨领域数据配比。</p>
<p>在预训练过程中，各智能体会基于实时模型状态动态更新其优先级规则（即根据当前模型性能自适应调整数据偏好）。</p>
<p>中央调度器则通过动态分配各智能体权重（决定不同训练阶段的主导策略），实现多维度信号的有效融合。</p>
<p>实验验证表明，相较于单一方法或固定组合策略，该多智能体协同机制不仅能显著提升预训练收敛速度，更在数据利用率上实现突破性改进。</p>
<p>这项工作为数据选择提供了更具适应性的系统化方案：无需局限于特定策略的取舍，而是将多元策略构建为专家协作网络，使系统能够自主选择与模型状态最优匹配的方法组合。</p>
<p><strong>结构化知识/技能驱动（Skill- or Structure-aware Selection）</strong></p>
<p>MASS: Mathematical Data Selection via Skill Graphs</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/969d8e08404949589305de22c79a34b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=oGodgvOx%2BOlAZG2NwQPtf7FGICg%3D" alt="图片" loading="lazy"/></p>
<p>MASS 的核心创新在于数学与推理领域预训练数据的筛选机制。</p>
<p>研究团队指出，数学文本蕴含独特的结构特征与技能关联性，传统通用过滤方法难以精准识别这些特性。</p>
<p>为此，MASS 创新性地引入"技能图谱"（skill graph）框架，通过可视化数学能力间的拓扑关系实现数据价值量化评估。</p>
<p>该方法实施分为三个关键步骤：</p>
<p>1）从权威数学资源中提取基础数学技能（如代数、几何、微积分、证明推理等），建立以技能为节点、依赖关系为边的知识图谱；</p>
<p>2）对候选数学文本进行技能成分分析，将其与图谱进行匹配，综合计算覆盖技能的数量、层级权重和关键性指标；</p>
<p>3）依据多维评分体系对数据排序，筛选出对模型数学能力提升最具针对性的数据子集。</p>
<p>实验结果表明，采用MASS筛选数据的模型在数学推理任务中表现全面超越基准模型，尤其在数据规模缩减50%-70%的条件下，仍能实现4%-6%的性能提升。</p>
<p>这一验证充分证明，基于领域知识构建结构化技能图谱并指导数据选择，是优化模型专业能力的有效范式。</p>
<p><strong>任务相关性驱动（Task-aware Data Selection）</strong></p>
<p>Language Models Improve When Pretraining Data Matches Target Tasks</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37605e64ca58451ea2cdd17989d51506~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=tKW7AwvqwlFhUXK%2F%2F5qQ0muM1Vw%3D" alt="图片" loading="lazy"/></p>
<p>该研究聚焦于预训练语言模型的核心问题：当训练数据分布与目标任务高度一致时，模型性能能否实现显著优化。</p>
<p>研究者创新性地提出了一种高效数据筛选框架BETR（Benchmark-Targeted Ranking）</p>
<p>其核心机制包含三个步骤：首先将目标任务样本与预训练数据子集进行向量空间对齐，通过相似度计算建立初始排序；</p>
<p>继而借助轻量分类器将排序策略泛化至全量语料库；最终筛选出与目标任务分布匹配度最高的训练数据。</p>
<p>通过构建数百个实验模型并验证不同数据规模下的scaling law，研究发现BETR筛选的数据可使计算效率提升2倍以上，且模型表现显著优于原始数据或基础过滤方法。</p>
<p>在目标benchmark与下游任务存在分布偏移的场景中，BETR仍能保持与基准数据相当甚至更优的性能。</p>
<p>研究明确证实：预训练数据与任务需求的分布匹配度较数据规模更具决定性影响。采用可扩展的轻量级任务相关性排序方法，能够在维持计算成本的前提下显著提升模型质量。</p>
<p><strong>二、后训练的数据选择</strong></p>
<p><strong>在线和离线数据选择结合</strong></p>
<p>Towards High Data Efficiency in Reinforcement Learning with Verifiable Reward</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/771460e406224dfaa535fdb096ad1ef0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=LpLDTWJIQhwE8Ef%2BAhn7KlK2n78%3D" alt="图片" loading="lazy"/></p>
<p><strong>‌动机‌</strong></p>
<p>当前RLVR方法依赖增加训练数据规模与rollout数量来增强模型推理能力，但这一方式显著提升了训练成本（计算资源消耗、时间投入）并降低了数据利用效率。</p>
<p>‌离线数据选择‌的局限性体现在：传统方法需在全量数据集上训练以评估数据选择指标（如奖励趋势分析、梯度对齐），计算负担沉重；或仅关注单一维度（如样本难度过滤），忽视样本间的关联性。</p>
<p>‌在线rollout效率问题‌：现有方法（以GRESO为例）仅能对零方差样本进行粗略筛选，无法有效识别具有高探索潜力的样本，导致大量计算资源被低贡献样本占用。</p>
<p><strong>‌方法‌</strong></p>
<p><strong>‌多维度离线数据筛选框架‌</strong></p>
<p>1.1 采用LLM最终层token嵌入构建样本表征空间，基于余弦相似度建立相似度图网络。</p>
<p>1.2 通过PageRank权重与行列式点过程协同优化，实现子集多样性与影响力的联合最大化。</p>
<p>1.3 对初步筛选后的子集执行策略离线rollout，以样本准确率量化难度指标，并按正态分布优先选取中等难度样本。</p>
<p><strong>‌基于熵的在线rollout优化机制‌</strong></p>
<p>2.1 设计滑动窗口内历史熵与优势函数的动态加权指标，精准识别高探索潜力样本进行在线rollout。</p>
<p>2.2 实施动态样本重放策略，确保训练覆盖所有样本的充分学习。</p>
<p><strong>‌实验验证‌</strong></p>
<p>该方法仅需20%数据即可达到全量训练性能，同时实现训练耗时降低40%、rollout数量减少60%的优化效果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ccec261439942269fda3a9fb5e03dc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=rLxwhr5NnMVXiaD51nfyH1Oz1OQ%3D" alt="图片" loading="lazy"/></p>
<p>本文在三个模型和五个推理数据集上都进行了详细的实验，实验结果表明 DEPO 在各个数据集上都展现出强大的性能和效率优势。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38cf6f8dd5d0485d9f1fe9915fdd30cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=FUQEzJitAgyWT8AP5m9%2BVXVzwfQ%3D" alt="图片" loading="lazy"/></p>
<p><strong>在线数据选择</strong></p>
<p>Act Only When It Pays: Efficient Reinforcement Learning for LLM Reasoning via Selective Rollouts</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b43327d7e226433ebc50ebfd7ed1554b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=YLL47yKGQdvZokosQQh1LIxmylw%3D" alt="图片" loading="lazy"/></p>
<p>论文分析了提示在不同训练epoch中的奖励动态，发现零方差提示（即所有响应的奖励都相同的提示）在训练过程中具有很强的时间一致性。</p>
<p>自适应调整探索概率：采用了一种自适应机制来自动调整探索概率，根据目标零方差比例和实际观察到的零方差比例动态调整探索概率。</p>
<p>自适应采样批次大小：如果当前批次中有效提示的数量不足，算法会根据需要动态调整采样批次大小。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/856319c7d68d4dd1a640ec2fd06cb7f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=RSxm9lAghAbIKtLGNkNwjeD17lI%3D" alt="图片" loading="lazy"/></p>
<p><strong>离线数据选择</strong></p>
<p>LearnAlign: Reasoning Data Selection for Reinforcement Learning in Large Language Models Based on Improved Gradient Alignment</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a97f74c1a7a4ce684ebb9495d1923ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=xcJMr8AeGO64GeSgZSfXBUX8w%2Fw%3D" alt="图片" loading="lazy"/></p>
<p>‌梯度对齐‌：研究通过一阶泰勒展开近似模型参数更新对损失函数的作用，将数据点间的影响力量化为两者梯度的内积值。</p>
<p>‌可学性‌：采用成功概率作为评估指标，表征数据点对模型性能优化的潜在贡献度。</p>
<p>‌LearnAlign分数‌：综合数据可学性与梯度对齐结果，生成该分数以量化数据点间的相似性及学习价值。</p>
<p><strong>‌数据筛选流程‌</strong></p>
<p>‌预热训练‌：随机抽取训练数据的小规模子集进行初始训练，为梯度估计提供稳定基础。</p>
<p>‌梯度信息处理‌：在预热阶段计算各数据点梯度，并通过随机投影实现降维。</p>
<p>‌分数矩阵构建‌：基于降维梯度数据，计算所有数据点对的LearnAlign分数，形成完整矩阵。</p>
<p>‌最终筛选‌：依据矩阵均值排序，选取得分最高的前N个数据点作为最优子集。</p>
<p>Reinforcement Learning for Reasoning in Large Language Models with One Training Example</p>
<p>论文提出了“1-shot RLVR”的概念，旨在探究仅使用一个训练样本是否能够实现与使用大规模数据集相当的性能提升。</p>
<p>通过分析训练样本的历史方差得分，选择具有最高方差的样本作为训练数据。这种方法基于假设高方差样本在训练过程中可能提供更丰富的信息。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9795239bddf74e709670bb169d0848b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=g9YiJRwxXKU3Z9YEw0boP8tKG80%3D" alt="图片" loading="lazy"/></p>
<p>LIMR: Less is More for RL Scaling</p>
<p>以模型平均奖励曲线为基准，衡量单个样本学习轨迹与整体学习轨迹的匹配度。</p>
<p>通过归一化对齐分数评估样本对模型学习的贡献值，分数越高表明样本与模型学习路径的一致性越强，其对模型优化的促进作用也越显著。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8170c65a789c421b8f27c66e299d842e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=iPghKIwEdsUL%2BSJs334GpfI0J3o%3D" alt="图片" loading="lazy"/></p>
<p>Data-Efficient RLVR via Off-Policy Influence Guidance</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1216d58140fb47e491c23af134717135~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=zsWsQftE0bhZWdPBLqgvSTjwO%2BI%3D" alt="图片" loading="lazy"/></p>
<p><strong>理论扩展与方法创新‌</strong></p>
<p>将监督学习的影响函数理论推广至RLVR领域，建立训练样本对策略性能影响的一阶近似量化模型。</p>
<p>通过离策略估计技术，利用行为策略生成的离线轨迹替代实时策略梯度计算，实现完全离线化的高效训练流程。</p>
<p><strong>‌计算优化技术‌</strong></p>
<p>采用稀疏随机投影方法，在梯度运算前通过随机维度丢弃与低维变换，显著减少存储需求与计算复杂度，同时实验表明该方法能有效保持向量内积的排序特性。</p>
<p><strong>‌框架设计与应用‌</strong></p>
<p>基于上述理论构建多阶段课程学习系统CROPI，框架通过动态筛选验证集影响力最大的数据子集，分阶段实施GRPO算法更新策略，实现高效渐进式学习。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c34bc180b4bb4e8d9bf1212b95461197~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765976845&amp;x-signature=j%2Bhvq41q0e%2F2YrzWBTAiLAzuDmI%3D" alt="图片" loading="lazy"/></p>
<p>‌第一阶段‌：采用9k道均衡难度题目，每道题执行8次rollout训练，总序列长度24k，有效避免模型陷入模式固化；</p>
<p>‌第二阶段‌：筛选极端困难样本，通过64次rollout的阶梯式训练（分三阶段逐步强化），不断推动模型突破性能极限。</p>
<p><strong>更多AI大模型学习视频及资源，都在<a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[离开舒适区100天，我后悔了吗？]]></title>    <link>https://juejin.cn/post/7582021506190327854</link>    <guid>https://juejin.cn/post/7582021506190327854</guid>    <pubDate>2025-12-10T13:16:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582021506190327854" data-draft-id="7581995152190963754" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="离开舒适区100天，我后悔了吗？"/> <meta itemprop="keywords" content="前端,后端,面试"/> <meta itemprop="datePublished" content="2025-12-10T13:16:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="优弧"/> <meta itemprop="url" content="https://juejin.cn/user/852876722177533"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            离开舒适区100天，我后悔了吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/852876722177533/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    优弧
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T13:16:40.000Z" title="Wed Dec 10 2025 13:16:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>各位朋友好，我是优弧。今天想用一种轻松的方式，记录一个小小的里程碑：<strong>我来到新部门，已经满100天了。</strong></p>
<p>如果把职场比作一段旅程，这100天像是从一条熟悉的主路，转入了一条全新的小径。风景不同，路况也迥异。过去，我更多是在既定方向里把事情做深做透；如今，则像是在一片新的地基上，一砖一瓦地搭建起"规则、方法与节奏"。</p>
<p>我现在所在的团队，从事的是<strong>数据标注与评测</strong>相关工作。很多人一听"标注"，第一反应是"是不是就是打标签？"——我最初也是这么想的。但真正深入之后才发现：它更像是把人类的判断，转化为一套清晰、一致、可复用的"语言"。这些语言会凝结成数据，数据会塑造模型，模型再反过来影响产品体验。它不张扬，却至关重要。</p>
<hr/>
<h2 data-id="heading-0"><strong>这100天，我主要做了三件事</strong></h2>
<p><strong>第一件：把模糊变清晰。</strong></p>
<p>新方向里，最常见的困难不是"做不出来"，而是"大家以为理解一致，其实各有各的理解"。所以我花了大量时间做"对齐"——把需求写清楚，把边界讲明白，把容易产生歧义的地方用具体案例固定下来。</p>
<p>这件事看似不起眼，却能让后来的人少走许多弯路。</p>
<p><strong>第二件：把事情做得更稳。</strong></p>
<p>在这里，"做完"不是终点，"能稳定交付"才是。</p>
<p>我参与梳理流程、完善检查机制，也会和一线同事一起复盘：哪里最容易出错？是规则没讲清楚，还是样例不够充分，还是工具设计让人产生误解？</p>
<p>我们在努力把"靠经验"变成"靠机制"，把"凭感觉"变成"有共识"。</p>
<p><strong>第三件：把经验沉淀下来。</strong></p>
<p>我越来越相信一个朴素的道理：<strong>团队的效率，很大程度上取决于能否把经验写下来、传下去、复用起来。</strong></p>
<p>所以这段时间，我持续在做文档化、样例库整理、常见问题汇总，让新人上手更快，老同事协作更顺。</p>
<hr/>
<h2 data-id="heading-1"><strong>这100天，我最大的收获</strong></h2>
<p>说实话，新方向并不轻松。它不像冲刺型项目那样"立竿见影"，更多是"润物无声"。但也正因如此，它让我学会了另一种能力：<strong>耐心地把一件事做成体系。</strong></p>
<p>我也更深刻地体会到——所谓成长，不一定是站到更高的位置，有时候是换一个角度看世界：从追求结果，到构建方法；从解决一个问题，到消除一类问题。</p>
<hr/>
<h2 data-id="heading-2"><strong>几点真实的小感悟</strong></h2>
<ul>
<li>很多分歧不是谁对谁错，只是大家站在不同位置，看同一件事。</li>
<li>把规则写清楚，比想象中更难；写清楚之后，比想象中更有价值。</li>
<li>让事情"稳定"，往往比让事情"快速"更考验功力。</li>
</ul>
<hr/>
<h2 data-id="heading-3"><strong>写在最后</strong></h2>
<p>100天当然不算长，但足以让我确认：我已经在一个新的方向上重新出发了。离开不是告别，更像是把自己推入一个更陌生的场景，再学一次"如何把事情做好"。</p>
<p>最后，用一句我很喜欢的话收尾（我一直拿它提醒自己）：</p>
<blockquote>
<p>"这个世界上没有什么生活方式是完全正确的，神山圣湖并不是终点。接受平凡的自我，但不放弃理想和信仰，热爱生活。我们都在路上，也许路的尽头是什么，从来都不重要。"</p>
</blockquote>
<p>感谢这一路遇到的每一个人。也希望下一个100天，我能继续保持好奇、保持笃定，把这条路走得更深、更稳。</p>
<hr/>
<h2 data-id="heading-4"><strong>顺便打个小广告</strong></h2>
<p>既然聊到了数据标注，也借这个机会说一声：<strong>我们的标注平台即将上线，现在开始招募标注员啦！</strong></p>
<p>如果你是计算机相关专业背景，对代码有热情，想用专业能力做点有价值的事（顺便赚点外快），欢迎了解一下：</p>
<p><strong>我们在找这样的你：</strong></p>
<ul>
<li><strong>研发工程师</strong>，能独立理解并修改开源或企业级代码，熟悉单测与验证流程</li>
<li><strong>3年以上开发经验</strong>，熟悉 Git、单元测试、模块化架构，能阅读、理解、调试中大型项目</li>
<li>掌握主流开发语言（Python / Java / JS / TS / Rust / C / C++）</li>
<li>具备问题抽象、代码重构与性能优化经验，能从开发者视角构造高质量问题与解决方案</li>
</ul>
<p><strong>工作方式：</strong></p>
<ul>
<li>线上灵活办公，时间自由安排</li>
<li>每周投入 <strong>20小时以上</strong> 即可</li>
</ul>
<p><strong>薪酬待遇：</strong></p>
<ul>
<li>时薪 <strong>50～100元</strong>，具体以项目最终定价为准</li>
</ul>
<p>当然，如果你是<strong>本科及以上学历、有计算机相关背景</strong>的同学，也非常欢迎报名——我们同样期待新鲜血液的加入！</p>
<p>感兴趣的朋友可以私信我，或者留言咨询。期待与你在标注的世界里相遇。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b97428020c7546358f63495bf510c9ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LyY5byn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765977400&amp;x-signature=mGucn44Ekj10SZR2l2FMUbCu4ss%3D" alt="1_1067699600_171_85_3_1067549210_6ec3197faa53f1febc00f936e9787654.png" width="30%" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Agent】MemOS 源码笔记---(4)---KV Cache]]></title>    <link>https://juejin.cn/post/7582039917216989184</link>    <guid>https://juejin.cn/post/7582039917216989184</guid>    <pubDate>2025-12-10T13:27:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582039917216989184" data-draft-id="7581117416811708459" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Agent】MemOS 源码笔记---(4)---KV Cache"/> <meta itemprop="keywords" content="算法,人工智能"/> <meta itemprop="datePublished" content="2025-12-10T13:27:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="罗西的思考"/> <meta itemprop="url" content="https://juejin.cn/user/351470467691175"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Agent】MemOS 源码笔记---(4)---KV Cache
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/351470467691175/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    罗西的思考
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T13:27:58.000Z" title="Wed Dec 10 2025 13:27:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【Agent】MemOS 源码笔记---(4)---KV Cache</h2>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x00 概要</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x01 原理</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.1 技术路径</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.2 对比</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.3 协同工作</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x02 定义</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.1 KV Cache的记忆结构</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.2 API总结 (KVCacheMemory)</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.3 KVCacheMemory代码</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.4 流程</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x03 重要组件</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.1 KVCacheItem</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.2 build_kv_cache</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x04 示例</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">4.1 何时使用：</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">4.2 关键点：</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0xFF 参考</a></p>
</li>
</ul>
<h3 data-id="heading-1">0x00 概要</h3>
<p>在MemOS中，KV Cache最适合存储<strong>语义稳定且经常复用的背景信息</strong>，例如：</p>
<ul>
<li>常见问题（FAQs）或特定领域知识</li>
<li>先前的对话历史</li>
</ul>
<p>这些稳定的<strong>明文记忆项</strong>由<code>MemScheduler</code>模块自动识别和管理。一旦被选中，它们就会被提前转换成KV格式的表示(<code>KVCacheItem</code>)。这个预计算步骤以可复用的格式存储记忆的激活状态（键值对张量），允许它们在推理期间注入到模型的注意力缓存中</p>
<p>一旦进行转换，这些KV记忆就可以<strong>跨查询复用</strong>，而不需要对原始内容重新编码。这减少了处理和存储大量文本的计算开销，使其成为需要<strong>快速响应时间</strong>和<strong>高吞吐量</strong>的应用程序的理想选择。</p>
<h3 data-id="heading-2">0x01 原理</h3>
<p>KVCacheMemory 是MemOS中用于存储和管理KV cache的专用记忆模块，主要用于加速大语言模型（LLMs）推理并支持有效的上下文复用。<strong>KVCacheMemory</strong> 将最近或稳定的上下文作为激活缓存保存，有助于对于会话式和生成式人工智能系统。</p>
<h4 data-id="heading-3">1.1 技术路径</h4>
<p>若要替大模型补上记忆的缺口，如今的产业界大致踩出两条技术路径，各有利弊，也决定了产品落地的不同走向。</p>
<ul>
<li>第一条路是“外挂式”的文本记忆。做法直截了当：先把对话里的关键信息提炼成可读的文字，再写进向量库或图数据库；待模型需要时，按语义相似度把它们重新召回即可。这相当于给模型配一本随身的智能记事本，写进去的是什么，以后读出来的也是什么，人类一眼就能核对、删改或增补。</li>
<li>第二条路是“内置式”的张量记忆。在模型内部新增数十亿参数，充当隐式的“记忆池”，一切信息都被压缩成高维张量存于其中。此法的好处是召回路径短，与推理过程融为一体；代价则是不可读、不可改，一旦写错，只能重新训练，无法像删改文档那样随手修正。</li>
</ul>
<p>KVCacheMemory 看起来是介于两者之间的一条路。</p>
<p>KVCacheMemory 对应了激活记忆，即运行时的 KV 缓存和隐藏状态（高效率）。MemOS 使用 KVCacheMemory （最近或稳定的上下文）来加速多轮对话，高效的运行时状态缓存。适合对话中的快速重用、多轮会话。</p>
<h4 data-id="heading-4">1.2 对比</h4>
<p>我们比对下是否带 KV Cache 的区别：</p>
<ul>
<li>
<p>无KV Cache记忆</p>
<ul>
<li>每个新查询都被添加到完整的提示模板中，包括背景知识。</li>
<li>模型必须在整个序列上<strong>重新计算token嵌入和注意力</strong>——即使是未更改的记忆。</li>
</ul>
</li>
<li>
<p>有KV Cache记忆</p>
<ul>
<li>背景知识以键值对张量的形式<strong>缓存一次</strong>。</li>
<li>对于每个查询，只对新用户输入（查询token）进行编码。</li>
<li>之前缓存的KV被直接注入到注意力机制中。</li>
</ul>
</li>
</ul>
<p>这种分离减少了预填充阶段的冗余计算，从而导致:</p>
<ul>
<li>跳过背景知识的重复编码</li>
<li>更快的查询token和缓存记忆之间的注意力计算</li>
<li><strong>降低首次token时间(Time To First Token, TTFT)</strong> 生成过程中的延迟</li>
</ul>
<p>这种优化在以下方面特别有价值:</p>
<ul>
<li>多回合聊天机器人交互</li>
<li>检索增强生成或上下文增强生成(RAG, CAG)</li>
<li>在固定文档或FAQ风格记忆上操作的助理</li>
</ul>
<p>我们再比对下 TreeTextMemory 和 KVCacheMemory ：</p>
<ul>
<li>TreeTextMemory 将你的长时记忆存储在图数据库（Neo4j）中。</li>
<li>KVCacheMemory 将最近或稳定的上下文作为激活缓存保存。</li>
<li>二者在一个 MemCube 中协同工作，由你的 <code>MOS</code> Pipeline 统一管理。</li>
</ul>
<h4 data-id="heading-5">1.3 协同工作</h4>
<p>MemOS 将记忆视为一个生态系统——不仅仅是静态数据，而是演进的知识。以下是三种核心记忆类型如何协同工作：</p>

























<table><thead><tr><th>记忆类型</th><th>描述</th><th>何时使用</th></tr></thead><tbody><tr><td><strong>参数记忆</strong></td><td>知识提炼到模型权重中</td><td>常青技能、稳定领域专业知识</td></tr><tr><td><strong>激活记忆</strong></td><td>短期 KV cache 和隐藏状态</td><td>对话中的快速重用、多轮会话</td></tr><tr><td><strong>明文记忆</strong></td><td>文本、文档、图节点或向量块</td><td>可搜索、可检查、演进知识</td></tr></tbody></table>
<p>MemOS 让用户在生命周期循环中调度所有三种记忆类型：</p>
<ul>
<li>高频的明文记忆可以提炼为参数化权重。</li>
<li>高频激活路径成为可重用的 KV 模板。</li>
<li>陈旧的参数化或激活单元可以降级为明文记忆以进行追溯。</li>
</ul>
<p>使用 MemOS，用户的 AI 不仅仅是存储事实——它<strong><strong>记忆</strong></strong>、<strong><strong>理解</strong></strong>和<strong><strong>成长</strong></strong>。</p>
<p><strong>深入理解</strong></p>
<ul>
<li>随着时间的推移，频繁使用的明文记忆可以提炼为参数化形式。</li>
<li>很少使用的权重或缓存可以降级为纯文本存储以进行审计和重新训练。</li>
</ul>
<h3 data-id="heading-6">0x02 定义</h3>
<h4 data-id="heading-7">2.1 KV Cache的记忆结构</h4>
<p>通过<code>KVCacheMemory</code>实现基于KV的记忆复用，在保持相同输出的同时，大大减少了模型大小和查询类型之间的延迟。通过将可复用记忆从明文提示转移到预先计算的KV Cache，MemOS消除了冗余的上下文编码，并实现了更快的响应时间，特别是在实时的、记忆增强的LLM应用程序中。</p>
<p>每个缓存被存储为一个<code>KVCacheItem</code>:</p>

























<table><thead><tr><th>字段</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td><code>kv_cache_id</code></td><td><code>str</code></td><td>缓存中的唯一ID(UUID)</td></tr><tr><td><code>kv_cache</code></td><td><code>DynamicCache</code></td><td>实际的KV Cache(transformers)</td></tr><tr><td><code>metadata</code></td><td><code>dict</code></td><td>元数据 (源, 抽取时间等.)</td></tr></tbody></table>
<p>总体逻辑如下：</p>
<ul>
<li>KVCacheItem 是数据载体，KVCacheMemory 是管理多个KVCacheItem 的内存系统，对外提供操作接口。</li>
<li>KVCacheMemory 是管理多个 KVCacheItem 的内存系统（使用kv_cache_memories这个字典结构来保存），提供了CRUD操作，负责 KVCacheItem 的创建、存储、检索、合并和持久化。</li>
<li>KVCacheItem 是单个激活记忆的数据结构。继承自基础激活内存项，专门存储 LLM 的动态 KV 缓存，支持自定义元数据和关联文本记录。KVCacheItem 包含多个KVCacheRecords，KVCacheRecords存储与缓存相关的文本记忆信息。</li>
</ul>
<h4 data-id="heading-8">2.2 API总结 (KVCacheMemory)</h4>
<p>KVCacheMemory 提供了CRUD操作，用户可以直接使用。</p>
<p>初始化代码如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">KVCacheMemory</span>(config: KVCacheMemoryConfig)
</code></pre>
<p>核心方法如下：</p>





















































<table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td><code>extract(text)</code></td><td>使用LLM从输入文本中提取KV Cache</td></tr><tr><td><code>add(memories)</code></td><td>添加一个或多个<code>KVCacheItem</code>到记忆中</td></tr><tr><td><code>get(memory_id)</code></td><td>根据ID获取单个缓存</td></tr><tr><td><code>get_by_ids(ids)</code></td><td>根据IDs获取多个缓存</td></tr><tr><td><code>get_all()</code></td><td>返回所有存储的缓存</td></tr><tr><td><code>get_cache(cache_ids)</code></td><td>从多个IDs合并并返回组合缓存</td></tr><tr><td><code>delete(ids)</code></td><td>通过IDs删除缓存</td></tr><tr><td><code>delete_all()</code></td><td>删除所有缓存</td></tr><tr><td><code>dump(dir)</code></td><td>将所有缓存序列化到目录中的pickle文件</td></tr><tr><td><code>load(dir)</code></td><td>从目录中的pickle文件加载缓存</td></tr><tr><td><code>from_textual_memory(mem)</code></td><td>将<code>TextualMemoryItem</code> 转换为 <code>KVCacheItem</code></td></tr></tbody></table>
<p>当调用<code>dump(dir)</code>, 系统写到:</p>
<pre><code class="hljs">/
</code></pre>
<p>该文件包含所有KV Cache的pickle字典，可以使用<code>load(dir)</code>重新加载。</p>
<h4 data-id="heading-9">2.3 KVCacheMemory代码</h4>
<p>KVCacheMemory：</p>
<ul>
<li>该类是基于键值缓存的激活内存存储机制，用于管理 LLM 的键值缓存（KV Cache）</li>
<li>提供了完整的键值缓存提取、添加、查询、合并、删除等功能</li>
<li>支持将文本内容转换为 KV 缓存格式，也支持与文本内存项的相互转换</li>
<li>特色是针对不同版本的 transformers 库进行了兼容处理，实现了高效的多层缓存合并操作，通过批量拼接张量提升性能</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64f5e3319eb04d6c8aab313bfb499189~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765978078&amp;x-signature=zsYh%2FwW%2FnpTvEiK2dd%2Bd5lagvL4%3D" alt="memos-kv-1" loading="lazy"/></p>
<p>memos-kv-1</p>
<p>具体代码如下。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">KVCacheMemory</span>(BaseActMemory):
    <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
    用于激活内存的键值缓存存储器。
    这种内存类型设计用于存储和检索键值缓存。
    <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;

    @<span class="hljs-selector-tag">require_python_package</span>(
        import_name=&amp;#<span class="hljs-number">34</span>;torch&amp;#<span class="hljs-number">34</span>;,
        install_link=&amp;#<span class="hljs-number">34</span>;<span class="hljs-attribute">https</span>:<span class="hljs-comment">//pytorch.org/get-started/locally/&amp;#34;,</span>
    )
    <span class="hljs-selector-tag">def</span> <span class="hljs-selector-tag">__init__</span>(self, <span class="hljs-attribute">config</span>: KVCacheMemoryConfig) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">None</span>:
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;使用配置初始化<span class="hljs-selector-tag">KV</span>缓存存储器。<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.config</span> = <span class="hljs-selector-tag">config</span>  # 存储配置信息
        # 根据配置创建<span class="hljs-selector-tag">LLM</span>实例，用于提取<span class="hljs-selector-tag">KV</span>缓存
        <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.llm</span> = <span class="hljs-selector-tag">LLMFactory</span><span class="hljs-selector-class">.from_config</span>(config.extractor_llm)
        # 存储<span class="hljs-selector-tag">KV</span>缓存项的字典，以<span class="hljs-selector-tag">ID</span>为键
        <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.kv_cache_memories</span>: <span class="hljs-selector-tag">dict</span><span class="hljs-selector-attr">[str, KVCacheItem]</span> = {}

    <span class="hljs-selector-tag">def</span> <span class="hljs-selector-tag">extract</span>(self, <span class="hljs-attribute">text</span>: str) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">KVCacheItem</span>:
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;基于文本提取内存。

        使用<span class="hljs-selector-tag">LLM</span>从提供的文本中构建<span class="hljs-selector-tag">KV</span>缓存。

        参数:
            <span class="hljs-selector-tag">text</span>: 用于提取内存的输入文本

        返回:
            提取的内存项
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        # 使用<span class="hljs-selector-tag">LLM</span>从文本构建<span class="hljs-selector-tag">KV</span>缓存
        <span class="hljs-selector-tag">kv_cache</span> = <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.llm</span><span class="hljs-selector-class">.build_kv_cache</span>(text)

        # 创建包含提取的缓存的<span class="hljs-selector-tag">KV</span>缓存项
        <span class="hljs-selector-tag">cache_item</span> = <span class="hljs-selector-tag">KVCacheItem</span>(
            memory=kv_cache,
            metadata={<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">source_text</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">text</span>, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">extracted_at</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">datetime</span><span class="hljs-selector-class">.now</span>()<span class="hljs-selector-class">.isoformat</span>()},
        )

        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">cache_item</span>

    <span class="hljs-selector-tag">def</span> <span class="hljs-selector-tag">add</span>(self, <span class="hljs-attribute">memories</span>: list[KVCacheItem]) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">None</span>:
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;将内存添加到<span class="hljs-selector-tag">KV</span>缓存存储器中。

        参数:
            <span class="hljs-selector-tag">memories</span>: 要添加的<span class="hljs-selector-tag">KV</span>缓存项列表
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">memory</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">memories</span>:
            <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.kv_cache_memories</span><span class="hljs-selector-attr">[memory.id]</span> = <span class="hljs-selector-tag">memory</span>

    <span class="hljs-selector-tag">def</span> <span class="hljs-selector-tag">get_cache</span>(self, <span class="hljs-attribute">cache_ids</span>: list[str]) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">DynamicCache</span> | <span class="hljs-selector-tag">None</span>:
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;将多个<span class="hljs-selector-tag">KV</span>缓存合并为一个缓存。

        参数:
            <span class="hljs-selector-tag">cache_ids</span>: 要合并的缓存<span class="hljs-selector-tag">ID</span>列表

        返回:
            合并后的<span class="hljs-selector-tag">DynamicCache</span>，如果未找到缓存则返回<span class="hljs-selector-tag">None</span>
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        <span class="hljs-selector-tag">caches_to_merge</span> = <span class="hljs-selector-attr">[]</span>
        <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">cache_id</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">cache_ids</span>:
            <span class="hljs-selector-tag">cache_item</span> = <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.kv_cache_memories</span><span class="hljs-selector-class">.get</span>(cache_id)
            <span class="hljs-selector-tag">if</span> <span class="hljs-selector-tag">cache_item</span> <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">cache_item</span><span class="hljs-selector-class">.memory</span>:
                <span class="hljs-selector-tag">caches_to_merge</span><span class="hljs-selector-class">.append</span>(cache_item.memory)

        <span class="hljs-selector-tag">if</span> <span class="hljs-selector-tag">not</span> <span class="hljs-selector-tag">caches_to_merge</span>:
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">None</span>

        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">._concat_caches</span>(caches_to_merge)

    <span class="hljs-selector-tag">def</span> <span class="hljs-selector-tag">get</span>(self, <span class="hljs-attribute">memory_id</span>: str) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">KVCacheItem</span> | <span class="hljs-selector-tag">None</span>:
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;通过<span class="hljs-selector-tag">ID</span>获取内存。

        参数:
            <span class="hljs-selector-tag">memory_id</span>: 要检索的内存<span class="hljs-selector-tag">ID</span>

        返回:
            内存字典，如果未找到则返回<span class="hljs-selector-tag">None</span>
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.kv_cache_memories</span><span class="hljs-selector-class">.get</span>(memory_id)

    <span class="hljs-selector-tag">def</span> <span class="hljs-selector-tag">get_by_ids</span>(self, <span class="hljs-attribute">memory_ids</span>: list[str]) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">list</span><span class="hljs-selector-attr">[KVCacheItem | None]</span>:
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;通过<span class="hljs-selector-tag">ID</span>列表获取多个内存。

        参数:
            <span class="hljs-selector-tag">memory_ids</span>: 要检索的内存<span class="hljs-selector-tag">ID</span>列表

        返回:
            内存字典列表，对于不存在的<span class="hljs-selector-tag">ID</span>返回<span class="hljs-selector-tag">None</span>
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        <span class="hljs-selector-tag">results</span> = <span class="hljs-selector-attr">[]</span>
        <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">memory_id</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">memory_ids</span>:
            <span class="hljs-selector-tag">memory</span> = <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.get</span>(memory_id)
            <span class="hljs-selector-tag">results</span><span class="hljs-selector-class">.append</span>(memory)
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">results</span>

    <span class="hljs-selector-tag">def</span> <span class="hljs-selector-tag">get_all</span>(self) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">list</span><span class="hljs-selector-attr">[KVCacheItem]</span>:
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;获取所有内存。

        返回:
            存储器中所有<span class="hljs-selector-tag">KV</span>缓存项的列表
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">list</span>(self.kv_cache_memories.<span class="hljs-built_in">values</span>())

    <span class="hljs-selector-tag">def</span> <span class="hljs-selector-tag">delete</span>(self, <span class="hljs-attribute">memory_ids</span>: list[str]) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">None</span>:
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;通过<span class="hljs-selector-tag">ID</span>删除内存。

        参数:
            <span class="hljs-selector-tag">memory_ids</span>: 要删除的内存<span class="hljs-selector-tag">ID</span>列表
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">memory_id</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">memory_ids</span>:
            <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.kv_cache_memories</span><span class="hljs-selector-class">.pop</span>(memory_id, None)

    <span class="hljs-selector-tag">def</span> <span class="hljs-selector-tag">delete_all</span>(self) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">None</span>:
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;删除所有内存。<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.kv_cache_memories</span><span class="hljs-selector-class">.clear</span>()

    <span class="hljs-selector-tag">def</span> <span class="hljs-selector-tag">from_textual_memory</span>(self, <span class="hljs-attribute">mem</span>: TextualMemoryItem) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">KVCacheItem</span>:
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        将<span class="hljs-selector-tag">TextualMemoryItem</span>转换为<span class="hljs-selector-tag">KVCacheItem</span>。
        此方法从文本内存中提取键值缓存。
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        # 从文本内存内容构建<span class="hljs-selector-tag">KV</span>缓存
        <span class="hljs-selector-tag">kv_cache</span> = <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.llm</span><span class="hljs-selector-class">.build_kv_cache</span>(mem.memory)
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">KVCacheItem</span>(memory=kv_cache, metadata=mem.metadata.<span class="hljs-built_in">model_dump</span>())

    <span class="hljs-selector-tag">def</span> <span class="hljs-selector-tag">_concat_caches</span>(self, <span class="hljs-attribute">caches</span>: list[DynamicCache]) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">DynamicCache</span>:
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        更快的拼接合并：对于每个层，收集所有缓存的张量
        并每层执行一次<span class="hljs-selector-tag">torch</span><span class="hljs-selector-class">.cat</span>操作。
        <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        <span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">torch</span>

        <span class="hljs-selector-tag">assert</span> <span class="hljs-selector-tag">caches</span>, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;至少需要一个缓存<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;
        <span class="hljs-selector-tag">if</span> <span class="hljs-selector-tag">len</span>(caches) == <span class="hljs-number">1</span>:
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">caches</span><span class="hljs-selector-attr">[0]</span>

        <span class="hljs-selector-tag">merged</span> = <span class="hljs-selector-tag">DynamicCache</span>()
        <span class="hljs-selector-tag">num_layers</span> = <span class="hljs-selector-tag">len</span>(caches[<span class="hljs-number">0</span>].key_cache)

        # 处理<span class="hljs-selector-tag">transformers</span> <span class="hljs-number">4.54</span><span class="hljs-selector-class">.0</span>及以上版本的缓存结构
        <span class="hljs-selector-tag">if</span> <span class="hljs-selector-tag">Version</span>(<span class="hljs-built_in">version</span>(&amp;#<span class="hljs-number">34</span>;transformers&amp;#<span class="hljs-number">34</span>;)) &gt;= <span class="hljs-selector-tag">Version</span>(&amp;#<span class="hljs-number">34</span>;<span class="hljs-number">4.54</span>.<span class="hljs-number">0</span>&amp;#<span class="hljs-number">34</span>;):
            <span class="hljs-selector-tag">merged</span><span class="hljs-selector-class">.append_new_layers</span>(num_layers - <span class="hljs-number">1</span>)
            <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">layer</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">range</span>(num_layers):
                # 收集当前层的所有<span class="hljs-selector-tag">K</span>和<span class="hljs-selector-tag">V</span>
                <span class="hljs-selector-tag">keys</span> = <span class="hljs-selector-attr">[c.layers[layer]</span><span class="hljs-selector-class">.keys</span> <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">c</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">caches</span>]
                <span class="hljs-selector-tag">vals</span> = <span class="hljs-selector-attr">[c.layers[layer]</span><span class="hljs-selector-class">.values</span> <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">c</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">caches</span>]
                # 每层执行一次拼接
                <span class="hljs-selector-tag">merged</span><span class="hljs-selector-class">.layers</span><span class="hljs-selector-attr">[layer]</span><span class="hljs-selector-class">.keys</span> = <span class="hljs-selector-tag">torch</span><span class="hljs-selector-class">.cat</span>(keys, dim=-<span class="hljs-number">2</span>)
                <span class="hljs-selector-tag">merged</span><span class="hljs-selector-class">.layers</span><span class="hljs-selector-attr">[layer]</span><span class="hljs-selector-class">.values</span> = <span class="hljs-selector-tag">torch</span><span class="hljs-selector-class">.cat</span>(vals, dim=-<span class="hljs-number">2</span>)

        # 处理旧版本<span class="hljs-selector-tag">transformers</span>的缓存结构
        <span class="hljs-selector-tag">else</span>:
            <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">layer</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">range</span>(num_layers):
                # 收集当前层的所有<span class="hljs-selector-tag">K</span>和<span class="hljs-selector-tag">V</span>
                <span class="hljs-selector-tag">keys</span> = <span class="hljs-selector-attr">[c.key_cache[layer]</span> <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">c</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">caches</span>]
                <span class="hljs-selector-tag">vals</span> = <span class="hljs-selector-attr">[c.value_cache[layer]</span> <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">c</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">caches</span>]
                # 每层执行一次拼接
                <span class="hljs-selector-tag">merged</span><span class="hljs-selector-class">.key_cache</span><span class="hljs-selector-class">.append</span>(torch.<span class="hljs-built_in">cat</span>(keys, dim=-<span class="hljs-number">2</span>))
                <span class="hljs-selector-tag">merged</span><span class="hljs-selector-class">.value_cache</span><span class="hljs-selector-class">.append</span>(torch.<span class="hljs-built_in">cat</span>(vals, dim=-<span class="hljs-number">2</span>))

        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">merged</span>
</code></pre>
<h4 data-id="heading-10">2.4 流程</h4>
<p>几个重要的流程图总结如下：</p>
<h5 data-id="heading-11">2.4.1 初始化流程</h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78458bd760bf44b9964728899e51f8d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765978078&amp;x-signature=E5s74L6kysYEs3n%2FAW15%2BuivNII%3D" alt="memos-kv-2" loading="lazy"/></p>
<p>memos-kv-2</p>
<h5 data-id="heading-12">2.4.2 提取与添加流程</h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd3a737a9e5a4ff6a6a5802fd66a5ae2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765978078&amp;x-signature=mxvHCMSvbNm0aW7tNj37%2FslaRmg%3D" alt="memos-kv-3" loading="lazy"/></p>
<p>memos-kv-3</p>
<h5 data-id="heading-13">2.4.3 缓存合并流程</h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fea80e2833b4cc7ba01ac8897d67a3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765978078&amp;x-signature=poVfMQ5opVMxVhhwulYjR4w3jSo%3D" alt="memos-kv-4" loading="lazy"/></p>
<p>memos-kv-4</p>
<h3 data-id="heading-14">0x03 重要组件</h3>
<h4 data-id="heading-15">3.1 KVCacheItem</h4>
<h5 data-id="heading-16">3.1.1 定义</h5>
<ul>
<li>
<p>该代码定义了 MemOS 中激活内存相关的数据模型，用于标准化存储 KV 缓存及关联元数据。</p>
</li>
<li>
<p>核心是<code>KVCacheItem</code>类，继承自基础激活内存项，专门存储 LLM 的动态 KV 缓存，支持自定义元数据和关联文本记录。</p>
</li>
<li>
<p>衍生类<code>VLLMKVCacheItem</code>适配 vLLM 场景，将缓存存储改为提示字符串（因 vLLM 在服务端预加载 KV 缓存）。</p>
</li>
<li>
<p>特色是使用 Pydantic 模型实现数据结构化，自动生成唯一 ID，支持任意类型字段（适配 DynamicCache），同时通过<code>KVCacheRecords</code>记录文本内存来源和组合信息，保证数据可追溯。</p>
<p>class ActivationMemoryItem(BaseModel):
    """基础激活内存项模型，定义激活内存的核心结构"""
    # 内存项唯一ID，默认使用UUID4自动生成
    id: str = Field(default_factory=lambda: str(uuid.uuid4()))
    # 内存具体内容，支持任意类型
    memory: Any
    # 内存关联的元数据，默认空字典
    metadata: dict = {}</p>
<p>class KVCacheRecords(BaseModel):
    """KV缓存关联的文本记录模型，用于追溯缓存来源"""
    # 转换为激活内存的文本内存列表
    text_memories: list[str] = Field(
        default=[],
        description="转换为激活内存的文本内存列表",
    )
    # 使用组装模板组合所有文本内存后的单一字符串
    composed_text_memory: str = Field(
        default="",
        description="使用组装模板将所有文本内存组合成的单一字符串",
    )
    # 提交时间（用于调度消息），默认使用UTC当前时间
    timestamp: datetime = Field(
        default_factory=datetime.utcnow, description="调度消息的提交时间"
    )</p>
<p>class KVCacheItem(ActivationMemoryItem):
    """KV缓存内存项模型，专门存储键值缓存数据"""
    # 缓存项唯一ID，默认使用UUID4自动生成（覆盖父类字段）
    id: str = Field(default_factory=lambda: str(uuid.uuid4()))
    # 存储KV键值对的动态缓存，默认初始化空DynamicCache
    memory: DynamicCache = Field(
        default_factory=DynamicCache,
        description="用于在内存中存储键值对的动态缓存",
    )
    # 与KV缓存项关联的元数据，默认空字典（覆盖父类字段）
    metadata: dict = Field(
        default_factory=dict, description="与KV缓存项关联的元数据"
    )</p>
<p>    # 配置模型以允许任意类型字段（支持DynamicCache作为字段类型）
    model_config = ConfigDict(arbitrary_types_allowed=True)
    # 关联的文本记录，默认初始化空KVCacheRecords
    records: KVCacheRecords = KVCacheRecords()</p>
<p>class VLLMKVCacheItem(KVCacheItem):
    """
    vLLM专用KV缓存项模型，存储提示字符串而非DynamicCache对象。
    原因是vLLM通过预加载在服务端处理KV缓存。
    """</p>
<p>    # 重写memory字段，存储提示字符串而非DynamicCache（适配vLLM）
    memory: str = Field(
        default="",
        description="用于在vLLM服务端预加载KV缓存的提示字符串",
    )</p>
</li>
</ul>
<h5 data-id="heading-17">3.1.2 关联</h5>
<p>KVCacheItem 和 KVCacheMemory 是互相联系的。KVCacheItem 是数据单元/单个记忆单元，KVCacheMemory 是管理系统/激活记忆的存储系统。</p>
<ul>
<li>KVCacheMemory 是管理多个 KVCacheItem 的内存系统，提供了完整的CRUD（创建、存储、检索、合并和持久化）操作。</li>
<li>KVCacheMemory 中有self.kv_cache_memories: dict[str, KVCacheItem] = {}。</li>
<li>KVCacheRecords 是 KVCacheItem 的一部分，为 KVCacheItem 提供了重要的元数据支持，使得系统可以有效管理和跟踪KV Cache 的状态变化。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9557074120a4867885cb17bd995d498~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765978078&amp;x-signature=j3A2feoZvXYsqd8tlrocTErxpfw%3D" alt="memos-kv-5" loading="lazy"/></p>
<p>memos-kv-5</p>
<h4 data-id="heading-18">3.2 build_kv_cache</h4>
<p>KVCacheMemory 会使用LLM把文本构建成KV Cache，或者说是构建成KV 向量。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">self.llm</span> = LLMFactory.from_config(config.extractor_llm)

<span class="hljs-attr">kv_cache</span> = self.llm.build_kv_cache(text)
</code></pre>
<p>HFLLM类是基于 Hugging Face Transformers 的 LLM 封装，支持缓存增强生成（CAG）和采样功能。</p>
<ul>
<li>核心能力是将多种格式的输入（字符串、字符串列表、聊天消息列表）转换为标准 KV 缓存，为后续生成任务提供上下文加速。</li>
<li>内置温度、Top-K、Top-P 等采样策略的日志处理器，支持灵活的生成配置。</li>
<li>特色是自动适配模型和分词器初始化，支持多种输入格式标准化，通过单次前向传播高效构建 KV 缓存。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/682ad97f1e8c43e59d48126caf1dff76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765978078&amp;x-signature=0ylugVAas%2ByZdF1tABOd3gB9XHc%3D" alt="memos-kv-6" loading="lazy"/></p>
<p>memos-kv-6</p>
<p>初始化流程如下:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3dbe488535b4269801fbb8ee5a715dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765978078&amp;x-signature=ODQR5vEH2vgns%2FuIPeKWwEPgteY%3D" alt="memos-kv-7" loading="lazy"/></p>
<p>memos-kv-7</p>
<p>build_kv_cache()流程如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e826990178c642e187773af1ef7695fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765978078&amp;x-signature=8zbctLkwDuUCuEEpqhu%2F%2Filob6s%3D" alt="memos-kv-8" loading="lazy"/></p>
<p>memos-kv-8</p>
<p>具体代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">HFLLM</span>(<span class="hljs-title class_ inherited__">BaseLLM</span>):
    &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;</span>
    HFLLM：支持缓存增强生成（CAG）和采样的Transformers LLM类。
    &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;    </span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config: HFLLMConfig</span>):
        &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;</span>
        初始化HFLLM模型和分词器，并设置用于采样的日志处理器。
        &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;</span>
        self.config = config  <span class="hljs-comment"># 存储模型配置信息</span>

        <span class="hljs-comment"># 如果未指定模型，使用默认模型</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.config.model_name_or_path:
            self.config.model_name_or_path = &amp;<span class="hljs-comment">#34;Qwen/Qwen3-1.7B&amp;#34;</span>

        <span class="hljs-comment"># 初始化Hugging Face模型</span>
        self.model = AutoModelForCausalLM.from_pretrained(
            self.config.model_name_or_path, torch_dtype=&amp;<span class="hljs-comment">#34;auto&amp;#34;, device_map=&amp;#34;auto&amp;#34;</span>
        )
        <span class="hljs-comment"># 初始化分词器，启用快速分词模式</span>
        self.tokenizer = AutoTokenizer.from_pretrained(
            self.config.model_name_or_path, use_fast=<span class="hljs-literal">True</span>
        )

        <span class="hljs-comment"># 初始化用于采样的日志处理器列表</span>
        processors = []
        <span class="hljs-comment"># 温度调节：控制生成的随机性，非1.0时添加</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">getattr</span>(self.config, &amp;<span class="hljs-comment">#34;temperature&amp;#34;, 1.0) != 1.0:</span>
            processors.append(TemperatureLogitsWarper(self.config.temperature))
        <span class="hljs-comment"># Top-K采样：限制仅从概率最高的K个token中选择，K&gt;0时添加</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">getattr</span>(self.config, &amp;<span class="hljs-comment">#34;top_k&amp;#34;, 0) &gt; 0:</span>
            processors.append(TopKLogitsWarper(self.config.top_k))
        <span class="hljs-comment"># Top-P采样：限制仅从累积概率达P的token子集选择，0&lt;p&gt; DynamicCache:</span>
        &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;</span>
        通过单次前向传播从聊天消息构建KV缓存。
        支持以下输入类型：
            - <span class="hljs-built_in">str</span>：用作系统提示词。
            - <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]：拼接后用作系统提示词。
            - <span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>]：直接用作聊天消息（需包含&amp;<span class="hljs-comment">#34;role&amp;#34;和&amp;#34;content&amp;#34;键）。</span>
        消息始终会转换为标准聊天模板格式。
        异常：
            ValueError：如果模板处理后的提示词为空。
        返回：
            DynamicCache：构建完成的KV缓存对象。
        &amp;<span class="hljs-comment">#34;&amp;#34;&amp;#34;</span>
        <span class="hljs-keyword">import</span> torch

        <span class="hljs-comment"># 处理多种输入类型，统一转换为标准聊天消息格式</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(messages, <span class="hljs-built_in">str</span>):
            <span class="hljs-comment"># 字符串输入转为系统提示词格式</span>
            messages = [
                {
                    &amp;<span class="hljs-comment">#34;role&amp;#34;: &amp;#34;system&amp;#34;,</span>
                    &amp;<span class="hljs-comment">#34;content&amp;#34;: f&amp;#34;Below is some information about the user.\n{messages}&amp;#34;,</span>
                }
            ]
        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(messages, <span class="hljs-built_in">list</span>) <span class="hljs-keyword">and</span> messages <span class="hljs-keyword">and</span> <span class="hljs-built_in">isinstance</span>(messages[<span class="hljs-number">0</span>], <span class="hljs-built_in">str</span>):
            <span class="hljs-comment"># 字符串列表输入拼接后转为系统提示词</span>
            messages = [
                {
                    &amp;<span class="hljs-comment">#34;role&amp;#34;: &amp;#34;system&amp;#34;,</span>
                    &amp;<span class="hljs-comment">#34;content&amp;#34;: f&amp;#34;Below is some information about the user.\n{' '.join(messages)}&amp;#34;,</span>
                }
            ]
        
        <span class="hljs-comment"># 应用聊天模板生成完整提示词（不添加生成提示，不分词）</span>
        prompt = self.tokenizer.apply_chat_template(
            messages, tokenize=<span class="hljs-literal">False</span>, add_generation_prompt=<span class="hljs-literal">False</span>
        )
        <span class="hljs-comment"># 对提示词进行分词，转换为模型输入格式</span>
        inputs = self.tokenizer(prompt, return_tensors=&amp;<span class="hljs-comment">#34;pt&amp;#34;)</span>
        <span class="hljs-comment"># 将输入ID移至模型所在设备，转换为长整型</span>
        inputs[&amp;<span class="hljs-comment">#34;input_ids&amp;#34;] = inputs[&amp;#34;input_ids&amp;#34;].to(self.model.device, dtype=torch.long)</span>
        <span class="hljs-comment"># 获取序列长度</span>
        seq_len = inputs[&amp;<span class="hljs-comment">#34;input_ids&amp;#34;].size(-1)</span>
        
        <span class="hljs-comment"># 检查提示词是否为空</span>
        <span class="hljs-keyword">if</span> seq_len == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">raise</span> ValueError(
                &amp;<span class="hljs-comment">#34;聊天模板处理后的提示词为空，无法构建KV缓存。请检查你的消息输入。&amp;#34;</span>
            )
        
        <span class="hljs-comment"># 初始化动态KV缓存</span>
        kv = DynamicCache()
        <span class="hljs-comment"># 关闭梯度计算，执行前向传播构建缓存</span>
        <span class="hljs-keyword">with</span> torch.no_grad():
            self.model(**inputs, use_cache=<span class="hljs-literal">True</span>, past_key_values=kv)
        
        <span class="hljs-comment"># 截取有效长度的缓存（去除可能的冗余部分）</span>
        <span class="hljs-keyword">for</span> i, (k, v) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">zip</span>(kv.key_cache, kv.value_cache, strict=<span class="hljs-literal">False</span>)):
            kv.key_cache[i] = k[:, :, :seq_len, :]
            kv.value_cache[i] = v[:, :, :seq_len, :]
        
        <span class="hljs-keyword">return</span> kv
</code></pre>
<h3 data-id="heading-19">0x04 示例</h3>
<h4 data-id="heading-20">4.1 何时使用：</h4>
<ul>
<li>你想要短期工作记忆以加快多轮对话速度。</li>
<li>适合聊天机器人会话加速或提示复用。</li>
<li>最适合缓存隐藏状态 / KV 对。</li>
</ul>
<h4 data-id="heading-21">4.2 关键点：</h4>
<ul>
<li>
<p>用 KVCacheMemory，不含显式明文记忆。</p>
</li>
<li>
<p>演示提取 → 添加 → 合并 → 获取 → 删除。</p>
</li>
<li>
<p>展示如何导出/加载 KV cache。</p>
</li>
</ul>
<p>以下是KV Cache的使用示例。</p>
<pre><code class="hljs language-xml" lang="xml">from memos.configs.memory import MemoryConfigFactory
from memos.memories.factory import MemoryFactory

# 为 KVCacheMemory（HuggingFace 后端）创建配置
config = MemoryConfigFactory(
    backend=<span class="hljs-symbol">&amp;#34;</span>kv_cache<span class="hljs-symbol">&amp;#34;</span>,
    config={
        <span class="hljs-symbol">&amp;#34;</span>extractor_llm<span class="hljs-symbol">&amp;#34;</span>: {
            <span class="hljs-symbol">&amp;#34;</span>backend<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>huggingface<span class="hljs-symbol">&amp;#34;</span>,
            <span class="hljs-symbol">&amp;#34;</span>config<span class="hljs-symbol">&amp;#34;</span>: {
                <span class="hljs-symbol">&amp;#34;</span>model_name_or_path<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>Qwen/Qwen3-0.6B<span class="hljs-symbol">&amp;#34;</span>,
                <span class="hljs-symbol">&amp;#34;</span>max_tokens<span class="hljs-symbol">&amp;#34;</span>: 32,
                <span class="hljs-symbol">&amp;#34;</span>add_generation_prompt<span class="hljs-symbol">&amp;#34;</span>: True,
                <span class="hljs-symbol">&amp;#34;</span>remove_think_prefix<span class="hljs-symbol">&amp;#34;</span>: True,
            },
        },
    },
)

# 实例化 KVCacheMemory
kv_mem = MemoryFactory.from_config(config)

# 提取一个 KVCacheItem（DynamicCache）
prompt = [
    {<span class="hljs-symbol">&amp;#34;</span>role<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>user<span class="hljs-symbol">&amp;#34;</span>, <span class="hljs-symbol">&amp;#34;</span>content<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>What is MemOS?<span class="hljs-symbol">&amp;#34;</span>},
    {<span class="hljs-symbol">&amp;#34;</span>role<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>assistant<span class="hljs-symbol">&amp;#34;</span>, <span class="hljs-symbol">&amp;#34;</span>content<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>MemOS is a memory operating system for LLMs.<span class="hljs-symbol">&amp;#34;</span>},
]
print(<span class="hljs-symbol">&amp;#34;</span>===== Extract KVCacheItem =====<span class="hljs-symbol">&amp;#34;</span>)
cache_item = kv_mem.extract(prompt)
print(cache_item)

# 将缓存添加到内存中
kv_mem.add([cache_item])
print(<span class="hljs-symbol">&amp;#34;</span>All caches:<span class="hljs-symbol">&amp;#34;</span>, kv_mem.get_all())

# 通过 ID 获取
retrieved = kv_mem.get(cache_item.id)
print(<span class="hljs-symbol">&amp;#34;</span>Retrieved:<span class="hljs-symbol">&amp;#34;</span>, retrieved)

# 合并缓存（模拟多轮对话）
item2 = kv_mem.extract([{<span class="hljs-symbol">&amp;#34;</span>role<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>user<span class="hljs-symbol">&amp;#34;</span>, <span class="hljs-symbol">&amp;#34;</span>content<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>Tell me a joke.<span class="hljs-symbol">&amp;#34;</span>}])
kv_mem.add([item2])
merged = kv_mem.get_cache([cache_item.id, item2.id])
print(<span class="hljs-symbol">&amp;#34;</span>Merged cache:<span class="hljs-symbol">&amp;#34;</span>, merged)

# 删除其中一个
kv_mem.delete([cache_item.id])
print(<span class="hljs-symbol">&amp;#34;</span>After delete:<span class="hljs-symbol">&amp;#34;</span>, kv_mem.get_all())

# 导出和加载缓存
kv_mem.dump(<span class="hljs-symbol">&amp;#34;</span>tmp/kv_mem<span class="hljs-symbol">&amp;#34;</span>)
print(<span class="hljs-symbol">&amp;#34;</span>Dumped to tmp/kv_mem<span class="hljs-symbol">&amp;#34;</span>)
kv_mem.delete_all()
kv_mem.load(<span class="hljs-symbol">&amp;#34;</span>tmp/kv_mem<span class="hljs-symbol">&amp;#34;</span>)
print(<span class="hljs-symbol">&amp;#34;</span>Loaded caches:<span class="hljs-symbol">&amp;#34;</span>, kv_mem.get_all())
</code></pre>
<h3 data-id="heading-22">0xFF 参考</h3>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.com.cn" target="_blank" title="https://markdown.com.cn" ref="nofollow noopener noreferrer">markdown.com.cn</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[紧急修复！Dify CVE-2025-55182 高危漏洞，手把手教你升级避坑]]></title>    <link>https://juejin.cn/post/7581999251368214580</link>    <guid>https://juejin.cn/post/7581999251368214580</guid>    <pubDate>2025-12-10T12:40:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581999251368214580" data-draft-id="7582016579857956898" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="紧急修复！Dify CVE-2025-55182 高危漏洞，手把手教你升级避坑"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-10T12:40:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wwwzhouhui"/> <meta itemprop="url" content="https://juejin.cn/user/3428746411400537"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            紧急修复！Dify CVE-2025-55182 高危漏洞，手把手教你升级避坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3428746411400537/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wwwzhouhui
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T12:40:34.000Z" title="Wed Dec 10 2025 12:40:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在AI应用快速发展的今天，如何保障生产环境的安全成为了企业关注的焦点。传统的开发方式往往只关注功能实现，却忽视了底层框架的供应链安全风险，特别是当你使用的技术栈升级到最新架构时，一些隐藏的安全漏洞可能在不经意间就让你的服务器"裸奔"在互联网上。</p>
<p>这2天Dify用户炸锅了！号称"史上最严重"的React漏洞CVE-2025-55182被曝光，CVSS评分高达10.0满分。这个漏洞源于React Server Components（RSC）和Next.js App Router架构的反序列化缺陷，攻击者无需任何身份验证，只需发送一个精心构造的HTTP请求，就能在服务器上执行任意代码，直接拿下服务器权限。更可怕的是，全球已有大量Dify自托管实例被植入挖矿程序、窃取API密钥、甚至建立持久化后门。好家伙，这不就是现代版的"一键夺舍"吗？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85c1a4f593844cb89f62021410fadfeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=I73MxHnI1%2FpfPewU2GWNZI7iekE%3D" alt="1765352612636" loading="lazy"/></p>
<p>今天我们就带小伙伴们深入了解CVE-2025-55182漏洞的来龙去脉，并手把手教大家在Dify平台上进行安全修复升级，避开升级过程中的各种大坑。呵呵，保证让你的Dify实例固若金汤！</p>
<h2 data-id="heading-1">✨ 漏洞核心特征</h2>
<ul>
<li><strong>🔥 CVSS 10.0满分</strong>: 史上最严重的React安全漏洞，影响范围极广</li>
<li><strong>💀 无需身份验证</strong>: 攻击者不需要登录，只要服务暴露在公网即可攻击</li>
<li><strong>⚡ 远程代码执行</strong>: 一个HTTP请求直接获取服务器Shell权限</li>
<li><strong>🎯 精准打击Dify</strong>: 使用Next.js App Router的Dify v1.9.x-v1.10.1全线受影响</li>
<li><strong>💰 高价值目标</strong>: 可窃取OpenAI/Claude API密钥、数据库凭证等核心资产</li>
<li><strong>🔗 供应链攻击</strong>: 源头漏洞在React，Next.js连带受影响，波及整个生态</li>
<li><strong>⚠️ 升级有坑</strong>: 官方镜像标签存在错误，盲目升级可能无效</li>
<li><strong>🛡️ WAF可防御</strong>: 通过雷池等WAF可临时拦截攻击，争取升级时间</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba3fb6ddce9f41389d4b0014545b65f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=qiH2tMhPh0zXDbOn1CNxx6eNAvo%3D" alt="1765359233004" loading="lazy"/></p>
<h2 data-id="heading-2">🛠️ 技术背景：从CSR到RSC的架构演进</h2>
<p>要理解这个漏洞为什么这么严重，我们得先了解React和Next.js的技术演进史。呵呵，别怕，我用大白话给大家讲清楚。</p>
<h3 data-id="heading-3">React架构的三次进化</h3>
<p><strong>第一代：客户端渲染（CSR）</strong></p>
<ul>
<li><strong>时代</strong>: 2013-2016年</li>
<li><strong>特点</strong>: 服务器只发送空HTML，浏览器下载JS后动态生成页面</li>
<li><strong>问题</strong>: 首屏慢、SEO差、JS体积大</li>
</ul>
<p><strong>第二代：服务端渲染（SSR）</strong></p>
<ul>
<li><strong>时代</strong>: 2016-2022年</li>
<li><strong>代表</strong>: Next.js Pages Router</li>
<li><strong>特点</strong>: 服务器生成完整HTML，浏览器"注水"(Hydration)实现交互</li>
<li><strong>问题</strong>: 仍需下载全量JS，Hydration延迟高</li>
</ul>
<p><strong>第三代：React Server Components（RSC）</strong></p>
<ul>
<li><strong>时代</strong>: 2022年至今</li>
<li><strong>代表</strong>: Next.js 13+ App Router</li>
<li><strong>特点</strong>: 组件分为服务端组件和客户端组件，服务端组件不发送到客户端</li>
<li><strong>优势</strong>: JS体积减少90%，性能大幅提升</li>
<li><strong>风险</strong>: 引入了新的通信协议——Flight Protocol</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b2af5864b204ccb94dc8eb167b9f927~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=mO3HF%2ByaDHpoaF%2F7y8B2mThl%2F%2Fg%3D" alt="1765359490644" loading="lazy"/></p>
<h3 data-id="heading-4">Flight协议：漏洞的"元凶"</h3>
<p>为了让服务端组件和客户端组件能够无缝通信，React团队设计了Flight Protocol。这个协议不仅要传输数据，还要传输组件树结构、Promise对象、甚至服务端函数引用。传统的JSON格式无法满足这些复杂需求，于是React实现了一套自定义的序列化/反序列化机制。</p>
<p><strong>问题就出在这里！</strong> 当服务器反序列化客户端发来的Flight协议数据时，没有充分验证数据的安全性，导致攻击者可以构造恶意的序列化数据，触发服务器执行任意代码。</p>



































<table><thead><tr><th>架构特征</th><th>CSR</th><th>SSR</th><th>RSC</th></tr></thead><tbody><tr><td>执行位置</td><td>浏览器</td><td>服务器+浏览器</td><td><strong>服务器(Server Components)</strong></td></tr><tr><td>数据传输</td><td>JSON API</td><td>HTML字符串</td><td><strong>Flight协议序列化流</strong></td></tr><tr><td>主要风险</td><td>XSS, CSRF</td><td>XSS, 注入</td><td><strong>反序列化RCE</strong></td></tr><tr><td>受此漏洞影响</td><td>❌ 否</td><td>❌ 否</td><td>✅ <strong>是</strong></td></tr></tbody></table>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2ef3b88e8e94dccb5a73a827d7208a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=rIcvKM7MgPYIzDt7ul1i%2FNgtwgE%3D" alt="unnamed" loading="lazy"/></p>
<h2 data-id="heading-5">🎯 漏洞影响范围</h2>
<h3 data-id="heading-6">受影响的Dify版本</h3>
<ul>
<li><strong>Dify v1.9.0 - v1.10.1</strong>: 全线受影响</li>
<li><strong>核心受害者</strong>: dify-web容器（前端服务）</li>
<li><strong>技术栈</strong>: Next.js 15.x + React 19.x (App Router架构)</li>
</ul>
<h3 data-id="heading-7">受影响的Next.js版本</h3>
<ul>
<li><strong>Next.js 13.4+</strong>: 使用App Router的所有版本</li>
<li><strong>Next.js 14.x, 15.x, 16.x</strong>: 全部受影响</li>
<li><strong>Pages Router用户</strong>: 完全不受影响（使用pages/目录）</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5776fc850747483cb84ff99bb5fde6eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=jW%2FQggaNk1PRCoT6%2FP0%2FPpoAqUw%3D" alt="1765359829068" loading="lazy"/></p>
<h3 data-id="heading-8">攻击后果</h3>
<p>根据真实案例，攻击者成功入侵后会进行以下操作：</p>
<ol>
<li><strong>资源劫持</strong>: 部署XMRig挖矿程序，CPU占用飙升至100%</li>
<li><strong>凭证窃取</strong>: 读取环境变量中的API密钥（OpenAI/Claude/AWS等）</li>
<li><strong>数据泄露</strong>: 窃取数据库密码，访问PostgreSQL中的敏感数据</li>
<li><strong>持久化后门</strong>: 在.next目录写入Webshell，修改cron任务</li>
<li><strong>内网渗透</strong>: 以Dify为跳板，攻击内网其他服务</li>
</ol>
<h2 data-id="heading-9">安全漏洞复现</h2>
<h3 data-id="heading-10">dify部署</h3>
<p>我这里使用最新的dify1.10.1版本给大家演示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/696793f4461d4e6bb7144e94a857821e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=0goLQnWVNDTCtk3GpfmU3iyWulM%3D" alt="image-20251210142140149" loading="lazy"/></p>
<p>我们在本地电脑上使用docker compose 安装</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15400be90bf6476f8dee205408ce7f2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=6UImSO6oKh9CrV%2FDuNieKjV1emI%3D" alt="image-20251210142250397" loading="lazy"/></p>
<p>下图我们按照官方的部署方式部署了一个1.10.1版本（算是比较新的版本）</p>
<h3 data-id="heading-11">漏洞检查</h3>
<p>我们这里在github搜索CVE-2025-55182 搜到这个开源项目 把这个代码下载到本地</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80743f80aa3b4e2b900a549df74e0fc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=f4%2FLXLZIucU7%2B6brm98cfcq7FHI%3D" alt="image-20251210142527875" loading="lazy"/></p>
<p>代码下载本地</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06c9f2e623e045fdbc6875a648e4cc0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=swuy7Yjyyhse9mBLm2Niw0SEkbs%3D" alt="image-20251210142556609" loading="lazy"/></p>
<p>这个poc.py 代码非常简单，我们在命令行窗口直接下面地址</p>
<pre><code class="hljs language-shell" lang="shell">python poc.py http://127.0.0.1
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0e0912140494c1e94e0f2d51a0bb9d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=HYTo7QLZlga5T4OjnrWRSUXOmv4%3D" alt="image-20251210142741505" loading="lazy"/></p>
<p>出现下面的画面我们的浮现了上手漏洞。脚本已经成功拿到数据库返回uid=1001 用户root。如果这个暴露在互联网，如果没有安全防护WAF等安全设备硬件或者软件基本上我通过这一行命令就可以成功拿到服务器权限了。</p>
<h3 data-id="heading-12">扫描生成环境</h3>
<p>我们公司也少量的使用的dify做一些信息查询和统计。我们查看一下生产环境的版本。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/505762073565409ba3795f8a8d6d1164~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=hdZ2KGWAgpbiDCifrp07V32%2F8hk%3D" alt="image-20251210143144806" loading="lazy"/></p>
<p>我们检查下面当前生产环境使用的是1.9.0 版本。刚才我们上面给大家演示的是1.10.1 版本也是成功拿下，我们也在想这个脚本是不是也可以拿下生产环境？答案我也不知道，我们来试一试。</p>
<pre><code class="hljs language-shell" lang="shell">python poc.py https://xxx.xxx.com
</code></pre>
<p>生产环境我们用域名来实现访问的所以地址是上面的信息（我这里影藏了。）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7725baac73804b82892e540ad3e817af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=i3XZFO0m6smfRrksfmUWhX0Idk0%3D" alt="image-20251210143455362" loading="lazy"/></p>
<p>返回了一串信息还有一个403。返回信息是一个HTML，我们抓出来保存HTML</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae4119049fdc4a1f914087a2356fd8f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=yH1g7Z0%2B0HAFsYmWvjKHo8N45Cs%3D" alt="image-20251210143608687" loading="lazy"/></p>
<p>我们看到这里的POC请求被我们的雷池WAF成功拦截了。因为这个是一个反序列化漏洞，WAF通过判断成功拦截了一些非法请求。成功保护了我们后端程序不给其他非法工具攻击成功。</p>
<p>所以生产环境中我们在前端增加一个WAF防护拦截还是有必要的。这样我们可以给后端程序争取升级的时间，有效的包含我们的信息资产不会被攻击到。</p>
<h2 data-id="heading-13">升级漏洞修复</h2>
<h3 data-id="heading-14">升级包介绍</h3>
<p>知道了上面的安全漏洞我们按照官方提供的安全漏洞镜像包升级就可以了。我们在dify官方镜像包</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05dbd70c3d9b45c7a2ac72ad74d12527~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=qCLre2thsUXuv3Y%2Bky9W%2B9Imqlw%3D" alt="image-20251210144155082" loading="lazy"/></p>
<p>我们把代码下载到本地</p>
<p>我们打开代码进入docker文件夹中找到docker-compose.yaml 并打开它。这个地方其实有一个坑，上周官方紧急修改了BUG，但是这个docker-compose.yaml里面的镜像文件并没有修复还是老的langgenius/dify-api:1.10.1、langgenius/dify-web:1.10.1</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2360905e55e14333821cb2a64ecf07ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=muTDAXELtkAlbrhO2Y2yGASDS7A%3D" alt="image-20251210145019818" loading="lazy"/></p>
<p>我们需要注意这个地方应该是langgenius/dify-web:1.10.1-fix.1、langgenius/dify-api:1.10.1-fix.1</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4802dceb49644ef6bc73a24e846716c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=oBNcZkPUKfluXkWLTO97ihyBYkk%3D" alt="image-20251210145142608" loading="lazy"/></p>
<p>很多小伙伴被坑了一把，服务器我是周末手工升级的，公司的环境我周一（2025年12月8日）安排其他人升级的，结果升级后没有修复这个漏洞复现了。我今天仔细检查了升级的记录发现上述问题。</p>
<p>新的升级包已经修复了这个问题，我看升级时间大概是昨天</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb09e74d74e4426683964437001b17df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=71U2JH2rTVLV1y7cbwaZ7SiZaak%3D" alt="image-20251210145510508" loading="lazy"/></p>
<p>大家可以使用比较工具比较（我平时升级都不是安装官方方式升级，官方升级坑多）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a69845cbef74c92b981f7ba0d276a07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=S9gjUnSkOi680M8yHiVIeXkkA64%3D" alt="image-20251210145742384" loading="lazy"/></p>
<p>确保以上版本是langgenius/dify-web:1.10.1-fix.1、langgenius/dify-api:1.10.1-fix.1 升级后才不会有问题。</p>
<p>顺便提一嘴，我使用的比较工具名字叫做BCompare，写代码、分析代码比较文档神器。我这个工具我用了很多年了推荐给大家。（工具下载大家可以网上搜，这里就不给提供下载包了，包我也没有。）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f88b807a23c45b1b71a3011597f6b7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=qm7Wf8EXFGxMiNvhwsfm9l1zicM%3D" alt="image-20251210153213972" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9666bd409caf442fb6fcaff70121b6b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=sjYGLb6w3cM8wAuUu3peble3se4%3D" alt="image-20251210153151439" loading="lazy"/></p>
<h3 data-id="heading-15">升级复测</h3>
<p>我们确保升级版本是langgenius/dify-web:1.10.1-fix.1、langgenius/dify-api:1.10.1-fix.1 正确的修复镜像后启动dify, 接下来我们还是使用前面的验证脚本测试</p>
<pre><code class="hljs language-shell" lang="shell">python poc.py  http://192.168.210.10
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f21b69f5d4240689b9122b33507ed7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765975233&amp;x-signature=irbi7Dae%2FfYskOBA2skGKd8N19A%3D" alt="image-20251210150011032" loading="lazy"/></p>
<p>出现404了。这个测试方法我是绕过公司网络安全防护WAF验证的。这POC 没有返回信息，说明安全漏洞已经修复没有出现反弹的序列化漏洞了。</p>
<h2 data-id="heading-16">总结</h2>
<p>今天主要带大家了解并实现了Dify平台CVE-2025-55182高危安全漏洞的完整检测与修复流程，该漏洞以"React Server Components反序列化缺陷 + CVSS 10.0满分评级"为核心特征，结合Next.js App Router架构和Flight协议的不安全反序列化机制，通过无需身份验证的恶意HTTP请求直接触发远程代码执行，形成了一套从漏洞检测到安全加固的全链路防御方案。</p>
<p>在实际应用中，该修复方案不仅解决了React生态史上最严重的安全漏洞威胁，还通过对比CSR/SSR/RSC三代架构演进揭示了Flight协议设计缺陷的根本原因，技术深度远超简单的"打补丁"操作；特别是通过真实的生产环境WAF拦截案例、官方镜像标签错误踩坑经历、周末紧急升级与周一复测失败的血泪教训等关键信息点，有效帮助小伙伴们避开升级过程中12月6-8日期间docker-compose.yaml配置文件未更新-fix.1后缀的致命陷阱。</p>
<p>感兴趣的小伙伴可以按照文中提供的步骤进行实践，根据实际部署架构调整镜像版本检查和POC测试方法。今天的分享就到这里结束了，我们下一篇文章见。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【鸿蒙开发案例篇】鸿蒙跨设备实时滤镜同步的完整方案]]></title>    <link>https://juejin.cn/post/7581858890608476196</link>    <guid>https://juejin.cn/post/7581858890608476196</guid>    <pubDate>2025-12-10T11:14:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581858890608476196" data-draft-id="7581995152190783530" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【鸿蒙开发案例篇】鸿蒙跨设备实时滤镜同步的完整方案"/> <meta itemprop="keywords" content="HarmonyOS,ArkTS,ArkUI"/> <meta itemprop="datePublished" content="2025-12-10T11:14:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="威哥爱编程"/> <meta itemprop="url" content="https://juejin.cn/user/2242659450109575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【鸿蒙开发案例篇】鸿蒙跨设备实时滤镜同步的完整方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659450109575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    威哥爱编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T11:14:37.000Z" title="Wed Dec 10 2025 11:14:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 V 哥。鸿蒙在跨设备数据传输的能力，即丝滑又酷炫，今天的内容，V 哥想分享一下基于鸿蒙 6.0（API21）实现跨设备实时滤镜同步的完整方案，结合分布式软总线与 <code>PixelMap</code> 的协同处理流程：</p>
<p>联系V哥获取 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F042cb1cc4d7d44ecbdbd902fd1275dcc%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/042cb1cc4d7d44ecbdbd902fd1275dcc?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">鸿蒙学习资料</a></p>
<hr/>
<h3 data-id="heading-0">一、技术架构设计</h3>

























<table><thead><tr><th>层级</th><th>组件</th><th>功能说明</th></tr></thead><tbody><tr><td><strong>应用层</strong></td><td>手机（客户端）</td><td>调用相机生成 <code>PixelMap</code>，应用滤镜算法，通过 RPC 发送数据</td></tr><tr><td><strong>传输层</strong></td><td>分布式软总线（SoftBus）</td><td>设备自动发现、低延迟传输渲染指令流</td></tr><tr><td><strong>渲染层</strong></td><td>平板（服务端）</td><td>接收 <code>PixelMap</code> 数据流，通过 <code>CanvasRenderer</code> 实时渲染</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-1">二、核心实现步骤</h3>
<h4 data-id="heading-2">1. <strong>环境配置与权限声明</strong></h4>
<p>在 <code>module.json5</code> 中添加分布式能力与相机权限：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  &amp;#<span class="hljs-number">34</span>;module&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    &amp;#<span class="hljs-number">34</span>;requestPermissions&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        &amp;#<span class="hljs-number">34</span>;name&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;ohos.permission.DISTRIBUTED_DATASYNC&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 分布式数据同步</span>
        &amp;#<span class="hljs-number">34</span>;reason&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;跨设备传输PixelMap数据&amp;#<span class="hljs-number">34</span>;
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        &amp;#<span class="hljs-number">34</span>;name&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;ohos.permission.CAMERA&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
        &amp;#<span class="hljs-number">34</span>;usedScene&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> &amp;#<span class="hljs-number">34</span>;abilities&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>&amp;#<span class="hljs-number">34</span>;CameraAbility&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">]</span> <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    &amp;#<span class="hljs-number">34</span>;abilities&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        &amp;#<span class="hljs-number">34</span>;name&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;CameraAbility&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
        &amp;#<span class="hljs-number">34</span>;distributedEnabled&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>  <span class="hljs-comment">// 启用分布式能力</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-3">2. <strong>设备发现与连接管理</strong></h4>
<p>使用 <code>DistributedDeviceManager</code> 获取目标设备 NetworkId：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> distributedDeviceManager <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.distributedDeviceManager'</span>;

<span class="hljs-comment">// 发现可用设备</span>
<span class="hljs-keyword">let</span> deviceManager = distributedDeviceManager.<span class="hljs-title function_">createDeviceManager</span>(context);
<span class="hljs-keyword">let</span> deviceList = deviceManager.<span class="hljs-title function_">getTrustedDeviceListSync</span>();
<span class="hljs-keyword">let</span> targetDevice = deviceList.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">device</span> =&gt;</span> device.<span class="hljs-property">deviceName</span> === &amp;#<span class="hljs-number">34</span>;平板设备&amp;#<span class="hljs-number">34</span>;);
<span class="hljs-keyword">let</span> networkId = targetDevice.<span class="hljs-property">networkId</span>;
</code></pre>
<h4 data-id="heading-4">3. <strong>手机端：相机捕获与滤镜处理</strong></h4>
<p>通过 <code>@ohos.multimedia.camera</code> 获取相机帧数据并转换为 <code>PixelMap</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> camera <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.multimedia.camera'</span>;

<span class="hljs-comment">// 创建相机预览流</span>
camera.<span class="hljs-title function_">createPreviewOutput</span>(cameraManager, surfaceId).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">previewOutput</span>) =&gt;</span> {
  previewOutput.<span class="hljs-title function_">on</span>(<span class="hljs-string">'frameStart'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 获取图像数据并应用滤镜</span>
    <span class="hljs-keyword">let</span> pixelMap = <span class="hljs-keyword">await</span> image.<span class="hljs-title function_">createPixelMapFromSurface</span>(surfaceId);
    <span class="hljs-keyword">let</span> filteredPixelMap = <span class="hljs-title function_">applySepiaFilter</span>(pixelMap);  <span class="hljs-comment">// 示例：棕褐色滤镜</span>
    <span class="hljs-title function_">sendToTablet</span>(filteredPixelMap, networkId);
  });
});

<span class="hljs-comment">// 滤镜算法示例（棕褐色调）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">applySepiaFilter</span>(<span class="hljs-params">pixelMap: image.PixelMap</span>): image.<span class="hljs-property">PixelMap</span> {
  <span class="hljs-keyword">let</span> arrayBuffer = <span class="hljs-keyword">await</span> pixelMap.<span class="hljs-title function_">getImageData</span>();
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arrayBuffer.<span class="hljs-property">length</span>; i += <span class="hljs-number">4</span>) {
    <span class="hljs-keyword">let</span> r = arrayBuffer[i], g = arrayBuffer[i+<span class="hljs-number">1</span>], b = arrayBuffer[i+<span class="hljs-number">2</span>];
    arrayBuffer[i] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">255</span>, (r * <span class="hljs-number">0.393</span>) + (g * <span class="hljs-number">0.769</span>) + (b * <span class="hljs-number">0.189</span>));
    arrayBuffer[i+<span class="hljs-number">1</span>] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">255</span>, (r * <span class="hljs-number">0.349</span>) + (g * <span class="hljs-number">0.686</span>) + (b * <span class="hljs-number">0.168</span>));
    arrayBuffer[i+<span class="hljs-number">2</span>] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">255</span>, (r * <span class="hljs-number">0.272</span>) + (g * <span class="hljs-number">0.534</span>) + (b * <span class="hljs-number">0.131</span>));
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> image.<span class="hljs-title function_">createPixelMapFromData</span>(arrayBuffer, pixelMap.<span class="hljs-title function_">getImageInfo</span>());
}
</code></pre>
<h4 data-id="heading-5">4. <strong>跨设备数据传输（RPC 调用）</strong></h4>
<p><strong>服务端（平板）定义远程接口</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> rpc <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.rpc'</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FilterService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">rpc.RemoteObject</span> {
  <span class="hljs-comment">// 接收手机端发送的PixelMap数据</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onRemoteMessageRequest</span>(<span class="hljs-params">code: <span class="hljs-built_in">number</span>, data: rpc.MessageSequence, reply: rpc.MessageSequence</span>) {
    <span class="hljs-keyword">if</span> (code === <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">let</span> pixelMapData = data.<span class="hljs-title function_">readObject</span>() <span class="hljs-keyword">as</span> image.<span class="hljs-property">PixelMap</span>;  <span class="hljs-comment">// 反序列化数据</span>
      <span class="hljs-title function_">renderOnCanvas</span>(pixelMapData);  <span class="hljs-comment">// 在平板端渲染</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
}
</code></pre>
<p><strong>客户端（手机）绑定服务并发送数据</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 构造Want对象绑定平板服务</span>
<span class="hljs-keyword">let</span> want = {
  <span class="hljs-attr">bundleName</span>: &amp;#<span class="hljs-number">34</span>;com.<span class="hljs-property">example</span>.<span class="hljs-property">tabletapp</span>&amp;#<span class="hljs-number">34</span>;,
  <span class="hljs-attr">abilityName</span>: &amp;#<span class="hljs-number">34</span>;<span class="hljs-title class_">FilterServiceAbility</span>&amp;#<span class="hljs-number">34</span>;,
  <span class="hljs-attr">deviceId</span>: networkId  <span class="hljs-comment">// 目标设备标识</span>
};

<span class="hljs-comment">// 发送滤镜处理后的PixelMap</span>
<span class="hljs-keyword">let</span> proxy = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Context</span>.<span class="hljs-title function_">connectService</span>(want);
<span class="hljs-keyword">let</span> data = rpc.<span class="hljs-property">MessageSequence</span>.<span class="hljs-title function_">create</span>();
data.<span class="hljs-title function_">writeObject</span>(pixelMap);
proxy.<span class="hljs-title function_">sendMessageRequest</span>(<span class="hljs-number">1</span>, data);
</code></pre>
<h4 data-id="heading-6">5. <strong>平板端：实时渲染与显示</strong></h4>
<p>使用 <code>CanvasRenderer</code> 渲染接收到的 <code>PixelMap</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> ui <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.arkui.ui'</span>;

<span class="hljs-comment">// 创建画布组件</span>
struct <span class="hljs-title class_">FilterCanvas</span> {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">pixelMap</span>: image.<span class="hljs-property">PixelMap</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Canvas</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">onCanvasReady</span>)
      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
  }

  <span class="hljs-title function_">onCanvasReady</span>(<span class="hljs-params">ctx: CanvasRenderingContext2D</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pixelMap</span>) {
      ctx.<span class="hljs-title function_">drawImage</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pixelMap</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">360</span>, <span class="hljs-number">640</span>);  <span class="hljs-comment">// 渲染图像</span>
    }
  }

  <span class="hljs-comment">// 接收手机端数据更新UI</span>
  <span class="hljs-title function_">updatePixelMap</span>(<span class="hljs-params">newPixelMap: image.PixelMap</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pixelMap</span> = newPixelMap;
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-7">三、性能优化关键点</h3>
<ol>
<li>
<p><strong>数据压缩传输</strong></p>
<ul>
<li>将 <code>PixelMap</code> 转换为 <code>ArrayBuffer</code> 后使用 LZ4 压缩，减少软总线带宽占用。</li>
<li>代码示例：
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> compressedData = zlib.<span class="hljs-title function_">compress</span>(pixelMap.<span class="hljs-title function_">getImageData</span>(), { <span class="hljs-attr">level</span>: <span class="hljs-number">3</span> });
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>渲染帧率控制</strong></p>
<ul>
<li>通过 <code>requestAnimationFrame</code> 限制刷新率（如 30fps），避免平板端过载。</li>
</ul>
</li>
<li>
<p><strong>错误处理与重连</strong></p>
<ul>
<li>监听设备断开事件，自动切换至本地渲染：
<pre><code class="hljs language-typescript" lang="typescript">deviceManager.<span class="hljs-title function_">on</span>(<span class="hljs-string">'deviceOffline'</span>, <span class="hljs-function">(<span class="hljs-params">device</span>) =&gt;</span> {
  <span class="hljs-title function_">showDialog</span>(<span class="hljs-string">'设备断开，已切换本地模式'</span>);
  <span class="hljs-title function_">switchToLocalRender</span>();
});
</code></pre>
</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-8">四、完整流程示意图</h3>
<pre><code class="hljs language-css" lang="css">手机端采集 → 滤镜处理 → 软总线传输 → 平板渲染 → 显示反馈
    ↓          ↓           ↓           ↓         ↓
  Camera → PixelMap → RPC调用 → <span class="hljs-selector-tag">Canvas</span> → UI更新
</code></pre>
<hr/>
<h3 data-id="heading-9">注意事项</h3>
<ol>
<li><strong>设备兼容性</strong>：需确保双端设备为 HarmonyOS 6.0 及以上版本，且登录同一华为账号。</li>
<li><strong>延迟优化</strong>：若传输延迟 &gt;100ms，可降低图像分辨率（如 720p→480p）。</li>
<li><strong>隐私安全</strong>：传输的 <code>PixelMap</code> 数据需在本地完成脱敏处理，避免敏感信息泄露。</li>
</ol>
<p>通过以上方案，可实现手机拍摄后滤镜效果实时同步至平板渲染，充分发挥鸿蒙分布式能力与图像处理性能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter Path.computeMetrics() 的使用注意点]]></title>    <link>https://juejin.cn/post/7582003642191937578</link>    <guid>https://juejin.cn/post/7582003642191937578</guid>    <pubDate>2025-12-10T11:20:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582003642191937578" data-draft-id="7581858890608492580" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter Path.computeMetrics() 的使用注意点"/> <meta itemprop="keywords" content="Flutter,Android"/> <meta itemprop="datePublished" content="2025-12-10T11:20:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火柴就是我"/> <meta itemprop="url" content="https://juejin.cn/user/272334614705575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter Path.computeMetrics() 的使用注意点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/272334614705575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火柴就是我
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T11:20:00.000Z" title="Wed Dec 10 2025 11:20:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>一个Path转虚线的扩展</p>
<pre><code class="hljs language-java" lang="java">extension DashedPathExtension on Path {
  <span class="hljs-comment">/// 转换为虚线 Path（安全版）</span>
  <span class="hljs-comment">/// [solidLength]：实线段长度（像素）</span>
  <span class="hljs-comment">/// [gapLength]：空线段长度（像素）</span>
  <span class="hljs-comment">/// 返回：新的虚线 Path（原 Path 不变）</span>
  Path <span class="hljs-title function_">toDashedPath</span><span class="hljs-params">({
    required <span class="hljs-type">double</span> solidLength,
    required <span class="hljs-type">double</span> gapLength,
  })</span> {
    <span class="hljs-comment">// 前置参数校验</span>
    <span class="hljs-keyword">assert</span>(solidLength &gt; <span class="hljs-number">0</span>, &amp;#<span class="hljs-number">34</span>;实线段长度必须大于<span class="hljs-number">0</span>&amp;#<span class="hljs-number">34</span>;);
    <span class="hljs-keyword">assert</span>(gapLength &gt;= <span class="hljs-number">0</span>, &amp;#<span class="hljs-number">34</span>;空线段长度不能为负数&amp;#<span class="hljs-number">34</span>;);

    <span class="hljs-comment">// 1. 安全获取 PathMetrics 并校验</span>
    <span class="hljs-comment">//final PathMetrics metrics = computeMetrics();</span>
    <span class="hljs-comment">// // 校验1：PathMetrics 为空 → 返回空 Path</span>
    <span class="hljs-comment">//if (metrics.isEmpty) return Path();</span>

    <span class="hljs-comment">// 2. 遍历 metrics（兼容多段路径），避免 first 直接报错</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">Path</span> <span class="hljs-variable">dashedPath</span> <span class="hljs-operator">=</span> Path();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> PathMetric metric in <span class="hljs-title function_">computeMetrics</span><span class="hljs-params">()</span>) {
      <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> <span class="hljs-variable">totalLength</span> <span class="hljs-operator">=</span> metric.length;
      <span class="hljs-comment">// 校验2：单段路径长度为0 → 跳过</span>
      <span class="hljs-keyword">if</span> (totalLength &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;

      <span class="hljs-comment">// 3. 循环绘制实线段（始终从实线开始）</span>
      <span class="hljs-type">double</span> <span class="hljs-variable">currentDistance</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.0</span>;
      <span class="hljs-keyword">while</span> (currentDistance &lt; totalLength) {
        <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> <span class="hljs-variable">solidEnd</span> <span class="hljs-operator">=</span> currentDistance + solidLength;
        <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> <span class="hljs-variable">actualEnd</span> <span class="hljs-operator">=</span> solidEnd &gt; totalLength ? totalLength : solidEnd;

        <span class="hljs-comment">// 提取实线段并添加到虚线 Path</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">Path</span> <span class="hljs-variable">segment</span> <span class="hljs-operator">=</span> metric.extractPath(currentDistance, actualEnd);
        dashedPath.addPath(segment, Offset.zero);

        <span class="hljs-comment">// 跳过空线段</span>
        currentDistance = solidEnd + gapLength;
      }
    }

    <span class="hljs-keyword">return</span> dashedPath;
  }
}
</code></pre>
<p>注意点是这个</p>
<pre><code class="hljs language-js" lang="js">    <span class="hljs-comment">// 1. 安全获取 PathMetrics 并校验</span>
    <span class="hljs-comment">// final PathMetrics metrics = computeMetrics();</span>
    <span class="hljs-comment">// // // 校验1：PathMetrics 为空 → 返回空 Path</span>
    <span class="hljs-comment">// if (metrics.isEmpty) return Path();</span>
</code></pre>
<p>这里调用了 metrics.isEmpty()</p>
<pre><code class="hljs language-js" lang="js">  bool get isEmpty =&gt; !iterator.<span class="hljs-title function_">moveNext</span>();
</code></pre>
<p>也就是调用了迭代器的moveNext() 再次遍历metrics 就会从第二个元素开始。
如果迭代器本身只有一个元素,这个时候调用metrics.first 救护报错no element。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Expo (React Native) 本地存储全攻略：普通数据与敏感数据该存哪？]]></title>    <link>https://juejin.cn/post/7582036070159269888</link>    <guid>https://juejin.cn/post/7582036070159269888</guid>    <pubDate>2025-12-10T11:29:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582036070159269888" data-draft-id="7581876069609504811" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Expo (React Native) 本地存储全攻略：普通数据与敏感数据该存哪？"/> <meta itemprop="keywords" content="前端,React Native"/> <meta itemprop="datePublished" content="2025-12-10T11:29:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Expo (React Native) 本地存储全攻略：普通数据与敏感数据该存哪？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T11:29:43.000Z" title="Wed Dec 10 2025 11:29:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在移动应用开发中，<strong>数据持久化</strong>（Data Persistence）是绕不开的话题。无论是为了让用户免于重复登录，还是保存用户的偏好设置（如深色模式），我们都需要将数据存储在用户的设备上。</p>
<p>对于使用 Expo 开发的 React Native 项目，官方推荐了两种截然不同的存储方案：<strong><code>AsyncStorage</code></strong> 和 <strong><code>expo-secure-store</code></strong>。</p>
<p>本文将深入解析这两者的区别、适用场景，并教你如何在项目中优雅地封装它们。</p>
<hr/>
<h2 data-id="heading-0">方案一：AsyncStorage（通用存储）</h2>
<p><strong>AsyncStorage</strong> 是 React Native 社区维护的一个异步、非加密的键值对（Key-Value）存储系统。你可以把它想象成浏览器端的 <code>localStorage</code>。</p>
<h3 data-id="heading-1">1. 适用场景</h3>
<p>由于它是<strong>未加密</strong>的，任何拥有设备文件系统访问权限的人（或恶意软件）都能读取这些数据。因此，它<strong>只适合</strong>存储：</p>
<ul>
<li>✅ 用户偏好设置（如：是否开启推送、语言设置、主题色）</li>
<li>✅ 应用缓存数据（如：首页的临时数据列表）</li>
<li>✅ Redux/Zustand 状态的持久化</li>
<li>❌ <strong>绝对不要存</strong>：用户密码、身份认证 Token、信用卡信息</li>
</ul>
<h3 data-id="heading-2">2. 安装</h3>
<pre><code class="hljs language-Bash" lang="Bash">npx expo install @react-native-async-storage/async-storage
</code></pre>
<h3 data-id="heading-3">3. 使用示例</h3>
<p>AsyncStorage 只能存储字符串。如果你要存储对象，需要使用 <code>JSON.stringify</code> 和 <code>JSON.parse</code> 进行转换。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">AsyncStorage</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@react-native-async-storage/async-storage'</span>;

<span class="hljs-comment">// 1. 存储数据 (Key 必须是字符串，Value 也必须是字符串)</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">saveSettings</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">AsyncStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'app_theme'</span>, <span class="hljs-string">'dark'</span>);
    <span class="hljs-comment">// 存储对象需序列化</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">AsyncStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'user_profile'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'John'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> }));
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'保存失败'</span>, e);
  }
};

<span class="hljs-comment">// 2. 读取数据</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">loadSettings</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> theme = <span class="hljs-keyword">await</span> <span class="hljs-title class_">AsyncStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'app_theme'</span>);
    
    <span class="hljs-keyword">const</span> jsonValue = <span class="hljs-keyword">await</span> <span class="hljs-title class_">AsyncStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'user_profile'</span>);
    <span class="hljs-keyword">const</span> userProfile = jsonValue != <span class="hljs-literal">null</span> ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(jsonValue) : <span class="hljs-literal">null</span>;
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(theme, userProfile);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'读取失败'</span>, e);
  }
};

<span class="hljs-comment">// 3. 删除/清空</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">clearData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">AsyncStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'app_theme'</span>); <span class="hljs-comment">// 删除单个</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">AsyncStorage</span>.<span class="hljs-title function_">clear</span>(); <span class="hljs-comment">// 清空所有（慎用）</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-4">方案二：expo-secure-store（安全存储）</h2>
<p><strong>SecureStore</strong> 是 Expo 提供的一个库，它利用了操作系统底层的安全机制来加密存储数据。</p>
<ul>
<li><strong>iOS</strong>: 使用 <strong>Keychain Services</strong>（钥匙串）。</li>
<li><strong>Android</strong>: 使用 <strong>SharedPreferences</strong>（配合 Keystore 加密）。</li>
</ul>
<h3 data-id="heading-5">1. 适用场景</h3>
<p>这是存储敏感数据的唯一正确选择：</p>
<ul>
<li>✅ 身份认证 Token (Auth Token / Refresh Token)</li>
<li>✅ 用户密码 (Password)</li>
<li>✅ API 密钥 (API Keys)</li>
</ul>
<h3 data-id="heading-6">2. 安装</h3>
<pre><code class="hljs language-Bash" lang="Bash">npx expo install expo-secure-store
</code></pre>
<h3 data-id="heading-7">3. 使用示例</h3>
<p>API 与 AsyncStorage 非常相似，但它保证了数据是加密落盘的。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">SecureStore</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'expo-secure-store'</span>;

<span class="hljs-comment">// 1. 存储敏感数据</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">saveToken</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">token: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-comment">// 注意：Key 和 Value 都必须是字符串</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">SecureStore</span>.<span class="hljs-title function_">setItemAsync</span>(<span class="hljs-string">'user_token'</span>, token);
};

<span class="hljs-comment">// 2. 读取数据</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getToken</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> token = <span class="hljs-keyword">await</span> <span class="hljs-title class_">SecureStore</span>.<span class="hljs-title function_">getItemAsync</span>(<span class="hljs-string">'user_token'</span>);
  <span class="hljs-keyword">if</span> (token) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'获取到 Token:'</span>, token);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'未找到 Token'</span>);
  }
};

<span class="hljs-comment">// 3. 删除数据 (如用户登出时)</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">removeToken</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">SecureStore</span>.<span class="hljs-title function_">deleteItemAsync</span>(<span class="hljs-string">'user_token'</span>);
};
</code></pre>
<hr/>
<h2 data-id="heading-8">深度对比：该选哪一个？</h2>



































<table><thead><tr><th><strong>特性</strong></th><th><strong>AsyncStorage</strong></th><th><strong>SecureStore</strong></th></tr></thead><tbody><tr><td><strong>安全性</strong></td><td>🚨 <strong>低</strong> (明文存储，类似 TXT 文件)</td><td>🔒 <strong>高</strong> (OS 级硬件加密)</td></tr><tr><td><strong>存储容量</strong></td><td>较大 (几 MB 到几十 MB 没问题)</td><td>极小 (建议只存 &lt; 2KB 的短字符串)</td></tr><tr><td><strong>读写速度</strong></td><td>快</td><td>稍慢 (涉及解密过程)</td></tr><tr><td><strong>数据类型</strong></td><td>仅字符串 (需手动 JSON 序列化)</td><td>仅字符串</td></tr><tr><td><strong>核心用途</strong></td><td>缓存、设置、非敏感状态</td><td><strong>Token、密码、证书</strong></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-9">最佳实践：封装统一的存储工具</h2>
<p>在真实的项目开发中，我们不应该在 UI 组件里直接调用 <code>AsyncStorage</code> 或 <code>SecureStore</code>，而是应该封装一个工具模块。这样既能统一管理 Key，又能屏蔽底层实现的差异。</p>
<p>以下是一个推荐的 <strong><code>utils/storage.ts</code></strong> 封装示例：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// utils/storage.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AsyncStorage</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@react-native-async-storage/async-storage'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">SecureStore</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'expo-secure-store'</span>;

<span class="hljs-comment">// 定义所有的 Key，防止手误写错</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">KEYS</span> = {
  <span class="hljs-attr">TOKEN</span>: <span class="hljs-string">'auth_token'</span>,
  <span class="hljs-attr">USER_INFO</span>: <span class="hljs-string">'user_info'</span>,
  <span class="hljs-attr">THEME</span>: <span class="hljs-string">'app_theme'</span>,
};

<span class="hljs-comment">/**
 * 敏感数据存储工具 (使用 SecureStore)
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AuthStorage</span> = {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">setToken</span>(<span class="hljs-params">token: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">SecureStore</span>.<span class="hljs-title function_">setItemAsync</span>(<span class="hljs-variable constant_">KEYS</span>.<span class="hljs-property">TOKEN</span>, token);
  },

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getToken</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title class_">SecureStore</span>.<span class="hljs-title function_">getItemAsync</span>(<span class="hljs-variable constant_">KEYS</span>.<span class="hljs-property">TOKEN</span>);
  },

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">clearToken</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">SecureStore</span>.<span class="hljs-title function_">deleteItemAsync</span>(<span class="hljs-variable constant_">KEYS</span>.<span class="hljs-property">TOKEN</span>);
  },
};

<span class="hljs-comment">/**
 * 普通数据存储工具 (使用 AsyncStorage)
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AppStorage</span> = {
  <span class="hljs-comment">// 封装对象存储，自动处理 JSON 转换</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">setUser</span>(<span class="hljs-params">user: <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> jsonValue = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(user);
      <span class="hljs-keyword">await</span> <span class="hljs-title class_">AsyncStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-variable constant_">KEYS</span>.<span class="hljs-property">USER_INFO</span>, jsonValue);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Saving user failed'</span>, e);
    }
  },

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getUser</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> jsonValue = <span class="hljs-keyword">await</span> <span class="hljs-title class_">AsyncStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-variable constant_">KEYS</span>.<span class="hljs-property">USER_INFO</span>);
      <span class="hljs-keyword">return</span> jsonValue != <span class="hljs-literal">null</span> ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(jsonValue) : <span class="hljs-literal">null</span>;
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Loading user failed'</span>, e);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
  },
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">clearAll</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">await</span> <span class="hljs-title class_">AsyncStorage</span>.<span class="hljs-title function_">clear</span>();
  }
};
</code></pre>
<h3 data-id="heading-10">如何在业务中使用？</h3>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AuthStorage</span>, <span class="hljs-title class_">AppStorage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/storage'</span>;

<span class="hljs-comment">// 登录成功后</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLoginSuccess</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">apiResponse</span>) =&gt; {
    <span class="hljs-keyword">const</span> { token, user } = apiResponse;
    
    <span class="hljs-comment">// 1. Token 进保险箱</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">AuthStorage</span>.<span class="hljs-title function_">setToken</span>(token);
    
    <span class="hljs-comment">// 2. 用户信息进普通仓库</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setUser</span>(user);
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'登录数据已持久化'</span>);
};

<span class="hljs-comment">// 退出登录时</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogout</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">AuthStorage</span>.<span class="hljs-title function_">clearToken</span>();
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setUser</span>(<span class="hljs-literal">null</span>); 
};
</code></pre>
<h2 data-id="heading-11">总结</h2>
<p>在 React Native (Expo) 开发中，请务必遵守 <strong>“数据分级”</strong> 原则：</p>
<ol>
<li><strong>Token 和密码</strong>：必须通过 <code>expo-secure-store</code> 放入系统的“保险箱”。</li>
<li><strong>设置和缓存</strong>：可以通过 <code>@react-native-async-storage/async-storage</code> 放入普通的“储物柜”。</li>
</ol>
<p>通过合理的封装，你可以让代码更安全、更整洁，也更易于维护。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VS Code终端从入门到精通完全指南]]></title>    <link>https://juejin.cn/post/7581995152190849066</link>    <guid>https://juejin.cn/post/7581995152190849066</guid>    <pubDate>2025-12-10T11:32:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581995152190849066" data-draft-id="7582003642191986730" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VS Code终端从入门到精通完全指南"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-12-10T11:32:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VS Code终端从入门到精通完全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T11:32:13.000Z" title="Wed Dec 10 2025 11:32:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当前，Visual Studio Code的集成终端已成为开发者日常工作中不可或缺的工具。它不仅能运行 <code>echo</code>、 <code>ls</code> 和 <code>git</code> 等命令，还与编辑器深度集成，支持工作区文件链接和错误检测等功能。无论你是使用Bash、Zsh还是PowerShell，VS Code终端都能满足你的需求。</p>
<p>打开终端的三种方式：</p>
<ul>
<li>快捷键： <code>Ctrl+``（Windows/Linux）或</code>Cmd+``（macOS）</li>
<li>菜单栏：<strong>查看 &gt; 终端</strong></li>
<li>命令面板： <code>Ctrl+Shift+P</code> 输入<strong>终端：新建终端</strong></li>
</ul>
<p>终端默认工作目录为当前打开的VS Code项目根目录，这意味着你可以直接运行与项目相关的命令，无需额外切换路径。</p>
<h2 data-id="heading-0">基础操作</h2>
<p>VS Code终端提供丰富的交互功能，让你能够高效地与命令输出进行交互。命令通常会输出文件路径或URL，你只需按住Ctrl/Cmd键，将鼠标悬停在文件名上，然后点击链接，VS Code会自动在编辑器中打开该文件。对于URL，点击后会在默认浏览器中打开。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84d6c57dd60b450e92beef7718da6538~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765971132&amp;x-signature=4H%2FOhO%2FDF18%2BzKMRRk2OyHbSps8%3D" alt="image.png" loading="lazy"/></p>
<p>核心快捷键一览：</p>
<ul>
<li>新建终端： `Ctrl+Shift+``</li>
<li>切换终端： <code>Ctrl+PageUp/PageDown</code></li>
<li>分屏终端： <code>Ctrl+\</code>（Windows/Linux）或 <code>Cmd+\</code>（macOS）</li>
<li>关闭终端： <code>Ctrl+Shift+W</code></li>
</ul>
<p>命令历史导航：</p>
<ul>
<li>向上查看历史命令： <code>↑</code> 键</li>
<li>向下查看历史命令： <code>↓</code> 键</li>
<li>搜索历史命令： <code>Ctrl+R</code>（Bash/Zsh）或 <code>F8</code>（PowerShell）</li>
</ul>
<p>创建命令列表文件示例：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Bash/Zsh</span>
<span class="hljs-built_in">ls</span> -l /usr/bin &gt; Command.txt

<span class="hljs-comment"># PowerShell</span>
Get-Command | Out-File -FilePath .\Command.txt
</code></pre>
<h2 data-id="heading-1">配置文件</h2>
<p>终端配置文件是特定于平台的shell配置，由可执行文件路径、参数和其他自定义项组成。VS Code会自动检测几个常见的配置文件，你也可以根据需要进行自定义或添加新的配置文件。</p>
<p>设置默认配置文件步骤：</p>
<ul>
<li>打开命令面板（ <code>Ctrl+Shift+P</code>）</li>
<li>搜索"终端: 选择默认配置文件"</li>
<li>从下拉菜单中选择你常用的shell</li>
</ul>
<p>默认情况下，Linux和macOS上的默认shell是 <code>$SHELL</code> 环境变量指定的程序，Windows系统默认使用PowerShell。</p>
<p>自定义配置文件示例（settings.json）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  &amp;#<span class="hljs-number">34</span>;terminal.integrated.profiles.windows&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    &amp;#<span class="hljs-number">34</span>;PowerShell - NoProfile&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      &amp;#<span class="hljs-number">34</span>;source&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;PowerShell&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
      &amp;#<span class="hljs-number">34</span>;args&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>&amp;#<span class="hljs-number">34</span>;-NoProfile&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    &amp;#<span class="hljs-number">34</span>;Git Bash&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      &amp;#<span class="hljs-number">34</span>;path&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;C<span class="hljs-punctuation">:</span>\\Program Files\\Git\\bin\\bash.exe&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
      &amp;#<span class="hljs-number">34</span>;args&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>&amp;#<span class="hljs-number">34</span>;--login&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;terminal.integrated.defaultProfile.windows&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;Git Bash&amp;#<span class="hljs-number">34</span>;
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-2">Shell集成</h2>
<p>VS Code能够与常见的Shell集成，使终端可以更深入地了解Shell内部的情况。这种集成启用了工作目录检测、命令检测、装饰和导航等有用功能。</p>
<p>支持的Shell包括Linux/macOS上的bash、fish、pwsh、zsh，以及Windows上的Git Bash和pwsh。默认情况下，当从VS Code启动受支持的Shell时，Shell集成脚本会自动激活。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44b355fbec424e5e8275491b8a54f1f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765971132&amp;x-signature=NXlmF6%2Fyz06hJSfBTsrjT04vTVs%3D" alt="image.png" loading="lazy"/></p>
<p>手动安装Shell集成（以bash为例）：</p>
<ul>
<li>打开配置文件： <code>code ~/.bashrc</code></li>
<li>添加以下内容：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">[[ &amp;<span class="hljs-comment">#34;$TERM_PROGRAM&amp;#34; == &amp;#34;vscode&amp;#34; ]] &amp;&amp; . &amp;#34;$(code --locate-shell-integration-path bash)&amp;#34;</span>
</code></pre>
<ul>
<li>重新加载配置： <code>source ~/.bashrc</code></li>
</ul>
<p>Shell集成质量分为"无"、"丰富"和"基本"三个等级。将鼠标悬停在终端选项卡上可以查看当前的集成质量状态。</p>
<h2 data-id="heading-3">外观设置</h2>
<p>VS Code终端的外观可以进行广泛的自定义，包括文本样式、光标样式和选项卡等。通过调整这些设置，你可以打造一个既美观又符合个人习惯的终端环境。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae78ca4728114d5d88c0be960dc88101~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765971132&amp;x-signature=h5QGs71bzL1R1B1B3xBrAw6u6bY%3D" alt="image.png" loading="lazy"/></p>
<p>常用外观设置（settings.json）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  &amp;#<span class="hljs-number">34</span>;terminal.integrated.fontFamily&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;'Fira Code'<span class="hljs-punctuation">,</span> 'Hack NF'<span class="hljs-punctuation">,</span> monospace&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;terminal.integrated.fontSize&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-number">14</span><span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;terminal.integrated.lineHeight&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-number">1.2</span><span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;terminal.integrated.cursorStyle&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;line&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;terminal.integrated.cursorWidth&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;terminal.integrated.cursorBlinking&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;workbench.colorCustomizations&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    &amp;#<span class="hljs-number">34</span>;terminal.background&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;#<span class="hljs-number">1e1</span>e1e&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
    &amp;#<span class="hljs-number">34</span>;terminal.foreground&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;#e0e0e0&amp;#<span class="hljs-number">34</span>;
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Powerline和Nerd Fonts配置：</p>
<pre><code class="hljs language-json" lang="json">&amp;#<span class="hljs-number">34</span>;terminal.integrated.fontFamily&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;'DejaVu Sans Mono for Powerline'<span class="hljs-punctuation">,</span> 'Hack NF'&amp;#<span class="hljs-number">34</span>;
</code></pre>
<h2 data-id="heading-4">高级功能</h2>
<p>VS Code终端提供了许多高级功能，帮助你进一步提升开发效率。</p>
<h3 data-id="heading-5">持久会话</h3>
<p>终端支持两种持久会话类型：</p>
<ul>
<li>进程重新连接：重新加载窗口时重新连接到先前的进程</li>
<li>进程恢复：重新启动VS Code时恢复终端内容并重新启动进程</li>
</ul>
<p>禁用持久会话：</p>
<pre><code class="hljs language-json" lang="json">&amp;#<span class="hljs-number">34</span>;terminal.integrated.enablePersistentSessions&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
</code></pre>
<h3 data-id="heading-6">命令别名设置</h3>
<p>通过shell配置文件实现常用命令的快捷方式：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Bash/Zsh用户编辑~/.bashrc或~/.zshrc</span>
<span class="hljs-built_in">alias</span> ll=<span class="hljs-string">'ls -la'</span>
<span class="hljs-built_in">alias</span> gs=<span class="hljs-string">'git status'</span>
<span class="hljs-built_in">alias</span> gp=<span class="hljs-string">'git push'</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/787d064309364ed6968e86f8009678a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765971132&amp;x-signature=BjsdY09agq3FF9p5UzyLkJ4TOyc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">自定义键盘快捷键</h3>
<p>在keybindings.json中配置终端快捷键：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  &amp;#<span class="hljs-number">34</span>;key&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;ctrl+shift+t&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;command&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;workbench.action.terminal.sendSequence&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;args&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> &amp;#<span class="hljs-number">34</span>;text&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;npm run dev\n&amp;#<span class="hljs-number">34</span>; <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-8">多终端管理</h3>
<ul>
<li>重命名终端：右键终端选项卡 &gt; <strong>重命名</strong></li>
<li>移动终端：拖拽终端选项卡到编辑器区域或新窗口</li>
<li>终端分组：右键终端 &gt; <strong>移动到新组</strong></li>
</ul>
<h3 data-id="heading-9">任务自动化</h3>
<p>在工作区根目录创建 <code>.vscode/tasks.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  &amp;#<span class="hljs-number">34</span>;version&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;<span class="hljs-number">2.0</span><span class="hljs-number">.0</span>&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
  &amp;#<span class="hljs-number">34</span>;tasks&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      &amp;#<span class="hljs-number">34</span>;label&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;启动开发服务器&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
      &amp;#<span class="hljs-number">34</span>;type&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;shell&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
      &amp;#<span class="hljs-number">34</span>;command&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;npm run dev&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
      &amp;#<span class="hljs-number">34</span>;group&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        &amp;#<span class="hljs-number">34</span>;kind&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> &amp;#<span class="hljs-number">34</span>;build&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">,</span>
        &amp;#<span class="hljs-number">34</span>;isDefault&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      &amp;#<span class="hljs-number">34</span>;problemMatcher&amp;#<span class="hljs-number">34</span>;<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>使用 <code>Ctrl+Shift+B</code> 快速运行任务。</p>
<p>VS Code终端不仅仅是一个命令执行工具，它是你开发工作流的核心部分。花时间配置好终端，每天节省的操作时间会累积成显著的效率优势。无论你是刚入门的新手还是经验丰富的开发者，掌握这些终端技巧都将使你的VS Code体验更加流畅和高效。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[现代C++系统编程中类型重解释的内存安全范式]]></title>    <link>https://juejin.cn/post/7581858890608574500</link>    <guid>https://juejin.cn/post/7581858890608574500</guid>    <pubDate>2025-12-10T11:35:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581858890608574500" data-draft-id="7581876069609553963" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="现代C++系统编程中类型重解释的内存安全范式"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-10T11:35:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            现代C++系统编程中类型重解释的内存安全范式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T11:35:30.000Z" title="Wed Dec 10 2025 11:35:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在底层系统编程领域，指针运算和类型重解释是构建高性能硬件接口和数据处理管道的基石。然而，一个普遍存在的编码模式——<code>reinterpret_cast(byte_buffer[offset])</code>——揭示了程序员对C++指针语义的深层次误解。本文通过形式化分析这一反模式，探讨了地址空间操作与值语义的混淆现象，提出了基于现代C++类型系统的安全访问范式，并建立了防御性指针运算的工程实践框架。</p>
<h2 data-id="heading-0">1. 一个工业级反模式</h2>
<h3 data-id="heading-1">1.1 反模式定义</h3>
<p>考虑以下硬件数据采集系统的典型代码片段：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// PCIe DMA缓冲区数据流处理</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SensorData</span> {
    <span class="hljs-type">float</span> real_component;
    <span class="hljs-type">float</span> imag_component;
    <span class="hljs-type">uint32_t</span> timestamp;
    <span class="hljs-type">uint16_t</span> quality_flag;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataPipeline</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ProcessHardwareData</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span>* dma_buffer, <span class="hljs-type">size_t</span> buffer_capacity)</span> </span>{
        <span class="hljs-keyword">constexpr</span> <span class="hljs-type">size_t</span> protocol_overhead = <span class="hljs-number">64</span>;  <span class="hljs-comment">// 协议头部大小</span>
        
        <span class="hljs-comment">// 反模式：危险的类型重解释</span>
        SensorData* sensor_stream = 
            <span class="hljs-built_in">reinterpret_cast</span>(dma_buffer[protocol_overhead]);
        
        <span class="hljs-built_in">ExtractTelemetry</span>(sensor_stream);
    }
};
</code></pre>
<h3 data-id="heading-2">1.2 语义分析</h3>
<p>上述代码中，程序员意图跳过64字节的协议头部，将后续数据解释为<code>SensorData</code>结构流。然而，表达式的实际语义是：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 语法树分解</span>
dma_buffer[protocol_overhead]           <span class="hljs-comment">// 1. 数组下标操作符，返回uint8_t值</span>
<span class="hljs-built_in">reinterpret_cast</span>(... )     <span class="hljs-comment">// 2. 将8位整数值强制转换为指针</span>

<span class="hljs-comment">// 等价展开</span>
<span class="hljs-type">uint8_t</span> temporary_byte = *(dma_buffer + protocol_overhead);
SensorData* misinterpreted_ptr = <span class="hljs-built_in">reinterpret_cast</span>(
    <span class="hljs-built_in">static_cast</span>(temporary_byte)
);
</code></pre>
<p><strong>关键洞察</strong>：程序员执行的是<strong>值的类型重解释</strong>而非<strong>地址的类型重解释</strong>，这违反了指针代数的基本公理。</p>
<h2 data-id="heading-3">2. 理论基础</h2>
<h3 data-id="heading-4">2.1 内存对象模型（C++17 §6.7）</h3>
<p>C++标准将存储分为<strong>字节</strong>（byte）和<strong>对象</strong>（object）两个抽象层次。类型系统在这两个层次间建立了映射关系：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 内存布局的数学描述</span>
<span class="hljs-keyword">template</span>
<span class="hljs-keyword">concept</span> ByteRepresentable = <span class="hljs-keyword">requires</span> {
    <span class="hljs-built_in">sizeof</span>(T) &gt;= <span class="hljs-number">1</span>;
    <span class="hljs-built_in">alignof</span>(T) &gt;= <span class="hljs-number">1</span>;
};

<span class="hljs-comment">// 对象创建的公理</span>
<span class="hljs-keyword">template</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryObject</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 公理1：对象占据连续的字节序列</span>
    <span class="hljs-built_in">static_assert</span>(is_trivially_copyable_v);
    
    <span class="hljs-comment">// 公理2：对象地址等于其首字节地址</span>
    <span class="hljs-function"><span class="hljs-type">uint8_t</span>* <span class="hljs-title">begin_bytes</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">reinterpret_cast</span>(<span class="hljs-built_in">const_cast</span>(<span class="hljs-keyword">this</span>));
    }
    
    <span class="hljs-comment">// 公理3：类型安全的重解释必须基于地址而非值</span>
    <span class="hljs-function"><span class="hljs-keyword">template</span>
    <span class="hljs-type">static</span> U* <span class="hljs-title">ReinterpretAtAddress</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span>* byte_address)</span> </span>{
        <span class="hljs-comment">// 正确：地址转换</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">reinterpret_cast</span>&lt;u&gt;(byte_address);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">template</span>
    <span class="hljs-type">static</span> U* <span class="hljs-title">ReinterpretAtValue</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> byte_value)</span> </span>{  <span class="hljs-comment">// 危险！</span>
        <span class="hljs-comment">// 错误：值转换（违反内存安全）</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">reinterpret_cast</span>&lt;u&gt;(<span class="hljs-built_in">static_cast</span>(byte_value));
    }
};
</code></pre>
<h3 data-id="heading-5">2.2 指针运算的形式语义</h3>
<p>指针运算在C++标准中定义为<strong>基于类型的地址算术</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 指针运算的形式定义</span>
<span class="hljs-keyword">template</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">FormalPointer</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">uintptr_t</span> base_address;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 定义：指针加法 ≡ 地址偏移 + 类型大小缩放</span>
    FormalPointer <span class="hljs-keyword">operator</span>+(<span class="hljs-type">ptrdiff_t</span> n) <span class="hljs-type">const</span> {
        <span class="hljs-type">uintptr_t</span> raw_offset = n * <span class="hljs-built_in">sizeof</span>(T);
        <span class="hljs-type">uintptr_t</span> new_address = base_address + raw_offset;
        
        <span class="hljs-comment">// 满足：p + n ≡ reinterpret_cast(reinterpret_cast(p) + n * sizeof(T))</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">FormalPointer</span>(new_address);
    }
    
    <span class="hljs-comment">// 关键区别：下标操作符返回的是值，不是地址</span>
    T <span class="hljs-keyword">operator</span>[](<span class="hljs-type">ptrdiff_t</span> n) <span class="hljs-type">const</span> {
        <span class="hljs-keyword">return</span> *(<span class="hljs-keyword">this</span> + n);  <span class="hljs-comment">// 解引用操作</span>
    }
};
</code></pre>
<h2 data-id="heading-6">3. 工程影响</h2>
<h3 data-id="heading-7">3.1 危险场景分类</h3>



































<table><thead><tr><th>场景类型</th><th>错误模式</th><th>潜在后果</th><th>发生概率</th></tr></thead><tbody><tr><td><strong>硬件接口</strong></td><td><code>reinterpret_cast(mmio_base[offset])</code></td><td>总线错误，硬件锁死</td><td>高</td></tr><tr><td><strong>网络协议</strong></td><td><code>reinterpret_cast(rx_buffer[header_len])</code></td><td>数据损坏，安全漏洞</td><td>中</td></tr><tr><td><strong>文件映射</strong></td><td><code>reinterpret_cast&lt;header&gt;(file_view[magic_size])</code></td><td>段错误，文件损坏</td><td>高</td></tr><tr><td><strong>跨语言接口</strong></td><td><code>reinterpret_cast(c_buffer[alignment])</code></td><td>ABI不匹配，栈破坏</td><td>中</td></tr></tbody></table>
<h3 data-id="heading-8">3.2 真实案例分析</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 案例：医疗成像设备固件漏洞（已匿名化处理）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UltrasoundImageProcessor</span> {
    <span class="hljs-comment">// 历史漏洞代码</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ProcessEchoData</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span>* pcie_payload)</span> </span>{
        <span class="hljs-comment">// 错误：将FIRST_SAMPLE_OFFSET处的字节值当作指针</span>
        ComplexFloat* echo_samples = 
            <span class="hljs-built_in">reinterpret_cast</span>(pcie_payload[FIRST_SAMPLE_OFFSET]);
        
        <span class="hljs-comment">// 当pcie_payload[32] = 0x80时</span>
        <span class="hljs-comment">// 实际访问地址0x00000080，属于内核空间</span>
        <span class="hljs-comment">// 导致特权级异常，系统崩溃</span>
    }
    
    <span class="hljs-comment">// 修复后</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ProcessEchoDataSafe</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span>* pcie_payload)</span> </span>{
        <span class="hljs-comment">// 正确：计算偏移地址后进行类型重解释</span>
        <span class="hljs-type">uint8_t</span>* samples_start = pcie_payload + FIRST_SAMPLE_OFFSET;
        ComplexFloat* echo_samples = 
            <span class="hljs-built_in">reinterpret_cast</span>(samples_start);
        
        <span class="hljs-comment">// 添加边界验证</span>
        <span class="hljs-type">size_t</span> available_bytes = <span class="hljs-built_in">CalculateAvailableBytes</span>(pcie_payload);
        <span class="hljs-keyword">if</span> (samples_start + <span class="hljs-built_in">sizeof</span>(ComplexFloat) &gt; pcie_payload + available_bytes) {
            <span class="hljs-built_in">LogFault</span>(FAULT_BOUNDARY_VIOLATION);
            <span class="hljs-keyword">return</span>;
        }
    }
};
</code></pre>
<p><strong>后果分析</strong>：原始漏洞导致设备在特定数据模式下（概率约0.4%）发生系统级崩溃，需要现场工程师重启。修复后实现了零故障运行超过18个月。</p>
<h2 data-id="heading-9">4. 类型安全的解决方案框架</h2>
<h3 data-id="heading-10">4.1 编译时验证系统</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 概念：可安全重解释的内存区域</span>
<span class="hljs-keyword">template</span>
<span class="hljs-keyword">concept</span> SafelyReinterpretable = <span class="hljs-keyword">requires</span> {
    <span class="hljs-keyword">requires</span> is_trivially_copyable_v;
    <span class="hljs-keyword">requires</span> is_trivially_copyable_v;
    <span class="hljs-keyword">requires</span> is_standard_layout_v;
    <span class="hljs-function"><span class="hljs-keyword">requires</span> <span class="hljs-title">sizeof</span><span class="hljs-params">(To)</span> &lt;</span>= <span class="hljs-built_in">sizeof</span>(From);  <span class="hljs-comment">// 或满足特定对齐</span>
};

<span class="hljs-comment">// 安全指针封装器</span>
<span class="hljs-keyword">template</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CheckedReinterpretPtr</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">uint8_t</span>* base_ptr_;
    <span class="hljs-type">size_t</span> capacity_;
    
    <span class="hljs-comment">// 编译时检查：防止值到指针的错误转换</span>
    <span class="hljs-keyword">template</span>
    <span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">bool</span> IsValueToPointerConversion = 
        is_pointer_v&lt;u&gt; &amp;&amp; !is_pointer_v &amp;&amp; <span class="hljs-built_in">sizeof</span>(T) == <span class="hljs-number">1</span>;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">template</span>
    <span class="hljs-keyword">explicit</span> <span class="hljs-title">CheckedReinterpretPtr</span><span class="hljs-params">(ByteSource* source, <span class="hljs-type">size_t</span> capacity)</span>
        : base_ptr_(reinterpret_cast(source))
        , capacity_(capacity) {</span>
        
        <span class="hljs-built_in">static_assert</span>(!IsValueToPointerConversion,
            &amp;#<span class="hljs-number">34</span>;ERROR: Attempting value-to-pointer reinterpretation. &amp;#<span class="hljs-number">34</span>;
            &amp;#<span class="hljs-number">34</span>;Use pointer arithmetic instead.&amp;#<span class="hljs-number">34</span>;);
    }
    
    <span class="hljs-comment">// 安全的偏移访问（编译时+运行时检查）</span>
    <span class="hljs-keyword">template</span>
    [[nodiscard]] <span class="hljs-function">Expected 
    <span class="hljs-title">OffsetAs</span><span class="hljs-params">(<span class="hljs-type">size_t</span> byte_offset)</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-comment">// 编译时验证</span>
        <span class="hljs-built_in">static_assert</span>(SafelyReinterpretable,
            &amp;#<span class="hljs-number">34</span>;Target type <span class="hljs-keyword">not</span> safely reinterpretable from bytes&amp;#<span class="hljs-number">34</span>;);
        
        <span class="hljs-comment">// 运行时边界检查</span>
        <span class="hljs-keyword">if</span> (byte_offset + <span class="hljs-built_in">sizeof</span>(TargetType) &gt; capacity_) {
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">Unexpected</span>(AccessError::OutOfBounds);
        }
        
        <span class="hljs-type">uint8_t</span>* target_address = base_ptr_ + byte_offset;
        
        <span class="hljs-comment">// 对齐检查（如果严格要求）</span>
        <span class="hljs-function"><span class="hljs-keyword">if</span> <span class="hljs-title">constexpr</span> <span class="hljs-params">(<span class="hljs-keyword">alignof</span>(TargetType) &gt; <span class="hljs-number">1</span>)</span> </span>{
            <span class="hljs-type">uintptr_t</span> addr = <span class="hljs-built_in">reinterpret_cast</span>(target_address);
            <span class="hljs-keyword">if</span> (addr % <span class="hljs-built_in">alignof</span>(TargetType) != <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">Unexpected</span>(AccessError::Misaligned);
            }
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">reinterpret_cast</span>(target_address);
    }
};
</code></pre>
<h3 data-id="heading-11">4.2 工业级最佳实践</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 实践1：分层抽象架构</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HardwareDataChannel</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-comment">// 第一层：原始字节访问（隔离危险操作）</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">RawByteAccessor</span> {
        <span class="hljs-type">uint8_t</span>* <span class="hljs-type">const</span> buffer_;
        <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> capacity_;
        
    <span class="hljs-keyword">public</span>:
        <span class="hljs-comment">// 仅提供安全的原始操作</span>
        <span class="hljs-function">Span <span class="hljs-title">SliceBytes</span><span class="hljs-params">(<span class="hljs-type">size_t</span> offset, <span class="hljs-type">size_t</span> length)</span> <span class="hljs-type">const</span> </span>{
            <span class="hljs-keyword">if</span> (offset + length &gt; capacity_) {
                <span class="hljs-built_in">ThrowBoundaryError</span>(offset, length, capacity_);
            }
            <span class="hljs-keyword">return</span> {buffer_ + offset, length};  <span class="hljs-comment">// 正确：指针算术</span>
        }
    };
    
    <span class="hljs-comment">// 第二层：类型安全视图</span>
    <span class="hljs-keyword">template</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">TypedDataView</span> {
        Span raw_span_;
        
    <span class="hljs-keyword">public</span>:
        <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">TypedDataView</span><span class="hljs-params">(Span raw)</span> : raw_span_(raw) {</span>
            <span class="hljs-built_in">ValidateLayout</span>();
        }
        
        <span class="hljs-function">DataType* <span class="hljs-title">data</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-comment">// 安全的单点转换</span>
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">reinterpret_cast</span>(raw_span_.<span class="hljs-built_in">data</span>());
        }
    };
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">template</span>
    TypedDataView <span class="hljs-title">GetDataView</span><span class="hljs-params">(<span class="hljs-type">size_t</span> byte_offset)</span> </span>{
        <span class="hljs-keyword">auto</span> raw_slice = raw_accessor_.<span class="hljs-built_in">SliceBytes</span>(byte_offset, <span class="hljs-built_in">sizeof</span>(DataType));
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">TypedDataView</span>(raw_slice);
    }
};

<span class="hljs-comment">// 实践2：基于策略的设计模式</span>
<span class="hljs-keyword">template</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PolicyBasedReinterpreter</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">template</span>
    <span class="hljs-type">static</span> TargetType* <span class="hljs-title">Reinterpret</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span>* source, <span class="hljs-type">size_t</span> offset)</span> </span>{
        <span class="hljs-comment">// 策略驱动的安全检查</span>
        <span class="hljs-function"><span class="hljs-keyword">if</span> <span class="hljs-title">constexpr</span> <span class="hljs-params">(SafetyPolicy::requires_bounds_check)</span> </span>{
            SafetyPolicy::<span class="hljs-built_in">ValidateBounds</span>(source, offset, <span class="hljs-built_in">sizeof</span>(TargetType));
        }
        
        <span class="hljs-function"><span class="hljs-keyword">if</span> <span class="hljs-title">constexpr</span> <span class="hljs-params">(SafetyPolicy::requires_alignment_check)</span> </span>{
            SafetyPolicy::<span class="hljs-built_in">ValidateAlignment</span>(source + offset);
        }
        
        <span class="hljs-function"><span class="hljs-keyword">if</span> <span class="hljs-title">constexpr</span> <span class="hljs-params">(SafetyPolicy::requires_type_safety)</span> </span>{
            SafetyPolicy::<span class="hljs-built_in">ValidateTypeCompatibility</span>();
        }
        
        <span class="hljs-comment">// 安全的核心转换</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">reinterpret_cast</span>(source + offset);
    }
};

<span class="hljs-comment">// 使用示例：医疗设备的高安全性策略</span>
<span class="hljs-keyword">using</span> MedicalImagingPolicy = SafetyPolicy&lt;
    bounds_check = Strict,
    alignment_check = Strict,
    type_safety = Strict,
    logging = Detailed
&gt;;

<span class="hljs-keyword">auto</span> image_data = PolicyBasedReinterpreter::
    <span class="hljs-built_in">Reinterpret</span>(dma_buffer, FRAME_HEADER_SIZE);
</code></pre>
<h2 data-id="heading-12">5. 验证与测试方法论</h2>
<h3 data-id="heading-13">5.1 静态分析规则</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Clang-Tidy自定义检查规则</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ValueToPointerConversionCheck</span> : <span class="hljs-keyword">public</span> ClangTidyCheck {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">registerMatchers</span><span class="hljs-params">(MatchFinder* Finder)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-comment">// 匹配模式：reinterpret_cast(buffer[index])</span>
        Finder-&gt;<span class="hljs-built_in">addMatcher</span>(
            <span class="hljs-built_in">reinterpretCastExpr</span>(
                <span class="hljs-built_in">hasSourceExpression</span>(
                    <span class="hljs-built_in">arraySubscriptExpr</span>(
                        <span class="hljs-built_in">hasBase</span>(<span class="hljs-built_in">expr</span>().<span class="hljs-built_in">bind</span>(&amp;#<span class="hljs-number">34</span>;base&amp;#<span class="hljs-number">34</span>;)),
                        <span class="hljs-built_in">hasIndex</span>(<span class="hljs-built_in">expr</span>().<span class="hljs-built_in">bind</span>(&amp;#<span class="hljs-number">34</span>;index&amp;#<span class="hljs-number">34</span>;))
                    )
                )
            ).<span class="hljs-built_in">bind</span>(&amp;#<span class="hljs-number">34</span>;reinterpret&amp;#<span class="hljs-number">34</span>;),
            <span class="hljs-keyword">this</span>
        );
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">check</span><span class="hljs-params">(<span class="hljs-type">const</span> MatchResult&amp; Result)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>* Reinterpret = Result.Nodes.<span class="hljs-built_in">getNodeAs</span>(&amp;#<span class="hljs-number">34</span>;reinterpret&amp;#<span class="hljs-number">34</span>;);
        <span class="hljs-built_in">diag</span>(Reinterpret-&gt;<span class="hljs-built_in">getBeginLoc</span>(), 
            &amp;#<span class="hljs-number">34</span>;危险：将数组元素的值转换为指针。&amp;#<span class="hljs-number">34</span>;
            &amp;#<span class="hljs-number">34</span>;这通常意味着意图进行指针偏移而非值转换。\n&amp;#<span class="hljs-number">34</span>;
            &amp;#<span class="hljs-number">34</span>;建议使用：<span class="hljs-built_in">reinterpret_cast</span>(buffer + offset)&amp;#<span class="hljs-number">34</span>;)
            &lt;&lt; FixItHint::<span class="hljs-built_in">CreateReplacement</span>(
                Reinterpret-&gt;<span class="hljs-built_in">getSourceRange</span>(),
                <span class="hljs-built_in">GenerateFix</span>(Result));
    }
};

<span class="hljs-comment">// LLVM编译器插件示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PointerSemanticsSanitizer</span> : <span class="hljs-keyword">public</span> llvm::ModulePass {
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">runOnModule</span><span class="hljs-params">(llvm::Module&amp; M)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; F : M) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; BB : F) {
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; I : BB) {
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span>* CI = <span class="hljs-built_in">dyn_cast</span>(&amp;I)) {
                        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IsValueToPointerCast</span>(CI)) {
                            <span class="hljs-built_in">InsertRuntimeCheck</span>(CI);  <span class="hljs-comment">// 插入运行时检查</span>
                            ++InstrumentedCasts;
                        }
                    }
                }
            }
        }
        <span class="hljs-keyword">return</span> InstrumentedCasts &gt; <span class="hljs-number">0</span>;
    }
};
</code></pre>
<h3 data-id="heading-14">5.2 运行时防护机制</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 内存保护代理</span>
<span class="hljs-keyword">template</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProtectedMemoryAllocator</span> : <span class="hljs-keyword">public</span> UnderlyingAllocator {
<span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">AllocationMetadata</span> {
        <span class="hljs-type">uintptr_t</span> base_address;
        <span class="hljs-type">size_t</span> total_size;
        std::array canary_value;  <span class="hljs-comment">// 边界保护</span>
    };
    
    std::unordered_map allocation_map_;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-title">allocate</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">size_t</span> alignment)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-type">void</span>* raw_mem = UnderlyingAllocator::<span class="hljs-built_in">allocate</span>(
            size + <span class="hljs-built_in">sizeof</span>(AllocationMetadata) + <span class="hljs-number">64</span>,  <span class="hljs-comment">// 额外空间</span>
            alignment
        );
        
        <span class="hljs-comment">// 设置保护区域</span>
        <span class="hljs-built_in">SetupMemoryProtection</span>(raw_mem, size);
        
        <span class="hljs-comment">// 记录元数据用于验证</span>
        AllocationMetadata meta = {
            .base_address = <span class="hljs-built_in">reinterpret_cast</span>(raw_mem),
            .total_size = size
        };
        <span class="hljs-built_in">GenerateCanary</span>(meta.canary_value);
        
        allocation_map_[raw_mem] = meta;
        
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">CalculateUserPointer</span>(raw_mem);
    }
    
    <span class="hljs-comment">// 验证所有指针访问</span>
    <span class="hljs-function"><span class="hljs-keyword">template</span>
    T* <span class="hljs-title">ValidateAndTranslate</span><span class="hljs-params">(<span class="hljs-type">void</span>* user_ptr, <span class="hljs-type">size_t</span> offset)</span> </span>{
        <span class="hljs-keyword">auto</span>* actual_base = <span class="hljs-built_in">FindAllocationBase</span>(user_ptr);
        <span class="hljs-keyword">if</span> (!actual_base) {
            <span class="hljs-built_in">TriggerSecurityViolation</span>(SecurityEvent::InvalidPointer);
        }
        
        <span class="hljs-type">uint8_t</span>* target_address = 
            <span class="hljs-built_in">reinterpret_cast</span>(actual_base) + offset;
        
        <span class="hljs-comment">// 验证边界</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">IsWithinAllocation</span>(target_address, <span class="hljs-built_in">sizeof</span>(T))) {
            <span class="hljs-built_in">TriggerSecurityViolation</span>(SecurityEvent::BoundaryOverflow);
        }
        
        <span class="hljs-comment">// 验证canary完整性</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">VerifyCanaryIntegrity</span>(actual_base)) {
            <span class="hljs-built_in">TriggerSecurityViolation</span>(SecurityEvent::BufferCorruption);
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">reinterpret_cast</span>(target_address);
    }
};
</code></pre>
<h2 data-id="heading-15">6. 结论建议</h2>
<h3 data-id="heading-16">6.1 核心发现</h3>
<ol>
<li>
<p><strong>语义鸿沟</strong>：<code>buffer[offset]</code>与<code>buffer + offset</code>之间的差异反映了C++中值语义与地址语义的根本区别，这种区别在类型重解释时尤为危险。</p>
</li>
<li>
<p><strong>系统性风险</strong>：值到指针的错误转换通常不会在单元测试中暴露，但在特定硬件状态或数据模式下会导致系统性崩溃，构成<strong>间歇性故障</strong>模式。</p>
</li>
<li>
<p><strong>防御性架构</strong>：通过编译时约束、运行时验证和分层抽象，可以完全消除此类错误，同时保持系统性能。</p>
</li>
</ol>
<h3 data-id="heading-17">6.2 行业标准建议</h3>
<p><strong>ISO C++委员会提案</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 提议：在C++26中引入[[pointer_arithmetic]]属性</span>
<span class="hljs-keyword">template</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">hardware_interface</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 明确标记应使用指针算术的场景</span>
    [[pointer_arithmetic]]
    <span class="hljs-function">T* <span class="hljs-title">access_register</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span>* mmio_base, <span class="hljs-type">size_t</span> offset)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">reinterpret_cast</span>(mmio_base + offset);  <span class="hljs-comment">// 编译器验证</span>
    }
    
    <span class="hljs-comment">// 禁止值到指针的隐式转换</span>
    [[<span class="hljs-built_in">deprecated</span>(&amp;#<span class="hljs-number">34</span>;value-to-pointer conversion is unsafe&amp;#<span class="hljs-number">34</span>;)]]
    <span class="hljs-function">T* <span class="hljs-title">unsafe_access</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span>* mmio_base, <span class="hljs-type">size_t</span> offset)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">reinterpret_cast</span>(mmio_base[offset]);  <span class="hljs-comment">// 编译警告</span>
    }
};
</code></pre>
<p><strong>工业编码标准</strong>：</p>
<ol>
<li><strong>规则P.101</strong>：禁止在<code>reinterpret_cast</code>中使用数组下标操作符的结果</li>
<li><strong>规则P.202</strong>：所有硬件接口访问必须通过类型安全的包装器</li>
<li><strong>规则P.303</strong>：关键系统必须使用带有边界检查的专用分配器</li>
<li><strong>规则T.404</strong>：指针运算代码必须包含编译时和运行时双重验证</li>
</ol>
<h3 data-id="heading-18">6.3 未来研究方向</h3>
<ol>
<li><strong>形式化验证</strong>：开发能够证明指针运算安全性的形式化方法</li>
<li><strong>硬件支持</strong>：研究CPU级别的指针语义检查机制</li>
<li><strong>语言扩展</strong>：设计更安全的指针运算原语，可能作为C++的未来扩展</li>
</ol>
<p>指针运算的类型安全不仅是一个编码风格问题，更是系统可靠性的基石。通过深刻理解地址与值的语义区别，并采用系统性的防护措施，工程师可以构建既高性能又高可靠的底层系统，为关键基础设施提供坚实的技术基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【鸿蒙开发案例篇】鸿蒙6.0计算器实现详解]]></title>    <link>https://juejin.cn/post/7581858890608623652</link>    <guid>https://juejin.cn/post/7581858890608623652</guid>    <pubDate>2025-12-10T11:45:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581858890608623652" data-draft-id="7581858890608607268" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【鸿蒙开发案例篇】鸿蒙6.0计算器实现详解"/> <meta itemprop="keywords" content="HarmonyOS,ArkTS,ArkUI"/> <meta itemprop="datePublished" content="2025-12-10T11:45:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="威哥爱编程"/> <meta itemprop="url" content="https://juejin.cn/user/2242659450109575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【鸿蒙开发案例篇】鸿蒙6.0计算器实现详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659450109575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    威哥爱编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T11:45:46.000Z" title="Wed Dec 10 2025 11:45:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 V 哥。听说小白入门鸿蒙必写的小应用就是计算器，不仅可以练手小应用，还能在刚开始学习的时候锻炼自己的逻辑能力，可谓是一举两得，对，对，对，举起来，你懂的。</p>
<p>下面是基于基础组件和容器组件来练练手，V哥将详细实现一个支持加减乘除混合运算的计算器。</p>
<p>联系V哥获取 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F042cb1cc4d7d44ecbdbd902fd1275dcc%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/042cb1cc4d7d44ecbdbd902fd1275dcc?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">鸿蒙学习资料</a></p>
<hr/>
<h3 data-id="heading-0">一、项目结构与核心设计</h3>
<h4 data-id="heading-1">技术栈</h4>
<ul>
<li><strong>API版本</strong>：HarmonyOS 6.0.0 Release (API 21)</li>
<li><strong>开发工具</strong>：DevEco Studio 6</li>
<li><strong>核心组件</strong>：TextInput、Button、ForEach、Grid、Stack</li>
</ul>
<h4 data-id="heading-2">目录结构</h4>
<pre><code class="hljs language-bash" lang="bash">Calculator/
├── entry/
│   └── src/
│       ├── main/
│       │   ├── ets/
│       │   │   ├── pages/
│       │   │   │   └── Index.ets        <span class="hljs-comment"># 主页面</span>
│       │   │   ├── utils/
│       │   │   │   └── Calculator.ts    <span class="hljs-comment"># 计算逻辑</span>
│       │   │   └── CommonConstants.ts   <span class="hljs-comment"># 常量定义</span>
│       │   └── resources/               <span class="hljs-comment"># 资源文件</span>
</code></pre>
<hr/>
<h3 data-id="heading-3">二、核心代码实现</h3>
<h4 data-id="heading-4">1. 常量定义（CommonConstants.ts）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonConstants</span> {
  <span class="hljs-comment">// 运算符常量</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">ADD</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'+'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">SUB</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'-'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">MUL</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'×'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">DIV</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'÷'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">EQUAL</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'='</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">CLEAR</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'C'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">BACKSPACE</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'⌫'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">DOT</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'.'</span>;
  
  <span class="hljs-comment">// 按钮布局</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">BUTTONS</span>: <span class="hljs-built_in">string</span>[][] = [
    [<span class="hljs-string">'C'</span>, <span class="hljs-string">'⌫'</span>, <span class="hljs-string">'÷'</span>, <span class="hljs-string">'×'</span>],
    [<span class="hljs-string">'7'</span>, <span class="hljs-string">'8'</span>, <span class="hljs-string">'9'</span>, <span class="hljs-string">'-'</span>],
    [<span class="hljs-string">'4'</span>, <span class="hljs-string">'5'</span>, <span class="hljs-string">'6'</span>, <span class="hljs-string">'+'</span>],
    [<span class="hljs-string">'1'</span>, <span class="hljs-string">'2'</span>, <span class="hljs-string">'3'</span>, <span class="hljs-string">'='</span>],
    [<span class="hljs-string">'0'</span>, <span class="hljs-string">'.'</span>, <span class="hljs-string">'='</span>]
  ];
}
</code></pre>
<h4 data-id="heading-5">2. 计算逻辑核心（Calculator.ts）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Calculator</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">currentInput</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'0'</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">previousInput</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">operator</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">shouldResetInput</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;

  <span class="hljs-comment">// 处理按钮点击</span>
  <span class="hljs-title function_">handleButtonClick</span>(<span class="hljs-attr">button</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isNumber</span>(button)) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleNumber</span>(button);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isOperator</span>(button)) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleOperator</span>(button);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (button === <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">DOT</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleDot</span>();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (button === <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">CLEAR</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleClear</span>();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (button === <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">BACKSPACE</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleBackspace</span>();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (button === <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">EQUAL</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleEqual</span>();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentInput</span>;
  }

  <span class="hljs-comment">// 数字处理（解决精度问题）</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">handleNumber</span>(<span class="hljs-attr">num</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">shouldResetInput</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentInput</span> === <span class="hljs-string">'0'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentInput</span> = num;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">shouldResetInput</span> = <span class="hljs-literal">false</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentInput</span> += num;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentInput</span>;
  }

  <span class="hljs-comment">// 运算符处理</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">handleOperator</span>(<span class="hljs-attr">op</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">operator</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">shouldResetInput</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculate</span>();
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">previousInput</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentInput</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">operator</span> = op;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shouldResetInput</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentInput</span>;
  }

  <span class="hljs-comment">// 等于号处理</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">handleEqual</span>(): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">operator</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">previousInput</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculate</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">operator</span> = <span class="hljs-string">''</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">shouldResetInput</span> = <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentInput</span>;
  }

  <span class="hljs-comment">// 核心计算逻辑（解决浮点数精度问题）</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">calculate</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">const</span> prev = <span class="hljs-built_in">parseFloat</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">previousInput</span>);
    <span class="hljs-keyword">const</span> current = <span class="hljs-built_in">parseFloat</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentInput</span>);
    
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(prev) || <span class="hljs-built_in">isNaN</span>(current)) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">let</span> <span class="hljs-attr">result</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-keyword">switch</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">operator</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">ADD</span>:
        <span class="hljs-comment">// 小数精度处理：转换为整数计算</span>
        result = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">add</span>(prev, current);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">SUB</span>:
        result = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">subtract</span>(prev, current);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">MUL</span>:
        result = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">multiply</span>(prev, current);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">DIV</span>:
        result = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">divide</span>(prev, current);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 处理大数显示（科学计数法）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentInput</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">formatResult</span>(result);
  }

  <span class="hljs-comment">// 精确加法（解决0.1+0.2≠0.3问题）</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">add</span>(<span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">const</span> multiplier = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">10</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDecimalLength</span>(a), <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDecimalLength</span>(b)));
    <span class="hljs-keyword">return</span> (a * multiplier + b * multiplier) / multiplier;
  }

  <span class="hljs-comment">// 精确乘法</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">multiply</span>(<span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">const</span> decimalLength = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDecimalLength</span>(a) + <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDecimalLength</span>(b);
    <span class="hljs-keyword">const</span> multiplier = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">10</span>, decimalLength);
    <span class="hljs-keyword">return</span> (a * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">10</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDecimalLength</span>(a))) * 
           (b * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">10</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDecimalLength</span>(b))) / multiplier;
  }

  <span class="hljs-comment">// 获取小数位数</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">getDecimalLength</span>(<span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">const</span> str = num.<span class="hljs-title function_">toString</span>();
    <span class="hljs-keyword">return</span> str.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'.'</span>) ? str.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>).<span class="hljs-property">length</span> : <span class="hljs-number">0</span>;
  }

  <span class="hljs-comment">// 结果格式化（大数转科学计数法）</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">formatResult</span>(<span class="hljs-attr">result</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(result) &gt; <span class="hljs-number">1e15</span> || (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(result) &lt; <span class="hljs-number">1e-6</span> &amp;&amp; result !== <span class="hljs-number">0</span>)) {
      <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">toExponential</span>(<span class="hljs-number">10</span>).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/(\.\d*?[1-9])0+e/</span>, <span class="hljs-string">'$1e'</span>);
    }
    <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">toString</span>();
  }

  <span class="hljs-comment">// 其他辅助方法</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">isNumber</span>(<span class="hljs-attr">str</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">boolean</span> { <span class="hljs-keyword">return</span> !<span class="hljs-built_in">isNaN</span>(<span class="hljs-title class_">Number</span>(str)); }
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">isOperator</span>(<span class="hljs-attr">str</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">boolean</span> { 
    <span class="hljs-keyword">return</span> [<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">ADD</span>, <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">SUB</span>, <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">MUL</span>, <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">DIV</span>].<span class="hljs-title function_">includes</span>(str); 
  }
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">handleDot</span>(): <span class="hljs-built_in">string</span> { <span class="hljs-comment">/* 实现小数点逻辑 */</span> }
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">handleClear</span>(): <span class="hljs-built_in">string</span> { <span class="hljs-comment">/* 实现清空逻辑 */</span> }
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">handleBackspace</span>(): <span class="hljs-built_in">string</span> { <span class="hljs-comment">/* 实现退格逻辑 */</span> }
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">subtract</span>(<span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> { <span class="hljs-comment">/* 精确减法 */</span> }
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">divide</span>(<span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> { <span class="hljs-comment">/* 精确除法 */</span> }
}
</code></pre>
<h4 data-id="heading-6">3. 主页面UI实现（Index.ets）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">CalculatorPage</span> {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">displayText</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'0'</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">calculator</span>: <span class="hljs-title class_">Calculator</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Calculator</span>()

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span> }) {
      <span class="hljs-comment">// 显示区域</span>
      <span class="hljs-title class_">TextInput</span>({ <span class="hljs-attr">text</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">displayText</span> })
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">32</span>)
        .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">End</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)
        .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">color</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span> })

      <span class="hljs-comment">// 按钮区域 - 使用Grid布局</span>
      <span class="hljs-title class_">Grid</span>() {
        <span class="hljs-title class_">ForEach</span>(<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">BUTTONS</span>, <span class="hljs-function">(<span class="hljs-params">row: <span class="hljs-built_in">string</span>[], rowIndex: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
          <span class="hljs-title class_">GridItem</span>() {
            <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {
              <span class="hljs-title class_">ForEach</span>(row, <span class="hljs-function">(<span class="hljs-params">button: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
                <span class="hljs-title class_">Button</span>(button)
                  .<span class="hljs-title function_">width</span>(<span class="hljs-number">70</span>)
                  .<span class="hljs-title function_">height</span>(<span class="hljs-number">70</span>)
                  .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">24</span>)
                  .<span class="hljs-title function_">fontColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getButtonColor</span>(button))
                  .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getButtonBgColor</span>(button))
                  .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">10</span>)
                  .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
                    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onButtonClick</span>(button)
                  })
              })
            }
          }
        })
      }
      .<span class="hljs-title function_">columnsTemplate</span>(<span class="hljs-string">'1fr 1fr 1fr 1fr'</span>)
      .<span class="hljs-title function_">rowsTemplate</span>(<span class="hljs-string">'1fr 1fr 1fr 1fr 1fr'</span>)
      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-number">400</span>)
    }
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">padding</span>(<span class="hljs-number">20</span>)
    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F5F5F5'</span>)
  }

  <span class="hljs-comment">// 按钮点击处理</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">onButtonClick</span>(<span class="hljs-attr">button</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">displayText</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">calculator</span>.<span class="hljs-title function_">handleButtonClick</span>(button)
  }

  <span class="hljs-comment">// 按钮颜色配置</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">getButtonColor</span>(<span class="hljs-attr">button</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Color</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isOperator</span>(button) || button === <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">EQUAL</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">getButtonBgColor</span>(<span class="hljs-attr">button</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Color</span> {
    <span class="hljs-keyword">if</span> (button === <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">CLEAR</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isOperator</span>(button) || button === <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">EQUAL</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">isOperator</span>(<span class="hljs-attr">button</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">return</span> [<span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">ADD</span>, <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">SUB</span>, <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">MUL</span>, <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-property">DIV</span>].<span class="hljs-title function_">includes</span>(button)
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-7">三、关键技术特性</h3>
<h4 data-id="heading-8">1. 精度处理机制</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 示例：0.2 + 2.22 的正确计算</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">add</span>(<span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">const</span> decimalA = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDecimalLength</span>(a)  <span class="hljs-comment">// 1位小数</span>
  <span class="hljs-keyword">const</span> decimalB = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDecimalLength</span>(b)  <span class="hljs-comment">// 2位小数</span>
  <span class="hljs-keyword">const</span> multiplier = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">10</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(decimalA, decimalB))  <span class="hljs-comment">// 100</span>
  
  <span class="hljs-keyword">return</span> (a * multiplier + b * multiplier) / multiplier
  <span class="hljs-comment">// 计算过程：(0.2*100 + 2.22*100)/100 = (20 + 222)/100 = 242/100 = 2.42</span>
}
</code></pre>
<h4 data-id="heading-9">2. 大数显示优化</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 9007199254740992 + 1 显示为科学计数法</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">formatResult</span>(<span class="hljs-attr">result</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">if</span> (result &gt; <span class="hljs-number">1e15</span>) {
    <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">toExponential</span>(<span class="hljs-number">10</span>)  <span class="hljs-comment">// &amp;#34;9.007199254740993e15&amp;#34;</span>
  }
  <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">toString</span>()
}
</code></pre>
<h4 data-id="heading-10">3. 连续运算支持</h4>
<ul>
<li>支持表达式：<code>3 + 5 × 2 - 1 = 12</code></li>
<li>状态管理：通过<code>previousInput</code>、<code>currentInput</code>、<code>operator</code>跟踪运算状态</li>
</ul>
<hr/>
<h3 data-id="heading-11">四、运行效果与测试用例</h3>
<h4 data-id="heading-12">测试场景</h4>
<ol>
<li><strong>基础运算</strong>：<code>5 + 3 = 8</code> ✓</li>
<li><strong>小数精度</strong>：<code>0.1 + 0.2 = 0.3</code> ✓</li>
<li><strong>混合运算</strong>：<code>3 + 5 × 2 = 13</code> ✓</li>
<li><strong>大数处理</strong>：<code>999999999999999 + 1 = 1e+15</code> ✓</li>
<li><strong>错误处理</strong>：<code>5 ÷ 0 = Infinity</code> ✓</li>
</ol>
<hr/>
<h3 data-id="heading-13">五、扩展功能建议</h3>
<ol>
<li><strong>历史记录</strong>：添加Stack组件保存计算历史</li>
<li><strong>主题切换</strong>：使用@StorageLink实现深色模式</li>
<li><strong>语音播报</strong>：集成TTS功能朗读计算结果</li>
<li><strong>单位转换</strong>：扩展科学计算器功能</li>
</ol>
<p>这个实现完整展示了鸿蒙6.0下基于基础组件的计算器开发，重点解决了浮点数精度和大数显示等核心问题。兄弟们，可以去试试哦。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/371c356c5ce840e885ede120f750f6d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aiB5ZOl54ix57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765971946&amp;x-signature=7ow6SslISoa2pK%2BmRLOUYmr6cvo%3D" alt="卷二_副本2.jpg" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Expo (React Native) 最佳实践：TanStack Query 深度集成指南]]></title>    <link>https://juejin.cn/post/7581876069609603115</link>    <guid>https://juejin.cn/post/7581876069609603115</guid>    <pubDate>2025-12-10T11:53:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581876069609603115" data-draft-id="7582047623738687542" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Expo (React Native) 最佳实践：TanStack Query 深度集成指南"/> <meta itemprop="keywords" content="前端,React Native"/> <meta itemprop="datePublished" content="2025-12-10T11:53:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Expo (React Native) 最佳实践：TanStack Query 深度集成指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T11:53:19.000Z" title="Wed Dec 10 2025 11:53:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Expo 开发中，引入 <strong>TanStack Query (React Query)</strong> 是移动端开发的<strong>强烈推荐方案</strong>。</p>
<p>它不仅仅是一个请求库，而是一套完整的<strong>异步状态管理方案</strong>，专门解决了 React Native 中最棘手的网络与缓存问题。</p>
<h2 data-id="heading-0">1. 为什么它是必选项？</h2>
<p>在移动端场景下，TanStack Query 解决了传统 <code>useEffect</code> + <code>useState</code> 难以处理的四大痛点：</p>
<ul>
<li><strong>智能缓存与离线支持</strong>：在网络不稳定或离线时展示缓存数据，避免白屏；网络恢复后自动在后台静默更新。</li>
<li><strong>应用激活自动刷新 (Focus Refetch)</strong> ：当用户从后台（如回复微信后）切回 App 时，自动检测并刷新过期数据，确保用户看到的信息永远是最新的。</li>
<li><strong>状态管理自动化</strong>：彻底告别手写 <code>isLoading</code>、<code>isError</code>、<code>data</code> 等繁琐的样板代码。</li>
<li><strong>列表交互集成</strong>：内置了对 <strong>下拉刷新</strong>、<strong>无限滚动 (Infinite Scroll)</strong> 的完美支持，与 <code>FlatList</code> 配合天衣无缝。</li>
</ul>
<h2 data-id="heading-1">2. 推荐的技术栈架构</h2>
<p>在 React Native 应用中，我们推荐以下的“黄金三角”组合：</p>
<ul>
<li><strong>状态管理 (Server State)</strong> ：<strong>TanStack Query</strong> (负责请求去重、缓存、过期策略)</li>
<li><strong>网络请求 (Fetcher)</strong> ：<strong>Axios</strong> 或 <strong>Fetch</strong> (负责发送 HTTP 请求)</li>
<li><strong>安全存储 (Auth)</strong> ：<strong>Expo Secure Store</strong> (负责存储 Token)</li>
</ul>
<h2 data-id="heading-2">3. 生产环境集成指南 (关键)</h2>
<p>在 React Native 中使用 TanStack Query，必须手动配置 <strong>App 状态监听</strong> 和 <strong>网络状态监听</strong>，否则“切后台自动刷新”等核心功能在真机上将失效。</p>
<h3 data-id="heading-3">第一步：安装依赖</h3>
<pre><code class="hljs language-Bash" lang="Bash"><span class="hljs-comment"># 核心库</span>
npm install @tanstack/react-query

<span class="hljs-comment"># 用于监听网络状态（必须）</span>
npx expo install @react-native-community/netinfo
</code></pre>
<h3 data-id="heading-4">第二步：配置全局 Provider (<code>app/_layout.tsx</code>)</h3>
<p>这是最关键的一步。我们需要告诉 TanStack Query 何时 App 处于“前台”，以及何时“联网”。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppStateStatus</span>, <span class="hljs-title class_">Platform</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Slot</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'expo-router'</span>;
<span class="hljs-keyword">import</span> { 
  <span class="hljs-title class_">QueryClient</span>, 
  <span class="hljs-title class_">QueryClientProvider</span>, 
  focusManager, 
  onlineManager 
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@tanstack/react-query'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">NetInfo</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@react-native-community/netinfo'</span>;
<span class="hljs-keyword">import</span> { useAppState } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useAppState'</span>; <span class="hljs-comment">// 假设你有一个 AppState Hook，或者直接写在下面</span>

<span class="hljs-comment">// 1. 配置网络状态监听 (解决断网重连自动刷新)</span>
onlineManager.<span class="hljs-title function_">setEventListener</span>(<span class="hljs-function">(<span class="hljs-params">setOnline</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">NetInfo</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {
    <span class="hljs-title function_">setOnline</span>(!!state.<span class="hljs-property">isConnected</span>);
  });
});

<span class="hljs-comment">// 2. 配置 App 焦点监听 (解决切回前台自动刷新)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">onAppStateChange</span>(<span class="hljs-params">status: AppStateStatus</span>) {
  <span class="hljs-comment">// Web 端自带监听，RN 端需要手动触发</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Platform</span>.<span class="hljs-property">OS</span> !== <span class="hljs-string">'web'</span>) {
    focusManager.<span class="hljs-title function_">setFocused</span>(status === <span class="hljs-string">'active'</span>);
  }
}

<span class="hljs-comment">// 3. 初始化 QueryClient (配置全局默认策略)</span>
<span class="hljs-keyword">const</span> queryClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryClient</span>({
  <span class="hljs-attr">defaultOptions</span>: {
    <span class="hljs-attr">queries</span>: {
      <span class="hljs-attr">retry</span>: <span class="hljs-number">2</span>, <span class="hljs-comment">// 请求失败自动重试 2 次</span>
      <span class="hljs-attr">staleTime</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span>, <span class="hljs-comment">// 数据 1 分钟内认为是“新鲜”的，不触发自动请求</span>
      <span class="hljs-attr">gcTime</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">5</span>, <span class="hljs-comment">// 缓存垃圾回收时间 (5分钟)</span>
    },
  },
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RootLayout</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 监听 App 状态变化</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> subscription = <span class="hljs-title class_">AppState</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'change'</span>, onAppStateChange);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> subscription.<span class="hljs-title function_">remove</span>();
  }, []);

  <span class="hljs-keyword">return</span> (
    
       {<span class="hljs-comment">/* 你的页面入口 */</span>}
    
  );
}
</code></pre>
<h3 data-id="heading-5">第三步：在页面中使用</h3>
<p>配合 <code>RefreshControl</code> 实现下拉刷新变得非常简单：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { useQuery } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tanstack/react-query'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">View</span>, <span class="hljs-title class_">Text</span>, <span class="hljs-title class_">FlatList</span>, <span class="hljs-title class_">RefreshControl</span>, <span class="hljs-title class_">ActivityIndicator</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-comment">// 定义请求函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchTodos</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> { data } = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'https://api.example.com/todos'</span>);
  <span class="hljs-keyword">return</span> data;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoListScreen</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { data, isLoading, isError, refetch } = <span class="hljs-title function_">useQuery</span>({
    <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">'todos'</span>],
    <span class="hljs-attr">queryFn</span>: fetchTodos,
  });

  <span class="hljs-keyword">if</span> (isLoading) <span class="hljs-keyword">return</span> ;
  <span class="hljs-keyword">if</span> (isError) <span class="hljs-keyword">return</span> 加载失败，请重试;

  <span class="hljs-keyword">return</span> (
     item.<span class="hljs-property">id</span>.<span class="hljs-title function_">toString</span>()}
      renderItem={<span class="hljs-function">(<span class="hljs-params">{ item }</span>) =&gt;</span> {item.<span class="hljs-property">title</span>}}
      <span class="hljs-comment">// 集成下拉刷新，只需一行代码</span>
      refreshControl={
        
      }
    /&gt;
  );
}
</code></pre>
<h2 data-id="heading-6">4. 总结</h2>
<p>引入 TanStack Query 是 Expo 应用迈向<strong>高性能</strong>和<strong>高可用性</strong>的关键一步。</p>
<ul>
<li><strong>对于开发者</strong>：它消除了 90% 的冗余代码和手动状态管理。</li>
<li><strong>对于用户</strong>：它提供了丝滑的“切后台刷新”和“断网重连”体验。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[@contextlib.contextmanager 的作用是什么]]></title>    <link>https://juejin.cn/post/7581470169840058406</link>    <guid>https://juejin.cn/post/7581470169840058406</guid>    <pubDate>2025-12-09T03:34:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581470169840058406" data-draft-id="7581448482544943130" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="@contextlib.contextmanager 的作用是什么"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-09T03:34:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Xier"/> <meta itemprop="url" content="https://juejin.cn/user/1152710585356295"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            @contextlib.contextmanager 的作用是什么
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1152710585356295/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Xier
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T03:34:37.000Z" title="Tue Dec 09 2025 03:34:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong><code>with</code> 语句根本听不懂函数的语言，它只听得懂“类”的语言（即 <code>__enter__</code> 和 <code>__exit__</code>）。</strong></p>
<p><code>@contextlib.contextmanager</code> 的作用就是<strong>把你的生成器函数“包装”成一个 <code>with</code> 语句能听懂的类</strong>。</p>
<p>下面我为你拆解它的核心机制：</p>
<h3 data-id="heading-0">1. 为什么不能直接用？</h3>
<p>如果你直接把一个包含 <code>try...finally</code> 和 <code>yield</code> 的普通生成器函数放到 <code>with</code> 后面，程序会直接<strong>报错</strong>。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">my_gen</span>():
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"清理工作"</span>)

<span class="hljs-comment"># ❌ 这样写会报错！</span>
<span class="hljs-comment"># AttributeError: __enter__</span>
<span class="hljs-comment"># with my_gen() as x:</span>
<span class="hljs-comment">#     pass</span>
</code></pre>
<p><strong>原因：</strong> <code>with</code> 语句期望后面的对象必须有 <code>__enter__</code> 和 <code>__exit__</code> 方法。普通的生成器函数返回的是一个生成器对象，它没有这两个方法。</p>
<h3 data-id="heading-1">2. <code>@contextlib.contextmanager</code> 到底做了什么？</h3>
<p>当你给函数加上这个装饰器时，Python 在背后做了一个“偷天换日”的操作：</p>
<ol>
<li>它捕获了你的生成器函数。</li>
<li>它返回了一个<strong>新的对象</strong>（Helper Class），这个对象内部实现了 <code>__enter__</code> 和 <code>__exit__</code>。</li>
<li>它在 <code>__exit__</code> 方法里，帮你去<strong>手动触发</strong>了生成器的后续代码（也就是你的 <code>finally</code> 部分）。</li>
</ol>
<h3 data-id="heading-2">3. 执行流程图解（核心原理）</h3>
<p>为了让你明白 <code>finally</code> 是怎么被触发的，请看这个流程：</p>
<ol>
<li>
<p><strong><code>with</code> 开始</strong> -&gt; 调用装饰器生成的对象的 <code>__enter__</code>。</p>
</li>
<li>
<p><strong><code>__enter__</code> 内部</strong> -&gt; 调用 <code>next(your_generator)</code>。</p>
<ul>
<li>生成器开始运行 -&gt; 遇到 <code>yield</code> 暂停。</li>
<li><code>__enter__</code> 拿到 <code>yield</code> 出来的值，并返回给 <code>as</code> 后的变量。</li>
</ul>
</li>
<li>
<p><strong>用户代码块 (<code>with</code> 内部)</strong> -&gt; 执行你的业务逻辑。</p>
</li>
<li>
<p><strong><code>with</code> 结束</strong> -&gt; 自动调用装饰器生成的对象的 <code>__exit__</code>。</p>
</li>
<li>
<p><strong><code>__exit__</code> 内部</strong> -&gt; <strong>关键点来了！</strong></p>
<ul>
<li>它会再次调用 <code>next(your_generator)</code> (或者 <code>throw</code> 如果有异常)。</li>
<li><strong>这导致生成器从 <code>yield</code> 后面继续运行。</strong></li>
<li>因此，你的 <code>finally</code> 代码块才得以执行。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-3">4. 自己模拟一个 <code>contextmanager</code></h3>
<p>为了证明这一点，我们可以写一个简化版的类，来实现和 <code>@contextlib.contextmanager</code> 一样的功能。看完这个你就彻底懂了：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyContextManagerWrapper</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, generator_func, *args, **kwargs</span>):
        <span class="hljs-comment"># 1. 初始化时，创建一个生成器对象</span>
        self.gen = generator_func(*args, **kwargs)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__enter__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 2. 进入 with 时，运行生成器直到遇到 yield</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">next</span>(self.gen)
        <span class="hljs-keyword">except</span> StopIteration:
            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">"生成器没有 yield 任何值！"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__exit__</span>(<span class="hljs-params">self, exc_type, exc_value, traceback</span>):
        <span class="hljs-comment"># 3. 退出 with 时，核心逻辑在这里！</span>
        <span class="hljs-keyword">if</span> exc_type <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">try</span>:
                <span class="hljs-comment"># 如果没有异常，让生成器继续运行（执行 yield 后面的代码，即 finally）</span>
                <span class="hljs-built_in">next</span>(self.gen)
            <span class="hljs-keyword">except</span> StopIteration:
                <span class="hljs-comment"># 生成器正常结束是预期的</span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">try</span>:
                <span class="hljs-comment"># 如果有异常，把异常扔回给生成器</span>
                self.gen.throw(exc_type, exc_value, traceback)
            <span class="hljs-keyword">except</span> (StopIteration, exc_type):
                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
            <span class="hljs-keyword">except</span> Exception:
                <span class="hljs-comment"># 处理生成器内部的新异常</span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

<span class="hljs-comment"># --- 测试 ---</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">simple_func</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"1. setup"</span>)
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">yield</span> <span class="hljs-string">"资源"</span>
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"3. teardown (finally 执行了)"</span>)

<span class="hljs-comment"># 使用我们要包装的类</span>
<span class="hljs-keyword">with</span> MyContextManagerWrapper(simple_func) <span class="hljs-keyword">as</span> res:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"2. inside with: <span class="hljs-subst">{res}</span>"</span>)
</code></pre>
<p><strong>输出：</strong></p>
<p>Plaintext</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> setup
<span class="hljs-bullet">2.</span> inside with: 资源
<span class="hljs-bullet">3.</span> teardown (finally 执行了)
</code></pre>
<h3 data-id="heading-4">总结</h3>
<p><code>@contextlib.contextmanager</code> <strong>不是仅仅为了执行 <code>finally</code></strong>，它的作用是：</p>
<ol>
<li><strong>桥接 (Bridge)：</strong> 把“生成器”转换成符合“上下文管理器协议”的对象。</li>
<li><strong>驱动 (Driver)：</strong> 它负责在 <code>__enter__</code> 时启动生成器，在 <code>__exit__</code> 时<strong>恢复</strong>生成器的执行。</li>
</ol>
<p>正是因为它在 <code>__exit__</code> 里手动帮你“踹”了生成器一脚（调用了 <code>next()</code>），生成器才得以从 <code>yield</code> 醒来并往下走，从而执行到了你的 <code>finally</code> 代码块。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[新项目为什么推荐WebFlux，而非SpringMVC?]]></title>    <link>https://juejin.cn/post/7581381365494366262</link>    <guid>https://juejin.cn/post/7581381365494366262</guid>    <pubDate>2025-12-09T03:41:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581381365494366262" data-draft-id="7581324707481305129" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="新项目为什么推荐WebFlux，而非SpringMVC?"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-09T03:41:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏三说技术"/> <meta itemprop="url" content="https://juejin.cn/user/465848661970824"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            新项目为什么推荐WebFlux，而非SpringMVC?
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848661970824/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏三说技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T03:41:39.000Z" title="Tue Dec 09 2025 03:41:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>从早期的 Struts 到统治多年的 Spring MVC，我见证了整个 Java Web 开发框架的演进。</p>
<p>今天，我想和大家深入聊聊 Spring 5 带来的这个“新成员”—— <strong>WebFlux</strong>。</p>
<p>有些小伙伴在工作中可能听说过它，知道它“性能高”、“异步非阻塞”，但真要上手，心里却直打鼓：这和 Spring MVC 到底有啥不同？我的项目真的需要它吗？</p>
<p>今天，我们就从底层原理到实战代码，彻底把 WebFlux 讲明白。</p>
<p><a href="https://link.juejin.cn/?target=http%3A%2F%2Fsusan.net.cn%2Fproject" title="https://link.juejin.cn/?target=http%3A%2F%2Fsusan.net.cn%2Fproject" target="_blank">最近准备面试的小伙伴，可以看一下这个宝藏网站（Java突击队）：www.susan.net.cn，里面：面试八股文、场景设计题、Spring源码解读、8个项目实战、工作内推什么都有</a>。</p>
<h2 data-id="heading-1">01 为什么是WebFlux？</h2>
<p>要理解 WebFlux，必须先看清楚它要解决的问题。我们最熟悉的 Spring MVC，其核心是建立在 Servlet API 之上的<strong>同步阻塞模型</strong>。</p>
<p>想象这样一个场景：你的控制器里有一个方法，需要调用一个外部接口获取数据，这个接口响应很慢，可能需要 2 秒。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 传统的Spring MVC控制器</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TraditionalController</span> {
    <span class="hljs-meta">@GetMapping("/slow")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">slowApi</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 模拟一个耗时2秒的远程调用</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> someSlowRemoteService.call(); <span class="hljs-comment">// 线程在这里被阻塞2秒！</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Data: "</span> + data;
    }
}
</code></pre>
<p><strong>问题出在哪里？</strong> 当请求到达服务器时，Servlet 容器（如 Tomcat）会从它的线程池中分配一个工作线程来处理这个请求。</p>
<p>在这个线程执行 <code>someSlowRemoteService.call()</code> 的整整 2 秒钟里，<strong>这个线程什么也做不了，只能空转、等待</strong>。</p>
<p>它无法去处理其他已经到达的请求。如果同一时间有 1000 个这样的并发请求，Tomcat 就需要准备至少 1000 个线程来应对。</p>
<p>每个线程都消耗内存（约 1MB 栈内存）和 CPU 调度资源。当线程数超过物理核心承载能力，大量的时间将浪费在线程上下文切换上，导致响应变慢，最终可能因资源耗尽而崩溃。</p>
<p>这就是 <strong>“一个请求，一个线程”的阻塞模型在 I/O 密集型场景下的天然瓶颈</strong>。我们投入了大量资源（线程），仅仅是为了“等待”，而不是“计算”。</p>
<p>有些小伙伴在工作中，可能已经通过增大线程池、服务拆分等方式缓解了这个问题，但这本质上是“用资源换吞吐量”，并非最优解。</p>
<h2 data-id="heading-2">02 WebFlux的核心：异步非阻塞与响应式流</h2>
<p>WebFlux 的哲学截然不同。它源于<strong>响应式编程范式</strong>，核心目标是：<strong>用少量、固定的线程，处理大量并发请求</strong>。</p>
<p>如何做到？答案是 <strong>事件驱动</strong> 和 <strong>异步非阻塞 I/O</strong>。它不再让线程傻等，而是告诉系统：“我去做点别的，等数据准备好了，你再回调通知我”。</p>
<h3 data-id="heading-3">Reactor 与 Mono/Flux</h3>
<p>这是理解 WebFlux 的第一道坎。WebFlux 构建在 Project Reactor 响应式库之上，引入了两个核心类型：</p>
<ul>
<li><strong>Mono</strong>： 代表 <strong>0 或 1 个</strong> 结果的异步序列。可以把它想象成一个“未来可能到来的单个数据包”的承诺。</li>
<li><strong>Flux</strong>： 代表 <strong>0 到 N 个</strong> 结果的异步序列。可以把它想象成一个“数据流”，数据项一个接一个地异步发布出来。</li>
</ul>
<p>看一个代码对比，立刻就能明白：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Spring MVC: 直接返回对象</span>
<span class="hljs-meta">@GetMapping("/user/{id}")</span>
<span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span> {
    <span class="hljs-keyword">return</span> userService.findById(id); <span class="hljs-comment">// 阻塞式，线程等待数据库返回</span>
}

<span class="hljs-comment">// WebFlux: 返回Mono，代表一个异步承诺</span>
<span class="hljs-meta">@GetMapping("/user/{id}")</span>
<span class="hljs-keyword">public</span> Mono&lt;User&gt; <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span> {
    <span class="hljs-keyword">return</span> userService.findByIdReactive(id); <span class="hljs-comment">// 非阻塞，立即返回Mono，数据稍后填充</span>
}
</code></pre>
<p>在 WebFlux 版本中，<code>getUser</code> 方法<strong>几乎瞬间返回</strong>，返回的是一个 <code>Mono&lt;User&gt;</code> 的空壳。当底层非阻塞数据库驱动真正获取到数据后，会自动将数据“填充”到这个 <code>Mono</code> 里，并最终发送给客户端。在这个过程中，线程没有被挂起，它可以立刻去处理其他请求。</p>
<p>我们可以通过下面这张图，直观感受两种模型处理多个慢请求时的巨大差异：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47208efe6f154e3e9c0f4f454f51dc87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765856499&amp;x-signature=sy9F4uC%2FtkQMfAFsd4sOfs8AZ4g%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">背压（Backpressure）：响应式流的精髓</h3>
<p>这或许是 WebFlux 最精妙也最容易被忽视的特性。在传统的拉取模型中，消费者控制节奏。而在响应式流中，数据由生产者主动推送，如果生产者太快，消费者来不及处理怎么办？</p>
<p><strong>背压机制</strong>允许消费者（如下游服务）主动告知生产者（如上游数据源）“我最多还能处理多少”，生产者据此调整推送速率，避免消费者被压垮。这为构建健壮的流处理系统提供了基础保障，是 Reactive Streams 规范的核心。</p>
<h2 data-id="heading-5">03 两种编程模型：注解与函数式</h2>
<p>有些小伙伴一听要学新框架就头大，生怕过去 Spring MVC 的经验白费。别担心，WebFlux 贴心地提供了两种编程模型，平滑过渡。</p>
<h3 data-id="heading-6">1. 注解模型：最熟悉的陌生人</h3>
<p>这种方式和 Spring MVC <strong>几乎一模一样</strong>，学习成本极低。主要区别仅在于返回值和部分参数类型。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/orders")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactiveOrderController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReactiveOrderService orderService;

    <span class="hljs-comment">// 返回Flux，代表多个订单的流</span>
    <span class="hljs-meta">@GetMapping</span>
    <span class="hljs-keyword">public</span> Flux&lt;Order&gt; <span class="hljs-title function_">getAllOrders</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> orderService.findAll();
    }

    <span class="hljs-comment">// 返回Mono</span>
    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> Mono&lt;Order&gt; <span class="hljs-title function_">getOrderById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span> {
        <span class="hljs-keyword">return</span> orderService.findById(id);
    }

    <span class="hljs-comment">// 参数也可以是Mono</span>
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">createOrder</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Mono&lt;Order&gt; orderMono)</span> {
        <span class="hljs-keyword">return</span> orderMono.flatMap(orderService::save).then();
    }
}
</code></pre>
<p>可以看到，除了 <code>Flux</code> 和 <code>Mono</code> 这些类型，其他注解 <code>@RestController</code>、<code>@GetMapping</code> 都是老熟人。这对于现有项目进行部分重构或新项目启动非常友好。</p>
<h3 data-id="heading-7">2. 函数式模型：更灵活轻量的选择</h3>
<p>这是 WebFlux 的另一面，更像是在用 <strong>Java 8 的 Lambda 表达式和函数式接口来定义路由和处理逻辑</strong>，它不依赖于注解。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RouterFunctionConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RouterFunction&lt;ServerResponse&gt; <span class="hljs-title function_">routeOrder</span><span class="hljs-params">(ReactiveOrderHandler orderHandler)</span> {
        <span class="hljs-keyword">return</span> RouterFunctions.route()
                .GET(<span class="hljs-string">"/fn/orders"</span>, orderHandler::getAll)
                .GET(<span class="hljs-string">"/fn/orders/{id}"</span>, orderHandler::getById)
                .POST(<span class="hljs-string">"/fn/orders"</span>, orderHandler::create)
                .build();
    }
}

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactiveOrderHandler</span> {
    <span class="hljs-keyword">public</span> Mono&lt;ServerResponse&gt; <span class="hljs-title function_">getAll</span><span class="hljs-params">(ServerRequest request)</span> {
        Flux&lt;Order&gt; orders = ... <span class="hljs-comment">// 获取订单流</span>
        <span class="hljs-keyword">return</span> ServerResponse.ok()
                .contentType(MediaType.APPLICATION_JSON)
                .body(orders, Order.class);
    }
    <span class="hljs-comment">// ... 其他处理方法</span>
}
</code></pre>
<p>函数式模型将所有路由和处理器暴露为明确的 Bean，<strong>声明清晰，易于测试，且运行时开销更小</strong>，特别适合微服务场景中功能明确、结构简洁的端点。</p>
<p>最近为了帮助大家找工作，专门建了一些工作内推群，各大城市都有，欢迎各位HR和找工作的小伙伴进群交流，群里目前已经收集了20多家大厂的工作内推岗位。加苏三的微信：li_su223，备注：掘金+所在城市，即可进群。</p>
<h2 data-id="heading-8">04 深入核心：WebFlux如何运转</h2>
<p>理解了表面用法，我们以注解模型为例，深入一层，看看一个请求在 WebFlux 内部是如何流转的。</p>
<p>WebFlux 的核心调度器不再是 Servlet 容器的线程池，而是一个名为 <code>DispatcherHandler</code> 的组件，它扮演着类似 Spring MVC 中 <code>DispatcherServlet</code> 的角色。</p>
<ol>
<li><strong>请求接收</strong>： 以 Netty 为例，I/O 线程接收到 HTTP 请求，将其封装为 <code>ServerWebExchange</code>（一个非阻塞的请求-响应交换对象）。</li>
<li><strong>寻找处理器</strong>： <code>DispatcherHandler</code> 调用一组 <code>HandlerMapping</code>，根据请求路径等信息，找到对应的控制器方法（就是一个 <code>Handler</code>）。</li>
<li><strong>执行处理</strong>： <code>DispatcherHandler</code> 再通过 <code>HandlerAdapter</code> 去实际执行这个控制器方法。我们的方法返回一个 <code>Mono</code> 或 <code>Flux</code>。</li>
<li><strong>处理结果</strong>： <code>HandlerResultHandler</code> 负责处理这个反应式返回类型，将流中的数据序列化（如转为 JSON），并通过非阻塞 I/O 写回响应。</li>
</ol>
<p>整个过程中，<strong>所有环节都是非阻塞的</strong>。线程只在有 CPU 计算任务时才忙碌，一旦遇到 I/O 等待，就会去处理其他任务，从而实现极高的资源利用率。</p>
<p>下面是 WebFlux 核心组件协同处理请求的架构图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/999baa7b71514b11b705d8981fd15709~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765856499&amp;x-signature=dwDZ8W7t5nyQ6VhZVjQESCP2TgU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">05 性能与选择：并非银弹</h2>
<p>读到这里，有些小伙伴可能摩拳擦掌，准备把现有项目全盘迁移到 WebFlux。<strong>且慢！技术选型最忌“为了用而用”</strong>。</p>
<p>WebFlux 和 Spring MVC 不是替代关系，而是互补关系，它们共同扩展了 Spring 生态的能力边界。</p>
<h3 data-id="heading-10">性能真相</h3>
<ul>
<li><strong>WebFlux 的优势在于高并发、低延迟的 I/O 密集型场景</strong>。当你的应用有大量外部调用（数据库、微服务、API）、慢连接或长轮询（如聊天）时，WebFlux 能用更少的资源提供更稳定的吞吐量。</li>
<li><strong>WebFlux 不会让你的 CPU 密集型计算更快</strong>。如果业务逻辑本身就是复杂的计算，没有太多 I/O 等待，那么切换到 WebFlux 可能看不到收益，甚至因为响应式链的开销而略有下降。</li>
<li><strong>资源利用率是核心优势</strong>。WebFlux 通过减少线程数量，降低了内存消耗和上下文切换开销，使系统在压力下的表现更加可预测和稳定。</li>
</ul>
<h3 data-id="heading-11">代价与挑战</h3>
<ul>
<li><strong>编程范式转换</strong>： 从“指令式”思维切换到“声明式”、“函数式”的反应式思维是一大挑战。调试链式调用的 <code>Mono/Flux</code> 也比调试普通代码更困难。</li>
<li><strong>生态兼容性</strong>： 你的整个技术栈都需要支持非阻塞。<strong>这意味着你常用的阻塞式数据库驱动（如 JDBC）、Redis 客户端等可能无法直接使用</strong>，必须寻找其反应式版本（如 R2DBC、Lettuce）。这是一条“全栈反应式”的不归路。</li>
<li><strong>学习曲线</strong>： 团队需要时间学习 Reactor 丰富的操作符（<code>map</code>, <code>flatMap</code>, <code>zip</code> 等）和错误处理机制。</li>
</ul>
<h3 data-id="heading-12">如何选择？</h3>
<p>你可以遵循以下的决策流程，来判断你的项目是否真的需要 WebFlux：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/015ef95dff174171918d00a929c206a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765856499&amp;x-signature=qn%2BeB3u21kXBa2mzSMZMaLDKsJE%3D" alt="image.png" loading="lazy"/></p>
<p><strong>对于新项目</strong>： 如果是微服务网关（Spring Cloud Gateway 就是基于 WebFlux）、实时监控、消息推送等场景，WebFlux 是绝佳选择。</p>
<p><strong>对于现有项目</strong>： <strong>不要轻易重构！</strong> 如果 Spring MVC 运行良好，重构的成本和风险极高。</p>
<p>一个更务实的切入点是：<strong>先在 Spring MVC 项目中使用 <code>WebClient</code>（WebFlux 提供的非阻塞 HTTP 客户端）来调用外部慢服务</strong>，这能立即为你的应用带来部分非阻塞的优势。</p>
<hr/>
<h2 data-id="heading-13">06 总结</h2>
<p>WebFlux 是 Spring 应对现代高并发、低延迟应用需求交出的一份优秀答卷。</p>
<p>它通过异步非阻塞和响应式流的技术，在 I/O 密集型领域展现出巨大优势。</p>
<p>但它不是一个“傻瓜式”的性能提升按钮，而是一套完整的、有门槛的新编程范式。</p>
<p>我们的职责不是追逐最酷的技术，而是<strong>为业务场景选择最合适的技术</strong>。</p>
<p>在你决定拥抱 WebFlux 之前，不妨先问自己三个问题：</p>
<ol>
<li>我的应用瓶颈真的是 I/O 吗？</li>
<li>我的团队和技术栈准备好“全栈反应式”了吗？</li>
<li>预期的收益能否覆盖学习和改造成本？</li>
</ol>
<p>想清楚这些问题，你的选择自然会清晰起来。</p>
<p>技术世界没有银弹，<strong>理解原理，权衡利弊，方是长期主义者的生存之道</strong>。</p>
<h2 data-id="heading-14">最后说一句(求关注，别白嫖我)</h2>
<p>如果这篇文章对您有所帮助，或者有所启发的话，帮忙关注一下我的同名公众号：苏三说技术，您的支持是我坚持写作最大的动力。</p>
<p>求一键三连：点赞、转发、在看。</p>
<p>关注公众号：【苏三说技术】，在公众号中回复：进大厂，可以免费获取我最近整理的10万字的面试宝典，好多小伙伴靠这个宝典拿到了多家大厂的offer。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【AI 编程实战】第 2 篇：让 AI 成为你的前端架构师 - UniApp + Vue3 项目初始化]]></title>    <link>https://juejin.cn/post/7581437632855015464</link>    <guid>https://juejin.cn/post/7581437632855015464</guid>    <pubDate>2025-12-09T06:40:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581437632855015464" data-draft-id="7581545175508598836" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【AI 编程实战】第 2 篇：让 AI 成为你的前端架构师 - UniApp + Vue3 项目初始化"/> <meta itemprop="keywords" content="前端,Vue.js,AI编程"/> <meta itemprop="datePublished" content="2025-12-09T06:40:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HashTang"/> <meta itemprop="url" content="https://juejin.cn/user/1117561754756488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【AI 编程实战】第 2 篇：让 AI 成为你的前端架构师 - UniApp + Vue3 项目初始化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1117561754756488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HashTang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T06:40:54.000Z" title="Tue Dec 09 2025 06:40:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="vs2015">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1e1e1e;color:#dcdcdc}.hljs-keyword,.hljs-link,.hljs-literal,.hljs-name,.hljs-symbol{color:#569cd6}.hljs-link{text-decoration:underline}.hljs-built_in,.hljs-type{color:#4ec9b0}.hljs-class,.hljs-number{color:#b8d7a3}.hljs-meta-string,.hljs-string{color:#d69d85}.hljs-regexp,.hljs-template-tag{color:#9a5334}.hljs-formula,.hljs-function,.hljs-params,.hljs-subst,.hljs-title{color:#dcdcdc}.hljs-comment,.hljs-quote{color:#57a64a;font-style:italic}.hljs-doctag{color:#608b4e}.hljs-meta,.hljs-meta-keyword,.hljs-tag{color:#9b9b9b}.hljs-template-variable,.hljs-variable{color:#bd63c5}.hljs-attr,.hljs-attribute,.hljs-builtin-name{color:#9cdcfe}.hljs-section{color:gold}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-bullet,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag{color:#d7ba7d}.hljs-addition{background-color:#144212}.hljs-addition,.hljs-deletion{display:inline-block;width:100%}.hljs-deletion{background-color:#600}</style><blockquote>
<p>传统方式搭建前端项目：查文档、试错、调试，耗时 1 天起步。AI 辅助：对话式配置，1 小时搞定。这是《<a href="https://juejin.cn/column/7579556047783624756" target="_blank" title="https://juejin.cn/column/7579556047783624756">AI 编程实战：TRAE SOLO 全栈开发指南</a>》专栏的第二篇文章，带你用 AI 快速搭建专业级前端项目架构。</p>
</blockquote>
<h2 data-id="heading-0">一、开篇：为什么项目初始化这么让人头疼？</h2>
<p>还记得上一篇文章里提到的小何吗？他在"心动恋聊"项目中遇到的第一个挑战，就是前端项目初始化。</p>
<h3 data-id="heading-1">1.1 传统方式的痛点</h3>
<p>如果你做过前端项目，一定深有体会：</p>
<p><strong>技术选型迷茫</strong>：</p>
<pre><code class="hljs">UniApp vs Taro vs 原生？
Vue3 还是 React？
Vite 还是 Webpack？
UnoCSS 还是 Tailwind CSS？
</code></pre>
<p>每个选择背后都是无数的文档、博客、踩坑记录。光是技术选型，就能让人纠结半天。</p>
<p><strong>配置地狱</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">vite.config.ts
tsconfig.json
uno.config.ts
.eslintrc.js
.prettierrc
pages.json
manifest.json
...
</code></pre>
<p>每一个配置文件都有自己的语法、规则、坑点。配置完一个，还有下一个在等着你。</p>
<p><strong>时间黑洞</strong>：</p>
<p>小何最初的估算：</p>

















































<table><thead><tr><th>任务</th><th>预计时间</th></tr></thead><tbody><tr><td>技术调研</td><td>2 小时</td></tr><tr><td>项目创建</td><td>0.5 小时</td></tr><tr><td>Vite 配置</td><td>1 小时</td></tr><tr><td>TypeScript 配置</td><td>1 小时</td></tr><tr><td>UI 框架集成</td><td>2 小时</td></tr><tr><td>自动导入配置</td><td>1 小时</td></tr><tr><td>路由配置</td><td>1 小时</td></tr><tr><td>环境变量配置</td><td>0.5 小时</td></tr><tr><td>代码规范配置</td><td>2 小时</td></tr><tr><td><strong>总计</strong></td><td><strong>11 小时</strong></td></tr></tbody></table>
<p>实际上，因为各种问题、版本冲突、配置不兼容，往往需要 <strong>1.5-2 天</strong>。</p>
<h3 data-id="heading-2">1.2 AI 辅助的革命性变化</h3>
<p>有了 TRAE SOLO，一切都不同了。</p>
<p><strong>小何的实际体验</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">小何：帮我创建一个 UniApp + Vue3 + TypeScript 项目，
      使用 Vite 构建，支持微信小程序、H5、App 三端，
      集成 UnoCSS 和 UView Pro 组件库

AI：好的，我来帮你搭建完整的项目架构：

    ✓ 分析需求，确定技术选型
    ✓ 创建 Monorepo 项目结构
    ✓ 配置 Vite 构建工具
    ✓ 集成 TypeScript 严格模式
    ✓ 配置 UnoCSS 原子化 CSS
    ✓ 集成 UView Pro 组件库
    ✓ 设置自动导入
    ✓ 配置多环境变量
    ✓ 添加代码规范工具

    项目结构已生成，请查看...
</code></pre>
<p><strong>一天的工作，不到一小时完成。</strong> 这就是 AI 辅助开发的魔力。</p>
<h2 data-id="heading-3">二、技术选型：让 AI 帮你做决策</h2>
<h3 data-id="heading-4">2.1 框架对比分析</h3>
<p>项目开始前，小何需要确定技术选型。传统做法是搜索各种博客文章、技术对比，然后纠结半天。</p>
<p><strong>TRAE SOLO 的做法</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">小何：帮我对比 UniApp、Taro、原生小程序的优劣，
      项目需求：社交类小程序，需要支持微信小程序、H5、App 三端

AI：（通过 MCP 实时查阅最新文档）

      分析结论：

      1. UniApp 优势：
         - 一套代码，支持微信/H5/App/鸿蒙等多端
         - Vue3 技术栈，学习成本低
         - 生态完善，组件库丰富
         - 文档完善，社区活跃

      2. Taro 优势：
         - React 技术栈友好
         - 适合已有 React 经验的团队

      3. 原生小程序：
         - 性能最优
         - 但只能在单一平台运行

      推荐：UniApp + Vue3

      理由：
      1. 项目需要三端发布，UniApp 跨端能力最强
      2. 社交类应用迭代快，UniApp 开发效率高
      3. 后续还要扩展到鸿蒙、安卓、iOS，UniApp 支持最全
</code></pre>
<p><strong>5 分钟，得到了专业级的技术选型分析报告。</strong></p>
<h3 data-id="heading-5">2.2 构建工具选择</h3>
<pre><code class="hljs language-txt" lang="txt">小何：UniApp 应该用 Vite 还是 Webpack？

AI：强烈推荐 Vite！

      对比分析：
      ┌────────────┬────────────────┬────────────────┐
      │   维度     │     Vite       │    Webpack     │
      ├────────────┼────────────────┼────────────────┤
      │ 冷启动     │ 毫秒级         │ 秒级           │
      │ 热更新     │ 即时           │ 有延迟         │
      │ 配置复杂度 │ 简单           │ 复杂           │
      │ 生态支持   │ 完善           │ 非常完善       │
      │ 构建速度   │ 快             │ 较慢           │
      └────────────┴────────────────┴────────────────┘

      实测数据（心动恋聊项目）：
      - Vite 冷启动：1.2 秒
      - Webpack 冷启动：8.5 秒

      结论：Vite 开发体验完胜，选它！
</code></pre>
<h3 data-id="heading-6">2.3 最终技术栈确定</h3>
<p>通过 AI 辅助分析，"心动恋聊"项目确定了以下技术栈：</p>
<pre><code class="hljs language-txt" lang="txt">前端技术栈：
├── 框架：UniApp + Vue 3.4.21
├── 构建工具：Vite 5.2.8
├── 语言：TypeScript 5.7
├── 状态管理：Pinia 2.0.36 + 持久化
├── 原子化 CSS：UnoCSS 66.0
├── UI 组件库：UView Pro
├── HTTP 请求：自定义封装（基于 uni.request）
├── 列表优化：z-paging 2.8.7
└── 数据请求：@tanstack/vue-query
</code></pre>
<h2 data-id="heading-7">三、项目初始化：AI 一键生成</h2>
<h3 data-id="heading-8">3.1 Monorepo 项目结构</h3>
<p>"心动恋聊"采用 Monorepo 架构，这是现代前端项目的最佳实践。</p>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我创建一个 Monorepo 项目结构，包含：
1. apps/unibest-mp - UniApp 小程序端
2. apps/xindong-server - Next.js 服务端
3. packages/shared-types - 共享类型定义
使用 pnpm 管理依赖，Turborepo 编排任务
</code></pre>
<p><strong>AI 生成的项目结构</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">xingdong/
├── apps/
│   ├── unibest-mp/              # UniApp 多端应用
│   │   ├── src/
│   │   │   ├── api/             # API 接口定义
│   │   │   ├── components/      # 公共组件
│   │   │   ├── composables/     # 组合式函数
│   │   │   ├── config/          # 配置文件
│   │   │   ├── hooks/           # 自定义 Hooks
│   │   │   ├── http/            # HTTP 请求封装
│   │   │   ├── layouts/         # 布局组件
│   │   │   ├── pages/           # 页面文件
│   │   │   ├── store/           # Pinia 状态管理
│   │   │   ├── subPackages/     # 分包页面
│   │   │   │   ├── agreement/   # 协议相关
│   │   │   │   ├── vip/         # 会员相关
│   │   │   │   └── planForm/    # 计划表单
│   │   │   ├── tabbar/          # 底部导航
│   │   │   └── utils/           # 工具函数
│   │   ├── env/                 # 环境变量
│   │   ├── vite.config.ts       # Vite 配置
│   │   └── package.json
│   │
│   └── xingdong-server/         # Next.js 服务端
│       ├── src/
│       │   └── app/             # App Router
│       └── package.json
│
├── packages/
│   └── shared-types/            # 共享类型定义
│       ├── src/
│       │   └── index.ts
│       └── package.json
│
├── pnpm-workspace.yaml          # pnpm 工作区配置
├── turbo.json                   # Turborepo 配置
└── package.json                 # 根配置
</code></pre>
<p><strong>pnpm-workspace.yaml</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">packages:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">apps/*</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">packages/*</span>
</code></pre>
<p><strong>turbo.json</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"$schema"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://turbo.build/schema.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tasks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"dependsOn"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"^build"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"outputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"apps/unibest-mp/dist/**"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"apps/xingdong-server/.next/**"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"cache"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"persistent"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这个结构的好处：</p>
<ol>
<li><strong>代码复用</strong>：shared-types 包让前后端类型一致</li>
<li><strong>独立开发</strong>：前后端可以独立启动、独立部署</li>
<li><strong>并行构建</strong>：Turborepo 自动并行执行不相关的任务</li>
</ol>
<h3 data-id="heading-9">3.2 配置 Vite</h3>
<p>Vite 配置是前端项目的核心。让我们看看 AI 生成的实际配置：</p>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我配置 UniApp 的 Vite 配置文件，需要：
1. 自动导入 Vue API
2. 自动导入 uni-app API
3. 自动导入自定义 hooks
4. 配置路径别名
5. 支持多环境变量
6. 集成 UnoCSS
7. 配置分包优化
</code></pre>
<p><strong>生成的 vite.config.ts（实际项目配置）</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// vite.config.ts 核心配置片段</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> ({ command, mode }) =&gt; {
  <span class="hljs-comment">// ... 环境变量加载逻辑 ...</span>

  <span class="hljs-keyword">return</span> <span class="hljs-title function_">defineConfig</span>({
    <span class="hljs-attr">plugins</span>: [
      <span class="hljs-comment">// 1. 页面路由自动生成</span>
      <span class="hljs-title class_">UniPages</span>({
        <span class="hljs-attr">exclude</span>: [<span class="hljs-string">'**/components/**/**.*'</span>],
        <span class="hljs-attr">subPackages</span>: [
          <span class="hljs-string">'src/subPackages/agreement'</span>,
          <span class="hljs-string">'src/subPackages/vip'</span>,
          <span class="hljs-string">'src/subPackages/planForm'</span>,
        ],
      }),

      <span class="hljs-comment">// 2. 布局系统 &amp; 平台适配</span>
      <span class="hljs-title class_">UniLayouts</span>(),
      <span class="hljs-title class_">UniPlatform</span>(),
      <span class="hljs-title class_">UniManifest</span>(),

      <span class="hljs-comment">// 3. 修复 Vue 编译问题（AI 自动生成的补丁）</span>
      {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'fix-vite-plugin-vue'</span>,
        <span class="hljs-title function_">configResolved</span>(<span class="hljs-params">config</span>) {
          <span class="hljs-keyword">const</span> plugin = config.<span class="hljs-property">plugins</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.<span class="hljs-property">name</span> === <span class="hljs-string">'vite:vue'</span>);
          <span class="hljs-keyword">if</span> (plugin &amp;&amp; plugin.<span class="hljs-property">api</span> &amp;&amp; plugin.<span class="hljs-property">api</span>.<span class="hljs-property">options</span>) {
            plugin.<span class="hljs-property">api</span>.<span class="hljs-property">options</span>.<span class="hljs-property">devToolsEnabled</span> = <span class="hljs-literal">false</span>;
          }
        },
      },

      <span class="hljs-comment">// 4. UnoCSS 原子化 CSS</span>
      <span class="hljs-title class_">UnoCSS</span>(),

      <span class="hljs-comment">// 5. 自动导入</span>
      <span class="hljs-title class_">AutoImport</span>({
        <span class="hljs-attr">imports</span>: [<span class="hljs-string">'vue'</span>, <span class="hljs-string">'uni-app'</span>],
        <span class="hljs-attr">dirs</span>: [<span class="hljs-string">'src/hooks'</span>],
        <span class="hljs-attr">vueTemplate</span>: <span class="hljs-literal">true</span>,
      }),

      <span class="hljs-comment">// ... 其他插件</span>
      <span class="hljs-title class_">Uni</span>(),
    ],
    <span class="hljs-comment">// ...</span>
  });
};
</code></pre>
<p><strong>这个配置包含了</strong>：</p>
<ol>
<li><strong>@uni-helper 插件生态</strong>：页面路由、布局、平台、manifest 全自动化</li>
<li><strong>UnoCSS</strong>：原子化 CSS，开发效率翻倍</li>
<li><strong>AutoImport</strong>：Vue API、uni-app API、自定义 hooks 自动导入</li>
<li><strong>Hack 修复</strong>：AI 甚至帮我生成了一个 <code>fix-vite-plugin-vue</code> 插件来解决特定的编译 Bug，这在传统开发中可能要排查半天。</li>
</ol>
<h3 data-id="heading-10">3.3 TypeScript 配置</h3>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我配置 TypeScript 严格模式，确保类型安全，支持 Vue3 和 uni-app
</code></pre>
<p><strong>生成的配置</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"extends"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@vue/tsconfig/tsconfig.dom.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"strict"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"noImplicitAny"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"strictNullChecks"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"moduleResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"bundler"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"jsx"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"preserve"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"jsxImportSource"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vue"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"@img/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/static/images/*"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"@dcloudio/types"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"@uni-helper/uni-types"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"miniprogram-api-typings"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/**/*.ts"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"src/**/*.vue"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"exclude"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"node_modules"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"dist"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-11">四、UI 框架集成：UnoCSS + UView Pro</h2>
<h3 data-id="heading-12">4.1 UnoCSS 配置：AI 也会"翻车"</h3>
<p>UnoCSS 是原子化 CSS 的最佳选择，但在小程序环境中使用时，AI 一开始给出的配置并不完美。</p>
<p><strong>第一次尝试</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">小何：配置 UnoCSS
AI：生成了标准的 Web 端配置（presetUno）。
结果：小程序端样式完全不生效。
</code></pre>
<p><strong>修正后的交互</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">小何：这个配置在微信小程序里不生效，请检查是否需要专用预设？

AI：抱歉，你是对的。在 UniApp 中需要使用 `@uni-helper/unocss-preset-uni`。
    我已更新配置：
</code></pre>
<p><strong>最终生成的 uno.config.ts</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { defineConfig, presetIcons } <span class="hljs-keyword">from</span> <span class="hljs-string">'unocss'</span>;
<span class="hljs-keyword">import</span> { presetUni } <span class="hljs-keyword">from</span> <span class="hljs-string">'@uni-helper/unocss-preset-uni'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">presets</span>: [
    <span class="hljs-comment">// 使用 UniApp 专用预设，解决小程序兼容性问题</span>
    <span class="hljs-title function_">presetUni</span>({
      <span class="hljs-attr">attributify</span>: {
        <span class="hljs-attr">prefixedOnly</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 避免属性冲突</span>
      },
    }),
    <span class="hljs-title function_">presetIcons</span>({
      <span class="hljs-attr">scale</span>: <span class="hljs-number">1.2</span>,
      <span class="hljs-attr">warn</span>: <span class="hljs-literal">true</span>,
    }),
  ],
  <span class="hljs-attr">theme</span>: {
    <span class="hljs-attr">colors</span>: {
      <span class="hljs-comment">// 使用 CSS 变量，支持动态换肤</span>
      <span class="hljs-attr">primary</span>: <span class="hljs-string">'var(--wot-color-theme,#0957DE)'</span>,
    },
  },
});
</code></pre>
<p>这里的重点是 <strong><code>presetUni</code></strong> 和 <strong><code>prefixedOnly</code></strong>，这是 AI 在被指出错误后迅速修正的关键点。</p>
<p><strong>UnoCSS 的优势</strong>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 传统 CSS 写法 --&gt;
&lt;template&gt;
  &lt;view class="container"&gt;
    &lt;text class="title"&gt;心动恋聊&lt;/text&gt;
  &lt;/view&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.container {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 16px;
}
.title {
  font-size: 24px;
  font-weight: bold;
  color: #ff6b9d;
}
&lt;/style&gt;

&lt;!-- UnoCSS 写法 --&gt;
&lt;template&gt;
  &lt;view class="flex-center p-4"&gt;
    &lt;text class="text-24px font-bold text-primary"&gt;心动恋聊&lt;/text&gt;
  &lt;/view&gt;
&lt;/template&gt;
</code></pre>
<p><strong>代码量减少 70%，开发效率大幅提升！</strong></p>
<h3 data-id="heading-13">4.2 UView Pro 集成</h3>
<p>UView Pro 是 UniApp 最好用的组件库之一。</p>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我集成 UView Pro 组件库，配置按需导入和主题定制
</code></pre>
<p><strong>package.json 依赖</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"uview-pro"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^0.0.3"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>组件使用示例</strong>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;view class="page"&gt;
    &lt;!-- 导航栏 --&gt;
    &lt;u-navbar title="心动恋聊" :placeholder="true" /&gt;

    &lt;!-- 表单 --&gt;
    &lt;u-form ref="formRef" :model="formData" :rules="rules"&gt;
      &lt;u-form-item label="昵称" prop="nickname"&gt;
        &lt;u-input v-model="formData.nickname" placeholder="请输入昵称" /&gt;
      &lt;/u-form-item&gt;
      &lt;u-form-item label="性别" prop="gender"&gt;
        &lt;u-radio-group v-model="formData.gender"&gt;
          &lt;u-radio label="男" :name="1" /&gt;
          &lt;u-radio label="女" :name="2" /&gt;
        &lt;/u-radio-group&gt;
      &lt;/u-form-item&gt;
    &lt;/u-form&gt;

    &lt;!-- 按钮 --&gt;
    &lt;u-button type="primary" @click="handleSubmit"&gt;提交&lt;/u-button&gt;

    &lt;!-- 弹窗 --&gt;
    &lt;u-popup v-model:show="showPopup" mode="bottom"&gt;
      &lt;view class="p-4"&gt;弹窗内容&lt;/view&gt;
    &lt;/u-popup&gt;
  &lt;/view&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
const formRef = ref();
const showPopup = ref(false);

const formData = reactive({
  nickname: '',
  gender: 1,
});

const rules = {
  nickname: [{ required: true, message: '请输入昵称' }],
  gender: [{ required: true, message: '请选择性别' }],
};

const handleSubmit = async () =&gt; {
  const valid = await formRef.value.validate();
  if (valid) {
    // 提交逻辑
  }
};
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-14">五、自动导入配置：提升开发体验</h2>
<h3 data-id="heading-15">5.1 Vue API 自动导入</h3>
<p>传统写法每个文件都要导入：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 传统写法</span>
<span class="hljs-keyword">import</span> { ref, reactive, computed, watch, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);
<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">''</span> });
</code></pre>
<p>配置自动导入后：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 自动导入后，直接使用</span>
<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);
<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">''</span> });
<span class="hljs-keyword">const</span> double = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>);

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'mounted'</span>);
});
</code></pre>
<p><strong>AutoImport 配置</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">AutoImport</span>({
  <span class="hljs-attr">imports</span>: [<span class="hljs-string">'vue'</span>, <span class="hljs-string">'uni-app'</span>],
  <span class="hljs-attr">dts</span>: <span class="hljs-string">'src/types/auto-import.d.ts'</span>,
  <span class="hljs-attr">dirs</span>: [<span class="hljs-string">'src/hooks'</span>],
  <span class="hljs-attr">vueTemplate</span>: <span class="hljs-literal">true</span>,
});
</code></pre>
<p>这会自动生成类型声明文件 <code>src/types/auto-import.d.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Auto generated by unplugin-auto-import</span>
<span class="hljs-keyword">export</span> {};
<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">global</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">computed</span>: (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'vue'</span>))[<span class="hljs-string">'computed'</span>];
  <span class="hljs-keyword">const</span> <span class="hljs-attr">onMounted</span>: (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'vue'</span>))[<span class="hljs-string">'onMounted'</span>];
  <span class="hljs-keyword">const</span> <span class="hljs-attr">onUnmounted</span>: (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'vue'</span>))[<span class="hljs-string">'onUnmounted'</span>];
  <span class="hljs-keyword">const</span> <span class="hljs-attr">reactive</span>: (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'vue'</span>))[<span class="hljs-string">'reactive'</span>];
  <span class="hljs-keyword">const</span> <span class="hljs-attr">ref</span>: (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'vue'</span>))[<span class="hljs-string">'ref'</span>];
  <span class="hljs-keyword">const</span> <span class="hljs-attr">watch</span>: (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'vue'</span>))[<span class="hljs-string">'watch'</span>];
  <span class="hljs-comment">// uni-app APIs</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">onLaunch</span>: (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'uni-app'</span>))[<span class="hljs-string">'onLaunch'</span>];
  <span class="hljs-keyword">const</span> <span class="hljs-attr">onShow</span>: (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'uni-app'</span>))[<span class="hljs-string">'onShow'</span>];
  <span class="hljs-keyword">const</span> <span class="hljs-attr">onHide</span>: (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'uni-app'</span>))[<span class="hljs-string">'onHide'</span>];
  <span class="hljs-comment">// ... 更多</span>
}
</code></pre>
<h3 data-id="heading-16">5.2 自定义 Hooks 自动导入</h3>
<p>在 <code>src/hooks/</code> 目录下创建的 hooks 也会自动导入：</p>
<p><strong>src/hooks/useRequest.ts</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Ref</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UseRequestOptions</span>&lt;T&gt; {
  immediate?: <span class="hljs-built_in">boolean</span>;
  onSuccess?: <span class="hljs-function">(<span class="hljs-params">data: T</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
  onError?: <span class="hljs-function">(<span class="hljs-params">error: <span class="hljs-built_in">Error</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> useRequest&lt;T&gt;(<span class="hljs-attr">fn</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;T&gt;, <span class="hljs-attr">options</span>: <span class="hljs-title class_">UseRequestOptions</span>&lt;T&gt; = {}) {
  <span class="hljs-keyword">const</span> { immediate = <span class="hljs-literal">false</span>, onSuccess, onError } = options;

  <span class="hljs-keyword">const</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">Ref</span>&lt;T | <span class="hljs-literal">null</span>&gt; = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> error = ref&lt;<span class="hljs-title class_">Error</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">execute</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
    error.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">try</span> {
      data.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fn</span>();
      onSuccess?.(data.<span class="hljs-property">value</span>);
    } <span class="hljs-keyword">catch</span> (e) {
      error.<span class="hljs-property">value</span> = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>;
      onError?.(error.<span class="hljs-property">value</span>);
    } <span class="hljs-keyword">finally</span> {
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
    }
  };

  <span class="hljs-keyword">if</span> (immediate) {
    <span class="hljs-title function_">execute</span>();
  }

  <span class="hljs-keyword">return</span> { data, loading, error, execute };
}
</code></pre>
<p><strong>使用时无需导入</strong>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
// 直接使用，无需 import
const { data, loading, execute } = useRequest(() =&gt; apiGetUserInfo(), { immediate: true });
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-17">5.3 组件自动注册</h3>
<p>配置 <code>@uni-helper/vite-plugin-uni-components</code> 后，组件也自动注册：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">Components</span>({
  <span class="hljs-attr">extensions</span>: [<span class="hljs-string">'vue'</span>],
  <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">directoryAsNamespace</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">dts</span>: <span class="hljs-string">'src/types/components.d.ts'</span>,
});
</code></pre>
<p><strong>src/components/UserCard.vue</strong>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;view class="user-card"&gt;
    &lt;image :src="user.avatar" class="avatar" /&gt;
    &lt;text class="name"&gt;{{ user.name }}&lt;/text&gt;
  &lt;/view&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
defineProps&lt;{
  user: {
    avatar: string;
    name: string;
  };
}&gt;();
&lt;/script&gt;
</code></pre>
<p><strong>使用时无需注册</strong>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;!-- 直接使用，无需 import 和 components 注册 --&gt;
  &lt;UserCard :user="userInfo" /&gt;
&lt;/template&gt;
</code></pre>
<h2 data-id="heading-18">六、路由配置：pages.json 优化</h2>
<h3 data-id="heading-19">6.1 页面路由自动生成</h3>
<p>使用 <code>@uni-helper/vite-plugin-uni-pages</code>，页面路由可以自动生成。</p>
<p><strong>在页面文件中配置路由</strong>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/pages/index/index.vue --&gt;
&lt;route lang="json"&gt;
{
  "style": {
    "navigationBarTitleText": "首页"
  }
}
&lt;/route&gt;

&lt;template&gt;
  &lt;view class="page"&gt;
    &lt;!-- 页面内容 --&gt;
  &lt;/view&gt;
&lt;/template&gt;
</code></pre>
<p><strong>自动生成的 pages.json</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"pages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pages/index/index"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"navigationBarTitleText"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"首页"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pages/my/my"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"navigationBarTitleText"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我的"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"subPackages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"root"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"subPackages/agreement"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"pages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"privacy"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"navigationBarTitleText"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"隐私协议"</span> <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user-agreement"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"navigationBarTitleText"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"用户协议"</span> <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"root"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"subPackages/vip"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"pages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"index"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"navigationBarTitleText"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"会员中心"</span> <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tabBar"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"color"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#999999"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"selectedColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#FF6B9D"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"backgroundColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#ffffff"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"list"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"pagePath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pages/index/index"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"首页"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"iconPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"static/tabbar/home.png"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"selectedIconPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"static/tabbar/home-active.png"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"pagePath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pages/my/my"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我的"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"iconPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"static/tabbar/my.png"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"selectedIconPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"static/tabbar/my-active.png"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"globalStyle"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"navigationBarTextStyle"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"black"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"navigationBarTitleText"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"心动恋聊"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"navigationBarBackgroundColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#ffffff"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"backgroundColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#F5F5F5"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-20">6.2 分包配置</h3>
<p>小程序有包体积限制（主包 2MB，总包 20MB），分包是必须的。</p>
<p><strong>配置分包</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-title class_">UniPages</span>({
  <span class="hljs-attr">exclude</span>: [<span class="hljs-string">'**/components/**/**.*'</span>],
  <span class="hljs-attr">dts</span>: <span class="hljs-string">'src/types/uni-pages.d.ts'</span>,
  <span class="hljs-attr">subPackages</span>: [
    <span class="hljs-string">'src/subPackages/agreement'</span>, <span class="hljs-comment">// 协议相关页面</span>
    <span class="hljs-string">'src/subPackages/vip'</span>, <span class="hljs-comment">// 会员相关页面</span>
    <span class="hljs-string">'src/subPackages/planForm'</span>, <span class="hljs-comment">// 计划表单页面</span>
  ],
});
</code></pre>
<p><strong>分包优化插件</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// @uni-ku/bundle-optimizer 自动优化</span>
<span class="hljs-title class_">Optimization</span>({
  <span class="hljs-attr">enable</span>: {
    <span class="hljs-attr">optimization</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 开启优化</span>
    <span class="hljs-string">'async-import'</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 异步导入</span>
    <span class="hljs-string">'async-component'</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 异步组件</span>
  },
  <span class="hljs-attr">dts</span>: {
    <span class="hljs-attr">base</span>: <span class="hljs-string">'src/types'</span>,
  },
});
</code></pre>
<h2 data-id="heading-21">七、环境变量配置</h2>
<h3 data-id="heading-22">7.1 多环境配置</h3>
<p>"心动恋聊"项目支持多环境、多项目配置：</p>
<p><strong>目录结构</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">env/
├── .env                           # 基础配置
├── .env.development               # 开发环境
└── .env.production                # 生产环境
</code></pre>
<p><strong>.env.development</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"> <span class="hljs-comment"># 基础配置</span>
 VITE_APP_PORT=5173
 VITE_APP_PUBLIC_BASE=/

 <span class="hljs-comment"># API 配置</span>
 VITE_SERVER_BASEURL=http://localhost:3000
 VITE_APP_PROXY=<span class="hljs-literal">true</span>

 <span class="hljs-comment"># 业务配置</span>
 VITE_APP_SOURCE_ID=your_source_id
 VITE_APP_CHANNEL_ID=weixin
</code></pre>
<h3 data-id="heading-23">7.2 环境变量使用</h3>
<p><strong>在代码中使用</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 直接使用</span>
<span class="hljs-keyword">const</span> apiBaseUrl = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_SERVER_BASEURL</span>;
<span class="hljs-keyword">const</span> sourceId = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_APP_SOURCE_ID</span>;

<span class="hljs-comment">// 类型安全</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ImportMetaEnv</span> {
  <span class="hljs-attr">VITE_APP_PORT</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">VITE_SERVER_BASEURL</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">VITE_APP_SOURCE_ID</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">VITE_APP_CHANNEL_ID</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">VITE_APP_BRAND_KEY</span>: <span class="hljs-built_in">string</span>;
}
</code></pre>
<p><strong>启动命令</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev:mp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uni -p mp-weixin --mode development"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build:mp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uni build -p mp-weixin --mode production"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-24">八、代码规范配置</h2>
<h3 data-id="heading-25">8.1 ESLint 配置</h3>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">配置 ESLint，适合 Vue3 + TypeScript + UniApp 项目
</code></pre>
<p><strong>使用 @uni-helper/eslint-config</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// eslint.config.js</span>
<span class="hljs-keyword">import</span> uniHelper <span class="hljs-keyword">from</span> <span class="hljs-string">'@uni-helper/eslint-config'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">uniHelper</span>({
  <span class="hljs-attr">typescript</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">vue</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">unocss</span>: <span class="hljs-literal">true</span>,
});
</code></pre>
<h3 data-id="heading-26">8.2 Prettier 配置</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// .prettierrc</span>
{
  <span class="hljs-string">"printWidth"</span>: <span class="hljs-number">100</span>,
  <span class="hljs-string">"singleQuote"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"trailingComma"</span>: <span class="hljs-string">"all"</span>,
  <span class="hljs-string">"semi"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"tabWidth"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"endOfLine"</span>: <span class="hljs-string">"lf"</span>
}
</code></pre>
<h3 data-id="heading-27">8.3 Git Hooks</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// package.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"lint-staged"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"*"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint --fix"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-28">九、实战演示：首页核心逻辑开发</h2>
<p>"心动恋聊"的首页并不是一个简单的展示页，它包含了一个复杂的交互逻辑：<strong>文字/图片输入模式切换</strong>。</p>
<h3 data-id="heading-29">9.1 需求描述</h3>
<pre><code class="hljs language-txt" lang="txt">小何：首页需要一个输入区域，支持两种模式：
1. 文字模式：输入对方说的话。
2. 图片模式：上传聊天截图。

切换模式时，输入框和上传区域要互斥显示。
并且需要一个"清除记忆"的功能，但只在文字模式下显示。
</code></pre>
<h3 data-id="heading-30">9.2 AI 的逐步实现</h3>
<p>这是一个涉及状态管理、UI 交互和业务逻辑的复杂需求。AI 是如何一步步实现的呢？</p>
<p><strong>第一步：定义状态</strong></p>
<p>AI 首先定义了核心的响应式状态：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/pages/index/index.vue</span>
<span class="hljs-keyword">const</span> showUploadArea = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>); <span class="hljs-comment">// 控制模式切换</span>
<span class="hljs-keyword">const</span> inputText = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>); <span class="hljs-comment">// 文字输入</span>
<span class="hljs-keyword">const</span> selectedImages = <span class="hljs-title function_">ref</span>([]); <span class="hljs-comment">// 图片列表</span>

<span class="hljs-comment">// 切换模式逻辑</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleInputMode</span> = (<span class="hljs-params"/>) =&gt; {
  showUploadArea.<span class="hljs-property">value</span> = !showUploadArea.<span class="hljs-property">value</span>;
  <span class="hljs-comment">// 切换时清空状态，避免数据混淆</span>
  <span class="hljs-keyword">if</span> (showUploadArea.<span class="hljs-property">value</span>) {
    inputText.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
  } <span class="hljs-keyword">else</span> {
    selectedImages.<span class="hljs-property">value</span> = [];
  }
};
</code></pre>
<p><strong>第二步：构建动态 UI</strong></p>
<p>利用 Vue 的 <code>v-if/v-show</code> 指令处理复杂的显示逻辑：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;!-- 模式切换按钮 --&gt;
  &lt;view class="flex justify-between items-center"&gt;
    &lt;text&gt;{{ showUploadArea ? '与Ta的聊天截图：' : 'Ta说：' }}&lt;/text&gt;
    &lt;view @click="toggleInputMode"&gt;
      &lt;text&gt;{{ showUploadArea ? '切换文字' : '切换图片' }}&lt;/text&gt;
    &lt;/view&gt;
  &lt;/view&gt;

  &lt;!-- 上传区域 (图片模式) --&gt;
  &lt;view v-show="showUploadArea" class="upload-area"&gt;
    &lt;ImageGrid :images="selectedImages" @add="addImages" /&gt;
  &lt;/view&gt;

  &lt;!-- 输入框 (文字模式) --&gt;
  &lt;view v-show="!showUploadArea" class="input-wrapper"&gt;
    &lt;u-input type="textarea" v-model="inputText" :autoHeight="true" /&gt;
  &lt;/view&gt;

  &lt;!-- 清除记忆 (仅文字模式) --&gt;
  &lt;view v-if="!showUploadArea" class="clear-memory-btn" @click="handleClearMemory"&gt;
    &lt;text&gt;清除记忆&lt;/text&gt;
  &lt;/view&gt;
&lt;/template&gt;
</code></pre>
<p><strong>第三步：处理业务逻辑</strong></p>
<p>生成回复时，需要根据当前模式调用不同的接口：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleGenerate</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 1. 鉴权检查</span>
  <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">await</span> <span class="hljs-title function_">checkAuth</span>())) <span class="hljs-keyword">return</span>;

  <span class="hljs-comment">// 2. 模式判断</span>
  <span class="hljs-keyword">if</span> (showUploadArea.<span class="hljs-property">value</span>) {
    <span class="hljs-comment">// 图片模式逻辑</span>
    <span class="hljs-keyword">if</span> (selectedImages.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> toast.<span class="hljs-title function_">info</span>(<span class="hljs-string">'请上传截图'</span>);
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateByImage</span>(selectedImages.<span class="hljs-property">value</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 文字模式逻辑</span>
    <span class="hljs-keyword">if</span> (!inputText.<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>()) <span class="hljs-keyword">return</span> toast.<span class="hljs-title function_">info</span>(<span class="hljs-string">'请输入内容'</span>);
    <span class="hljs-comment">// 调用带记忆的接口</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateByText</span>({
      <span class="hljs-attr">text</span>: inputText.<span class="hljs-property">value</span>,
      <span class="hljs-attr">sessionId</span>: chatSessionStore.<span class="hljs-property">sessionId</span>,
    });
  }
};
</code></pre>
<h3 data-id="heading-31">9.3 真实代码片段</h3>
<p>最终生成的代码不仅逻辑清晰，还处理了很多细节，比如 iOS 的样式适配：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 适配 iOS 的输入框样式</span>
<span class="hljs-keyword">const</span> inputCustomStyle = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> isIOS = systemInfo?.<span class="hljs-property">platform</span> === <span class="hljs-string">'ios'</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">padding</span>: isIOS ? <span class="hljs-string">'12rpx'</span> : <span class="hljs-string">'20rpx'</span>,
    <span class="hljs-attr">minHeight</span>: <span class="hljs-string">'240rpx'</span>,
    <span class="hljs-attr">borderRadius</span>: <span class="hljs-string">'12px'</span>,
  };
});
</code></pre>
<p>这就是 AI 辅助开发的威力：<strong>它不仅能写出跑通的代码，还能考虑到平台差异和边界情况。</strong></p>
<h3 data-id="heading-32">9.3 运行测试</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 微信小程序</span>
pnpm --filter unibest-mp dev:mp

<span class="hljs-comment"># H5</span>
pnpm --filter unibest-mp dev:h5

<span class="hljs-comment"># App</span>
pnpm --filter unibest-mp dev:app
</code></pre>
<h2 data-id="heading-33">十、总结与下一步</h2>
<h3 data-id="heading-34">10.1 本篇完成的工作</h3>
<p>通过 AI 辅助，我们在 <strong>不到 1 小时</strong> 内完成了：</p>

















































<table><thead><tr><th>任务</th><th>完成情况</th></tr></thead><tbody><tr><td>✅ Monorepo 项目结构</td><td>标准的 pnpm + Turborepo 架构</td></tr><tr><td>✅ Vite 配置</td><td>完整的插件链和优化配置</td></tr><tr><td>✅ TypeScript 配置</td><td>严格模式，完整类型支持</td></tr><tr><td>✅ UnoCSS 集成</td><td>原子化 CSS，主题定制</td></tr><tr><td>✅ UView Pro 集成</td><td>组件库完整接入</td></tr><tr><td>✅ 自动导入配置</td><td>Vue API、uni-app API、Hooks</td></tr><tr><td>✅ 路由系统</td><td>自动生成，分包优化</td></tr><tr><td>✅ 环境变量</td><td>多环境、多项目支持</td></tr><tr><td>✅ 代码规范</td><td>ESLint + Prettier</td></tr><tr><td>✅ 首页开发</td><td>完整的页面实现</td></tr></tbody></table>
<h3 data-id="heading-35">10.2 核心提示词模板</h3>
<p><strong>项目初始化</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">创建 [框架] + [技术栈] 项目，
包含 [目录结构]，
配置 [构建工具]
</code></pre>
<p><strong>配置文件生成</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">配置 [工具名称]，需要：
1. [功能点 1]
2. [功能点 2]
3. [功能点 3]
</code></pre>
<p><strong>页面生成</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">创建 [页面名称]，包括：
- [功能描述]
使用 [UI 框架] 和 [样式方案]
</code></pre>
<h3 data-id="heading-36">10.4 下一篇预告</h3>
<p><strong>《【AI 编程实战】第 3 篇：AI 辅助后端开发 - Next.js 15 API 快速搭建》</strong></p>
<p>我们将学习：</p>
<ul>
<li>Next.js 15 App Router 架构</li>
<li>Prisma ORM 数据库操作</li>
<li>RESTful API 设计</li>
<li>JWT 认证中间件</li>
<li>前后端类型共享</li>
</ul>
<p><strong>关注我，不错过每一篇实战干货！</strong></p>
<hr/>
<blockquote>
<p>如果这篇文章对你有帮助，请点赞、收藏、转发，让更多人了解 AI 编程的强大！</p>
<p>有任何问题，欢迎在评论区留言，我们一起讨论。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[歼20居然是个框架-基于 Signals 信号的前端框架设计]]></title>    <link>https://juejin.cn/post/7581348660824768512</link>    <guid>https://juejin.cn/post/7581348660824768512</guid>    <pubDate>2025-12-09T01:31:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581348660824768512" data-draft-id="7581251003330134042" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="歼20居然是个框架-基于 Signals 信号的前端框架设计"/> <meta itemprop="keywords" content="JavaScript,前端框架,前端"/> <meta itemprop="datePublished" content="2025-12-09T01:31:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="anuoua"/> <meta itemprop="url" content="https://juejin.cn/user/4415237335295933"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            歼20居然是个框架-基于 Signals 信号的前端框架设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4415237335295933/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    anuoua
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T01:31:50.000Z" title="Tue Dec 09 2025 01:31:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b4af4852d384ab9a20ff89eab34a12b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYW51b3Vh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765848710&amp;x-signature=Tp85S3N8CYamDjPP%2FfiOVBGeq%2FE%3D" alt="logo" loading="lazy"/></p>
<p>大家好，我是 anuoua，今天我们来讲讲基于 Signal 如何构建一个前端框架。</p>
<p>以 Vue 为响应式前端框架的代表，以 React 则是非响应式前端框架的代表，算是目前前端框架的稳定格局。</p>
<p>响应式的优点不言而喻，是高性能前端框架的选择。</p>
<p>而响应式也有不同的设计理念，区别于 Vue 的 reactivity，preact 的作者提出了 Signal 这种响应式的理念，和深度劫持的 reactivity 不同，Signal 更简单直观，其理念传播广泛，目前 Signal 作为 js 语言特性被提出成为 proposal。</p>
<h2 data-id="heading-0">响应式前端框架的现状</h2>
<p>目前一些具有代表性的前端框架，基本都走向了响应式 API + 真实 DOM，例如：svelte、solid、vue，这几个前端框架在性能上有了大幅提升，但是仍然存在一些问题。</p>
<h3 data-id="heading-1">Vue 3</h3>
<p>Vue 作为响应式框架的开创者，Vue3 仍然是虚拟 DOM，而 Vue 3 vapor 转向真实 DOM。Vue 3 版本中遇到最严重的问题是<strong>自动解包</strong>、**解构以及类型，**为了解决这些问题作者试验过很多语法，最终在数个的迭代后，还是上了编译手段，在SFC中使用宏用来解决开发体验以及 Typescript 类型问题。</p>
<pre><code class="hljs language-markup" lang="markup">&lt;script setup&gt;
const props = defineProps({
  foo: String
})
&lt;/script&gt;
</code></pre>
<p>除此之外，Vue 的问题就在于官方没有引导用户到理想的开发模式上去，<strong>组件写法太多</strong>，导致社区力量分散，发力不在一处。如果统一使用 SFC 开发，统一使用 composition api，那么社区就不会陷入使用 jsx 还是 SFC，使用 options 还是 composition api 的纠结，那么社区的生态会好很多。</p>
<h3 data-id="heading-2">Svelte</h3>
<p>Svelte 借助编译手段将视图转换成真实DOM实现，在 Svelte 5 中转向了和 Vue 类似的深度劫持的响应式API。它设计了一种叫 runes 的概念，通过编译技术追踪由特殊函数名创建的变量，将其编译成响应式代码，基本解决了类似 Vue 的困扰，无需手动解包，开发体验不错。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> message = $state(<span class="hljs-string">'hello'</span>);
</code></pre>
<p>我认为 Svelte 的 runes 已经很接近完美了，开发体验很不错。</p>
<p>但 Svelte 本身仍然有以下几点问题：</p>
<p><strong>第一</strong>：它有自己的 DSL <code>.svelte</code>，我认为 JSX 更佳，Typescript 对 JSX 的支持非常好，DSL 支持 TS 总是需要付出更多的代价，而且需要支付更多的学习成本。</p>
<p><strong>第二</strong>：它的响应式仍然是和 Vue 一样的默认深度劫持，如果是复杂嵌套对象，劫持内部对象会被包装带来会有隐晦的debug负担和理解成本。我认为 Signal 信号的浅劫持理念更加简单和直观。</p>
<p><strong>第三</strong>：runes 还不够完美，若在大型应用中使用其创建的变量，会导致和普通变量混淆，编译器可以追踪变量，但是在多文件代码复杂组合的时候，很难区分是普通变量还是响应式变量，给debug带来困难。</p>
<h3 data-id="heading-3">Solid</h3>
<p>Solidjs，它则是视图部分采取编译手段，API部分保持原生，让用户裸使用原生 Signal API，Solidjs 的 API 是符合 Signal 理念的，没有深度劫持。但是原生的 Signal API 看起来使用较为繁琐。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createSignal } <span class="hljs-keyword">from</span> <span class="hljs-string">"solid-js"</span>;
<span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">createSignal</span>(<span class="hljs-number">0</span>);
</code></pre>
<p>Solid 性能不错，JSX + TS 的开发体验基本拉满，唯一的问题是裸 Signal API 的使用不够优雅，略显繁琐。</p>
<p>例如它也不能直接解构 props，需要借助帮助函数才能维持响应性。</p>
<h3 data-id="heading-4">通病</h3>
<p>它们在支持 Web Component 这点上，都没有做好无缝的开发体验，有额外的使用成本。</p>
<h3 data-id="heading-5">总结</h3>
<p>以上三个框架都抛弃了虚拟DOM，配合响应式API，性能表现都非常好，但它们都或多或少都有令人在意的问题，很难找到理想中的前端框架。</p>

































<table><thead><tr><th>框架</th><th>真实 DOM</th><th>Signal</th><th>JSX</th><th>Signal API 编译</th></tr></thead><tbody><tr><td>Vue</td><td>支持（Vapor Mode）</td><td>兼容（shallowRef）</td><td>兼容</td><td>混合</td></tr><tr><td>Svelte</td><td>支持</td><td>不支持</td><td>不支持</td><td>支持</td></tr><tr><td>Solid</td><td>支持</td><td>支持</td><td>支持</td><td>不支持</td></tr></tbody></table>
<h2 data-id="heading-6">理想的前端框架</h2>
<p>如果我们需要一个新的前端框架，那么应该怎么设计？</p>
<p>根据上述总结，我认为 <strong>真实 DOM +</strong> <strong>JSX + Signal API 编译策略 + Web Component 一等支持</strong> 才是最接近完美的方案。</p>
<p>而 Solid 已经接近我们想要的了，给它加上剩下两个特性基本上就满足我们需要了。</p>
<p>所以怎么实现一个“完美”的框架呢？</p>
<h2 data-id="heading-7">从细粒度绑定到组件</h2>
<p>signal 如何细粒度绑定 DOM 更新呢？又是怎么从基本的绑定演化为框架组件呢？</p>
<p>我们先从 Signal 的用法说起。</p>
<h3 data-id="heading-8">Signal 的基本用方法</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 声明信号</span>
<span class="hljs-keyword">const</span> name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">"hello"</span>);
<span class="hljs-comment">// 派生信号</span>
<span class="hljs-keyword">const</span> displayName = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> name.<span class="hljs-property">value</span> + <span class="hljs-string">" world"</span>);
<span class="hljs-comment">// 副作用绑定</span>
<span class="hljs-title function_">effect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 当 name.value = "hello2";</span>
  <span class="hljs-comment">// console =&gt; 1. "hello world" 2. "hello2 world"</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(displayName);
});
</code></pre>
<h3 data-id="heading-9">绑定DOM元素</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 声明信号</span>
<span class="hljs-keyword">const</span> name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">"hello"</span>);
<span class="hljs-comment">// 派生信号</span>
<span class="hljs-keyword">const</span> displayName = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> name.<span class="hljs-property">value</span> + <span class="hljs-string">" world"</span>);

<span class="hljs-keyword">const</span> text = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">""</span>);

<span class="hljs-comment">// 副作用绑定</span>
<span class="hljs-title function_">effect</span>(<span class="hljs-function">() =&gt;</span> {
  text.<span class="hljs-property">nodeValue</span>= displayName.<span class="hljs-property">value</span>;
});
</code></pre>
<h3 data-id="heading-10">演化成组件</h3>
<p>一个只有 text 节点的组件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">"hello"</span>);
  <span class="hljs-keyword">const</span> displayName = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> name.<span class="hljs-property">value</span> + <span class="hljs-string">" world"</span>);
  <span class="hljs-keyword">return</span> (<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> text = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">""</span>);
    <span class="hljs-title function_">effect</span>(<span class="hljs-function">() =&gt;</span> {
      text.<span class="hljs-property">nodeValue</span>= displayName.<span class="hljs-property">value</span>;
    });
    <span class="hljs-keyword">return</span> text;
  })();
}
</code></pre>
<h3 data-id="heading-11">更复杂的组件</h3>
<p>在 div 中添加 text 节点：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">"hello"</span>);
  <span class="hljs-keyword">const</span> displayName = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> name.<span class="hljs-property">value</span> + <span class="hljs-string">" world"</span>);
  <span class="hljs-keyword">return</span> (<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> el1 = (<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> text = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">""</span>);
      <span class="hljs-title function_">effect</span>(<span class="hljs-function">() =&gt;</span> {
        text.<span class="hljs-property">nodeValue</span>= displayName.<span class="hljs-property">value</span>;
      });
      <span class="hljs-keyword">return</span> text;
    })();
    <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"div"</span>);
    div.<span class="hljs-title function_">append</span>(el1);
    <span class="hljs-keyword">return</span> div;
  })();
}
</code></pre>
<h3 data-id="heading-12">演化成 JSX</h3>
<p>Solid 的编译策略和上述是类似的，视图的编译是有规律的，创建 - 绑定 - 挂载，只要是有规律的，那就可以通过 DSL 来描述，JSX 正好可以表达这个过程。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">"hello"</span>);
  <span class="hljs-keyword">const</span> displayName = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> name.<span class="hljs-property">value</span> + <span class="hljs-string">" world"</span>);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{displayName.value}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>可以看到复杂的视图创建流程通过 DSL 的使用配合编译手段，开发体验可以大幅提升。</p>
<p>同时需要指出 Solid 的编译方式未必是最好的，编译后的代码量挺大，还有各种闭包嵌套，可以稍微改进一下，编译成：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { jsx, template } <span class="hljs-keyword">from</span> <span class="hljs-string">"some/jsx-runtime"</span>

<span class="hljs-keyword">const</span> temp1 = <span class="hljs-title function_">template</span>(<span class="hljs-string">"&lt;div&gt;"</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">"hello"</span>);
  <span class="hljs-keyword">const</span> displayName = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> name.<span class="hljs-property">value</span> + <span class="hljs-string">" world"</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">jsx</span>(<span class="hljs-title function_">temp1</span>(), {
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">children</span>() {
      <span class="hljs-keyword">return</span> displayName.<span class="hljs-property">value</span>;
    }
  });
}
</code></pre>
<p>Solid 把一部分 DOM 操作过程也编译出来了，事实上创建真实 DOM 的过程很大一部分是通用的，我们把创建元素的方法抽出来 <code>jsx</code>，用于创建和组装元素，这样编译出来的代码也会相对直观。</p>
<p>同时需要注意到 template 方法，它做了一件事，内部使用 cloneNode 去创建静态节点，这样可以提升性能。</p>
<h3 data-id="heading-13">总结</h3>
<p>这套编译策略，从演化中总结编译策略，然后完成 JSX AST 转换实现，确实是有创新思维和难度的，属于框架的创新点核心。</p>
<p>最先搞视图转真实 DOM 编译的是 Svelte，而 Solid 完成了更高效的实现，又最终促进了 Svelte 5 的诞生，使 Web 框架在性能得到了上大幅升级。</p>
<h2 data-id="heading-14">完整的框架要考虑的更多</h2>
<p>只靠上面的编译策略显然是不够的，需要考虑很多细节问题。</p>
<p>组件的创建，事实上挺复杂的，组件是有实例的，初始化实例的过程中需要做很多工作。</p>
<p>比如：利用插桩来定位组件组件的边界，假设组件直接返回 <code>&lt;&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;2&lt;/span&gt;&lt;/&gt;</code> ，如果没有插桩框架将无法识别边界，在做列表 diff 的时候，组件内元素集合的移除、添加、移动等操作将错乱。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> fragment = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createDocumentFragment</span>();
  <span class="hljs-keyword">const</span> instance = {
    <span class="hljs-attr">range</span>: [
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">""</span>),
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">""</span>),
    ]
  }
  <span class="hljs-keyword">const</span> span1 = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"span"</span>);
  <span class="hljs-keyword">const</span> span2 = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"span"</span>);
  fragment.<span class="hljs-title function_">append</span>(instance.<span class="hljs-property">range</span>[<span class="hljs-number">0</span>]);
  fragment.<span class="hljs-title function_">append</span>(span1);
  fragment.<span class="hljs-title function_">append</span>(span2);
  fragment.<span class="hljs-title function_">append</span>(instance.<span class="hljs-property">range</span>[<span class="hljs-number">1</span>]);
  <span class="hljs-keyword">return</span> fragment;
}
</code></pre>
<h2 data-id="heading-15"><strong>界面突变和 diff 算法</strong></h2>
<p>和 React 和 Vue 一样，这类编译型的前端框架仍然有 diff 过程。</p>
<p>界面突变的根本逻辑就是<strong>列表渲染</strong>，而列表渲染一定会涉及 diff，而 Vue 高效的 diff 算法也是可以使用的，算法和实现分离，不同的框架有不同的实现。</p>
<h3 data-id="heading-16"><strong>为什么说界面突变的根本逻辑是列表渲染？</strong></h3>
<p>条件渲染本质也是列表渲染，我们来看一个三目逻辑 ：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">List</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [toggle, setToggle] = <span class="hljs-number">0</span>;
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setToggle</span>((toggle[<span class="hljs-number">0</span>] + <span class="hljs-number">1</span>) % <span class="hljs-number">2</span>);
  });
  
  <span class="hljs-keyword">return</span> [toggle].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> (<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Fragment</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span>&gt;</span>{i}<span class="hljs-tag">&lt;/<span class="hljs-name">Fragment</span>&gt;</span></span>))
}
</code></pre>
<p>实际上就是列表 <code>[0]</code> 和 <code>[1]</code> 之间相互切换。</p>
<p>Switch Case 逻辑也类似：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">List</span> = (<span class="hljs-params">{ value }</span>) =&gt; {
  <span class="hljs-keyword">const</span> [list, setList] = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>];
  
  <span class="hljs-keyword">const</span> deriveList = list.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> i === value).<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
  
  <span class="hljs-keyword">return</span> [deriveList].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> (<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Fragment</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span>&gt;</span>{i}<span class="hljs-tag">&lt;/<span class="hljs-name">Fragment</span>&gt;</span></span>));
}
</code></pre>
<p>根据 value 的值过滤列表，即可以实现 Switch Case 逻辑。</p>
<h3 data-id="heading-17"><strong>虚拟 DOM 和 真实 DOM 的 diff 实现差异</strong></h3>
<p>虚拟 DOM 的 diff 是从的组件节点（Vue）或者根节点（React）开始，遍历一遍，抽离出 DOM 指令以更新视图。</p>
<p>但是真实 DOM 的框架，列表是细粒度绑定的，当列表变化后，更新视图是在副作用内执行的，所以它需要一个特定的组件或者函数来封装这个副作用的逻辑，在 Solid 中就是 <code>&lt;For&gt;</code> 组件， Vue Vapor 和 Svelte 是在编译的时候编译成了一个特定的函数。</p>
<p>svelte:</p>
<pre><code class="hljs language-html" lang="html">$.each(node, 16, () =&gt; expression, $.index, ($$anchor, name, index, $$array) =&gt; {
    $.next();
    var text_2 = $.text('...');
    $.append($$anchor, text_2);
});
</code></pre>
<p>diff 算法可以借鉴，但是虚拟 DOM 和 真实 DOM 框架在 diff 算法中进行的操作并不一样，理论上 Solid 也可以用 Vue 3 的算法。</p>
<h2 data-id="heading-18">开发体验升级</h2>
<p>上面指出 Solid 体验已经很好的，但是仍有不足，裸 Signal API 的使用不够优雅，getter setter 满屏幕跑，Vue Svelte 为了解决体验问题都通过对应的编译策略来解决这个问题，而 Solid 没有，有点遗憾。</p>
<p>事实上开发体验这块，React 除了需要手动管理依赖这块过于逆天之外，它的开发体验真的不错。</p>
<p>React 的组件状态写法已经很简洁了，不用像 Vue，Solid 那样套 computed。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [name, setName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">""</span>);
  
  <span class="hljs-keyword">const</span> displayName = <span class="hljs-string">"Info: "</span> + name
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setName(name + "world")}&gt;{displayName}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<p>也就是说，如果我们能改进 Solid，给它加上一组编译手段，改进 Signal 的使用体验，是不是会提升开发体验呢？</p>
<p>让我们尝试推演一下。</p>
<h2 data-id="heading-19">理想的组件形态</h2>
<p>我们先提出一个理想中的组件形态，要求足够简洁，开发体验足够好：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">let</span> name = <span class="hljs-string">"hello"</span>;
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> {name = name + "world"}}&gt;{name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>我们希望改变 name  的时候，视图就会更新，但是这样是做不到的，改变一个变量没有任何作用。</p>
<p>但是如果是信号就不一样了：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">""</span>);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> name.value = name.value + "xxx"}&gt;{name.value}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>我们根据上文所说的 JSX 编译手段，创建元素可以绑定副作用，<code>name.value</code>是可以被副作用收集到，并在name.value 更新的时候顺便更新视图。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { jsx, template } <span class="hljs-keyword">from</span> <span class="hljs-string">"some/jsx-runtime"</span>

<span class="hljs-keyword">const</span> temp1 = <span class="hljs-title function_">template</span>(<span class="hljs-string">"&lt;div&gt;"</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">""</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">jsx</span>(<span class="hljs-title function_">temp1</span>(), {
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">onClick</span>() {
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
        name.<span class="hljs-property">value</span> = name.<span class="hljs-property">value</span> + <span class="hljs-string">"xxx"</span>;
      }
    },
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">children</span>() {
      <span class="hljs-keyword">return</span> name.<span class="hljs-property">value</span>;
    }
  });
}
</code></pre>
<p>这时候就需要编译来完成我们的代码转换，在这里我们把<strong>信号变量使用</strong> <code>**$**</code> <strong>标记</strong>。然后就代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">let</span> $name = <span class="hljs-string">"hello"</span>;
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> {$name = $name + "world"}}&gt;{$name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>这个代码和我们理想中的组件代码非常接近了，要是真的能这样写代码，那么开发体验就能得到大幅提升。</p>
<h2 data-id="heading-20"><strong>Signal 信号编译策略</strong></h2>
<p>前面提到使用 $ 标记信号，就是一种创新的编译策略，通过<strong>特殊命名标记变量</strong>，将变量编译成响应式信号代码。</p>
<h3 data-id="heading-21">编译策略说明</h3>
<blockquote>
<p>这里我们按照 preact/signals 库的 api 做示例。</p>
</blockquote>
<h3 data-id="heading-22">编译策略一：let 搭配 $ 开头的变量，即为声明信号。</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> $name = <span class="hljs-string">"hello"</span>
<span class="hljs-comment">// 编译成</span>
<span class="hljs-keyword">import</span> { signal } <span class="hljs-keyword">from</span> <span class="hljs-string">"@preact/signal"</span>;
<span class="hljs-keyword">let</span> $name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">"hello"</span>);
</code></pre>
<h3 data-id="heading-23">编译策略二：读取 $ 开头的变量会默认解包</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> $name = <span class="hljs-string">"hello"</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>($name);
<span class="hljs-comment">// 编译成</span>
<span class="hljs-keyword">let</span> $name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">"hello"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>($name.<span class="hljs-property">value</span>);
</code></pre>
<h3 data-id="heading-24">编译策略三：const 搭配 $ 开头的变量，为声明派生信号。</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> $name = <span class="hljs-string">"hello"</span>;
<span class="hljs-keyword">const</span> $display = $name + <span class="hljs-string">"world"</span>;
<span class="hljs-comment">// 编译成</span>
<span class="hljs-keyword">import</span> { signal, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">"@preact/signal"</span>;
<span class="hljs-keyword">let</span> $name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">"hello"</span>);
<span class="hljs-keyword">const</span> $display = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> $name.<span class="hljs-property">value</span> + <span class="hljs-string">"world"</span>);
</code></pre>
<h3 data-id="heading-25">编译策略四：$use 开头的为自定义 hooks 。</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">$useName</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">let</span> $name = <span class="hljs-string">"hello"</span>;
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: $name
  }
}

<span class="hljs-comment">// 编译成</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">$useName</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">let</span> $name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">"hello"</span>);
  
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">name</span>: $name.<span class="hljs-property">value</span>
  }))
}
</code></pre>
<h3 data-id="heading-26">编译策略五：解构 + 变量传递。</h3>
<p>函数入参，入参的响应传递，解构变量需要设置<code>$</code>前缀</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params">{ name: $name, ...$rest }</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>($rest);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{$name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}

<span class="hljs-comment">// 编译为</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params">$__0</span>) =&gt; {
  <span class="hljs-keyword">const</span> $name = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> $__0.<span class="hljs-property">value</span>.<span class="hljs-property">name</span>);
  <span class="hljs-keyword">const</span> $rest = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> { name, ...rest } = $__0.<span class="hljs-property">value</span>;
    <span class="hljs-keyword">return</span> rest;
  });
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>($rest.<span class="hljs-property">value</span>);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{$name.value}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<p>自定义 hook 返回，解构的时候为了不丢失响应，同样也要解构变量设置<code>$</code>前缀，这样就能触发编译。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">$useName</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">let</span> $name = <span class="hljs-string">"hello"</span>;
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: $name
  }
}

<span class="hljs-comment">// 解构后的变量也必须是 $ 开头，否则丢失响应，退化为普通变量（原始信号对象，可手动.value使用）</span>
<span class="hljs-keyword">const</span> { <span class="hljs-attr">name</span>: $name } = $useName();
<span class="hljs-comment">// 自定义 hook 返回赋值的变量也必须是 $ 开头，否则丢失响应，退化为普通变量（原始信号对象，可手动.value使用）</span>
<span class="hljs-keyword">const</span> $nameSignal = $useName();

<span class="hljs-comment">// 编译成</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">$useName</span>= (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">let</span> $name = <span class="hljs-title function_">signal</span>(<span class="hljs-string">"hello"</span>);
  
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">name</span>: $name.<span class="hljs-property">value</span>
  }))
}

<span class="hljs-keyword">const</span> $__0 = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> $useName().<span class="hljs-property">value</span>);
<span class="hljs-keyword">const</span> $name = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> $__0.<span class="hljs-property">value</span>.<span class="hljs-property">name</span>);
<span class="hljs-keyword">const</span> $nameSignal = $useName();
</code></pre>
<h3 data-id="heading-27">此编译策略的优点</h3>
<ol>
<li>无需手动导入 API，像普通变量一样使用 Signal</li>
<li>和 TS 类型的结合非常好，特别和 JSX 的类型结合非常完美</li>
<li>不怕解构</li>
<li>标记变量和常规变量一起用不会有混淆</li>
</ol>
<h2 data-id="heading-28">一个简单的鼠标位置hook</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">$usePosition</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">let</span> $x = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">let</span> $y = <span class="hljs-number">0</span>;
  
  <span class="hljs-keyword">const</span> $pos = {
    <span class="hljs-attr">x</span>: $x,
    <span class="hljs-attr">y</span>: $y
  };
  
  <span class="hljs-title function_">mounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      $x = e.<span class="hljs-property">pageX</span>;
      $y = e.<span class="hljs-property">pageY</span>;
    });
  })
  
  <span class="hljs-keyword">return</span> {
    $pos,
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> { $pos } = $usePosition();
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>x: {$pos.x}; y:{$pos.y}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<p>是不是清爽很多，简单应用的代码量差距不是很明显，但是如果代码量增加，那么代码量的差距还是非常可观的。</p>
<p>同时这样的设计，甚至不需要手动导入 API ，它在编译期间自动导入，让人无需关心 Signal 本身，真正做到了无感，开发体验得到了提升。</p>
<h2 data-id="heading-29">Web Component 支持</h2>
<p>Vue Solid Svelte 都支持封装 Web Component，但是在开发体验上并没有多好，需要额外操作才能集成到框架中使用，做不到在框架内无缝使用，这样也限制了 Web Component 的推广和使用。</p>
<p>所以我们希望框架能够做好以下几点来支持 Web Component：</p>
<ul>
<li>和框架本身可以无缝集成，像普通组件一样方便使用</li>
<li>组件 TS 类型易用且完善</li>
<li>可以按照常规 Web Component 一样可以独立使用</li>
<li>可以供给原生 HTML 或者其他框架使用</li>
</ul>
<h2 data-id="heading-30">有这样的框架吗？</h2>
<p>有啊 J20 框架 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanuoua%2Fj20" target="_blank" title="https://github.com/anuoua/j20" ref="nofollow noopener noreferrer">J20</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b4af4852d384ab9a20ff89eab34a12b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYW51b3Vh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765848710&amp;x-signature=Tp85S3N8CYamDjPP%2FfiOVBGeq%2FE%3D" alt="logo" loading="lazy"/></p>
<p>点个 Star 吧。</p>
<h2 data-id="heading-31">说在最后</h2>
<p>这大概是我最后一个前端框架了，也算是完成了之前对前端框架的想法（中间隔了很久才想起来还有个东西没完成）。</p>
<p>歼20框架大量代码都是AI写的，我负责设计，它负责实现，同时帮我写测试，速度大幅提升。</p>
<p>AI 时代，也许框架不再重要了吧。哈哈</p>
<p>谢谢大家！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[分享下我创业烧了 几十万的 AI Coding 经验]]></title>    <link>https://juejin.cn/post/7581545175509434420</link>    <guid>https://juejin.cn/post/7581545175509434420</guid>    <pubDate>2025-12-09T07:39:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581545175509434420" data-draft-id="7581477397507948578" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="分享下我创业烧了 几十万的 AI Coding 经验"/> <meta itemprop="keywords" content="前端,JavaScript,后端"/> <meta itemprop="datePublished" content="2025-12-09T07:39:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金泥石流"/> <meta itemprop="url" content="https://juejin.cn/user/3421335914034983"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            分享下我创业烧了 几十万的 AI Coding 经验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3421335914034983/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金泥石流
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T07:39:38.000Z" title="Tue Dec 09 2025 07:39:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    204
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>差不多 1 年没写了，这两年一直忙着创业，抽个空给大家聊聊，扯扯闲天。</p>
<p>我思来想去能写的东西其实很多，比如</p>
<ul>
<li>一个前端老鸟是如何开始创业不归路的</li>
<li>搞技术的创业要注意哪些是</li>
<li>创业上班有啥不同</li>
<li>怎么融资，投资人都是什么路子</li>
<li>创业 2 年都踩过什么坑</li>
<li>如何找客户</li>
<li>如何做产品</li>
<li>AI 来了改变了什么</li>
</ul>
<p>不过我想了想，掘金毕竟是个开发者社区，还是先聊聊大家比较容易理解的技术侧的内容</p>
<p>首先是给个结论 <strong>传统软件开发基本要嘎了</strong></p>
<p>别的公司不知道，但是我们确实做到了在没有产品，测试，UI，前端，后端传统分工的情况下，完全通过 AI Coding 开发产品，上线，拿钱，交付，增长，迭代。</p>
<p>就是如果你还纠结 AI 原生组织，去掉所有岗位分工角色，只用 AI Coding 到底能不能代替传统软件开发模式，能不能上生产，能不能做出真的产品，那么我直接告诉你</p>
<p><strong>完全可以</strong> 前提是从 0 开始，丢掉所有的历史包袱，所以创业公司可以这么干。</p>
<p>下面的内容分享给那些用过，没用过，想用 AI Coding 组织或者同学们，这一篇我就只聊我的经验，后面有时间我再展开说。</p>
<h2 data-id="heading-0">AI Coding 里的上下文工程怎么做</h2>
<p>如果你翻一些开发团队的公众号，可能会把上下文工程给你说的神乎其神，或者长篇大论，但是对我的理解，我从 AI 作为编码工具到 AI 成为我的同事这个漫长的过程中，我的体验是，上下文工程只解决一个问题。</p>
<p>就是解决 AI 在没有记忆的情况下如何获取最新的结果，比如你发送了个需求让 AI Coding，AI 能不能知道上一次的修改结果，能不能基于最新的代码去推理来满足你的需求。</p>
<p>那么要解决这个问题有几条路径</p>
<ul>
<li>让 AI 读写查询搜索自己去组织上下文，目前主流 AI IDE 的做法，优点是自动化程度高，缺点是慢，费钱，而且准确性和需求的复杂度成反比，需求越复杂，性能越差</li>
<li>结合 RAG 做索引，早期 Cursor 类产品的主流做法，优点是便宜，理论上下文无限，现在用 google 的 api 成本大幅下降，缺点么就是基本没啥用，尤其是推理模型出来后，代码切片就跟盲人摸象差不多，反而增加了 AI 的推理难度，AI 还得想想你这切的支离破碎的代码到底想表达啥？因为大部分的项目都是业务项目，与其说里面是代码，不如说里面就是业务的一个 know how 的表达方式。代码的耦合性是很高的基本切开就玩完。</li>
<li>手工选择 + 自动注入，这是目前我们的做法，简单粗暴，直接将整个项目的代码序列化结构化变成一个 markdown 丢过去，然后允许工程师手工选择，优点就是准确性极佳，推理速度快，生成效果好，完全能满足生成要求，缺点么就是费钱，超级费钱，基本上密集开发周期内，单日消耗可以达到数百美金，还是在手工选择加持的情况下，完全不管的话大几千美金也打不住。</li>
</ul>
<p>然后现在各家 AI Coding 产品其实做的上下文工程就是围绕怎么把所有想让 AI 知道的的东西变成文本丢进去，难点在于很多内容很难文本化，并且丢一次是不够的，如何增量的丢，低成本的丢，快速的丢，都是技术，这方面的工程复杂度完全是一个全新的问题和领域</p>
<p>要做好上下文工程，产品和技术必须合二为一，不能分工，国内很多产品体验做的不好和我们长期的分工模式有关系，现在 AI 产品的设计，角色分工反而成了最大掣肘，从就业角度看，我觉得单独的产品和工程师以后都没啥活路，最好就是变成 <strong>产品工程师</strong> AI 干活你主导设计</p>
<h2 data-id="heading-1">AI Coding  对传统软件开发方式的影响</h2>
<p>先给结论，影响是颠覆性的革命性的，和过去我们经历的低代码/无代码那一波不一样，低代码无代码还是传统开发中针对业务场景的解决方案，是一个子集，人还是那些人，最后又加了一批脚本工程师。</p>
<p>但是 AI Coding 是掀桌子了，今天如果所有的公司是 AI 原生，AI Coding 的那么除了一批架构，转型快的还有活干，90% 的岗位都不存在了，没有任何独立的分工，垂直的工作给你，你想当螺丝钉，AI 比你更适合拧螺丝。</p>
<p>最大的影响是分工没了，AI 的知识结构和基于算力的特点，从资本效率上完全是碾压人类的，AI 欠缺的部分还需要人去补足，但是这个补他不需要一个团队，只需要一个人就够了，这意味着分工的消失。</p>
<p>基于 AI 的研发团队，结构是高度扁平，实现了我们最理想的模式，就是工程师流动的自由性，不像过去你的工作是被绑死在一个项目和代码上的。但是要做到这一点，就必须放手让 AI 去写代码。</p>
<p>必须是 100% 让 AI 写，任何混合式写法最后的结果就是，AI 和 人的能力都发挥不出来，今天还想着给团里的人配个 AI 提升效率的，我就直接告诉你们，短期有效，长期无效，还不如保持原来的传统模式，把 AI 就当成一次性工具，和低代码无代码一样解决一些业务场景的问题，AI 只是更智能而已，但是低代码/无代码解决不了的 AI 一样解决不了，不用指望大力出奇迹，人效飞上天，如果你们老板有这种想法，让他来找我，我免费给他上课，告诉他“别做梦！”。</p>
<p>总结下，影响是多方面的，一个是团队的分工，要想最大化收益，就是全干掉，变成一个工程师 + AI 的模式，其次是协同方式，必须数字化，平台化，依赖 IDE 你效率跑不起来。对 AI 来说，IDE的上下文很不完整，如果要自研一套基于 AI 的效率平台，最好的办法就是从 AI 出发为 AI 打造。</p>
<p>先写这些，1 年没写了，水两句让免得掘金把我给忘了😄</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter TolyUI 框架#11 | 标签 tolyui_tag]]></title>    <link>https://juejin.cn/post/7581385235964870690</link>    <guid>https://juejin.cn/post/7581385235964870690</guid>    <pubDate>2025-12-09T01:30:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581385235964870690" data-draft-id="7581386627676209192" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter TolyUI 框架#11 | 标签 tolyui_tag  "/> <meta itemprop="keywords" content="前端,Flutter,UI Kit"/> <meta itemprop="datePublished" content="2025-12-09T01:30:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="张风捷特烈"/> <meta itemprop="url" content="https://juejin.cn/user/149189281194766"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter TolyUI 框架#11 | 标签 tolyui_tag  
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189281194766/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    张风捷特烈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T01:30:13.000Z" title="Tue Dec 09 2025 01:30:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e1b2f7d2ec8b4ca0ac1b5feadf97637b~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=800&amp;h=450&amp;s=33895&amp;e=jpg&amp;b=031126" alt="" loading="lazy"/></p>
<h4 data-id="heading-0">《Flutter TolyUI 框架》系列前言:</h4>
<p><strong>TolyUI</strong> 是 <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">张风捷特烈</a> 打造的 Fluter 全平台应用开发 UI 框架。具备 <strong>全平台</strong>、<strong>组件化</strong>、<strong>源码开放</strong>、<strong>响应式</strong> 四大特点。可以帮助开发者迅速构建具有响应式全平台应用软件：</p>
<blockquote>
<p>开源地址： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTolyFx%2Ftoly_ui" target="_blank" title="https://github.com/TolyFx/toly_ui" ref="nofollow noopener noreferrer">github.com/TolyFx/toly…</a></p>
</blockquote>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/de8c6bed9bfe46b3865accea7d493d4c~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1563&amp;h=409&amp;s=62505&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-1">1. 标签组件的设计动机</h4>
<p>在应用开发中，标签是一种常见的界面元素，用于分类标记、状态展示、筛选条件等场景。一个好的标签组件不仅要有美观的视觉效果，更要提供灵活的交互能力。从简单的静态展示到复杂的动态管理，从单一的样式到多样的变体，标签组件承载着丰富的功能需求。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cb72f53c2632447581d12f12fa6c890f~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=980&amp;h=454&amp;s=66029&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<p>TolyUI 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Ftolyui_tag" target="_blank" title="https://pub.dev/packages/tolyui_tag" ref="nofollow noopener noreferrer">tolyui_tag</a> 模块正是为此而设计。它不仅提供了基础的标签展示能力，还支持可关闭、可选择、动态添加等高级功能。通过合理的 API 设计和灵活的配置选项，让开发者能够轻松应对各种标签使用场景。其中包含两个核心组件:</p>
<ul>
<li><strong>TolyTag</strong> 展示独立的标签，可以设置标签类型、是否可关闭等。</li>
<li><strong>TolyTagGroup</strong> 展示标签组，可以支持单选、多选等功能。</li>
</ul>
<p>使用者可以独立引入模块包，或者使用 tolyui 全家桶：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 仅使用 tolyui_tag</span>
<span class="hljs-attr">dependencies:</span> 
   <span class="hljs-attr">tolyui_tag:</span> <span class="hljs-string">^last_version</span>

<span class="hljs-comment"># 使用 tolyui 全家桶 </span>
<span class="hljs-attr">dependencies:</span> 
    <span class="hljs-attr">tolyui:</span> <span class="hljs-string">^last_version</span>
</code></pre>
<p>下面来介绍相关组件的具体用法。</p>
<hr/>
<h4 data-id="heading-2">2. 基础标签展示</h4>
<p>最基本的用法是使用 Tag 组件展示静态标签。组件支持不同的颜色和变体样式，通过简单的配置就能实现丰富的视觉效果。</p>
<p>第一行展示了不同颜色的标签效果，通过 <code>color</code> 属性可以快速设置标签的主题色。第二行展示了四种变体样式：填充、边框、实心、虚线。每种样式都有其独特的视觉特征，适用于不同的使用场景。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2532493a16f44e80af150d155aecef49~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=721&amp;h=179&amp;s=14817&amp;e=png&amp;b=fefefe" alt="" loading="lazy"/></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 不同颜色的标签</span>
TolyTag(child: Text(<span class="hljs-string">'默认样式'</span>))
TolyTag(color: Colors.red, child: Text(<span class="hljs-string">'红色 red'</span>))
TolyTag(color: Colors.purple, child: Text(<span class="hljs-string">'紫色 purple'</span>))
TolyTag(color: Colors.green, child: Text(<span class="hljs-string">'绿色 green'</span>))

<span class="hljs-comment">// 不同变体的标签</span>
TolyTag(variant: TagVariant.filled, color: Colors.blue, child: Text(<span class="hljs-string">'填充 filled'</span>))
TolyTag(variant: TagVariant.outlined, color: Colors.green, child: Text(<span class="hljs-string">'边框 outlined'</span>))
TolyTag(variant: TagVariant.solid, color: Colors.orange, child: Text(<span class="hljs-string">'实心 TolyTag'</span>))
TolyTag(variant: TagVariant.dashed, color: Colors.grey, child: Text(<span class="hljs-string">'虚线 dashed'</span>))
</code></pre>
<p>通过颜色和样式的组合，可以灵活应用于分类标记、状态展示、标签管理等场景。</p>
<hr/>
<h4 data-id="heading-3">3. 可关闭标签</h4>
<p>在实际应用中，标签往往需要支持动态删除。Tag 组件通过 <code>closable</code> 属性提供了关闭功能，配合 <code>onClose</code> 回调可以实现完整的删除交互。</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9f38908045974c498fb2738111f9ee3d~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=717&amp;h=135&amp;s=9693&amp;e=png&amp;b=fefefe" alt="" loading="lazy"/></p>
<p>基于数据驱动的方式，可以轻松实现标签的动态管理。每个标签都可以独立关闭删除，点击关闭按钮后标签从列表中移除并显示提示信息。当有标签被删除时，右侧会出现重置标签，点击可恢复所有已删除的标签。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_TagDemo2State</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">TagDemo2</span>&gt; </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;TagData&gt; _initialTags = [
    TagData(label: <span class="hljs-string">'编程技术'</span>, variant: TagVariant.outlined),
    TagData(label: <span class="hljs-string">'拍摄影像'</span>, icon: Icons.camera, color: Colors.green),
    TagData(label: <span class="hljs-string">'Dart语言'</span>, icon: Icons.code, variant: TagVariant.outlined),
    TagData(label: <span class="hljs-string">'禁用状态'</span>, variant: TagVariant.filled, disabled: <span class="hljs-keyword">true</span>),
  ];

  <span class="hljs-keyword">late</span> <span class="hljs-built_in">List</span>&lt;TagData&gt; tags;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    tags = <span class="hljs-built_in">List</span>.from(_initialTags);
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Wrap(
      spacing: <span class="hljs-number">8</span>,
      runSpacing: <span class="hljs-number">8</span>,
      children: [
        ...tags.map((tag) {
          <span class="hljs-keyword">return</span> TolyTag(
            variant: tag.variant,
            closable: <span class="hljs-keyword">true</span>,
            disabled: tag.disabled,
            color: tag.color,
            icon: tag.icon != <span class="hljs-keyword">null</span> ? Icon(tag.icon, size: <span class="hljs-number">14</span>) : <span class="hljs-keyword">null</span>,
            onClose: () {
              setState(() =&gt; tags.remove(tag));
              $message.success(message: <span class="hljs-string">'已删除: <span class="hljs-subst">${tag.label}</span>'</span>);
            },
            child: Text(tag.label),
          );
        }),
        <span class="hljs-keyword">if</span> (tags.length &lt; _initialTags.length)
          GestureDetector(
            onTap: () {
              setState(() =&gt; tags = <span class="hljs-built_in">List</span>.from(_initialTags));
              $message.success(message: <span class="hljs-string">'已重置所有标签'</span>);
            },
            child: TolyTag(
              variant: TagVariant.filled,
              color: Colors.blue,
              icon: Icon(Icons.refresh, size: <span class="hljs-number">14</span>),
              child: Text(<span class="hljs-string">'重置'</span>),
            ),
          ),
      ],
    );
  }
}
</code></pre>
<p>这种数据驱动的模式让标签管理变得简单而优雅，示例包含了不同样式、颜色、图标的标签组合，以及禁用状态的展示，适用于标签管理、筛选条件、关键词编辑等需要动态增删的交互场景。</p>
<hr/>
<h4 data-id="heading-4">4. 动态添加标签</h4>
<p>除了删除，标签的动态添加也是常见需求。通过结合输入框和标签组件，可以实现完整的标签增删功能。</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4eb0daa4c33044638db62e34dfe6d771~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=623&amp;h=419&amp;s=916037&amp;e=gif&amp;f=176&amp;b=fbfbf9" alt="" loading="lazy"/></p>
<p>用户可以通过关闭按钮删除已有标签，也可以点击虚线边框的添加按钮创建新标签。点击添加后会出现输入框，输入内容并回车或失焦即可完成添加。新标签会自动去重和去除空白，确保标签列表的整洁性。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_TagDemo3State</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">TagDemo3</span>&gt; </span>{
  <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; tags = [<span class="hljs-string">'上进'</span>, <span class="hljs-string">'努力'</span>, <span class="hljs-string">'成功'</span>, <span class="hljs-string">'创新'</span>, <span class="hljs-string">'热情'</span>];
  <span class="hljs-built_in">bool</span> _isAdding = <span class="hljs-keyword">false</span>;
  <span class="hljs-keyword">final</span> TextEditingController _tagInputController = TextEditingController();
  <span class="hljs-keyword">final</span> FocusNode _tagInputFocusNode = FocusNode();

  <span class="hljs-keyword">void</span> _handleSubmitted(<span class="hljs-built_in">String</span> value) {
    setState(() {
      <span class="hljs-keyword">final</span> newTag = value.trim();
      <span class="hljs-keyword">if</span> (newTag.isNotEmpty &amp;&amp; !tags.contains(newTag)) {
        tags.add(newTag);
      }
      _isAdding = <span class="hljs-keyword">false</span>;
      _tagInputController.clear();
    });
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Wrap(
      spacing: <span class="hljs-number">8</span>,
      runSpacing: <span class="hljs-number">8</span>,
      children: [
        ...tags.map((tag) {
          <span class="hljs-keyword">return</span> TolyTag(
            closable: <span class="hljs-keyword">true</span>,
            color: Colors.blue,
            onClose: () =&gt; setState(() =&gt; tags.remove(tag)),
            child: Text(tag),
          );
        }),
        <span class="hljs-keyword">if</span> (_isAdding)
          SizedBox(
            width: <span class="hljs-number">90</span>,
            height: <span class="hljs-number">24</span>,
            child: TextField(
              controller: _tagInputController,
              focusNode: _tagInputFocusNode,
              onSubmitted: _handleSubmitted,
            ),
          )
        <span class="hljs-keyword">else</span>
          Tag(
            variant: TagVariant.dashed,
            onTap: () {
              setState(() =&gt; _isAdding = <span class="hljs-keyword">true</span>);
              _tagInputFocusNode.requestFocus();
            },
            child: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                Icon(Icons.add, size: <span class="hljs-number">14</span>),
                SizedBox(width: <span class="hljs-number">4</span>),
                Text(<span class="hljs-string">'添加标签'</span>),
              ],
            ),
          ),
      ],
    );
  }
}
</code></pre>
<p>这种交互模式常用于个人信息编辑、兴趣标签管理、技能标签设置等需要用户自定义标签内容的场景。</p>
<hr/>
<h4 data-id="heading-5">5. 可选择标签</h4>
<p>对于筛选和分类场景，标签需要支持选择功能。TolyUI 提供了 TolyTagGroup 组件，支持单选和多选两种模式。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7e73d7bc4dc04bebad27e867ed29b895~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=623&amp;h=419&amp;s=369664&amp;e=gif&amp;f=84&amp;b=fcfcfa" alt="" loading="lazy"/></p>
<p>单选模式下，点击标签会取消其他标签的选中状态，只保留当前选中项。多选模式下，可以同时选中多个标签。每个模式都实时显示当前选中的内容，提供直观的视觉反馈。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_TagDemo4State</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">TagDemo4</span>&gt; </span>{
  <span class="hljs-built_in">String?</span> selectedCategory;
  <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; selectedTags = [];

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">const</span> TextStyle style = TextStyle(fontSize: <span class="hljs-number">14</span>,fontWeight: FontWeight.bold);
    <span class="hljs-keyword">const</span> TextStyle greyStyle = TextStyle(fontSize: <span class="hljs-number">12</span>,color: Colors.grey);
    <span class="hljs-keyword">return</span> Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Wrap(
          children: [
            <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'单选模式：'</span>,style: style),
            <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">8</span>),
            Text(<span class="hljs-string">'已选择：<span class="hljs-subst">${selectedCategory ?? <span class="hljs-string">"无"</span>}</span>'</span>,style: greyStyle),
          ],
        ),
        <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">8</span>),
        TolyTagGroup&lt;<span class="hljs-built_in">String</span>&gt;(
          options: <span class="hljs-keyword">const</span> [
            TagOption(value: <span class="hljs-string">'frontend'</span>, label: Text(<span class="hljs-string">'前端'</span>)),
            TagOption(value: <span class="hljs-string">'backend'</span>, label: Text(<span class="hljs-string">'后端'</span>)),
            TagOption(value: <span class="hljs-string">'mobile'</span>, label: Text(<span class="hljs-string">'移动端'</span>)),
            TagOption(value: <span class="hljs-string">'ai'</span>, label: Text(<span class="hljs-string">'人工智能'</span>)),
          ],
          value: selectedCategory,
          onChange: (value) =&gt; setState(() =&gt; selectedCategory = value),
        ),
        <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">24</span>),
        Wrap(
          children: [
            <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'多选模式：'</span>,style: style),
            <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">8</span>),
            Text(<span class="hljs-string">'已选择：<span class="hljs-subst">${selectedTags.isEmpty ? <span class="hljs-string">"无"</span> : selectedTags.join(<span class="hljs-string">", "</span>)}</span>'</span>,style: greyStyle),

          ],
        ),

        <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">8</span>),
        TolyTagGroup&lt;<span class="hljs-built_in">String</span>&gt;(
          multiple: <span class="hljs-keyword">true</span>,
          options: <span class="hljs-keyword">const</span> [
            TagOption(value: <span class="hljs-string">'flutter'</span>, label: Text(<span class="hljs-string">'Flutter'</span>)),
            TagOption(value: <span class="hljs-string">'react'</span>, label: Text(<span class="hljs-string">'React'</span>)),
            TagOption(value: <span class="hljs-string">'vue'</span>, label: Text(<span class="hljs-string">'Vue'</span>)),
            TagOption(value: <span class="hljs-string">'angular'</span>, label: Text(<span class="hljs-string">'Angular'</span>)),
            TagOption(value: <span class="hljs-string">'nodejs'</span>, label: Text(<span class="hljs-string">'Node.js'</span>)),
          ],
          values: selectedTags,
          onChangeMultiple: (values) =&gt; setState(() =&gt; selectedTags = values),
        ),
      ],
    );
  }
}
</code></pre>
<p>示例中单选用于技术方向选择，多选用于技术栈选择。这种交互模式广泛应用于筛选器、分类选择、问卷调查、偏好设置等需要用户选择的场景。</p>
<hr/>
<h4 data-id="heading-6">6. 状态标签</h4>
<p>在系统中，标签常用于展示各种状态信息。通过不同的颜色和图标组合，可以直观地传达状态含义。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aa87719ba9114dcc8ea95de35c2873f6~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=721&amp;h=141&amp;s=9142&amp;e=png&amp;b=fffefe" alt="" loading="lazy"/></p>
<p>TolyUI 的 TolyTag 组件支持自定义图标，配合合适的颜色，可以创建出语义明确的状态标签。示例包含六种常见状态：成功、错误、警告、信息、等待中、处理中。每个状态都采用了符合直觉的颜色和图标搭配，特别是处理中状态使用了动态的加载指示器，提供更生动的视觉反馈。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">const</span> TolyTag(
  icon: Icon(Icons.check_circle, size: <span class="hljs-number">12</span>, color: Colors.green),
  color: Colors.green,
  child: Text(<span class="hljs-string">'成功'</span>),
)

<span class="hljs-keyword">const</span> TolyTag(
  icon: Icon(Icons.error, size: <span class="hljs-number">12</span>, color: Colors.red),
  color: Colors.red,
  child: Text(<span class="hljs-string">'错误'</span>),
)

<span class="hljs-keyword">const</span> TolyTag(
  icon: Icon(Icons.warning, size: <span class="hljs-number">12</span>, color: Colors.orange),
  color: Colors.orange,
  child: Text(<span class="hljs-string">'警告'</span>),
)

<span class="hljs-keyword">const</span> TolyTag(
  icon: Icon(Icons.info, size: <span class="hljs-number">12</span>, color: Colors.blue),
  color: Colors.blue,
  child: Text(<span class="hljs-string">'信息'</span>),
)

<span class="hljs-keyword">const</span> TolyTag(
  icon: Icon(Icons.schedule, size: <span class="hljs-number">12</span>, color: Colors.grey),
  color: Colors.grey,
  child: Text(<span class="hljs-string">'等待中'</span>),
)

<span class="hljs-keyword">const</span> TolyTag(
  icon: CupertinoActivityIndicator(color: Colors.purple, radius: <span class="hljs-number">6</span>),
  color: Colors.purple,
  child: Text(<span class="hljs-string">'处理中'</span>),
)
</code></pre>
<p>这种模式广泛应用于任务状态跟踪、审批流程、订单状态、系统通知等需要明确状态表达的场景。</p>
<hr/>
<h4 data-id="heading-7">尾声</h4>
<p>toly_tag 模块为 Flutter 应用提供了完整的标签展示和交互能力。从基础的静态展示到动态的增删管理，从单一的样式配置到丰富的状态表达，它都能够胜任。无论你是在构建内容管理系统，还是开发社交应用，这个组件都能帮助你创建出既美观又实用的标签界面。</p>
<p>随着 tolyui 的逐步迭代，越来越多的新功能将会支持。感谢你关注 tolyui 的成长，如果喜欢，也希望你能在 github 中点赞支持~</p>
<blockquote>
<p>github 开源地址： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTolyFx%2Ftoly_ui" target="_blank" title="https://github.com/TolyFx/toly_ui" ref="nofollow noopener noreferrer">github.com/TolyFx/toly…</a></p>
</blockquote>
<hr/>
<p>更多文章和视频知识资讯，大家可以关注我的公众号、掘金和 B 站 。让我们一起成长，变得更强。我们下次再见~</p>
<ul>
<li>QQ交流群： 1046304516</li>
<li>掘金账号： <a href="https://juejin.cn/user/149189281194766" title="https://juejin.cn/user/149189281194766" target="_blank">张风捷特烈</a></li>
<li>bilibli 账号： <a href="https://link.juejin.cn?target=https%3A%2F%2Fspace.bilibili.com%2F390457600" title="https://link.juejin.cn?target=https%3A%2F%2Fspace.bilibili.com%2F390457600" target="_blank">张风捷特烈</a></li>
<li>公众号： <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fq8Vs5i3SU-4QPoU3-0xOSg" title="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fq8Vs5i3SU-4QPoU3-0xOSg" target="_blank">编程之王</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Tiptap 编写一个富文本编辑器为什么对很多人来说很难 🤔🤔🤔]]></title>    <link>https://juejin.cn/post/7581385235964510242</link>    <guid>https://juejin.cn/post/7581385235964510242</guid>    <pubDate>2025-12-08T23:47:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581385235964510242" data-draft-id="7581385235964395554" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Tiptap 编写一个富文本编辑器为什么对很多人来说很难 🤔🤔🤔"/> <meta itemprop="keywords" content="前端,JavaScript,GitHub"/> <meta itemprop="datePublished" content="2025-12-08T23:47:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Moment"/> <meta itemprop="url" content="https://juejin.cn/user/3782764966460398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Tiptap 编写一个富文本编辑器为什么对很多人来说很难 🤔🤔🤔
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782764966460398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Moment
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T23:47:48.000Z" title="Mon Dec 08 2025 23:47:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>我正在开发 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxun082%2FDocFlow" target="_blank" title="https://github.com/xun082/DocFlow" ref="nofollow noopener noreferrer">DocFlow</a>，一个完整的 AI 全栈协同文档项目。这个项目涵盖了前端富文本编辑器（基于 Tiptap）、后端服务、AI 集成、实时协作等多个技术栈。在开发过程中，我积累了丰富的实战经验，包括 Tiptap 的深度定制、性能优化、协作功能实现等核心难点。如果你对 AI 全栈开发、Tiptap 富文本编辑器定制、或者 DocFlow 项目的完整技术方案感兴趣，想系统学习相关技术栈和最佳实践，欢迎加我微信 <code>yunmz777</code> 私聊咨询。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edf437a5ed804b62b407246cbbfd9574~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765842468&amp;x-signature=H6pEszCPtXo3pprOvi6u4Ur2YwQ%3D" alt="20251209053826" loading="lazy"/></p>
<p>用 Tiptap 做富文本编辑器，听起来挺美好，实际上却让不少人头疼。虽然它比从零开始写编辑器要友好得多，但真正上手后你会发现，想要做出一个能用的编辑器，难度远超预期。</p>
<p>这篇文章想聊聊，为什么 Tiptap 对很多人来说这么难，以及在实际项目中会遇到哪些坑。</p>
<h2 data-id="heading-0">为什么很多人选择 Tiptap</h2>
<p>先说说 Tiptap 吸引人的地方。</p>
<p><code>基于 ProseMirror 的稳健基础</code> 是它最大的卖点。ProseMirror 这个底层框架被 Notion、Linear 这些产品验证过，稳定性没问题。Tiptap 在它上面做了封装，提供了 starter-kit、基础扩展、getHTML、getJSON 这些常用 API，让你不用直接面对 ProseMirror 的复杂性。</p>
<p><code>模块化设计</code> 也很讨喜。按需加载，基础功能可以保持 bundle 很小，需要的时候再扩展。这种设计符合现代前端开发习惯，你可以根据项目需求灵活选择功能。</p>
<p><code>框架集成</code> 做得不错。React、Vue、Svelte 都有官方包，可以在熟悉的框架生态里工作，不用重新学习一套东西。</p>
<p><code>社区活跃度</code> 也还行。GitHub 上 star 不少，issue 讨论也很多，遇到问题至少能找到一些线索。</p>
<p>所以 Tiptap 确实降低了门槛，但降低门槛不等于消除复杂性。这是理解它为什么仍然困难的关键。</p>
<h2 data-id="heading-1">然而，"难"的原因很多</h2>
<p>"降低门槛" ≠ "变成容易"。下面这些挑战，往往在项目推进过程中才会逐渐暴露。</p>
<h3 data-id="heading-2">1. 底层复杂：ProseMirror 的抽象与复杂性</h3>
<p>Tiptap 虽然封装了 ProseMirror，但本质上还是基于它。有文章提到：</p>
<blockquote>
<p>"Tiptap is built on top of ProseMirror, a robust yet difficult to master editor."</p>
</blockquote>
<p>这话不假。一旦你需要做高级定制，比如自定义节点、插件、命令、协作同步，你就得深入 ProseMirror。那些抽象概念对很多前端工程师来说并不直观。</p>
<h4 data-id="heading-3">抽象概念的学习曲线</h4>
<p><code>Document Model</code> 是第一个坎。ProseMirror 用自己的一套文档模型，不是直接操作 DOM。这是个树状结构，每个节点有类型、属性、内容。理解这个模型需要思维转换，习惯了 DOM 操作的人一开始会不适应。</p>
<p><code>Schema</code> 设计也不简单。它定义了文档里能有哪些节点和标记，以及它们之间的关系。设计一个合理的 schema 需要深入理解文档结构，遇到表格嵌套、列表嵌套这些复杂情况时尤其头疼。</p>
<p><code>Transaction</code> 系统是另一个难点。ProseMirror 用 transaction 处理所有文档变更，每个编辑操作都会创建一个 transaction，描述从旧状态到新状态的变化。要实现撤销、重做、协作这些功能，必须理解 transaction 的工作原理。</p>
<p><code>Selection</code> 管理比想象中复杂。不同浏览器对 selection 的处理不一致，文档结构复杂时（比如表格、列表），selection 的行为经常不符合预期。你以为选中了，实际上可能选中的是别的东西。</p>
<p><code>Node View</code> 更麻烦。当你需要自定义节点渲染和交互时（比如代码块、表格、嵌入内容），你得同时理解 React、Vue 组件系统和 ProseMirror 的节点系统，两者之间的桥接并不总是直观。</p>
<h4 data-id="heading-4">实际开发中的具体困难</h4>
<p>很多人一开始觉得"写个富文本编辑器不就是个 textarea + toolbar 吗"，等真正要兼容多个格式、插入图片表格、撤销重做、协作、粘贴处理、HTML 和 JSON 转换时，才发现坑深如海。</p>
<p>举个例子，实现一个简单的图片上传功能，你需要：</p>
<ol>
<li>创建自定义 Image 节点类型</li>
<li>实现 Node View 来渲染图片</li>
<li>处理图片上传逻辑（拖拽、粘贴、URL 输入等多种方式）</li>
<li>处理图片加载失败的情况</li>
<li>实现图片大小调整、对齐等功能</li>
<li>处理响应式布局</li>
<li>处理图片的序列化和反序列化</li>
</ol>
<p>这还只是图片功能。如果再加上表格、代码块、嵌入内容，复杂度会成倍增加。</p>
<h3 data-id="heading-5">2. 功能多样，需求场景差异极大</h3>
<p>富文本编辑器不是"一个按钮能解决所有问题"。不同应用对文档编辑的需求千差万别，这种多样性让"万能"解决方案变得不现实。</p>
<h4 data-id="heading-6">从 Word、Google Docs 复制粘贴的噩梦</h4>
<p>从 Word 复制内容到编辑器，听起来简单，实际上是个噩梦。</p>
<p>浏览器接收到的是一堆内联样式、嵌套的 div 和 span、字体信息、颜色信息。这些内容需要被"清洗"和转换为你编辑器中的节点结构。你得识别和转换段落、标题、列表，处理表格（包括合并单元格、嵌套表格），处理图片和嵌入内容，清理不必要的样式和标签，处理特殊字符和编码问题。</p>
<p>很多编辑器（包括 Tiptap）对此处理并不理想。你往往需要自己实现或扩展粘贴处理逻辑，这需要深入理解 ProseMirror 的 paste rules 和 clipboard 处理机制。</p>
<h4 data-id="heading-7">媒体与复杂内容支持的工作量被低估</h4>
<p>你可能需要支持图片、视频、embed、附件、表格、表单，还要支持拖拽、上传、调整、重排、自定义样式、响应式、兼容多端。这意味着不仅是文本，还要管理复杂结构。</p>
<p>以表格为例，实现一个功能完整的表格编辑器需要：</p>
<ul>
<li>表格的创建、删除、行列的增删</li>
<li>单元格的合并和拆分</li>
<li>表格样式的自定义（边框、背景色、对齐方式等）</li>
<li>表格内容的编辑（包括嵌套其他节点类型）</li>
<li>表格的响应式处理（在小屏幕上如何显示）</li>
<li>表格的序列化和反序列化</li>
<li>表格的复制粘贴处理</li>
</ul>
<p>这还只是表格。如果再加上图片的拖拽调整大小、视频的播放控制、嵌入内容的交互，工作量会急剧增加。很多人低估了这部分工作量，以为"用个扩展就行"，实际上往往需要大量的定制开发。</p>
<h4 data-id="heading-8">协作功能的指数级复杂度</h4>
<p>如果还要加协作（多人实时编辑）、版本历史、评论、建议编辑、合并、冲突解决，那就更复杂了。有文章指出："无论你选择哪种富文本编辑器，把协作功能加进去都是一件非常具有挑战性的事情。"</p>
<p>协作编辑涉及：</p>
<ul>
<li><code>实时同步</code>：需要 WebSocket 或类似技术来实时同步编辑操作</li>
<li><code>冲突解决</code>：当多个用户同时编辑同一部分时，如何解决冲突</li>
<li><code>操作转换（OT）或 CRDT</code>：需要算法来保证最终一致性</li>
<li><code>版本历史</code>：需要记录每次变更，支持回滚和查看历史</li>
<li><code>权限管理</code>：不同用户可能有不同的编辑权限</li>
<li><code>评论系统</code>：需要在文档中插入评论，并管理评论的生命周期</li>
<li><code>建议编辑</code>：允许用户提出编辑建议，而不是直接修改</li>
</ul>
<p>即使使用 Y.js 这样的协作框架，你仍然需要处理很多细节，比如如何将 ProseMirror 的 transaction 转换为 Y.js 的操作，如何处理网络延迟和断线重连，如何处理冲突等。</p>
<p><code>通用 + 万能 + 高可定制 + 多功能</code>，是个"理想"与"魔鬼"并存的组合。很多团队和个人在最初没评估清楚就上了车，最后才发现问题。</p>
<h3 data-id="heading-9">3. 性能、UX、浏览器兼容的复杂度</h3>
<h4 data-id="heading-10">性能问题的真实存在</h4>
<p>有人反映，当文档很长（上百、几百条目、复杂结构）且含多种格式、嵌入、样式、块时，Tiptap 的响应会变慢。有使用者说：</p>
<blockquote>
<p>"One of the big gotchas I've had with TipTap is that it's extremely sluggish once you get to more than 300 words or so and you're using different formatting options."</p>
</blockquote>
<p>这个问题的根源在于：</p>
<ul>
<li><code>DOM 操作的开销</code>：每次编辑操作都可能触发 DOM 的更新，当文档很大时，这些更新会变得很慢</li>
<li><code>重渲染的成本</code>：React、Vue 组件的重渲染可能不够优化，导致不必要的更新</li>
<li><code>内存占用</code>：大文档会占用大量内存，特别是在移动设备上</li>
</ul>
<p>解决性能问题需要按需渲染、虚拟滚动、优化更新策略、垃圾回收优化、防抖和节流。这些优化都需要深入理解 ProseMirror 和框架的工作原理，不是简单的配置就能解决的。</p>
<h4 data-id="heading-11">跨浏览器兼容性的挑战</h4>
<p>不同浏览器对 content-editable、selection、复制粘贴行为的处理并不一致。兼容性问题、剪贴板行为差异、样式冲突、默认样式覆盖、CSS reset、响应式布局等等，都容易让人头疼。</p>
<p>具体问题包括：</p>
<ul>
<li><code>Selection API 的差异</code>：不同浏览器对 selection 的处理方式不同，特别是在处理复杂节点（如表格、列表）时</li>
<li><code>Clipboard API 的差异</code>：复制粘贴的行为在不同浏览器中可能不同</li>
<li><code>ContentEditable 的行为差异</code>：不同浏览器对 content-editable 元素的处理方式不同</li>
<li><code>移动端的特殊问题</code>：移动端的键盘、触摸事件、输入法等都会影响编辑体验</li>
<li><code>样式兼容性</code>：不同浏览器的默认样式不同，需要大量的 CSS reset 和兼容性处理</li>
</ul>
<p>这正是很多人不想"从头搞一个富文本编辑器"的原因。</p>
<h4 data-id="heading-12">生产环境的额外复杂度</h4>
<p>如果你的编辑器用于生产系统，还可能涉及数据持久化、存储格式选择、解析和回显、版本控制、迁移、与后端兼容、安全（XSS）、国际化、多语言、字体、排版、方向（RTL）等。</p>
<p>当这些积累起来，远超"几行代码 + 一个 toolbar + 一个富文本输入框"的复杂度。</p>
<h3 data-id="heading-13">4. 社区与文档 ≠ "覆盖所有场景"</h3>
<p>虽然 Tiptap 本身文档、示例、社区不错，但对于特定复杂场景（比如"带表格 + 嵌入 + 自定义 node + 协作 + Undo、Redo + 导出 + 插件系统 + 自定义样式、主题、布局、响应式、多端"），几乎不存在一个"现成解决方案"。</p>
<h4 data-id="heading-14">文档的局限性</h4>
<p>Tiptap 的官方文档主要覆盖了基础用法和常见场景，但对于复杂场景，文档往往只能提供方向性的指导，具体的实现细节需要你自己去探索。</p>
<p>比如如何实现一个自定义的表格编辑器，支持合并单元格、调整列宽等功能？如何实现一个代码块编辑器，支持语法高亮、行号、代码折叠？如何实现一个协作编辑系统，处理冲突和同步？如何实现一个导出系统，将编辑器内容导出为 PDF、Word 等格式？</p>
<p>这些场景的文档往往不够详细，或者根本没有文档。你需要阅读源码来理解工作原理，在 GitHub 上搜索相关的 issue 和讨论，在社区中提问（但可能得不到及时回复），自己实验和调试。</p>
<h4 data-id="heading-15">需要自己设计的部分</h4>
<p>多数时候你得自己设计 Schema、Node View、Commands、插件体系、交互逻辑、前端-后端同步、数据库存储方案等。</p>
<p><code>复杂度被隐藏在"源码 + 配置 + 扩展 + 兼容性 + 性能调优 + 测试 + 边界 case 处理"</code> 后面。</p>
<h4 data-id="heading-16">从"用个库就好"到"坑太多"的转变</h4>
<p>很多人在刚开始抱着"用个库就好"的想法，但不到真正要满足复杂需求的时候，就发现坑太多。</p>
<p>你以为插入图片很简单，结果发现需要处理上传、加载失败、响应式、拖拽调整大小等多个问题。你以为实现表格很简单，结果发现需要处理合并单元格、嵌套表格、复制粘贴等复杂情况。你以为实现协作很简单，结果发现需要处理冲突、同步、权限等多个问题。</p>
<p>有人甚至建议，如果你的需求很基础（只是简单文字 + 粗体斜体 + 列表 + 少量图片），用 Markdown 编辑器 + 轻量富文本或简易配置反而更稳。</p>
<h3 data-id="heading-17">5. 心理预期 vs 现实落地</h3>
<p>很多产品经理或不熟悉富文本底层的人，会把富文本编辑器当成"轻量版 Word、Google Docs、所见即所得编辑器"。但事实是，浏览器里的 contenteditable + 富文本编辑器，受限于 DOM、Selection、样式、多端差异、复制粘贴行为、HTML → Model → HTML 的 round-trip、标准兼容性、性能、插件生态等等。</p>
<h4 data-id="heading-18">Word 级别的功能需要 Word 级别的投入</h4>
<p>要做到"像 Word 那么强大又稳定"，就算用了 Tiptap，也至少要投入非常多开发 + 测试 + 兼容 + 优化 + 维护成本。</p>
<p>Word 的表格编辑器是几十年的积累，而 Web 编辑器要实现类似功能需要从零开始。Word 的协作功能是 Microsoft 团队多年研发的结果，而 Web 编辑器要实现类似功能需要自己实现或集成第三方服务。Word 的导出功能支持多种格式，而 Web 编辑器要实现类似功能需要集成多个库或自己实现。</p>
<h4 data-id="heading-19">"跳进兔子洞"的风险</h4>
<p>这是为什么很多从头搞的人（尤其业务方、非编辑器专注团队）最终放弃的原因。甚至有开发者在讨论里直言：构建富文本编辑器"像跳进 rabbit hole"（兔子洞），风险太大，不靠谱。</p>
<p>这个比喻很形象：你以为只是挖一个小洞，结果发现下面是一个深不见底的兔子洞，越挖越深，越挖越复杂，最终发现自己投入的时间和精力远超预期。</p>
<h2 data-id="heading-20">对开发者、项目经理、内容生产者来说：为什么依旧容易被难住</h2>
<p>对于不同类型的角色，Tiptap 的困难点可能有所不同，但都会面临一些共同的挑战。</p>
<h3 data-id="heading-21">内容存储格式的复杂性</h3>
<p>你需要考虑 HTML、JSON、markdown、自定义格式。Tiptap 支持 JSON、HTML 输出、回显，但如果你要自定义节点（例如 embed、图文混排、特殊 block、meta 数据、AI-辅助内容），那就需要你设计 schema，处理序列化、反序列化逻辑，以及前后端如何统一处理这些内容结构。</p>
<h4 data-id="heading-22">格式选择的权衡</h4>
<p>每种格式都有其优缺点：</p>
<ul>
<li><code>HTML</code>：最直观，但可能包含大量冗余信息，不利于存储和传输</li>
<li><code>JSON</code>：结构化好，易于处理，但需要自定义解析逻辑</li>
<li><code>Markdown</code>：简洁，但表达能力有限，不适合复杂内容</li>
<li><code>自定义格式</code>：最灵活，但需要自己实现所有逻辑</li>
</ul>
<p>选择哪种格式需要根据你的具体需求来决定，这个决定会影响整个系统的架构。</p>
<h4 data-id="heading-23">Schema 设计的挑战</h4>
<p>设计一个好的 schema 需要考虑哪些节点类型是必需的、节点之间的包含关系、节点的属性、节点的默认样式和行为、如何扩展 schema 以支持未来需求。这需要深入理解你的内容模型和业务需求。</p>
<p>Tiptap 文档中虽有基础 API，但自定义越深，你要写的东西就越多。</p>
<h3 data-id="heading-24">可视化与发布的多个层面</h3>
<p>如果你希望支持可视化、可发布（类似公众号、社交媒体、Markdown 转 HTML、文章导出、静态页面），你还可能涉及样式渲染、响应式、兼容性、多端适配、HTML sanitation、安全（XSS）、图片、资源管理、SEO、导出与预览等。</p>
<p>每个层面都需要深入的工作，不是简单的配置就能解决的。</p>
<h3 data-id="heading-25">协作功能的指数级复杂度</h3>
<p>若你还想加协作（多人编辑、实时、历史、评论、AI 辅助、版本、导出、回滚），那复杂度呈指数级增长。</p>
<h4 data-id="heading-26">基础框架只是开始</h4>
<p>即便 Tiptap + Y.js + WebSocket、后端，也只是基础框架。你可能还需要额外处理冲突解决、数据同步、权限管理、undo、redo、版本存储、合并逻辑、并发控制、UI、UX 体验、多端协作（桌面、移动）等。</p>
<h4 data-id="heading-27">"要么你自己写，要么妥协"</h4>
<p>很多细节是"要么你自己写，要么妥协"。如果你需要显示其他用户的光标位置，你需要自己实现这个功能。如果你需要支持评论和建议编辑，你需要自己实现这些功能。如果你需要支持版本历史，你需要自己实现版本管理系统。</p>
<p>事实证明，哪怕是经验丰富的团队也要花费相当多时间。</p>
<h3 data-id="heading-28">性能与用户体验的持续挑战</h3>
<p>当文档较大、格式复杂、包含多种节点、嵌入、图片、表格、样式时，要保证编辑体验流畅、不卡顿、不闪烁、不延迟，是个挑战。</p>
<p>性能问题可能出现在输入延迟、滚动卡顿、渲染延迟、内存占用、CPU 占用等多个维度。</p>
<p>尤其对移动端、低性能设备，或者需要即时渲染、同步、预览时，卡顿体验对用户友好度伤害很大。移动端的挑战包括性能更有限、触摸交互与鼠标交互不同、键盘输入体验不同、网络可能不稳定、电池续航需要考虑等。</p>
<h3 data-id="heading-29">这些挑战是核心需求，不是边缘用例</h3>
<p>如果你未来可能会做"复杂内容 + 社交、公众号、文章、AI 辅助、可能多人协作、排版导出"的系统，这些挑战并不是边缘用例，而可能是核心需求。这意味着你不能简单地"先做一个简单版本，以后再优化"，而是需要在设计阶段就考虑这些挑战。</p>
<h2 data-id="heading-30">总结：为什么"对很多人来说，Tiptap 很难"</h2>
<h3 data-id="heading-31">富文本编辑本身是高度复杂的问题</h3>
<p>格式多样（文本、段落、列表、样式、嵌入、媒体、表格...）+ 用户期望高（像 Word、Google Docs、CMS 编辑那样自然）+ 浏览器、DOM、标准、兼容性、性能各类限制，这些因素叠加在一起，使得富文本编辑成为一个高度复杂的问题。</p>
<h3 data-id="heading-32">底层复杂度依然存在</h3>
<p>虽然 Tiptap 封装了一些基础，但底层仍是复杂，高度定制、复杂功能、实用级需求基本都需要"深入 ProseMirror + 自己实现"。Tiptap 降低了入门门槛，但没有消除复杂性。</p>
<h3 data-id="heading-33">成本压力大</h3>
<p>对大多数中小团队、个人开发者、希望快速上线的人来说，真正把富文本编辑器"做好、做稳、做可维护"，工时、测试、兼容性、性能、维护、边缘 case 全都压得人喘不过气。这个成本往往被低估。</p>
<h3 data-id="heading-34">维护成本持续累积</h3>
<p>当需求不断变化（新功能、新格式、新媒体、新协作、新导出、新兼容）的时候，维护成本会不断累积，很多人最终发现"再也不想碰富文本编辑器"。这是一个持续的过程，不是一次性的投入。</p>
<h3 data-id="heading-35">心理预期与现实的差距</h3>
<p>很多人对富文本编辑器的期望是"像 Word 那样强大"，但现实是 Web 编辑器的能力有限，要实现类似功能需要大量投入。这个差距导致了很多项目的失败。</p>
<h2 data-id="heading-36">建议：基于实际需求的实践路径</h2>
<p>虽然 Tiptap 很难，但这并不意味着你不应该使用它。关键是要有正确的预期和合理的规划。</p>
<h3 data-id="heading-37">1. 先做 Minimal Viable Editor (MVE)</h3>
<p>用 Tiptap + StarterKit 做基础（段落、标题、粗体、斜体、列表、链接、图片）。如果你主要是发文、写文章、有一定样式要求，这足够。不要一开始就试图实现所有功能。</p>
<h3 data-id="heading-38">2. 根据需要逐步扩展</h3>
<p>只当确实需要"嵌入、表格、特殊布局、导出、协作、AI 插件、自定义 node"时，再考虑扩展，而不是一开始就设计"万能 + 所有可能功能"。每个功能的添加都需要评估其成本和收益。</p>
<h3 data-id="heading-39">3. 把 Schema、数据结构设计做好</h3>
<p>选好内容存储格式（JSON、HTML、自定义 + metadata），并确保前后端、导入导出、兼容、未来扩展都考虑进去。一个好的数据结构设计可以避免很多后续问题。</p>
<h3 data-id="heading-40">4. 权衡收益 vs 成本</h3>
<p>对于一些不常用或复杂功能（比如复杂表格、拖拽布局、多人协作、版本控制、复杂导出...）要评估清楚，是不是值得投入，或者可以通过 Markdown + 插件 + 后处理导出来替代。不是所有功能都需要在编辑器中实现。</p>
<h3 data-id="heading-41">5. 做好测试与回退、兼容策略</h3>
<p>包括浏览器兼容、移动端、自定义样式、theme、内容导出、清洗（sanitize）、未来迁移、升级。这些工作虽然繁琐，但对于生产环境是必需的。</p>
<h3 data-id="heading-42">6. 考虑替代方案</h3>
<p>如果你的需求相对简单，考虑使用 Markdown 编辑器 + 后处理的方式，可能比直接使用富文本编辑器更简单、更稳定。Markdown 虽然表达能力有限，但对于很多场景已经足够，而且实现和维护成本要低得多。</p>
<h3 data-id="heading-43">7. 寻求专业帮助</h3>
<p>如果项目预算允许，考虑寻求专业的编辑器开发团队或咨询服务的帮助。富文本编辑器是一个专业领域，有经验的人可以帮你避免很多坑。</p>
<h2 data-id="heading-44">总结</h2>
<p>Tiptap 是一个优秀的富文本编辑器框架，它确实降低了开发门槛，但这并不意味着它简单。理解其复杂性，有正确的预期，做好规划，是成功使用 Tiptap 的关键。</p>
<p>如果你正在考虑使用 Tiptap，希望这篇文章能帮助你更好地评估项目的复杂度和成本，做出明智的决策。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[检测开发者工具是否打开？这几种方法让黑客无处遁形🤣]]></title>    <link>https://juejin.cn/post/7581619505584128051</link>    <guid>https://juejin.cn/post/7581619505584128051</guid>    <pubDate>2025-12-09T02:54:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581619505584128051" data-draft-id="7581374664327315507" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="检测开发者工具是否打开？这几种方法让黑客无处遁形🤣"/> <meta itemprop="keywords" content="前端,JavaScript,前端框架"/> <meta itemprop="datePublished" content="2025-12-09T02:54:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ErpanOmer"/> <meta itemprop="url" content="https://juejin.cn/user/3878732754331096"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            检测开发者工具是否打开？这几种方法让黑客无处遁形🤣
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3878732754331096/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ErpanOmer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T02:54:42.000Z" title="Tue Dec 09 2025 02:54:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5be74d43fd534de5a4dd96ea18a2075a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853682&amp;x-signature=OiOSXoPShXsr5SztLkLwb%2Fh3A4I%3D" alt="image.png" loading="lazy"/></p>
<p>大家好，我来了😁。</p>
<p><strong>前端代码在浏览器里是裸奔的。</strong>——这几乎是所有开发者的共识。</p>
<p>只要用户按一下 <code>F12</code>，你的源码、你的接口、你的数据结构，全部一览无余。黑客可以修改你的变量，脚本小子可以刷你的接口，竞品可以分析你的逻辑。</p>
<p>很多老板会问：能不能禁止用户打开控制台？</p>
<p>通常我们的回答是：不能。浏览器是用户的地盘，我们无权干涉。</p>
<p>但是， <strong>禁止不了，不代表我们检测不到。</strong></p>
<p>如果在检测到用户打开 DevTools 的那一瞬间，我们立马<strong>清空敏感数据</strong>、<strong>停止视频播放</strong>、或者<strong>无限 debugger 卡死页面</strong>，是不是就能极大地提高攻击者的门槛？🤔</p>
<p>今天，我就来分享几种利用浏览器API技巧实现的 <strong>DevTools 检测技术</strong>。</p>
<hr/>
<h4 data-id="heading-0"><strong>1.利用 <code>debugger</code> 的时间差</strong></h4>
<p>这是最古老、最暴力，但也最有效的方法之一。</p>
<p>原理：</p>
<p>当 DevTools 打开，并且开启了断点调试功能时，代码执行到 debugger 语句会暂停。</p>
<p>而不打开 DevTools 时，debugger 语句会被浏览器忽略，代码瞬间执行过去。</p>
<p>我们可以记录 <code>debugger</code> 语句前后的<strong>时间戳</strong>。如果差值过大，说明代码被暂停了——也就是说，DevTools 肯定是开着的。</p>
<p><strong>具体代码👇：</strong></p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">checkDevTools</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  
  <span class="hljs-comment">// 核心：这就好比在路上设个卡</span>
  <span class="hljs-keyword">debugger</span>; 
  
  <span class="hljs-keyword">const</span> end = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  
  <span class="hljs-comment">// 如果暂停时间超过 100ms，判定为有人在调试</span>
  <span class="hljs-keyword">if</span> (end - start &gt; <span class="hljs-number">100</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"警告：检测到开发者工具已打开！"</span>);
    <span class="hljs-comment">// 这里可以执行你的防御逻辑：</span>
    <span class="hljs-comment">// window.location.reload(); </span>
    <span class="hljs-comment">// clearSensitiveData();</span>
  }
}

<span class="hljs-comment">// 搞个定时器，每秒查岗一次</span>
<span class="hljs-built_in">setInterval</span>(checkDevTools, <span class="hljs-number">1000</span>);
</code></pre>
<p>优点是简单粗暴，对付小白有效。</p>
<p>缺点的话 有点扰民😖。如果攻击者禁用了断点功能（Deactivate breakpoints），或者设置⚙中配置了Never pause here，这招就废了。</p>
<hr/>
<h4 data-id="heading-1"><strong>2.利用 <code>console.log</code> 的对象懒加载</strong></h4>
<p>这是一个非常骚的检测方法，利用了 Chrome 控制台的一个特性：<strong>对象求值（Object Evaluation）</strong> 。</p>
<p>原理：</p>
<p>当你执行 console.log(obj) 时，浏览器为了性能，并不会立刻把 obj 的所有属性打印出来。它只打印一个引用。</p>
<p>只有当控制台真的是打开状态，并且需要显示内容时，浏览器才会去读取这个对象的属性（getters）。</p>
<p>我们可以给一个对象定义一个 <code>getter</code>（读取器）。如果这个 <code>getter</code> 被触发了，就说明<strong>有一个观察者（DevTools）正在看它</strong>。</p>
<p><strong>直接上代码👇：</strong></p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> element = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(element, <span class="hljs-string">'id'</span>, {
  <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-comment">// 只有当 DevTools 打开时，浏览器尝试获取 element.id 来显示详情</span>
    <span class="hljs-comment">// 这个 getter 才会执行</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'抓到你了！DevTools 是开着的！'</span>);
    
    <span class="hljs-comment">// 执行防御逻辑</span>
    <span class="hljs-title function_">alert</span>(<span class="hljs-string">'请关闭开发者工具继续浏览！'</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-string">'detected'</span>;
  }
});

<span class="hljs-comment">// 定时打印这个 element</span>
<span class="hljs-comment">// 如果控制台没开，log 只是静默执行，不会触发 getter</span>
<span class="hljs-comment">// 如果控制台开了，log 为了显示 element 的详情，会触发 getter</span>
<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(element);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">clear</span>(); <span class="hljs-comment">// 刷屏清空，防止用户发现</span>
}, <span class="hljs-number">1000</span>);
</code></pre>
<hr/>
<p>优点是隐蔽性极强，不需要 <code>debugger</code>，不会打断代码执行。缺点呢？严重依赖浏览器实现。Chrome 上效果最好，Firefox/Safari 的行为可能不同。</p>
<hr/>
<h4 data-id="heading-2"><strong>3.无限 Debugger (防调试)</strong></h4>
<p>这其实不是检测，而是劝退。</p>
<p>很多网站（比如某些视频站、加密小说站），会用一种让黑客极其恶心的手段：<strong>只要你敢开控制台，我就让你卡死。</strong></p>
<p>原理：</p>
<p>利用 Function.constructor 或 eval，在一个高频循环里不断生成新的 debugger。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 放在一个立即执行函数里</span>
(<span class="hljs-keyword">function</span> <span class="hljs-title function_">anonymous</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 定义一个生成 debugger 的函数</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">debuggerLoop</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 通过构造函数生成 debugger，防止源码被静态搜索到</span>
      (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(<span class="hljs-string">"debugger"</span>))(); 
    } <span class="hljs-keyword">catch</span> (e) {}
  }

  <span class="hljs-comment">// 只要没被拦截，我就一直递归调用</span>
  <span class="hljs-comment">// 也可以配合 setInterval</span>
  <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">debuggerLoop</span>();
  }, <span class="hljs-number">50</span>); <span class="hljs-comment">// 每 50ms 炸你一次🤣</span>
})();
</code></pre>
<p>效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95b25ac655bc43f3b46e61f5047b6d30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853682&amp;x-signature=W2t%2FIZzyiwQLlfrTGmqzhbPxZMI%3D" alt="image.png" loading="lazy"/></p>
<p>一旦你打开 F12，你的浏览器就会立刻被无数个断点暂停。点击继续运行？没用，50ms 后下一个断点又来了。你的页面基本处于假死状态，根本没法操作 DOM 或发请求。</p>
<p>这也是为什么你在调试某些网站时，会发现 <code>Sources</code> 面板里全是 <code>VMxxxx</code> 开头的匿名脚本，而且一直卡在 <code>debugger</code> 上。</p>
<hr/>
<h4 data-id="heading-3"><strong>如何绕过呢？🤔</strong></h4>
<p>作为补充，我必须告诉你，这些防御<strong>都不是无敌的</strong>。</p>
<p><strong>对于无限 Debugger：</strong></p>
<ol>
<li><strong>禁用断点</strong>：在 Chrome DevTools 里点击那个禁用所有断点的图标，世界瞬间清净了。</li>
</ol>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2eb18ae20bbb452f9ac906bb4fa0c82b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853682&amp;x-signature=JP0Vx2iUWpG7igBV971gsR%2FC7WY%3D" alt="image.png" loading="lazy"/></p>
<ol start="2">
<li><strong>条件断点</strong>：在那个 <code>debugger</code> 行右键 -&gt; 停用断点。</li>
</ol>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17b75a3b47e340a0bb1f118572367334~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853682&amp;x-signature=Q0qCbHYJlla8dBibXIy3XHSfSjc%3D" alt="image.png" loading="lazy"/></p>
<ol start="3">
<li><strong>本地替换</strong>：用 Chrome 的 本地替换功能，把那段 JS 代码替换成本地空文件。</li>
</ol>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4f16fb8bcdf4bb092e764b0aabcc5af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853682&amp;x-signature=inXbW7V5BQUA7XBACLC08Bg%2Btk8%3D" alt="image.png" loading="lazy"/></p>
<p>对于Getter 检测呢？🤔</p>
<p>黑客可以直接 Hook console.log，让它失效😖。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 你的检测逻辑就废了</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">console</span>.<span class="hljs-property">log</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {}; 
</code></pre>
<hr/>
<p>任何前端安全手段，本质上都是 <strong>防君子，防不了小人</strong>，或者说是<strong>提高攻击门槛</strong>。</p>
<p>在浏览器这个完全开放的环境里，没有什么秘密能真正藏得住。</p>
<p><strong>不要把核心业务逻辑（比如金额计算、权限校验）放在前端。</strong></p>
<p>这些检测手段，更多是用来保护<strong>知识产权</strong>（防止小白扒代码）或者<strong>反爬虫</strong>（检测到调试就停止渲染数据）。</p>
<p><strong>学会这几招，起码能挡住 90% 的脚本小子。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83eae55c2df64ab283a86d5162441714~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853682&amp;x-signature=1xxNUyL4wG5IZ6cg7xW3%2FcA%2FqHI%3D" alt="谢谢大家.gif" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Git提交信息太乱？AI一键美化！一行命令拯救你的项目历史🚀]]></title>    <link>https://juejin.cn/post/7581428845683179563</link>    <guid>https://juejin.cn/post/7581428845683179563</guid>    <pubDate>2025-12-09T07:35:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581428845683179563" data-draft-id="7581408984415977491" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Git提交信息太乱？AI一键美化！一行命令拯救你的项目历史🚀"/> <meta itemprop="keywords" content="前端,AI编程"/> <meta itemprop="datePublished" content="2025-12-09T07:35:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐诗"/> <meta itemprop="url" content="https://juejin.cn/user/712139266339694"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Git提交信息太乱？AI一键美化！一行命令拯救你的项目历史🚀
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139266339694/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐诗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T07:35:54.000Z" title="Tue Dec 09 2025 07:35:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>发现了一个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ff%2Fgit-rewrite-commits" target="_blank" title="https://github.com/f/git-rewrite-commits" ref="nofollow noopener noreferrer">git-rewrite-commits</a> 的仓库，目前 1.1k 🌟</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f1fe86aff7244a5976971c5b4a25b12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZSQ6K-X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870554&amp;x-signature=dEm312DTNp7b4bPZr3TUdf2l0y0%3D" alt="image.png" loading="lazy"/></p>
<p>可以使用 ai 来重写已经提交的 git commit 信息，<strong>修改后需要强制提交</strong></p>
<p>这对于之前 git commit 信息写的乱七八糟的项目，又不想手动改，现在一行命令就能解决这个问题！</p>
<p>写这个文章的原因是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ff%2Fgit-rewrite-commits" target="_blank" title="https://github.com/f/git-rewrite-commits" ref="nofollow noopener noreferrer">git-rewrite-commits</a> 我觉得她这个使用说明写的不是很好懂，但还是建议阅读下！</p>
<h2 data-id="heading-0">准备工作</h2>
<p>可以使用 OpenAI GPT 或本地 Ollama 模型进行 AI 驱动的提交信息生成</p>
<p>这里我们使用 Ollama 模型进行 AI 驱动的提交信息生成</p>
<p>首先你需要安装 Ollama <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.ollama.com%2Fquickstart" target="_blank" title="https://docs.ollama.com/quickstart" ref="nofollow noopener noreferrer">猛击参考官方文档安装</a></p>
<p>然后 Ollama 现在有一个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.ollama.com%2Fcloud" target="_blank" title="https://docs.ollama.com/cloud" ref="nofollow noopener noreferrer">Cloud 云模型</a>，大概就是使用 Ollama 调用云端模型达成和本地运行一样的效果。</p>
<p>运行云模型需要一个 ollama.com 上的账户，执行 <code>ollama signin</code> 登录或创建账户，登录完成后点击头像-&gt;设置，可以看到限额情况</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bef29bd75d6405087e6680eb64b49df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZSQ6K-X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870554&amp;x-signature=KGLdfIx3JUCf6ijWXol%2FSoq1Dd0%3D" alt="image.png" loading="lazy"/></p>
<p>云模型后边会有标识</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5320cb60121d42c4a0a7404aabb329cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZSQ6K-X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870554&amp;x-signature=NxIFShBmFVUgf4G3t7i70KvvtgE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">开始使用</h2>
<pre><code class="hljs language-bash" lang="bash">npx git-rewrite-commits --provider ollama --model qwen3-coder:480b-cloud --min-quality-score 10 --language zh --verbose
</code></pre>









































<table><thead><tr><th>参数</th><th>简写</th><th>值</th><th>作用说明</th></tr></thead><tbody><tr><td><code>--provider</code></td><td>无</td><td><code>ollama</code></td><td>指定 AI 服务提供商，选择使用本地运行的 Ollama 服务处理请求</td></tr><tr><td><code>--model</code></td><td><code>-m</code></td><td><code>qwen3-coder:480b-cloud</code></td><td>指定使用的 AI 模型名称，此处为 Qwen3 Coder 云端版本</td></tr><tr><td><code>--min-quality-score</code></td><td>无</td><td><code>10</code></td><td>设置质量评分阈值，提交评分低于此值的将被重写，设置为 10 表示强制重写所有提交</td></tr><tr><td><code>--language</code></td><td><code>-l</code></td><td><code>zh</code></td><td>设置生成提交信息的语言，此处为中文（简体）</td></tr><tr><td><code>--verbose</code></td><td><code>-v</code></td><td>无（标志参数）</td><td>启用详细输出模式，显示处理过程中的详细信息、评分结果、AI 响应内容等</td></tr></tbody></table>
<p>其他还有一个参数可以执行 <code>npx git-rewrite-commits --help</code> 查看</p>
<p>以我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvaebe%2Fblog" target="_blank" title="https://github.com/vaebe/blog" ref="nofollow noopener noreferrer">blog</a> 项目为例</p>
<ol>
<li>
<p>输入 y 确认
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a02bc06fdb5c45939b6beb7c5b91bb3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZSQ6K-X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870554&amp;x-signature=DSOSifQdc3W0xqDsaJYwk8SnZWM%3D" alt="image.png" loading="lazy"/></p>
</li>
<li>
<p>开始执行
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7be3fa573a042248833163032f7d776~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZSQ6K-X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870554&amp;x-signature=gDmWANALt7m4Kb5FU06XnZr2oaU%3D" alt="image.png" loading="lazy"/></p>
</li>
<li>
<p>执行结束会让你确认是否重写 git commit 记录，输入 y 确认后开始执行
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e733dc70ad0468c911359f3bdb42091~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZSQ6K-X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870554&amp;x-signature=G5vkQh1fpiOhqWfduk82RCB059I%3D" alt="image.png" loading="lazy"/></p>
</li>
<li>
<p>重写完成后会提示你需要强制推送
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32f35931f22c49cfb60c4fe10be67017~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZSQ6K-X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870554&amp;x-signature=lcA1pQLZxnUfmyq5LiTApB2p%2Bq0%3D" alt="image.png" loading="lazy"/>
翻译一下：</p>
<ol>
<li>查看更改：git log --oneline</li>
<li>如果满意，强制推送：git push --force-with-lease</li>
<li>如果出现问题，恢复：git reset --hard backup-main-1765263878856</li>
<li>完成后清理备份：git branch -D backup-main-176526387885</li>
</ol>
</li>
<li>
<p>执行 <code>git push --force-with-lease</code> 开始强制推送
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7eae3c13e6c14d8abe5b9bc375546b37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZSQ6K-X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765870554&amp;x-signature=BHZAo%2BOYn6vTbMGezZGj31bLYqM%3D" alt="image.png" loading="lazy"/>
没有权限会有这种提示，修改仓库推送权限后重新推送即可</p>
</li>
</ol>
<h2 data-id="heading-2">总结</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ff%2Fgit-rewrite-commits" target="_blank" title="https://github.com/f/git-rewrite-commits" ref="nofollow noopener noreferrer">git-rewrite-commits</a> 是一个可以使用 ai 来重写已经提交的 git commit 信息的工具，对于之前项目中 git 提交信息不规范又不想手动去修改时，可以通过一行命令解决，十分方便！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Bean Searcher 遇“鬼”记：为何我的查询条件偷偷跑进了 HAVING？]]></title>    <link>https://juejin.cn/post/7581437632855081000</link>    <guid>https://juejin.cn/post/7581437632855081000</guid>    <pubDate>2025-12-09T06:42:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581437632855081000" data-draft-id="7581437632854458408" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Bean Searcher 遇“鬼”记：为何我的查询条件偷偷跑进了 HAVING？"/> <meta itemprop="keywords" content="前端,Java,ORM"/> <meta itemprop="datePublished" content="2025-12-09T06:42:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="遇见代码"/> <meta itemprop="url" content="https://juejin.cn/user/2928754709235800"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Bean Searcher 遇“鬼”记：为何我的查询条件偷偷跑进了 HAVING？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2928754709235800/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    遇见代码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T06:42:21.000Z" title="Tue Dec 09 2025 06:42:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    107
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>一行代码实现复杂查询的优雅背后，藏着 SQL 语义的严格守卫者。当你不了解它的规则时，它就会用看似诡异的行为提醒你。</p>
</blockquote>
<h2 data-id="heading-0">1. 优雅框架的意外难题</h2>
<p>Bean Searcher 在 Java 开发者中正获得越来越多的关注。它被描述为 “比 MyBatis 开发效率 <strong>快 100 倍</strong> 的只读 ORM，天生支持联表”，只需要一行代码就能实现多表联查、分页搜索、组合过滤等复杂功能。</p>
<p>我很快就在项目中应用了这个框架，处理那些常规的列表查询确实得心应手。直到我遇到了需要分组统计的场景。</p>
<h2 data-id="heading-1">2. 问题的显现</h2>
<blockquote>
<p>为了业务脱敏，我将业务表简化为学校里常用的 课程、教师、分数 模型表</p>
</blockquote>
<p>我的需求很明确：统计每门课程的平均分，同时只关注特定教师教授的课程。我设计了如下 SearchBean（检索实体类）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SearchBean(
    tables = "course c, teacher t, score s",
    where = "c.teacher_id = t.id and c.id = s.course_id",
    groupBy = "c.id"   // 按课程 ID 分组
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AvgScoreVO</span> {

    <span class="hljs-meta">@DbField("c.id")</span>
    <span class="hljs-keyword">private</span> Integer courseId;

    <span class="hljs-meta">@DbField("avg(s.score)")</span>
    <span class="hljs-keyword">private</span> Float averageScore;

    <span class="hljs-meta">@DbField("t.id")</span>  <span class="hljs-comment">// 我想用这个字段筛选特定教师的课程</span>
    <span class="hljs-keyword">private</span> Integer teacherId;

    <span class="hljs-comment">// 省略getter/setter</span>
}
</code></pre>
<p>在控制器中，我像往常一样使用一行代码进行查询：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/avgScores")</span>
<span class="hljs-keyword">public</span> List&lt;AvgScoreVO&gt; <span class="hljs-title function_">getAvgScores</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> beanSearcher.searchAll(AvgScoreVO.class);
}
</code></pre>
<blockquote>
<p>这里我使用了 Bean Searcher 官方文档中推荐的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fbs.zhxu.cn%2Fguide%2Fusage%2Fothers.html" target="_blank" title="https://bs.zhxu.cn/guide/usage/others.html" ref="nofollow noopener noreferrer"><strong>自动接收前端请求参数</strong></a> 的机制。所以这里真的只剩一行代码了。</p>
</blockquote>
<p>逻辑看起来无懈可击：按课程分组，计算平均分，同时筛选出指定教师的课程。我用 HTTP 客户端发起请求：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76f944b95db04b52912302caaa512773~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YGH6KeB5Luj56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765873186&amp;x-signature=KzIFUF6w0ij6%2FfrwaSu5VdckJ9U%3D" alt="image.png" loading="lazy"/></p>
<p>然而请求发起后，我却得到了这样的错误：</p>
<pre><code class="hljs language-sql" lang="sql">SQLSyntaxErrorException: <span class="hljs-literal">Unknown</span> <span class="hljs-keyword">column</span> <span class="hljs-string">'t.id'</span> <span class="hljs-keyword">in</span> <span class="hljs-string">'having clause'</span>
</code></pre>
<p>生成的 SQL 大致如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">select</span> c.id c_0, <span class="hljs-built_in">avg</span>(s.score) c_1, t.id c_2
<span class="hljs-keyword">from</span> course c, teacher t, score s
<span class="hljs-keyword">where</span> c.teacher_id <span class="hljs-operator">=</span> t.id <span class="hljs-keyword">and</span> c.id <span class="hljs-operator">=</span> s.course_id
<span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> c.id
<span class="hljs-keyword">HAVING</span> c_2 <span class="hljs-operator">=</span> ?  <span class="hljs-comment">-- 问题在这里！</span>
</code></pre>
<p>为什么？为什么我的 <code>teacherId</code> 条件被放在 <code>HAVING</code> 子句而不是 <code>WHERE</code> 子句？按照 SQL 执行顺序，<code>WHERE</code> 在分组前执行，<code>HAVING</code> 在分组后执行。将教师筛选条件放在 <code>HAVING</code> 中不仅逻辑错误，而且是 SQL 语法错误！</p>
<h2 data-id="heading-2">3. 深入探索：官方文档的线索</h2>
<p>面对这个看似诡异的问题，我开始仔细查阅 Bean Searcher 的官方文档。在其 <a href="https://link.juejin.cn?target=https%3A%2F%2Fbs.zhxu.cn%2Fguide%2Fbean%2Ffields.html" target="_blank" title="https://bs.zhxu.cn/guide/bean/fields.html" ref="nofollow noopener noreferrer"><strong>条件属性</strong></a> 章节，我发现了关于 <code>@DbField</code> 注解的 <code>cluster</code> 属性的关键说明。</p>
<p><code>cluster</code> 属性有三种取值：</p>

























<table><thead><tr><th>取值</th><th>含义</th><th>GroupBy 时条件生成位置</th></tr></thead><tbody><tr><td><code>Cluster.TRUE</code></td><td>表明该属性是聚合字段</td><td>只会生成 <code>HAVING</code> 条件</td></tr><tr><td><code>Cluster.FALSE</code></td><td>表明该属性是非聚合字段</td><td>只会生成 <code>WHERE</code> 条件</td></tr><tr><td><code>Cluster.AUTO</code></td><td>默认值，自动推断</td><td>根据规则推断</td></tr></tbody></table>
<p>文档进一步解释了 <code>Cluster.AUTO</code> 的推断逻辑：</p>
<ul>
<li>当条件属性 <strong>在 <code>groupBy</code> 列表中时</strong>，自动推断为 <code>FALSE</code>（生成 <code>WHERE</code> 条件）</li>
<li>当条件属性 <strong>不在 <code>groupBy</code> 列表中</strong>，并且 <strong>该属性同时是 Java 类中的字段</strong> 时，自动推断为 <code>TRUE</code>（生成 <code>HAVING</code> 条件）</li>
<li>其他情况都推断为 <code>FALSE</code></li>
</ul>
<p>这就是关键！我的 <code>teacherId</code> 字段不在 <code>groupBy</code> 列表中，但它是 Java 类中的字段，因此被自动推断为 <code>Cluster.TRUE</code>，条件被生成在 <code>HAVING</code> 子句中。</p>
<h2 data-id="heading-3">4. 设计者的精妙考量</h2>
<p>为什么 Bean Searcher 的作者要这样设计？起初我觉得这是反直觉的，但深入思考后，我发现这背后有着严谨的逻辑。</p>
<p>首先，需要理解 Bean Searcher 中两种不同类型 条件属性 的区别：</p>
<ul>
<li><strong>字段属性</strong>：声明在 Java 类 (<code>@SearchBean</code>) 中的字段，既可以根据参数生成条件，又用于 <strong>承载查询结果</strong>，会出现在 <code>SELECT</code> 列表中</li>
<li><strong>附加属性</strong>：通过 <code>@SearchBean.fields</code> 定义的属性，不承载查询结果，<strong>不会</strong>出现在 <code>SELECT</code> 列表中，仅作为动态查询条件使用</li>
</ul>
<p>当执行带有 <code>GROUP BY</code> 的查询时，<strong>SQL-92</strong> 和 <strong>SQL:1999</strong> 规范里都有一个严格的语义规则：<strong><code>SELECT</code> 列表中的任何非聚合列，必须出现在 <code>GROUP BY</code> 子句中</strong>。</p>
<p>Bean Searcher 的设计者面临一个抉择：当框架检测到一个"普通Java字段"出现在分组查询中，但又不参与分组时，该如何处理？</p>
<p>如果框架将其条件生成在 <code>WHERE</code> 子句，这在语义上是正确的，但如果开发者本意是想用这个字段过滤分组后的结果，框架将其放在 <code>WHERE</code> 就会导致逻辑错误。</p>
<p><code>Cluster.AUTO</code> 选择推断为 <code>TRUE</code>，实际上是一种"安全侧"设计。这种推断很大概率会导致运行时数据库报错，但这个<strong>错误会强制开发者停下来思考</strong>："我到底想用这个字段做什么？"</p>
<p>然后开发者必须做出明确的决定：</p>
<ul>
<li>如果这个字段只是用于动态生成条件，不承载检索结果，就应该将其声明再附加属性中</li>
<li>如果确实想基于该字段的聚合结果过滤：则需要改写 SQL，例如使用 <code>avg(s.score)</code> 等聚合函数</li>
<li>如果确实用不了聚合函数，但既想承载检索结果，又想在分组前过滤：那是否考虑将其声明到 <code>groupBy</code> 列表中去（遵守 SQL 规范）</li>
<li>如果就 <strong>不想遵守 SQL 规范</strong>，就应显式设置为 <code>@DbField(cluster = Cluster.FALSE)</code></li>
</ul>
<h2 data-id="heading-4">5. 问题的本质与解决方案</h2>
<p>基于上述理解，我意识到我的问题本质是：<code>teacherId</code> 是一个<strong>字段属性</strong>（Java类中的字段），它会出现在 <code>SELECT</code> 列表中，但在 <code>GROUP BY</code> 查询中，它既不在分组列表中，也不是聚合函数。</p>
<p>根据 SQL 语义，这样的字段在 <code>SELECT</code> 中是非法的。Bean Searcher 的 <code>Cluster.AUTO</code> 推断逻辑在这种情况下选择将其视为聚合字段（<code>TRUE</code>），因此将过滤条件放在 <code>HAVING</code> 中。</p>
<p>解决这个问题有两种方法：</p>
<h3 data-id="heading-5">方法一：将字段改为附加属性</h3>
<p>如果这个字段不需要出现在查询结果中，只作为过滤条件，可以将其定义为附加属性：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SearchBean(
    tables = "course c, teacher t, score s",
    joinCond = "c.teacher_id = t.id and c.id = s.course_id",
    groupBy = "c.id",
    fields = {
        @DbField(name = "teacherId", value = "t.id")    // 定义附加属性
    }
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CourseScoreVO</span> {

    <span class="hljs-meta">@DbField("c.id")</span>
    <span class="hljs-keyword">private</span> Long courseId;

    <span class="hljs-meta">@DbField("AVG(s.score)")</span>
    <span class="hljs-keyword">private</span> Double averageScore;

    <span class="hljs-comment">// teacherId 现在是附加属性，不会出现在SELECT中</span>
    <span class="hljs-comment">// 它将被自动推断为 Cluster.FALSE，条件生成在WHERE中</span>

    <span class="hljs-comment">// 省略其他字段和getter/setter</span>
}
</code></pre>
<h3 data-id="heading-6">方法二：显式指定 cluster 属性</h3>
<p>如果确实 <strong>不想遵守 SQL 规范</strong>，并且也确定我的数据库支持运行这种不规范的 SQL，那么只需指定 <code>cluster</code> 属性为 <code>FALSE</code> 即可：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@DbField(value = "t.id", cluster = Cluster.FALSE)</span>
<span class="hljs-keyword">private</span> Long teacherId;
</code></pre>
<p>这样明确告诉框架，这个字段是非聚合字段，条件应该放在 <code>WHERE</code> 子句中。</p>
<h2 data-id="heading-7">6. 作者的设计哲学："好类" 与 "坏类"</h2>
<p>与 Bean Searcher 作者沟通后，我获得了更深层次的理解。作者将分组查询场景下的 <code>@SearchBean</code> 类分为两种：</p>
<h3 data-id="heading-8">什么是"好类"？</h3>
<p>一个被开发者深思熟虑的"好类"，在分组查询中，其每个字段都严格遵守 SQL 语义：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SearchBean(
    tables = "student_course sc",
    groupBy = "sc.course_id"
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CourseScore</span> {

    <span class="hljs-comment">// 这个字段在 groupBy 列表中，合法</span>
    <span class="hljs-meta">@DbField("sc.course_id")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> courseId;

    <span class="hljs-comment">// 这个字段是聚合函数，合法</span>
    <span class="hljs-meta">@DbField("sum(sc.score)")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> totalScore;

    <span class="hljs-comment">// 这是一个"好类"，无需手动指定 cluster 属性</span>
}
</code></pre>
<p>"好类" 的特点：</p>
<ol>
<li>每个字段要么在 <code>groupBy</code> 列表中</li>
<li>要么使用了聚合函数（如 <code>SUM</code>, <code>AVG</code>, <code>COUNT</code> 等）</li>
<li>框架的 <strong>自动推断</strong> 能完美工作，无需手动干预</li>
</ol>
<h3 data-id="heading-9">什么是"坏类"？</h3>
<p>一个未被开发者深思熟虑的"坏类"，包含不符合分组查询语义的字段：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SearchBean(
    tables = "course c, teacher t, score s",
    joinCond = "c.teacher_id = t.id AND c.id = s.course_id",
    groupBy = "c.id"
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CourseScoreVO</span> {

    <span class="hljs-comment">// 这个字段在 groupBy 列表中，合法</span>
    <span class="hljs-meta">@DbField("c.id")</span>
    <span class="hljs-keyword">private</span> Long courseId;

    <span class="hljs-comment">// 这个字段是聚合函数，合法</span>
    <span class="hljs-meta">@DbField("AVG(s.score)")</span>
    <span class="hljs-keyword">private</span> Double averageScore;

    <span class="hljs-comment">// 这个字段既不在 groupBy 列表中，也不是聚合函数</span>
    <span class="hljs-comment">// 这是一个 "坏类" 的典型表现</span>
    <span class="hljs-meta">@DbField("t.id")</span>
    <span class="hljs-keyword">private</span> Long teacherId;
}
</code></pre>
<p>"坏类"的问题：</p>
<ol>
<li>包含既不在 <code>groupBy</code> 列表中，也不是聚合函数的字段</li>
<li>这些字段在分组查询的 <code>SELECT</code> 子句中是不合法的，没有遵循 SQL 规范</li>
<li>框架无法自动确定如何处理这些字段的过滤条件</li>
</ol>
<h3 data-id="heading-10">作者的意图</h3>
<p>作者的设计哲学是：<strong>引导开发者设计 "好类"，而不是迁就 "坏类"</strong> 。</p>
<p>当一个类被框架标记为"坏类"（通过条件被错误放入 <code>HAVING</code> 来提示）时，框架实际上在说：</p>
<blockquote>
<p>"你的类设计可能存在问题。请重新思考：这个字段真的应该在分组查询的结果中出现吗？"</p>
</blockquote>
<p>如果开发者经过思考后，认为这个字段确实需要，那么就应该明确告诉框架：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 经过思考，我确实需要这个字段，但它应该作为分组前过滤条件</span>
<span class="hljs-meta">@DbField(value = "t.id", cluster = Cluster.FALSE)</span>
<span class="hljs-keyword">private</span> Long teacherId;
</code></pre>
<p>通过这种方式，框架既保证了 SQL 的语义正确性，又给了开发者灵活处理特殊情况的空间。</p>
<h2 data-id="heading-11">7. 最佳实践与总结</h2>
<p>通过这次经历，我总结了在使用 Bean Searcher 进行分组查询时的最佳实践：</p>
<ol>
<li><strong>设计"好类"优先</strong>：在设计分组查询的实体类时，优先确保每个字段要么在 <code>groupBy</code> 列表中，要么是聚合函数。这样的"好类"能让框架的自动推断完美工作。</li>
<li><strong>理解"坏类"的代价</strong>：如果确实需要包含非分组、非聚合的字段，理解这是"坏类"，并接受需要手动指定 <code>cluster</code> 属性的代价。</li>
<li><strong>理解框架设计哲学</strong>：Bean Searcher 的设计者在"便利性"和"语义正确性"之间选择了后者。这可能导致初期的学习曲线，但长期来看，它 <strong>避免了更隐蔽的逻辑错误</strong>。</li>
<li><strong>区分字段用途</strong>：明确区分哪些字段用于展示结果（需要在 <code>SELECT</code> 中），哪些仅用于过滤（可以定义为附加属性）。</li>
</ol>
<p>回顾整个探索过程，那个看似"诡异"的错误实际上是指引我深入理解 SQL 语义和框架设计理念的路标。Bean Searcher 通过这种 <strong>"快速失败"</strong> 的设计，确保开发者在早期就能发现并修复潜在的逻辑问题。</p>
<p>这个框架不仅仅是一个简化代码的工具，它更是一个引导开发者写出更严谨 SQL 的良师益友。下次当你的查询条件"偷偷"跑进 <code>HAVING</code> 子句时，不要惊慌，这是框架在提醒你：是时候仔细思考你的查询逻辑了。</p>
<p>毕竟，在编程的世界里，没有无缘无故的"诡异"，只有尚未理解的精妙设计！</p>
<blockquote>
<p><strong>开源代码：</strong></p>
<ul>
<li>Gitee: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Ftroyzhxu%2Fbean-searcher" target="_blank" title="https://gitee.com/troyzhxu/bean-searcher" ref="nofollow noopener noreferrer">gitee.com/troyzhxu/be…</a></li>
<li>Github: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftroyzhxu%2Fbean-searcher" target="_blank" title="https://github.com/troyzhxu/bean-searcher" ref="nofollow noopener noreferrer">github.com/troyzhxu/be…</a></li>
<li>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbs.zhxu.cn%2F" target="_blank" title="https://bs.zhxu.cn/" ref="nofollow noopener noreferrer">bs.zhxu.cn/</a></li>
</ul>
<p><strong>往期阅读：</strong></p>
<ul>
<li><a href="https://juejin.cn/post/7027733039299952676" target="_blank" title="https://juejin.cn/post/7027733039299952676">我这样写代码，比直接使用 MyBatis 效率提高了 100 倍</a></li>
<li><a href="https://juejin.cn/post/7092411551507808264" target="_blank" title="https://juejin.cn/post/7092411551507808264">最近火起的 Bean Searcher 与 MyBatis Plus 倒底有啥区别？</a></li>
<li><a href="https://juejin.cn/post/7116736773065343012" target="_blank" title="https://juejin.cn/post/7116736773065343012">Bean Searcher v3.8.0 一大波新特性来袭</a></li>
<li><a href="https://juejin.cn/post/7379667550504517643" target="_blank" title="https://juejin.cn/post/7379667550504517643">你知道只读 ORM 吗，Bean Searcher v4.3.0 来啦！</a></li>
</ul>
</blockquote>
<p>如果觉得文本不错，动手点个赞吧 ^_^</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Context 知多少，组件通联有门道]]></title>    <link>https://juejin.cn/post/7581348660824506368</link>    <guid>https://juejin.cn/post/7581348660824506368</guid>    <pubDate>2025-12-09T00:29:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581348660824506368" data-draft-id="7577345758036066304" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Context 知多少，组件通联有门道"/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2025-12-09T00:29:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Context 知多少，组件通联有门道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T00:29:48.000Z" title="Tue Dec 09 2025 00:29:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><em>本系列为 Android 技术职场题材虚构小说，所有登场人物、公司名称、组织架构及相关情节均为创作所需虚构而来，若有雷同，纯属偶然。书中涉及的技术知识经专业梳理，仅供参考。</em></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/844bf0f4350a4e488ceae20d66f4dfce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765844987&amp;x-signature=hqjJxjm%2B1%2FnQsG0jEQxcQOYQDww%3D" alt="0.png" loading="lazy"/></p>
<h2 data-id="heading-0">四）Context 知多少，组件通联有门道</h2>
<p>上次面试的失败像盆冷水，彻底浇醒了浑浑噩噩的林卓。面试官随意抛出的Android相关问题，他答得支支吾吾，那一刻他才明白，只靠改UI、调接口的表面功夫，根本撑不起职业道路。</p>
<p>回到组里，他收起了摸鱼的心思，开始沉下心钻研核心技术。恰逢组里启动“用户中心模块重构”，老杨见他态度转变，便把“全局通知工具类开发”这个基础子任务交给他练手。林卓磕磕绊绊干了快一周，刚把基础功能跑通，麻烦就找上门了。</p>
<p>“林卓，你负责的通知模块测出问题了！”小安抱着测试机急匆匆跑过来，高马尾随着脚步晃得厉害，“常规操作都没问题，但我做后台保活测试时发现，退到后台等待一会儿再触发推送，APP直接内存泄漏，时间长了还会崩溃，日志里全是 <strong>LeakCanary</strong> 检测到内存泄漏的警告。”</p>
<p>林卓赶紧接过测试机，屏幕上“应用已停止运行”的提示格外刺眼。他打开日志，<code>Activity Context leaked</code> 的红色字样像根刺扎在眼前。这个通知工具类他用了单例模式，为了方便调用 <code>Toast</code>，直接把 <code>Activity</code> 的 <code>this</code> 传了进去。</p>
<p>“我明明在工具类里加了判空啊。”林卓皱着眉翻代码，“<code>if (context != null) { Toast.makeText(context, msg, Toast.LENGTH_SHORT).show() }</code>，怎么还会泄漏？”</p>
<p>“你这是把 <code>Activity</code> 的命门攥手里了。”老杨端着搪瓷杯路过，杯沿还沾着点茶叶。</p>
<p>他直指问题核心：“单例是全局生命周期，<code>Activity</code> 一销毁，它还抱着 <code>Activity</code> 的 <code>Context</code> 不放，垃圾回收器收不了，可不就泄漏了？”</p>
<p>林卓顺着老杨的话往下想，眉头拧得更紧：“那要是有些场景确实绕不开，非得在单例这种长生命周期对象里用到 <code>Activity Context</code>，就没别的办法了吗？”</p>
<p>“也不是完全不能用，核心是别让长生命周期对象‘死抓着’<code>Activity Context</code> 不放。”老杨拉过椅子坐下，顺势接过林卓的代码本。</p>
<p>他给出解决方案：“真碰到这种需求，就得用 <code>WeakReference</code> 把 <code>Context</code> 包起来。它就像个‘临时抓手’，只在需要的时候关联 <code>Activity</code>，垃圾回收器要清理 <code>Activity</code> 时，它不会拦着，这样就能从根上减少泄漏风险。”</p>
<p>听着老杨的讲解，林卓突然想起之前看过老杨给的《Android核心知识点》，赶紧追问：“您这么一说我就明白了！那结合你的文档里讲的 <code>Context</code> 类型，我这个单例工具类，是不是直接用 <code>Application Context</code> 最稳妥？”</p>
<p>“先别急着下结论。”老杨拉过椅子坐下，点开工具类代码，“你这工具类又弹 <code>Toast</code> 又显示 <code>Dialog</code>，得先搞清楚不同场景该用啥 <code>Context</code>。”</p>
<p>他指着屏幕，给出关键区分：“像 <code>Toast</code> 这种轻量级提示，用 <code>Application Context</code> 完全没问题，系统会自动处理窗口关联。”</p>
<p>“但像 <code>AlertDialog</code>、自定义主题的 <code>TextView</code> 这类和界面主题强相关的组件，就必须用 <code>Activity Context</code>。”</p>
<p>老杨强调核心原因：“<code>Application Context</code> 没有承载界面主题的能力，这才是新手常踩的坑。”</p>
<p>小安在旁边连连点头：“对对，我上次测个弹窗功能，按钮字体和颜色全不对，跟设计图差老远。开发改了改调用方式，换成跟页面绑定的那种，立马就正常了。”她撇撇嘴吐槽，“这Android也太奇怪了，同样是弹个东西，换个地方触发就出幺蛾子。”</p>
<p>“嗯，这也是很多新手踩坑的地方。”</p>
<p>老杨接过话头，抛出一个隐藏知识点：“就说 <code>Dialog</code> 这个类，构造函数明晃晃写着要 <code>Context</code>，但你去翻源码就知道，它要求的是 <code>@UIContext</code>。”</p>
<p>他进一步解释：“这种上下文一般只有 <code>Activity</code> 才有，<code>Application</code> 和 <code>Service</code> 根本不具备。”</p>
<p>他接着打开林卓的单例代码，用鼠标圈出 <code>private var mContext: Context? = null</code>：“你把 <code>Activity</code> 传进来，单例就成了 <code>Activity</code> 的‘寄生虫’。”</p>
<p>“就算 <code>Activity</code> <code>finish</code> 了，单例还拿着它的引用，内存能不泄漏吗？”</p>
<p>老杨顿了顿，给出明确解决方案：“改成就用 <code>getApplicationContext()</code>。”</p>
<p>他特意强调注意事项：“但要记死，这个 <code>Context</code> 不能做UI相关的操作，比如弹对话框、加载布局，刚好避开它的短板。”</p>
<p>林卓恍然大悟，赶紧翻回工具类代码，手指在屏幕上划着逻辑：“我明白您的意思了！<code>Toast</code> 用 <code>Application Context</code> 就行，但工具类里还留着弹 <code>AlertDialog</code> 的功能，这总不能跟 <code>Toast</code> 共用一套上下文吧？是不是得让调用方每次传 <code>Activity Context</code> 过来？”</p>
<p>“分场景处理。”老杨拿起笔在林卓的笔记本上画起来，给出清晰的使用准则。</p>
<p>适用 <code>Application Context</code> 的场景：“工具类里存 <code>Application Context</code>，用于初始化通知管理器、访问全局资源，还有 <code>Toast</code> 这种通用提示。”</p>
<p>必须用 <code>Activity Context</code> 的场景：“<code>AlertDialog</code>、带自定义主题的UI组件这些和界面强绑定的操作，必须让调用方传 <code>Activity</code> 里的 <code>Context</code>，并且每次用的时候实时传，别存起来。”</p>
<p>他顿了顿，补充一个 <code>Service</code> 专属知识点：“还有个 <code>Service</code> 里常踩的硬坑——<code>Service</code> 本身没有独立的任务栈，它跑在后台，不属于任何界面的任务栈。”</p>
<p>核心要求：“所以在 <code>Service</code> 里启动 <code>Activity</code> 时，必须给 <code>Intent</code> 加<code>Intent.FLAG_ACTIVITY_NEW_TASK</code>这个标记。”</p>
<p>标记作用与异常后果：“这个标记的作用是帮新启动的 <code>Activity</code> 创建一个独立的任务栈来承载它，要是不加，系统找不到放 <code>Activity</code> 的地方，就会抛出<code>AndroidRuntimeException</code>。”</p>
<p>他看向小安：“这个小安测试的时候肯定碰到过。”</p>
<p>小安立刻点头摆手，有点不好意思地笑：“反正就是这么个理儿！我之前测过类似的后台功能，开发没加东西就崩了，我把崩的情况报上去，他们改了个标记就好了。具体啥原理我也记不太清，你们说的这些 <code>Context</code> 相关的，我听着都头大。”</p>
<p>林卓立刻按这个思路重构代码：单例初始化时通过 <code>context.applicationContext</code> 存全局上下文，弹 <code>AlertDialog</code> 的方法则新增 <code>Activity Context</code> 参数，要求调用方实时传入。改完后小安当场测试——前台弹通知、弹窗都正常，后台触发推送也没再出现内存泄漏，<strong>LeakCanary</strong> 的警告彻底消失了。</p>
<p>林卓把老杨的话记在笔记本上，特意用红笔标注：“单例存 <code>Application Context</code>，UI操作传 <code>Activity Context</code>，实时调用不缓存”。接下来的几天，他不仅重构了通知工具类，还主动把组里几个老模块的<code>Context</code>使用逻辑都排查了一遍——之前总被忽略的“内存泄漏隐患”“主题错乱”等小问题，如今都成了他重点关注的对象。</p>
<p>林卓排查完最后一个老模块，揉着脖子跟老杨反馈：“杨工，我发现好多旧代码里，<code>Activity</code> 里既用 <code>this</code> 又用 <code>baseContext</code>，看得我有点乱，这俩到底啥关系啊？”</p>
<p>老杨正收拾着文档，闻言停下动作，干脆把林卓的代码本拉到自己面前：“正好你问到点子上了，光会用还不够，得知道底层逻辑才不容易踩坑。”</p>
<p>他打开 <code>ContextWrapper</code> 的源码，用指尖点着屏幕：“你看，<code>ContextWrapper</code> 里有个 <code>mBase</code> 字段，这就是真正的上下文实现，不管是 <code>Activity</code> 还是 <code>Service</code>，最终都要委托给它。<code>Activity</code> 的 <code>mBase</code> 是 <code>ContextImpl</code>，还附加了主题信息；但 <code>Service</code> 的 <code>mBase</code> 也是 <code>ContextImpl</code>，却没有主题扩展——这就是为啥 <code>Service</code> 不能弹弹窗。”</p>
<p>林卓盯着源码若有所思，突然指着 <code>baseContext</code> 相关的注释问：“那 <code>Activity</code> 里的 <code>this</code> 和 <code>baseContext</code> 具体有啥区别？”</p>
<p>“这问题问得好，正好结合代码给你讲明白。”老杨干脆拉过林卓的工位椅，打开他的IDE，调出两段代码——正是组里前辈写过的主题包装类代码。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomThemeContextWrapper</span>(base: Context) : ContextWrapper(base) {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getTheme</span><span class="hljs-params">()</span></span>: Resources.Theme {
        <span class="hljs-keyword">val</span> theme = <span class="hljs-keyword">super</span>.getTheme()
        theme.applyStyle(R.style.CustomTheme, <span class="hljs-literal">true</span>) <span class="hljs-comment">// Apply a custom theme</span>
        <span class="hljs-keyword">return</span> theme
    }
}
</code></pre>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">attachBaseContext</span><span class="hljs-params">(newBase: <span class="hljs-type">Context</span>)</span></span> {
        <span class="hljs-keyword">super</span>.attachBaseContext(CustomThemeContextWrapper(newBase))
    }
}
</code></pre>
<p>老杨逐行解析代码：“你先看这段 <code>CustomThemeContextWrapper</code>，它继承了 <code>ContextWrapper</code>，核心是重写 <code>getTheme()</code> 方法，给上下文附加了自定义主题样式。”</p>
<p>“再看 <code>MyActivity</code>，通过 <code>attachBaseContext</code> 方法，把 <code>newBase</code> 包装成了这个自定义上下文。”</p>
<p>林卓盯着代码里的 <code>newBase</code> 关键词，眉头拧了起来：“这个 <code>newBase</code> 就是 <code>baseContext</code> 吧？那 <code>Activity</code> 的 <code>this</code> 拿到的上下文，是不是在它基础上包装出来的？”</p>
<p>“可以这么理解，但 <code>this</code> 是比 <code>baseContext</code> 更完整的存在。”老杨指着代码解释。</p>
<p>“<code>baseContext</code> 是 <code>Activity</code> 的‘底层上下文’，负责和系统底层交互，比如获取资源、启动服务这些基础操作，你看到的 <code>newBase</code> 就是系统给 <code>Activity</code> 分配的初始 <code>baseContext</code>。”</p>
<p>他顿了顿，敲了敲 <code>attachBaseContext</code> 方法，讲解 <code>this</code> 的作用：“而 <code>Activity</code> 的 <code>this</code>，是在 <code>baseContext</code> 的基础上做了‘增强’——它封装了生命周期管理、界面主题、窗口绘制这些核心能力。”</p>
<p>结合代码举例：“就像这段代码，我们给 <code>baseContext</code> 包了一层自定义主题，最终 <code>this</code> 拿到的上下文，就带着这个主题样式了。”</p>
<p>为了让林卓更直观，老杨举了个对比例子。</p>
<p><code>this</code> 的优势：“你用 <code>this</code> 去创建 <code>AlertDialog</code>，它能自动适配 <code>Activity</code> 的主题，因为 <code>this</code> 里包含了主题信息。”</p>
<p><code>baseContext</code> 的局限：“但你要是用 <code>baseContext</code> 去创建，它只会用系统默认主题——甚至在某些版本里会崩溃，因为 <code>baseContext</code> 没有 <code>Activity</code> 那种窗口关联能力。”</p>
<p>“那什么时候该用 <code>baseContext</code> 啊？”林卓追问，顺手把老杨的话记在笔记本上，特意留出补充案例的空白。</p>
<p>“用在不需要界面主题和生命周期的场景。”老杨补充道。</p>
<p>他给出一句总结，还举了个具体例子：“简单说，<code>this</code> 是‘全能选手’，带界面属性；<code>baseContext</code> 是‘基础工具人’，只干底层活。比如你在 <code>Activity</code> 里注册静态广播，用 <code>baseContext</code> 就够了”</p>
<p>小安凑过来看热闹，听完恍然大悟：“怪不得我上次测一个自定义按钮，开发的样式总出问题，换个调用方式就好了，原来问题在这！”</p>
<p>老杨笑着看向小安，又转头对林卓说：“其实测试和开发排查问题的思路是相通的，都能从场景反推。”</p>
<p>核心排查场景：“你就盯着那些关键场景测：比如启动新页面、弹弹窗的样式，后台操作等等，如果出问题，大概率是 <code>Context</code> 用错了。”</p>
<p>他补充测试要点：“还有那些全局都能用的工具，要是在后台用就出问题，也可能是这个原因。你多换几种机型、多测几个前后台切换的场景，问题自然就露出来了。”</p>
<p>带着这些收获，林卓在接下来的一周里，把项目里所有涉及 <code>Context</code> 的地方都系统梳理了一遍。</p>
<p>他甚至总结出三条规范记在团队共享文档里：“1. 全局工具类存 <code>Application Context</code>；2. 界面相关操作必须传 <code>Activity Context</code> 且实时调用；3. 后台程序禁用界面类 <code>Context</code>。”</p>
<p>小安则发挥测试优势，设计了一套“全场景覆盖用例”，从前台操作、后台驻留、进程重启到低电量模式，反复测试，确保 <code>Context</code> 相关的崩溃和泄漏问题彻底绝迹。</p>
<p>周五傍晚的研发区渐渐安静，工位灯一盏盏熄灭，只剩林卓、老杨和小安的座位还亮着。小安一边收拾测试机一边随口说道：“林卓，张组长今天Review你提交的代码，跟我说‘这小子现在写的东西越来越稳了’，还追问是谁带的你呢。”</p>
<p>林卓刚改完最后一行注释，闻言抬头看向正在整理文档的老杨，脸上带着点不好意思的笑，从抽屉里摸出一瓶可乐递过去：“全靠杨工指点，不然我现在还在 <code>Context</code> 的迷雾里打转呢。”</p>
<p>老杨没直接喝，顺手把可乐塞进了口袋：“我不爱喝甜的。”</p>
<p>他端起搪瓷杯继续喝，褐色液体在杯壁上留下淡淡的渍痕。</p>
<p>“不是我指点得好，是你肯钻。”老杨放下杯子，杯底与桌面碰撞发出轻响，一股混杂着焦香和茶香的味道飘了过来，“技术这东西，光看理论没用，得自己试错才知道啥适合自己。”</p>
<p>小安正收拾到一半，抽着鼻子凑过来：“杨工，你这杯子里泡的啥呀？闻着不像纯茶。”</p>
<p>林卓也好奇地瞥了眼杯子里深褐色的液体，质地比茶水浓稠些。</p>
<p>老杨有点不好意思地挠挠头：“前几天赶版本熬大夜，困得慌就瞎兑的——绿茶加咖啡，提神劲儿翻倍。”</p>
<p>“啊？茶和咖啡混着喝？”小安眼睛瞪圆了，“那是什么奇怪味道？又苦又涩吗？”</p>
<p>“还行，喝惯了就好，比纯咖啡少点酸味儿，比浓茶多股劲儿。”老杨笑着摆手，把话题拉回技术。</p>
<p>他用这个例子打比方：“就像 <code>Context</code> 这知识点，背一万遍理论不如踩一次坑，踩一次坑不如解决一次问题。”</p>
<p>“就像 <code>Context</code> 这知识点，背一万遍理论不如踩一次坑，踩一次坑不如解决一次问题。”</p>
<p>他话锋一转说起正事，眼神里带着点期许：“对了，下周组里会来几个实习生，基础有点薄弱，我跟张组长合计过，让你带带它们。你趁这两天把Android四大组件的知识点过一遍，尤其是 <code>Activity</code> 和 <code>Service</code> 的生命周期——正好把你这段时间踩的坑，都转化成经验教给他们。”</p>
<p>林卓眼睛一亮，用力点头，手指无意识地摩挲着手机里的 <code>Context</code> 笔记——从前连 <code>Context</code> 类型都分不清的自己，如今居然能指导新人了，这种成长的踏实感格外真切。</p>
<p>他低头看向手机里刚整理的 <code>Context</code> 笔记，上面老杨的批注格外醒目：“<code>Context</code> 是应用的根，用对了是桥梁，用错了是陷阱。”</p>
<p>西二旗的研发区灯光透过玻璃窗洒下来，照亮了笔记上的字迹，也照亮了他从“踩坑者”到“引路人”的逆袭方向。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[nest.js / hono.js 一起学！开发前必备！]]></title>    <link>https://juejin.cn/post/7581448482544713754</link>    <guid>https://juejin.cn/post/7581448482544713754</guid>    <pubDate>2025-12-09T02:56:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581448482544713754" data-draft-id="7580197740963151898" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nest.js / hono.js 一起学！开发前必备！"/> <meta itemprop="keywords" content="前端,Node.js"/> <meta itemprop="datePublished" content="2025-12-09T02:56:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟祥_成都"/> <meta itemprop="url" content="https://juejin.cn/user/96412752684744"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nest.js / hono.js 一起学！开发前必备！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/96412752684744/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟祥_成都
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T02:56:16.000Z" title="Tue Dec 09 2025 02:56:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读29分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>欢迎到我们的交流群一起交流各种前端技术，同时欢迎访问我的 headless 组件库，同时感谢你的 star：</p>
<ul>
<li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fwww.frontlight.tech%2F" title="https://link.juejin.cn/?target=https%3A%2F%2Fwww.frontlight.tech%2F" target="_blank">国内官网</a></li>
<li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Flio-mengxiang%2Ft-ui" title="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Flio-mengxiang%2Ft-ui" target="_blank">感谢 github star</a></li>
</ul>
<hr/>
<p>nest.js / hono.js 一起学系列，最终会封装一个通用的架子，例如有鉴权，日志收集，多环境配置等等功能，用两种框架去实现。
之前写了两篇关于这两个框架编程思想相关的</p>
<ul>
<li><a href="https://juejin.cn/post/7576555431943503882" target="_blank" title="https://juejin.cn/post/7576555431943503882">深入 Nestjs 底层概念（1）：依赖注入和面向切面编程 AOP</a></li>
<li><a href="https://juejin.cn/post/7580564126403362866" target="_blank" title="https://juejin.cn/post/7580564126403362866">nest.js / hono.js 一起…</a></li>
</ul>
<p>这一篇主要是涉及到我们马上开发前需要具备的一些基础知识，包含：</p>
<ul>
<li>命令行工具使用</li>
<li>最佳工程实践（目录规划篇）</li>
<li>如何调试</li>
<li>docker 入门 + 深入 docker 基本原理</li>
</ul>
<h2 data-id="heading-1">命令行上手</h2>
<h3 data-id="heading-2">全局安装 CLI</h3>
<p>建议，全局安装 CLI， 然后试着创建一个项目试试：</p>
<pre><code class="hljs language-css" lang="css">npm <span class="hljs-selector-tag">i</span> -g <span class="hljs-keyword">@nestjs</span>/cli
nest new project-name
</code></pre>
<p>后续，你按照命令行提示即可完成项目初始化，然后安装完包，最后看一下 package.json 中 scripts 中的启动命令是什么，启动项目即可。</p>
<p>hono.js 初始化项目是采用：</p>
<pre><code class="hljs language-sql" lang="sql">npm <span class="hljs-keyword">create</span> hono<span class="hljs-variable">@latest</span> project<span class="hljs-operator">-</span>name
</code></pre>
<p>同样，你按照命令行提示即可完成项目初始化，然后安装对应的包即可，最后看一下 package.json 中 scripts 中的启动命令是什么，启动项目即可。</p>
<p>但是 hono.js 并没有类似 nest 的 cli 管理工具，毕竟 nest 的写法要繁琐很多，所以官方提供了一些快速创建模板的命令。可以通过以下命令查看：</p>
<pre><code class="hljs language-bash" lang="bash">nest --<span class="hljs-built_in">help</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3e3c9b3dd31474a853e6b51c3365065~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=wYeiPJuoEG94qx8PJq0%2F1sQmZ4M%3D" alt="image.png" loading="lazy"/></p>
<p>最常见的使用 generate 或者 g 来生成模板, 我们可以用 -d 命令，来让 cli 告诉你，你的 generate 或者 g 命令会生成什么文件，咱们来试试，假设我们要创建一个 名字为 user 的 class</p>
<pre><code class="hljs language-kotlin" lang="kotlin">nest g <span class="hljs-keyword">class</span> <span class="hljs-title class_">user</span> -<span class="hljs-title">d</span> 
</code></pre>
<p>显示：</p>
<pre><code class="hljs language-scss" lang="scss">CREATE <span class="hljs-attribute">src</span>/user/user<span class="hljs-selector-class">.spec</span><span class="hljs-selector-class">.ts</span> (<span class="hljs-number">139</span> bytes)
CREATE <span class="hljs-attribute">src</span>/user/user<span class="hljs-selector-class">.ts</span> (<span class="hljs-number">21</span> bytes)
Dry run enabled. No files written to disk.
</code></pre>
<p>注意最后一行： No files written to disk. 也就是没有真的把文件写入，而是提示如果你使用<code>nest g class user</code> 可能创建的文件有哪些。</p>
<p>还有，我们有时候不太喜欢测试，可以使用</p>
<pre><code class="hljs language-kotlin" lang="kotlin">nest g <span class="hljs-keyword">class</span> <span class="hljs-title class_">user</span> --<span class="hljs-title">no</span>-<span class="hljs-title">spec</span>
</code></pre>
<p>来省去测试文件的创建。</p>
<h2 data-id="heading-3">最佳工程实践</h2>
<p>我们这里列举一些比较好的工程实践的点，欢迎大家一起讨论。</p>
<h3 data-id="heading-4">工程目录</h3>
<p>我们采用”约定大于配置“的思想，无论使用什么 node.js 后端框架，我们的目录名尽可能一致。</p>
<p>nest.js 的建议，如果以下目录名意思不清楚没关系，后续学到控制器，service 等等章节的时候，就会明白了：</p>
<pre><code class="hljs language-ruby" lang="ruby">src/
├── modules/              <span class="hljs-comment"># 核心：按业务领域划分的模块</span>
│   ├── users/            <span class="hljs-comment"># 用户模块</span>
│   │   ├── dto/          <span class="hljs-comment"># 数据传输对象（请求/响应结构）</span>
│   │   ├── entities/     <span class="hljs-comment"># 数据库实体</span>
│   │   ├── users.controller.ts
│   │   ├── users.service.ts
│   │   └── users.<span class="hljs-keyword">module</span>.ts
│   └── products/         <span class="hljs-comment"># 产品模块（结构类似用户模块）</span>
├── common/               <span class="hljs-comment"># 共享资源</span>
│   ├── filters/          <span class="hljs-comment"># 全局异常过滤器</span>
│   ├── interceptors/     <span class="hljs-comment"># 拦截器</span>
│   └── guards/           <span class="hljs-comment"># 守卫</span>
├── config/               <span class="hljs-comment"># 全局配置</span>
├── database/             <span class="hljs-comment"># 数据库连接配置        </span>
└── app.<span class="hljs-keyword">module</span>.ts         <span class="hljs-comment"># 应用根模块</span>
</code></pre>
<p>核心设计原则：</p>
<ul>
<li>功能内聚：与“用户”相关的所有文件（控制器、服务、实体、DTO）都应放在 users 目录下。</li>
<li>分层管理：使用 common、core 等目录管理跨模块共享的组件和全局配置。</li>
</ul>
<p>hono.js 的建议如下，当然 config ,utils 这些比较常见的全局模块也可以提到第一层级，也就是 src 目录下：</p>
<pre><code class="hljs language-csharp" lang="csharp">src/
├── modules/                <span class="hljs-meta"># 每个模块独立</span>
│   ├── user/
│   │   ├── routes.ts       <span class="hljs-meta"># 只放路由注册（薄层）</span>
│   │   ├── controller/     <span class="hljs-meta"># handlers 控制器层</span>
│   │   │   ├── <span class="hljs-keyword">get</span>-user.ts
│   │   │   ├── list-users.ts
│   │   │   ├── create-user.ts
│   │   │   └── update-user.ts
│   │   ├── service/        <span class="hljs-meta"># 业务逻辑</span>
│   │   │   └── user.service.ts
│   │   ├── repository/     <span class="hljs-meta"># DB / 外部API</span>
│   │   │   └── user.repo.ts
│   │   ├── middleware/     <span class="hljs-meta"># 与 user 模块强相关的中间件</span>
│   │   │   └── user-auth.middleware.ts
│   │   ├── validators/     <span class="hljs-meta"># DTO / 校验器（zod / valibot）</span>
│   │   │   ├── create-user.validator.ts
│   │   │   └── update-user.validator.ts
│   │   ├── dto/            <span class="hljs-meta"># 请求 / 响应类型</span>
│   │   │   ├── user.dto.ts
│   │   │   └── index.ts
│   │   ├── constants.ts    <span class="hljs-meta"># 与 user 相关的常量</span>
│   │   ├── index.ts        <span class="hljs-meta"># 模块总出口</span>
│   │   └── types.ts        <span class="hljs-meta"># 模块相关类型</span>
│   │
│   ├── product/
│   │   ├── routes.ts
│   │   ├── controller/
│   │   ├── service/
│   │   ├── repository/
│   │   ├── middleware/
│   │   ├── validators/
│   │   └── dto/
│   │
│   └── auth/
│       └── ...
│
├── common/                 <span class="hljs-meta"># 全局复用层（不属于任何模块）</span>
│   ├── app.ts              <span class="hljs-meta"># app 初始化（全局中间件、错误处理）</span>
│   ├── router.ts           <span class="hljs-meta"># 合并 modules 的 routes</span>
│   ├── middlewares/        <span class="hljs-meta"># 全局中间件</span>
│   ├── config/             <span class="hljs-meta"># 配置（DB、ENV等）</span>
│   ├── utils/              <span class="hljs-meta"># 工具</span>
│   ├── errors/             <span class="hljs-meta"># 全局错误类</span>
│   ├── types/              <span class="hljs-meta"># 全局类型</span>
│   └── logging/            <span class="hljs-meta"># 日志系统</span>
|    <span class="hljs-meta"># 也可以把一些重要模块单独放在根目录，例如 config ， log</span>
│
└── index.ts                <span class="hljs-meta"># 启动文件</span>
</code></pre>
<p>注意：也可以把一些重要模块单独放在根目录，例如 config ， log等等，看业务需要。</p>
<p>最后，我们可以借鉴一下 angular 团队的一些代码风格指南。例如</p>
<ul>
<li>
<p>总则</p>
<ul>
<li>坚持每个文件只定义一样东西（例如服务或者组件）</li>
<li>考虑把文件大小限制在 400 行代码以内</li>
<li>坚持定义简单函数来组装复杂函数</li>
</ul>
</li>
<li>
<p>命名</p>
<ul>
<li>使用点和横杠来风格文件名，不建议驼峰</li>
<li>坚持在描述性名字中，用横杠分割单词</li>
<li>坚持遵守先描述组件特性，再描述它的类型的模式，例如 <code>feature.type.ts</code></li>
</ul>
</li>
</ul>
<h2 data-id="heading-5">调试</h2>
<p>接下来介绍一下，如何借助 vscode(其它编辑器，cursor，trae 是同样的方式)，来调试 nest.js 和 hono.js 代码</p>
<p>首先我们简单介绍一下如何调试单文件 node.js 文件，这个对于我们 demo 也算比较有用。</p>
<p>首先，随便在跟目录建一个 index.js</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c45d47e0ad943d790c6d0a8139d3c44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=yOeuyBtLV8icdUet5MkUMcBGtGs%3D" alt="image.png" loading="lazy"/></p>
<p>然后我们在第 6 行，打了一个断点，可以看到红色标记。然后再根目录，建立一个 .vscode 文件夹，文件夹内建立一个 launch.json</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2479c2b99bcf4a659b9474a83bc76302~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=KknRi82WS8CjI46HtBnJhc3ho7s%3D" alt="image.png" loading="lazy"/></p>
<p>接着点击 如下的 bug 按钮，就可以调试了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7dd4671a138a4eff9be825e236830162~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=FvNBsGJMUCkWds6vY4ykzaodzBc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">调试 nest</h3>
<p>调试 nest 和 hono 都很相似，只是 launch.json 的配置不一样，</p>
<p>我们 launch.json 的配置如下（调试 nest 的）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-comment">// 配置文件的版本号，遵循VSCode调试协议。0.2.0是当前常用版本。</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 定义调试配置的数组，一个文件可以包含多个独立的调试配置。</span>
  <span class="hljs-attr">"configurations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-comment">// 指定调试器类型。`node` 表示使用Node.js调试适配器，用于调试JavaScript/TypeScript。</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-comment">// 调试请求类型。`launch` 表示启动一个新程序进行调试；另一种是`attach`（附加到已运行进程， 这个不纠结，我们都用 launch）。</span>
      <span class="hljs-attr">"request"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"launch"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-comment">// 在VSCode调试下拉菜单中显示的名称，随便起个就行。</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Launch Program"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-comment">// 指定实际用来运行程序的命令。这里使用`pnpm`包管理器作为启动器。</span>
      <span class="hljs-comment">// 如果不设置此项，默认值为`node`。</span>
      <span class="hljs-attr">"runtimeExecutable"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pnpm"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-comment">// 传递给`runtimeExecutable`（pnpm）的命令行参数。</span>
      <span class="hljs-comment">// 等同于在终端执行：`pnpm run start:dev`</span>
      <span class="hljs-attr">"runtimeArgs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"run"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"start:dev"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-comment">// `runtimeVersion`主要用于通过`nvm`等版本管理器切换Node版本。</span>
      <span class="hljs-attr">"runtimeVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"20.16.0"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-comment">// 调试时跳过（不进入）的文件。</span>
      <span class="hljs-comment">// `&lt;node_internals&gt;/**` 表示跳过所有Node.js内置核心模块代码，使调试更聚焦于应用自身。</span>
      <span class="hljs-attr">"skipFiles"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"&lt;node_internals&gt;/**"</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这里的关键是什么呢，就是 runtimeExecutable + runtimeArgs， runtimeExecutable 代表我们执行的命令使用 pnpm, 你可以改为 yarn， npm，都行，然后执行的命令参数runtimeArgs，合起来就是</p>
<pre><code class="hljs language-arduino" lang="arduino">pnpm run start:dev
</code></pre>
<p>为什么这样呢，因为 start:dev 是 nest.js 的 package.json 中注明的启动开发环境的命令,如下：</p>
<pre><code class="hljs language-sql" lang="sql">"scripts": {
    "build": "nest build",
    "format": "prettier --write \"src<span class="hljs-comment">/**/</span><span class="hljs-operator">*</span>.ts\" \"test<span class="hljs-comment">/**/</span><span class="hljs-operator">*</span>.ts\"",
    "start": "nest start",
    "start:dev": "nest start --watch",
    "start:debug": "nest start --debug --watch",
    "start:prod": "node dist/main",
    "lint": "eslint \"{src,apps,libs,test}<span class="hljs-comment">/**/</span><span class="hljs-operator">*</span>.ts\" --fix",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:cov": "jest --coverage",
    "test:debug": "node --inspect-brk -r tsconfig-paths/register -r ts-node/register node_modules/.bin/jest --runInBand",
    "test:e2e": "jest --config ./test/jest-e2e.json"
  },
</code></pre>
<p>当然，你可以用 start 命令，start:debug 命令都行，假设就用</p>
<pre><code class="hljs language-perl" lang="perl"> // 指定实际用来运行程序的命令。这里使用<span class="hljs-string">`pnpm`</span>包管理器作为启动器。
      // 如果不设置此项，默认值为<span class="hljs-string">`node`</span>。
      <span class="hljs-string">"runtimeExecutable"</span>: <span class="hljs-string">"pnpm"</span>,
      <span class="hljs-regexp">//</span> 传递给<span class="hljs-string">`runtimeExecutable`</span>（pnpm）的命令行参数。
      // 等同于在终端执行：<span class="hljs-string">`pnpm run start:dev`</span>
      <span class="hljs-string">"runtimeArgs"</span>: [<span class="hljs-string">"run"</span>, <span class="hljs-string">"start:dev"</span>],
</code></pre>
<p>然后我们在 app.controller.ts 上打个断点：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22e4a980696b4ae8a32969ac00d971e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=BPXY5c9i2v2IuwJKzxFvL6yNvTQ%3D" alt="image.png" loading="lazy"/></p>
<p>然后启动调试</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac8175fe89d64b72ac1d012bf2de2cd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=yAXY6G2hgJeDVkCshKlu1aOKOfs%3D" alt="image.png" loading="lazy"/></p>
<p>点击后，相当于在命令行输入：</p>
<pre><code class="hljs language-arduino" lang="arduino">pnpm run start:dev
</code></pre>
<p>接着你浏览器访问 <code>http://localhost:3000</code> 就能触发断点了！</p>
<h3 data-id="heading-7">调试 hono</h3>
<p>所以根据上面的理论，我们来创建一个 launch.json，用来调试 hono</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"configurations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"request"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"launch"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Launch Program"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"runtimeExecutable"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pnpm"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 核心：告诉调试器用pnpm来运行</span>
      <span class="hljs-attr">"runtimeArgs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"run"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"dev"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 传给pnpm的参数：运行“dev”脚本</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>

</code></pre>
<p>同理，其实就是触发了：</p>
<pre><code class="hljs language-arduino" lang="arduino">pnpm run dev
</code></pre>
<p>命令， dev 这个命令其实就是 hono 项目 package.json 中的内容：</p>
<pre><code class="hljs language-json" lang="json">  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsx watch src/index.ts"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsc"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node dist/index.js"</span>
  <span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-8">容器部署</h2>
<p>接下来是很长的关于 docker 和我们前端全栈相关的知识，有深入的原理介绍，有兴趣的同学可以一起交流。</p>
<h3 data-id="heading-9">为什么需要 Docker？</h3>
<p>即便是纯前端开发者，不涉及 Node.js、Nginx 或数据库等服务器相关软件，在中小企业部署应用时，后端团队或项目经理常常会要求前端团队提供一个 Dockerfile，以便将前端应用部署到 Nginx 上。这种要求在容器化时代变得越来越普遍。所以是有必要了解容器的知识的。</p>
<h3 data-id="heading-10">容器化的基本概念</h3>
<p>在容器化时代，通常通过 Dockerfile（用于描述如何构建 Docker 容器的配置文件）构建开发或生产环境的 Docker 镜像，然后启动这些镜像，使外部网络可以访问对应的应用。</p>
<p>在 Docker 流行之前，前端应用的部署方式一般是直接在服务器上下载相关软件（如 Nginx、MySQL 或 PostgreSQL），配置并启动服务，再将打包后的前端内容放入 Nginx 的指定目录，以便外部访问。这种方式被称为物理机直接部署。</p>
<h3 data-id="heading-11">为何转向容器化部署？</h3>
<p>容器化部署的优势主要体现在以下两个方面，我们用前端的视角去理解：</p>
<ol>
<li><strong>环境一致性</strong>：</li>
</ol>
<ul>
<li>前端常见的问题，为什么在 Chrome 中功能正常，但在其他浏览器中却无法运行？</li>
</ul>
<ol start="2">
<li><strong>简化环境配置</strong>：</li>
</ol>
<ul>
<li>前端项目通常需要配置 ESLint、Prettier、TSConfig、Vite/Webpack 等工具。这些配置繁琐，且需要一定的知识才能定制适合项目的配置。为了解决这些问题，前端社区提供了许多 CLI 工具，如 React 的 create-react-app、Vue 的 Vue CLI、Next.js 的 @nextjs/cli 等，这些工具为项目提供了现成的模板，并在 Babel/SWC 和 Browserslist 的配置中解决了兼容性问题。</li>
</ul>
<p>同样，服务器端也面临环境一致性和配置繁琐的问题，并且这些问题相当棘手。为什么会这样呢？我们可以回顾一下 Docker 流行之前的 PaaS 项目。</p>
<h3 data-id="heading-12">PaaS 的背景</h3>
<p>PaaS（Platform as a Service）是云计算的重要服务模型，旨在提供一个完整的应用开发、运行和管理环境，使开发者能够专注于编写代码，而无需担心底层基础设施或操作系统。</p>
<h3 data-id="heading-13">PaaS 受欢迎的原因</h3>
<p>PaaS 项目受到广泛接纳的一个主要原因是它提供了“应用托管”能力。如今，许多人使用阿里云、腾讯云、AWS 等云服务，实际上就是将本地应用托管到云端。然而，这一部署过程常常会遇到云端虚拟机与本地环境不一致的问题。因此，当时的云计算服务竞争的焦点在于谁能更好地模拟本地服务器环境，从而提供更优质的“上云”体验。而开源 PaaS 项目的出现，正是为了有效解决这一问题。</p>
<h3 data-id="heading-14">docker 的出现</h3>
<p>正当大家比谁能更好模拟本地服务器环境的时候，docker 跳出来说，对不起，在做的各位都是垃圾。。。我能完全模拟本地服务器环境，嘿嘿！</p>
<p><strong>并且 docker 提供了非常便捷的打包机制，</strong> 并且这个压缩包包含了完整的操作系统文件和目录，也就是包含了这个应用运行所需要的所有依赖。只需：</p>
<pre><code class="hljs language-arduino" lang="arduino">docker build 打包自己的服务
docker run 启动自己的服务
</code></pre>
<p>如此，docker 轻松击败了 pass 本身的打包机制，后来逐渐使容器技术成为云服务的基础设施之一。</p>
<p>你可以想象，就跟前端使用 vite 和 webpack 一样，一键 <code>npm run build xxx</code> 打包后，你的前端应用能在各个浏览器上运行，并帮助我们解决了浏览器兼容性问题，如此便捷，谁能不喜欢这样的技术呢？</p>
<p>所以这个小节我们可以回答常见的面试题：</p>
<ul>
<li>为什么需要容器化 （docker）？</li>
</ul>
<p>既然 docker 这么好用，那 docker 镜像，docker 容器，docker 镜像仓库等等常见概念是什么意思呢？我们拿前端的 npm 包管理来帮助我们理解。</p>
<h2 data-id="heading-15">Docker 必需了解的基础概念</h2>
<h3 data-id="heading-16">1. Docker 镜像和 Docker 容器</h3>
<p>镜像（<code>Image</code>）和容器（<code>Container</code>）的关系，就像是面向对象程序设计中的 <code>类</code> 和 <code>实例</code> 一样，镜像是静态的定义，容器是镜像运行时的实体。</p>
<ul>
<li><strong>Docker 镜像</strong> 是一个特殊的文件系统，除了提供容器运行时所需的程序、库、资源、配置等文件外，还包含了一些为运行时准备的一些配置参数（如匿名卷、环境变量、用户等）。</li>
<li><strong>Docker 容器</strong>的实质就是一个进程，但是跟普通进程不一样的是，因此容器可以拥有自己的 <code>root</code> 文件系统、自己的网络配置、自己的进程空间，甚至自己的用户 ID 空间。容器内的进程是运行在一个隔离的环境里，使用起来，就好像是在一个独立于宿主的系统下操作一样。</li>
</ul>
<h3 data-id="heading-17">2. Dockerfile</h3>
<p>dockerfile 是一个文本文件，包含了一系列指令，一般我们都是用这个文件配合 docker build 命令来构建 docker 镜像。</p>
<h3 data-id="heading-18">3. Docker Client、Docker hub、Docker Daemon</h3>
<p>关系如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a570165d395b4ae7927cb22d8824e443~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=Jkiiqfu%2BDqq%2F89BYaaYnBznEq5A%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7885b08b51d74326a891fbaf1776b273~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=FLhngk35eljrOBOBGdauK%2FvhUSA%3D" alt="" loading="lazy"/></p>
<p>上图中涉及 3 个重要的概念</p>
<ul>
<li>Docker Hub：Docker Hub 是一个云端托管的Docker镜像库，用户可以在其中存储和共享 docker 镜像。它类似于 npm 仓库。</li>
<li>Docker Daemon：守护进程是一个后台服务，负责管理 docker 容器和镜像。它监听来自的 docker 客户端的命令，并执行相应操作。</li>
<li>Docker Client：允许用户与守护进程交互的命令行工具。</li>
</ul>
<h2 data-id="heading-19">【延伸补充】深入原理1：一定要理解 Docker 镜像的分层的原理</h2>
<p>上面我们说了，<strong>Docker 镜像</strong> 是一个特殊的文件系统，其中有一个特别重要的特性，称之为文件系统分层。为了说明这个原理，我们需要从 linux 本身的文件系统讲起。</p>
<p>首先 linux 启动的时候，首先加载的是 bootfs 文件系统，它包含了 boot 加载器和 kernel 内核。kernel 内核作用是什么呢？我们知道计算机是由硬件构成的，例如 cpu、主板、外设、内存等等，最终这些硬件会被操作系统接手管理，例如，将在硬盘的程序映射为一个个动态的进程，然后增加 cpu 调度算法，让每个进程按照特定的规则不断运行，还需要管理内存，不断的读取内存指令给 cpu 运行。。。</p>
<p>然后 linux 会挂在 rootfs 文件系统，什么是 rootfs 呢？作用是什么呢？我们知道在玩 windows 操作系统的时候，C 盘一般都是用来存储操作系统相关的文件的，例如 C 盘下的 Program Files 一般用来存放操作系统相关的配置文件。</p>
<p>而 linux 中的 rootfs 在初始化的时候，也是把操作系统相关的文件放入其中。linux 有很多不同的发行版本，例如 centos，ubantu 等等，他们都有自己的 rootfs，规则有所不同。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/460a739ec5904cf49ccf1ef798882f92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=O65Hc%2F%2F%2FaD9Lg2MZZ0F8yyhiLSo%3D" alt="" loading="lazy"/></p>
<p>而上面说的两个文件系统，在 docker 中，并不是混在一起的，而是如上图分层了的，这意味着，如果正在使用不同的 docker 镜像，他们最底层的 bootfs 很可能是一样的（相同的 linux 版本），那么这些镜像就可以共享这一层，而不是每个镜像都分别有一个 bootfs。</p>
<p>同理 rootfs 也是一样，如果我们使用的镜像都是基于 ubantu 的 linux 发行版本，版本号也是一样的话，那么 rootfs 也是可以共享的。</p>
<p>这样就会大大降低 docker 的体积，这也是为什么大家说 docker 轻量的原因。</p>
<p>docker 镜像本身提供的这些数据层是只读的，我们后续用 dockerfile 去自定义我们自己的镜像时，实在可读层上面加一个读写层，但是修改 docker 的，所以共享底层的数据层也不会影响我们定制化的 docker 镜像。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15b4b8bedf384df983393bdfe87b3b4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=KAp6f5ZN1Rw6QuAFT%2FEfTCb0Fac%3D" alt="" loading="lazy"/></p>
<p>为什么理解分层如此重要呢？我们举个例子（以下 dockerfile 文件每个命令是什么意思会详细讲解，现在不用在意），以下 docker file 中，我们注意 RUN 命令：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">FROM</span> ubuntu:<span class="hljs-number">20.04</span>

RUN apt<span class="hljs-operator">-</span><span class="hljs-keyword">get</span> <span class="hljs-keyword">update</span>
RUN apt<span class="hljs-operator">-</span><span class="hljs-keyword">get</span> install <span class="hljs-operator">-</span>y python3
RUN apt<span class="hljs-operator">-</span><span class="hljs-keyword">get</span> install <span class="hljs-operator">-</span>y python3<span class="hljs-operator">-</span>pip
RUN apt<span class="hljs-operator">-</span><span class="hljs-keyword">get</span> clean
</code></pre>
<p>这里执行了 4 个 RUN 命令，而每个 RUN 命令都会单独在 docker 镜像上建立一个单独的读写层，这样会增大构建后的 docker 镜像体积，我们可以将其合并：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">FROM</span> ubuntu:<span class="hljs-number">20.04</span>

RUN apt<span class="hljs-operator">-</span><span class="hljs-keyword">get</span> <span class="hljs-keyword">update</span> <span class="hljs-operator">&amp;&amp;</span> \
    apt<span class="hljs-operator">-</span><span class="hljs-keyword">get</span> install <span class="hljs-operator">-</span>y python3 python3<span class="hljs-operator">-</span>pip <span class="hljs-operator">&amp;&amp;</span> \
    apt<span class="hljs-operator">-</span><span class="hljs-keyword">get</span> clean <span class="hljs-operator">&amp;&amp;</span> \
    rm <span class="hljs-operator">-</span>rf <span class="hljs-operator">/</span>var<span class="hljs-operator">/</span>lib<span class="hljs-operator">/</span>apt<span class="hljs-operator">/</span>lists<span class="hljs-comment">/*
</span></code></pre>
<p>同样的，如果分层中，分层的内容没有变，docker 会重复利用这些已经打包好的层，什么意思呢？我们前端应用打包的时候，往往 package.json/package.lock.json 的依赖是没有变化的，所以我们如果能利用之前已经下载好的 npm 包的层，就不用重复下载了。</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 使用 Node.js 作为基础镜像</span>
FROM node:<span class="hljs-number">22</span>-slim

<span class="hljs-comment"># 将 package.json 和 package-lock.json 复制到容器中</span>
COPY <span class="hljs-keyword">package</span>*.json ./

<span class="hljs-comment"># 安装依赖（会在此层缓存 node_modules）</span>
RUN npm install

<span class="hljs-comment"># 复制应用程序的其他源代码到容器中</span>
COPY . .

<span class="hljs-comment"># 暴露应用程序运行的端口</span>
EXPOSE <span class="hljs-number">3000</span>

<span class="hljs-comment"># 启动应用程序</span>
CMD [<span class="hljs-string">"npm"</span>, <span class="hljs-string">"start"</span>]
</code></pre>
<p>以上我们会看到 <code>RUN npm install</code> 这一步，如果命令跟以前一样，会利用缓存，不会下载 npm 包，具体缓存规则，官方叙述如下（建议后续看完 dockerfile 章节后再回来看这部分，非常重要）：</p>
<p>在镜像的构建过程中，Docker 会遍历 <code>Dockerfile</code> 文件中的指令，然后按顺序执行。在执行每条指令之前，Docker 都会在缓存中查找是否已经存在可重用的镜像，如果有就使用现存的镜像，不再重复创建。如果你不想在构建过程中使用缓存，你可以在 <code>docker build</code> 命令中使用 <code>--no-cache=true</code> 选项。 但是，如果你想在构建的过程中使用缓存，你得明白什么时候会，什么时候不会找到匹配的镜像，遵循的基本规则如下：</p>
<ul>
<li>从一个基础镜像开始（<code>FROM</code> 指令指定），下一条指令将和该基础镜像的所有子镜像进行匹配，检查这些子镜像被创建时使用的指令是否和被检查的指令完全一样。如果不是，则缓存失效。</li>
<li>在大多数情况下，只需要简单地对比 <code>Dockerfile</code> 中的指令和子镜像。然而，有些指令需要更多的检查和解释。</li>
<li>对于 <code>ADD</code> 和 <code>COPY</code> 指令，镜像中对应文件的内容也会被检查，每个文件都会计算出一个校验和。文件的最后修改时间和最后访问时间不会纳入校验。在缓存的查找过程中，会将这些校验和和已存在镜像中的文件校验和进行对比。如果文件有任何改变，比如内容和元数据，则缓存失效。</li>
<li>除了 <code>ADD</code> 和 <code>COPY</code> 指令，缓存匹配过程不会查看临时容器中的文件来决定缓存是否匹配。例如，当执行完 <code>RUN apt-get -y update</code> 指令后，容器中一些文件被更新，但 Docker 不会检查这些文件。这种情况下，只有指令字符串本身被用来匹配缓存。</li>
</ul>
<p>一旦缓存失效，所有后续的 Dockerfile 指令都将产生新的镜像，缓存不会被使用。</p>
<h2 data-id="heading-20">【延伸补充】深入原理2：一定要理解什么是构建上下文</h2>
<p>上面有一个很容易混淆的路径问题，<code>COPY package*.json ./</code> 中 package*.json 指的并不是 docker build 命令的目录，也不是 <code>Dockerfile</code> 所在的目录，而是执行上下文的目录。执行上下文目录我们是在 docker build 的时候指定的，这里我们指定的 <code>.</code>，表示执行 docker build 命令时的目录。</p>
<p>为什么这个概念如此重要，很有可能你你设置的不对，根本找不到 package*.json，例如你这样</p>
<pre><code class="hljs language-bash" lang="bash">COPY ../package*.json ./
</code></pre>
<p><code>../package*.json</code>，指的是构建上下文上一层目录的 package*.json，其实是找不到的，因为我们将构建上下文复制到 docker host 的时候，docker 只会复制构建上下文内的内容（并且除开 .dockerignore file 指定的排除的内容）。</p>
<p>所以你在构建上下文之外找 package*.json，肯定是找不到的。</p>
<p>并且有相当多网上的人误以为 <code>.</code> 是指定 <code>Dockerfile</code> 所在目录呢？这是因为在默认情况下，如果不额外指定 <code>Dockerfile</code> 的话，会将上下文目录下的名为 <code>Dockerfile</code> 的文件作为 Dockerfile。</p>
<p>这只是默认行为，实际上 <code>Dockerfile</code> 的文件名并不要求必须为 <code>Dockerfile</code>，而且并不要求必须位于上下文目录中，比如可以用 <code>-f ../Dockerfile.php</code> 参数指定某个文件作为 <code>Dockerfile</code>。</p>
<p>当然，一般大家习惯性的会使用默认的文件名 <code>Dockerfile</code>，以及会将其置于镜像构建上下文目录中。</p>
<p>最后最最重要的就是需要写一份 .dockerignore 文件，例如，我们前端项目往往都有 node_modules 目录，而且体积相当大，所以没必要将其复制到 docker host。</p>
<ul>
<li>这会显著增加镜像的体积，从而影响镜像构建时间和传输效率。</li>
<li><code>node_modules</code> 中的某些依赖可能是平台相关的（例如，使用了原生代码或编译步骤），在不同的操作系统（如 Windows 和 Linux）上会有所不同。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/751edbf1964d4253a777394992781d8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=Kno%2FN33OujwUu5h4MQTmHus7seQ%3D" alt="" loading="lazy"/></p>
<p>好了，我们接着编写完 dockerfile 文件继续说。</p>
<p>然后，就可以运行 docker 镜像</p>
<pre><code class="hljs language-arduino" lang="arduino">docker run -d -p <span class="hljs-number">3000</span>:<span class="hljs-number">80</span> react-app
</code></pre>
<ul>
<li><code>-d</code>：以后台模式运行容器。</li>
<li><code>-p 3000:80</code>：将本地的 8080 端口映射到容器的 80 端口。</li>
</ul>
<p>然后本地访问 localhost: 3000，或者你的机器有外网地址，使用 &lt;外网地址&gt;: 3000，访问即可。</p>
<p>这里还会牵扯到一个需要深入讨论的内容，就是容器网络的原理，我们后续再谈。</p>
<p>这里我们总结一下一些常用的 docker 命令，帮助大家快速用起来 docker。</p>
<h3 data-id="heading-21">常用命令总结</h3>
<p><strong>下载镜像</strong>：docker pull &lt;镜像名&gt;，例如下载 node.js 22 版本的镜像</p>
<pre><code class="hljs">docker pull node:22-slim
</code></pre>
<p>注：可以用 docker hub 来搜索支持的版本。方法如下：</p>
<ul>
<li>进入docker hub的官网，地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhub.docker.com%2F" target="_blank" title="https://hub.docker.com/" ref="nofollow noopener noreferrer">hub.docker.com</a></li>
<li>然后搜索需要的镜像：</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3988f9ef8e46490ab302e31d3871e483~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=FD2TnK6Lpe1Bne3QaP8KKcKh0vA%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>查看镜像支持的版本：</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eac86c6febf940ce994e34bd32a0f5e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=dxY5IlqwXvRbaKbeAl8j%2F5%2BqX%2Fs%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<p><strong>列出镜像：</strong></p>
<pre><code class="hljs">docker images 
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38688a35f24a4f9b92c81398c2ba463d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=IafRLnpcdUvZBbkcYRHmrYb6cno%3D" alt="" loading="lazy"/></p>
<p><strong>删除镜像</strong>：docker rmi -f &lt;镜像名&gt;，例如：</p>
<pre><code class="hljs">docker rmi -f nginx
</code></pre>
<p><strong>新建并启动容器：docker run -d -p &lt;本地端口&gt;:&lt;容器端口&gt; &lt;镜像名&gt;，例如</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">docker run -d -p <span class="hljs-number">80</span>:<span class="hljs-number">80</span> --name nginx nginx:<span class="hljs-number">1.17</span><span class="hljs-number">.0</span>
</code></pre>
<ul>
<li>
<p>-d 选项：表示后台运行</p>
</li>
<li>
<p>--name 选项：指定运行后容器的名字为nginx,之后可以通过名字来操作容器</p>
</li>
<li>
<p>-p 选项：指定端口映射，格式为：hostPort:containerPort</p>
</li>
</ul>
<p><strong>列出容器：</strong></p>
<pre><code class="hljs">docker ps
</code></pre>
<p><strong>查看运行中的容器</strong>：</p>
<pre><code class="hljs">docker ps
</code></pre>
<p>如果加入 -a 参数，即使暂停的容器也会被列出来。</p>
<p><strong>停止容器</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">docker stop &lt;容器ID | 容器名字&gt;
</code></pre>
<hr/>
<p><strong>删除容器</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">rm</span> &lt;容器ID | 容器名字&gt;
</code></pre>
<p><strong>在宿主机查看docker使用cpu、内存、网络、io情况：</strong></p>
<pre><code class="hljs language-xml" lang="xml">docker stats <span class="hljs-tag">&lt;<span class="hljs-name">容器ID</span> | <span class="hljs-attr">容器名字</span>&gt;</span>
</code></pre>
<p><strong>进入Docker容器内部的bash</strong></p>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">exec</span> -it &lt;容器名字&gt; /bin/bash
</code></pre>
<p>注意，有的镜像里面没有 bash 命令，例如 nginx，可以将 /bin/bash 改为 /bin/sh</p>
<p>以上的知识，足够前端应付常见的场景了，遇到问题搜索一下，看懂也不是难事。其实容器的网络，是比较特殊的，因为容器实际上看起来是有自己独立的文件系统，独立的网络，独立的进程的（也就是在容器中，你会看懂容器进程的 id 是 1）等等。</p>
<p>既然有自己独立的网络，那么容器的网络如何跟外界打通，原理又是什么呢？（这个问题特别重要，无论对于你自己本地调试，还是生产环境解决容器无法访问的问题）</p>
<p>既然有自己独立的文件系统，那么容器销毁，容器里面的文件也随之销毁，那么容器如何做到将文件跟物理机上的文件系统共享的呢？</p>
<h2 data-id="heading-22">【延伸补充】深入原理3：docker 容器的底层三大核心技术</h2>
<p>三大核心技术分别是 namespace、Cgroup 以及联合文件系统，联合文件系统上面已经讲了，现在就剩下 namespace 和 Cgroup 了。我们先来看看 pid namespace 是什么。</p>
<p>首先再次强调，容器就是一个进程。举个例子</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9caf1f5712394135bd6b369da0e82fdd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=IUHJUSoVcTJf%2FK2%2FPPFFPFMXH0A%3D" alt="" loading="lazy"/></p>
<p>我们首先使用以下命令来获取到容器的进程 id 为 2526</p>
<pre><code class="hljs language-bash" lang="bash">docker inspect &lt;容器 <span class="hljs-built_in">id</span>&gt; | grep Pid 
</code></pre>
<p>然后使用 ps 命令来过滤出 2526 进程</p>
<pre><code class="hljs language-perl" lang="perl">ps -ef | <span class="hljs-keyword">grep</span> <span class="hljs-number">2526</span>
</code></pre>
<p>发现确实有对应的进程。</p>
<p>但是跟普通进程不一样的是，容器的进程利用 namespace 技术，让我们进入容器后，发现容器主进程的 pid 是 1 ，而不是 2526。也就是容器使用了"障眼法"，来让自己跟别的容器都隔离开。就拿进程隔离来说，容器是如何修改进程视图的呢？如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0ce66bf43fd47d09fe3052a5b27d14c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=9tkQXP8lYTyx9Wi9GjGU5CD4vCU%3D" alt="" loading="lazy"/></p>
<p>如上图，1、2、3、4、5、6、7、8、9、10，都是在物理机操作系统上的进程号（PID），而进入容器后，PID 8 是容器的主进程，linux 将其修改为进程号（PID）为 1，子进程也同样修改 PID，这样你在容器里，看到主进程是 PID 1，但是你退出容器，查看这个容器的进程号，就是 8。</p>
<p>namespace 不仅仅隔离了进程的 pid，还包括网络、用户、IPC 等等。接着我们看看 Cgroup 是什么。</p>
<p>你想想，虽然视图可以改变，但是却没法限制这个容器对 cpu 的使用，所以是有可能单个容器把 cpu 跑满的。所以如果能限制 cpu、内存的使用就更好了，Cgroup 就是做这个事的。</p>
<p>Cgroup 的原理如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40a2e69605244305bc66a7e45fb5b267~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=9y8Zn7iHzfraJpWX37bPGDJoWfQ%3D" alt="" loading="lazy"/></p>
<p>Cgroup 对不同资源进行了分组，例如 cpu 总共是 100%，假设分配给某个容器是 25%，当你进入容器中，你看到的自己 cpu 总共是 100% ，也就是这个容器里的 100% 是假的，其实是从真实的 25% 里面去分的。</p>
<p>Cgroup 如何操作是有对应的 linux 命令的，这里我们就不深入了，因为性价比并不高，用好 docker 就可以了。</p>
<h2 data-id="heading-23">【延伸补充】深入原理4：docker 容器网络的秘密</h2>
<p>为了更通俗的解释 docker 的桥接网络，我们先从计算机网络基本的知识讲起：</p>
<p>如下图，只需要一根网线相互连接，然后在计算机上配置一下自己的 ip 地址（在一个网段里），两台计算机就可以相互通信了。例如 A 计算机的 ip 我们写死 ip 到网卡，地址为 192.168.1.1/24，B 计算机是 192.168.1.2/24 ，他们都是 192.168.1.xxx 网段。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8d93afb2a4e41fcaab4fc1775deb8ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=sDm3sjgDlsFnfCwugXRdy%2B8RmjE%3D" alt="" loading="lazy"/></p>
<p>有些同学可能不理解，为啥要分配 ip 地址？因为我们很多通信协议是基于 ip 协议的，例如 http，tcp。所以必须分配 ip 地址，才能让数据包走出网卡。我们接着聊:</p>
<p>现在我们多加一些电脑，这时候一根网线肯定就不够了，我们就加入一个交换机（虚拟交换机是有 ip 的，但是现实生活中的交换机是没有 ip），如下图</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8329e75a78ee43bd83f814a96565e1e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=%2B7BU4vfRoF7tpIT3h7fF8fwW2OE%3D" alt="" loading="lazy"/></p>
<p>假设交换机的 ip 是 192.168.1.1/24，这个交换机还可以自动分配 ip（dhcp协议），只要计算机连接交换机，就会自动分配一个不重复的 ip 地址，那么多台计算机互相通信就解决了。</p>
<p>其实 docker 内部默认有一个叫做 docker0 的网桥，这个网桥工作机制就跟我们上面说的交换机类似。而容器默认情况下，会连接 docker 0 网桥。如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32d6362471ac450492a7a8be0f5f9368~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=HHoBlHiBNSVLrarn8RgpPDg8AmE%3D" alt="" loading="lazy"/></p>
<p><strong>这样容器之间互通的问题我们就解决了。</strong></p>
<p>那么如何解决容器跟外部网络通信的问题，例如某个容器去访问微信登录。</p>
<p>如下图，其实 docker0 是连接到我们真实物理机的网卡 eth0 来转发数据，从而让容器的数据通过 -&gt; docker0 -&gt; eth0 发送到计算机外部</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/619e592a6b874215b0bcb41f17da744f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=PZPhQEYZ91jX7fsMbKKyTY4fADw%3D" alt="" loading="lazy"/></p>
<p>这里又有问题了，容器内部的 ip 往往是一个内部地址，什么是内部地址？你会看到，我们前端启动前端应用，经常看到启动的 ip 地址是 192.168.x.x，你回到家启动前端应用分配的地址居然是一样的 192.168.x.x。我们知道 ip 地址必须全网唯一，为啥在家里分配的 ip 和在公司分配的 ip 一样呢？</p>
<p>这是因为 ip 地址规定了一些只能在内网通讯的地址，不能用在外网，例如 192.168.x.x 就是不会用在外部网络访问的 ip 地址。</p>
<p>这对于 docker 容器访问外部网络就有问题了，你想想 docker容器 -&gt; docker0 -&gt; eth0 将数据包传给了微信服务器，微信服务不能说我回传的 ip 地址是 docker容器的 ip，因为 docker容器的 ip 是内部地址，不能在网络上传输。</p>
<p>这里又涉及一个概念，叫 nat 转换，也就是 docker 容器将数据包传给 eth0 的时候，会改写自己数据包发送端的 ip 地址为 eth0 的公网地址。</p>
<p><strong>这样就解决了容器访问外部网络的问题了。</strong></p>
<p>问题又来了哦，那返回给 eth0 的数据，如何知道这个数据包最终转发给哪个容器呢？这里涉及到一个叫做 iptables 的工具（NAT 转换也是依赖它），它可以记录转发规则，例如如果这个数据是从 80 端口出去的，那么返回的时候，就返回给 A 容对应的内部 ip。</p>
<h2 data-id="heading-24">【延伸补充】深入原理5：docker 容器文件隔离和共享的秘密</h2>
<p><strong>文件隔离</strong></p>
<p>docker 容器的文件系统是跟宿主机隔离的，在 docker 里，我们能看到一份独立的文件系统。linux 如何实现的呢？</p>
<p>实际上 linux 也是用了障眼法做到的，如下图，首先假设下图是正常的某台 linux 机器的目录结构：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2ba4a7f3e82450689860ceac12ac9a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=lVn%2Fidbfvt6nXwvpv6%2BgosHvcVs%3D" alt="" loading="lazy"/></p>
<p>然后我们希望 docker 容器跟 joe 目录（最右边最后一个目录）拿来作为容器的根目录，使用 linux 的 Mount Namespac 功能 + chroot 命令，结果如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/224342bce84c4d8f808c3cdcf12aa387~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765853776&amp;x-signature=mzAa52GcFrI1Yv92LJOZUEVqALw%3D" alt="" loading="lazy"/></p>
<p>容器的根目录，挂载到了宿主机的 joe 目录。由于 Mount Namespace 技术的特性，这个容器的根目录对于宿主机是看不见的。</p>
<p>而这在某些情况下不是我们想要的。比如数据库文件，我们想留在宿主机上，这样重启容器的时候，依然保留了数据库的数据。</p>
<p>而这里要使用到的挂载技术，就是Linux的<strong>绑定挂载（bind mount）机制</strong>。它的主要作用就是，允许你将一个目录或者文件，而不是整个设备，挂载到一个指定的目录上。并且，这时你在该挂载点上进行的任何操作，只是发生在被挂载的目录或者文件上，而原挂载点的内容则会被隐藏起来且不受影响。</p>
<p><strong>文件共享</strong></p>
<p>由于容器的特性，如果容器删除，那么容器里的数据也会删除，之前的挂载功能也会解除。可是在某些情况下，我们希望保留容器里的数据，例如数据库，方便再下一次启动镜像的时候能共享之前容器的数据。</p>
<p>这个功能在 docker 叫做绑定 <strong>Volume 功能。</strong> 这个功能的实现其实很简单，之间我们讲的绑定挂载，其实需要分为两步，第一步开启 Mount Namespace，此时容器内部仍然可以看到宿主机的目录，但是宿主机看不到容器的目录，第二步执行类似 chroot 命令，可以简单理解为执行后，容器就看不到宿主机目录了。</p>
<p>所以我们可以在第一步之前，把 Volume 指定的宿主机目录（比如/home目录），挂载到指定的容器目录（比如/test目录）在宿主机上对应的目录上，这个 Volume 的挂载工作就完成了。</p>
<h2 data-id="heading-25">最后补充</h2>
<p>补充，之前前端部署的 dockerfile 一般都会用分阶段构建的方法，首先借助 node.js 镜像打包前端应用，然后将打包好的内容放入 nginx 镜像中，最后借助 nginx 作为 web 服务器，来让外网访问。我们简单实现一下，可用在生产环境：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Use the official Node.js runtime as the base image</span>
FROM node:20-slim as build

<span class="hljs-comment"># Set the working directory in the container</span>
WORKDIR /app

<span class="hljs-comment"># Copy package.json and package-lock.json to the working directory</span>
COPY package*.json ./

<span class="hljs-comment"># Install dependencies</span>
RUN npm install

<span class="hljs-comment"># Copy the entire application code to the container</span>
COPY . .

<span class="hljs-comment"># Build the React app for production</span>
RUN npm run build

<span class="hljs-comment"># Use Nginx as the production server</span>
FROM nginx:alpine

<span class="hljs-comment"># Copy the built React app to Nginx's web server directory</span>
COPY --from=build /app/build /usr/share/nginx/html

<span class="hljs-comment"># Expose port 80 for the Nginx server</span>
EXPOSE 80

<span class="hljs-comment"># Start Nginx when the container runs</span>
CMD [<span class="hljs-string">"nginx"</span>, <span class="hljs-string">"-g"</span>, <span class="hljs-string">"daemon off;"</span>]
</code></pre>
<p>需要注意的是</p>
<pre><code class="hljs language-bash" lang="bash">COPY --from=build /app/build /usr/share/nginx/html
</code></pre>
<p>--from build , 这个 build 就是 <code>FROM node:20-slim as build</code> 中，node.js 镜像的别名。意思是把这个镜像中 /app/build 目录下的文件复制到 nginx:alpine 镜像的 /usr/share/nginx/html 文件夹下。</p>
<h2 data-id="heading-26">欢迎加入交流群</h2>
<p>欢迎大家一起进群讨论前端全栈技术和 ai agent ，一起进步！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据库AI方向探索-MCP原理解析&DB方向实战｜得物技术]]></title>    <link>https://juejin.cn/post/7581670270844174376</link>    <guid>https://juejin.cn/post/7581670270844174376</guid>    <pubDate>2025-12-09T08:55:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581670270844174376" data-draft-id="7581415427516661802" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据库AI方向探索-MCP原理解析&amp;DB方向实战｜得物技术"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-12-09T08:55:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="得物技术"/> <meta itemprop="url" content="https://juejin.cn/user/2392954206960247"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据库AI方向探索-MCP原理解析&amp;DB方向实战｜得物技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392954206960247/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    得物技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T08:55:49.000Z" title="Tue Dec 09 2025 08:55:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读40分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、MCP设计理念</h2>
<p>在浅析 MCP 原理之前，有必要搞清楚两个问题：<strong>MCP 是什么？为什么会出现？</strong> 以此明晰它存在的价值和意义。</p>
<p>首先，MCP（Model Context Protocol，模型上下文协议）是由人工智能公司 Anthropic 主导推出的一种<strong>开放标准协议，旨在统一大型语言模型（LLM）与外部数据源、工具及服务之间的交互方式</strong>。该协议<strong>通过JSON-RPC 2.0 标准消息格式</strong>定义通信规则，使模型能像使用"万能接口"（类比 Type-C 接口）一样即插即用地连接异构资源。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74f31e19dded49d8b56103dc2523e504~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=qXKKS6mABMUC3yGTTRPZnCB5s%2Fc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>图片来源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F598749792" target="_blank" title="https://zhuanlan.zhihu.com/p/598749792" ref="nofollow noopener noreferrer">zhuanlan.zhihu.com/p/598749792</a></p>
<p>其架构采用<strong>客户端-服务器模式，包含三个关键组件</strong>： </p>
<ul>
<li><strong>MCP Host</strong>：运行大模型应用（如 Cursor、Cline、Cherry Studio、Claude Desktop 等），负责发起任务请求。</li>
<li><strong>MCP Client</strong>：集成在 Host 中的协议客户端，解析任务需求并与服务器协调资源调用。</li>
<li><strong>MCP Server</strong>：<strong>轻量级</strong>服务程序，动态注册与暴露本地资源（例如文件、数据库）或远程服务（如云API），处理客户端请求并返回结构化数据，同时提供安全控制，包括访问权限管理和资源隔离。</li>
</ul>
<p>简单概括为 MCP 是一种开放标准，本质是应用层协议（Protocal），跟我们熟知的 TCP/IP，HTTP 协议类似。借助它开发者可以安全地在数据源和 AI 工具之间建立双向连接。其架构概括起来就是：</p>
<ul>
<li><strong>开发者可以通过 MCP 服务器公开他们的数据；</strong></li>
<li><strong>AI 应用（MCP 客户端） 可以连接到 MCP 服务器，获取所需数据，LLMs 再分析投喂的数据。</strong></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2a345ca9dbd4ff9851b7b321178f042~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=TRBAEFK%2B%2BCasoc7fVFlxszzXMK8%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>那为什么会出现呢？这就要说到<strong>RAG和Function Calling</strong> 技术了。</p>
<p><strong>RAG（检索增强生成）</strong> 通过检索外部知识库获取与问题相关的实时信息并将其注入模型提示词，生成更精准、时效性更强的回答。 <strong>其工作原理为</strong>：当用户发出提问时，AI 应用通过向量检索、关键词匹配等方式，从外部知识库或数据源中搜索相关信息，再把检索到的信息作为上下文提供给大模型，让大模型基于补充的信息进行回答。<strong>技术流程：</strong> 用户提问→问题向量化→向量数据库相似度检索→拼接上下文提示词→模型生成答案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c83eef56bd64d45b58a24f1d8e244f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=O21RxrzyhDSnSU8%2B8t4wFp%2BuKhs%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>图片来源：ailydoseofds</p>
<p>而<strong>Function Calling（函数调用）</strong> 拓展了模型执行动作的能力，解决纯文本交互的局限性，即模型解析用户意图后生成结构化指令，调用预定义外部函数或 API（如发送邮件、查询天气）。<strong>其工作原理为</strong>：当用户发出提问时，应用会将集成的函数列表作为上下文发送给大模型。<strong>大模型根据用户输入判断应调用的函数，并生成相应的调用参数。随后，应用执行该函数并将结果发送给大模型，作为补充信息供其生成最终的总结或回答。技术流程</strong>：用户指令→ 模型识别需调用的函数→ 生成参数化调用指令→ 外部系统执行→ 返回结果至模型→ 生成用户响应。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d27ecb8622774e31a9d55f343b2cf835~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=IOrPuYT00cXNEtB76jxJ8puWxUs%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>图片来源：ailydoseofds</p>
<p>但不同的 API 需要封装成不同的方法，且参数确定后，后期变更困难，很难在不同的平台灵活复用。  而我们可以认为，MCP 是在 Function Calling 的基础上做了进一步的抽象，目的是让应用更加简单、高效、安全地对接外部资源，更好地为大模型补充上下文信息。总结起来就是，MCP 把大模型运行环境称作 MCP Client，也就是 MCP 客户端，同时，把外部函数运行环境称作 MCP Server，也就是 MCP 服务器，然后，统一 MCP 客户端和服务器的运行规范，并且要求 MCP 客户端和服务器之间，也统一按照某个既定的提示词模板进行通信。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59cb5bafe20c4e9789aec4cf53229b4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=BDXwn2lvg1fRwAuCKYEQ2PK0Mxc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>MCP vs Function Calling 对比：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dec37bae08374502b247877f4b91eced~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=5xv0r5R54HDaJDRztnE1EGaFzoM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>综上，RAG与Function Calling 互补，前者用于知识检索，后者用于执行操作，二者均可提升模型实用性，但目标维度不同，且存在难集成，扩展性差的问题，开发者往往需为不同模型重复实现工具调用逻辑。</p>
<p><strong>MCP 则是对两者的整合与标准的规范化：</strong></p>
<ul>
<li><strong>标准化接口</strong>：MCP 为 RAG 的检索源接入（如数据库、文档库）和 Function Calling 的工具调用（如 API 服务）提供统一接入规范，避免为每个工具开发定制化适配。 比如 MCP 工具的inputSchema可定义多个参数，通过required标记必传参数。大模型在解析用户提问时，会根据工具的描述和参数定义，自动解析并提供相应参数值来调用工具。这种参数化设计方式提高了工具调用的灵活性，降低了 Function Calling 的开发复杂度。</li>
</ul>

<pre><code class="hljs language-lua" lang="lua"><span class="hljs-keyword">return</span> Tool(
    name=<span class="hljs-built_in">self</span>.name,
    description=<span class="hljs-built_in">self</span>.description,
    inputSchema={
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
        <span class="hljs-string">"properties"</span>: {
            <span class="hljs-string">"host"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"数据库主机地址"</span>},
            <span class="hljs-string">"port"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"integer"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"数据库端口"</span>},
            <span class="hljs-string">"user"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"数据库用户名"</span>},
            <span class="hljs-string">"password"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"数据库密码"</span>},
            <span class="hljs-string">"database"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"数据库名称"</span>}
        },
        <span class="hljs-string">"required"</span>: [<span class="hljs-string">"host"</span>, <span class="hljs-string">"port"</span>, <span class="hljs-string">"user"</span>, <span class="hljs-string">"password"</span>, <span class="hljs-string">"database"</span>]
    }
)
</code></pre>
<ul>
<li><strong>能力扩展</strong>：</li>
<li>
<ul>
<li>RAG 通过 MCP 接入实时数据流（如证券行情），突破静态知识库限制；</li>
<li>Function Calling通过 MCP 调用异构工具（如 IoT 设备），无需依赖特定模型的支持。</li>
</ul>
</li>
</ul>

<ul>
<li><strong>系统效率</strong>：MCP 降低开发复杂度（如开发者无需为不同模型重复实现工具调用逻辑），促进工具生态共享。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f6b876f522f42c6a42ea7fda515ca11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=fwfts7tQjWrE4gncBcspiVDLKao%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>技术演进总结</strong>：</p>
<ul>
<li>RAG → Function Calling → MCP 代表了 AI 能力的三个重要维度：从静态知识检索到动态行动执行，再到标准化生态构建，标志着 AI 从知识增强到行动扩展再到生态标准化的发展趋势。</li>
<li>在 AI Agent 架构中：RAG 充当知识中枢，Function Calling 为执行手段，MCP 则是连接内外的“神经枢纽”。</li>
<li><strong>未来意义</strong>：MCP 的开放性将加速工具互操作性，推动复杂任务（如多 Agent 协作）的规模化落地，成为 AI 基础设施的关键组件。</li>
</ul>
<h2 data-id="heading-1">二、MCP 架构详解</h2>
<p>了解 MCP 存在的价值后，我们还需要定位 MCP 在整个 AI 体系中所处的位置，如以 Agent 为例：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e03f1b22573640d89fe8bab08ebeb377~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=JhtFb7mDb7CgmWyyAlDocaqbolU%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>了解完其在生态中所处的位置后，本节将结合 Python 版 SDK 源码和开源 MCP for DB 项目解读如何运用 MCP 以此了解其架构原理及使用方法。MCP Python SDK 提供了一个分层架构，通过多种传输协议将 LLM 应用程序连接到 MCP 服务器，同时具有高级和低级开发 API。</p>
<p>参考项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FEliot-Shen%2FMCP-DB-GPT" target="_blank" title="https://github.com/Eliot-Shen/MCP-DB-GPT" ref="nofollow noopener noreferrer">github.com/Eliot-Shen/…</a></p>
<p>Python SDK：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmodelcontextprotocol%2Fpython-sdk" target="_blank" title="https://github.com/modelcontextprotocol/python-sdk" ref="nofollow noopener noreferrer">github.com/modelcontex…</a></p>
<h3 data-id="heading-2">2.1MCP运行过程</h3>
<p>在此之前，有必要对 MCP 整体运行有个宏观上的认知，如下图所示，首先，需用户在主机上配置 MCP 服务，比如借助 VSCode 插件 Cline，根据使用的协议配置好 JSON文件即可。然后，用户输入问题，客户端让大语言模型选择 MCP 工具，大模型选择好工具后，客户端寻求用户同意，然后再请求 MCP 服务器， MCP 服务器调用工具并将工具的结果返回给客户端，客户端将模型调用结果和用户的查询发送给大语言模型，大语言模型组织答案给用户。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb752df059f6441cad887e2257e6820b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=b7GUZlDlmC0DX8XCILVr4CseCZ4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>可见，整个流程中最核心的部分就是<strong>Client 和 Server的交互</strong>，而在使用像 Cline 这种主机端软件时，整体感知如下图，Client 已经被嵌在 MCP Host 中，只需开发出对应的 MCP Server，在主机中配置好 JSON即可使用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9013370e13eb4d62a5c47895d684da5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=7oqjho3E1IUGnUW771YPC4guyoU%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>接下来将结合项目和 SDK 源码详细解读 MCP 架构原理。</p>
<h3 data-id="heading-3">2.2MCP运行原理</h3>
<p>MCP Server作为 MCP 架构的核心部分，在提升AI应用性能方面发挥着不可替代的关键作用。其 Python 版 SDK 提供的框架图如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94d71e641dde4fc2b8087a79642f4e9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=InGZ%2FYZuwlRBZmpQucE3l21LfPc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>我们着重关注其提供的三大核心功能</strong>：资源@mcp.resource、工具@mcp.tool、提示词@mcp.prompt。而这三大核心功能之间的协作逻辑大致如下：</p>
<ul>
<li><strong>资源为工具提供上下文</strong>：手动注入资源可增强模型对任务的理解（如提供参考文档）辅助其更准确调用工具。</li>
<li><strong>工具执行依赖资源输入</strong>：当工具操作外部数据时，如文件处理工具，可将指定文件 URI 作为工具参数输入。</li>
<li><strong>提示词封装工具与资源调用</strong>：复杂 Prompt 可预设工具调用顺序或资源使用规则，形成自动化工作流。</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 在工具中封装提示词模版存在的问题是该工具不一定能被LLM调用，导致不一定能达到预期效果，但使用cline这中客户端，服务端的提示词又不能被加载调用</span>
async def run_tool(self, arguments: Dict<span class="hljs-section">[str, Any]</span>) -&gt; Sequence<span class="hljs-section">[TextContent]</span>:
    <span class="hljs-attr">prompt</span> = f<span class="hljs-string">"""
            - Workflow:
              1. 解析用户输入的自然语言指令，提取关键信息，如表描述和查询条件。
              2. 判断是否跨库查询、是否明确指定了目标表名（例如是中文的描述、英文的描述，偏向语义化的描述则判断为未明确表名）
              3. 未明确指定目标表名则调用“get_table_name”工具，获取对应的表名。
              4. 调用“get_table_desc”工具，获取表的结构信息。
              5. 根据表结构信息和用户输入的查询条件，生成SQL查询语句并调用“execute_sql”工具，返回查询结果。
            - Examples:
              - 例子1：用户输入“查询用户表张三的数据”
                解析结果：表描述为“用户表”，查询条件为“张三”。
                判断结果：1.没有出现跨库的情况 2.未明确指定表名，当前为表的描述，需调用工具获取表名
                调用工具“get_table_name”：根据“用户表”描述获取表名，假设返回表名为“user_table”。
                调用工具“get_table_desc”：根据“user_table”获取表结构，假设表结构包含字段“id”、“name”、“age”。
                生成SQL查询语句：`SELECT * FROM user_table WHERE name = '张三';`
                调用工具“execute_sql”：根据生成的SQL,获取结果。
                查询结果：返回张三的相关数据。
            - task: 
              - 调用工具“get_table_name”，
              - 调用工具“get_table_desc”，
              - 调用工具“execute_sql”
              - 以markdown格式返回执行结果
            """</span>
    
    return <span class="hljs-section">[TextContent(type="text", text=prompt)]</span>
</code></pre>
<p><strong>但出于安全考虑，大模型对资源/工具的访问能力受到限制：</strong></p>
<ul>
<li><strong>工具：支持自主调用</strong>。大模型通过解析服务端公开的工具描述，能主动发起工具调用请求 ，无需用户逐条指令干预。此能力依赖模型的 Function Calling 支持，否则需通过提示词工程实现。</li>
<li><strong>资源：禁止自主访问</strong>。资源始终由应用层或用户管控 ，模型仅能使用已注入的资源内容。避免模型随意访问敏感数据，保障安全性。</li>
</ul>
<p><strong>资源（Resources）</strong></p>
<p>资源是指由 MCP Server 向客户端提供的数据实体，这些实体作为统一的信息载体，旨在扩展 AI 模型的数据访问边界，并支撑其对动态、结构化与非结构化数据的实时处理能力。<strong>类似于 REST API中的 GET 端点</strong>——提供数据，但不应执行大量计算或产生副作用。</p>
<p>资源代表任何可供 AI 模型读取的数据形式，是你向LLM 暴露数据的方式，涵盖：</p>
<ul>
<li><strong>文件内容</strong>：包括文本文件、JSON、XML 等结构化文档，以及源代码、配置文件等文本数据（UTF-8 编码）。</li>
<li><strong>数据库记录</strong>：关系型或非关系型数据库查询结果（e.g. PostgreSQL或MySQL）。</li>
<li><strong>动态系统数据</strong>：包括实时日志、屏幕截图、多媒体（图像、视频）、传感器输出等二进制数据。</li>
</ul>
<p><strong>如 MCP-DB-GPT 项目中定义的访问本地 JSON 格式的日志数据资源接口如下：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@mcp.resource(<span class="hljs-params"><span class="hljs-string">"logs://{session_id}/{limit}"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_query_logs</span>(<span class="hljs-params">limit: <span class="hljs-built_in">str</span> = <span class="hljs-string">"5"</span>, session_id: <span class="hljs-built_in">str</span> = <span class="hljs-string">"anonymous"</span></span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
    <span class="hljs-string">"""获取查询日志
    
    Args:
        limit: 可选参数，指定返回的日志数量，默认为5
        session_id: 可选参数，指定要获取的会话ID
    """</span>
    <span class="hljs-keyword">try</span>:
        limit_val = <span class="hljs-built_in">int</span>(limit)
        <span class="hljs-keyword">if</span> limit_val &lt;= <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"success"</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">"error"</span>: <span class="hljs-string">"Limit must be a positive integer"</span>}
        
        logs = query_logger.get_logs(session_id=session_id, limit=limit_val)
        total = query_logger.total_query_count(session_id=session_id)
        
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"success"</span>: <span class="hljs-literal">True</span>, <span class="hljs-string">"logs"</span>: logs, <span class="hljs-string">"total_queries"</span>: total}
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"success"</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">"error"</span>: <span class="hljs-built_in">str</span>(e)}
</code></pre>
<ul>
<li><strong>装饰器中资源类型以统一资源标识符（URI）为唯一寻址机制</strong>，格式为[协议]://[主机]/[路径]（如 file://home/user/report.pdf 或 postgres://database/customers/schema）。此设计允许资源协议、主机与路径的灵活定制，支持跨本地与远程环境的无缝集成。</li>
</ul>
<p><strong>通过整合多模态数据（文本与二进制）资源使 AI 模型能访问私有或专属知识库（如企业内部文档）、实时外部 API 及系统动态信息，有效突破单一大模型数据孤岛。</strong></p>
<p><strong>工具（Tools）</strong></p>
<p>工具是服务器向客户端暴露的可执行函数集合，用于拓展大型语言模型（LLM）的操作能力，使其突破纯文本生成的局限，实现对外部系统的主动交互。<strong>其本质就是函数抽象</strong>，通过JSON Schema 严格定义输入/输出参数结构（如天气查询需输入位置参数，输出结构化天气数据）。</p>
<p><strong>如 MCP-DB-GPT 项目中定义的只读 SQL 查询工具接口如下：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@mcp.tool()</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">query_data</span>(<span class="hljs-params">sql: <span class="hljs-built_in">str</span>, session_id: <span class="hljs-built_in">str</span> = <span class="hljs-string">"anonymous"</span></span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
    <span class="hljs-string">"""Execute read-only SQL queries"""</span>
    logger.info(<span class="hljs-string">f"Executing query: <span class="hljs-subst">{sql}</span>"</span>)
    conn = get_connection()
    cursor = <span class="hljs-literal">None</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># Create dictionary cursor</span>
        cursor = conn.cursor(pymysql.cursors.DictCursor)
        
        <span class="hljs-comment"># Start read-only transaction</span>
        cursor.execute(<span class="hljs-string">"SET TRANSACTION READ ONLY"</span>)
        cursor.execute(<span class="hljs-string">"START TRANSACTION"</span>)
        
        <span class="hljs-keyword">try</span>:
            cursor.execute(sql)
            results = cursor.fetchall()
            conn.commit()
            
            <span class="hljs-comment"># 记录成功查询</span>
            log_query(operation=sql, success=<span class="hljs-literal">True</span>, session_id=session_id)
            
            <span class="hljs-comment"># Convert results to serializable format</span>
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">"success"</span>: <span class="hljs-literal">True</span>,
                <span class="hljs-string">"results"</span>: results,
                <span class="hljs-string">"rowCount"</span>: <span class="hljs-built_in">len</span>(results)
            }
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            conn.rollback()
            log_query(operation=sql, success=<span class="hljs-literal">False</span>, error=<span class="hljs-built_in">str</span>(e), session_id=session_id)
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">"success"</span>: <span class="hljs-literal">False</span>,
                <span class="hljs-string">"error"</span>: <span class="hljs-built_in">str</span>(e)
            }
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-keyword">if</span> cursor:
            cursor.close()
        conn.close()
</code></pre>
<p>客户端通过标准协议接口（tools/list发现工具、tools/call 调用工具）与服务器交互，形成机器可读的自动化操作链路。<strong>其安全控制机制采用 “模型控制 + 人类监督” 双轨制：</strong></p>
<ul>
<li>LLM 自主决定工具调用的必要性（如识别用户请求中的查询数据库表信息意图）；</li>
<li>每次执行需用户显式授权（如弹出确认框），确保数据隐私与操作合规。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29b0c8dcc03e43eb906fc79577185c3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=dI6UP%2Bd9qxOLZvazhAwqjWQ7a8E%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>提示词（Prompts）</strong></p>
<p>提示词是服务器端预定义的可重用交互模板，用于标准化和引导大型语言模型（LLM）的任务执行。这些模板通过<strong>动态参数化设计</strong>，允许传入特定值（如任务变量或上下文数据）生成定制化指令，从而实现高效、一致的模型交互。其核心机制如下：</p>
<ul>
<li><strong>结构化要素</strong>：每个提示模板包含唯一标识符、任务描述、参数列表（如输入变量）以及可选的资源引用（如外部文件或API数据）。这种结构确保指令的明确性和可扩展性，减少模型输出歧义。例如，在文本生成任务中，模板可能定义输出格式要求（如字数限制或响应风格），并动态整合用户输入数据。</li>
<li><strong>上下文引导</strong>：提示词嵌入上下文关联机制（如历史对话片段或外部资源引用），帮助模型理解任务背景。例如，在问答场景中，模板可引入相关数据源（如知识库），提升响应准确性和相关性。</li>
<li><strong>工作流支持</strong>：支持链式交互设计，允许多个提示模板组合以处理复杂任务（如多步骤分析或迭代优化）。同时，模板常作为用户界面元素（如斜杠命令）集成，增强可用性。</li>
<li>⚠️：提示词模版需要与客户端联动，即服务端定义好之后，在与客户端交互时，客户端获取服务器端动态填充好的提示词模版再发给大模型，大模型按照提示词要求进行回答。<strong>如果嵌在工具中触发条件往往是被动的</strong>。</li>
</ul>
<p><strong>如MCP-DB-GPT 项目中服务端定义好的提示词接口如下：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@mcp.prompt()</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_db_gpt_prompt</span>() -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""Generate a prompt for LLM to interact with database."""</span>
    <span class="hljs-comment"># 获取数据库表列表</span>
    tables_info = get_tables()
    database_name = tables_info[<span class="hljs-string">"database"</span>]
    tables = tables_info[<span class="hljs-string">"tables"</span>]
    
    <span class="hljs-comment"># 获取所有表的描述信息</span>
    table_definitions = []
    <span class="hljs-keyword">for</span> table <span class="hljs-keyword">in</span> tables:
        table_desc = get_table_description(table)
        <span class="hljs-keyword">if</span> table_desc.get(<span class="hljs-string">"success"</span>):
            table_definitions.append(table_desc[<span class="hljs-string">"table_definition"</span>])
    <span class="hljs-keyword">return</span> DB_GPT_SYSTEM_PROMPT.<span class="hljs-built_in">format</span>(
        database_name=database_name,
        table_definitions=<span class="hljs-string">"\n"</span>.join(table_definitions),
    )
</code></pre>
<p>DB_GPT_SYSTEM_PROMPT 即是预先编写好的提示词模板，当你动态的获取参数后进行替换即可。一个简易的提示词模板如下：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">Baseline_SYSTEM_PROMPT</span> = <span class="hljs-string">"""
请根据用户选择的数据库和该库的所有可用表结构定义来回答用户问题.
数据库名:
    {database_name}
表结构定义:
    {table_definitions}


约束:
    1. 请根据用户问题理解用户意图，使用给出表结构定义创建一个语法正确的mysql sql。
    2. 将查询限制为最多10000个结果。
    3. 只能使用表结构信息中提供的表来生成 sql。
    4. 请检查SQL的正确性。
    5. 分析基于现有表结构和元数据信息，估算用户提供的 DQL 语句的索引推荐策略,并返回给用户explain执行结果


用户问题:
    {user_question}


请按照以下JSON格式回复：
{{
    "thoughts": "分析思路",
    "sql": "SQL查询语句",
    "explain": "优化后的DQL语句执行结果"
}}
"""</span>
</code></pre>
<p>然后客户端建立通信连接后获取相关的资源、工具和提示词模版：</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-comment"># methods will go here</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">connect_to_server</span>(<span class="hljs-params">self, server_script_path: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-string">"""Connect to an MCP server
        
        Args:
            server_script_path: Path to the server script (.py or .js)
        """</span>
        <span class="hljs-comment"># try:</span>
        is_python = server_script_path.endswith(<span class="hljs-string">'.py'</span>)
        is_js = server_script_path.endswith(<span class="hljs-string">'.js'</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (is_python <span class="hljs-keyword">or</span> is_js):
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"Server script must be a .py or .js file"</span>)
        
        command = <span class="hljs-string">"python"</span> <span class="hljs-keyword">if</span> is_python <span class="hljs-keyword">else</span> <span class="hljs-string">"node"</span>
        server_params = StdioServerParameters(
            command=command,
            args=[server_script_path],
            env=<span class="hljs-literal">None</span>
        )
        stdio_transport = <span class="hljs-keyword">await</span> self.exit_stack.enter_async_context(stdio_client(server_params))
        self.stdio, self.write = stdio_transport
        self.session = <span class="hljs-keyword">await</span> self.exit_stack.enter_async_context(ClientSession(self.stdio, self.write))
        <span class="hljs-keyword">await</span> self.session.initialize()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Session_id: <span class="hljs-subst">{self.session_id}</span>"</span>)
        
        <span class="hljs-comment"># List available tools</span>
        response = <span class="hljs-keyword">await</span> self.session.list_tools()
        tools = response.tools
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\nConnected to server with tools:"</span>, [tool.name <span class="hljs-keyword">for</span> tool <span class="hljs-keyword">in</span> tools])
        
        <span class="hljs-comment"># List available resources</span>
        resources_response = <span class="hljs-keyword">await</span> self.session.list_resources()
        <span class="hljs-keyword">if</span> resources_response <span class="hljs-keyword">and</span> resources_response.resources:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"Available resources:"</span>, [resource.uri <span class="hljs-keyword">for</span> resource <span class="hljs-keyword">in</span> resources_response.resources])
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"Available resources templates: ['logs']"</span>)


        prompts = <span class="hljs-keyword">await</span> self.session.list_prompts()
        <span class="hljs-keyword">if</span> prompts <span class="hljs-keyword">and</span> prompts.prompts:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"Available prompts:"</span>, [prompt.name <span class="hljs-keyword">for</span> prompt <span class="hljs-keyword">in</span> prompts.prompts])
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"No available prompts found."</span>)
</code></pre>
<p><strong>MCP Client</strong></p>
<p>MCP Client 在整个模型交互过程中则起着至关重要的桥梁作用，连接着 LLM 与 MCP Server。其Python版 SDK 提供的框架图如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe301a6e62f546e59ec19f92b2be6b82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=kGn7fMjngzWsTYelfewwR48QOmQ%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>此处，我们先不看他的通信机制，结合 MCP-DB-GPT 项目仅关注 ClientSession 是如何与服务器层交互的。从宏观上看，客户端与服务器端的消息流大致如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f4e561364b142b4be20a9632cf40714~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=AaP6H8LbbUF5ibw7n75dhLQ%2BSSQ%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>而在 MCP-DB-GPT项目中定义了一个集成阿里通义千问大模型接口的 MCPClient类：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MCPClient</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># Initialize session and client objects</span>
        self.session: <span class="hljs-type">Optional</span>[ClientSession] = <span class="hljs-literal">None</span>
        self.exit_stack = AsyncExitStack()
        self.llm = TongYiAPI()
        self.session_id = <span class="hljs-built_in">str</span>(uuid.uuid4())
        self.use_few_shot = <span class="hljs-literal">True</span>
        self.conversation_history = FEW_SHOT_EXAMPLES <span class="hljs-keyword">if</span> self.use_few_shot <span class="hljs-keyword">else</span> []
    
    <span class="hljs-comment"># methods will go here</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">connect_to_server</span>(<span class="hljs-params">self, server_script_path: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-string">"""Connect to an MCP server
    
    async def get_query_logs(self, limit: int = 5) -&gt; str:
        """</span>获取查询日志<span class="hljs-string">"""
    
    async def get_schema(self, table_names: Optional[List[str]] = None) -&gt; str:
        """</span>获取数据库结构信息<span class="hljs-string">"""


    async def process_query(self, query: str) -&gt; str:
        """</span>使用通义千问处理数据库相关查询<span class="hljs-string">"""
</span></code></pre>
<p>客户端就是通过ClientSession对象与服务器交互，主要包括初始化连接、工具调用和资源访问：</p>
<ul>
<li><strong>连接建立</strong>：</li>
<li>
<ul>
<li>在connect_to_server方法中，客户端基于服务器脚本路径（如 Python 或 Node.js 脚本）初始化StdioServerParameters。</li>
<li>使用stdio_client建立标准输入输出（Stdio）传输通道，创建ClientSession对象。调用session.initialize()初始会话，生成唯一会话 ID（session_id），用于加密通信和日志跟踪。</li>
<li>随后通过session.list_tools()获取可用工具列表（如query_data、get_schema），并通过session.list_resources()列出可访问资源（如日志）。此阶段实现协议中的“工具发现”阶段，确保客户端了解服务器功能。</li>
</ul>
</li>
</ul>

<ul>
<li><strong>工具调用过程</strong>：</li>
<li>
<ul>
<li>当执行具体操作时（如执行 SQL 或获取 Schema），客户端使用session.call_tool(tool_name, params)方法发送 JSON-RPC 请求。 </li>
<li>
<ul>
<li><strong>请求结构</strong>：以get_schema为例，参数包括session_id和可选table_names，序列化为 JSON 格式。</li>
<li><strong>服务器响应</strong>：服务器执行工具（如查询数据库结构），返回JSON-RPC响应。响应包含content字段（如数据库结构信息），客户端解析 JSON 以提取结果。</li>
</ul>
</li>
<li><strong>错误处理</strong>：若响应包含success: false或error字段（如无法获取Schema），客户端返回错误信息。</li>
</ul>
</li>
</ul>

<ul>
<li><strong>资源访问机制</strong>：</li>
<li>
<ul>
<li>通过session.read_resource(uri)访问资源（如日志）。日志 URI 格式为logs://{session_id}/{limit}，服务器返回结构化的日志数据（JSON 格式）。</li>
<li><strong>安全性</strong>：所有交互依赖会话级加密（session_id），并通过权限验证（用户需显式授权敏感操作）。</li>
</ul>
</li>
</ul>
<p><strong>典型案例运用</strong></p>
<p>MCP-DB-GPT 项目的一大亮点在于，其实现了结合提示词后，如何借助大模型解析自然语言生成 SQL 语句再与服务器进行交互并返回查询结果的完整过程。该功能能让初学者一步感知到 MCP 的工作流程以及它的灵活与强大。</p>
<p><strong>通过LLM解析自然语言生成SQL语句的流程</strong>：在process_query方法中，LLM（通义千问 API）用于生成结构化工具调用（如 SQL 语句）。核心代码实现如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_query</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""使用通义千问处理数据库相关查询"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 调用服务器层的提示词方法</span>
        prompt = <span class="hljs-keyword">await</span> self.session.get_prompt(<span class="hljs-string">"generate_db_gpt_prompt"</span>)
        prompt = prompt.messages[<span class="hljs-number">0</span>].content.text
        <span class="hljs-comment"># 将封装好的提示词投喂给大模型</span>
        llm_response = self.llm.chat(system_prompt=prompt, content=query, response_format=<span class="hljs-string">"json_object"</span>,
                                     conversation_history=self.conversation_history)
        response_data = json.loads(llm_response)
</code></pre>
<ul>
<li>客户端通过session.get_prompt("generate_db_gpt_prompt")获取预定义提示模板（prompt），该模板描述可用工具（如query_data）和任务规范，优化 LLM 对查询的理解和工具的调用。</li>
<li><strong>LLM 基于提示和对话历史，执行“意图解析”</strong> ：</li>
<li>
<ul>
<li>分析自然语言，匹配工具（如自动选择query_data工具）。</li>
<li>输出 JSON 包含sql字段（生成的 SQL 语句）、direct_response（当无需 SQL）或thoughts（推理过程）。</li>
<li>示例：查询“金额最高的订单”可能生成"sql": "SELECT * FROM orders ORDER BY amount DESC LIMIT 1"。</li>
</ul>
</li>
<li><strong>对话更新</strong>：用户查询和 LLM 响应添加到conversation_history，保持上下文一致性。</li>
</ul>
<p><strong>生成 SQL 后与服务器层的二次交互</strong>：在process_query中，如果 LLM 响应包含sql字段（如"sql":"SELECT * FROM users"），客户端自动调用session.call_tool("query_data", params)。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 如果有SQL查询，执行它</span>
<span class="hljs-keyword">if</span> response_data.get(<span class="hljs-string">"sql"</span>):
    <span class="hljs-comment"># 执行SQL查询</span>
    query_result = <span class="hljs-keyword">await</span> self.session.call_tool(<span class="hljs-string">"query_data"</span>, {
        <span class="hljs-string">"sql"</span>: response_data[<span class="hljs-string">"sql"</span>],
        <span class="hljs-string">"session_id"</span>: self.session_id
    })
    <span class="hljs-comment"># 构建最终响应</span>
    final_response = {
        <span class="hljs-string">"thoughts"</span>: response_data[<span class="hljs-string">"thoughts"</span>],
        <span class="hljs-string">"sql"</span>: response_data[<span class="hljs-string">"sql"</span>],
        <span class="hljs-string">"display_type"</span>: response_data.get(<span class="hljs-string">"display_type"</span>, <span class="hljs-string">"Table"</span>),
        <span class="hljs-string">"results"</span>: json.loads(query_result.content[<span class="hljs-number">0</span>].text) <span class="hljs-keyword">if</span> query_result.content[<span class="hljs-number">0</span>].text <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
    }
    
    <span class="hljs-keyword">return</span> json.dumps(final_response, ensure_ascii=<span class="hljs-literal">False</span>, indent=<span class="hljs-number">2</span>)
</code></pre>
<ul>
<li>所有查询（包括 LLM 生成的 SQL）通过write_resource记录到日志资源，URI 为logs://{session_id}/{limit}，支持后续审计。</li>
</ul>
<p><strong>此交互完成 MCP 的“执行-响应”闭环：SQL 作为工具调用的参数，服务器执行后返回结构化数据，客户端整合为最终响应。</strong></p>
<h2 data-id="heading-4">三、底层通信原理</h2>
<h3 data-id="heading-5">3.1协议层：JSON-RPC 2.0基础</h3>
<p>MCP 的核心消息格式采用 JSON-RPC 2.0 协议，这是一个轻量级的 RPC 框架，用于结构化请求、响应和通知。在 Python SDK 中：</p>
<ul>
<li><strong>消息结构</strong>：每条消息都是 JSON 对象，包含 method（方法名，如 tool_execute）、params（参数）和 id（请求 ID）。</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">JSONRPCRequest</span>(Request[<span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-literal">None</span>, <span class="hljs-built_in">str</span>]):
    <span class="hljs-string">"""A request that expects a response."""</span>
    jsonrpc: <span class="hljs-type">Literal</span>[<span class="hljs-string">"2.0"</span>]
    <span class="hljs-built_in">id</span>: RequestId
    method: <span class="hljs-built_in">str</span>
    params: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>
</code></pre>
<ul>
<li><strong>交互类型</strong>：</li>
<li>
<ul>
<li>请求（JSONRPCRequest） ：客户端（如 AI 应用）发送操作指令（如执行工具）。</li>
<li>响应（JSONRPCResponse） ：服务器返回结果。</li>
<li>错误响应（JSONRPCError）：服务器返回错误信息。</li>
<li>通知（JSONRPCNotification） ：用于异步事件（如服务器主动推送上下文更新），无需响应。</li>
</ul>
</li>
</ul>

<ul>
<li><strong>优势</strong>：JSON-RPC 2.0 的标准化确保跨平台兼容性，源码中通过 JsonRPCRequest和JsonRPCResponse 类实现解析和验证，减少消息解析开销。如在 STDIO 传输中，消息的序列化和反序列化过程如下：</li>
</ul>
<p><strong>发送消息时</strong>：消息被序列化为 JSON 并添加换行符。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> write_stream_reader:
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> session_message <span class="hljs-keyword">in</span> write_stream_reader:
            json = session_message.message.model_dump_json(by_alias=<span class="hljs-literal">True</span>, exclude_none=<span class="hljs-literal">True</span>)
            <span class="hljs-keyword">await</span> process.stdin.send(
                (json + <span class="hljs-string">"\n"</span>).encode(
                    encoding=server.encoding,
                    errors=server.encoding_error_handler,
                )
            )
<span class="hljs-keyword">except</span> anyio.ClosedResourceError:
    <span class="hljs-keyword">await</span> anyio.lowlevel.checkpoint()
</code></pre>
<p><strong>接收消息时</strong>：从输入流读取行，解析为JSON-RPC消息 。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">try</span>:
    message = types.JSONRPCMessage.model_validate_json(line)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> exc:
    <span class="hljs-keyword">await</span> read_stream_writer.send(exc)
    <span class="hljs-keyword">continue</span>


session_message = SessionMessage(message)
<span class="hljs-keyword">await</span> read_stream_writer.send(session_message)
</code></pre>
<h3 data-id="heading-6">3.2传输层：双向通信实现</h3>
<p>MCP Python SDK 提供了多种传输机制，每种机制都针对不同的部署场景和通信模式进行了优化。所有传输机制都抽象为一个基于流的通用接口，同时支持特定于协议的功能。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18278ce7850a4df0910a8a34573852b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=Yxs3GvFFNbluVWIqwcAj3ZucujQ%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>Stdio传输</strong></p>
<p>通过标准输入/输出（stdin/stdout）流进行同步或异步通信。源码中读取和写入流由如下函数实现：</p>
<ul>
<li><strong>读取流</strong>：MemoryObjectReceiveStream[SessionMessage | Exception]-从服务器标准输出接收消息</li>
<li><strong>写入流</strong>：MemoryObjectSendStream[SessionMessage]- 将消息发送到服务器标准输入</li>
</ul>
<p><strong>其适用于本地进程间通信（如 IDE 插件），低延迟但仅限单机。</strong> 关键代码包括stdin_reader()和stdout_writer方法，负责后台处理双向通信。<strong>其通信流程大致为以下七步</strong>：</p>
<ol>
<li>客户端以子进程的方式启动服务器</li>
<li>客户端往服务器的 stdin 写入消息</li>
<li>服务器从自身的 stdin 读取消息</li>
<li>服务端往自身的 stdout 写入消息</li>
<li>客户端从服务器的 stdout 读取消息</li>
<li>客户端终止子进程，关闭服务器的 stdin</li>
<li>服务器关闭自身的 stdout</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f613241f67b64e839f79f78785ba82c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=qKCcegowaJOiuJBGki3AacYWAs0%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li>⚠️⚠️⚠️：<strong>当客户端调用mcp.tool() 装饰的函数时，SDK 内部封装请求为 JSON-RPC，通过 stdio 发送给服务器进程，服务端通过装饰器装饰的函数在建立连接后被调用时，会自动进行注入并转换成 JSON格式的数据与客户端进行自动交互。</strong></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/699be87066ba4ae682db893131642374~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=JcwFyrtnIzFRmzkUUfqwdLgQTSc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>服务端代码参考：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_stdio</span>():
    <span class="hljs-string">"""运行标准输入输出模式的服务器
    
    使用标准输入输出流(stdio)运行服务器，主要用于命令行交互模式
    
    Raises:
        Exception: 当服务器运行出错时抛出异常
    """</span>
    <span class="hljs-keyword">from</span> mcp.server.stdio <span class="hljs-keyword">import</span> stdio_server
    
    logger.info(<span class="hljs-string">"启动标准输入输出(stdio)模式服务器"</span>)
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 初始化资源</span>
        <span class="hljs-keyword">await</span> initialize_global_resources()
        
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> stdio_server() <span class="hljs-keyword">as</span> (read_stream, write_stream):
            <span class="hljs-keyword">try</span>:
                logger.debug(<span class="hljs-string">"初始化流式传输接口"</span>)
                <span class="hljs-keyword">await</span> app.run(
                    read_stream,
                    write_stream,
                    app.create_initialization_options()
                )
                logger.info(<span class="hljs-string">"标准输入输出模式服务结束"</span>)
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                logger.critical(<span class="hljs-string">f"标准输入输出模式服务器错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
                logger.exception(<span class="hljs-string">"服务异常终止"</span>)
                <span class="hljs-keyword">raise</span>
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-comment"># 关闭资源</span>
        <span class="hljs-keyword">await</span> close_global_resources()
</code></pre>
<p><strong>Main 函数中调用：</strong></p>
<pre><code class="hljs language-css" lang="css">try:
    if mode == <span class="hljs-string">"stdio"</span>:
        asyncio.<span class="hljs-built_in">run</span>(<span class="hljs-built_in">run_stdio</span>())
</code></pre>
<p><strong>配置 Cline 的JSON文件即可访问：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"mcp_db"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"timeout"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">60</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"stdio"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uv"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"--directory"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"/Users/admin/Downloads/Codes/MCP/mcp_for_db/src/"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"run"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"-m"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"server.mcp.server_mysql"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"--mode"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"stdio"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"MYSQL_HOST"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"localhost"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"MYSQL_PORT"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"3306"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"MYSQL_USER"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"root"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"MYSQL_PASSWORD"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"password"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"MYSQL_DATABASE"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"mcp_db"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"MYSQL_ROLE"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"admin"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"PYTHONPATH"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/Users/admin/Downloads/Codes/MCP/MCP-DB/"</span>
      <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>SSE 传输</strong></p>
<p>SSE 传输使用服务器发送事件 (SSE) 传输服务器到客户端的消息，并使用 HTTP POST 请求传输客户端到服务器的消息，提供基于 HTTP 的通信。其本质是双向模拟，即 SSE 本质为单向，SDK 通过“请求/响应”对模拟双向通信（客户端发送 HTTP POST 请求携带JSON-RPC，服务器返回 SSE 流）。其通信流程也可概括为七步：</p>
<ol>
<li>客户端向服务器的 /sse 端点发送请求（一般是 GET 请求），建立 SSE 连接；</li>
<li>服务器给客户端返回一个包含消息端点地址的事件消息；</li>
<li>客户端给消息端点发送消息；</li>
<li>服务器给客户端响应消息已接收状态码；</li>
<li>服务器给双方建立的 SSE 连接推送事件消息；</li>
<li>客户端从 SSE 连接读取服务器发送的事件消息；</li>
<li>客户端关闭 SSE 连接。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e93fb80a910e4cdabb1f6c1bd3d95938~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=mpBSd0tWXQcjHBzRJ3WvA4%2BJ6to%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>服务器端</strong>：SseServerTransport为服务器端 SSE 传输实现提供了两个主要的 ASGI 应用程序。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b831d81cec6d4d4e81d44555874bb264~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=nYwNrpa0iwp%2F22Vr929kkbKTXP4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>客户端</strong>：sse_client函数提供客户端 SSE 传输实现。</p>
<p><strong>二者通信的消息格式如下</strong>：每条 SSE 消息以 data: 前缀携带 JSON-RPC 负载，客户端监听事件流。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 服务端</span>
logger.debug(<span class="hljs-string">"Starting SSE writer"</span>)
<span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> sse_stream_writer, write_stream_reader:
    <span class="hljs-keyword">await</span> sse_stream_writer.send({<span class="hljs-string">"event"</span>: <span class="hljs-string">"endpoint"</span>, <span class="hljs-string">"data"</span>: client_post_uri_data})
    logger.debug(<span class="hljs-string">f"Sent endpoint event: <span class="hljs-subst">{client_post_uri_data}</span>"</span>)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> session_message <span class="hljs-keyword">in</span> write_stream_reader:
        logger.debug(<span class="hljs-string">f"Sending message via SSE: <span class="hljs-subst">{session_message}</span>"</span>)
        <span class="hljs-keyword">await</span> sse_stream_writer.send(
            {
                <span class="hljs-string">"event"</span>: <span class="hljs-string">"message"</span>,
                <span class="hljs-string">"data"</span>: session_message.message.model_dump_json(by_alias=<span class="hljs-literal">True</span>, exclude_none=<span class="hljs-literal">True</span>),
            }
        )
</code></pre>
<p><strong>其中涉及两种主要事件类型：</strong></p>
<ul>
<li><strong>endpoint事件</strong>：在连接建立时发送，告知客户端 POST 消息的端点 URL。</li>
<li><strong>message事件</strong>：传输实际的 JSON-RPC 消息。</li>
</ul>
<p><strong>客户端通过 sse_reader 函数处理接收到的 SSE 事件：</strong></p>
<ul>
<li><strong>endpoint事件处理</strong>：验证端点 URL 的安全性，确保与连接源匹配。</li>
</ul>

<pre><code class="hljs language-css" lang="css">match sse<span class="hljs-selector-class">.event</span>:
    case <span class="hljs-string">"endpoint"</span>:
        endpoint_url = <span class="hljs-built_in">urljoin</span>(url, sse.data)
        logger.<span class="hljs-built_in">debug</span>(f<span class="hljs-string">"Received endpoint URL: {endpoint_url}"</span>)
        
        url_parsed = <span class="hljs-built_in">urlparse</span>(url)
        endpoint_parsed = <span class="hljs-built_in">urlparse</span>(endpoint_url)
        if (
            url_parsed.netloc != endpoint_parsed.netloc
            or url_parsed.scheme != endpoint_parsed.scheme
        ):
            error_msg = (
                <span class="hljs-string">"Endpoint origin does not match "</span> f<span class="hljs-string">"connection origin: {endpoint_url}"</span>
            )
            logger.<span class="hljs-built_in">error</span>(error_msg)
            raise <span class="hljs-built_in">ValueError</span>(error_msg)
        
        task_status.<span class="hljs-built_in">started</span>(endpoint_url)
</code></pre>
<ul>
<li><strong>message事件处理</strong>：解析 JSON-RPC 消息并转换为 SessionMessage。</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">case</span> <span class="hljs-string">"message"</span>:
    <span class="hljs-keyword">try</span>:
        message = types.JSONRPCMessage.model_validate_json(  <span class="hljs-comment"># noqa: E501</span>
            sse.data
        )
        logger.debug(<span class="hljs-string">f"Received server message: <span class="hljs-subst">{message}</span>"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> exc:
        logger.error(<span class="hljs-string">f"Error parsing server message: <span class="hljs-subst">{exc}</span>"</span>)
        <span class="hljs-keyword">await</span> read_stream_writer.send(exc)
        <span class="hljs-keyword">continue</span>
    
    session_message = SessionMessage(message)
    <span class="hljs-keyword">await</span> read_stream_writer.send(session_message)
</code></pre>
<p><strong>适用场景</strong>：远程或云端部署，支持高并发和实时更新（如工具调用的结果推送）。错误处理包括连接超时重试（源码中 retry 机制）。</p>
<p><strong>服务端代码参考</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">run_sse</span>():
    <span class="hljs-string">"""运行SSE(Server-Sent Events)模式的服务器
    
    启动一个支持SSE的Web服务器，允许客户端通过HTTP长连接接收服务器推送的消息
    服务器默认监听0.0.0.0:9000
    """</span>
    logger.info(<span class="hljs-string">"启动SSE(Server-Sent Events)模式服务器"</span>)
    sse = SseServerTransport(<span class="hljs-string">"/messages/"</span>)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_sse</span>(<span class="hljs-params">request</span>):
        <span class="hljs-string">"""处理SSE连接请求
        
        Args:
            request: HTTP请求对象
        """</span>
        logger.info(<span class="hljs-string">f"新的SSE连接 [client=<span class="hljs-subst">{request.client}</span>]"</span>)
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> sse.connect_sse(
                request.scope, request.receive, request.send
        ) <span class="hljs-keyword">as</span> streams:
            <span class="hljs-keyword">try</span>:
                <span class="hljs-keyword">await</span> app.run(streams[<span class="hljs-number">0</span>], streams[<span class="hljs-number">1</span>], app.create_initialization_options())
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                logger.error(<span class="hljs-string">f"SSE连接处理异常: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
                <span class="hljs-keyword">raise</span>
        logger.info(<span class="hljs-string">f"SSE连接断开 [client=<span class="hljs-subst">{request.client}</span>]"</span>)
        <span class="hljs-keyword">return</span> Response(status_code=<span class="hljs-number">204</span>)
    
    @contextlib.asynccontextmanager
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">lifespan</span>(<span class="hljs-params">app: Starlette</span>) -&gt; AsyncIterator[<span class="hljs-literal">None</span>]:
        <span class="hljs-string">"""SSE应用的生命周期管理"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 初始化资源</span>
            <span class="hljs-keyword">await</span> initialize_global_resources()
            <span class="hljs-keyword">yield</span>
        <span class="hljs-keyword">finally</span>:
            <span class="hljs-comment"># 关闭资源</span>
            <span class="hljs-keyword">await</span> close_global_resources()
    
    starlette_app = Starlette(
        debug=<span class="hljs-literal">True</span>,
        routes=[
            Route(<span class="hljs-string">"/sse"</span>, endpoint=handle_sse),
            Mount(<span class="hljs-string">"/messages/"</span>, app=sse.handle_post_message)
        ],
        lifespan=lifespan
    )
    
    logger.info(<span class="hljs-string">"SSE服务器启动中 [host=0.0.0.0, port=9000]"</span>)
    <span class="hljs-comment"># 创建配置并运行</span>
    config = uvicorn.Config(
        app=starlette_app,
        host=<span class="hljs-string">"0.0.0.0"</span>,
        port=<span class="hljs-number">9000</span>,
        loop=<span class="hljs-string">"asyncio"</span>,
        log_config=<span class="hljs-literal">None</span>  <span class="hljs-comment"># 禁用uvicorn默认日志配置</span>
    )
    
    server = uvicorn.Server(config)
    server.run()
</code></pre>
<p><strong>Main函数中调用</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">try:
    if <span class="hljs-attr">mode</span> == <span class="hljs-string">"sse"</span>:
        run_sse()
</code></pre>
<p><strong>配置 Cline 的 JSON文件即可访问：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"mysql_mcp_server"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"disabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"timeout"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">60</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sse"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost:9000/sse"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-7">3.3通信工作流程</h3>
<p>MCP通信遵循 JSON-RPC 2.0模式，主要包含三个消息类别：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15cc40200832463294bb9305e8877ce1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=6srulcbfkV3b7%2FvzWo3yaI%2BBQW4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>同时，理解 MCP 连接生命周期可以帮助我们更好地开发 MCP 服务器和 AI 应用。MCP 连接生命周期跟 TCP 的三次握手、四次挥手有点类似，也要经历建立连接、交换消息、断开连接等阶段。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fa1a26d463440ae9583b47c283ecd3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=ImgXpfMxLIGbDvuYHFY8jbD2HAs%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>接下来，以 StreamableHTTP 机制为例，分析通信工作流程。StreamableHTTP 传输机制实现了基于 HTTP 的双向通信，结合了 HTTP POST 请求和 Server-Sent Events (SSE) 流来提供完整的客户端-服务器通信解决方案。</p>
<p><strong>整体架构流程</strong></p>
<p>StreamableHTTP 通信机制包含会话管理、双向消息传输和可选的事件重放功能：</p>
<ul>
<li>客户端传输初始化</li>
<li>
<ul>
<li>客户端通过 streamablehttp_client 函数建立连接。</li>
<li>核心组件 StreamableHTTPTransport 负责管理会话状态和消息路由。</li>
<li/>
</ul>
</li>
<li>服务器端会话管理</li>
<li>
<ul>
<li>服务器端使用 StreamableHTTPSessionManager 管理多个并发会话。支持有状态和无状态两种模式：</li>
<li><strong>有状态模式</strong>：维护会话状态，支持连接恢复。</li>
<li><strong>无状态模式</strong>：每个请求创建新的传输实例。</li>
</ul>
</li>
</ul>
<p><strong>通信工作流程详解</strong></p>
<p><strong>初始化和会话建立</strong></p>
<ul>
<li>初始化请求：客户端发送 initialize 方法的 POST 请求。</li>
<li>会话 ID 分配：服务器生成唯一会话 ID 并通过 mcp-session-id 头返回。</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_maybe_extract_session_id_from_response</span>(<span class="hljs-params">
    self,
    response: httpx.Response,
</span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""Extract and store session ID from response headers."""</span>
    new_session_id = response.headers.get(MCP_SESSION_ID)
    <span class="hljs-keyword">if</span> new_session_id:
        self.session_id = new_session_id
        logger.info(<span class="hljs-string">f"Received session ID: <span class="hljs-subst">{self.session_id}</span>"</span>)
</code></pre>
<p><strong>双向消息传输</strong></p>
<p>客户端到服务器（POST 请求）：客户端的post_writer 方法处理出站消息。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">post_writer</span>(<span class="hljs-params">
    self,
    client: httpx.AsyncClient,
    write_stream_reader: StreamReader,
    read_stream_writer: StreamWriter,
    write_stream: MemoryObjectSendStream[SessionMessage],
    start_get_stream: <span class="hljs-type">Callable</span>[[], <span class="hljs-literal">None</span>],
    tg: TaskGroup,
</span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""Handle writing requests to the server."""</span>
</code></pre>
<ul>
<li><strong>消息序列化</strong>：将 JSON-RPC 消息序列化为 HTTP POST 请求体。</li>
<li><strong>请求处理</strong>：根据消息类型选择处理方式 - 普通请求或恢复请求。</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_request_async</span>():
    <span class="hljs-keyword">if</span> is_resumption:
        <span class="hljs-keyword">await</span> self._handle_resumption_request(ctx)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">await</span> self._handle_post_request(ctx)
<span class="hljs-comment"># If this is a request, start a new task to handle it</span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(message.root, JSONRPCRequest):
    tg.start_soon(handle_request_async)
<span class="hljs-keyword">else</span>:
    <span class="hljs-keyword">await</span> handle_request_async()
</code></pre>
<ul>
<li><strong>响应处理</strong>：支持 JSON 响应和 SSE 流响应两种模式。</li>
</ul>
<p><strong>服务器到客户端（SSE 流）</strong></p>
<p>服务器端通过不同的 HTTP 方法处理消息：</p>
<ul>
<li><strong>POST 请求处理</strong>：接收客户端消息并通过 SSE 或 JSON 响应</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> self.is_json_response_enabled:
    <span class="hljs-comment"># Process the message</span>
    metadata = ServerMessageMetadata(request_context=request)
    session_message = SessionMessage(message, metadata=metadata)
    <span class="hljs-keyword">await</span> writer.send(session_message)
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># Process messages from the request-specific stream</span>
        <span class="hljs-comment"># We need to collect all messages until we get a response</span>
        <span class="hljs-keyword">pass</span>
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-keyword">await</span> self._clean_up_memory_streams(request_id)
<span class="hljs-keyword">else</span>:
    <span class="hljs-comment"># Create SSE stream</span>
    sse_stream_writer, sse_stream_reader = anyio.create_memory_object_stream[<span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]](<span class="hljs-number">0</span>)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">sse_writer</span>():
        <span class="hljs-comment"># Get the request ID from the incoming request message</span>
</code></pre>
<ul>
<li><strong>GET 请求处理</strong>：建立独立的 SSE 流用于服务器主动推送 streamable_http.py:511-601</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_handle_get_request</span>(<span class="hljs-params">self, request: Request, send: Send</span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""
    Handle GET request to establish SSE.
    
    This allows the server to communicate to the client without the client
    first sending data via HTTP POST. The server can send JSON-RPC requests
    and notifications on this stream.
    """</span>
</code></pre>
<p><strong>实际使用示例</strong></p>
<p>从测试代码中可以看到完整的使用流程：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@pytest.mark.anyio</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_streamablehttp_client_basic_connection</span>(<span class="hljs-params">basic_server, basic_server_url</span>):
    <span class="hljs-string">"""Test basic client connection with initialization."""</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> streamablehttp_client(<span class="hljs-string">f"<span class="hljs-subst">{basic_server_url}</span>/mcp"</span>) <span class="hljs-keyword">as</span> (
        read_stream,
        write_stream,
        _,
    ):
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> ClientSession(
            read_stream,
            write_stream,
        ) <span class="hljs-keyword">as</span> session:
            <span class="hljs-comment"># Test initialization</span>
            result = <span class="hljs-keyword">await</span> session.initialize()
            <span class="hljs-keyword">assert</span> <span class="hljs-built_in">isinstance</span>(result, InitializeResult)
            <span class="hljs-keyword">assert</span> result.serverInfo.name == SERVER_NAME
</code></pre>
<ol>
<li>使用 streamablehttp_client 建立连接</li>
<li>通过 ClientSession 进行初始化</li>
<li>执行各种 MCP 操作（工具调用、资源访问等）</li>
</ol>
<h3 data-id="heading-8">3.4各协议对比分析</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/785e811b64234854bfa08f6c5c04ccc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=anWdBMNmIdWTD7raJ1Z%2B1OStFA8%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>MCP vs REST API</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c46a32a3d7ca4fffbf19fadf0137b464~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=Es2s2DTqEmfvx47xFKsSfizhius%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>MCP vs WebSocket</p>
<h2 data-id="heading-9">四、项目初始化&amp;实战解析</h2>
<p>本节，将使用 uv 快速搭建 MCP 服务，然后结合 DW-DBA-MCP 实战项目进行介绍。</p>
<h3 data-id="heading-10">4.1环境安装</h3>
<p>官方推荐使用 uv 进行虚拟环境及依赖的管理。uv 的安装可参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.astral.sh%2Fuv%2F%23highlights%25E3%2580%2582%25E5%2585%25B6%25E4%25BB%2596%25E5%25AE%2589%25E8%25A3%2585%25E6%2596%25B9%25E5%25BC%258F%25E5%258F%25AF%25E5%258F%2582%25E8%2580%2583%25EF%25BC%259Ahttps%3A%2F%2Fdocs.astral.sh%2Fuv%2Fgetting-started%2Finstallation%2F%23standalone-installer%25E3%2580%2582" target="_blank" title="https://docs.astral.sh/uv/#highlights%E3%80%82%E5%85%B6%E4%BB%96%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F%E5%8F%AF%E5%8F%82%E8%80%83%EF%BC%9Ahttps://docs.astral.sh/uv/getting-started/installation/#standalone-installer%E3%80%82" ref="nofollow noopener noreferrer">docs.astral.sh/uv/#highlig…</a></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># macos</span>
curl -LsSf https://astral.sh/uv/install.sh | sh
<span class="hljs-built_in">source</span> <span class="hljs-variable">$HOME</span>/.local/bin/env


(base) Dewu-GK234XWXCT:~ admin$ uv --version
uv 0.7.13 (62ed17b23 2025-06-12)
</code></pre>
<p>同时，需要注意⚠️：SDK 需要 Python 3.10 或更高版本，支持 Python 3.10 至 3.13。</p>
<ul>
<li><strong>创建虚拟环境：</strong></li>
</ul>

<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 初始化虚拟环境</span>
uv init MCP-DB


<span class="hljs-comment"># 切换目录</span>
<span class="hljs-built_in">cd</span> MCP-DB


<span class="hljs-comment"># 安装mcp client依赖</span>
uv add <span class="hljs-string">"mcp[cli]"</span>


<span class="hljs-comment"># 使用 uv 运行 mcp 命令</span>
uv run mcp -<span class="hljs-built_in">help</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28668b7469de44c2ba8874402248c92f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=g8SWYGvQxG%2BOUN0T6nxvfX8wTc0%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-11">4.2DW-DBA-MCP实战解析</h3>
<p>本项目旨在为数据库侧开发 MCP Server。同时，考虑到高可扩展性，项目采用微服务架构进行设计开发，这也便于与 Nacos MCP Server 进行集成，客户端配置Nacos MCP Server 服务，LLM 即可通过该网关高效路由到合适工具；考虑到易用性，通过封装 MCP Client 和 MCP Server，提供 FastAPI 接口处理用户的提问。项目目录结构如下：</p>
<pre><code class="hljs language-csharp" lang="csharp">DW-DBA-MCP/
├── Dockerfile
├── LICENSE
├── README.md   
├── datas                          <span class="hljs-meta"># 存放项目日志文件</span>
│   ├── files                           <span class="hljs-meta"># 存放工具执行的 SQL 语句</span>
│   ├── logs                            <span class="hljs-meta"># 存放日志文件</span>
│   └── version   
├── mcp_for_db
│   ├── __init__.py
│   ├── client                    <span class="hljs-meta"># 自建客户端</span>
│   │   ├── __init__.py
│   │   ├── api.py                     <span class="hljs-meta"># FastAPI 服务</span>
│   │   └── client.py                  <span class="hljs-meta"># MCP Client</span>
│   ├── debug
│   │   ├── __init__.py
│   │   └── mcp_logger.py              <span class="hljs-meta"># 记录 MCP Client 与 MCP Server 通信数据，用于白盒解析 MCP 通信协议</span>
│   ├── envs
│   │   ├── common.env           <span class="hljs-meta"># 多服务环境变量配置文件</span>
│   │   ├── dify.env
│   │   └── mysql.env
│   ├── server
│   │   ├── __init__.py
│   │   ├── cli
│   │   │   ├── __init__.py
│   │   │   ├── dify_cli.py     <span class="hljs-meta"># cli 方式启动 dify 服务</span>
│   │   │   ├── mysql_cli.py    <span class="hljs-meta"># cli 方式启动 mysql 服务</span>
│   │   │   └── server.py
│   │   ├── common
│   │   │   ├── __init__.py
│   │   │   ├── <span class="hljs-keyword">base</span>            <span class="hljs-meta"># 公共的资源、工具和提示词自动注册和发现的基类包</span>
│   │   │   ├── prompts.py      <span class="hljs-meta"># 存放提示词模版</span>
│   │   │   └── tools.py        <span class="hljs-meta"># 存放工具描述</span>
│   │   ├── core
│   │   │   ├── __init__.py
│   │   │   ├── base_server.py       <span class="hljs-meta"># 微服务基类</span>
│   │   │   ├── config_manager.py    <span class="hljs-meta"># 环境变量配置器</span>
│   │   │   ├── env_distribute.py    <span class="hljs-meta"># stdio通信机制下多服务环境变量分发器</span>
│   │   │   └── service_manager.py   <span class="hljs-meta"># 多服务管理器</span>
│   │   ├── server_dify              <span class="hljs-meta"># dify 服务实现包</span>
│   │   │   ├── __init__.py
│   │   │   ├── config
│   │   │   ├── dify_server.py      <span class="hljs-meta"># dify 服务实现类</span>
│   │   │   └── tools
│   │   ├── server_mysql             <span class="hljs-meta"># mysql 服务实现包</span>
│   │   │   ├── __init__.py
│   │   │   ├── config
│   │   │   ├── mysql_server.py     <span class="hljs-meta"># mysql 服务实现类</span>
│   │   │   ├── prompts
│   │   │   ├── resources
│   │   │   └── tools
│   │   └── shared
│   │       ├── __init__.py
│   │       ├── oauth
│   │       ├── security    <span class="hljs-meta"># SQL鉴权</span>
│   │       ├── templates
│   │       └── utils
│   └── test
├── pyproject.toml
├── requirements.txt
└── uv.<span class="hljs-keyword">lock</span>
</code></pre>
<p><strong>项目设计思路</strong></p>
<p>本项目原先参考于开源项目：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwenb1n-dev%2Fmysql_mcp_server_pro%25EF%25BC%258C%25E4%25BD%2586%25E9%2592%2588%25E5%25AF%25B9%25E5%25BE%25AE%25E6%259C%258D%25E5%258A%25A1%25E5%25BC%258F%25E7%259A%2584%25E6%259E%25B6%25E6%259E%2584%25E8%25AE%25BE%25E8%25AE%25A1%25EF%25BC%258C%25E5%258F%2588%25E5%2581%259A%25E4%25BA%2586%25E8%25BF%259B%25E4%25B8%2580%25E6%25AD%25A5%25E6%2594%25B9%25E8%25BF%259B%25EF%25BC%258C%25E7%258E%25B0%25E9%2598%25B6%25E6%25AE%25B5%25E4%25BA%258C%25E8%2580%2585%25E7%259A%2584%25E5%25B7%25AE%25E5%25BC%2582%25E5%25A6%2582%25E4%25B8%258B%25EF%25BC%259A" target="_blank" title="https://github.com/wenb1n-dev/mysql_mcp_server_pro%EF%BC%8C%E4%BD%86%E9%92%88%E5%AF%B9%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%8F%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%EF%BC%8C%E5%8F%88%E5%81%9A%E4%BA%86%E8%BF%9B%E4%B8%80%E6%AD%A5%E6%94%B9%E8%BF%9B%EF%BC%8C%E7%8E%B0%E9%98%B6%E6%AE%B5%E4%BA%8C%E8%80%85%E7%9A%84%E5%B7%AE%E5%BC%82%E5%A6%82%E4%B8%8B%EF%BC%9A" ref="nofollow noopener noreferrer">github.com/wenb1n-dev/…</a></p>
<p>针对如何借助 Low-Level 接口自动注册和发现资源、工具和提示词，接下来则以我们扩展封装的资源为例进行介绍。</p>
<p>在多服务基类脚本base_server.py中只需展示和读取资源即可，对应的类会自动将资源进行注册和读取。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">setup_server</span>(<span class="hljs-params">self</span>):
    <span class="hljs-string">"""设置服务器路由"""</span>
    <span class="hljs-keyword">if</span> self.server_setup_completed:
        self.logger.debug(<span class="hljs-string">"服务器路由已设置，跳过重复设置"</span>)
        <span class="hljs-keyword">return</span>
    
    self.logger.info(<span class="hljs-string">"开始设置服务器路由"</span>)
    
    <span class="hljs-comment"># 注册资源处理器</span>
    @self.server.list_resources()
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_list_resources</span>() -&gt; <span class="hljs-type">List</span>[Resource]:
        <span class="hljs-keyword">try</span>:
            registry = self.get_resource_registry()
            <span class="hljs-keyword">if</span> registry <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
                self.logger.warning(<span class="hljs-string">"资源注册表未初始化，返回空列表"</span>)
                <span class="hljs-keyword">return</span> []
            
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(registry, <span class="hljs-string">'get_all_resources'</span>):
                <span class="hljs-keyword">if</span> asyncio.iscoroutinefunction(registry.get_all_resources):
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> registry.get_all_resources()
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-keyword">return</span> registry.get_all_resources()
            <span class="hljs-keyword">return</span> []
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            self.logger.error(<span class="hljs-string">f"获取资源列表失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>, exc_info=<span class="hljs-literal">True</span>)
            <span class="hljs-keyword">return</span> []
    
    @self.server.read_resource()
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_read_resource</span>(<span class="hljs-params">uri: AnyUrl</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-keyword">try</span>:
            self.logger.info(<span class="hljs-string">f"开始读取资源: <span class="hljs-subst">{uri}</span>"</span>)
            registry = self.get_resource_registry()
            <span class="hljs-keyword">if</span> registry <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"资源注册表未初始化"</span>)
            
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(registry, <span class="hljs-string">'get_resource'</span>):
                <span class="hljs-keyword">if</span> asyncio.iscoroutinefunction(registry.get_resource):
                    content = <span class="hljs-keyword">await</span> registry.get_resource(uri)
                <span class="hljs-keyword">else</span>:
                    content = registry.get_resource(uri)
            <span class="hljs-keyword">else</span>:
                content = <span class="hljs-literal">None</span>
            
            <span class="hljs-keyword">if</span> content <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
                content = <span class="hljs-string">"null"</span>
            self.logger.info(<span class="hljs-string">f"资源 <span class="hljs-subst">{uri}</span> 读取成功，内容长度: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(content)}</span>"</span>)
            <span class="hljs-keyword">return</span> content
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            self.logger.error(<span class="hljs-string">f"读取资源失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>, exc_info=<span class="hljs-literal">True</span>)
            <span class="hljs-keyword">raise</span>
</code></pre>
<p><strong>资源注册类：</strong></p>
<pre><code class="hljs language-python" lang="python">

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceRegistry</span>:
    <span class="hljs-string">"""资源注册表，用于管理所有资源实例"""</span>
    _resources: ClassVar[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-string">'BaseResource'</span>]] = {}
    
    @<span class="hljs-built_in">classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">cls, resource_class: <span class="hljs-type">Type</span>[<span class="hljs-string">'BaseResource'</span>]</span>):
        <span class="hljs-string">"""注册资源实例"""</span>
        resource = resource_class()
        logger.info(<span class="hljs-string">f"注册资源: <span class="hljs-subst">{resource.name}</span> (URI: <span class="hljs-subst">{resource.uri}</span>)"</span>)
        cls._resources[<span class="hljs-built_in">str</span>(resource.uri)] = resource
    
    @<span class="hljs-built_in">classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register_instance</span>(<span class="hljs-params">cls, resource: <span class="hljs-string">'BaseResource'</span></span>):
        <span class="hljs-string">"""手动注册资源实例"""</span>
        uri_str = <span class="hljs-built_in">str</span>(resource.uri)
        logger.info(<span class="hljs-string">f"注册资源实例: <span class="hljs-subst">{resource.name}</span> (URI: <span class="hljs-subst">{uri_str}</span>)"</span>)
        cls._resources[uri_str] = resource
    
    @<span class="hljs-built_in">classmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_resource</span>(<span class="hljs-params">cls, uri: AnyUrl</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""获取资源内容"""</span>
        logger.info(<span class="hljs-string">f"请求资源: <span class="hljs-subst">{uri}</span>"</span>)
        parsed = urlparse(<span class="hljs-built_in">str</span>(uri))
        uri_str = <span class="hljs-string">f"<span class="hljs-subst">{parsed.scheme}</span>://<span class="hljs-subst">{parsed.netloc}</span>/<span class="hljs-subst">{parsed.path}</span>"</span>
        path_parts = parsed.path.strip(<span class="hljs-string">'/'</span>).split(<span class="hljs-string">'/'</span>)
        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> path_parts <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> path_parts[<span class="hljs-number">0</span>]:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"无效的URI格式: <span class="hljs-subst">{uri_str}</span>，未指定表名"</span>)
        
        <span class="hljs-comment"># 优先尝试精确匹配</span>
        <span class="hljs-keyword">for</span> resource <span class="hljs-keyword">in</span> cls._resources.values():
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span>(resource.uri) == uri_str:
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> resource.read_resource(uri)
        
        <span class="hljs-comment"># 尝试后缀匹配</span>
        <span class="hljs-keyword">for</span> resource <span class="hljs-keyword">in</span> cls._resources.values():
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span>(resource.uri).endswith(path_parts[<span class="hljs-number">0</span>]):
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> resource.read_resource(uri)
        
        logger.error(<span class="hljs-string">f"未找到资源: <span class="hljs-subst">{uri}</span>，已注册资源: <span class="hljs-subst">{[r.uri <span class="hljs-keyword">for</span> k, r <span class="hljs-keyword">in</span> cls._resources.items()]}</span>"</span>)
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"未注册的资源: <span class="hljs-subst">{uri}</span>"</span>)
    
    @<span class="hljs-built_in">classmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_all_resources</span>(<span class="hljs-params">cls</span>) -&gt; <span class="hljs-type">List</span>[Resource]:
        <span class="hljs-string">"""获取所有资源的描述"""</span>
        result = []
        <span class="hljs-comment"># 创建资源副本避免在迭代过程中修改原字典:扫描库时还会注册表资源</span>
        resources_copy = <span class="hljs-built_in">list</span>(cls._resources.values())
        <span class="hljs-keyword">for</span> resource <span class="hljs-keyword">in</span> resources_copy:
            <span class="hljs-keyword">try</span>:
                logger.info(<span class="hljs-string">f"获取 <span class="hljs-subst">{resource.name}</span> 的资源描述"</span>)
                descriptions = <span class="hljs-keyword">await</span> resource.get_resource_descriptions()
                result.extend(descriptions)
                logger.debug(<span class="hljs-string">f"<span class="hljs-subst">{resource.name}</span> 提供了 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(descriptions)}</span> 个资源描述"</span>)
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                logger.error(<span class="hljs-string">f"获取 <span class="hljs-subst">{resource.name}</span> 的描述失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>, exc_info=<span class="hljs-literal">True</span>)
        <span class="hljs-keyword">return</span> result
</code></pre>
<p><strong>封装后的资源基类：主要是借助__init_subclass__方法自动注册</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseResource</span>:
    <span class="hljs-string">"""资源基类"""</span>
    name: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span>
    description: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span>
    uri: AnyUrl
    mimeType: <span class="hljs-built_in">str</span> = <span class="hljs-string">"text/plain"</span>
    auto_register: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init_subclass__</span>(<span class="hljs-params">cls, **kwargs</span>):
        <span class="hljs-string">"""子类初始化时自动注册到资源注册表"""</span>
        <span class="hljs-built_in">super</span>().__init_subclass__(**kwargs)
        <span class="hljs-keyword">if</span> cls.auto_register <span class="hljs-keyword">and</span> cls.uri <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:  <span class="hljs-comment"># 只注册有 uri 的资源</span>
            ResourceRegistry.register(cls)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_resource_descriptions</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[Resource]:
        <span class="hljs-string">"""获取资源描述，子类必须实现"""</span>
        <span class="hljs-keyword">raise</span> NotImplementedError
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_resource</span>(<span class="hljs-params">self, uri: AnyUrl</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""读取资源内容，子类必须实现"""</span>
        <span class="hljs-keyword">raise</span> NotImplementedError
</code></pre>
<p><strong>实现 MySQL 资源类：值得注意的是此处我们在设计时迫于上面的机制又设计了表资源类TableResource</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TableResource</span>(<span class="hljs-title class_ inherited__">BaseResource</span>):
    <span class="hljs-string">"""代表具体表资源的类"""</span>
    auto_register: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>
    
    TABLE_EXISTS_QUERY = <span class="hljs-string">"""
        SELECT COUNT(*) AS table_exists
        FROM information_schema.tables
        WHERE table_schema = %s AND table_name = %s
    """</span>
    
    COLUMN_METADATA_QUERY = <span class="hljs-string">"""
        SELECT COLUMN_NAME, DATA_TYPE
        FROM information_schema.columns
        WHERE table_schema = %s AND table_name = %s
        ORDER BY ORDINAL_POSITION
    """</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, db_name: <span class="hljs-built_in">str</span>, table_name: <span class="hljs-built_in">str</span>, description: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.db_name = db_name
        self.table_name = table_name
        self.name = <span class="hljs-string">f"table: <span class="hljs-subst">{table_name}</span>"</span>
        self.uri = AnyUrl(<span class="hljs-string">f"mysql://<span class="hljs-subst">{db_name}</span>/<span class="hljs-subst">{table_name}</span>"</span>)
        self.description = description
        self.mimeType = <span class="hljs-string">"text/csv"</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_resource_descriptions</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[Resource]:
        <span class="hljs-string">"""返回数据库表资源的描述:已返回"""</span>
        <span class="hljs-keyword">return</span> []
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_resource</span>(<span class="hljs-params">self, uri: AnyUrl</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""安全读取数据库表数据为CSV格式（带列类型信息）"""</span>
        logger.info(<span class="hljs-string">f"开始读取资源: <span class="hljs-subst">{uri}</span>"</span>)
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 安全解析表名</span>
            table_name = extract_table_name(uri)
            logger.info(<span class="hljs-string">f"准备查询表: <span class="hljs-subst">{table_name}</span>"</span>)
            
            <span class="hljs-comment"># 获取列元数据（用于优化CSV生成）</span>
            column_metadata = <span class="hljs-keyword">await</span> self.get_table_metadata(table_name)
            
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> get_current_database_manager().get_connection() <span class="hljs-keyword">as</span> conn:
                <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> conn.cursor(aiomysql.DictCursor) <span class="hljs-keyword">as</span> cursor:
                    <span class="hljs-comment"># 使用参数化查询避免SQL注入</span>
                    safe_query = _build_safe_query(table_name)
                    <span class="hljs-keyword">await</span> cursor.execute(safe_query)
                    
                    <span class="hljs-comment"># 直接获取列名</span>
                    columns = [col[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> cursor.description]
                    rows = <span class="hljs-keyword">await</span> cursor.fetchall()
                    
                    logger.info(<span class="hljs-string">f"获取到 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(rows)}</span> 行数据"</span>)
                    
                    <span class="hljs-comment"># 使用优化的CSV生成</span>
                    <span class="hljs-keyword">return</span> generate_csv(columns, rows, column_metadata)
        
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"读取资源失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>, exc_info=<span class="hljs-literal">True</span>)
            <span class="hljs-keyword">raise</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_table_metadata</span>(<span class="hljs-params">self, table_name: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">tuple</span>]:
        <span class="hljs-string">"""获取表列名和数据类型"""</span>
        db_name = get_current_database_manager().get_current_config()[<span class="hljs-string">"database"</span>]
        
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> get_current_database_manager().get_connection() <span class="hljs-keyword">as</span> conn:
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> conn.cursor(aiomysql.DictCursor) <span class="hljs-keyword">as</span> cursor:
                <span class="hljs-comment"># 首先验证表存在</span>
                <span class="hljs-keyword">await</span> cursor.execute(self.TABLE_EXISTS_QUERY, (db_name, table_name))
                exists = <span class="hljs-keyword">await</span> cursor.fetchone()
                
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> exists <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> exists[<span class="hljs-string">'table_exists'</span>]:
                    <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"表 '<span class="hljs-subst">{table_name}</span>' 在数据库 '<span class="hljs-subst">{db_name}</span>' 中不存在"</span>)
                
                <span class="hljs-comment"># 获取列元数据</span>
                <span class="hljs-keyword">await</span> cursor.execute(self.COLUMN_METADATA_QUERY, (db_name, table_name))
                metadata = [(row[<span class="hljs-string">'COLUMN_NAME'</span>], row[<span class="hljs-string">'DATA_TYPE'</span>]) <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> <span class="hljs-keyword">await</span> cursor.fetchall()]
                
                <span class="hljs-keyword">return</span> metadata




<span class="hljs-keyword">class</span> <span class="hljs-title class_">MySQLResource</span>(<span class="hljs-title class_ inherited__">BaseResource</span>):
    <span class="hljs-string">"""MySQL数据库资源实现"""</span>
    name = <span class="hljs-string">"MySQL数据库"</span>
    uri = AnyUrl(<span class="hljs-string">f"mysql://localhost/default"</span>)
    description = <span class="hljs-string">"提供对MySQL数据库表的访问与查询"</span>
    mimeType = <span class="hljs-string">"text/csv"</span>
    auto_register = <span class="hljs-literal">True</span>
    
    <span class="hljs-comment"># 重用这些常量查询</span>
    TABLE_QUERY = <span class="hljs-string">"""
        SELECT TABLE_NAME AS table_name,
               TABLE_COMMENT AS table_comment,
               TABLE_ROWS AS estimated_rows
        FROM information_schema.tables
        WHERE table_schema = %s
    """</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""初始化资源管理"""</span>
        <span class="hljs-built_in">super</span>().__init__()
        self.cache = {}  <span class="hljs-comment"># 查询结果缓存</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_resource_descriptions</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[Resource]:
        <span class="hljs-string">"""获取数据库表资源描述（带缓存机制）"""</span>
        logger.info(<span class="hljs-string">"获取数据库资源描述"</span>)
        
        db_manager = get_current_database_manager()
        <span class="hljs-keyword">if</span> db_manager <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            logger.error(<span class="hljs-string">"无法获取数据库管理器，上下文未设置？"</span>)
            <span class="hljs-keyword">return</span> []
        
        db_name = db_manager.get_current_config().get(<span class="hljs-string">"database"</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> db_name:
            logger.error(<span class="hljs-string">"数据库配置中未指定数据库名称"</span>)
            <span class="hljs-keyword">return</span> []
        
        <span class="hljs-comment"># 使用缓存避免重复查询</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'table_descriptions'</span> <span class="hljs-keyword">in</span> self.cache:
            logger.debug(<span class="hljs-string">"使用缓存的表描述"</span>)
            <span class="hljs-keyword">return</span> self.cache[<span class="hljs-string">'table_descriptions'</span>]
        
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> db_manager.get_connection() <span class="hljs-keyword">as</span> conn:
                <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> conn.cursor(aiomysql.DictCursor) <span class="hljs-keyword">as</span> cursor:
                    <span class="hljs-keyword">await</span> cursor.execute(self.TABLE_QUERY, (db_name,))
                    tables = <span class="hljs-keyword">await</span> cursor.fetchall()
                    logger.info(<span class="hljs-string">f"发现 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(tables)}</span> 个数据库表"</span>)
                    
                    resources = []
                    <span class="hljs-keyword">for</span> table <span class="hljs-keyword">in</span> tables:
                        table_name = table[<span class="hljs-string">'table_name'</span>]
                        
                        <span class="hljs-comment"># 添加表行数统计</span>
                        description = table[<span class="hljs-string">'table_comment'</span>] <span class="hljs-keyword">or</span> <span class="hljs-string">f"<span class="hljs-subst">{table_name}</span> 表"</span>
                        <span class="hljs-keyword">if</span> table[<span class="hljs-string">'estimated_rows'</span>]:
                            description += <span class="hljs-string">f" (~<span class="hljs-subst">{table[<span class="hljs-string">'estimated_rows'</span>]}</span>行)"</span>
                        
                        <span class="hljs-comment"># 创建表资源</span>
                        table_resource = TableResource(db_name, table_name, description)
                        
                        <span class="hljs-comment"># 手动注册表资源实例</span>
                        ResourceRegistry.register_instance(table_resource)
                        
                        <span class="hljs-comment"># 创建资源描述对象</span>
                        resource_desc = Resource(
                            uri=table_resource.uri,
                            name=table_resource.name,
                            mimeType=table_resource.mimeType,
                            description=table_resource.description
                        )
                        resources.append(resource_desc)
                    
                    <span class="hljs-comment"># 缓存结果</span>
                    self.cache[<span class="hljs-string">'table_descriptions'</span>] = resources
                    logger.info(<span class="hljs-string">f"创建了 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(resources)}</span> 个表资源描述"</span>)
                    <span class="hljs-keyword">return</span> resources
        
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"获取资源描述失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>, exc_info=<span class="hljs-literal">True</span>)
            <span class="hljs-keyword">return</span> []
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_resource</span>(<span class="hljs-params">self, uri: AnyUrl</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""读取根资源内容 - 返回数据库信息"""</span>
        <span class="hljs-keyword">return</span> json.dumps({
            <span class="hljs-string">"name"</span>: self.name,
            <span class="hljs-string">"uri"</span>: self.uri,
            <span class="hljs-string">"description"</span>: self.description,
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"database_root"</span>
        })
</code></pre>
<p>想实现其他资源，就编写对应的脚本，然后将包加入到对应的__init__.py脚本中：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">from</span> <span class="hljs-selector-class">.db_resource</span> import MySQLResource, TableResource


__all__ = <span class="hljs-selector-attr">[    <span class="hljs-string">"MySQLResource"</span>,    <span class="hljs-string">"TableResource"</span>,]</span>
</code></pre>
<p>这样代码具有较高可扩展性，组织结构也很清晰。当然，也会有其他更好的实现方式。</p>
<p><strong>效果展示</strong></p>
<p>MCP Server 主要是通过工具暴露数据给LLMs，故基于上述的设计思路，实现起来相对简单且专一，主要就是实现工具所对应的 SQL 语句编写和对应的提示词即可，鉴于篇幅和代码量，此处不再展示源码，仅提供历史测试效果图。</p>
<p><strong>查询表中数据</strong></p>
<p>在 Cline 中配置好阿里通义千问大模型 API-KEY 后，进行提问： </p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82b11e5bc2c7454b82729de5c276b7d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=c6Hgf0s9SC0M2FC%2BZ1oc4naFxzs%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>⚠️：阿里通义千问大模型配置可参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fmodel-studio%2Fcline" target="_blank" title="https://help.aliyun.com/zh/model-studio/cline" ref="nofollow noopener noreferrer">help.aliyun.com/zh/model-st…</a></p>
<p>随后，大模型开始解析执行任务：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23489474801042e5988413b59ef3ec08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=Gqh9f%2By5j2mjKnT4RblRt7rukaQ%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>发现解析错了，开始自动矫正： </p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b50aee3b8af426990c420eaed7fe63a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=oCSNDPEUdOBsHAikBZydqm8gNdQ%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>OK，现在看起来就对多了，开始执行工具运行指令并返回结果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a30e51011094d87933fa45a04439b88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=fJeROGH%2F7ZK7EWsisdHcLTfLUU4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>最终执行结果如下：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61ad13ea574344aba8bc40dd57c26f08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=k8sIx3h8zjwQ7hxhaoLEZ4sGU88%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>其他的比如：查询某表中告警信息。此处给出了明确的库表信息，回答的就很精准。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7713b0a8cfc94bb7938dc5917e85c9b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=KrQg3AfNZkd8eNSB4sQtVetaOvo%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>慢SQL优化</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb4164be51a7496891a351ff091b844e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=4TUEajo1PYSTiTb%2BNl2KpHnigpA%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>大模型在执行一些工具之后，给出了回答：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1fbb3b0cef84d83a63f9635591cf56c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=%2FzcZB7jnSQhwZysnreVp66cSjnc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>并最终给出了如下预期效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d63453dbb4324438abe4f5aa7dca1e92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=UtPdSA7KLY%2B1Z63L00SQ8r32cC4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>高危操作验证</strong></p>
<p>在执行高危 SQL 语句前，会拦截并作解析，判断是否与预先允许的操作一致，不一致则不放行，模型无法操作数据库，报错终止任务。<strong>目前权限限定为查询操作 DQL</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7ddbb08c32c416f977c3142833563da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=fLUSeumR2B6Sml5uzJfezzd7LBk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>当想更新表中数据时：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16b9b5ddb3ad47f49d346f17057bebea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=jGDuPa%2F5Kat2qP%2FWn4uKnrSAhl8%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d535c51b76304dc5a652278af834f9aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=Uh5uvUicf4%2B4ToQoMI2P%2Bvic%2Fek%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>自建客户端提问</strong></p>
<p>实现自定义客户端时可调用服务端提示词进行任务编排，提高工具调用准确度和规避一连串的客户端continue操作，通过请求实现的FastAPI接口可直接运行出结果。</p>
<pre><code class="hljs">当前数据库基本信息，以及包含哪些表，同时用户表有哪些字段。
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d798e78e854a4594b455b7bd1166c4e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=pfvotBHzn44Jl8EsAMNyD5QeD6w%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6f043da60d74dfc9f33127198c09f53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=yy%2F7JITZaN3V2%2FX8q89I17NZTRM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>线上部署测试效果</strong></p>
<p>我们在 MCP 应用市场中上架了一个版本的 DW-DBA-MCP 服务，在 VSCode 中安装 EP-Copilot 插件即可安装使用该服务。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c9791bcc29d45a6abc5c91807fe470d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=jIjYiw6O4WnADzXic%2B7abAG%2F%2FWE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>然后在聊天界面中选择agent模式即可让 LLMs 选择合适的工具处理您的提问（注意为服务配置环境变量）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e08c232d8d24503950d0c2a62c2a294~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=wdkJYOzj9BjdanrAPmDAHgpMEQY%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/972c44c730ba4100bb96417007464ae4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765875349&amp;x-signature=Q4sCax34ZrykWl%2FjHBp3vwfGYd0%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-12">五、未来规划</h2>
<p>在<strong>AI4DB</strong>（AI for Database）领域，AI 技术正颠覆传统数据库的运维与调优逻辑，推动其从依赖人工介入的被动响应模式，全面迈向可自主诊断、智能调优、故障自愈的全链路智能自治新阶段，大幅降低运维成本的同时提升了数据库系统的稳定性与运行效率。</p>
<p>而在<strong>DB4AI</strong>（Database for AI）方向，适配 AI 场景的数据库解决方案已实现关键突破：不仅具备高性能向量检索、复杂分析计算及强事务一致性等核心能力，还能原生支持文本、图像等多模态数据的一体化存储与管理，为 AI 模型训练与推理提供了高效、可靠的数据基座。</p>
<p>在技术格局剧变的背景下，DBA 的角色定位也迎来重构。传统意义上，DBA 即 Database Administrator（数据库管理员），核心聚焦于数据库的日常运维与技术保障；但随着 AI 技术的井喷式发展，DBA 已突破单一运维属性，可进阶为<strong>Data Business Architect（数据业务架构师</strong>）—— 借助 AI 工具与能力，DBA 能从海量数据中挖掘潜藏价值，打通数据与业务的链路，实现技术能力向业务价值的转化。</p>
<p>面向未来，DBA 团队将持续强化两大核心能力：一是筑牢数据安全防线，构建全周期数据安全治理体系；二是夯实工程化落地能力，推动智能技术与业务场景的深度融合。以此为基础，充分释放 DBA 在数据库 “智能自治运维” 与 “全域数据价值挖掘” 领域的双重价值，为企业数字化与智能化转型提供坚实的数据支撑。</p>
<h2 data-id="heading-13">六、资源推荐</h2>

























<table><thead><tr><th><strong>资源</strong></th><th><strong>内容</strong></th></tr></thead><tbody><tr><td><strong>MCP Server 社区仓库推荐</strong></td><td>-   <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmodelcontextprotocol%2Fservers" target="_blank" title="https://github.com/modelcontextprotocol/servers" ref="nofollow noopener noreferrer">github.com/modelcontex…</a>  <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpunkpeye%2Fawesome-mcp-servers" target="_blank" title="https://github.com/punkpeye/awesome-mcp-servers" ref="nofollow noopener noreferrer">github.com/punkpeye/aw…</a></td></tr><tr><td><strong>当前支持 MCP 协议的客户端应用</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fclients" target="_blank" title="https://modelcontextprotocol.io/clients" ref="nofollow noopener noreferrer">modelcontextprotocol.io/clients</a></td></tr><tr><td><strong>MCP 市场</strong></td><td>-   <strong>ModelScope：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelscope.cn%2Fmcp" target="_blank" title="https://modelscope.cn/mcp" ref="nofollow noopener noreferrer">modelscope.cn/mcp</a></td></tr><tr><td><strong>百炼 MCP 市场：</strong></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fbailian.console.aliyun.com%2F%3Ftab%3Dmcp%23%2Fmcp-market" target="_blank" title="https://bailian.console.aliyun.com/?tab=mcp#/mcp-market" ref="nofollow noopener noreferrer">bailian.console.aliyun.com/?tab=mcp#/m…</a></td></tr></tbody></table>
<p><strong>参考资料：</strong></p>
<p>[1] 一文带你 "看见" MCP 的过程，彻底理解 MCP 的概念（<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.aliyun.com%2Farticle%2F1665090%25EF%25BC%2589" target="_blank" title="https://developer.aliyun.com/article/1665090%EF%BC%89" ref="nofollow noopener noreferrer">developer.aliyun.com/article/166…</a></p>
<p>[2] 100行代码讲透MCP原理（<a href="https://link.juejin.cn?target=https%3A%2F%2Fai.programnotes.cn%2Fp%2F100%25E8%25A1%258C%25E4%25BB%25A3%25E7%25A0%2581%25E8%25AE%25B2%25E9%2580%258Fmcp%25E5%258E%259F%25E7%2590%2586%2F%25EF%25BC%2589" target="_blank" title="https://ai.programnotes.cn/p/100%E8%A1%8C%E4%BB%A3%E7%A0%81%E8%AE%B2%E9%80%8Fmcp%E5%8E%9F%E7%90%86/%EF%BC%89" ref="nofollow noopener noreferrer">ai.programnotes.cn/p/100%E8%A1…</a></p>
<h3 data-id="heading-14">往期回顾</h3>
<p>1. 项目性能优化实践：深入FMP算法原理探索｜得物技术</p>
<p>2. Dragonboat统一存储LogDB实现分析｜得物技术</p>
<p>3. 从数字到版面：得物数据产品里数字格式化的那些事</p>
<p>4. 一文解析得物自建 Redis 最新技术演进</p>
<p>5. Golang HTTP请求超时与重试：构建高可靠网络请求｜得物技术</p>
<h3 data-id="heading-15">文 /少晖、洪兆</h3>
<p>关注得物技术，每周更新技术干货</p>
<p>要是觉得文章对你有帮助的话，欢迎评论转发点赞～</p>
<p>未经得物技术许可严禁转载，否则依法追究法律责任。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[知识库创业复盘：从闭源到开源，这3个教训价值百万]]></title>    <link>https://juejin.cn/post/7581872532363755529</link>    <guid>https://juejin.cn/post/7581872532363755529</guid>    <pubDate>2025-12-10T10:33:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581872532363755529" data-draft-id="7582041304654512174" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="知识库创业复盘：从闭源到开源，这3个教训价值百万"/> <meta itemprop="keywords" content="JavaScript,GitHub,前端"/> <meta itemprop="datePublished" content="2025-12-10T10:33:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="徐小夕"/> <meta itemprop="url" content="https://juejin.cn/user/3808363978429613"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            知识库创业复盘：从闭源到开源，这3个教训价值百万
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363978429613/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    徐小夕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T10:33:48.000Z" title="Wed Dec 10 2025 10:33:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>"把知识库代码公开到 github 上的那天，我失眠到凌晨四点。</p>
<p>不是因为激动，是害怕——害怕一年心血被一键复制，害怕客户部署了就没有采购的欲望了。</p>
<p>120 天后再回头看，正是那次'裸奔'，才救活了公司，也重塑了我对商业护城河的所有认知。</p>
<p>今天把决策前后最痛的 3 个教训掏出来，能帮你省下至少 100 万试错成本。"</p>
</blockquote>
<p>关注我的朋友也许了解，我们24年年初，上线了一款知识库产品——橙子轻文档。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9710aa201d0e482792e40d2f1df3cf4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765967628&amp;x-signature=poXiskH2ppEm70OaAKQLGVsJmds%3D" alt="图片" loading="lazy"/></p>
<p>github地址：</p>
<p>我一直觉得「在线办公工具」是个矛盾体：要么功能全但收费贵（比如某钉、某飞），要么免费但功能零散（比如单独的在线文档、独立的思维导图工具）。所以我们决定花半年时间打造 <strong>OfficeHub</strong> 这个项目，把「文档 + 表格 + 思维导图 + AI + 知识库」完美的融合成一个办公智能体。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d7de8d946214c1b903d6f30f53495cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765967628&amp;x-signature=u5ow0Nttm4T1JZfHsAW94OIRcJU%3D" alt="图片" loading="lazy"/></p>
<p><strong>核心定位：基于 Web 的开源在线办公协作平台，集成文档编辑、思维导图、电子表格、AI 创作、模板管理和知识库功能。</strong> <strong>简单说，OfficeHub 想做的是「办公工具界的瑞士军刀」：不用切换多个平台，一个系统搞定从内容创作到知识沉淀的全流程。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/627e4a066e2c4971825cd9841f87e489~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765967628&amp;x-signature=TZVDKeYXyGgz98oVREksTS%2B1iMo%3D" alt="图片" loading="lazy"/></p>
<p>但是上线运营了3个月之后，虽然积累了上千的用户使用，但是也发现了很多商业上的问题。接下来我会系统复盘一下，橙子轻文档创业的一些经验和教训。</p>
<h2 data-id="heading-0">01 教训一：把"闭源"当护城河，其实是给自己挖坟</h2>
<h3 data-id="heading-1">1. 自嗨式壁垒</h3>
<ul>
<li>我们曾花 2 个月自研「文档搭建引擎」，体验类比 Notion，PPT 里写满"技术壁垒"。</li>
<li>闭源 6 个月，GitHub 只有 12 个 star，其中 3 个还是团队成员小号。</li>
</ul>
<h3 data-id="heading-2">2. 客户用脚投票</h3>
<ul>
<li>企业版客单价 3 万，成交周期 60 天，我天天被客户问："有没有 API？能不能二开？"</li>
<li>一次 POC，客户 IT 总监直接甩出飞书知识库组件："你们不开放，我就不买。"</li>
</ul>
<h3 data-id="heading-3">3. 致命瞬间</h3>
<p>去年 9 月，账上现金只剩 2 个月，一位也在创业的朋友问我：</p>
<blockquote>
<p>"如果 Notion 明天开源，你们还剩什么？" 我答不上来，那一刻我知道：闭源不是墙，是牢笼。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">02 教训二：开源不是"做慈善"，是"放鱼饵"</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22a44e91fc154610a38690d58bf3ecd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6Q5bCP5aSV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765967628&amp;x-signature=NgKxzcJEcsWSVtfaJ1ieY%2BkzqQU%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-5">上面是我们开源了编译版之后的 github 截图。</h2>
<h3 data-id="heading-6">1. 120 天数据对比</h3>

























<table><thead><tr><th align="left">指标</th><th align="left">闭源末期</th><th align="left">开源 +120 天</th></tr></thead><tbody><tr><td align="left">新增线索</td><td align="left">68 条</td><td align="left">300 条</td></tr><tr><td align="left">企业版演示</td><td align="left">1-3 次/月</td><td align="left">10 次/月</td></tr><tr><td align="left"/><td align="left"/><td align="left"/></tr></tbody></table>
<h3 data-id="heading-7">2. 鱼饵配方</h3>
<p>我们把知识库编译版代码开源了，让用户可以直接本地安装和部署，保证数据的绝对安全，同时还能在本地环境体验，测试。</p>
<ul>
<li><strong>Apache 模块</strong> → 审计日志、合规，企业刚需；</li>
<li><strong>云原生插件</strong> → 只给二进制，订阅解锁。</li>
</ul>
<blockquote>
<p>开发者爽了，企业慌了，我们笑了。开源第 7 天，一家头部券商主动约演示："我们发现本地体验不错，想二次开发，买商业源码授权多少钱？"</p>
</blockquote>
<h3 data-id="heading-8">这个时候我才发现，让客户能用起来，比说产品亮点说1万遍都有用。</h3>
<p>虽然开源后，很多没有二次开发需求的企业，直接用我们的源码部署到自己服务器上作为私有知识库使用，但是这间接的提高了我们产品的影响力，进而带来了真正有二次开发需求的潜在客户。</p>
<h2 data-id="heading-9">03 教训三：开源节奏错了，同样会死</h2>
<h3 data-id="heading-10">1. 一步错，全盘输</h3>
<p>同期友商 B 直接把 100% 代码 GPL 开源，结果：</p>
<ul>
<li>企业客户担心"被传染"，不敢用；</li>
<li>社区开发者发现没"高级功能"，star 数暴涨却无人续费；</li>
<li>3 个月后资金链断裂，核心团队被大厂打包挖走。</li>
</ul>
<h3 data-id="heading-11">2. 三把尺子，决定"先开哪块"</h3>

























<table><thead><tr><th align="left">尺子</th><th align="left">先开源</th><th align="left">后闭源</th></tr></thead><tbody><tr><td align="left">技术壁垒低</td><td align="left">✓ 编辑器 UI</td><td align="left">✗ 协同算法</td></tr><tr><td align="left">获客需求强</td><td align="left">✓ 导入工具</td><td align="left">✗ 审计日志</td></tr><tr><td align="left">合规风险高</td><td align="left">✗ 国密加密</td><td align="left">✓ 私有部署脚本</td></tr></tbody></table>
<blockquote>
<p>一句话：<strong>让开发者爽在先，让企业怕在后。</strong></p>
</blockquote>
<h3 data-id="heading-12">3. 节奏表</h3>
<ul>
<li><strong>0-3 个月</strong>：放编辑器 + 基础 API，拉 star、拉社群；</li>
<li><strong>3-6 个月</strong>：放权限框架 50%，留 GPL 暗钩，销售跟进；</li>
<li><strong>6 个月后</strong>：逐步闭源高阶合规模块，推出订阅制。</li>
</ul>
<h2 data-id="heading-13">04 彩蛋：开源那晚，我们在代码里藏了一句 joke</h2>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// If you find this line, call cxzk_168,// we will send you a crate of oranges.</span>
</code></pre>
<p>结果真有 3 个开发者联系我，我们按约寄出橙子，其中一人后来成了橙子轻文档的客户。</p>
<p><strong>你看，诚意永远是最便宜的 PR。</strong></p>
<h2 data-id="heading-14">05 如果你只能记住三句话</h2>
<ol>
<li>闭源不是护城河，是拦路墙，越早推倒越省钱。</li>
<li>开源不是全裸，是"比基尼"——露得恰到好处，才让人想花钱看里面。</li>
<li>节奏 &gt; 决心，先让社区爽，再让客户怕，最后让公司活下来。</li>
</ol>
<p>把代码公开那天，我以为会失去一切；<br/>
120 天后才发现，<strong>真正的护城河，是与客户一起进化和成长。</strong></p>
<p>愿这 3 条价值百万的教训，帮你少失眠 180 个夜晚。</p>
<p>橙子已熟，等你来摘。</p>
<p>github地址：</p>
<p>目 橙子轻文档 由于用户量过多，目前只做为演示使用，切勿传个人敏感数据。</p>
<p>如果大家想线上管理知识笔记，大家可以移步我们的新产品——<strong>FlowmixAI</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 插槽（Slot）完全指南：从基础到实战的灵活组件通信方案]]></title>    <link>https://juejin.cn/post/7581412054903128073</link>    <guid>https://juejin.cn/post/7581412054903128073</guid>    <pubDate>2025-12-09T03:57:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581412054903128073" data-draft-id="7581412607060951086" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 插槽（Slot）完全指南：从基础到实战的灵活组件通信方案"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-09T03:57:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三小河"/> <meta itemprop="url" content="https://juejin.cn/user/4222562141210478"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 插槽（Slot）完全指南：从基础到实战的灵活组件通信方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4222562141210478/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三小河
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T03:57:40.000Z" title="Tue Dec 09 2025 03:57:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    37
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在组件化开发中，插槽（Slot）是实现组件内容分发与灵活扩展的核心技术。Vue、Angular 等框架原生支持插槽语法，而 React 虽未提供内置的 <code>&lt;slot&gt;</code> 标签，但通过 <code>props</code>、组件组合等原生能力，能实现更灵活、更强大的插槽效果。本文将系统拆解 React 插槽的实现方案，辨析常见用法的合理性，结合全新实例详解从基础到高级的应用场景，帮助开发者掌握组件复用与扩展的核心技巧。</p>
<h2 data-id="heading-0">一、React 插槽的核心原理与合理性辨析</h2>
<p>React 插槽的本质是<strong>组件间的内容传递与渲染控制</strong>，核心依赖 React 的 <code>children</code> 属性、props 传递机制以及组件组合思想。在分析常见实现方案前，先明确核心原则：</p>
<ul>
<li>正确方向：利用 React 原生特性（<code>children</code>、props、Context 等）实现内容分发，不依赖非标准 API，保证组件复用性与可维护性；</li>
<li>常见误区：过度封装复杂逻辑（如不必要的 Context 嵌套）、忽略性能优化（如每次渲染创建新组件）、混淆插槽与普通 props 的使用场景。</li>
</ul>
<p>下面将通过「基础→进阶→高级」的顺序，详解各类插槽的正确实现方式，并补充全新实例说明。</p>
<h2 data-id="heading-1">二、基础插槽：<code>children</code> prop （默认插槽）</h2>
<p><code>children</code> 是 React 组件的内置 prop，用于接收组件标签包裹的所有内容，是实现「默认插槽」的最简方案，适用于无需分区的简单内容传递场景。</p>
<h3 data-id="heading-2">核心特性与正确用法</h3>
<ul>
<li>自动接收组件包裹的所有节点（元素、文本、组件等）；</li>
<li>支持设置默认内容，处理无传入内容的边界情况；</li>
<li>无需额外配置，原生支持，性能最优。</li>
<li>
<h3 data-id="heading-3">实例 1：基础卡片组件（默认插槽）</h3>
</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 子组件：基础卡片（支持默认内容）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">BasicCard</span>(<span class="hljs-params">{ children, className }</span>) {
  <span class="hljs-comment">// 边界处理：无传入内容时显示默认提示</span>
  <span class="hljs-keyword">const</span> defaultContent = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"card-default"</span>&gt;</span>暂无内容<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">card</span> ${<span class="hljs-attr">className</span> || ''}`} <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> 
      <span class="hljs-attr">border:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">eee</span>', 
      <span class="hljs-attr">borderRadius:</span> '<span class="hljs-attr">8px</span>', 
      <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>', 
      <span class="hljs-attr">maxWidth:</span> '<span class="hljs-attr">300px</span>' 
    }}&gt;</span>
      {children || defaultContent}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 父组件：使用卡片组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', <span class="hljs-attr">gap:</span> '<span class="hljs-attr">20px</span>', <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>' }}&gt;</span>
      {/* 传入自定义内容 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">BasicCard</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"user-card"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">img</span> 
          <span class="hljs-attr">src</span>=<span class="hljs-string">"https://via.placeholder.com/80"</span> 
          <span class="hljs-attr">alt</span>=<span class="hljs-string">"用户头像"</span> 
          <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">borderRadius:</span> '<span class="hljs-attr">50</span>%', <span class="hljs-attr">marginBottom:</span> '<span class="hljs-attr">10px</span>' }}
        /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">margin:</span> '<span class="hljs-attr">0</span> <span class="hljs-attr">0</span> <span class="hljs-attr">8px</span> <span class="hljs-attr">0</span>' }}&gt;</span>李华<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">margin:</span> '<span class="hljs-attr">0</span>', <span class="hljs-attr">color:</span> '#<span class="hljs-attr">666</span>' }}&gt;</span>前端开发工程师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">BasicCard</span>&gt;</span>

      {/* 未传入内容（显示默认值） */}
      <span class="hljs-tag">&lt;<span class="hljs-name">BasicCard</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"empty-card"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-4">实例 2：带条件渲染的默认插槽</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 子组件：通知组件（根据类型显示不同默认图标）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Notification</span>(<span class="hljs-params">{ children, type = <span class="hljs-string">'info'</span> }</span>) {
  <span class="hljs-comment">// 根据类型生成默认图标</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getDefaultIcon</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">switch</span>(type) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'success'</span>: <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '<span class="hljs-attr">green</span>' }}&gt;</span>✅<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'error'</span>: <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '<span class="hljs-attr">red</span>' }}&gt;</span>❌<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'warning'</span>: <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '<span class="hljs-attr">orange</span>' }}&gt;</span>⚠️<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>;
      <span class="hljs-attr">default</span>: <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '<span class="hljs-attr">blue</span>' }}&gt;</span>ℹ️<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>;
    }
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> 
      <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', 
      <span class="hljs-attr">alignItems:</span> '<span class="hljs-attr">center</span>', 
      <span class="hljs-attr">gap:</span> '<span class="hljs-attr">8px</span>', 
      <span class="hljs-attr">padding:</span> '<span class="hljs-attr">12px</span>', 
      <span class="hljs-attr">backgroundColor:</span> '#<span class="hljs-attr">f5f5f5</span>', 
      <span class="hljs-attr">borderRadius:</span> '<span class="hljs-attr">4px</span>' 
    }}&gt;</span>
      {getDefaultIcon()}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 父组件使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>', <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', <span class="hljs-attr">flexDirection:</span> '<span class="hljs-attr">column</span>', <span class="hljs-attr">gap:</span> '<span class="hljs-attr">10px</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Notification</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"success"</span>&gt;</span>操作成功！<span class="hljs-tag">&lt;/<span class="hljs-name">Notification</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Notification</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"error"</span>&gt;</span>提交失败，请重试<span class="hljs-tag">&lt;/<span class="hljs-name">Notification</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Notification</span>&gt;</span>这是一条普通通知<span class="hljs-tag">&lt;/<span class="hljs-name">Notification</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-5">三、命名插槽：多区域内容精准分发</h2>
<p>当组件需要划分多个固定区域（如头部、主体、底部）时，使用「命名插槽」实现精准内容分发。React 中无原生「命名插槽」语法，但通过「多 props 传递」或「children 对象」两种方案均可实现，适用于布局组件、复杂卡片等场景。</p>
<h3 data-id="heading-6">方案 1：多 props 传递（推荐，简洁直观）</h3>
<p>通过不同名称的 props 接收不同区域的内容，是最常用的命名插槽实现方式，可读性强，易于维护。</p>
<h4 data-id="heading-7">实例：页面布局组件（头部、侧边栏、主体、底部）</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 子组件：布局组件（定义 4 个命名插槽）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">PageLayout</span>(<span class="hljs-params">{ header, sidebar, content, footer, isSidebarLeft = <span class="hljs-literal">true</span> }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', <span class="hljs-attr">flexDirection:</span> '<span class="hljs-attr">column</span>', <span class="hljs-attr">minHeight:</span> '<span class="hljs-attr">100vh</span>' }}&gt;</span>
      {/* 头部插槽 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> 
        <span class="hljs-attr">backgroundColor:</span> '#<span class="hljs-attr">2c3e50</span>', 
        <span class="hljs-attr">color:</span> '<span class="hljs-attr">white</span>', 
        <span class="hljs-attr">padding:</span> '<span class="hljs-attr">16px</span>', 
        <span class="hljs-attr">textAlign:</span> '<span class="hljs-attr">center</span>' 
      }}&gt;</span>
        {header}
      <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>

      {/* 主体+侧边栏容器 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', <span class="hljs-attr">flex:</span> <span class="hljs-attr">1</span> }}&gt;</span>
        {/* 侧边栏插槽（支持左右切换） */}
        {isSidebarLeft &amp;&amp; (
          <span class="hljs-tag">&lt;<span class="hljs-name">aside</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> 
            <span class="hljs-attr">width:</span> '<span class="hljs-attr">200px</span>', 
            <span class="hljs-attr">backgroundColor:</span> '#<span class="hljs-attr">ecf0f1</span>', 
            <span class="hljs-attr">padding:</span> '<span class="hljs-attr">16px</span>', 
            <span class="hljs-attr">borderRight:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ddd</span>' 
          }}&gt;</span>
            {sidebar}
          <span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
        )}

        {/* 主体内容插槽 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">flex:</span> <span class="hljs-attr">1</span>, <span class="hljs-attr">padding:</span> '<span class="hljs-attr">24px</span>' }}&gt;</span>
          {content}
        <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>

        {!isSidebarLeft &amp;&amp; (
          <span class="hljs-tag">&lt;<span class="hljs-name">aside</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> 
            <span class="hljs-attr">width:</span> '<span class="hljs-attr">200px</span>', 
            <span class="hljs-attr">backgroundColor:</span> '#<span class="hljs-attr">ecf0f1</span>', 
            <span class="hljs-attr">padding:</span> '<span class="hljs-attr">16px</span>', 
            <span class="hljs-attr">borderLeft:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ddd</span>' 
          }}&gt;</span>
            {sidebar}
          <span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
        )}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      {/* 底部插槽 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">footer</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> 
        <span class="hljs-attr">backgroundColor:</span> '#<span class="hljs-attr">2c3e50</span>', 
        <span class="hljs-attr">color:</span> '<span class="hljs-attr">white</span>', 
        <span class="hljs-attr">padding:</span> '<span class="hljs-attr">8px</span>', 
        <span class="hljs-attr">textAlign:</span> '<span class="hljs-attr">center</span>' 
      }}&gt;</span>
        {footer}
      <span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 父组件使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">PageLayout</span>
      // <span class="hljs-attr">头部插槽内容</span>
      <span class="hljs-attr">header</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">h1</span>&gt;</span>我的博客<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>}
      // 侧边栏插槽内容
      sidebar={
        <span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', <span class="hljs-attr">flexDirection:</span> '<span class="hljs-attr">column</span>', <span class="hljs-attr">gap:</span> '<span class="hljs-attr">12px</span>' }}&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '#<span class="hljs-attr">333</span>', <span class="hljs-attr">textDecoration:</span> '<span class="hljs-attr">none</span>' }}&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/article"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '#<span class="hljs-attr">333</span>', <span class="hljs-attr">textDecoration:</span> '<span class="hljs-attr">none</span>' }}&gt;</span>文章列表<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/about"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '#<span class="hljs-attr">333</span>', <span class="hljs-attr">textDecoration:</span> '<span class="hljs-attr">none</span>' }}&gt;</span>关于我<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
      }
      // 主体插槽内容
      content={
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>React 插槽详解<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>本文介绍 React 中插槽的多种实现方式，帮助开发者灵活扩展组件...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      }
      // 底部插槽内容
      footer={<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>© 2025 我的博客 版权所有<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>}
      // 侧边栏在右侧
      isSidebarLeft={false}
    /&gt;</span>
  );
}
</code></pre>
<h3 data-id="heading-8">方案 2：children 对象（模拟 Vue 具名插槽语法）</h3>
<p>将 <code>children</code> 设计为对象，键名为插槽名称，键值为插槽内容，语法更接近 Vue 的具名插槽，适用于习惯 Vue 语法的开发者， 不推荐使用，不直观多此一举</p>
<h4 data-id="heading-9">实例：商品卡片组件（标题、描述、价格、操作区）</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 子组件：商品卡片（接收 children 对象作为命名插槽）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductCard</span>(<span class="hljs-params">{ children, style }</span>) {
  <span class="hljs-comment">// 解构插槽内容，设置默认值</span>
  <span class="hljs-keyword">const</span> { 
    title = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>默认商品名称<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></span>,
    description = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>暂无商品描述<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>,
    price = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '<span class="hljs-attr">red</span>' }}&gt;</span>¥0.00<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>,
    action = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>加入购物车<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  } = children || {};

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> 
      <span class="hljs-attr">border:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">eee</span>', 
      <span class="hljs-attr">borderRadius:</span> '<span class="hljs-attr">8px</span>', 
      <span class="hljs-attr">padding:</span> '<span class="hljs-attr">16px</span>', 
      <span class="hljs-attr">width:</span> '<span class="hljs-attr">280px</span>',
      <span class="hljs-attr">...style</span>
    }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginBottom:</span> '<span class="hljs-attr">12px</span>' }}&gt;</span>{title}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginBottom:</span> '<span class="hljs-attr">12px</span>', <span class="hljs-attr">color:</span> '#<span class="hljs-attr">666</span>', <span class="hljs-attr">fontSize:</span> '<span class="hljs-attr">14px</span>' }}&gt;</span>{description}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginBottom:</span> '<span class="hljs-attr">16px</span>', <span class="hljs-attr">fontSize:</span> '<span class="hljs-attr">18px</span>', <span class="hljs-attr">fontWeight:</span> '<span class="hljs-attr">bold</span>' }}&gt;</span>{price}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">textAlign:</span> '<span class="hljs-attr">center</span>' }}&gt;</span>{action}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 父组件使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', <span class="hljs-attr">gap:</span> '<span class="hljs-attr">20px</span>', <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ProductCard</span>&gt;</span>
        {{
          title: <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">margin:</span> '<span class="hljs-attr">0</span>' }}&gt;</span>无线蓝牙耳机<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>,
          description: <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">margin:</span> '<span class="hljs-attr">0</span>' }}&gt;</span>降噪功能 | 续航24小时 | 防水防汗<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>,
          price: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '<span class="hljs-attr">red</span>' }}&gt;</span>¥399.00<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>,
          action: (
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', <span class="hljs-attr">gap:</span> '<span class="hljs-attr">8px</span>', <span class="hljs-attr">justifyContent:</span> '<span class="hljs-attr">center</span>' }}&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">6px</span> <span class="hljs-attr">12px</span>', <span class="hljs-attr">backgroundColor:</span> '#<span class="hljs-attr">42b983</span>', <span class="hljs-attr">color:</span> '<span class="hljs-attr">white</span>', <span class="hljs-attr">border:</span> '<span class="hljs-attr">none</span>', <span class="hljs-attr">borderRadius:</span> '<span class="hljs-attr">4px</span>' }}&gt;</span>
                加入购物车
              <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">6px</span> <span class="hljs-attr">12px</span>', <span class="hljs-attr">backgroundColor:</span> '#<span class="hljs-attr">fff</span>', <span class="hljs-attr">color:</span> '#<span class="hljs-attr">42b983</span>', <span class="hljs-attr">border:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">42b983</span>', <span class="hljs-attr">borderRadius:</span> '<span class="hljs-attr">4px</span>' }}&gt;</span>
                立即购买
              <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          )
        }}
      <span class="hljs-tag">&lt;/<span class="hljs-name">ProductCard</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">ProductCard</span>&gt;</span>
        {{
          title: <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">margin:</span> '<span class="hljs-attr">0</span>' }}&gt;</span>智能手表<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>,
          price: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '<span class="hljs-attr">red</span>' }}&gt;</span>¥899.00<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          // 未传入 description 和 action，使用默认值
        }}
      <span class="hljs-tag">&lt;/<span class="hljs-name">ProductCard</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-10">四、作用域插槽：子组件向父组件传递数据</h2>
<p>作用域插槽（Scoped Slot）的核心是「子组件提供数据，父组件决定如何渲染」，适用于子组件持有数据但渲染逻辑需灵活定制的场景（如列表渲染、数据展示格式化）。React 中通过「render props」或「函数作为 children」实现，两者本质一致，均是将数据通过函数参数传递给父组件。</p>
<h3 data-id="heading-11">方案 1：函数作为 children（更简洁，推荐）</h3>
<p>直接将 <code>children</code> 设计为函数，子组件调用该函数时传入数据，父组件通过函数参数接收数据并渲染。</p>
<h4 data-id="heading-12">实例：用户列表组件（子组件提供用户数据，父组件定制渲染）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 子组件：用户列表（提供数据，暴露给父组件渲染）</span>
<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">UserList</span>({ <span class="hljs-selector-tag">data</span>, <span class="hljs-selector-tag">children</span> }) {
  <span class="hljs-selector-tag">if</span> (!data || data.length === <span class="hljs-number">0</span>) {
    <span class="hljs-selector-tag">return</span> &lt;<span class="hljs-selector-tag">div</span> <span class="hljs-selector-tag">style</span>={{ <span class="hljs-attribute">padding</span>: <span class="hljs-string">'20px'</span>, <span class="hljs-attribute">textAlign</span>: <span class="hljs-string">'center'</span>, <span class="hljs-attribute">color</span>: <span class="hljs-string">'#666'</span> }}&gt;暂无用户数据&lt;/div&gt;;
  }

  return (
    &lt;div style={{ <span class="hljs-attribute">border</span>: <span class="hljs-string">'1px solid #eee'</span>, <span class="hljs-attribute">borderRadius</span>: <span class="hljs-string">'8px'</span>, <span class="hljs-attribute">overflow</span>: <span class="hljs-string">'hidden'</span> }}&gt;
      {data.<span class="hljs-built_in">map</span>((user, index) =&gt; (
        <span class="hljs-comment">// 调用 children 函数，传递用户数据和索引</span>
        &lt;div 
          key={user.id} 
          style={{ 
            <span class="hljs-attribute">padding</span>: <span class="hljs-string">'16px'</span>, 
            <span class="hljs-attribute">borderBottom</span>: index &lt; data.length - <span class="hljs-number">1</span> ? <span class="hljs-string">'1px solid #eee'</span> : <span class="hljs-string">'none'</span>,
            <span class="hljs-attribute">backgroundColor</span>: index % <span class="hljs-number">2</span> === <span class="hljs-number">0</span> ? <span class="hljs-string">'#fff'</span> : <span class="hljs-string">'#f9f9f9'</span>
          }}
        &gt;
          {<span class="hljs-built_in">children</span>(user, index)}
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  );
}

<span class="hljs-comment">// 父组件使用：定制不同的渲染逻辑</span>
function <span class="hljs-built_in">App</span>() {
  <span class="hljs-comment">// 模拟用户数据</span>
  <span class="hljs-selector-tag">const</span> <span class="hljs-selector-tag">userData</span> = <span class="hljs-selector-attr">[    { id: 1, name: <span class="hljs-string">'张三'</span>, age: 28, role: <span class="hljs-string">'管理员'</span>, avatar: <span class="hljs-string">'https://via.placeholder.com/40'</span> },    { id: 2, name: <span class="hljs-string">'李四'</span>, age: 24, role: <span class="hljs-string">'普通用户'</span>, avatar: <span class="hljs-string">'https://via.placeholder.com/40'</span> },    { id: 3, name: <span class="hljs-string">'王五'</span>, age: 32, role: <span class="hljs-string">'VIP用户'</span>, avatar: <span class="hljs-string">'https://via.placeholder.com/40'</span> }  ]</span>;

  <span class="hljs-selector-tag">return</span> (
    &lt;div style={{ <span class="hljs-attribute">padding</span>: <span class="hljs-string">'20px'</span>, <span class="hljs-attribute">display</span>: <span class="hljs-string">'flex'</span>, <span class="hljs-attribute">gap</span>: <span class="hljs-string">'20px'</span> }}&gt;
      {<span class="hljs-comment">/* 渲染方式 1：简洁卡片式 */</span>}
      &lt;UserList data={<span class="hljs-selector-tag">userData</span>}&gt;
        {(<span class="hljs-selector-tag">user</span>) =&gt; (
          &lt;div style={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">'flex'</span>, <span class="hljs-attribute">alignItems</span>: <span class="hljs-string">'center'</span>, <span class="hljs-attribute">gap</span>: <span class="hljs-string">'12px'</span> }}&gt;
            &lt;img src={<span class="hljs-selector-tag">user</span><span class="hljs-selector-class">.avatar</span>} <span class="hljs-selector-tag">alt</span>={<span class="hljs-selector-tag">user</span><span class="hljs-selector-class">.name</span>} <span class="hljs-selector-tag">style</span>={{ borderRadius: '50%' }} /&gt;
            &lt;div&gt;
              &lt;div style={{ fontWeight: 'bold' }}&gt;{<span class="hljs-selector-tag">user</span><span class="hljs-selector-class">.name</span>}&lt;/<span class="hljs-selector-tag">div</span>&gt;
              &lt;<span class="hljs-selector-tag">div</span> <span class="hljs-selector-tag">style</span>={{ fontSize: '12px', <span class="hljs-attribute">color</span>: <span class="hljs-string">'#666'</span> }}&gt;{<span class="hljs-selector-tag">user</span><span class="hljs-selector-class">.role</span>}&lt;/<span class="hljs-selector-tag">div</span>&gt;
            &lt;/<span class="hljs-selector-tag">div</span>&gt;
          &lt;/<span class="hljs-selector-tag">div</span>&gt;
        )}
      &lt;/<span class="hljs-selector-tag">UserList</span>&gt;

      {<span class="hljs-comment">/* 渲染方式 2：详细信息式 */</span>}
      &lt;UserList data={<span class="hljs-selector-tag">userData</span>}&gt;
        {(<span class="hljs-selector-tag">user</span>, <span class="hljs-selector-tag">index</span>) =&gt; (
          &lt;div&gt;
            &lt;div style={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">'flex'</span>, <span class="hljs-attribute">alignItems</span>: <span class="hljs-string">'center'</span>, <span class="hljs-attribute">gap</span>: <span class="hljs-string">'8px'</span>, <span class="hljs-attribute">marginBottom</span>: <span class="hljs-string">'8px'</span> }}&gt;
              &lt;span style={{ backgroundColor: '#42b983', <span class="hljs-attribute">color</span>: <span class="hljs-string">'white'</span>, <span class="hljs-attribute">padding</span>: <span class="hljs-string">'2px 8px'</span>, <span class="hljs-attribute">borderRadius</span>: <span class="hljs-string">'12px'</span>, <span class="hljs-attribute">fontSize</span>: <span class="hljs-string">'12px'</span> }}&gt;
                {<span class="hljs-selector-tag">index</span> + <span class="hljs-number">1</span>}
              &lt;/<span class="hljs-selector-tag">span</span>&gt;
              &lt;<span class="hljs-selector-tag">h4</span> <span class="hljs-selector-tag">style</span>={{ <span class="hljs-attribute">margin</span>: <span class="hljs-string">'0'</span> }}&gt;{<span class="hljs-selector-tag">user</span><span class="hljs-selector-class">.name</span>}&lt;/<span class="hljs-selector-tag">h4</span>&gt;
            &lt;/<span class="hljs-selector-tag">div</span>&gt;
            &lt;<span class="hljs-selector-tag">div</span> <span class="hljs-selector-tag">style</span>={{ fontSize: '14px', <span class="hljs-attribute">color</span>: <span class="hljs-string">'#666'</span> }}&gt;年龄：{<span class="hljs-selector-tag">user</span><span class="hljs-selector-class">.age</span>}岁&lt;/<span class="hljs-selector-tag">div</span>&gt;
            &lt;<span class="hljs-selector-tag">div</span> <span class="hljs-selector-tag">style</span>={{ fontSize: '14px', <span class="hljs-attribute">color</span>: <span class="hljs-string">'#666'</span> }}&gt;身份：{<span class="hljs-selector-tag">user</span><span class="hljs-selector-class">.role</span>}&lt;/<span class="hljs-selector-tag">div</span>&gt;
          &lt;/<span class="hljs-selector-tag">div</span>&gt;
        )}
      &lt;/<span class="hljs-selector-tag">UserList</span>&gt;
    &lt;/<span class="hljs-selector-tag">div</span>&gt;
  );
}
</code></pre>
<h3 data-id="heading-13">方案 2：render props（显式声明渲染函数）</h3>
<p>通过专门的 props（如 <code>renderItem</code>）传递渲染函数，语义更明确，适用于需要多个渲染函数的复杂组件。</p>
<h4 data-id="heading-14">实例：数据表格组件（支持表头和行渲染定制）</h4>
<pre><code class="hljs language-css" lang="css">// 子组件：数据表格（通过 render props 暴露表头和行数据）
function DataTable({ <span class="hljs-attribute">columns</span>, data, renderHeader, renderRow }) {
  return (
    &lt;<span class="hljs-selector-tag">table</span> style={{ <span class="hljs-attribute">width</span>: <span class="hljs-string">'100%'</span>, borderCollapse: <span class="hljs-string">'collapse'</span>, border: <span class="hljs-string">'1px solid #eee'</span> }}&gt;
      {<span class="hljs-comment">/* 表头渲染：调用 renderHeader 传递列配置 */</span>}
      &lt;<span class="hljs-selector-tag">thead</span>&gt;
        &lt;<span class="hljs-selector-tag">tr</span> style={{ backgroundColor: <span class="hljs-string">'#f5f5f5'</span> }}&gt;
          {<span class="hljs-attribute">columns</span><span class="hljs-selector-class">.map</span>((col) =&gt; (
            &lt;&lt;<span class="hljs-selector-tag">th</span> key={col<span class="hljs-selector-class">.key</span>} style={{ <span class="hljs-attribute">padding</span>: <span class="hljs-string">'12px'</span>, border: <span class="hljs-string">'1px solid #eee'</span>, textAlign: <span class="hljs-string">'left'</span> }}&gt;
              {renderHeader(col)}
            &lt;/&lt;/<span class="hljs-selector-tag">th</span>&gt;
          ))}
        &lt;/<span class="hljs-selector-tag">tr</span>&gt;
      &lt;/<span class="hljs-selector-tag">thead</span>&gt;
      {<span class="hljs-comment">/* 表体渲染：调用 renderRow 传递行数据 */</span>}
      &lt;<span class="hljs-selector-tag">tbody</span>&gt;
        {data<span class="hljs-selector-class">.map</span>((row) =&gt; (
          &lt;<span class="hljs-selector-tag">tr</span> key={row<span class="hljs-selector-class">.id</span>} style={{ backgroundColor: <span class="hljs-string">'#fff'</span> }}&gt;
            {<span class="hljs-attribute">columns</span><span class="hljs-selector-class">.map</span>((col) =&gt; (
              &lt;<span class="hljs-selector-tag">td</span> key={col<span class="hljs-selector-class">.key</span>} style={{ <span class="hljs-attribute">padding</span>: <span class="hljs-string">'12px'</span>, border: <span class="hljs-string">'1px solid #eee'</span> }}&gt;
                {renderRow(row, col)}
              &lt;/<span class="hljs-selector-tag">td</span>&gt;
            ))}
          &lt;/<span class="hljs-selector-tag">tr</span>&gt;
        ))}
      &lt;/<span class="hljs-selector-tag">tbody</span>&gt;
    &lt;/<span class="hljs-selector-tag">table</span>&gt;
  );
}

// 父组件使用
function App() {
  const tableColumns = <span class="hljs-selector-attr">[    { key: <span class="hljs-string">'name'</span>, label: <span class="hljs-string">'商品名称'</span> },    { key: <span class="hljs-string">'price'</span>, label: <span class="hljs-string">'价格'</span> },    { key: <span class="hljs-string">'stock'</span>, label: <span class="hljs-string">'库存'</span> },    { key: <span class="hljs-string">'action'</span>, label: <span class="hljs-string">'操作'</span> }  ]</span>;

  const tableData = <span class="hljs-selector-attr">[    { id: 1, name: <span class="hljs-string">'无线鼠标'</span>, price: 99, stock: 120 },    { id: 2, name: <span class="hljs-string">'机械键盘'</span>, price: 299, stock: 86 },    { id: 3, name: <span class="hljs-string">'显示器'</span>, price: 1299, stock: 34 }  ]</span>;

  return (
    &lt;<span class="hljs-selector-tag">div</span> style={{ <span class="hljs-attribute">padding</span>: <span class="hljs-string">'20px'</span> }}&gt;
      &lt;DataTable
        <span class="hljs-attribute">columns</span>={tableColumns}
        data={tableData}
        // 定制表头渲染（添加图标）
        renderHeader={(col) =&gt; (
          &lt;<span class="hljs-selector-tag">div</span> style={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">'flex'</span>, alignItems: <span class="hljs-string">'center'</span>, gap: <span class="hljs-string">'6px'</span> }}&gt;
            &lt;<span class="hljs-selector-tag">span</span>&gt;📋&lt;/<span class="hljs-selector-tag">span</span>&gt;
            {col<span class="hljs-selector-class">.label</span>}
          &lt;/<span class="hljs-selector-tag">div</span>&gt;
        )}
        // 定制行渲染（价格高亮、库存状态显示）
        renderRow={(row, col) =&gt; {
          switch (col<span class="hljs-selector-class">.key</span>) {
            case 'price':
              return &lt;span style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">'red'</span>, fontWeight: <span class="hljs-string">'bold'</span> }}&gt;¥{row<span class="hljs-selector-class">.price</span>}&lt;/<span class="hljs-selector-tag">span</span>&gt;;
            case 'stock':
              return row.stock &gt; <span class="hljs-number">50</span> ? (
                &lt;span style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">'green'</span> }}&gt;充足&lt;/<span class="hljs-selector-tag">span</span>&gt;
              ) : (
                &lt;span style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">'orange'</span> }}&gt;紧张&lt;/<span class="hljs-selector-tag">span</span>&gt;
              );
            case 'action':
              return (
                &lt;button style={{ <span class="hljs-attribute">padding</span>: <span class="hljs-string">'4px 8px'</span>, backgroundColor: <span class="hljs-string">'#42b983'</span>, color: <span class="hljs-string">'white'</span>, border: <span class="hljs-string">'none'</span>, borderRadius: <span class="hljs-string">'4px'</span> }}&gt;
                  编辑
                &lt;/<span class="hljs-selector-tag">button</span>&gt;
              );
            default:
              return row[col.key];
          }
        }}
      /&gt;
    &lt;/<span class="hljs-selector-tag">div</span>&gt;
  );
}
</code></pre>
<h2 data-id="heading-15">五、高级插槽：组件组合 + Context</h2>
<p>对于复杂组件（如弹窗、表单），需要多个分散的插槽且插槽内容可能嵌套较深时，可通过「专用插槽组件 + Context」实现，适用于大型组件库开发。</p>
<h3 data-id="heading-16">核心思路</h3>
<ol>
<li>定义容器组件（如 <code>Modal</code>），创建 Context 用于传递插槽注册函数；</li>
<li>定义专用插槽组件（如 <code>ModalHeader</code>、<code>ModalBody</code>），通过 Context 注册自身内容到容器组件；</li>
<li>容器组件收集所有插槽内容，按固定结构渲染。</li>
</ol>
<h3 data-id="heading-17">实例：多功能弹窗组件（支持头部、主体、底部、右上角插槽）</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { createContext, useContext, useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 1. 创建 Context 用于传递插槽注册函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">ModalContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);

<span class="hljs-comment">// 2. 定义容器组件：Modal</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Modal</span>(<span class="hljs-params">{ isOpen, onClose, children }</span>) {
  <span class="hljs-comment">// 存储所有插槽内容</span>
  <span class="hljs-keyword">const</span> [slots, setSlots] = <span class="hljs-title function_">useState</span>({
    <span class="hljs-attr">header</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">body</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">footer</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">closeBtn</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClose}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">background:</span> '<span class="hljs-attr">none</span>', <span class="hljs-attr">border:</span> '<span class="hljs-attr">none</span>', <span class="hljs-attr">fontSize:</span> '<span class="hljs-attr">18px</span>', <span class="hljs-attr">cursor:</span> '<span class="hljs-attr">pointer</span>' }}&gt;</span>×<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  });

  <span class="hljs-comment">// 注册插槽的函数：接收插槽名称和内容，合并到 slots 中</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">registerSlot</span> = (<span class="hljs-params">name, content</span>) =&gt; {
    <span class="hljs-title function_">setSlots</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({ ...prev, [name]: content }));
  };

  <span class="hljs-comment">// 未打开时不渲染</span>
  <span class="hljs-keyword">if</span> (!isOpen) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> (
    <span class="hljs-comment">// 提供 Context，让子插槽组件能访问 registerSlot</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ModalContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">registerSlot</span> }}&gt;</span>
      {/* 遮罩层 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> 
        <span class="hljs-attr">position:</span> '<span class="hljs-attr">fixed</span>', 
        <span class="hljs-attr">top:</span> <span class="hljs-attr">0</span>, 
        <span class="hljs-attr">left:</span> <span class="hljs-attr">0</span>, 
        <span class="hljs-attr">right:</span> <span class="hljs-attr">0</span>, 
        <span class="hljs-attr">bottom:</span> <span class="hljs-attr">0</span>, 
        <span class="hljs-attr">backgroundColor:</span> '<span class="hljs-attr">rgba</span>(<span class="hljs-attr">0</span>,<span class="hljs-attr">0</span>,<span class="hljs-attr">0</span>,<span class="hljs-attr">0.5</span>)', 
        <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', 
        <span class="hljs-attr">alignItems:</span> '<span class="hljs-attr">center</span>', 
        <span class="hljs-attr">justifyContent:</span> '<span class="hljs-attr">center</span>' 
      }} <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClose}</span>&gt;</span>
        {/* 弹窗容器 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> 
          <span class="hljs-attr">backgroundColor:</span> '#<span class="hljs-attr">fff</span>', 
          <span class="hljs-attr">borderRadius:</span> '<span class="hljs-attr">8px</span>', 
          <span class="hljs-attr">width:</span> '<span class="hljs-attr">500px</span>', 
          <span class="hljs-attr">maxWidth:</span> '<span class="hljs-attr">90vw</span>', 
          <span class="hljs-attr">position:</span> '<span class="hljs-attr">relative</span>',
          <span class="hljs-attr">onClick:</span> (<span class="hljs-attr">e</span>) =&gt;</span> e.stopPropagation() // 阻止冒泡关闭弹窗
        }}&gt;
          {/* 右上角插槽（默认关闭按钮） */}
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">position:</span> '<span class="hljs-attr">absolute</span>', <span class="hljs-attr">top:</span> '<span class="hljs-attr">16px</span>', <span class="hljs-attr">right:</span> '<span class="hljs-attr">16px</span>' }}&gt;</span>
            {slots.closeBtn}
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

          {/* 头部插槽 */}
          {slots.header &amp;&amp; (
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">16px</span> <span class="hljs-attr">24px</span>', <span class="hljs-attr">borderBottom:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">eee</span>' }}&gt;</span>
              {slots.header}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          )}

          {/* 主体插槽 */}
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">24px</span>' }}&gt;</span>
            {slots.body || children} {/* 兼容默认插槽 */}
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

          {/* 底部插槽 */}
          {slots.footer &amp;&amp; (
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">16px</span> <span class="hljs-attr">24px</span>', <span class="hljs-attr">borderTop:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">eee</span>', <span class="hljs-attr">textAlign:</span> '<span class="hljs-attr">right</span>' }}&gt;</span>
              {slots.footer}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          )}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ModalContext.Provider</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 3. 定义专用插槽组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ModalHeader</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">const</span> { registerSlot } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ModalContext</span>);

  <span class="hljs-comment">// 组件挂载时注册插槽，卸载时清除</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">registerSlot</span>(<span class="hljs-string">'header'</span>, children);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">registerSlot</span>(<span class="hljs-string">'header'</span>, <span class="hljs-literal">null</span>);
  }, [children, registerSlot]);

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 自身不渲染，仅注册内容</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ModalBody</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">const</span> { registerSlot } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ModalContext</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">registerSlot</span>(<span class="hljs-string">'body'</span>, children);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">registerSlot</span>(<span class="hljs-string">'body'</span>, <span class="hljs-literal">null</span>);
  }, [children, registerSlot]);

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ModalFooter</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">const</span> { registerSlot } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ModalContext</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">registerSlot</span>(<span class="hljs-string">'footer'</span>, children);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">registerSlot</span>(<span class="hljs-string">'footer'</span>, <span class="hljs-literal">null</span>);
  }, [children, registerSlot]);

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ModalCloseBtn</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">const</span> { registerSlot } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ModalContext</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">registerSlot</span>(<span class="hljs-string">'closeBtn'</span>, children);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">registerSlot</span>(<span class="hljs-string">'closeBtn'</span>, <span class="hljs-literal">null</span>);
  }, [children, registerSlot]);

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-comment">// 4. 父组件使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [isModalOpen, setIsModalOpen] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsModalOpen(true)}
        style={{ padding: '8px 16px', backgroundColor: '#42b983', color: 'white', border: 'none', borderRadius: '4px', cursor: 'pointer' }}
      &gt;
        打开弹窗
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">Modal</span> <span class="hljs-attr">isOpen</span>=<span class="hljs-string">{isModalOpen}</span> <span class="hljs-attr">onClose</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsModalOpen(false)}&gt;
        {/* 专用插槽组件 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">ModalHeader</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">margin:</span> '<span class="hljs-attr">0</span>', <span class="hljs-attr">fontSize:</span> '<span class="hljs-attr">18px</span>' }}&gt;</span>修改个人信息<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ModalHeader</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">ModalBody</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', <span class="hljs-attr">flexDirection:</span> '<span class="hljs-attr">column</span>', <span class="hljs-attr">gap:</span> '<span class="hljs-attr">16px</span>' }}&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> '<span class="hljs-attr">block</span>', <span class="hljs-attr">marginBottom:</span> '<span class="hljs-attr">4px</span>', <span class="hljs-attr">fontSize:</span> '<span class="hljs-attr">14px</span>' }}&gt;</span>姓名<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
                <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> 
                <span class="hljs-attr">defaultValue</span>=<span class="hljs-string">"张三"</span>
                <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">width:</span> '<span class="hljs-attr">100</span>%', <span class="hljs-attr">padding:</span> '<span class="hljs-attr">8px</span>', <span class="hljs-attr">border:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ddd</span>', <span class="hljs-attr">borderRadius:</span> '<span class="hljs-attr">4px</span>' }}
              /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> '<span class="hljs-attr">block</span>', <span class="hljs-attr">marginBottom:</span> '<span class="hljs-attr">4px</span>', <span class="hljs-attr">fontSize:</span> '<span class="hljs-attr">14px</span>' }}&gt;</span>邮箱<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
                <span class="hljs-attr">type</span>=<span class="hljs-string">"email"</span> 
                <span class="hljs-attr">defaultValue</span>=<span class="hljs-string">"zhangsan@example.com"</span>
                <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">width:</span> '<span class="hljs-attr">100</span>%', <span class="hljs-attr">padding:</span> '<span class="hljs-attr">8px</span>', <span class="hljs-attr">border:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ddd</span>', <span class="hljs-attr">borderRadius:</span> '<span class="hljs-attr">4px</span>' }}
              /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ModalBody</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">ModalFooter</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', <span class="hljs-attr">gap:</span> '<span class="hljs-attr">8px</span>', <span class="hljs-attr">justifyContent:</span> '<span class="hljs-attr">flex-end</span>' }}&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
              <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsModalOpen(false)}
              style={{ padding: '8px 16px', backgroundColor: '#fff', color: '#333', border: '1px solid #ddd', borderRadius: '4px' }}
            &gt;
              取消
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
              <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">8px</span> <span class="hljs-attr">16px</span>', <span class="hljs-attr">backgroundColor:</span> '#<span class="hljs-attr">42b983</span>', <span class="hljs-attr">color:</span> '<span class="hljs-attr">white</span>', <span class="hljs-attr">border:</span> '<span class="hljs-attr">none</span>', <span class="hljs-attr">borderRadius:</span> '<span class="hljs-attr">4px</span>' }}
            &gt;</span>
              保存修改
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ModalFooter</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">ModalCloseBtn</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsModalOpen(false)}
            style={{ background: 'none', border: 'none', fontSize: '18px', cursor: 'pointer', color: '#666' }}
          &gt;
            关闭
          <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ModalCloseBtn</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Modal</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-18">六、第三方库辅助：react-slot（简化命名插槽）</h2>
<p>如果项目中需要大量使用命名插槽，可借助第三方库 <code>react-slot</code> 简化代码，其提供了 <code>&lt;Slot&gt;</code> 和 <code>&lt;Fill&gt;</code> 组件，语法更接近原生插槽，适用于追求简洁语法的场景。</p>
<h3 data-id="heading-19">用法示例：导航栏组件</h3>
<p>jsx</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 1. 安装依赖</span>
<span class="hljs-comment">// npm install react-slot</span>

<span class="hljs-comment">// 2. 导入组件</span>
<span class="hljs-selector-tag">import</span> { <span class="hljs-selector-tag">Slot</span>, <span class="hljs-selector-tag">Fill</span> } <span class="hljs-selector-tag">from</span> '<span class="hljs-selector-tag">react-slot</span>';

<span class="hljs-comment">// 3. 子组件：导航栏（定义插槽）</span>
<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">Navbar</span>() {
  <span class="hljs-selector-tag">return</span> (
    &lt;nav style={{ 
      backgroundColor: '#2c3e50', 
      <span class="hljs-attribute">padding</span>: <span class="hljs-string">'16px 24px'</span>, 
      <span class="hljs-attribute">display</span>: <span class="hljs-string">'flex'</span>, 
      <span class="hljs-attribute">justifyContent</span>: <span class="hljs-string">'space-between'</span>, 
      <span class="hljs-attribute">alignItems</span>: <span class="hljs-string">'center'</span> 
    }}&gt;
      {<span class="hljs-comment">/* 左侧插槽 */</span>}
      &lt;div style={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">'flex'</span>, <span class="hljs-attribute">alignItems</span>: <span class="hljs-string">'center'</span> }}&gt;
        &lt;Slot name=<span class="hljs-string">"logo"</span> /&gt;
      &lt;/div&gt;

      {<span class="hljs-comment">/* 中间插槽 */</span>}
      &lt;div style={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">'flex'</span>, <span class="hljs-attribute">gap</span>: <span class="hljs-string">'24px'</span> }}&gt;
        &lt;Slot name=<span class="hljs-string">"menu"</span> /&gt;
      &lt;/div&gt;

      {<span class="hljs-comment">/* 右侧插槽 */</span>}
      &lt;div style={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">'flex'</span>, <span class="hljs-attribute">alignItems</span>: <span class="hljs-string">'center'</span> }}&gt;
        &lt;Slot name=<span class="hljs-string">"user"</span> /&gt;
      &lt;/div&gt;
    &lt;/nav&gt;
  );
}

<span class="hljs-comment">// 4. 父组件使用：填充插槽</span>
<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">App</span>() {
  <span class="hljs-selector-tag">return</span> (
    &lt;Navbar&gt;
      {<span class="hljs-comment">/* 填充 logo 插槽 */</span>}
      &lt;Fill name=<span class="hljs-string">"logo"</span>&gt;
        &lt;h1 style={{ <span class="hljs-attribute">margin</span>: <span class="hljs-string">'0'</span>, <span class="hljs-attribute">color</span>: <span class="hljs-string">'white'</span>, <span class="hljs-attribute">fontSize</span>: <span class="hljs-string">'20px'</span> }}&gt;Logo&lt;/h1&gt;
      &lt;/Fill&gt;

      {<span class="hljs-comment">/* 填充 menu 插槽 */</span>}
      &lt;Fill name=<span class="hljs-string">"menu"</span>&gt;
        &lt;a href=<span class="hljs-string">"/"</span> style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">'white'</span>, <span class="hljs-attribute">textDecoration</span>: <span class="hljs-string">'none'</span> }}&gt;首页&lt;/a&gt;
        &lt;a href=<span class="hljs-string">"/products"</span> style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">'white'</span>, <span class="hljs-attribute">textDecoration</span>: <span class="hljs-string">'none'</span> }}&gt;产品&lt;/a&gt;
        &lt;a href=<span class="hljs-string">"/contact"</span> style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">'white'</span>, <span class="hljs-attribute">textDecoration</span>: <span class="hljs-string">'none'</span> }}&gt;联系我们&lt;/a&gt;
      &lt;/Fill&gt;

      {<span class="hljs-comment">/* 填充 user 插槽 */</span>}
      &lt;Fill name=<span class="hljs-string">"user"</span>&gt;
        &lt;button style={{ 
          <span class="hljs-attribute">padding</span>: <span class="hljs-string">'6px 12px'</span>, 
          <span class="hljs-attribute">backgroundColor</span>: <span class="hljs-string">'#42b983'</span>, 
          <span class="hljs-attribute">color</span>: <span class="hljs-string">'white'</span>, 
          <span class="hljs-attribute">border</span>: <span class="hljs-string">'none'</span>, 
          <span class="hljs-attribute">borderRadius</span>: <span class="hljs-string">'4px'</span> 
        }}&gt;
          登录
        &lt;/button&gt;
      &lt;/Fill&gt;
    &lt;/Navbar&gt;
  );
}
</code></pre>
<h2 data-id="heading-20">七、最佳实践与性能优化</h2>
<h3 data-id="heading-21">1. 插槽方案选择指南</h3>
<ul>
<li>简单内容传递（无分区）→ <code>children</code> prop（默认插槽）；</li>
<li>固定多区域（如布局、卡片）→ 多 props 命名插槽（简洁高效）；</li>
<li>子组件传数据 + 父组件定制渲染 → 函数作为 children（作用域插槽）；</li>
<li>复杂组件（多插槽、深嵌套）→ 组件组合 + Context；</li>
<li>追求 Vue 式简洁语法 → react-slot 第三方库。</li>
</ul>
<h3 data-id="heading-22">2. 性能优化关键要点</h3>
<ul>
<li>避免每次渲染创建新组件：将插槽内容提取到组件外部或使用 <code>useMemo</code> 缓存；</li>
</ul>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误示例：每次渲染创建新对象/组件</span>
&lt;<span class="hljs-title class_">ProductCard</span>&gt;
  {{
    <span class="hljs-attr">title</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>商品名称<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></span>, <span class="hljs-comment">// 每次渲染都是新元素</span>
    <span class="hljs-attr">action</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>购买<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  }}
&lt;/<span class="hljs-title class_">ProductCard</span>&gt;

<span class="hljs-comment">// 正确示例：缓存插槽内容</span>
<span class="hljs-keyword">const</span> productSlots = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-attr">title</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>商品名称<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></span>,
  <span class="hljs-attr">action</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>购买<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
}), []); <span class="hljs-comment">// 无依赖项，仅渲染一次</span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProductCard</span>&gt;</span>{productSlots}<span class="hljs-tag">&lt;/<span class="hljs-name">ProductCard</span>&gt;</span></span>
</code></pre>
<ul>
<li>避免不必要的 Context 嵌套：Context 会增加组件渲染开销，简单场景优先使用 props；</li>
<li>边界处理：为所有插槽设置默认值，避免空渲染导致的布局错乱；</li>
<li>减少插槽内容的重渲染：通过 <code>React.memo</code> 包装插槽组件，避免无关更新。</li>
</ul>
<h2 data-id="heading-23">八、总结</h2>
<p>React 虽无原生插槽语法，但通过 <code>children</code> prop、多 props、函数作为 children、组件组合 + Context 等原生能力，能实现比 Vue 更灵活的插槽效果。核心在于理解「插槽是组件间内容与数据的双向传递」—— 简单场景用 <code>children</code>，多区域用命名插槽，需传数据用作用域插槽，复杂场景用组件组合 + Context。</p>
<p>掌握 React 插槽的核心是「根据场景选择合适的实现方案」，并注重性能优化，避免过度封装。合理使用插槽能大幅提升组件的复用性与扩展性，是 React 组件化开发中的必备技巧。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[越南开发者用 TRAE 做了个复古相机，还原拍立得显影过程]]></title>    <link>https://juejin.cn/post/7581423932612706344</link>    <guid>https://juejin.cn/post/7581423932612706344</guid>    <pubDate>2025-12-09T02:25:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581423932612706344" data-draft-id="7581386627676602408" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="越南开发者用 TRAE 做了个复古相机，还原拍立得显影过程"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-12-09T02:25:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TRAE_ai"/> <meta itemprop="url" content="https://juejin.cn/user/3048259110571032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            越南开发者用 TRAE 做了个复古相机，还原拍立得显影过程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3048259110571032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TRAE_ai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T02:25:32.000Z" title="Tue Dec 09 2025 02:25:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70e7c23621bd4723945c72f1c5488e6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=vILflovwPv7UQU7KryZ%2BNnru%2Fnw%3D" alt="" loading="lazy"/></p>
<p><strong>Flashback 是一款模拟复古即时相机（Polaroid）体验的 Web 应用。</strong></p>
<p>作品来自越南的 TRAE 用户 <strong>The Vibe Coders</strong>（成员：Mai Nguyen &amp; Son Le），他们是两位后端开发者，在参与 11/22 TRAE 越南 Vibe Coding 体验活动时，用 TRAE SOLO 实现了这款基于网页的应用。这款相机可以将你的普通摄像头变成一台虚拟的复古拍立得，完整还原从按下快门到照片显影的整个过程。用户只需一个带摄像头的设备，就可以拍摄带有复古滤镜的照片，并通过动画效果观看照片“显影”的过程，仿佛回到了胶片年代。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/feff18ef033b4d65a505a5d04950771a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=6FseLeTNRO9w5E6KcFC7Vdzg61E%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb515381fe9040f6bf6adf0696bef401~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=ioLvH9T6FnTn26azA1I9tocc7bc%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>作者：Mai Nguyen &amp; Son Le，TRAE 开发者用户</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b668f893d0fb468b9af411bed2dea758~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=NdirerMaUz9MBw2N2qqgoXJV3Dc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>为什么做这个项目</strong></h2>
<h3 data-id="heading-1"><strong>项目起源</strong></h3>
<p>起初，这只是一个源于朋友的拍立得相机带来的灵感。团队成员之一说：</p>
<blockquote>
<p>“我们有个朋友拥有一台真正的复古拍立得，我们非常喜欢它拍照的过程和感觉。但现实是，这种相机价格不低，我们也买不起。所以我们决定，自己动手，用代码造一台。”</p>
</blockquote>
<p>于是，Flashback 应运而生。它不仅解决了昂贵设备门槛的问题，还带来了如下几点价值：</p>
<ul>
<li>
<p><strong>让复古摄影零门槛：</strong> 只要有摄像头，人人都能免费体验拍立得的乐趣。</p>
</li>
<li>
<p><strong>模拟真实交互：</strong> 用户需要手动开机、取景、按快门，仿佛真的在用一台物理相机。</p>
</li>
<li>
<p><strong>还原显影过程：</strong> 照片从黑屏逐渐清晰，仅需短短 3 秒，却让人感受到等待的仪式感。</p>
</li>
<li>
<p><strong>提升情绪价值：</strong> 慢下来的一拍一显，比滤镜一键生成更值得珍藏。</p>
</li>
<li>
<p><strong>保留复古美感：</strong> 多种滤镜让照片更具“老照片”的质感。</p>
</li>
</ul>
<h3 data-id="heading-2"><strong>用到 TRAE 的能力</strong></h3>
<ul>
<li>
<p><strong>TRAE IDE 的 SOLO 模式：</strong> AI 辅助开发，帮助快速完成原型、生成代码，解决开发过程中遇到的各种问题。</p>
</li>
<li>
<p><strong>一键部署到 Vercel：</strong> 简化了部署流程，让应用快速上线。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e257b8a180374540a8284b971480b39c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=dIm1jsBeXzL57vzTO01cKybbODs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3"><strong>架构设计：简单技术，完整体验</strong></h2>
<h3 data-id="heading-4"><strong>应用架构</strong></h3>
<p>Flashback 是一个纯前端构建的单页应用（SPA），技术栈非常轻量：</p>
<ul>
<li><strong>HTML + CSS + JavaScript：</strong> 不依赖大型框架，兼容性强，加载迅速。</li>
</ul>
<h3 data-id="heading-5"><strong>核心流程</strong></h3>
<ol>
<li>
<p><strong>权限获取</strong> - 用户点击电源按钮，授权使用摄像头</p>
</li>
<li>
<p><strong>实时预览</strong> - 视频流实时显示，可预览选中的滤镜效果</p>
</li>
<li>
<p><strong>图像捕获</strong> - 点击快门，将当前画面捕获到画布</p>
</li>
<li>
<p><strong>滤镜处理</strong> - 对图像应用滤镜并进行处理</p>
</li>
<li>
<p><strong>显影动画</strong> - 照片带着动画效果“弹出”，然后逐渐“显影”</p>
</li>
<li>
<p><strong>照片收藏</strong> - 用户可以把照片拖到钉板上收藏</p>
</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e275473036c440cda25d2b544cd114aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=8MhqrcWPNDoEg6jw2PV1NF1G2PU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6"><strong>效果展示</strong></h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3af0ea6537844c38ec130b4e9644952~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=xKDhZYOCdCEgtmpkkdm%2By5oSA7g%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7"><strong>在线体验</strong></h3>
<p><strong>在线演示地址：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fflashbackcamera.vercel.app%2F" target="_blank" title="https://flashbackcamera.vercel.app/" ref="nofollow noopener noreferrer">flashbackcamera.vercel.app/</a></p>
<h3 data-id="heading-8"><strong>主要功能展示</strong></h3>
<ul>
<li>
<p>相机开机动画和实时预览</p>
</li>
<li>
<p>四种复古滤镜：正常、柯达彩色、褪色哑光、8mm 胶片</p>
</li>
<li>
<p>照片弹出和显影动画效果</p>
</li>
<li>
<p>拖放式照片钉板</p>
</li>
<li>
<p>移动端响应式适配</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c46c0a8b50434e5cb4910fe54c738f09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=v5d7xM%2BGoJz%2BO6O5iGiyTqfW68Y%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9"><strong>挑战与经验总结</strong></h2>
<h3 data-id="heading-10"><strong>遇到的技术难题</strong></h3>
<p><strong>1. 跨浏览器的摄像头权限问题</strong></p>
<ul>
<li>
<p><strong>遇到的挑战：</strong> Chrome、Firefox 和 Safari 处理媒体权限的方式各不相同，很难做到统一体验。</p>
</li>
<li>
<p><strong>解决方案：</strong> 针对不同浏览器做了大量测试，并实现了多套后备方案来确保兼容性。</p>
</li>
</ul>
<p><strong>2. 实时滤镜的性能优化</strong></p>
<ul>
<li>
<p><strong>遇到的挑战：</strong> 需要在视频流上实时应用滤镜，同时保持 60fps 的流畅度，这对性能要求很高。</p>
</li>
<li>
<p><strong>解决方案：</strong> 经过测试发现，CSS 滤镜在实时预览场景下比 Canvas 滤镜性能更好，最终采用了 CSS 方案。</p>
</li>
</ul>
<p><strong>3. 拖放功能的实现</strong></p>
<ul>
<li>
<p><strong>遇到的挑战：</strong> 要让拖放功能在桌面端和移动端都能流畅使用，需要处理多种事件类型，还要阻止浏览器的默认行为。</p>
</li>
<li>
<p><strong>解决方案：</strong> 开发了自定义的拖放系统，统一处理不同设备的交互逻辑。</p>
</li>
</ul>
<h3 data-id="heading-11"><strong>遇到的设计难题</strong></h3>
<p><strong>4. 如何做出真实的复古感</strong></p>
<ul>
<li>
<p><strong>遇到的挑战：</strong> 既要有复古美学，又要保证现代用户的使用习惯，这两者之间很难平衡。</p>
</li>
<li>
<p><strong>解决方案：</strong> 在相机设计、动画效果和交互方式上反复打磨，最终找到了合适的平衡点。</p>
</li>
</ul>
<p><strong>5. 响应式 3D 效果的适配</strong></p>
<ul>
<li>
<p><strong>遇到的挑战：</strong> 3D 相机的视差效果需要在各种屏幕尺寸上都看起来自然，从小手机到大显示器都要兼顾。</p>
</li>
<li>
<p><strong>解决方案：</strong> 针对不同屏幕尺寸调整了 3D 效果参数，确保在各种设备上都有好的视觉体验。</p>
</li>
</ul>
<h3 data-id="heading-12"><strong>核心经验总结</strong></h3>
<h4 data-id="heading-13"><strong>用户体验永远是第一位的</strong></h4>
<p>比起实现多么高级的图像处理技术，让用户感受到怀旧氛围和流畅交互更重要</p>
<h4 data-id="heading-14"><strong>音效能大幅提升真实感</strong></h4>
<p>简单的音效就能让整个体验的真实度提升一大截</p>
<h3 data-id="heading-15"/>
<p>Flashback Camera 不只是一个玩具项目，它是一次关于“数字怀旧”的实验，也是对 Web 技术可玩性的一次精彩演绎。The Vibe Coders 团队用最朴素的技术，创造了最富情感的体验，令人眼前一亮。</p>
<p>在这个人人追求“效率最大化”的世界，这种带点仪式感和浪漫气息的小工具，反而更值得被记住。</p>
<p>期待未来，他们还能用代码带来更多“有温度”的创意项目。</p>
<h5 data-id="heading-16"><strong>更多项目展示：</strong></h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/881d17522ab24d1984883250c17dd350~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=%2B58Jnx4pcX0K8xkoD2uvigu9LNk%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3792d10814094bab8148f0e1373c9948~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=9gCLUmS%2BMQYzpJOpKls3XXwA%2BnY%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b827f3faf97140909172d44ed85aedab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=sW%2FGYj1XS2R0h5Ez0bgP6FC9wfE%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5490b380a8b4884bd316434d448e3c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=wg7VlmQElGYyGFJwDBxRzwxmcPM%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dc7766b471d4049bde849fece7ae194~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=d3pttTxQyIwcpRdZZtK8DZBjyyQ%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a557870b8c304aefab53bef75e4bc072~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765851931&amp;x-signature=dRqvfTDVLeKN75EoGnaw253iwBw%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>