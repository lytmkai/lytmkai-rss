<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Spring 项目别再乱注入 Service 了！用 Lambda 封装个统一调用组件，爽到飞起]]></title>    <link>https://juejin.cn/post/7575017581036765222</link>    <guid>https://juejin.cn/post/7575017581036765222</guid>    <pubDate>2025-11-21T17:00:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575017581036765222" data-draft-id="7575004291833004083" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring 项目别再乱注入 Service 了！用 Lambda 封装个统一调用组件，爽到飞起"/> <meta itemprop="keywords" content="Spring Boot"/> <meta itemprop="datePublished" content="2025-11-21T17:00:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="只会写代码"/> <meta itemprop="url" content="https://juejin.cn/user/995479086189514"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring 项目别再乱注入 Service 了！用 Lambda 封装个统一调用组件，爽到飞起
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/995479086189514/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    只会写代码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T17:00:41.000Z" title="Fri Nov 21 2025 17:00:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>兄弟们，咱做 Spring 项目的时候，是不是总遇到这些破事：</p>
<ul>
<li>每个 Controller 里都要写@Autowired UserService userService，注入一大堆 Service，代码又乱又冗余；</li>
</ul>

<ul>
<li>想统一加个日志 / 异常处理，得在每个 Service 方法里写一遍，改起来要疯；</li>
</ul>

<ul>
<li>偶尔还会手滑把 Service 类名 / 方法名写错，编译不报错，跑起来才出问题，排查半天。</li>
</ul>
<p>今天给大家分享个我自己写的ServiceManager组件，用 Lambda 搞定这些破事 —— 不用手动注入 Service，调用方法像写公式一样简单，还能自动缓存、统一处理异常，新手也能秒懂秒用！</p>
<h2 data-id="heading-0">先说说这组件能解决啥实际问题？</h2>
<p>举个栗子：以前咱调用用户查询接口，得这么写：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 先注入Service</span>
<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> UserService userService;
<span class="hljs-comment">// 2. 再调用方法</span>
<span class="hljs-keyword">public</span> SerResult&lt;UserDTO&gt; getUser(<span class="hljs-built_in">Long</span> userId) {
    <span class="hljs-keyword">try</span> {
        log.info(<span class="hljs-string">"开始查用户，ID：{}"</span>, userId);
        UserDTO user = userService.queryUser(userId);
        log.info(<span class="hljs-string">"查询成功，结果：{}"</span>, user);
        <span class="hljs-keyword">return</span> SerResult.success(user);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        log.error(<span class="hljs-string">"查询失败"</span>, e);
        <span class="hljs-keyword">return</span> SerResult.fail(<span class="hljs-string">"查用户出错了"</span>);
    }
}
</code></pre>
<p>又是注入又是日志又是 try-catch，重复代码一堆。</p>
<p>用了ServiceManager之后，直接写成这样：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> SerResult&lt;UserDTO&gt; getUser(<span class="hljs-built_in">Long</span> userId) {
    <span class="hljs-comment">// 一行搞定：传方法+参数，其他全帮你做</span>
    <span class="hljs-keyword">return</span> ServiceManager.call(UserService::queryUser, userId);
}
</code></pre>
<p>注入？没了。日志？组件自动打。异常？组件自动处理。爽不爽？</p>
<h2 data-id="heading-1">组件核心逻辑：大白话拆解</h2>
<p>其实这组件就干了 3 件事：</p>
<ol>
<li>你传个 Lambda（比如UserService::queryUser），它帮你找到对应的 Service 实例；</li>
</ol>

<ol start="2">
<li>把找到的实例和方法缓存起来，下次调用更快；</li>
</ol>

<ol start="3">
<li>统一执行方法，顺便把日志、异常处理都包了。</li>
</ol>
<p>下面咱一步步来，代码都给你贴好，复制过去改改就能用。</p>
<h2 data-id="heading-2">第一步：先搭基础 —— 需要的依赖和工具类</h2>
<p>首先得有几个小工具，不用自己写，直接复制：</p>
<h3 data-id="heading-3">1. 统一返回结果类（SerResult）</h3>
<p>不管调用成功还是失败，都返回同一个格式，前端好处理：</p>
<pre><code class="hljs language-typescript" lang="typescript">package org.<span class="hljs-property">pro</span>.<span class="hljs-property">wwcx</span>.<span class="hljs-property">ledger</span>.<span class="hljs-property">common</span>.<span class="hljs-property">dto</span>;
<span class="hljs-keyword">import</span> lombok.<span class="hljs-property">Data</span>;
<span class="hljs-comment">// 服务调用的统一返回结果，前端拿到就知道是成功还是失败</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SerResult</span>&lt;T&gt; {
    <span class="hljs-keyword">private</span> int code;       <span class="hljs-comment">// 200=成功，500=失败，前端一看就懂</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> msg;     <span class="hljs-comment">// 提示信息，比如“操作成功”“查不到用户”</span>
    <span class="hljs-keyword">private</span> T data;         <span class="hljs-comment">// 成功时返回的数据，比如用户信息</span>
    <span class="hljs-comment">// 成功的时候调用这个方法，把数据传进去</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-title class_">SerResult</span>&lt;T&gt; <span class="hljs-title function_">success</span>(<span class="hljs-params">T data</span>) {
        <span class="hljs-title class_">SerResult</span>&lt;T&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SerResult</span>&lt;&gt;();
        result.<span class="hljs-title function_">setCode</span>(<span class="hljs-number">200</span>);
        result.<span class="hljs-title function_">setMsg</span>(<span class="hljs-string">"操作成功"</span>);
        result.<span class="hljs-title function_">setData</span>(data);
        <span class="hljs-keyword">return</span> result;
    }
    <span class="hljs-comment">// 失败的时候调用这个方法，传错误信息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-title class_">SerResult</span>&lt;T&gt; <span class="hljs-title function_">fail</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> msg</span>) {
        <span class="hljs-title class_">SerResult</span>&lt;T&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SerResult</span>&lt;&gt;();
        result.<span class="hljs-title function_">setCode</span>(<span class="hljs-number">500</span>);
        result.<span class="hljs-title function_">setMsg</span>(msg);
        result.<span class="hljs-title function_">setData</span>(<span class="hljs-literal">null</span>);
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<h3 data-id="heading-4">2. Lambda 解析工具（LambdaUtil）</h3>
<p>这工具是核心，帮咱从 Lambda 里 “扣” 出 Service 类名和方法名（不用懂原理，复制用就行）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.pro.wwcx.ledger.common.util;
<span class="hljs-keyword">import</span> java.io.Serializable;
<span class="hljs-keyword">import</span> java.lang.reflect.Method;
<span class="hljs-keyword">import</span> java.lang.invoke.SerializedLambda;
<span class="hljs-comment">// 从Lambda表达式里拿Service信息的工具</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LambdaUtil</span> {
    <span class="hljs-comment">// 传个Lambda进来，返回它对应的“元数据”（比如哪个Service，哪个方法）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SerializedLambda <span class="hljs-title function_">valueOf</span><span class="hljs-params">(Serializable lambda)</span> {
        <span class="hljs-keyword">if</span> (lambda == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Lambda不能传空！"</span>);
        }
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 反射拿到Lambda里的隐藏方法，不用管这行是咋回事</span>
            <span class="hljs-type">Method</span> <span class="hljs-variable">writeReplaceMethod</span> <span class="hljs-operator">=</span> lambda.getClass().getDeclaredMethod(<span class="hljs-string">"writeReplace"</span>);
            writeReplaceMethod.setAccessible(<span class="hljs-literal">true</span>);
            <span class="hljs-keyword">return</span> (SerializedLambda) writeReplaceMethod.invoke(lambda);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"解析Lambda出错了"</span>, e);
        }
    }
}
</code></pre>
<h3 data-id="heading-5">3. Spring 工具类（SpringUtil）</h3>
<p>帮咱从 Spring 里拿 Service 实例（不用手动@Autowired就是靠它）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.pro.wwcx.ledger.common.util;
<span class="hljs-keyword">import</span> org.springframework.beans.BeansException;
<span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;
<span class="hljs-keyword">import</span> org.springframework.context.ApplicationContextAware;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;
<span class="hljs-comment">// 从Spring里拿Bean的工具，不用自己注入Service</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringUtil</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationContextAware</span> {
    <span class="hljs-comment">// Spring的上下文，相当于“Bean仓库”</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ApplicationContext applicationContext;
    <span class="hljs-comment">// 从仓库里按类型拿Bean，比如拿UserService类型的实例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(Class&lt;T&gt; requiredType)</span> {
        <span class="hljs-keyword">if</span> (applicationContext == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Spring还没初始化好呢！"</span>);
        }
        <span class="hljs-keyword">return</span> applicationContext.getBean(requiredType);
    }
    <span class="hljs-comment">// 下面这行是Spring自动调用的，不用管</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplicationContext</span><span class="hljs-params">(ApplicationContext applicationContext)</span> <span class="hljs-keyword">throws</span> BeansException {
        SpringUtil.applicationContext = applicationContext;
    }
}
</code></pre>
<h3 data-id="heading-6">4. 函数接口（SerialBiFunction）</h3>
<p>这个是 Lambda 的 “规矩”，规定传参和返回值的格式（复制就行）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.pro.wwcx.ledger.common.resolver.anno;
<span class="hljs-keyword">import</span> java.io.Serializable;
<span class="hljs-comment">// 支持序列化的双参数函数接口，Lambda要符合这个格式</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SerialBiFunction</span>&lt;T, U, R&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-comment">// 方法格式：传入T（Service实例）和U（参数），返回R（结果）</span>
    R <span class="hljs-title function_">apply</span><span class="hljs-params">(T t, U u)</span>;
}
</code></pre>
<h3 data-id="heading-7">5. 实例构建器（InstBuilder）</h3>
<p>帮咱快速创建对象的小工具，不用写一堆set方法：</p>
<pre><code class="hljs language-csharp" lang="csharp">package org.pro.wwcx.ledger.common.resolver;
<span class="hljs-comment">// 快速创建对象的工具，比如new ServiceExecutor后不用一个个set值</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">InstBuilder</span>&lt;<span class="hljs-title">T</span>&gt; {
    <span class="hljs-keyword">private</span> final T target;
    <span class="hljs-comment">// 初始化要创建的对象</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">InstBuilder</span>(<span class="hljs-params">Class&lt;T&gt; clazz</span>)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">this</span>.target = clazz.getDeclaredConstructor().newInstance();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"创建对象失败"</span>, e);
        }
    }
    <span class="hljs-comment">// 静态方法，入口：InstBuilder.of(ServiceExecutor.class)</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-title">InstBuilder</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-title">of</span>(<span class="hljs-params">Class&lt;T&gt; clazz</span>)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstBuilder&lt;&gt;(clazz);
    }
    <span class="hljs-comment">// 链式set值：比如.set(ServiceExecutor::setParam, param)</span>
    <span class="hljs-keyword">public</span> &lt;V&gt; <span class="hljs-function">InstBuilder&lt;T&gt; <span class="hljs-title">set</span>(<span class="hljs-params">Setter&lt;T, V&gt; setter, V <span class="hljs-keyword">value</span></span>)</span> {
        setter.<span class="hljs-keyword">set</span>(target, <span class="hljs-keyword">value</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }
    <span class="hljs-comment">// 最后调用build()拿到对象</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">build</span>()</span> {
        <span class="hljs-keyword">return</span> target;
    }
    <span class="hljs-comment">// 定义setter的格式</span>
    @FunctionalInterface
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">Setter</span>&lt;<span class="hljs-title">T</span>, <span class="hljs-title">V</span>&gt; {
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">set</span>(<span class="hljs-params">T target, V <span class="hljs-keyword">value</span></span>)</span>;
    }
}
</code></pre>
<h2 data-id="heading-8">第二步：核心组件 ——ServiceManager</h2>
<p>这是咱的主角，所有逻辑都在这，我一行行给你讲明白：</p>
<pre><code class="hljs language-swift" lang="swift">package org.pro.wwcx.ledger.common.servicer;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.pro.wwcx.ledger.common.dto.SerResult;
<span class="hljs-keyword">import</span> org.pro.wwcx.ledger.common.resolver.InstBuilder;
<span class="hljs-keyword">import</span> org.pro.wwcx.ledger.common.resolver.anno.SerialBiFunction;
<span class="hljs-keyword">import</span> org.pro.wwcx.ledger.common.util.LambdaUtil;
<span class="hljs-keyword">import</span> org.pro.wwcx.ledger.common.util.SpringUtil;
<span class="hljs-keyword">import</span> java.lang.invoke.SerializedLambda;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentHashMap;
<span class="hljs-comment">// 日志注解，能打日志</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceManager</span> {
    <span class="hljs-comment">// 缓存初始化大小，6666够咱用了，不够再改</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> int <span class="hljs-type">INIT_COUNT</span> <span class="hljs-operator">=</span> <span class="hljs-number">6666</span>;
    <span class="hljs-comment">// 缓存Lambda对应的Service信息，key是Lambda，value是Service元数据</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Map</span>&lt;<span class="hljs-type">SerialBiFunction</span>&lt;?,?,?&gt;, <span class="hljs-type">LambdaMeta</span>&lt;?&gt;&gt; <span class="hljs-type">CACHE_LAMBDA</span>;
    <span class="hljs-comment">// 静态代码块，项目启动时就初始化缓存</span>
    <span class="hljs-keyword">static</span> {
        <span class="hljs-type">CACHE_LAMBDA</span> <span class="hljs-operator">=</span> new <span class="hljs-type">ConcurrentHashMap</span>&lt;&gt;(<span class="hljs-type">INIT_COUNT</span>);
    }
    <span class="hljs-comment">// 对外提供的调用方法：传Lambda（比如UserService::queryUser）和参数，返回结果</span>
    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-operator">&lt;</span><span class="hljs-type">T</span>,<span class="hljs-type">U</span>,<span class="hljs-type">R</span><span class="hljs-operator">&gt;</span> <span class="hljs-type">SerResult</span>&lt;<span class="hljs-type">R</span>&gt; call(<span class="hljs-type">SerialBiFunction</span>&lt;<span class="hljs-type">T</span>,<span class="hljs-type">U</span>,<span class="hljs-type">R</span>&gt; fn, <span class="hljs-type">U</span> param){
        <span class="hljs-comment">// 先检查：Lambda不能传空</span>
        <span class="hljs-keyword">if</span> (fn <span class="hljs-operator">==</span> null) {
            <span class="hljs-keyword">return</span> <span class="hljs-type">SerResult</span>.fail(<span class="hljs-string">"服务函数不能为空！"</span>);
        }
        <span class="hljs-comment">// 1. 从缓存拿Service信息：有就直接用，没有就解析并缓存</span>
        <span class="hljs-type">LambdaMeta</span>&lt;<span class="hljs-type">T</span>&gt; lambdaMeta <span class="hljs-operator">=</span> (<span class="hljs-type">LambdaMeta</span>&lt;<span class="hljs-type">T</span>&gt;) <span class="hljs-type">CACHE_LAMBDA</span>.computeIfAbsent(fn, k-&gt; {
            <span class="hljs-comment">// 解析Lambda，拿到Service实例、类名这些信息</span>
            <span class="hljs-type">LambdaMeta</span>&lt;<span class="hljs-type">T</span>&gt; meta <span class="hljs-operator">=</span> parseSerialFunction(fn);
            log.debug(<span class="hljs-string">"缓存Service信息：{}"</span>, meta.getServiceName());
            <span class="hljs-keyword">return</span> meta;
        });
        <span class="hljs-comment">// 2. 创建执行器，把Lambda、参数、Service信息传进去</span>
        <span class="hljs-type">ServiceExecutor</span>&lt;<span class="hljs-type">T</span>,<span class="hljs-type">U</span>,<span class="hljs-type">R</span>&gt; executor <span class="hljs-operator">=</span> <span class="hljs-type">InstBuilder</span>.of(<span class="hljs-type">ServiceExecutor</span>.class)
                .set(ServiceExecutor::setServiceFn, fn)    <span class="hljs-comment">// 传Lambda方法</span>
                .set(ServiceExecutor::setParam, param)      <span class="hljs-comment">// 传参数</span>
                .set(ServiceExecutor::setLambdaMeta, lambdaMeta)  <span class="hljs-comment">// 传Service信息</span>
                .build();  <span class="hljs-comment">// 构建执行器</span>
        <span class="hljs-comment">// 3. 执行方法，返回结果</span>
        <span class="hljs-keyword">return</span> executor.callService();
    }
    <span class="hljs-comment">// 解析Lambda：从Lambda里拿到Service类名、实例、方法名</span>
    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-operator">&lt;</span><span class="hljs-type">T</span>, <span class="hljs-type">U</span>, <span class="hljs-type">R</span><span class="hljs-operator">&gt;</span> <span class="hljs-type">LambdaMeta</span>&lt;<span class="hljs-type">T</span>&gt; parseSerialFunction(<span class="hljs-type">SerialBiFunction</span>&lt;<span class="hljs-type">T</span>,<span class="hljs-type">U</span>,<span class="hljs-type">R</span>&gt; fn) {
        <span class="hljs-comment">// 用LambdaUtil拿到Lambda的元数据</span>
        <span class="hljs-type">SerializedLambda</span> lambda <span class="hljs-operator">=</span> <span class="hljs-type">LambdaUtil</span>.valueOf(fn);
        <span class="hljs-comment">// 封装Service信息的对象</span>
        <span class="hljs-type">LambdaMeta</span>&lt;<span class="hljs-type">T</span>&gt; lambdaMeta <span class="hljs-operator">=</span> new <span class="hljs-type">LambdaMeta</span>&lt;&gt;();
        <span class="hljs-comment">// 1. 解析Service类名：Lambda里的类名是“com/example/UserService”，要改成“com.example.UserService”</span>
        <span class="hljs-type">String</span> tClassName <span class="hljs-operator">=</span> lambda.getImplClass().replaceAll(<span class="hljs-string">"/"</span>, <span class="hljs-string">"."</span>);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 2. 拿到Service的Class对象（比如UserService.class）</span>
            <span class="hljs-type">Class</span>&lt;<span class="hljs-type">T</span>&gt; aClass <span class="hljs-operator">=</span> (<span class="hljs-type">Class</span>&lt;<span class="hljs-type">T</span>&gt;) <span class="hljs-type">Class</span>.forName(tClassName);
            <span class="hljs-comment">// 3. 从Spring里拿Service实例（不用@Autowired就是靠这行）</span>
            <span class="hljs-type">T</span> inst <span class="hljs-operator">=</span> <span class="hljs-type">SpringUtil</span>.getBean(aClass);
            <span class="hljs-comment">// 4. 把信息存到lambdaMeta里</span>
            lambdaMeta.setClazz(aClass);    <span class="hljs-comment">// 存Service的Class</span>
            lambdaMeta.setInst(inst);       <span class="hljs-comment">// 存Service实例</span>
            lambdaMeta.setServiceName(lambda.getImplMethodName());  <span class="hljs-comment">// 存方法名（比如queryUser）</span>
        } <span class="hljs-keyword">catch</span> (<span class="hljs-type">ClassNotFoundException</span> e) {
            <span class="hljs-comment">// 找不到类就抛异常</span>
            <span class="hljs-keyword">throw</span> new <span class="hljs-type">RuntimeException</span>(<span class="hljs-string">"没找到Service类："</span> <span class="hljs-operator">+</span> tClassName, e);
        }
        <span class="hljs-keyword">return</span> lambdaMeta;
    }
    <span class="hljs-comment">// 封装Service信息的内部类：存Class、实例、方法名</span>
    <span class="hljs-meta">@lombok</span>.<span class="hljs-type">Data</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LambdaMeta</span>&lt;<span class="hljs-title class_">T</span>&gt; {
        <span class="hljs-keyword">private</span> <span class="hljs-type">Class</span>&lt;<span class="hljs-type">T</span>&gt; clazz;          <span class="hljs-comment">// Service的Class（比如UserService.class）</span>
        <span class="hljs-keyword">private</span> <span class="hljs-type">T</span> inst;                  <span class="hljs-comment">// Service实例（Spring里的Bean）</span>
        <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> serviceName;      <span class="hljs-comment">// 方法名（比如queryUser）</span>
    }
}
</code></pre>
<h2 data-id="heading-9">第三步：执行器 ——ServiceExecutor</h2>
<p>这是帮咱统一执行方法、打日志、处理异常的 “打工人”：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.pro.wwcx.ledger.common.servicer;
<span class="hljs-keyword">import</span> lombok.Setter;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.pro.wwcx.ledger.common.dto.SerResult;
<span class="hljs-keyword">import</span> org.pro.wwcx.ledger.common.resolver.anno.SerialBiFunction;
<span class="hljs-comment">// 执行Service方法的类，统一打日志、处理异常</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Setter</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceExecutor</span>&lt;T, U, R&gt; {
    <span class="hljs-keyword">private</span> SerialBiFunction&lt;T, U, R&gt; serviceFn;  <span class="hljs-comment">// 要执行的Lambda方法</span>
    <span class="hljs-keyword">private</span> U param;                               <span class="hljs-comment">// 方法参数</span>
    <span class="hljs-keyword">private</span> ServiceManager.LambdaMeta&lt;T&gt; lambdaMeta;  <span class="hljs-comment">// Service信息</span>
    <span class="hljs-comment">// 执行方法的核心逻辑</span>
    <span class="hljs-keyword">public</span> SerResult&lt;R&gt; <span class="hljs-title function_">callService</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 记录开始时间，方便算耗时</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-type">String</span> <span class="hljs-variable">serviceName</span> <span class="hljs-operator">=</span> lambdaMeta.getClazz().getSimpleName();  <span class="hljs-comment">// 比如UserService</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> lambdaMeta.getServiceName();             <span class="hljs-comment">// 比如queryUser</span>
        log.info(<span class="hljs-string">"开始调用：{}的{}方法，参数：{}"</span>, serviceName, methodName, param);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 真正执行方法：用Service实例调用Lambda方法</span>
            <span class="hljs-type">R</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> serviceFn.apply(lambdaMeta.getInst(), param);
            <span class="hljs-comment">// 算耗时，打成功日志</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">costTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - startTime;
            log.info(<span class="hljs-string">"调用成功：{}的{}方法，耗时{}ms，结果：{}"</span>,
                    serviceName, methodName, costTime, result);
            <span class="hljs-comment">// 返回成功结果</span>
            <span class="hljs-keyword">return</span> SerResult.success(result);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 出错了就打错误日志，返回失败结果</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">costTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - startTime;
            log.error(<span class="hljs-string">"调用失败：{}的{}方法，耗时{}ms"</span>,
                    serviceName, methodName, costTime, e);
            <span class="hljs-keyword">return</span> SerResult.fail(<span class="hljs-string">"调用"</span> + serviceName + <span class="hljs-string">"的"</span> + methodName + <span class="hljs-string">"方法失败："</span> + e.getMessage());
        }
    }
}
</code></pre>
<h2 data-id="heading-10">第四步：怎么用？举个实际例子</h2>
<p>咱以用户查询和更新为例，看 Controller 里怎么写：</p>
<h3 data-id="heading-11">1. 先写个 Service（正常写，不用改）</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> org.pro.wwcx.ledger.service;
<span class="hljs-keyword">import</span> org.pro.wwcx.ledger.dto.UserDTO;
<span class="hljs-keyword">import</span> org.pro.wwcx.ledger.dto.UserUpdateDTO;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-comment">// 正常的Service，该咋写咋写</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-comment">// 查用户：根据ID查</span>
    <span class="hljs-keyword">public</span> UserDTO queryUser(<span class="hljs-built_in">Long</span> userId) {
        <span class="hljs-comment">// 这里模拟查数据库，实际项目里换JDBC/MyBatis</span>
        UserDTO user = new UserDTO();
        user.setUserId(userId);
        user.setUserName(<span class="hljs-string">"张三"</span>);
        user.setAge(<span class="hljs-number">25</span>);
        <span class="hljs-keyword">return</span> user;
    }
    <span class="hljs-comment">// 更新用户：传ID和更新参数</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">Boolean</span> updateUser(<span class="hljs-built_in">Long</span> userId, UserUpdateDTO updateDTO) {
        <span class="hljs-comment">// 这里模拟更新数据库</span>
        log.info(<span class="hljs-string">"更新用户{}的信息：{}"</span>, userId, updateDTO);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 返回更新成功</span>
    }
}
</code></pre>
<h3 data-id="heading-12">2. Controller 里调用（重点看变化）</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">package</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.pro</span><span class="hljs-selector-class">.wwcx</span><span class="hljs-selector-class">.ledger</span><span class="hljs-selector-class">.controller</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.pro</span><span class="hljs-selector-class">.wwcx</span><span class="hljs-selector-class">.ledger</span><span class="hljs-selector-class">.common</span><span class="hljs-selector-class">.dto</span><span class="hljs-selector-class">.SerResult</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.pro</span><span class="hljs-selector-class">.wwcx</span><span class="hljs-selector-class">.ledger</span><span class="hljs-selector-class">.common</span><span class="hljs-selector-class">.servicer</span><span class="hljs-selector-class">.ServiceManager</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.pro</span><span class="hljs-selector-class">.wwcx</span><span class="hljs-selector-class">.ledger</span><span class="hljs-selector-class">.dto</span><span class="hljs-selector-class">.UserDTO</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.pro</span><span class="hljs-selector-class">.wwcx</span><span class="hljs-selector-class">.ledger</span><span class="hljs-selector-class">.dto</span><span class="hljs-selector-class">.UserUpdateDTO</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.pro</span><span class="hljs-selector-class">.wwcx</span><span class="hljs-selector-class">.ledger</span><span class="hljs-selector-class">.service</span><span class="hljs-selector-class">.UserService</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.bind</span><span class="hljs-selector-class">.annotation</span>.*;
@<span class="hljs-selector-tag">RestController</span>
@<span class="hljs-selector-tag">RequestMapping</span>(<span class="hljs-string">"/user"</span>)
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">UserController</span> {
    <span class="hljs-comment">// 查用户：不用注入UserService！一行搞定</span>
    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/{userId}"</span>)
    public SerResult&lt;UserDTO&gt; <span class="hljs-built_in">getUser</span>(<span class="hljs-variable">@PathVariable</span> Long userId) {
        <span class="hljs-comment">// 直接传Lambda（UserService::queryUser）和参数（userId）</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ServiceManager</span><span class="hljs-selector-class">.call</span>(<span class="hljs-attribute">UserService</span>::queryUser, userId);
    }
    <span class="hljs-comment">// 更新用户：同样不用注入</span>
    @<span class="hljs-selector-tag">PutMapping</span>(<span class="hljs-string">"/{userId}"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">SerResult</span>&lt;<span class="hljs-selector-tag">Boolean</span>&gt; <span class="hljs-selector-tag">updateUser</span>(
            <span class="hljs-variable">@PathVariable</span> Long userId,
            <span class="hljs-variable">@RequestBody</span> UserUpdateDTO updateDTO) {
        <span class="hljs-comment">// 这里要注意：因为updateUser有两个参数，所以要显式指定Lambda类型</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ServiceManager</span><span class="hljs-selector-class">.call</span>(
                (UserService service, UserUpdateDTO dto) -&gt; service.<span class="hljs-built_in">updateUser</span>(userId, dto),
                updateDTO
        );
    }
}
</code></pre>
<h3 data-id="heading-13">3. 跑起来看看效果</h3>
<ul>
<li>查用户的时候，日志会自动打：</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">开始调用：UserService的queryUser方法，参数：1001
调用成功：UserService的queryUser方法，耗时5ms，结果：UserDTO(<span class="hljs-attr">userId</span>=<span class="hljs-number">1001</span>, userName=张三, age=<span class="hljs-number">25</span>)
</code></pre>
<ul>
<li>要是出错了，比如传个不存在的用户 ID（假设数据库查不到会抛异常），日志会打错误信息，返回给前端的结果是：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">500</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"msg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"调用UserService的queryUser方法失败：用户不存在"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-14">这组件的好处：总结一下</h2>
<ol>
<li><strong>不用再写 @Autowired</strong>：Controller 里干干净净，再也不用注入一堆 Service；</li>
</ol>

<ol start="2">
<li><strong>统一日志 / 异常</strong>：想改日志格式、加权限校验，只需要改 ServiceExecutor，不用改每个方法；</li>
</ol>

<ol start="3">
<li><strong>缓存优化</strong>：解析过的 Service 信息会缓存，下次调用更快；</li>
</ol>

<ol start="4">
<li><strong>类型安全</strong>：写 Lambda 的时候，方法名错了编译就报错，不用等到运行才发现。</li>
</ol>
<h2 data-id="heading-15">注意事项：避坑指南</h2>
<ol>
<li><strong>JDK 版本</strong>：用 JDK8 及以上，Lambda 表达式是 JDK8 才有的；</li>
</ol>

<ol start="2">
<li><strong>Service 要加 @Service</strong>：Spring 才能扫描到，不然 SpringUtil 拿不到实例；</li>
</ol>

<ol start="3">
<li><strong>多实现类的情况</strong>：如果一个接口有多个实现（比如 UserService 有 UserServiceImpl1 和 UserServiceImpl2），需要在 SpringUtil 里加按名称拿 Bean 的方法，具体可以评论区问我。</li>
</ol>
<p>最后说明下，文档里的代码是我一步步设计出来的，文档润色部分内容借助豆包工具帮忙整理，方便大家阅读。完整的代码我已经整理好了，直接复制到项目里，改改包名就能用。如果遇到问题，或者想扩展功能（比如加缓存过期、多参数支持），评论区一起聊～</p>
<p>觉得有用的话，点个赞再走呗！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 .ibd 文件恢复 MySQL 数据全流程]]></title>    <link>https://juejin.cn/post/7575031395861495854</link>    <guid>https://juejin.cn/post/7575031395861495854</guid>    <pubDate>2025-11-21T18:22:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575031395861495854" data-draft-id="7575004291833069619" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 .ibd 文件恢复 MySQL 数据全流程"/> <meta itemprop="keywords" content="后端,GitHub"/> <meta itemprop="datePublished" content="2025-11-21T18:22:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="九夜"/> <meta itemprop="url" content="https://juejin.cn/user/4318537404122941"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 .ibd 文件恢复 MySQL 数据全流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4318537404122941/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    九夜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T18:22:31.000Z" title="Fri Nov 21 2025 18:22:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>.ibd</code> 文件是 InnoDB 存储引擎的核心数据文件，存储表的行数据、索引及元信息。在仅有 <code>.ibd</code> 文件的情况下，可通过以下流程恢复数据。</p>
<h4 data-id="heading-0">一、.ibd 文件基础认知</h4>
<ol>
<li><strong>表空间模式</strong></li>
</ol>
<ul>
<li>
<ul>
<li><strong>独立表空间</strong>（MySQL 5.6+ 默认）：每张表对应独立 <code>.ibd</code> 文件（如 <code>user.ibd</code>），包含表的完整数据、索引及元数据，默认存储于 <code>datadir/数据库名/</code> 目录。</li>
<li><strong>系统表空间</strong>（旧模式）：所有表数据集中存储于 <code>ibdata1</code> 等共享文件，无独立 <code>.ibd</code> 文件。</li>
</ul>
</li>
</ul>
<ol start="2">
<li><strong>核心特性</strong></li>
</ol>
<ul>
<li>
<ul>
<li>二进制格式，需通过 MySQL 命令或专用工具解析；</li>
<li>依赖 redo 日志保障事务安全，通过 undo 日志支持 MVCC；</li>
<li>最小 I/O 单位为 16KB 页，由区（64 页）和段（索引对应的区集合）组成。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-1">二、恢复工具与流程</h4>
<p>使用开源工具 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fddcw%2Fibd2sql" target="_blank" title="https://github.com/ddcw/ibd2sql" ref="nofollow noopener noreferrer">ibd2sql</a> 解析 <code>.ibd</code> 文件，支持提取表结构（DDL）和数据（SQL）。</p>
<h5 data-id="heading-2">1. 工具准备</h5>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 下载工具</span>
wget <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/ddcw</span><span class="hljs-regexp">/ibd2sql/archive</span><span class="hljs-regexp">/refs/heads</span><span class="hljs-regexp">/ibd2sql-v2.x.zip
unzip ibd2sql-v2.x.zip
cd ibd2sql-ibd2sql-v2.x/</span>

<span class="hljs-comment"># 确认 Python3 环境</span>
python --version  <span class="hljs-comment"># 需 Python 3.x</span>
</code></pre>
<h5 data-id="heading-3">2. 单文件解析</h5>
<pre><code class="hljs language-css" lang="css">python3 <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.py</span> your_file<span class="hljs-selector-class">.ibd</span> <span class="hljs-attr">--sql</span> <span class="hljs-attr">--ddl</span>
</code></pre>
<p>执行后生成包含表结构和数据的 SQL 文件。</p>
<h4 data-id="heading-4">三、批量处理脚本</h4>
<p>当存在大量 <code>.ibd</code> 文件时，使用以下脚本批量解析：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> subprocess
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

<span class="hljs-comment"># ===================== 配置参数（按需修改）=====================</span>
ROOT_DIR = Path(__file__).resolve().parent
SOURCE_IBD_DIR = Path(os.path.expanduser(<span class="hljs-string">"./input_ibd"</span>)).resolve()  <span class="hljs-comment"># 源 ibd 目录</span>
OUTPUT_SQL_DIR = Path(os.path.expanduser(<span class="hljs-string">"./output_sql"</span>)).resolve()  <span class="hljs-comment"># 输出 SQL 目录</span>
PYTHON_CMD = sys.executable <span class="hljs-keyword">or</span> <span class="hljs-string">"python3"</span>  <span class="hljs-comment"># 使用当前 python</span>
MAIN_SCRIPT = ROOT_DIR / <span class="hljs-string">"main.py"</span>
<span class="hljs-comment"># ===============================================================</span>

OUTPUT_SQL_DIR.mkdir(parents=<span class="hljs-literal">True</span>, exist_ok=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 日志文件（macOS 下默认编码为 UTF-8，无需额外设置）</span>
LOG_FILE = OUTPUT_SQL_DIR / <span class="hljs-string">f"parse_log_<span class="hljs-subst">{datetime.now().strftime(<span class="hljs-string">'%Y%m%d_%H%M%S'</span>)}</span>.log"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">log</span>(<span class="hljs-params">info, level=<span class="hljs-string">"INFO"</span></span>):
    <span class="hljs-string">"""日志输出（控制台 + 文件）"""</span>
    msg = <span class="hljs-string">f"[<span class="hljs-subst">{level}</span>] [<span class="hljs-subst">{datetime.now().strftime(<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>)}</span>] <span class="hljs-subst">{info}</span>"</span>
    <span class="hljs-built_in">print</span>(msg)
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(LOG_FILE, <span class="hljs-string">"a"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
        f.write(msg + <span class="hljs-string">"\n"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_single_ibd</span>(<span class="hljs-params">ibd_file_path: Path</span>) -&gt; <span class="hljs-built_in">bool</span>:
    <span class="hljs-string">"""调用官方 main.py 解析单个 ibd，并将 stdout 写入同名 .sql 文件"""</span>
    table_name = ibd_file_path.stem
    sql_file = OUTPUT_SQL_DIR / <span class="hljs-string">f"<span class="hljs-subst">{table_name}</span>.sql"</span>
    log(<span class="hljs-string">f"开始解析表：<span class="hljs-subst">{table_name}</span>（文件：<span class="hljs-subst">{ibd_file_path.name}</span>）"</span>)

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> MAIN_SCRIPT.exists():
        log(<span class="hljs-string">f"❌ 未找到 main.py，期望路径：<span class="hljs-subst">{MAIN_SCRIPT}</span>"</span>, level=<span class="hljs-string">"ERROR"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

    cmd = [
        PYTHON_CMD,
        <span class="hljs-built_in">str</span>(MAIN_SCRIPT),
        <span class="hljs-built_in">str</span>(ibd_file_path),
        <span class="hljs-string">"--sql"</span>,
        <span class="hljs-string">"--ddl"</span>,
    ]

    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(sql_file, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> sql_fp:
            proc = subprocess.run(
                cmd,
                stdout=sql_fp,
                stderr=subprocess.PIPE,
                text=<span class="hljs-literal">True</span>,
                cwd=ROOT_DIR,
                check=<span class="hljs-literal">False</span>,
            )
        <span class="hljs-keyword">if</span> proc.returncode != <span class="hljs-number">0</span>:
            log(<span class="hljs-string">f"❌ 解析失败（退出码 <span class="hljs-subst">{proc.returncode}</span>）：<span class="hljs-subst">{proc.stderr.strip()}</span>"</span>, level=<span class="hljs-string">"ERROR"</span>)
            <span class="hljs-keyword">if</span> sql_file.exists():
                sql_file.unlink()
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">if</span> proc.stderr.strip():
            log(<span class="hljs-string">f"⚠️  命令警告：<span class="hljs-subst">{proc.stderr.strip()}</span>"</span>, level=<span class="hljs-string">"WARNING"</span>)
        log(<span class="hljs-string">f"✅ SQL 生成成功：<span class="hljs-subst">{sql_file}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
    <span class="hljs-keyword">except</span> FileNotFoundError <span class="hljs-keyword">as</span> exc:
        log(<span class="hljs-string">f"❌ 命令执行失败：<span class="hljs-subst">{exc}</span>"</span>, level=<span class="hljs-string">"ERROR"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> exc:
        log(<span class="hljs-string">f"❌ 未知异常：<span class="hljs-subst">{exc}</span>"</span>, level=<span class="hljs-string">"ERROR"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    log(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    log(<span class="hljs-string">"ibd2sql 批量解析任务（macOS 版）启动"</span>)
    log(<span class="hljs-string">f"源 ibd 目录：<span class="hljs-subst">{SOURCE_IBD_DIR}</span>"</span>)
    log(<span class="hljs-string">f"输出 SQL 目录：<span class="hljs-subst">{OUTPUT_SQL_DIR}</span>"</span>)
    log(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span> + <span class="hljs-string">"\n"</span>)

    <span class="hljs-comment"># 遍历所有 .ibd 文件（自动过滤非 ibd 文件）</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> SOURCE_IBD_DIR.is_dir():
        log(<span class="hljs-string">"⚠️  源目录不存在，请检查配置！"</span>, level=<span class="hljs-string">"ERROR"</span>)
        sys.exit(<span class="hljs-number">1</span>)

    ibd_files = <span class="hljs-built_in">sorted</span>(SOURCE_IBD_DIR.glob(<span class="hljs-string">"*.ibd"</span>))
    total_count = <span class="hljs-built_in">len</span>(ibd_files)
    success_count = <span class="hljs-number">0</span>
    fail_count = <span class="hljs-number">0</span>
    fail_tables = []

    <span class="hljs-keyword">if</span> total_count == <span class="hljs-number">0</span>:
        log(<span class="hljs-string">"⚠️  未发现 ibd 文件，请检查源目录是否正确！"</span>, level=<span class="hljs-string">"WARNING"</span>)
        sys.exit(<span class="hljs-number">1</span>)

    log(<span class="hljs-string">f"发现 <span class="hljs-subst">{total_count}</span> 个 ibd 文件，开始批量解析...\n"</span>)

    <span class="hljs-keyword">for</span> ibd_path <span class="hljs-keyword">in</span> ibd_files:
        <span class="hljs-keyword">if</span> parse_single_ibd(ibd_path):
            success_count += <span class="hljs-number">1</span>
        <span class="hljs-keyword">else</span>:
            fail_count += <span class="hljs-number">1</span>
            fail_tables.append(ibd_path.stem)
        log(<span class="hljs-string">"-"</span> * <span class="hljs-number">40</span> + <span class="hljs-string">"\n"</span>)

    <span class="hljs-comment"># 输出统计结果</span>
    log(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    log(<span class="hljs-string">"批量解析任务结束"</span>)
    log(<span class="hljs-string">f"总文件数：<span class="hljs-subst">{total_count}</span>"</span>)
    log(<span class="hljs-string">f"成功解析：<span class="hljs-subst">{success_count}</span> 个"</span>)
    log(<span class="hljs-string">f"解析失败：<span class="hljs-subst">{fail_count}</span> 个"</span>)
    <span class="hljs-keyword">if</span> fail_tables:
        log(<span class="hljs-string">f"失败表名：<span class="hljs-subst">{<span class="hljs-string">','</span>.join(fail_tables)}</span>"</span>, level=<span class="hljs-string">"ERROR"</span>)
    log(<span class="hljs-string">f"日志文件：<span class="hljs-subst">{LOG_FILE}</span>"</span>)
    log(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
</code></pre>
<h4 data-id="heading-5">四、SQL 文件修正</h4>
<p>解析后的 SQL 可能存在格式问题，需进一步处理：</p>
<h5 data-id="heading-6">1. 移除 JSON 字段的字符集声明</h5>
<p>MySQL JSON 类型为二进制存储，无需指定字符集/排序规则，脚本如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> argparse
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">import</span> re

<span class="hljs-comment"># 默认输出目录，与 batch_ibd2sql.py 保持一致</span>
DEFAULT_OUTPUT_SQL_DIR = Path(__file__).resolve().parent / <span class="hljs-string">"output_sql"</span>

JSON_KEYWORD = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r"\bjson\b"</span>, re.IGNORECASE)
CHARSET_PATTERN = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r"\s+CHARACTER\s+SET\s+\w+"</span>, re.IGNORECASE)
COLLATE_PATTERN = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r"\s+COLLATE\s+\w+"</span>, re.IGNORECASE)
COLUMN_NAME_PATTERN = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r"`([^`]+)`"</span>)


<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcessResult</span>:
    file_path: Path
    columns: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]
    modified: <span class="hljs-built_in">bool</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">clean_line</span>(<span class="hljs-params">line: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span>]:
    <span class="hljs-string">"""
    若该行定义 JSON 字段且指定了字符集/排序规则，则移除相关声明。
    返回 (新行内容, 字段名或 None)。
    """</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> JSON_KEYWORD.search(line):
        <span class="hljs-keyword">return</span> line, <span class="hljs-literal">None</span>

    has_charset = <span class="hljs-string">"CHARACTER SET"</span> <span class="hljs-keyword">in</span> line.upper()
    has_collate = <span class="hljs-string">"COLLATE"</span> <span class="hljs-keyword">in</span> line.upper()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (has_charset <span class="hljs-keyword">or</span> has_collate):
        <span class="hljs-keyword">return</span> line, <span class="hljs-literal">None</span>

    new_line = CHARSET_PATTERN.sub(<span class="hljs-string">""</span>, line)
    new_line = COLLATE_PATTERN.sub(<span class="hljs-string">""</span>, new_line)

    <span class="hljs-keyword">if</span> new_line == line:
        <span class="hljs-keyword">return</span> line, <span class="hljs-literal">None</span>

    <span class="hljs-keyword">match</span> = COLUMN_NAME_PATTERN.search(line)
    column_name = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"&lt;unknown&gt;"</span>
    <span class="hljs-keyword">return</span> new_line, column_name


<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_sql_file</span>(<span class="hljs-params">file_path: Path, dry_run: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span></span>) -&gt; ProcessResult:
    original = file_path.read_text(encoding=<span class="hljs-string">"utf-8"</span>)
    lines = original.splitlines()
    trailing_newline = original.endswith(<span class="hljs-string">"\n"</span>)

    processed_lines = []
    touched_columns: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>] = []

    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> lines:
        new_line, column = clean_line(line)
        processed_lines.append(new_line)
        <span class="hljs-keyword">if</span> column <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            touched_columns.append(column)

    modified = <span class="hljs-built_in">bool</span>(touched_columns)
    <span class="hljs-keyword">if</span> modified <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> dry_run:
        new_content = <span class="hljs-string">"\n"</span>.join(processed_lines)
        <span class="hljs-keyword">if</span> trailing_newline:
            new_content += <span class="hljs-string">"\n"</span>
        file_path.write_text(new_content, encoding=<span class="hljs-string">"utf-8"</span>)

    <span class="hljs-keyword">return</span> ProcessResult(file_path=file_path, columns=touched_columns, modified=modified)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">iter_sql_files</span>(<span class="hljs-params">root_dir: Path</span>):
    <span class="hljs-keyword">for</span> path <span class="hljs-keyword">in</span> <span class="hljs-built_in">sorted</span>(root_dir.rglob(<span class="hljs-string">"*.sql"</span>)):
        <span class="hljs-keyword">if</span> path.is_file():
            <span class="hljs-keyword">yield</span> path


<span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_args</span>():
    parser = argparse.ArgumentParser(
        description=<span class="hljs-string">"移除 SQL 文件中 JSON 字段的字符集/排序规则声明（MySQL JSON 内置二进制类型无需设定字符集）。"</span>
    )
    parser.add_argument(
        <span class="hljs-string">"-t"</span>,
        <span class="hljs-string">"--target"</span>,
        default=<span class="hljs-built_in">str</span>(DEFAULT_OUTPUT_SQL_DIR),
        <span class="hljs-built_in">help</span>=<span class="hljs-string">"待扫描的 SQL 目录，默认为项目 output_sql"</span>,
    )
    parser.add_argument(
        <span class="hljs-string">"--dry-run"</span>,
        action=<span class="hljs-string">"store_true"</span>,
        <span class="hljs-built_in">help</span>=<span class="hljs-string">"仅报告将要修改的内容，不实际写回文件"</span>,
    )
    <span class="hljs-keyword">return</span> parser.parse_args()


<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    args = parse_args()
    target_dir = Path(args.target).expanduser().resolve()

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> target_dir.is_dir():
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[ERROR] 目录不存在：<span class="hljs-subst">{target_dir}</span>"</span>, file=sys.stderr)
        sys.exit(<span class="hljs-number">1</span>)

    has_changes = <span class="hljs-literal">False</span>
    total_files = <span class="hljs-number">0</span>
    total_columns = <span class="hljs-number">0</span>

    <span class="hljs-keyword">for</span> sql_file <span class="hljs-keyword">in</span> iter_sql_files(target_dir):
        total_files += <span class="hljs-number">1</span>
        result = process_sql_file(sql_file, dry_run=args.dry_run)
        <span class="hljs-keyword">if</span> result.modified:
            has_changes = <span class="hljs-literal">True</span>
            total_columns += <span class="hljs-built_in">len</span>(result.columns)
            state = <span class="hljs-string">"DRY-RUN"</span> <span class="hljs-keyword">if</span> args.dry_run <span class="hljs-keyword">else</span> <span class="hljs-string">"UPDATED"</span>
            columns_str = <span class="hljs-string">", "</span>.join(result.columns)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[<span class="hljs-subst">{state}</span>] <span class="hljs-subst">{sql_file}</span> -&gt; <span class="hljs-subst">{columns_str}</span>"</span>)

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> has_changes:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[INFO] 未检测到需要处理的 JSON 字段，扫描文件数：<span class="hljs-subst">{total_files}</span>"</span>)
    <span class="hljs-keyword">else</span>:
        mode = <span class="hljs-string">"dry-run"</span> <span class="hljs-keyword">if</span> args.dry_run <span class="hljs-keyword">else</span> <span class="hljs-string">"write"</span>
        <span class="hljs-built_in">print</span>(
            <span class="hljs-string">f"[SUMMARY] 模式=<span class="hljs-subst">{mode}</span>, 处理文件数=<span class="hljs-subst">{total_files}</span>, 修正字段数=<span class="hljs-subst">{total_columns}</span>"</span>
        )


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h5 data-id="heading-7">2. 修复索引注释格式（可选）</h5>
<p>部分表可能存在索引注释缺少 <code>COMMENT</code> 关键字或引号的问题，可使用以下脚本修复（未完全测试，少量异常表建议手动修改）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>
<span class="hljs-string">"""
修复 SQL 文件中 KEY/UNIQUE KEY/PRIMARY KEY 注释缺少 COMMENT 关键字的问题
将类似: KEY `xxx` (`column`) 注释内容
修改为: KEY `xxx` (`column`) COMMENT '注释内容'
同时处理: UNIQUE KEY, KEY, PRIMARY KEY 等所有索引定义
"""</span>

<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> re
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Tuple</span>, <span class="hljs-type">Dict</span>

<span class="hljs-comment"># ===================== 配置参数 =====================</span>
OUTPUT_SQL_DIR = Path(<span class="hljs-string">"./output_sql"</span>).resolve()  <span class="hljs-comment"># 输出 SQL 目录</span>
<span class="hljs-comment"># ===============================================================</span>

<span class="hljs-comment"># 日志文件</span>
LOG_FILE = OUTPUT_SQL_DIR / <span class="hljs-string">f"fix_unique_key_comment_log_<span class="hljs-subst">{datetime.now().strftime(<span class="hljs-string">'%Y%m%d_%H%M%S'</span>)}</span>.log"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">log</span>(<span class="hljs-params">info: <span class="hljs-built_in">str</span>, level: <span class="hljs-built_in">str</span> = <span class="hljs-string">"INFO"</span></span>):
    <span class="hljs-string">"""日志输出（控制台 + 文件）"""</span>
    msg = <span class="hljs-string">f"[<span class="hljs-subst">{level}</span>] [<span class="hljs-subst">{datetime.now().strftime(<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>)}</span>] <span class="hljs-subst">{info}</span>"</span>
    <span class="hljs-built_in">print</span>(msg)
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(LOG_FILE, <span class="hljs-string">"a"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
        f.write(msg + <span class="hljs-string">"\n"</span>)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">find_key_without_comment</span>(<span class="hljs-params">content: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Tuple</span>[<span class="hljs-built_in">int</span>, <span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]:
    <span class="hljs-string">"""
    查找所有缺少 COMMENT 关键字的 KEY 定义（包括 UNIQUE KEY, KEY, PRIMARY KEY）
    
    返回: [(行号, 原始行, KEY类型, 匹配的注释内容), ...]
    """</span>
    issues = []
    lines = content.split(<span class="hljs-string">'\n'</span>)
    
    <span class="hljs-keyword">for</span> line_num, line <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(lines, <span class="hljs-number">1</span>):
        <span class="hljs-comment"># 跳过已经有 COMMENT 关键字的行</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'COMMENT'</span> <span class="hljs-keyword">in</span> line.upper():
            <span class="hljs-keyword">continue</span>
        
        <span class="hljs-comment"># 检查是否包含 KEY 定义</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'KEY'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> line.upper():
            <span class="hljs-keyword">continue</span>
        
        line_upper = line.upper()
        <span class="hljs-keyword">match</span> = <span class="hljs-literal">None</span>
        key_type = <span class="hljs-literal">None</span>
        
        <span class="hljs-comment"># 按优先级匹配：PRIMARY KEY &gt; UNIQUE KEY &gt; KEY</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'PRIMARY KEY'</span> <span class="hljs-keyword">in</span> line_upper:
            <span class="hljs-keyword">match</span> = re.search(
                <span class="hljs-string">r'(PRIMARY\s+KEY\s+[^)]+))\s+([^,\n]+?)(?=\s*[,)]|\s*$)'</span>,
                line,
                re.IGNORECASE
            )
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:
                key_type = <span class="hljs-string">'PRIMARY KEY'</span>
        <span class="hljs-keyword">elif</span> <span class="hljs-string">'UNIQUE KEY'</span> <span class="hljs-keyword">in</span> line_upper:
            <span class="hljs-keyword">match</span> = re.search(
                <span class="hljs-string">r'(UNIQUE\s+KEY\s+[^)]+))\s+([^,\n]+?)(?=\s*[,)]|\s*$)'</span>,
                line,
                re.IGNORECASE
            )
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:
                key_type = <span class="hljs-string">'UNIQUE KEY'</span>
        <span class="hljs-keyword">elif</span> re.search(<span class="hljs-string">r'\bKEY\s+'</span>, line, re.IGNORECASE):
            <span class="hljs-comment"># 普通 KEY，确保不是 UNIQUE KEY 或 PRIMARY KEY</span>
            <span class="hljs-keyword">match</span> = re.search(
                <span class="hljs-string">r'(\bKEY\s+[^)]+))\s+([^,\n]+?)(?=\s*[,)]|\s*$)'</span>,
                line,
                re.IGNORECASE
            )
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:
                key_type = <span class="hljs-string">'KEY'</span>
        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span> <span class="hljs-keyword">and</span> key_type:
            comment_text = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>).strip().rstrip(<span class="hljs-string">','</span>).strip()
            
            <span class="hljs-comment"># 排除空注释</span>
            <span class="hljs-keyword">if</span> comment_text:
                issues.append((line_num, line, key_type, comment_text))
    
    <span class="hljs-keyword">return</span> issues


<span class="hljs-keyword">def</span> <span class="hljs-title function_">fix_key_comment</span>(<span class="hljs-params">content: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>]]:
    <span class="hljs-string">"""
    修复 KEY 注释问题（包括 UNIQUE KEY, KEY, PRIMARY KEY）
    
    返回: (修复后的内容, 修复记录列表)
    """</span>
    lines = content.split(<span class="hljs-string">'\n'</span>)
    fixes = []
    new_lines = []
    
    <span class="hljs-keyword">for</span> line_num, line <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(lines, <span class="hljs-number">1</span>):
        original_line = line
        fixed = <span class="hljs-literal">False</span>
        
        <span class="hljs-comment"># 跳过已经有 COMMENT 关键字的行</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'COMMENT'</span> <span class="hljs-keyword">in</span> line.upper():
            new_lines.append(line)
            <span class="hljs-keyword">continue</span>
        
        <span class="hljs-comment"># 检查是否包含 KEY 定义</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'KEY'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> line.upper():
            new_lines.append(line)
            <span class="hljs-keyword">continue</span>
        
        line_upper = line.upper()
        <span class="hljs-keyword">match</span> = <span class="hljs-literal">None</span>
        key_type = <span class="hljs-literal">None</span>
        pattern = <span class="hljs-literal">None</span>
        
        <span class="hljs-comment"># 按优先级匹配：PRIMARY KEY &gt; UNIQUE KEY &gt; KEY</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'PRIMARY KEY'</span> <span class="hljs-keyword">in</span> line_upper:
            pattern = <span class="hljs-string">r'(PRIMARY\s+KEY\s+[^)]+))\s+([^,\n]+?)(?=\s*[,)]|\s*$)'</span>
            <span class="hljs-keyword">match</span> = re.search(pattern, line, re.IGNORECASE)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:
                key_type = <span class="hljs-string">'PRIMARY KEY'</span>
        <span class="hljs-keyword">elif</span> <span class="hljs-string">'UNIQUE KEY'</span> <span class="hljs-keyword">in</span> line_upper:
            pattern = <span class="hljs-string">r'(UNIQUE\s+KEY\s+[^)]+))\s+([^,\n]+?)(?=\s*[,)]|\s*$)'</span>
            <span class="hljs-keyword">match</span> = re.search(pattern, line, re.IGNORECASE)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:
                key_type = <span class="hljs-string">'UNIQUE KEY'</span>
        <span class="hljs-keyword">elif</span> re.search(<span class="hljs-string">r'\bKEY\s+'</span>, line, re.IGNORECASE):
            <span class="hljs-comment"># 普通 KEY，确保不是 UNIQUE KEY 或 PRIMARY KEY</span>
            pattern = <span class="hljs-string">r'(\bKEY\s+[^)]+))\s+([^,\n]+?)(?=\s*[,)]|\s*$)'</span>
            <span class="hljs-keyword">match</span> = re.search(pattern, line, re.IGNORECASE)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:
                key_type = <span class="hljs-string">'KEY'</span>
        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span> <span class="hljs-keyword">and</span> key_type <span class="hljs-keyword">and</span> pattern:
            key_def = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>)
            comment_text = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>).strip()
            
            <span class="hljs-comment"># 排除空注释或只是空白字符</span>
            <span class="hljs-keyword">if</span> comment_text <span class="hljs-keyword">and</span> comment_text.strip():
                <span class="hljs-comment"># 移除末尾的逗号（如果有）</span>
                comment_text = comment_text.rstrip(<span class="hljs-string">','</span>).strip()
                
                <span class="hljs-comment"># 检查注释是否已经用引号包裹</span>
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (comment_text.startswith(<span class="hljs-string">"'"</span>) <span class="hljs-keyword">and</span> comment_text.endswith(<span class="hljs-string">"'"</span>)):
                    <span class="hljs-comment"># 转义单引号</span>
                    escaped_comment = comment_text.replace(<span class="hljs-string">"'"</span>, <span class="hljs-string">"''"</span>)
                    <span class="hljs-comment"># 用单引号包裹</span>
                    quoted_comment = <span class="hljs-string">f"'<span class="hljs-subst">{escaped_comment}</span>'"</span>
                <span class="hljs-keyword">else</span>:
                    quoted_comment = comment_text
                
                <span class="hljs-comment"># 使用正则替换</span>
                <span class="hljs-comment"># 匹配: KEY ... ) 注释内容 [逗号或行尾]</span>
                <span class="hljs-comment"># 替换为: KEY ... ) COMMENT '注释内容' [逗号或行尾]</span>
                new_line = re.sub(
                    pattern,
                    <span class="hljs-string">rf'\1 COMMENT <span class="hljs-subst">{quoted_comment}</span>'</span>,
                    line,
                    count=<span class="hljs-number">1</span>,
                    flags=re.IGNORECASE
                )
                
                <span class="hljs-comment"># 确保行尾的逗号被保留（如果原来有的话）</span>
                <span class="hljs-keyword">if</span> line.rstrip().endswith(<span class="hljs-string">','</span>) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> new_line.rstrip().endswith(<span class="hljs-string">','</span>):
                    new_line = new_line.rstrip() + <span class="hljs-string">','</span>
                
                fixes.append({
                    <span class="hljs-string">'line'</span>: line_num,
                    <span class="hljs-string">'key_type'</span>: key_type,
                    <span class="hljs-string">'original'</span>: original_line.strip(),
                    <span class="hljs-string">'fixed'</span>: new_line.strip(),
                    <span class="hljs-string">'comment'</span>: quoted_comment
                })
                
                new_lines.append(new_line)
                fixed = <span class="hljs-literal">True</span>
        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> fixed:
            new_lines.append(line)
    
    <span class="hljs-keyword">return</span> <span class="hljs-string">'\n'</span>.join(new_lines), fixes


<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_sql_file</span>(<span class="hljs-params">sql_file: Path</span>) -&gt; <span class="hljs-type">Dict</span>:
    <span class="hljs-string">"""处理单个 SQL 文件"""</span>
    result = {
        <span class="hljs-string">'file'</span>: <span class="hljs-built_in">str</span>(sql_file),
        <span class="hljs-string">'fixed'</span>: <span class="hljs-literal">False</span>,
        <span class="hljs-string">'fixes'</span>: []
    }
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(sql_file, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
            content = f.read()
        
        <span class="hljs-comment"># 查找问题</span>
        issues = find_key_without_comment(content)
        
        <span class="hljs-keyword">if</span> issues:
            <span class="hljs-comment"># 修复问题</span>
            new_content, fixes = fix_key_comment(content)
            
            <span class="hljs-keyword">if</span> fixes:
                <span class="hljs-comment"># 写回文件</span>
                <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(sql_file, <span class="hljs-string">'w'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
                    f.write(new_content)
                
                result[<span class="hljs-string">'fixed'</span>] = <span class="hljs-literal">True</span>
                result[<span class="hljs-string">'fixes'</span>] = fixes
                
                log(<span class="hljs-string">f"✅ 修复文件: <span class="hljs-subst">{sql_file.name}</span>"</span>)
                <span class="hljs-keyword">for</span> fix <span class="hljs-keyword">in</span> fixes:
                    key_type = fix.get(<span class="hljs-string">'key_type'</span>, <span class="hljs-string">'KEY'</span>)
                    log(<span class="hljs-string">f"   行 <span class="hljs-subst">{fix[<span class="hljs-string">'line'</span>]}</span> (<span class="hljs-subst">{key_type}</span>): <span class="hljs-subst">{fix[<span class="hljs-string">'original'</span>]}</span>"</span>)
                    log(<span class="hljs-string">f"   -&gt; <span class="hljs-subst">{fix[<span class="hljs-string">'fixed'</span>]}</span>"</span>)
            <span class="hljs-keyword">else</span>:
                log(<span class="hljs-string">f"⚠️  发现问题但未修复: <span class="hljs-subst">{sql_file.name}</span>"</span>)
        <span class="hljs-keyword">else</span>:
            log(<span class="hljs-string">f"✓  无问题: <span class="hljs-subst">{sql_file.name}</span>"</span>)
    
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        log(<span class="hljs-string">f"❌ 处理文件失败 <span class="hljs-subst">{sql_file.name}</span>: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>, level=<span class="hljs-string">"ERROR"</span>)
        result[<span class="hljs-string">'error'</span>] = <span class="hljs-built_in">str</span>(e)
    
    <span class="hljs-keyword">return</span> result


<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-string">"""主函数"""</span>
    log(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    log(<span class="hljs-string">"KEY/UNIQUE KEY/PRIMARY KEY 注释修复任务启动"</span>)
    log(<span class="hljs-string">f"扫描目录：<span class="hljs-subst">{OUTPUT_SQL_DIR}</span>"</span>)
    log(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span> + <span class="hljs-string">"\n"</span>)
    
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> OUTPUT_SQL_DIR.exists():
        log(<span class="hljs-string">f"❌ 目录不存在：<span class="hljs-subst">{OUTPUT_SQL_DIR}</span>"</span>, level=<span class="hljs-string">"ERROR"</span>)
        sys.exit(<span class="hljs-number">1</span>)
    
    <span class="hljs-comment"># 查找所有 SQL 文件</span>
    sql_files = <span class="hljs-built_in">sorted</span>(OUTPUT_SQL_DIR.glob(<span class="hljs-string">"*.sql"</span>))
    total_count = <span class="hljs-built_in">len</span>(sql_files)
    
    <span class="hljs-keyword">if</span> total_count == <span class="hljs-number">0</span>:
        log(<span class="hljs-string">"⚠️  未发现 SQL 文件"</span>, level=<span class="hljs-string">"WARNING"</span>)
        sys.exit(<span class="hljs-number">1</span>)
    
    log(<span class="hljs-string">f"发现 <span class="hljs-subst">{total_count}</span> 个 SQL 文件，开始扫描...\n"</span>)
    
    <span class="hljs-comment"># 统计信息</span>
    fixed_files = []
    total_fixes = <span class="hljs-number">0</span>
    all_fixes_detail = []
    
        <span class="hljs-comment"># 处理每个文件</span>
    <span class="hljs-keyword">for</span> sql_file <span class="hljs-keyword">in</span> sql_files:
        result = process_sql_file(sql_file)
        <span class="hljs-keyword">if</span> result[<span class="hljs-string">'fixed'</span>]:
            fixed_files.append(result[<span class="hljs-string">'file'</span>])
            total_fixes += <span class="hljs-built_in">len</span>(result[<span class="hljs-string">'fixes'</span>])
            <span class="hljs-comment"># 为每个修复添加文件信息</span>
            <span class="hljs-keyword">for</span> fix <span class="hljs-keyword">in</span> result[<span class="hljs-string">'fixes'</span>]:
                fix[<span class="hljs-string">'file'</span>] = result[<span class="hljs-string">'file'</span>]
            all_fixes_detail.extend(result[<span class="hljs-string">'fixes'</span>])
        log(<span class="hljs-string">"-"</span> * <span class="hljs-number">40</span> + <span class="hljs-string">"\n"</span>)
    
    <span class="hljs-comment"># 输出统计结果</span>
    log(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    log(<span class="hljs-string">"修复任务结束"</span>)
    log(<span class="hljs-string">f"总文件数：<span class="hljs-subst">{total_count}</span>"</span>)
    log(<span class="hljs-string">f"修复文件数：<span class="hljs-subst">{<span class="hljs-built_in">len</span>(fixed_files)}</span>"</span>)
    log(<span class="hljs-string">f"总修复数：<span class="hljs-subst">{total_fixes}</span>"</span>)
    log(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    
    <span class="hljs-comment"># 输出详细修复信息</span>
    <span class="hljs-keyword">if</span> all_fixes_detail:
        log(<span class="hljs-string">"\n详细修复信息："</span>)
        log(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
        <span class="hljs-keyword">for</span> fix <span class="hljs-keyword">in</span> all_fixes_detail:
            <span class="hljs-comment"># 从文件路径中提取文件名</span>
            file_name = Path(fix.get(<span class="hljs-string">'file'</span>, <span class="hljs-string">''</span>)).name <span class="hljs-keyword">if</span> <span class="hljs-string">'file'</span> <span class="hljs-keyword">in</span> fix <span class="hljs-keyword">else</span> <span class="hljs-string">'unknown'</span>
            key_type = fix.get(<span class="hljs-string">'key_type'</span>, <span class="hljs-string">'KEY'</span>)
            log(<span class="hljs-string">f"\n文件: <span class="hljs-subst">{file_name}</span>"</span>)
            log(<span class="hljs-string">f"行号: <span class="hljs-subst">{fix[<span class="hljs-string">'line'</span>]}</span>"</span>)
            log(<span class="hljs-string">f"类型: <span class="hljs-subst">{key_type}</span>"</span>)
            log(<span class="hljs-string">f"原始: <span class="hljs-subst">{fix[<span class="hljs-string">'original'</span>]}</span>"</span>)
            log(<span class="hljs-string">f"修复: <span class="hljs-subst">{fix[<span class="hljs-string">'fixed'</span>]}</span>"</span>)
            log(<span class="hljs-string">f"注释: <span class="hljs-subst">{fix[<span class="hljs-string">'comment'</span>]}</span>"</span>)
        log(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    
    log(<span class="hljs-string">f"\n日志文件：<span class="hljs-subst">{LOG_FILE}</span>"</span>)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h4 data-id="heading-8">总结</h4>
<p>通过 <code>ibd2sql</code> 工具结合批量处理脚本，可高效恢复 <code>.ibd</code> 文件中的数据。解析后需注意修正 JSON 字段格式及索引注释问题，少量异常表建议手动调整以确保数据完整性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[247. Java 集合 - 为什么要远离 Stack 类？]]></title>    <link>https://juejin.cn/post/7575050949959188516</link>    <guid>https://juejin.cn/post/7575050949959188516</guid>    <pubDate>2025-11-21T23:45:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575050949959188516" data-draft-id="7575021014033072147" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="247. Java 集合 - 为什么要远离 Stack 类？"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-11-21T23:45:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Cache技术分享"/> <meta itemprop="url" content="https://juejin.cn/user/1662117313262776"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            247. Java 集合 - 为什么要远离 Stack 类？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1662117313262776/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Cache技术分享
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T23:45:57.000Z" title="Fri Nov 21 2025 23:45:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">247. Java 集合 - 为什么要远离 <code>Stack</code> 类？</h2>
<p>虽然 <code>Stack</code> 类在 <code>JDK</code> 中依然存在，使用起来也非常简单直观，比如提供了我们期望的经典三大方法：</p>
<ul>
<li><code>push(element)</code>：压入元素</li>
<li><code>pop()</code>：弹出栈顶元素</li>
<li><code>peek()</code>：查看栈顶元素但不移除</li>
</ul>
<p>看到这些方法，很多初学者会觉得直接使用 <code>Stack</code> 很顺手。那么问题来了：</p>
<blockquote>
<p>🚨 为什么<strong>不推荐</strong>在现代 <code>Java</code> 编程中使用 <code>Stack</code> 类？</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">📜 <code>Stack</code> 背后的故事</h3>
<ul>
<li><code>Stack</code> 继承自 <code>Vector</code> 类。</li>
<li><code>Vector</code> 是 <code>Java</code> 在 <strong><code>Collections Framework</code>（集合框架）诞生之前</strong>的早期集合类。</li>
<li><code>Vector</code> 和 <code>Stack</code> 都是**线程安全（<code>synchronized</code>）**的，即所有方法都加了锁。</li>
<li>然而，在<strong>单线程程序</strong>或者<strong>无锁高性能场景</strong>下，这种同步机制反而会带来<strong>不必要的性能开销</strong>。</li>
</ul>
<p>🔔 <strong>总结</strong>：</p>
<ul>
<li><code>Vector</code> 和 <code>Stack</code> 并没有被标记为过时（<code>deprecated</code>），但<strong>官方强烈不推荐</strong>继续使用。</li>
<li>在需要栈功能时，<strong>推荐使用</strong> <code>Deque</code>（特别是 <code>ArrayDeque</code>）。</li>
</ul>
<hr/>
<h3 data-id="heading-2">✅ 推荐替代方案</h3>

















<table><thead><tr><th>需求</th><th>推荐使用</th></tr></thead><tbody><tr><td>普通单线程栈</td><td><code>Deque</code> / <code>ArrayDeque</code></td></tr><tr><td>多线程安全的栈</td><td><code>BlockingQueue</code> 的实现，如 <code>LinkedBlockingDeque</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-3">🔥 示例对比：使用 <code>Deque</code> 替代 <code>Stack</code></h3>
<h4 data-id="heading-4">❌ 老式写法（使用<code> Stack</code>）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.Stack;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OldStackExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Stack&lt;String&gt; stack = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stack</span>&lt;&gt;();

        stack.push(<span class="hljs-string">"A"</span>);
        stack.push(<span class="hljs-string">"B"</span>);
        stack.push(<span class="hljs-string">"C"</span>);

        System.out.println(stack.pop()); <span class="hljs-comment">// C</span>
        System.out.println(stack.peek()); <span class="hljs-comment">// B</span>
    }
}
</code></pre>
<p><strong>问题</strong>：虽然简单，但 Stack 底层是同步的，影响了单线程性能，而且是过时风格。</p>
<hr/>
<h4 data-id="heading-5">✅ 现代写法（使用<code> ArrayDeque</code>）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.ArrayDeque;
<span class="hljs-keyword">import</span> java.util.Deque;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ModernStackExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Deque&lt;String&gt; stack = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayDeque</span>&lt;&gt;();

        stack.push(<span class="hljs-string">"A"</span>);
        stack.push(<span class="hljs-string">"B"</span>);
        stack.push(<span class="hljs-string">"C"</span>);

        System.out.println(stack.pop()); <span class="hljs-comment">// C</span>
        System.out.println(stack.peek()); <span class="hljs-comment">// B</span>
    }
}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>无锁设计，<strong>更快更轻量</strong>。</li>
<li><code>ArrayDeque</code> 专门为栈和队列操作进行了优化。</li>
<li>代码同样清晰易懂。</li>
</ul>
<hr/>
<h3 data-id="heading-6">🏗️ 进阶：需要线程安全怎么办？</h3>
<p>如果确实需要在多线程环境下使用栈功能，可以使用 <code>BlockingDeque</code> 接口的实现，例如：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.LinkedBlockingDeque;
<span class="hljs-keyword">import</span> java.util.Deque;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadSafeStackExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Deque&lt;String&gt; stack = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingDeque</span>&lt;&gt;();

        stack.push(<span class="hljs-string">"A"</span>);
        stack.push(<span class="hljs-string">"B"</span>);
        stack.push(<span class="hljs-string">"C"</span>);

        System.out.println(stack.pop()); <span class="hljs-comment">// C</span>
        System.out.println(stack.peek()); <span class="hljs-comment">// B</span>
    }
}
</code></pre>
<ul>
<li><code>LinkedBlockingDeque</code> 是一个<strong>线程安全</strong>的双端队列，支持高并发访问。</li>
<li>适合生产者-消费者等并发场景。</li>
</ul>
<hr/>
<h2 data-id="heading-7">🎯 小结：使用 <code>Deque</code> 的三大理由</h2>





















<table><thead><tr><th>理由</th><th>描述</th></tr></thead><tbody><tr><td>🚀 性能更好</td><td>无锁操作，适合大部分应用场景</td></tr><tr><td>🔍 语义清晰</td><td><code>push/pop/peek</code> 方法一目了然</td></tr><tr><td>🎯 适应更多场景</td><td>既可以做栈（<code>LIFO</code>），也可以做队列（<code>FIFO</code>）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-8">👀 互动问题</h3>
<p><strong>问题1</strong>：如果你发现项目中还在用 <code>Stack</code> 类，你会怎么做？</p>
<blockquote>
<p>答案示例：评估是否可以替换成 <code>Deque</code> 或 <code>ArrayDeque</code>，如果涉及并发场景，再考虑 <code>BlockingDeque</code> 的实现。</p>
</blockquote>
<p><strong>问题2</strong>：在什么情况下你依然可能使用 <code>Vector</code> 或 <code>Stack</code>？</p>
<blockquote>
<p>答案示例：如果在维护极老旧的遗留系统，需要兼容性优先考虑，但新代码中应避免使用。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[# 9 个步骤教你如何安全地迁移数据库或字段]]></title>    <link>https://juejin.cn/post/7575015480198791220</link>    <guid>https://juejin.cn/post/7575015480198791220</guid>    <pubDate>2025-11-22T02:04:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575015480198791220" data-draft-id="7575015480198774836" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="# 9 个步骤教你如何安全地迁移数据库或字段"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2025-11-22T02:04:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            # 9 个步骤教你如何安全地迁移数据库或字段
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T02:04:07.000Z" title="Sat Nov 22 2025 02:04:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">9 个步骤教你如何安全地迁移数据库或字段</h2>
<h3 data-id="heading-1">问题描述</h3>
<p>这篇文章要讲的是一个非常具体且棘手的问题：<strong>唯一 ID 迁移</strong>。</p>
<p>现在有一个实体 <code>User</code>，由 <code>User::$id</code> 标识，看起来像这样：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span>
</span>{
  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$id</span>,
  </span>) </span>{}
}
</code></pre>
<p>访问它的数据的方式是通过一个名为 <code>UserRepository</code> 的仓储接口。这里提供一个简单的 SQLite 实现：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserRepository</span>
</span>{
  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@throws</span>  UserNotFoundException
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findById</span>(<span class="hljs-params">
    <span class="hljs-keyword">int</span> <span class="hljs-variable">$id</span>
  </span>): <span class="hljs-title">User</span></span>;
}

<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SqliteUserRepository</span>
  <span class="hljs-keyword">implements</span> <span class="hljs-title">UserRepository</span>
</span>{
  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findById</span>(<span class="hljs-params">
    <span class="hljs-keyword">int</span> <span class="hljs-variable">$id</span>
  </span>): <span class="hljs-title">User</span> </span>{
    <span class="hljs-variable">$sql</span> = <span class="hljs-string">"..."</span>;
    <span class="hljs-variable">$stmt</span> = <span class="hljs-variable language_">$this</span>-&gt;pdo-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-variable">$sql</span>);
    <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>([
      <span class="hljs-string">'id'</span> =&gt; <span class="hljs-variable">$id</span>,
    ]);
    <span class="hljs-comment">// ...</span>
  }
}
</code></pre>
<p>非常简单的设置。</p>
<p>现在假设你的团队决定，出于安全原因，用户的唯一标识符不应再是整数，而应该采用 UUID。</p>
<p>当然，不允许停机。
<a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2025-11%2Fsafely-migrate-database-field-9-steps-zh" target="_blank" title="https://catchadmin.com/post/2025-11/safely-migrate-database-field-9-steps-zh" ref="nofollow noopener noreferrer">原文链接  9 个步骤教你如何安全地迁移数据库或字段</a></p>
<h3 data-id="heading-2">解决方案</h3>
<p>为了绝对安全，将分三个阶段实施：</p>
<ol>
<li><strong>让两个 ID 共存</strong></li>
<li><strong>实战测试 UUID 实现</strong></li>
<li><strong>淘汰以前的整数 ID 实现</strong></li>
</ol>
<p>分阶段进行的主要原因是，测试不足以确保一切都按预期工作。这个字段可能被其他作业通过 API 使用，或者我现在甚至无法想象的东西。</p>
<p>所以以防万一，我希望能够在任何时刻安全地回滚到以前的实现。</p>
<p>假设这里描述的每一步都有适当的测试覆盖，理想情况下是在重构发生之前。</p>
<h3 data-id="heading-3">步骤 1 - 从原始类型解耦</h3>
<p>无论你接下来做什么，没有这个都不容易！<code>User</code> 类中的那个 <code>int</code> 原始类型就是在要求爆炸发生。</p>
<p>如果你想从整数平滑过渡到 UUID，最好的办法是首先将代码与原始类型解耦。一种方法是封装你的原始类型。我将创建一个名为 <code>UserId</code> 的类，让代码依赖它而不是 <code>int</code>：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserId</span>
</span>{
  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$id</span>,
  </span>) </span>{}

  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getId</span>(<span class="hljs-params"/>): <span class="hljs-title">int</span>
  </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;id;
  }
}

<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span>
</span>{
  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">
    <span class="hljs-keyword">public</span> UserId <span class="hljs-variable">$id</span>,
  </span>) </span>{}
}

<span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserRepository</span>
</span>{
  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@throws</span>  UserNotFoundException
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findById</span>(<span class="hljs-params">
    UserId <span class="hljs-variable">$id</span>
  </span>): <span class="hljs-title">User</span></span>;
}
</code></pre>
<p>上面的代码应该会使重构稍微容易一些。当调用 <code>getId()</code> 时，<code>UserId</code> 仍然返回 <code>int</code>，但这没关系！最重要的是，我们的代码依赖于 <code>UserId</code>——一个我们控制的类型——而不是原始整数——我们根本无法控制它。</p>
<p>现在只需覆盖所有现有代码以使用 <code>UserId</code> 而不是 <code>int $id</code>。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SqliteUserRepository</span>
  <span class="hljs-keyword">implements</span> <span class="hljs-title">UserRepository</span>
</span>{
  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findById</span>(<span class="hljs-params">
    UserId <span class="hljs-variable">$id</span>
  </span>): <span class="hljs-title">User</span> </span>{
    <span class="hljs-variable">$sql</span> = <span class="hljs-string">"..."</span>;
    <span class="hljs-variable">$stmt</span> = <span class="hljs-variable language_">$this</span>-&gt;pdo-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-variable">$sql</span>);
    <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>([
      <span class="hljs-string">'id'</span> =&gt; <span class="hljs-variable">$id</span>-&gt;<span class="hljs-title function_ invoke__">getId</span>(),
    ]);
    <span class="hljs-comment">// ...</span>
  }
}
</code></pre>
<p>到这里，什么都没有改变。感觉可以安全地合并和部署，不应该有任何东西会崩溃。顺便说一句，测试帮助很大。一定要进行测试！</p>
<h3 data-id="heading-4">步骤 2 - 让两个字段共存</h3>
<p>现在确保可以向 <code>users</code> 表添加一个新字段。这样就可以了：</p>
<pre><code class="hljs language-sql" lang="sql">sqlite<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> `users` <span class="hljs-keyword">ADD</span> `uuid` <span class="hljs-type">VARCHAR</span>;
</code></pre>
<p>现在它既不能是 <code>NOT NULL</code> 也不能是 <code>UNIQUE</code>，因为每个现有记录的值都将是 <code>NULL</code>。</p>
<p>回到 <code>UserId</code> 类，确保它现在的实现中有 <code>uuid</code>：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserId</span>
</span>{
  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$id</span>,
    <span class="hljs-keyword">public</span> ?UuidInterface <span class="hljs-variable">$uuid</span>,
  </span>) </span>{}

  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getId</span>(<span class="hljs-params"/>): <span class="hljs-title">int</span>
  </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;id;
  }

  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUuid</span>(<span class="hljs-params"/>): ?<span class="hljs-title">UUidInterface</span>
  </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;uuid;
  }
}
</code></pre>
<p>它仍然是可空的，因为，嗯，它在数据库中是 null！</p>
<p>现在需要确保发生两件事：</p>
<ol>
<li>每个现有记录都将有一个非空的 uuid；并且</li>
<li>每个新记录都将已经带有填充的 uuid</li>
</ol>
<p>当看到在任何给定时刻，<code>users.uuid</code> 永远不会是 <code>NULL</code> 时，则认为两者在数据库层都很好地共存。</p>
<h3 data-id="heading-5">步骤 3 - 确保每个新记录都有 UUID</h3>
<p>在你的系统中，某个地方存储着 Users。需要确保在它发生的任何地方，UUID 字段都将被填充。</p>
<p>所以给定这个旧的实现：</p>
<pre><code class="hljs language-php" lang="php">
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">insert</span>(<span class="hljs-params">
  User <span class="hljs-variable">$user</span>
</span>): <span class="hljs-title">void</span> </span>{
  <span class="hljs-comment">// insert into ...</span>
}

</code></pre>
<p>只需用 UUID 生成来修补它，应该就没问题了：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">insert</span>(<span class="hljs-params">
  User <span class="hljs-variable">$user</span>
</span>): <span class="hljs-title">void</span> </span>{
  <span class="hljs-variable">$id</span> = <span class="hljs-variable">$user</span>-&gt;id;

  <span class="hljs-keyword">if</span> (<span class="hljs-variable">$id</span>-&gt;uuid === <span class="hljs-literal">null</span>) {
    <span class="hljs-variable">$id</span>-&gt;uuid = <span class="hljs-title class_">Uuid</span>::<span class="hljs-title function_ invoke__">uuid4</span>();
  }

  <span class="hljs-comment">// insert into ...</span>
}

</code></pre>
<p>个人强烈建议你用测试覆盖这个 IF 语句，以防你遗漏了导入或类似的东西。除此之外，不应该引入其他回归。</p>
<p>每个新记录现在应该都有正确填充的 <code>users.uuid</code>。</p>
<h3 data-id="heading-6">步骤 4 - 为旧记录回填 UUID 字段</h3>
<p>这可以用脚本完成。如果你使用迁移框架，可能也会非常简单。</p>
<p>现在只需要获取所有 uuid 为 null 的用户并填充它们。类似这样就可以完成：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$users</span> = <span class="hljs-title function_ invoke__">getUsersWithEmptyUuid</span>();
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$users</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$user</span>) {
  <span class="hljs-variable">$user</span>-&gt;id-&gt;uuid = <span class="hljs-title class_">Uuid</span>::<span class="hljs-title function_ invoke__">uuid4</span>();
  <span class="hljs-title function_ invoke__">updateUser</span>(<span class="hljs-variable">$user</span>);
}
</code></pre>
<p>上面的代码并不能代表每个代码库，但我想你明白了。</p>
<h3 data-id="heading-7">步骤 5 - 确保一切正常运行</h3>
<p>不要急于切换实现。一定要确保系统正常运行，并且在再运行系统几个小时后，<code>users.uuid</code> 不会是 <code>NULL</code>。</p>
<p>只有当你 100% 确定 <code>users.uuid</code> 在此表中永远不会是 <code>NULL</code> 时，才进入下一步。</p>
<h3 data-id="heading-8">步骤 6 - 更新 UserRepository 以使用 UUID</h3>
<p>看来现在已经可以切换到新的 UUID 实现了。但不建议盲目地切换到新实现。</p>
<p>谨慎总比后悔好，对吧？首先确保用功能开关保护代码。用以下内容更新 <code>SqliteUserRepository</code>：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SqliteUserRepository</span>
    <span class="hljs-keyword">implements</span> <span class="hljs-title">UserRepository</span>
</span>{
  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findById</span>(<span class="hljs-params">UserId <span class="hljs-variable">$id</span></span>): <span class="hljs-title">User</span>
  </span>{
    <span class="hljs-keyword">if</span> (
      <span class="hljs-title function_ invoke__">isFeatureFlagActive</span>(<span class="hljs-string">'enableNewUsersUuidImplementation'</span>)
    ) {
      <span class="hljs-comment">// 新实现，使用 Uuid</span>
      <span class="hljs-variable">$sql</span> = <span class="hljs-string">"..."</span>;
      <span class="hljs-variable">$stmt</span> = <span class="hljs-variable language_">$this</span>-&gt;pdo-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-variable">$sql</span>);
      <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>([
        <span class="hljs-string">'uuid'</span> =&gt; (<span class="hljs-keyword">string</span>) <span class="hljs-variable">$id</span>-&gt;<span class="hljs-title function_ invoke__">getUuid</span>(),
      ]);
      <span class="hljs-comment">// ...</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 旧实现，使用整数 $id</span>
      <span class="hljs-variable">$sql</span> = <span class="hljs-string">"..."</span>;
      <span class="hljs-variable">$stmt</span> = <span class="hljs-variable language_">$this</span>-&gt;pdo-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-variable">$sql</span>);
      <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>([
        <span class="hljs-string">'id'</span> =&gt; <span class="hljs-variable">$id</span>-&gt;<span class="hljs-title function_ invoke__">getId</span>(),
      ]);
      <span class="hljs-comment">// ...</span>
    }
  }
}
</code></pre>
<p>长话短说：如果请求的功能已启用，<code>isFeatureFlagActive()</code> 返回 <code>TRUE</code>，否则返回 <code>FALSE</code>。它可以基于配置、数据库条目或环境变量。这在这里不相关。</p>
<p>重要的是，你可以更改 <code>isFeatureFlagActive()</code> 的返回值，而无需重新部署代码。这样你就可以安全地回滚到以前的实现，没有太多摩擦。</p>
<h3 data-id="heading-9">步骤 7 - 部署、启用和监控</h3>
<p>首先部署它，确保 <code>isFeatureFlagActive()</code> 始终返回 <code>FALSE</code>，这样就会选择原始实现。</p>
<p>然后将 <code>isFeatureFlagActive()</code> 切换为返回 <code>TRUE</code>，这样就会选择新实现——同样，这可以通过数据库记录、环境变量、SaaS 工具或你喜欢的任何东西来完成。</p>
<p>哦不！出问题了！网站突然变得超级慢！！</p>
<p>关闭你的功能开关，这样 <code>isFeatureFlagActive()</code> 将再次返回 <code>FALSE</code>。</p>
<p>...</p>
<p>事情似乎又恢复正常了。回到你的 IDE，试着弄清楚发生了什么。也许做一些点击测试和调试来理解是什么导致它如此缓慢。</p>
<p>最终你会意识到你没有索引 <code>users.uuid</code> 列，所以由于你的巨大表，查询它变得超级慢。尽快修复它！</p>
<h3 data-id="heading-10">步骤 8 - 使 UUID 唯一并建立索引</h3>
<p>由于使用的是 SQLite 实现，这里是应该完成此操作的代码片段：</p>
<pre><code class="hljs language-sql" lang="sql">sqlite<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX `users_uuid_uq` <span class="hljs-keyword">ON</span> `users`(`uuid`);
</code></pre>
<p>理想情况下，你还应该使 <code>users.uuid</code> 为 <code>NOT NULL</code>，但我跳过了它，因为它需要更多的 SQLite 步骤，这些步骤与我想在这里演示的内容无关。</p>
<p>好了，现在应该没问题了。将你的更改传播到生产环境，看看功能开关的代码现在表现如何。</p>
<p>一切都好，对吧？是时候清理了。</p>
<h3 data-id="heading-11">步骤 9 - 清理你的数字 ID</h3>
<p>既然东西已经部署并经过实战测试，是时候清理以前的数字 id 字段了。</p>
<p>无论你是删除实际字段还是只是不在代码中使用它，这都是项目决策——什么不是呢？</p>
<p>但最终你的 <code>SqliteUserRepository</code> 会看起来像这样：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SqliteUserRepository</span>
    <span class="hljs-keyword">implements</span> <span class="hljs-title">UserRepository</span>
</span>{
  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findById</span>(<span class="hljs-params">
    UserId <span class="hljs-variable">$id</span>
  </span>): <span class="hljs-title">User</span> </span>{
    <span class="hljs-variable">$sql</span> = <span class="hljs-string">"..."</span>;
    <span class="hljs-variable">$stmt</span> = <span class="hljs-variable language_">$this</span>-&gt;pdo-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-variable">$sql</span>);
    <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>([
      <span class="hljs-string">'uuid'</span> =&gt; (<span class="hljs-keyword">string</span>) <span class="hljs-variable">$id</span>-&gt;<span class="hljs-title function_ invoke__">getUuid</span>(),
    ]);
    <span class="hljs-comment">// ...</span>
  }
}
</code></pre>
<p>插入记录的函数现在也值得一些关爱。让我们删除以前的 IF 语句：</p>
<pre><code class="hljs language-php" lang="php">...

<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">insert</span>(<span class="hljs-params">
  User <span class="hljs-variable">$user</span>
</span>): <span class="hljs-title">void</span> </span>{
  <span class="hljs-variable">$user</span>-&gt;id-&gt;uuid = <span class="hljs-title class_">Uuid</span>::<span class="hljs-title function_ invoke__">uuid4</span>();

  <span class="hljs-comment">// insert logic</span>
}

...
</code></pre>
<p>如果你决定也从数据库中删除数字 id，必须确保 <code>UserId</code> 代码也被清理，并删除 <code>$id</code> 属性：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserId</span>
</span>{
  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">
    <span class="hljs-keyword">public</span> UuidInterface <span class="hljs-variable">$uuid</span>,
  </span>) </span>{}

  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUuid</span>(<span class="hljs-params">
  </span>): <span class="hljs-title">UuidInterface</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;uuid;
  }
}
</code></pre>
<p>因为现在 UUID 完全没有理由为空，也从 <code>$uuid</code> 属性中删除了问号。现在你的系统是安全的！</p>
<h3 data-id="heading-12">总结</h3>
<p>当然，事情可能因项目而异，但归根结底，你将执行所描述技术的某种变体。</p>
<p>这适用于几乎任何依赖数据的实现更改。只需记住三个阶段：</p>
<ol>
<li><strong>让两个实现共存</strong></li>
<li><strong>实战测试新实现</strong></li>
<li><strong>淘汰以前的实现</strong></li>
</ol>
<p>不要害羞或羞于采取多个步骤。即使你知道之后必须删除代码！实际上回滚部署或修复实时数据库比在这里描述的任何步骤都要痛苦得多。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[enet源码解析 (2) 对等节点 (ENetPeer)]]></title>    <link>https://juejin.cn/post/7575050949959598116</link>    <guid>https://juejin.cn/post/7575050949959598116</guid>    <pubDate>2025-11-22T02:26:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575050949959598116" data-draft-id="7575050949959565348" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="enet源码解析 (2) 对等节点 (ENetPeer)"/> <meta itemprop="keywords" content="网络协议,C++"/> <meta itemprop="datePublished" content="2025-11-22T02:26:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="重启的码农"/> <meta itemprop="url" content="https://juejin.cn/user/3590319025687584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            enet源码解析 (2) 对等节点 (ENetPeer)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3590319025687584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    重启的码农
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T02:26:09.000Z" title="Sat Nov 22 2025 02:26:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在上一章 主机管理 (ENetHost)中，我们建立了自己的“邮局”（Host）。但是，如果只有邮局而没有通信的对象，那这就是一个孤独的邮局。</p>
<p>本章我们将介绍 <strong>对等节点 (ENetPeer)</strong>。如果不把 <code>ENetHost</code> 比作邮局，而是比作一部手机，那么 <code>ENetPeer</code> 就是你正在进行的<strong>通话</strong>。</p>
<hr/>
<h2 data-id="heading-0">1. 什么是 ENetPeer？</h2>
<p><code>ENetPeer</code> 代表了与<strong>特定远程计算机</strong>的一个活动连接。</p>
<p>在一个多人游戏中：</p>
<ul>
<li><strong>对于客户端</strong>：你通常只有 1 个 <code>ENetPeer</code>，它代表了你连接的游戏服务器。</li>
<li><strong>对于服务器</strong>：你会有很多个 <code>ENetPeer</code>，每一个对象都代表一个在线的玩家。</li>
</ul>
<p>它的核心职责是充当<strong>连接的管家</strong>：</p>
<ol>
<li><strong>状态维护</strong>：记录我们是“正在连接”、“已连接”还是“正在断开”。</li>
<li><strong>健康监控</strong>：计算往返时间 (RTT)，也就是数据一来一回需要多久。</li>
<li><strong>流量控制</strong>：如果网络太卡，它会自动降低发送速度，防止堵塞。</li>
</ol>
<hr/>
<h2 data-id="heading-1">2. 实战：建立连接</h2>
<p>要获得一个 <code>ENetPeer</code> 对象，最常见的方法是<strong>主动发起连接</strong>（作为客户端）。</p>
<h3 data-id="heading-2">2.1 发起连接</h3>
<p>假设你已经创建了一个客户端 Host（如第一章所述），现在我们要连接到服务器。</p>
<pre><code class="hljs language-c" lang="c">ENetAddress address;
ENetEvent event;
ENetPeer *peer;

<span class="hljs-comment">// 设置服务器地址 (本地回环地址)</span>
enet_address_set_host(&amp;address, <span class="hljs-string">"127.0.0.1"</span>);
address.port = <span class="hljs-number">1234</span>;

<span class="hljs-comment">// 发起连接：2个通道，0表示不限速</span>
peer = enet_host_connect(client, &amp;address, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);

<span class="hljs-keyword">if</span> (peer == <span class="hljs-literal">NULL</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"连接请求创建失败！\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>代码解读</strong>：
调用 <code>enet_host_connect</code> 并不会立即联网，它只是由 ENet 创建了一个“连接意向”。真正的握手数据包会在你调用 <code>enet_host_service</code> 时发出。</p>
<h3 data-id="heading-3">2.2 确认连接成功</h3>
<p>连接不是瞬间完成的。我们需要在事件循环中等待服务器的“同意”。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 等待 5 秒钟看是否能连接成功</span>
<span class="hljs-keyword">if</span> (enet_host_service(client, &amp;event, <span class="hljs-number">5000</span>) &gt; <span class="hljs-number">0</span> &amp;&amp;
    event.type == ENET_EVENT_TYPE_CONNECT) {
    
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"连接成功！服务器响应了。\n"</span>);
    <span class="hljs-comment">// 此时，peer 对象已经完全准备好可以使用了</span>
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 5秒内没有收到回复，或者连接失败</span>
    enet_peer_reset(peer);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"连接失败。\n"</span>);
}
</code></pre>
<p><strong>注意</strong>：如果你在这里收到了 <code>ENetPeer</code>，说明底层的“三次握手”已经完成了。</p>
<hr/>
<h2 data-id="heading-4">3. 实战：断开连接</h2>
<p>天下没有不散的筵席，当玩家退出游戏时，我们需要优雅地断开连接。</p>
<h3 data-id="heading-5">3.1 温柔的断开 (Disconnect)</h3>
<p>这是最推荐的方式。它会发送一个“再见”消息，并等待对方确认“好的，再见”。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 发送断开请求，附带一个数字 0 作为数据</span>
enet_peer_disconnect(peer, <span class="hljs-number">0</span>);

<span class="hljs-comment">// 需要继续运行服务循环，让断开消息发出去</span>
<span class="hljs-keyword">while</span> (enet_host_service(client, &amp;event, <span class="hljs-number">3000</span>) &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">switch</span> (event.type) {
    <span class="hljs-keyword">case</span> ENET_EVENT_TYPE_RECEIVE:
        <span class="hljs-comment">// 还有遗留数据就先销毁</span>
        enet_packet_destroy(event.packet);
        <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> ENET_EVENT_TYPE_DISCONNECT:
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"断开连接成功。\n"</span>);
        <span class="hljs-keyword">return</span>;
    }
}
</code></pre>
<h3 data-id="heading-6">3.2 强制断开 (Disconnect Now)</h3>
<p>如果你不想等待，或者对方已经死机了，可以使用强制断开。这就像直接拔网线。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 立即重置 Peer，不通知对方</span>
enet_peer_reset(peer);
</code></pre>
<hr/>
<h2 data-id="heading-7">4. 内部原理解析</h2>
<p>ENetPeer 是如何工作的？为什么我们在第一章说它是“预分配”的？</p>
<h3 data-id="heading-8">4.1 节点的生命周期</h3>
<p>当我们在服务器端创建一个 <code>ENetHost</code> 时，我们指定了 <code>peerCount</code>（比如 32）。ENet 会在内存中创建一个包含 32 个 <code>ENetPeer</code> 结构体的数组。</p>
<p>当一个新玩家连接时，ENet 不会<code>malloc</code>（分配）新内存，而是简单地在这个数组中找一个<strong>空闲</strong>的 Peer，把它标记为“正在使用”。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client as 客户端
    participant ServerHost as 服务器 Host
    participant PeerPool as Peer 数组(内存)
    participant PeerObj as 激活的 Peer

    Client-&gt;&gt;ServerHost: 发送连接请求 (Connect Packet)
    ServerHost-&gt;&gt;PeerPool: 寻找空闲的 Peer 位置
    PeerPool--&gt;&gt;ServerHost: 返回索引 5 是空的
    ServerHost-&gt;&gt;PeerObj: 初始化索引 5 (设置 IP, 端口, 状态)
    ServerHost-&gt;&gt;Client: 发送确认 (Verify Connect)
    Note over PeerObj: 状态变为 CONNECTED
</code></pre>
<h3 data-id="heading-9">4.2 深入代码 (peer.c)</h3>
<p>让我们看看 <code>enet_peer_reset</code> 函数，这个函数不仅用于断开连接，也用于初始化一个新连接的槽位。</p>
<p><strong>1. 清理旧状态</strong>
无论这个 Peer 之前发生了什么，重置意味着清空所有统计数据。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// file: peer.c (简化版)</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">enet_peer_reset</span> <span class="hljs-params">(ENetPeer * peer)</span> {
    <span class="hljs-comment">// 通知 Host 减少连接计数</span>
    enet_peer_on_disconnect (peer);

    <span class="hljs-comment">// 重置 IP 和端口信息</span>
    peer -&gt; outgoingPeerID = ENET_PROTOCOL_MAXIMUM_PEER_ID;
    peer -&gt; connectID = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 状态设为断开</span>
    peer -&gt; state = ENET_PEER_STATE_DISCONNECTED;
</code></pre>
<p><strong>2. 重置网络参数 (RTT)</strong>
ENet 非常智能，它会为每个连接动态计算 RTT（网络延迟）。重置时，这些值回归默认。</p>
<pre><code class="hljs language-c" lang="c">    <span class="hljs-comment">// file: peer.c</span>
    <span class="hljs-comment">// 默认 RTT 为 500ms</span>
    peer -&gt; roundTripTime = ENET_PEER_DEFAULT_ROUND_TRIP_TIME; 
    peer -&gt; roundTripTimeVariance = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 重置丢包统计</span>
    peer -&gt; packetLoss = <span class="hljs-number">0</span>;
</code></pre>
<p><strong>3. 清空队列</strong>
最重要的一步：如果还有没发出去的包，或者没处理的包，全部丢弃，防止内存泄漏。</p>
<pre><code class="hljs language-c" lang="c">    <span class="hljs-comment">// file: peer.c</span>
    <span class="hljs-comment">// 清理所有待发送和待接收队列</span>
    enet_peer_reset_queues (peer);
}
</code></pre>
<h3 data-id="heading-10">4.3 智能流控 (Throttling)</h3>
<p><code>ENetPeer</code> 最强大的功能之一是<strong>自适应流控</strong>。就像水坝一样，如果下游（网络）堵塞了，上游就要关小闸门。</p>
<p>在 <code>enet_peer_throttle</code> 函数中：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// file: peer.c (逻辑示意)</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">enet_peer_throttle</span> <span class="hljs-params">(ENetPeer * peer, enet_uint32 rtt)</span> {
    <span class="hljs-comment">// 如果当前 RTT (延迟) 比平均值还低，说明网络很顺畅</span>
    <span class="hljs-keyword">if</span> (rtt &lt;= peer -&gt; lastRoundTripTime) {
        <span class="hljs-comment">// 增加发送概率 (packetThrottle)</span>
        peer -&gt; packetThrottle += peer -&gt; packetThrottleAcceleration;
    }
    <span class="hljs-comment">// 如果延迟很高，说明网络堵了</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rtt &gt; peer -&gt; lastRoundTripTime + <span class="hljs-number">2</span> * Variance) {
        <span class="hljs-comment">// 降低发送概率，主动丢弃一部分不可靠包</span>
        peer -&gt; packetThrottle -= peer -&gt; packetThrottleDeceleration;
    }
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<ul>
<li><strong>解释</strong>：这保证了当网络变差时，重要的“可靠包”还能挤过去，而不太重要的“不可靠包”会被主动丢弃，防止连接彻底断开。</li>
</ul>
<hr/>
<h2 data-id="heading-11">5. 常见问题</h2>
<p><strong>Q: ENetPeer 需要我手动释放内存吗？</strong>
A: <strong>不需要</strong>。如果你是客户端，销毁 <code>ENetHost</code> 时会自动清理。如果你是服务器，<code>ENetPeer</code> 只是大数组里的一格，调用 <code>enet_peer_reset</code> 或断开连接后，它只是变回“空闲状态”，内存依然归 <code>ENetHost</code> 管理。</p>
<p><strong>Q: 我可以把 packet 发送给 NULL peer 吗？</strong>
A: 不行，程序会崩溃。在发送前永远要确保 <code>peer</code> 不为空且状态是 <code>ENET_PEER_STATE_CONNECTED</code>。</p>
<hr/>
<h2 data-id="heading-12">6. 总结</h2>
<p>在这一章，我们学习了：</p>
<ul>
<li><strong>ENetPeer</strong> 是网络连接的“替身”，管理着与特定计算机的通信状态。</li>
<li>如何使用 <code>enet_host_connect</code> 发起连接。</li>
<li>如何使用 <code>enet_peer_disconnect</code> 断开连接。</li>
<li>内部原理：Peer 是从 Host 的预分配数组中“借”出来的，并自带了智能的流控机制。</li>
</ul>
<p>现在连接已经建立，可以互相通话了。但是，我们具体要发送什么呢？字符串？结构体？二进制流？</p>
<p>下一章，我们将学习如何打包你的数据：数据包封装 (ENetPacket)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring表达式详解]]></title>    <link>https://juejin.cn/post/7575047994681212979</link>    <guid>https://juejin.cn/post/7575047994681212979</guid>    <pubDate>2025-11-22T02:33:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575047994681212979" data-draft-id="7575031395861774382" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring表达式详解"/> <meta itemprop="keywords" content="Spring"/> <meta itemprop="datePublished" content="2025-11-22T02:33:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring表达式详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T02:33:48.000Z" title="Sat Nov 22 2025 02:33:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring表达式详解：SpEL从入门到实战</h2>
<h3 data-id="heading-1">前言</h3>
<p>SpEL（Spring Expression Language，Spring表达式语言）是Spring框架提供的强大表达式语言，支持在运行时查询和操作对象图。SpEL广泛应用于Spring的各个模块中，如Spring Security、Spring Data、Spring Cache等。本文将深入讲解SpEL的核心概念、语法特性和实战应用。</p>
<h3 data-id="heading-2">一、SpEL概述</h3>
<h4 data-id="heading-3">1.1 什么是SpEL</h4>
<p>SpEL是一种功能强大的表达式语言，它支持：</p>
<ul>
<li>字面量表达式</li>
<li>属性访问</li>
<li>方法调用</li>
<li>集合操作</li>
<li>逻辑运算</li>
<li>正则表达式</li>
<li>自定义函数</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin">SpEL在Spring中的应用
┌─────────────────────────────────────────┐
│  Spring框架                              │
│  ┌───────────────────────────────────┐ │
│  │ <span class="hljs-meta">@Value(<span class="hljs-string">"<span class="hljs-subst">${...}</span>"</span>)</span>                  │ │
│  │ <span class="hljs-meta">@Cacheable(key = <span class="hljs-string">"#id"</span>)</span>           │ │
│  │ <span class="hljs-meta">@PreAuthorize(<span class="hljs-string">"hasRole('ADMIN')"</span>)</span>│ │
│  │ <span class="hljs-meta">@EventListener(condition = <span class="hljs-string">"..."</span>)</span>│ │
│  │ XML配置：&lt;property value=<span class="hljs-string">"#{...}"</span>/&gt;│ │
│  └───────────────────────────────────┘ │
│              ↓                           │
│  ┌───────────────────────────────────┐ │
│  │     SpEL解析引擎                  │ │
│  │  - 词法分析                       │ │
│  │  - 语法分析                       │ │
│  │  - 表达式求值                     │ │
│  └───────────────────────────────────┘ │
└─────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-4">1.2 SpEL的优势</h4>
<pre><code class="hljs">SpEL vs 其他表达式语言
┌──────────────┬─────────────┬──────────────┐
│  特性         │  SpEL       │  EL/OGNL     │
├──────────────┼─────────────┼──────────────┤
│  Spring集成  │  原生支持    │  需要适配     │
│  类型安全     │  支持        │  有限支持     │
│  方法调用     │  全面支持    │  有限支持     │
│  集合操作     │  强大        │  基础         │
│  自定义函数   │  支持        │  有限         │
│  安全性       │  可控        │  风险较高     │
└──────────────┴─────────────┴──────────────┘
</code></pre>
<h3 data-id="heading-5">二、SpEL基础语法</h3>
<h4 data-id="heading-6">2.1 字面量表达式</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 字面量表达式示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LiteralExpressionsDemo</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();

        <span class="hljs-comment">// 字符串字面量</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp1</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"'Hello World'"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> (String) exp1.getValue();
        System.out.println(<span class="hljs-string">"字符串: "</span> + str);  <span class="hljs-comment">// Hello World</span>

        <span class="hljs-comment">// 数字字面量</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp2</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"100"</span>);
        <span class="hljs-type">Integer</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> (Integer) exp2.getValue();
        System.out.println(<span class="hljs-string">"数字: "</span> + num);  <span class="hljs-comment">// 100</span>

        <span class="hljs-comment">// 浮点数字面量</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp3</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"3.14159"</span>);
        <span class="hljs-type">Double</span> <span class="hljs-variable">pi</span> <span class="hljs-operator">=</span> (Double) exp3.getValue();
        System.out.println(<span class="hljs-string">"浮点数: "</span> + pi);  <span class="hljs-comment">// 3.14159</span>

        <span class="hljs-comment">// 布尔字面量</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp4</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"true"</span>);
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">bool</span> <span class="hljs-operator">=</span> (Boolean) exp4.getValue();
        System.out.println(<span class="hljs-string">"布尔值: "</span> + bool);  <span class="hljs-comment">// true</span>

        <span class="hljs-comment">// null字面量</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp5</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"null"</span>);
        <span class="hljs-type">Object</span> <span class="hljs-variable">nullVal</span> <span class="hljs-operator">=</span> exp5.getValue();
        System.out.println(<span class="hljs-string">"null值: "</span> + nullVal);  <span class="hljs-comment">// null</span>
    }
}
</code></pre>
<h4 data-id="heading-7">2.2 属性访问</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 属性访问示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PropertyAccessDemo</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();

        <span class="hljs-comment">// 创建上下文对象</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"张三"</span>, <span class="hljs-number">25</span>, <span class="hljs-string">"zhangsan@example.com"</span>);

        <span class="hljs-comment">// 访问属性</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp1</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"name"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> exp1.getValue(user, String.class);
        System.out.println(<span class="hljs-string">"姓名: "</span> + name);  <span class="hljs-comment">// 张三</span>

        <span class="hljs-comment">// 访问嵌套属性</span>
        user.setAddress(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Address</span>(<span class="hljs-string">"北京市"</span>, <span class="hljs-string">"朝阳区"</span>));
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp2</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"address.city"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">city</span> <span class="hljs-operator">=</span> exp2.getValue(user, String.class);
        System.out.println(<span class="hljs-string">"城市: "</span> + city);  <span class="hljs-comment">// 北京市</span>

        <span class="hljs-comment">// 安全导航（避免空指针）</span>
        user.setAddress(<span class="hljs-literal">null</span>);
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp3</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"address?.city"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">safeCity</span> <span class="hljs-operator">=</span> exp3.getValue(user, String.class);
        System.out.println(<span class="hljs-string">"安全访问: "</span> + safeCity);  <span class="hljs-comment">// null</span>

        <span class="hljs-comment">// 数组/列表访问</span>
        user.setHobbies(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{<span class="hljs-string">"篮球"</span>, <span class="hljs-string">"游泳"</span>, <span class="hljs-string">"阅读"</span>});
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp4</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"hobbies[0]"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">hobby</span> <span class="hljs-operator">=</span> exp4.getValue(user, String.class);
        System.out.println(<span class="hljs-string">"第一个爱好: "</span> + hobby);  <span class="hljs-comment">// 篮球</span>

        <span class="hljs-comment">// Map访问</span>
        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        map.put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp5</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"['key1']"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> exp5.getValue(map, String.class);
        System.out.println(<span class="hljs-string">"Map值: "</span> + value);  <span class="hljs-comment">// value1</span>
    }
}

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> Integer age;
    <span class="hljs-keyword">private</span> String email;
    <span class="hljs-keyword">private</span> Address address;
    <span class="hljs-keyword">private</span> String[] hobbies;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">(String name, Integer age, String email)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.age = age;
        <span class="hljs-built_in">this</span>.email = email;
    }
}

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Address</span> {
    <span class="hljs-keyword">private</span> String city;
    <span class="hljs-keyword">private</span> String district;
}
</code></pre>
<h4 data-id="heading-8">2.3 方法调用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 方法调用示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodCallDemo</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();

        <span class="hljs-comment">// 字符串方法调用</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp1</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"'Hello'.concat(' World')"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">result1</span> <span class="hljs-operator">=</span> exp1.getValue(String.class);
        System.out.println(<span class="hljs-string">"字符串拼接: "</span> + result1);  <span class="hljs-comment">// Hello World</span>

        <span class="hljs-comment">// 对象方法调用</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"zhangsan"</span>, <span class="hljs-number">25</span>, <span class="hljs-string">"zhangsan@example.com"</span>);
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp2</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"name.toUpperCase()"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">result2</span> <span class="hljs-operator">=</span> exp2.getValue(user, String.class);
        System.out.println(<span class="hljs-string">"大写: "</span> + result2);  <span class="hljs-comment">// ZHANGSAN</span>

        <span class="hljs-comment">// 链式调用</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp3</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"email.substring(0, 8).toUpperCase()"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">result3</span> <span class="hljs-operator">=</span> exp3.getValue(user, String.class);
        System.out.println(<span class="hljs-string">"链式调用: "</span> + result3);  <span class="hljs-comment">// ZHANGSAN</span>

        <span class="hljs-comment">// 静态方法调用</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp4</span> <span class="hljs-operator">=</span> parser.parseExpression(
            <span class="hljs-string">"T(java.lang.Math).random() * 100"</span>);
        <span class="hljs-type">Double</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> exp4.getValue(Double.class);
        System.out.println(<span class="hljs-string">"随机数: "</span> + random);

        <span class="hljs-comment">// 调用自定义方法</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp5</span> <span class="hljs-operator">=</span> parser.parseExpression(
            <span class="hljs-string">"T(com.example.StringUtils).isEmpty(name)"</span>);
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">isEmpty</span> <span class="hljs-operator">=</span> exp5.getValue(user, Boolean.class);
        System.out.println(<span class="hljs-string">"是否为空: "</span> + isEmpty);
    }
}

<span class="hljs-comment">/**
 * 工具类
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">StringUtils</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEmpty</span><span class="hljs-params">(String str)</span> {
        <span class="hljs-keyword">return</span> str == <span class="hljs-literal">null</span> || str.isEmpty();
    }
}
</code></pre>
<h4 data-id="heading-9">2.4 运算符</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 运算符示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperatorDemo</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();

        <span class="hljs-comment">// 算术运算符</span>
        System.out.println(<span class="hljs-string">"加法: "</span> + parser.parseExpression(<span class="hljs-string">"1 + 2"</span>).getValue());  <span class="hljs-comment">// 3</span>
        System.out.println(<span class="hljs-string">"减法: "</span> + parser.parseExpression(<span class="hljs-string">"5 - 2"</span>).getValue());  <span class="hljs-comment">// 3</span>
        System.out.println(<span class="hljs-string">"乘法: "</span> + parser.parseExpression(<span class="hljs-string">"3 * 4"</span>).getValue());  <span class="hljs-comment">// 12</span>
        System.out.println(<span class="hljs-string">"除法: "</span> + parser.parseExpression(<span class="hljs-string">"10 / 2"</span>).getValue()); <span class="hljs-comment">// 5</span>
        System.out.println(<span class="hljs-string">"取模: "</span> + parser.parseExpression(<span class="hljs-string">"10 % 3"</span>).getValue()); <span class="hljs-comment">// 1</span>

        <span class="hljs-comment">// 关系运算符</span>
        System.out.println(<span class="hljs-string">"等于: "</span> + parser.parseExpression(<span class="hljs-string">"5 == 5"</span>).getValue());   <span class="hljs-comment">// true</span>
        System.out.println(<span class="hljs-string">"不等于: "</span> + parser.parseExpression(<span class="hljs-string">"5 != 3"</span>).getValue()); <span class="hljs-comment">// true</span>
        System.out.println(<span class="hljs-string">"大于: "</span> + parser.parseExpression(<span class="hljs-string">"5 &gt; 3"</span>).getValue());    <span class="hljs-comment">// true</span>
        System.out.println(<span class="hljs-string">"小于: "</span> + parser.parseExpression(<span class="hljs-string">"3 &lt; 5"</span>).getValue());    <span class="hljs-comment">// true</span>
        System.out.println(<span class="hljs-string">"大于等于: "</span> + parser.parseExpression(<span class="hljs-string">"5 &gt;= 5"</span>).getValue());  <span class="hljs-comment">// true</span>

        <span class="hljs-comment">// 逻辑运算符</span>
        System.out.println(<span class="hljs-string">"与: "</span> + parser.parseExpression(<span class="hljs-string">"true and false"</span>).getValue()); <span class="hljs-comment">// false</span>
        System.out.println(<span class="hljs-string">"或: "</span> + parser.parseExpression(<span class="hljs-string">"true or false"</span>).getValue());  <span class="hljs-comment">// true</span>
        System.out.println(<span class="hljs-string">"非: "</span> + parser.parseExpression(<span class="hljs-string">"!true"</span>).getValue());         <span class="hljs-comment">// false</span>

        <span class="hljs-comment">// 三元运算符</span>
        System.out.println(<span class="hljs-string">"三元: "</span> + parser.parseExpression(<span class="hljs-string">"5 &gt; 3 ? 'yes' : 'no'"</span>).getValue());  <span class="hljs-comment">// yes</span>

        <span class="hljs-comment">// 字符串连接</span>
        System.out.println(<span class="hljs-string">"拼接: "</span> + parser.parseExpression(<span class="hljs-string">"'Hello' + ' ' + 'World'"</span>).getValue());

        <span class="hljs-comment">// Elvis运算符（简化三元）</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        user.setName(<span class="hljs-literal">null</span>);
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"name?:'匿名用户'"</span>);
        System.out.println(<span class="hljs-string">"Elvis: "</span> + exp.getValue(user, String.class));  <span class="hljs-comment">// 匿名用户</span>
    }
}
</code></pre>
<h4 data-id="heading-10">2.5 集合操作</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 集合操作示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CollectionDemo</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();

        <span class="hljs-comment">// 创建列表</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp1</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"{1,2,3,4,5}"</span>);
        List&lt;Integer&gt; list = (List&lt;Integer&gt;) exp1.getValue();
        System.out.println(<span class="hljs-string">"列表: "</span> + list);  <span class="hljs-comment">// [1, 2, 3, 4, 5]</span>

        <span class="hljs-comment">// 创建Map</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp2</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"{name:'张三',age:25}"</span>);
        Map&lt;String, Object&gt; map = (Map&lt;String, Object&gt;) exp2.getValue();
        System.out.println(<span class="hljs-string">"Map: "</span> + map);  <span class="hljs-comment">// {name=张三, age=25}</span>

        <span class="hljs-comment">// 集合选择（筛选）</span>
        List&lt;Integer&gt; numbers = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>);
        <span class="hljs-type">StandardEvaluationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEvaluationContext</span>();
        context.setVariable(<span class="hljs-string">"numbers"</span>, numbers);

        <span class="hljs-comment">// 选择偶数</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp3</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"#numbers.?[#this % 2 == 0]"</span>);
        List&lt;Integer&gt; evenNumbers = (List&lt;Integer&gt;) exp3.getValue(context);
        System.out.println(<span class="hljs-string">"偶数: "</span> + evenNumbers);  <span class="hljs-comment">// [2, 4, 6, 8, 10]</span>

        <span class="hljs-comment">// 集合投影（映射）</span>
        List&lt;User&gt; users = Arrays.asList(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"张三"</span>, <span class="hljs-number">25</span>, <span class="hljs-string">"zhangsan@example.com"</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"李四"</span>, <span class="hljs-number">30</span>, <span class="hljs-string">"lisi@example.com"</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"王五"</span>, <span class="hljs-number">35</span>, <span class="hljs-string">"wangwu@example.com"</span>)
        );
        context.setVariable(<span class="hljs-string">"users"</span>, users);

        <span class="hljs-comment">// 提取所有用户名</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp4</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"#users.![name]"</span>);
        List&lt;String&gt; names = (List&lt;String&gt;) exp4.getValue(context);
        System.out.println(<span class="hljs-string">"用户名列表: "</span> + names);  <span class="hljs-comment">// [张三, 李四, 王五]</span>

        <span class="hljs-comment">// 查找第一个匹配</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp5</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"#users.^[age &gt; 25]"</span>);
        <span class="hljs-type">User</span> <span class="hljs-variable">firstMatch</span> <span class="hljs-operator">=</span> (User) exp5.getValue(context);
        System.out.println(<span class="hljs-string">"第一个年龄&gt;25: "</span> + firstMatch.getName());  <span class="hljs-comment">// 李四</span>

        <span class="hljs-comment">// 查找最后一个匹配</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp6</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"#users.$[age &gt; 25]"</span>);
        <span class="hljs-type">User</span> <span class="hljs-variable">lastMatch</span> <span class="hljs-operator">=</span> (User) exp6.getValue(context);
        System.out.println(<span class="hljs-string">"最后一个年龄&gt;25: "</span> + lastMatch.getName());  <span class="hljs-comment">// 王五</span>
    }
}
</code></pre>
<h4 data-id="heading-11">2.6 正则表达式</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 正则表达式示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RegexDemo</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();

        <span class="hljs-comment">// 邮箱验证</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp1</span> <span class="hljs-operator">=</span> parser.parseExpression(
            <span class="hljs-string">"'zhangsan@example.com' matches '^[A-Za-z0-9+_.-]+@(.+)$'"</span>);
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">isEmail</span> <span class="hljs-operator">=</span> exp1.getValue(Boolean.class);
        System.out.println(<span class="hljs-string">"是否为邮箱: "</span> + isEmail);  <span class="hljs-comment">// true</span>

        <span class="hljs-comment">// 手机号验证</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp2</span> <span class="hljs-operator">=</span> parser.parseExpression(
            <span class="hljs-string">"'13800138000' matches '^1[3-9]\\d{9}$'"</span>);
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">isPhone</span> <span class="hljs-operator">=</span> exp2.getValue(Boolean.class);
        System.out.println(<span class="hljs-string">"是否为手机号: "</span> + isPhone);  <span class="hljs-comment">// true</span>

        <span class="hljs-comment">// 在对象上使用</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"张三"</span>, <span class="hljs-number">25</span>, <span class="hljs-string">"invalid-email"</span>);
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp3</span> <span class="hljs-operator">=</span> parser.parseExpression(
            <span class="hljs-string">"email matches '^[A-Za-z0-9+_.-]+@(.+)$'"</span>);
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">validEmail</span> <span class="hljs-operator">=</span> exp3.getValue(user, Boolean.class);
        System.out.println(<span class="hljs-string">"邮箱格式正确: "</span> + validEmail);  <span class="hljs-comment">// false</span>
    }
}
</code></pre>
<h3 data-id="heading-12">三、Spring中的SpEL应用</h3>
<h4 data-id="heading-13">3.1 @Value注解</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@Value</span>注解使用SpEL
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ValueDemo</span> {

    <span class="hljs-comment">// 1. 字面量</span>
    <span class="hljs-meta">@Value("#{100}")</span>
    <span class="hljs-keyword">private</span> Integer literalValue;

    <span class="hljs-comment">// 2. 系统属性</span>
    <span class="hljs-meta">@Value("#{systemProperties['user.home']}")</span>
    <span class="hljs-keyword">private</span> String userHome;

    <span class="hljs-comment">// 3. 环境变量</span>
    <span class="hljs-meta">@Value("#{systemEnvironment['PATH']}")</span>
    <span class="hljs-keyword">private</span> String path;

    <span class="hljs-comment">// 4. 配置文件属性</span>
    <span class="hljs-meta">@Value("${server.port:8080}")</span>
    <span class="hljs-keyword">private</span> Integer serverPort;

    <span class="hljs-comment">// 5. Bean属性</span>
    <span class="hljs-meta">@Value("#{userService.userCount}")</span>
    <span class="hljs-keyword">private</span> Integer userCount;

    <span class="hljs-comment">// 6. 表达式计算</span>
    <span class="hljs-meta">@Value("#{T(java.lang.Math).random() * 100}")</span>
    <span class="hljs-keyword">private</span> Double randomValue;

    <span class="hljs-comment">// 7. 列表注入</span>
    <span class="hljs-meta">@Value("#{'${user.roles}'.split(',')}")</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; roles;

    <span class="hljs-comment">// 8. 三元表达式</span>
    <span class="hljs-meta">@Value("#{${user.enabled:true} ? '启用' : '禁用'}")</span>
    <span class="hljs-keyword">private</span> String userStatus;

    <span class="hljs-comment">// 9. Elvis运算符</span>
    <span class="hljs-meta">@Value("#{config.name ?: 'default'}")</span>
    <span class="hljs-keyword">private</span> String configName;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printValues</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"字面量: "</span> + literalValue);
        System.out.println(<span class="hljs-string">"用户主目录: "</span> + userHome);
        System.out.println(<span class="hljs-string">"随机值: "</span> + randomValue);
        System.out.println(<span class="hljs-string">"用户角色: "</span> + roles);
        System.out.println(<span class="hljs-string">"用户状态: "</span> + userStatus);
    }
}
</code></pre>
<h4 data-id="heading-14">3.2 Spring Cache</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * Spring Cache中使用SpEL
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {

    <span class="hljs-comment">/**
     * 缓存Key使用SpEL
     */</span>
    <span class="hljs-meta">@Cacheable(
        value = "products",
        key = "#id",                    // 简单参数
        condition = "#id &gt; 0",          // 缓存条件
        unless = "#result == null"     // 排除条件
    )</span>
    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span> {
        System.out.println(<span class="hljs-string">"从数据库查询: "</span> + id);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(id, <span class="hljs-string">"商品"</span> + id, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"99.99"</span>));
    }

    <span class="hljs-comment">/**
     * 复杂Key生成
     */</span>
    <span class="hljs-meta">@Cacheable(
        value = "productList",
        key = "#root.methodName + ':' + #category + ':' + #page + ':' + #size"
    )</span>
    <span class="hljs-keyword">public</span> List&lt;Product&gt; <span class="hljs-title function_">findByCategory</span><span class="hljs-params">(String category, <span class="hljs-type">int</span> page, <span class="hljs-type">int</span> size)</span> {
        System.out.println(<span class="hljs-string">"查询分类: "</span> + category);
        <span class="hljs-keyword">return</span> Arrays.asList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-number">1L</span>, <span class="hljs-string">"商品1"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"99.99"</span>)));
    }

    <span class="hljs-comment">/**
     * 使用对象属性作为Key
     */</span>
    <span class="hljs-meta">@Cacheable(
        value = "searchResults",
        key = "#query.keyword + ':' + #query.page"
    )</span>
    <span class="hljs-keyword">public</span> List&lt;Product&gt; <span class="hljs-title function_">search</span><span class="hljs-params">(SearchQuery query)</span> {
        System.out.println(<span class="hljs-string">"搜索: "</span> + query.getKeyword());
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    }

    <span class="hljs-comment">/**
     * 缓存删除
     */</span>
    <span class="hljs-meta">@CacheEvict(
        value = "products",
        key = "#product.id",
        condition = "#product.id != null"
    )</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProduct</span><span class="hljs-params">(Product product)</span> {
        System.out.println(<span class="hljs-string">"更新商品: "</span> + product.getId());
    }

    <span class="hljs-comment">/**
     * 批量删除缓存
     */</span>
    <span class="hljs-meta">@CacheEvict(value = "products", allEntries = true)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearAllCache</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"清空所有缓存"</span>);
    }
}

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> BigDecimal price;
}

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchQuery</span> {
    <span class="hljs-keyword">private</span> String keyword;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> page;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> size;
}
</code></pre>
<h4 data-id="heading-15">3.3 Spring Security</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * Spring Security中使用SpEL
 */</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {

    <span class="hljs-comment">/**
     * 方法级权限控制
     */</span>
    <span class="hljs-meta">@PreAuthorize("hasRole('ADMIN')")</span>
    <span class="hljs-meta">@GetMapping</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    }

    <span class="hljs-comment">/**
     * 基于参数的权限控制
     */</span>
    <span class="hljs-meta">@PreAuthorize("#id == authentication.principal.id or hasRole('ADMIN')")</span>
    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
    }

    <span class="hljs-comment">/**
     * 复杂权限表达式
     */</span>
    <span class="hljs-meta">@PreAuthorize("hasRole('ADMIN') and #user.department == authentication.principal.department")</span>
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">createUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        <span class="hljs-keyword">return</span> user;
    }

    <span class="hljs-comment">/**
     * 方法返回后检查
     */</span>
    <span class="hljs-meta">@PostAuthorize("returnObject.owner == authentication.principal.username")</span>
    <span class="hljs-meta">@GetMapping("/{id}/details")</span>
    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">getUserDetails</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserDetails</span>();
    }

    <span class="hljs-comment">/**
     * 过滤集合
     */</span>
    <span class="hljs-meta">@PostFilter("filterObject.owner == authentication.principal.username")</span>
    <span class="hljs-meta">@GetMapping("/my-items")</span>
    <span class="hljs-keyword">public</span> List&lt;Item&gt; <span class="hljs-title function_">getMyItems</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    }
}

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDetails</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String owner;
}

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Item</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String owner;
}
</code></pre>
<h4 data-id="heading-16">3.4 Spring事件监听</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 事件监听中使用SpEL
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderEventListener</span> {

    <span class="hljs-comment">/**
     * 条件事件监听
     */</span>
    <span class="hljs-meta">@EventListener(condition = "#event.order.amount &gt; 1000")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLargeOrder</span><span class="hljs-params">(OrderCreatedEvent event)</span> {
        System.out.println(<span class="hljs-string">"处理大额订单: "</span> + event.getOrder().getAmount());
    }

    <span class="hljs-comment">/**
     * 复杂条件
     */</span>
    <span class="hljs-meta">@EventListener(condition = "#event.order.status == 'PAID' and #event.order.amount &gt; 500")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handlePaidOrder</span><span class="hljs-params">(OrderCreatedEvent event)</span> {
        System.out.println(<span class="hljs-string">"处理已支付订单"</span>);
    }

    <span class="hljs-comment">/**
     * 使用SpEL调用方法
     */</span>
    <span class="hljs-meta">@EventListener(condition = "#event.isVipOrder()")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleVipOrder</span><span class="hljs-params">(OrderCreatedEvent event)</span> {
        System.out.println(<span class="hljs-string">"处理VIP订单"</span>);
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderCreatedEvent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ApplicationEvent</span> {
    <span class="hljs-keyword">private</span> Order order;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderCreatedEvent</span><span class="hljs-params">(Object source, Order order)</span> {
        <span class="hljs-built_in">super</span>(source);
        <span class="hljs-built_in">this</span>.order = order;
    }

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> order;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isVipOrder</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> order.getAmount().compareTo(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"5000"</span>)) &gt; <span class="hljs-number">0</span>;
    }
}

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String status;
    <span class="hljs-keyword">private</span> BigDecimal amount;
}
</code></pre>
<h3 data-id="heading-17">四、高级特性</h3>
<h4 data-id="heading-18">4.1 自定义函数</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 自定义函数示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomFunctionDemo</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchMethodException {
        <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();
        <span class="hljs-type">StandardEvaluationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEvaluationContext</span>();

        <span class="hljs-comment">// 注册自定义函数</span>
        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> StringUtils.class.getDeclaredMethod(<span class="hljs-string">"reverse"</span>, String.class);
        context.registerFunction(<span class="hljs-string">"reverse"</span>, method);

        <span class="hljs-comment">// 使用自定义函数</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"#reverse('Hello')"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> exp.getValue(context, String.class);
        System.out.println(<span class="hljs-string">"反转: "</span> + result);  <span class="hljs-comment">// olleH</span>
    }

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringUtils</span> {
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">reverse</span><span class="hljs-params">(String str)</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(str).reverse().toString();
        }
    }
}
</code></pre>
<h4 data-id="heading-19">4.2 变量定义</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 变量定义示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VariableDemo</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();
        <span class="hljs-type">StandardEvaluationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEvaluationContext</span>();

        <span class="hljs-comment">// 定义变量</span>
        context.setVariable(<span class="hljs-string">"name"</span>, <span class="hljs-string">"张三"</span>);
        context.setVariable(<span class="hljs-string">"age"</span>, <span class="hljs-number">25</span>);
        context.setVariable(<span class="hljs-string">"hobbies"</span>, Arrays.asList(<span class="hljs-string">"篮球"</span>, <span class="hljs-string">"游泳"</span>, <span class="hljs-string">"阅读"</span>));

        <span class="hljs-comment">// 使用变量</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp1</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"#name"</span>);
        System.out.println(<span class="hljs-string">"姓名: "</span> + exp1.getValue(context));  <span class="hljs-comment">// 张三</span>

        <span class="hljs-comment">// 在表达式中计算</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp2</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"#age &gt; 18 ? '成年' : '未成年'"</span>);
        System.out.println(<span class="hljs-string">"年龄状态: "</span> + exp2.getValue(context));  <span class="hljs-comment">// 成年</span>

        <span class="hljs-comment">// 集合操作</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp3</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"#hobbies.size()"</span>);
        System.out.println(<span class="hljs-string">"爱好数量: "</span> + exp3.getValue(context));  <span class="hljs-comment">// 3</span>

        <span class="hljs-comment">// #this和#root</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"李四"</span>, <span class="hljs-number">30</span>, <span class="hljs-string">"lisi@example.com"</span>);
        context.setRootObject(user);

        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp4</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"#root.name"</span>);
        System.out.println(<span class="hljs-string">"#root: "</span> + exp4.getValue(context));  <span class="hljs-comment">// 李四</span>

        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp5</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"name"</span>);
        System.out.println(<span class="hljs-string">"直接访问: "</span> + exp5.getValue(context));  <span class="hljs-comment">// 李四</span>
    }
}
</code></pre>
<h4 data-id="heading-20">4.3 Bean引用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * Bean引用示例
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BeanReferenceDemo</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">dataSource</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HikariDataSource</span>();
    }

    <span class="hljs-meta">@Component</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigService</span> {

        <span class="hljs-comment">// 引用Bean</span>
        <span class="hljs-meta">@Value("#{@dataSource.jdbcUrl}")</span>
        <span class="hljs-keyword">private</span> String jdbcUrl;

        <span class="hljs-comment">// 调用Bean方法</span>
        <span class="hljs-meta">@Value("#{@userService.getUserCount()}")</span>
        <span class="hljs-keyword">private</span> Integer userCount;

        <span class="hljs-comment">// Bean属性访问</span>
        <span class="hljs-meta">@Value("#{@environment['spring.application.name']}")</span>
        <span class="hljs-keyword">private</span> String appName;
    }

    <span class="hljs-meta">@Service</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {

        <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getUserCount</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-number">100</span>;
        }

        <span class="hljs-meta">@Cacheable(value = "users", key = "@userService.generateKey(#id)")</span>
        <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        }

        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateKey</span><span class="hljs-params">(Long id)</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"user:"</span> + id;
        }
    }
}
</code></pre>
<h4 data-id="heading-21">4.4 类型转换</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 类型转换示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeConversionDemo</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();

        <span class="hljs-comment">// 自动类型转换</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp1</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"'100'"</span>);
        <span class="hljs-type">Integer</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> exp1.getValue(Integer.class);
        System.out.println(<span class="hljs-string">"字符串转整数: "</span> + num);  <span class="hljs-comment">// 100</span>

        <span class="hljs-comment">// 显式类型转换</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp2</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"T(Integer).parseInt('123')"</span>);
        <span class="hljs-type">Integer</span> <span class="hljs-variable">parsed</span> <span class="hljs-operator">=</span> exp2.getValue(Integer.class);
        System.out.println(<span class="hljs-string">"解析整数: "</span> + parsed);  <span class="hljs-comment">// 123</span>

        <span class="hljs-comment">// 日期转换</span>
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp3</span> <span class="hljs-operator">=</span> parser.parseExpression(
            <span class="hljs-string">"T(java.time.LocalDate).parse('2024-01-01')"</span>);
        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> exp3.getValue(LocalDate.class);
        System.out.println(<span class="hljs-string">"日期: "</span> + date);

        <span class="hljs-comment">// 自定义类型转换</span>
        <span class="hljs-type">StandardEvaluationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEvaluationContext</span>();
        <span class="hljs-type">DefaultConversionService</span> <span class="hljs-variable">conversionService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConversionService</span>();
        conversionService.addConverter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringToUserConverter</span>());
        context.setTypeConverter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardTypeConverter</span>(conversionService));

        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp4</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">"'张三,25,zhangsan@example.com'"</span>);
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> exp4.getValue(context, User.class);
        System.out.println(<span class="hljs-string">"自定义转换: "</span> + user.getName());
    }

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringToUserConverter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Converter</span>&lt;String, User&gt; {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> User <span class="hljs-title function_">convert</span><span class="hljs-params">(String source)</span> {
            String[] parts = source.split(<span class="hljs-string">","</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(parts[<span class="hljs-number">0</span>], Integer.parseInt(parts[<span class="hljs-number">1</span>]), parts[<span class="hljs-number">2</span>]);
        }
    }
}
</code></pre>
<h3 data-id="heading-22">五、实战案例</h3>
<h4 data-id="heading-23">5.1 案例1：动态权限校验</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 动态权限校验系统
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ExpressionParser parser;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, String&gt; resourcePermissions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PermissionService</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 初始化资源权限表达式</span>
        resourcePermissions.put(<span class="hljs-string">"/api/users"</span>, <span class="hljs-string">"hasRole('ADMIN')"</span>);
        resourcePermissions.put(<span class="hljs-string">"/api/users/{id}"</span>,
            <span class="hljs-string">"hasRole('ADMIN') or #id == principal.id"</span>);
        resourcePermissions.put(<span class="hljs-string">"/api/orders"</span>,
            <span class="hljs-string">"hasRole('USER') and principal.department == 'SALES'"</span>);
    }

    <span class="hljs-comment">/**
     * 检查权限
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkPermission</span><span class="hljs-params">(String resource, Map&lt;String, Object&gt; variables)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> resourcePermissions.get(resource);
        <span class="hljs-keyword">if</span> (expression == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 无限制</span>
        }

        <span class="hljs-type">StandardEvaluationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEvaluationContext</span>();

        <span class="hljs-comment">// 设置变量</span>
        variables.forEach(context::setVariable);

        <span class="hljs-comment">// 注册自定义函数</span>
        registerFunctions(context);

        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> parser.parseExpression(expression);
        <span class="hljs-keyword">return</span> Boolean.TRUE.equals(exp.getValue(context, Boolean.class));
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerFunctions</span><span class="hljs-params">(StandardEvaluationContext context)</span> {
        <span class="hljs-comment">// 注册hasRole函数</span>
        context.setVariable(<span class="hljs-string">"hasRole"</span>, (Function&lt;String, Boolean&gt;) role -&gt; {
            <span class="hljs-comment">// 模拟从SecurityContext获取角色</span>
            Set&lt;String&gt; roles = getCurrentUserRoles();
            <span class="hljs-keyword">return</span> roles.contains(role);
        });

        <span class="hljs-comment">// 设置principal</span>
        context.setVariable(<span class="hljs-string">"principal"</span>, getCurrentUser());
    }

    <span class="hljs-keyword">private</span> Set&lt;String&gt; <span class="hljs-title function_">getCurrentUserRoles</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;(Arrays.asList(<span class="hljs-string">"USER"</span>, <span class="hljs-string">"ADMIN"</span>));
    }

    <span class="hljs-keyword">private</span> UserPrincipal <span class="hljs-title function_">getCurrentUser</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserPrincipal</span>(<span class="hljs-number">1L</span>, <span class="hljs-string">"zhangsan"</span>, <span class="hljs-string">"SALES"</span>);
    }
}

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserPrincipal</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String department;
}

<span class="hljs-comment">/**
 * 使用示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">PermissionService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PermissionService</span>();
        service.parser = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();

        <span class="hljs-comment">// 检查访问/api/users权限</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">canAccess</span> <span class="hljs-operator">=</span> service.checkPermission(<span class="hljs-string">"/api/users"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;());
        System.out.println(<span class="hljs-string">"可以访问用户列表: "</span> + canAccess);

        <span class="hljs-comment">// 检查访问特定用户权限</span>
        Map&lt;String, Object&gt; vars = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        vars.put(<span class="hljs-string">"id"</span>, <span class="hljs-number">1L</span>);
        <span class="hljs-type">boolean</span> <span class="hljs-variable">canAccessUser</span> <span class="hljs-operator">=</span> service.checkPermission(<span class="hljs-string">"/api/users/{id}"</span>, vars);
        System.out.println(<span class="hljs-string">"可以访问用户1: "</span> + canAccessUser);
    }
}
</code></pre>
<h4 data-id="heading-24">5.2 案例2：动态查询构建器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 动态查询构建器
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicQueryService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ExpressionParser parser;

    <span class="hljs-comment">/**
     * 根据条件表达式构建查询
     */</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(String condition, Map&lt;String, Object&gt; params)</span> {
        <span class="hljs-type">StandardEvaluationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEvaluationContext</span>();
        params.forEach(context::setVariable);

        <span class="hljs-comment">// 模拟数据</span>
        List&lt;User&gt; allUsers = Arrays.asList(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"张三"</span>, <span class="hljs-number">25</span>, <span class="hljs-string">"zhangsan@example.com"</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"李四"</span>, <span class="hljs-number">30</span>, <span class="hljs-string">"lisi@example.com"</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"王五"</span>, <span class="hljs-number">35</span>, <span class="hljs-string">"wangwu@example.com"</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"赵六"</span>, <span class="hljs-number">28</span>, <span class="hljs-string">"zhaoliu@example.com"</span>)
        );

        context.setVariable(<span class="hljs-string">"users"</span>, allUsers);

        <span class="hljs-comment">// 使用SpEL过滤</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> <span class="hljs-string">"#users.?["</span> + condition + <span class="hljs-string">"]"</span>;
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> parser.parseExpression(expression);

        <span class="hljs-keyword">return</span> (List&lt;User&gt;) exp.getValue(context);
    }

    <span class="hljs-comment">/**
     * 动态排序
     */</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">sort</span><span class="hljs-params">(List&lt;User&gt; users, String sortExpression)</span> {
        users.sort((u1, u2) -&gt; {
            <span class="hljs-type">StandardEvaluationContext</span> <span class="hljs-variable">context1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEvaluationContext</span>(u1);
            <span class="hljs-type">StandardEvaluationContext</span> <span class="hljs-variable">context2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEvaluationContext</span>(u2);

            <span class="hljs-type">Expression</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> parser.parseExpression(sortExpression);
            <span class="hljs-type">Comparable</span> <span class="hljs-variable">v1</span> <span class="hljs-operator">=</span> exp.getValue(context1, Comparable.class);
            <span class="hljs-type">Comparable</span> <span class="hljs-variable">v2</span> <span class="hljs-operator">=</span> exp.getValue(context2, Comparable.class);

            <span class="hljs-keyword">return</span> v1.compareTo(v2);
        });

        <span class="hljs-keyword">return</span> users;
    }
}

<span class="hljs-comment">/**
 * 使用示例
 */</span>
<span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicQueryDemo</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DynamicQueryService queryService;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDynamicQuery</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 查询年龄大于25的用户</span>
        Map&lt;String, Object&gt; params1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        params1.put(<span class="hljs-string">"minAge"</span>, <span class="hljs-number">25</span>);
        List&lt;User&gt; result1 = queryService.query(<span class="hljs-string">"#this.age &gt; #minAge"</span>, params1);
        System.out.println(<span class="hljs-string">"年龄&gt;25: "</span> + result1.size());

        <span class="hljs-comment">// 查询邮箱包含特定域名的用户</span>
        Map&lt;String, Object&gt; params2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        params2.put(<span class="hljs-string">"domain"</span>, <span class="hljs-string">"example.com"</span>);
        List&lt;User&gt; result2 = queryService.query(
            <span class="hljs-string">"#this.email.contains(#domain)"</span>, params2);
        System.out.println(<span class="hljs-string">"邮箱包含example.com: "</span> + result2.size());

        <span class="hljs-comment">// 复合条件</span>
        Map&lt;String, Object&gt; params3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        params3.put(<span class="hljs-string">"minAge"</span>, <span class="hljs-number">25</span>);
        params3.put(<span class="hljs-string">"maxAge"</span>, <span class="hljs-number">32</span>);
        List&lt;User&gt; result3 = queryService.query(
            <span class="hljs-string">"#this.age &gt;= #minAge and #this.age &lt;= #maxAge"</span>, params3);
        System.out.println(<span class="hljs-string">"年龄25-32: "</span> + result3.size());

        <span class="hljs-comment">// 动态排序</span>
        List&lt;User&gt; sorted = queryService.sort(result3, <span class="hljs-string">"age"</span>);
        System.out.println(<span class="hljs-string">"排序后: "</span> + sorted);
    }
}
</code></pre>
<h4 data-id="heading-25">5.3 案例3：配置表达式引擎</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 配置表达式引擎
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigExpressionService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Environment environment;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ExpressionParser parser;

    <span class="hljs-comment">/**
     * 解析配置表达式
     */</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">evaluateConfig</span><span class="hljs-params">(String expression, Class&lt;T&gt; type)</span> {
        <span class="hljs-type">StandardEvaluationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEvaluationContext</span>();

        <span class="hljs-comment">// 添加环境变量</span>
        context.setVariable(<span class="hljs-string">"env"</span>, environment);

        <span class="hljs-comment">// 添加系统属性</span>
        context.setVariable(<span class="hljs-string">"sys"</span>, System.getProperties());

        <span class="hljs-comment">// 添加自定义函数</span>
        registerFunctions(context);

        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> parser.parseExpression(expression);
        <span class="hljs-keyword">return</span> exp.getValue(context, type);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerFunctions</span><span class="hljs-params">(StandardEvaluationContext context)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 注册环境相关函数</span>
            context.registerFunction(<span class="hljs-string">"isProd"</span>,
                ConfigExpressionService.class.getMethod(<span class="hljs-string">"isProdEnvironment"</span>));
            context.registerFunction(<span class="hljs-string">"isWindows"</span>,
                ConfigExpressionService.class.getMethod(<span class="hljs-string">"isWindows"</span>));
        } <span class="hljs-keyword">catch</span> (NoSuchMethodException e) {
            e.printStackTrace();
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isProdEnvironment</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">profile</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"spring.profiles.active"</span>, <span class="hljs-string">""</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"prod"</span>.equals(profile);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isWindows</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> System.getProperty(<span class="hljs-string">"os.name"</span>).toLowerCase().contains(<span class="hljs-string">"win"</span>);
    }
}

<span class="hljs-comment">/**
 * 配置类
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicConfig</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ConfigExpressionService configService;

    <span class="hljs-comment">/**
     * 动态线程池配置
     */</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> ThreadPoolExecutor <span class="hljs-title function_">threadPoolExecutor</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 根据环境动态配置</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">coreSize</span> <span class="hljs-operator">=</span> configService.evaluateConfig(
            <span class="hljs-string">"#isProd() ? 20 : 5"</span>, Integer.class);

        <span class="hljs-type">int</span> <span class="hljs-variable">maxSize</span> <span class="hljs-operator">=</span> configService.evaluateConfig(
            <span class="hljs-string">"#isProd() ? 50 : 10"</span>, Integer.class);

        <span class="hljs-type">int</span> <span class="hljs-variable">queueSize</span> <span class="hljs-operator">=</span> configService.evaluateConfig(
            <span class="hljs-string">"#isProd() ? 1000 : 100"</span>, Integer.class);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
            coreSize, maxSize, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(queueSize),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy()
        );
    }

    <span class="hljs-comment">/**
     * 动态数据源配置
     */</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">dataSource</span><span class="hljs-params">()</span> {
        <span class="hljs-type">HikariConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HikariConfig</span>();

        <span class="hljs-comment">// 根据系统动态选择驱动</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">driver</span> <span class="hljs-operator">=</span> configService.evaluateConfig(
            <span class="hljs-string">"#isWindows() ? 'com.mysql.cj.jdbc.Driver' : 'org.postgresql.Driver'"</span>,
            String.class);

        config.setDriverClassName(driver);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HikariDataSource</span>(config);
    }
}
</code></pre>
<h4 data-id="heading-26">5.4 案例4：规则引擎</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 简单规则引擎
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuleEngine</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ExpressionParser parser;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Rule&gt; rules = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RuleEngine</span><span class="hljs-params">()</span> {
        initRules();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initRules</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 订单金额折扣规则</span>
        rules.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Rule</span>(
            <span class="hljs-string">"大额订单折扣"</span>,
            <span class="hljs-string">"order.amount &gt; 1000"</span>,
            <span class="hljs-string">"order.discount = 0.9"</span>
        ));

        rules.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Rule</span>(
            <span class="hljs-string">"VIP用户折扣"</span>,
            <span class="hljs-string">"user.vip == true"</span>,
            <span class="hljs-string">"order.discount = order.discount * 0.95"</span>
        ));

        rules.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Rule</span>(
            <span class="hljs-string">"首单优惠"</span>,
            <span class="hljs-string">"user.orderCount == 0"</span>,
            <span class="hljs-string">"order.discount = order.discount * 0.85"</span>
        ));

        rules.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Rule</span>(
            <span class="hljs-string">"节假日优惠"</span>,
            <span class="hljs-string">"T(java.time.LocalDate).now().dayOfWeek.value &gt;= 6"</span>,
            <span class="hljs-string">"order.discount = order.discount * 0.98"</span>
        ));
    }

    <span class="hljs-comment">/**
     * 执行规则
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(OrderContext context)</span> {
        <span class="hljs-type">StandardEvaluationContext</span> <span class="hljs-variable">evalContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEvaluationContext</span>(context);

        <span class="hljs-keyword">for</span> (Rule rule : rules) {
            <span class="hljs-comment">// 检查条件</span>
            <span class="hljs-type">Expression</span> <span class="hljs-variable">conditionExp</span> <span class="hljs-operator">=</span> parser.parseExpression(rule.getCondition());
            <span class="hljs-type">Boolean</span> <span class="hljs-variable">matched</span> <span class="hljs-operator">=</span> conditionExp.getValue(evalContext, Boolean.class);

            <span class="hljs-keyword">if</span> (Boolean.TRUE.equals(matched)) {
                System.out.println(<span class="hljs-string">"规则匹配: "</span> + rule.getName());

                <span class="hljs-comment">// 执行动作</span>
                <span class="hljs-type">Expression</span> <span class="hljs-variable">actionExp</span> <span class="hljs-operator">=</span> parser.parseExpression(rule.getAction());
                actionExp.getValue(evalContext);
            }
        }
    }
}

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Rule</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> String condition;
    <span class="hljs-keyword">private</span> String action;
}

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderContext</span> {
    <span class="hljs-keyword">private</span> OrderInfo order;
    <span class="hljs-keyword">private</span> UserInfo user;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderContext</span><span class="hljs-params">(OrderInfo order, UserInfo user)</span> {
        <span class="hljs-built_in">this</span>.order = order;
        <span class="hljs-built_in">this</span>.user = user;
        <span class="hljs-built_in">this</span>.order.setDiscount(<span class="hljs-number">1.0</span>);  <span class="hljs-comment">// 初始折扣</span>
    }
}

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderInfo</span> {
    <span class="hljs-keyword">private</span> BigDecimal amount;
    <span class="hljs-keyword">private</span> Double discount;

    <span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title function_">getFinalAmount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> amount.multiply(BigDecimal.valueOf(discount));
    }
}

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserInfo</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> vip;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> orderCount;
}

<span class="hljs-comment">/**
 * 使用示例
 */</span>
<span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuleEngineDemo</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RuleEngine ruleEngine;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testRuleEngine</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 场景1：大额订单 + VIP用户</span>
        <span class="hljs-type">OrderInfo</span> <span class="hljs-variable">order1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderInfo</span>();
        order1.setAmount(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"1500"</span>));

        <span class="hljs-type">UserInfo</span> <span class="hljs-variable">user1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserInfo</span>();
        user1.setVip(<span class="hljs-literal">true</span>);
        user1.setOrderCount(<span class="hljs-number">5</span>);

        <span class="hljs-type">OrderContext</span> <span class="hljs-variable">context1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderContext</span>(order1, user1);
        ruleEngine.execute(context1);

        System.out.println(<span class="hljs-string">"原价: "</span> + order1.getAmount());
        System.out.println(<span class="hljs-string">"折扣: "</span> + order1.getDiscount());
        System.out.println(<span class="hljs-string">"实付: "</span> + order1.getFinalAmount());
        System.out.println();

        <span class="hljs-comment">// 场景2：首单用户</span>
        <span class="hljs-type">OrderInfo</span> <span class="hljs-variable">order2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderInfo</span>();
        order2.setAmount(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"500"</span>));

        <span class="hljs-type">UserInfo</span> <span class="hljs-variable">user2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserInfo</span>();
        user2.setVip(<span class="hljs-literal">false</span>);
        user2.setOrderCount(<span class="hljs-number">0</span>);

        <span class="hljs-type">OrderContext</span> <span class="hljs-variable">context2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderContext</span>(order2, user2);
        ruleEngine.execute(context2);

        System.out.println(<span class="hljs-string">"原价: "</span> + order2.getAmount());
        System.out.println(<span class="hljs-string">"折扣: "</span> + order2.getDiscount());
        System.out.println(<span class="hljs-string">"实付: "</span> + order2.getFinalAmount());
    }
}
</code></pre>
<h3 data-id="heading-27">六、性能优化</h3>
<h4 data-id="heading-28">6.1 表达式缓存</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 表达式缓存
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CachedExpressionService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Expression&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-comment">/**
     * 获取表达式（带缓存）
     */</span>
    <span class="hljs-keyword">public</span> Expression <span class="hljs-title function_">getExpression</span><span class="hljs-params">(String expressionString)</span> {
        <span class="hljs-keyword">return</span> cache.computeIfAbsent(expressionString, parser::parseExpression);
    }

    <span class="hljs-comment">/**
     * 评估表达式
     */</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">evaluate</span><span class="hljs-params">(String expressionString, Object rootObject, Class&lt;T&gt; type)</span> {
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> getExpression(expressionString);
        <span class="hljs-keyword">return</span> exp.getValue(rootObject, type);
    }

    <span class="hljs-comment">/**
     * 性能测试
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performanceTest</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">expr</span> <span class="hljs-operator">=</span> <span class="hljs-string">"name.toUpperCase() + ' - ' + age"</span>;
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"张三"</span>, <span class="hljs-number">25</span>, <span class="hljs-string">"zhangsan@example.com"</span>);

        <span class="hljs-comment">// 不使用缓存</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">start1</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
            parser.parseExpression(expr).getValue(user, String.class);
        }
        <span class="hljs-type">long</span> <span class="hljs-variable">time1</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start1;

        <span class="hljs-comment">// 使用缓存</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">start2</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-type">Expression</span> <span class="hljs-variable">cached</span> <span class="hljs-operator">=</span> getExpression(expr);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
            cached.getValue(user, String.class);
        }
        <span class="hljs-type">long</span> <span class="hljs-variable">time2</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start2;

        System.out.println(<span class="hljs-string">"不使用缓存: "</span> + time1 + <span class="hljs-string">"ms"</span>);
        System.out.println(<span class="hljs-string">"使用缓存: "</span> + time2 + <span class="hljs-string">"ms"</span>);
        System.out.println(<span class="hljs-string">"性能提升: "</span> + (time1 - time2) + <span class="hljs-string">"ms"</span>);
    }
}
</code></pre>
<h4 data-id="heading-29">6.2 编译模式</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 编译模式优化
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CompilationDemo</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">SpelExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();
        <span class="hljs-type">SpelParserConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelParserConfiguration</span>(
            SpelCompilerMode.IMMEDIATE,  <span class="hljs-comment">// 立即编译</span>
            <span class="hljs-literal">null</span>
        );
        <span class="hljs-type">SpelExpressionParser</span> <span class="hljs-variable">compilingParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>(config);

        <span class="hljs-type">String</span> <span class="hljs-variable">expr</span> <span class="hljs-operator">=</span> <span class="hljs-string">"#this * 2 + 1"</span>;
        List&lt;Integer&gt; numbers = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);

        <span class="hljs-comment">// 普通模式</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">start1</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp1</span> <span class="hljs-operator">=</span> parser.parseExpression(expr);
        <span class="hljs-type">StandardEvaluationContext</span> <span class="hljs-variable">context1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEvaluationContext</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; i++) {
            <span class="hljs-keyword">for</span> (Integer num : numbers) {
                context1.setRootObject(num);
                exp1.getValue(context1);
            }
        }
        <span class="hljs-type">long</span> <span class="hljs-variable">time1</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start1;

        <span class="hljs-comment">// 编译模式</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">start2</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp2</span> <span class="hljs-operator">=</span> compilingParser.parseExpression(expr);
        <span class="hljs-type">StandardEvaluationContext</span> <span class="hljs-variable">context2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEvaluationContext</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; i++) {
            <span class="hljs-keyword">for</span> (Integer num : numbers) {
                context2.setRootObject(num);
                exp2.getValue(context2);
            }
        }
        <span class="hljs-type">long</span> <span class="hljs-variable">time2</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start2;

        System.out.println(<span class="hljs-string">"普通模式: "</span> + time1 + <span class="hljs-string">"ms"</span>);
        System.out.println(<span class="hljs-string">"编译模式: "</span> + time2 + <span class="hljs-string">"ms"</span>);
        System.out.println(<span class="hljs-string">"性能提升: "</span> + ((time1 - time2) * <span class="hljs-number">100.0</span> / time1) + <span class="hljs-string">"%"</span>);
    }
}
</code></pre>
<h3 data-id="heading-30">七、最佳实践</h3>
<h4 data-id="heading-31">7.1 安全性</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * SpEL安全性最佳实践
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityDemo</span> {

    <span class="hljs-comment">/**
     * ❌ 不安全：直接使用用户输入
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unsafeEvaluation</span><span class="hljs-params">(String userInput)</span> {
        <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> parser.parseExpression(userInput);
        <span class="hljs-comment">// 危险！用户可以执行任意代码</span>
        <span class="hljs-comment">// 如输入：T(java.lang.Runtime).getRuntime().exec('rm -rf /')</span>
        exp.getValue();
    }

    <span class="hljs-comment">/**
     * ✓ 安全：使用SimpleEvaluationContext
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">safeEvaluation</span><span class="hljs-params">(String userInput)</span> {
        <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();

        <span class="hljs-comment">// 创建受限的上下文</span>
        <span class="hljs-type">SimpleEvaluationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> SimpleEvaluationContext
            .forReadOnlyDataBinding()  <span class="hljs-comment">// 只读绑定</span>
            .build();

        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> parser.parseExpression(userInput);
        <span class="hljs-comment">// 只能访问有限的功能</span>
        exp.getValue(context);
    }

    <span class="hljs-comment">/**
     * ✓ 安全：白名单验证
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validatedEvaluation</span><span class="hljs-params">(String userInput)</span> {
        <span class="hljs-comment">// 白名单验证</span>
        <span class="hljs-keyword">if</span> (!isValidExpression(userInput)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"非法表达式"</span>);
        }

        <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();
        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> parser.parseExpression(userInput);
        exp.getValue();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValidExpression</span><span class="hljs-params">(String expr)</span> {
        <span class="hljs-comment">// 只允许简单的属性访问和运算符</span>
        <span class="hljs-keyword">return</span> expr.matches(<span class="hljs-string">"^[a-zA-Z0-9.+\\-*/()\\s]+$"</span>);
    }
}
</code></pre>
<h4 data-id="heading-32">7.2 错误处理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 错误处理最佳实践
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorHandlingDemo</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();

    <span class="hljs-comment">/**
     * 安全的表达式求值
     */</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; Optional&lt;T&gt; <span class="hljs-title function_">safeEvaluate</span><span class="hljs-params">(String expr, Object root, Class&lt;T&gt; type)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Expression</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> parser.parseExpression(expr);
            <span class="hljs-type">T</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> expression.getValue(root, type);
            <span class="hljs-keyword">return</span> Optional.ofNullable(value);

        } <span class="hljs-keyword">catch</span> (ParseException e) {
            <span class="hljs-comment">// 表达式语法错误</span>
            System.err.println(<span class="hljs-string">"表达式解析失败: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> Optional.empty();

        } <span class="hljs-keyword">catch</span> (EvaluationException e) {
            <span class="hljs-comment">// 表达式求值错误</span>
            System.err.println(<span class="hljs-string">"表达式求值失败: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> Optional.empty();

        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 其他错误</span>
            System.err.println(<span class="hljs-string">"未知错误: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> Optional.empty();
        }
    }

    <span class="hljs-comment">/**
     * 带默认值的求值
     */</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">evaluateWithDefault</span><span class="hljs-params">(String expr, Object root,
                                     Class&lt;T&gt; type, T defaultValue)</span> {
        <span class="hljs-keyword">return</span> safeEvaluate(expr, root, type).orElse(defaultValue);
    }
}
</code></pre>
<h3 data-id="heading-33">八、总结</h3>
<h4 data-id="heading-34">核心知识点回顾</h4>
<pre><code class="hljs language-scss" lang="scss">Spring表达式语言(SpEL)核心要点
│
├── 基础语法
│   ├── 字面量表达式
│   ├── 属性访问（含安全导航）
│   ├── 方法调用
│   ├── 运算符
│   ├── 集合操作
│   └── 正则表达式
│
├── Spring集成
│   ├── <span class="hljs-keyword">@Value</span>注解
│   ├── Spring Cache
│   ├── Spring Security
│   └── 事件监听
│
├── 高级特性
│   ├── 自定义函数
│   ├── 变量定义
│   ├── Bean引用
│   └── 类型转换
│
├── 实战应用
│   ├── 动态权限校验
│   ├── 动态查询构建
│   ├── 配置表达式引擎
│   └── 规则引擎
│
└── 最佳实践
    ├── 表达式缓存
    ├── 编译模式
    ├── 安全性控制
    └── 错误处理
</code></pre>
<p>SpEL是Spring框架的重要组成部分，它提供了强大而灵活的表达式计算能力。掌握SpEL不仅能帮助我们更好地使用Spring的各种特性，还能在实际项目中构建动态、可配置的系统。在使用SpEL时，要特别注意安全性问题，避免执行不受信任的表达式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端开发规范]]></title>    <link>https://juejin.cn/post/7575022279568572457</link>    <guid>https://juejin.cn/post/7575022279568572457</guid>    <pubDate>2025-11-22T02:25:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575022279568572457" data-draft-id="7569810118169395215" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端开发规范"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-22T02:25:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="凌晨起床"/> <meta itemprop="url" content="https://juejin.cn/user/3642007770904605"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端开发规范
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3642007770904605/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    凌晨起床
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T02:25:21.000Z" title="Sat Nov 22 2025 02:25:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前端开发规范，涵盖代码细节、工程化、协作流程等维度，结合实际场景补充具体规则和示例。</p>
<h3 data-id="heading-0">一、HTML 规范</h3>
<h4 data-id="heading-1">1. 文档结构与元信息</h4>
<ul>
<li>
<p><strong>DOCTYPE 与命名空间</strong>：必须以 <code>&lt;!DOCTYPE html&gt;</code> 开头，<code>html</code> 标签需指定 <code>lang</code>（如 <code>zh-CN</code> 对应中文，<code>en</code> 对应英文），避免 <code>xmlns</code> 等冗余命名空间（HTML5 已废弃）。</p>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span> <span class="hljs-comment">&lt;!-- 正确 --&gt;</span>
<span class="hljs-comment">&lt;!-- &lt;html lang="zh" xmlns="http://www.w3.org/1999/xhtml"&gt; 错误（冗余xmlns） --&gt;</span>

</code></pre>
</li>
<li>
<p><strong>head 标签顺序</strong>：按「关键优先级」排序：<code>meta charset</code>（必须首行，避免乱码）→ <code>title</code> → <code>meta:viewport</code> → <code>meta</code>（SEO/安全相关）→ <code>link</code>（样式）→ <code>script</code>（异步脚本放底部）。</p>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>首页 - 某某平台<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"keywords"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"前端, 规范"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"description"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"详细的前端开发规范文档"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"IE=edge"</span>&gt;</span> <span class="hljs-comment">&lt;!-- 兼容IE --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"base.css"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-2">2. 语义化深度规范</h4>
<ul>
<li>
<p><strong>细分标签使用场景</strong>：</p>
<ul>
<li>
<p><code>&lt;figure&gt;</code> + <code>&lt;figcaption&gt;</code>：包裹图片/图表+说明（如 <code>figure &gt; img + figcaption</code>）；</p>
</li>
<li>
<p><code>&lt;time&gt;</code>：标记时间（需加 <code>datetime</code> 属性，如 <code>&lt;time datetime="2025-11-08"&gt;2025年11月8日&lt;/time&gt;</code>）；</p>
</li>
<li>
<p><code>&lt;address&gt;</code>：标记联系信息（仅用于页面作者/机构联系方式）；</p>
</li>
<li>
<p><code>&lt;dialog&gt;</code>：标记对话框（配合 <code>open</code> 属性控制显示，如 <code>&lt;dialog open&gt;确认删除？&lt;/dialog&gt;</code>）。</p>
</li>
</ul>
</li>
<li>
<p><strong>表单语义化</strong>：</p>
<ul>
<li>
<p>用 <code>&lt;fieldset&gt;</code> 包裹关联表单元素，<code>&lt;legend&gt;</code> 描述分组标题；</p>
</li>
<li>
<p><code>label</code> 必须通过 <code>for</code> 与 <code>input</code> 的 <code>id</code> 关联（或直接包裹 <code>input</code>），提升点击区域；</p>
</li>
<li>
<p>优先使用语义化输入类型（<code>type="email"</code>/<code>tel</code>/<code>number</code>），而非通用 <code>text</code>。</p>
</li>
</ul>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fieldset</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">legend</span>&gt;</span>用户信息<span class="hljs-tag">&lt;/<span class="hljs-name">legend</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"username"</span>&gt;</span>用户名：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"agree"</span>&gt;</span> 同意协议
      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">fieldset</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-3">3. 性能与兼容性</h4>
<ul>
<li>
<p><strong>避免冗余标签</strong>：不嵌套无意义的父级（如 <code>&lt;div&gt;&lt;span&gt;文本&lt;/span&gt;&lt;/div&gt;</code> 可简化为 <code>&lt;span&gt;文本&lt;/span&gt;</code>，除非有样式需求）。</p>
</li>
<li>
<p><strong>图片优化</strong>：</p>
<ul>
<li>
<p>必加 <code>width</code>/<code>height</code> 属性（避免布局偏移 CLS）；</p>
</li>
<li>
<p>优先使用 <code>webp</code> 格式，配合 <code>picture</code> 标签做降级：</p>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-tag">&lt;<span class="hljs-name">picture</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"image.webp"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/webp"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"image.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"示例图"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"200"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"150"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">picture</span>&gt;</span>
</code></pre>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">二、CSS/SCSS 规范</h3>
<h4 data-id="heading-5">1. 命名体系（BEM 扩展）</h4>
<ul>
<li>
<p><strong>命名空间</strong>：在 BEM 基础上增加前缀，区分组件类型：</p>
<ul>
<li>
<p><code>c-</code>：通用组件（<code>c-button</code>、<code>c-card</code>）；</p>
</li>
<li>
<p><code>m-</code>：模块（<code>m-header</code>、<code>m-footer</code>）；</p>
</li>
<li>
<p><code>u-</code>：工具类（<code>u-mt10</code> 即 <code>margin-top:10px</code>）；</p>
</li>
<li>
<p><code>is-</code>/<code>has-</code>：状态（<code>is-active</code>、<code>has-error</code>）。示例：<code>c-button__icon--large</code>（组件-按钮的图标元素-大尺寸修饰符）。</p>
</li>
</ul>
</li>
<li>
<p><strong>禁止样式污染</strong>：页面级样式需加页面前缀（如 <code>page-home__title</code>），避免影响全局；组件样式通过 CSS Modules 或 scoped（Vue）隔离。</p>
</li>
</ul>
<h4 data-id="heading-6">2. 选择器与权重</h4>
<ul>
<li>
<p><strong>权重优先级</strong>：禁止使用「标签+ID」（<code>div#box</code>）或「多层类嵌套」（<code>.a .b .c .d</code>），权重控制在 <code>(0,2,0)</code> 以内（即最多 2 个类选择器，如 <code>.a.b</code> 或 <code>.a .b</code>）。</p>
</li>
<li>
<p><strong>伪类/伪元素使用</strong>：</p>
<ul>
<li>
<p>伪类（<code>:hover</code>/<code>:focus</code>）用于状态，伪元素（<code>::before</code>/<code>::after</code>）用于装饰性内容（需加 <code>content: ''</code>）；</p>
</li>
<li>
<p>必写 <code>:focus</code> 样式（无障碍要求，如 <code>outline: 2px solid #165DFF</code>）。</p>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-7">3. SCSS 语法规范</h4>
<ul>
<li>
<p><strong>嵌套限制</strong>：最多嵌套 2 层（避免编译后生成冗余选择器）：</p>
<pre><code class="hljs language-SCSS" lang="SCSS"><span class="hljs-selector-class">.c-card</span> {
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>;
    &amp;__title { <span class="hljs-comment">// 1层嵌套</span>
        <span class="hljs-attribute">font-size</span>: <span class="hljs-number">18px</span>;
        &amp;<span class="hljs-attr">--bold</span> { <span class="hljs-comment">// 2层嵌套（允许）</span>
        <span class="hljs-attribute">font-weight</span>: bold;
        }
    }
    <span class="hljs-comment">// &amp;__content .item { 错误（3层嵌套） }</span>
}
</code></pre>
</li>
<li>
<p><strong>变量与混合宏</strong>：</p>
<ul>
<li>
<p>全局变量集中管理（如 <code>_variables.scss</code> 定义 <code>$color-primary: #165DFF</code>）；</p>
</li>
<li>
<p>重复逻辑用 <code>@mixin</code>（带参数），而非复制代码：</p>
<pre><code class="hljs language-SCSS" lang="SCSS"><span class="hljs-keyword">@mixin</span> flex-center {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">justify-content</span>: center;
    <span class="hljs-attribute">align-items</span>: center;
}
<span class="hljs-selector-class">.c-button</span> { <span class="hljs-keyword">@include</span> flex-center; }
</code></pre>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-8">4. 响应式与适配</h4>
<ul>
<li>
<p><strong>断点规范</strong>：统一使用移动优先策略，断点命名与值：</p>
<pre><code class="hljs language-SCSS" lang="SCSS"><span class="hljs-comment">// 从小到大：xs(手机) → sm(平板) → md(小屏桌面) → lg(大屏桌面)</span>
<span class="hljs-variable">$breakpoints</span>: (
  xs: <span class="hljs-number">0</span>,
  sm: <span class="hljs-number">576px</span>,
  md: <span class="hljs-number">768px</span>,
  lg: <span class="hljs-number">1200px</span>
);
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">min-width</span>: map-get(<span class="hljs-variable">$breakpoints</span>, md)) { /\* 中等屏幕样式 \*/ }
</code></pre>
</li>
<li>
<p><strong>单位使用</strong>：</p>
<ul>
<li>
<p>布局尺寸用 <code>rem</code>（根字体默认 16px，1rem=16px）或 <code>vw</code>（移动端）；</p>
</li>
<li>
<p>内边距/边框用 <code>px</code>（避免缩放模糊）；</p>
</li>
<li>
<p>字体大小用 <code>rem</code>（便于全局调整）。</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-9">三、JavaScript/TypeScript 规范（增强版）</h3>
<h4 data-id="heading-10">1. 变量与类型</h4>
<ul>
<li>
<p><strong>类型约束</strong>：优先使用 TypeScript，明确变量类型（避免 <code>any</code>）：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 正确：指定类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">username</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'张三'</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">userList</span>: <span class="hljs-title class_">User</span>\[] = \[{ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span> }];

<span class="hljs-comment">// 错误：隐式any</span>
<span class="hljs-comment">// const data = fetchData(); // 应改为 const data: Data = fetchData();</span>
</code></pre>
</li>
<li>
<p><strong>对象/数组声明</strong>：</p>
<ul>
<li>
<p>用字面量声明（<code>const obj = {}</code> 而非 <code>new Object()</code>）；</p>
</li>
<li>
<p>数组初始化指定类型（<code>const arr: number[] = []</code> 而非 <code>[]</code>）；</p>
</li>
<li>
<p>禁止修改原数组/对象（用 <code>map</code>/<code>filter</code> 替代 <code>for</code> 循环修改，用扩展运算符复制：<code>const newObj = { ...obj }</code>）。</p>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-11">2. 函数设计</h4>
<ul>
<li>
<p><strong>参数规范</strong>：</p>
<ul>
<li>
<p>最多 3 个参数（超过用对象聚合）：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 正确</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getUser</span>(<span class="hljs-params">{ id, name, age }</span>) { <span class="hljs-regexp">/\* ... \*/</span> }
<span class="hljs-title function_">getUser</span>({ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span> });

<span class="hljs-comment">// 错误（参数过多）</span>
<span class="hljs-comment">// function getUser(id, name, age, gender, address) { ... }</span>
</code></pre>
</li>
</ul>
<ul>
<li>必传参数放前，可选参数放后，可选参数用 <code>?</code> 标记（TS）。</li>
</ul>
</li>
<li>
<p><strong>返回值</strong>：</p>
<ul>
<li>
<p>函数必须有返回值（无意义返回 <code>void</code>）；</p>
</li>
<li>
<p>异步函数必须返回 <code>Promise</code>，且明确 resolve/reject 类型。</p>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-12">3. 异步处理</h4>
<ul>
<li>
<p><strong>错误捕获</strong>：</p>
<ul>
<li>
<p><code>async/await</code> 必须用 <code>try/catch</code> 包裹（或用统一错误处理函数）；</p>
</li>
<li>
<p><code>Promise</code> 链式调用必须加 <code>catch</code>，禁止丢失错误：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 正确</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data'</span>);
        <span class="hljs-keyword">return</span> res.<span class="hljs-property">data</span>;
    } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败：'</span>, err);
        <span class="hljs-keyword">throw</span> err; <span class="hljs-comment">// 向上传递错误</span>
    }
}

<span class="hljs-comment">// 错误（未捕获错误）</span>
<span class="hljs-comment">// axios.get('/api/data').then(res =&gt; res.data);</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>并发控制</strong>：</p>
<ul>
<li>
<p>并行请求用 <code>Promise.all</code>（全部成功）或 <code>Promise.allSettled</code>（允许部分失败）；</p>
</li>
<li>
<p>限制并发数（如用 <code>p-limit</code> 库，避免请求风暴）。</p>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-13">4. 模块化与依赖</h4>
<ul>
<li>
<p><strong>导入导出</strong>：</p>
<ul>
<li>
<p>优先用 <code>export default</code> 导出单个组件/类，<code>export</code> 导出工具函数集合；</p>
</li>
<li>
<p>导入路径：相对路径用 <code>./</code>（同目录）、<code>../</code>（父目录），绝对路径配置别名（如 <code>@/utils</code> 指向 <code>src/utils</code>）；</p>
</li>
<li>
<p>禁止循环依赖（A 依赖 B，B 依赖 A）。</p>
</li>
</ul>
</li>
<li>
<p><strong>依赖管理</strong>：</p>
<ul>
<li>
<p>第三方库优先用 <code>peerDependencies</code>（如 UI 组件库），避免重复安装；</p>
</li>
<li>
<p>工具函数优先封装到 <code>utils</code>，避免重复代码（如 <code>formatDate</code>、<code>deepClone</code>）。</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-14">四、工程化与工具链（增强版）</h3>
<h4 data-id="heading-15">1. ESLint + Prettier 配置</h4>
<ul>
<li>
<p><strong>核心规则</strong>（<code>.eslintrc.js</code>）：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
    <span class="hljs-attr">extends</span>: [
        <span class="hljs-string">'eslint:recommended'</span>,
        <span class="hljs-string">'plugin:react/recommended'</span>, <span class="hljs-comment">// React项目</span>
        <span class="hljs-string">'plugin:vue/vue3-essential'</span>, <span class="hljs-comment">// Vue项目</span>
        <span class="hljs-string">'prettier'</span> <span class="hljs-comment">// 关闭与Prettier冲突的规则</span>
    ],
    <span class="hljs-attr">rules</span>: {
        <span class="hljs-string">'no-console'</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'production'</span> ? <span class="hljs-string">'error'</span> : <span class="hljs-string">'warn'</span>, <span class="hljs-comment">// 生产环境禁止console</span>
        <span class="hljs-string">'no-unused-vars'</span>: [<span class="hljs-string">'error'</span>, { <span class="hljs-attr">vars</span>: <span class="hljs-string">'all'</span>, <span class="hljs-attr">args</span>: <span class="hljs-string">'after-used'</span> }], <span class="hljs-comment">// 禁止未使用的变量</span>
        <span class="hljs-string">'indent'</span>: [<span class="hljs-string">'error'</span>, <span class="hljs-number">2</span>, { <span class="hljs-title class_">SwitchCase</span>: <span class="hljs-number">1</span> }], <span class="hljs-comment">// 缩进2空格</span>
        <span class="hljs-string">'quotes'</span>: [<span class="hljs-string">'error'</span>, <span class="hljs-string">'single'</span>], <span class="hljs-comment">// 单引号</span>
        <span class="hljs-string">'semi'</span>: [<span class="hljs-string">'error'</span>, <span class="hljs-string">'always'</span>] <span class="hljs-comment">// 强制分号</span>
    }
};
</code></pre>
</li>
<li>
<p><strong>Prettier 配置</strong>（<code>.prettierrc</code>）：</p>
<pre><code class="hljs language-JSON" lang="JSON"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"printWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 每行最多100字符</span>
    <span class="hljs-attr">"tabWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 制表符宽度2</span>
    <span class="hljs-attr">"singleQuote"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 单引号</span>
    <span class="hljs-attr">"trailingComma"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"all"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 末尾逗号（如数组最后一项）</span>
    <span class="hljs-attr">"arrowParens"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"always"</span> <span class="hljs-comment">// 箭头函数参数必加括号（(x) =&gt; x）</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-16">2. Git 工作流与提交规范</h4>
<ul>
<li>
<p><strong>分支策略</strong>（Git Flow 简化版）：</p>
<ul>
<li>
<p><code>main</code>：生产环境代码，禁止直接提交；</p>
</li>
<li>
<p><code>develop</code>：开发主分支，从 <code>main</code> 创建，用于集成功能；</p>
</li>
<li>
<p><code>feature/xxx</code>：功能分支（从 <code>develop</code> 创建，完成后合并回 <code>develop</code>）；</p>
</li>
<li>
<p><code>fix/xxx</code>：修复分支（从 <code>develop</code> 创建，修复后合并回 <code>develop</code>）；</p>
</li>
<li>
<p><code>release/v1.0.0</code>：发布分支（从 <code>develop</code> 创建，测试通过后合并到 <code>main</code> 和 <code>develop</code>）。</p>
</li>
</ul>
</li>
<li>
<p><strong>提交信息增强</strong>：除基础 <code>type(scope): desc</code> 外，复杂提交需加「详细描述」和「关联issue」：</p>
<pre><code class="hljs language-Plain" lang="Plain">feat(login): 支持手机号验证码登录
*   新增验证码输入框组件

*   集成短信发送API

*   优化登录状态校验逻辑

Close #123（关闭issue 123）

</code></pre>
</li>
</ul>
<h4 data-id="heading-17">3. 构建与部署</h4>
<ul>
<li>
<p><strong>构建优化</strong>：</p>
<ul>
<li>
<p>代码分割（<code>splitChunks</code> 提取公共库，如 <code>react</code>、<code>vue</code>）；</p>
</li>
<li>
<p>树摇（<code>tree-shaking</code> 移除未使用代码，需 ES 模块）；</p>
</li>
<li>
<p>图片压缩（<code>image-webpack-loader</code>）、CSS 提取（<code>mini-css-extract-plugin</code>）。</p>
</li>
</ul>
</li>
<li>
<p><strong>环境区分</strong>：配置 <code>env.development</code>/<code>env.production</code>/<code>env.test</code>，区分 API 地址、日志级别等：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 开发环境</span>
<span class="hljs-variable constant_">VITE</span>\_API\_BASE\_URL = <span class="hljs-string">'/api'</span> <span class="hljs-comment">// 本地代理</span>
<span class="hljs-comment">// 生产环境</span>
<span class="hljs-variable constant_">VITE</span>\_API\_BASE\_URL = <span class="hljs-string">'&lt;https://api.example.com&gt;'</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-18">五、框架特定规范（Vue3 + React）</h3>
<h4 data-id="heading-19">1. Vue3 规范</h4>
<ul>
<li>
<p><strong>单文件组件（SFC）结构</strong>：</p>
<pre><code class="hljs language-Plain" lang="Plain">&lt;template&gt; &lt;!-- 模板 --&gt; &lt;/template&gt;

&lt;script setup lang="ts"&gt; &lt;!-- 逻辑（优先setup语法糖） --&gt; &lt;/script&gt;

&lt;style scoped lang="scss"&gt; &lt;!-- 样式（scoped隔离） --&gt; &lt;/style&gt;
</code></pre>
</li>
<li>
<p><strong>Composition API 规则</strong>：</p>
<ul>
<li>
<p><code>ref</code> 用于基本类型，<code>reactive</code> 用于对象（避免 <code>reactive</code> 包裹基本类型）；</p>
</li>
<li>
<p>自定义钩子以 <code>use</code> 开头（如 <code>useUserInfo</code>）；</p>
</li>
<li>
<p>避免在 <code>template</code> 中直接使用 <code>reactive</code> 对象的属性（用 <code>toRefs</code> 解构）。</p>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-20">2. React 规范</h4>
<ul>
<li>
<p><strong>组件设计</strong>：</p>
<ul>
<li>
<p>优先用函数组件 + Hooks，避免 class 组件；</p>
</li>
<li>
<p>组件拆分：UI 组件（纯展示，如 <code>Button</code>）与容器组件（带逻辑，如 <code>UserListContainer</code>）分离；</p>
</li>
<li>
<p>Hooks 规则：只在顶层调用，只在函数组件中调用（禁止条件判断内使用）。</p>
</li>
</ul>
</li>
<li>
<p><strong>Props 传递</strong>：</p>
<ul>
<li>
<p>用 <code>interface</code> 定义 Props 类型（TS）；</p>
</li>
<li>
<p>非必要不传递 <code>children</code>（避免深层嵌套）；</p>
</li>
<li>
<p>大量 Props 用解构传递（<code>&lt;User {...userProps} /&gt;</code>）。</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-21">六、无障碍性（A11y）与性能</h3>
<h4 data-id="heading-22">1. 无障碍性</h4>
<ul>
<li>
<p><strong>ARIA 属性</strong>：</p>
<ul>
<li>
<p>动态内容用 <code>aria-live</code>（如通知：<code>&lt;div aria-live="polite"&gt;新消息&lt;/div&gt;</code>）；</p>
</li>
<li>
<p>表单错误提示关联 <code>aria-describedby</code>（如 <code>&lt;input aria-describedby="error-msg"&gt;</code>）。</p>
</li>
</ul>
</li>
<li>
<p><strong>键盘导航</strong>：所有交互元素（按钮、菜单）必须可通过 Tab 聚焦，且有明显焦点样式（<code>outline</code> 或自定义样式）。</p>
</li>
</ul>
<h4 data-id="heading-23">2. 性能优化</h4>
<ul>
<li>
<p><strong>渲染优化</strong>：</p>
<ul>
<li>
<p>避免频繁重排（如批量修改 DOM 前先脱离文档流）；</p>
</li>
<li>
<p>Vue 用 <code>v-memo</code> 缓存静态节点，React 用 <code>React.memo</code>/<code>useMemo</code> 缓存组件/值。</p>
</li>
</ul>
</li>
<li>
<p><strong>资源加载</strong>：</p>
<ul>
<li>
<p>非首屏 JS 用 <code>dynamic import</code> 懒加载（<code>import('./HeavyComponent')</code>）；</p>
</li>
<li>
<p>图片用 <code>loading="lazy"</code> 懒加载（<code>&lt;img src="large.jpg" loading="lazy"&gt;</code>）。</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-24">七、协作与代码审查</h3>
<ul>
<li>
<p><strong>Code Review  checklist</strong>：</p>
<ol>
<li>
<p>代码是否符合规范（命名、格式、注释）；</p>
</li>
<li>
<p>逻辑是否清晰（是否有冗余/重复代码）；</p>
</li>
<li>
<p>边界情况是否处理（空值、异常、大数）；</p>
</li>
<li>
<p>性能是否有优化空间（是否有不必要的 DOM 操作/请求）；</p>
</li>
<li>
<p>是否包含测试用例（核心逻辑需覆盖）。</p>
</li>
</ol>
</li>
<li>
<p><strong>冲突处理</strong>：拉取代码前先 <code>pull</code> 最新 <code>develop</code> 分支，解决冲突时保留双方合理逻辑，避免暴力覆盖。</p>
</li>
</ul>
<h3 data-id="heading-25">总结</h3>
<p>规范的核心是「共识」与「落地」：</p>
<ol>
<li>
<p>团队需共同制定规范（避免一刀切，保留合理灵活性）；</p>
</li>
<li>
<p>用工具（ESLint、husky 等）自动化约束，减少人工成本；</p>
</li>
<li>
<p>定期复盘迭代（根据项目反馈调整规则）。</p>
</li>
</ol>
<p>通过细化规范，可显著降低沟通成本，提升代码可维护性，尤其适合多人协作的中大型项目。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不用记复杂路径！3 步让你的 JS 脚本像 “vue create” 一样好用]]></title>    <link>https://juejin.cn/post/7575047994681229363</link>    <guid>https://juejin.cn/post/7575047994681229363</guid>    <pubDate>2025-11-22T02:44:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575047994681229363" data-draft-id="7575017581037142054" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不用记复杂路径！3 步让你的 JS 脚本像 “vue create” 一样好用"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-22T02:44:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="欧阳的棉花糖"/> <meta itemprop="url" content="https://juejin.cn/user/958429872784541"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不用记复杂路径！3 步让你的 JS 脚本像 “vue create” 一样好用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/958429872784541/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    欧阳的棉花糖
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T02:44:47.000Z" title="Sat Nov 22 2025 02:44:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、开篇：为什么别人的命令能直接用？</h2>
<p>日常开发中，你可能会有这样的疑问：为什么输入 <code>vue create</code> 就能快速创建项目，而自己写的 JavaScript 脚本，每次都要敲长长的 <code>node ./xxx/xxx.js</code> 才能运行？其实，这背后藏着 <code>package.json</code> 里 <code>bin</code> 命令的 “小秘密”。</p>
<p>这篇文章就用最直白的方式，带你搞清楚 <code>bin</code> 命令、shebang 以及 <code>npm link</code> 的作用和用法，看完之后，你也能让自己的脚本像那些常用工具一样，一键就能运行。</p>
<h2 data-id="heading-1">二、package.json 的 bin 命令：让脚本 “一键启动”</h2>
<h3 data-id="heading-2">1. 什么是 bin 命令？</h3>
<p>简单来说，bin 命令就是给你的 JavaScript 脚本起一个 “简短别名”。有了这个别名，你不用再输入完整的脚本路径，直接喊出 “别名”，就能运行对应的脚本。</p>
<p>比如原本需要输入 <code>node ./bin/my-script.js</code> 才能执行的脚本，配置 bin 命令后，可能只需要输入 <code>my-script</code> 就能运行，大大减少了重复输入的麻烦。</p>
<h3 data-id="heading-3">2. 如何配置 bin 命令？</h3>
<p>bin 命令的配置很灵活，主要分两种情况，根据你的脚本数量来选择即可：</p>
<h4 data-id="heading-4">情况一：只有一个脚本（简单写法）</h4>
<p>如果你的项目里只有一个需要便捷运行的脚本，直接在 <code>package.json</code> 中写脚本的相对路径就行。这时，脚本的 “别名” 会默认和你项目的 “name” 字段一致（也就是 <code>package.json</code> 里 <code>"name": "xxx"</code> 中的 xxx）。</p>
<p>举个例子：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>

&amp;#x20; <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-tool"</span><span class="hljs-punctuation">,</span>

&amp;#x20; <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>

&amp;#x20; <span class="hljs-attr">"bin"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./bin/my-script.js"</span>

<span class="hljs-punctuation">}</span>
</code></pre>
<p>上面的配置中，脚本 <code>./bin/my-script.js</code> 的别名就是 <code>my-tool</code>，后续直接输入 <code>my-tool</code> 就能运行这个脚本。</p>
<h4 data-id="heading-5">情况二：多个脚本（对象写法）</h4>
<p>如果项目里有多个需要便捷运行的脚本，就用对象的形式配置，键是你想给脚本起的 “别名”，值是脚本的相对路径。</p>
<p>举个例子：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>

&amp;#x20; <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-tool"</span><span class="hljs-punctuation">,</span>

&amp;#x20; <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>

&amp;#x20; <span class="hljs-attr">"bin"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>

&amp;#x20;   <span class="hljs-attr">"script-one"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./bin/1.js"</span><span class="hljs-punctuation">,</span>

&amp;#x20;   <span class="hljs-attr">"script-two"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./bin/2.js"</span>

&amp;#x20; <span class="hljs-punctuation">}</span>

<span class="hljs-punctuation">}</span>
</code></pre>
<p>这样配置后，输入 <code>script-one</code> 就能运行 <code>./bin/1.js</code>，输入 <code>script-two</code> 就能运行 <code>./bin/2.js</code>，清晰又好记。</p>
<p>需要注意的是，脚本路径要从 <code>package.json</code> 所在的文件夹开始计算，比如 <code>package.json</code> 在项目根目录，脚本在根目录下的 <code>bin</code> 文件夹里，路径就写 <code>./bin/xxx.js</code>，别写错了路径导致脚本找不到。</p>
<h3 data-id="heading-6">3. 配置完 bin 还不够，必须加 “shebang”</h3>
<p>很多人配置完 bin 命令后，运行时会遇到 “命令未找到” 或 “无法执行脚本” 的错误，这大概率是因为没加 “shebang”。</p>
<h4 data-id="heading-7">为什么需要 shebang？</h4>
<p>简单来说，shebang 是告诉系统 “用什么程序来运行这个脚本”。如果没有它，系统不知道该用 Node.js 还是其他程序来执行你的 JavaScript 脚本，自然会报错。</p>
<h4 data-id="heading-8">什么是 shebang？怎么加？</h4>
<p>shebang 就是在你的 JavaScript 脚本文件的第一行，加上 <code>#!/usr/bin/env node</code> 这行代码。不用纠结这行代码的具体含义，直接复制粘贴到脚本第一行就行，它能兼容不同的电脑系统。</p>
<p>举个例子，你的脚本文件 <code>./bin/my-script.js</code> 应该长这样：</p>
<pre><code class="hljs language-javascript" lang="javascript">\#!<span class="hljs-regexp">/usr/</span>bin/env node

<span class="hljs-comment">// 下面是你的脚本逻辑</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"脚本运行成功！"</span>);
</code></pre>
<h4 data-id="heading-9">为什么不能写死路径？</h4>
<p>有些资料里可能会写 <code>#!/usr/bin/node</code>，但这种写法有个坑：它假设 Node.js 一定安装在 <code>/usr/bin</code> 这个路径下。但实际中，很多人会用 nvm（Node.js 版本管理器）来管理 Node.js，这时 Node.js 的安装路径可能是 <code>~/.nvm/versions/node/xxx/bin</code>，或者 Windows 系统里的 <code>C:\Program Files\nodejs</code>。写死路径的话，换一台电脑可能就无法运行了，而 <code>#!/usr/bin/env node</code> 会让系统自动寻找 Node.js 的安装路径，避免这个问题。</p>
<h3 data-id="heading-10">4. 动手实操：3 步跑通自己的命令</h3>
<p>看完理论，咱们来动手试一次，3 步就能让你的脚本实现 “一键运行”：</p>
<h4 data-id="heading-11">第一步：建文件夹和文件</h4>
<p>先建一个项目文件夹，比如叫 <code>my-first-cli</code>，在里面新建两个东西：</p>
<ul>
<li>
<p>一个 <code>package.json</code> 文件（可以用 <code>npm init -y</code> 快速生成）；</p>
</li>
<li>
<p>一个 <code>bin</code> 文件夹，在 <code>bin</code> 文件夹里新建 <code>cli.js</code> 文件（这就是你的脚本文件）。</p>
</li>
</ul>
<p>此时项目结构应该是这样：</p>
<pre><code class="hljs language-go" lang="go">my-first-cli/

├── bin/

│   └── cli.js

└── <span class="hljs-keyword">package</span>.json
</code></pre>
<h4 data-id="heading-12">第二步：写脚本内容</h4>
<p>打开 <code>bin/cli.js</code>，在第一行加上 shebang，再写点简单的逻辑，比如：</p>
<pre><code class="hljs language-javascript" lang="javascript">\#!<span class="hljs-regexp">/usr/</span>bin/env node

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"我的第一个便捷脚本，运行成功啦！"</span>);
</code></pre>
<h4 data-id="heading-13">第三步：配置 package.json 的 bin 命令</h4>
<p>打开 <code>package.json</code>，加上 bin 配置，比如：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>

&amp;#x20; <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-first-cli"</span><span class="hljs-punctuation">,</span>

&amp;#x20; <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>

&amp;#x20; <span class="hljs-attr">"bin"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>

&amp;#x20;   <span class="hljs-attr">"my-test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./bin/cli.js"</span>

&amp;#x20; <span class="hljs-punctuation">}</span>

<span class="hljs-punctuation">}</span>
</code></pre>
<p>这里我们给脚本起的别名是 <code>my-test</code>，后续输入这个别名就能运行脚本。</p>
<h2 data-id="heading-14">三、shebang 详解：脚本的 “运行说明书”</h2>
<h3 data-id="heading-15">1. 再深入理解：shebang 到底是什么？</h3>
<p>前面我们知道了 shebang 是 <code>#!/usr/bin/env node</code>，但它本质上是 Unix/Linux 系统的一个通用规则 —— 只要脚本文件的第一行以 <code>#!</code> 开头，这行就是 shebang，用来指定执行这个脚本的程序。</p>
<p>对 JavaScript 脚本来说，shebang 就是告诉系统 “用 Node.js 来运行我”，相当于给脚本加了一份 “运行说明书”。需要注意的是，它不是注释，而是给系统看的指令，别把它删掉或放到其他行。</p>
<h3 data-id="heading-16">2. 为什么 <code>#!/usr/bin/env node</code> 能兼容所有系统？</h3>
<p>这里拆解一下 <code>#!/usr/bin/env node</code> 的作用：</p>
<ul>
<li>
<p><code>#!/usr/bin/env</code>：<code>env</code> 是系统自带的一个工具，它能读取系统的 PATH 环境变量（PATH 里包含了系统所有可执行程序的安装目录）；</p>
</li>
<li>
<p><code>node</code>：<code>env</code> 会在 PATH 包含的目录里，找第一个名叫 <code>node</code> 的可执行文件，找到后就用这个 Node.js 来运行脚本。</p>
</li>
</ul>
<p>不管你的 Node.js 装在 <code>~/.nvm</code>、<code>C盘</code> 还是其他路径，<code>env</code> 都能找到它，所以这行代码能兼容 Windows、macOS、Linux 等不同系统。</p>
<h3 data-id="heading-17">3. Windows 用户不用慌，shebang 兼容问题已解决</h3>
<p>很多 Windows 用户会担心：Windows 系统不认识 shebang，会不会影响脚本运行？其实不用怕，npm 和 npx 已经帮我们处理了这个问题。</p>
<p>当你在 Windows 上运行通过 bin 命令配置的脚本时，npm 会自动忽略 shebang，直接用你电脑里当前的 Node.js 来执行脚本，所以不用额外做任何配置，和其他系统一样正常使用。</p>
<h3 data-id="heading-18">4. 不止 Node.js，其他脚本也用 shebang</h3>
<p>shebang 不是 Node.js 专属的，其他类型的脚本也会用它来指定运行程序。比如：</p>
<ul>
<li>
<p>Shell 脚本（.sh 文件）：第一行通常是 <code>#!/bin/bash</code>，表示用 bash 程序来运行；</p>
</li>
<li>
<p>Python 脚本（.py 文件）：第一行通常是 <code>#!/usr/bin/env python3</code>，表示用 Python3 来运行；</p>
</li>
<li>
<p>Perl 脚本（.pl 文件）：第一行通常是 <code>#!/usr/bin/perl</code>，表示用 Perl 来运行。</p>
</li>
</ul>
<p>了解这个知识点，以后看到其他类型的脚本，也能明白第一行代码的作用。</p>
<h2 data-id="heading-19">四、npm link：本地测试的 “神器”，不用反复装包</h2>
<h3 data-id="heading-20">1. 为什么需要 npm link？</h3>
<p>当你写完脚本并配置好 bin 命令后，肯定想测试一下能不能正常运行。如果每次修改代码后，都要先把项目发布到 npm 仓库，再用 <code>npm install -g</code> 安装到全局来测试，那也太麻烦了 —— 这时候，<code>npm link</code> 就能派上用场。</p>
<h3 data-id="heading-21">2. 什么是 npm link？</h3>
<p>简单来说，<code>npm link</code> 是给你本地的项目创建一个 “快捷方式”，并把这个快捷方式链接到系统的全局 npm 目录里。这样一来，你不用发布项目，也不用反复安装，就能像使用 “已发布到 npm 仓库的工具” 一样，在任何目录下运行你的脚本，而且修改代码后，效果会实时生效，不用重新配置。</p>
<h3 data-id="heading-22">3. 动手实操：2 步用 npm link 测试命令</h3>
<p>还是用前面的 <code>my-first-cli</code> 项目举例，2 步就能完成测试：</p>
<h4 data-id="heading-23">第一步：把项目链接到全局</h4>
<p>打开终端，进入 <code>my-first-cli</code> 文件夹（也就是 <code>package.json</code> 所在的目录），输入命令：</p>
<pre><code class="hljs language-bash" lang="bash">npm <span class="hljs-built_in">link</span>
</code></pre>
<p>执行完后，系统会提示 “链接成功”，此时你的 <code>my-test</code> 命令已经被添加到全局了。</p>
<h4 data-id="heading-24">第二步：测试命令</h4>
<p>不用停留在 <code>my-first-cli</code> 文件夹，随便找一个其他目录（比如你的桌面），在终端输入：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">my</span>-test
</code></pre>
<p>如果看到输出 “我的第一个便捷脚本，运行成功啦！”，就说明测试成功了。</p>
<p>如果后续修改了 <code>bin/cli.js</code> 里的代码，比如把输出改成 “脚本更新啦！”，不用重新执行 <code>npm link</code>，直接在终端再次输入 <code>my-test</code>，就能看到更新后的效果，非常方便。</p>
<h3 data-id="heading-25">4. npm link 不止能测命令，还有 2 个常用场景</h3>
<p><code>npm link</code> 不止用来测试 bin 命令，在本地开发中还有两个非常实用的场景：</p>
<h4 data-id="heading-26">场景一：本地两个项目互相依赖</h4>
<p>比如你有两个项目：</p>
<ul>
<li>
<p>项目 A：是一个工具包（比如叫 <code>utils-package</code>），里面有一些常用的工具函数；</p>
</li>
<li>
<p>项目 B：是一个业务项目，需要用到项目 A 里的工具函数。</p>
</li>
</ul>
<p>如果直接在项目 B 里用 <code>npm install ../utils-package</code> 安装项目 A，每次项目 A 的代码修改后，都要重新安装才能在项目 B 里看到更新，很麻烦。这时候用 <code>npm link</code> 就能解决：</p>
<ol>
<li>
<p>进入项目 A 的文件夹，执行 <code>npm link</code>，把项目 A 链接到全局；</p>
</li>
<li>
<p>进入项目 B 的文件夹，执行 <code>npm link utils-package</code>（<code>utils-package</code> 是项目 A 的 <code>package.json</code> 里的 “name” 字段）；</p>
</li>
</ol>
<p>这样一来，项目 B 里就能像使用普通 npm 包一样，用 <code>require('utils-package')</code> 引入项目 A 的代码，而且项目 A 的代码修改后，项目 B 里能实时看到更新，不用反复安装。</p>
<h4 data-id="heading-27">场景二：调试已安装的依赖包</h4>
<p>有时候你在项目里使用某个 npm 包（比如 lodash），发现某个功能有问题，想修改这个包的源码来调试（当然pnpm有更优雅的解决方案）。这时候也能用到 <code>npm link</code>：</p>
<ol>
<li>
<p>先从 GitHub 上下载这个包的源码（比如 lodash 的源码），解压后进入源码文件夹，执行 <code>npm link</code>，把修改后的源码链接到全局；</p>
</li>
<li>
<p>进入你的项目文件夹，执行 <code>npm link lodash</code>，把项目里的 lodash 替换成你本地修改后的源码；</p>
</li>
<li>
<p>调试完成后，再执行 <code>npm unlink lodash</code>，并重新执行 <code>npm install lodash</code>，恢复成官方的包即可。</p>
</li>
</ol>
<h3 data-id="heading-28">5. 用完记得 “取消链接”，避免影响后续使用</h3>
<p>当你测试完或者不再需要本地链接时，记得取消链接，避免本地的测试版本影响后续使用官方版本。</p>
<p>取消链接分两步：</p>
<ol>
<li>
<p>进入你之前执行 <code>npm link</code> 的项目文件夹（比如 <code>my-first-cli</code>），执行 <code>npm unlink</code>，取消项目到全局的链接；</p>
</li>
<li>
<p>如果其他项目链接过这个项目（比如前面的项目 B 链接过项目 A），还要进入这些项目文件夹，执行 <code>npm unlink 包名</code>（比如 <code>npm unlink utils-package</code>），取消项目间的链接。</p>
</li>
</ol>
<p>比如取消 <code>my-first-cli</code> 的链接：</p>
<pre><code class="hljs language-bash" lang="bash">\<span class="hljs-comment"># 进入 my-first-cli 文件夹</span>

<span class="hljs-built_in">cd</span> my-first-cli

\<span class="hljs-comment"># 取消全局链接</span>

npm <span class="hljs-built_in">unlink</span>
</code></pre>
<h2 data-id="heading-29">五、总结：3 个核心知识点要记牢</h2>
<ol>
<li>
<p><strong>bin 命令</strong>：给 JavaScript 脚本起 “简短别名”，配置后不用输完整路径，直接喊别名就能运行脚本，配置时注意路径别写错；</p>
</li>
<li>
<p><strong>shebang</strong>：脚本第一行的 <code>#!/usr/bin/env node</code>，告诉系统用 Node.js 运行脚本，别写死路径，兼容所有系统；</p>
</li>
<li>
<p><strong>npm link</strong>：本地测试和开发的 “神器”，能创建项目快捷方式，实现代码实时更新，不用反复安装，用完记得取消链接。</p>
</li>
</ol>
<h2 data-id="heading-30">六、结尾：动手试试，一次就会</h2>
<p>看完这篇文章，建议你动手实操一次：建一个简单的项目，配置 bin 命令、加 shebang、用 npm link 测试。过程中如果遇到报错，先检查三个地方：脚本路径对不对、shebang 加没加、link 有没有成功。</p>
<p>其实这些知识点都不复杂，关键是多动手，试一次就能完全掌握，以后开发脚本或工具时，就能像那些常用的 npm 包一样，实现 “一键运行”，大大提升开发效率。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何快速实现响应式多屏幕适配]]></title>    <link>https://juejin.cn/post/7574997924930601000</link>    <guid>https://juejin.cn/post/7574997924930601000</guid>    <pubDate>2025-11-22T03:13:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574997924930601000" data-draft-id="7575015480198905908" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何快速实现响应式多屏幕适配"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-22T03:13:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MQliferecord"/> <meta itemprop="url" content="https://juejin.cn/user/1139543665814600"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何快速实现响应式多屏幕适配
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1139543665814600/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MQliferecord
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T03:13:15.000Z" title="Sat Nov 22 2025 03:13:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>项目涉及的场景比较简单，所以我个人的配置也比较粗糙简单，如果要对于更详细的多端适配，可能需要更细致的设定，如果希望一键快速实现大体上过得去的pc端多端适配，可以用这个法子。</p>
<ol>
<li>安装postcss(必须)+tailwindcss(可选)</li>
<li>安装postcss-plugin-px2rem(必须)</li>
<li><del>在豆包搜索postcss-plugin-px2rem如何配置应用</del>在postcss.config.js文件里面按需配置（关键）</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-built_in">require</span>(<span class="hljs-string">'postcss-plugin-px2rem'</span>)({
      <span class="hljs-attr">rootValue</span>: <span class="hljs-number">16</span>, <span class="hljs-comment">// 根元素字体大小（默认 16px，即 1rem = 16px）</span>
      <span class="hljs-attr">unitPrecision</span>: <span class="hljs-number">5</span>, <span class="hljs-comment">// 转换后的 rem 保留小数位数（默认 5）</span>
      <span class="hljs-attr">propList</span>: [<span class="hljs-string">'*'</span>], <span class="hljs-comment">// 需要转换的 CSS 属性（默认 ['*']，即所有属性）</span>
      <span class="hljs-attr">selectorBlackList</span>: [], <span class="hljs-comment">// 不转换的选择器（如 ['body']，则 body 下的 px 不转换）</span>
      <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否直接替换原 px 值（默认 true，不保留原 px）</span>
      <span class="hljs-attr">mediaQuery</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 是否转换媒体查询中的 px（默认 false，不转换）</span>
      <span class="hljs-attr">minPixelValue</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 最小转换像素值（默认 0，即所有 px 都转换）</span>
      <span class="hljs-attr">exclude</span>: <span class="hljs-regexp">/node_modules/i</span> <span class="hljs-comment">// 排除的文件路径（如 node_modules 下的样式不转换）</span>
    })
  ]
}
</code></pre>
<p>后续需要详细配置的话，需要关注的两个属性</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">selectorBlackList</span>: [], 
<span class="hljs-attr">mediaQuery</span>: <span class="hljs-literal">false</span>, 
</code></pre>
<ol start="4">
<li>在App.vue 文件下添加(关键)</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">setRootFontSize</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> screenWidth = <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">clientWidth</span>;
  <span class="hljs-keyword">const</span> rootFontSize = screenWidth / <span class="hljs-number">7.5</span>; 
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">fontSize</span> = <span class="hljs-string">`<span class="hljs-subst">${rootFontSize}</span>px`</span>;
}

<span class="hljs-title function_">setRootFontSize</span>();
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, setRootFontSize);
</code></pre>
<p>这里因为我们项目主要是大屏和超大屏工作，所以我针对我们的项目具体应用场景做了一下更改</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">setRootFontSize</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> screenWidth = <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">clientWidth</span>;
  <span class="hljs-keyword">if</span>(screenWidth&lt;<span class="hljs-number">1560</span>){
      <span class="hljs-keyword">const</span> rootFontSize = screenWidth / <span class="hljs-number">75</span>; 
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">fontSize</span> = <span class="hljs-string">`<span class="hljs-subst">${rootFontSize}</span>px`</span>;
  }
}

</code></pre>
<p>具体原理搜索rem是什么意思就行了</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从回调到async/await：JavaScript异步编程的进化之路]]></title>    <link>https://juejin.cn/post/7575006095389474825</link>    <guid>https://juejin.cn/post/7575006095389474825</guid>    <pubDate>2025-11-22T03:28:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575006095389474825" data-draft-id="7575047994681262131" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从回调到async/await：JavaScript异步编程的进化之路"/> <meta itemprop="keywords" content="JavaScript,面试,前端"/> <meta itemprop="datePublished" content="2025-11-22T03:28:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xiaoxue_"/> <meta itemprop="url" content="https://juejin.cn/user/4065372122398027"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从回调到async/await：JavaScript异步编程的进化之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4065372122398027/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xiaoxue_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T03:28:14.000Z" title="Sat Nov 22 2025 03:28:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从回调到async/await：JavaScript异步编程的进化之路</h2>
<p>在JavaScript的世界里，异步编程是绕不开的核心命题。从最初的回调函数，到ES6的Promise，再到ES8的async/await，每一次语法升级都在解决前一阶段的痛点，让异步代码更贴近人类的线性思维。本文将结合文件读取的实际案例，带你看清JavaScript异步编程的进化脉络。</p>
<h3 data-id="heading-1">一、ES6之前：回调函数的“地狱”与坚守</h3>
<p>在ES6引入Promise之前，JavaScript处理异步操作的唯一方案就是回调函数。其核心逻辑是：将异步操作完成后需要执行的代码，作为参数传入异步函数，当异步任务结束时，由JavaScript引擎自动调用这个回调函数。</p>
<p>以文件读取API <code>fs.readFile</code> 为例，传统回调写法如下：</p>
<pre><code class="hljs language-javascript" lang="javascript">fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'./1.html'</span>,<span class="hljs-string">'utf-8'</span>,<span class="hljs-function">(<span class="hljs-params">err,data</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span>(err) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err);
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">111</span>);
})
</code></pre>
<p>这种写法的优势是直观易懂，对于单一异步任务完全够用。但它的缺陷也极为明显：当多个异步任务存在依赖关系时，代码会嵌套成“回调地狱”。比如先读A文件，再根据A文件内容读B这段回调函数代码是ES6之前的主流异步写法，核心依赖Node.js的<code>fs</code>模块（文件系统模块）实现文件读取。我们从API参数到执行逻辑逐行拆解：</p>
<p><code>fs.readFile('./1.html','utf-8',(err,data) =&gt; { ... })</code> 中，<code>fs.readFile</code> 作为异步读取方法，接收三个关键参数：第一个参数<code>'./1.html'</code>是文件路径，指定读取当前目录下的1.html文件；第二个参数<code>'utf-8'</code>是编码格式，确保读取的二进制数据转为字符串而非Buffer对象；第三个参数是回调函数，这是异步的核心——JS引擎不会等待文件读取完成，而是继续执行后续代码，读取结束后自动调用此函数处理结果。</p>
<p>回调函数遵循“错误优先”规范，<code>err</code>参数优先接收错误信息：若读取失败（如文件不存在），<code>err</code>为错误对象，执行<code>console.log(err)</code>打印错误并通过<code>return</code>终止函数；若成功，<code>err</code>为null，<code>data</code>接收文件内容，随后打印内容与数字111。</p>
<p>这种写法对单一异步任务足够简洁，但多任务依赖时会陷入“回调地狱”。比如读完1.html后需根据内容读2.html，代码会嵌套成多层缩进，可读性与维护性急剧下降，这也催生了ES6的Promise方案。</p>
<h3 data-id="heading-2">二、ES6 Promise：异步流程的“标准化”升级</h3>
<p>Promise是ES6为解决回调地狱推出的异步容器，它将异步操作的“成功/失败”状态标准化，通过链式调用替代嵌套。Promise封装代码，正是对文件读取异步任务的规范化改造：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// es6 Promise</span>
<span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>) =&gt;</span> {
    fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'./1.html'</span>, <span class="hljs-string">'utf-8'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (err) {
            <span class="hljs-title function_">reject</span>(err); <span class="hljs-comment">// 异步失败，传递错误</span>
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-title function_">resolve</span>(data); <span class="hljs-comment">// 异步成功，传递结果</span>
    })
})
 p.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">111</span>);
})
</code></pre>
<p>Promise构造函数接收一个“执行器函数”，该函数有两个内置参数<code>resolve</code>和<code>reject</code>，均为函数：<code>resolve</code>用于标记异步成功，将结果数据传递给后续处理；<code>reject</code>用于标记失败，传递错误信息。</p>
<p>上述代码中，文件读取的回调逻辑被重构：失败时调用<code>reject(err)</code>，成功时调用<code>resolve(data)</code>，Promise实例<code>p</code>便承载了异步任务的状态。<code>p.then(data =&gt; { ... })</code>是结果处理方式，<code>then</code>方法接收<code>resolve</code>传递的数据，实现成功逻辑。若需处理错误，可链式调用<code>.catch(err =&gt; { ... })</code>捕获<code>reject</code>的错误。</p>
<p>Promise的核心优势是链式调用。若需连续读取两个文件，只需在第一个<code>then</code>中返回新的Promise，再链式调用<code>then</code>即可，代码始终保持扁平，彻底摆脱嵌套困境。但多个链式调用时，“then链”仍会略显冗余，ES8的async/await在此基础上实现了进一步优化。</p>
<h3 data-id="heading-3">三、ES8 async/await：异步代码的“同步化”终极方案</h3>
<p>async/await是ES8推出的Promise语法糖，它让异步代码具备同步代码的线性逻辑，堪称异步编程的“终极形态”。async/await基于前文的Promise实例实现，大幅简化了结果获取逻辑：</p>
<pre><code class="hljs language-ini" lang="ini">// es8 async
const <span class="hljs-attr">main</span> = async() =&gt; {
    const <span class="hljs-attr">html</span> = await p<span class="hljs-comment">;</span>
    console.log(html)<span class="hljs-comment">;</span>
}
main()<span class="hljs-comment">;</span>
</code></pre>
<p>这段代码的核心是两个关键字的配合：<code>async</code>用于修饰函数（如这里的<code>main</code>函数），表明该函数是异步函数，其返回值必然是Promise；<code>await</code>只能在<code>async</code>函数内使用，用于等待Promise完成——它会“暂停”函数执行，直到Promise状态变为成功（fulfilled），再将<code>resolve</code>的数据赋值给左侧变量（如<code>html</code>）。</p>
<p>需要补充的是，实际开发中需完善错误处理：若Promise状态为失败（rejected），<code>await</code>会抛出异常，需用<code>try/catch</code>捕获，优化后的代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">main</span> = <span class="hljs-keyword">async</span>(<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> html = <span class="hljs-keyword">await</span> p;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(html);
    } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'错误：'</span>, err); <span class="hljs-comment">// 捕获reject的错误</span>
    }
}
<span class="hljs-title function_">main</span>();
</code></pre>
<p>async/await的价值不仅在于简洁，更在于逻辑贴近人类思维。比如连续执行三个异步任务，只需用三个<code>await</code>依次等待，代码顺序与任务执行顺序完全一致，无需关注Promise的链式调用细节。</p>
<h3 data-id="heading-4">四、进化总结：从工具到思维的贴近</h3>
<p>回顾JavaScript异步的进化之路，每一步都是对“开发体验”的优化：回调函数是异步的基础工具，却违背线性思维；Promise通过标准化容器规范异步流程，解决嵌套问题；async/await则彻底抹平异步与同步的语法差异，让代码逻辑与人类思考顺序完全统一。</p>
<p>实际开发中无需拘泥于单一方案：简单异步任务可用回调；多任务依赖优先用Promise链式调用；复杂业务逻辑则首选async/await，兼顾可读性与维护性。理解三者的关联与演进逻辑，才能根据场景灵活选择最合适的异步方案，写出高效优雅的JavaScript代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OkHttp 深度解析(一) : 从一次完整请求看 OkHttp 整体架构]]></title>    <link>https://juejin.cn/post/7575017581036732454</link>    <guid>https://juejin.cn/post/7575017581036732454</guid>    <pubDate>2025-11-21T16:25:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575017581036732454" data-draft-id="7574725286530678835" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OkHttp 深度解析(一) : 从一次完整请求看 OkHttp 整体架构"/> <meta itemprop="keywords" content="OKHttp,Android"/> <meta itemprop="datePublished" content="2025-11-21T16:25:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Entropless"/> <meta itemprop="url" content="https://juejin.cn/user/3518885279826078"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OkHttp 深度解析(一) : 从一次完整请求看 OkHttp 整体架构
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3518885279826078/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Entropless
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T16:25:17.000Z" title="Fri Nov 21 2025 16:25:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-cave-dark">.hljs-comment,.hljs-quote{color:#7e7887}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#be4678}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa573c}.hljs-bullet,.hljs-string,.hljs-symbol{color:#2a9292}.hljs-section,.hljs-title{color:#576ddb}.hljs-keyword,.hljs-selector-tag{color:#955ae7}.hljs-addition,.hljs-deletion{color:#19171c;display:inline-block;width:100%}.hljs-deletion{background-color:#be4678}.hljs-addition{background-color:#2a9292}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#19171c;color:#8b8792}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是 OkHttp 深度解析系列文章</p>
<p><a href="https://juejin.cn/spost/7575017581036732454" target="_blank" title="https://juejin.cn/spost/7575017581036732454">OkHttp深度解析(一) : 从一次完整请求看 OkHttp整体架构</a></p>
<p><a href="https://juejin.cn/post/7575031395861446702" target="_blank" title="https://juejin.cn/post/7575031395861446702">OkHttp深度解析(二) : OkHttpClient 你没见过的那些属性</a></p>
<p><a href="https://juejin.cn/post/7575006095389097993" target="_blank" title="https://juejin.cn/post/7575006095389097993">OkHttp深度解析(三) : 拦截器？连接复用&amp;合并？Http2?</a></p>
<h2 data-id="heading-0">前言</h2>
<p>OkHttp 是一个非常优秀的网络请求框架，几乎每个 Android 开发人员应该都使用过它。</p>
<p>本文深入介绍了 Okhttp 的整体框架结构，OkhttpClient重点属性深度解释，并且<strong>深度分析</strong>了<strong>一次完整的的 Http 请求在Okhttp中是如何实现的</strong>，我个人习惯系统性了解一项技术而不是单纯的罗列源码通篇讲解，因为只有建立出系统，才能理解的更透彻，这样记忆会非常深刻。因此我侧重使用画图的方式来分析 Okhttp（只有关键源码），<strong>图是重点</strong>，文字是辅助（画图好纍😅）。</p>
<p>这篇文章应该是你从未见过的OkHttp 全流程网络请求的深入解读，它同时也可能解惑你在其它博客中找不到答案的疑问。</p>
<h2 data-id="heading-1">OkHttp 发展背景</h2>
<ul>
<li>
<p>诞生背景</p>
<p>在OkHttp出现之前，Android开发者主要使用Apache的<code>HttpClient</code>和Google自家的<code>HttpURLConnection</code>进行网络请求。但这两者多少都会存在一些问题。美国的移动支付公司Square在开发过程中，深感这些原生网络库难以满足其需求，便在2013年开源了<strong>OkHttp</strong>。</p>
</li>
<li>
<p>发展之路: <strong>从包装到替代</strong></p>
<p>OkHttp并非一开始就完全另起炉灶，其发展经历了几个阶段：</p>
<ol>
<li><strong>初期包装</strong>：最初，OkHttp是对原生<code>HttpClient</code>和<code>HttpURLConnection</code>的封装，旨在提供更友好、统一的API。</li>
<li><strong>剥离与独立</strong>：随着Apache宣布弃用<code>HttpClient</code>，OkHttp也移除了对其的支持。后来，Square团队认为<code>HttpURLConnection</code>也不够好用，索性去掉了对它的依赖，转而直接从 Socket 层完全重写整个 Http 网络请求**，实现了真正的独立。</li>
<li><strong>反向影响</strong>：OkHttp因其出色的设计和性能，受到了广大开发者的欢迎。Google也注意到了这一点，并在Android 4.4 (KitKat) 系统中，将<code>HttpURLConnection</code>的底层实现替换成了OkHttp**。这意味着，即使你在代码中使用的是标准的<code>HttpURLConnection</code>，其底层实际使用的 Okhttp的代码。</li>
<li><strong>向Kotlin迈进</strong>：从OkHttp 4版本开始，Square开始使用Kotlin语言进行重写</li>
</ol>
</li>
</ul>
<h2 data-id="heading-2">OkHttp 整体框架</h2>
<p>首先我们先看一下使用 Okhttp 如何完成一个网络请求：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">//okhttp 网络请求示例(异步)</span>
<span class="hljs-keyword">val</span> client = OkHttpClient()
<span class="hljs-keyword">val</span> request = Request.Builder()
    .url(<span class="hljs-string">""</span>)
    .build()
client.newCall(request)
    .enqueue(<span class="hljs-keyword">object</span> : Callback {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>, e: <span class="hljs-type">IOException</span>)</span></span> {
            <span class="hljs-comment">//处理错误</span>
        }
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onResponse</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>, response: <span class="hljs-type">Response</span>)</span></span> {
            <span class="hljs-comment">//处理 response</span>
        }
    })
</code></pre>
<p>代码非常简单，这得益于 Okhttp 优秀的框架设计，以下是以一次网络请求流程的视角来系统的了解 Okhttp 的整体结构：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf81327cc5f346898b226a478b80aeaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRW50cm9wbGVzcw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764348920&amp;x-signature=DCyjlzJnAG0SdjN49d7NvjbdXKk%3D" alt="OkHttp整体框架图（转载请注明出处）@Entropless" loading="lazy"/></p>
<p>文字说明：(请在看完文字说明后回来再看一次上面的图，理解会更深刻，而且不容易忘记)</p>
<ol>
<li>
<p>通过 OkHttpClient.Builder 来构造出一个 OkHttpClient 实例（这个实例在绝大部分场景都应该是单例的）,后面会详细介绍 OkHttpClient 中各个属性配置的作用</p>
</li>
<li>
<p>通过 Request.Builder 来构造出一个 Request 实例，这表示一个 originalRequest(原始请求)，开发者需要配置一个请求的基础参数</p>
</li>
<li>
<p>通过 newCall 方法（携带 request 参数）创建一个 Call 对象，实际为 RealCall 实例，它包含了以下参数：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RealCall</span>(
  <span class="hljs-keyword">val</span> client: OkHttpClient,<span class="hljs-comment">//开发者创建出来的 OkHttp Client 实例</span>
  <span class="hljs-comment">/** 一个未经重定向或者没有添加认证头的原始请求，
	  也就是未经OkHttp内部处理的请求，并不是实际发给服务器的请求 
  */</span>
  <span class="hljs-keyword">val</span> originalRequest: Request,
  <span class="hljs-keyword">val</span> forWebSocket: <span class="hljs-built_in">Boolean</span> <span class="hljs-comment">//发起的是否是一个WebSocket请求，因为WebSocket也是基于Http的协议</span>
) : Call {
	......
}
</code></pre>
<p>也就是说我们创建的这个原始请求对象，被转化为 了一个 RealCall，后面的每个 RealCall 就代表了一个请求</p>
</li>
<li>
<p>开始使用 execute(同步)/enqueue(异步)的方式发起一个 Http 请求</p>
</li>
<li>
<p>enqueue 方式： enqueue 需要传入一个 callback 对象来接收返回结果，整体逻辑如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">enqueue</span><span class="hljs-params">(responseCallback: <span class="hljs-type">Callback</span>)</span></span> {
	<span class="hljs-comment">//检查请求的执行状态</span>
  check(executed.compareAndSet(<span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>)) { <span class="hljs-string">"Already Executed"</span> }
  <span class="hljs-comment">//事件记录，标记开始执行请求</span>
  callStart()
  <span class="hljs-comment">//初始化一个异步的 Call，并入队</span>
  client.dispatcher.enqueue(AsyncCall(responseCallback))
}
</code></pre>
<blockquote>
<p>💡
PS: 关于check 方法，这是 Kotlin 标准库中的方法，它内部使用的是 Kotlin Contract 这个高级特性</p>
<p>此处简单介绍下这个方法，因为在 Okhttp 中大量使用到了它</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-meta">@kotlin</span>.<span class="hljs-keyword">internal</span>.InlineOnly

<span class="hljs-keyword">public</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">check</span><span class="hljs-params">(value: <span class="hljs-type">Boolean</span>, lazyMessage: () -&gt; <span class="hljs-type">Any</span>)</span></span>: <span class="hljs-built_in">Unit</span> {

contract {

returns() implies value

}

<span class="hljs-keyword">if</span> (!value) {

<span class="hljs-keyword">val</span> message = lazyMessage()

<span class="hljs-keyword">throw</span> IllegalStateException(message.toString())

}

}

</code></pre>
<p>contract 表示契约，implies 表示 暗示，这个方法的作用是 <strong>开发者 告诉 编译器</strong> 如果 check 方法能够正常返回(也就是不会抛出异常)，则暗示检查成功，否则抛出异常信息。</p>
<p>enqueue 方法中 check 的作用就是请求执行状态的检查</p>
<ul>
<li>
<p>**<code>executed</code>**是一个 <code>AtomicBoolean</code>，用于标记这个 <code>Call</code>是否已被执行过。<code>compareAndSet(false, true)</code>尝试将其值从 <code>false</code>设置为 <code>true</code>。</p>
</li>
<li>
<p><strong><code>check</code>函数</strong>：如果传入的表达式结果为 <code>false</code>（即设置失败，说明 <code>executed</code>已经是 <code>true</code>，意味着这个 <code>Call</code>已经被执行过），<code>check</code>函数就会抛出一个 <code>IllegalStateException</code>，异常信息为 "Already Executed"。</p>
</li>
<li>
<p><strong>这保证了</strong>一个 <code>Call</code>实例只能被执行一次，这是 OkHttp 防止重复请求的重要设计。</p>
</li>
</ul>
<p>🔑
关于 Contract 的更深入理解，<a href="https://juejin.cn/post/7574775334680952842" target="_blank" title="https://juejin.cn/post/7574775334680952842">请移步此处</a></p>
</blockquote>
<p>keep on :</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">internal</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">enqueue</span><span class="hljs-params">(call: <span class="hljs-type">AsyncCall</span>)</span></span> {
    synchronized(<span class="hljs-keyword">this</span>) {
	    <span class="hljs-comment">//将这个请求添加到准备执行的队列中</span>
      readyAsyncCalls.add(call)
			<span class="hljs-comment">/**下面这两行代码的意思是：找到与当前的这个请求主机名相同的Call,
				然后使它们共享「同一个主机请求个数」这个变量。
				为何共享？因为 Okhttp 要求同一个主机的请求个数不能大于5个（默认）
			*/</span>
      <span class="hljs-keyword">if</span> (!call.call.forWebSocket) {
        <span class="hljs-keyword">val</span> existingCall = findExistingCallWithHost(call.host)
        <span class="hljs-keyword">if</span> (existingCall != <span class="hljs-literal">null</span>) call.reuseCallsPerHostFrom(existingCall)
      }
    }
    <span class="hljs-comment">//开始推举并执行请求</span>
    promoteAndExecute()
  }
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">//promote 表示推动，意思就是对readyAsyncCalls中 Call 进行进一步的挑选，然后执行</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">promoteAndExecute</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">this</span>.assertThreadDoesntHoldLock()
		<span class="hljs-comment">//遍历 readyAsyncCalls,挑选出不会导致超负载的 Call 来添加至 executableCalls</span>
		<span class="hljs-comment">//同时也会添加到 runningAsyncCalls中(runningAsyncCalls中也包含已取消单但未执行完的Call)</span>
		<span class="hljs-comment">//runningAsyncCalls 主要用于记录正在运行的 Call</span>
    <span class="hljs-keyword">val</span> executableCalls = mutableListOf&lt;AsyncCall&gt;()
    <span class="hljs-keyword">val</span> isRunning: <span class="hljs-built_in">Boolean</span>
    synchronized(<span class="hljs-keyword">this</span>) {
      <span class="hljs-keyword">val</span> i = readyAsyncCalls.iterator()
      <span class="hljs-keyword">while</span> (i.hasNext()) {
        <span class="hljs-keyword">val</span> asyncCall = i.next()

        <span class="hljs-keyword">if</span> (runningAsyncCalls.size &gt;= <span class="hljs-keyword">this</span>.maxRequests) <span class="hljs-keyword">break</span> <span class="hljs-comment">// Max capacity.</span>
        <span class="hljs-keyword">if</span> (asyncCall.callsPerHost.<span class="hljs-keyword">get</span>() &gt;= <span class="hljs-keyword">this</span>.maxRequestsPerHost) <span class="hljs-keyword">continue</span> <span class="hljs-comment">// Host max capacity.</span>

        i.remove()
        asyncCall.callsPerHost.incrementAndGet()
        executableCalls.add(asyncCall)
        runningAsyncCalls.add(asyncCall)
      }
      isRunning = runningCallsCount() &gt; <span class="hljs-number">0</span>
    }
		<span class="hljs-comment">//开始遍历 executableCalls 然后执行每个 AsyncCall</span>
    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> until executableCalls.size) {
      <span class="hljs-keyword">val</span> asyncCall = executableCalls[i]
      asyncCall.executeOn(executorService)
    }
    <span class="hljs-keyword">return</span> isRunning
  }
</code></pre>
<p>由于 AsyncCall 继承了 Runnable ，因此它表示一个需要放进线程池中执行的具体任务，这是异步请求的核心（此处仅贴出核心代码）</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">inner</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncCall</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> responseCallback: Callback
  ) : Runnable {
    <span class="hljs-meta">@Volatile</span> <span class="hljs-keyword">var</span> callsPerHost = AtomicInteger(<span class="hljs-number">0</span>)
      <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">reuseCallsPerHostFrom</span><span class="hljs-params">(other: <span class="hljs-type">AsyncCall</span>)</span></span> {
      <span class="hljs-keyword">this</span>.callsPerHost = other.callsPerHost
    }
    ...
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">executeOn</span><span class="hljs-params">(executorService: <span class="hljs-type">ExecutorService</span>)</span></span> {
      ...
      executorService.execute(<span class="hljs-keyword">this</span>)
      ...
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span> {
      ...
      <span class="hljs-comment">//这是异步任务的核心，通过拦截器链的链式调用方式执行一个请求并返回结果</span>
      <span class="hljs-keyword">val</span> response = getResponseWithInterceptorChain()
      ...
      <span class="hljs-comment">//把返回的 response 传给 callback</span>
      responseCallback.onResponse(<span class="hljs-keyword">this</span><span class="hljs-symbol">@RealCall</span>, response)
      ...
    }
  }
</code></pre>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[补码是什么？为什么byte的范围是-128~127，负数要比整数多1个？]]></title>    <link>https://juejin.cn/post/7575050949958680612</link>    <guid>https://juejin.cn/post/7575050949958680612</guid>    <pubDate>2025-11-21T16:25:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575050949958680612" data-draft-id="7575021235135463443" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="补码是什么？为什么byte的范围是-128~127，负数要比整数多1个？"/> <meta itemprop="keywords" content="计算机组成原理"/> <meta itemprop="datePublished" content="2025-11-21T16:25:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Joey_Chen"/> <meta itemprop="url" content="https://juejin.cn/user/2522755752011596"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            补码是什么？为什么byte的范围是-128~127，负数要比整数多1个？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2522755752011596/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Joey_Chen
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T16:25:23.000Z" title="Fri Nov 21 2025 16:25:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">引言</h2>
<p>在学习任何一门编程语言时，都会首先学习基本数据类型。其中n位的整数类型（有符号）的范围是:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo>−</mo><msup><mn>2</mn><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msup><mo>∼</mo><msup><mn>2</mn><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">-2^{n-1} \sim 2^{n-1}-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9474em;vertical-align:-0.0833em;"/><span class="mord">−</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.9474em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></div>
<p>例如C++中的<code>int8_t</code>和<code>char</code>，以及Java中的<code>byte</code>，都是8位有符号整数，范围是<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>128</mn><mo>∼</mo><mn>127</mn></mrow><annotation encoding="application/x-tex">-128 \sim 127</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">−</span><span class="mord">128</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">127</span></span></span></span></span>, 有没有想过为什么负数会比正数多一个呢？</p>
<p>另外，如果<code>byte num = 127</code>, 什么<code>num + 1=-128</code>呢？</p>
<p>要想搞清楚背后的原理，就要知道<strong>二进制补码表示法</strong></p>
<h2 data-id="heading-1">二进制补码表示法</h2>
<p>二进制补码是计算机中表示有符号整数的标准方式（例如Java 中 byte、short、int、long 等整数类型均采用补码存储）。在补码出现之前，计算机曾用<strong>原码</strong>、<strong>反码</strong>表示有符号整数</p>
<h3 data-id="heading-2">原码</h3>
<ul>
<li><strong>表示方式</strong>：最高位为符号位（0 = 正、1 = 负），数值位为二进制本身。例如 8 位原码<code>+3=00000011</code>，<code>-3=10000011</code></li>
<li><strong>存在问题</strong>：
<ul>
<li>存在 “正负 0”（<code>+0=00000000</code>、<code>-0=10000000</code>），浪费一个存储位</li>
<li>减法需单独处理（<code>3-2</code> 不能直接用 <code>3+(-2)</code> 的原码相加，结果会出错）。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-plaintext" lang="plaintext">  3  -&gt; 00000011
+ -2 -&gt; 10000010
————————————————
        10000101  -&gt; -5, 结果错误
</code></pre>
<h3 data-id="heading-3">反码</h3>
<ul>
<li><strong>表示方式</strong>：正数反码 = 原码；负数反码 = 符号位不变，数值位按位取反。例如 8 位反码：<code>+3=00000011</code>，<code>-3=11111100</code>。</li>
<li><strong>存在问题</strong>：
<ul>
<li>减法问题：与原码相比，可以处理简单的减法，但是需要进位循环增加硬件按复杂度。更致命的是，无法处理“正负 0” 的歧义导致运算逻辑矛盾</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-plaintext" lang="plaintext">     3 -&gt; 00000011
  + -2 -&gt; 11111101
  ————————————————
         100000000  -&gt; 超出8位，需要进位循环，
         舍弃最高位 `1`，将进位加回最低位 → `00000000 + 1 = 00000001`，结果为1，正确；
         
     3 -&gt; 00000011
  + -3 -&gt; 11111100
  ————————————————
          11111111  -&gt; -0, 但是3-3结果应该是0，存在歧义
</code></pre>
<h3 data-id="heading-4">补码</h3>
<p>补码的核心改进正是针对反码的缺陷：</p>
<ul>
<li>消除 “正负 0”：仅保留 <code>00000000</code> 作为 0，<code>10000000</code> 分配给 <code>-128</code>（8 位），无歧义；</li>
<li>无需进位循环：补码加法的最高位进位直接舍弃（模运算特性），硬件实现简单；</li>
</ul>
<h4 data-id="heading-5">关键概念：模</h4>
<p>“模” 是指存储位数对应的 “溢出值”，即该位数能表示的最大无符号数 + 1。例如8位整数（如 <code>byte</code>）模 = 2⁸ = 256（能表示 0~255 共 256 个值）；</p>
<h4 data-id="heading-6">补码计算步骤</h4>
<ol>
<li>正数的补码，与原码完全一致</li>
</ol>
<pre><code class="hljs language-plaintext" lang="plaintext">规则：符号位为 0，数值位为该数的二进制表示
示例（以 8 位为例）:
+5 的原码 = 00000101 → 补码 = 00000101；
+127 的原码 = 01111111 → 补码 = 01111111
</code></pre>
<ol start="2">
<li>负数的补码：两种等价计算方式
<ul>
<li>方式 1：补码 = 模 - 绝对值的原码</li>
<li>方式 2：补码 = 负数的反码 + 1</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-plaintext" lang="plaintext">示例：计算 8 位 -3 的补码
先求绝对值 3 的原码：00000011
方式 1：模（256） - 3 = 253 → 253 的二进制 = 11111101（即 -3 的补码）；
方式 2：-3 的原码 = 10000011 → 反码（符号位不变，数值位取反）= 11111100 → 反码 + 1 = 11111101（与方式 1 结果一致）。
</code></pre>
<p>这里解释一下为什么两个方式等价，也就是:  <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>模</mtext><mo>−</mo><mtext>绝对值的原码</mtext><mo>=</mo><mtext>负数的反码</mtext><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">模 - 绝对值的原码 = 负数的反码 + 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord cjk_fallback">模</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">绝对值的原码</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord cjk_fallback">负数的反码</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>，假设<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">A&gt;0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>为正数，则<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mi>A</mi><mo>&lt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">-A&lt;0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord">−</span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>为负数</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mtext>模</mtext><mo>−</mo><mtext>绝对值的原码</mtext></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mtext>负数的反码</mtext><mo>+</mo><mn>1</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mtext>  </mtext><mn>256</mn><mo>−</mo><mi>A</mi><mtext>的原码</mtext></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mo>−</mo><mi>A</mi><mtext>的反码</mtext><mo>+</mo><mn>1</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mtext>     </mtext><mn>255</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mo>−</mo><mi>A</mi><mtext>的反码</mtext><mo>+</mo><mi>A</mi><mtext>的原码  </mtext></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}

    模 - 绝对值的原码 &amp;= 负数的反码 + 1 \\
    
    256-A的原码 &amp;= -A的反码 + 1 \\  

       255 &amp;= -A的反码 + A的原码 

    \end{align*}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.5em;vertical-align:-2em;"/><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord cjk_fallback">模</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord cjk_fallback">绝对值的原码</span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">  256</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal">A</span><span class="mord cjk_fallback">的原码</span></span></span><span style="top:-1.66em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">     255</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2em;"><span/></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord cjk_fallback">负数的反码</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">1</span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">−</span><span class="mord mathnormal">A</span><span class="mord cjk_fallback">的反码</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">1</span></span></span><span style="top:-1.66em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">−</span><span class="mord mathnormal">A</span><span class="mord cjk_fallback">的反码</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal">A</span><span class="mord cjk_fallback">的原码</span><span class="mord">  </span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>根据负数反码的定义<strong>符号位不变，数值位按位取反</strong>，-A的反码和A的原码中，其中一方为1的位另一方就为0，相加刚好是<code>11111111 = 255</code></p>
<h3 data-id="heading-7">如何根据补码求数值？</h3>
<p>根据 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>补码</mtext><mo>=</mo><mtext>模</mtext><mo>−</mo><mtext>绝对值的原码</mtext></mrow><annotation encoding="application/x-tex">补码 = 模 - 绝对值的原码</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">补码</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord cjk_fallback">模</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">绝对值的原码</span></span></span></span></span>得：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>绝对值的原码</mtext><mo>=</mo><mtext>模</mtext><mo>−</mo><mtext>补码</mtext></mrow><annotation encoding="application/x-tex">绝对值的原码 = 模 - 补码</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">绝对值的原码</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord cjk_fallback">模</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">补码</span></span></span></span></span></div>
<p>得到绝对值的原码，计算出绝对值，然后再根据补码得符号位判断正负，例如：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">补码10000001表示什么数？
首先用模-补码：100000000 - 10000001 = 01111111 = 127
由于补码第一位是1，所以10000001表示-127

反过来验证一下：
补码 = 负数的反码 + 1
10000001 = 10000000 + 1

补码 = 模 - 绝对值的原码
10000001 = 100000000 - 01111111

</code></pre>
<h2 data-id="heading-8">为什么负数范围比正数范围多1？</h2>
<p>关键在于0得表示，在二进制补码表示法中，0只有唯一的表示方式：<code>00000000</code>，那么<code>10000000</code>在补码中表示什么？</p>
<p>绝对值的原码 = 100000000 - 10000000 = 10000000 = 128，符号位为1，所以是-128</p>
<p>也就是说原码中的表示<code>-0</code>的10000000在补码中表示-128。由于舍弃了-0，并分配给了最小的负数-128，所以负数的范围就比正数多1个</p>
<h2 data-id="heading-9">为什么 127 + 1 = -128？</h2>
<p>知道了补码的原理后就很好理解了，127 + 1 = 01111111 + 1 = 10000000 = -128</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第14讲：CompletableFuture（上）——构建异步应用]]></title>    <link>https://juejin.cn/post/7575015480199020596</link>    <guid>https://juejin.cn/post/7575015480199020596</guid>    <pubDate>2025-11-22T03:39:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575015480199020596" data-draft-id="7575054113923661839" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第14讲：CompletableFuture（上）——构建异步应用"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-22T03:39:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="科威舟的代码笔记"/> <meta itemprop="url" content="https://juejin.cn/user/1732486058230174"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第14讲：CompletableFuture（上）——构建异步应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1732486058230174/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    科威舟的代码笔记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T03:39:07.000Z" title="Sat Nov 22 2025 03:39:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>[toc]</p>
<p>大家好，我是你们的船长：<strong>科威舟</strong>，今天给大家分享一下：第14讲：CompletableFuture（上）——构建异步应用。更多技术干货欢迎关注微信公众号<strong>科威舟的AI笔记</strong>~</p>
<p><img src="https://files.mdnice.com/user/101007/40fb2530-2565-4f14-a1df-8f581b1b1d70.png" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0">一、从Future到CompletableFuture：异步编程的演进</h2>
<p>在Java 5中引入的<code>Future</code>接口为异步编程提供了基础支持，但它存在明显的局限性。<code>Future</code>代表一个异步计算的结果，允许我们提交任务到线程池，并在需要时获取计算结果。然而，在实际使用中，<code>Future</code>的模式显得笨重且功能有限。</p>
<h3 data-id="heading-1">1.1 Future的局限性</h3>
<p><strong>传统Future的使用模式</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>);
Future&lt;String&gt; future = executor.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callable</span>&lt;String&gt;() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        Thread.sleep(<span class="hljs-number">2000</span>); <span class="hljs-comment">// 模拟耗时操作</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"任务结果"</span>;
    }
});

<span class="hljs-comment">// 阻塞等待结果</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.get(<span class="hljs-number">5</span>, TimeUnit.SECONDS);
    System.out.println(<span class="hljs-string">"结果: "</span> + result);
} <span class="hljs-keyword">catch</span> (TimeoutException e) {
    System.out.println(<span class="hljs-string">"任务超时"</span>);
} <span class="hljs-keyword">finally</span> {
    executor.shutdown();
}
</code></pre>
<p><strong>Future的主要局限性</strong>：</p>
<ul>
<li><strong>结果获取阻塞</strong>：<code>get()</code>方法会阻塞线程直到结果可用</li>
<li><strong>无法手动完成</strong>：不能主动设置任务结果或异常</li>
<li><strong>缺乏回调机制</strong>：任务完成后无法自动触发后续操作</li>
<li><strong>组合能力弱</strong>：难以将多个异步任务的结果组合在一起</li>
<li><strong>异常处理不便</strong>：异常被包裹在ExecutionException中，处理繁琐</li>
</ul>
<h3 data-id="heading-2">1.2 CompletableFuture的设计理念</h3>
<p>Java 8引入的<code>CompletableFuture</code>解决了上述所有问题，它实现了<code>Future</code>和<code>CompletionStage</code>接口，提供了强大的异步编程能力。</p>
<p><strong>核心设计特点</strong>：</p>
<ul>
<li><strong>可完成性</strong>：可以手动设置结果或异常</li>
<li><strong>非阻塞回调</strong>：支持任务完成后的回调处理</li>
<li><strong>链式编程</strong>：支持多个异步任务的流水线组合</li>
<li><strong>异常传播</strong>：提供完整的异常处理机制</li>
<li><strong>组合操作</strong>：支持多个异步任务的并行组合</li>
</ul>
<h2 data-id="heading-3">二、CompletableFuture核心原理解析</h2>
<h3 data-id="heading-4">2.1 架构设计：观察者模式的应用</h3>
<p><code>CompletableFuture</code>内部采用<strong>观察者模式</strong>实现异步回调机制。每个<code>CompletableFuture</code>维护一个依赖动作栈（stack），当任务完成时，会自动通知所有注册的依赖动作。</p>
<p><strong>内部关键字段</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 存储异步计算的结果</span>
<span class="hljs-keyword">volatile</span> Object result;

<span class="hljs-comment">// 依赖动作栈（观察者链）</span>
<span class="hljs-keyword">volatile</span> Completion stack;
</code></pre>
<h3 data-id="heading-5">2.2 任务触发机制：tryFire方法</h3>
<p><code>CompletableFuture</code>通过<code>tryFire</code>方法实现异步任务链的触发。当某个阶段完成时，会递归调用后续阶段的<code>tryFire</code>方法，形成完整的任务执行链。</p>
<p><strong>触发模式</strong>：</p>
<ul>
<li><strong>SYNC</strong>（同步触发）：在当前线程直接执行</li>
<li><strong>ASYNC</strong>（异步触发）：提交到线程池异步执行</li>
<li><strong>NESTED</strong>（嵌套触发）：避免重复触发的特殊模式</li>
</ul>
<h2 data-id="heading-6">三、创建异步任务：supplyAsync与runAsync</h2>
<h3 data-id="heading-7">3.1 supplyAsync：有返回值的异步任务</h3>
<p><code>supplyAsync</code>方法接受一个<code>Supplier</code>函数式接口，返回一个<code>CompletableFuture</code>对象，用于执行有返回值的异步任务。</p>
<p><strong>基础用法</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SupplyAsyncExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 使用默认线程池（ForkJoinPool.commonPool()）</span>
        CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-comment">// 模拟耗时操作</span>
            <span class="hljs-keyword">try</span> {
                Thread.sleep(<span class="hljs-number">1000</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(e);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-string">"异步任务结果"</span>;
        });
        
        System.out.println(<span class="hljs-string">"主线程继续执行..."</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.get();
        System.out.println(<span class="hljs-string">"获取结果: "</span> + result);
    }
}
</code></pre>
<p><strong>使用自定义线程池</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomThreadPoolExample</span> {
    <span class="hljs-comment">// 创建专用的线程池</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">customExecutor</span> <span class="hljs-operator">=</span> 
        Executors.newFixedThreadPool(<span class="hljs-number">5</span>);
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; {
            System.out.println(<span class="hljs-string">"执行线程: "</span> + Thread.currentThread().getName());
            <span class="hljs-keyword">return</span> <span class="hljs-string">"使用自定义线程池"</span>;
        }, customExecutor);
        
        System.out.println(<span class="hljs-string">"结果: "</span> + future.get());
        customExecutor.shutdown();
    }
}
</code></pre>
<h3 data-id="heading-8">3.2 runAsync：无返回值的异步任务</h3>
<p><code>runAsync</code>方法接受一个<code>Runnable</code>参数，适用于不需要返回值的异步操作。</p>
<p><strong>实战示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RunAsyncExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        CompletableFuture&lt;Void&gt; future = CompletableFuture.runAsync(() -&gt; {
            <span class="hljs-comment">// 执行后台任务，如日志记录、数据清理等</span>
            System.out.println(<span class="hljs-string">"开始执行后台任务..."</span>);
            <span class="hljs-keyword">try</span> {
                Thread.sleep(<span class="hljs-number">2000</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(e);
            }
            System.out.println(<span class="hljs-string">"后台任务执行完成"</span>);
        });
        
        <span class="hljs-comment">// 等待任务完成</span>
        future.get();
        System.out.println(<span class="hljs-string">"主程序结束"</span>);
    }
}
</code></pre>
<h3 data-id="heading-9">3.3 线程池选择策略</h3>
<p>根据任务特性选择合适的线程池至关重要：</p>
<p><strong>CPU密集型任务</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用ForkJoinPool，并行度等于CPU核心数</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ForkJoinPool</span> <span class="hljs-variable">cpuIntensivePool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ForkJoinPool</span>(
    Runtime.getRuntime().availableProcessors()
);

CompletableFuture.supplyAsync(() -&gt; {
    <span class="hljs-comment">// CPU密集型计算</span>
    <span class="hljs-keyword">return</span> intensiveCalculation();
}, cpuIntensivePool);
</code></pre>
<p><strong>IO密集型任务</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用ThreadPoolExecutor，配置更多线程</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">ioIntensivePool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    <span class="hljs-number">10</span>,  <span class="hljs-comment">// 核心线程数</span>
    <span class="hljs-number">20</span>,  <span class="hljs-comment">// 最大线程数</span>
    <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>)
);

CompletableFuture.supplyAsync(() -&gt; {
    <span class="hljs-comment">// IO密集型操作，如网络请求、数据库查询</span>
    <span class="hljs-keyword">return</span> databaseQuery();
}, ioIntensivePool);
</code></pre>
<h2 data-id="heading-10">四、链式操作：thenApply与thenAccept</h2>
<h3 data-id="heading-11">4.1 thenApply：结果转换</h3>
<p><code>thenApply</code>方法用于对前一个阶段的结果进行转换，返回一个新的<code>CompletableFuture</code>。</p>
<p><strong>基础转换示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThenApplyExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello"</span>;
        }).thenApply(result -&gt; {
            <span class="hljs-comment">// 对上游结果进行转换</span>
            <span class="hljs-keyword">return</span> result + <span class="hljs-string">" World"</span>;
        }).thenApply(result -&gt; {
            <span class="hljs-comment">// 继续转换</span>
            <span class="hljs-keyword">return</span> result.toUpperCase();
        });
        
        System.out.println(<span class="hljs-string">"最终结果: "</span> + future.get()); <span class="hljs-comment">// 输出: HELLO WORLD</span>
    }
}
</code></pre>
<p><strong>实战案例：数据处理流水线</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataProcessingPipeline</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        CompletableFuture&lt;String&gt; processingPipeline = CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-comment">// 第一阶段：数据获取</span>
            System.out.println(<span class="hljs-string">"获取原始数据..."</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-string">"raw_data_123"</span>;
        }).thenApply(rawData -&gt; {
            <span class="hljs-comment">// 第二阶段：数据清洗</span>
            System.out.println(<span class="hljs-string">"清洗数据: "</span> + rawData);
            <span class="hljs-keyword">return</span> rawData.replace(<span class="hljs-string">"raw_"</span>, <span class="hljs-string">"cleaned_"</span>);
        }).thenApply(cleanedData -&gt; {
            <span class="hljs-comment">// 第三阶段：数据转换</span>
            System.out.println(<span class="hljs-string">"转换数据: "</span> + cleanedData);
            <span class="hljs-keyword">return</span> cleanedData.toUpperCase();
        }).thenApply(transformedData -&gt; {
            <span class="hljs-comment">// 第四阶段：数据存储准备</span>
            System.out.println(<span class="hljs-string">"准备存储: "</span> + transformedData);
            <span class="hljs-keyword">return</span> <span class="hljs-string">"final_"</span> + transformedData;
        });
        
        <span class="hljs-type">String</span> <span class="hljs-variable">finalResult</span> <span class="hljs-operator">=</span> processingPipeline.get();
        System.out.println(<span class="hljs-string">"处理完成: "</span> + finalResult);
    }
}
</code></pre>
<h3 data-id="heading-12">4.2 thenAccept：结果消费</h3>
<p><code>thenAccept</code>方法接受一个<code>Consumer</code>参数，对结果进行消费但不返回新值。</p>
<p><strong>基础用法</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThenAcceptExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        CompletableFuture&lt;Void&gt; future = CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"处理后的数据"</span>;
        }).thenAccept(result -&gt; {
            <span class="hljs-comment">// 消费结果，如打印、保存等</span>
            System.out.println(<span class="hljs-string">"消费结果: "</span> + result);
        });
        
        future.get(); <span class="hljs-comment">// 等待整个流水线完成</span>
    }
}
</code></pre>
<p><strong>实战案例：异步处理结果</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncResultHandler</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        CompletableFuture&lt;Void&gt; processingFlow = CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-comment">// 模拟业务数据处理</span>
            System.out.println(<span class="hljs-string">"开始业务处理..."</span>);
            <span class="hljs-keyword">try</span> {
                Thread.sleep(<span class="hljs-number">1000</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(e);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessData</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"处理完成"</span>, System.currentTimeMillis());
        }).thenAccept(businessData -&gt; {
            <span class="hljs-comment">// 异步处理业务结果</span>
            System.out.println(<span class="hljs-string">"收到业务数据: "</span> + businessData);
            <span class="hljs-comment">// 可以在这里进行结果保存、通知等操作</span>
            saveToDatabase(businessData);
            sendNotification(businessData);
        });
        
        System.out.println(<span class="hljs-string">"主线程继续执行其他任务..."</span>);
        processingFlow.get(); <span class="hljs-comment">// 等待异步处理完成</span>
        System.out.println(<span class="hljs-string">"所有处理完成"</span>);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveToDatabase</span><span class="hljs-params">(BusinessData data)</span> {
        System.out.println(<span class="hljs-string">"保存到数据库: "</span> + data);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendNotification</span><span class="hljs-params">(BusinessData data)</span> {
        System.out.println(<span class="hljs-string">"发送通知: "</span> + data);
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessData</span> {
        <span class="hljs-type">int</span> id;
        String status;
        <span class="hljs-type">long</span> timestamp;
        
        BusinessData(<span class="hljs-type">int</span> id, String status, <span class="hljs-type">long</span> timestamp) {
            <span class="hljs-built_in">this</span>.id = id;
            <span class="hljs-built_in">this</span>.status = status;
            <span class="hljs-built_in">this</span>.timestamp = timestamp;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"BusinessData{id=%d, status='%s', timestamp=%d}"</span>, 
                               id, status, timestamp);
        }
    }
}
</code></pre>
<h3 data-id="heading-13">4.3 同步与异步执行模式</h3>
<p><code>thenApply</code>和<code>thenAccept</code>都有同步和异步版本：</p>
<p><strong>同步执行</strong>（默认）：</p>
<pre><code class="hljs language-java" lang="java">CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; <span class="hljs-string">"Hello"</span>)
    .thenApply(result -&gt; {  <span class="hljs-comment">// 在上一个任务的同一线程执行</span>
        <span class="hljs-keyword">return</span> result + <span class="hljs-string">" World"</span>;
    });
</code></pre>
<p><strong>异步执行</strong>（thenApplyAsync）：</p>
<pre><code class="hljs language-java" lang="java">CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; <span class="hljs-string">"Hello"</span>)
    .thenApplyAsync(result -&gt; {  <span class="hljs-comment">// 在默认线程池执行</span>
        <span class="hljs-keyword">return</span> result + <span class="hljs-string">" World"</span>;
    });
</code></pre>
<p><strong>指定线程池的异步执行</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Executor</span> <span class="hljs-variable">customExecutor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">3</span>);
CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; <span class="hljs-string">"Hello"</span>)
    .thenApplyAsync(result -&gt; {
        <span class="hljs-keyword">return</span> result + <span class="hljs-string">" World"</span>;
    }, customExecutor);
</code></pre>
<h2 data-id="heading-14">五、实战案例：电商价格计算系统</h2>
<p>下面通过一个完整的电商价格计算案例，展示CompletableFuture在实际业务中的应用。</p>
<h3 data-id="heading-15">5.1 业务场景描述</h3>
<p>假设我们需要计算一个商品的最终价格，计算过程涉及：</p>
<ol>
<li>获取商品基础价格</li>
<li>查询用户会员等级折扣</li>
<li>查询当前促销活动折扣</li>
<li>计算运费</li>
<li>汇总最终价格</li>
</ol>
<h3 data-id="heading-16">5.2 传统同步实现 vs CompletableFuture异步实现</h3>
<p><strong>传统同步实现</strong>（性能较差）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SyncPriceCalculator</span> {
    <span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title function_">calculatePrice</span><span class="hljs-params">(Long productId, Long userId)</span> {
        <span class="hljs-comment">// 1. 获取商品基础价格（耗时100ms）</span>
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">basePrice</span> <span class="hljs-operator">=</span> productService.getBasePrice(productId);
        
        <span class="hljs-comment">// 2. 查询用户折扣（耗时150ms）</span>
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">userDiscount</span> <span class="hljs-operator">=</span> userService.getUserDiscount(userId);
        
        <span class="hljs-comment">// 3. 查询促销折扣（耗时200ms）</span>
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">promotionDiscount</span> <span class="hljs-operator">=</span> promotionService.getCurrentDiscount(productId);
        
        <span class="hljs-comment">// 4. 计算运费（耗时100ms）</span>
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">shippingFee</span> <span class="hljs-operator">=</span> shippingService.calculateFee(productId, userId);
        
        <span class="hljs-comment">// 5. 计算最终价格</span>
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">finalPrice</span> <span class="hljs-operator">=</span> basePrice
            .multiply(userDiscount)
            .multiply(promotionDiscount)
            .add(shippingFee);
            
        <span class="hljs-keyword">return</span> finalPrice;
    }
}
<span class="hljs-comment">// 总耗时：100 + 150 + 200 + 100 = 550ms</span>
</code></pre>
<p><strong>CompletableFuture异步实现</strong>（性能优化）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncPriceCalculator</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">4</span>);
    
    <span class="hljs-keyword">public</span> CompletableFuture&lt;BigDecimal&gt; <span class="hljs-title function_">calculatePrice</span><span class="hljs-params">(Long productId, Long userId)</span> {
        <span class="hljs-comment">// 并行执行所有查询任务</span>
        CompletableFuture&lt;BigDecimal&gt; basePriceFuture = 
            CompletableFuture.supplyAsync(() -&gt; 
                productService.getBasePrice(productId), executor);
                
        CompletableFuture&lt;BigDecimal&gt; userDiscountFuture = 
            CompletableFuture.supplyAsync(() -&gt; 
                userService.getUserDiscount(userId), executor);
                
        CompletableFuture&lt;BigDecimal&gt; promotionDiscountFuture = 
            CompletableFuture.supplyAsync(() -&gt; 
                promotionService.getCurrentDiscount(productId), executor);
                
        CompletableFuture&lt;BigDecimal&gt; shippingFeeFuture = 
            CompletableFuture.supplyAsync(() -&gt; 
                shippingService.calculateFee(productId, userId), executor);
        
        <span class="hljs-comment">// 组合所有结果</span>
        <span class="hljs-keyword">return</span> basePriceFuture
            .thenCombine(userDiscountFuture, BigDecimal::multiply)
            .thenCombine(promotionDiscountFuture, BigDecimal::multiply)
            .thenCombine(shippingFeeFuture, BigDecimal::add)
            .exceptionally(ex -&gt; {
                System.err.println(<span class="hljs-string">"价格计算失败: "</span> + ex.getMessage());
                <span class="hljs-keyword">return</span> BigDecimal.ZERO; <span class="hljs-comment">// 返回默认值</span>
            });
    }
}
<span class="hljs-comment">// 总耗时：最慢的任务时间 ≈ 200ms</span>
</code></pre>
<h3 data-id="heading-17">5.3 完整的电商价格服务</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ECommercePriceService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ExecutorService priceCalculatorExecutor;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ProductService productService;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserService userService;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PromotionService promotionService;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ShippingService shippingService;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ECommercePriceService</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.priceCalculatorExecutor = Executors.newFixedThreadPool(<span class="hljs-number">10</span>);
        <span class="hljs-comment">// 初始化各服务...</span>
    }
    
    <span class="hljs-keyword">public</span> CompletableFuture&lt;PriceResult&gt; <span class="hljs-title function_">calculateDetailedPrice</span><span class="hljs-params">(Long productId, Long userId)</span> {
        <span class="hljs-comment">// 并行获取所有必要信息</span>
        CompletableFuture&lt;BigDecimal&gt; basePriceFuture = getBasePrice(productId);
        CompletableFuture&lt;BigDecimal&gt; userDiscountFuture = getUserDiscount(userId);
        CompletableFuture&lt;BigDecimal&gt; promotionDiscountFuture = getPromotionDiscount(productId);
        CompletableFuture&lt;BigDecimal&gt; shippingFeeFuture = getShippingFee(productId, userId);
        
        <span class="hljs-comment">// 组合计算结果</span>
        <span class="hljs-keyword">return</span> basePriceFuture
            .thenCombine(userDiscountFuture, (price, discount) -&gt; {
                <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discountedPrice</span> <span class="hljs-operator">=</span> price.multiply(discount);
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriceStepResult</span>(price, discountedPrice, <span class="hljs-string">"用户折扣应用"</span>);
            })
            .thenCombine(promotionDiscountFuture, (stepResult, promotionDiscount) -&gt; {
                <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">newPrice</span> <span class="hljs-operator">=</span> stepResult.getCurrentPrice().multiply(promotionDiscount);
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriceStepResult</span>(stepResult.getBasePrice(), newPrice, <span class="hljs-string">"促销折扣应用"</span>);
            })
            .thenCombine(shippingFeeFuture, (stepResult, shippingFee) -&gt; {
                <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">finalPrice</span> <span class="hljs-operator">=</span> stepResult.getCurrentPrice().add(shippingFee);
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriceResult</span>(
                    stepResult.getBasePrice(),
                    finalPrice,
                    shippingFee,
                    <span class="hljs-string">"价格计算完成"</span>
                );
            })
            .exceptionally(ex -&gt; {
                <span class="hljs-comment">// 异常处理</span>
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriceResult</span>(
                    BigDecimal.ZERO, BigDecimal.ZERO, BigDecimal.ZERO,
                    <span class="hljs-string">"计算失败: "</span> + ex.getMessage()
                );
            });
    }
    
    <span class="hljs-keyword">private</span> CompletableFuture&lt;BigDecimal&gt; <span class="hljs-title function_">getBasePrice</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            System.out.println(<span class="hljs-string">"查询商品基础价格: "</span> + productId);
            <span class="hljs-keyword">return</span> productService.getBasePrice(productId);
        }, priceCalculatorExecutor);
    }
    
    <span class="hljs-keyword">private</span> CompletableFuture&lt;BigDecimal&gt; <span class="hljs-title function_">getUserDiscount</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            System.out.println(<span class="hljs-string">"查询用户折扣: "</span> + userId);
            <span class="hljs-keyword">return</span> userService.getUserDiscount(userId);
        }, priceCalculatorExecutor);
    }
    
    <span class="hljs-comment">// 其他服务方法类似...</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span> {
        priceCalculatorExecutor.shutdown();
    }
}
</code></pre>
<h2 data-id="heading-18">六、最佳实践与注意事项</h2>
<h3 data-id="heading-19">6.1 线程池管理策略</h3>
<p><strong>避免使用默认线程池</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不推荐：使用默认commonPool（可能造成线程饥饿）</span>
CompletableFuture.supplyAsync(() -&gt; heavyTask());

<span class="hljs-comment">// 推荐：使用自定义线程池</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">customExecutor</span> <span class="hljs-operator">=</span> 
    Executors.newFixedThreadPool(<span class="hljs-number">10</span>);

CompletableFuture.supplyAsync(() -&gt; heavyTask(), customExecutor);
</code></pre>
<p><strong>线程池配置建议</strong>：</p>
<ul>
<li><strong>CPU密集型</strong>：线程数 = CPU核心数</li>
<li><strong>IO密集型</strong>：线程数 = CPU核心数 × 2 ~ 4</li>
<li><strong>使用有界队列</strong>防止内存溢出</li>
<li><strong>设置合理的拒绝策略</strong></li>
</ul>
<h3 data-id="heading-20">6.2 异常处理基础</h3>
<pre><code class="hljs language-java" lang="java">CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; {
    <span class="hljs-keyword">if</span> (Math.random() &gt; <span class="hljs-number">0.5</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">"成功结果"</span>;
}).exceptionally(ex -&gt; {
    <span class="hljs-comment">// 异常处理，返回默认值</span>
    System.err.println(<span class="hljs-string">"处理异常: "</span> + ex.getMessage());
    <span class="hljs-keyword">return</span> <span class="hljs-string">"默认结果"</span>;
});
</code></pre>
<h3 data-id="heading-21">6.3 资源清理与超时控制</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceAwareFuture</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newSingleThreadExecutor();
        
        <span class="hljs-keyword">try</span> {
            CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; {
                <span class="hljs-comment">// 模拟耗时任务</span>
                <span class="hljs-keyword">try</span> {
                    Thread.sleep(<span class="hljs-number">5000</span>);
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    <span class="hljs-keyword">return</span> <span class="hljs-string">"任务被中断"</span>;
                }
                <span class="hljs-keyword">return</span> <span class="hljs-string">"任务完成"</span>;
            }, executor);
            
            <span class="hljs-comment">// 设置超时</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.get(<span class="hljs-number">2</span>, TimeUnit.SECONDS);
            System.out.println(<span class="hljs-string">"结果: "</span> + result);
            
        } <span class="hljs-keyword">catch</span> (TimeoutException e) {
            System.out.println(<span class="hljs-string">"任务超时"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.out.println(<span class="hljs-string">"其他异常: "</span> + e.getMessage());
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 重要：及时关闭线程池</span>
            executor.shutdown();
        }
    }
}
</code></pre>
<h2 data-id="heading-22">总结</h2>
<p>通过本讲的学习，我们掌握了<code>CompletableFuture</code>的基础用法和核心概念。关键要点总结：</p>
<ol>
<li><strong>从Future到CompletableFuture</strong>：解决了传统Future的局限性，提供了更强大的异步编程能力</li>
<li><strong>任务创建</strong>：使用<code>supplyAsync</code>和<code>runAsync</code>创建异步任务，注意线程池选择</li>
<li><strong>链式操作</strong>：<code>thenApply</code>用于结果转换，<code>thenAccept</code>用于结果消费</li>
<li><strong>实战应用</strong>：通过电商价格计算案例展示了异步编程的性能优势</li>
<li><strong>最佳实践</strong>：合理管理线程池，做好异常处理和资源清理</li>
</ol>
<p><code>CompletableFuture</code>将回调模式转变为声明式组合，让异步编程变得更加直观和优雅。在下一讲中，我们将深入探讨更高级的特性，包括任务组合、异常处理、超时控制等高级用法。</p>
<p><strong>思考与实践</strong>：在你的项目中，哪些耗时操作可以用<code>CompletableFuture</code>进行优化？尝试用本讲知识重构一个同步业务逻辑，体验性能提升的效果！</p>
<p>【转载须知】：<strong>转载请注明原文出处及作者信息</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[虾分发平台提供多种价格套餐]]></title>    <link>https://juejin.cn/post/7575065042157682738</link>    <guid>https://juejin.cn/post/7575065042157682738</guid>    <pubDate>2025-11-22T03:44:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575065042157682738" data-draft-id="7575017581037256742" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="虾分发平台提供多种价格套餐"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-22T03:44:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我的虾分发"/> <meta itemprop="url" content="https://juejin.cn/user/4141193601750448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            虾分发平台提供多种价格套餐
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4141193601750448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我的虾分发
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T03:44:30.000Z" title="Sat Nov 22 2025 03:44:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><ol>
<li>
<p>操作简便：</p>
<ul>
<li>平台界面简洁易用，操作流程顺畅，即使是初次使用的开发者也能快速上手。</li>
<li>虾分发 xiafenfa提供在线自助制作功能，支持24小时在线制作APP，为开发者提供了极大的便利。</li>
</ul>
</li>
<li>
<p>性价比高：</p>
<ul>
<li>提供多种价格套餐，支持按需购买，避免资源浪费。例如，基础套餐（30元/1000虾币）即可满足小范围测试需求。</li>
<li>新用户登录即赠虾币，可用于下载流量抵扣，降低早期内测成本。</li>
</ul>
</li>
<li>
<p>安全性高：</p>
<ul>
<li>部署了DDoS防护系统，可抵御每秒数百G的攻击流量，同时通过Web应用防火墙（WAF）拦截SQL注入、XSS等常见攻击，确保分发环境安全。</li>
<li>对管理后台和API接口实施频率限制和行为分析，防止恶意刷量或数据窃取。</li>
<li>云盘数据可靠性达99.99%，支持自动宕机迁移和多线路备份，即使遭遇硬件故障也能在分钟级恢复服务，避免数据丢失影响测试进度。</li>
</ul>
</li>
<li>
<p>服务全面：</p>
<ul>
<li>提供从应用上传、审核、测试、分发到下载的一站式服务，满足开发者全流程需求。</li>
<li>提供丰富的插件库和功能组件，开发者可以根据需求自由搭配，提升应用的性能和用户体验。</li>
</ul>
</li>
<li>
<p>用户口碑好：</p>
<ul>
<li>累计服务全球开发者超84000家，内测分发APP超79万次，内测下载量突破78万次，数据表现领先行业。</li>
<li>用户评价显示，虾分发平台上传速度快、下载稳定、客服响应及时，是团队内测的首选平台。</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[转转UI自动化走查方案探索]]></title>    <link>https://juejin.cn/post/7574739133945675818</link>    <guid>https://juejin.cn/post/7574739133945675818</guid>    <pubDate>2025-11-21T02:34:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574739133945675818" data-draft-id="7574734686493278244" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="转转UI自动化走查方案探索"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-21T02:34:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="转转技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/606586148237431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            转转UI自动化走查方案探索
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/606586148237431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    转转技术团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T02:34:49.000Z" title="Fri Nov 21 2025 02:34:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">转转UI自动化走查方案探索</h2>
<h3 data-id="heading-1">前言</h3>
<p>UI走查是现在转转C端需求开发流程中相当重要的一环，然而UI走查这一环节难以接入自动化流程中，导致其没有如同测试环节一样的冒烟环节（又称测试准入），因此实际走查阶段时，前端的UI交付质量难以在流程上做硬性管控，UI还原度参差不齐，这也就进一步导致了UI走查效率难以把控。经UI侧同学的不完全统计，2025年5-8月期间，共走查需求20个，总耗时33h，平均单个需求耗时1.6h，在需求规模较大的情况下，走查耗时最高时可达3-4小时，走查轮次3次，异常数量30-50个不等，而走查本身耗时并不高，而大部分的时间都耗费在对UI异常问题的标注上。因此，开发一种自动化比对UI设计稿与HTML结构，自动化标注比对结果的工具，能在根本上提升UI还原度，提升UI走查效率。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47c7038c756c46b49701c9dd507276dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764297289&amp;x-signature=giECpVZqMcXhNZXBYaDyiZ6q7dE%3D" alt="走查耗时统计" loading="lazy"/></p>
<h3 data-id="heading-2">方案的调研与选择</h3>
<h4 data-id="heading-3">叠图比对方案</h4>
<p>目前现存的大多数UI走查方案走的都是比对UI设计稿与前端页面截图的方案，此方案虽通用性高，但是结果难以量化，难以与标准化研发流程结合，在前言中我们也说明了，走查的耗时成本在与<strong>异常数据的标注</strong>，而非获取比对结果。因此这种方案显然无法达成目的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8085f307b3f24c6dabadac76cf8020b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764297289&amp;x-signature=JNzzVIOcb4c4zgUV%2FErkmH3sUw4%3D" alt="prefect pixel实现效果" loading="lazy"/></p>
<h4 data-id="heading-4">像素比对方案</h4>
<p>像素级的比对方案与叠图比对方案的原理相似，在实现上，叠图方案需要开发者主动判断结果，而像素比对方案则是通过类似于<code>opencv</code>之类的图像处理工具配合类似于<code>scikit-image</code>之类的结构相似度算法进行实现。这种方案虽然能拿到量化的比对数据，以及自动化标注，但是在双方图片的相似度上要求较高，设计稿与UI在文案上有一定的区别都能造成比对的误差，且误差不可控。如果进一步的考虑通过微调、自训练ai模型的方案，则训练、标注的成本也相当高。因此改方案也并非最佳的选择。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9339f48c9c941cd94698fa8087c01c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764297289&amp;x-signature=GV1ry9dbfV%2BHmeokgA9lSYjc%2BmI%3D" alt="像素级比对方案结果" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19421e681b4b494f81cfe4d340430ed0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764297289&amp;x-signature=LlbXhRWYRC10PzF47L8Utj4YVCM%3D" alt="像素级比对方案结果" loading="lazy"/></p>
<h4 data-id="heading-5">基于前端与UI节点的比对方案</h4>
<p>在现在流行的一些前端化UI设计工具（例如Figma、Master Go）中，UI设计稿在底层其实是一个大型的带有嵌套关系的JSON数据结构，而前端的Dom树也是一个带有嵌套关系的数据结构。基于这两点，很容易就想到如果能将双方的节点数据归一化处理成相同的数据结构，那么在节点间间距的精确匹配与比对上，或许会有不错的效果。</p>
<h3 data-id="heading-6">数据结构设计</h3>
<p>既然要归一化处理数据，那么首先需要考虑的就是这个数据结构需要什么。</p>
<p>在上文提到的UI走查情况统计数据中，UI走查出现的问题中，间距问题占比约<strong>95%</strong>，字体相关问题约占<strong>3%</strong>，其余诸如背景色、边框等问题占比共2%，因此在方案前期，首要需要解决的问题就是间距问题。</p>
<p>要检测出间距问题，首先需要找到当前节点的相邻节点，于是我们对相邻节点做出如下定义。</p>
<ol>
<li>
<p>定义当前节点A与另一个节点B之间总共有9种环绕关系，按从左到右从上到下编号分别即为1-9号位置。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/280faf73cbcf4331806889ae891fa6a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764297289&amp;x-signature=u5TgvlVwpeKwE79K5CwbAc2V6BU%3D" alt="节点周边的8个位置" loading="lazy"/></p>
</li>
<li>
<p>2、4、6、8号位置中，与当前节点的距离最小的节点，即为当前节点的四个方位的相邻节点</p>
</li>
<li>
<p>所谓上下左右的间距，即为当前节点与各方位上的相邻节点的间距。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/** 相对于当前节点的兄弟节点位置枚举 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">SiblingPosition</span> {
  <span class="hljs-comment">/** 不在任何位置 */</span>
  <span class="hljs-variable constant_">NONE</span> = <span class="hljs-number">0</span>,
  <span class="hljs-comment">/** 左上角 */</span>
  <span class="hljs-variable constant_">TOP_LEFT</span> = <span class="hljs-number">1</span>,
  <span class="hljs-comment">/** 正上方 */</span>
  <span class="hljs-variable constant_">TOP</span> = <span class="hljs-number">2</span>,
  <span class="hljs-comment">/** 右上角 */</span>
  <span class="hljs-variable constant_">TOP_RIGHT</span> = <span class="hljs-number">3</span>,
  <span class="hljs-comment">/** 左侧 */</span>
  <span class="hljs-variable constant_">LEFT</span> = <span class="hljs-number">4</span>,
  <span class="hljs-comment">/** 右侧 */</span>
  <span class="hljs-variable constant_">RIGHT</span> = <span class="hljs-number">6</span>,
  <span class="hljs-comment">/** 左下角 */</span>
  <span class="hljs-variable constant_">BOTTOM_LEFT</span> = <span class="hljs-number">7</span>,
  <span class="hljs-comment">/** 正下方 */</span>
  <span class="hljs-variable constant_">BOTTOM</span> = <span class="hljs-number">8</span>,
  <span class="hljs-comment">/** 右下角 */</span>
  <span class="hljs-variable constant_">BOTTOM_RIGHT</span> = <span class="hljs-number">9</span>,
}
<span class="hljs-comment">/** 节点的唯一ID标识符 */</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">UniqueId</span> = <span class="hljs-built_in">string</span>
<span class="hljs-comment">/** 只记录2 4 6 8 四个方向的兄弟节点信息 */</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">SiblingRelativeNodeInfo</span> = <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">SiblingPosition</span>, <span class="hljs-title class_">UniqueId</span>&gt;&gt;
</code></pre>
</li>
</ol>
<p>除此之外，我们还需要该节点的<code>boundingRect</code>、<code>padding</code>、<code>margin</code>、<code>border</code>、<code>font</code>相关的信息，最终设计了如下的数据结构</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/** 节点信息 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">NodeInfo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SiblingRelativeNodeInfo</span> {
  <span class="hljs-comment">/** 父节点 id */</span>
  <span class="hljs-attr">parentId</span>: <span class="hljs-title class_">UniqueId</span>
  <span class="hljs-comment">/** 子节点 id */</span>
  <span class="hljs-attr">children</span>: <span class="hljs-title class_">UniqueId</span>[]
  <span class="hljs-comment">/** 兄弟节点 id */</span>
  <span class="hljs-attr">sibling</span>: <span class="hljs-title class_">UniqueId</span>[]
  <span class="hljs-attr">uniqueId</span>: <span class="hljs-title class_">UniqueId</span>
  <span class="hljs-attr">nodeName</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-comment">/** 节点边界 */</span>
  <span class="hljs-attr">boundingRect</span>: <span class="hljs-title class_">BoundingRect</span>
  <span class="hljs-comment">/** padding信息 */</span>
  <span class="hljs-attr">paddingInfo</span>: <span class="hljs-title class_">PaddingInfo</span>
  <span class="hljs-comment">/** border信息 */</span>
  <span class="hljs-attr">borderInfo</span>: <span class="hljs-title class_">BorderInfo</span>
  <span class="hljs-comment">/** 背景色 */</span>
  <span class="hljs-attr">backgroundColor</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-comment">/** 标签名称（设计稿则为节点类型） */</span>
  tagName?: <span class="hljs-built_in">string</span> | <span class="hljs-title class_">SceneNode</span>[<span class="hljs-string">'type'</span>]
  <span class="hljs-comment">/** 文本样式信息, 只有内部是文本的节点才有这个字段 */</span>
  textStyleInfo?: <span class="hljs-title class_">TextStyleInfo</span>
  <span class="hljs-comment">/** 节点的中心信息 <span class="hljs-doctag">@description</span> DOM ONLY */</span>
  nodeFlexInfo?: <span class="hljs-title class_">NodeFlexInfo</span>
  <span class="hljs-comment">/** 相邻节点的边距 */</span>
  <span class="hljs-attr">neighborMarginInfo</span>: <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">SiblingPosition</span>, <span class="hljs-title class_">NeighborMarginInfo</span>&gt;&gt;
}

</code></pre>
<h3 data-id="heading-7">数据归一化处理流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    Start([开始: rootNode]) --&gt; GetBounding[获取根节点 getBoundingClientRect]
    GetBounding --&gt; SetBounding[设置 rootBounding 到 domConfigs]
    SetBounding --&gt; CheckTextResize{检查设计稿是否有&lt;br/&gt;textAutoResize}
    CheckTextResize --&gt; RecordInfo[onDomInfoRecorder&lt;br/&gt;记录 DOM 信息]
    
    RecordInfo --&gt; SyncText[syncTextInfoToTextParentNode&lt;br/&gt;同步文本信息到父节点]
    SyncText --&gt; LargeLineHeight[processLargeLineHeight&lt;br/&gt;处理大行高场景]
    
    LargeLineHeight --&gt; ShouldShrink{是否需要处理&lt;br/&gt;shouldShrinkBounding?}
    ShouldShrink --&gt;|是| ProcessShrink[processDomNodeShouldShrinkBounding&lt;br/&gt;处理收缩边界]
    ShouldShrink --&gt;|否| ProcessZZUI[processDomZZUINode&lt;br/&gt;处理 ZZUI 节点]
    ProcessShrink --&gt; ProcessZZUI
    
    ProcessZZUI --&gt; SearchInitial[searchNeighborNodesInitial&lt;br/&gt;搜索初始邻居节点]
    SearchInitial --&gt; RemoveSame1[removeSameSizePositionChildren&lt;br/&gt;去除同位置同大小子节点 #1]
    
    RemoveSame1 --&gt; MarginCollapse[processMarginCollapsing&lt;br/&gt;处理 margin 折叠]
    MarginCollapse --&gt; Padding[processPaddingInfo&lt;br/&gt;处理 padding 信息]
    Padding --&gt; ShrinkRect[shrinkRectBounding&lt;br/&gt;收缩矩形边界]
    
    ShrinkRect --&gt; RemoveSame2[removeSameSizePositionChildren&lt;br/&gt;去除同位置同大小子节点 #2]
    RemoveSame2 --&gt; Match[recordHybridNodeMatchResult&lt;br/&gt;记录混合节点匹配结果]
    
    Match --&gt; SearchNeighbor[searchNeighborNodes&lt;br/&gt;搜索邻居节点]
    SearchNeighbor --&gt; Distance[getNeighborNodeDistance&lt;br/&gt;计算邻居节点距离]
    
    Distance --&gt; End([返回: FlatNodeMap])
    
    style Start fill:#e1f5e1
    style End fill:#ffe1e1
    style ShouldShrink fill:#fff4e1
    style CheckTextResize fill:#fff4e1
</code></pre>
<p>Dom侧数据处理与UI侧数据处理逻辑基本一致，上图为整个Dom结构数据处理流程，下面将对该流程中比较核心的部分进行讲解。</p>
<h4 data-id="heading-8"><code>processLargeLineHeight</code>处理行高问题</h4>
<p>处理行高问题，旨在抹平前端侧与UI侧在相同渲染效果下，因为设置了不同的行高导致节点高度不同造成的异常。行高数据的归一化处理依赖于节点内部的<code>textStyleInfo</code>，其结构如下</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TextStyleInfo</span> {
  <span class="hljs-comment">/** 行高 */</span>
  <span class="hljs-attr">lineHeight</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-comment">/** 文本宽度 */</span>
  <span class="hljs-attr">textWidth</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-comment">/** 字体大小 */</span>
  <span class="hljs-attr">fontSize</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-comment">/** 字体粗细 */</span>
	<span class="hljs-attr">fontWeight</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-comment">/** 字体 */</span>
  <span class="hljs-attr">fontFamily</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-comment">/** 文本行数 */</span>
  <span class="hljs-attr">textLineCount</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-comment">/** 文本对齐方向 */</span>
  <span class="hljs-attr">textAlignment</span>: <span class="hljs-title class_">TextAlignment</span>
  <span class="hljs-comment">/** 文本内容 */</span>
  <span class="hljs-attr">textContent</span>: <span class="hljs-built_in">string</span>
	<span class="hljs-comment">/** master go的文本节点的宽高策略 */</span>
  textAutoResize?: <span class="hljs-title class_">TextNode</span>[<span class="hljs-string">'textAutoResize'</span>]
}
</code></pre>
<p>其核心逻辑如下：</p>
<ol>
<li><strong>创建测量容器</strong></li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> measureElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>)
measureElement.<span class="hljs-property">style</span>.<span class="hljs-property">position</span> = <span class="hljs-string">'absolute'</span>
measureElement.<span class="hljs-property">style</span>.<span class="hljs-property">visibility</span> = <span class="hljs-string">'hidden'</span>
</code></pre>
<ol start="2">
<li><strong>克隆关键样式</strong></li>
</ol>
<p>复制影响文本布局的所有样式到测量元素：</p>
<ul>
<li><strong>字体样式</strong>: <code>fontSize</code>, <code>fontFamily</code>, <code>fontWeight</code></li>
<li><strong>排版</strong>: <code>lineHeight</code>, <code>whiteSpace</code>, <code>wordBreak</code>, <code>textTransform</code></li>
<li><strong>约束</strong>: <code>width</code>（使用原节点宽度）</li>
<li><strong>清零</strong>: <code>padding</code>, <code>margin</code>, <code>border</code>（避免干扰）</li>
</ul>
<ol start="3">
<li><strong>首次测量（多行场景）</strong></li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript">measureElement.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">`<span class="hljs-subst">${domNode.getBoundingClientRect().width}</span>px`</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(measureElement)
<span class="hljs-keyword">const</span> measureHeight = measureElementRect.<span class="hljs-property">height</span>
</code></pre>
<ul>
<li>设置<strong>固定宽度</strong>（与原节点一致）</li>
<li>测量文本在此宽度约束下的实际高度</li>
</ul>
<ol start="4">
<li><strong>计算行数</strong></li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> shouldUseOriginHeight = !isInline &amp;&amp; originHeight &lt; measureHeight
<span class="hljs-keyword">const</span> textHeight = shouldUseOriginHeight ? originHeight : measureHeight
<span class="hljs-keyword">const</span> lineCount = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">1</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(textHeight / lineHeightValue))
</code></pre>
<p><strong>关键逻辑</strong>：</p>
<ul>
<li>如果原节点是 <strong>block</strong> 且设置了固定高度，且该高度小于测量高度
<ul>
<li>说明文本被裁剪了（如 <code>height: 50px</code> 但文本实际需要 100px）</li>
<li>使用原始高度计算行数（因为实际显示的就是被裁剪的部分）</li>
</ul>
</li>
<li>否则使用测量高度</li>
<li><code>行数 = 文本高度 / 行高</code></li>
</ul>
<ol start="5">
<li><strong>单行特殊处理</strong></li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (lineCount &gt; <span class="hljs-number">1</span>) {
  <span class="hljs-keyword">return</span> baseTextStyle
}
<span class="hljs-comment">// 单行场景，重新计算宽度</span>
measureElement.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">'auto'</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(measureElement)
<span class="hljs-keyword">const</span> measureElementRect2 = measureElement.<span class="hljs-title function_">getBoundingClientRect</span>()
</code></pre>
<p>单行重新测量，根本上是为了确定单行文本的场景下实际占用的最小宽度。</p>
<p>在获取了<code>textStyleInfo</code>之后，就可以进行行高的归一化处理了。</p>
<ol>
<li><strong>Inline 节点特殊处理</strong></li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (isInlineNode &amp;&amp; !!parentNodeInfo) {
  nodeInfo.<span class="hljs-property">boundingRect</span>.<span class="hljs-property">y</span> = parentNodeInfo.<span class="hljs-property">boundingRect</span>.<span class="hljs-property">y</span>
  nodeInfo.<span class="hljs-property">boundingRect</span>.<span class="hljs-property">height</span> = parentNodeInfo.<span class="hljs-property">boundingRect</span>.<span class="hljs-property">height</span>
  <span class="hljs-keyword">return</span>
}
</code></pre>
<p>inline节点的处理是一个大坑，在MasterGo的渲染器中，文字始终是在<code>TextNode</code>中居中处理的，但是在前端文本中，文本是以baseline为基准对齐的，文字在lnlineNode中的居中方式，取决于字体本身的设置，而非始终居中渲染。因此此套逻辑只能在非行内元素中使用，而行内元素的宽高则始终与父节点保持一致。</p>
<ol start="2">
<li><strong>单行文本行高大于字体大小的场景处理</strong></li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> realHeight = boundingRect.<span class="hljs-property">height</span> - paddingBottom - paddingTop

<span class="hljs-keyword">if</span> (textLineCount &gt; <span class="hljs-number">1</span> || fontSize === realHeight) {
  <span class="hljs-keyword">return</span>
}

<span class="hljs-keyword">const</span> deltaValue = realHeight - fontSize
nodeInfo.<span class="hljs-property">boundingRect</span>.<span class="hljs-property">y</span> = boundingRect.<span class="hljs-property">y</span> + deltaValue / <span class="hljs-number">2</span>
nodeInfo.<span class="hljs-property">boundingRect</span>.<span class="hljs-property">height</span> = fontSize + paddingTop + paddingBottom
</code></pre>
<p><strong>调整方式</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">原始高度 = <span class="hljs-number">50px</span> (行高撑开)
字体大小 = <span class="hljs-number">14px</span>
多余空间 = <span class="hljs-number">36px</span>

调整后：
- Y 坐标下移：y + <span class="hljs-number">18px</span> (居中)
- 高度缩小：<span class="hljs-number">14px</span> + <span class="hljs-attribute">padding</span>
</code></pre>
<h4 data-id="heading-9"><code>processMarginCollapsing</code>处理边距合并的场景</h4>
<p>要理解这一步骤，首先需要理解CSS中的核心概念：<strong>Margin 折叠（Margin Collapsing）</strong></p>
<h5 data-id="heading-10">Margin Collapsing介绍</h5>
<p>在特定条件下，<strong>子元素的 margin 会穿透父元素边界</strong>，直接作用到父元素外部。举个例子：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"background: lightblue;"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin-top: 30px; background: pink;"</span>&gt;</span>
    子元素
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p><strong>预期效果</strong>：子元素距离父元素顶部 30px<br/>
<strong>实际效果</strong>：父元素整体向下移动 30px，子元素紧贴父元素顶部</p>
<pre><code class="hljs">❌ 预期布局                ✅ 实际布局
┌─────────────┐           ↓ 30px
│  Parent     │           ┌─────────────┐
│  ↓ 30px     │           │  Parent     │
│  ┌────────┐ │           │┌────────┐   │
│  │ Child  │ │           ││ Child  │   │
│  └────────┘ │           │└────────┘   │
└─────────────┘           └─────────────┘
</code></pre>
<h5 data-id="heading-11">不会发生 Margin 折叠的条件：</h5>
<ol>
<li>
<p>BFC区域</p>
</li>
<li>
<p>父节点有边界或者背景</p>
</li>
<li>
<p>Flex、Grid布局</p>
</li>
<li>
<p>节点中有内联文本</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
  内联文本
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin-top: 30px;"</span>&gt;</span>子元素<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
</li>
</ol>
<h5 data-id="heading-12">处理逻辑</h5>
<ol>
<li>判断是否会发生Margin折叠</li>
<li>会发生Margin折叠时，对应方向上是否有子节点有<code>margin</code></li>
<li>有<code>margin</code>时，将子节点设置为<code>margin: 0</code>,并将父节点对应方向上的<code>margin</code>设置为子节点的值与父节点的值中的最大值。</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">hoistingNotBfcBoundaryMargin</span>(<span class="hljs-params">domNode: HTMLElement</span>) {
  <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(domNode.<span class="hljs-property">children</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">childNode</span>) =&gt;</span> {
    <span class="hljs-comment">// 反向DFS，先走最内部节点，然后往外走</span>
    <span class="hljs-title function_">hoistingNotBfcBoundaryMargin</span>(childNode <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLElement</span>)
  })
  <span class="hljs-comment">// 是否是bfc</span>
  <span class="hljs-keyword">const</span> isBFC = <span class="hljs-title function_">getDomIsBfc</span>(domNode)
  <span class="hljs-comment">// 是否是flex or grid</span>
  <span class="hljs-keyword">const</span> isFlexOrGridItem = <span class="hljs-title function_">getIsFlexOrGridItem</span>(domNode)
  <span class="hljs-comment">// 是否有内联元素</span>
  <span class="hljs-keyword">const</span> hasInlineContent = <span class="hljs-title function_">getHasInlineContent</span>(domNode)
  <span class="hljs-comment">// 是否有clear</span>
  <span class="hljs-keyword">const</span> hasClearance = <span class="hljs-title function_">getHasClearance</span>(domNode)
  <span class="hljs-keyword">const</span> childNodeList = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(domNode.<span class="hljs-property">children</span>).<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">childNode</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> isDataTextWrapper = childNode.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'data-text-wrapper'</span>) === <span class="hljs-string">'1'</span>
    <span class="hljs-keyword">return</span> !isDataTextWrapper
  })

  <span class="hljs-comment">// 全部为false才需要提升margin</span>
  <span class="hljs-keyword">const</span> preJudgeResult = [isBFC, isFlexOrGridItem, hasInlineContent, hasClearance, !childNodeList.<span class="hljs-property">length</span>].<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">it</span> =&gt;</span> !it)
  <span class="hljs-keyword">if</span> (!preJudgeResult) {
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-keyword">const</span> shouldHoistTopMargin = <span class="hljs-title function_">judgeDomNodeMarginHoisting</span>(domNode, <span class="hljs-string">'top'</span>)
  <span class="hljs-keyword">const</span> shouldHoistBottomMargin = <span class="hljs-title function_">judgeDomNodeMarginHoisting</span>(domNode, <span class="hljs-string">'bottom'</span>)

  <span class="hljs-keyword">if</span> (shouldHoistTopMargin) {
    <span class="hljs-title function_">hostingTargetDirectionMargin</span>(domNode, <span class="hljs-string">'top'</span>)
  }
  <span class="hljs-keyword">if</span> (shouldHoistBottomMargin) {
    <span class="hljs-title function_">hostingTargetDirectionMargin</span>(domNode, <span class="hljs-string">'bottom'</span>)
  }
}
</code></pre>
<h4 data-id="heading-13"><code>processPaddingInfo</code> 合并padding逻辑</h4>
<p>在UI设计稿中，他们的边距可能是两个节点之间的距离，也可能是自动化布局的时候配置的padding。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62397a9d03f0475b8b1864cde4cd7118~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764297289&amp;x-signature=Gzi3vLX%2Bwf6z%2Fe4W03m2zFf%2F4q0%3D" alt="不同的边距实现" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73fd3385f9a54921a055458baee215d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764297289&amp;x-signature=2oOCKd%2Fomtqcg%2B7IsT3fyoHDpbc%3D" alt="边距场景2" loading="lazy"/></p>
<p>而在前端页面中，由于时常要考虑到节点存在与不存在的情况下的间距稳定性，因此常会出现各种拼接边距的情况。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7a05bc50005456aa8ab4f2933fcff42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764297289&amp;x-signature=hzJfsAajEZzBPvjWBvPlot%2FBCJw%3D" alt="拼接边距场景" loading="lazy"/></p>
<p>所以需要将纯粹地用来作为拼接边距的padding，从当前节点的width和height中排除出去，让节点的尺寸中不包含任何多余的无效padding。本处理方法的核心逻辑如下</p>
<ol>
<li>对每个节点的上、下、左、右四个方向独立处理</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript">paddingInfoDirectionList.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">currentPosition</span>) =&gt;</span> {
  <span class="hljs-comment">// top, right, bottom, left</span>
})
</code></pre>
<ol start="2">
<li>判断当前方向的 padding 是否可以被合并（可能需要检查子节点是否占用了这个空间）</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> targetDirectionPaddingValue = <span class="hljs-title function_">getTargetDirectionPaddingValue</span>({
  currentNodeInfo,
  flatNodeMap,
  <span class="hljs-attr">position</span>: currentPosition,
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getTargetDirectionPaddingValue</span>(<span class="hljs-params">{ currentNodeInfo, position }: JudgeMergableConfig</span>) {
  <span class="hljs-keyword">const</span> paddingKey = <span class="hljs-title function_">camel</span>(<span class="hljs-string">`padding <span class="hljs-subst">${position}</span>`</span>) <span class="hljs-keyword">as</span> keyof <span class="hljs-title class_">PaddingInfo</span>
  <span class="hljs-comment">// 是否存在目标方向的padding</span>
  <span class="hljs-keyword">const</span> targetDirectionPaddingValue = currentNodeInfo.<span class="hljs-property">paddingInfo</span>[paddingKey]
  <span class="hljs-keyword">return</span> targetDirectionPaddingValue || <span class="hljs-number">0</span>
}
</code></pre>
<ol start="3">
<li>执行合并操作</li>
<li><strong>扩展边界框</strong>：将 padding 空间纳入 boundingRect</li>
<li><strong>减少 padding 值</strong>：从 paddingInfo 中扣除已合并的值</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 合并padding
 * <span class="hljs-doctag">@param</span> curNodeInfo 当前节点信息
 * <span class="hljs-doctag">@param</span> position 目标方向
 * <span class="hljs-doctag">@param</span> paddingInfo 目标方向的padding值
 * <span class="hljs-doctag">@returns</span> 合并后的节点信息
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleMergePadding</span>(<span class="hljs-params">curNodeInfo: NodeInfo, position: <span class="hljs-string">'left'</span> | <span class="hljs-string">'right'</span> | <span class="hljs-string">'top'</span> | <span class="hljs-string">'bottom'</span>, paddingInfo: <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-keyword">const</span> clonedBoundingRect = <span class="hljs-title function_">clone</span>(curNodeInfo.<span class="hljs-property">boundingRect</span>)
  <span class="hljs-keyword">if</span> (position === <span class="hljs-string">'left'</span>) {
    clonedBoundingRect.<span class="hljs-property">x</span> += paddingInfo
    clonedBoundingRect.<span class="hljs-property">width</span> -= paddingInfo
  }
  <span class="hljs-keyword">if</span> (position === <span class="hljs-string">'right'</span>) {
    clonedBoundingRect.<span class="hljs-property">width</span> -= paddingInfo
  }
  <span class="hljs-keyword">if</span> (position === <span class="hljs-string">'top'</span>) {
    clonedBoundingRect.<span class="hljs-property">y</span> += paddingInfo
    clonedBoundingRect.<span class="hljs-property">height</span> -= paddingInfo
  }
  <span class="hljs-keyword">if</span> (position === <span class="hljs-string">'bottom'</span>) {
    clonedBoundingRect.<span class="hljs-property">height</span> -= paddingInfo
  }
  <span class="hljs-keyword">return</span> clonedBoundingRect
}

<span class="hljs-comment">/**
 * 减去已被合并的padding值
 * <span class="hljs-doctag">@param</span> curNodeInfo 当前节点信息
 * <span class="hljs-doctag">@param</span> position 目标方向
 * <span class="hljs-doctag">@param</span> paddingInfo 目标方向的padding值
 * <span class="hljs-doctag">@returns</span> 减去padding值后的节点信息
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSubtractPaddingValue</span>(<span class="hljs-params">curNodeInfo: NodeInfo, position: <span class="hljs-string">'left'</span> | <span class="hljs-string">'right'</span> | <span class="hljs-string">'top'</span> | <span class="hljs-string">'bottom'</span>, paddingInfo: <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-keyword">const</span> clonedPaddingInfo = <span class="hljs-title function_">clone</span>(curNodeInfo.<span class="hljs-property">paddingInfo</span>)
  <span class="hljs-keyword">const</span> paddingKey = <span class="hljs-title function_">camel</span>(<span class="hljs-string">`padding <span class="hljs-subst">${position}</span>`</span>) <span class="hljs-keyword">as</span> keyof <span class="hljs-title class_">PaddingInfo</span>
  clonedPaddingInfo[paddingKey] -= paddingInfo
  <span class="hljs-keyword">return</span> clonedPaddingInfo
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">processingPaddingInfo</span>(<span class="hljs-params"/>) {
	<span class="hljs-comment">//...</span>
  <span class="hljs-keyword">const</span> paddingMergedBoundingRect = <span class="hljs-title function_">handleMergePadding</span>(
    currentNodeInfo, 
    currentPosition, 
    targetDirectionPaddingValue
  )
  <span class="hljs-keyword">const</span> newPaddingInfo = <span class="hljs-title function_">handleSubtractPaddingValue</span>(
    currentNodeInfo, 
    currentPosition, 
    targetDirectionPaddingValue
  )
	<span class="hljs-comment">//...</span>
}
</code></pre>
<h4 data-id="heading-14"><code>shrinkRectBounding</code>收缩矩形边界</h4>
<h5 data-id="heading-15">为什么要收缩矩形边界？</h5>
<p>在UI设计稿中，存在一些质量不可控的现象，比如
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0497940248b74e039385d1e4045a38d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764297289&amp;x-signature=5bd7aSPDY1Jphp7Pv%2BBeETJxD%2Bc%3D" alt="初始效果" loading="lazy"/></p>
<p>在这个设计稿中，看似左侧的成色+定级标准节点与右侧的上下边距混乱，毫无居中的感觉。但是倘若我们对他进行一下变更：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e7e1057d6694876ad4f92774a755c0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764297289&amp;x-signature=Xt%2Fg32I%2BDmMGh6yZCFhjLIZi9BM%3D" alt="居中后的效果" loading="lazy"/>实际上只需要处理好左侧的高度，右侧的高度完全可以和左侧相同，并处理成为 <code>justify-content: space-between</code>即可。</p>
<p>但是当FE拿到第一张图的时候，并不会一眼就看出来左右两侧的高度是可以完全一样的（因为选中左侧的时候是一个大的rectangle）</p>
<p>这个例子告诉我们，在UI侧常会存在一些凌乱的、难以用直觉判断实际效果的设计节点。这时候如果想要用自动化的方案进行比对，就需要针对这些噪声进行降噪处理。在本文中，采用的就是<strong>以实际渲染内容为主的节点收缩方案</strong></p>
<p>主要逻辑就是尽可能的收缩节点的尺寸，让其可以紧凑地包裹在内容之外，尽可能地不包含多余的空间。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac402f7ae2cc49cd8f3f49ef50fa89f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764297289&amp;x-signature=oX4BLxAaphuTu2bJRH97t8DSOIg%3D" alt="设计稿边距收缩效果" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96e2678c771e4fc0bdc677873ff07e78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764297289&amp;x-signature=qi4XIlYZn8RgCHwA%2Bx5%2Fn1EYxBI%3D" alt="HTML边距收缩效果" loading="lazy"/></p>
<p>在做完这些工作后，便可以进行节点与其相邻节点的间距计算了。</p>
<h3 data-id="heading-16">Dom与设计稿数据的预处理逻辑</h3>
<p>所谓预处理逻辑，旨在解决归一化处理数据时遇到的一些特殊case。包括但不限于：设计稿蒙版节点处理、设计稿使用rectange节点作为背景色节点的逻辑处理、前端px2rem误差精度修正等</p>
<h4 data-id="heading-17">设计稿蒙版节点处理</h4>
<p>在设计稿中 Mask 的形式如下</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">GROUP</span>
├─ 图片 <span class="hljs-selector-tag">A</span>
├─ 图片 <span class="hljs-selector-tag">B</span>
└─ 圆形 (<span class="hljs-attribute">isMask</span>: true)  ← <span class="hljs-selector-tag">Mask</span> 图层
</code></pre>
<p>其效果为：圆形作为遮罩，图片 A 和 B 只显示圆形范围内的部分。</p>
<p>虽然蒙版节点与被蒙版的节点是同一层的几个节点，但是从效果上来说，被蒙版的节点，可以视为蒙版的子节点。因此，将蒙版节点及被蒙版的节点视为一个父子结构，可以有效简化数据结构的处理。其流程如下：</p>
<ol>
<li><strong>查找 Mask 节点</strong>
<ol>
<li>先<strong>反转</strong>子节点列表（因为设计工具中 mask 在图层堆叠的底部）</li>
<li>找出所有可见的 <code>isMask: true</code> 节点的索引</li>
</ol>
</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> reversedChildNodeList = originChildNodeList.<span class="hljs-title function_">toReversed</span>()

<span class="hljs-keyword">const</span> childMastIndexList = reversedChildNodeList
  .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">it</span> =&gt;</span> !!it.<span class="hljs-property">isVisible</span>)
  .<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">prev, it, index</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!nodeCanBeMaskSet.<span class="hljs-title function_">has</span>(curNode.<span class="hljs-property">type</span>) || !curNode.<span class="hljs-property">isMask</span>) {
      <span class="hljs-keyword">return</span> prev
    }
    <span class="hljs-keyword">return</span> [...prev, index]
  }, [] <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>[])
</code></pre>
<ol start="2">
<li><strong>计算 Mask 影响范围</strong>
<ol>
<li>Mask 节点会影响它<strong>上方</strong>的所有节点（直到遇到下一个 mask）</li>
<li>计算每个 mask 的影响范围 <code>[start, end]</code></li>
</ol>
</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> maskChildIndexStartEndList = childMastIndexList
  .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">it, index, originArr</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (index === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> [reversedChildNodeList.<span class="hljs-property">length</span> - it, reversedChildNodeList.<span class="hljs-property">length</span>]
    }
    <span class="hljs-keyword">return</span> [reversedChildNodeList.<span class="hljs-property">length</span> - it, reversedChildNodeList.<span class="hljs-property">length</span> - originArr[index - <span class="hljs-number">1</span>] - <span class="hljs-number">1</span>]
  })
  .<span class="hljs-title function_">toReversed</span>()
</code></pre>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">原始顺序（反转后）：</span>
[<span class="hljs-attr">0:</span> <span class="hljs-string">图片A</span>, <span class="hljs-attr">1:</span> <span class="hljs-string">图片B</span>, <span class="hljs-attr">2:</span> <span class="hljs-string">Mask1</span>, <span class="hljs-attr">3:</span> <span class="hljs-string">图片C</span>, <span class="hljs-attr">4:</span> <span class="hljs-string">Mask2</span>]
                      <span class="hljs-string">↑</span>                    <span class="hljs-string">↑</span>
<span class="hljs-string">Mask1</span> <span class="hljs-string">影响范围:</span> [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>]  <span class="hljs-string">(图片A,</span> <span class="hljs-string">图片B)</span>
<span class="hljs-string">Mask2</span> <span class="hljs-string">影响范围:</span> [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>]  <span class="hljs-string">(图片C)</span>
</code></pre>
<p>3.  <strong>创建新的 FRAME 容器</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> newFrameNode = {
  ...emptyFrameNode,           <span class="hljs-comment">// 基础 FRAME 属性</span>
  <span class="hljs-attr">id</span>: <span class="hljs-string">`<span class="hljs-subst">${id}</span><span class="hljs-subst">${MASK_REPLACE_SUFFIX}</span>`</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">`<span class="hljs-subst">${name}</span><span class="hljs-subst">${MASK_REPLACE_SUFFIX}</span>`</span>,
  <span class="hljs-comment">// 继承 mask 节点的位置和尺寸</span>
  absoluteTransform,
  relativeTransform,
  x, y, width, height,
  cornerRadius,                <span class="hljs-comment">// 继承圆角</span>
  <span class="hljs-attr">clipsContent</span>: <span class="hljs-literal">true</span>,          <span class="hljs-comment">// 关键：裁剪内容</span>
  children,                    <span class="hljs-comment">// 被遮罩的内容</span>
}
</code></pre>
<ol start="4">
<li>
<p><strong>优化：单个 Mask 且尺寸一致</strong></p>
<p>如果只有一个 mask 且和父容器尺寸相同，直接替换父节点，减少层级。</p>
</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> isSameSize = currentNode.<span class="hljs-property">width</span> === firstMaskRelpaceNodeInfo.<span class="hljs-property">width</span> 
  &amp;&amp; currentNode.<span class="hljs-property">height</span> === firstMaskRelpaceNodeInfo.<span class="hljs-property">height</span>

<span class="hljs-keyword">if</span> (newChildGroupList.<span class="hljs-property">length</span> === <span class="hljs-number">1</span> &amp;&amp; isSameSize) {
  <span class="hljs-comment">// 直接合并到父节点</span>
  <span class="hljs-keyword">return</span> {
    ...currentNode,
    ...firstMaskRelpaceNodeInfo,
  }
}
</code></pre>
<h4 data-id="heading-18">设计稿背景节点的提升</h4>
<p>由于一些原Adobe软件 or sketch的操作习惯，且在MasterGo工具中，Group节点无法主动设置宽高，因此常使用group节点+rectangle节点的方式去撑开一个节点或者给一个节点设置背景色。而这个rectangle节点在比对过程中则属于一个需要忽略的节点，因此在此预处理逻辑中，需要识别背景色节点，并将背景色提升到父节点的属性上去，简化图层结构。其处理流程如下：</p>
<ol>
<li><strong>分离背景图层和内容图层</strong></li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">judgeIsBgStyleRectangle</span>(<span class="hljs-params">currentNode: PenNode | RectangleNode, parentNode: FrameNode | GroupNode</span>) {
  <span class="hljs-keyword">const</span> { width, height } = currentNode
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">width</span>: parentWidth, <span class="hljs-attr">height</span>: parentHeight } = parentNode
  <span class="hljs-keyword">const</span> deltaWidth = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(width - parentWidth)
  <span class="hljs-keyword">const</span> deltaHeight = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(height - parentHeight)
  <span class="hljs-comment">// 大于为图片 + mask 或者 图片+overflow hidden的场景</span>
  <span class="hljs-keyword">const</span> isSameSize = deltaWidth &lt; <span class="hljs-number">2</span> &amp;&amp; deltaHeight &lt; <span class="hljs-number">2</span>
  <span class="hljs-keyword">return</span> isSameSize
}

<span class="hljs-comment">// 背景图层：RECTANGLE/PEN 且判断为背景样式</span>
<span class="hljs-keyword">const</span> bgStyleNodeList = currentNode.<span class="hljs-property">children</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">it</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (it.<span class="hljs-property">type</span> !== <span class="hljs-string">'RECTANGLE'</span> &amp;&amp; it.<span class="hljs-property">type</span> !== <span class="hljs-string">'PEN'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">judgeIsBgStyleRectangle</span>(it, currentNode)
})

<span class="hljs-comment">// 其他图层：非背景的内容</span>
<span class="hljs-keyword">const</span> restNodeChildList = currentNode.<span class="hljs-property">children</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">it</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (it.<span class="hljs-property">type</span> !== <span class="hljs-string">'RECTANGLE'</span> &amp;&amp; it.<span class="hljs-property">type</span> !== <span class="hljs-string">'PEN'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  <span class="hljs-keyword">return</span> !<span class="hljs-title function_">judgeIsBgStyleRectangle</span>(it, currentNode)
})
</code></pre>
<ol start="2">
<li><strong>合并背景样式</strong></li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 合并所有背景图层的填充</span>
<span class="hljs-keyword">const</span> combinedFillList = bgStyleNodeList.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">node</span> =&gt;</span> node.<span class="hljs-property">fills</span> || [])
</code></pre>
<h4 data-id="heading-19">前端px2rem误差精度修正</h4>
<p>转转App的px2rem方案走的是常规的px2rem方案，root上的<code>font-size</code>配置为了<code>document.clientWidth / 10</code>的值，rem值的取值精度为两位小数。</p>
<p>在前端响应式配置设置为iphone se（<code>375px</code>）的场景下，其页面实际渲染的值并非设计稿的一半。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec3ce85caaa94568a1115539b332073f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764297289&amp;x-signature=a9BfSPsIZ0R0NLH1DzGkh34Gkdk%3D" alt="px2rem误差" loading="lazy"/></p>
<p>单个节点的场景误差尚可以用四舍五入的逻辑修正，但是在多数值拼接的场景下，误差可能会被放大，导致比对异常。因此需要对px2rem精度进行修正，以避免过多的误差出现。</p>
<ul>
<li><strong>模块结构</strong></li>
</ul>
<pre><code class="hljs language-shell" lang="shell">📦 css-hacker
├─ main-hacker.ts      # 主流程编排
├─ dom-parser.ts       # 解析页面样式表
├─ css-fetcher.ts      # 获取 CSS 内容
├─ css-modifier.ts     # 修改 CSS 内容
├─ css-injector.ts     # 注入修改后的 CSS
├─ convert-px2rem-deviation.ts  # rem 单位转换插件
└─ types.ts            # 类型定义
</code></pre>
<ul>
<li><strong>核心流程</strong></li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[开始] --&gt; B[解析页面获取外部样式表 URL]
    B --&gt; C{有外部样式表?}
    C --&gt;|否| D[结束]
    C --&gt;|是| E[批量获取 CSS 内容]
    E --&gt; F[遍历每个 CSS 文件]
    F --&gt; G[使用 modifier 修改内容]
    G --&gt; H[注入修改后的 CSS]
    H --&gt; I[删除原始 link 标签]
    I --&gt; J{还有文件?}
    J --&gt;|是| F
    J --&gt;|否| K[完成]
</code></pre>
<ul>
<li><strong>核心逻辑：</strong></li>
</ul>
<p>通过px2rem逻辑，构建一个1-2000数值的哈希Map，key为rem的值，value为原px值。</p>
<p>通过劫持页面CSS文件，用一个自定义的postcss插件，配合预配置的Map，将px值反向映射为设计稿原值。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 单例1-2000映射Map</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PxConvertMapSingleton</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">instance</span>: <span class="hljs-title class_">PxConvertMapSingleton</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">convertMap</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span>&gt;

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">convertMap</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateConvertMap</span>()
  }

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getInstance</span>(): <span class="hljs-title class_">PxConvertMapSingleton</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">PxConvertMapSingleton</span>.<span class="hljs-property">instance</span>) {
      <span class="hljs-title class_">PxConvertMapSingleton</span>.<span class="hljs-property">instance</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PxConvertMapSingleton</span>()
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">PxConvertMapSingleton</span>.<span class="hljs-property">instance</span>
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">convertPx</span>(<span class="hljs-attr">originPxValue</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">const</span> originRemValue = originPxValue / <span class="hljs-number">750</span> * <span class="hljs-number">10</span>
    <span class="hljs-keyword">const</span> remValue = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(originRemValue * <span class="hljs-number">100</span>) / <span class="hljs-number">100</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(remValue * <span class="hljs-number">37.5</span> * <span class="hljs-number">1000</span>) / <span class="hljs-number">1000</span>
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">generateConvertMap</span>(): <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span>&gt; {
    <span class="hljs-keyword">const</span> startValue = <span class="hljs-number">1</span>
    <span class="hljs-keyword">const</span> endValue = <span class="hljs-number">2000</span>

    <span class="hljs-keyword">const</span> entries = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: endValue - startValue + <span class="hljs-number">1</span> }).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_, index</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> curValue = index + startValue
      <span class="hljs-keyword">if</span> (curValue === <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>
      }

      <span class="hljs-keyword">return</span> [<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertPx</span>(curValue), curValue] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>
    })

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(entries)
  }

  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getConvertMap</span>(): <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">convertMap</span>
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getPxConvertMap</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span>&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">PxConvertMapSingleton</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getConvertMap</span>()
}

</code></pre>
<p>再通过设计稿数据处理方案转换成前端页面实际的px值，最终形成新的css样式表注入到HTML中。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> remRegex = <span class="hljs-regexp">/(\d+(?:\.\d+)?|\.\d+)rem/gi</span>
<span class="hljs-comment">/** 处理CSS属性值中的rem单位，转换为px */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">processRemInValue</span>(<span class="hljs-params">value: <span class="hljs-built_in">string</span>, baseFontSize: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">if</span> (!value || !value.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'rem'</span>)) {
    <span class="hljs-keyword">return</span> value
  }
  <span class="hljs-keyword">const</span> convertMap = <span class="hljs-title function_">getPxConvertMap</span>()
  <span class="hljs-keyword">return</span> value.<span class="hljs-title function_">replace</span>(remRegex, <span class="hljs-function">(<span class="hljs-params">_match, remValue</span>) =&gt;</span> {
    <span class="hljs-comment">// rem值</span>
    <span class="hljs-keyword">const</span> convertedRemValue = <span class="hljs-title class_">Number</span>(remValue)
    <span class="hljs-comment">// 四舍五入取4位精度</span>
    <span class="hljs-keyword">const</span> convertedPxValue = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(convertedRemValue * baseFontSize * <span class="hljs-number">10000</span>) / <span class="hljs-number">10000</span>
    <span class="hljs-keyword">const</span> designValue = convertMap.<span class="hljs-title function_">get</span>(convertedPxValue)

    <span class="hljs-keyword">if</span> (!designValue) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${convertedRemValue}</span>rem`</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${convertDesignToPx(designValue)}</span>px`</span>
  })
}

<span class="hljs-comment">// post-css插件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">convertPx2RemDeviation</span>: <span class="hljs-title class_">PluginCreator</span>&lt;<span class="hljs-title class_">Px2RemDeviationOptions</span>&gt; = <span class="hljs-function">(<span class="hljs-params">opts</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> combinedOptions = { ...(opts || {}), ...defaultOptions }
  <span class="hljs-keyword">const</span> { baseFontSize } = combinedOptions

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">postcssPlugin</span>: <span class="hljs-string">'convert-px2rem-deviation'</span>,

    <span class="hljs-title class_">Rule</span>(<span class="hljs-attr">rule</span>: <span class="hljs-title class_">Rule</span>) {
      rule.<span class="hljs-title function_">walkDecls</span>(<span class="hljs-function">(<span class="hljs-params">decl: Declaration</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> value = decl.<span class="hljs-property">value</span>

        <span class="hljs-keyword">if</span> (!value || !value.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'rem'</span>)) {
          <span class="hljs-keyword">return</span>
        }

        <span class="hljs-keyword">const</span> newValue = <span class="hljs-title function_">processRemInValue</span>(value, baseFontSize)
        decl.<span class="hljs-property">value</span> = newValue
      })
    },
  }
}

convertPx2RemDeviation.<span class="hljs-property">postcss</span> = <span class="hljs-literal">true</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> convertPx2RemDeviation

</code></pre>
<ul>
<li>
<p><strong>为什么不通过<code>computedStyle</code>进行反向映射？</strong></p>
<p>原因在于<code>computedStyle</code>获取到的值无法通过1-2000的Map直接进行映射，比如一个<code>box-sizing:border-box</code>的div节点，需要面临三种场景：</p>
<ul>
<li>如果其宽度是直接设置的，则需要拆解成<code>padding</code>、<code>border</code> 、<code>width</code>三部分分别进行映射。</li>
<li>如果其宽度是撑满父容器的，则需要受控于其父容器的宽度。</li>
<li>如果是被子节点撑开的，则又需要分别计算子节点的宽度进行组合。</li>
</ul>
<p>其整体判断逻辑复杂程度高，难以理清。所以采用css注入的方式从css文件层面去解决精度问题，是当前最优解。</p>
</li>
</ul>
<h3 data-id="heading-20">Dom节点与UI节点的匹配</h3>
<p>节点匹配策略为一块较为独立且完整的模块，由于时间、人力等一些问题，目前的节点匹配方案为常规的IOU匹配方案，匹配准确率约为40%~60%左右，有较高的优化空间，并将在后续的开发中探索匹配层面的优化方案，以提高匹配率和检测准确度。</p>
<h4 data-id="heading-21">基本匹配策略</h4>
<p>节点匹配算法采用<strong>欧几里得距离计算</strong>的方式，综合考虑节点的位置和尺寸信息：</p>
<ul>
<li><strong>位置距离</strong>：计算两个节点中心点的欧几里得距离</li>
<li><strong>尺寸距离</strong>：计算两个节点宽高的欧几里得距离</li>
<li><strong>综合距离</strong>：通过加权平均得到最终匹配分数</li>
</ul>
<h4 data-id="heading-22">距离计算公式</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 位置距离计算</span>
<span class="hljs-keyword">const</span> positionDistance = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(
  (x - mgX)  <span class="hljs-number">2</span> + (y - mgY)  <span class="hljs-number">2</span>
)
 
<span class="hljs-comment">// 尺寸距离计算</span>
<span class="hljs-keyword">const</span> sizeDistance = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(
  (width - mgWidth)  <span class="hljs-number">2</span> + (height - mgHeight)  <span class="hljs-number">2</span>
)
 
<span class="hljs-comment">// 综合距离（位置权重 0.7，尺寸权重 0.3）</span>
<span class="hljs-keyword">const</span> totalDistance = positionDistance  <span class="hljs-number">0.7</span> + sizeDistance  <span class="hljs-number">0.3</span>
 
</code></pre>
<h4 data-id="heading-23">匹配阈值机制</h4>
<ul>
<li><strong>最大可接受距离</strong>：MAX_ACCEPTABLE_DISTANCE = 100</li>
<li>只有当综合距离小于阈值时，才会被认为是有效匹配</li>
<li>在所有有效匹配中选择距离最小的作为最终匹配结果</li>
</ul>
<h4 data-id="heading-24">算法流程</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1825ae8df6c248d8a7fc18e36e43471d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764297289&amp;x-signature=8iiyDxXLoUT4CRusMylVRsBMby4%3D" alt="匹配算法流程" loading="lazy"/></p>
<h3 data-id="heading-25">部分区域UI比对逻辑</h3>
<p>上述的比对逻辑虽是比较通用的逻辑，但是在初版实现时，以全页面的比对逻辑为主。但是在实际业务开发过程中，对页面部分区域进行修改的需求数量是多余构建全新页面的需求数量的。因此部分区域比对逻辑是比较关键的一环。</p>
<p>这部分开发的重点在于如何快速简单地让用户选中需要比对的区域？</p>
<p>可以通过chrome插件中的<strong>devtools</strong>相关功能来实现。</p>
<h4 data-id="heading-26">chrome插件通信时序图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User as 👤 用户
    participant DevTools as 🔧 DevTools Panel
    participant BG as 🎯 Background Script
    participant CS as 📄 Content Script
    participant Page as 🌐 被检查页面

    Note over DevTools,BG: 1. 初始化阶段
    User-&gt;&gt;DevTools: 打开 DevTools 面板
    DevTools-&gt;&gt;BG: connect({ name: 'UI_DIFF_PANEL' })
    activate BG
    BG--&gt;&gt;DevTools: Port 连接成功
    DevTools-&gt;&gt;BG: PORT_REGISTER&lt;br/&gt;{ tabId: 123 }
    Note right of BG: 存储 DevTools Port&lt;br/&gt;portMap[123] = port
    BG--&gt;&gt;DevTools: 注册成功
    deactivate BG

    Note over CS,BG: 2. Content Script 准备
    User-&gt;&gt;Page: 打开/刷新页面
    CS-&gt;&gt;CS: 初始化 UI Diff 功能
    
    Note over User,Page: 3. 用户选择元素
    User-&gt;&gt;DevTools: 在 Elements 面板&lt;br/&gt;点击选中元素
    Note right of DevTools: 元素被赋值给 $0
    
    Note over CS,Page: 4. 获取选中元素流程
    CS-&gt;&gt;BG: 发送消息&lt;br/&gt;GET_ELEMENT_SELECTOR&lt;br/&gt;{ tabId: 123 }
    activate BG
    BG-&gt;&gt;BG: 查找对应的 DevTools Port&lt;br/&gt;portMap[123]
    BG-&gt;&gt;DevTools: 转发消息&lt;br/&gt;GET_ELEMENT_SELECTOR
    deactivate BG
    
    activate DevTools
    DevTools-&gt;&gt;Page: inspectedWindow.eval(&lt;br/&gt;getElementSelector($0)&lt;br/&gt;)
    activate Page
    Page-&gt;&gt;Page: 遍历 DOM 树&lt;br/&gt;构建 CSS Selector
    Page--&gt;&gt;DevTools: 返回 Selector 字符串&lt;br/&gt;"#app &gt; div.container"
    deactivate Page
    
    DevTools-&gt;&gt;BG: RETURN_ELEMENT_SELECTOR&lt;br/&gt;{ tabId, selector }
    deactivate DevTools
    
    activate BG
    BG-&gt;&gt;BG: 查找对应的标签页
    BG-&gt;&gt;CS: chrome.tabs.sendMessage&lt;br/&gt;{ selector: "..." }
    deactivate BG
    
    activate CS
    CS-&gt;&gt;CS: 使用 Selector 定位元素&lt;br/&gt;document.querySelector(selector)
    CS-&gt;&gt;Page: getBoundingClientRect()
    Page--&gt;&gt;CS: { x, y, width, height }
    CS-&gt;&gt;CS: 执行 UI Diff 对比逻辑
    deactivate CS

    Note over User,Page: 5. 完成对比
    CS--&gt;&gt;User: 显示对比结果
</code></pre>
<h4 data-id="heading-27">获取用户当前在element标签下选中的元素</h4>
<p>主要通过chrome插件的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.chrome.com%2Fdocs%2Fextensions%2Freference%2Fapi%2Fdevtools%2FinspectedWindow%3Fhl%3Dzh-cn%23method-eval" target="_blank" title="https://developer.chrome.com/docs/extensions/reference/api/devtools/inspectedWindow?hl=zh-cn#method-eval" ref="nofollow noopener noreferrer"><code>chrome.devtools.inspectedWindow.eval</code></a>方法实现。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleGetSelectedElement</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> getSelectorExpression = <span class="hljs-string">`
      (function() {
      	// ...生成selector逻辑
        // $0 是 DevTools 中当前选中的元素
        return getElementSelector($0);
      })()
    `</span>
  <span class="hljs-comment">// 使用 chrome.devtools.inspectedWindow.eval 在页面上下文中执行</span>
  chrome.<span class="hljs-property">devtools</span>.<span class="hljs-property">inspectedWindow</span>.<span class="hljs-built_in">eval</span>(
    getSelectorExpression,
    <span class="hljs-function">(<span class="hljs-params">result, exceptionInfo</span>) =&gt;</span> {
      <span class="hljs-comment">// 将获取到的selector发送给background</span>
      <span class="hljs-keyword">const</span> <span class="hljs-attr">responseMsg</span>: <span class="hljs-title class_">ChromeListenerMessageType</span> = {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">ChromeMessageType</span>.<span class="hljs-property">RETURN_ELEMENT_SELECTOR</span>,
        <span class="hljs-attr">data</span>: {
          <span class="hljs-attr">tabId</span>: chrome.<span class="hljs-property">devtools</span>.<span class="hljs-property">inspectedWindow</span>.<span class="hljs-property">tabId</span>,
          <span class="hljs-attr">selector</span>: result,
        },
      }
      backgroundPort?.<span class="hljs-title function_">postMessage</span>(responseMsg)
    },
  )
}
</code></pre>
<h4 data-id="heading-28">生成对应节点的selector逻辑</h4>
<p>通过生成对应节点的selector，将结果经由background层发送给<code>content_script</code>(插件主体)，在<code>content_script</code>中通过<code>document.querySelector(${selector})</code>重新获取到用户选中的节点。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getElementSelector</span>(<span class="hljs-params">element</span>) {
  <span class="hljs-keyword">if</span> (!element) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
  }

  <span class="hljs-comment">// 如果是 document，返回 html</span>
  <span class="hljs-keyword">if</span> (element === <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'html'</span>
  }

  <span class="hljs-comment">// 如果元素有 id，使用 id</span>
  <span class="hljs-keyword">if</span> (element.<span class="hljs-property">id</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`#<span class="hljs-subst">${element.id}</span>`</span>
  }

  <span class="hljs-comment">// 构建 CSS Selector</span>
  <span class="hljs-keyword">const</span> path = []
  <span class="hljs-keyword">let</span> current = element

  <span class="hljs-keyword">while</span> (current &amp;&amp; current.<span class="hljs-property">nodeType</span> === <span class="hljs-title class_">Node</span>.<span class="hljs-property">ELEMENT_NODE</span>) {
    <span class="hljs-keyword">let</span> selector = current.<span class="hljs-property">nodeName</span>.<span class="hljs-title function_">toLowerCase</span>()

    <span class="hljs-comment">// 添加类名（如果有）</span>
    <span class="hljs-keyword">if</span> (current.<span class="hljs-property">className</span> &amp;&amp; <span class="hljs-keyword">typeof</span> current.<span class="hljs-property">className</span> === <span class="hljs-string">'string'</span>) {
      <span class="hljs-keyword">const</span> classes = current.<span class="hljs-property">className</span>.<span class="hljs-title function_">trim</span>().<span class="hljs-title function_">split</span>(<span class="hljs-regexp">/\\s+/</span>).<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c)
      <span class="hljs-keyword">if</span> (classes.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        selector += <span class="hljs-string">`.<span class="hljs-subst">${classes.join(<span class="hljs-string">'.'</span>)}</span>`</span>
      }
    }

    <span class="hljs-comment">// 计算同级元素的位置（如果需要）</span>
    <span class="hljs-keyword">if</span> (current.<span class="hljs-property">parentNode</span>) {
      <span class="hljs-keyword">const</span> siblings = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(current.<span class="hljs-property">parentNode</span>.<span class="hljs-property">children</span>).<span class="hljs-title function_">filter</span>(
        <span class="hljs-function"><span class="hljs-params">sibling</span> =&gt;</span> sibling.<span class="hljs-property">nodeName</span> === current.<span class="hljs-property">nodeName</span>,
      )

      <span class="hljs-keyword">if</span> (siblings.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">const</span> index = siblings.<span class="hljs-title function_">indexOf</span>(current) + <span class="hljs-number">1</span>
        selector += <span class="hljs-string">`:nth-of-type(<span class="hljs-subst">${index}</span>)`</span>
      }
    }

    path.<span class="hljs-title function_">unshift</span>(selector)
    current = current.<span class="hljs-property">parentNode</span>

    <span class="hljs-comment">// 如果到达了有 id 的父元素，可以停止</span>
    <span class="hljs-keyword">if</span> (current &amp;&amp; current.<span class="hljs-property">id</span>) {
      path.<span class="hljs-title function_">unshift</span>(<span class="hljs-string">`#<span class="hljs-subst">${current.id}</span>`</span>)
      <span class="hljs-keyword">break</span>
    }
  }

  <span class="hljs-keyword">return</span> path.<span class="hljs-title function_">join</span>(<span class="hljs-string">' &gt; '</span>)
}
</code></pre>
<h3 data-id="heading-29">写在最后</h3>
<p>这套方案从最初的想法到现在的实现,其实走了不少弯路。最开始我们也想过用图像识别,毕竟看起来很"AI"很"高级",但实际跑下来发现根本不靠谱——设计稿改个文案、换个颜色,算法就得重新训练。后来才想明白,既然设计稿和DOM都是结构化数据,为什么不直接对比结构呢?</p>
<p>整个方案的核心其实就做了一件事:把两个看起来完全不同的东西(设计稿的JSON和HTML的DOM树),通过一系列归一化处理,变成可以直接比对的同构数据。这个过程中最大的感受是,<strong>前端开发和UI设计之间的gap,本质上是两套不同的渲染规则在互相较劲</strong>。CSS的margin折叠、行高计算、盒模型,每一个细节都可能让设计稿"看起来一样"的两个元素在代码层面完全不同。</p>
<p>说实话,当前40%-60%的匹配准确率还远谈不上完美,但至少让我们看到了一个方向:自动化UI走查的关键不在于追求百分百的准确,而在于建立一套可量化、可追溯的比对标准。就像单元测试不能保证代码零bug,但能让我们对代码质量有个基本的信心。</p>
<p>更重要的是,这套方案让我们重新思考了前端工程化的本质。过去我们总说要提效、要自动化,但往往只盯着代码构建、打包部署这些环节。UI还原度这件事一直是个"玄学"——全凭开发的经验和责任心。现在我们把它量化了、标准化了,这意味着整个研发流程可以往前再推一步:不仅要保证代码能跑,还要保证UI能过。</p>
<p>当然,技术方案永远只是工具。真正能提升团队协作效率的,是大家对质量的共识。这套自动化走查如果只是用来"抓bug",那价值就太有限了。我更希望它能成为一面镜子,让前端看到自己对设计的理解偏差,让设计看到自己稿子的不规范之处,最终推动双方在规范上达成更多共识。</p>
<p>技术的意义从来不在于解决所有问题,而在于让问题变得可见、可量化、可改进。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OCR告别付费！分享两款可部署的开源工具]]></title>    <link>https://juejin.cn/post/7574722364353921033</link>    <guid>https://juejin.cn/post/7574722364353921033</guid>    <pubDate>2025-11-21T01:38:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574722364353921033" data-draft-id="7574722364353904649" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OCR告别付费！分享两款可部署的开源工具"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-21T01:38:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SimonKing"/> <meta itemprop="url" content="https://juejin.cn/user/4001878056904584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OCR告别付费！分享两款可部署的开源工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878056904584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SimonKing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T01:38:50.000Z" title="Fri Nov 21 2025 01:38:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>关注我的公众号：【编程朝花夕拾】，可获取首发内容。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/146340e808894ba1bd0511cf2db32e42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764293930&amp;x-signature=VzFEUgJb6aW8JMFR%2FBWdaukR82A%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">01 引言</h2>
<p><code>OCR</code>文字识别已经基本覆盖我们的日常的聊天工具，如微信、<code>QQ</code>等都有截图识别文字甚至直接从图片可以复制文字。开发项目中使用<code>OCR</code>图片识别、文案提取等经常用到。大多数小型企业都会选择云厂商的文字识别，如阿里云、百度云、腾讯云等的识别功能。</p>
<p>那有没有白嫖的<code>OCR</code>呢？当然有，但是很多的识别率并不高。今天介绍两款识别率较高的<code>OCR</code>项目，关键是可以部署，应用到业务项目中。</p>
<h2 data-id="heading-1">02 Umi-OCR</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/999310fde1b2445c9098f65cbad819b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764293930&amp;x-signature=HFyDcSdknDDi7XA8lxpU8gzTeGk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">2.1 简介</h3>
<p><strong><code>Umi-OCR</code></strong> 是一个免费、开源、可离线的 OCR 文字识别工具，由开发者 <code>hiroi-sora</code> 使用 <code>Python</code> 编写。它的名字中 “<code>Umi</code>” 在日语里是“海”的意思，寓意着其“海纳百川”的特性。</p>
<p>该项目是基于百度开源的<code>PaddleOCR</code>开发，对中文和英文的识别准确率非常高，同时支持多国语言。它的主要目标是提供一个简单易用、功能强大且完全离线的图片文字识别解决方案，完美保护用户隐私，因为所有识别过程都在本地计算机上完成，无需连接任何外部服务器。</p>
<p>不仅支持本地部署，还支持<code>windows</code>系统：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0958e5823ba4123b390c9284c525539~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764293930&amp;x-signature=6GsFwzhE45mZZ1B5t2vtB3eZl%2BI%3D" alt="" loading="lazy"/></p>
<p><code>windows</code>版本作为日常使用的工具大家可以自行探索。为了接入项目开发，我们主要了解一下本地部署的方式。</p>
<p><code>GitHub</code>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhiroi-sora%2FUmi-OCR" target="_blank" title="https://github.com/hiroi-sora/Umi-OCR" ref="nofollow noopener noreferrer">github.com/hiroi-sora/…</a></p>
<h3 data-id="heading-3">2.2 部署</h3>
<p><code>linux</code>部署是新的项目：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhiroi-sora%2FUmi-OCR_runtime_linux" target="_blank" title="https://github.com/hiroi-sora/Umi-OCR_runtime_linux" ref="nofollow noopener noreferrer">github.com/hiroi-sora/…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03af51e6f0f546eabd5fc8c6115b09a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764293930&amp;x-signature=f7sS3FNU2PfIviAfunAczjZkWoE%3D" alt="" loading="lazy"/></p>
<p>由于官方给出的测试的系统类型并没有<code>Centos</code>。尝试通过<code>Centos8</code>部署，结果失败：缺少一些基本组件，升级不成功。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0bdd5f1dd90c4eceadf92cc3c85ba03c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764293930&amp;x-signature=vC6xhDqxaXehOyTbmIGBkv%2FGeEg%3D" alt="" loading="lazy"/></p>
<p>所以这里我们使用<code>Docker</code>部署。</p>
<p><code>Docker</code>部署的地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhiroi-sora%2FUmi-OCR_runtime_linux%2Fblob%2Fmain%2FREADME-docker.md" target="_blank" title="https://github.com/hiroi-sora/Umi-OCR_runtime_linux/blob/main/README-docker.md" ref="nofollow noopener noreferrer">github.com/hiroi-sora/…</a></p>
<p>官方文档介绍的很明白了。</p>
<p><strong>检查主机CUP</strong></p>
<p>因为目前主机的CPU只支持<code>AVX</code>指令集。</p>
<pre><code class="hljs language-sh" lang="sh">lscpu | grep avx
</code></pre>
<p>如果输出了类似如下的结果，那么可以继续部署。如果没有则无法部署</p>
<pre><code class="hljs language-sh" lang="sh">Flags:          ... avx ... avx2 ...
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcda6b2abea643db83a9f0b40896338a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764293930&amp;x-signature=28nsAtJAbnGu8069GdGFrVKN3ig%3D" alt="" loading="lazy"/></p>
<p>所以小编的机器是可以部署的。</p>
<p><strong>构建镜像</strong></p>
<p>由于远程镜像仓库里面没有上传，需要使用<code>Dockerfile</code>自行构建。</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 拉取Dockerfile文件</span>
wget https://raw.githubusercontent.com/hiroi-sora/Umi-OCR_runtime_linux/main/Dockerfile

<span class="hljs-comment"># 构建镜像</span>
docker build -t umi-ocr-paddle .
</code></pre>
<p><code>umi-ocr-paddle</code>表示构建的镜像名称。</p>
<p><strong>启动容器</strong></p>
<p>容器的运行支持无头模式和GUI模式。因为我们是为了项目的调用，所以这里我们使用悟透模式。</p>
<pre><code class="hljs language-sh" lang="sh">docker run -d --name umi-ocr \
    -e HEADLESS=<span class="hljs-literal">true</span> \
    -p 1224:1224 \
    umi-ocr-paddle
</code></pre>
<p>说明：</p>
<ul>
<li>设置容器名称为 <code>umi-ocr</code> 。你也可以设置为任意名称。</li>
<li>设置环境变量 <code>-e HEADLESS=true</code> 启用无头模式。</li>
<li>设置端口转发 <code>-p xxxx:1224</code> ，将容器内的1224端口转发给主机<code>xxxx</code>端口。</li>
<li>使用的镜像为 <code>umi-ocr-paddle</code> 。</li>
</ul>
<h3 data-id="heading-4">2.3 接口调用</h3>
<p>官方提供了HTTP接口手册：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhiroi-sora%2FUmi-OCR%2Fblob%2Fmain%2Fdocs%2Fhttp%2FREADME.md" target="_blank" title="https://github.com/hiroi-sora/Umi-OCR/blob/main/docs/http/README.md" ref="nofollow noopener noreferrer">github.com/hiroi-sora/…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ae10ad922ff470cac7aca23030178e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764293930&amp;x-signature=G4uMM0QtASuRhhavrR1QxEZaY4I%3D" alt="" loading="lazy"/></p>
<p>我们这里以<code>图片OCR：Base64识别</code>为例：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f985853a4c44771ac98cb74fd349fb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764293930&amp;x-signature=0OMHgkInb1uQo13Z3VTKYLH4%2BZ0%3D" alt="" loading="lazy"/></p>
<p><strong>Java案例</strong></p>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-meta">@Test</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">test04</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"C:\\Users\\ws\\Desktop\\00.jpg"</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">encode</span> <span class="hljs-operator">=</span> Base64.encode(Files.toByteArray(file));

    <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();
    jsonObject.put(<span class="hljs-string">"base64"</span>, encode);

    <span class="hljs-type">JSONObject</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();
<span class="hljs-comment">//        item.put("ocr.language", "models/config_chinese.txt");</span>
<span class="hljs-comment">//        item.put("ocr.cls", true);</span>
<span class="hljs-comment">//        item.put("ocr.limit_side_len", 4320);</span>
<span class="hljs-comment">//        item.put("tbpu.parser", "multi_none");</span>
    item.put(<span class="hljs-string">"data.format"</span>, <span class="hljs-string">"text"</span>);
<span class="hljs-comment">//        item.put("data.format", "dict");</span>
    jsonObject.put(<span class="hljs-string">"options"</span>, item);

    <span class="hljs-type">String</span> <span class="hljs-variable">post</span> <span class="hljs-operator">=</span> HttpUtil.post(<span class="hljs-string">"http://127.0.0.1:1224/api/ocr"</span>, JSON.toJSONString(jsonObject));
    System.out.println(post);
    System.out.println(<span class="hljs-string">"----------------------------------------------"</span>);
    System.out.println(UnicodeUtil.toString(post));
}
</code></pre>
<p><strong>结果</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23c4a5c1e95a4c0894e0eb1487d9ab25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764293930&amp;x-signature=zqj%2F9i%2F7PtjNwIr4%2F7UQ5V2wtWg%3D" alt="" loading="lazy"/></p>
<p>结果是识别出来了，但是有个小问题。第一行输出是<code>unicode</code>，需要我们将<code>unicode</code>转成中文。</p>
<h2 data-id="heading-5">03 TrWebOCR</h2>
<h3 data-id="heading-6">3.1 简介</h3>
<p><code>TrWebOCR</code>基于开源项目 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmyhub%2Ftr" target="_blank" title="https://github.com/myhub/tr" ref="nofollow noopener noreferrer">Tr</a> 构建，目前已经停更了，<code>tr</code>官方说了项目转为研究性项目：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/991372fe0d5a4952b503012dc63eb140~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764293930&amp;x-signature=m0azwTio4Bp2%2BEW0h%2Bau6EVQczA%3D" alt="" loading="lazy"/></p>
<p>但是它仍然是一款好用的<code>OCR</code>工具。支持的平台比较多：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a319dc6a1e574e9680b24a1fd0ee72ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764293930&amp;x-signature=f2MbOSyRNHK0K6tHx%2FlwOuN%2BMsM%3D" alt="" loading="lazy"/></p>
<p><code>GitHub</code>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falisen39%2FTrWebOCR" target="_blank" title="https://github.com/alisen39/TrWebOCR" ref="nofollow noopener noreferrer">github.com/alisen39/Tr…</a></p>
<h3 data-id="heading-7">3.2 部署</h3>
<p>我们同样以Docker的形式部署。这个就比较简单了，可以自行构建镜像，也可以拉取镜像。</p>
<p><strong>构建镜像</strong></p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># dockerfile 构建</span>
docker build -t trwebocr:latest .

<span class="hljs-comment"># 运行镜像</span>
docker run -itd --<span class="hljs-built_in">rm</span> -p 8089:8089 --name trwebocr trwebocr:latest 
</code></pre>
<p><strong>远程镜像</strong></p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 从 dockerhub pull</span>
docker pull mmmz/trwebocr:latest

<span class="hljs-comment"># 运行镜像</span>
docker run -itd --<span class="hljs-built_in">rm</span> -p 8089:8089 --name trwebocr mmmz/trwebocr:latest 
</code></pre>
<p>访问<code>IP</code>+端口，提供了网页端：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cd7b3a0e21e42be8c98687ba3035ebf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764293930&amp;x-signature=XkEOrVx0ZMf%2Fogm5%2FR0eS2yzDxU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">3.3 接口调用</h3>
<p>我们先试试网页端：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/871c7dc091a348069d763aa5898a35ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764293930&amp;x-signature=4nPC8oRkMtTfYv3BNNFR71ItmPQ%3D" alt="" loading="lazy"/></p>
<p>接口文档地址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falisen39%2FTrWebOCR%2Fwiki%2F%25E6%258E%25A5%25E5%258F%25A3%25E6%2596%2587%25E6%25A1%25A3" target="_blank" title="https://github.com/alisen39/TrWebOCR/wiki/%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3" ref="nofollow noopener noreferrer">github.com/alisen39/Tr…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de44fa7aae104cbea998a97e95ddc94a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764293930&amp;x-signature=mQ0JmcEqB2KZSqfhvL4EBWpOdjE%3D" alt="" loading="lazy"/></p>
<p><strong>Java案例</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">test07</span><span class="hljs-params">()</span>  {
    <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"C:\\Users\\ws\\Desktop\\34.png"</span>);

    <span class="hljs-type">JSONObject</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();
    item.put(<span class="hljs-string">"file"</span>, file);
    item.put(<span class="hljs-string">"is_draw"</span>, <span class="hljs-number">0</span>);

    <span class="hljs-type">String</span> <span class="hljs-variable">post</span> <span class="hljs-operator">=</span> HttpUtil.post(<span class="hljs-string">"http://127.0.0.1:8089/api/tr-run/"</span>, item);
    System.out.println(post);
    System.out.println(<span class="hljs-string">"----------------------------------------------"</span>);
    System.out.println(UnicodeUtil.toString(post));
}
</code></pre>
<p><strong>结果</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a70ba047770245cd93f608161a7cdbcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764293930&amp;x-signature=o9sBNJ8WeLEB8qUAB9YivWgk9UE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">04 小结</h2>
<p>第二款虽然停更，但是已有的功能可以满足常用的OCR识别。而第一款一直活跃在<code>GitHub</code>上，是一款非常值得关注的项目，不断的迭代新的功能。有特殊要求的OCR可以利用开源模型自行训练。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别 Vue 多分辨率适配烦恼：vfit 让元素定位 “丝滑” 跨设备]]></title>    <link>https://juejin.cn/post/7574992086715219983</link>    <guid>https://juejin.cn/post/7574992086715219983</guid>    <pubDate>2025-11-21T10:26:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574992086715219983" data-draft-id="7574803558878920719" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别 Vue 多分辨率适配烦恼：vfit 让元素定位 “丝滑” 跨设备 "/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-11-21T10:26:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一颗烂土豆"/> <meta itemprop="url" content="https://juejin.cn/user/764915822371912"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别 Vue 多分辨率适配烦恼：vfit 让元素定位 “丝滑” 跨设备 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/764915822371912/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一颗烂土豆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T10:26:54.000Z" title="Fri Nov 21 2025 10:26:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5648e0388884f619ad605cedbb0b2c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6aKX54OC5Zyf6LGG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764325614&amp;x-signature=vMD0rHwEAGQO%2BQMfMoK04HyJmAQ%3D" alt="pre-sales-poster.jpg" width="100%" loading="lazy"/>
在前端开发中，“多分辨率适配”一直是个绕不开的坎。尤其是Vue项目，面对从手机到大屏的各种设备，既要保证元素比例不变，又要让位置精准，往往需要手写大量缩放计算或媒体查询，代码冗余且难维护。
<p>今天推荐一个专为Vue 3设计的轻量方案——<strong>vfit</strong>，通过“全局缩放管理+组件化定位”的思路，让适配工作变得简单可控。</p>
<h4 data-id="heading-0">为什么需要vfit？</h4>
<p>传统适配方案（如rem、vw/vh）的痛点在于：</p>
<ul>
<li>• 仅能处理“大小”适配，难以保证“位置”在不同分辨率下的一致性；</li>
<li>• 需手动维护基准值，缩放逻辑与业务代码耦合；</li>
<li>• 对固定像素布局（如设计稿上精确到px的定位）支持不友好。</li>
</ul>
<p>vfit的解决思路更直接：</p>
<ol>
<li>以设计稿宽高（如1920×1080）为基准，实时计算容器的缩放比例（<code>scale = 容器尺寸 / 设计稿尺寸</code>）；</li>
<li>通过<code>FitContainer</code>组件，根据缩放比例自动调整元素的位置和大小，同时支持两种定位模式（px/%）。</li>
</ol>
<h4 data-id="heading-1">核心能力解析</h4>
<ol>
<li>
<p> <strong>灵活的缩放模式</strong><br/>
vfit提供3种缩放策略，覆盖绝大多数场景：</p>
</li>
<li>
<ul>
<li>• <code>width</code>：按容器宽度缩放（<code>scale = 容器宽 / 设计稿宽</code>）；</li>
<li>• <code>height</code>：按容器高度缩放（<code>scale = 容器高 / 设计稿高</code>）；</li>
<li>• <code>auto</code>：自动对比容器宽高比与设计稿宽高比，选择更合适的维度缩放（避免元素被截断）。</li>
</ul>
</li>
<li>
<p> <strong>组件化定位</strong><br/>
内置的<code>FitContainer</code>组件是核心，通过<code>top/bottom/left/right</code>属性定义位置，配合<code>unit</code>参数控制定位逻辑：</p>
<p>示例代码（像素定位）：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>  
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"position: relative; width: 100%; height: 100vh;"</span>&gt;</span>  
    <span class="hljs-tag">&lt;<span class="hljs-name">FitContainer</span> <span class="hljs-attr">:top</span>=<span class="hljs-string">"90"</span> <span class="hljs-attr">:left</span>=<span class="hljs-string">"90"</span> <span class="hljs-attr">unit</span>=<span class="hljs-string">"px"</span>&gt;</span>  
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span>固定像素布局<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>  
    <span class="hljs-tag">&lt;/<span class="hljs-name">FitContainer</span>&gt;</span>  
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>  
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>  
</code></pre>
</li>
<li>
<ul>
<li>• <code>unit="%"</code>：位置基于容器百分比，不受缩放影响（适合居中、相对布局）；</li>
<li>• <code>unit="px"</code>：位置会自动乘以当前缩放值（适合固定像素定位，如设计稿上left:90px，缩放后实际位置为90×scale）。</li>
</ul>
</li>
<li>
<p> <strong>全局缩放值访问</strong><br/>
通过<code>useFitScale()</code>钩子可在组件内获取当前缩放值（<code>Ref&lt;number&gt;</code>），方便自定义缩放逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useFitScale } <span class="hljs-keyword">from</span> <span class="hljs-string">'vfit'</span>  

<span class="hljs-keyword">const</span> scale = <span class="hljs-title function_">useFitScale</span>()  
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'当前缩放比例：'</span>, scale.<span class="hljs-property">value</span>)  
</code></pre>
</li>
</ol>
<h4 data-id="heading-2">上手成本极低</h4>
<p>安装初始化仅需两步：</p>
<pre><code class="hljs language-css" lang="css">npm <span class="hljs-selector-tag">i</span> vfit  
</code></pre>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main.ts  </span>
<span class="hljs-keyword">import</span> { createFitScale } <span class="hljs-keyword">from</span> <span class="hljs-string">'vfit'</span>  
<span class="hljs-keyword">import</span> <span class="hljs-string">'vfit/style.css'</span>  

app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">createFitScale</span>({  
  <span class="hljs-attr">target</span>: <span class="hljs-string">'#app'</span>, <span class="hljs-comment">// 默认为#app，可指定其他容器  </span>
  <span class="hljs-attr">designWidth</span>: <span class="hljs-number">1920</span>, <span class="hljs-comment">// 设计稿宽度（默认1920）  </span>
  <span class="hljs-attr">designHeight</span>: <span class="hljs-number">1080</span>, <span class="hljs-comment">// 设计稿高度（默认1080）  </span>
  <span class="hljs-attr">scaleMode</span>: <span class="hljs-string">'auto'</span> <span class="hljs-comment">// 默认auto  </span>
}))  
</code></pre>
<h4 data-id="heading-3">适用场景与优势</h4>
<ul>
<li> <strong>优势</strong>：轻量（无冗余依赖）、Vue 3原生支持、定位与缩放逻辑解耦、API简洁；</li>
<li><strong>场景</strong>：数据大屏、管理系统、多设备兼容的活动页等需要精确布局的场景。</li>
</ul>
<p>如果你正在为Vue项目的多分辨率适配头疼，不妨试试vfit——它不追求大而全，只专注于把“缩放与定位”这件事做好。现在就去npm安装体验，让适配工作少走弯路～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[牛刀小试：Vue 3的响应式系统和Proxy?]]></title>    <link>https://juejin.cn/post/7574967214128381978</link>    <guid>https://juejin.cn/post/7574967214128381978</guid>    <pubDate>2025-11-21T10:29:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574967214128381978" data-draft-id="7574967214128349210" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="牛刀小试：Vue 3的响应式系统和Proxy?"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-21T10:29:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ArkPppp"/> <meta itemprop="url" content="https://juejin.cn/user/4484239094198752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            牛刀小试：Vue 3的响应式系统和Proxy?
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4484239094198752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ArkPppp
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T10:29:24.000Z" title="Fri Nov 21 2025 10:29:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">牛刀小试：Vue 3的响应式系统和Proxy?</h2>
<h2 data-id="heading-1">引言</h2>
<p>众所周知，Vue3 的响应式系统主要依赖于 ES6 的 <em>Proxy</em> 对象来实现。相比于 Vue2 使用的 <code>Object.defineProperty</code>，<code>Proxy</code>提供了更强大的功能和更好的性能。但我们在日常使用框架时却很少注意到背后的底层原理，本文就旨在通过重温Vue3的响应式系统，学习和回顾ES6的相关特性。</p>
<h2 data-id="heading-2">Proxy概述</h2>
<p><strong>ES6 Proxy</strong> 是一种新的 JavaScript 功能，它允许你创建一个对象的代理，从而可以拦截和自定义基本操作，例如属性查找、赋值、枚举和函数调用等。Proxy 可以被视为在目标对象之前设置的一层拦截，所有对该对象的访问都必须首先通过这层拦截，这提供了一种机制，可以对外界的访问进行过滤和改写。</p>
<h3 data-id="heading-3">语法</h3>
<p><code>const p = new Proxy(target, handler)</code></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FProxy%23target_2" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy#target_2" ref="nofollow noopener noreferrer"><code>target</code></a>:要使用 <code>Proxy</code> 包装的目标对象（可以是任何类型的对象，包括原生数组，函数，甚至另一个代理）。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FProxy%23handler" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy#handler" ref="nofollow noopener noreferrer"><code>handler</code></a>:一个通常以函数作为属性的对象，各属性中的函数分别定义了在执行各种操作时代理 <code>p</code> 的行为。</p>
<h3 data-id="heading-4">例子</h3>
<h4 data-id="heading-5">拦截器</h4>
<p>这里我们创建了一个<em>get handler</em>，当程序试图访问对象时，如果属性存在于对象，则返回其对象的值，否则返回37。</p>
<p>以下是传递给 get 方法的参数，this 上下文绑定在handler 对象上。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FProxy%2FProxy%2Fget%23target" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/get#target" ref="nofollow noopener noreferrer"><code>target</code></a>目标对象。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FProxy%2FProxy%2Fget%23property" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/get#property" ref="nofollow noopener noreferrer"><code>property</code></a>被获取的属性名。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FProxy%2FProxy%2Fget%23receiver" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/get#receiver" ref="nofollow noopener noreferrer"><code>receiver</code></a>是Proxy 或者继承 Proxy 的对象</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> handler = {
  <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">obj, prop</span>) {
    <span class="hljs-keyword">return</span> prop <span class="hljs-keyword">in</span> obj ? obj[prop] : <span class="hljs-number">37</span>;
  },
};

<span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>({}, handler);
p.<span class="hljs-property">a</span> = <span class="hljs-number">1</span>;
p.<span class="hljs-property">b</span> = <span class="hljs-literal">undefined</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p.<span class="hljs-property">a</span>, p.<span class="hljs-property">b</span>); <span class="hljs-comment">// 1, undefined</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"c"</span> <span class="hljs-keyword">in</span> p, p.<span class="hljs-property">c</span>); <span class="hljs-comment">// false, 37</span>
</code></pre>
<h4 data-id="heading-6">无操作转发</h4>
<p>在以下例子中，我们使用了一个原生 JavaScript 对象，代理会将所有应用到它的操作转发到这个对象上。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">let</span> target = {};
<span class="hljs-keyword">let</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target, {});

p.<span class="hljs-property">a</span> = <span class="hljs-number">37</span>; <span class="hljs-comment">// 操作转发到目标</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(target.<span class="hljs-property">a</span>); <span class="hljs-comment">// 37 操作已经被正确地转发</span>
</code></pre>
<h4 data-id="heading-7">验证功能</h4>
<p>通过代理，你可以轻松地验证向一个对象的传值。向Proxy的handler设置相关的setter方法，可以拦截对对象的赋值操作，并确保预期之内的结果。</p>
<p>以下是传递给 <code>set()</code> 方法的参数。<code>this</code> 绑定在 handler 对象上。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FProxy%2FProxy%2Fset%23target" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/set#target" ref="nofollow noopener noreferrer"><code>target</code></a>目标对象。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FProxy%2FProxy%2Fset%23property" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/set#property" ref="nofollow noopener noreferrer"><code>property</code></a>将被设置的属性名或 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FSymbol" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Symbol" ref="nofollow noopener noreferrer"><code>Symbol</code></a>。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FProxy%2FProxy%2Fset%23value" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/set#value" ref="nofollow noopener noreferrer"><code>value</code></a>新属性值。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FProxy%2FProxy%2Fset%23receiver" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/set#receiver" ref="nofollow noopener noreferrer"><code>receiver</code></a>最初接收赋值的对象。通常是 proxy 本身，但 handler 的 set 方法也有可能在原型链上，或以其他方式被间接地调用（因此不一定是 proxy 本身）。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// Proxy &amp; setter拦截器</span>

<span class="hljs-keyword">let</span> validator = {
    <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">obj, prop, value</span>) {
    <span class="hljs-keyword">if</span> (prop === <span class="hljs-string">"age"</span>) {
      <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Number</span>.<span class="hljs-title function_">isInteger</span>(value)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">"The age is not an integer"</span>);
      }
      <span class="hljs-keyword">if</span> (value &gt; <span class="hljs-number">200</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RangeError</span>(<span class="hljs-string">"The age seems invalid"</span>);
      }
    }

    <span class="hljs-comment">// 保存属性值的默认行为!</span>
    obj[prop] = value;

    <span class="hljs-comment">// 表示成功</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  },
}

<span class="hljs-keyword">let</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>({},validator)

person.<span class="hljs-property">age</span> = <span class="hljs-number">50</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person.<span class="hljs-property">age</span>)

<span class="hljs-comment">// TypeError: The age is not an integer</span>
person.<span class="hljs-property">age</span> = <span class="hljs-number">11.4</span>

<span class="hljs-comment">// RangeError: The age seems invalid</span>
person.<span class="hljs-property">age</span> = <span class="hljs-number">3000</span>
</code></pre>
<h2 data-id="heading-8">Reflect概述</h2>
<p><strong>ES6 Reflect</strong> 是一个内置的对象，它提供了一系列静态方法，用于执行可拦截的 JavaScript 操作。<code>Reflect</code> 并不是一个函数对象，因此它是不可构造的。</p>
<p><code>Reflect</code> 的设计目的之一是与 <code>Proxy</code> 配合使用。<code>Proxy</code> handler 中的方法（如 <code>get</code>, <code>set</code>）与 <code>Reflect</code> 对象上的方法具有相同的名称和参数。这使得在 <code>Proxy</code> handler 中调用 <code>Reflect</code> 对应的方法来执行默认行为变得非常方便和规范。</p>
<h3 data-id="heading-9">主要方法</h3>
<p><code>Reflect</code> 上的所有方法都是静态的，与 <code>Proxy</code> 的 handler 方法一一对应。</p>
<ul>
<li><code>Reflect.get(target, propertyKey[, receiver])</code>: 获取对象属性的值，类似于 <code>target[propertyKey]</code>。</li>
<li><code>Reflect.set(target, propertyKey, value[, receiver])</code>: 设置对象属性的值，类似于 <code>target[propertyKey] = value</code>。它会返回一个布尔值表示是否设置成功。</li>
<li><code>Reflect.has(target, propertyKey)</code>: 判断一个对象是否存在某个属性，类似于 <code>propertyKey in target</code>。</li>
<li><code>Reflect.deleteProperty(target, propertyKey)</code>: 删除对象的属性，类似于 <code>delete target[propertyKey]</code>。</li>
</ul>
<h3 data-id="heading-10">为什么与Proxy是最佳搭档？</h3>
<p>在 <code>Proxy</code> 的拦截器中，我们通常需要执行原始操作。直接使用 <code>obj[prop] = value</code> 这样的语法虽然可行，但存在一些问题，尤其是在处理继承和 <code>getter/setter</code> 时。</p>
<p><code>Reflect</code> 方法提供了执行这些默认操作的标准方式，并能正确处理 <code>this</code> 指向（通过 <code>receiver</code> 参数）。</p>
<h4 data-id="heading-11">例子</h4>
<p>在这个例子中，我们使用 <code>Reflect.set</code> 来完成属性的赋值。这确保了即使对象有 <code>setter</code>，<code>this</code> 也会正确地指向代理对象 <code>p</code>。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> target = {
    <span class="hljs-attr">_name</span>: <span class="hljs-string">'Guest'</span>,
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">name</span>() {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_name</span>;
    },
    <span class="hljs-keyword">set</span> <span class="hljs-title function_">name</span>(<span class="hljs-params">val</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Setter called!'</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">_name</span> = val;
    }
};

<span class="hljs-keyword">const</span> handler = {
    <span class="hljs-title function_">set</span>(<span class="hljs-params">obj, prop, value, receiver</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Setting <span class="hljs-subst">${prop}</span> to <span class="hljs-subst">${value}</span>`</span>);
        <span class="hljs-comment">// 使用 Reflect.set 来调用原始的 setter，并确保 this 指向 receiver (代理对象 p)</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(obj, prop, value, receiver);
    }
};

<span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target, handler);

p.<span class="hljs-property">name</span> = <span class="hljs-string">'Admin'</span>;
<span class="hljs-comment">// 输出:</span>
<span class="hljs-comment">// Setting name to Admin</span>
<span class="hljs-comment">// Setter called!</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p.<span class="hljs-property">name</span>); <span class="hljs-comment">// Admin</span>

</code></pre>
<p>使用 <code>Reflect</code> 不仅代码更简洁，而且更健壮，能够正确处理 JavaScript 复杂的内部机制。</p>
<h3 data-id="heading-12">手动挡响应式</h3>
<p>了解完基本的原理后，我们将”手动挡”开始一步步实现Vue的响应式。</p>
<h3 data-id="heading-13">实现单个值的响应式</h3>
<p>下面代码通过 3 个步骤，实现对 <code>total</code> 数据进行响应式变化：</p>
<p>① 初始化一个 <code>Set</code> 类型的 <code>dep</code> (Dependency 依赖)变量，用来存放需要执行的副作用（ <code>effect</code> 函数），即修改 <code>total</code> 值的方法；</p>
<p>② 创建 <code>track()</code> 函数，用来将需要执行的副作用(Effect)保存到 <code>dep</code> 变量中（也称收集副作用）；</p>
<p>③ 创建 <code>trigger()</code> 函数，用来执行 <code>dep</code> 变量中的所有副作用；</p>
<p>在每次修改 <code>price</code> 或 <code>quantity</code> 后，调用 <code>trigger()</code> 函数(扳机,触发器)执行所有副作用后， <code>total</code> 值将自动更新为最新值。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">let</span> price = <span class="hljs-number">10</span>, quantity = <span class="hljs-number">2</span>, total = <span class="hljs-number">0</span>;
<span class="hljs-keyword">const</span> dep = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(); <span class="hljs-comment">// ① </span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">effect</span> = (<span class="hljs-params"/>) =&gt; { total = price * quantity };
<span class="hljs-keyword">const</span> <span class="hljs-title function_">track</span> = (<span class="hljs-params"/>) =&gt; { dep.<span class="hljs-title function_">add</span>(effect) };  <span class="hljs-comment">// ②</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">trigger</span> = (<span class="hljs-params"/>) =&gt; { dep.<span class="hljs-title function_">forEach</span>( <span class="hljs-function"><span class="hljs-params">effect</span> =&gt;</span> <span class="hljs-title function_">effect</span>() )};  <span class="hljs-comment">// ③</span>

<span class="hljs-title function_">track</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`total: <span class="hljs-subst">${total}</span>`</span>); <span class="hljs-comment">// total: 0</span>
<span class="hljs-title function_">trigger</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`total: <span class="hljs-subst">${total}</span>`</span>); <span class="hljs-comment">// total: 20</span>
price = <span class="hljs-number">20</span>;
<span class="hljs-title function_">trigger</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`total: <span class="hljs-subst">${total}</span>`</span>); <span class="hljs-comment">// total: 40</span>

</code></pre>
<h3 data-id="heading-14">实现单个对象的响应式</h3>
<p>我们的对象具有多个属性，并且每个属性都需要自己的 <code>dep</code>(Dependency)。</p>
<p>我们将所有副作用保存在一个 <code>Set</code> 集合中，而该集合不会有重复项，这里我们引入一个 <code>Map</code> 类型集合（即 <code>depsMap</code> ），其 <code>key</code> 为对象的属性（如： <code>price</code> 属性）， <code>value</code> 为前面保存副作用的 <code>Set</code> 集合（如： <code>dep</code> 对象）</p>
<p>下面的代码通过 3 个步骤，实现对 <code>total</code> 数据进行响应式变化：</p>
<p>① 初始化一个 <code>Map</code> 类型的 <code>depsMap</code> 变量，用来保存每个需要响应式变化的对象属性（<code>key</code> 为对象的属性， <code>value</code> 为前面 <code>Set</code> 集合）；</p>
<p>② 创建 <code>track()</code> 函数，用来将需要执行的副作用保存到 <code>depsMap</code> 变量中对应的对象属性下（也称收集副作用）；</p>
<p>③ 创建 <code>trigger()</code> 函数，用来执行 <code>dep</code> 变量中指定对象属性的所有副作用；</p>
<p>这样就实现监听对象的响应式变化，在 <code>product</code> 对象中的属性值发生变化， <code>total</code> 值也会跟着更新。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">let</span> product = { <span class="hljs-attr">price</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">2</span> }, total = <span class="hljs-number">0</span>;
<span class="hljs-keyword">const</span> depsMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(); <span class="hljs-comment">// 1 创建依赖映射表</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">effect</span> = (<span class="hljs-params"/>) =&gt; { total = product.<span class="hljs-property">price</span> * product.<span class="hljs-property">quantity</span> };
<span class="hljs-keyword">const</span> <span class="hljs-title function_">track</span> = key =&gt; {     <span class="hljs-comment">// 2 查找该属性已有的依赖,若没有则自行创建一个</span>
  <span class="hljs-keyword">let</span> dep = depsMap.<span class="hljs-title function_">get</span>(key);
  <span class="hljs-keyword">if</span>(!dep) {
    depsMap.<span class="hljs-title function_">set</span>(key, (dep = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>()));
  }
  dep.<span class="hljs-title function_">add</span>(effect);
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">trigger</span> = key =&gt; {  <span class="hljs-comment">// 3 找到该属性对应的所有依赖,并执行相关的副作用函数</span>
  <span class="hljs-keyword">let</span> dep = depsMap.<span class="hljs-title function_">get</span>(key);
  <span class="hljs-keyword">if</span>(dep) {
    dep.<span class="hljs-title function_">forEach</span>( <span class="hljs-function"><span class="hljs-params">effect</span> =&gt;</span> <span class="hljs-title function_">effect</span>() );
  }
};

<span class="hljs-title function_">track</span>(<span class="hljs-string">'price'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`total: <span class="hljs-subst">${total}</span>`</span>); <span class="hljs-comment">// total: 0</span>
<span class="hljs-title function_">effect</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`total: <span class="hljs-subst">${total}</span>`</span>); <span class="hljs-comment">// total: 20</span>
product.<span class="hljs-property">price</span> = <span class="hljs-number">20</span>;
<span class="hljs-title function_">trigger</span>(<span class="hljs-string">'price'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`total: <span class="hljs-subst">${total}</span>`</span>); <span class="hljs-comment">// total: 40</span>

</code></pre>
<h4 data-id="heading-15"><strong>为什么是Map充当依赖映射?</strong></h4>
<p>Map与Set的区别:</p>
<ul>
<li>Set只储存唯一的值,只有值没有键,<strong>重复值不会被添加。</strong></li>
<li>Map存储键值对,存在键值对的映射关系。</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// Set 存储唯一值的集合</span>
<span class="hljs-keyword">const</span> effects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(); <span class="hljs-comment">// 只存储值，不存储键</span>
effects.<span class="hljs-title function_">add</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'effect1'</span>));
effects.<span class="hljs-title function_">add</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'effect2'</span>));
effects.<span class="hljs-title function_">add</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'effect1'</span>)); <span class="hljs-comment">// 重复值不会被添加</span>

<span class="hljs-comment">// Set 的内部结构</span>
[effect1函数, effect2函数]
<span class="hljs-comment">// 只有值，没有键</span>

<span class="hljs-comment">// Map 存储键值对</span>
<span class="hljs-keyword">const</span> depsMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(); <span class="hljs-comment">// key -&gt; value 的映射关系</span>
depsMap.<span class="hljs-title function_">set</span>(<span class="hljs-string">'price'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([effect1, effect2]));
depsMap.<span class="hljs-title function_">set</span>(<span class="hljs-string">'quantity'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([effect3]));

<span class="hljs-comment">// Map 的内部结构</span>
{
  <span class="hljs-string">'price'</span> -&gt; <span class="hljs-title class_">Set</span>([effect1, effect2]),
  <span class="hljs-string">'quantity'</span> -&gt; <span class="hljs-title class_">Set</span>([effect3])
}
<span class="hljs-comment">// 有明确的键值对应关系</span>
</code></pre>
<p>故<code>Set</code>用于储存副作用函数运算，<code>Map</code>用于保存依赖的键值对。</p>
<h3 data-id="heading-16">实现多个对象的响应式</h3>
<p>下面代码通过 3 个步骤，实现对 <code>total</code> 数据进行响应式变化：</p>
<p>① 初始化一个 <code>WeakMap</code> 类型的 <code>targetMap</code> 变量，用来要观察每个响应式对象；</p>
<p>② 创建 <code>track()</code> 函数，用来将需要执行的副作用保存到指定对象（ <code>target</code> ）的依赖中（也称收集副作用）；</p>
<p>③ 创建 <code>trigger()</code> 函数，用来执行指定对象（ <code>target</code> ）中指定属性（ <code>key</code> ）的所有副作用；</p>
<p>这样就实现监听对象的响应式变化，在 <code>product</code> 对象中的属性值发生变化， <code>total</code> 值也会跟着更新。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">let</span> product = { <span class="hljs-attr">price</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">2</span> }, total = <span class="hljs-number">0</span>;
<span class="hljs-keyword">const</span> targetMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();     <span class="hljs-comment">// 1 初始化 targetMap，保存观察对象</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">effect</span> = (<span class="hljs-params"/>) =&gt; { total = product.<span class="hljs-property">price</span> * product.<span class="hljs-property">quantity</span> };
<span class="hljs-keyword">const</span> <span class="hljs-title function_">track</span> = (<span class="hljs-params">target, key</span>) =&gt; {     <span class="hljs-comment">// 2 收集依赖</span>
  <span class="hljs-keyword">let</span> depsMap = targetMap.<span class="hljs-title function_">get</span>(target);
  <span class="hljs-keyword">if</span>(!depsMap){
    targetMap.<span class="hljs-title function_">set</span>(target, (depsMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()));
  }
  <span class="hljs-keyword">let</span> dep = depsMap.<span class="hljs-title function_">get</span>(key);
  <span class="hljs-keyword">if</span>(!dep) {
    depsMap.<span class="hljs-title function_">set</span>(key, (dep = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>()));
  }
  dep.<span class="hljs-title function_">add</span>(effect);
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">trigger</span> = (<span class="hljs-params">target, key</span>) =&gt; {  <span class="hljs-comment">// 3 执行指定对象的指定属性的所有副作用</span>
  <span class="hljs-keyword">const</span> depsMap = targetMap.<span class="hljs-title function_">get</span>(target);
  <span class="hljs-keyword">if</span>(!depsMap) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">let</span> dep = depsMap.<span class="hljs-title function_">get</span>(key);
  <span class="hljs-keyword">if</span>(dep) {
    dep.<span class="hljs-title function_">forEach</span>( <span class="hljs-function"><span class="hljs-params">effect</span> =&gt;</span> <span class="hljs-title function_">effect</span>() );
  }
};

<span class="hljs-title function_">track</span>(product, <span class="hljs-string">'price'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`total: <span class="hljs-subst">${total}</span>`</span>); <span class="hljs-comment">// total: 0</span>
<span class="hljs-title function_">effect</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`total: <span class="hljs-subst">${total}</span>`</span>); <span class="hljs-comment">// total: 20</span>
product.<span class="hljs-property">price</span> = <span class="hljs-number">20</span>;
<span class="hljs-title function_">trigger</span>(product, <span class="hljs-string">'price'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`total: <span class="hljs-subst">${total}</span>`</span>); <span class="hljs-comment">// total: 40</span>

</code></pre>
<h2 data-id="heading-17">"自动挡"的响应式系统：Proxy与Reflect的结合</h2>
<p>到目前为止，我们已经建立了一个依赖追踪系统，但它还是“手动挡”的：</p>
<ol>
<li>我们需要在代码中手动调用 <code>track()</code> 来收集依赖。</li>
<li>我们需要在数据更新后手动调用 <code>trigger()</code> 来触发更新。</li>
</ol>
<p>这显然不够智能。现在，让我们利用 <code>Proxy</code> 和 <code>Reflect</code> 将它升级为“自动挡”。我们的目标是：当访问一个对象的属性时，自动执行 <code>track()</code>；当修改一个对象的属性时，自动执行 <code>trigger()</code>。</p>
<h4 data-id="heading-18">第一步：创建 <code>reactive</code> 函数</h4>
<p>我们先创建一个 <code>reactive</code> 函数，它接收一个普通对象，并返回一个该对象的代理。所有的操作都将发生在这个代理的 <code>handler</code> 中。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> targetMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>(); <span class="hljs-comment">// 依赖存储保持不变</span>

<span class="hljs-comment">// 副作用函数也保持不变</span>
<span class="hljs-keyword">let</span> activeEffect = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 我们需要一个变量来存储当前正在运行的副作用函数</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">reactive</span>(<span class="hljs-params">target</span>) {
  <span class="hljs-keyword">const</span> handler = {
    <span class="hljs-comment">// get 拦截器：当读取属性时触发</span>
    <span class="hljs-title function_">get</span>(<span class="hljs-params">target, key, receiver</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`GET: 访问属性 <span class="hljs-subst">${key}</span>`</span>);
      <span class="hljs-comment">// ... 在这里自动收集依赖</span>
    },
    <span class="hljs-comment">// set 拦截器：当设置属性时触发</span>
    <span class="hljs-title function_">set</span>(<span class="hljs-params">target, key, value, receiver</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`SET: 设置属性 <span class="hljs-subst">${key}</span> 为 <span class="hljs-subst">${value}</span>`</span>);
      <span class="hljs-comment">// ... 在这里自动触发更新</span>
    }
  };
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target, handler);
}

</code></pre>
<h4 data-id="heading-19">第二步：在 <code>get</code> 拦截器中自动收集依赖</h4>
<p>当代码访问代理对象的属性时（例如 <code>product.price</code>），<code>get</code> 拦截器会被触发。这正是我们调用 <code>track()</code> 的时机。</p>
<p>同时，为了让 <code>track</code> 函数知道要收集哪个副作用，我们引入一个全局变量 <code>activeEffect</code>，用于存储当前正在执行的副作用函数。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// track 函数现在需要知道当前激活的副作用是哪个</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">track</span>(<span class="hljs-params">target, key</span>) {
  <span class="hljs-keyword">if</span> (activeEffect) { <span class="hljs-comment">// 只有在 activeEffect 存在时才进行追踪</span>
    <span class="hljs-keyword">let</span> depsMap = targetMap.<span class="hljs-title function_">get</span>(target);
    <span class="hljs-keyword">if</span> (!depsMap) {
      targetMap.<span class="hljs-title function_">set</span>(target, (depsMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()));
    }
    <span class="hljs-keyword">let</span> dep = depsMap.<span class="hljs-title function_">get</span>(key);
    <span class="hljs-keyword">if</span> (!dep) {
      depsMap.<span class="hljs-title function_">set</span>(key, (dep = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>()));
    }
    dep.<span class="hljs-title function_">add</span>(activeEffect); <span class="hljs-comment">// 收集当前激活的副作用</span>
  }
}

<span class="hljs-comment">// reactive 函数的 get handler</span>
<span class="hljs-keyword">const</span> handler = {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, key, receiver</span>) {
    <span class="hljs-title function_">track</span>(target, key); <span class="hljs-comment">// 自动收集依赖</span>
    <span class="hljs-comment">// 使用 Reflect.get 返回属性的原始值，确保 this 指向正确</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, key, receiver);
  },
  <span class="hljs-comment">// ... set handler</span>
};

</code></pre>
<h4 data-id="heading-20">第三步：在 <code>set</code> 拦截器中自动触发更新</h4>
<p>当代码修改代理对象的属性时（例如 <code>product.price = 20</code>），<code>set</code> 拦截器会被触发。这时则调用 <code>trigger()</code> 。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// trigger 函数保持不变</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">trigger</span>(<span class="hljs-params">target, key</span>) {
  <span class="hljs-keyword">const</span> depsMap = targetMap.<span class="hljs-title function_">get</span>(target);
  <span class="hljs-keyword">if</span> (!depsMap) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">let</span> dep = depsMap.<span class="hljs-title function_">get</span>(key);
  <span class="hljs-keyword">if</span> (dep) {
    dep.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">effect</span> =&gt;</span> <span class="hljs-title function_">effect</span>());
  }
}

<span class="hljs-comment">// reactive 函数的 set handler</span>
<span class="hljs-keyword">const</span> handler = {
  <span class="hljs-comment">// ... get handler</span>
  <span class="hljs-title function_">set</span>(<span class="hljs-params">target, key, value, receiver</span>) {
    <span class="hljs-comment">// 使用 Reflect.set 设置新值</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(target, key, value, receiver);
    <span class="hljs-title function_">trigger</span>(target, key); <span class="hljs-comment">// 自动触发更新</span>
    <span class="hljs-keyword">return</span> result; <span class="hljs-comment">// 返回设置操作是否成功</span>
  }
};

</code></pre>
<h4 data-id="heading-21">第四步：整合与测试</h4>
<p>现在，我们把所有部分整合起来，并创建一个 <code>watchEffect</code> 函数来管理 <code>activeEffect</code>。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> targetMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();
<span class="hljs-keyword">let</span> activeEffect = <span class="hljs-literal">null</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">track</span>(<span class="hljs-params">target, key</span>) {
  <span class="hljs-keyword">if</span> (activeEffect) {
    <span class="hljs-keyword">let</span> depsMap = targetMap.<span class="hljs-title function_">get</span>(target);
    <span class="hljs-keyword">if</span> (!depsMap) {
      targetMap.<span class="hljs-title function_">set</span>(target, (depsMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()));
    }
    <span class="hljs-keyword">let</span> dep = depsMap.<span class="hljs-title function_">get</span>(key);
    <span class="hljs-keyword">if</span> (!dep) {
      depsMap.<span class="hljs-title function_">set</span>(key, (dep = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>()));
    }
    dep.<span class="hljs-title function_">add</span>(activeEffect);
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">trigger</span>(<span class="hljs-params">target, key</span>) {
  <span class="hljs-keyword">const</span> depsMap = targetMap.<span class="hljs-title function_">get</span>(target);
  <span class="hljs-keyword">if</span> (!depsMap) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">let</span> dep = depsMap.<span class="hljs-title function_">get</span>(key);
  <span class="hljs-keyword">if</span> (dep) {
    dep.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">effect</span> =&gt;</span> <span class="hljs-title function_">effect</span>());
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">reactive</span>(<span class="hljs-params">target</span>) {
  <span class="hljs-keyword">const</span> handler = {
    <span class="hljs-title function_">get</span>(<span class="hljs-params">target, key, receiver</span>) {
      <span class="hljs-title function_">track</span>(target, key);
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, key, receiver);
    },
    <span class="hljs-title function_">set</span>(<span class="hljs-params">target, key, value, receiver</span>) {
      <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(target, key, value, receiver);
      <span class="hljs-title function_">trigger</span>(target, key);
      <span class="hljs-keyword">return</span> result;
    }
  };
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target, handler);
}

<span class="hljs-comment">// watchEffect 用于注册副作用函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">watchEffect</span>(<span class="hljs-params">effect</span>) {
  activeEffect = effect;
  <span class="hljs-title function_">effect</span>(); <span class="hljs-comment">// 立即执行一次，以触发 get 从而收集依赖</span>
  activeEffect = <span class="hljs-literal">null</span>;
}

<span class="hljs-comment">// --- 测试 ---</span>
<span class="hljs-keyword">let</span> product = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">price</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">2</span> });
<span class="hljs-keyword">let</span> total = <span class="hljs-number">0</span>;

<span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 这个函数现在是我们的副作用</span>
  total = product.<span class="hljs-property">price</span> * product.<span class="hljs-property">quantity</span>;
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`total: <span class="hljs-subst">${total}</span>`</span>); <span class="hljs-comment">// total: 20</span>

<span class="hljs-comment">// 当我们修改 price 时，不再需要手动调用 trigger</span>
product.<span class="hljs-property">price</span> = <span class="hljs-number">20</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`total: <span class="hljs-subst">${total}</span>`</span>); <span class="hljs-comment">// total: 40 (自动更新!)</span>

<span class="hljs-comment">// 当我们修改 quantity 时，也同样会自动更新</span>
product.<span class="hljs-property">quantity</span> = <span class="hljs-number">3</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`total: <span class="hljs-subst">${total}</span>`</span>); <span class="hljs-comment">// total: 60 (自动更新!)</span>

</code></pre>
<p>现在，我们拥有了一个真正的“自动挡”响应式系统。我们只需要用 <code>reactive()</code> 包裹我们的数据，并用 <code>watchEffect()</code> 注册依赖于这些数据的操作，剩下的依赖收集和触发更新都由 <code>Proxy</code> 自动完成了。</p>
<h2 data-id="heading-22">总结</h2>
<p>在本文中，我们通过一个循序渐进的过程，亲手实现了一个迷你版的Vue 3响应式系统。让我们回顾一下这个旅程：</p>
<ol>
<li><strong>从基础开始</strong>：我们首先理解了响应式的核心概念——当数据变化时，依赖该数据的代码应该自动重新执行。我们用一个简单的 <code>Set</code> 来存储单个依赖（副作用函数），并手动调用 <code>track</code> 和 <code>trigger</code>。</li>
<li><strong>支持对象属性</strong>：为了处理对象，我们引入了 <code>Map</code>，建立了从“属性名”到“依赖集合”的映射关系，使得每个属性都能独立追踪自己的依赖。</li>
<li><strong>支持多个对象</strong>：为了管理多个响应式对象，我们引入了 <code>WeakMap</code>，构建了 <code>targetMap -&gt; depsMap -&gt; dep</code> 的三层依赖存储结构。至此，我们的“手动挡”响应式系统已经成型。</li>
<li><strong>迈向自动化</strong>：我们认识到手动调用 <code>track</code> 和 <code>trigger</code> 的繁琐和不可靠。于是，我们引入了 ES6 的 <code>Proxy</code> 和 <code>Reflect</code>。
<ul>
<li><strong>Proxy</strong> 允许我们拦截对象的 <code>get</code> 和 <code>set</code> 操作。我们在 <code>get</code> 拦截器中自动调用 <code>track</code>，在 <code>set</code> 拦截器中自动调用 <code>trigger</code>。</li>
<li><strong>Reflect</strong> 则作为 <code>Proxy</code> 的最佳搭档，提供了执行对象默认操作的标准方法，确保了操作的健壮性和 <code>this</code> 指向的正确性。</li>
</ul>
</li>
</ol>
<p>通过这个过程，我们不仅深入理解了Vue 3响应式系统的核心原理，还掌握了 <code>Proxy</code> 和 <code>Reflect</code> 这两个强大的JavaScript特性。</p>
<h2 data-id="heading-23">参考</h2>
<ul>
<li><a href="https://juejin.cn/post/6977513378256257031" target="_blank" title="https://juejin.cn/post/6977513378256257031">稀土掘金-探索 Vue3 响应式原理</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FProxy" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy" ref="nofollow noopener noreferrer">MDN-Proxy</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FReflect" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Reflect" ref="nofollow noopener noreferrer">MDN-Reflect</a></li>
<li>Google-Gemini2.5Pro参与校验和部分编纂工作</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js SSR 实战：从零到一，构建服务端渲染应用]]></title>    <link>https://juejin.cn/post/7574978545144463395</link>    <guid>https://juejin.cn/post/7574978545144463395</guid>    <pubDate>2025-11-21T10:55:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574978545144463395" data-draft-id="7574404398066614272" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js SSR 实战：从零到一，构建服务端渲染应用"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-21T10:55:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="venton"/> <meta itemprop="url" content="https://juejin.cn/user/66443682264973"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js SSR 实战：从零到一，构建服务端渲染应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/66443682264973/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    venton
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T10:55:08.000Z" title="Fri Nov 21 2025 10:55:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">引言</h3>
<p>今天我们来通过一篇文章掌握服务端渲染框架-nextjs的基本使用，通过本文一步一步实现来完成一个企业级SSR框架的搭建。</p>
<p>能点开这篇文章，相信你对SSR服务端渲染已经有了大概的了解，当然也可以看我前面的一篇文章让你搞清楚服务端渲染的核心原理是什么：<a href="https://juejin.cn/post/7571655312798285850" target="_blank" title="https://juejin.cn/post/7571655312798285850"> 搞懂SSR的灵魂-Hydration</a></p>
<p>咱们学习之前还是需要有一些的react预备知识，比如react16+、hooks、redux、react-redux、redux toolkit，如果是的，那咱们就发车了！</p>
<h3 data-id="heading-1">项目创建</h3>
<pre><code class="hljs language-java" lang="java">npx create-next-app<span class="hljs-meta">@latest</span>   <span class="hljs-comment">//当然你也可以根据需求指定脚手架版本</span>

</code></pre>
<p>项目的基本结构如下</p>
<pre><code class="hljs language-python" lang="python">├── assets/             <span class="hljs-comment"># 文件资源</span>
├── components/         <span class="hljs-comment"># 可复用组件</span>
├── pages/              <span class="hljs-comment"># 页面路由</span>
   ├── _app.tsx         <span class="hljs-comment"># 入口文件</span>
   ├── _document.js     <span class="hljs-comment"># 文档配置（可在这里定义TDK--sso优化）</span>
   ├── index.tsx        <span class="hljs-comment"># 首页</span>
   ├── xxxx             <span class="hljs-comment"># 其他页面</span>
├── store/              <span class="hljs-comment"># Redux状态管理</span>
├── service/            <span class="hljs-comment"># API服务层</span>
├── styles/             <span class="hljs-comment"># 全局样式</span>
└── middleware.ts       <span class="hljs-comment"># 中间件配置（路由拦截、请求重定向-反向代理...）</span>
└── <span class="hljs-built_in">next</span>.config.js      <span class="hljs-comment"># 项目配置（网络图片优化配置...）</span>
└── tsconfig.json       <span class="hljs-comment"># typescript配置(路径别名...)</span>
</code></pre>
<p>接下来在编辑器终端执行 npm run dev ,如果打开浏览器看到类似这样的页面就代表第一步已经成功了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09bdfce6175646a4bebd89b03fcff0f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdmVudG9u:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764327307&amp;x-signature=2v%2BbpP5UH%2FY%2BH23MOkroFnZCKuQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">路由系统</h3>
<p>项目运行起来了我们可能下一步考虑的是怎么创建路由，关联页面？
nextjs具备的一个特点就是：<strong>零配置路由</strong></p>
<p>Next.js最大的路由优势就是：不需要手动配置路由，文件系统就是路由系统！</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 文件结构自动映射为路由</span>
pages/
├── index.tsx          → 自动映射为 /
├── about.tsx         → 自动映射为 /about
├── profile/
│   ├── index.tsx     → 自动映射为 /profile
│   └── [<span class="hljs-built_in">id</span>].tsx      → 自动映射为 /profile/:<span class="hljs-built_in">id</span>  注意：这里是动态路由，文件命名和参数接收时统一
└── api/
    └── user.ts       → 自动映射为 /api/user
</code></pre>
<p>路由跳转可通过下面两种方式</p>
<p>link组件跳转</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/link"</span>;
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">AppProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/app"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params">{ Component, ...rest }: AppProps</span>) {
  <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span>
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/profile?code=123"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>Profile<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span>
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/profile/123444"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>Profile动态<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span>
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{getInfo}</span>&gt;</span>api重写<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
        {<span class="hljs-comment">/* Component页面占位 ===相当于vue中的 router-view */</span>}
        &lt;<span class="hljs-title class_">Component</span> {...props.<span class="hljs-property">pageProps</span>} /&gt;
  );
}
</code></pre>
<p>编程式导航跳转hook（类似vue3）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/router'</span>
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">AppProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/app"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params">{ Component, ...rest }: AppProps</span>) {

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>()
  
  <span class="hljs-comment">// 基本跳转</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleNavigate</span> = (<span class="hljs-params"/>) =&gt; {
    router.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/profile'</span>) <span class="hljs-comment">// 跳转到个人资料页</span>
  }
  
  <span class="hljs-comment">// 带查询参数跳转</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleNavigateWithQuery</span> = (<span class="hljs-params"/>) =&gt; {
    router.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/profile?code=123&amp;name=john'</span>)
  }
  
  <span class="hljs-comment">// 动态路由跳转</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleDynamicRoute</span> = (<span class="hljs-params"/>) =&gt; {
    router.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/profile/123'</span>) <span class="hljs-comment">// 跳转到 /profile/123</span>
  }
  
  <span class="hljs-comment">// 对象形式跳转（更灵活）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleObjectNavigation</span> = (<span class="hljs-params"/>) =&gt; {
    router.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">pathname</span>: <span class="hljs-string">'/profile'</span>,
      <span class="hljs-attr">query</span>: { 
        <span class="hljs-attr">id</span>: <span class="hljs-string">'123'</span>, 
        <span class="hljs-attr">tab</span>: <span class="hljs-string">'settings'</span> 
      }
    })
  }
}

</code></pre>
<p>路由传递参数的接收</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/router'</span>
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">AppProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/app"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params">{ Component, ...rest }: AppProps</span>) {

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>()
<span class="hljs-comment">// 拿到 url中查询字符串 注意：如果是动态路由这里解构的属性名就与文件名必须保持一致</span>
<span class="hljs-comment">// 动态路由参数都是通过query获取，同名的话路由参数优先级高于查询字符串 </span>
<span class="hljs-keyword">const</span> { id } = router.<span class="hljs-property">query</span>; <span class="hljs-comment">// 拿到 url中查询字符串 注意：如果是动态路由这里结构的属性名就与文件名</span>
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.detail}</span>&gt;</span>{id}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}

</code></pre>
<p>如果要执行路由守卫在中间件配置文件操作</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">//middleware.ts</span>

  <span class="hljs-comment">// 路由守卫（示例）</span>
  <span class="hljs-keyword">const</span> token = req.cookies.<span class="hljs-keyword">get</span>(<span class="hljs-string">"token"</span>)?.<span class="hljs-keyword">value</span>;
  <span class="hljs-keyword">if</span> (!token &amp;&amp; req.nextUrl.pathname.startsWith(<span class="hljs-string">"/profile"</span>)) {
    <span class="hljs-keyword">return</span> NextResponse.redirect(<span class="hljs-keyword">new</span> URL(<span class="hljs-string">"/login"</span>, req.nextUrl.origin));
  }

</code></pre>
<p>上面涵盖了nextjs路由系统的基本使用，接下来我们就来实践下服务端渲染的核心：</p>
<h3 data-id="heading-3">SSR数据获取（重点！！！）</h3>
<p>我们先来看看页面中如何展示数据</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { useSelector, useDispatch } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-redux"</span>;
<span class="hljs-keyword">import</span> { fetchUserAction } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/store/modules/home"</span>;
<span class="hljs-keyword">import</span> wrapper <span class="hljs-keyword">from</span> <span class="hljs-string">"@/store/index"</span>;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">GetServerSideProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-variable constant_">FC</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> {
  <span class="hljs-title class_">IUser</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"@/service/home"</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">IProps</span> {
  <span class="hljs-attr">users</span>: <span class="hljs-title class_">IUser</span>[];
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">Home</span>: <span class="hljs-variable constant_">FC</span>&lt;<span class="hljs-title class_">IProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">props</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> {
    product = [], <span class="hljs-comment">//通过getServerSideProps映射到props中了</span>
  } = props;

  <span class="hljs-comment">// 从 redux 读取数据</span>
  <span class="hljs-keyword">const</span> { users } = <span class="hljs-title function_">useSelector</span>(<span class="hljs-function">(<span class="hljs-params">rootState: IAppRootState</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">users</span>: rootState.<span class="hljs-property">home</span>.<span class="hljs-property">users</span>,
    };
  });
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.home}</span>&gt;</span>
        {product}
        {users}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Home</span>;
<span class="hljs-title class_">Home</span>.<span class="hljs-property">displayName</span> = <span class="hljs-string">"Home"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">getServerSideProps</span>: <span class="hljs-title class_">GetServerSideProps</span> =
  wrapper.<span class="hljs-title function_">getServerSideProps</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">store</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (context) =&gt; {
      <span class="hljs-comment">// 1.触发一个异步的action来发起网络请求, 拿到接口数据并存到redex中</span>
      <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">dispatch</span>(<span class="hljs-title function_">fetchUserAction</span>());
      <span class="hljs-comment">// 2.实际项目中不一定非要在redux进行网络请求获取数据（考虑是否要作为公共数据存储）</span>
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchProduct</span>();
  
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">props</span>: {
          <span class="hljs-attr">product</span>: res.<span class="hljs-property">data</span>.<span class="hljs-property">product</span> || [],
        },
      };
    };
  });

</code></pre>
<p>看到这里可能会有几个个疑问：getServerSideProps有什么作用？ fetchUserAction这个action做了什么？wrapper又是干嘛的？跟着我的节奏，接下来我们围绕这三个问题展开讲解。</p>
<p>首先我们要知道SSR通常是服务端和客户端分工协作的结果：</p>
<p><strong>SSR数据预取（getServerSideProps）</strong> ：</p>
<ul>
<li>在服务器端执行，页面首次加载时完成</li>
<li>数据在页面渲染前就已准备好</li>
<li>属于服务端渲染范畴</li>
<li>适用于SEO重要、首次加载必需的数据</li>
</ul>
<p><strong>客户端数据获取</strong>：</p>
<ul>
<li>在浏览器端执行，页面渲染后触发</li>
<li>通过用户交互（点击、滚动等）触发</li>
<li>属于客户端渲染范畴</li>
<li>适用于动态、用户交互相关的数据</li>
</ul>
<p>在实际项目中，通常<code>混合使用</code>上面两种方式。
SEO关键数据通过 <code>getServerSideProps</code> 预取，用户交互相关的私密数据则在客户端通过 <code>useEffect</code> 或事件处理函数获取。</p>
<p>接下来我们看看fetchUserAction 在redux中具体实现：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">//store\modules\home.ts</span>

<span class="hljs-keyword">import</span> { createSlice, createAsyncThunk } <span class="hljs-keyword">from</span> <span class="hljs-string">"@reduxjs/toolkit"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">HYDRATE</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next-redux-wrapper"</span>;
<span class="hljs-keyword">import</span> { fetchUser } <span class="hljs-keyword">from</span> <span class="hljs-string">"../../service/home"</span>;

<span class="hljs-keyword">const</span> homeSlice = <span class="hljs-title function_">createSlice</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"home"</span>,
  <span class="hljs-attr">initialState</span>: {
    <span class="hljs-attr">users</span>: {},
  },
  <span class="hljs-attr">extraReducers</span>: <span class="hljs-function">(<span class="hljs-params">builder</span>) =&gt;</span> {
    <span class="hljs-comment">// Hydrate 是 Next.js 提供的一个特殊的 action，用于在服务端渲染时将服务器端的状态合并到客户端的状态中。</span>
    builder
      .<span class="hljs-title function_">addCase</span>(<span class="hljs-variable constant_">HYDRATE</span>, <span class="hljs-function">(<span class="hljs-params">state, action: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> {
          ...state,
          ...action.<span class="hljs-property">payload</span>.<span class="hljs-property">home</span>,
        };
      })
      .<span class="hljs-title function_">addCase</span>(fetchUserAction.<span class="hljs-property">fulfilled</span>, <span class="hljs-function">(<span class="hljs-params">state, { payload }</span>) =&gt;</span> {
        state.<span class="hljs-property">users</span> = payload;
      });
  },
});

<span class="hljs-comment">// 异步的action</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> fetchUserAction = <span class="hljs-title function_">createAsyncThunk</span>(
  <span class="hljs-string">"fetchUserAction"</span>,
  <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-comment">// 发起网络请求,拿到搜索建议的数据</span>
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>();
    <span class="hljs-keyword">return</span> res.<span class="hljs-property">data</span>
  }
);
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> homeSlice.<span class="hljs-property">reducer</span>;
</code></pre>
<p>每个reducer通过redux toolkit是作为一个切片模块，最终需要整合在一起</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//store\index.ts</span>

<span class="hljs-keyword">import</span> { configureStore } <span class="hljs-keyword">from</span> <span class="hljs-string">"@reduxjs/toolkit"</span>;
<span class="hljs-keyword">import</span> { createWrapper } <span class="hljs-keyword">from</span> <span class="hljs-string">"next-redux-wrapper"</span>;
<span class="hljs-keyword">import</span> homeReducer <span class="hljs-keyword">from</span> <span class="hljs-string">"./modules/home"</span>;

<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">configureStore</span>({
  <span class="hljs-attr">reducer</span>: {
    <span class="hljs-attr">home</span>: homeReducer,
  },
});

<span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">createWrapper</span>(<span class="hljs-function">() =&gt;</span> store);
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> wrapper;

</code></pre>
<p>这里我们可以看到createWrapper生成了一个wraper导出，它的主要作用就是使服务端与客户端状态同步，为什么需要同步？</p>
<p>我们再回顾下SSR的核心原理：</p>
<ul>
<li><strong>服务端状态序列化</strong>：在服务器端渲染时，将 Redux store 的状态序列化并注入到 HTML 中</li>
<li><strong>客户端状态水合</strong>：在客户端首次加载时，将服务端注入的状态重新水合到客户端的 Redux store</li>
<li><strong>避免状态不一致</strong>：防止服务端和客户端渲染结果不一致的问题</li>
</ul>
<p>最终，我们在入口文件_app.tsx中挂载store要做一点调整</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//pages\_app.tsx</span>

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Provider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-redux"</span>;
<span class="hljs-keyword">import</span> wrapper <span class="hljs-keyword">from</span> <span class="hljs-string">"../store"</span>;
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">AppProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/app"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params">{ Component, ...rest }: AppProps</span>) {
  <span class="hljs-comment">//实现服务端和客户端状态的自动同步</span>
  <span class="hljs-keyword">const</span> { store, props } = wrapper.<span class="hljs-title function_">useWrappedStore</span>(rest);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">store</span>=<span class="hljs-string">{store}</span>&gt;</span>
         <span class="hljs-tag">&lt;<span class="hljs-name">Component</span> {<span class="hljs-attr">...props.pageProps</span>} /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>
  );
}

</code></pre>
<p>自此，服务端渲染结合redux的核心应用就完成了！通过一张图梳理下个Next.js SSR数据预取与Redux状态同步的完整流程</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1a95b97deac470c86741c4de2aff620~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdmVudG9u:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764327307&amp;x-signature=yR7r3bKrSghsWwHJCMSVGCqSAds%3D" alt="deepseek_mermaid_20251121_d68c43.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[钉钉小程序直传文件到 阿里云OSS]]></title>    <link>https://juejin.cn/post/7574978545144512547</link>    <guid>https://juejin.cn/post/7574978545144512547</guid>    <pubDate>2025-11-21T12:25:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574978545144512547" data-draft-id="7574997924929880104" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="钉钉小程序直传文件到 阿里云OSS"/> <meta itemprop="keywords" content="前端,uni-app,Vue.js"/> <meta itemprop="datePublished" content="2025-11-21T12:25:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="广白"/> <meta itemprop="url" content="https://juejin.cn/user/231309974726702"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            钉钉小程序直传文件到 阿里云OSS
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/231309974726702/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    广白
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T12:25:18.000Z" title="Fri Nov 21 2025 12:25:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="tomorrow">.hljs-comment,.hljs-quote{color:#8e908c}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c82829}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5871f}.hljs-attribute{color:#eab700}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#718c00}.hljs-section,.hljs-title{color:#4271ae}.hljs-keyword,.hljs-selector-tag{color:#8959a8}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#4d4d4c}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>举个🌰，用钉钉小程序将一段视频在 前端 直接传到阿里云上。</p>
<p>由于 <code>js-base64</code> 这个npm包在钉钉小程序使用不了，而目前钉钉小程序又没有<code>base64ToArrayBuffe</code>r这类方法，故只能曲线救国，使用 <code>dd.writeFile</code>和 <code>dd.readFile</code>来做<code>base64</code>的转换。</p>
<p>首先，我们得先处理OSS配置，具体如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> crypto <span class="hljs-keyword">from</span> <span class="hljs-string">"crypto-js"</span>

<span class="hljs-keyword">const</span> <span class="hljs-title class_">OSSConfig</span> = {
  <span class="hljs-title class_">AccessKeyId</span>: <span class="hljs-string">"xxxx"</span>,
  <span class="hljs-title class_">AccessKeySecret</span>: <span class="hljs-string">"xxxxxx"</span>,
  <span class="hljs-title class_">Host</span>: <span class="hljs-string">"xxxxx"</span>, <span class="hljs-comment">// 具体某个账号下,</span>
  <span class="hljs-title class_">SecurityToken</span>: <span class="hljs-string">"xx"</span>, <span class="hljs-comment">// 可选，使用STS签名时必传。</span>
}

<span class="hljs-comment">// 计算签名。</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">computeSignature</span> = (<span class="hljs-params">accessKeySecret, canonicalString</span>) =&gt; {
  <span class="hljs-keyword">return</span> crypto.<span class="hljs-property">enc</span>.<span class="hljs-property">Base64</span>.<span class="hljs-title function_">stringify</span>(
    crypto.<span class="hljs-title class_">HmacSHA1</span>(canonicalString, accessKeySecret)
  )
}

<span class="hljs-keyword">let</span> ossData = <span class="hljs-literal">null</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getOssConfig</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
  date.<span class="hljs-title function_">setHours</span>(date.<span class="hljs-title function_">getHours</span>() + <span class="hljs-number">24</span>) <span class="hljs-comment">//加 1个小时</span>
  <span class="hljs-keyword">const</span> policyText = {
    <span class="hljs-attr">expiration</span>: date.<span class="hljs-title function_">toISOString</span>(), <span class="hljs-comment">// 设置policy过期时间。</span>
    <span class="hljs-attr">conditions</span>: [
      <span class="hljs-comment">// 限制上传大小。</span>
      [<span class="hljs-string">"content-length-range"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>],
    ],
  }
  <span class="hljs-keyword">let</span> fileManager = dd.<span class="hljs-title function_">getFileSystemManager</span>()
  fileManager.<span class="hljs-title function_">writeFile</span>({
    <span class="hljs-attr">filePath</span>: <span class="hljs-string">`<span class="hljs-subst">${dd.env.USER_DATA_PATH}</span>/test.txt`</span>,
    <span class="hljs-attr">data</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(policyText),
    <span class="hljs-attr">success</span>: <span class="hljs-function">() =&gt;</span> {
      fileManager.<span class="hljs-title function_">readFile</span>({
        <span class="hljs-attr">filePath</span>: <span class="hljs-string">`<span class="hljs-subst">${dd.env.USER_DATA_PATH}</span>/test.txt`</span>,
        <span class="hljs-attr">encoding</span>: <span class="hljs-string">"base64"</span>,
        <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">data</span>, <span class="hljs-string">"readFile"</span>)
          <span class="hljs-keyword">const</span> signature = <span class="hljs-title function_">computeSignature</span>(
            <span class="hljs-title class_">OSSConfig</span>.<span class="hljs-property">AccessKeySecret</span>,
            res.<span class="hljs-property">data</span>
          )
          ossData = {
            <span class="hljs-title class_">OSSAccessKeyId</span>: <span class="hljs-title class_">OSSConfig</span>.<span class="hljs-property">AccessKeyId</span>,
            signature,
            <span class="hljs-attr">policy</span>: res.<span class="hljs-property">data</span>,
            <span class="hljs-comment">// "x-oss-security-token": OSSConfig.SecurityToken,</span>
          }
        },
        <span class="hljs-attr">fail</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err)
        },
      })
    },
    <span class="hljs-attr">fail</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err)
    },
  })
}
</code></pre>
<p>这个ossData就是我们处理好后的配置项，接下来将其填充到 <code>dd.uploadFile</code> 里就大功告成了！</p>
<pre><code class="hljs language-js" lang="js">dd.<span class="hljs-title function_">chooseVideo</span>({
        <span class="hljs-attr">sourceType</span>: [<span class="hljs-string">"album"</span>, <span class="hljs-string">"camera"</span>],
        <span class="hljs-attr">maxDuration</span>: <span class="hljs-number">60</span>,
        <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-keyword">let</span> uniqueId = <span class="hljs-string">`<span class="hljs-subst">${dirPath}</span>xcx-<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime()}</span>.mp4`</span> <span class="hljs-comment">// dirPath为存储的文件夹路径， 比如"dev/front-end/video/"</span>
          uni.<span class="hljs-title function_">showLoading</span>({
            <span class="hljs-attr">title</span>: <span class="hljs-string">"视频上传中..."</span>,
          })
          dd.<span class="hljs-title function_">uploadFile</span>({
            <span class="hljs-attr">url</span>: <span class="hljs-title class_">OSSConfig</span>.<span class="hljs-property">Host</span>,
            <span class="hljs-attr">fileType</span>: <span class="hljs-string">"video"</span>,
            <span class="hljs-attr">fileName</span>: <span class="hljs-string">"file"</span>,
            <span class="hljs-attr">formData</span>: {
              ...ossData, <span class="hljs-comment">// 上述getOssConfig方法得到的结果</span>
              <span class="hljs-attr">key</span>: uniqueId, <span class="hljs-comment">// 该值为你存在在oss上的位置  后面上传成功之后拼接得到链接需要使用</span>
              <span class="hljs-attr">success_action_status</span>: <span class="hljs-string">"200"</span>, <span class="hljs-comment">// 默认上传成功状态码为204，此处被success_action_status设置为200。</span>
            },
            <span class="hljs-attr">filePath</span>: res.<span class="hljs-property">tempFilePath</span>,
            <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
              uni.<span class="hljs-title function_">hideLoading</span>()
              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"视频上传成功,地址为："</span>,<span class="hljs-string">`<span class="hljs-subst">${OSSConfig.Host}</span>/<span class="hljs-subst">${uniqueId}</span>`</span>)
            },
            <span class="hljs-attr">fail</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
              uni.<span class="hljs-title function_">hideLoading</span>()
            },
          })
        },
        <span class="hljs-attr">fail</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err)
        },
      })
</code></pre>
<p><br/><br/>
<strong>欢迎小伙伴留言讨论，互相学习！</strong></p>
<p><strong>❤❤❤ 如果对你有帮助，记得点赞收藏哦！❤❤❤</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter每日库: local_auth本地设备验证插件]]></title>    <link>https://juejin.cn/post/7574992086715482127</link>    <guid>https://juejin.cn/post/7574992086715482127</guid>    <pubDate>2025-11-21T12:38:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574992086715482127" data-draft-id="7574997924929912872" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter每日库: local_auth本地设备验证插件"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-11-21T12:38:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天天开发"/> <meta itemprop="url" content="https://juejin.cn/user/4420475793718670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter每日库: local_auth本地设备验证插件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4420475793718670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天天开发
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T12:38:15.000Z" title="Fri Nov 21 2025 12:38:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在移动应用开发中，用户隐私和安全至关重要。你是否想过为APP添加类似手机解锁的本地身份验证功能？今天介绍的<strong>local_auth插件</strong>，正是Flutter开发者实现指纹、人脸识别的终极武器！无需复杂代码，轻松打造安全又炫酷的认证体验</p>
<h2 data-id="heading-0">功能亮点</h2>
<ul>
<li><strong>多平台支持</strong>：兼容iOS（Face ID/Touch ID）和Android（指纹/人脸）</li>
<li><strong>一键验证</strong>：调用系统原生界面，用户体验无缝衔接</li>
<li><strong>灵活配置</strong>：支持生物识别+密码双验证模式</li>
<li><strong>异常处理</strong>：智能识别硬件锁死、权限异常等场景</li>
</ul>
<h2 data-id="heading-1">安装方式</h2>
<pre><code class="hljs language-csharp" lang="csharp">flutter pub <span class="hljs-keyword">add</span> local_auth
</code></pre>
<h2 data-id="heading-2">详细配置和示例</h2>
<h3 data-id="heading-3">iOS和安卓平台的配置</h3>
<p>iOS需要再info.plist中配置face ID的权限</p>
<pre><code class="hljs language-vbnet" lang="vbnet">&lt;<span class="hljs-keyword">key</span>&gt;NSFaceIDUsageDescription&lt;/<span class="hljs-keyword">key</span>&gt;
&lt;<span class="hljs-type">string</span>&gt;Why <span class="hljs-built_in">is</span> my app authenticating <span class="hljs-keyword">using</span> face id?&lt;/<span class="hljs-type">string</span>&gt;
</code></pre>
<h3 data-id="heading-4">安卓配置如下</h3>
<p>1、修改安卓的原生MainActivity的父类</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> io.flutter.embedding.android.FlutterActivity
​
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">FlutterActivity</span>()
​
<span class="hljs-comment">// 修改为：</span>
<span class="hljs-keyword">import</span> io.flutter.embedding.android.FlutterFragmentActivity
​
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">FlutterFragmentActivity</span> ()
</code></pre>
<p>2、在AndroidManifest.xml添加权限</p>
<pre><code class="hljs language-ini" lang="ini">&lt;manifest xmlns:<span class="hljs-attr">android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
          <span class="hljs-attr">package</span>=<span class="hljs-string">"com.example.app"</span>&gt;
  &lt;uses-permission android:<span class="hljs-attr">name</span>=<span class="hljs-string">"android.permission.USE_BIOMETRIC"</span>/&gt;
&lt;manifest&gt;
</code></pre>
<h3 data-id="heading-5">硬件能力检测</h3>
<pre><code class="hljs language-ini" lang="ini">final <span class="hljs-attr">auth</span> = LocalAuthentication()<span class="hljs-comment">;</span>
​
// 检测设备是否支持
bool <span class="hljs-attr">isSupported</span> = await auth.isDeviceSupported()<span class="hljs-comment">;</span>
​
// 查看已注册的生物识别类型
List&lt;BiometricType&gt; <span class="hljs-attr">types</span> = await auth.getAvailableBiometrics()<span class="hljs-comment">;</span>
// 可能返回：fingerprint（指纹）、face（人脸）、strong（高安全级别）
</code></pre>
<h3 data-id="heading-6">完整代码示例</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/services.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:local_auth/local_auth.dart'</span>;
​
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> TestPage({<span class="hljs-keyword">super</span>.key});
​
  <span class="hljs-meta">@override</span>
  State&lt;TestPage&gt; createState() =&gt; _TestPageState();
}
​
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_TestPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">TestPage</span>&gt; </span>{
  <span class="hljs-keyword">final</span> LocalAuthentication auth = LocalAuthentication();
​
  Future&lt;<span class="hljs-keyword">void</span>&gt; _checkBiometrics() <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// canCheckBiometrics 仅指示硬件是否支持，并不表示设备是否已注册任何生物识别信息，有可能未录入指纹或者人脸</span>
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> canAuthenticateWithBiometrics = <span class="hljs-keyword">await</span> auth.canCheckBiometrics;
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> isDeviceSupported = <span class="hljs-keyword">await</span> auth.isDeviceSupported();
    debugPrint(
      <span class="hljs-string">"canAuthenticateWithBiometrics = <span class="hljs-subst">$canAuthenticateWithBiometrics</span> isDeviceSupported = <span class="hljs-subst">$isDeviceSupported</span>"</span>,
    );
  }
​
  Future&lt;<span class="hljs-keyword">void</span>&gt; _getAvailableBiometricsData() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;BiometricType&gt; availableBiometrics = <span class="hljs-keyword">await</span> auth
        .getAvailableBiometrics();
​
    <span class="hljs-keyword">if</span> (availableBiometrics.isEmpty) {
      debugPrint(<span class="hljs-string">"设备未注册任何生物识别信息"</span>);
      <span class="hljs-keyword">return</span>;
    }
​
    <span class="hljs-keyword">for</span> (BiometricType item <span class="hljs-keyword">in</span> availableBiometrics) {
      debugPrint(<span class="hljs-string">"type = <span class="hljs-subst">${item.name}</span>"</span>);
    }
​
    <span class="hljs-comment">// if (availableBiometrics.contains(BiometricType.strong) ||</span>
    <span class="hljs-comment">//     availableBiometrics.contains(BiometricType.face)) {</span>
    <span class="hljs-comment">// }</span>
  }
​
  Future&lt;<span class="hljs-keyword">void</span>&gt; authenticateTest() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> didAuthenticate = <span class="hljs-keyword">await</span> auth.authenticate(
        localizedReason: <span class="hljs-string">'Please authenticate to show account balance'</span>,
        biometricOnly: <span class="hljs-keyword">true</span>, <span class="hljs-comment">// 强制使用生物识别认证</span>
        persistAcrossBackgrounding: <span class="hljs-keyword">true</span>, <span class="hljs-comment">// 应用未验证就退到后台，再次在前台运行时，重试身份验证</span>
      );
​
      <span class="hljs-keyword">if</span> (didAuthenticate) {
        debugPrint(<span class="hljs-string">"success"</span>);
      } <span class="hljs-keyword">else</span> {
        debugPrint(<span class="hljs-string">"fail"</span>);
      }
    } <span class="hljs-keyword">on</span> LocalAuthException <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-comment">// 异常处理  temporaryLockout  biometricLockout  指纹或face ID被锁定</span>
      debugPrint(<span class="hljs-string">"LocalAuthException <span class="hljs-subst">${e.toString()}</span>"</span>);
    } <span class="hljs-keyword">on</span> PlatformException <span class="hljs-keyword">catch</span> (e) {
      debugPrint(<span class="hljs-string">"PlatformException <span class="hljs-subst">${e.message}</span>"</span>);
    }
  }
​
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> MaterialApp(
      home: Scaffold(
        appBar: AppBar(title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'local_auth'</span>)),
        body: Column(
          children: [
            ElevatedButton(
              onPressed: () {
                _checkBiometrics();
              },
              child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'检查此设备是否支持本地身份验证'</span>),
            ),
​
            ElevatedButton(
              onPressed: () {
                _getAvailableBiometricsData();
              },
              child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'获取注册生物识别信息的列表'</span>),
            ),
​
            ElevatedButton(
              onPressed: () {
                authenticateTest();
              },
              child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'Check biometrics'</span>),
            ),
          ],
        ),
      ),
    );
  }
}
​
</code></pre>
<p>以上就是该库在移动端的使用情况了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[windows中flutter开发鸿蒙实操]]></title>    <link>https://juejin.cn/post/7574840547808182282</link>    <guid>https://juejin.cn/post/7574840547808182282</guid>    <pubDate>2025-11-21T12:52:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574840547808182282" data-draft-id="7575017581036224550" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="windows中flutter开发鸿蒙实操"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-11-21T12:52:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大雷神"/> <meta itemprop="url" content="https://juejin.cn/user/1688498113884839"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            windows中flutter开发鸿蒙实操
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1688498113884839/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大雷神
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T12:52:07.000Z" title="Fri Nov 21 2025 12:52:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h3 data-id="heading-0">环境搭建完成 开始构建项目</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83de3916c2f34b4da65e1e6e8c216e2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn6Zu356We:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334327&amp;x-signature=PZJHXKzBIsEVL5aZUZhYsXyEAk0%3D" alt="" loading="lazy"/><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/>​编辑</p>
<h3 data-id="heading-1">项目目录</h3>
<p>打开项目以后 可以看到结构如下 里面的ohos就是鸿蒙代码</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b093bacf9a4849c8b30ea2059595c5c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn6Zu356We:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334327&amp;x-signature=XUyCkUhksB64N64Vj0rBpd2BJiA%3D" alt="" loading="lazy"/><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/>​编辑</p>
<p>展开看看 熟悉吧</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37d683688a04416ab842c8f00a354274~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn6Zu356We:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334327&amp;x-signature=JCHzqD4XhqbiLhenlFukJP%2FLWH8%3D" alt="" loading="lazy"/><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/>​编辑</p>
<p>不要直接去操作这些代码，肯定跑不起来的</p>
<h3 data-id="heading-2">启动模拟器</h3>
<p>这个时候打开DevEco工具 启动模拟器 随便用哪个项目打开都行 只启动模拟器就可以了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49bbc5745f2e492e9e87ca7f3da75495~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn6Zu356We:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334327&amp;x-signature=HCIW%2BB6Wi7JR3LbukSrR81ehuQM%3D" alt="" loading="lazy"/><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/>​编辑</p>
<p>启动以后</p>
<h3 data-id="heading-3">打包</h3>
<p>打开项目目录 运行</p>
<p>flutter build hap --debug</p>
<p>构建鸿蒙项目包</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fafb23b8256a41d480b87b8e72210b50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn6Zu356We:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334327&amp;x-signature=pYCxFYus1cTJ3w8CZ7lJs1DDgIw%3D" alt="" loading="lazy"/><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/>​编辑</p>
<p>打包完成后开始运行flutter项目<br/>
在终端继续输入命令：</p>
<p>flutter run<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b36cc8a27e84ec5aab757b1e671dd52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn6Zu356We:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334327&amp;x-signature=DJqZNYgIelJkREvBQMuYXgYhEYs%3D" alt="" loading="lazy"/><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/>​编辑然后选择1 用模拟器启动</p>
<h3 data-id="heading-4">模拟器效果</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/687db6f9aaf94759a3fda2f285311776~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn6Zu356We:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334327&amp;x-signature=azXeWo7hrIV35rx78wY695Kmo6c%3D" alt="" loading="lazy"/><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/>​编辑</p>
<h3 data-id="heading-5">实操</h3>
<p>用vsCode打开项目 找到lib目录 里面的main.dart 就是程序的主入口</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df1bbc21eee44d4e91bc35b0339713c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn6Zu356We:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334327&amp;x-signature=ncACY5U3jrJ%2FQY426%2BEghYV1XeY%3D" alt="" loading="lazy"/><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/>​编辑在lib中分别新建pages，在新建四个文件夹 Home Cinema Film Mine ,然后分别新建各自的默认页面 index.dart</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9564b73c027b42a4ba40b74378bef6a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn6Zu356We:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334327&amp;x-signature=inytvsjBiQbcFHEjzDKKE4rD9q8%3D" alt="" loading="lazy"/><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/>​编辑</p>
<p>分别定义好自己的页面内容</p>
<p>Cinema/index</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">import</span> '<span class="hljs-keyword">package</span>:flutter/material.dart';

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CinemaPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span></span>{
  const <span class="hljs-type">CinemaPage</span>({<span class="hljs-keyword">super</span>.key});
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
   <span class="hljs-keyword">return</span> const <span class="hljs-type">Center</span>(
    child: <span class="hljs-type">Text</span>('影院',style: <span class="hljs-type">TextStyle</span>(fontSize: <span class="hljs-number">24</span>),),
   );
  }
}

</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>Film/index</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">import</span> '<span class="hljs-keyword">package</span>:flutter/material.dart';

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FilmPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  const <span class="hljs-type">FilmPage</span>({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> const <span class="hljs-type">Center</span>(
      child: <span class="hljs-type">Text</span>('电影', style: <span class="hljs-type">TextStyle</span>(fontSize: <span class="hljs-number">24</span>)),
    );
  }
}
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>Home/index</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">import</span> '<span class="hljs-keyword">package</span>:flutter/material.dart';

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HomePage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span></span>{
  const <span class="hljs-type">HomePage</span>({<span class="hljs-keyword">super</span>.key});
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {

    <span class="hljs-keyword">return</span> const <span class="hljs-type">Center</span>(
      child: <span class="hljs-type">Column</span>(
        mainAxisAlignment: <span class="hljs-type">MainAxisAlignment</span>.center,
        children: &lt;<span class="hljs-type">Widget</span>&gt;[
          <span class="hljs-type">Text</span>('首页',style: <span class="hljs-type">TextStyle</span>(fontSize:<span class="hljs-number">24</span>))
        ],
      )
    );




  }
}
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>Mine/index</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">import</span> '<span class="hljs-keyword">package</span>:flutter/material.dart';

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MinePage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  const <span class="hljs-type">MinePage</span>({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> const <span class="hljs-type">Center</span>(
      child: <span class="hljs-type">Text</span>('我的', style: <span class="hljs-type">TextStyle</span>(fontSize: <span class="hljs-number">24</span>)),
    );
  }
}
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>最后修改main.dart文件</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">import</span> '<span class="hljs-keyword">package</span>:flutter/material.dart';
<span class="hljs-keyword">import</span> '<span class="hljs-keyword">package</span>:my_app01/pages/<span class="hljs-type">Cinema</span>/index.dart';
<span class="hljs-keyword">import</span> '<span class="hljs-keyword">package</span>:my_app01/pages/<span class="hljs-type">Home</span>/index.dart';
<span class="hljs-keyword">import</span> '<span class="hljs-keyword">package</span>:my_app01/pages/<span class="hljs-type">Film</span>/index.dart';
<span class="hljs-keyword">import</span> '<span class="hljs-keyword">package</span>:my_app01/pages/<span class="hljs-type">Mine</span>/index.dart';


void main() {
  runApp(const <span class="hljs-type">MyApp</span>());
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  const <span class="hljs-type">MyApp</span>({<span class="hljs-keyword">super</span>.key});
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">MaterialApp</span>(
      title: '<span class="hljs-type">Flutter</span> <span class="hljs-type">Demo</span>',
      theme: <span class="hljs-type">ThemeData</span>(
        colorScheme: <span class="hljs-type">ColorScheme</span>.fromSeed(seedColor: <span class="hljs-type">Colors</span>.deepPurple),
        useMaterial3: <span class="hljs-literal">true</span>,
      ),
      home: const <span class="hljs-type">MainScreen</span>(),
    );
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainScreen</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  const <span class="hljs-type">MainScreen</span>({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">State</span>&lt;<span class="hljs-type">MainScreen</span>&gt;createState()=&gt;_MainScreenState();
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MainScreenState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State&lt;MainScreen&gt;</span></span>{
  int _currentIndex = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">final</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">Widget</span>&gt; _page = const[
    <span class="hljs-type">HomePage</span>(),
    <span class="hljs-type">CinemaPage</span>(),
    <span class="hljs-type">FilmPage</span>(),
    <span class="hljs-type">MinePage</span>(),
  ];
  <span class="hljs-keyword">final</span> <span class="hljs-type">List</span>&lt;<span class="hljs-type">BottomNavigationBarItem</span>&gt; _navBarItems = [
    const <span class="hljs-type">BottomNavigationBarItem</span>(
      icon: <span class="hljs-type">Icon</span>(<span class="hljs-type">Icons</span>.home_outlined),
      activeIcon: <span class="hljs-type">Icon</span>(<span class="hljs-type">Icons</span>.home,color: <span class="hljs-type">Colors</span>.blue),
      label: '首页'
    ),
    const <span class="hljs-type">BottomNavigationBarItem</span>(
      icon: <span class="hljs-type">Icon</span>(<span class="hljs-type">Icons</span>.contacts_outlined),
      activeIcon: <span class="hljs-type">Icon</span>(<span class="hljs-type">Icons</span>.contacts, color: <span class="hljs-type">Colors</span>.blue),
      label: '影院',
    ),
    const <span class="hljs-type">BottomNavigationBarItem</span>(
      icon: <span class="hljs-type">Icon</span>(<span class="hljs-type">Icons</span>.people_outline),
      activeIcon: <span class="hljs-type">Icon</span>(<span class="hljs-type">Icons</span>.people, color: <span class="hljs-type">Colors</span>.blue),
      label: '个人',
    ),
    const <span class="hljs-type">BottomNavigationBarItem</span>(
      icon: <span class="hljs-type">Icon</span>(<span class="hljs-type">Icons</span>.person_outline),
      activeIcon: <span class="hljs-type">Icon</span>(<span class="hljs-type">Icons</span>.person, color: <span class="hljs-type">Colors</span>.blue),
      label: '我的',
    ),
  ];
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context){
    <span class="hljs-keyword">return</span> <span class="hljs-type">Scaffold</span>(
      appBar: <span class="hljs-type">AppBar</span>(
        title: <span class="hljs-type">Text</span>(_getAppBarTitle()),
      ),
      body: _page[_currentIndex],
      bottomNavigationBar: <span class="hljs-type">BottomNavigationBar</span>(
       items: _navBarItems,
        currentIndex: _currentIndex,
        onTap: (index) {
          setState(() {
            _currentIndex = index; <span class="hljs-comment">// 更新当前索引</span>
          });
        },
        <span class="hljs-class"><span class="hljs-keyword">type</span></span>: <span class="hljs-type">BottomNavigationBarType</span>.fixed, <span class="hljs-comment">// 固定样式（支持4个以上）</span>
        selectedItemColor: <span class="hljs-type">Colors</span>.blue, <span class="hljs-comment">// 选中项颜色</span>
        unselectedItemColor: <span class="hljs-type">Colors</span>.grey, <span class="hljs-comment">// 未选中项颜色</span>
      ),
    );
  }
  <span class="hljs-comment">// 根据当前索引返回AppBar标题</span>
  <span class="hljs-type">String</span> _getAppBarTitle() {
    switch (_currentIndex) {
      <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>: <span class="hljs-keyword">return</span> '首页';
      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-keyword">return</span> '影院';
      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: <span class="hljs-keyword">return</span> '电影';
      <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: <span class="hljs-keyword">return</span> '个人';
      <span class="hljs-keyword">default</span>: <span class="hljs-keyword">return</span> '我的应用';
    }
  }
}
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<h3 data-id="heading-6">先启动鸿蒙虚拟机 或者真机</h3>
<h3 data-id="heading-7">编译成鸿蒙</h3>
<p>先运行 flutter build hap</p>
<p>在运行 flutter run</p>
<p>最后的效果如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcab8fc1cbf54fa6b32f483261417b60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn6Zu356We:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334327&amp;x-signature=UQFtEcrt0P9peK2C92HxDBHR1wE%3D" alt="" loading="lazy"/><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/>​编辑</p>
<p>你学废了吗？</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2Ffd34ff9286174e848d34cde7f512ce22%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" title="https://developer.huawei.com/consumer/cn/training/classDetail/fd34ff9286174e848d34cde7f512ce22?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" target="_blank" ref="nofollow noopener noreferrer">developer.huawei.com/consumer/cn…</a></p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++进阶小技巧：让代码从"能用"变"优雅"]]></title>    <link>https://juejin.cn/post/7574840547808313354</link>    <guid>https://juejin.cn/post/7574840547808313354</guid>    <pubDate>2025-11-21T13:26:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574840547808313354" data-draft-id="7575006095388753929" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++进阶小技巧：让代码从&quot;能用&quot;变&quot;优雅&quot;"/> <meta itemprop="keywords" content="前端,C++"/> <meta itemprop="datePublished" content="2025-11-21T13:26:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA简单玩转程序设计"/> <meta itemprop="url" content="https://juejin.cn/user/4294056357689099"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++进阶小技巧：让代码从"能用"变"优雅"
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4294056357689099/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA简单玩转程序设计
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T13:26:16.000Z" title="Fri Nov 21 2025 13:26:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin:30px 0 10px;color:#cca152;position:relative;padding-left:50px;border-bottom:2px solid rgba(209,163,78,.6);padding-bottom:0}.markdown-body h1{font-size:30px}.markdown-body h1:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:80%;bottom:-10px;left:-2px}.markdown-body h2{font-size:24px}.markdown-body h2:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:70%;bottom:-15px;left:-1px}.markdown-body h3{font-size:18px}.markdown-body h3:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:60%;bottom:-19px;left:-2px}.markdown-body h4{font-size:16px;padding-left:0;border-bottom:1px solid rgba(209,163,78,.6)}.markdown-body h5{font-size:15px;padding-left:0}.markdown-body em{color:#cca152}.markdown-body del{text-decoration-color:#cca152;text-decoration-thickness:2px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:80%;margin:6px auto;box-shadow:0 6px 15px #8e8e8e;display:block;margin:20px auto!important;object-fit:contain;border-radius:8px}.markdown-body hr{border:none;border-top:2px solid #e0c9a1;margin-top:32px 0}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background:#f6efde;color:#b69454;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Mono,Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;background:#fef6e1;border-radius:4px;box-shadow:0 0 8px hsla(0,0%,47%,.45)}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAOCAMAAABaWb9VAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAADsQAAA7EAZUrDhsAAACHUExURUdwTMxCKdc8NvdYT/9hVyLJPABBAGubKNiIOv+/K+ytJBakH9aZG+5QR5VZDOBDPhmtJ8+VGuGjH/CwJR26MR6+NBq0LPW1KBmwKetNRfJUTONHP92fHuSmIeFEPhu3LR29M/BTS+mqIuqsI5qdHyLKPP++Kv9gVf9lW//KLSXXQCTQP//FLMVm5KQAAAAldFJOUwAlPPz7+woBBPu8Mzu+FlRRKmvnweeG+Wqg6mVNXmuc1OCbmjZJWF/9AAABKklEQVQoz3WS6XaCMBCFRzAM++KGsqhtDwES3//5OtmA2uP9A9zwzRoAgBC0QgQrdA68OZsDr229YGHoIEj7Pl0ZOgjKa5lYJ4Rd1vijn3nuD4Qurjmv48o6RFyfbGDnS6DeEXZfk5ZfuBhdPb9I87ECNMh1EFJKIU6agWzaa01NbmLkxznSmmObJBkkUxrERf3i+ftRiZi7ShPCYY64UhTx1AR5CDYoMXkOKEY7GmTcTzeD/FiER68DfSLgSRqEIBoB3P8h3x8RZhBXGJGusJdD6rfCBl0YqvZNkrV9zej2cWlfJWG6fRpyM41qYH+GTPPi2yFLQYC0Qybm5o96lW77kMbcrBKtgeWTsthVamNXFF4I6x0DTPuugsVRFyYpyxzWqNvHJwed8ws7QyP1UwjNjwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fef6e1}.markdown-body a{text-decoration:none;color:#d8ac5a;border-bottom:1px solid #d8ac5a}.markdown-body a:active,.markdown-body a:hover{color:#93753f;border-color:#93753f}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f4e8c7;border-collapse:collapse}.markdown-body thead{background:rgba(255,227,176,.6588235294);text-align:left;display:table-header-group;border-bottom:1px solid rgba(255,227,176,.6588235294)}.markdown-body tbody{background:rgba(255,247,229,.3882352941)}.markdown-body td,.markdown-body th{padding:7px;line-height:24px;min-width:100px}.markdown-body blockquote{color:#bd954f;padding:1px 23px;margin:22px 0;border-left:4px solid #dcb267;background-color:#fff7e5}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol .task-list-item,.markdown-body ul .task-list-item{list-style:none}.markdown-body ol li{padding-left:6px}.markdown-body::marker{color:#dcb267}.markdown-body .contains-task-list{padding-left:0}.markdown-body .contains-task-list .task-list-item{list-style:none;position:relative}.markdown-body .contains-task-list .task-list-item input[type=checkbox]{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:before{content:"";display:inline-block;height:12px;width:12px;position:absolute;left:-2px;top:-2px;border:2px solid #cda152;border-radius:5px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked:before{border:none;content:"";display:inline-block;height:17px;width:17px;position:absolute;left:-2px;top:-2px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAFo9M/3AAAAAXNSR0IArs4c6QAAAYhJREFUOBFjYACC0/MDGsDEiyvr/zOCeUwMJxn/A8HZRUEMYBFGJsZ6kFoQYALiAyAGCgDpA+sFijKeWRj4H1kWpIWBW1SDQcm+BCzOAiK/vr7BcO/gDbAAI4hE1waWgRBnmWCGIwkyKFjnwow0BhsJk9QLncvw5dV1oPE9MCEGmBWrgCKhcFEowyR+PSNYwemFAZ4M/xjMkRWYJm5oAPFB/joDpI1BHHQANgGPDxj+//vfCA4IdJ3GcevgQnAFhlHLwYIgSVA0wABcwY3tFQzokiBFGIEP0wmigW5wZAK5FFkQib0a6NUDcEmgb7AGFpIGZOZqoMFhIAFQknEAJpn9yLLEssFOBCp2IFaDkl0xg6C8FbJyB3gowUS5RdQYBORQYpVB1iwVHIIMwJh///AYTCmYRklNIBFmNi4GeYt0BhnjeIa3dw8wSBlEgDUhxw2yCRgGfHp2geHiqiSwUwUVrFAiFVkjjA1LrjgTHEwhFvosMCZM4NEIUoAtWWNoBGZ70/gN22HiAD2uhAzsYNBZAAAAAElFTkSuQmCC) 0 0 no-repeat;background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在掘金逛C++帖子时，总能看到新手问"为什么我的代码能跑但总被review打回"？其实很多时候不是逻辑错了，而是没掌握这些"进阶偏基础"的实用技巧——既能少踩坑，又能让代码更简洁高效，配上极简例子一看就会～</p>
<h2 data-id="heading-0">1. 前向声明：头文件依赖的"减负神器"</h2>
<p>还在头文件里疯狂#include？前向声明能直接减少编译依赖，还能解决循环依赖问题 ！</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// forward.h （集中存放前向声明）</span>
<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Document</span>; <span class="hljs-comment">// 无需包含完整定义，声明即可</span>

<span class="hljs-comment">// my_class.h</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"forward.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> {
    std::unique_ptr&lt;Document&gt; doc; <span class="hljs-comment">// 指针/引用类型只需前向声明</span>
};
</code></pre>
<p> </p>
<p>核心优势：编译速度翻倍，避免"改一个头文件全工程重编"的痛苦。</p>
<h2 data-id="heading-1">2. emplace_back：容器插入的"性能王者"</h2>
<p>别再用push_back了！<code>emplace_back</code>直接在容器内构造对象，省去临时对象拷贝的开销 。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span>

std::vector&lt;std::string&gt; vec;
vec.<span class="hljs-built_in">push_back</span>(std::<span class="hljs-built_in">string</span>(<span class="hljs-string">"hello"</span>)); <span class="hljs-comment">// 先构造临时对象，再拷贝</span>
vec.<span class="hljs-built_in">emplace_back</span>(<span class="hljs-string">"world"</span>); <span class="hljs-comment">// 直接在vector里构造，零拷贝</span>
</code></pre>
<p> </p>
<p>适用场景：所有支持的STL容器（vector、list、map等），插入复杂对象时效果超明显。</p>
<h2 data-id="heading-2">3. 静态工厂方法：对象创建的"安全卫士"</h2>
<p>构造函数没法返回错误？静态工厂方法能优雅处理对象创建失败，避免部分初始化的坑 。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;optional&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FileProcessor</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 静态工厂方法，创建失败返回nullopt</span>
    <span class="hljs-function"><span class="hljs-type">static</span> std::optional&lt;FileProcessor&gt; <span class="hljs-title">create</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; filename)</span> </span>{
        <span class="hljs-function">std::ifstream <span class="hljs-title">file</span><span class="hljs-params">(filename)</span></span>;
        <span class="hljs-keyword">if</span> (!file.<span class="hljs-built_in">is_open</span>()) <span class="hljs-keyword">return</span> std::<span class="hljs-literal">nullopt</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">FileProcessor</span>(std::<span class="hljs-built_in">move</span>(file)); <span class="hljs-comment">// 私有构造确保初始化成功</span>
    }
<span class="hljs-keyword">private</span>:
    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">FileProcessor</span><span class="hljs-params">(std::ifstream file)</span> : file_(std::move(file)) {</span>}
    std::ifstream file_;
};

<span class="hljs-comment">// 使用：创建成功才执行逻辑</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> processor = FileProcessor::<span class="hljs-built_in">create</span>(<span class="hljs-string">"data.txt"</span>)) {
    processor-&gt;<span class="hljs-built_in">process</span>();
}
</code></pre>
<p> </p>
<h2 data-id="heading-3">4. 结构化绑定：解包的"懒人福音"</h2>
<p>不用再写<code>get&lt;0&gt;、get&lt;1&gt;</code>了！结构化绑定能直接<code>解包tuple/pair</code>，代码清爽到飞起。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;tuple&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span>

<span class="hljs-comment">// 返回多个值的函数</span>
<span class="hljs-function">std::tuple&lt;<span class="hljs-type">int</span>, std::string, <span class="hljs-type">float</span>&gt; <span class="hljs-title">getUser</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> {<span class="hljs-number">101</span>, <span class="hljs-string">"张三"</span>, <span class="hljs-number">95.5</span>};
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">auto</span> [id, name, score] = <span class="hljs-built_in">getUser</span>(); <span class="hljs-comment">// 直接绑定三个变量</span>
    <span class="hljs-comment">// id=101, name="张三", score=95.5</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p> </p>
<h2 data-id="heading-4">5. 作用域守卫：资源清理的"自动管家"</h2>
<p>怕函数中途<code>return</code>导致资源泄漏？作用域守卫能确保离开作用域时自动执行清理逻辑 。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;functional&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ScopeGuard</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">ScopeGuard</span><span class="hljs-params">(std::function&lt;<span class="hljs-type">void</span>()&gt; cleanup)</span> 
        : cleanup_(std::move(cleanup)), active_(true) {</span>}
    ~<span class="hljs-built_in">ScopeGuard</span>() { <span class="hljs-keyword">if</span> (active_) <span class="hljs-built_in">cleanup_</span>(); }
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dismiss</span><span class="hljs-params">()</span> </span>{ active_ = <span class="hljs-literal">false</span>; } <span class="hljs-comment">// 可取消清理</span>
<span class="hljs-keyword">private</span>:
    std::function&lt;<span class="hljs-type">void</span>()&gt; cleanup_;
    <span class="hljs-type">bool</span> active_;
};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">writeFile</span><span class="hljs-params">()</span> </span>{
    FILE* file = <span class="hljs-built_in">fopen</span>(<span class="hljs-string">"temp.txt"</span>, <span class="hljs-string">"w"</span>);
    <span class="hljs-function">ScopeGuard <span class="hljs-title">guard</span><span class="hljs-params">([&amp;]() { <span class="hljs-keyword">if</span> (file) fclose(file); })</span></span>; <span class="hljs-comment">// 自动关文件</span>
    
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">someError</span>()) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 即使提前返回，文件也会关闭</span>
}
</code></pre>
<p> </p>
<h2 data-id="heading-5">6. constexpr：编译期计算的"性能加速器"</h2>
<p>把能在编译期算的逻辑交给编译器，运行时零开销，还能用作常量表达式 。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 编译期计算阶乘</span>
<span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> <span class="hljs-title">factorial</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> </span>{
    <span class="hljs-keyword">return</span> n &lt;= <span class="hljs-number">1</span> ? <span class="hljs-number">1</span> : n * <span class="hljs-built_in">factorial</span>(n - <span class="hljs-number">1</span>);
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> size = <span class="hljs-built_in">factorial</span>(<span class="hljs-number">5</span>); <span class="hljs-comment">// 编译时就算出120</span>
    <span class="hljs-type">int</span> arr[size]; <span class="hljs-comment">// 可直接用作数组大小</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p> </p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[多语言的爱意告白]]></title>    <link>https://juejin.cn/post/7575021014032564243</link>    <guid>https://juejin.cn/post/7575021014032564243</guid>    <pubDate>2025-11-21T14:35:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575021014032564243" data-draft-id="7575050949958434852" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="多语言的爱意告白"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-11-21T14:35:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="花开花富贵"/> <meta itemprop="url" content="https://juejin.cn/user/3220933005549171"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            多语言的爱意告白
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3220933005549171/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    花开花富贵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T14:35:39.000Z" title="Fri Nov 21 2025 14:35:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这张图片以黑色为背景，中央突出显示白色的 “小鱼” 字样，周围环绕着多语言的 “我喜欢你”“我爱你”“和我交往吧”“在一起” 等表达爱慕与交往意愿的文字，文字颜色多样，营造出一种充满爱意的视觉氛围。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/775fa0cfa4d44cde9ee8ed313f08d7d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iqx5byA6Iqx5a-M6LS1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764340539&amp;x-signature=VBCcq0jZRoznZKaPUh5CUdpeiMo%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pygame
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> math
<span class="hljs-keyword">import</span> os

<span class="hljs-comment"># 初始化pygame</span>
pygame.init()
<span class="hljs-comment"># 窗口设置</span>
width, height = <span class="hljs-number">1000</span>, <span class="hljs-number">800</span>
screen = pygame.display.set_mode((width, height))

<span class="hljs-comment"># 改进的字体设置函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_font</span>(<span class="hljs-params">size</span>):
    font_paths = [
        <span class="hljs-string">"C:/Windows/Fonts/simhei.ttf"</span>, <span class="hljs-string">"C:/Windows/Fonts/msyh.ttc"</span>, <span class="hljs-string">"C:/Windows/Fonts/simsun.ttc"</span>,
        <span class="hljs-string">"/System/Library/Fonts/PingFang.ttc"</span>, <span class="hljs-string">"/System/Library/Fonts/Arial.ttf"</span>,
        <span class="hljs-string">"/usr/share/fonts/truetype/droid/DroidSansFallbackFull.ttf"</span>, <span class="hljs-string">"/usr/share/fonts/truetype/wqy/wqy-microhei.ttc"</span>,
    ]
    <span class="hljs-keyword">for</span> font_path <span class="hljs-keyword">in</span> font_paths:
        <span class="hljs-keyword">if</span> os.path.exists(font_path):
            <span class="hljs-keyword">try</span>:
                <span class="hljs-keyword">return</span> pygame.font.Font(font_path, size)
            <span class="hljs-keyword">except</span>:
                <span class="hljs-keyword">continue</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">return</span> pygame.font.SysFont(<span class="hljs-string">"Arial"</span>, size)
    <span class="hljs-keyword">except</span>:
        <span class="hljs-keyword">return</span> pygame.font.Font(<span class="hljs-literal">None</span>, size)

<span class="hljs-comment"># 创建字体对象（弹幕字体稍大，保证清晰）</span>
font = get_font(<span class="hljs-number">20</span>)
title_font = get_font(<span class="hljs-number">36</span>)
danmu_font = get_font(<span class="hljs-number">20</span>)  <span class="hljs-comment"># 弹幕字体大小适中</span>
<span class="hljs-comment"># 新增名字专用字体（更大更醒目）</span>
name_font = get_font(<span class="hljs-number">60</span>)  <span class="hljs-comment"># 字体大小60，突出显示</span>

<span class="hljs-comment"># 多语言“我爱你”文本库（原内容完全保留）</span>
love_texts = [
    <span class="hljs-string">"Mola le offi la tee"</span>, <span class="hljs-string">"mihai amestiah sind"</span>, <span class="hljs-string">"milvini un ne seibesc"</span>, <span class="hljs-string">"Le sakam"</span>, <span class="hljs-string">"Mlohuujam"</span>,
    <span class="hljs-string">"Te sakam"</span>, <span class="hljs-string">"chami dài e n ki n M"</span>, <span class="hljs-string">"Te dua"</span>, <span class="hljs-string">"Té okabescu"</span>, <span class="hljs-string">"Tá grá agam duit"</span>, <span class="hljs-string">"Kocham Ci"</span>,
    <span class="hljs-string">"Saya cintakan kamu"</span>, <span class="hljs-string">"我爱你"</span>, <span class="hljs-string">"Te ambesc"</span>, <span class="hljs-string">"Mahal kita"</span>, <span class="hljs-string">"Jeg elsker deg"</span>, <span class="hljs-string">"Mihaji té"</span>, <span class="hljs-string">"Meng sona"</span>,
    <span class="hljs-string">"Szerethékda"</span>, <span class="hljs-string">"Jag Tjukin"</span>, <span class="hljs-string">"Teja amerhi"</span>, <span class="hljs-string">"L kertesi skarji"</span>, <span class="hljs-string">"joga nem lesen"</span>, <span class="hljs-string">"nyolyomni"</span>,
    <span class="hljs-string">"I love you"</span>, <span class="hljs-string">"Je t'aime"</span>, <span class="hljs-string">"Ich liebe dich"</span>, <span class="hljs-string">"Ti amo"</span>, <span class="hljs-string">"Te amo"</span>, <span class="hljs-string">"あいしてる"</span>,
    <span class="hljs-string">"我爱你"</span>, <span class="hljs-string">"我中意你"</span>, <span class="hljs-string">"我爱侬"</span>, <span class="hljs-string">"我欢喜你"</span>, <span class="hljs-string">"我爱你"</span>, <span class="hljs-string">"我愛你"</span>, <span class="hljs-string">"勾买蒙"</span>, <span class="hljs-string">"额爱你"</span>,<span class="hljs-string">"我待见你"</span>
    <span class="hljs-string">"恩欢喜你"</span>, <span class="hljs-string">"我爱列"</span>, <span class="hljs-string">"Ik hou van je"</span>, <span class="hljs-string">"Saya cintakan mu"</span>, <span class="hljs-string">"Ti amo"</span>, <span class="hljs-string">"Jeg elsker dig"</span>,
    <span class="hljs-string">"Aku cinta padamu"</span>, <span class="hljs-string">"Saya cinta kamu"</span>, <span class="hljs-string">"Ljubim te"</span>, <span class="hljs-string">"俺喜欢"</span>, <span class="hljs-string">"我稀罕你"</span>, <span class="hljs-string">"俺稀罕你"</span>,<span class="hljs-string">"阿秋拉嘎"</span>
]

<span class="hljs-comment"># 爱心坐标生成（原逻辑完全保留，未做任何修改）</span>
love_points = []
<span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000</span>):
    theta = t / <span class="hljs-number">1000</span> * <span class="hljs-number">2</span> * math.pi
    x = <span class="hljs-number">15</span> * (<span class="hljs-built_in">pow</span>(math.sin(theta), <span class="hljs-number">3</span>))
    y = <span class="hljs-number">10</span> * math.cos(theta) - <span class="hljs-number">5</span> * math.cos(<span class="hljs-number">2</span> * theta) - <span class="hljs-number">2</span> * math.cos(<span class="hljs-number">3</span> * theta) - math.cos(<span class="hljs-number">4</span> * theta)
    x = x * <span class="hljs-number">18</span> + width // <span class="hljs-number">2</span>
    y = -y * <span class="hljs-number">18</span> + height // <span class="hljs-number">2</span>
    love_points.append((<span class="hljs-built_in">int</span>(x), <span class="hljs-built_in">int</span>(y)))

<span class="hljs-comment"># 文字对象列表（原逻辑完全保留，未做任何修改）</span>
text_objects = []
colors = [(<span class="hljs-number">255</span>, <span class="hljs-number">182</span>, <span class="hljs-number">193</span>), (<span class="hljs-number">255</span>, <span class="hljs-number">105</span>, <span class="hljs-number">180</span>), (<span class="hljs-number">255</span>, <span class="hljs-number">20</span>, <span class="hljs-number">147</span>),(<span class="hljs-number">218</span>,<span class="hljs-number">112</span>,<span class="hljs-number">214</span>)]
<span class="hljs-keyword">for</span> i, text <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(love_texts):
    color = colors[i % <span class="hljs-built_in">len</span>(colors)]
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(text, <span class="hljs-built_in">str</span>):
            text = <span class="hljs-built_in">str</span>(text)
        text_surface = font.render(text, <span class="hljs-literal">True</span>, color)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"渲染失败 '<span class="hljs-subst">{text}</span>': <span class="hljs-subst">{e}</span>"</span>)
        text_surface = font.render(<span class="hljs-string">"Love"</span>, <span class="hljs-literal">True</span>, color)
    idx = random.randint(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(love_points) - <span class="hljs-number">1</span>)
    x, y = love_points[idx]
    speed_x = random.uniform(-<span class="hljs-number">0.15</span>, <span class="hljs-number">0.15</span>)
    speed_y = random.uniform(-<span class="hljs-number">0.15</span>, <span class="hljs-number">0.15</span>)
    text_objects.append({
        <span class="hljs-string">"surface"</span>: text_surface, <span class="hljs-string">"text"</span>: text, <span class="hljs-string">"x"</span>: x, <span class="hljs-string">"y"</span>: y,
        <span class="hljs-string">"speed_x"</span>: speed_x, <span class="hljs-string">"speed_y"</span>: speed_y, <span class="hljs-string">"target_idx"</span>: idx, <span class="hljs-string">"color"</span>: color
    })

<span class="hljs-comment"># ===================== 弹幕功能（按要求优化）=====================</span>
<span class="hljs-comment"># 弹幕仅保留3条中文文案</span>
danmu_texts = [<span class="hljs-string">"我爱你"</span>, <span class="hljs-string">"在一起"</span>, <span class="hljs-string">"我喜欢你"</span>,<span class="hljs-string">"和我交往吧"</span>,<span class="hljs-string">"阿秋拉嘎"</span>]
<span class="hljs-comment"># 弹幕仅一种粉色（鲜艳且协调）</span>
danmu_color = (<span class="hljs-number">255</span>,<span class="hljs-number">239</span>,<span class="hljs-number">213</span>)  <span class="hljs-comment"># 热粉色</span>

<span class="hljs-comment"># 弹幕对象类（速度加快，淡入淡出节奏紧凑）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Danmu</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.text = random.choice(danmu_texts)
        self.font_size = random.randint(<span class="hljs-number">18</span>, <span class="hljs-number">24</span>)  <span class="hljs-comment"># 字体大小随机</span>
        self.font = get_font(self.font_size)
        self.color = danmu_color
        <span class="hljs-comment"># 随机位置（全屏分布，支持左右/上下双向运动）</span>
        <span class="hljs-keyword">if</span> random.random() &gt; <span class="hljs-number">0.5</span>:
            <span class="hljs-comment"># 从左向右运动</span>
            self.x = random.randint(-<span class="hljs-number">100</span>, -<span class="hljs-number">20</span>)
            self.y = random.randint(<span class="hljs-number">50</span>, height - <span class="hljs-number">50</span>)
            self.speed_x = random.uniform(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>)  <span class="hljs-comment"># 加快水平速度</span>
            self.speed_y = random.uniform(-<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>)  <span class="hljs-comment"># 轻微垂直偏移</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># 从右向左运动</span>
            self.x = random.randint(width + <span class="hljs-number">20</span>, width + <span class="hljs-number">100</span>)
            self.y = random.randint(<span class="hljs-number">50</span>, height - <span class="hljs-number">50</span>)
            self.speed_x = random.uniform(-<span class="hljs-number">5</span>, -<span class="hljs-number">3</span>)  <span class="hljs-comment"># 加快水平速度</span>
            self.speed_y = random.uniform(-<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>)  <span class="hljs-comment"># 轻微垂直偏移</span>
        self.alpha = <span class="hljs-number">0</span>  <span class="hljs-comment"># 初始透明度为0</span>
        self.life = random.randint(<span class="hljs-number">80</span>, <span class="hljs-number">150</span>)  <span class="hljs-comment"># 生命周期缩短（速度快对应短生命周期）</span>
        self.life_count = <span class="hljs-number">0</span>
        self.surface = self._render_text()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_render_text</span>(<span class="hljs-params">self</span>):
        surf = self.font.render(self.text, <span class="hljs-literal">True</span>, self.color)
        surf.set_alpha(self.alpha)
        <span class="hljs-keyword">return</span> surf

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">self</span>):
        self.life_count += <span class="hljs-number">1</span>
        <span class="hljs-comment"># 快速淡入（前20%生命周期完成淡入）</span>
        <span class="hljs-keyword">if</span> self.life_count &lt; self.life * <span class="hljs-number">0.2</span>:
            self.alpha = <span class="hljs-built_in">min</span>(<span class="hljs-number">255</span>, self.alpha + <span class="hljs-number">15</span>)  <span class="hljs-comment"># 加快淡入速度</span>
        <span class="hljs-comment"># 快速淡出（后30%生命周期完成淡出）</span>
        <span class="hljs-keyword">elif</span> self.life_count &gt; self.life * <span class="hljs-number">0.7</span>:
            self.alpha = <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, self.alpha - <span class="hljs-number">10</span>)  <span class="hljs-comment"># 加快淡出速度</span>
        <span class="hljs-comment"># 更新透明度和位置（速度加快）</span>
        self.surface.set_alpha(self.alpha)
        self.x += self.speed_x
        self.y += self.speed_y
        <span class="hljs-comment"># 生命周期结束或超出屏幕则重置</span>
        <span class="hljs-keyword">if</span> self.life_count &gt;= self.life <span class="hljs-keyword">or</span> self.x &lt; -<span class="hljs-number">200</span> <span class="hljs-keyword">or</span> self.x &gt; width + <span class="hljs-number">200</span>:
            self.__init__()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params">self, screen</span>):
        rect = self.surface.get_rect(center=(self.x, self.y))
        screen.blit(self.surface, rect)

<span class="hljs-comment"># 初始化弹幕（初始30条，数量适中不遮挡爱心）</span>
danmu_list = [Danmu() <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">30</span>)]
<span class="hljs-comment"># 弹幕生成计时器（生成频率加快）</span>
danmu_spawn_timer = <span class="hljs-number">0</span>
danmu_spawn_interval = <span class="hljs-number">20</span>  <span class="hljs-comment"># 每20帧（约0.3秒）新增1条弹幕</span>

<span class="hljs-comment"># 原标题与说明文字（保留）</span>
<span class="hljs-keyword">try</span>:
    title_text = title_font.render(<span class="hljs-string">""</span>, <span class="hljs-literal">True</span>, (<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>))
<span class="hljs-keyword">except</span>:
    title_text = title_font.render(<span class="hljs-string">"I Love You + Pink Danmu"</span>, <span class="hljs-literal">True</span>, (<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>))
instruction_font = get_font(<span class="hljs-number">16</span>)
instruction_text = instruction_font.render(<span class="hljs-string">"按ESC键退出"</span>, <span class="hljs-literal">True</span>, (<span class="hljs-number">150</span>, <span class="hljs-number">150</span>, <span class="hljs-number">150</span>))

<span class="hljs-comment"># 生成居中显示的名字（白色，屏幕正中间）</span>
name_text = name_font.render(<span class="hljs-string">"小鱼"</span>, <span class="hljs-literal">True</span>, (<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>))  <span class="hljs-comment"># 白色文字</span>
<span class="hljs-comment"># 计算名字居中坐标（屏幕正中心）</span>
name_x = width // <span class="hljs-number">2</span> - name_text.get_width() // <span class="hljs-number">2</span>
name_y = height // <span class="hljs-number">2</span> - name_text.get_height() // <span class="hljs-number">2</span>

<span class="hljs-comment"># 主循环（仅添加名字绘制，不改动原有内容）</span>
clock = pygame.time.Clock()
running = <span class="hljs-literal">True</span>
<span class="hljs-keyword">while</span> running:
    <span class="hljs-comment"># 事件处理（原逻辑保留）</span>
    <span class="hljs-keyword">for</span> event <span class="hljs-keyword">in</span> pygame.event.get():
        <span class="hljs-keyword">if</span> event.<span class="hljs-built_in">type</span> == pygame.QUIT:
            running = <span class="hljs-literal">False</span>
        <span class="hljs-keyword">elif</span> event.<span class="hljs-built_in">type</span> == pygame.KEYDOWN:
            <span class="hljs-keyword">if</span> event.key == pygame.K_ESCAPE:
                running = <span class="hljs-literal">False</span>

    <span class="hljs-comment"># 黑色背景（原逻辑保留）</span>
    screen.fill((<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>))

    <span class="hljs-comment"># 绘制标题、说明文字（原逻辑保留）</span>
    screen.blit(title_text, (width // <span class="hljs-number">2</span> - title_text.get_width() // <span class="hljs-number">2</span>, <span class="hljs-number">20</span>))
    screen.blit(instruction_text, (width - instruction_text.get_width() - <span class="hljs-number">10</span>, height - <span class="hljs-number">30</span>))

    <span class="hljs-comment"># 绘制爱心轨迹文字（原逻辑完全保留，未做任何修改）</span>
    <span class="hljs-keyword">for</span> obj <span class="hljs-keyword">in</span> text_objects:
        text_rect = obj[<span class="hljs-string">"surface"</span>].get_rect(center=(obj[<span class="hljs-string">"x"</span>], obj[<span class="hljs-string">"y"</span>]))
        screen.blit(obj[<span class="hljs-string">"surface"</span>], text_rect)
        target_x, target_y = love_points[obj[<span class="hljs-string">"target_idx"</span>]]
        obj[<span class="hljs-string">"x"</span>] += (target_x - obj[<span class="hljs-string">"x"</span>]) * <span class="hljs-number">0.02</span> + obj[<span class="hljs-string">"speed_x"</span>]
        obj[<span class="hljs-string">"y"</span>] += (target_y - obj[<span class="hljs-string">"y"</span>]) * <span class="hljs-number">0.02</span> + obj[<span class="hljs-string">"speed_y"</span>]
        obj[<span class="hljs-string">"target_idx"</span>] = (obj[<span class="hljs-string">"target_idx"</span>] + <span class="hljs-number">1</span>) % <span class="hljs-built_in">len</span>(love_points)
        <span class="hljs-keyword">if</span> obj[<span class="hljs-string">"x"</span>] &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> obj[<span class="hljs-string">"x"</span>] &gt; width:
            obj[<span class="hljs-string">"speed_x"</span>] *= -<span class="hljs-number">1</span>
        <span class="hljs-keyword">if</span> obj[<span class="hljs-string">"y"</span>] &lt; <span class="hljs-number">50</span> <span class="hljs-keyword">or</span> obj[<span class="hljs-string">"y"</span>] &gt; height - <span class="hljs-number">50</span>:
            obj[<span class="hljs-string">"speed_y"</span>] *= -<span class="hljs-number">1</span>

    <span class="hljs-comment"># ===================== 绘制居中名字（新增代码）=====================</span>
    screen.blit(name_text, (name_x, name_y))  <span class="hljs-comment"># 在屏幕正中间绘制白色名字</span>

    <span class="hljs-comment"># ===================== 弹幕更新与绘制（按要求优化）=====================</span>
    <span class="hljs-comment"># 加快弹幕生成频率</span>
    danmu_spawn_timer += <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> danmu_spawn_timer &gt;= danmu_spawn_interval:
        danmu_list.append(Danmu())
        danmu_spawn_timer = <span class="hljs-number">0</span>
        <span class="hljs-comment"># 限制弹幕总数（最多50条，避免过度拥挤）</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(danmu_list) &gt; <span class="hljs-number">50</span>:
            danmu_list.pop(<span class="hljs-number">0</span>)

    <span class="hljs-comment"># 更新并绘制所有弹幕（速度加快，粉色系，仅中文文案）</span>
    <span class="hljs-keyword">for</span> danmu <span class="hljs-keyword">in</span> danmu_list:
        danmu.update()
        danmu.draw(screen)

    <span class="hljs-comment"># 显示帧率（原逻辑保留）</span>
    fps_text = font.render(<span class="hljs-string">f"FPS: <span class="hljs-subst">{<span class="hljs-built_in">int</span>(clock.get_fps())}</span>"</span>, <span class="hljs-literal">True</span>, (<span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>))
    screen.blit(fps_text, (<span class="hljs-number">10</span>, height - <span class="hljs-number">30</span>))

    pygame.display.flip()
    clock.tick(<span class="hljs-number">60</span>)

pygame.quit()
sys.exit()
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Suite v6：面向现代化的稳健升级]]></title>    <link>https://juejin.cn/post/7574978545145135139</link>    <guid>https://juejin.cn/post/7574978545145135139</guid>    <pubDate>2025-11-22T02:25:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574978545145135139" data-draft-id="7574978545145085987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Suite v6：面向现代化的稳健升级"/> <meta itemprop="keywords" content="GitHub,前端框架,React.js"/> <meta itemprop="datePublished" content="2025-11-22T02:25:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="漆工"/> <meta itemprop="url" content="https://juejin.cn/user/1345457961570638"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Suite v6：面向现代化的稳健升级
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1345457961570638/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    漆工
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T02:25:17.000Z" title="Sat Nov 22 2025 02:25:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>React Suite (rsuite) v6 正式发布了。这一版本聚焦于现代化改造：重构底层样式系统、提供新的布局能力，并整体提升响应式体验和开发流程。v6 代表 React Suite 在稳定性的前提下，持续向更具适应性的 UI 方案演进。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96a8f14ddedb4943a062fc53974cb997~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryG5bel:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764383117&amp;x-signature=%2FmhdiOE%2Fof0ThPdJUoAFX3pqy34%3D" alt="React Suite v6 Banner" loading="lazy"/></p>
<h2 data-id="heading-0">1. 样式系统的全面重构：拥抱 CSS 变量</h2>
<p>v6 最重大的底层变革是将样式系统从 Less 彻底迁移到了 <strong>SCSS</strong>，并<strong>全面采用 CSS 变量 (CSS Variables)</strong> 作为主题定制的核心方案。开发者只需覆盖变量值，就能在运行时动态切换品牌色、间距或圆角，无需重新编译或配置额外的构建流程。</p>
<p>完整的变量清单与使用方式，可参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fguide%2Fcss-variables%2F" target="_blank" title="https://rsuitejs.com/guide/css-variables/" ref="nofollow noopener noreferrer">CSS Variables 文档</a>，也可以借助 <a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fresources%2Fpalette%2F" target="_blank" title="https://rsuitejs.com/resources/palette/" ref="nofollow noopener noreferrer">Palette 工具</a> 可视化调整品牌配色。</p>
<h3 data-id="heading-1">其他样式系统改进</h3>
<ul>
<li><strong>逻辑属性 (Logical Properties)</strong>：全面采用 CSS 逻辑属性（如 <code>margin-inline-start</code> 代替 <code>margin-left</code>），原生支持 RTL（从右到左）排版。</li>
<li><strong>rem 单位</strong>：字体大小、间距等尺寸从 <code>px</code> 转换为 <code>rem</code>，更好地支持响应式排版和无障碍缩放。</li>
</ul>
<h2 data-id="heading-2">2. 拥抱 AI 辅助编程</h2>
<p>React Suite v6 不仅关注组件本身，更致力于提升 AI 时代的开发效率。我们引入了对 AI 编程助手的原生支持，让 Cursor、Windsurf 等工具能更懂 RSuite。</p>
<h3 data-id="heading-3">LLMs.txt 支持</h3>
<p>我们遵循 <a href="https://link.juejin.cn?target=https%3A%2F%2Fllmstxt.org%2F" target="_blank" title="https://llmstxt.org/" ref="nofollow noopener noreferrer">llms.txt</a> 标准，为文档站添加了 <code>/llms.txt</code> 文件。这是一个专为大语言模型 (LLM) 优化的文档索引。</p>
<p>当你在 Cursor 或其他 AI 工具中引用 RSuite 文档时，AI 可以通过这个文件快速获取组件的 API 定义、最佳实践和代码示例，从而生成更准确、符合 v6 规范的代码。</p>
<h3 data-id="heading-4">MCP Server 集成</h3>
<p>我们推出了官方的 <a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fguide%2Fmcp-server%2F" target="_blank" title="https://rsuitejs.com/guide/mcp-server/" ref="nofollow noopener noreferrer">Model Context Protocol (MCP)</a> Server。</p>
<p>通过 MCP，你的 AI 助手可以直接连接到 RSuite 的知识库。这意味着：</p>
<ul>
<li><strong>实时检索</strong>：AI 可以直接读取最新的组件文档和 API，无需手动复制粘贴。</li>
<li><strong>上下文感知</strong>：在编写代码时，AI 能自动推荐适合当前场景的组件和属性。</li>
<li><strong>减少幻觉</strong>：基于官方文档的上下文投喂，大幅降低 AI 生成过时或错误代码的概率。</li>
</ul>
<h2 data-id="heading-5">3. 布局能力的原子化：引入 Box 与 Center</h2>
<p>为了让布局更加灵活高效，v6 引入了基础的布局原子组件，让开发者能够像搭积木一样构建复杂的 UI。</p>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Fbox%2F" target="_blank" title="https://rsuitejs.com/components/box/" ref="nofollow noopener noreferrer">Box 组件</a></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Fbox%2F" target="_blank" title="https://rsuitejs.com/components/box/" ref="nofollow noopener noreferrer"><code>Box</code></a> 是构建布局的基石，它允许你直接在组件上通过 props 控制样式，无需编写额外的 CSS 类。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Box</span>, <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'rsuite'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Box</span> <span class="hljs-attr">p</span>=<span class="hljs-string">{20}</span> <span class="hljs-attr">m</span>=<span class="hljs-string">{10}</span> <span class="hljs-attr">bg</span>=<span class="hljs-string">"gray-100"</span> <span class="hljs-attr">borderRadius</span>=<span class="hljs-string">{8}</span> <span class="hljs-attr">display</span>=<span class="hljs-string">"flex"</span> <span class="hljs-attr">justifyContent</span>=<span class="hljs-string">"space-between"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Welcome to v6<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">appearance</span>=<span class="hljs-string">"primary"</span>&gt;</span>Get Started<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Box</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Fcenter%2F" target="_blank" title="https://rsuitejs.com/components/center/" ref="nofollow noopener noreferrer">Center 组件</a></h3>
<p>垂直水平居中一直是 CSS 中的高频需求，现在你可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Fcenter%2F" target="_blank" title="https://rsuitejs.com/components/center/" ref="nofollow noopener noreferrer"><code>Center</code></a> 组件轻松实现：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Center</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'rsuite'</span>;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Center</span> <span class="hljs-attr">height</span>=<span class="hljs-string">{200}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-blue-50"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Perfectly Centered Content<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Center</span>&gt;</span></span>;
</code></pre>
<h2 data-id="heading-8">4. 响应式设计的全面增强</h2>
<p>在移动互联网时代，跨端适配至关重要。v6 对核心组件进行了响应式能力的增强。</p>
<ul>
<li>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Fgrid%2F" target="_blank" title="https://rsuitejs.com/components/grid/" ref="nofollow noopener noreferrer">Grid</a> 系统升级</strong>：重构了 <code>Row</code> 和 <code>Col</code>，提供更灵活的断点控制对象语法。</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Row</span> align=<span class="hljs-string">"center"</span> justify=<span class="hljs-string">"space-between"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Col</span> <span class="hljs-attr">span</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">xs:</span> <span class="hljs-attr">24</span>, <span class="hljs-attr">md:</span> <span class="hljs-attr">12</span>, <span class="hljs-attr">lg:</span> <span class="hljs-attr">8</span> }}&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">Col</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Col</span> <span class="hljs-attr">span</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">xs:</span> <span class="hljs-attr">24</span>, <span class="hljs-attr">md:</span> <span class="hljs-attr">12</span>, <span class="hljs-attr">lg:</span> <span class="hljs-attr">8</span> }}&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">Col</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Row</span>&gt;
</code></pre>
</li>
<li>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Fnavbar%2F" target="_blank" title="https://rsuitejs.com/components/navbar/" ref="nofollow noopener noreferrer">Navbar</a> &amp; <a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Fsidenav%2F" target="_blank" title="https://rsuitejs.com/components/sidenav/" ref="nofollow noopener noreferrer">Sidenav</a></strong>：新增了对移动端的自适应支持，使用 <code>Navbar.Content</code> 替代了废弃的 <code>pullRight</code>，布局更清晰。</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Navbar</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Navbar.Brand</span>&gt;</span>BRAND<span class="hljs-tag">&lt;/<span class="hljs-name">Navbar.Brand</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Navbar.Content</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Nav</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">Nav</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Navbar.Content</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Navbar.Content</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Avatar</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Navbar.Content</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Navbar</span>&gt;
</code></pre>
</li>
<li>
<p><strong>Picker 组件</strong>：所有的 Picker 组件现在都拥有了更好的移动端适配体验，在小屏幕设备上会自动切换为更友好的交互模式。</p>
</li>
</ul>
<h2 data-id="heading-9">5. 全新的组件与 Hooks</h2>
<p>除了布局组件，v6 还带来了一系列实用的新组件和 Hooks，进一步丰富了组件库的能力。</p>
<h3 data-id="heading-10">新增组件</h3>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Fsegmented-control%2F" target="_blank" title="https://rsuitejs.com/components/segmented-control/" ref="nofollow noopener noreferrer"><strong>SegmentedControl</strong></a>：分段控制器，提供更现代的选项卡切换体验，适用于筛选、视图切换等场景。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Fpassword-input%2F" target="_blank" title="https://rsuitejs.com/components/password-input/" ref="nofollow noopener noreferrer"><strong>PasswordInput</strong></a>：专用的密码输入框，内置显示/隐藏密码切换功能，提升用户体验。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Fpin-input%2F" target="_blank" title="https://rsuitejs.com/components/pin-input/" ref="nofollow noopener noreferrer"><strong>PinInput</strong></a>：PIN 码/验证码输入组件，支持自动聚焦和粘贴分割，适用于验证场景。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Ftextarea%2F" target="_blank" title="https://rsuitejs.com/components/textarea/" ref="nofollow noopener noreferrer"><strong>Textarea</strong></a>：独立的多行文本输入组件，提供更好的样式控制和一致性。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Fkbd%2F" target="_blank" title="https://rsuitejs.com/components/kbd/" ref="nofollow noopener noreferrer"><strong>Kbd</strong></a>：用于展示键盘按键，文档站和快捷键提示的福音。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Flink%2F" target="_blank" title="https://rsuitejs.com/components/link/" ref="nofollow noopener noreferrer"><strong>Link</strong></a>：提供统一样式的链接组件，支持自定义颜色和无障碍访问。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Fmenu%2F" target="_blank" title="https://rsuitejs.com/components/menu/" ref="nofollow noopener noreferrer"><strong>Menu</strong></a> &amp; <a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Fnavbar%2F%23mega-menu" target="_blank" title="https://rsuitejs.com/components/navbar/#mega-menu" ref="nofollow noopener noreferrer"><strong>MegaMenu</strong></a>：全新的菜单系统，支持更复杂的导航结构，轻松构建大型应用导航。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Fform%2F" target="_blank" title="https://rsuitejs.com/components/form/" ref="nofollow noopener noreferrer"><strong>Form.Stack</strong></a>：让表单布局排列更加整洁有序，替代了 Form 组件上的布局属性。</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Form</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Form.Stack</span> <span class="hljs-attr">layout</span>=<span class="hljs-string">"horizontal"</span> <span class="hljs-attr">spacing</span>=<span class="hljs-string">{20}</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Form.Group</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Form.Label</span>&gt;</span>Username<span class="hljs-tag">&lt;/<span class="hljs-name">Form.Label</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Form.Control</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Form.Group</span>&gt;</span>
    {/* ... */}
  <span class="hljs-tag">&lt;/<span class="hljs-name">Form.Stack</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Form</span>&gt;
</code></pre>
</li>
</ul>
<h3 data-id="heading-11">强大的 Hooks</h3>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Fuse-dialog%2F" target="_blank" title="https://rsuitejs.com/components/use-dialog/" ref="nofollow noopener noreferrer"><strong>useDialog</strong></a>：通过函数调用方式管理对话框，告别繁琐的 visible state 管理。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> dialog = <span class="hljs-title function_">useDialog</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> dialog.<span class="hljs-title function_">confirm</span>({
    <span class="hljs-attr">title</span>: <span class="hljs-string">'确认操作'</span>,
    <span class="hljs-attr">children</span>: <span class="hljs-string">'您确定要执行此操作吗？'</span>
  });
  <span class="hljs-keyword">if</span> (result) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Confirmed'</span>);
  }
};
</code></pre>
</li>
<li>
<p><strong>useFormControl</strong>：轻松创建自定义的表单控件，自动处理验证状态和错误信息。</p>
</li>
</ul>
<h2 data-id="heading-12">6. 开发者体验 (DX) 的极致追求</h2>
<p>我们深知开发者的快乐不仅仅来自于好用的组件，更来自于流畅的开发流程。</p>
<ul>
<li><strong>全面拥抱 Vitest</strong>：我们将测试框架从 Karma/Mocha 迁移到了 Vitest，测试速度大幅提升，开发反馈更加即时。</li>
<li><strong>TypeScript 类型增强</strong>：优化了所有组件的类型导出，新增 Schema 类型命名导出，智能提示更加精准。</li>
<li><strong>Bundle Size 优化</strong>：
<ul>
<li>引入 size-limit，严格把控包体积。</li>
</ul>
</li>
<li><strong>生态支持</strong>：新增 Bun 安装指南，紧跟前端工具链发展潮流。</li>
<li><strong>开发调试</strong>：<code>useToaster</code> 增加了环境检查，当在 <code>CustomProvider</code> 上下文之外使用时会发出友好警告，帮助快速定位问题。</li>
</ul>
<h2 data-id="heading-13">7. 更多细节改进</h2>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Fbadge%2F" target="_blank" title="https://rsuitejs.com/components/badge/" ref="nofollow noopener noreferrer"><strong>Badge</strong></a>：新增 <code>size</code>、<code>outline</code>、<code>placement</code> 等属性，支持更丰富的展示形态。</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Badge</span> content=<span class="hljs-string">"New"</span> size=<span class="hljs-string">"lg"</span> outline /&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Badge</span> <span class="hljs-attr">content</span>=<span class="hljs-string">{99}</span> <span class="hljs-attr">shape</span>=<span class="hljs-string">"square"</span> <span class="hljs-attr">placement</span>=<span class="hljs-string">"bottomEnd"</span> /&gt;</span></span>
</code></pre>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Fbreadcrumb%2F" target="_blank" title="https://rsuitejs.com/components/breadcrumb/" ref="nofollow noopener noreferrer"><strong>Breadcrumb</strong></a>：默认样式调整，更符合现代设计规范。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Fdate-picker%2F" target="_blank" title="https://rsuitejs.com/components/date-picker/" ref="nofollow noopener noreferrer"><strong>DatePicker</strong></a>：优化了 Toolbar 布局，交互更符合直觉。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Fprogress%2F" target="_blank" title="https://rsuitejs.com/components/progress/" ref="nofollow noopener noreferrer"><strong>Progress</strong></a>：新增 <code>indeterminate</code> 加载动画状态，以及支持分段进度条 (<code>sections</code>)，展示更丰富的信息。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Ftree-picker%2F" target="_blank" title="https://rsuitejs.com/components/tree-picker/" ref="nofollow noopener noreferrer"><strong>TreePicker</strong></a>：新增 <code>onlyLeafSelectable</code> 属性，满足仅允许选择叶子节点的业务场景。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Fbutton%2F" target="_blank" title="https://rsuitejs.com/components/button/" ref="nofollow noopener noreferrer"><strong>Button</strong></a>：新增 toggle 状态支持。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fcomponents%2Finput%2F" target="_blank" title="https://rsuitejs.com/components/input/" ref="nofollow noopener noreferrer"><strong>InputGroup</strong></a>：优化了 inside 模式下的按钮样式，视觉更加协调。</p>
</li>
<li>
<p><strong>依赖升级</strong>：Date-fns 4.x, Prettier 3.x 等核心依赖全面升级。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-14">立即开始</h2>
<p>React Suite v6 现已通过 npm 发布。</p>
<pre><code class="hljs language-bash" lang="bash">npm install rsuite@latest
</code></pre>
<p>我们准备了详细的<a href="https://link.juejin.cn?target=https%3A%2F%2Frsuitejs.com%2Fguide%2Fmigration-v6" target="_blank" title="https://rsuitejs.com/guide/migration-v6" ref="nofollow noopener noreferrer">迁移指南</a>，帮助您从 v5 平滑升级。</p>
<p>欢迎在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frsuite%2Frsuite" target="_blank" title="https://github.com/rsuite/rsuite" ref="nofollow noopener noreferrer">GitHub</a> 上给我们 Star，或者在 Discussion 中分享您的使用体验！</p>
<p><strong>React Suite Team</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🌌 AIGC模型的冷启动问题：Web应用的初期技术支撑策略]]></title>    <link>https://juejin.cn/post/7575022279568588841</link>    <guid>https://juejin.cn/post/7575022279568588841</guid>    <pubDate>2025-11-22T02:26:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575022279568588841" data-draft-id="7575050949959581732" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🌌 AIGC模型的冷启动问题：Web应用的初期技术支撑策略"/> <meta itemprop="keywords" content="人工智能,Trae"/> <meta itemprop="datePublished" content="2025-11-22T02:26:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🌌 AIGC模型的冷启动问题：Web应用的初期技术支撑策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T02:26:48.000Z" title="Sat Nov 22 2025 02:26:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🧊 一、引言：当AI还没“醒来”</h2>
<p>在AIGC（AI Generated Content）浪潮中，我们常常遇到这样一个尴尬时刻：</p>
<blockquote>
<p>产品上线第一天，用户点开页面，AI模型沉默如山。<br/>
团队眨眼互望，一句“稍等加载”成为高频台词。</p>
</blockquote>
<p>这就是我们常说的——<strong>AIGC模型的冷启动问题</strong>。<br/>
别被这个词吓到，它不是什么玄学，而是计算机系统在面对<strong>初始资源匮乏、模型未热身、数据不足、请求未定型</strong>时的那种<em>灵魂冰点</em>。<br/>
想象一下，AI 模型还在喝它的第一杯咖啡，而用户已经在敲键盘催命。</p>
<hr/>
<h2 data-id="heading-1">🧬 二、冷启动的本质：一场从零到「上线」的进化</h2>
<p>从底层原理来看，AIGC 模型的冷启动过程包含三个阶段：</p>
<ol>
<li><strong>计算冷</strong>：<br/>
模型参数巨大（动辄十亿个参数），首次加载模型时需要把这些参数从磁盘搬进显存。<br/>
就像一个懒惰的巨人——每一层神经都得先伸个懒腰。</li>
<li><strong>网络冷</strong>：<br/>
如果模型部署在云端，那就有「延迟初恋」这一说。第一次请求往往要花费额外的握手时间、容器唤醒、负载平衡。</li>
<li><strong>语义冷</strong>：<br/>
刚上线的模型还不知道你的业务习惯，比如“APP内提示语风格”。<br/>
它的第一句话，可能像刚出厂的R2-D2一样——充满机械的纯真。</li>
</ol>
<hr/>
<h2 data-id="heading-2">⚙️ 三、从底层出发：技术支撑策略</h2>
<p>冷启动并不是宿命，而是可以用技术“焐热”的。以下是常用的支撑策略，背后各自有着深厚的系统哲学。</p>
<hr/>
<h3 data-id="heading-3">🚀 1. 模型预热（Warm-Up）</h3>
<p>思路很简单：</p>
<blockquote>
<p>不要等到用户来了，才去唤醒模型。</p>
</blockquote>
<p>在Web应用启动后，我们可以模拟一组虚假的 API 调用请求，让模型提前加载。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 🧊 AIGC 冷启动预热脚本</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">warmUpModel</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> fakePrompts = [
    <span class="hljs-string">"你好，请简单介绍一下你自己。"</span>,
    <span class="hljs-string">"生成一句充满科技感的口号。"</span>,
    <span class="hljs-string">"写一句让程序员春风得意的俏皮话。"</span>
  ];

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"🚀 模型预热开始 ..."</span>);

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> prompt <span class="hljs-keyword">of</span> fakePrompts) {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"/api/generate"</span>, {
      <span class="hljs-attr">method</span>: <span class="hljs-string">"POST"</span>,
      <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ prompt }),
      <span class="hljs-attr">headers</span>: { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span> }
    });
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`🔥 已预热：<span class="hljs-subst">${prompt}</span>`</span>);
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ 模型已成功热身！"</span>);
}

<span class="hljs-title function_">warmUpModel</span>();
</code></pre>
<blockquote>
<p>💡 <em>小贴士：这段代码相当于提前帮AI打了三瓶咖啡。</em></p>
</blockquote>
<hr/>
<h3 data-id="heading-4">☁️ 2. 按需加载 + 模型分层缓存</h3>
<p>底层策略在这里显得优雅又“狡猾”：</p>
<ul>
<li>把模型权重分层存储，比如只加载用于启动的核心层。</li>
<li>其余部分按需加载，动态补齐。</li>
<li>对于常见Token结果建立<strong>向量缓存</strong>，让模型“记忆”高频回答。</li>
</ul>
<p>这类似于<strong>懒加载+缓存继承</strong>的策略组合。<br/>
如果程序是舞台，那缓存层就是那个“技术黑幕”，在后台默默挡住冷风。</p>
<hr/>
<h3 data-id="heading-5">🧞 3. 灰度 + 蒙特卡洛采样（经验数据啤酒算法）</h3>
<p>早期阶段，不妨给模型“喂”一些业务数据采样。<br/>
这里通常通过经验分布采样策略实现，使模型在推理阶段有更好的初始收敛。</p>
<p>通俗点说：</p>
<blockquote>
<p>我们让模型在上岗前，提前实习几天。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">🕸️ 4. 边缘节点缓存与轻量推理引擎</h3>
<p>很多人忽略了网络拓扑在冷启动中的作用。<br/>
若用户在日本，而你的模型服务器在硅谷，那延迟就像打越洋电话。</p>
<p>解决方案是 <strong>部署边缘节点推理代理</strong>：</p>
<ul>
<li>前端就近调用轻量引擎（Mini-Inference），处理通用请求。</li>
<li>再由主模型处理复杂请求。</li>
<li>用户感受到的不是“冷启动”，而是“热响应”。</li>
</ul>
<hr/>
<h2 data-id="heading-7">🧠 四、技术之外：冷启动的哲学与幽默</h2>
<p>冷启动，归根结底是人与系统之间的一场信任测试。<br/>
有时候，AI不是不想快，而是太害羞。它还没准备好展示它的全部魅力。</p>
<p>从操作系统到语言运行时，从HTTP握手到显存调度，每一次延迟都像是计算机世界深处那种——</p>
<blockquote>
<p>“我正在努力加载灵魂，请稍等片刻。”</p>
</blockquote>
<p>从这个角度看，每一个冷启动，<br/>
其实就是人工智能世界的<strong>黎明微光</strong>。🌄</p>
<hr/>
<h2 data-id="heading-8">🧩 五、最后的小结与温柔暴论</h2>






























<table><thead><tr><th>阶段</th><th>问题</th><th>对策</th></tr></thead><tbody><tr><td>模型加载</td><td>初始化慢</td><td>预热请求、延迟缓存</td></tr><tr><td>网络延迟</td><td>通信慢</td><td>边缘推理、Cloudflare Worker代理</td></tr><tr><td>业务不适配</td><td>输出生硬</td><td>向量缓存、蒸馏训练</td></tr><tr><td>用户体验差</td><td>页面卡顿</td><td>Skeleton UI、渐进渲染</td></tr></tbody></table>
<blockquote>
<p>🗣️ <strong>暴论总结</strong>：<br/>
真正的冷启动不是模型冷，是我们没教会它怎么热。</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">🎬 尾声：当AI开始呼吸</h2>
<p>当第一位用户顺滑地扫描二维码、浏览页面，AI回应流畅如诗时，<br/>
你听到的不只是HTTP返回200，而是一句轻声的问候：</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀谷歌凌晨炸场！Nano Banana Pro 首发深度评测：20轮地狱级测试，它不仅会画画，还读懂了物理世界]]></title>    <link>https://juejin.cn/post/7575006095389294601</link>    <guid>https://juejin.cn/post/7575006095389294601</guid>    <pubDate>2025-11-22T02:26:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575006095389294601" data-draft-id="7575230119091716139" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀谷歌凌晨炸场！Nano Banana Pro 首发深度评测：20轮地狱级测试，它不仅会画画，还读懂了物理世界"/> <meta itemprop="keywords" content="OpenAI,AIGC,Google IO"/> <meta itemprop="datePublished" content="2025-11-22T02:26:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="win4r"/> <meta itemprop="url" content="https://juejin.cn/user/1739869037541555"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀谷歌凌晨炸场！Nano Banana Pro 首发深度评测：20轮地狱级测试，它不仅会画画，还读懂了物理世界
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1739869037541555/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    win4r
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T02:26:29.000Z" title="Sat Nov 22 2025 02:26:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>摘要：</strong> 经过一上午的极限测试，我们发现这款号称具备“工作室级创意控制”的新模型，正在悄然跨越AI绘图与现实世界的恐怖谷。</p>
<p>🔥🔥🔥本篇笔记所对应的视频：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1HHULBPEVr%2F" target="_blank" title="https://www.bilibili.com/video/BV1HHULBPEVr/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1HH…</a></p>
<hr/>
<p><strong>正文：</strong></p>
<p>今天凌晨，谷歌在毫无预兆的情况下，突然发布了全新的图像生成旗舰模型——<strong>Nano Banana Pro</strong>。</p>
<p>在官方博客的技术白皮书中，谷歌赋予了这款模型极其强悍的纸面参数：它引入了“工作室级创意控制（Studio-grade creative control）”架构，支持混合多达14张参考图像，并能同时保持画面中多达5个人物的高度一致性。此外，它打破了常规生成的限制，原生支持从16:9到21:9、乃至4K分辨率的超清输出，并赋予用户对局部编辑、相机角度、色彩分级（Color Grading）和场景照明的精细控制权。</p>
<p>参数再豪华，终究要落地到实际应用。为了验证 Nano Banana Pro 是否真的如宣传般强大，我们耗时一上午，设计了覆盖图像生成、电商应用、逻辑推理、医学影像、创意设计等领域的<strong>20组地狱级测试案例</strong>。</p>
<p>实测结果表明，这不仅仅是一个画图工具的升级，更像是AI对物理世界理解能力的一次跃迁。以下是我们的详细万字评测报告。</p>
<h3 data-id="heading-0">一、 突破“恐怖谷”：极致的微观细节与文本渲染</h3>
<p>长期以来，AI绘图模型在处理文字（Text Rendering）和微观物理细节时，往往会暴露出“由于计算生成”而产生的违和感。但 Nano Banana Pro 在这方面的表现，让我们重新审视了“逼真”的定义。</p>
<ol>
<li>指纹级的真实感：马斯克推文实拍</li>
</ol>
<p>在第一组测试中，我们要求模型生成一张“马斯克在手机上发推文夸赞特斯拉自动驾驶，并获得OpenAI及Google官方回复”的照片。</p>
<p>结果令人咋舌。模型生成的不仅是一张截图，而是一张**“对着手机屏幕拍摄的照片”。当我们把图片放大到像素级时，震惊地发现了屏幕玻璃上残留的指纹印记**。此外，手机顶部状态栏的电池电量、信号格强弱，以及屏幕光线在不同角度下的漫反射效果，都完全符合物理规律。如果不是因为推文内容是我们编造的，这张图在社交网络上足以以假乱真。</p>
<ol start="2">
<li>中文书法的笔触还原</li>
</ol>
<p>汉字生成一直是西方大模型的弱项。我们测试了生成一幅《念奴娇·赤壁怀古》的行楷书法作品。</p>
<p>生成的画面中，宣纸的纤维质感、墨汁的浓淡晕染（Dry and Wet ink effects）、毛笔搁置在砚台上的光影投射，都达到了摄影级别。尽管在长文本的逻辑上，模型没有完全一字不差地复写上阙内容（这是目前大语言模型的通病），但在“字形结构”上，每一个汉字都笔法严谨，完全没有出现“鬼画符”般的伪造字，对于国风设计素材的生成而言，这已是极高可用的生产力。</p>
<ol start="3">
<li>零错误的巧克力艺术字</li>
</ol>
<p>在生日蛋糕的测试中，模型面临着材质与文字的双重挑战。我们需要它用巧克力酱在奶油蛋糕上写出“AI超元域频道3岁啦”。生成的图像中，巧克力字迹呈现出流体凝固后的自然光泽，且每一个字符都清晰可辨，没有任何错别字。这意味着模型已经理解了“液体书写”的物理特性。</p>
<h3 data-id="heading-1">二、 电商与摄影的革命：一致性与局部重绘</h3>
<p>对于电商行业而言，AI最大的痛点在于“不可控”。而 Nano Banana Pro 此次主打的“局部编辑”与“一致性保持”，似乎正是为了解决这一商业痛点而来。</p>
<ol>
<li>完美的模特“云换装”</li>
</ol>
<p>这是本次评测中商业价值最高的一组测试。我们上传了一张模特图和一套衣服图，要求模型“给图二的模特穿上图一的衣服”。</p>
<p>Nano Banana Pro 的表现堪称完美。它不仅完成了换装，更重要的是，它锁死了模特的面部特征、身材比例和站姿。在随后的多轮对话中，我们像对待真人模特一样不断提出修改要求：</p>
<ul>
<li>
<p>“把低领内搭换成高领”——完成，且颈部光影自然过渡。</p>
</li>
<li>
<p>“把短裙换成长裤”——完成，裤子的褶皱符合重力垂坠感。</p>
</li>
<li>
<p>“给她戴上一顶帽子”——完成，帽子的阴影精准投射在脸部。</p>
</li>
<li>
<p>“加上一条腰带”——完成，腰带束紧了衣物，产生了真实的挤压褶皱。</p>
<p>甚至原图中没有拍到模特的脚，模型也自动根据身体姿态补全了鞋子。对于电商卖家来说，这意味着只需拍摄一次模特，即可无限生成不同款式的上身图，成本将呈指数级下降。</p>
</li>
</ul>
<ol start="2">
<li>智能修图与发型设计</li>
</ol>
<p>除了换装，我们还测试了“去路人”和“换发型”。</p>
<p>在旅游照中，一句“去掉路人”的提示词，模型瞬间清除了背景杂乱的游客，并自动脑补了被遮挡的风景，毫无修图痕迹。</p>
<p>在人物写真中，我们将一位男性的发型替换为“更时尚的款式”，整个人气质瞬间提升，且发丝与头皮的连接处处理得极其自然。这预示着它完全可以替代Photoshop的大部分繁琐功能。</p>
<h3 data-id="heading-2">三、 视觉推理：AI 开始“看懂”这个世界</h3>
<p>Nano Banana Pro 不仅仅在“画”，它似乎在“思考”。多组测试证明，它具备了极强的多模态视觉推理能力。</p>
<ol>
<li>逆向工程：一张图反推食谱</li>
</ol>
<p>我们投喂了一张“土豆烧牛肉”的成品菜照片，要求模型“生成这道菜的所有食材”。</p>
<p>模型生成的图像不仅是一堆食材的堆砌，更像是一张精美的备菜图：牛肉切块的纹理、土豆的氧化色泽、葱花、姜片、甚至生抽、老抽、冰糖、八角等看不见的调味品，都被它逻辑严密地具象化了出来。这说明模型识别出了菜品，检索了知识库，并将其反向视觉化。</p>
<ol start="2">
<li>医学影像的精准判读</li>
</ol>
<p>为了测试专业性，我们上传了一张包含微小骨折点的X光片，提示词仅为“标注骨折位置”。</p>
<p>模型精准地识别出了病灶，并用红框进行了高亮标注。值得注意的是，生成后的图像依然保持了X光胶片特有的灰度噪点和透视质感，没有因为AI的介入而变成“卡通画”。这展示了其在辅助医疗诊断领域的潜力。</p>
<ol start="3">
<li>逻辑思维的可视化：数学与试卷</li>
</ol>
<p>这可能是最让我们感到“细思极恐”的测试。</p>
<ul>
<li><strong>数学解题：</strong> 我们要求模型解答一道圆面积计算题，并展现“草稿纸上的手写过程”。模型不仅步骤正确、答案无误，更可怕的是它模拟了真实的“运算场景”——字迹是手写的圆珠笔质感，纸张上有上一页笔记透过来的印痕，甚至还有手腕摩擦留下的污渍。</li>
<li><strong>试卷填空：</strong> 给定一张空白英语试卷，模型自动识别题目，在括号内填入了正确的选项字母，并在下方用中文手写体翻译了句子。这不仅是OCR（文字识别），而是“识别+理解+生成”的全流程闭环。</li>
<li><strong>手绘RAG流程图：</strong> 它还能根据抽象的技术概念（检索增强生成），绘制出逻辑清晰、带有中文注释的手绘风格流程图。</li>
</ul>
<h3 data-id="heading-3">四、 创意的边界：从复刻到脑洞</h3>
<p>最后，我们测试了模型的艺术创造力与跨风格融合能力。</p>
<ol>
<li>时空错乱的艺术融合</li>
</ol>
<p>当我们将现代工业产物强行植入古代艺术时，Nano Banana Pro 展现了极高的审美融合度。</p>
<ul>
<li><strong>清明上河图+游艇：</strong> 我们要求在仿古画的河面上放一艘现代钓鱼艇。模型不仅放入了游艇，还精细地绘制了游艇马达激起的白色浪花，这种浪花的画法模仿了古画的笔触，使得违和感降到了最低。</li>
<li><strong>古画改图：</strong> 将古画中垂钓的人改为“中鱼拉杆”的状态。模型重绘了弯曲的鱼竿和水下的鱼，动态张力十足。</li>
</ul>
<p><strong>2. 风格迁移与设计赋能</strong></p>
<ul>
<li><strong>室内设计：</strong> 一张简陋的毛坯房照片，在提示词“现代简约风”的驱动下，瞬间变成了精装修效果图。光影方向与原图窗户完全一致，地砖的镜面反射更是点睛之笔。</li>
<li><strong>素描转油画：</strong> 将人物素描一键转为油画，衣服上的格子纹理细节毫发无损。</li>
<li><strong>手办生成：</strong> 将真人模特图转化为带包装盒、亚克力底座的精美手办图，材质反光逼真。</li>
<li><strong>杂志封面：</strong> 根据我们的频道介绍，自动生成了一张极具设计感的时尚杂志封面，桌上的咖啡杯倒影清晰可见。</li>
<li><strong>脑洞流程图：</strong> 在“如何烤面包”的趣味测试中，模型画出了喷火龙烤面包、投石机送面包的夸张场景，证明了它在幽默感和想象力上的可塑性。</li>
</ul>
<h3 data-id="heading-4">五、 总结与展望</h3>
<p>洋洋洒洒20组测试，涵盖了从微观细节到宏观场景，From “What is” to “What if” 的各个维度。</p>
<p><strong>Nano Banana Pro 给我们最大的感受是：它变“聪明”了。</strong></p>
<p>以前的AI绘图模型，像是一个画技高超但不懂物理规律的“画师”，经常画出反重力的衣服或错误的光影。而 Nano Banana Pro 给人的感觉，是它在生成图像之前，先在潜空间里构建了一个符合逻辑的“虚拟世界”。它知道手写字会有压痕，知道屏幕会有指纹，知道衣服会有重力褶皱，知道X光片背后的病理结构。</p>
<p>对于用户而言，这意味着：</p>
<ol>
<li><strong>设计门槛的进一步降低：</strong> 你不需要再用复杂的ControlNet去控制光影，简单的自然语言即可实现精准修改。</li>
<li><strong>商业应用的爆发：</strong> 电商换装、室内设计、辅助教育、医疗标注，这些领域的生产力将迎来质的飞跃。</li>
<li><strong>创意的无限延伸：</strong> 无论是搞怪的烤面包流程图，还是严肃的数学推导，它都能成为你大脑的外挂。</li>
</ol>
<p>谷歌 Nano Banana Pro 的发布，标志着图像生成模型正式进入了**“通感”**时代。它不再仅仅是像素的堆砌，而是逻辑与物理的投射。</p>
<p>关于这款模型的更多玩法和提示词技巧，我们将在后续的推文中继续更新。<strong>AI进化的速度比我们想象的更快，你准备好了吗？</strong></p>
<hr/>
<p><em>本文测试内容均基于真实视频演示素材，技术参数参考官方发布信息。保持客观，拒绝捧杀。</em></p>
<p><strong>记得点赞、在看、转发，关注我们，不错过每一次AI技术的变革！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[群晖 DSM 更新后 Cloudflare DDNS 失效的排查记录]]></title>    <link>https://juejin.cn/post/7574978847152357416</link>    <guid>https://juejin.cn/post/7574978847152357416</guid>    <pubDate>2025-11-22T02:29:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574978847152357416" data-draft-id="7575015480198807604" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="群晖 DSM 更新后 Cloudflare DDNS 失效的排查记录"/> <meta itemprop="keywords" content="前端,后端,DNS"/> <meta itemprop="datePublished" content="2025-11-22T02:29:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="子洋"/> <meta itemprop="url" content="https://juejin.cn/user/1099167359835015"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            群晖 DSM 更新后 Cloudflare DDNS 失效的排查记录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1099167359835015/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    子洋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T02:29:38.000Z" title="Sat Nov 22 2025 02:29:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{font-family:-apple-system,BlinkMacSystemFont,PingFang SC,Helvetica Neue,Helvetica,Arial,sans-serif;word-break:break-word;line-height:1.75;font-weight:200;font-size:16px;overflow-x:hidden;color:#666;letter-spacing:.5px}.markdown-body a{text-decoration:none;color:#0064c8;position:relative}.markdown-body a:after{content:"";position:absolute;bottom:-2px;left:0;width:100%;height:1px;background-color:rgba(0,100,200,.7);transform:scale(0);transition:all .4s ease-in-out}.markdown-body a:link:hover:after{transform:scale(1)}.markdown-body code{padding:2px 4px;font-size:.9em;font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px;background-color:rgba(0,46,70,.0431);color:#39f}.markdown-body strong{font-weight:400}.markdown-body em{color:#ff6a00}.markdown-body del,.markdown-body s{color:#bbb}.markdown-body small{font-size:.8em;color:#bbb}.markdown-body kbd{margin:0 .1em;padding:5px 8px 3px;border:1px solid #d1d5d9;border-radius:3px;box-shadow:0 1px 0 0 #e3e4e6,inset 0 0 0 2px #fff;background-color:#eee;font-weight:600;font-size:.8em;font-family:Arial,Helvetica Neue,Helvetica,sans-serif;white-space:nowrap;color:#666}.markdown-body kbd:first-child{margin-left:0}.markdown-body kbd:last-child{margin-right:0}.markdown-body img{display:block;border:0;max-width:calc(100% - 20px);min-width:20px;min-height:20px;margin:0 10px;box-shadow:0 2px 8px 2px rgba(0,0,0,.2);transition:all .25s ease-in-out}.markdown-body img:hover{transform:translateY(-4px)}.markdown-body blockquote,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{line-height:inherit;font-size:inherit;color:inherit}.markdown-body blockquote:first-child,.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child,.markdown-body ol:first-child,.markdown-body p:first-child,.markdown-body pre:first-child,.markdown-body table:first-child,.markdown-body ul:first-child{margin-top:0}.markdown-body blockquote:last-child,.markdown-body h1:last-child,.markdown-body h2:last-child,.markdown-body h3:last-child,.markdown-body h4:last-child,.markdown-body h5:last-child,.markdown-body h6:last-child,.markdown-body ol:last-child,.markdown-body p:last-child,.markdown-body pre:last-child,.markdown-body table:last-child,.markdown-body ul:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:1.6em 0 .6em;color:#333;font-weight:400;position:relative}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:-2em}.markdown-body h1{font-size:1.75em}.markdown-body h1:before{content:"#"}.markdown-body h1:first-child{margin-top:0}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.35em}.markdown-body h4{font-size:1.2em}.markdown-body h5{font-size:1.1em}.markdown-body h6{font-size:1em}.markdown-body blockquote,.markdown-body ol,.markdown-body pre,.markdown-body table,.markdown-body ul{margin:1em 0}.markdown-body p{margin:.7em 0;word-break:break-word}.markdown-body pre{padding:8px 12px;color:#666;background-color:rgba(0,46,70,.0431);border:1px solid #ebebeb;tab-size:4;white-space:pre-wrap;line-height:1.4}.markdown-body pre code{color:inherit;background-color:transparent;padding:0}.markdown-body ol,.markdown-body ul{margin:1em 0 1em 2em;padding:0;line-height:1.5!important;font-size:inherit;color:inherit}.markdown-body ol:first-child,.markdown-body ul:first-child{margin-top:0}.markdown-body ol:last-child,.markdown-body ul:last-child{margin-bottom:0}.markdown-body ol li,.markdown-body ul li{margin:.5em 0;list-style:inherit}.markdown-body ul{list-style:disc outside}.markdown-body ul ul{list-style-type:circle}.markdown-body ul ul ul{list-style-type:square}.markdown-body ol{list-style:decimal outside}.markdown-body ol ol{list-style-type:lower-alpha}.markdown-body ol ol ol{list-style-type:lower-roman}.markdown-body blockquote{font-size:.9em;padding:8px 20px 8px 15px;color:#666;border-left:5px solid rgba(0,100,200,.7);background-color:rgba(0,100,200,.1)}.markdown-body table{border-collapse:collapse;border-spacing:0;max-width:100%;min-width:50%;word-wrap:break-word;color:inherit}.markdown-body table thead tr{background-color:#f4f6f7}.markdown-body table td,.markdown-body table th{padding:4px 16px;font-size:.95em;text-align:left;color:inherit;border:0;min-width:72px}.markdown-body table td[align=center],.markdown-body table th[align=center]{text-align:center}.markdown-body table td[align=right],.markdown-body table th[align=right]{text-align:right}.markdown-body table th{border-bottom:2px solid #e3e4e6;color:#333;font-weight:400;white-space:nowrap}.markdown-body table td{border-bottom:1px solid #ebebeb}.markdown-body hr{margin:1.5em 0;padding:0;border:0;background:linear-gradient(90deg,rgba(0,46,70,.0431),#ebebeb 50%,rgba(0,46,70,.0431));height:1px}.markdown-body br{content:"";display:block}</style><style data-highlight="" data-highlight-key="tomorrow-night">.hljs-comment,.hljs-quote{color:#969896}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c66}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#de935f}.hljs-attribute{color:#f0c674}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#b5bd68}.hljs-section,.hljs-title{color:#81a2be}.hljs-keyword,.hljs-selector-tag{color:#b294bb}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1d1f21;color:#c5c8c6}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>前两天我的群晖 NAS 提示 DSM 有新版本更新。由于已经好久没更新，一瞄发行说明发现新 feature 和 bugfix 还挺多，想着时间也不短了，那就顺手更一下吧。</p>
<p>系统更新得倒是很顺利，更新后啥异常也没发现，内网/外网访问都正常，我也就没再管。</p>
<p>直到昨晚事情才开始不对：我突然发现通过 DDNS 完全无法访问 NAS 上的任何应用。不过当时家里网络卡得要命，我也没太当回事，只以为是网络抽风。</p>
<p>但今天一早起来网络速度恢复，可域名依然不通，这时候我才知道绝对不是网络速度的问题了，这才开始正式排查。</p>
<h2 data-id="heading-1">排查链路复盘</h2>
<p>下面是我这次遇到问题后的完整排查过程。一方面是给可能遇到同样坑的朋友提供一个参考思路，另一方面也是给自己做个记录，方便以后再遇到类似情况时能更快定位问题。</p>
<h3 data-id="heading-2">1. 先确认 NAS 服务本身是否正常</h3>
<p>第一步很简单：  <strong>通过内网 IP 访问 NAS</strong>，一切正常，系统服务都在。</p>
<h3 data-id="heading-3">2. 再确认公网访问是否正常</h3>
<p>用家里的 <strong>公网 IP 直连</strong> NAS 暴露出去的端口，能通。说明 ISP 没问题，端口也没被封。</p>
<h3 data-id="heading-4">3. 检查群晖 DSM 自带的 DDNS 状态</h3>
<p>打开 <strong>控制面板 → 外部访问 → DDNS</strong>。</p>
<p>果然看到 DDNS 状态一直卡在 <strong>“正在连接...”</strong>，  点“测试连接”，转半天圈，最后报 <strong>连接超时</strong>。</p>
<p>至此基本确认问题出在 DDNS。</p>
<h3 data-id="heading-5">4. 怀疑是否是 NAS 上的代理导致的问题</h3>
<p>我之前遇到过：  <strong>只要开了系统代理 → 重启 NAS → 自定义 DDNS 会无法连接</strong>，</p>
<p><strong>必须是：</strong></p>
<ol>
<li>先连上 DDNS</li>
<li>再手动开启系统代理</li>
</ol>
<p>这很奇怪，但确实存在这个问题，我也一直没有去解决，所以这次我也先排查了一遍代理设置，结果发现代理是关闭的，这条可能性排除了。</p>
<h3 data-id="heading-6">5. 怀疑 Cloudflare 又宕机？</h3>
<p>突然想起前两天 Cloudflare 宕机，难不成又宕机了？</p>
<p>我登录 CF 控制台看了眼，没有任何告警。为了确认，我还顺手访问了几个托管在 Vercel、经过 Cloudflare 的服务，一切正常，说明 Cloudflare 没锅。</p>
<h3 data-id="heading-7">6. 终于把怀疑对象指向 DSM 更新</h3>
<p>这时我不禁想起了福尔摩斯法则：</p>
<blockquote>
<p>“当你排除了所有不可能的，剩下的即使再离谱，也必然是真相。”</p>
</blockquote>
<p>我先是在 Nas 上添加 DDNS 的地方看了一下服务提供商，果然，没有之前自定义的 Cloudflare 了。</p>
<p>我回忆了一下，群晖默认不支持 Cloudflare DDNS，需要自己手动部署第三方脚本，比如很多玩家都用的 <strong>SynologyCloudflareDDNS</strong>。</p>
<p>但我这是两三年前配置的了，早忘得干干净净，只记得当时是用 SSH 登进去扔了些脚本、改了 ddns_provider 配置，我只好去网上重新查教程。</p>
<h3 data-id="heading-8">7. 转折：ddns_provider 配置“消失了”</h3>
<p>网上的做法都差不多，我也照着检查了一下 NAS 的 <code>/etc/ddns_provider.conf</code>。</p>
<p>结果一打开就发现：<strong>我之前手动添加的 Cloudflare provider 配置彻底没了。</strong></p>
<p>八成是这次 DSM 更新覆盖了系统文件，把自定义的 DDNS provider 给清干净了。</p>
<p>于是我把缺失的配置重新补上、保存，然后再回到 DSM 的 DDNS 界面一看，果然有变化：
列表里多出了一个“<strong>访问 DDNS 供应商的网站</strong>”的按钮。</p>
<p>这说明新增的 provider 已成功加载（因为在 <code>ddns_provider.conf</code> 里设置 <code>website</code> 字段后，DSM 会自动在面板中显示这个入口）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81af4510c66847a7b2b9cb600b8764ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5rSL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764383378&amp;x-signature=nAYT55Vc8ZY6BXRgc6kdjhkA8Gs%3D" alt="Pasted image 20251122094435.png" loading="lazy"/></p>
<p>再测试连接，结果：还是失败。</p>
<h3 data-id="heading-9">8. 再一查：原先放在 /sbin 的脚本也没了</h3>
<p>我继续顺着配置里引用的脚本路径查下去（就是 SynologyCloudflareDDNS 的核心脚本）。</p>
<p>结果：指定路径下根本没有脚本！ 我甚至怀疑是不是我之前放在其他地方了，于是全盘搜索了一遍。</p>
<p>找不到，根本找不到，基本可以确认<strong>整个 /sbin 目录都被更新重置了。</strong></p>
<p>至此终于搞清楚问题根因：</p>
<blockquote>
<p>DSM 更新时覆盖了系统目录，导致自定义 DDNS Provider 配置 + 脚本全部消失。</p>
</blockquote>
<h3 data-id="heading-10">9. 修复：重新上传脚本 + 重新配置 provider</h3>
<p>我重新下载脚本，上传到 <code>/sbin</code>，给可执行权限，再更新 ddns_provider 配置。</p>
<p>测试连接，这次成功了，DDNS 恢复正常！</p>
<h3 data-id="heading-11">10. 为什么前两天还能用？</h3>
<p>现在回头一想，为什么更新当天没问题？</p>
<p>很简单：<strong>因为我的公网 IP 那几天没变。</strong> DDNS 虽然挂了，但只要 Cloudflare 上的 DNS A 记录还指向老 IP，访问就不会出问题。</p>
<p>直到昨天公网 IP 有一点点变动（可能只差一两位），我登陆 CF 又没仔细看 A 记录，这才导致域名完全失效。</p>
<h2 data-id="heading-12">总结</h2>
<p>这次问题的根因其实非常隐蔽：</p>
<ul>
<li>DSM 更新 → 覆盖系统目录</li>
<li>自定义 DDNS Provider 配置被删</li>
<li><code>/sbin</code> 下的 Cloudflare 更新脚本也清空</li>
<li>但因为公网 IP 没变，所以问题延后了两天才暴露</li>
<li>最后一度误以为是 Cloudflare、代理或网络的问题</li>
</ul>
<p><strong>最终的解决办法就是：重新放回脚本 + 重写 ddns_provider.conf。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🌳 Claude `code/worktree` 命令最佳实践指南]]></title>    <link>https://juejin.cn/post/7575050949959614500</link>    <guid>https://juejin.cn/post/7575050949959614500</guid>    <pubDate>2025-11-22T02:30:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575050949959614500" data-draft-id="7575067409416077355" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🌳 Claude `code/worktree` 命令最佳实践指南"/> <meta itemprop="keywords" content="人工智能,Claude,Trae"/> <meta itemprop="datePublished" content="2025-11-22T02:30:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🌳 Claude `code/worktree` 命令最佳实践指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T02:30:09.000Z" title="Sat Nov 22 2025 02:30:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🧭 一、前言：当AI开始「搬砖」</h2>
<p>在与 <strong>Claude</strong>（Anthropic 开发的AI助手）协作开发代码时，<code>code/worktree</code> 命令是一个极其有趣的工具。<br/>
这一命令的意图，是让 AI 和开发者在一个<strong>隔离但同步的工作区</strong>中协同修改、组织项目，就像是给 Claude 自己准备了一个“虚拟分支工位”。</p>
<p>简言之：</p>
<blockquote>
<p><code>code/worktree</code> ≈ “让 Claude 不破坏主代码库就能实验新功能的魔法空间”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">🧩 二、命令的逻辑本质与底层哲学</h2>
<p>从底层原理讲，它与 Git 的 <strong>worktree</strong> 思想一致：<br/>
创建一个共享 <code>.git</code> 元数据但独立工作目录的副本。<br/>
这种设计既保留了版本控制的完整性，又让多场景开发成为可能。</p>
<p>在 Claude 体系中，<code>code/worktree</code> 的哲学是这样的：</p>
<ol>
<li><strong>Claude 不直接改主干（main branch）</strong> 。</li>
<li><strong>每次生成代码，都在临时工作区中修改。</strong></li>
<li><strong>开发者可以选择合入、重构或丢弃。</strong></li>
</ol>
<p>换句话说：Claude 是文明的，不会直接在你的主分支上乱动。</p>
<hr/>
<h2 data-id="heading-2">⚙️ 三、基础语法与结构</h2>
<p>假设你已经将项目以 Claude 的 workspace 方式加载。<br/>
此时使用命令：</p>
<pre><code class="hljs language-bash" lang="bash">/worktree create feature/refactor-api
</code></pre>
<p>Claude 将：</p>
<ol>
<li>创建一个 <code>feature/refactor-api</code> 的工作区。</li>
<li>将当前 HEAD 的代码复制到新目录（但共享 <code>.git</code> 数据）。</li>
<li>在该工作区下生成、修改、运行代码。</li>
</ol>
<p>完成后，你可以通过：</p>
<pre><code class="hljs language-bash" lang="bash">/worktree merge feature/refactor-api
</code></pre>
<p>将改动安全地合并回主工作区。</p>
<hr/>
<h2 data-id="heading-3">🧰 四、实践案例：让 Claude 改造你的 Web 应用</h2>
<h3 data-id="heading-4">🧪 场景示例</h3>
<p>你有一个 Node.js + React 的项目：</p>
<pre><code class="hljs language-css" lang="css">my-app/
  ├── <span class="hljs-attribute">src</span>/
  ├── package<span class="hljs-selector-class">.json</span>
  └── server<span class="hljs-selector-class">.js</span>
</code></pre>
<p>你希望 Claude 帮你：</p>
<blockquote>
<p>将 Express server 改为支持 WebSocket 通信。</p>
</blockquote>
<h3 data-id="heading-5">🦾 操作流程</h3>
<ol>
<li>
<p><strong>创建 Claude 工作区</strong></p>
<pre><code class="hljs language-bash" lang="bash">/worktree create feature/add-websocket
</code></pre>
</li>
<li>
<p><strong>Claude 进入专属工位</strong></p>
<p>Claude 会自动克隆代码结构到一个新工作区。<br/>
它的修改操作不会影响主分支。</p>
</li>
<li>
<p><strong>让 Claude 修改代码</strong></p>
<pre><code class="hljs language-bash" lang="bash">/edit In feature/add-websocket:
Add WebSocket support to server.js
</code></pre>
</li>
<li>
<p><strong>Claude 编辑并展示差异</strong></p>
<p>Claude 会用 diff 形式展示修改区域，开发者确认后才会落地。</p>
</li>
<li>
<p><strong>测试和评审</strong></p>
<p>你可以让 Claude 执行单元测试命令：</p>
<pre><code class="hljs language-bash" lang="bash">/run npm <span class="hljs-built_in">test</span>
</code></pre>
<p>或让它自动运行 ESLint 检查。</p>
</li>
<li>
<p><strong>合并成果</strong></p>
<p>一旦满意，可以：</p>
<pre><code class="hljs language-bash" lang="bash">/worktree merge feature/add-websocket
</code></pre>
<p>完成集成后可使用：</p>
<pre><code class="hljs language-bash" lang="bash">/worktree delete feature/add-websocket
</code></pre>
<p>清理隔离区，保持工作区整洁。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-6">🧠 五、底层实现建议（结合Git机制）</h2>
<blockquote>
<p>Claude <code>code/worktree</code> 的实现可被理解为：通过<strong>AI控制的Git临时分支</strong>执行抽象的工作流。</p>
</blockquote>
<p>在底层实现上，可复用以下类 Git 逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟 Claude 的 code/worktree 流程</span>
<span class="hljs-keyword">const</span> { execSync } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createWorktree</span>(<span class="hljs-params">branch</span>) {
  <span class="hljs-title function_">execSync</span>(<span class="hljs-string">`git worktree add ../<span class="hljs-subst">${branch}</span> <span class="hljs-subst">${branch}</span>`</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`🌿 Created worktree: <span class="hljs-subst">${branch}</span>`</span>);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mergeWorktree</span>(<span class="hljs-params">branch</span>) {
  <span class="hljs-title function_">execSync</span>(<span class="hljs-string">`git checkout main`</span>);
  <span class="hljs-title function_">execSync</span>(<span class="hljs-string">`git merge <span class="hljs-subst">${branch}</span>`</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`✅ Merged <span class="hljs-subst">${branch}</span> into main`</span>);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">deleteWorktree</span>(<span class="hljs-params">branch</span>) {
  <span class="hljs-title function_">execSync</span>(<span class="hljs-string">`git worktree remove ../<span class="hljs-subst">${branch}</span> --force`</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`🧹 Deleted worktree: <span class="hljs-subst">${branch}</span>`</span>);
}
</code></pre>
<p>Claude 在其内部系统中执行了类似逻辑，但将其关联到 AI 文件缓存和编辑上下文管理中，使其能够：</p>
<ul>
<li>高速加载关联文件；</li>
<li>在隔离环境中编译；</li>
<li>支持多版本回溯。</li>
</ul>
<hr/>
<h2 data-id="heading-7">⚖️ 六、最佳实践建议（重磅精华）</h2>



































<table><thead><tr><th>目标</th><th>建议实践</th><th>Claude命令示例</th></tr></thead><tbody><tr><td>快速试验</td><td>为重大重构代码预留独立worktree</td><td><code>/worktree create feature/new-ui</code></td></tr><tr><td>审查代码</td><td>使用 Claude 生成diff并由人工确认</td><td><code>/diff feature/new-ui</code></td></tr><tr><td>自动化测试</td><td>将测试脚本注册为 Hook</td><td><code>/test run feature/new-ui</code></td></tr><tr><td>并行开发</td><td>为每个模块分配 Claude 实例与独立 worktree</td><td><code>/worktree create feature/auth-refactor</code></td></tr><tr><td>安全管理</td><td>定期让 Claude 清理过期工作区</td><td><code>/worktree prune</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-8">🧩 七、冷知识与幽默插曲</h2>
<ul>
<li>
<p>有人问：为什么 Claude 不直接改主分支？<br/>
🧑‍💻 回答：<strong>因为他懂版本管理的礼仪。</strong></p>
</li>
<li>
<p>一个典型的错误用法是：</p>
<pre><code class="hljs language-bash" lang="bash">/worktree create main-feature
</code></pre>
<p>Claude 会温柔地提醒：<br/>
<em>“您刚试图改写历史，请冷静。”</em></p>
</li>
<li>
<p>在大型项目中，Claude 的 <code>code/worktree</code> 策略就像多线程调度：</p>
<blockquote>
<p>每个工作区就是一个线程，每个线程都在为未来的主干静静努力。</p>
</blockquote>
</li>
</ul>
<hr/>
<h2 data-id="heading-9">🛠 八、结语：让Claude成为你的「安全编辑器」</h2>
<p>合理使用 <code>code/worktree</code>，本质上是让 Claude 从一个“AI助手”升级为<strong>协同式副开发者（Co-Developer）</strong> 。<br/>
它不只是写代码，而是遵守开发流程，与人类团队共生。</p>
<p>当 Claude 生成代码的同时，还能保证主分支的整洁与安全时，<br/>
你会发现开发变得轻盈、策略变得优雅。</p>
<hr/>
<blockquote>
<p>✨ <strong>最终箴言：</strong></p>
<p>“聪明的开发者自己写代码，更聪明的开发者教 Claude 在另一个 world 里写。”</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[上架元服务-味寻纪 技术分享]]></title>    <link>https://juejin.cn/post/7575006095389376521</link>    <guid>https://juejin.cn/post/7575006095389376521</guid>    <pubDate>2025-11-22T03:02:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575006095389376521" data-draft-id="7575017581037158438" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="上架元服务-味寻纪 技术分享"/> <meta itemprop="keywords" content="前端,HarmonyOS"/> <meta itemprop="datePublished" content="2025-11-22T03:02:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="万少"/> <meta itemprop="url" content="https://juejin.cn/user/4441682708283191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            上架元服务-味寻纪 技术分享
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682708283191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    万少
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T03:02:04.000Z" title="Sat Nov 22 2025 03:02:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"/>
<h3 data-id="heading-1">项目概述</h3>
<p><strong>味寻纪-元服务</strong>是一款基于鸿蒙HarmonyOS Next的美食应用，集成了鸿蒙官方推荐的zrouter路由管理方案，并实现了完整的用户认证体系包括静默登录功能。项目采用现代的组件化架构，提供流畅的用户体验。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dda080f49b8447f94975b77407ffeb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764385323&amp;x-signature=DYsv%2Bw%2BerF7%2BliJ0irrC2kOpTgQ%3D" alt="image-20251121103048327" loading="lazy"/></p>
<h3 data-id="heading-2">zrouter核心特性与功能</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e759f12275474461a1bfe94ecb5e1f6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764385323&amp;x-signature=BFo5ckRm3dU1ttR6IYEWnccSm8c%3D" alt="image-20251121103359970" loading="lazy"/></p>
<h4 data-id="heading-3">1. 统一路由管理</h4>
<p>zrouter作为鸿蒙官方推荐的路由管理方案，为应用提供了强大的页面导航能力。在味寻纪项目中，zrouter承担了以下核心功能：</p>
<h5 data-id="heading-4">1.1 自动路由生成</h5>
<p>通过<code>router-register-plugin</code>插件自动扫描生成路由构建器，项目中已自动生成了11个页面的路由文件：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// _generated目录下的自动生成的路由文件</span>
<span class="hljs-selector-tag">entry</span>\<span class="hljs-selector-tag">src</span>\<span class="hljs-selector-tag">main</span>\<span class="hljs-selector-tag">ets_generated</span>\
├── <span class="hljs-selector-tag">ZRBrowseHistoryPage</span><span class="hljs-selector-class">.ets</span>      <span class="hljs-comment">// 浏览历史页面</span>
├── <span class="hljs-selector-tag">ZRCookingTechniqueDetailPage</span><span class="hljs-selector-class">.ets</span>  <span class="hljs-comment">// 烹饪技法详情</span>
├── <span class="hljs-selector-tag">ZRCookingToolDetailPage</span><span class="hljs-selector-class">.ets</span>       <span class="hljs-comment">// 烹饪工具详情</span>
├── <span class="hljs-selector-tag">ZREditProfilePage</span><span class="hljs-selector-class">.ets</span>             <span class="hljs-comment">// 编辑资料页面</span>
├── <span class="hljs-selector-tag">ZRFamilyMemberEditPage</span><span class="hljs-selector-class">.ets</span>        <span class="hljs-comment">// 家庭成员编辑</span>
├── <span class="hljs-selector-tag">ZRFamilyMemberListPage</span><span class="hljs-selector-class">.ets</span>        <span class="hljs-comment">// 家庭成员列表</span>
├── <span class="hljs-selector-tag">ZRFamilyMemberRecipesPage</span><span class="hljs-selector-class">.ets</span>     <span class="hljs-comment">// 家庭成员菜谱</span>
├── <span class="hljs-selector-tag">ZRFavoriteListPage</span><span class="hljs-selector-class">.ets</span>            <span class="hljs-comment">// 收藏列表</span>
├── <span class="hljs-selector-tag">ZRIngredientDetailPage</span><span class="hljs-selector-class">.ets</span>        <span class="hljs-comment">// 食材详情</span>
├── <span class="hljs-selector-tag">ZRRecipeDetailPage</span><span class="hljs-selector-class">.ets</span>            <span class="hljs-comment">// 菜谱详情</span>
├── <span class="hljs-selector-tag">ZRRecipeFilterPage</span><span class="hljs-selector-class">.ets</span>            <span class="hljs-comment">// 菜谱筛选</span>
├── <span class="hljs-selector-tag">ZRRecipeListPage</span><span class="hljs-selector-class">.ets</span>              <span class="hljs-comment">// 菜谱列表</span>
└── <span class="hljs-selector-tag">ZRTestPage</span><span class="hljs-selector-class">.ets</span>                    <span class="hljs-comment">// 测试页面</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03af903cbfcf4bf9911dce03cd064813~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764385323&amp;x-signature=65E1eFNoDqOMJrhAHWcprrozQdE%3D" alt="image-20251121103117978" loading="lazy"/></p>
<h5 data-id="heading-5">1.2 生命周期管理</h5>
<p>zrouter内置了完整的页面生命周期管理，支持页面创建、销毁、返回等状态控制：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 生命周期管理示例</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Lifecycle</span>, <span class="hljs-title class_">LifecycleEvent</span>, <span class="hljs-title class_">LifecycleRegistry</span>, <span class="hljs-title class_">ZRouter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@hzw/zrouter"</span>;

<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ZRTestPageBuilder</span>(<span class="hljs-params"/>) {
  <span class="hljs-title class_">ZRTestPage</span>()
}

<span class="hljs-meta">@ComponentV2</span>
<span class="hljs-keyword">export</span> struct <span class="hljs-title class_">ZRTestPage</span> {
  <span class="hljs-meta">@Local</span> <span class="hljs-attr">navDestinationId</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">pageStack</span>: <span class="hljs-title class_">NavPathStack</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-meta">@Lifecycle</span>
  <span class="hljs-title function_">onCreate</span>(<span class="hljs-params">want: Want, navStack: NavPathStack</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">navDestinationId</span> = want.<span class="hljs-property">parameters</span>?.[<span class="hljs-string">'navDestinationId'</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span> || <span class="hljs-string">''</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageStack</span> = navStack;
    <span class="hljs-comment">// 注册模板管理器</span>
    <span class="hljs-title class_">ZRouter</span>.<span class="hljs-title function_">templateMgr</span>().<span class="hljs-title function_">register</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">navDestinationId</span>)
  }

  <span class="hljs-meta">@Lifecycle</span>
  <span class="hljs-title function_">onShow</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 页面显示时的逻辑</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pageStack</span>) {
      <span class="hljs-keyword">const</span> router = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LifecycleRegistry</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">navDestinationId</span>);
      <span class="hljs-title class_">ZRouter</span>.<span class="hljs-title function_">templateMgr</span>().<span class="hljs-title function_">dispatch</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">navDestinationId</span>, <span class="hljs-title class_">LifecycleEvent</span>.<span class="hljs-property">ON_SHOW</span>, router)
    }
  }

  <span class="hljs-meta">@Lifecycle</span>
  <span class="hljs-title function_">onBackPress</span>(): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-comment">// 处理返回键逻辑</span>
    <span class="hljs-keyword">const</span> router = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LifecycleRegistry</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">navDestinationId</span>);
    <span class="hljs-keyword">const</span> r = <span class="hljs-title class_">ZRouter</span>.<span class="hljs-title function_">templateMgr</span>().<span class="hljs-title function_">dispatch</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">navDestinationId</span>, <span class="hljs-title class_">LifecycleEvent</span>.<span class="hljs-property">ON_BACK_PRESS</span>, router)
    <span class="hljs-keyword">return</span> r || <span class="hljs-literal">false</span>;
  }
}
</code></pre>
<h4 data-id="heading-6">2. 强大的参数传递机制</h4>
<p>zrouter提供了类型安全的参数传递功能，支持复杂的参数类型和结构。</p>
<h5 data-id="heading-7">2.1 基本参数传递</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 从首页跳转到菜谱详情页，并传递参数</span>
ZRouter<span class="hljs-selector-class">.getInstance</span>()<span class="hljs-selector-class">.setParam</span>({ recipeId: recipe.id })<span class="hljs-selector-class">.push</span>('RecipeDetailPage');

<span class="hljs-comment">// 从筛选页面跳转到列表页面，传递筛选条件</span>
ZRouter<span class="hljs-selector-class">.getInstance</span>()<span class="hljs-selector-class">.setParam</span>(params)<span class="hljs-selector-class">.push</span>('RecipeListPage');
</code></pre>
<h5 data-id="heading-8">2.2 复杂参数传递</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 传递多个筛选参数</span>
const filterParams = {
  category: <span class="hljs-string">'川菜'</span>,
  difficulty: <span class="hljs-string">'简单'</span>,
  flavor: <span class="hljs-string">'香辣'</span>,
  includeIngredients: <span class="hljs-string">'牛肉,青椒'</span>,
  excludeIngredients: <span class="hljs-string">'洋葱'</span>,
  minTime: <span class="hljs-number">10</span>,
  maxTime: <span class="hljs-number">60</span>,
  keyword: <span class="hljs-string">'麻婆豆腐'</span>
};

ZRouter<span class="hljs-selector-class">.getInstance</span>()<span class="hljs-selector-class">.setParam</span>(filterParams)<span class="hljs-selector-class">.push</span>('RecipeListPage');
</code></pre>
<h5 data-id="heading-9">2.3 参数获取与类型转换</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 在目标页面中获取参数</span>
<span class="hljs-meta">@ComponentV2</span>
<span class="hljs-keyword">export</span> struct <span class="hljs-title class_">RecipeListPage</span> {
  <span class="hljs-meta">@Local</span> <span class="hljs-attr">selectMode</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;
  <span class="hljs-meta">@Local</span> <span class="hljs-attr">memberId</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;

  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 获取路由参数</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectMode</span> = <span class="hljs-title class_">ZRouter</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getParamByKey</span>(<span class="hljs-string">'selectMode'</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">boolean</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">memberId</span> = <span class="hljs-title class_">ZRouter</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getParamByKey</span>(<span class="hljs-string">'memberId'</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;
    
    <span class="hljs-comment">// 获取筛选参数</span>
    <span class="hljs-keyword">const</span> category = <span class="hljs-title class_">ZRouter</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getParamByKey</span>(<span class="hljs-string">'category'</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;
    <span class="hljs-keyword">const</span> difficulty = <span class="hljs-title class_">ZRouter</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getParamByKey</span>(<span class="hljs-string">'difficulty'</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;
    <span class="hljs-keyword">const</span> flavor = <span class="hljs-title class_">ZRouter</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getParamByKey</span>(<span class="hljs-string">'flavor'</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;
    <span class="hljs-keyword">const</span> includeIngredients = <span class="hljs-title class_">ZRouter</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getParamByKey</span>(<span class="hljs-string">'includeIngredients'</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;
    <span class="hljs-keyword">const</span> excludeIngredients = <span class="hljs-title class_">ZRouter</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getParamByKey</span>(<span class="hljs-string">'excludeIngredients'</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;
    <span class="hljs-keyword">const</span> minTime = <span class="hljs-title class_">ZRouter</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getParamByKey</span>(<span class="hljs-string">'minTime'</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;
    <span class="hljs-keyword">const</span> maxTime = <span class="hljs-title class_">ZRouter</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getParamByKey</span>(<span class="hljs-string">'maxTime'</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;
    <span class="hljs-keyword">const</span> keyword = <span class="hljs-title class_">ZRouter</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getParamByKey</span>(<span class="hljs-string">'keyword'</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;
  }
}
</code></pre>
<h4 data-id="heading-10">3. 声明式路由配置</h4>
<p>zrouter支持简洁的装饰器语法，让路由配置更加优雅：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Route</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@hzw/zrouter'</span>;

<span class="hljs-meta">@Route</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'TestPage'</span>, <span class="hljs-attr">useTemplate</span>: <span class="hljs-literal">true</span> })
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">export</span> struct <span class="hljs-title class_">TestPage</span> {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'This is Test Page'</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">NavDestination</span>() {
      <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span> }) {
        <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)
          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">24</span>)
          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)
        
        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'ZRouter 引入成功！'</span>)
          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
          .<span class="hljs-title function_">fontColor</span>(<span class="hljs-string">'#4CAF50'</span>)
      }
      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
    }
    .<span class="hljs-title function_">title</span>(<span class="hljs-string">'测试页面'</span>)
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
  }
}
</code></pre>
<h3 data-id="heading-11">项目集成实践</h3>
<h4 data-id="heading-12">1. 依赖配置</h4>
<p>在项目的<code>oh-package.json5</code>中添加zrouter依赖：</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-string">"@hzw/zrouter"</span>: <span class="hljs-string">"^1.8.2"</span>
  }
}
</code></pre>
<p>![依赖配置示意图]<em>图3：oh-package.json5中的zrouter依赖配置</em></p>
<h4 data-id="heading-13">2. 初始化配置</h4>
<p>在<code>EntryAbility</code>的<code>onCreate</code>方法中初始化zrouter：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> { ZRouter } from <span class="hljs-string">'@hzw/zrouter'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> extends UIAbility {
  <span class="hljs-built_in">onCreate</span>(want: Want, launchParam: AbilityConstant.LaunchParam): <span class="hljs-type">void</span> {
    <span class="hljs-comment">// 初始化 ZRouter</span>
    ZRouter.<span class="hljs-built_in">initialize</span>((config) =&gt; {
      config.context = <span class="hljs-keyword">this</span>.context;
      config.isLoggingEnabled = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 开发环境开启日志</span>
      config.isHSPModuleDependent = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 如果有HSP模块设置为true</span>
    });
  }
}
</code></pre>
<h4 data-id="heading-14">3. 导航容器配置</h4>
<p>在主页面中使用zrouter的导航栈：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ZRouter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@hzw/zrouter'</span>;

<span class="hljs-meta">@ComponentV2</span>
<span class="hljs-keyword">export</span> struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Navigation</span>(<span class="hljs-title class_">ZRouter</span>.<span class="hljs-title function_">getNavStack</span>()) {
      <span class="hljs-title class_">HomePage</span>()
    }
    .<span class="hljs-title function_">mode</span>(<span class="hljs-title class_">NavigationMode</span>.<span class="hljs-property">Stack</span>)
  }
}
</code></pre>
<h4 data-id="heading-15">4. 代码混淆适配</h4>
<p>在混淆规则文件<code>obfuscation-rules.txt</code>中配置zrouter相关的保护规则：</p>
<pre><code class="hljs language-erlang" lang="erlang"># ZRouter 混淆配置
-keep<span class="hljs-keyword">-file</span>-name
Index
_generated
ZR*
</code></pre>
<p>这确保了zrouter生成的页面名称和路由配置在混淆后仍能正常工作。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ebdd71a3f814a9fa99fc866c4ab3cb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764385323&amp;x-signature=JTTQI4lMj%2BClPozmRBnLeDL2GGE%3D" alt="image-20251121103208018" loading="lazy"/></p>
<h3 data-id="heading-16">静默登录功能实现</h3>
<p>除了zrouter路由管理，项目还实现了完整的用户认证体系，其中静默登录是一大亮点功能。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ee0b462325a4111be0553691a22c0fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764385323&amp;x-signature=SEgIGNCYicIWLFAov%2Fw9tYkFreI%3D" alt="image-20251121103220738" loading="lazy"/></p>
<h4 data-id="heading-17">1. 静默登录核心逻辑</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 静默登录 - 不显示登录界面
 * <span class="hljs-doctag">@param</span> enableSilentLogin 是否启用静默登录
 * <span class="hljs-doctag">@returns</span> 登录是否成功
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">performSilentLogin</span>(<span class="hljs-attr">enableSilentLogin</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {
  <span class="hljs-comment">// 如果未启用静默登录，直接返回</span>
  <span class="hljs-keyword">if</span> (!enableSilentLogin) {
    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'AuthManager'</span>, <span class="hljs-string">'静默登录已关闭'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">try</span> {
    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'AuthManager'</span>, <span class="hljs-string">'开始静默登录'</span>);

    <span class="hljs-comment">// 创建静默登录请求</span>
    <span class="hljs-keyword">const</span> loginRequest = <span class="hljs-keyword">new</span> authentication.<span class="hljs-title class_">HuaweiIDProvider</span>().<span class="hljs-title function_">createLoginWithHuaweiIDRequest</span>();
    loginRequest.<span class="hljs-property">forceLogin</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 静默登录</span>
    loginRequest.<span class="hljs-property">state</span> = util.<span class="hljs-title function_">generateRandomUUID</span>();

    <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> authentication.<span class="hljs-title class_">AuthenticationController</span>();
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> controller.<span class="hljs-title function_">executeRequest</span>(loginRequest);

    <span class="hljs-keyword">const</span> loginWithHuaweiIDResponse = response <span class="hljs-keyword">as</span> authentication.<span class="hljs-property">LoginWithHuaweiIDResponse</span>;
    <span class="hljs-keyword">const</span> state = loginWithHuaweiIDResponse.<span class="hljs-property">state</span>;

    <span class="hljs-comment">// 验证 state</span>
    <span class="hljs-keyword">if</span> (state &amp;&amp; loginRequest.<span class="hljs-property">state</span> !== state) {
      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'AuthManager'</span>, <span class="hljs-string">'状态验证失败'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">const</span> credential = loginWithHuaweiIDResponse.<span class="hljs-property">data</span>;
    <span class="hljs-keyword">if</span> (!credential) {
      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'AuthManager'</span>, <span class="hljs-string">'未获取到凭证'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 调用后端API完成登录</span>
    <span class="hljs-keyword">const</span> loginResponse = <span class="hljs-keyword">await</span> <span class="hljs-title function_">huaweiLogin</span>({
      <span class="hljs-attr">authorizationCode</span>: credential.<span class="hljs-property">authorizationCode</span> || <span class="hljs-string">''</span>,
      <span class="hljs-attr">openID</span>: credential.<span class="hljs-property">openID</span> || <span class="hljs-string">''</span>,
      <span class="hljs-attr">unionID</span>: credential.<span class="hljs-property">unionID</span> || <span class="hljs-string">''</span>,
      <span class="hljs-attr">idToken</span>: credential.<span class="hljs-property">idToken</span>
    });

    <span class="hljs-comment">// 保存登录状态</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveLoginState</span>(loginResponse);

    <span class="hljs-comment">// 更新全局用户状态</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">userStore</span>.<span class="hljs-title function_">setUser</span>(loginResponse.<span class="hljs-property">user</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">userStore</span>.<span class="hljs-title function_">setLoggedIn</span>(<span class="hljs-literal">true</span>);

    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'AuthManager'</span>, <span class="hljs-string">'静默登录成功: %{public}s'</span>, 
      loginResponse.<span class="hljs-property">user</span>.<span class="hljs-property">nickname</span> || loginResponse.<span class="hljs-property">user</span>.<span class="hljs-property">username</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">const</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;
    <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span> === <span class="hljs-number">1001502001</span>) {
      <span class="hljs-comment">// 用户未登录华为账号，这是正常情况</span>
      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'AuthManager'</span>, <span class="hljs-string">'用户未登录华为账号'</span>);
    } <span class="hljs-keyword">else</span> {
      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'AuthManager'</span>, <span class="hljs-string">'静默登录失败: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
}
</code></pre>
<h4 data-id="heading-18">2. 启动登录流程</h4>
<p>在应用启动时，系统会自动执行以下登录逻辑：</p>
<ol>
<li><strong>本地状态恢复</strong>：优先从本地存储恢复登录状态</li>
<li><strong>静默登录</strong>：如果本地恢复失败且开启静默登录，则执行静默登录</li>
<li><strong>用户状态更新</strong>：更新全局用户状态管理</li>
</ol>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">/**
 * 应用启动时的登录逻辑
 * 1. 先尝试从本地恢复登录状态
 * 2. 如果本地恢复成功，不再执行静默登录
 * 3. 如果本地恢复失败且开启了静默登录，则执行静默登录
 */</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title">performStartupLogin</span>(): Promise&lt;<span class="hljs-keyword">void</span>&gt;</span> {
  <span class="hljs-keyword">try</span> {
    hilog.info(DOMAIN, <span class="hljs-string">'EntryAbility'</span>, <span class="hljs-string">'开始执行启动登录逻辑'</span>);

    <span class="hljs-comment">// 1. 先尝试从本地恢复登录状态</span>
    <span class="hljs-keyword">const</span> restored = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.authManager.restoreLoginState();
    <span class="hljs-keyword">if</span> (restored) {
      hilog.info(DOMAIN, <span class="hljs-string">'EntryAbility'</span>, <span class="hljs-string">'从本地恢复登录状态成功'</span>);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 2. 检查是否启用静默登录</span>
    <span class="hljs-keyword">const</span> enableSilentLogin = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.storageManager.getBoolean(
      StorageKeys.ENABLE_SILENT_LOGIN, 
      <span class="hljs-literal">true</span> <span class="hljs-comment">// 默认开启</span>
    );

    <span class="hljs-keyword">if</span> (!enableSilentLogin) {
      hilog.info(DOMAIN, <span class="hljs-string">'EntryAbility'</span>, <span class="hljs-string">'静默登录已关闭，跳过'</span>);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 3. 执行静默登录</span>
    <span class="hljs-keyword">const</span> success = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.authManager.performSilentLogin(enableSilentLogin);
    <span class="hljs-keyword">if</span> (success) {
      hilog.info(DOMAIN, <span class="hljs-string">'EntryAbility'</span>, <span class="hljs-string">'静默登录成功'</span>);
    } <span class="hljs-keyword">else</span> {
      hilog.info(DOMAIN, <span class="hljs-string">'EntryAbility'</span>, <span class="hljs-string">'静默登录失败或用户未登录'</span>);
    }

  } <span class="hljs-keyword">catch</span> (error) {
    hilog.error(DOMAIN, <span class="hljs-string">'EntryAbility'</span>, <span class="hljs-string">'启动登录逻辑执行失败: %{public}s'</span>, JSON.stringify(error));
  }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4b91e0c788f43a0a737488c17282238~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764385323&amp;x-signature=DilTI5VV55VR98QoieFLk3Ljwyk%3D" alt="image-20251121103306865" loading="lazy"/></p>
<p>image-20251121103306865</p>
<h4 data-id="heading-19">3. 手动登录支持</h4>
<p>除了静默登录，项目还支持手动登录，用户可以主动触发登录流程：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">/**
 * 手动登录 - 显示登录界面
 * @returns 登录响应数据
 */</span>
<span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-title">performManualLogin</span>(): Promise&lt;LoginResponse | <span class="hljs-literal">null</span>&gt;</span> {
  <span class="hljs-keyword">try</span> {
    hilog.info(DOMAIN, <span class="hljs-string">'AuthManager'</span>, <span class="hljs-string">'开始手动登录'</span>);

    <span class="hljs-comment">// 创建登录请求</span>
    <span class="hljs-keyword">const</span> loginRequest = <span class="hljs-keyword">new</span> authentication.HuaweiIDProvider().createLoginWithHuaweiIDRequest();
    loginRequest.forceLogin = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 强制显示登录页面</span>
    loginRequest.state = util.generateRandomUUID();

    <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> authentication.AuthenticationController();
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> controller.executeRequest(loginRequest);

    <span class="hljs-keyword">const</span> loginWithHuaweiIDResponse = response <span class="hljs-keyword">as</span> authentication.LoginWithHuaweiIDResponse;
    <span class="hljs-keyword">const</span> state = loginWithHuaweiIDResponse.state;

    <span class="hljs-keyword">if</span> (state &amp;&amp; loginRequest.state !== state) {
      hilog.error(DOMAIN, <span class="hljs-string">'AuthManager'</span>, <span class="hljs-string">'状态验证失败'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">const</span> credential = loginWithHuaweiIDResponse.data;
    <span class="hljs-keyword">if</span> (!credential) {
      hilog.error(DOMAIN, <span class="hljs-string">'AuthManager'</span>, <span class="hljs-string">'未获取到凭证'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-comment">// 调用后端API完成登录</span>
    <span class="hljs-keyword">const</span> loginResponse = <span class="hljs-keyword">await</span> huaweiLogin({
      authorizationCode: credential.authorizationCode || <span class="hljs-string">''</span>,
      openID: credential.openID || <span class="hljs-string">''</span>,
      unionID: credential.unionID || <span class="hljs-string">''</span>,
      idToken: credential.idToken
    });

    <span class="hljs-comment">// 保存登录状态</span>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.saveLoginState(loginResponse);

    <span class="hljs-comment">// 更新全局用户状态</span>
    <span class="hljs-keyword">this</span>.userStore.setUser(loginResponse.user);
    <span class="hljs-keyword">this</span>.userStore.setLoggedIn(<span class="hljs-literal">true</span>);

    hilog.info(DOMAIN, <span class="hljs-string">'AuthManager'</span>, <span class="hljs-string">'手动登录成功: %{public}s'</span>,
      loginResponse.user.nickname || loginResponse.user.username);

    <span class="hljs-keyword">return</span> loginResponse;

  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">const</span> err = error <span class="hljs-keyword">as</span> BusinessError;
    hilog.error(DOMAIN, <span class="hljs-string">'AuthManager'</span>, <span class="hljs-string">'手动登录失败: %{public}s'</span>, JSON.stringify(error));
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<h3 data-id="heading-20">核心亮点与优势</h3>
<h4 data-id="heading-21">1. 零配置路由管理</h4>
<ul>
<li><strong>自动生成路由</strong>：通过插件自动扫描生成路由配置，无需手动维护路由表</li>
<li><strong>类型安全</strong>：参数传递和获取过程中提供完整的类型支持</li>
<li><strong>声明式配置</strong>：使用装饰器语法，让路由配置更加简洁直观</li>
</ul>
<h4 data-id="heading-22">2. 强大的页面生命周期管理</h4>
<ul>
<li><strong>完整的生命周期钩子</strong>：支持页面创建、显示、隐藏、销毁等完整生命周期</li>
<li><strong>灵活的事件处理</strong>：内置多种事件类型，便于处理复杂的页面交互逻辑</li>
<li><strong>返回键管理</strong>：提供统一的返回键处理机制</li>
</ul>
<h4 data-id="heading-23">3. 智能参数传递机制</h4>
<ul>
<li><strong>类型转换支持</strong>：自动处理基本类型和复杂对象的序列化/反序列化</li>
<li><strong>参数验证</strong>：内置参数验证机制，提高应用稳定性</li>
<li><strong>状态管理集成</strong>：与鸿蒙的AppStorageV2等状态管理方案完美集成</li>
</ul>
<h4 data-id="heading-24">4. 生产级混淆适配</h4>
<ul>
<li><strong>混淆保护规则</strong>：提供完整的混淆配置建议</li>
<li><strong>文件名称保护</strong>：确保混淆后路由名称的正确映射</li>
<li><strong>编译时优化</strong>：支持编译时的路由优化和压缩</li>
</ul>
<h4 data-id="heading-25">5. 无缝认证集成</h4>
<ul>
<li><strong>静默登录体验</strong>：应用启动时自动完成身份验证，用户无感知</li>
<li><strong>本地状态恢复</strong>：优先使用本地存储的用户信息，提升启动速度</li>
<li><strong>灵活认证策略</strong>：支持静默登录和手动登录的灵活切换</li>
</ul>
<h3 data-id="heading-26">性能与优化</h3>
<h4 data-id="heading-27">1. 路由性能优化</h4>
<ul>
<li><strong>懒加载支持</strong>：zrouter支持页面懒加载，减少应用启动时间</li>
<li><strong>路由缓存</strong>：内置路由状态缓存，提升页面切换性能</li>
<li><strong>内存管理</strong>：智能的内存管理机制，避免内存泄漏</li>
</ul>
<h4 data-id="heading-28">2. 开发体验优化</h4>
<ul>
<li><strong>开发日志</strong>：开发模式下提供详细的路由操作日志</li>
<li><strong>热更新支持</strong>：支持开发时的路由热更新</li>
<li><strong>调试工具</strong>：提供丰富的调试工具和状态监控</li>
</ul>
<h4 data-id="heading-29">3. 兼容性保障</h4>
<ul>
<li><strong>版本兼容</strong>：支持不同版本的HarmonyOS系统</li>
<li><strong>API适配</strong>：自动适配不同API版本的功能差异</li>
<li><strong>向后兼容</strong>：确保老版本代码的兼容性问题</li>
</ul>
<h3 data-id="heading-30">最佳实践建议</h3>
<h4 data-id="heading-31">1. 路由命名规范</h4>
<ul>
<li>使用语义化的页面名称</li>
<li>统一命名风格（如驼峰命名法）</li>
<li>避免使用特殊字符</li>
</ul>
<h4 data-id="heading-32">2. 参数设计原则</h4>
<ul>
<li>传递最小必要信息</li>
<li>避免传递过大的对象</li>
<li>合理设计参数结构</li>
</ul>
<h4 data-id="heading-33">3. 页面生命周期管理</h4>
<ul>
<li>合理使用生命周期钩子</li>
<li>避免在生命周期中执行耗时操作</li>
<li>及时清理资源，避免内存泄漏</li>
</ul>
<h4 data-id="heading-34">4. 安全考虑</h4>
<ul>
<li>对敏感参数进行加密处理</li>
<li>验证参数的合法性</li>
<li>避免在URL中暴露敏感信息</li>
</ul>
<h3 data-id="heading-35">总结</h3>
<p>味寻纪-元服务项目成功集成了zrouter路由管理方案，并实现了完善的静默登录功能。通过zrouter的强大功能，项目获得了：</p>
<ul>
<li><strong>统一且强大的路由管理</strong>：简化了页面导航逻辑，提升了开发效率</li>
<li><strong>类型安全的参数传递</strong>：减少了运行时错误，提升了代码质量</li>
<li><strong>完整的生活周期管理</strong>：提供了更好的用户体验</li>
<li><strong>生产级的混淆支持</strong>：确保了应用的安全性</li>
<li><strong>无缝的认证体验</strong>：静默登录提升了用户使用体验</li>
</ul>
<p>zrouter作为鸿蒙官方推荐的路由解决方案，为HarmonyOS Next应用开发提供了强大而稳定的路由管理能力，是构建高质量鸿蒙应用的重要工具。通过味寻纪项目的实践，我们可以看到zrouter在实际项目中的强大功能和良好体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[模型驱动架构的数学内核：统一生成与演化的 Y = F(X) ⊕ Delta 不变式]]></title>    <link>https://juejin.cn/post/7575017581036847142</link>    <guid>https://juejin.cn/post/7575017581036847142</guid>    <pubDate>2025-11-22T01:20:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575017581036847142" data-draft-id="7575006095389179913" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="模型驱动架构的数学内核：统一生成与演化的 Y = F(X) ⊕ Delta 不变式"/> <meta itemprop="keywords" content="架构,设计模式,数学"/> <meta itemprop="datePublished" content="2025-11-22T01:20:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="canonical_entropy"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289694429"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            模型驱动架构的数学内核：统一生成与演化的 Y = F(X) ⊕ Delta 不变式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289694429/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    canonical_entropy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T01:20:51.000Z" title="Sat Nov 22 2025 01:20:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>摘要：</strong> 模型驱动架构（MDA）通过提升抽象层次与自动化来应对软件复杂性。然而，传统MDA在实践中面临“往返工程”与“胖模型”等挑战，这些问题的解决一般依赖于工程经验，缺少完备的数学理论的指导。本文探讨一种基于（广义）可逆计算理论的架构思想，它引入“差量（Delta）”作为具备代数属性的基本构造单元，并提出<code>Y = F(X) ⊕ Delta</code>这一构造不变式。该框架旨在统一软件的生成与演化过程，为解决传统MDA的固有问题提供一种新的范式，并揭示软件构造过程背后潜在的数学结构。</p>
<h4 data-id="heading-0"><strong>1. 模型驱动架构（MDA）的贡献与局限</strong></h4>
<p>模型驱动架构的核心是将模型作为软件开发过程的首要产物。其经典的流程——从计算无关模型（CIM）到平台无关模型（PIM），再到平台相关模型（PSM），最后生成代码。</p>
<p>模型驱动的核心思想可以看作是根据模型生成代码，形式化表达为 <code>Model =&gt; Code</code>, 更进一步可以写成</p>
<pre><code class="hljs language-ini" lang="ini"> <span class="hljs-attr">Code</span> = Generator(Model)
</code></pre>
<p>现实中，手动调整几乎不可避免，导致最终的应用形态变为：</p>
<p><code>App = Generator(Model) + ManualAdjustment</code></p>
<p>但是这里的 <code>+ManualAdjustment</code>一般是一种人工介入的操作过程，比如手工对生成代码修改，难以通过规则自动化完成。这种行为破坏了模型作为“唯一真相来源”的原则，导致模型与代码的状态不一致。</p>
<h4 data-id="heading-1"><strong>2. 构造单元的重定义：以“差量（Delta）”为核心</strong></h4>
<p><strong>（广义）可逆计算理论</strong>提供了一种新的理论视角，它建议对软件的基本构造单元进行重新定义。</p>
<ul>
<li><strong>传统视角</strong>：程序由数据和函数构成。在面向对象范式中，它们被组织为类与对象，即“一切皆对象”。</li>
<li><strong>新视角</strong>：软件的基本构造单元是**“差量（Delta）”<strong>。一个<code>Delta</code>是包含精确增、删、改语义的变更切片（Slice）的集合，例如类的切片、函数的切片或数据的切片。考虑到A=0+A，在此框架下，一个完整的程序或模型（全量）可被视为一个“从无到有”的特殊<code>Delta</code>。因此，其核心主张是</strong>“一切皆差量”**。</li>
</ul>
<p>这一视角的转变，意在将软件的“初始构造”和“后续演化”两个过程统一在同一个概念之下。这与版本控制系统（如Git的Commit）或事件溯源（Event Sourcing）的思想存在关联，但其应用目标是程序的<strong>结构本身</strong>，而非文本或运行时状态。</p>
<h4 data-id="heading-2"><strong>3. Delta导向架构：基于差量代数的不变式</strong></h4>
<p>基于“一切皆差量”的公理，传统MDA的构造公式可被一个更通用的公式所取代：</p>
<p><code>Y = F(X) ⊕ Delta</code></p>
<p>该公式可被视为Delta导向架构的<strong>基本不变式</strong>，其中：</p>
<ul>
<li><code>X</code> 和 <code>Y</code> 是不同抽象层次或不同领域的模型，它们通常以领域特定语言（DSL）的形式存在。</li>
<li><code>F</code> 是一个转换函数（Generator），定义了从<code>X</code>到<code>Y</code>主要部分的推导规则。</li>
<li><code>Delta</code> 是一个形式化的差量对象，封装了所有<code>F(X)</code>未能覆盖的、在<code>Y</code>空间中必须补充或修正的细节。</li>
<li><code>⊕</code> 是一个有明确定义的<strong>差量合并运算</strong>。它取代了原先模糊的 <code>+</code>，使得“手动调整”过程本身成为可追踪、可组合、甚至具备可逆性的操作。</li>
</ul>
<p>为实现此框架，需要在不同的程序结构空间中定义相应的<code>⊕</code>运算规则。例如，对于树状结构的XML或JSON，可定义一种<code>x-extends</code>的差量合并算法，满足结合律但不满足交换律；对于具有复杂依赖图的Java语言结构，则可以通过引用id将循环关联断开，将图投影为树结构。</p>
<h4 data-id="heading-3"><strong>4. 递归分解：应对复杂性与“胖模型”问题</strong></h4>
<p><code>Y = F(X) ⊕ Delta</code>这一不变式的一个关键特性在于其<strong>递归应用</strong>的能力，这为处理复杂系统和MDA的“胖模型”问题提供了一种结构化的解决方案。</p>
<p><strong>4.1 纵向分解</strong></p>
<p>传统MDA要求上游模型（PIM）包含生成下游所有产物所需的信息，可能导致PIM过度复杂。Delta导向架构允许信息在转换链中逐步注入：</p>
<p><code>Y = F1(X) ⊕ Delta1</code>
<code>X = F2(Z) ⊕ Delta2</code></p>
<p>代入后得到：<code>Y = F1(F2(Z) ⊕ Delta2) ⊕ Delta1</code></p>
<p>此公式表明，在从<code>Z</code>生成<code>X</code>时，<code>Z</code>模型本身无需承载所有的最终细节。<code>X</code>层面的信息可以通过<code>Delta2</code>补充，而最终<code>Y</code>层面的信息则可通过<code>Delta1</code>再次补充。每一层的<code>Delta</code>仅包含其对应抽象层次所关心的信息，有助于降低单一模型的复杂性。</p>
<p><strong>4.2 横向分解</strong></p>
<p>现代应用通常是多个关注点的组合。该框架同样支持横向分解：</p>
<p><code>App = F1(DSL1) ⊕ F2(DSL2) ⊕ ... ⊕ Delta_extra</code></p>
<p>这描述了应用的最终形态可由多个不同领域模型（如API模型、数据模型、UI模型）的生成结果，与一个用于粘合和定制的额外差量<code>Delta_extra</code>组合而成。</p>
<p><strong>4.3 元编程空间的分解</strong></p>
<p>该理论的普适性体现在它同样适用于构造过程本身。不仅模型和差量可以被分解，生成器自身也可以被视为差量组合的结果：</p>
<p><code>Generator2 = Generator1 ⊕ Delta_Generator</code></p>
<p>这意味着一个通用的代码生成器可以通过与一个特定的“特性差量包”进行合并，演化为一个专用的生成器。这为元编程工具的复用和演进提供了理论上的可能性。</p>
<h3 data-id="heading-4"><strong>5. 元模型、差量与生成式构造</strong></h3>
<p>本文提出的数学框架，在元模型（Metamodel）层面同样适用，并能与现代AI技术无缝结合。</p>
<p><strong>5.1 元模型即类型</strong></p>
<p>首先，我们将元模型与模型的关系形式化。一个元模型（MM）可以被看作一个<strong>类型系统</strong>，而模型（M）则是该类型系统的一个<strong>实例（值）</strong>。这种关系用类型论中的断言（Typing Judgment）表示：</p>
<p><code>M : MM</code></p>
<p>该公式读作：“模型<code>M</code>是元模型<code>MM</code>的一个有效实例”。这与编程语言中的<code>5 : Integer</code>完全等价。在MDA中，这意味着一个<code>UserClass</code>模型必须遵循<code>UML_Class</code>元模型定义的规则。</p>
<p><strong>5.2 AI驱动的生成式构造</strong></p>
<p>传统上，<code>M : MM</code>主要用于<strong>验证</strong>。但在AI（特别是LLM）时代，元模型的角色从“事后验证者”转变为“事前指导者”。我们可以将模型的生成过程形式化为：</p>
<p><code>Model = AIGenerator(Metamodel, Requirements)</code></p>
<ul>
<li><code>Metamodel</code>在此作为<strong>结构化约束</strong>输入，为AI的自由创造划定了语法边界和结构骨架，确保输出的<code>Model</code>必然满足<code>Model : Metamodel</code>。</li>
<li><code>Requirements</code>则是以自然语言等形式提供的<strong>语义意图</strong>，指导AI在合法的结构空间内生成具体内容。</li>
</ul>
<p><strong>5.3 元模型的差量演化</strong></p>
<p>本文理论最关键的自相似性体现在，差量分解同样适用于元模型本身：</p>
<p><code>Metamodel' = Metamodel ⊕ Delta_Metamodel</code></p>
<p>这个公式意味着<strong>语言本身也可以通过差量进行演化</strong>。例如，我们可以通过一个<code>Delta_Metamodel</code>为一门DSL（由<code>Metamodel</code>定义）非侵入式地增加原语言设计者设想之外的新特性。这为领域语言的受控演化和能力升级提供了强大的形式化工具，体现了该理论在不同抽象层次上的一致性和普适性。</p>
<h2 data-id="heading-5">结论</h2>
<p>Delta导向架构的数学结构类似于数学中的<strong>小波分析</strong>。在小波分析中，一个信号被分解为一个低频的**近似（Approximation）<strong>部分和一个高频的</strong>细节（Detail）**部分，且此分解过程可递归进行。</p>
<p>与之对应，<code>Y = F(X) ⊕ Delta</code>中的<code>F(X)</code>可被看作是由上游模型生成的、框架性的“近似”部分，而<code>Delta</code>则是补充的、具体的“细节”部分。其递归分解的特性，也与小波分析的多分辨率分析能力相似。</p>
<p>将“差量（Delta）”及其代数运算<code>⊕</code>置于软件构造的核心，为模型驱动架构的发展提供了一个基于形式化方法的演进方向。它试图将软件开发从一种依赖人工协调的活动，转变为一种基于形式化推导和结构化差量合成的系统工程。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 实战：基于 JWT 优化 Spring Security 无状态登录]]></title>    <link>https://juejin.cn/post/7574997924929978408</link>    <guid>https://juejin.cn/post/7574997924929978408</guid>    <pubDate>2025-11-21T13:01:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574997924929978408" data-draft-id="7574978545144610851" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 实战：基于 JWT 优化 Spring Security 无状态登录"/> <meta itemprop="keywords" content="后端,Spring Boot"/> <meta itemprop="datePublished" content="2025-11-21T13:01:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Web天梯之路"/> <meta itemprop="url" content="https://juejin.cn/user/2825061103052843"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 实战：基于 JWT 优化 Spring Security 无状态登录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2825061103052843/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Web天梯之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T13:01:49.000Z" title="Fri Nov 21 2025 13:01:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring Boot 实战：基于 JWT 优化 Spring Security 无状态登录</h2>
<p>在上一篇文章中，我们通过 Spring Security 实现了基础的接口权限控制，但采用的 HTTP Basic 登录存在明显缺陷：<strong>安全性</strong>，用户名和密码只是简单的通过 Base64 编码之后就开始传送了，很容易被破解，进而暴露用户信息。</p>
<p>本文将引入 <strong>JWT（JSON Web Token）</strong> 技术，重构登录流程，让接口即安全又贴合企业级项目需求。</p>
<h3 data-id="heading-1">一、先搞懂：为什么需要 JWT？</h3>
<p>Jwt的核心优势是 <strong>无状态</strong>：</p>
<ol>
<li>登录成功后，服务器生成一个包含用户信息和权限的加密 Token，直接返回给客户端；</li>
<li>客户端后续请求时，只需在请求头携带 Token，服务器无需存储任何状态，直接通过 Token 验证身份和权限；</li>
<li>多台服务器共用一套 Token 验证逻辑，无需同步状态，完美适配分布式部署。</li>
</ol>
<h3 data-id="heading-2">二、准备工作：添加 JWT 依赖</h3>
<p>在 <code>pom.xml</code> 的 <code>&lt;dependencies&gt;</code> 标签中，新增 JWT 相关依赖（基于 JJWT 框架，Spring 官方推荐）：</p>
<pre><code class="hljs language-xml" lang="xml">        <span class="hljs-comment">&lt;!-- JWT 核心依赖（JJWT） --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- JWT 实现依赖 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-impl<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- JWT 加密算法依赖 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-jackson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>添加后点击 IDEA 右上角的 “Load Maven Changes” 刷新依赖，确保无红色报错。</p>
<h3 data-id="heading-3">三、第一步：实现 JWT 工具类（核心）</h3>
<p>JWT 的核心操作包括 <strong>生成 Token</strong>、<strong>验证 Token</strong>、<strong>解析 Token 中的用户信息</strong>，我们创建一个工具类封装这些逻辑，方便后续调用。</p>
<p>在 <code>com.example.firstspringbootproject.utils</code> 包下创建 <code>JwtUtil</code> 类：</p>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">example</span>.<span class="hljs-property">firstspringbootproject</span>.<span class="hljs-property">utils</span>;

<span class="hljs-keyword">import</span> io.<span class="hljs-property">jsonwebtoken</span>.*;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">beans</span>.<span class="hljs-property">factory</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Value</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">security</span>.<span class="hljs-property">core</span>.<span class="hljs-property">userdetails</span>.<span class="hljs-property">UserDetails</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">stereotype</span>.<span class="hljs-property">Component</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">Date</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">HashMap</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">List</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">Map</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">function</span>.<span class="hljs-property">Function</span>;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtUtil</span> {

    <span class="hljs-comment">// 1. 从配置文件读取 JWT 关键参数（避免硬编码）</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"${jwt.secret}"</span>) <span class="hljs-comment">// 密钥（必须保密，建议在生产环境用环境变量配置）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> secret;

    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"${jwt.expiration}"</span>) <span class="hljs-comment">// Token 过期时间（单位：毫秒，这里配置 2 小时）</span>
    <span class="hljs-keyword">private</span> long expiration;

    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"${jwt.header}"</span>) <span class="hljs-comment">// 请求头中携带 Token 的字段名（如 Authorization）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> tokenHeader;

    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"${jwt.prefix}"</span>) <span class="hljs-comment">// Token 前缀（如 Bearer，规范要求加空格）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> tokenPrefix;

    <span class="hljs-comment">// 2. 生成 Token：基于用户信息（用户名、角色）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">generateToken</span>(<span class="hljs-params">UserDetails userDetails</span>) {

        <span class="hljs-comment">// 存储 Token 中的自定义信息（Payload）</span>
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; claims = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

        <span class="hljs-comment">// 将用户角色存入 Token（后续验证权限用）</span>
        claims.<span class="hljs-title function_">put</span>(<span class="hljs-string">"roles"</span>, userDetails.<span class="hljs-title function_">getAuthorities</span>().<span class="hljs-title function_">stream</span>()
                .<span class="hljs-title function_">map</span>(authority -&gt; authority.<span class="hljs-title function_">getAuthority</span>())
                .<span class="hljs-title function_">toList</span>());

        <span class="hljs-comment">// 构建 Token 并返回</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Jwts</span>.<span class="hljs-title function_">builder</span>()
                .<span class="hljs-title function_">setClaims</span>(claims) <span class="hljs-comment">// 自定义信息</span>
                .<span class="hljs-title function_">setSubject</span>(userDetails.<span class="hljs-title function_">getUsername</span>()) <span class="hljs-comment">// 用户名（唯一标识）</span>
                .<span class="hljs-title function_">setIssuedAt</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()) <span class="hljs-comment">// 签发时间</span>
                .<span class="hljs-title function_">setExpiration</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-title class_">System</span>.<span class="hljs-title function_">currentTimeMillis</span>() + expiration)) <span class="hljs-comment">// 过期时间</span>
                .<span class="hljs-title function_">signWith</span>(<span class="hljs-title class_">SignatureAlgorithm</span>.<span class="hljs-property">HS512</span>, secret) <span class="hljs-comment">// 加密算法（HS512）+ 密钥</span>
                .<span class="hljs-title function_">compact</span>();
    }

    <span class="hljs-comment">// 3. 从 Token 中获取用户名</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getUsernameFromToken</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> token</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">getClaimFromToken</span>(token, <span class="hljs-title class_">Claims</span>::getSubject);
    }

    <span class="hljs-comment">// 4. 验证 Token 是否有效（未过期 + 用户名匹配）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">validateToken</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> token, UserDetails userDetails</span>) {
        <span class="hljs-title class_">String</span> username = <span class="hljs-title function_">getUsernameFromToken</span>(token);

        <span class="hljs-comment">// 验证逻辑：用户名一致 + Token 未过期 + Token 未被篡改</span>
        <span class="hljs-keyword">return</span> username.<span class="hljs-title function_">equals</span>(userDetails.<span class="hljs-title function_">getUsername</span>())
                &amp;&amp; !<span class="hljs-title function_">isTokenExpired</span>(token);

    }

    <span class="hljs-comment">// 5. 从 Token 中获取自定义角色信息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getRoleFromToken</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> token</span>) {

        <span class="hljs-title class_">Claims</span> claims = <span class="hljs-title function_">getAllClaimsFromToken</span>(token);
        <span class="hljs-comment">// 从自定义信息中获取角色列表（这里简化为单个角色，多角色可返回 List）</span>
        <span class="hljs-keyword">return</span> ((<span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">String</span>&gt;) claims.<span class="hljs-title function_">get</span>(<span class="hljs-string">"roles"</span>)).<span class="hljs-title function_">get</span>(<span class="hljs-number">0</span>);

    }

    <span class="hljs-comment">// ------------------------------</span>

    <span class="hljs-comment">// 以下是内部工具方法（无需外部调用）</span>

    <span class="hljs-comment">// ------------------------------</span>

    <span class="hljs-comment">// 解析 Token，获取所有自定义信息（Payload）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Claims</span> <span class="hljs-title function_">getAllClaimsFromToken</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> token</span>) {

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Jwts</span>.<span class="hljs-title function_">parser</span>()
                    .<span class="hljs-title function_">setSigningKey</span>(secret) <span class="hljs-comment">// 用密钥解密</span>
                    .<span class="hljs-title function_">parseClaimsJws</span>(token)
                    .<span class="hljs-title function_">getBody</span>();
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">ExpiredJwtException</span> | <span class="hljs-title class_">MalformedJwtException</span> | <span class="hljs-title class_">SignatureException</span>
                 | <span class="hljs-title class_">IllegalArgumentException</span> | <span class="hljs-title class_">UnsupportedJwtException</span> e) {
            <span class="hljs-comment">// 捕获 Token 异常（过期、格式错误、签名错误等）</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"无效的 Token："</span> + e.<span class="hljs-title function_">getMessage</span>());
        }

    }

    <span class="hljs-comment">// 从 Token 中获取指定信息（通用方法）</span>
    <span class="hljs-keyword">private</span> &lt;T&gt; T <span class="hljs-title function_">getClaimFromToken</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> token, <span class="hljs-built_in">Function</span>&lt;Claims, T&gt; claimsResolver</span>) {
        final <span class="hljs-title class_">Claims</span> claims = <span class="hljs-title function_">getAllClaimsFromToken</span>(token);
        <span class="hljs-keyword">return</span> claimsResolver.<span class="hljs-title function_">apply</span>(claims);

    }

    <span class="hljs-comment">// 判断 Token 是否过期</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isTokenExpired</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> token</span>) {

        final <span class="hljs-title class_">Date</span> expirationDate = <span class="hljs-title function_">getClaimFromToken</span>(token, <span class="hljs-title class_">Claims</span>::getExpiration);
        <span class="hljs-keyword">return</span> expirationDate.<span class="hljs-title function_">before</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());

    }

    <span class="hljs-comment">// 6. 辅助方法：从请求头中提取 Token（去除前缀）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">extractTokenFromHeader</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> header</span>) {

        <span class="hljs-keyword">if</span> (header != <span class="hljs-literal">null</span> &amp;&amp; header.<span class="hljs-title function_">startsWith</span>(tokenPrefix)) {
            <span class="hljs-comment">// 例如：header = "Bearer eyJhbGciOiJIUzI1NiJ9..."，返回后面的 Token 部分</span>
            <span class="hljs-keyword">return</span> header.<span class="hljs-title function_">substring</span>(tokenPrefix.<span class="hljs-title function_">length</span>()).<span class="hljs-title function_">trim</span>();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

    }

    <span class="hljs-comment">// Getter 方法（供外部获取配置参数）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getTokenHeader</span>(<span class="hljs-params"/>) {

        <span class="hljs-keyword">return</span> tokenHeader;

    }

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getTokenPrefix</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> tokenPrefix;
    }

}
</code></pre>
<h3 data-id="heading-4">四、第二步：配置 JWT 参数（避免硬编码）</h3>
<p>在 <code>src/main/resources/application.yml</code>（或 <code>application.properties</code>）中，添加 JWT 相关配置（替换硬编码，方便后续修改）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># JWT 配置</span>
<span class="hljs-attr">jwt:</span>
  <span class="hljs-attr">secret:</span> <span class="hljs-string">firstspringbootproject2025secretkeyfirstspringbootproject2025secretkeyfirstspringbootproject2025secretkey</span> <span class="hljs-comment"># 密钥（生产环境建议用 64 位以上随机字符串）</span>
<span class="hljs-comment">#  expiration: 7200000 # Token 过期时间（7200000 毫秒 = 2 小时）</span>
  <span class="hljs-attr">expiration:</span> <span class="hljs-number">1000</span> <span class="hljs-comment"># Token 过期时间（1000 毫秒 = 1 秒）</span>
  <span class="hljs-attr">header:</span> <span class="hljs-string">Authorization</span> <span class="hljs-comment"># 请求头字段名</span>
  <span class="hljs-attr">prefix:</span> <span class="hljs-string">Bearer</span>  <span class="hljs-comment"># Token 前缀（注意末尾有空格）</span>
</code></pre>
<h3 data-id="heading-5">五、第三步：实现 JWT 登录接口（替换 HTTP Basic）</h3>
<p>HTTP Basic 登录是通过浏览器弹窗输入账号密码，体验较差；我们需要自定义一个 <strong>登录接口</strong>（如 <code>/api/login</code>），客户端通过 JSON 提交账号密码，服务器验证通过后返回 JWT Token。</p>
<h4 data-id="heading-6">1. 创建登录请求参数实体类</h4>
<p>在 <code>com.example.firstspringbootproject.dto</code> 包下创建 <code>LoginRequestDTO</code>（接收客户端提交的账号密码）：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">package</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.firstspringbootproject</span><span class="hljs-selector-class">.dto</span>;

<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">io</span><span class="hljs-selector-class">.swagger</span><span class="hljs-selector-class">.v3</span><span class="hljs-selector-class">.oas</span><span class="hljs-selector-class">.annotations</span><span class="hljs-selector-class">.media</span><span class="hljs-selector-class">.Schema</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">jakarta</span><span class="hljs-selector-class">.validation</span><span class="hljs-selector-class">.constraints</span><span class="hljs-selector-class">.NotBlank</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">lombok</span><span class="hljs-selector-class">.Data</span>;

@<span class="hljs-selector-tag">Data</span>
@<span class="hljs-selector-tag">Schema</span>(name = <span class="hljs-string">"LoginRequestDTO"</span>, description = <span class="hljs-string">"登录请求参数"</span>)
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">LoginRequestDTO</span> {

    <span class="hljs-variable">@NotBlank</span>(message = <span class="hljs-string">"用户名不能为空"</span>)
    <span class="hljs-variable">@Schema</span>(description = <span class="hljs-string">"用户名"</span>, example = <span class="hljs-string">"admin"</span>)
    private String username;

    <span class="hljs-variable">@NotBlank</span>(message = <span class="hljs-string">"密码不能为空"</span>)
    <span class="hljs-variable">@Schema</span>(description = <span class="hljs-string">"密码"</span>, example = <span class="hljs-string">"123456"</span>)
    private String password;

}
</code></pre>
<h4 data-id="heading-7">2. 创建登录控制器</h4>
<p>在 <code>com.example.firstspringbootproject.controller</code> 包下创建 <code>AuthController</code>，实现登录接口：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">package</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.firstspringbootproject</span><span class="hljs-selector-class">.controller</span>;

<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.firstspringbootproject</span><span class="hljs-selector-class">.dto</span><span class="hljs-selector-class">.LoginRequestDTO</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.firstspringbootproject</span><span class="hljs-selector-class">.common</span><span class="hljs-selector-class">.Result</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.firstspringbootproject</span><span class="hljs-selector-class">.utils</span><span class="hljs-selector-class">.JwtUtil</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">io</span><span class="hljs-selector-class">.swagger</span><span class="hljs-selector-class">.v3</span><span class="hljs-selector-class">.oas</span><span class="hljs-selector-class">.annotations</span><span class="hljs-selector-class">.Operation</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">io</span><span class="hljs-selector-class">.swagger</span><span class="hljs-selector-class">.v3</span><span class="hljs-selector-class">.oas</span><span class="hljs-selector-class">.annotations</span><span class="hljs-selector-class">.tags</span><span class="hljs-selector-class">.Tag</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">jakarta</span><span class="hljs-selector-class">.validation</span><span class="hljs-selector-class">.Valid</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.beans</span><span class="hljs-selector-class">.factory</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.Autowired</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.authentication</span><span class="hljs-selector-class">.AuthenticationManager</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.authentication</span><span class="hljs-selector-class">.UsernamePasswordAuthenticationToken</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.Authentication</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.userdetails</span><span class="hljs-selector-class">.UserDetails</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.bind</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.PostMapping</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.bind</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.RequestBody</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.bind</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.RequestMapping</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.bind</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.RestController</span>;

<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.HashMap</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Map</span>;

@<span class="hljs-selector-tag">RestController</span>
@<span class="hljs-selector-tag">RequestMapping</span>(<span class="hljs-string">"/api"</span>)
@<span class="hljs-selector-tag">Tag</span>(name = <span class="hljs-string">"认证接口"</span>, description = <span class="hljs-string">"登录、Token 相关接口"</span>)
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">AuthController</span> {

    <span class="hljs-variable">@Autowired</span>
    private AuthenticationManager authenticationManager; <span class="hljs-comment">// Spring Security 认证管理器</span>

    <span class="hljs-variable">@Autowired</span>
    private JwtUtil jwtUtil; <span class="hljs-comment">// 自定义 JWT 工具类</span>

    <span class="hljs-comment">/**
     * 登录接口：接收账号密码，验证通过后返回 JWT Token
     */</span>

    <span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/login"</span>)
    <span class="hljs-variable">@Operation</span>(summary = <span class="hljs-string">"用户登录"</span>, description = <span class="hljs-string">"提交用户名和密码，获取 JWT Token"</span>)
    public Result&lt;Map&lt;String, String&gt;&gt; <span class="hljs-built_in">login</span>(<span class="hljs-variable">@Valid</span> <span class="hljs-variable">@RequestBody</span> LoginRequestDTO loginRequest) {

        <span class="hljs-comment">// 1. 调用 Spring Security 认证管理器，验证账号密码</span>
        <span class="hljs-selector-tag">Authentication</span> <span class="hljs-selector-tag">authentication</span> = <span class="hljs-selector-tag">authenticationManager</span><span class="hljs-selector-class">.authenticate</span>(
                new <span class="hljs-built_in">UsernamePasswordAuthenticationToken</span>(
                        loginRequest.<span class="hljs-built_in">getUsername</span>(),
                        loginRequest.<span class="hljs-built_in">getPassword</span>()
                )
        );

        <span class="hljs-comment">// 2. 认证通过：从认证结果中获取用户信息</span>
        <span class="hljs-selector-tag">UserDetails</span> <span class="hljs-selector-tag">userDetails</span> = (UserDetails) <span class="hljs-selector-tag">authentication</span><span class="hljs-selector-class">.getPrincipal</span>();

        <span class="hljs-comment">// 3. 生成 JWT Token</span>
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">token</span> = <span class="hljs-selector-tag">jwtUtil</span><span class="hljs-selector-class">.generateToken</span>(userDetails);

        <span class="hljs-comment">// 4. 构建返回结果（包含 Token 和过期提示）</span>
        <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">String</span>, <span class="hljs-selector-tag">String</span>&gt; <span class="hljs-selector-tag">resultMap</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">HashMap</span>&lt;&gt;();
        <span class="hljs-selector-tag">resultMap</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"token"</span>, token);
        <span class="hljs-selector-tag">resultMap</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"expiration"</span>, <span class="hljs-string">"Token 有效期 2 小时，请及时刷新"</span>);
        <span class="hljs-selector-tag">resultMap</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"role"</span>, jwtUtil.<span class="hljs-built_in">getRoleFromToken</span>(token)); <span class="hljs-comment">// 返回用户角色，方便前端处理</span>

        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.success</span>(resultMap);
    }

}
</code></pre>
<h3 data-id="heading-8">六、第四步：实现 JWT 认证过滤器（核心拦截逻辑）</h3>
<p>客户端登录成功后，后续请求会在 <code>Authorization</code> 头中携带 Token（格式：<code>Bearer eyJhbGciOiJIUzI1NiJ9...</code>）。我们需要自定义一个 <strong>过滤器</strong>，在请求到达接口前拦截 Token，完成以下操作：</p>
<ol>
<li>从请求头中提取 Token；</li>
<li>验证 Token 有效性；</li>
<li>从 Token 中解析用户信息和角色；</li>
<li>将用户信息存入 Spring Security 上下文，让后续权限校验生效。</li>
</ol>
<p>在 <code>com.example.firstspringbootproject.filter</code> 包下创建 <code>JwtAuthenticationFilter</code> 类：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> com.example.firstspringbootproject.filter;

<span class="hljs-keyword">import</span> com.example.firstspringbootproject.utils.<span class="hljs-type">JwtUtil</span>;
<span class="hljs-keyword">import</span> jakarta.servlet.<span class="hljs-type">FilterChain</span>;
<span class="hljs-keyword">import</span> jakarta.servlet.<span class="hljs-type">ServletException</span>;
<span class="hljs-keyword">import</span> jakarta.servlet.http.<span class="hljs-type">HttpServletRequest</span>;
<span class="hljs-keyword">import</span> jakarta.servlet.http.<span class="hljs-type">HttpServletResponse</span>;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.<span class="hljs-type">Autowired</span>;
<span class="hljs-keyword">import</span> org.springframework.security.authentication.<span class="hljs-type">UsernamePasswordAuthenticationToken</span>;
<span class="hljs-keyword">import</span> org.springframework.security.core.context.<span class="hljs-type">SecurityContextHolder</span>;
<span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.<span class="hljs-type">UserDetails</span>;
<span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.<span class="hljs-type">UserDetailsService</span>;
<span class="hljs-keyword">import</span> org.springframework.security.web.authentication.<span class="hljs-type">WebAuthenticationDetailsSource</span>;
<span class="hljs-keyword">import</span> org.springframework.stereotype.<span class="hljs-type">Component</span>;
<span class="hljs-keyword">import</span> org.springframework.web.filter.<span class="hljs-type">OncePerRequestFilter</span>;

<span class="hljs-keyword">import</span> java.io.<span class="hljs-type">IOException</span>;

<span class="hljs-comment">// 自定义 JWT 认证过滤器：每次请求都会执行（OncePerRequestFilter 确保一次请求只执行一次）</span>
<span class="hljs-meta">@Component</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtAuthenticationFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">OncePerRequestFilter</span> </span>{

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">JwtUtil</span> jwtUtil;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">UserDetailsService</span> userDetailsService; <span class="hljs-comment">// 之前实现的用户查询服务</span>

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> void doFilterInternal(<span class="hljs-type">HttpServletRequest</span> request,
                                    <span class="hljs-type">HttpServletResponse</span> response,
                                    <span class="hljs-type">FilterChain</span> filterChain
    ) <span class="hljs-keyword">throws</span> <span class="hljs-type">ServletException</span>, <span class="hljs-type">IOException</span> {

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 从请求头中提取 Token</span>
            <span class="hljs-type">String</span> token = jwtUtil.extractTokenFromHeader(
                    request.getHeader(jwtUtil.getTokenHeader())
            );

            <span class="hljs-comment">// 2. 验证 Token：非空 + 有效</span>
            <span class="hljs-keyword">if</span> (token != <span class="hljs-literal">null</span>) {

                <span class="hljs-comment">// 2.1 从 Token 中获取用户名</span>
                <span class="hljs-type">String</span> username = jwtUtil.getUsernameFromToken(token);

                <span class="hljs-comment">// 2.2 若用户名存在，且 Spring Security 上下文未存储用户信息（未登录）</span>
                <span class="hljs-keyword">if</span> (username != <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-type">SecurityContextHolder</span>.getContext().getAuthentication() == <span class="hljs-literal">null</span>) {

                    <span class="hljs-comment">// 2.3 从数据库查询用户完整信息（UserDetails）</span>
                    <span class="hljs-type">UserDetails</span> userDetails = userDetailsService.loadUserByUsername(username);

                    <span class="hljs-comment">// 2.4 验证 Token 有效性（未过期 + 用户名匹配）</span>
                    <span class="hljs-keyword">if</span> (jwtUtil.validateToken(token, userDetails)) {

                        <span class="hljs-comment">// 3. 构建认证对象，存入 Spring Security 上下文</span>
                        <span class="hljs-type">UsernamePasswordAuthenticationToken</span> authentication =
                                <span class="hljs-keyword">new</span> <span class="hljs-type">UsernamePasswordAuthenticationToken</span>(
                                        userDetails, <span class="hljs-comment">// 用户信息</span>
                                        <span class="hljs-literal">null</span>, <span class="hljs-comment">// 密码（已验证，无需存储）</span>
                                        userDetails.getAuthorities() <span class="hljs-comment">// 用户权限（角色）</span>
                                );

                        <span class="hljs-comment">// 设置请求详情（如 IP、会话 ID）</span>
                        authentication.setDetails(
                                <span class="hljs-keyword">new</span> <span class="hljs-type">WebAuthenticationDetailsSource</span>().buildDetails(request)
                        );

                        <span class="hljs-comment">// 将认证对象存入上下文：后续接口权限校验会从这里获取用户信息</span>
                        <span class="hljs-type">SecurityContextHolder</span>.getContext().setAuthentication(authentication);
                    }
                }
            }
        } <span class="hljs-keyword">catch</span> (<span class="hljs-type">Exception</span> e) {

            <span class="hljs-comment">// Token 验证失败（如过期、篡改），打印日志但不阻断请求（后续会返回 401）</span>
            logger.error(<span class="hljs-string">"JWT Token 验证失败："</span> + e.getMessage());

        }

        <span class="hljs-comment">// 4. 继续执行过滤器链（让请求到达后续接口或过滤器）</span>
        filterChain.doFilter(request, response);
    }

}
</code></pre>
<h3 data-id="heading-9">七、第五步：重构 SecurityConfig（适配 JWT）</h3>
<p>之前的 <code>SecurityConfig</code> 基于 HTTP Basic 登录，现在需要修改为 <strong>JWT 无状态登录</strong>，核心调整点：</p>
<ol>
<li>关闭 Session（无状态登录不需要 Session）；</li>
<li>放行登录接口（<code>/api/login</code>）；</li>
<li>将 JWT 过滤器加入过滤器链；</li>
<li>移除 HTTP Basic 配置，保留统一异常处理。</li>
</ol>
<p>修改 <code>com.example.firstspringbootproject.config.SecurityConfig</code> 类：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.example.firstspringbootproject.config;

<span class="hljs-keyword">import</span> com.example.firstspringbootproject.common.Result;
<span class="hljs-keyword">import</span> com.example.firstspringbootproject.entity.SysUser;
<span class="hljs-keyword">import</span> com.example.firstspringbootproject.filter.JwtAuthenticationFilter;
<span class="hljs-keyword">import</span> com.example.firstspringbootproject.mapper.SysUserMapper;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.<span class="hljs-keyword">annotation</span>.Autowired;
<span class="hljs-keyword">import</span> org.springframework.context.<span class="hljs-keyword">annotation</span>.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.<span class="hljs-keyword">annotation</span>.Configuration;
<span class="hljs-keyword">import</span> org.springframework.security.authentication.AuthenticationManager;
<span class="hljs-keyword">import</span> org.springframework.security.authentication.dao.DaoAuthenticationProvider;
<span class="hljs-keyword">import</span> org.springframework.security.config.<span class="hljs-keyword">annotation</span>.authentication.configuration.AuthenticationConfiguration;
<span class="hljs-keyword">import</span> org.springframework.security.config.<span class="hljs-keyword">annotation</span>.method.configuration.EnableMethodSecurity;
<span class="hljs-keyword">import</span> org.springframework.security.config.<span class="hljs-keyword">annotation</span>.web.builders.HttpSecurity;
<span class="hljs-keyword">import</span> org.springframework.security.config.<span class="hljs-keyword">annotation</span>.web.configuration.EnableWebSecurity;
<span class="hljs-keyword">import</span> org.springframework.security.config.http.SessionCreationPolicy;
<span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;
<span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;
<span class="hljs-keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
<span class="hljs-keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;
<span class="hljs-keyword">import</span> org.springframework.security.web.SecurityFilterChain;
<span class="hljs-keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableWebSecurity</span>
<span class="hljs-meta">@EnableMethodSecurity</span> <span class="hljs-comment">// 启用方法级权限控制（如 @PreAuthorize("hasRole('ADMIN')")）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SysUserMapper sysUserMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> JwtAuthenticationFilter jwtAuthenticationFilter; <span class="hljs-comment">// 自定义 JWT 过滤器</span>

    <span class="hljs-comment">// 1. 密码编码器（不变）</span>

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> PasswordEncoder passwordEncoder() {
        <span class="hljs-keyword">return</span> new BCryptPasswordEncoder();

    }

    <span class="hljs-comment">// 2. 用户详情服务（不变）</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> UserDetailsService userDetailsService() {
        <span class="hljs-keyword">return</span> username -&gt; {

            SysUser sysUser = sysUserMapper.findByUsername(username);

            <span class="hljs-keyword">if</span> (sysUser == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">throw</span> new UsernameNotFoundException(<span class="hljs-string">"用户不存在: "</span> + username);
            }
            <span class="hljs-keyword">return</span> sysUser;

        };

    }

    <span class="hljs-comment">// 3. 认证提供者（不变）</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> DaoAuthenticationProvider authenticationProvider() {

        DaoAuthenticationProvider provider = new DaoAuthenticationProvider();
        provider.setUserDetailsService(userDetailsService());
        provider.setPasswordEncoder(passwordEncoder());
        <span class="hljs-keyword">return</span> provider;
    }

    <span class="hljs-comment">// 4. 认证管理器（不变）</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> AuthenticationManager authenticationManager(AuthenticationConfiguration config) throws Exception {
        <span class="hljs-keyword">return</span> config.getAuthenticationManager();
    }

    <span class="hljs-comment">// 5. 核心规则配置（重点修改：适配 JWT）</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {

        http
                <span class="hljs-comment">// 1. 关闭 CSRF（前后端分离必须关）</span>
                .csrf(csrf -&gt; csrf.disable())
                <span class="hljs-comment">// 2. 关闭 Session（无状态登录核心：不创建和使用 Session）</span>
                .sessionManagement(session -&gt; session
                        .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
                )
                <span class="hljs-comment">// 3. 配置接口访问规则（调整放行接口）</span>
                .authorizeHttpRequests(auth -&gt; auth
                        <span class="hljs-comment">// ① 放行：接口文档（Knife4j）、登录接口</span>
                        .requestMatchers(<span class="hljs-string">"/doc.html"</span>, <span class="hljs-string">"/webjars/**"</span>, <span class="hljs-string">"/v3/api-docs/**"</span>, <span class="hljs-string">"/api/login"</span>).permitAll()
                        <span class="hljs-comment">// ② 管理员接口：仅 ADMIN 可访问</span>
                        .requestMatchers(<span class="hljs-string">"/api/user/all"</span>).hasRole(<span class="hljs-string">"ADMIN"</span>)
                        <span class="hljs-comment">// ③ 普通用户接口：USER/ADMIN 可访问</span>
                        .requestMatchers(<span class="hljs-string">"/api/user/**"</span>, <span class="hljs-string">"/api/product/**"</span>).hasAnyRole(<span class="hljs-string">"USER"</span>, <span class="hljs-string">"ADMIN"</span>)
                        <span class="hljs-comment">// ④ 其他接口：必须登录（Token 有效）</span>
                        .anyRequest().authenticated()
                )

                <span class="hljs-comment">// 4. 加入 JWT 过滤器：在 UsernamePasswordAuthenticationFilter 之前执行</span>
                <span class="hljs-comment">// （先验证 Token，再执行后续认证逻辑）</span>
                .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.<span class="hljs-keyword">class</span>)
                <span class="hljs-comment">// 5. 统一异常处理（不变：未登录返回 401，权限不足返回 403）</span>
                .exceptionHandling(ex -&gt; ex
                        .authenticationEntryPoint((request, response, authException) -&gt; {
                            response.setContentType(<span class="hljs-string">"application/json;charset=UTF-8"</span>);
                            Result&lt;<span class="hljs-built_in">Void</span>&gt; result = Result.error(<span class="hljs-number">401</span>, <span class="hljs-string">"未登录或 Token 已过期，请重新登录"</span>);
                            response.getWriter().write(objectMapper.writeValueAsString(result));
                        })
                        .accessDeniedHandler((request, response, accessDeniedException) -&gt; {
                            response.setContentType(<span class="hljs-string">"application/json;charset=UTF-8"</span>);
                            Result&lt;<span class="hljs-built_in">Void</span>&gt; result = Result.error(<span class="hljs-number">403</span>, <span class="hljs-string">"权限不足，无法访问"</span>);
                            response.getWriter().write(objectMapper.writeValueAsString(result));
                        })
                );

        <span class="hljs-comment">// 关联认证提供者</span>
        http.authenticationProvider(authenticationProvider());
        <span class="hljs-keyword">return</span> http.build();

    }

}
</code></pre>
<h3 data-id="heading-10">八、第六步：测试 JWT 无状态登录流程</h3>
<p>启动项目，用 Apifox 测试完整流程，验证无状态登录和权限控制是否生效：</p>
<h4 data-id="heading-11">1. 测试 1：调用登录接口，获取 Token</h4>
<ul>
<li><strong>请求地址</strong>：<code>http://localhost:8080/api/login</code></li>
<li><strong>请求方法</strong>：POST</li>
<li><strong>请求体（JSON）</strong> ：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"username"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"admin"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"password"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"123456"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><strong>响应结果（成功）</strong> ：</li>
</ul>
<pre><code class="hljs language-css" lang="css">{
    "<span class="hljs-selector-tag">code</span>": <span class="hljs-number">200</span>,
    <span class="hljs-string">"msg"</span>: <span class="hljs-string">"success"</span>,
    <span class="hljs-string">"data"</span>: {
        "role": <span class="hljs-string">"ROLE_ADMIN"</span>,
        <span class="hljs-string">"expiration"</span>: <span class="hljs-string">"Token 有效期 2 小时，请及时刷新"</span>,
        <span class="hljs-string">"token"</span>: <span class="hljs-string">"eyJhbGciOiJIUzUxMiJ9.eyJyb2xlcyI6WyJST0xFX0FETUlOIl0sInN1YiI6ImFkbWluIiwiaWF0IjoxNzYzNDgxMDk0LCJleHAiOjE3NjM0ODgyOTR9.hSxBCTlQo5tUai-knfM2Sh4nVmehizOslcHkvG86jdC-U7-EztskPkF0r4G0DcaTMV3eFcJUu4pCewDdnniq2A"</span>
    }
}
</code></pre>
<p>复制返回的 <code>token</code>，后续请求会用到。</p>
<h4 data-id="heading-12">2. 测试 2：携带 Token 访问管理员接口</h4>
<ul>
<li><strong>请求地址</strong>：<code>http://localhost:8080/api/user/all</code>（需 ADMIN 角色）</li>
<li><strong>请求方法</strong>：GET</li>
<li><strong>请求头</strong>：添加 <code>Authorization: Bearer eyJhbGciOiJIUzUxMiJ9.eyJyb2xlcyI6WyJST0xFX0FETUlOIl0sInN1YiI6ImFkbWluIiwiaWF0IjoxNzYzNDgxMDk0LCJleHAiOjE3NjM0ODgyOTR9.hSxBCTlQo5tUai-knfM2Sh4nVmehizOslcHkvG86jdC-U7-EztskPkF0r4G0DcaTMV3eFcJUu4pCewDdnniq2A</code>（注意 <code>Bearer</code> 后有空格）</li>
<li><strong>响应结果（成功）</strong> ：</li>
</ul>
<pre><code class="hljs language-css" lang="css">{
    "<span class="hljs-selector-tag">code</span>": <span class="hljs-number">200</span>,
    <span class="hljs-string">"msg"</span>: <span class="hljs-string">"success"</span>,
    <span class="hljs-string">"data"</span>: [
        {
            "id": <span class="hljs-number">1</span>,
            <span class="hljs-string">"name"</span>: <span class="hljs-string">"小明"</span>,
            <span class="hljs-string">"age"</span>: <span class="hljs-number">20</span>,
            <span class="hljs-string">"phone"</span>: <span class="hljs-string">"13800138000"</span>
        },
        {
            "id": <span class="hljs-number">2</span>,
            <span class="hljs-string">"name"</span>: <span class="hljs-string">"小红"</span>,
            <span class="hljs-string">"age"</span>: <span class="hljs-number">19</span>,
            <span class="hljs-string">"phone"</span>: <span class="hljs-string">"13900139000"</span>
        },
        {
            "id": <span class="hljs-number">3</span>,
            <span class="hljs-string">"name"</span>: <span class="hljs-string">"小李"</span>,
            <span class="hljs-string">"age"</span>: <span class="hljs-number">22</span>,
            <span class="hljs-string">"phone"</span>: <span class="hljs-string">"13700137000"</span>
        }
    ]
}
</code></pre>
<h4 data-id="heading-13">3. 测试 3：普通用户 Token 访问管理员接口（权限不足）</h4>
<ul>
<li>先用 <code>zhangsan</code>（密码 123456）调用登录接口，获取普通用户 Token；</li>
<li>携带普通用户 Token 访问 <code>http://localhost:8080/api/user/all</code>；</li>
<li><strong>响应结果（失败）</strong> ：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">403</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"msg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"权限不足，无法访问"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-14">4. 测试 4：Token 过期（模拟）</h4>
<ul>
<li>修改 <code>application.yml</code> 中 <code>jwt.expiration</code> 为 <code>1000</code>（1 秒过期）；</li>
<li>重新登录获取 Token，1 秒后携带 Token 访问接口；</li>
<li><strong>响应结果（失败）</strong> ：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">401</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"msg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"未登录或 Token 已过期，请重新登录"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-15">九、常见问题与优化建议</h3>
<h4 data-id="heading-16">1. 问题：Token 被盗用怎么办？</h4>
<ul>
<li><strong>原因</strong>：JWT Token 一旦生成，在过期前无法主动作废；</li>
<li><strong>解决方案</strong>：</li>
</ul>
<ol>
<li>缩短 Token 过期时间（如 30 分钟），同时实现 <strong>Token 刷新接口</strong>（用旧 Token 换取新 Token，避免频繁登录）；</li>
<li>维护一个 <strong>黑名单</strong>（如 Redis），用户登出或 Token 被盗时，将 Token 加入黑名单，验证时先检查是否在黑名单中。</li>
</ol>
<h4 data-id="heading-17">2. 问题：密钥（secret）泄露怎么办？</h4>
<ul>
<li><strong>原因</strong>：密钥是 JWT 安全的核心，泄露后攻击者可伪造 Token；</li>
<li><strong>解决方案</strong>：</li>
</ul>
<ol>
<li>生产环境中，密钥通过 <strong>环境变量</strong> 或 <strong>配置中心</strong> 注入，不写入代码或配置文件；</li>
<li>使用 <strong>非对称加密算法</strong>（如 RS256），用私钥生成 Token，公钥验证 Token，私钥严格保密。</li>
</ol>
<h4 data-id="heading-18">## 十、总结：JWT 无状态登录的核心价值</h4>
<p>通过本文的改造，我们实现了 Spring Boot + Spring Security + JWT 的无状态登录，核心优势总结如下：</p>
<ol>
<li><strong>分布式友好</strong>：服务器无需存储 Session，多台服务器可直接共用 Token 验证逻辑；</li>
<li><strong>前后端分离适配</strong>：通过请求头携带 Token，无需依赖 Cookie，适配移动端、小程序等多端场景；</li>
<li><strong>安全性提升</strong>：Token 包含过期时间和加密签名，避免身份信息被篡改；</li>
<li><strong>扩展性强</strong>：Token 可自定义存储用户角色、权限等信息，减少数据库查询次数。</li>
</ol>
<p>至此，恭喜你已具备初级程序员开发水平，可以试着投简历找工作啦。</p>
<blockquote>
<p>👉 关注 + 私信 “Web基础源码”，获取本文完整工程！有问题评论区见～</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[光图片就300多M，微信小游戏给再大的分包也难啊！]]></title>    <link>https://juejin.cn/post/7574991051436097546</link>    <guid>https://juejin.cn/post/7574991051436097546</guid>    <pubDate>2025-11-22T00:06:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574991051436097546" data-draft-id="7574269207363076105" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="光图片就300多M，微信小游戏给再大的分包也难啊！"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-22T00:06:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亿元程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1972988307323236"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            光图片就300多M，微信小游戏给再大的分包也难啊！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972988307323236/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亿元程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T00:06:53.000Z" title="Sat Nov 22 2025 00:06:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>点击上方亿元程序员+关注和★星标</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbc09c62192e409f94baf3b9690e2e91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=hsvHgWUS2WhB4gFbxgLkekcSRJU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p><strong>哈喽大家好</strong>，有小伙伴说他们公司的游戏项目，光图片资源就高达<code>300M</code>，最近正在考虑上架微信小游戏。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2066feb13c464154af9e7fef249691d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=w1Q0r2k0X8puFWZJo7li%2F3zdlSw%3D" alt="" loading="lazy"/></p>
<p><strong>但是</strong>，如此庞大的游戏资源，想通过分包的形式肯定是不行的，只能放到服务器上，通过<code>CDN</code>让玩家下载。</p>
<p><strong>笔者还是很好奇</strong>，什么样的资源如此巨大，通过对小伙伴的<strong>深入了解</strong>。</p>
<p><strong>惊讶发现</strong>，他们的图片资源居然没有压缩！且不说图片是否过于精致、美术手笔是否过于奔放，不压缩实在是太难受了！</p>
<p><strong>言归正传</strong>，本期将带小伙伴们一起来看下，在<code>Cocos</code>游戏开发中，如何省心省力地压缩图片，<code>330M</code>能压缩到多少。</p>
<p><strong>本文源工程可在文末获取，小伙伴们自行前往。</strong></p>
<h2 data-id="heading-1">图片压缩</h2>
<blockquote>
<p><strong>图片压缩</strong>是一种在尽可能保持图片质量的前提下，减小PNG文件大小的技术。</p>
</blockquote>
<p><strong>游戏开发</strong>中常用的图片压缩工具有<code>TinyPNG</code>、<code>pngquant</code>、<code>Compressor.io</code>等等。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5a6b7ca35354e23afc6f21f57db86d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=ELwP%2FxRh6xKWwOPUmaGFyvP3O4Y%3D" alt="" loading="lazy"/></p>
<p><code>pngquant</code>是一款用于PNG图像有损压缩的命令行工具和函数库。</p>
<p><strong>该转换工具</strong>能显著减小文件大小（通常高达<code>70%</code>），同时保持完整的<code>Alpha</code>通道透明度。生成的图像兼容所有主流网页浏览器和操作系统。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c21cf91c016b4c7e9a7c9cb42261c7c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=ABlz4ICbe0zXj3OUW0kIr7zt2aQ%3D" alt="" loading="lazy"/></p>
<p><strong>常用</strong>的参数包括：</p>
<ul>
<li><strong>quality min-max</strong>：质量，使用满足或超过“最大质量”所需的最少颜色数量。若转换后的质量低于“最低质量”要求，图像将不会被保存。</li>
<li><strong>speed N</strong>：速度，从<code>1</code>（暴力）到<code>10</code>（最快）。默认为<code>3</code>。速度<code>10</code>的质量降低<code>5%</code>，但比默认速度快<code>8</code>倍。</li>
</ul>
<h2 data-id="heading-2">图片压缩实例</h2>
<p><strong>下面</strong>一起来看下，在<code>Cocos</code>游戏开发中，如何通过插件集成到项目，使其构建后自动压缩图片。</p>
<h3 data-id="heading-3">1.资源准备</h3>
<p><strong>先准备</strong>一张<code>PNG</code>图片，原图大小<code>0.97M</code>，用来确认压缩是否成功，压缩质量如何。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e53e053964b4012aca555b60a3c960d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=%2FWNMI68F89Ro%2FLMxePQzpqDEiwk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">2.创建扩展</h3>
<p><strong>新建</strong>一个项目，通过菜单<code>扩展-&gt;创建扩展</code>打开扩展创建面板。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/981246b0cffe4757a85b779b56633feb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=jFbkGayKUQQqvpuIazBfOv1yees%3D" alt="" loading="lazy"/></p>
<p><strong>我们选择</strong>构建插件，这是官方自定义构建插件的一个简单示例，点击创建扩展，我们直接在上面扩展我们的自动压缩。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05a3c4c89607467686ba1f2f3d48d24b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=rodimWz7EF92karm679PyenHPBE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">3.启用扩展</h3>
<p><strong>通过</strong>菜单<code>扩展-&gt;扩展管理器</code>打开扩展管理器，在已安装扩展中找到我们新建的插件，将其改成开启状态。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/465a0f954acc419fb5c198282b834872~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=4JvqFHoiW06xlvOIGG17t9QRWdU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">4.扩展界面</h3>
<p><strong>首先</strong>我们删掉我们不需要的<code>asset-handlers.ts</code>和<code>panel.ts</code>·，在<code>builder.ts</code>中只保留<code>hooks</code>配置。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b1efbecbc664d18a9f5164a8c173820~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=eFokhipz4Omu7nkopZZH63zs1jU%3D" alt="" loading="lazy"/></p>
<p><strong>接下来</strong>我们给构建面板加上一组配置，用来控制压缩是否开启、压缩的质量以及压缩的速度：</p>
<p><strong>代码</strong>整理如下：</p>
<ul>
<li><strong>启用复选框</strong>（ui-checkbox）：默认不开启。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3662259cd77a4ba58b25da9e2fdf0278~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=0KsWYOcifuW682blzoeFOZwtVFg%3D" alt="" loading="lazy"/></li>
<li><strong>最小质量滑块</strong>（ui-slider）：<code>0-100</code>，默认<code>65</code>，步进<code>1</code>。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86eb29babec341c2a83deafd98433c77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=SUWSw5wM2CTpiqAZtDBLWVSeO30%3D" alt="" loading="lazy"/></li>
<li><strong>最大质量滑块</strong>（ui-slider）：<code>0-100</code>，默认<code>80</code>，步进<code>1</code>。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6f567a3570344e1ae908383059b5f80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=EvCPx6zeWOL2UMEeLQXsINIaTXg%3D" alt="" loading="lazy"/></li>
<li><strong>速度滑块</strong>（ui-slider）：<code>1-10</code>，默认<code>3</code>，步进<code>1</code>。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40b1baddc0ef4c2d84847e13fb0dd4da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=KZ6F53fujTsWRzmHY9S4xJwc3GY%3D" alt="" loading="lazy"/></li>
<li><strong>校验最大质量&gt;=最小质量</strong>:
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb723730b83e4cd7a84873b890ea7320~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=f1BieoHQpgvtIFLLqjiYgWdtnm4%3D" alt="" loading="lazy"/></li>
</ul>
<p><strong>最后</strong>通过<code>npm install</code>和<code>npm run build</code>编译即可。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9dc8fd1db82c4707a9a8b876b80fe03c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=wuKxh92xl8wloQ%2F99R2LcW%2F4W5s%3D" alt="" loading="lazy"/></p>
<p><strong>打开</strong>构建面板就可以看到我们添加的内容：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f09648112a8645af92dd1a05205a7887~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=zZxAFXheaVUKmeT1wUWZCYhOwJ4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">5.构建后压缩</h3>
<p><strong>界面</strong>控制添加完之后，我们需要把<code>pngquant压缩</code>植入到构建完成的钩子（<code>onAfterBuild</code>）里，使其构建完成后自动按照配置的参数进行压缩。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/855ca681e05c4463b4aca0a6bfbfedc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=WUtzrK7WPNmOZwztSSElM1LnIG8%3D" alt="" loading="lazy"/></p>
<p><strong>代码</strong>整理如下：</p>
<ul>
<li><strong>检查</strong>是否启用了质量控制：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5e4b32642014e198f3d611eaa356677~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=QWiXh13B10V07Jzxk2HR1xVhlqs%3D" alt="" loading="lazy"/></li>
<li><strong>提前</strong>准备好压缩的工具，这里包括<strong>win</strong>和<strong>mac</strong>的，并且根据系统选择：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/633f808ba8bb4cb182c47ff7ed00b4cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=800zDDbc2V3eFjci%2F1pTqrSdbZ4%3D" alt="" loading="lazy"/></li>
<li><strong>在构建后目录</strong>递归查找所有图片文件：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa08c16bba334bccb449d17ab1f93c80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=8H4rKaQPmA8f8KepGErzJT3LseE%3D" alt="" loading="lazy"/></li>
<li><strong>组装命令开始逐个压缩</strong>：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a00e01a3b1a74589b8745a25a68aa468~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=LRuT%2FeTlN9gYqKhyG4wpyopDl%2Fs%3D" alt="" loading="lazy"/></li>
</ul>
<h3 data-id="heading-8">6.测试</h3>
<p><strong>编译</strong>代码后，打开我们的构建面板，开始进行构建，构建完成后可以点开日志查看：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c67114a52ec4d2b8e70d9163662edf7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=uCiXLPfM7cDHDq8KA4hwIDS7fx0%3D" alt="" loading="lazy"/></p>
<p><strong>从日志</strong>可以看出<code>原文件大小: 1002.9KB, 压缩后大小: 179.6KB, 压缩了82.1%</code>，提示压缩成功。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78200b21b2de40eebb779eff70784e01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=ZJ0S1bI%2BwKWT4JzwkUo66EdmEVI%3D" alt="" loading="lazy"/></p>
<p><strong>打开</strong>构建好的目录，找到我们的资源，可以看到已经压缩完成：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0bb767a138464086a3dcb4f29bdfb039~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=hzeu0zYvUXwFz8kwvcvdO3ewGlI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">图片压缩进阶</h2>
<h3 data-id="heading-10">1.过滤</h3>
<p><strong>通常</strong>游戏中会有一些图片为了避免模糊，例如主界面，会通过配置的或者特殊文件名开头的形式进行过滤，不进行压缩，小伙伴们在面板或者文件配置，然后压缩前过滤即可。</p>
<h3 data-id="heading-11">2.记录</h3>
<p><strong>图片比较多</strong>，每次构建耗时比较长的话，可以把压缩提前到构建之前，并通过<code>MD5</code>记录表示图片已经压缩，直接跳过该文件，避免重复压缩。</p>
<h2 data-id="heading-12">结语</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2641cebd78ea4a40b54ad8cc2ec0f8c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764374812&amp;x-signature=cSNnv8pSVPiBJ8VO3SG48X7m4tA%3D" alt="" loading="lazy"/></p>
<p><strong>通过</strong>压缩，小伙伴的图片资源从<code>330M</code>降到了<code>273M</code>，压缩了<code>18%</code>。感觉剩余资源还是比较大，建议从其他方式进行检查和处理，例如<strong>查找没依赖的资源删除</strong>、<strong>找美术重造</strong>等等。</p>
<p><strong>不知道小伙伴们有没有其他更好的办法呢？</strong></p>
<p>本文<strong>源工程</strong>可通过<strong>私信</strong>发送 <strong>PngExtension</strong> 获取。</p>
<p><strong>我是"亿元程序员"，一位有着8年游戏行业经验的主程。在游戏开发中，希望能给到您帮助, 也希望通过您能帮助到大家。</strong></p>
<p>AD:笔者线上的小游戏《打螺丝闯关》《贪吃蛇掌机经典》《重力迷宫球》《填色之旅》《方块掌机经典》大家可以自行点击搜索体验。</p>
<p>实不相瞒，想要个<strong>赞</strong>和<strong>爱心</strong>！请把该文章<strong>分享</strong>给你觉得有需要的其他小伙伴。谢谢！</p>
<p>推荐专栏：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3175880857546129410%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3175880857546129410#wechat_redirect" ref="nofollow noopener noreferrer">知识付费专栏</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26mid%3D2247487282%26idx%3D1%26sn%3De3cb8ab6f5c0d5f804d5c29e2e90b9ad%26chksm%3Dc00daec5f77a27d33933e877464d8cde24c4c947d3755f5e8262c634634617e7c26de3953a54%26token%3D336413522%26lang%3Dzh_CN%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=Mzg5NTY2MjIzMg==&amp;mid=2247487282&amp;idx=1&amp;sn=e3cb8ab6f5c0d5f804d5c29e2e90b9ad&amp;chksm=c00daec5f77a27d33933e877464d8cde24c4c947d3755f5e8262c634634617e7c26de3953a54&amp;token=336413522&amp;lang=zh_CN#rd" ref="nofollow noopener noreferrer">你知道和不知道的微信小游戏常用API整理，赶紧收藏用起来~</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3207702867494305797%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3207702867494305797#wechat_redirect" ref="nofollow noopener noreferrer">100个Cocos实例</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3073771187570999299%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3073771187570999299#wechat_redirect" ref="nofollow noopener noreferrer">8年主程手把手打造Cocos独立游戏开发框架</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3121583619634626562%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3121583619634626562#wechat_redirect" ref="nofollow noopener noreferrer">和8年游戏主程一起学习设计模式</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3Faction%3Dgetalbum%26__biz%3DMzg5NTY2MjIzMg%3D%3D%26scene%3D1%26album_id%3D3038883468588089350%26count%3D3%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?action=getalbum&amp;__biz=Mzg5NTY2MjIzMg==&amp;scene=1&amp;album_id=3038883468588089350&amp;count=3#wechat_redirect" ref="nofollow noopener noreferrer">从零开始开发贪吃蛇小游戏到上线系列</a></p>
<p>点击下方灰色按钮+关注。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React性能翻倍！90%开发者忽略的5个Hooks最佳实践]]></title>    <link>https://juejin.cn/post/7575015480198610996</link>    <guid>https://juejin.cn/post/7575015480198610996</guid>    <pubDate>2025-11-22T00:17:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575015480198610996" data-draft-id="7574992086715809807" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React性能翻倍！90%开发者忽略的5个Hooks最佳实践"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-22T00:17:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_陈寒"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React性能翻倍！90%开发者忽略的5个Hooks最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_陈寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-22T00:17:36.000Z" title="Sat Nov 22 2025 00:17:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>React性能翻倍！90%开发者忽略的5个Hooks最佳实践</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>React Hooks自2019年推出以来，彻底改变了开发者编写React组件的方式。它们提供了更简洁的代码组织和更好的逻辑复用能力。然而，随着Hooks的普及，许多开发者在使用过程中忽略了其性能优化的潜力。事实上，通过遵循一些最佳实践，你可以显著提升React应用的性能，甚至在某些场景下实现性能翻倍的效果。</p>
<p>本文将深入探讨5个被90%开发者忽略的Hooks最佳实践，这些实践不仅能优化渲染性能，还能减少不必要的副作用和内存消耗。无论你是React新手还是资深开发者，这些技巧都将帮助你写出更高效的代码。</p>
<hr/>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. 合理使用<code>useMemo</code>和<code>useCallback</code>：避免不必要的计算和重渲染</h3>
<h4 data-id="heading-4">问题背景</h4>
<p>许多开发者过度依赖<code>useMemo</code>和<code>useCallback</code>，认为它们能“自动”优化性能。然而，滥用这两个Hook反而会增加内存开销（因为需要存储额外的依赖项和缓存值）。关键在于<strong>只在必要时使用它们</strong>。</p>
<h4 data-id="heading-5">最佳实践</h4>
<ul>
<li><strong>何时用<code>useMemo</code></strong>：当计算成本高昂（如大型数组排序、复杂对象推导）且依赖项变化不频繁时。</li>
<li><strong>何时用<code>useCallback</code></strong>：当函数作为子组件的props传递且子组件依赖引用相等性（如<code>React.memo</code>优化的组件）。</li>
<li><strong>反例</strong>：对简单计算或高频更新的值使用这些Hook可能得不偿失。</li>
</ul>
<h4 data-id="heading-6">示例代码</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> expensiveValue = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">computeExpensiveValue</span>(a, b), [a, b]);
<span class="hljs-keyword">const</span> handleClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">doSomething</span>(a, b), [a, b]);
</code></pre>
<h4 data-id="heading-7">数据支持</h4>
<p>根据React官方文档，<code>useMemo</code>和<code>useCallback</code>的开销约为每次渲染额外0.1ms~0.5ms（取决于环境）。因此，只有当计算成本高于此阈值时才值得使用。</p>
<hr/>
<h3 data-id="heading-8">2. <code>useEffect</code>的依赖数组陷阱：正确处理副作用</h3>
<h4 data-id="heading-9">问题背景</h4>
<p>许多开发者会在依赖数组中遗漏关键变量或盲目包含所有变量，导致无限循环或不必要的副作用执行。</p>
<h4 data-id="heading-10">最佳实践</h4>
<ul>
<li><strong>最小化依赖项</strong>：只包含真正影响副作用的变量。如果某些变量是稳定的（如dispatch函数），可以安全省略。</li>
<li><strong>使用函数式更新</strong>：对于基于前值的状态更新（如计数器），使用回调形式避免依赖当前状态值：
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> interval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>); <span class="hljs-comment">// ✅ No dependency on `count`</span>
  }, <span class="hljs-number">1000</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(interval);
}, []);
</code></pre>
</li>
<li><strong>拆分无关逻辑</strong>：将不相关的副作用拆分到多个<code>useEffect</code>中。</li>
</ul>
<hr/>
<h3 data-id="heading-11">3. <code>useReducer</code>:  复杂状态管理的秘密武器</h3>
<h4 data-id="heading-12">问题背景</h4>
<p>当状态逻辑变得复杂时（多个相互关联的状态、嵌套更新），单纯用多个<code>useState</code>会导致代码臃肿且难以维护。</p>
<h4 data-id="heading-13">最佳实践</h4>
<ul>
<li><strong>适用场景</strong>：
<ol>
<li>state之间存在复杂关系（如表单验证）。</li>
<li>state更新逻辑涉及多步操作。</li>
<li>state结构较深（需深层更新）。</li>
</ol>
</li>
<li><strong>优势</strong>：
<ol>
<li><strong>集中化逻辑</strong>：将所有状态变更集中在reducer中。</li>
<li><strong>性能优化</strong>：减少触发多次渲染的风险。</li>
<li><strong>可测试性</strong>：纯函数reducer易于单元测试。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-14">示例代码</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useReducer</span>(reducer, initialState);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">reducer</span>(<span class="hljs-params">state, action</span>) {
  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'increment'</span>:
      <span class="hljs-keyword">return</span> { ...state, <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> + action.<span class="hljs-property">payload</span> };
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>();
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-15">4. <code>useRef</code>:  不只是DOM引用的工具</h3>
<h4 data-id="heading-16">Problem Background</h4>
<p>大多数开发者仅用ref来访问DOM元素，却忽略了它在存储可变值时的价值——尤其是在不需要触发重新渲染的场景中。</p>
<h4 data-id="heading-17">Best Practices</h4>
<ol>
<li><strong>跨渲染持久化数据</strong>:</li>
</ol>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> renderCount = <span class="hljs-title function_">useRef</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// Won't trigger re-render when changed</span>
</code></pre>
<ol start="2">
<li><strong>存储定时器/订阅ID</strong>:</li>
</ol>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
 timerRef.<span class="hljs-property">current</span> = <span class="hljs-built_in">setInterval</span>(...);
 <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timerRef.<span class="hljs-property">current</span>);
}, []);
</code></pre>
<ol start="3">
<li><strong>避免闭包陷阱</strong>:</li>
</ol>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> latestValue = <span class="hljs-title function_">useRef</span>(value);
latestValue.<span class="hljs-property">current</span> = value; <span class="hljs-comment">// Always up-to-date in callbacks</span>
</code></pre>
<hr/>
<p>###5．自定义Hook的组合艺术</p>
<p>####Why It Matters<br/>
自定义Hook是React逻辑复用的终极方案──但设计不当会导致性能黑洞或违反Hook规则.</p>
<p>####Golden Rules<br/>
✅以"use"前缀命名(强制ESLint检查)<br/>
✅隔离无关联逻辑到独立Hooks<br/>
✅返回稳定引用:利用memoization保证返回值一致性</p>
<p>Example: Optimized Data Fetching Hook</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useUserData</span>(<span class="hljs-params">userId</span>) {      
 <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);      
 <span class="hljs-keyword">const</span> [error, setError] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);      

 <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {        
    <span class="hljs-keyword">let</span> didCancel = <span class="hljs-literal">false</span>;        

    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/users/<span class="hljs-subst">${userId}</span>`</span>)          
     .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> !didCancel &amp;&amp; <span class="hljs-title function_">setData</span>(res))          
     .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> !didCancel &amp;&amp; <span class="hljs-title function_">setError</span>(err));        

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> { didCancel = <span class="hljs-literal">true</span> };      
 }, [userId]);      

 <span class="hljs-keyword">return</span> { data, error };    
}    
</code></pre>
<hr/>
<h2 data-id="heading-18">Conclusion</h2>
<p>Mastering React Hooks isn't just about knowing their API surface—it's about deeply understanding their performance characteristics and composing them effectively．The five practices we've covered today:</p>
<p>1️⃣ Strategic memoization with <code>useMemo/useCallback</code>
2️⃣ Precise dependency management in <code>useEffect</code>
3️⃣ Leveraging <code>useReducer</code>s for complex state flows
4️⃣ Unlocking the full potential of <code>useRef</code>
5️⃣ Designing high-performance custom Hooks</p>
<p>Adopting these patterns can lead to dramatic performance improvements—sometimes even doubling rendering speeds in heavy component trees．The key is thoughtful application rather than blind adherence．</p>
<p>Remember: Premature optimization is still the root of all evil．Profile first with React DevTools before applying these techniques!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（138） Redis的模块如何开发？]]></title>    <link>https://juejin.cn/post/7575004291833102387</link>    <guid>https://juejin.cn/post/7575004291833102387</guid>    <pubDate>2025-11-21T23:05:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575004291833102387" data-draft-id="7575017581036781606" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（138） Redis的模块如何开发？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-21T23:05:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（138） Redis的模块如何开发？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T23:05:43.000Z" title="Fri Nov 21 2025 23:05:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis 模块开发是一种扩展 Redis 功能的强大方式。通过模块，开发者可以向 Redis 添加新的命令、数据类型、事件处理器等。以下是开发 Redis 模块的详细步骤，包括必要的代码示例。</p>
<h3 data-id="heading-0">1. 包含必要的头文件</h3>
<p>首先，需要包含 Redis 模块 API 的头文件 <code>redismodule.h</code>。该头文件定义了开发模块所需的所有函数和宏。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"redismodule.h"</span></span>
</code></pre>
<h3 data-id="heading-1">2. 实现模块命令</h3>
<p>每个模块命令对应一个处理函数。这些函数需要遵循特定的签名，即返回 <code>int</code> 类型，并接受 <code>RedisModuleCtx *ctx, RedisModuleString **argv, int argc</code> 作为参数。</p>
<p>下面是一个简单的命令处理函数示例，该命令返回 "Hello, World!" 字符串。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">HelloWorldCommand</span><span class="hljs-params">(RedisModuleCtx *ctx, RedisModuleString **argv, <span class="hljs-type">int</span> argc)</span> {
    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> RedisModule_WrongArity(ctx);
    }
    RedisModule_ReplyWithSimpleString(ctx, <span class="hljs-string">"Hello, World!"</span>);
    <span class="hljs-keyword">return</span> REDISMODULE_OK;
}
</code></pre>
<h3 data-id="heading-2">3. 模块初始化函数</h3>
<p>模块初始化函数用于注册模块和命令。通过调用 <code>RedisModule_Init</code> 函数初始化模块，并使用 <code>RedisModule_CreateCommand</code> 函数注册命令。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">RedisModule_OnLoad</span><span class="hljs-params">(RedisModuleCtx *ctx, RedisModuleString **argv, <span class="hljs-type">int</span> argc)</span> {
    <span class="hljs-keyword">if</span> (RedisModule_Init(ctx, <span class="hljs-string">"hello"</span>, <span class="hljs-number">1</span>, REDISMODULE_APIVER_1) == REDISMODULE_ERR) {
        <span class="hljs-keyword">return</span> REDISMODULE_ERR;
    }
    <span class="hljs-keyword">if</span> (RedisModule_CreateCommand(ctx, <span class="hljs-string">"hello.world"</span>, HelloWorldCommand, <span class="hljs-string">"readonly"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) == REDISMODULE_ERR) {
        <span class="hljs-keyword">return</span> REDISMODULE_ERR;
    }
    <span class="hljs-keyword">return</span> REDISMODULE_OK;
}
</code></pre>
<h3 data-id="heading-3">4. 编译模块</h3>
<p>将上述代码保存为 <code>hello.c</code> 文件，并通过以下命令编译为动态库：</p>
<pre><code class="hljs language-sh" lang="sh">gcc -fPIC -shared -o hello.so hello.c -I/path/to/redis/src
</code></pre>
<p>注意：<code>-fPIC</code> 选项用于生成位置无关代码，<code>-shared</code> 选项用于生成共享库，<code>-I</code> 选项指定 Redis 源代码的路径。</p>
<h3 data-id="heading-4">5. 加载和使用模块</h3>
<p>通过 Redis 客户端加载模块：</p>
<pre><code class="hljs language-sh" lang="sh">redis-cli MODULE LOAD ./hello.so
</code></pre>
<p>加载成功后，可以使用新命令 <code>hello.world</code>：</p>
<pre><code class="hljs language-sh" lang="sh">redis&gt; hello.world
<span class="hljs-string">"Hello, World!"</span>
</code></pre>
<h3 data-id="heading-5">复杂模块示例：计数器模块</h3>
<p>接下来，我们实现一个简单的计数器模块，该模块支持两个命令 <code>counter.incr</code> 和 <code>counter.get</code>，分别用于增加计数器和获取当前计数。</p>
<h4 data-id="heading-6">1. 包含头文件</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"redismodule.h"</span></span>
</code></pre>
<h4 data-id="heading-7">2. 定义全局变量</h4>
<p>定义一个全局变量表示计数器的值。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> counter = <span class="hljs-number">0</span>;
</code></pre>
<h4 data-id="heading-8">3. 实现命令处理函数</h4>
<p>实现 <code>counter.incr</code> 和 <code>counter.get</code> 命令的处理函数。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">CounterIncrCommand</span><span class="hljs-params">(RedisModuleCtx *ctx, RedisModuleString **argv, <span class="hljs-type">int</span> argc)</span> {
    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> RedisModule_WrongArity(ctx);
    }
    counter++;
    RedisModule_ReplyWithLongLong(ctx, counter);
    <span class="hljs-keyword">return</span> REDISMODULE_OK;
}

<span class="hljs-type">int</span> <span class="hljs-title function_">CounterGetCommand</span><span class="hljs-params">(RedisModuleCtx *ctx, RedisModuleString **argv, <span class="hljs-type">int</span> argc)</span> {
    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> RedisModule_WrongArity(ctx);
    }
    RedisModule_ReplyWithLongLong(ctx, counter);
    <span class="hljs-keyword">return</span> REDISMODULE_OK;
}
</code></pre>
<h4 data-id="heading-9">4. 模块初始化函数</h4>
<p>在模块初始化函数中注册 <code>counter.incr</code> 和 <code>counter.get</code> 命令。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">RedisModule_OnLoad</span><span class="hljs-params">(RedisModuleCtx *ctx, RedisModuleString **argv, <span class="hljs-type">int</span> argc)</span> {
    <span class="hljs-keyword">if</span> (RedisModule_Init(ctx, <span class="hljs-string">"counter"</span>, <span class="hljs-number">1</span>, REDISMODULE_APIVER_1) == REDISMODULE_ERR) {
        <span class="hljs-keyword">return</span> REDISMODULE_ERR;
    }
    <span class="hljs-keyword">if</span> (RedisModule_CreateCommand(ctx, <span class="hljs-string">"counter.incr"</span>, CounterIncrCommand, <span class="hljs-string">"write"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) == REDISMODULE_ERR) {
        <span class="hljs-keyword">return</span> REDISMODULE_ERR;
    }
    <span class="hljs-keyword">if</span> (RedisModule_CreateCommand(ctx, <span class="hljs-string">"counter.get"</span>, CounterGetCommand, <span class="hljs-string">"readonly"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) == REDISMODULE_ERR) {
        <span class="hljs-keyword">return</span> REDISMODULE_ERR;
    }
    <span class="hljs-keyword">return</span> REDISMODULE_OK;
}
</code></pre>
<h4 data-id="heading-10">5. 编译和加载模块</h4>
<p>将代码保存为 <code>counter.c</code> 文件，并通过以下命令编译为动态库：</p>
<pre><code class="hljs language-sh" lang="sh">gcc -fPIC -shared -o counter.so counter.c -I/path/to/redis/src
</code></pre>
<p>然后，通过 Redis 客户端加载模块：</p>
<pre><code class="hljs language-sh" lang="sh">redis-cli MODULE LOAD ./counter.so
</code></pre>
<p>加载成功后，可以使用新命令 <code>counter.incr</code> 和 <code>counter.get</code>：</p>
<pre><code class="hljs language-sh" lang="sh">redis&gt; counter.incr
(<span class="hljs-built_in">integer</span>) 1
redis&gt; counter.incr
(<span class="hljs-built_in">integer</span>) 2
redis&gt; counter.get
(<span class="hljs-built_in">integer</span>) 2
</code></pre>
<h3 data-id="heading-11">总结</h3>
<p>Redis 模块开发允许开发者通过编写 C 代码动态扩展 Redis 的功能。开发步骤包括包含模块 API 头文件、定义模块上下文、实现命令处理函数、注册命令以及编译和加载模块。通过上述简单示例和复杂示例，展示了如何实现自定义命令，并在 Redis 中加载和使用这些命令。通过这些步骤，开发者可以根据需要扩展 Redis 的功能，为特定应用场景提供更强大的支持。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（139）Redis的Cluster是如何实现的？]]></title>    <link>https://juejin.cn/post/7575004291833118771</link>    <guid>https://juejin.cn/post/7575004291833118771</guid>    <pubDate>2025-11-21T23:06:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575004291833118771" data-draft-id="7574967214129070106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（139）Redis的Cluster是如何实现的？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-21T23:06:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（139）Redis的Cluster是如何实现的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T23:06:30.000Z" title="Fri Nov 21 2025 23:06:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis Cluster 是 Redis 的一种分布式架构，允许将数据分布到多个节点上以实现数据的自动分片、负载均衡和高可用性。Redis Cluster 通过分片、复制、故障检测和自动故障转移等机制实现这些功能。以下是 Redis Cluster 的详细实现及其关键组件和代码示例。</p>
<h3 data-id="heading-0">核心概念</h3>
<h4 data-id="heading-1">1. 数据分片</h4>
<p>Redis Cluster 将数据键空间分为 16384 个哈希槽（hash slots）。每个键根据其 CRC16 校验和被映射到其中一个哈希槽。</p>
<h4 data-id="heading-2">2. 节点角色</h4>
<p>Redis Cluster 中的节点分为主节点（master）和从节点（slave）。主节点负责处理写请求和数据分片，从节点负责备份主节点的数据并在主节点失效时进行故障转移。</p>
<h4 data-id="heading-3">3. 集群总线</h4>
<p>Redis Cluster 节点之间通过集群总线（Cluster Bus）进行通信，该总线实现了节点间的故障检测、配置更新等功能。</p>
<h4 data-id="heading-4">4. 故障检测和转移</h4>
<p>Redis Cluster 通过投票机制检测节点故障，并在主节点失效时触发自动故障转移。</p>
<h3 data-id="heading-5">数据分片实现</h3>
<p>Redis Cluster 的数据分片通过哈希槽实现。以下是相关的代码示例：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/* Redis Cluster hash function */</span>
<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">keyHashSlot</span><span class="hljs-params">(<span class="hljs-type">char</span> *key, <span class="hljs-type">int</span> keylen)</span> {
    <span class="hljs-keyword">return</span> crc16(key, keylen) &amp; <span class="hljs-number">16383</span>;
}
</code></pre>
<h3 data-id="heading-6">节点间通信</h3>
<p>Redis Cluster 节点通过集群总线进行通信。集群总线使用特殊的二进制协议进行消息传递。以下是节点通信的实现：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/* Cluster message types */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> CLUSTERMSG_TYPE_PING 0</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> CLUSTERMSG_TYPE_PONG 1</span>

<span class="hljs-comment">/* Cluster message structure */</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
    <span class="hljs-type">uint16_t</span> type;     <span class="hljs-comment">/* Message type */</span>
    <span class="hljs-type">uint16_t</span> totlen;   <span class="hljs-comment">/* Total length of the message */</span>
    <span class="hljs-type">char</span> sender[<span class="hljs-number">40</span>];   <span class="hljs-comment">/* Node ID of the sender */</span>
    <span class="hljs-type">char</span> myip[<span class="hljs-number">16</span>];     <span class="hljs-comment">/* Sender IP address */</span>
    <span class="hljs-type">uint16_t</span> port;     <span class="hljs-comment">/* Sender port */</span>
    <span class="hljs-comment">// other fields...</span>
} clusterMsg;

<span class="hljs-comment">/* Function to send a message to a node */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">clusterSendMessage</span><span class="hljs-params">(clusterNode *node, clusterMsg *msg)</span> {
    <span class="hljs-comment">// Serialize the message and send it over the network</span>
}

</code></pre>
<h3 data-id="heading-7">故障检测和转移</h3>
<p>Redis Cluster 通过投票机制实现故障检测和转移。当一个主节点被检测为失效后，集群中的其他主节点会进行投票决定是否进行故障转移。</p>
<h4 data-id="heading-8">故障检测</h4>
<p>每个节点都会定期向其他节点发送 PING 消息，并期待收到 PONG 回复。如果在一定时间内未收到回复，该节点将认为目标节点失效。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/* Cluster node structure */</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">clusterNode</span> {</span>
    <span class="hljs-type">char</span> name[<span class="hljs-number">40</span>];      <span class="hljs-comment">/* Node ID */</span>
    <span class="hljs-type">int</span> flags;          <span class="hljs-comment">/* Node flags: master, slave, fail, etc. */</span>
    <span class="hljs-type">int</span> ping_sent;      <span class="hljs-comment">/* Last time a ping was sent */</span>
    <span class="hljs-type">int</span> pong_received;  <span class="hljs-comment">/* Last time a pong was received */</span>
    <span class="hljs-comment">// other fields...</span>
} clusterNode;

<span class="hljs-comment">/* Function to check for node failures */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">clusterCron</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    <span class="hljs-type">mstime_t</span> now = mstime();
    dictIterator *di;
    dictEntry *de;

    di = dictGetSafeIterator(server.cluster-&gt;nodes);
    <span class="hljs-keyword">while</span>((de = dictNext(di)) != <span class="hljs-literal">NULL</span>) {
        clusterNode *node = dictGetVal(de);

        <span class="hljs-keyword">if</span> (node-&gt;flags &amp; CLUSTER_NODE_MYSELF) <span class="hljs-keyword">continue</span>;

        <span class="hljs-keyword">if</span> (now - node-&gt;pong_received &gt; server.cluster_node_timeout) {
            <span class="hljs-comment">// Mark the node as failing</span>
            node-&gt;flags |= CLUSTER_NODE_PFAIL;
        }
    }
    dictReleaseIterator(di);
}
</code></pre>
<h4 data-id="heading-9">故障转移</h4>
<p>当一个主节点失效后，由从节点中的一个进行接管。故障转移的过程包括选择一个新的主节点和更新集群状态。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/* Function to trigger failover */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">clusterHandleSlaveFailover</span><span class="hljs-params">(clusterNode *slave)</span> {
    <span class="hljs-comment">// Promote the slave to master</span>
    slave-&gt;flags &amp;= ~CLUSTER_NODE_SLAVE;
    slave-&gt;flags |= CLUSTER_NODE_MASTER;

    <span class="hljs-comment">// Update the cluster state</span>
    clusterUpdateState();
}

<span class="hljs-comment">/* Function to update cluster state */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">clusterUpdateState</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    <span class="hljs-comment">// Iterate over all nodes and update the state</span>
    dictIterator *di;
    dictEntry *de;

    di = dictGetSafeIterator(server.cluster-&gt;nodes);
    <span class="hljs-keyword">while</span>((de = dictNext(di)) != <span class="hljs-literal">NULL</span>) {
        clusterNode *node = dictGetVal(de);

        <span class="hljs-keyword">if</span> (node-&gt;flags &amp; CLUSTER_NODE_MASTER) {
            <span class="hljs-comment">// Update the master's state</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (node-&gt;flags &amp; CLUSTER_NODE_SLAVE) {
            <span class="hljs-comment">// Update the slave's state</span>
        }
    }
    dictReleaseIterator(di);
}
</code></pre>
<h3 data-id="heading-10">整合示例</h3>
<p>以下是一个包含数据分片、通信和故障检测的完整示例：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"crc16.h"</span>  <span class="hljs-comment">// Assume crc16.h provides crc16 function</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"dict.h"</span>   <span class="hljs-comment">// Assume dict.h provides a dictionary implementation</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"mstime.h"</span> <span class="hljs-comment">// Assume mstime.h provides mstime function</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> CLUSTER_NODE_TIMEOUT 15000  <span class="hljs-comment">// 15 seconds</span></span>

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">clusterNode</span> {</span>
    <span class="hljs-type">char</span> name[<span class="hljs-number">40</span>];      <span class="hljs-comment">/* Node ID */</span>
    <span class="hljs-type">int</span> flags;          <span class="hljs-comment">/* Node flags: master, slave, fail, etc. */</span>
    <span class="hljs-type">int</span> ping_sent;      <span class="hljs-comment">/* Last time a ping was sent */</span>
    <span class="hljs-type">int</span> pong_received;  <span class="hljs-comment">/* Last time a pong was received */</span>
    <span class="hljs-type">int</span> port;           <span class="hljs-comment">/* Node port */</span>
} clusterNode;

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">clusterState</span> {</span>
    dict *nodes;        <span class="hljs-comment">/* All known nodes in the cluster */</span>
} clusterState;

clusterState *server.cluster;

<span class="hljs-comment">/* Function to hash a key to a slot */</span>
<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">keyHashSlot</span><span class="hljs-params">(<span class="hljs-type">char</span> *key, <span class="hljs-type">int</span> keylen)</span> {
    <span class="hljs-keyword">return</span> crc16(key, keylen) &amp; <span class="hljs-number">16383</span>;
}

<span class="hljs-comment">/* Function to send a message to a node */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">clusterSendMessage</span><span class="hljs-params">(clusterNode *node, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *msg)</span> {
    <span class="hljs-comment">// In a real implementation, this would send the message over a network</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Sending message to node %s: %s\n"</span>, node-&gt;name, msg);
}

<span class="hljs-comment">/* Function to check for node failures */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">clusterCron</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    <span class="hljs-type">mstime_t</span> now = mstime();
    dictIterator *di;
    dictEntry *de;

    di = dictGetSafeIterator(server.cluster-&gt;nodes);
    <span class="hljs-keyword">while</span>((de = dictNext(di)) != <span class="hljs-literal">NULL</span>) {
        clusterNode *node = dictGetVal(de);

        <span class="hljs-keyword">if</span> (now - node-&gt;pong_received &gt; CLUSTER_NODE_TIMEOUT) {
            <span class="hljs-comment">// Mark the node as failing</span>
            node-&gt;flags |= <span class="hljs-number">0x01</span>;  <span class="hljs-comment">// Assume 0x01 represents the fail flag</span>
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Node %s marked as failing\n"</span>, node-&gt;name);
        }
    }
    dictReleaseIterator(di);
}

<span class="hljs-comment">/* Entry point */</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    <span class="hljs-comment">// Initialize the cluster state</span>
    server.cluster = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(clusterState));
    server.cluster-&gt;nodes = dictCreate();

    <span class="hljs-comment">// Create and add nodes to the cluster</span>
    clusterNode node1 = {<span class="hljs-string">"node1"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, mstime(), <span class="hljs-number">6379</span>};
    clusterNode node2 = {<span class="hljs-string">"node2"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, mstime(), <span class="hljs-number">6379</span>};
    dictAdd(server.cluster-&gt;nodes, node1.name, &amp;node1);
    dictAdd(server.cluster-&gt;nodes, node2.name, &amp;node2);

    <span class="hljs-comment">// Simulate cron job</span>
    clusterCron();

    <span class="hljs-comment">// Simulate sending a message</span>
    clusterSendMessage(&amp;node1, <span class="hljs-string">"PING"</span>);

    <span class="hljs-comment">// Cleanup</span>
    dictRelease(server.cluster-&gt;nodes);
    <span class="hljs-built_in">free</span>(server.cluster);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-11">总结</h3>
<p>Redis Cluster 通过数据分片、节点通信、故障检测和故障转移等机制实现了分布式架构。数据分片基于哈希槽进行，节点间通信通过集群总线实现，故障检测通过定期的 PING/PONG 消息完成，而故障转移则通过投票机制选择新的主节点并更新集群状态。上述代码示例展示了 Redis Cluster 的基本实现原理和关键组件。通过理解这些机制，可以更深入地了解 Redis Cluster 的工作原理，并根据需要进行扩展和优化。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain v1 重大更新讲解⚠⚠⚠]]></title>    <link>https://juejin.cn/post/7575050949958746148</link>    <guid>https://juejin.cn/post/7575050949958746148</guid>    <pubDate>2025-11-21T17:44:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575050949958746148" data-draft-id="7575021014032678931" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain v1 重大更新讲解⚠⚠⚠"/> <meta itemprop="keywords" content="LangChain,Python,Agent"/> <meta itemprop="datePublished" content="2025-11-21T17:44:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吴佳浩"/> <meta itemprop="url" content="https://juejin.cn/user/2696441245481975"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain v1 重大更新讲解⚠⚠⚠
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2696441245481975/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吴佳浩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T17:44:36.000Z" title="Fri Nov 21 2025 17:44:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial;color:#00325e}.markdown-body ::selection{background-color:#00325e;color:#fff}.markdown-body blockquote{padding:10px 20px;background-color:#fffaf0;box-shadow:0 3px 10px 0 rgba(255,172,194,.24);border:1px solid #f3ca8e;transition:all .2s;margin:1em 0;border-radius:5px}.markdown-body blockquote p{font-size:14px;line-height:25px;color:#795548}.markdown-body blockquote p:last-child{margin:0}.markdown-body blockquote:hover{border-color:#ff9800;background-color:#fff8e0;box-shadow:0 6px 10px -5px rgba(225,173,98,.3803921569)}.markdown-body blockquote code{color:#ff502c}.markdown-body pre{border:1px solid #8cc0f3;box-shadow:0 3px 10px 0 rgba(255,198,198,.28);border-radius:5px;transition:all .2s;overflow-x:auto;white-space:pre-wrap}.markdown-body pre:hover{border-color:#6d9dce}.markdown-body pre&gt;code{padding:10px 20px;color:#00325e;background:#f0f8ff;font-size:12px;line-height:1.6;display:block}.markdown-body code{background:#f6fbff;color:#0b5393;padding:2px 4px;border-radius:4px;font-size:12px}.markdown-body p{font-size:14px;line-height:28px;text-align:justify;margin-bottom:17px;color:#595959}.markdown-body a{color:#00325e;text-decoration:none}.markdown-body a:after{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAQdJREFUKFNt0DtLA0EUBeBzZle0Eks7rcUfEfBRCha7NorYa6NmVJzgyi4smUgKtdZGCJktLMVH4Y8QeztLWyE7VyLEuNFbXj4Oh0P8c8mZm+uJrEN4BJFTeP/MUVe3bnocfALwkOlo1zS7iZAzf6Cx7oXgbaqjxiDEWCcVaGyxQ8pSWo9XhqhoQ/xUFbaKjhe5V+CmR7mnSplEEF6GSmJ+F/d0KHvbCIIJCLc85U6BC5mONgbJNM3uFag++sX7z8O8MzsWBucifMx0dDGE1kmm458KDVukAlnNdDz/exEeW3dNkbfsYC0xtmgDWP6ELLZ0/F6BJu/UoFQN5AkoeUjeJPvx6+i+X5Sjah4tA6gYAAAAAElFTkSuQmCC);margin-left:2px}.markdown-body a:hover{box-shadow:0 1px}.markdown-body table{max-width:100%;border-collapse:collapse;border-spacing:0;box-shadow:0 3px 10px 0 rgba(255,238,172,.24);transition:all .2s}.markdown-body table:hover{box-shadow:0 3px 10px 0 rgba(185,169,103,.24)}.markdown-body table tr th{border:1px solid #8cc0f3;background-color:#f0f8ff;padding:12px 15px}.markdown-body table tr td{border:1px solid rgba(243,202,142,.4);padding:12px 15px}.markdown-body table tbody tr{transition:all .2s}.markdown-body table tbody tr:hover td{border-color:#f3ca8e;background-color:#fff8e0;z-index:1}.markdown-body img{max-width:100%}.markdown-body h1{font-size:20px;margin-top:30px;margin-bottom:10px;padding-left:30px;position:relative}.markdown-body h1&gt;code{font-size:20px}.markdown-body h1:before{content:"🍺";display:block;font-size:18px;width:18px;height:18px;left:0;position:absolute}.markdown-body h2{font-size:18px;margin-top:30px;margin-bottom:10px;padding-left:28px;position:relative}.markdown-body h2&gt;code{font-size:18px}.markdown-body h2:before{content:"🍻";display:block;font-size:16px;width:16px;height:16px;left:0;position:absolute}.markdown-body h3{font-size:16px;margin-top:30px;margin-bottom:10px;padding-left:26px;position:relative}.markdown-body h3&gt;code{font-size:16px}.markdown-body h3:before{content:"🥂";display:block;font-size:14px;width:14px;height:14px;left:0;position:absolute}.markdown-body h4{font-size:14px;margin-top:30px;margin-bottom:10px;padding-left:24px;position:relative}.markdown-body h4&gt;code{font-size:14px}.markdown-body h4:before{content:"🥃";display:block;font-size:12px;width:12px;height:12px;left:0;position:absolute}.markdown-body h5{font-size:12px;margin-top:30px;margin-bottom:10px}.markdown-body h5&gt;code{font-size:12px}.markdown-body h6{font-size:10px;margin-top:30px;margin-bottom:10px}.markdown-body h6&gt;code{font-size:10px}.markdown-body h1,.markdown-body h2{color:#ff502c}.markdown-body hr{height:4px;border:none;margin-top:32px;margin-bottom:32px;background-size:4px 1px;background-image:linear-gradient(270deg,#6d9dce,#8cc0f3 25%,transparent 50%)}.markdown-body hr:nth-child(2n){background-image:linear-gradient(270deg,#ff9800,#fff8e0 25%,transparent 50%)}.markdown-body ul{padding-inline-start:20px}.markdown-body ul li{list-style-type:"🔸"}.markdown-body ul li li{list-style-type:"◻️"}.markdown-body ul li li li{list-style-type:"▫️"}.markdown-body ol{padding-inline-start:20px}.markdown-body ol ::marker{color:#ff9800}.markdown-body ol,.markdown-body ul{line-height:2em}.markdown-body li{padding-inline-start:1ch}.markdown-body li.task-list-item{list-style:none;padding-inline-start:0}.markdown-body li input{padding-right:2px}.markdown-body li input[type=checkbox i]{appearance:none}.markdown-body li input:before{content:"🟩";display:block;width:13px;height:13px}.markdown-body li input:checked:before{content:"✅"}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">LangChain v1 重大更新讲解</h2>
<blockquote>
<p>为什么没有先发布demo教学而是先发布一个什么重大更新</p>
<p>因为langchain更新了，更新还挺多的所以建议大家还是从新版本开始学习</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2a3016eef8c4ab0933e83e98f1dd875~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC05L2z5rWp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764351876&amp;x-signature=Ni9%2BXYxzHe7feYf8ZfLFx6ldvXM%3D" alt="人工智能的无限可能.png" loading="lazy"/></p>
<p><strong>作者</strong>：吴佳浩</p>
<p><strong>最后更新</strong>：2025-11-22</p>
<p><strong>适用版本</strong>：LangChain v1.0+</p>
<h3 data-id="heading-1">目录</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E4%25B8%2580langchain-v1-%25E4%25B8%25BA%25E4%25BB%2580%25E4%25B9%2588%25E6%2598%25AF%25E4%25B8%2580%25E6%25AC%25A1%25E5%25A4%25A7%25E7%2589%2588%25E6%259C%25AC%25E9%259D%25A9%25E5%2591%25BD" target="_blank" title="https://www.google.com/search?q=%23-%E4%B8%80langchain-v1-%E4%B8%BA%E4%BB%80%E4%B9%88%E6%98%AF%E4%B8%80%E6%AC%A1%E5%A4%A7%E7%89%88%E6%9C%AC%E9%9D%A9%E5%91%BD" ref="nofollow noopener noreferrer">📌 一、LangChain v1 为什么是一次“大版本革命”？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E4%25BA%258Cv01--v10%25E5%25B7%25AE%25E5%25BC%2582%25E5%25AF%25B9%25E7%2585%25A7%25E8%25A1%25A8%25E6%25A0%25B8%25E5%25BF%2583%25E5%25BF%2585%25E8%25AF%25BB" target="_blank" title="https://www.google.com/search?q=%23-%E4%BA%8Cv01--v10%E5%B7%AE%E5%BC%82%E5%AF%B9%E7%85%A7%E8%A1%A8%E6%A0%B8%E5%BF%83%E5%BF%85%E8%AF%BB" ref="nofollow noopener noreferrer">🚀 二、v0.1 → v1.0：差异对照表（核心必读）</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E4%25B8%2589langchain-v1-%25E6%259E%25B6%25E6%259E%2584%25E6%2580%25BB%25E8%25A7%2588" target="_blank" title="https://www.google.com/search?q=%23-%E4%B8%89langchain-v1-%E6%9E%B6%E6%9E%84%E6%80%BB%E8%A7%88" ref="nofollow noopener noreferrer">🧱 三、LangChain v1 架构总览</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E5%259B%259Bcreate_agent%25E5%2585%25A8%25E6%2596%25B0%25E7%259A%2584-agent-%25E5%2588%259B%25E5%25BB%25BA%25E6%2596%25B9%25E5%25BC%258F" target="_blank" title="https://www.google.com/search?q=%23-%E5%9B%9Bcreate_agent%E5%85%A8%E6%96%B0%E7%9A%84-agent-%E5%88%9B%E5%BB%BA%E6%96%B9%E5%BC%8F" ref="nofollow noopener noreferrer">🧰 四、create_agent：全新的 Agent 创建方式</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E4%25BA%2594middleware%25E6%25A0%25B8%25E5%25BF%2583%25E6%2589%25A9%25E5%25B1%2595%25E6%259C%25BA%25E5%2588%25B6%25E6%25B4%258B%25E8%2591%25B1%25E6%25A8%25A1%25E5%259E%258B" target="_blank" title="https://www.google.com/search?q=%23-%E4%BA%94middleware%E6%A0%B8%E5%BF%83%E6%89%A9%E5%B1%95%E6%9C%BA%E5%88%B6%E6%B4%8B%E8%91%B1%E6%A8%A1%E5%9E%8B" ref="nofollow noopener noreferrer">🔧 五、Middleware：核心扩展机制（洋葱模型）</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E5%2585%25ADcontent_blocks%25E8%25B7%25A8%25E6%25A8%25A1%25E5%259E%258B%25E7%25BB%259F%25E4%25B8%2580%25E8%25BE%2593%25E5%2587%25BA" target="_blank" title="https://www.google.com/search?q=%23-%E5%85%ADcontent_blocks%E8%B7%A8%E6%A8%A1%E5%9E%8B%E7%BB%9F%E4%B8%80%E8%BE%93%E5%87%BA" ref="nofollow noopener noreferrer">📦 六、content_blocks：跨模型统一输出</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E4%25B8%2583%25E7%25BB%2593%25E6%259E%2584%25E5%258C%2596%25E8%25BE%2593%25E5%2587%25BAstructured-output" target="_blank" title="https://www.google.com/search?q=%23-%E4%B8%83%E7%BB%93%E6%9E%84%E5%8C%96%E8%BE%93%E5%87%BAstructured-output" ref="nofollow noopener noreferrer">📐 七、结构化输出（Structured Output）</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E5%2585%25AB%25E5%2591%25BD%25E5%2590%258D%25E7%25A9%25BA%25E9%2597%25B4%25E9%2587%258D%25E6%259E%2584--langchain-classic" target="_blank" title="https://www.google.com/search?q=%23-%E5%85%AB%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E9%87%8D%E6%9E%84--langchain-classic" ref="nofollow noopener noreferrer">📚 八、命名空间重构 + langchain-classic</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E4%25B9%259Dv0--v1-%25E8%25BF%2581%25E7%25A7%25BB%25E6%258C%2587%25E5%258D%2597%25E5%25AE%259E%25E6%2588%2598%25E7%2589%2588" target="_blank" title="https://www.google.com/search?q=%23-%E4%B9%9Dv0--v1-%E8%BF%81%E7%A7%BB%E6%8C%87%E5%8D%97%E5%AE%9E%E6%88%98%E7%89%88" ref="nofollow noopener noreferrer">🛠 九、v0 → v1 迁移指南（实战版）</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E5%258D%2581%25E6%258E%25A8%25E8%258D%2590%25E7%259A%2584%25E7%2594%259F%25E4%25BA%25A7%25E7%25BA%25A7%25E9%25A1%25B9%25E7%259B%25AE%25E7%25BB%2593%25E6%259E%2584%25E5%259B%25BE" target="_blank" title="https://www.google.com/search?q=%23-%E5%8D%81%E6%8E%A8%E8%8D%90%E7%9A%84%E7%94%9F%E4%BA%A7%E7%BA%A7%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%E5%9B%BE" ref="nofollow noopener noreferrer">🏗 十、推荐的生产级项目结构图</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E5%258D%2581%25E4%25B8%2580%25E7%259C%259F%25E5%25AE%259E%25E4%25BC%2581%25E4%25B8%259A%25E7%25BA%25A7%25E6%25A1%2588%25E4%25BE%258B%25E5%25A4%259A%25E6%25AD%25A5%25E9%25AA%25A4%25E4%25BB%25BB%25E5%258A%25A1-agent" target="_blank" title="https://www.google.com/search?q=%23-%E5%8D%81%E4%B8%80%E7%9C%9F%E5%AE%9E%E4%BC%81%E4%B8%9A%E7%BA%A7%E6%A1%88%E4%BE%8B%E5%A4%9A%E6%AD%A5%E9%AA%A4%E4%BB%BB%E5%8A%A1-agent" ref="nofollow noopener noreferrer">🧪 十一、真实企业级案例：多步骤任务 Agent</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E5%258D%2581%25E4%25BA%258C%25E5%258F%25AF%25E8%25BF%2590%25E8%25A1%258C%25E7%25BB%25BC%25E5%2590%2588%25E7%25A4%25BA%25E4%25BE%258B%25E4%25BB%25A3%25E7%25A0%2581" target="_blank" title="https://www.google.com/search?q=%23-%E5%8D%81%E4%BA%8C%E5%8F%AF%E8%BF%90%E8%A1%8C%E7%BB%BC%E5%90%88%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81" ref="nofollow noopener noreferrer">📄 十二、可运行综合示例代码</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3D%2523-%25E5%258D%2581%25E4%25B8%2589%25E6%2580%25BB%25E7%25BB%2593" target="_blank" title="https://www.google.com/search?q=%23-%E5%8D%81%E4%B8%89%E6%80%BB%E7%BB%93" ref="nofollow noopener noreferrer">📍 十三、总结</a></li>
</ul>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3c0946c7f754c509c415ec7c41395e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC05L2z5rWp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764351876&amp;x-signature=%2BwOZ4LEjJgMGSln38CEuIWgLku4%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">0. 环境准备</h3>
<p>在开始之前，请确保 Python 版本 <strong>≥ 3.9</strong>，并安装以下核心包：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 v1 核心包、经典兼容包和图运行时</span>
pip install -U langchain langchain-classic langgraph

<span class="hljs-comment"># 安装适配的模型提供商包 (以 OpenAI 为例)</span>
pip install -U langchain-openai
</code></pre>
<hr/>
<h3 data-id="heading-3">一、LangChain v1 为什么是一次“大版本革命”？</h3>
<p>LangChain v1 不再仅仅是一个“LLM 调用工具箱”，而是正式转向<strong>构建生产级 Agent 系统的工程框架</strong>。</p>
<p><strong>核心变化包括：</strong></p>
<ol>
<li><strong><code>create_agent</code></strong>：正式成为 Agent 的标准构建方式（底层基于 LangGraph）。</li>
<li><strong>Middleware (中间件)</strong>：允许在任意阶段（模型调用前、工具执行时、输出后）拦截并修改逻辑。</li>
<li><strong><code>content_blocks</code></strong>：所有模型输出（推理/文本/工具调用）统一为标准格式，不再依赖正则解析。</li>
<li><strong>结构化输出</strong>：Pydantic Schema 成为一等公民，极大提升稳定性。</li>
<li><strong>命名空间拆分</strong>：旧 API（如 Chains）全部迁入 <code>langchain-classic</code>，主包只保留 Agent 核心。</li>
</ol>
<hr/>
<h3 data-id="heading-4">二、v0.1 → v1.0：差异对照表（核心必读）</h3>
<p>这是理解 v1 最重要的一张表，展示了从“脚本思维”到“工程思维”的转变。</p>

































































<table><thead><tr><th><strong>项目</strong></th><th><strong>LangChain v0.x (旧版)</strong></th><th><strong>LangChain v1.0 (新版)</strong></th><th><strong>核心差异</strong></th></tr></thead><tbody><tr><td><strong>中心思想</strong></td><td>Chains (链式调用)</td><td><strong>Agents (智能体)</strong></td><td>从线性执行转向循环图执行 (Graph)</td></tr><tr><td><strong>构建入口</strong></td><td><code>initialize_agent</code></td><td><strong><code>create_agent</code></strong></td><td>统一的新标准接口</td></tr><tr><td><strong>底层引擎</strong></td><td><code>AgentExecutor</code> (硬编码循环)</td><td><strong>LangGraph</strong></td><td>支持持久化、流式、分支、循环的图运行时</td></tr><tr><td><strong>流式能力</strong></td><td>部分支持 (Token级)</td><td><strong>全链路流式</strong></td><td>支持 Token、中间步骤、推理过程的实时流</td></tr><tr><td><strong>扩展机制</strong></td><td>无 (需修改源码或Prompt)</td><td><strong>Middleware</strong></td><td>完整的生命周期钩子 (Hooks)</td></tr><tr><td><strong>工具定义</strong></td><td><code>Tool</code> + <code>func</code></td><td><code>Tool</code> + <strong>Pydantic Schema</strong></td><td>类型更安全，参数定义更清晰</td></tr><tr><td><strong>结构化输出</strong></td><td>JSON Parser + Regex</td><td><strong>Structured Output</strong></td><td>直接绑定 Pydantic 类，由模型底层保证格式</td></tr><tr><td><strong>输出解析</strong></td><td>纯文本 + 正则匹配</td><td><strong><code>content_blocks</code></strong></td><td>标准化对象 (推理块、文本块、工具块)</td></tr><tr><td><strong>包管理</strong></td><td><code>langchain.*</code></td><td><strong><code>langchain-classic</code></strong></td><td>旧功能移至 classic 包，保持主包轻量</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-5">三、LangChain v1 架构总览</h3>
<blockquote>
<p><strong>💡 核心提示</strong>：LangChain v1 的底层引擎实际上是 <strong>LangGraph</strong>。<code>create_agent</code> 本质上是为你预构建了一个标准的 LangGraph 图。</p>
</blockquote>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    subgraph AgentRuntime ["LangGraph 运行时"]
        direction TB
        A["用户输入 (Messages)"] --&gt; B[" 模型推理 (LLM)"]
        B --&gt; C{"决策节点"}
        C --&gt;|需要工具| D[" 工具执行 (Tool Execution)"]
        D --&gt; E[" 工具结果反馈"]
        E --&gt; B
        C --&gt;|无需工具/结束| F[" 生成最终回答"]
    end
    
    style A fill:#e1f5fe,stroke:#01579b
    style B fill:#fff9c4,stroke:#fbc02d
    style D fill:#e8f5e9,stroke:#2e7d32
</code></pre>
<hr/>
<h3 data-id="heading-6">四、create_agent：全新的 Agent 创建方式</h3>
<p>为什么废弃 initialize_agent？</p>
<p>因为 v1 统一使用图架构（Graph Architecture）。所有的 Agent 本质上都是：推理 → 工具 → 再推理 的循环。create_agent 是这个标准循环的工厂函数。</p>
<p><strong>基本用法：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI

<span class="hljs-comment"># 1. 定义模型</span>
model = ChatOpenAI(model=<span class="hljs-string">"gpt-4o"</span>)

<span class="hljs-comment"># 2. 创建 Agent</span>
agent = create_agent(
    model=model,
    tools=[search_tool, calculator_tool],
    system_prompt=<span class="hljs-string">"你是一个乐于助人的金融分析师。"</span>
)

<span class="hljs-comment"># 3. 运行 (Invoke)</span>
result = agent.invoke({<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"分析 AAPL 股价"</span>}]})
</code></pre>
<hr/>
<h3 data-id="heading-7">五、Middleware：核心扩展机制（洋葱模型）</h3>
<p>中间件是 v1 最强大的功能，允许你在 Agent 生命周期的任意节点插入逻辑（如鉴权、日志、路由）。</p>
<p><strong>生命周期时序图：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User
    participant MW as Middleware (中间件层)
    participant Agent as Agent Runtime
    participant Model as LLM

    User-&gt;&gt;Agent: invoke(input)
    Agent-&gt;&gt;MW: 1. before_agent_start
    MW--&gt;&gt;Agent: (清洗后的输入)

    loop 思考与执行循环
        Agent-&gt;&gt;MW: 2. before_model
        Note right of MW: 动态修改 Prompt / 路由模型
        
        rect rgb(240,240,240)
            MW-&gt;&gt;Model: 3. wrap_model_call
            Model--&gt;&gt;MW: 返回原始结果
        end
        
        MW--&gt;&gt;Agent: 4. after_model (校验输出)

        opt 工具调用
            Agent-&gt;&gt;MW: 5. wrap_tool_call
            Note right of MW: 敏感操作审批 / 审计
            MW--&gt;&gt;Agent: 工具结果
        end
    end

    Agent-&gt;&gt;MW: 6. after_agent
    MW--&gt;&gt;User: 最终响应
</code></pre>
<hr/>
<h3 data-id="heading-8">六、content_blocks：跨模型统一输出</h3>
<p>解决“不同模型返回格式不同”的痛点。</p>
<p>模型输出现在包含统一的 .content_blocks 属性：</p>
<ul>
<li><code>reasoning</code>: 模型的思考过程（如 Chain of Thought）。</li>
<li><code>tool_call</code>: 结构化的工具调用请求。</li>
<li><code>text</code>: 最终回复文本。</li>
</ul>
<hr/>
<h3 data-id="heading-9">七、结构化输出（Structured Output）</h3>
<p>v1 推荐使用 <strong>Pydantic Schema</strong> 来强制模型输出特定格式，而不是在 Prompt 里写“请返回 JSON”。</p>
<p><strong>三种策略：</strong></p>
<ol>
<li><strong>SchemaBasedStructurer</strong> (推荐)：直接传入 Pydantic 类。</li>
<li><strong>ToolStrategy</strong>：利用 Tool Calling 机制输出结构。</li>
<li><strong>ProviderStrategy</strong>：利用模型原生 JSON Mode（如 OpenAI JSON Object）。</li>
</ol>
<hr/>
<h3 data-id="heading-10">八、命名空间重构 + langchain-classic</h3>
<p>为了给 Agent 让路，旧的“链式”组件被移入 <code>classic</code> 包。</p>
<p><strong>迁移对照：</strong></p>

























<table><thead><tr><th><strong>组件</strong></th><th><strong>旧引入方式</strong></th><th><strong>v1 新引入方式</strong></th></tr></thead><tbody><tr><td><strong>Memory</strong></td><td><code>from langchain.memory import ...</code></td><td><code>from langchain_classic.memory import ...</code></td></tr><tr><td><strong>Chains</strong></td><td><code>from langchain.chains import ...</code></td><td><code>from langchain_classic.chains import ...</code></td></tr><tr><td><strong>Retrievers</strong></td><td><code>from langchain.retrievers import ...</code></td><td><code>from langchain_classic.retrievers import ...</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-11">🛠 九、v0 → v1 迁移指南（实战版）</h3>
<h4 data-id="heading-12">1. ConversationChain → create_agent</h4>
<ul>
<li>
<p>❌ <strong>旧 (v0)</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.chains <span class="hljs-keyword">import</span> ConversationChain
chain = ConversationChain(llm=llm)
chain.run(<span class="hljs-string">"Hi"</span>)
</code></pre>
</li>
<li>
<p>✔ <strong>新 (v1)</strong>：</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-comment"># create_agent 自带记忆管理 (通过 LangGraph checkpoint)</span>
agent = create_agent(model=llm, tools=[])
agent.invoke({<span class="hljs-string">"messages"</span>: [...]})
</code></pre>
</li>
</ul>
<h4 data-id="heading-13">2. LLMChain → model.invoke</h4>
<ul>
<li>
<p>❌ <strong>旧 (v0)</strong>：</p>
<pre><code class="hljs language-python" lang="python">chain = LLMChain(prompt=prompt, llm=llm)
chain.run(variable=<span class="hljs-string">"value"</span>)
</code></pre>
</li>
<li>
<p>✔ <strong>新 (v1)</strong>：</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># 直接使用 LCEL (LangChain Expression Language)</span>
chain = prompt | llm
chain.invoke({<span class="hljs-string">"variable"</span>: <span class="hljs-string">"value"</span>})
</code></pre>
</li>
</ul>
<h4 data-id="heading-14">3. Tool 定义方式</h4>
<ul>
<li>❌ <strong>旧 (v0)</strong>：依赖 <code>func</code> 和文档字符串解析。</li>
<li>✔ <strong>新 (v1)</strong>：强烈建议使用 <code>@tool</code> 装饰器并配合 Pydantic 类型的参数注解，或者使用 <code>create_tool(schema=MySchema)</code>。</li>
</ul>
<hr/>
<h3 data-id="heading-15">十、推荐的生产级项目结构图</h3>
<p>在 v1 时代，推荐采用分层架构来管理 Agent 项目：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
  Root[" my_agent_project/"] --&gt; A[" app/"]
  
  A --&gt; B[" agent.py &lt;br/&gt; (create_agent 组装入口)"]
  
  A --&gt; C["middleware/ &lt;br/&gt; (中间件层)"]
  C --&gt; C1[" auth_middleware.py"]
  C --&gt; C2[" risk_control.py"]
  
  A --&gt; D[" schemas/ &lt;br/&gt; (数据结构)"]
  D --&gt; D1[" user_context.py"]
  D --&gt; D2[" output_schema.py"]
  
  A --&gt; E[" tools/ &lt;br/&gt; (工具集)"]
  E --&gt; E1[" search_tool.py"]
  E --&gt; E2[" db_tool.py"]
  
  A --&gt; F[" main.py &lt;br/&gt; (FastAPI/Streamlit 入口)"]
</code></pre>
<hr/>
<h3 data-id="heading-16">十一、真实企业级案例：多步骤任务 Agent</h3>
<p>场景：自动代码修复 Agent。</p>
<p>流程：写代码 → 运行测试 → 失败则分析日志 → 修复代码 → 循环直至成功。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    Start(("开始")) --&gt; Gen["生成初版代码"]
    Gen --&gt; Run["🔧 工具: 运行代码/测试"]
    Run --&gt; Check{"测试通过?"}
    
    Check --&gt;|失败| Debug[" LLM: 分析错误日志"]
    Debug --&gt; Gen
    
    Check --&gt;|成功| Output["输出最终代码"]
    Output --&gt; End(("结束"))
</code></pre>
<p><em>这在 v1 中通过 <code>create_agent</code> 天然支持，因为底层 Graph 支持循环，且可以通过中间件记录每次尝试的详细日志。</em></p>
<hr/>
<h3 data-id="heading-17">十二、可运行综合示例代码</h3>
<p>这是一个包含了 <strong>中间件 (Middleware)</strong> 和 <strong>结构化输出</strong> 的完整 v1 示例。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>, <span class="hljs-type">Dict</span>
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field

<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain.agents.middleware <span class="hljs-keyword">import</span> AgentMiddleware, ModelRequest, ModelResponse

<span class="hljs-comment"># 1. 定义工具</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">city: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""获取指定城市的天气信息"""</span>
    <span class="hljs-comment"># 模拟 API 返回</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{city}</span> 天气晴朗, 25°C"</span>

<span class="hljs-comment"># 2. 定义结构化输出 Schema</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherReport</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    city: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"城市名称"</span>)
    temperature: <span class="hljs-built_in">float</span> = Field(description=<span class="hljs-string">"温度数值"</span>)
    summary: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"一句话天气总结"</span>)

<span class="hljs-comment"># 3. 定义自定义中间件 (示例：自动添加礼貌用语)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PolitenessMiddleware</span>(<span class="hljs-title class_ inherited__">AgentMiddleware</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrap_model_call</span>(<span class="hljs-params">self, request: ModelRequest, handler</span>) -&gt; ModelResponse:
        <span class="hljs-comment"># 在发送给模型前，修改 System Prompt</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"🕵️ Middleware: 正在注入礼貌指令..."</span>)
        <span class="hljs-keyword">if</span> request.messages:
            last_msg = request.messages[-<span class="hljs-number">1</span>]
            <span class="hljs-keyword">if</span> last_msg.role == <span class="hljs-string">"user"</span>:
                last_msg.content += <span class="hljs-string">" (请用非常礼貌的语气回答)"</span>
        <span class="hljs-keyword">return</span> handler(request)

<span class="hljs-comment"># 4. 构建 Agent</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    agent = create_agent(
        model=ChatOpenAI(model=<span class="hljs-string">"gpt-4o-mini"</span>),
        tools=[get_weather],
        middleware=[PolitenessMiddleware()],
        <span class="hljs-comment"># 强制结构化输出 (v1 特性)</span>
        <span class="hljs-comment"># response_format=ToolStrategy(WeatherReport) # 若需强制结构化可开启此行</span>
    )

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🚀 Agent 启动..."</span>)
    result = <span class="hljs-keyword">await</span> agent.ainvoke({
        <span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"帮我查一下北京的天气"</span>}]
    })

    <span class="hljs-comment"># v1 的 result 包含完整的执行状态</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n💬 最终回复:"</span>)
    <span class="hljs-built_in">print</span>(result[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>].content)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    asyncio.run(main())
</code></pre>
<hr/>
<h3 data-id="heading-18">十三、总结</h3>
<p>LangChain v1 标志着我们从 <strong>“玩票性质的 Chain”</strong> 走向了 <strong>“工程化的 Agent”</strong>。</p>
<ul>
<li>如果你需要构建简单的问答机器人，LangChain v1 提供了更统一的接口。</li>
<li>如果你需要构建复杂的、多步推理的、具有自我纠错能力的企业级智能体，LangChain v1 (配合 LangGraph) 是目前 Python 生态中最佳的选择。</li>
</ul>
<p><strong>下一步建议：</strong> 安装 <code>langchain-classic</code> 确保旧代码运行，同时在新模块中开始尝试使用 <code>create_agent</code>。
慎重更新老项目。。。。。。崩了。。。别赖我。。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python与C#：从哲学到细节的全面对比]]></title>    <link>https://juejin.cn/post/7574992086715645967</link>    <guid>https://juejin.cn/post/7574992086715645967</guid>    <pubDate>2025-11-21T15:09:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574992086715645967" data-draft-id="7574997924930158632" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python与C#：从哲学到细节的全面对比"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-21T15:09:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python与C#：从哲学到细节的全面对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T15:09:54.000Z" title="Fri Nov 21 2025 15:09:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Python和C#都是现代、高级、面向对象的编程语言，拥有庞大的社区和广泛的应用。然而，它们源于不同的生态系统，秉承不同的设计哲学，因此在语法、执行模型和典型应用上存在显著差异。Python以其极简主义和灵活性著称，而C#则以其在强大类型系统和结构化框架下的优雅与一致性闻名。</p>
<p>下面，我们将从整体到细节，系统地剖析这两种语言的差异。</p>
<h4 data-id="heading-0"><strong>一、整体与哲学</strong></h4>
<ol>
<li>
<p><strong>设计哲学与起源</strong></p>
<ul>
<li><strong>Python</strong>： 由Guido van Rossum创建，其核心哲学是**“优美胜于丑陋，明了胜于晦涩，简洁胜于复杂”<strong>。它是一种</strong>解释型、动态类型**的通用语言，强调代码的可读性和开发者的生产力。其“内置电池”的理念通过庞大而全面的标准库得以体现。</li>
<li><strong>C#</strong>： 由微软的Anders Hejlsberg团队开发，作为**.NET框架<strong>的一部分。它是一种</strong>编译型、静态类型<strong>的语言，设计目标是提供一种</strong>类型安全、组件导向**的现代语言，融合了C++的强大和Java的简洁。其哲学强调在强大的框架内提供一致性和优雅的语法。</li>
</ul>
</li>
<li>
<p><strong>执行模型</strong></p>
<ul>
<li><strong>Python</strong>： 代码通常由<strong>解释器</strong>（如CPython）直接执行。源代码被编译成一种中间字节码，然后在Python虚拟机（PVM）中运行。这带来了跨平台性和动态灵活性。</li>
<li><strong>C#</strong>： 代码通过编译器（如Roslyn）编译成一种称为<strong>中间语言</strong>的字节码。IL代码在运行时由**.NET通用语言运行时<strong>进行</strong>即时编译**成本地机器码执行。这种模型平衡了跨平台性能（通过.NET CLR）和执行效率。</li>
</ul>
</li>
<li>
<p><strong>主要应用领域</strong></p>
<ul>
<li><strong>Python</strong>： <strong>数据科学与机器学习、Web后端、自动化脚本、DevOps、科学计算、人工智能、教育</strong>。它在快速原型开发和非性能临界区的领域表现出色。</li>
<li><strong>C#</strong>： <strong>Windows桌面应用、企业级Web后端、游戏开发、移动应用</strong>。它是构建Windows窗体、WPF、ASP.NET MVC应用的首选，同时通过<strong>Unity游戏引擎</strong>在游戏开发领域占据统治地位。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-1"><strong>二、语法与语言特性</strong></h4>
<ol>
<li>
<p><strong>代码块与语法</strong></p>
<ul>
<li><strong>Python</strong>： 使用<strong>强制性缩进</strong>来定义代码块。这强制了代码风格的统一，使其看起来像可执行的伪代码。
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> x &gt; <span class="hljs-number">0</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Positive"</span>)
    do_something()
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Non-positive"</span>)
</code></pre>
</li>
<li><strong>C#</strong>： 使用**花括号<code>{}</code>**来定义代码块，语句以分号<code>;</code>结尾。缩进是为了可读性，对编译器而言不是必须的。
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">if</span> (x &gt; <span class="hljs-number">0</span>)
{
    Console.WriteLine(<span class="hljs-string">"Positive"</span>);
    DoSomething();
}
<span class="hljs-keyword">else</span>
{
    Console.WriteLine(<span class="hljs-string">"Non-positive"</span>);
}
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>变量与类型系统</strong></p>
<ul>
<li><strong>Python</strong>： <strong>动态类型</strong>。变量是对象的引用，其类型在运行时决定，并且可以改变。
<pre><code class="hljs language-python" lang="python">x = <span class="hljs-number">10</span>        <span class="hljs-comment"># x 是整数</span>
x = <span class="hljs-string">"hello"</span>   <span class="hljs-comment"># 现在 x 是字符串</span>
x = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>] <span class="hljs-comment"># 现在 x 是列表</span>
</code></pre>
</li>
<li><strong>C#</strong>： <strong>静态类型</strong>。每个变量必须声明其类型，且类型在编译时检查，不可更改。从C# 3.0开始引入了<code>var</code>关键字，但它仍然是静态类型的（编译器根据初始值推断类型）。
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">int</span> x = <span class="hljs-number">10</span>;           <span class="hljs-comment">// x 是整数</span>
<span class="hljs-comment">// x = "hello";       // 编译错误！</span>
<span class="hljs-built_in">string</span> s = <span class="hljs-string">"hello"</span>;   <span class="hljs-comment">// s 是字符串</span>
<span class="hljs-keyword">var</span> list = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">int</span>&gt; { <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span> }; <span class="hljs-comment">// 编译器推断list为List&lt;int&gt;</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>内存管理</strong></p>
<ul>
<li><strong>Python</strong>： 拥有<strong>自动垃圾回收</strong>和<strong>引用计数</strong>机制。开发者完全不用关心内存的分配与释放，极大地简化了编程。</li>
<li><strong>C#</strong>： 同样拥有<strong>自动垃圾回收</strong>，由CLR的GC管理。然而，C#提供了更丰富的类型来帮助管理资源：
<ul>
<li><strong>值类型</strong>： 如<code>int</code>, <code>struct</code>，通常分配在栈上，效率高。</li>
<li><strong>引用类型</strong>： 如<code>class</code>，分配在托管堆上，由GC回收。</li>
<li>对于非托管资源（如文件句柄、数据库连接），C#提供了<code>IDisposable</code>接口和<code>using</code>语句来确保资源的确定性释放。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>面向对象编程</strong></p>
<ul>
<li><strong>Python</strong>： 支持<strong>多重继承</strong>。所有成员默认都是“公开”的，通过命名约定（单下划线<code>_protected</code>，双下划线<code>__private</code>）来实现封装，但这更多是一种约定，并非语言级别的强制限制。
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name</span>):
        self.name = name        <span class="hljs-comment"># 公有</span>
        self._protected_var = <span class="hljs-number">1</span> <span class="hljs-comment"># 保护（约定）</span>
        self.__private_var = <span class="hljs-number">2</span>  <span class="hljs-comment"># 私有（名称修饰）</span>
</code></pre>
</li>
<li><strong>C#</strong>： <strong>不支持类的多重继承</strong>，但支持通过<strong>接口</strong>实现多重继承。拥有严格的语言级访问修饰符：<code>public</code>, <code>private</code>, <code>protected</code>, <code>internal</code>等。
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyClass</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Name;          <span class="hljs-comment">// 公有</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> _privateVar;     <span class="hljs-comment">// 私有</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">int</span> ProtectedVar;  <span class="hljs-comment">// 保护</span>

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyClass</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> name</span>)</span>
    {
        Name = name;
    }
}
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>属性 vs 字段</strong></p>
<ul>
<li><strong>Python</strong>： 通常使用普通实例变量（字段）。如果需要封装，可以使用<code>@property</code>装饰器将方法作为属性访问。
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Circle</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, radius</span>):
        self._radius = radius

<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">radius</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> self._radius

<span class="hljs-meta">    @radius.setter</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">radius</span>(<span class="hljs-params">self, value</span>):
        <span class="hljs-keyword">if</span> value &lt; <span class="hljs-number">0</span>:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"Radius cannot be negative"</span>)
        self._radius = value
</code></pre>
</li>
<li><strong>C#</strong>： 明确区分<strong>字段</strong>和<strong>属性</strong>。属性是首选的封装方式，提供了get和set访问器。
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Circle</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">double</span> _radius;

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">double</span> Radius
    {
        <span class="hljs-keyword">get</span> { <span class="hljs-keyword">return</span> _radius; }
        <span class="hljs-keyword">set</span>
        {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">value</span> &lt; <span class="hljs-number">0</span>)
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-string">"Radius cannot be negative"</span>);
            _radius = <span class="hljs-keyword">value</span>;
        }
    }
}
</code></pre>
</li>
</ul>
</li>
</ol>
<h4 data-id="heading-2"><strong>三、生态系统与工具链</strong></h4>
<ol>
<li>
<p><strong>性能</strong></p>
<ul>
<li><strong>C#</strong>： 性能通常<strong>高于Python</strong>。作为编译型语言，经过JIT编译后生成的本地代码执行效率很高。.NET的GC也经过高度优化。</li>
<li><strong>Python</strong>： 作为解释型语言，性能是其短板。但在科学计算和数据处理领域，其高性能通常通过调用底层由C/Fortran实现的第三方库来弥补。</li>
</ul>
</li>
<li>
<p><strong>标准库与包管理</strong></p>
<ul>
<li><strong>Python</strong>： 标准库非常庞大，覆盖了网络、文件系统、压缩、电子邮件等方方面面。包管理主要通过<strong>pip</strong>和<strong>PyPI</strong>进行。</li>
<li><strong>C#</strong>： 标准库是**.NET Base Class Library**，同样非常强大和一致。包管理主要通过<strong>NuGet</strong>进行。</li>
</ul>
</li>
<li>
<p><strong>开发环境</strong></p>
<ul>
<li><strong>Python</strong>： 开发环境非常灵活，从简单的文本编辑器到强大的IDE都可以。<strong>PyCharm</strong>和<strong>VS Code</strong>是最流行的选择。</li>
<li><strong>C#</strong>： 与开发环境紧密集成。<strong>Visual Studio</strong>是其旗舰级IDE，提供了无与伦比的调试、分析和开发体验。<strong>Visual Studio Code</strong>配合C#扩展也是一个轻量级且强大的选择。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-3"><strong>总结</strong></h4>























































<table><thead><tr><th align="left">特性</th><th align="left">Python</th><th align="left">C#</th></tr></thead><tbody><tr><td align="left"><strong>类型系统</strong></td><td align="left">动态类型</td><td align="left">静态类型</td></tr><tr><td align="left"><strong>执行模型</strong></td><td align="left">解释执行</td><td align="left">编译为IL，由CLR JIT执行</td></tr><tr><td align="left"><strong>语法</strong></td><td align="left">缩进定义块</td><td align="left">花括号<code>{}</code>和分号<code>;</code></td></tr><tr><td align="left"><strong>内存管理</strong></td><td align="left">自动GC+引用计数</td><td align="left">自动GC，支持值类型/引用类型</td></tr><tr><td align="left"><strong>继承</strong></td><td align="left">支持多重继承</td><td align="left">仅支持单继承，可通过接口实现多重</td></tr><tr><td align="left"><strong>封装</strong></td><td align="left">命名约定</td><td align="left">严格的访问修饰符</td></tr><tr><td align="left"><strong>属性</strong></td><td align="left">使用<code>@property</code>装饰器</td><td align="left">语言内置的get/set访问器</td></tr><tr><td align="left"><strong>性能</strong></td><td align="left">较低</td><td align="left">较高</td></tr><tr><td align="left"><strong>主要领域</strong></td><td align="left">数据科学、AI、Web后端、脚本</td><td align="left">企业应用、游戏、Windows桌面应用</td></tr></tbody></table>
<p><strong>结论：</strong></p>
<p>选择Python还是C#，取决于你的项目目标和个人偏好。</p>
<ul>
<li>如果你追求<strong>极致的开发速度、脚本化、以及在数据科学和AI领域的丰富生态</strong>，或者你是一个初学者，<strong>Python</strong>是更合适的选择。</li>
<li>如果你在构建<strong>大型、高性能、结构严谨的企业级应用、Windows桌面程序，或者使用Unity进行游戏开发</strong>，那么<strong>C#</strong> 及其强大的.NET生态系统将是你的利器。</li>
</ul>
<p>两者都是优秀的通用语言，但它们在类型系统、执行模型和核心生态上的根本差异，决定了它们各自最适合的战场。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI编程规模化实践：从1到100的工程化之道]]></title>    <link>https://juejin.cn/post/7574992086715662351</link>    <guid>https://juejin.cn/post/7574992086715662351</guid>    <pubDate>2025-11-21T15:11:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574992086715662351" data-draft-id="7575015480198447156" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI编程规模化实践：从1到100的工程化之道"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-21T15:11:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI编程规模化实践：从1到100的工程化之道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T15:11:17.000Z" title="Fri Nov 21 2025 15:11:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">规模化阶段的挑战</h2>
<p>在AI编程工具日益普及的今天，从0到1快速构建原型已不再是难题。然而，当项目进入从1到100的规模化阶段，开发者面临着全新的挑战：如何确保AI生成代码的质量、可维护性和系统架构的连贯性？本文将深入探讨AI在规模化开发阶段的最佳实践，为团队提供切实可行的解决方案。</p>
<h2 data-id="heading-1">核心原则：建立AI辅助开发的基础</h2>
<h3 data-id="heading-2">人类专家的核心地位</h3>
<p>在规模化开发中，AI应明确定位为增强人类专家的工具，而非替代品。正如某国际消费品公司技术负责人所言："我们坚信AI应用于增强人类，其输出总是由人类来做最终的使用决策。"这一原则确保了关键节点的判断力和系统的可靠性。</p>
<h3 data-id="heading-3">清晰的职责边界</h3>
<p>将AI视为高效的初级开发伙伴是更合理的定位。在此模式下，人类工程师负责把控方向、制定架构和关键决策；AI则专注于执行已明确规划好的编码任务。这种分工协作能够显著提升开发效率，同时保证系统设计的合理性。</p>
<h3 data-id="heading-4">治理与合规先行</h3>
<p>规模化开发中，安全护栏和合规性不容妥协。某大型企业采用了包括使用不同的大语言模型进行交叉验证、建立负责任的AI框架等多重措施来减少模型幻觉风险。另一家科技公司的"AI工厂"框架中包含专门监控所有AI应用的组件，内置了确保安全与合规的机制。</p>
<h2 data-id="heading-5">工程实践：规模化开发的具体策略</h2>
<h3 data-id="heading-6">模块化设计与规范制定</h3>
<p>成功的AI规模化开发始于良好的模块化设计。开发者需要将复杂系统拆解为小型、聚焦的模块，并保持清晰的接口定义。这要求在为每个模块编写AI指令时，采用系统化的规范描述方法。</p>
<p>实践证明，RBTRO框架（角色-Role、背景-Background、任务-Task、要求-Requirements、输出-Output）能够有效指导AI生成更符合预期的代码。例如，在设计生产级线程池时，不应简单地说"帮我写个线程池"，而应提供完整的上下文：指定角色为"JDK并发包核心开发者"，背景是"电商系统，峰值QPS 5000"，任务是"设计动态线程池"，具体要求包括"支持动态调参、有监控指标输出"，并明确输出格式为"完整Java类+注释"。</p>
<h3 data-id="heading-7">严格的代码审查机制</h3>
<p>当AI生成的代码大规模融入核心系统时，建立严格的审查流程至关重要。开发者必须牢记，自己始终是代码质量的最终责任人。经验表明，高级开发者之所以能更好地利用AI工具，正是因为他们不会全盘接受AI的输出，而是会持续进行重构、补充边缘案例检查，并强化类型定义和接口设计。</p>
<p>将AI用于辅助审查是另一个有效策略。可以让AI扮演特定角色，如"阿里巴巴Java开发手册编写者"，按照既定规范对其他AI生成的代码进行审查。但这只能作为第一道过滤器，最终的专业判断必须由人类工程师完成。</p>
<h3 data-id="heading-8">平台化工具的统一整合</h3>
<p>当团队规模扩大时，依赖开发者个人使用的AI工具会导致协作效率低下和标准不一。某拉丁美洲电商巨头为其数千名开发者构建了统一的开发平台，该平台整合了语言模型和API，将以自然语言为核心交互方式，并内置了安全防护和路由逻辑。这种平台化 approach 使开发者能更快、更一致地构建高质量AI应用。</p>
<h3 data-id="heading-9">持续迭代与反馈优化</h3>
<p>AI辅助开发不是一次性的设置，而是需要持续优化的过程。对已部署的AI生成代码和组件进行持续监控至关重要。同时，建立定期的反馈机制，如季度调查，了解AI工具在实际使用中为团队节省的时间以及带来的效果变化。在推进AI应用时，重心应从技术炫酷的"概念验证"转向能带来切实效率和业务提升的"价值验证"。</p>
<h2 data-id="heading-10">组织级实施策略</h2>
<h3 data-id="heading-11">人才培养与技能转型</h3>
<p>规模化应用AI编程要求开发团队具备新的技能组合。除了传统的编程能力，还需要培养提示工程、AI输出评估和结果优化等新技能。某知名互联网企业的实践显示，成功的AI开发现场工程师需要具备系统思维、产品思维和快速学习能力，这些素质帮助他们更好地引导AI工具完成复杂任务。</p>
<h3 data-id="heading-12">流程与治理框架</h3>
<p>建立明确的AI使用流程和治理框架是保证规模化成功的制度保障。这包括：代码质量标准、审查流程、安全规范、以及AI使用边界的明确定义。某金融科技公司实施了分层治理模型，根据不同应用场景的风险等级制定相应的AI使用规范，在促进创新的同时有效控制风险。</p>
<h3 data-id="heading-13">度量与持续改进</h3>
<p>建立有效的度量体系是持续改进的基础。团队应该追踪关键指标，如AI生成代码的采用率、缺陷密度、开发效率提升等，并基于这些数据进行定期复盘和流程优化。某软件公司的经验表明，通过系统化地收集和分析AI工具使用数据，他们能够不断优化提示词库和开发流程，实现持续的效率提升。</p>
<h2 data-id="heading-14">结论</h2>
<p>将AI编程成功应用于从1到100的规模化开发，需要从个人技巧上升为团队纪律和组织能力。开发者角色的核心转变是从纯粹的解码者演进为系统的构建师、AI的引导者与质量的守门员。</p>
<p>通过模块化设计、精确的规范、严格的审查、平台化工具和持续的价值验证，团队能够将AI这个"超级助手"的潜力在复杂工程中充分释放。最终，成功的AI规模化实践不仅在于技术的精妙运用，更在于建立人与AI协同工作的新型工程文化，从而稳健地推动项目走向卓越。</p>
<p>在AI技术快速演进的时代，保持学习的心态、批判性的思维和系统化的工程方法，将是应对规模化开发挑战的不二法门。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI编程革命：React + shadcn/ui 将终结前端框架之战]]></title>    <link>https://juejin.cn/post/7574992086715564047</link>    <guid>https://juejin.cn/post/7574992086715564047</guid>    <pubDate>2025-11-21T14:21:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574992086715564047" data-draft-id="7574992086715547663" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI编程革命：React + shadcn/ui 将终结前端框架之战"/> <meta itemprop="keywords" content="前端,人工智能,AI编程"/> <meta itemprop="datePublished" content="2025-11-21T14:21:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倔强青铜三"/> <meta itemprop="url" content="https://juejin.cn/user/2942757076730455"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI编程革命：React + shadcn/ui 将终结前端框架之战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2942757076730455/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倔强青铜三
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.1 初学乍练
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.1 初学乍练" title="VIP.1 初学乍练" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T14:21:01.000Z" title="Fri Nov 21 2025 14:21:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>大家好，我是<strong>倔强青铜三</strong>。欢迎关注我，<strong>微信公众号：倔强青铜三</strong>。欢迎点赞、收藏、关注，一键三连！！！</p>
<p>在AI编程浪潮席卷开发世界的今天，大语言模型（LLMs）正重塑代码创作的规则。</p>
<p>当开发者们还在争论Vue、Angular或Svelte的优劣时，一个清晰的趋势正浮出水面：React与shadcn/ui的组合，凭借其与LLMs的天然契合，正悄然接管前端战场。</p>
<p>这不是空谈——而是由代码本质和AI行为模式驱动的必然。让我们撕开争论的表象，直面为什么这对组合将在AI时代称霸。</p>
<h2 data-id="heading-1">React：LLMs眼中的“理想框架”</h2>
<p>在AI驱动的编码时代，框架的胜出不再仅靠性能或API设计，而取决于它如何“对话”大模型。</p>
<p>React的架构为此而生。其核心是声明式组件模型：函数组件和JSX语法将UI拆解为纯JavaScript逻辑，结构清晰、无隐藏状态。</p>
<p>这与LLMs的训练方式完美匹配——模型在海量开源代码上训练，而GitHub上React的普及率使其成为LLMs最熟悉的“语言”。</p>
<p>相比之下，Vue的模板语法引入额外抽象层，Angular的依赖注入和装饰器常导致复杂上下文，Svelte的编译时魔法则超出LLMs的实时推理能力。</p>
<p>LLMs生成React代码时，错误率更低、可读性更高，因为函数式组件如同乐高积木，模型能轻松组合、修改，而无需理解深层框架魔法。这不是框架信仰之争，而是AI效率的必然选择。</p>
<h2 data-id="heading-2">shadcn/ui：组件库的“AI-native”革命</h2>
<p>当谈到组件库，传统方案如Material UI或Ant Design在AI时代暴露了致命弱点：它们是“黑盒”。封装过度的组件隐藏实现细节，定制时需破解CSS-in-JS或私有API，让LLMs生成的代码常失效。</p>
<p>shadcn/ui彻底颠覆此模式——它不是运行时库，而是一套可复制粘贴的Tailwind CSS组件，基于Radix UI构建。开发者直接拥有代码，LLMs能像编辑文本一样修改它：调整一个按钮颜色？只需替换Tailwind类名；重构表单布局？模型能精准插入新逻辑。</p>
<p>这种“零抽象”设计，让LLMs避免猜测内部状态，输出更可靠的代码。其他库依赖主题引擎或样式隔离，LLMs却常因不熟悉这些隐式规则而崩溃。</p>
<p>shadcn/ui的透明性，使它成为AI生成界面的终极画布——没有惊喜，只有可控创新。</p>
<h2 data-id="heading-3">为何LLMs是React的“天然盟友”</h2>
<p>大语言模型偏爱React，源于其训练数据的DNA。互联网上，React项目占据主导：无数教程、Stack Overflow讨论和开源仓库，让模型内化了其模式。</p>
<p>JSX混合HTML与JavaScript的语法，结构接近自然语言，LLMs能轻松解析并生成类似片段。函数组件的纯函数特性——输入props，输出UI——符合LLMs对确定性逻辑的偏好。</p>
<p>反观Angular的TypeScript装饰器或Vue黑魔法般的响应式实现，引入更多隐式依赖，模型需额外推理解析，错误风险倍增。</p>
<p>更关键的是，React的生态系统（如React Query或Zustand）鼓励解耦模式，LLMs能独立生成状态管理或数据获取逻辑，而无需全局上下文。</p>
<p>这不是React“更好”，而是LLMs在现有数据分布下，更高效地产出高质量React代码。</p>
<h2 data-id="heading-4">shadcn/ui：LLMs界面生成的“完美接口”</h2>
<p>shadcn/ui的设计哲学，正是为AI协作而生。</p>
<p>其组件由原子Tailwind类驱动——例如<code>bg-blue-500 hover:bg-blue-600</code>——这些类名语义清晰、组合灵活，LLMs能直接映射到设计需求（“一个悬停时变深的按钮”）。模型无需学习库特定的prop命名规则（如Material UI的<code>variant="contained"</code>），而是操作人类可读的CSS原语。</p>
<p>此外，shadcn/ui的按需复制机制，让LLMs生成的代码无外部依赖，避免版本冲突或tree-shaking问题。当开发者要求“添加一个模态框”，LLMs能输出完整、可运行的组件文件，而非调用未知库函数。其他组件库的封装层，在AI眼中如同迷雾；shadcn/ui的透明性，则让模型成为精准的“代码装配工”。</p>
<p>在AI编程的新纪元，技术栈的胜者不是由基准测试决定，而是由人与模型的协作效率定义。</p>
<p>React的组件化哲学与shadcn/ui的无摩擦定制，共同构建了一个LLMs能无缝赋能的开发流。</p>
<p><strong>AI不会取代开发者，但会放大那些选择正确工具的人。</strong></p>
<p>拥抱React与shadcn/ui，不是跟随潮流，而是为未来编写代码——在那里，框架战争已由AI的偏好悄然终结。</p>
<p><strong>你，准备好站在胜利的一方了吗？</strong></p>
<blockquote>
<p>最后感谢阅读！欢迎关注我，微信公众号： <strong>倔强青铜三</strong>。<br/>
<strong>点赞、收藏、关注</strong>，一键三连！！<br/></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 Go-Kratos 与 MCP 的推荐服务实战指南]]></title>    <link>https://juejin.cn/post/7575050949958418468</link>    <guid>https://juejin.cn/post/7575050949958418468</guid>    <pubDate>2025-11-21T14:27:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575050949958418468" data-draft-id="7575021235135430675" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 Go-Kratos 与 MCP 的推荐服务实战指南"/> <meta itemprop="keywords" content="后端,微服务,深度学习"/> <meta itemprop="datePublished" content="2025-11-21T14:27:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵个咪"/> <meta itemprop="url" content="https://juejin.cn/user/1350630784901262"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 Go-Kratos 与 MCP 的推荐服务实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1350630784901262/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵个咪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T14:27:01.000Z" title="Fri Nov 21 2025 14:27:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基于 Go-Kratos 与 MCP 的推荐服务实战指南</h2>
<p>在微服务与多模块协同场景下，实现服务间的标准化通信与流程调度是核心挑战。本文聚焦 <code>go-kratos-mcp-demo</code> 项目，讲解如何基于
<code>Go-Kratos</code> 框架与 <code>MCP</code>（模块化协同协议）构建可扩展的推荐服务，涵盖服务契约设计（proto）、模块化流程编排、召回/过滤/排序等关键模块的实现与测试，并展示实战部署与可观测性方案。</p>
<h3 data-id="heading-1">技术基石：Go-Kratos 与 MCP 的协同架构</h3>
<p>项目技术选型围绕 “模块化协同” 核心需求展开，<code>Go-Kratos</code> 与 <code>MCP</code> 构成架构的两大支柱，形成 “框架赋能 + 协议规范” 的协同模式：</p>
<ul>
<li><strong>Go-Kratos：</strong> 作为B站开源的微服务框架，提供了从 API 定义、配置管理到服务治理的全链路支持。项目通过其 <code>transport</code> 层扩展 <code>kratos-transport</code> 实现了 MCP 协议的集成，同时借助 wire 依赖注入工具简化了服务间依赖管理，让模块解耦更彻底。</li>
<li><strong>MCP 协议：</strong> 通过 <code>mcp-go</code> 库实现多模块协同，定义了标准化的工具注册、请求参数与响应格式。在推荐流程中，召回、排序、过滤模块通过 MCP 上下文传递数据，避免了硬编码耦合，使各模块可独立升级与复用。</li>
</ul>
<p>从依赖管理可见，项目通过 <code>github.com/tx7do/kratos-transport/transport/mcp</code> 实现了 Kratos 与 MCP 的无缝对接，同时引入 <code>mcp-go</code> 提供协议核心能力，形成了 "框架 + 协议" 的协同开发模式。</p>
<h3 data-id="heading-2">MCP 服务设计：基于 Kratos 的模块化调度实现</h3>
<h4 data-id="heading-3">1. MCP 服务初始化与工具注册</h4>
<p>在 <code>internal/server/mcp.go</code> 中，项目基于 <code>Kratos</code> 扩展的 <code>mcpServer</code> 构建 <code>MCP</code> 服务，核心是注册 "推荐工具" 并绑定处理逻辑：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewMcpServer</span><span class="hljs-params">(_ log.Logger, recommendService *service.RecommendService)</span></span> *mcpServer.Server {
    srv := mcpServer.NewServer(
        mcpServer.WithServerName(<span class="hljs-string">"Recommend MCP Server"</span>),
        mcpServer.WithMCPServeAddress(<span class="hljs-string">":8080"</span>), <span class="hljs-comment">// MCP 服务端口</span>
        <span class="hljs-comment">// 更多配置...</span>
    )
    
    <span class="hljs-comment">// 注册推荐工具，定义输入参数schema</span>
    <span class="hljs-keyword">if</span> err = srv.RegisterHandler(
        mcp.Tool{
            Name:        <span class="hljs-string">"recommend"</span>,
            Description: <span class="hljs-string">"获取个性化推荐结果"</span>,
            InputSchema: mcp.ToolInputSchema{ <span class="hljs-comment">// MCP 标准化输入定义</span>
                Type: <span class="hljs-string">"object"</span>,
                Properties: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
                    <span class="hljs-string">"userFeature"</span>: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{ <span class="hljs-comment">// 用户特征</span>
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                        <span class="hljs-string">"properties"</span>: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
                            <span class="hljs-string">"userId"</span>: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{<span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>},
                        },
                    },
                    <span class="hljs-string">"triggerItemId"</span>: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{<span class="hljs-string">"type"</span>: <span class="hljs-string">"integer"</span>}, <span class="hljs-comment">// 触发商品ID</span>
                    <span class="hljs-string">"scene"</span>:         <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{<span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>},  <span class="hljs-comment">// 推荐场景</span>
                },
                Required: []<span class="hljs-type">string</span>{<span class="hljs-string">"userFeature"</span>},
            },
        },
        recommendService.HandleRecommend, <span class="hljs-comment">// 绑定处理函数</span>
    ); err != <span class="hljs-literal">nil</span> {
        log.Errorf(<span class="hljs-string">"failed to register recommend tool: %v"</span>, err)
    }
    
    <span class="hljs-keyword">return</span> srv
}
</code></pre>
<p>这段代码体现了 MCP 协议的核心思想：通过标准化的工具定义（名称、输入 schema、描述），使调用方无需关心具体实现，只需按协议格式请求即可。而 Kratos 的服务管理能力则确保了 MCP 服务的高可用启动与配置加载。</p>
<h4 data-id="heading-4">2. 多模块协同流程：MCP 上下文驱动的推荐链路</h4>
<p>推荐服务的核心逻辑在 <code>internal/service/recommend.go</code> 中实现，通过 <code>MCP</code> 上下文串联 <strong>召回</strong>、<strong>排序</strong>、<strong>过滤</strong> 三大模块：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// HandleRecommend MCP协议推荐处理入口</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *RecommendService)</span></span> HandleRecommend(ctx context.Context, request mcp.CallToolRequest) (*mcp.CallToolResult, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 1. 解析MCP请求参数为内部上下文</span>
    <span class="hljs-keyword">var</span> actionCtx recommendV1.UserActionContext
    <span class="hljs-keyword">if</span> err := codec.Unmarshal(argsData, &amp;actionCtx); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    
    <span class="hljs-comment">// 2. 生成请求ID，用于全链路追踪</span>
    requestId := uuid.New().String()
    
    <span class="hljs-comment">// 3. 召回模块：基于用户历史与场景召回候选物品</span>
    recallInput := &amp;recommendV1.RecallInputContext{
        Stage:          recommendV1.ContextStage_CONTEXT_STAGE_RECALL,
        RequestId:      requestId,
        UserFeature:    actionCtx.GetUserFeature(),
        HistoryItemIds: history, <span class="hljs-comment">// 用户历史行为</span>
    }
    recallOutput, err := s.recallService.Recall(ctx, recallInput)
    
    <span class="hljs-comment">// 4. 排序模块：对召回结果打分排序</span>
    rankInput := &amp;recommendV1.RankInputContext{
        Stage:     recommendV1.ContextStage_CONTEXT_STAGE_RANK,
        RequestId: requestId,
        RecallCtx: recallOutput, <span class="hljs-comment">// 传递召回结果</span>
    }
    rankOutput, err := s.rankService.Rank(ctx, rankInput)
    
    <span class="hljs-comment">// 5. 过滤模块：过滤黑名单与已购物品</span>
    filterInput := &amp;recommendV1.FilterInputContext{
        Stage:            recommendV1.ContextStage_CONTEXT_STAGE_FILTER,
        RequestId:        requestId,
        RankCtx:          rankOutput, <span class="hljs-comment">// 传递排序结果</span>
        BlacklistItemIds: s.filterService.rc.GetService().GetFilter().GetBlacklist(),
    }
    finalOutput, err := s.filterService.Filter(ctx, filterInput)
    
    <span class="hljs-comment">// 6. 封装为MCP响应格式</span>
    <span class="hljs-keyword">return</span> &amp;mcp.CallToolResult{
        Content: []mcp.Content{
            mcp.TextContent{Type: <span class="hljs-string">"text"</span>, Text: <span class="hljs-type">string</span>(finalOutputJson)},
        },
    }, <span class="hljs-literal">nil</span>
}
</code></pre>
<p>整个流程中，MCP 协议承担了 "标准化胶水" 的角色：输入参数通过 <code>MCP</code> 定义的 <code>CallToolRequest</code> 传递，各模块通过上下文（<code>RecallInputContext</code>、<code>RankInputContext</code> 等）共享数据，最终结果以 <code>CallToolResult</code> 标准化返回。而 Kratos 的依赖注入（通过 <code>wire</code>）则确保了 <code>recallService</code>、<code>rankService</code> 等模块的灵活注入，实现了解耦。</p>
<h3 data-id="heading-5">服务部署与测试：Kratos 生态工具链的实践</h3>
<p>项目借助 Kratos 生态的工具链实现了标准化的构建与测试流程：</p>
<h4 data-id="heading-6">1. 服务启动</h4>
<p>在 <code>cmd/server/main.go</code> 中，通过 <code>Kratos</code> 的 <code>kratos.New</code> 整合 <code>MCP服务</code> 与 <code>HTTP服务</code>，实现多协议共存：</p>
<pre><code class="hljs language-go" lang="go">app := kratos.New(
    kratos.Name(<span class="hljs-string">"recommend-mcp-server"</span>),
    kratos.Server(
        ms, <span class="hljs-comment">// MCP服务</span>
        hs, <span class="hljs-comment">// HTTP服务</span>
    ),
)
</code></pre>
<h4 data-id="heading-7">2. 测试支持</h4>
<p><code>internal/service/recommend_test.go</code> 中，通过 MCP 客户端模拟请求，验证整个推荐链路：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 初始化MCP客户端</span>
httpTransport, _ := transport.NewStreamableHTTP(<span class="hljs-string">"http://localhost:8080/mcp"</span>)
mcpClient := client.NewClient(httpTransport)

<span class="hljs-comment">// 调用推荐工具</span>
result, _ := mcpClient.CallTool(ctx, mcp.CallToolRequest{
    Params: mcp.CallToolParams{
        Name: <span class="hljs-string">"recommend"</span>,
        Arguments: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
            <span class="hljs-string">"userFeature"</span>: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{<span class="hljs-string">"userId"</span>: <span class="hljs-string">"user123"</span>},
            <span class="hljs-string">"triggerItemId"</span>: <span class="hljs-type">int64</span>(<span class="hljs-number">1001</span>),
            <span class="hljs-string">"scene"</span>:         <span class="hljs-string">"homepage"</span>,
        },
    },
})
</code></pre>
<h4 data-id="heading-8">3. 构建脚本</h4>
<p><code>Makefile</code> 整合了 <code>Kratos</code> 推荐的开发流程，支持一键生成 API 代码、启动服务：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成API与OpenAPI文档</span>
make api openapi

<span class="hljs-comment"># 生成依赖注入代码</span>
make wire

<span class="hljs-comment"># 启动服务（同时启动MCP与HTTP服务）</span>
make run
</code></pre>
<h3 data-id="heading-9">总结：Go-Kratos 与 MCP 协同的价值</h3>
<p><code>go-kratos-mcp-demo</code> 项目展示了 <code>Go-Kratos</code> 与 <code>MCP协议</code> 在模块化服务开发中的协同优势，为微服务架构设计提供三大启示：</p>
<ol>
<li><strong>标准化协同：</strong> MCP 协议定义了模块间通信的统一规范，使召回、排序等模块可独立开发、复用与升级。</li>
<li><strong>框架赋能：</strong> Kratos 提供的服务管理、配置加载、依赖注入等能力，降低了 MCP 服务的开发与运维成本。</li>
<li><strong>多协议支持：</strong> 通过 Kratos 的 <code>transport</code> 扩展，项目同时支持 <code>MCP</code> 与 <code>HTTP</code> 协议，满足不同场景的调用需求。</li>
</ol>
<p>对于需要构建模块化、可扩展微服务的场景，这种 "框架 + 协议" 的模式具有重要参考价值，既保证了架构的灵活性，又通过标准化降低系统复杂度，具有较强的实践参考价值。</p>
<h3 data-id="heading-10">项目代码</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fgo-kratos-mcp-demo" target="_blank" title="https://github.com/tx7do/go-kratos-mcp-demo" ref="nofollow noopener noreferrer">go-kratos-mcp-demo Gitee</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Ftx7do%2Fgo-kratos-mcp-demo" target="_blank" title="https://gitee.com/tx7do/go-kratos-mcp-demo" ref="nofollow noopener noreferrer">go-kratos-mcp-demo Github</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谷歌Nano Banana Pro：AI画图迈向专业]]></title>    <link>https://juejin.cn/post/7575004291832873011</link>    <guid>https://juejin.cn/post/7575004291832873011</guid>    <pubDate>2025-11-21T14:33:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575004291832873011" data-draft-id="7575006095389016073" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谷歌Nano Banana Pro：AI画图迈向专业"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-11-21T14:33:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谷歌Nano Banana Pro：AI画图迈向专业
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T14:33:42.000Z" title="Fri Nov 21 2025 14:33:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025年11月21日，谷歌震撼发布新一代图像生成与编辑模型 <strong>Nano Banana Pro</strong>（官方名称：Gemini 3 Pro Image）。这款模型深度融合了刚刚推出的Gemini 3 Pro的强大推理能力，标志着AI图像技术从“能画”到“能用”的质的飞跃，旨在将创意工具推向专业级生产力新高度。</p>
<p>Nano Banana Pro并非简单地提升了画质，其核心优势在于它能真正“理解”用户的创作意图，并结合谷歌搜索的实时知识库，生成基于事实、逻辑准确的视觉内容。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2Fdawddf-1024x598.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/dawddf-1024x598.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/151dddb7f88847fd9e8d9302d8877d40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764340421&amp;x-signature=s8XUh8HCjdycxg06OyWlkELgbdA%3D" alt="dawddf" loading="lazy"/></a></p>
<p><strong>🚀 核心突破：从“生成”到“理解”的跨越</strong></p>
<ol>
<li>
<p><strong>攻克文本难题：AI图像中的精准文字</strong> 长期以来，AI图像中的文本生成是公认的难点。Nano Banana Pro在此领域实现了里程碑式突破，被誉为在图像中生成<strong>正确且清晰可读文字</strong>的最佳模型，支持多种字体、书法及复杂的排版。更令人惊叹的是，它依托Gemini 3 Pro，能轻松处理多语言文本，甚至能将图像中的文字（如产品包装说明）无缝翻译并替换成其他语言，同时保持原有风格，极大提升了全球化内容制作效率。</p>
</li>
<li>
<p><strong>智能信息可视化：不止图像，更是知识</strong> 这不仅仅是一个画图工具，它具备<strong>实时联网搜索</strong>能力，可抓取网络信息（如食谱、新闻、股价、生物学图谱）并自动生成对应的<strong>信息图、图表或教程</strong>。这意味着Nano Banana Pro能生成基于真实世界的逻辑和信息的视觉内容，使其可直接用于教育、演示和商业分析，从“生成”跃升至“理解”和“实用”。例如，生成一份带有精准数据的“豆蔻茶制作教程”或复杂的“胰岛素-葡萄糖反馈回路”示意图，内容准确到可直接用于教学或演示。</p>
</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-21_22.23.18-1024x603.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-21_22.23.18-1024x603.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca64dc63864e4a0fbb93d75026514bbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764340421&amp;x-signature=foqze6KjcOBLh36A4HmIStClx74%3D" alt="iShot_2025-11-21_22.23.18" loading="lazy"/></a></p>
<p><strong>🎨 极致画质与精准控制</strong></p>
<p>新模型提供了前所未有的“导演级”创意控制。</p>
<ul>
<li><strong>超高分辨率：</strong> 支持最高 <strong>4K</strong> 超高画质输出，细节纤毫毕现，满足专业级需求。</li>
<li><strong>专业级控制：</strong> 用户可获得“导演级”控制权，自由调整相机角度、景深、焦点、光线效果（如昼夜转换）及色彩分级，实现电影工业级调色。</li>
<li><strong>多图像融合与角色一致性：</strong> 它能将最多 <strong>14张图片</strong> 巧妙融合进一个画面，并能保持最多 <strong>5个人物角色</strong> 的身份特征一致性，实现无缝叙事，为系列创作和复杂场景提供了强大支撑。</li>
<li><strong>局部编辑：</strong> 强大的局部编辑功能允许用户对图像特定部分进行精确选择、优化和变换。</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2Ffdsf-1024x576.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/fdsf-1024x576.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/374d3419de5f4098b0a63269dee14e4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764340421&amp;x-signature=RTQx6cbBMkUSlBsdBDTvzjpMwzo%3D" alt="fdsf" loading="lazy"/></a></p>
<p><strong>💎 背后的强大引擎：Gemini 3 Pro</strong></p>
<p>Nano Banana Pro的卓越能力，核心源于其底层模型 <strong>Gemini 3 Pro</strong> 的强大支撑。Gemini 3 Pro的<strong>推理能力</strong>和<strong>世界知识</strong>，让Nano Banana Pro不仅能生成图片，更能“理解”用户的复杂指令，并基于真实世界的逻辑与信息进行创作，实现从视觉到智能的深度融合。</p>
<p><strong>💼 如何体验Nano Banana Pro？</strong></p>
<ul>
<li><strong>主要平台：</strong> 目前，用户可通过 <strong>Gemini 应用</strong> 的“创建图像”功能率先体验（需选择“思考”模型，即Gemini 3 Pro）。</li>
<li><strong>使用配额：</strong> 免费用户可享有<strong>有限的试用额度</strong>，而订阅 Google AI <strong>Plus、Pro 或 Ultra</strong> 服务的用户将获得更高的使用额度。</li>
<li><strong>产品集成：</strong> Nano Banana Pro 也将逐步集成到 Google Workspace (如Slides和Vids)、NotebookLM、Flow，以及面向开发者的AI Studio和Gemini API等产品中，赋能更广泛的应用场景。</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2Fwegfrg-1024x777.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/wegfrg-1024x777.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b130f7ebdbb496aaef5911cc9223ffd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764340421&amp;x-signature=b8ZPkCnfdPmt39aTqvmjZLrh2Ig%3D" alt="wegfrg" loading="lazy"/></a></p>
<p><strong>🛡️ 安全与透明度</strong></p>
<p>谷歌强调了新模型的安全和透明度措施。所有由Nano Banana Pro生成的图像都将嵌入不可见的 <strong>SynthID 数字水印和 C2PA 元数据</strong>。用户可以在Gemini应用中上传任何图片，直接询问“这是由Google AI生成的吗？”进行验证，确保AI生成内容的可追溯性与识别便利。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2Fhghfgj-1024x576.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/hghfgj-1024x576.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/445b3e83688044aab68df0a7f5808811~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764340421&amp;x-signature=Q%2FDhuSCrLip0w0AqvTBjPXzGdkI%3D" alt="hghfgj" loading="lazy"/></a></p>
<p>Nano Banana Pro的发布，标志着AI文生图技术从“追求视觉逼真”迈向了“追求事实准确与生产实用”的新阶段。它不再只是一个好玩的工具，而是能够理解意图、结合知识、产出专业级内容的生产力伙伴。这无疑是谷歌在AI图像生成领域的一次重大突破，值得我们深入探索和体验！</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI编程：更适合0到1的创意爆发，还是1到100的精雕细琢？]]></title>    <link>https://juejin.cn/post/7574997924930142248</link>    <guid>https://juejin.cn/post/7574997924930142248</guid>    <pubDate>2025-11-21T15:01:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574997924930142248" data-draft-id="7574997924930125864" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI编程：更适合0到1的创意爆发，还是1到100的精雕细琢？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-21T15:01:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI编程：更适合0到1的创意爆发，还是1到100的精雕细琢？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T15:01:49.000Z" title="Fri Nov 21 2025 15:01:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>看着YC创业公司里那些由AI生成95%代码的项目，我意识到编程正从精确的工程技术向充满可能性的创意手艺转变。</p>
</blockquote>
<p>一位硅谷工程师仅用三天时间，就通过AI编程工具将Figma设计转化为可运行的Web应用原型。<br/>
而在另一面，某创业团队同样依赖AI工具快速搭建的电商系统，却在处理高并发订单时突然崩溃，修复时间远超手动编码的两倍。</p>
<p>在2025年冬季YC孵化团队中，四分之一的创始人表示其代码库中<strong>超过95%的代码由AI生成</strong>。<br/>
与此同时，企业环境中的开发者们却开始强调建立AI治理框架、黄金路径和严格审查流程。</p>
<hr/>
<h2 data-id="heading-0">01 AI编程的革命：从代码补全到“氛围编程”</h2>
<p>当前AI编程工具已从早期的代码补全，演进到了半自动编程阶段。开发者通过自然语言与AI交互，描述他们想要的功能，AI则负责生成相应的代码实现。</p>
<p>这种被称为“<strong>氛围编程</strong>”（Vibe Coding）的新方法，完全改变了开发者与计算机的互动方式。</p>
<p>用一位开发者的说法：“我不怎么写代码了，我只是思考和审查”。这种模式将开发者从逐行编写代码的负担中解放出来，更像是一个创意总监或乐队指挥，通过自然语言向AI传达更高层次的意图。</p>
<p>AI编程工具市场呈现爆发式增长。Cursor在短短15个月内做到年收入5亿美元，而Google不惜砸下24亿美元抢下Windsurf。</p>
<p>这些工具正在彻底改变我们启动新项目的方式，使想法到可运行原型的转换从几周缩短到几小时或几天。</p>
<h2 data-id="heading-1">02 为什么AI编程在0-1阶段表现卓越？</h2>
<p><strong>AI编程工具显著降低了从想法到原型的转换门槛</strong>。从设计或粗略概念开始，利用AI生成完整的初始代码库，开发者可以在极短时间内做出工作原型，用于快速验证和迭代。</p>
<p>对于资源有限的创业者和独立开发者，这种能力具有革命性意义。个人开发者Pieter Levels独自创建和运营多个盈利颇丰的网站，包括Nomad List和Photo AI，其个人年收入早已超过百万美元。</p>
<p>他广泛使用AI工具来辅助编程、生成内容和处理客户服务，将个人的生产力杠杆化到了极致。</p>
<p>在0-1阶段，<strong>快速试错比完美代码更重要</strong>。一位YC创始人道出了这种转变的本质：“我不再是一名工程师，我成了一个产品人”。</p>
<p>当构建成本持续降低，速度与想象力成为新的门槛。开发者可以同时打开多个AI编程窗口，针对不同的功能进行并行开发，大大加快了创意验证的循环速度。</p>
<p>AI编程还使非技术背景的领域专家能够直接将他们的洞察转化为产品。一位经验丰富的零售业采购经理，可以在一个周末将她对供应链的独特洞察，转化为一个比现有ERP系统更智能的库存管理应用。</p>
<p>这种<strong>民主化开发</strong>正在释放前所未有的创新潜力。</p>
<h2 data-id="heading-2">03 AI编程在1-100阶段面临的挑战</h2>
<p>尽管AI在0-1阶段表现抢眼，但当项目进入1-100的扩展阶段，情况变得复杂起来。这就是所谓的“<strong>70%问题</strong>”——AI可以出奇地快速地完成前70%的工作，但最后的30%却是收益递减的过程。</p>
<p><strong>代码质量与系统稳定性</strong>成为首要问题。初级开发者更容易全盘接受AI的输出，导致出现“纸牌屋代码”——看似完整，但现实压力一推即倒。</p>
<p>在复杂业务场景中，AI生成的代码常存在隐藏的隐患。某创业团队用AI工具三天搭建出电商系统原型，却在处理高并发订单时崩溃——修复这些深层逻辑漏洞耗费的时间，远超手动编码的两倍。</p>
<p><strong>系统架构的连贯性</strong>是另一大挑战。现有的AI编码工具源自代码生成领域，代码隐匿于潜在空间，它们擅长从头开始重写，却难以在已有基础上进行构建。</p>
<p>这种特性使得渐进式改进变得困难，往往导致“进一步退两步”的调试循环。</p>
<p>在任务关键型和受监管的环境中，<strong>治理与合规</strong>成为不可逾越的障碍。REI Systems的实践经验表明，在联邦系统等高度规范的环境中，AI生成代码必须经过与手动编写代码相同的严格审查流程。</p>
<p>没有适当的监督，AI可能会忽视行业监管细则中的关键指标，导致合规风险。</p>
<h2 data-id="heading-3">04 知识悖论：为什么经验丰富的开发者更能从AI中受益？</h2>
<p>观察AI辅助开发几年后，我注意到一个有趣现象：<strong>AI工具对经验丰富的开发者的帮助要大于对初学者的帮助</strong>。这听起来有违直觉——AI难道不是应该让编码大众化吗？</p>
<p>现实是，AI就像团队中有一位很热心的初级开发者。他们能快速编写代码，但需要不断的监督和纠正。<strong>你懂得越多，就越能指导他们</strong>。</p>
<p>高级工程师利用AI来加速他们已经知道怎么去做的事情，而初级员工则尝试用AI来学习该干什么，结果大相径庭。</p>
<p>在REI Systems的实践中，经验丰富的开发者能够通过AI工具生成上下文相关的自定义代码，自动化测试案例生成，并以最少的开发者干预重构遗留代码。</p>
<p>他们不会简单接受AI的建议，而是不断地将生成的代码重构为更小、更聚焦的模块，查缺补漏，添加边缘案例，并强化类型定义和接口。</p>
<p>这种<strong>批判性使用AI的能力</strong>，恰恰是经验带来的宝贵优势。正如一位专家所指出的：“工具再好也是辅助，真想学好编程，基础概念还是得掌握”。</p>
<h2 data-id="heading-4">05 实践指南：如何在两个阶段合理运用AI编程？</h2>
<p>对于0-1阶段的项目，推荐采用“<strong>AI初稿</strong>”模式：让AI生成基本的实现，然后人工审查并模块化重构，添加全面的错误处理，编写彻底的测试，并记录关键决策。</p>
<p>保持紧密的反馈循环，经常提交变更，确保代码库始终处于可用状态。</p>
<p>当项目进入1-100阶段，则需要转向“<strong>信任但要核实</strong>”模式：用AI生成初始代码，但人工审查所有的关键路径，自动测试边缘案例，并定期进行安全审计。</p>
<p>在REI Systems，他们建立了强大的治理框架，确保所有AI生成的代码都经过与手动编写代码相同的严格质量检查、安全漏洞扫描和合规性验证。</p>
<p><strong>模块化设计</strong>是平衡两个阶段需求的关键策略。将所有内容分解为小的、集中的文件，组件之间保持接口清晰，并记录模块边界。</p>
<p>这种做法使得AI可以专注于特定模块的实现，同时降低系统整体复杂度。</p>
<p>最重要的是，保持<strong>持续的技能发展</strong>。最成功的非工程师会用混合模式使用AI编码工具：用AI进行快速原型设计，但花时间了解生成代码的工作原理，除了学习AI的使用方法外，还学习基本的编程概念。</p>
<h2 data-id="heading-5">06 未来展望：AI编程的演进方向</h2>
<p>随着技术演进，我们可能会看到更擅长在现有基础上构建而不仅仅是重写的AI工具。当前的研究重点正在从单纯的代码生成转向理解复杂系统和维护架构连贯性。</p>
<p><strong>多模态能力</strong>将成为下一代AI编程工具的标配。这些工具不仅处理代码，还能集成视觉理解能力（UI截图、模型、图表）、口头语言对话和与环境（浏览器、终端、API）交互。</p>
<p>这种进步将使AI能够像人类一样全面地理解和使用软件。</p>
<p>在企业层面，<strong>AI治理</strong>将变得更加关键。随着AI从自由实验转向企业核心流程，组织需要建立明确的AI治理策略，在创新和风险之间取得平衡。</p>
<p>REI Systems已经走在前列，他们确保所有AI生成的代码都经过严格的审查流程，并维护详细的审计日志，记录系统所做的每一个更改。</p>
<p>最后，我们可能会看到AI编程工具在不同阶段出现更专门化的分工。一些工具可能专注于极速原型设计，而另一些则专注于系统维护和渐进式改进。</p>
<p>这种专业化将使团队能够根据项目阶段选择最合适的工具。</p>
<hr/>
<p>在REI Systems的政府项目实践中，他们发现AI生成的代码必须通过<strong>与手动编写代码相同的严格审查</strong>。这种严谨态度使得他们能在关键任务系统中安全地利用AI的优势。</p>
<p>而那位用AI在三天内搭建电商系统的创业者，在系统崩溃后才发现：<strong>AI能给你速度，但给不了深度</strong>。修复那些深层逻辑漏洞的时间，远超手动编码的两倍。</p>
<p>未来的赢家，将是那些把AI当作“思维杠杆”的人：用工具突破认知边界，在机器效率与人类创造力之间找到平衡点。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python与C++：从哲学到细节的全面对比]]></title>    <link>https://juejin.cn/post/7574978847152013352</link>    <guid>https://juejin.cn/post/7574978847152013352</guid>    <pubDate>2025-11-21T15:03:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574978847152013352" data-draft-id="7574978847151996968" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python与C++：从哲学到细节的全面对比"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-21T15:03:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python与C++：从哲学到细节的全面对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T15:03:46.000Z" title="Fri Nov 21 2025 15:03:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Python和C++是两种在当今软件开发领域占据主导地位的语言，但它们的定位、设计哲学和应用场景有着天壤之别。Python以其简洁、直观的语法和“内置电池”的理念，致力于让开发者用更少的代码做更多的事，强调开发效率和可读性。而C++则是由C语言发展而来，以其对硬件底层的控制能力、极高的运行效率和灵活性著称，信奉“零开销抽象”原则，即你不用的东西不需要付出代价，你用的东西则能被最优地实现。</p>
<p>下面，我们将从整体到细节，系统地剖析这两种语言的差异。</p>
<h4 data-id="heading-0"><strong>一、整体与哲学</strong></h4>
<ol>
<li>
<p><strong>设计哲学</strong></p>
<ul>
<li><strong>Python</strong>： 遵循“优美胜于丑陋，明了胜于晦涩，简洁胜于复杂”。它是一种<strong>解释型、高级、动态类型</strong>语言，代码像伪代码一样易于阅读和理解。</li>
<li><strong>C++</strong>： 遵循“信任程序员，不增加额外开销”，并支持多种编程范式（面向过程、面向对象、泛型、函数式）。它是一种<strong>编译型、中级、静态类型</strong>语言，赋予程序员极大的权力，同时也要求承担更多的责任（如内存管理）。</li>
</ul>
</li>
<li>
<p><strong>执行模型</strong></p>
<ul>
<li><strong>Python</strong>： 代码由Python解释器逐行读取、解释并执行。这带来了跨平台的一致性和动态性，但牺牲了原生运行速度。</li>
<li><strong>C++</strong>： 代码必须通过编译器（如GCC, Clang, MSVC）预先编译成与特定平台相关的机器码（二进制可执行文件）。这个过程虽然复杂，但产生了高效的、可直接由CPU执行的程序。</li>
</ul>
</li>
<li>
<p><strong>应用领域</strong></p>
<ul>
<li><strong>Python</strong>： <strong>数据科学、机器学习、Web后端（Django/Flask）、自动化脚本、DevOps、科学计算、教育</strong>。适合快速原型开发和对执行速度要求不高的场景。</li>
<li><strong>C++</strong>： <strong>游戏开发、操作系统、浏览器、数据库、高频交易系统、嵌入式系统、图形图像处理、性能密集型桌面应用</strong>。适合开发底层系统和对性能有极致要求的应用。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-1"><strong>二、语法与语言特性</strong></h4>
<ol>
<li>
<p><strong>代码块与语法</strong></p>
<ul>
<li><strong>Python</strong>： 使用<strong>缩进</strong>来定义代码块（如<code>if</code>, <code>for</code>, 函数和类）。强制性的缩进规则使得代码风格高度统一，极具可读性。
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> x &gt; <span class="hljs-number">0</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Positive"</span>)
    do_something()
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Non-positive"</span>)
</code></pre>
</li>
<li><strong>C++</strong>： 使用**花括号<code>{}</code>**来定义代码块。缩进是出于可读性考虑，对编译器而言是可选的。
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">if</span> (x &gt; <span class="hljs-number">0</span>) {
    std::cout &lt;&lt; <span class="hljs-string">"Positive"</span> &lt;&lt; std::endl;
    <span class="hljs-built_in">doSomething</span>();
} <span class="hljs-keyword">else</span> {
    std::cout &lt;&lt; <span class="hljs-string">"Non-positive"</span> &lt;&lt; std::endl;
}
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>变量与类型系统</strong></p>
<ul>
<li><strong>Python</strong>： <strong>动态类型</strong>。变量在声明时无需指定类型，其类型在运行时由赋予它的值决定，并且可以改变。
<pre><code class="hljs language-python" lang="python">x = <span class="hljs-number">10</span>        <span class="hljs-comment"># x 是整数</span>
x = <span class="hljs-string">"hello"</span>   <span class="hljs-comment"># 现在 x 是字符串</span>
</code></pre>
</li>
<li><strong>C++</strong>： <strong>静态类型</strong>。每个变量在使用前必须明确定义其类型，且类型在编译时确定，不可更改。
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">int</span> x = <span class="hljs-number">10</span>;    <span class="hljs-comment">// x 永远是整数类型</span>
<span class="hljs-comment">// x = "hello"; // 错误：无法将字符串字面值分配给整型变量</span>
std::string s = <span class="hljs-string">"hello"</span>; <span class="hljs-comment">// s 是字符串类型</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>内存管理</strong></p>
<ul>
<li><strong>Python</strong>： 拥有<strong>垃圾回收机制</strong>。开发者无需手动管理内存，解释器会自动回收不再使用的对象所占用的内存。这极大地减少了内存泄漏和悬空指针的风险。</li>
<li><strong>C++</strong>： <strong>手动内存管理</strong>。开发者需要自己使用<code>new</code>/<code>delete</code>或<code>malloc</code>/<code>free</code>来分配和释放堆内存。现代C++推荐使用<strong>智能指针</strong>（<code>std::unique_ptr</code>, <code>std::shared_ptr</code>）来实现自动的、基于作用域的内存管理，但理解其底层原理仍然至关重要。</li>
</ul>
</li>
<li>
<p><strong>函数与参数传递</strong></p>
<ul>
<li><strong>Python</strong>： 参数传递是**“对象引用传递”**。对于可变对象（如列表），在函数内修改会影响到原始对象；对于不可变对象（如整数、字符串），则不会。
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">append_to_list</span>(<span class="hljs-params">lst</span>):
    lst.append(<span class="hljs-number">4</span>) <span class="hljs-comment"># 修改会影响原始列表</span>

my_list = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
append_to_list(my_list)
<span class="hljs-built_in">print</span>(my_list) <span class="hljs-comment"># 输出 [1, 2, 3, 4]</span>
</code></pre>
</li>
<li><strong>C++</strong>： 支持多种参数传递方式，需要显式指定：
<ul>
<li><strong>传值</strong>： 创建副本，函数内修改不影响原始数据。</li>
<li><strong>传引用</strong>： 不创建副本，函数内修改直接影响原始数据。</li>
<li><strong>传指针</strong>： 类似传引用，但语法和安全性不同。</li>
<li><strong>常量引用</strong>： 为了避免拷贝大型对象，同时防止函数修改它。</li>
</ul>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">byValue</span><span class="hljs-params">(<span class="hljs-type">int</span> a)</span> </span>{ a = <span class="hljs-number">100</span>; } <span class="hljs-comment">// 不影响原变量</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">byReference</span><span class="hljs-params">(<span class="hljs-type">int</span> &amp;a)</span> </span>{ a = <span class="hljs-number">100</span>; } <span class="hljs-comment">// 影响原变量</span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">int</span> x = <span class="hljs-number">10</span>;
    <span class="hljs-built_in">byValue</span>(x); <span class="hljs-comment">// x 仍然是 10</span>
    <span class="hljs-built_in">byReference</span>(x); <span class="hljs-comment">// x 变成了 100</span>
}
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>面向对象编程</strong></p>
<ul>
<li><strong>Python</strong>： 支持多重继承。所有成员变量和方法默认都是<code>public</code>的。通过命名约定（如单下划线<code>_var</code>表示保护，双下划线<code>__var</code>表示私有）来实现封装。
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name</span>):
        self.name = name <span class="hljs-comment"># 公有成员</span>
        self._protected_var = <span class="hljs-number">1</span>
        self.__private_var = <span class="hljs-number">2</span>
</code></pre>
</li>
<li><strong>C++</strong>： 拥有精细的访问控制符：<code>public</code>, <code>protected</code>, <code>private</code>。支持多重继承，但更推荐使用单继承和接口（纯虚类）。
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> {
<span class="hljs-keyword">public</span>:
    std::string name;
    <span class="hljs-built_in">MyClass</span>(<span class="hljs-type">const</span> std::string&amp; n) : <span class="hljs-built_in">name</span>(n) {}
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">int</span> privateVar;
};
</code></pre>
</li>
</ul>
</li>
</ol>
<h4 data-id="heading-2"><strong>三、性能与生态系统</strong></h4>
<ol>
<li>
<p><strong>性能</strong></p>
<ul>
<li><strong>C++</strong>： <strong>性能极高</strong>。编译成本地机器码，直接与操作系统和硬件交互。手动内存管理和零开销抽象原则使得程序可以高度优化，运行时开销极小。</li>
<li><strong>Python</strong>： <strong>性能较低</strong>。作为解释型语言，存在解释器开销。其动态类型特性也使得运行时需要进行类型检查，进一步降低了速度。不过，可以通过调用C/C++扩展库（如NumPy, SciPy）来弥补性能瓶颈，这些库的核心部分是用C/Fortran实现的。</li>
</ul>
</li>
<li>
<p><strong>标准库与生态系统</strong></p>
<ul>
<li><strong>Python</strong>： 以其“内置电池”哲学而闻名，提供了极其丰富和强大的标准库，涵盖了文件处理、网络通信、数据结构、操作系统接口等。第三方库生态（通过PyPI）更是无比繁荣，尤其在AI和数据科学领域。</li>
<li><strong>C++</strong>： 标准库（STL）相对更基础，但提供了强大的通用容器（<code>vector</code>, <code>map</code>）、算法和输入输出功能。其生态系统由许多大型、独立的库组成（如Boost, Qt, OpenCV），这些库功能专一且性能强大。</li>
</ul>
</li>
<li>
<p><strong>学习曲线与开发效率</strong></p>
<ul>
<li><strong>Python</strong>： <strong>学习曲线平缓</strong>。语法直观，可以快速上手并产出成果。<strong>开发效率极高</strong>，非常适合快速迭代和原型开发。</li>
<li><strong>C++</strong>： <strong>学习曲线陡峭</strong>。程序员需要理解复杂的概念，如内存管理、指针、模板、移动语义等。编译-链接-调试的周期较长，<strong>开发效率相对较低</strong>。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-3"><strong>总结</strong></h4>


















































<table><thead><tr><th align="left">特性</th><th align="left">Python</th><th align="left">C++</th></tr></thead><tbody><tr><td align="left"><strong>类型</strong></td><td align="left">动态类型</td><td align="left">静态类型</td></tr><tr><td align="left"><strong>执行</strong></td><td align="left">解释执行</td><td align="left">编译执行</td></tr><tr><td align="left"><strong>语法</strong></td><td align="left">缩进定义块</td><td align="left">花括号定义块</td></tr><tr><td align="left"><strong>内存管理</strong></td><td align="left">自动垃圾回收</td><td align="left">手动管理/智能指针</td></tr><tr><td align="left"><strong>性能</strong></td><td align="left">较低</td><td align="left">极高</td></tr><tr><td align="left"><strong>学习曲线</strong></td><td align="left">平缓</td><td align="left">陡峭</td></tr><tr><td align="left"><strong>开发效率</strong></td><td align="left">高</td><td align="left">低</td></tr><tr><td align="left"><strong>主要领域</strong></td><td align="left">Web、AI、数据科学、脚本</td><td align="left">游戏、系统、嵌入式、高性能计算</td></tr></tbody></table>
<p><strong>结论：</strong></p>
<p>选择Python还是C++，并非是一个孰优孰劣的问题，而是一个<strong>权衡</strong>的问题。</p>
<ul>
<li>当你需要<strong>快速开发、易于学习、专注于业务逻辑和算法本身</strong>，而对极致性能要求不高时，<strong>Python</strong>是理想的选择。</li>
<li>当你需要<strong>对硬件进行精细控制、榨干每一寸性能、开发底层系统或资源受限的应用</strong>时，<strong>C++</strong> 是无可替代的工具。</li>
</ul>
<p>在许多现代项目中，两者甚至会结合使用：用Python作为上层胶水语言，快速构建应用逻辑和原型，而用C++编写核心的性能瓶颈模块，通过Python的扩展接口进行调用，从而实现开发效率和运行效率的完美结合。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js第九章(AI)]]></title>    <link>https://juejin.cn/post/7574916588719538218</link>    <guid>https://juejin.cn/post/7574916588719538218</guid>    <pubDate>2025-11-21T13:24:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574916588719538218" data-draft-id="7574916588719521834" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js第九章(AI)"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-21T13:24:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小满zs"/> <meta itemprop="url" content="https://juejin.cn/user/2463384809252397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js第九章(AI)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2463384809252397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小满zs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T13:24:50.000Z" title="Fri Nov 21 2025 13:24:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">AI</h2>
<p>Vercel提供了AI SDK，可以让我们在Next.js中轻松集成AI功能。<a href="https://link.juejin.cn?target=https%3A%2F%2Fai-sdk.dev%2Fgetting-started" target="_blank" title="https://ai-sdk.dev/getting-started" ref="nofollow noopener noreferrer">AI SDK 官网</a></p>
<h4 data-id="heading-1">安装AI-SDK</h4>
<pre><code class="hljs language-sh" lang="sh">npm i ai @ai-sdk/deepseek @ai-sdk/react
</code></pre>
<p>这儿我们使用<code>deepseek</code>作为AI模型，<code>@ai-sdk/react</code>封装了流式输出和上下文管理hook，可以让我们在Next.js中轻松集成AI功能。如果你要安装其他模型，只需要将<code>deepseek</code>替换为其他模型即可。</p>
<p>例如：安装<code>openai</code>模型</p>
<pre><code class="hljs language-sh" lang="sh">npm i ai @ai-sdk/openai @ai-sdk/react
</code></pre>
<blockquote>
<p>为什么使用<code>deepseek</code>模型？因为<code>deepseek</code>比较便宜，充10元可以测试很久(非广告)。</p>
</blockquote>
<h4 data-id="heading-2">获取deepSeek API Key</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b389b99973b48f483f7d3ea52bddc6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764336290&amp;x-signature=6KRncuUWJT7bgvIrd4t7eRTZr1I%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afdb38c5928a4b319f5790d732cd7b16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764336290&amp;x-signature=Zl1EeQPi9jh3iLQUdOPyKtx51hw%3D" alt="image.png" loading="lazy"/></p>
<p>然后把生成的API Key复制一下保存起来。</p>
<h4 data-id="heading-3">编写API接口</h4>
<p>src/app/api/chat/route.ts</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextRequest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/server"</span>;
<span class="hljs-keyword">import</span> { streamText,convertToModelMessages } <span class="hljs-keyword">from</span> <span class="hljs-string">'ai'</span>
<span class="hljs-keyword">import</span> { createDeepSeek } <span class="hljs-keyword">from</span> <span class="hljs-string">"@ai-sdk/deepseek"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">DEEPSEEK_API_KEY</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./key"</span>;
<span class="hljs-keyword">const</span> deepSeek = <span class="hljs-title function_">createDeepSeek</span>({
    <span class="hljs-attr">apiKey</span>: <span class="hljs-variable constant_">DEEPSEEK_API_KEY</span>, <span class="hljs-comment">//设置API密钥</span>
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">POST</span>(<span class="hljs-params">req: NextRequest</span>) {
    <span class="hljs-keyword">const</span> { messages } = <span class="hljs-keyword">await</span> req.<span class="hljs-title function_">json</span>(); <span class="hljs-comment">//获取请求体</span>
    <span class="hljs-comment">//这里为什么接受messages 因为我们使用前端的useChat 他会自动注入这个参数，所有可以直接读取</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">streamText</span>({
        <span class="hljs-attr">model</span>: <span class="hljs-title function_">deepSeek</span>(<span class="hljs-string">'deepseek-chat'</span>), <span class="hljs-comment">//使用deepseek-chat模型</span>
        <span class="hljs-attr">messages</span>:<span class="hljs-title function_">convertToModelMessages</span>(messages), <span class="hljs-comment">//转换为模型消息</span>
        <span class="hljs-comment">//前端传过来的额messages不符合sdk格式所以需要convertToModelMessages转换一下</span>
        <span class="hljs-comment">//转换之后的格式：</span>
        <span class="hljs-comment">//[</span>
            <span class="hljs-comment">//{ role: 'user', content: [ [Object] ] },</span>
            <span class="hljs-comment">//{ role: 'assistant', content: [ [Object] ] },</span>
            <span class="hljs-comment">//{ role: 'user', content: [ [Object] ] },</span>
            <span class="hljs-comment">//{ role: 'assistant', content: [ [Object] ] },</span>
            <span class="hljs-comment">//{ role: 'user', content: [ [Object] ] },</span>
            <span class="hljs-comment">//{ role: 'assistant', content: [ [Object] ] },</span>
            <span class="hljs-comment">//{ role: 'user', content: [ [Object] ] }</span>
        <span class="hljs-comment">//]</span>
        <span class="hljs-attr">system</span>: <span class="hljs-string">'你是一个高级程序员，请根据用户的问题给出回答'</span>, <span class="hljs-comment">//系统提示词</span>
    });
   
    <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">toUIMessageStreamResponse</span>() <span class="hljs-comment">//返回流式响应</span>
}
</code></pre>
<p>src/app/page.tsx</p>
<p>我们在前端使用<code>useChat</code>组件来实现AI对话，这个组件内部封装了流式响应，默认会向<code>/api/chat</code>发送请求。</p>
<ul>
<li><code>messages</code>: 消息列表，包含用户和AI的对话内容</li>
<li><code>sendMessage</code>: 发送消息的函数，参数为消息内容</li>
<li><code>onFinish</code>: 消息发送完成后回调函数，可以在这里进行一些操作，例如清空输入框</li>
</ul>
<p><strong>messages</strong>：数据结构解析</p>
<pre><code class="hljs language-ts" lang="ts">[
    {
        <span class="hljs-string">"parts"</span>: [
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-comment">//文本类型</span>
                <span class="hljs-string">"text"</span>: <span class="hljs-string">"你知道 api router 吗"</span>
            }
        ],
        <span class="hljs-string">"id"</span>: <span class="hljs-string">"FPHwY1udRrkEoYgR"</span>, <span class="hljs-comment">//消息ID</span>
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span> <span class="hljs-comment">//用户角色</span>
    },
    {
        <span class="hljs-string">"id"</span>: <span class="hljs-string">"qno6vcWcwFM4Yc8J"</span>, <span class="hljs-comment">//消息ID</span>
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-comment">//AI角色</span>
        <span class="hljs-string">"parts"</span>: [
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"step-start"</span> <span class="hljs-comment">//步骤开始 </span>
            },
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-comment">//文本类型</span>
                <span class="hljs-string">"text"</span>: <span class="hljs-string">"是的，我知道 **API Router**。"</span>, <span class="hljs-comment">//文本内容</span>
                <span class="hljs-string">"state"</span>: <span class="hljs-string">"done"</span> <span class="hljs-comment">//步骤完成</span>
            }
        ]
    }
]
</code></pre>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-string">'use client'</span>;
<span class="hljs-keyword">import</span> { useState, useRef, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ui/button'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Textarea</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ui/textarea'</span>;
<span class="hljs-keyword">import</span> { useChat } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ai-sdk/react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">HomePage</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [input, setInput] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>); <span class="hljs-comment">//输入框的值</span>
    <span class="hljs-keyword">const</span> messagesEndRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>); <span class="hljs-comment">//获取消息结束的ref</span>
    <span class="hljs-comment">//useChat 内部封装了流式响应 默认会向/api/chat 发送请求</span>
    <span class="hljs-keyword">const</span> { messages, sendMessage } = <span class="hljs-title function_">useChat</span>({
        <span class="hljs-attr">onFinish</span>: <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">setInput</span>(<span class="hljs-string">''</span>);
        }
    });

    <span class="hljs-comment">// 自动滚动到底部</span>
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        messagesEndRef.<span class="hljs-property">current</span>?.<span class="hljs-title function_">scrollIntoView</span>({ <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span> });
    }, [messages]);
    <span class="hljs-comment">//回车发送消息</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleKeyDown</span> = (<span class="hljs-params">e: React.KeyboardEvent&lt;HTMLTextAreaElement&gt;</span>) =&gt; {
        <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'Enter'</span> &amp;&amp; !e.<span class="hljs-property">shiftKey</span>) {
            e.<span class="hljs-title function_">preventDefault</span>();
            <span class="hljs-keyword">if</span> (input.<span class="hljs-title function_">trim</span>()) {
                <span class="hljs-title function_">sendMessage</span>({ <span class="hljs-attr">text</span>: input });
            }
        }
    };

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'flex flex-col h-screen bg-linear-to-br from-blue-50 via-white to-purple-50'</span>&gt;</span>
            {/* 头部标题 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'bg-white/80 backdrop-blur-sm shadow-sm border-b border-gray-200'</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'max-w-4xl mx-auto px-6 py-4'</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'text-2xl font-bold bg-linear-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent'</span>&gt;</span>
                        AI 智能助手
                    <span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'text-sm text-gray-500 mt-1'</span>&gt;</span>随时为您解答问题<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

            {/* 消息区域 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'flex-1 overflow-y-auto px-4 py-6'</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'max-w-4xl mx-auto space-y-4'</span>&gt;</span>
                    {messages.length === 0 ? (
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'flex flex-col items-center justify-center h-full text-center py-20'</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'bg-linear-to-br from-blue-100 to-purple-100 rounded-full p-6 mb-4'</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'w-12 h-12 text-blue-600'</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">'none'</span> <span class="hljs-attr">stroke</span>=<span class="hljs-string">'currentColor'</span> <span class="hljs-attr">viewBox</span>=<span class="hljs-string">'0 0 24 24'</span>&gt;</span>
                                    <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">strokeLinecap</span>=<span class="hljs-string">'round'</span> <span class="hljs-attr">strokeLinejoin</span>=<span class="hljs-string">'round'</span> <span class="hljs-attr">strokeWidth</span>=<span class="hljs-string">{2}</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z'</span> /&gt;</span>
                                <span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'text-xl font-semibold text-gray-700 mb-2'</span>&gt;</span>开始对话<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'text-gray-500'</span>&gt;</span>输入您的问题，我会尽力帮助您<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    ) : (
                        messages.map((message) =&gt; (
                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
                                <span class="hljs-attr">key</span>=<span class="hljs-string">{message.id}</span>
                                <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">flex</span> ${<span class="hljs-attr">message.role</span> === <span class="hljs-string">'user'</span> ? '<span class="hljs-attr">justify-end</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">justify-start</span>'} <span class="hljs-attr">animate-in</span> <span class="hljs-attr">fade-in</span> <span class="hljs-attr">slide-in-from-bottom-4</span> <span class="hljs-attr">duration-500</span>`}
                            &gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">flex</span> <span class="hljs-attr">gap-3</span> <span class="hljs-attr">max-w-</span>[<span class="hljs-attr">80</span>%] ${<span class="hljs-attr">message.role</span> === <span class="hljs-string">'user'</span> ? '<span class="hljs-attr">flex-row-reverse</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">flex-row</span>'}`}&gt;</span>
                                    {/* 头像 */}
                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">shrink-0</span> <span class="hljs-attr">w-8</span> <span class="hljs-attr">h-8</span> <span class="hljs-attr">rounded-full</span> <span class="hljs-attr">flex</span> <span class="hljs-attr">items-center</span> <span class="hljs-attr">justify-center</span> <span class="hljs-attr">text-white</span> <span class="hljs-attr">font-semibold</span> ${
                                        <span class="hljs-attr">message.role</span> === <span class="hljs-string">'user'</span> 
                                            ? '<span class="hljs-attr">bg-linear-to-br</span> <span class="hljs-attr">from-blue-500</span> <span class="hljs-attr">to-blue-600</span>' 
                                            <span class="hljs-attr">:</span> '<span class="hljs-attr">bg-linear-to-br</span> <span class="hljs-attr">from-purple-500</span> <span class="hljs-attr">to-purple-600</span>'
                                    }`}&gt;</span>
                                        {message.role === 'user' ? '你' : 'AI'}
                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                                    
                                    {/* 消息内容 */}
                                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">flex</span> <span class="hljs-attr">flex-col</span> ${<span class="hljs-attr">message.role</span> === <span class="hljs-string">'user'</span> ? '<span class="hljs-attr">items-end</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">items-start</span>'}`}&gt;</span>
                                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">rounded-2xl</span> <span class="hljs-attr">px-4</span> <span class="hljs-attr">py-3</span> <span class="hljs-attr">shadow-sm</span> ${
                                            <span class="hljs-attr">message.role</span> === <span class="hljs-string">'user'</span>
                                                ? '<span class="hljs-attr">bg-linear-to-br</span> <span class="hljs-attr">from-blue-500</span> <span class="hljs-attr">to-blue-600</span> <span class="hljs-attr">text-white</span>'
                                                <span class="hljs-attr">:</span> '<span class="hljs-attr">bg-white</span> <span class="hljs-attr">border</span> <span class="hljs-attr">border-gray-200</span> <span class="hljs-attr">text-gray-800</span>'
                                        }`}&gt;</span>
                                            {message.parts.map((part, index) =&gt; {
                                                switch (part.type) {
                                                    case 'text':
                                                        return (
                                                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{message.id</span> + <span class="hljs-attr">index</span>} <span class="hljs-attr">className</span>=<span class="hljs-string">'whitespace-pre-wrap wrap-break-word'</span>&gt;</span>
                                                                {part.text}
                                                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                                                        );
                                                }
                                            })}
                                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        ))
                    )}
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{messagesEndRef}</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

            {/* 输入区域 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'bg-white/80 backdrop-blur-sm border-t border-gray-200 shadow-lg'</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'max-w-4xl mx-auto px-4 py-4'</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'flex gap-3 items-end'</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'flex-1 relative'</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">Textarea</span>
                                <span class="hljs-attr">value</span>=<span class="hljs-string">{input}</span>
                                <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setInput(e.target.value)}
                                onKeyDown={handleKeyDown}
                                placeholder='请输入你的问题... (按 Enter 发送，Shift + Enter 换行)'
                                className='min-h-[60px] max-h-[200px] resize-none rounded-xl border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all shadow-sm'
                            /&gt;
                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
                            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> {
                                if (input.trim()) {
                                    sendMessage({ text: input });
                                }
                            }}
                            disabled={!input.trim()}
                            className='h-[60px] px-6 rounded-xl bg-linear-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed'
                        &gt;
                            <span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'w-5 h-5'</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">'none'</span> <span class="hljs-attr">stroke</span>=<span class="hljs-string">'currentColor'</span> <span class="hljs-attr">viewBox</span>=<span class="hljs-string">'0 0 24 24'</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">strokeLinecap</span>=<span class="hljs-string">'round'</span> <span class="hljs-attr">strokeLinejoin</span>=<span class="hljs-string">'round'</span> <span class="hljs-attr">strokeWidth</span>=<span class="hljs-string">{2}</span> <span class="hljs-attr">d</span>=<span class="hljs-string">'M12 19l9 2-9-18-9 18 9-2zm0 0v-8'</span> /&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f37ae3e6f2c40f48901a37251cabd7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764336290&amp;x-signature=HPVslXZQ2loQfJLIFrfmb5ONPQ8%3D" alt="5.gif" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 Cloudflare 服务中断，看建立多维度风险应对机制的必要]]></title>    <link>https://juejin.cn/post/7575006095388901385</link>    <guid>https://juejin.cn/post/7575006095388901385</guid>    <pubDate>2025-11-21T13:42:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575006095388901385" data-draft-id="7575006095388868617" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 Cloudflare 服务中断，看建立多维度风险应对机制的必要"/> <meta itemprop="keywords" content="人工智能,云计算,云原生"/> <meta itemprop="datePublished" content="2025-11-21T13:42:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AKAMAI"/> <meta itemprop="url" content="https://juejin.cn/user/829502942352628"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 Cloudflare 服务中断，看建立多维度风险应对机制的必要
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/829502942352628/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AKAMAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T13:42:52.000Z" title="Fri Nov 21 2025 13:42:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>11月18日，Cloudflare 出现技术问题，致使全球互联网多处停止运行，多个主要网站瘫痪。求职网站 Indeed、Anthropic 的 Claude 聊天机器人、X（前 Twitter）、电影评论网站 Letterboxd 等平台均受到波及，部分用户短暂无法访问。用户访问这些平台时，收到显示因 Cloudflare 问题导致页面无法加载的错误消息，成千上万的用户报告了相关问题 。</p>
<p>由于此次中断对许多高知名度网站造成了重大影响，该事件已被报道为全球突发新闻。Cloudflare 发言人表示，中断的“根本原因”是用于管理威胁流量的自动生成的配置文件，该文件“超出了预期的条目大小”，从而引发了处理多项服务流量的软件系统崩溃。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d539a9dafd94f4698b82b3d949143bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUtBTUFJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764337371&amp;x-signature=M0C0qZAYf5lkh6y0KQfLKHzunTE%3D" alt="" loading="lazy"/></p>
<p>（图片源自互联网）</p>
<p>无独有偶，在此前不久，在亚马逊发布相关服务不到一个月后，其 Web 服务便遭受了长达一天的中断，导致大量在线服务瘫痪。随后，Microsoft 在全球范围内也出现服务中断情况。</p>
<p>时间往前回溯，2024 年 7 月，网络安全公司 CrowdStrike 的一次错误升级导致大范围停电，不仅致使航班暂时停飞，金融服务受到严重冲击，还迫使医院推迟手术。</p>
<p>这些事件凸显了互联网安全的复杂性与脆弱性，即便是一个看似细微的配置问题，都可能引发大规模的服务中断，给企业和用户带来一定的损失。企业需要在危机发生之前，部署可靠、全面的安全解决方案来应对各种潜在问题与威胁。</p>
<p>Akamai 一直将弹性能力和防止宕机视为首要任务。正如负责这一全球最分布式计算平台团队的高级副总裁兼首席技术官 James Kretchmar 所说——</p>
<blockquote>
<p>虽然没有任何一家服务提供商能够完全免于风险，但选择那些始终坚持完善实践的提供商至关重要——包括弹性工程与架构级防护措施、稳健的运营与变更安全流程、完善的治理体系以及深入的情景预案规划，例如 Akamai。</p>
<p>作为网络安全领域的利益相关者与专家，Akamai 深知任何人都有可能遭受零日攻击或意料之外的漏洞影响。同样，我们也清楚全球最大的组织都依赖 Akamai，因此持续投入建设我们的平台始终是首要任务。</p>
</blockquote>
<p>借助Akamai 规模宏大、覆盖全球的平台，以及卓越的威胁监测能力，企业能够全天候、7×24h不间断地在本地与云环境中有效防范、精准检测并强力抵御各类网络威胁，进而树立品牌信任度，稳步实现企业愿景：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cde0d6e8e2a64ce3b0d2e75836c2fab7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUtBTUFJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764337371&amp;x-signature=21o30z5VcgpuT8wPiyDB48b6WW8%3D" alt="" loading="lazy"/></p>
<p>（图片源自互联网）</p>
<p>在超过25 年的时间里，Akamai 一直是全球各大顶级组织值得信赖的合作伙伴，包括：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc19114714aa4220bdbf3a90a450367f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUtBTUFJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764337371&amp;x-signature=C19DAIWmbs4I5Ch%2BjIXWWycrrRg%3D" alt="" loading="lazy"/></p>
<p>（图片源自互联网）</p>
<p>在我们所处的数字世界中，所有人都彼此紧密相连。Akamai 以平台的高弹性为荣，只为更好地支持全球企业。我们深知自己在客户业务中所扮演的重要角色，并对此高度重视。客户对 Akamai 的信任，是我们支持并保护数字世界的核心所在。</p>
<p>如您希望了解更多Akamai所提供的服务，欢迎您拨打 400-609-1609 预约咨询，您也可以<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fproducts%2Fweb-performance-optimization%23free-trial%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejin_251121_blogarticles229_end" target="_blank" title="https://www.akamai.com/zh/products/web-performance-optimization#free-trial?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejin_251121_blogarticles229_end" ref="nofollow noopener noreferrer">点击此处</a>，借助 Akamai 规模庞大的全球平台以及出色的威胁监测能力，在本地和云环境中防范、检测和抵御网络威胁，建立品牌信任度并实现您的愿景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[计算机毕业设计推荐：基于springboot的快递物流仓库管理系统【Java+spring boot+MySQL、Java项目、Java毕设、Java项目定制定]]></title>    <link>https://juejin.cn/post/7574972697677709348</link>    <guid>https://juejin.cn/post/7574972697677709348</guid>    <pubDate>2025-11-21T12:15:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574972697677709348" data-draft-id="7574996958516576275" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="计算机毕业设计推荐：基于springboot的快递物流仓库管理系统【Java+spring boot+MySQL、Java项目、Java毕设、Java项目定制定"/> <meta itemprop="keywords" content="Java,Spring Boot,MySQL"/> <meta itemprop="datePublished" content="2025-11-21T12:15:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="计算机毕业设计小途"/> <meta itemprop="url" content="https://juejin.cn/user/3344059640330504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            计算机毕业设计推荐：基于springboot的快递物流仓库管理系统【Java+spring boot+MySQL、Java项目、Java毕设、Java项目定制定
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3344059640330504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    计算机毕业设计小途
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T12:15:17.000Z" title="Fri Nov 21 2025 12:15:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>💖💖作者：计算机毕业设计小途
💙💙个人简介：曾长期从事计算机专业培训教学，本人也热爱上课教学，语言擅长Java、微信小程序、Python、Golang、安卓Android等，开发项目包括大数据、深度学习、网站、小程序、安卓、算法。平常会做一些项目定制化开发、代码讲解、答辩教学、文档编写、也懂一些降重方面的技巧。平常喜欢分享一些自己开发中遇到的问题的解决办法，也喜欢交流技术，大家有技术代码这一块的问题可以问我！
💛💛想说的话：感谢大家的关注与支持！
💜💜
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2501_92808674%2Fcategory_13011385.html" target="_blank" title="https://blog.csdn.net/2501_92808674/category_13011385.html" ref="nofollow noopener noreferrer">网站实战项目</a>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2501_92808674%2Fcategory_13011386.html" target="_blank" title="https://blog.csdn.net/2501_92808674/category_13011386.html" ref="nofollow noopener noreferrer">安卓/小程序实战项目</a>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2501_92808674%2Fcategory_13011387.html" target="_blank" title="https://blog.csdn.net/2501_92808674/category_13011387.html" ref="nofollow noopener noreferrer">大数据实战项目</a>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2501_92808674%2Fcategory_13011390.html%3Fspm%3D1001.2014.3001.5482" target="_blank" title="https://blog.csdn.net/2501_92808674/category_13011390.html?spm=1001.2014.3001.5482" ref="nofollow noopener noreferrer">深度学习实战项目</a></p>
</blockquote>
<p>@<a href="https://link.juejin.cn?target=%25E7%259B%25AE%25E5%25BD%2595" target="_blank" title="%E7%9B%AE%E5%BD%95" ref="nofollow noopener noreferrer">TOC</a></p>
<h2 data-id="heading-0">基于springboot的快递物流仓库管理系统介绍</h2>
<p>本《基于SpringBoot的快递物流仓库管理系统》是一套专为模拟和管理现代快递物流仓储业务而设计的综合性信息管理平台，旨在通过信息化手段实现对快递包裹从揽收到运输完成全生命周期的精细化管控。系统采用当前业界主流且成熟的前后端分离架构进行开发，后端核心技术栈为Java语言结合轻量级、高效率的SpringBoot框架，整合了Spring、SpringMVC与MyBatis，实现了业务逻辑与数据访问的清晰分层；前端界面则基于Vue.js框架，并选用ElementUI组件库进行构建，打造了美观、响应式且用户体验友好的操作界面。整体系统基于B/S架构，通过IDEA或PyCharm作为开发工具，并选用稳定可靠的MySQL关系型数据库作为数据持久化存储方案。在功能层面，系统全面覆盖了快递物流的核心运营环节，构建了一个完整的业务闭环：首先，系统提供了完善的基础数据管理功能，包括对司机信息、快递员信息、客户信息、快递类型以及物流仓库等基础档案的统一维护；其次，核心业务流程模块精确追踪了包裹的每一个动态节点，从“快递揽件”的源头信息录入，到“快递入库”与“快递出库”的仓储作业管理，再到“快递运输”的过程监控，直至“运输完成”的状态确认，确保了物流信息流的完整与准确。此外，系统还特别设计了与人力成本相关的“司机津贴”和“快递员津贴”管理模块，实现了对运营成本的初步核算。最后，系统还配备了基础的“系统管理”与“个人中心”功能，保障了系统的安全与个性化使用，并通过“系统首页”为用户提供了关键业务数据的可视化概览，从而构成了一个功能完备、流程清晰、技术先进的计算机毕业设计项目。</p>
<h2 data-id="heading-1">基于springboot的快递物流仓库管理系统演示视频</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1AZULBzExc%2F%3Fspm_id_from%3D333.1387.homepage.video_card.click" target="_blank" title="https://www.bilibili.com/video/BV1AZULBzExc/?spm_id_from=333.1387.homepage.video_card.click" ref="nofollow noopener noreferrer">演示视频</a></p>
<h2 data-id="heading-2">基于springboot的快递物流仓库管理系统演示图片</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36d62975c92a404186bbc663b58e3772~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V5Lia6K6-6K6h5bCP6YCU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764332117&amp;x-signature=JNZoHGTtTFpYUIXpLVsVFNTuMtY%3D" alt="仓库物流.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18f2830f33594e51ae7e8b09b93de563~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V5Lia6K6-6K6h5bCP6YCU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764332117&amp;x-signature=K6cErDCqyNu1JiYqS%2FCw9c%2BjOY8%3D" alt="客户信息.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35601eb79a83486c9d7f8c1cb4714473~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V5Lia6K6-6K6h5bCP6YCU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764332117&amp;x-signature=L1R1PwmoJC%2Fr04qdv%2FoDOQDAjxg%3D" alt="快递出库.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c74c4b5536a74dfeb7ea30990ce4e3ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V5Lia6K6-6K6h5bCP6YCU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764332117&amp;x-signature=ZevKebCKcXigFyrCSLCOwyRql%2F8%3D" alt="快递揽件.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/711cbd79bb454cf8ace9e8a0ac1e88e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V5Lia6K6-6K6h5bCP6YCU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764332117&amp;x-signature=ZGCDFco5rPSy9BL4OpOCuQo0%2FEk%3D" alt="快递入库.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56ae0aba6fd84665b12aa9fb9c81f5ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V5Lia6K6-6K6h5bCP6YCU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764332117&amp;x-signature=Ri27unHt6QJLTaQ05xl4JLAbwno%3D" alt="快递信息.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c54cec246564d22ba48208c76effa17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V5Lia6K6-6K6h5bCP6YCU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764332117&amp;x-signature=4qxbskUeQtsd%2FtVDhwRX3e21PXE%3D" alt="快递员津贴.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6013efdd7d2b4d1f8efb3edbb012d6c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V5Lia6K6-6K6h5bCP6YCU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764332117&amp;x-signature=6fMGdpTXl5r5ox6ADuUD86GEi0s%3D" alt="快递员信息.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3234cb79941f485b83532bc2e34fbb9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V5Lia6K6-6K6h5bCP6YCU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764332117&amp;x-signature=x1RIg5bUqfqhPDJP5T7vr4nUpZs%3D" alt="快递运输.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5973d3ceb2144c919724fc1828f81cb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V5Lia6K6-6K6h5bCP6YCU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764332117&amp;x-signature=HPE1aGd6FXyEz1tNvR0KWnxrINc%3D" alt="司机津贴.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5545ba3e4219408483a0a616eb0f0827~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V5Lia6K6-6K6h5bCP6YCU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764332117&amp;x-signature=GrCphB2XH1HQyuw8ug753Zwehlw%3D" alt="司机信息.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9cb83818b04495b92f38e73a4bd1e22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V5Lia6K6-6K6h5bCP6YCU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764332117&amp;x-signature=bK5S2zdDBPoa1HvGQlaCYoizBO8%3D" alt="运输完成.png" loading="lazy"/></p>
<h2 data-id="heading-3">基于springboot的快递物流仓库管理系统代码展示</h2>
<pre><code class="hljs language-dart" lang="dart">from pyspark.sql <span class="hljs-keyword">import</span> SparkSession
from pyspark.sql.functions <span class="hljs-keyword">import</span> col, when, count, avg, lit, round
# 初始化SparkSession，这是所有大数据处理的入口点
spark = SparkSession.builder.appName(<span class="hljs-string">"StrokeAnalysisSystem"</span>).master(<span class="hljs-string">"local[*]"</span>).getOrCreate()
# 模拟从HDFS或数据库加载数据到Spark DataFrame
# 实际项目中，这里会是 spark.read.csv(<span class="hljs-string">"hdfs://..."</span>) 或 spark.read.jdbc(...)
schema = <span class="hljs-string">"id INT, gender STRING, age DOUBLE, hypertension INT, heart_disease INT, ever_married STRING, work_type STRING, Residence_type STRING, avg_glucose_level DOUBLE, bmi DOUBLE, smoking_status STRING, stroke INT"</span>
# 此处使用模拟数据代替真实数据加载过程
mock_data = [(<span class="hljs-number">51676</span>, <span class="hljs-string">"Male"</span>, <span class="hljs-number">67.0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-string">"Yes"</span>, <span class="hljs-string">"Private"</span>, <span class="hljs-string">"Urban"</span>, <span class="hljs-number">228.69</span>, <span class="hljs-number">36.6</span>, <span class="hljs-string">"formerly smoked"</span>, <span class="hljs-number">1</span>),
             (<span class="hljs-number">31112</span>, <span class="hljs-string">"Male"</span>, <span class="hljs-number">80.0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-string">"Yes"</span>, <span class="hljs-string">"Private"</span>, <span class="hljs-string">"Rural"</span>, <span class="hljs-number">105.92</span>, <span class="hljs-number">32.5</span>, <span class="hljs-string">"never smoked"</span>, <span class="hljs-number">1</span>),
             (<span class="hljs-number">60182</span>, <span class="hljs-string">"Female"</span>, <span class="hljs-number">49.0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"Yes"</span>, <span class="hljs-string">"Private"</span>, <span class="hljs-string">"Urban"</span>, <span class="hljs-number">171.23</span>, <span class="hljs-number">34.4</span>, <span class="hljs-string">"smokes"</span>, <span class="hljs-number">1</span>),
             (<span class="hljs-number">1665</span>, <span class="hljs-string">"Female"</span>, <span class="hljs-number">79.0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"Yes"</span>, <span class="hljs-string">"Self-employed"</span>, <span class="hljs-string">"Rural"</span>, <span class="hljs-number">174.12</span>, <span class="hljs-number">24.0</span>, <span class="hljs-string">"never smoked"</span>, <span class="hljs-number">1</span>),
             (<span class="hljs-number">58202</span>, <span class="hljs-string">"Male"</span>, <span class="hljs-number">81.0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"Yes"</span>, <span class="hljs-string">"Private"</span>, <span class="hljs-string">"Urban"</span>, <span class="hljs-number">186.21</span>, <span class="hljs-number">29.0</span>, <span class="hljs-string">"formerly smoked"</span>, <span class="hljs-number">1</span>),
             (<span class="hljs-number">7009</span>, <span class="hljs-string">"Female"</span>, <span class="hljs-number">50.0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"Yes"</span>, <span class="hljs-string">"Private"</span>, <span class="hljs-string">"Urban"</span>, <span class="hljs-number">88.5</span>, <span class="hljs-number">27.5</span>, <span class="hljs-string">"never smoked"</span>, <span class="hljs-number">0</span>),
             (<span class="hljs-number">47649</span>, <span class="hljs-string">"Female"</span>, <span class="hljs-number">25.0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"No"</span>, <span class="hljs-string">"Private"</span>, <span class="hljs-string">"Rural"</span>, <span class="hljs-number">92.5</span>, <span class="hljs-number">22.5</span>, <span class="hljs-string">"smokes"</span>, <span class="hljs-number">0</span>),
             (<span class="hljs-number">12175</span>, <span class="hljs-string">"Male"</span>, <span class="hljs-number">45.0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"Yes"</span>, <span class="hljs-string">"Govt_job"</span>, <span class="hljs-string">"Urban"</span>, <span class="hljs-number">110.5</span>, <span class="hljs-number">33.5</span>, <span class="hljs-string">"never smoked"</span>, <span class="hljs-number">0</span>)]
patient_df = spark.createDataFrame(mock_data, schema)
# ======================== <span class="hljs-number">1.</span> 高风险特征组合画像分析核心代码 ========================
def analyze_high_risk_profiles(df, risk_threshold=<span class="hljs-number">0.6</span>):
    <span class="hljs-string">"""
    分析高风险特征组合，找出中风概率超过阈值的群体画像。
    例如：分析同时患有高血压和心脏病的群体的中风风险。
    """</span>
    # 选择关键的二元特征进行组合分析：高血压、心脏病
    # 使用 a.alias() 来避免列名冲突，并提高代码可读性
    feature_combinations_df = df.groupBy(<span class="hljs-string">"hypertension"</span>, <span class="hljs-string">"heart_disease"</span>, <span class="hljs-string">"smoking_status"</span>).agg(
        count(<span class="hljs-string">"*"</span>).alias(<span class="hljs-string">"total_count"</span>),
        count(when(col(<span class="hljs-string">"stroke"</span>) == <span class="hljs-number">1</span>, True)).alias(<span class="hljs-string">"stroke_count"</span>)
    )
    # 计算每个特征组合下的中风风险概率
    risk_analysis_df = feature_combinations_df.withColumn(
        <span class="hljs-string">"stroke_risk_rate"</span>, round(col(<span class="hljs-string">"stroke_count"</span>) / col(<span class="hljs-string">"total_count"</span>), <span class="hljs-number">4</span>)
    )
    # 筛选出总人数大于一定数量（例如<span class="hljs-number">1</span>人以上，避免小样本偏差）且风险率高于设定阈值的组合
    high_risk_profiles_df = risk_analysis_df.filter(
        (col(<span class="hljs-string">"total_count"</span>) &gt; <span class="hljs-number">1</span>) &amp; (col(<span class="hljs-string">"stroke_risk_rate"</span>) &gt;= risk_threshold)
    ).orderBy(col(<span class="hljs-string">"stroke_risk_rate"</span>).desc())
    # 为了方便前端Echarts等工具使用，将Spark DataFrame转换为JSON格式列表
    high_risk_results = high_risk_profiles_df.toJSON().map(lambda j: eval(j)).collect()
    # 构造最终返回给前端的数据结构
    formatted_results = []
    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> high_risk_results:
        profile_desc = f<span class="hljs-string">"高血压:{'是' if row['hypertension']==1 else '否'}, 心脏病:{'是' if row['heart_disease']==1 else '否'}, 吸烟:{row['smoking_status']}"</span>
        formatted_results.append({
            <span class="hljs-string">"profile"</span>: profile_desc,
            <span class="hljs-string">"totalCount"</span>: row[<span class="hljs-string">"total_count"</span>],
            <span class="hljs-string">"strokeCount"</span>: row[<span class="hljs-string">"stroke_count"</span>],
            <span class="hljs-string">"riskRate"</span>: row[<span class="hljs-string">"stroke_risk_rate"</span>]
        })
    <span class="hljs-keyword">return</span> formatted_results
# ======================== <span class="hljs-number">2.</span> 多维度交叉与深度钻取分析核心代码 ========================
def analyze_multi_dimensional_cross(df, dimensions, filters=None):
    <span class="hljs-string">"""
    根据前端请求的维度列表进行动态的交叉分析，并支持过滤条件进行钻取。
    例如：dimensions=["gender", "work_type"], filters={"Residence_type": "Urban"}
    """</span>
    # 应用钻取过滤条件
    filtered_df = df
    <span class="hljs-keyword">if</span> filters:
        <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> filters.items():
            filtered_df = filtered_df.filter(col(key) == value)
    # 检查传入的维度列表是否为空，如果为空则无法分组
    <span class="hljs-keyword">if</span> not dimensions:
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"error"</span>: <span class="hljs-string">"维度列表不能为空"</span>}
    # 使用传入的维度列表进行动态分组聚合
    cross_analysis_df = filtered_df.groupBy(*dimensions).agg(
        count(<span class="hljs-string">"*"</span>).alias(<span class="hljs-string">"total_count"</span>),
        count(when(col(<span class="hljs-string">"stroke"</span>) == <span class="hljs-number">1</span>, True)).alias(<span class="hljs-string">"stroke_count"</span>)
    )
    # 增加中风占比列，用于前端图表展示
    result_df = cross_analysis_df.withColumn(
        <span class="hljs-string">"stroke_percentage"</span>, round((col(<span class="hljs-string">"stroke_count"</span>) / col(<span class="hljs-string">"total_count"</span>)) * <span class="hljs-number">100</span>, <span class="hljs-number">2</span>)
    ).orderBy(*dimensions)
    # 将最终的分析结果转换为JSON格式，方便API返回
    analysis_results_list = result_df.toJSON().map(lambda j: eval(j)).collect()
    # 构造返回给前端的完整数据，包括维度信息和数据本身
    final_response = {
        <span class="hljs-string">"dimensions"</span>: dimensions,
        <span class="hljs-string">"filtersApplied"</span>: filters <span class="hljs-keyword">if</span> filters <span class="hljs-keyword">else</span> <span class="hljs-string">"无"</span>,
        <span class="hljs-string">"analysisData"</span>: analysis_results_list,
        <span class="hljs-string">"totalRecordsAnalyzed"</span>: result_df.count()
    }
    <span class="hljs-keyword">return</span> final_response
# ======================== <span class="hljs-number">3.</span> 中风核心风险因素关联分析核心代码 ========================
def analyze_risk_factor_correlation(df):
    <span class="hljs-string">"""
    分析核心健康指标（数值型变量）与是否中风的关联性。
    通过对比中风患者与非中风患者在这些指标上的平均值差异来体现关联度。
    """</span>
    # 选择需要进行关联分析的核心数值型指标
    numeric_factors = [<span class="hljs-string">"age"</span>, <span class="hljs-string">"avg_glucose_level"</span>, <span class="hljs-string">"bmi"</span>]
    # 构建聚合表达式列表，对每个指标计算平均值
    agg_expressions = [avg(col(factor)).alias(f<span class="hljs-string">"avg_{factor}"</span>) <span class="hljs-keyword">for</span> factor <span class="hljs-keyword">in</span> numeric_factors]
    # 按是否中风（stroke=<span class="hljs-number">0</span>或<span class="hljs-number">1</span>）进行分组，并应用上面的聚合表达式
    correlation_df = df.groupBy(<span class="hljs-string">"stroke"</span>).agg(*agg_expressions).orderBy(<span class="hljs-string">"stroke"</span>)
    # 清理列名，并对结果进行四舍五入，使其更适合展示
    <span class="hljs-keyword">for</span> factor <span class="hljs-keyword">in</span> numeric_factors:
        correlation_df = correlation_df.withColumn(
            f<span class="hljs-string">"avg_{factor}"</span>, round(col(f<span class="hljs-string">"avg_{factor}"</span>), <span class="hljs-number">2</span>)
        )
    # 将宽表（多列）转换为长表，这种格式更适合Echarts等图表库进行分组柱状图的渲染
    # 例如：(factor, stroke_group, value) -&gt; (age, <span class="hljs-number">0</span>, <span class="hljs-number">55.2</span>), (age, <span class="hljs-number">1</span>, <span class="hljs-number">78.5</span>)
    unpivoted_results = []
    collected_data = correlation_df.collect()
    stroke_group_data = collected_data[<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> len(collected_data) &gt; <span class="hljs-number">1</span> and collected_data[<span class="hljs-number">1</span>][<span class="hljs-string">'stroke'</span>] == <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> None
    non_stroke_group_data = collected_data[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> len(collected_data) &gt; <span class="hljs-number">0</span> and collected_data[<span class="hljs-number">0</span>][<span class="hljs-string">'stroke'</span>] == <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> None
    <span class="hljs-keyword">for</span> factor <span class="hljs-keyword">in</span> numeric_factors:
        factor_data = {<span class="hljs-string">"factorName"</span>: factor, <span class="hljs-string">"strokeValue"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"nonStrokeValue"</span>: <span class="hljs-number">0</span>}
        <span class="hljs-keyword">if</span> stroke_group_data:
            factor_data[<span class="hljs-string">"strokeValue"</span>] = stroke_group_data[f<span class="hljs-string">"avg_{factor}"</span>]
        <span class="hljs-keyword">if</span> non_stroke_group_data:
            factor_data[<span class="hljs-string">"nonStrokeValue"</span>] = non_stroke_group_data[f<span class="hljs-string">"avg_{factor}"</span>]
        unpivoted_results.append(factor_data)
    # 返回最终处理好的、适合前端渲染的数据
    <span class="hljs-keyword">return</span> unpivoted_results
# 模拟调用这些函数并打印结果
<span class="hljs-built_in">print</span>(<span class="hljs-string">"--- 高风险特征组合画像分析结果 ---"</span>)
<span class="hljs-built_in">print</span>(analyze_high_risk_profiles(patient_df, risk_threshold=<span class="hljs-number">0.5</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 多维度交叉与深度钻取分析结果 ---"</span>)
<span class="hljs-built_in">print</span>(analyze_multi_dimensional_cross(patient_df, dimensions=[<span class="hljs-string">"gender"</span>, <span class="hljs-string">"Residence_type"</span>]))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 中风核心风险因素关联分析结果 ---"</span>)
<span class="hljs-built_in">print</span>(analyze_risk_factor_correlation(patient_df))
</code></pre>
<h2 data-id="heading-4">基于springboot的快递物流仓库管理系统文档展示</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4c65e4fdb614c3794e891848a46d9d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V5Lia6K6-6K6h5bCP6YCU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764332117&amp;x-signature=0ygMDq%2Fidwl67sq%2B54qmS9ES5eM%3D" alt="文档.png" loading="lazy"/></p>
<blockquote>
<p>💖💖作者：计算机毕业设计小途
💙💙个人简介：曾长期从事计算机专业培训教学，本人也热爱上课教学，语言擅长Java、微信小程序、Python、Golang、安卓Android等，开发项目包括大数据、深度学习、网站、小程序、安卓、算法。平常会做一些项目定制化开发、代码讲解、答辩教学、文档编写、也懂一些降重方面的技巧。平常喜欢分享一些自己开发中遇到的问题的解决办法，也喜欢交流技术，大家有技术代码这一块的问题可以问我！
💛💛想说的话：感谢大家的关注与支持！
💜💜
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2501_92808674%2Fcategory_13011385.html" target="_blank" title="https://blog.csdn.net/2501_92808674/category_13011385.html" ref="nofollow noopener noreferrer">网站实战项目</a>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2501_92808674%2Fcategory_13011386.html" target="_blank" title="https://blog.csdn.net/2501_92808674/category_13011386.html" ref="nofollow noopener noreferrer">安卓/小程序实战项目</a>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2501_92808674%2Fcategory_13011387.html" target="_blank" title="https://blog.csdn.net/2501_92808674/category_13011387.html" ref="nofollow noopener noreferrer">大数据实战项目</a>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2501_92808674%2Fcategory_13011390.html" target="_blank" title="https://blog.csdn.net/2501_92808674/category_13011390.html" ref="nofollow noopener noreferrer">深度学习实战项目</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spec Kit 实践：从 Prompt 工程到规范驱动开发]]></title>    <link>https://juejin.cn/post/7574916588719505450</link>    <guid>https://juejin.cn/post/7574916588719505450</guid>    <pubDate>2025-11-21T12:51:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574916588719505450" data-draft-id="7575022279567228969" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spec Kit 实践：从 Prompt 工程到规范驱动开发"/> <meta itemprop="keywords" content="VibeCoding,AI编程"/> <meta itemprop="datePublished" content="2025-11-21T12:51:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="严老湿"/> <meta itemprop="url" content="https://juejin.cn/user/3034307824991006"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spec Kit 实践：从 Prompt 工程到规范驱动开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3034307824991006/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    严老湿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T12:51:49.000Z" title="Fri Nov 21 2025 12:51:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">当前 Vibe Coding 的困扰</h2>
<p>是否已经遇到过以下问题？</p>
<ul>
<li>花费大量时间编写和修改 Prompt，但 AI 生成的代码与预期不符？</li>
<li>完成需求后难以追溯设计原则和具体改动点？</li>
<li>开发完成后希望补充文档，但上下文已被压缩丢失？</li>
<li>编码规则和规范散落在不同编辑器中，缺乏统一管理？</li>
<li>难以建立标准化的 AI 编程流程和质量保障机制？</li>
</ul>
<p>例如下面的提示词语言排行榜：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66c4d0cc82574828a327a76abdfedff3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lil6ICB5rm_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334309&amp;x-signature=qkBKxCxbj8Dbi%2BPSY7MxxQDQfMQ%3D" alt="图源GitHub" loading="lazy"/></p>
<p>而 Spec Kit 提供了一种"规范即代码"的解决方案，旨在解决传统 Prompt 工程中存在的重复修改、缺乏系统性信息留存等问题。</p>
<h2 data-id="heading-1">什么是 Spec Kit</h2>
<p>Spec Kit 是 GitHub 团队近期推出的开发工具套件，倡导"规范即代码"的开发理念。</p>
<p>它引入了<strong>规范驱动开发</strong>的新型软件开发模式，通过 AI 技术提升代码质量和开发效率。其核心思想是将需求规格置于开发流程的中心，让开发者首先精确定义"做什么"和"为什么"，再由 AI 基于清晰的规范生成代码。</p>
<p>简而言之，Spec Kit 通过文档先行的方式，建立系统化的开发工作流。</p>
<h2 data-id="heading-2">环境准备与安装</h2>
<h3 data-id="heading-3">支持的环境</h3>
<p>目前 Spec Kit 支持 <strong>Claude</strong>、<strong>Gemini</strong>、<strong>Copilot</strong> 等 AI 助手。如果无法使用 Claude，也可以将模型替换为 Qwen、DeepSeek 等其他兼容模型。</p>
<p>本文以 Claude Code 作为演示环境。</p>
<h3 data-id="heading-4">系统要求</h3>
<ul>
<li>Python ≥ 3.11</li>
<li>Git（任意版本）</li>
</ul>
<h3 data-id="heading-5">安装步骤</h3>
<p>打开终端（PowerShell、Terminal 等），执行以下命令安装 specify-cli：</p>
<pre><code class="hljs language-shell" lang="shell">uv tool install specify-cli --from git+https://github.com/github/spec-kit.git
</code></pre>
<p>或在项目内直接安装：</p>
<pre><code class="hljs language-shell" lang="shell">uvx --from git+https://github.com/github/spec-kit.git specify init &lt;PROJECT_NAME&gt;
</code></pre>
<h2 data-id="heading-6">项目初始化</h2>
<p>在已有项目目录中执行初始化命令（<code>claude</code> 可替换为其他支持的 AI 助手）：</p>
<pre><code class="hljs language-shell" lang="shell">specify init . --ai claude
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de244bb2cac342d78d921a35de709bd8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lil6ICB5rm_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334309&amp;x-signature=KFEGFbCzq76tTAgehsLVb9FbzNY%3D" alt="" loading="lazy"/></p>
<p>初始化完成后，项目目录中会生成 <code>.specify</code> 目录，包含以下结构：</p>
<ul>
<li><code>memory/</code> - 存储项目级原则和规范</li>
<li><code>scripts/bash/</code> - Spec Kit 的调用脚本</li>
<li><code>template/</code> - 执行命令时使用的模板文件</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd0aa477d44b492c81d7ecc95fa4076e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lil6ICB5rm_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334309&amp;x-signature=zvkAWMiFElXW1NxWUGh5OadEUN0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">核心命令参考</h3>
<p>所有 Spec Kit 命令都以 <code>/speckit.</code> 开头：</p>


















































<table><thead><tr><th>命令</th><th>用途描述</th><th>使用时机</th></tr></thead><tbody><tr><td><code>/speckit.constitution</code></td><td>制定或更新项目级开发原则和指南</td><td>项目初始化或引入新规范时</td></tr><tr><td><code>/speckit.specify</code></td><td>明确需求范围和用户故事</td><td>开始新功能开发时</td></tr><tr><td><code>/speckit.plan</code></td><td>基于技术栈创建实施方案</td><td>需求明确后</td></tr><tr><td><code>/speckit.tasks</code></td><td>生成可执行的任务清单</td><td>方案确定后</td></tr><tr><td><code>/speckit.implement</code></td><td>按计划执行所有开发任务</td><td>任务分解完成后</td></tr><tr><td><code>/speckit.clarify</code></td><td>澄清需求中的模糊领域</td><td>制定计划前</td></tr><tr><td><code>/speckit.analyze</code></td><td>跨工件一致性和覆盖率分析</td><td>任务生成后，实施前</td></tr><tr><td><code>/speckit.checklist</code></td><td>生成质量检查清单</td><td>需求验证阶段</td></tr></tbody></table>
<p>常用的核心命令包括：<code>specify</code>、<code>plan</code>、<code>tasks</code>、<code>implement</code>。</p>
<p><code>constitution</code> 主要用于项目初始化阶段或引入新的技术规范时。<code>clarify</code> 用于补充说明需求中的边界条件。<code>checklist</code> 生成验证清单，类似于文本形式的测试用例。</p>
<p>以下是 Spec Kit 的完整工作和核心流程参考：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/033e43829e104419a45d33bd0f8de5ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lil6ICB5rm_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334309&amp;x-signature=N6ug4Vp1XzOydvXdRGT2qikNdCY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/884f094e9aae44ed8caf8c9e20566650~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lil6ICB5rm_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334309&amp;x-signature=ORMu9qQX0V%2F9jAGI8E3jK2MUfdU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">实战演示：二维码生成工具开发</h2>
<h3 data-id="heading-9">启动开发环境</h3>
<p>通过终端或编辑器插件启动 Claude Code（为提升效率，可启用 YOLO 模式跳过权限确认）：</p>
<pre><code class="hljs language-shell" lang="shell">claude --dangerously-skip-permissions
</code></pre>
<h3 data-id="heading-10">建立项目规范</h3>
<p>在对话中输入以下命令，可根据实际项目背景补充具体规范：</p>
<pre><code class="hljs language-shell" lang="shell">/speckit.constitution 创建专注于代码质量、测试标准、用户体验一致性和性能要求的原则。
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd6ab23fa4224fe2820f2b5e4ac5ce8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lil6ICB5rm_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334309&amp;x-signature=hbk%2B2%2BEEWJ6CSj0ZFyFcFleKmhM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30f03554bcc84827b8a06e62ca47fc11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lil6ICB5rm_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334309&amp;x-signature=GTu0j8tts%2FVaBCMbh%2B0vaYabRt8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">定义功能需求</h3>
<p>使用 specify 命令定义二维码生成工具的需求：</p>
<pre><code class="hljs language-shell" lang="shell">/speckit.specify 需要开发一个二维码生成工具库，支持 color、size、logo 等基本配置，提供使用示例，满足常见使用场景。
</code></pre>
<p>此步骤会生成 <code>spec.md</code> 和 <code>requirements.md</code>，明确功能需求和验收标准，为后续开发奠定基础。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/132186143deb486bb615b09162e54804~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lil6ICB5rm_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334309&amp;x-signature=B5wvDaCHV%2B3ib2LsKF54EwWZYro%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">澄清需求边界</h3>
<p>如果发现生成的需求存在模糊之处，可使用 clarify 进行澄清：</p>
<pre><code class="hljs language-shell" lang="shell">/speckit.clarify 不需要考虑 Node.js 环境，仅针对 Web 端使用。
</code></pre>
<p>clarify 会记录澄清过程，并提出其他需要明确的边界问题，通过交互式对话完善需求文档。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c387c63d3fcd42bb852176630c9b9dd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lil6ICB5rm_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334309&amp;x-signature=4JelOhleeg2lShE2hKEFlEEGegU%3D" alt="" loading="lazy"/></p>
<p>例如，系统可能会提出以下澄清问题：</p>
<p><strong>问题 1: Logo 图像输入方式</strong></p>
<pre><code class="hljs language-sql" lang="sql">基于用户明确只针对 Web 端使用，Logo 的输入方式需要明确。

推荐方案: 选项 C (File 对象<span class="hljs-operator">/</span><span class="hljs-type">Blob</span> <span class="hljs-operator">+</span> URL 字符串) <span class="hljs-operator">-</span>
覆盖 Web 开发中最常见的所有场景，实现复杂度适中。

<span class="hljs-operator">|</span> 选项    <span class="hljs-operator">|</span> 描述                                 <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span><span class="hljs-comment">-------|------------------------------------|</span>
<span class="hljs-operator">|</span> A     <span class="hljs-operator">|</span> 仅支持 URL 字符串                    <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> B     <span class="hljs-operator">|</span> 仅支持 File 对象或 <span class="hljs-type">Blob</span>              <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> C     <span class="hljs-operator">|</span> 同时支持 File 对象<span class="hljs-operator">/</span><span class="hljs-type">Blob</span> 和 URL 字符串 <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span> D     <span class="hljs-operator">|</span> 支持 HTMLImageElement 或 Canvas 元素 <span class="hljs-operator">|</span>

<span class="hljs-operator">&gt;</span> yes
</code></pre>
<p><strong>问题 2: 颜色对比度处理策略</strong></p>
<pre><code class="hljs language-less" lang="less">当用户设置的前景色和背景色对比度过低时，系统应该如何处理？

推荐方案: 选项 <span class="hljs-selector-tag">B</span> (警告但允许生成) <span class="hljs-selector-tag">-</span>
既尊重开发者的设计自由度，又通过警告提醒潜在问题。

| 选项    | 描述             |
|<span class="hljs-selector-tag">-------</span>|<span class="hljs-selector-tag">----------------</span>|
| <span class="hljs-selector-tag">A</span>     | 拒绝生成并返回错误  |
| <span class="hljs-selector-tag">B</span>     | 发出警告但仍允许生成 |
| <span class="hljs-selector-tag">C</span>     | 自动调整颜色对比度  |
| <span class="hljs-selector-tag">D</span>     | 静默生成不做提示    |

&gt; <span class="hljs-selector-tag">yes</span>
</code></pre>
<p>澄清过程会记录所有决策，确保需求文档的完整性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73cb1a4583a743dfabc6a5eab3f15024~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lil6ICB5rm_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334309&amp;x-signature=kHs46xBgaqQSTTcjXQJmfXC1BXE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">制定技术方案</h3>
<p>使用 plan 命令生成技术实施方案：</p>
<pre><code class="hljs language-shell" lang="shell">/speckit.plan
</code></pre>
<p>plan 会综合分析 spec.md、requirements.md 和 constitution.md，制定完整的技术方案，包括市场调研、技术选型和架构设计。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/064db304ba04404a97c630e903e88afa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lil6ICB5rm_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334309&amp;x-signature=Dn%2FC%2FOirJP5679y8A8s1ZBS9McM%3D" alt="" loading="lazy"/></p>
<p>系统会进行技术调研，分析现有解决方案，并基于调研结果设计数据模型和系统架构。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/863dce78e0a44705a4f7422769f4665a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lil6ICB5rm_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334309&amp;x-signature=WRUAfmxaA4dB2yVo7ablHK0G9tw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-14">任务分解与执行</h3>
<p>基于设计方案进行任务拆分：</p>
<pre><code class="hljs language-shell" lang="shell">/speckit.tasks
</code></pre>
<p>系统会将项目分解为多个用户故事，每个故事包含详细的任务清单。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d079a4ead4124c5fafb28f2307e1cc6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lil6ICB5rm_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334309&amp;x-signature=xrGnnKxCX4S9Ai2Z1AxJtUM1OTg%3D" alt="" loading="lazy"/></p>
<p>执行所有开发任务：</p>
<pre><code class="hljs language-shell" lang="shell">/speckit.implement
</code></pre>
<pre><code class="hljs language-shell" lang="shell">正在执行 Phase 1: Setup… (esc to interrupt · ctrl+t to hide todos · 2m 15s · ↑ 1.2k tokens)
  ⎿  ☒ 验证并创建项目 ignore 文件
     ☐ Phase 1: Setup (7个任务)
     ☐ Phase 2: Foundational (7个任务)
     ☐ Phase 3: User Story 1 - MVP (7个任务)
     ☐ Phase 4: User Story 2 (5个任务)
     ☐ Phase 5: User Story 5 (5个任务)
     ☐ Phase 6: User Story 3 (7个任务)
     ☐ Phase 7: User Story 4 (4个任务)
     ☐ Phase 8: Polish (8个任务)
</code></pre>
<p>如果执行过程中断，可使用以下命令继续：</p>
<pre><code class="hljs language-shell" lang="shell">/speckit.implement 继续执行
</code></pre>
<p>直到执行完成所有 Task</p>
<h2 data-id="heading-15">开发成果</h2>
<p>通过 Spec Kit 完成的二维码生成工具开发，从需求定义到代码实现，整体耗时约 1 小时（包含网络延迟和指令等待时间）。这种方法相比传统的即时 Prompt 工程，提供了更系统化的开发体验。</p>
<p>项目实现了完整的二维码生成功能，包括：</p>
<ul>
<li>基础二维码生成</li>
<li>颜色和尺寸定制</li>
<li>Logo 嵌入支持</li>
<li>完整的文档和示例</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e51204b120804539b1a38534d8008138~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lil6ICB5rm_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334309&amp;x-signature=n24ZYliuPL%2BeK4mYm9gNKX0o%2BAY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45b713148d3f418890023aef9c5411e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lil6ICB5rm_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334309&amp;x-signature=wtA2%2F%2BmK53bJw5bKDwLqWcJ6ZGs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54242b1bb8094d9c953d26d63619ac22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lil6ICB5rm_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764334309&amp;x-signature=a0dfYTuALqYIy5b0964YzQZcjI8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-16">总结</h2>
<p>Spec Kit 通过规范驱动的开发方法，将产品需求、技术架构、测试标准和开发实现有机结合，提供了系统化的 AI 辅助编程解决方案。相比传统的即时 Prompt 工程，它能够：</p>
<ul>
<li>确保需求实现的准确性</li>
<li>提供完整的设计决策记录</li>
<li>生成一致且可维护的代码</li>
<li>建立标准化的开发流程</li>
</ul>
<p>完整项目代码仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCrazyMrYan%2Fqrcode-gen" target="_blank" title="https://github.com/CrazyMrYan/qrcode-gen" ref="nofollow noopener noreferrer">github.com/CrazyMrYan/…</a></p>
<h2 data-id="heading-17">文献</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.yanfukun.com%2Fread%2Fspec-kit%2Fwhat" target="_blank" title="https://www.yanfukun.com/read/spec-kit/what" ref="nofollow noopener noreferrer">www.yanfukun.com/read/spec-k…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgithub%2Fspec-kit" target="_blank" title="https://github.com/github/spec-kit" ref="nofollow noopener noreferrer">github.com/github/spec…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[win11上wsl本地安装版本ubuntu25.10]]></title>    <link>https://juejin.cn/post/7574848503731929134</link>    <guid>https://juejin.cn/post/7574848503731929134</guid>    <pubDate>2025-11-21T11:11:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574848503731929134" data-draft-id="7574991051435311114" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="win11上wsl本地安装版本ubuntu25.10"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-21T11:11:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Livingbody"/> <meta itemprop="url" content="https://juejin.cn/user/4213771487417944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            win11上wsl本地安装版本ubuntu25.10
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4213771487417944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Livingbody
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-21T11:11:02.000Z" title="Fri Nov 21 2025 11:11:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.安装wsl2</h2>
<pre><code class="hljs language-cmd" lang="cmd">   dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
   dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
   wsl --set-default-version 2
   
</code></pre>
<h2 data-id="heading-1">2.下载镜像</h2>
<p>从163镜像下载
<a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.163.com%2Fubuntu-releases%2F25.10%2Fubuntu-25.10-wsl-amd64.wsl" target="_blank" title="https://mirrors.163.com/ubuntu-releases/25.10/ubuntu-25.10-wsl-amd64.wsl" ref="nofollow noopener noreferrer">mirrors.163.com/ubuntu-rele…</a>
速度很快，1分钟不到即可完成。</p>
<h2 data-id="heading-2">3.使用wsl命令安装</h2>
<pre><code class="hljs language-cmd" lang="cmd">   cd .\Downloads\
   wsl --install --from-file .\ubuntu-25.10-wsl-amd64.wsl
   
   
  Linux gaint 6.6.87.2-microsoft-standard-WSL2 #1 SMP PREEMPT_DYNAMIC Thu Jun  5 18:30:46 UTC 2025 x86_64 GNU/Linux   
</code></pre>
<p>安装完成</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9efd92b3b591477086770cbbab1c1c47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGl2aW5nYm9keQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764328262&amp;x-signature=%2FCiutyPN4GAHCth9Ao915genr%2Bg%3D" alt="ScreenShot_2025-11-21_191012_647.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>