<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[音视频通用组件设计探索和应用]]></title>    <link>https://juejin.cn/post/7570651893867855924</link>    <guid>https://juejin.cn/post/7570651893867855924</guid>    <pubDate>2025-11-10T04:41:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570651893867855924" data-draft-id="7570306250027974708" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="音视频通用组件设计探索和应用"/> <meta itemprop="keywords" content="前端,音视频开发"/> <meta itemprop="datePublished" content="2025-11-10T04:41:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="政采云技术"/> <meta itemprop="url" content="https://juejin.cn/user/3456520257288974"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            音视频通用组件设计探索和应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3456520257288974/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    政采云技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T04:41:30.000Z" title="Mon Nov 10 2025 04:41:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1、背景介绍</h3>
<p>业务层面，基于国家发展改革委办公厅日前印发关于加快推广远程异地评标的通知，部署在全国范围内加快推广远程异地评标，重在解决传统的评标问题，提升整体的公平性和公正性，优化专家资源的评标配置，音视频作为整个业务流程中评标环节关键的桥梁，起着重大的作用。</p>
<p>技术层面，针对目前各中心相关音视频的诉求，以及目前出现的音视频对接成本高、标准不统一、质量难把控、体验不一致等相关问题，提升整体研发效率，收敛用户体验、统一开发标准，保证相关性能检测等至关重要。下面我将详细介绍下在本次研发过程中，基于音视频相关底层原理的探索和通用化组件设计过程中遇到的一些问题探讨。</p>
<h4 data-id="heading-1">1.1 音视频监控</h4>
<p>整个评标环节，主要用到音视频强化监管手段包括下面三大方面：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c75027b6a55d44c584345acdae18c989~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=sE07cXl9C2Qai8%2BYm2jMfn9XKFw%3D" alt="image.png" loading="lazy"/></p>
<p>加强电子化评标过程中的监管力度，对于音视频各方面的能力，要求非常高，满足业务的整体电子化评标流程，针对不同的业务场景做定制化处理，那么孵化一款音视频通用化组件的产品，提供一站式配置音视频的能力，很有必要。可以有效解决不同团队接入的成本高、业务定制化、开评同屏等问题。</p>
<h3 data-id="heading-2">2、音视频<code>WebRTC</code>介绍</h3>
<h4 data-id="heading-3">2.1 基本原理</h4>
<p>音视频底层能力，是基于浏览器提供的WEB端点对点之间通信的<code>WebRTC</code>的能力，通过浏览器提供的API， 可在网页端实现音视频通信，<code>WebRTC</code>主要提供了2种能力，<code>媒体捕获设备</code>和<code>点对点连接</code>。</p>
<p>a、音视频<code>点对点连接</code>的基本原理流程如下图所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/847a19a6a25f42fc998d27bc64083e3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=WZR9E%2FZZMcjiDsunoZgoTjthSK8%3D" alt="image.png" loading="lazy"/></p>
<p>客户端A 与客户端B之间，因为防火墙的限制是无法进行通信的，需要借助TURN服务器，进行点与点之间的链接，大致基本原理可以用下图来说明：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa12a1b557da4348ae292fdcf9d5aefc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=KnjdTwx9bj1nWNffz%2FPFkPJdj4Y%3D" alt="image.png" loading="lazy"/></p>
<p>b、音视频<code>媒体捕获设备</code>的获取</p>
<p>媒体捕获设备包括摄像头和麦克风，还包括屏幕捕获设备。对于摄像头和麦克风，调用 <code>navigator.mediaDevices.getUserMedia()</code> 来捕获 <code>MediaStreams</code>。对于屏幕录制，使用 <code>navigator.mediaDevices.getDisplayMedia()</code>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 摄像头和麦克风</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">openMediaDevices</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">constraints</span>) =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> navigator.<span class="hljs-property">mediaDevices</span>.<span class="hljs-title function_">getUserMedia</span>(constraints);
}

<span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> stream = <span class="hljs-title function_">openMediaDevices</span>({<span class="hljs-string">'video'</span>:<span class="hljs-literal">true</span>,<span class="hljs-string">'audio'</span>:<span class="hljs-literal">true</span>});
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'音视频流数据:'</span>, stream);
} <span class="hljs-keyword">catch</span>(error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
}
</code></pre>
<p>如果存在外接设备摄像头或者麦克风，此时，需要去查询所有当前客户端的所有设备，可以通过调用函数 <code>enumerateDevices()</code> 来实现 。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> getConnectedDevices = <span class="hljs-title function_">async</span>(<span class="hljs-params"><span class="hljs-keyword">type</span></span>) {
    <span class="hljs-keyword">const</span> devices = <span class="hljs-keyword">await</span> navigator.<span class="hljs-property">mediaDevices</span>.<span class="hljs-title function_">enumerateDevices</span>();
    <span class="hljs-keyword">return</span> devices.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">device</span> =&gt;</span> device.<span class="hljs-property">kind</span> === <span class="hljs-keyword">type</span>)
}

<span class="hljs-keyword">const</span> videoCameras = <span class="hljs-title function_">getConnectedDevices</span>(<span class="hljs-string">'videoinput'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'所有的摄像头的数据:'</span>, videoCameras);
</code></pre>
<p>拿到音视频流之后，需要进行播放，可以将其赋值给视频的<code>DOM</code>元素。</p>
<pre><code class="hljs language-ini" lang="ini">const  <span class="hljs-attr">play</span> = async() {
    try {
        const <span class="hljs-attr">constraints</span> = {<span class="hljs-string">'video'</span>: <span class="hljs-literal">true</span>, <span class="hljs-string">'audio'</span>: <span class="hljs-literal">true</span>}<span class="hljs-comment">;</span>
        const <span class="hljs-attr">stream</span> = await navigator.mediaDevices.getUserMedia(constraints)<span class="hljs-comment">;</span>
        const <span class="hljs-attr">videoElement</span> = document.querySelector(<span class="hljs-string">'video#localVideo'</span>)<span class="hljs-comment">;</span>
        <span class="hljs-attr">videoElement.srcObject</span> = stream<span class="hljs-comment">;</span>
    } catch(error) {
        console.error('Error opening video camera.', error)<span class="hljs-comment">;</span>
    }
}

return (
  &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"video-demo-container"</span>&gt;
    &lt;video <span class="hljs-attr">id</span>=<span class="hljs-string">"localVideo"</span> autoplay playsinline controls=<span class="hljs-string">"false"</span>/&gt;
  &lt;/div&gt;
)
</code></pre>
<h4 data-id="heading-4">2.2 <code>WebRTC</code>通信协议介绍</h4>
<p><code>WebRTC</code>的传输协议主要包括以下几个方面，基于下面几个协议来保证实时音视频既流畅又安全。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7db140d380148bc8ae692864675d23a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=K8rMQtj%2BukyCQ3bs6o9fkCRRIIA%3D" alt="image.png" loading="lazy"/></p>
<p>我们下面分别看下，这几种协议各自在音视频中起到的作用和分工。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e5af1a5273549e9a26b9a1a916d287b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=Ay6fj2nuR7icblned5yfWXH5nhU%3D" alt="image.png" loading="lazy"/></p>
<p>提到DTLS协议 ， 大家应该知道另外一个TLS协议 ，但是TLS协议是为TCP设计的，它依赖于TCP的可靠、有序传输，而UDP是不可靠、不保证顺序的，无法直接使用TLS，因此，DTLS主要是为UDP设计的。如下<code>WebRTC</code>各协议工作流程图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd4a556dbeda4dc3bd0319ab132d5097~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=UxZJfm0e6XiNxNNuB7m0xCh%2BUoQ%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">2.3 <code>WebRTC</code>音视频实现过程</h4>
<p>如下图所示，整个音视频过程，包括 前期的准备阶段、信令阶段、链接阶段、最后的通信阶段，大致过程如下所示流程图所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdc1169f1bdf46808b7dad389cc0d339~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=vaTVLT7BValztQp%2FgcBr8TwZn7I%3D" alt="image.png" loading="lazy"/></p>
<p>创建Offer的代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> peerConnection = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RTCPeerConnection</span>();
<span class="hljs-comment">// 创建SDP</span>
peerConnection.<span class="hljs-title function_">createOffer</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">offer</span>) {
  <span class="hljs-comment">// ...</span>
}, <span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error);
});
</code></pre>
<p>基于以上整个音视频的底层能力，下面我这边将详细介绍下，基于我们的公司的业务情况，针对业务的背景和诉求，提供的一站式接入音视频通用化组件的相关设计和问题探讨。</p>
<h3 data-id="heading-6">3、音视频通用组件设计</h3>
<h4 data-id="heading-7">3.1 组件基本设计思路</h4>
<p>音视频通用化组件，会提供基于音视频底层能力，提供SDK和UI组件二方包两个产物，针对每个SDK中，会提供语音转文字、聊天、纯语音、视频+语音等SDK, 可以供不同的场景使用，比如桌面录屏等需要单独调用SDK , 其次针对UI组件，会打包封装好的整套UI产品，通过配置参数，即可实现整套音视频的功能和使用。</p>
<p>实现效果Demo截图如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b046015354f4147b27181fbe6b34fba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=NGWPLubag5tpZr94nJ6ehwgWpsg%3D" alt="image.png" loading="lazy"/></p>
<p>上面的Demo截图功能操作是垂直布局的浮层，也提供了水平方向的布局浮层，主要通过参数配置。</p>
<p>整个音视频核心功能分为下面几个部分：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5010bf506b749658084d2b8ead50979~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=87%2BdS00yde%2BGfmguc8IJsYv21Ks%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<ul>
<li>视频块的大小，会跟随当前屏幕的大小，进行动态变化，且实时计算大小，赋值给每个组件的区域容器的宽度，除此之外，还需要监听<code>window.onResize</code>的大小变化。</li>
<li>操作区功能模块，通过参数配置，由业务侧控制其显隐，包括图标、名称、置灰等。</li>
<li>内置功能区域，主要是通用组件本身提供的内置能力，比如讨论和语音转文字等。</li>
<li>外置功能区域，比如业务自定义插入的组件页面，目前提供2种方式，一种是嵌入式的插入，一种是浮层式插入，依据参数字段 <code>isSlotComponentInsertToPage</code> 来区分。</li>
<li>主要核心的模块，主要包括视频模块、操作区模块、内置/自定义功能区域模块。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bede8912bd6a4bcc893b8c1fd8e4d2fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=ILcSlOXG%2F%2Fmpnz2xqr%2Bx8m1gv%2BI%3D" alt="image.png" loading="lazy"/></p>
<p>测试Demo代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">
import React, { useEffect, useState , useRef } from 'react'<span class="hljs-comment">;</span>

// 自定义组件弹窗
export const <span class="hljs-attr">DefineComponent</span> = (props) =&gt; {
  const {
    onRemoveSoltComponent,
    onShareScreen,
  } = props
  console.log("===defineComponent", props)
  const <span class="hljs-attr">onClickSure</span> = async () =&gt; {
    await onShareScreen?.()
    await onRemoveSoltComponent?.()
  }
  return (
    &lt;Modal
      <span class="hljs-attr">title</span>=<span class="hljs-string">"自定义组件"</span>
      <span class="hljs-attr">visible</span>={<span class="hljs-literal">true</span>}
      <span class="hljs-attr">onCancel</span>={<span class="hljs-literal">on</span>RemoveSoltComponent}
      <span class="hljs-attr">onOk</span>={<span class="hljs-literal">on</span>ClickSure}
    &gt;
      &lt;p&gt;Some contents...&lt;/p&gt;
      &lt;p&gt;Some contents...&lt;/p&gt;
      &lt;p&gt;Some contents...&lt;/p&gt;
    &lt;/Modal&gt;
  )
}

// 自定义组件弹窗2
export const <span class="hljs-attr">DefineComponent2</span> = (props) =&gt; {

  const {
    onRemoveSoltComponent,
    targetKey
  } = props<span class="hljs-comment">;</span>
  console.log("OnCloseDialog", props)

  // 关闭当前组件
  const <span class="hljs-attr">onRemoveSoltComponentHandle</span> = () =&gt; {
    onRemoveSoltComponent(targetKey)
  }

  return &lt;div <span class="hljs-attr">onClick</span>={<span class="hljs-literal">on</span>RemoveSoltComponentHandle}&gt;这是一个业务方自定义插入页面的会议监控<span class="hljs-number">2222222</span>组件， 点击我可以关闭页面&lt;/div&gt;
}

/**
 * 视频+语音的组件，业务方引入demo
 */
const <span class="hljs-attr">OnlineMeetingDemo</span> = () =&gt; {
  const <span class="hljs-section">[modalVisible, setModalVisible]</span> = useState(true)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">modalVisibleControl</span> = {
    visible: modalVisible,
    closeVisible: () =&gt; {
      setModalVisible(false)<span class="hljs-comment">;</span>
    },
  }
  // 通用按钮设置数据, 默认通用组件中的按钮，全部展示
  const <span class="hljs-attr">generalButtonSettingsData</span> = [
    {
      btnKey: BUTTON_CONSTANTS.CHANGE_VIEW_BUTTON_KEY, // 唯一key值
      isDisabled: <span class="hljs-literal">false</span>, // 是否置灰
      disabledToolTip: <span class="hljs-string">""</span>, // 置灰的提示tooltip
      isShow: <span class="hljs-literal">true</span>, // 按钮是否显示
      <span class="hljs-literal">on</span>ClickBefore: () =&gt; {}, // 点击之前
      <span class="hljs-literal">on</span>ClickAfter: () =&gt; {
        console.log(<span class="hljs-string">"切换视图之后"</span>)
      }, // 点击之后
    },
    ...
  ]<span class="hljs-comment">;</span>

  // 自定义业务侧按钮数据
  const <span class="hljs-attr">customButtonSettings</span> = [
    {
      btnImg: <span class="hljs-string">'https://sitecdn.zcycdn.com/1167DH/20248/68cd9c74-6493-4cff-b228-42e3f6965ce5.svg'</span>,
      btnName: <span class="hljs-string">'业务自定义按钮名称'</span>,
      btnKey: <span class="hljs-string">'talkBtn'</span>,
      isDisabled: <span class="hljs-literal">false</span>, // 是否置灰
      isShow: <span class="hljs-literal">true</span>, // 按钮是否显示
      <span class="hljs-literal">on</span>Click: (props) =&gt; { },
      slotComponent: &lt;div&gt;这是一个业务方自定义插入A组件&lt;/div&gt;, 
      isSlotComponentInsertToPage: <span class="hljs-literal">true</span>, // 自定义组件是否插入到页面
    },
    ...
  ]

  return (
    &lt;div
      <span class="hljs-attr">className</span>=<span class="hljs-string">"online-meeting-container"</span>
      <span class="hljs-attr">style</span>={{ width: <span class="hljs-string">'100%'</span>, height: <span class="hljs-string">'100%'</span> }}
    &gt;
        &lt;OnlineVideoMeeting
          <span class="hljs-attr">ref</span>={inputRef}
          <span class="hljs-attr">direction</span>=<span class="hljs-string">"inline"</span> // vertical | inline 方向
          <span class="hljs-attr">style</span>={{ width: <span class="hljs-string">'100%'</span>, height: <span class="hljs-string">'100%'</span> }}
          <span class="hljs-attr">manufacturer</span>=<span class="hljs-string">"yunxin"</span>
          <span class="hljs-attr">customConfig</span>={configData} // 业务方相关信息数据
          <span class="hljs-attr">generalButtonSettings</span>={generalButtonSettingsData} // 通用按钮组件配置
          <span class="hljs-attr">customButtonSettings</span>={customButtonSettings} // 自定义按钮配置
          <span class="hljs-attr">onCustomClientEvents</span>={<span class="hljs-literal">on</span>DefineClientEvents} // 接收到自定义消息类型，事件的回调

          <span class="hljs-attr">isCanSeeOtherVideo</span>={<span class="hljs-literal">true</span>} // 默认为<span class="hljs-literal">true</span> 当前角色，是否可以看到其它人的视频画面 （比如，供应商无法看到专家的画面）
          <span class="hljs-attr">isOpenAIDenoise</span>={<span class="hljs-literal">false</span>} // 默认不开启 <span class="hljs-literal">false</span>，是否开启变声，如果为盲评项目，需要开启变声
          <span class="hljs-attr">needAIUidList</span>={[]} // 传入需要变声的accId ， 仅当isOpenAIDenoise 为<span class="hljs-literal">true</span> 时候生效
          <span class="hljs-attr">isSpecailRole</span>={<span class="hljs-literal">false</span>} // 默认<span class="hljs-literal">false</span> 特殊的角色，可以进入视频会议，但是不可开启视频和音频, 比如监管角色
          <span class="hljs-attr">isShowRemoveMember</span>={<span class="hljs-literal">true</span>} // 默认不显示，是否显示移除人员的按钮 ,默认 为<span class="hljs-literal">false</span>
          <span class="hljs-attr">isAutoStartMeeting</span>={<span class="hljs-literal">false</span>} // 如果为<span class="hljs-literal">false</span> , 说明 需要点击 开始会议，才可以启动会议 ， 默认为<span class="hljs-literal">true</span>
          <span class="hljs-attr">isJoinMeetingAutomatically</span>={<span class="hljs-literal">false</span>}  // 当 isAutoStartMeeting 为<span class="hljs-literal">false</span> 时，才会生效，是否自动让参会人进入会议，<span class="hljs-literal">true</span> 是， <span class="hljs-literal">false</span>的话，需要参会人点击 开始会议 按钮，才可以进入
          <span class="hljs-attr">isDisabledAllVideo</span>={<span class="hljs-literal">false</span>} // 是否将所有与会者的视频画面置为不可见，比如盲评项目的话，将所有人的视频画面都置为不可见 , 默认为 <span class="hljs-literal">false</span>
          <span class="hljs-attr">disabledVideoToolTip</span>=<span class="hljs-string">""</span> // 视频浮层tooltip提示 , 默认为 空
          <span class="hljs-attr">peerOnLineEvent</span>={(props) =&gt; {}} // 加入房间事件
          <span class="hljs-attr">peerLeaveEvent</span>={(props) =&gt; {}} // 离开房间事件
          <span class="hljs-attr">onCloseModalErrorEvents</span>={() =&gt; { }}
          <span class="hljs-attr">onPublishLocalStreamSuccess</span>={()=&gt;{ }}
          <span class="hljs-attr">shouldCrash</span>={shouldCrash}
        /&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>

}<span class="hljs-comment">;</span>
export default OnlineMeetingDemo<span class="hljs-comment">;</span>
  
</code></pre>
<p>组件暴露出去参数给外部使用，通过<code>cloneElement</code> <code>useImperativeHandle</code>、钩子函数回调callBack等方式，进行内外部之间的通信。</p>
<p>整体的音视频产品设计图如下所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dae76abb9924422aacc225b4d0174279~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=jzAkNb5vhqcmuA4PV7JK9x37Q1w%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-8">3.2 多渠道视频<code>SDK</code>协议约束</h4>
<p>因业务的发展诉求，在设计底层的<code>SDK</code>的时候，需要考虑后续的<code>SDK</code>的可扩展性，像我们的渠道商有多个，每个视频渠道商提供的对应的视频<code>SDK</code>是不一样的，那么如何去兼容不同的视频渠道商<code>SDK</code>呢？</p>
<p>第一种<code>SDK</code>设计方案，如果渠道商<code>SDK</code>频繁更改, 以及频繁接入新的<code>SDK</code>的话，比较适用此业务场景</p>
<p>通过 在自己的二方包中，统一动态加载注入 不同的<code>SDK</code>的包版本，每个视频渠道商均为单独的二方包，如下图所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ee43ab18fd14a1ab6eac5b4d6cd209a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=bdmK3jUbVruxozRACqGkYvwP8l8%3D" alt="image.png" loading="lazy"/></p>
<p>第二种<code>SDK</code>设计方案，如果渠道商<code>SDK</code>较少，且更改不频繁，那么比较适用此业务场景</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3831b7a26464b57a0436a7b522cdeff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=QNof6OovNpopB5aScPFlTLY%2BGdw%3D" alt="image.png" loading="lazy"/></p>
<p>以上两种<code>SDK</code>设计方案，对于我们当前的业务诉求，<code>SDK</code>渠道商较少，且稳定，那么目前采用的是第二种设计方案，代码Demo类似如下所示：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Channel1SDK</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./channelSource/channel1"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Channel2SDK</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./channelSource/channel2"</span>;

<span class="hljs-comment">/**
 * 根据配置获取对应的SDK的实例
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">type</span>
 * <span class="hljs-doctag">@returns</span>
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getSDKInstance</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"><span class="hljs-keyword">type</span></span>) =&gt; {
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">type</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"请传入三方音视频type"</span>);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === <span class="hljs-string">"channel1"</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Channel1SDK</span>();
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === <span class="hljs-string">"channel2"</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Channel2SDK</span>();
  }
  ...
};
</code></pre>
<p>针对每个<code>SDK</code>, 设置统一的底层的协议<code>API</code>方法，如下类似代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">AudioTransformText</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"src/public/audioTransform"</span>;
<span class="hljs-keyword">import</span>  <span class="hljs-title class_">Video</span>  <span class="hljs-keyword">from</span> <span class="hljs-string">'./video'</span>;
<span class="hljs-keyword">import</span>   <span class="hljs-variable constant_">IM</span>  <span class="hljs-keyword">from</span> <span class="hljs-string">'./im'</span>;
<span class="hljs-keyword">import</span>   <span class="hljs-title class_">Audio</span>  <span class="hljs-keyword">from</span> <span class="hljs-string">'./audio'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Utils</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">BaseSDK</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../../basicSdk'</span>;

<span class="hljs-comment">/*
 * channel1 的SDK 聊天、视频、音频
 * @export
 * @class Channel1SDK
 * @implements {BaseSDK}
* */</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">IMPropsType</span> , <span class="hljs-title class_">OptsPropsType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"src/types/typings"</span>;

 <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Channel1SDK</span>  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BaseSDK</span>{
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>){

  }
  <span class="hljs-comment">// 获取IM SDK</span>
  <span class="hljs-keyword">async</span> getIM (payload?:<span class="hljs-title class_">IMPropsType</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">IM</span> (payload);
  }

  <span class="hljs-comment">// 获取WEBRTC SDK</span>
  <span class="hljs-keyword">async</span> getVideo (payload?:<span class="hljs-title class_">OptsPropsType</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Video</span> (payload);
  }

  <span class="hljs-comment">// 获取AUDIO SDK</span>
  <span class="hljs-keyword">async</span> getAudio (payload?:<span class="hljs-title class_">OptsPropsType</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Audio</span> (payload);
  }

  <span class="hljs-comment">// 获取通用工具 SDK</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getUtils</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Utils</span>(); <span class="hljs-comment">// 通用工具类</span>
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getAudioTransText</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AudioTransformText</span>(); <span class="hljs-comment">// 获取语音转文字SDK</span>
  }

}
</code></pre>
<p>每一个<code>IM</code>、<code>Video</code>、<code>Audio</code>、<code>Utils</code>、<code>AudioTransformText</code>均基于自己自己的<code>BaseSDK</code> 去进行实现，比如<code>IM</code> 自己的 <code>BaseIMSDK</code>如下代码所示：</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HistoryMsgsPropsType</span>, <span class="hljs-title class_">ResendMsgPropsType</span>  } <span class="hljs-keyword">from</span> <span class="hljs-string">"src/types/typings"</span>;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@desc</span> 基础的IM 声明
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BaseIMSDK</span> {

  <span class="hljs-comment">//发送消息 type 为 “text”表示文本 ， “file”表示文件</span>
  <span class="hljs-attr">sendMsg</span>:<span class="hljs-function">(<span class="hljs-params">msg?:<span class="hljs-built_in">any</span> , <span class="hljs-keyword">type</span>?:<span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt;;

  <span class="hljs-comment">// 消息回调 将接收到的文本或文件</span>
  <span class="hljs-comment">// 业务方直接 im.onReciveMsg = (msg) =&gt; {}; 使用获取到的msg即可</span>
  <span class="hljs-attr">onReciveMsg</span>:<span class="hljs-function">(<span class="hljs-params">msg?:<span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;

  <span class="hljs-comment">//撤回消息</span>
  <span class="hljs-attr">recallMsg</span>:<span class="hljs-function">(<span class="hljs-params">msg?:<span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Boolean</span>&gt;;

  <span class="hljs-comment">// 获取历史消息</span>
  <span class="hljs-attr">getHistoryMsgs</span>:<span class="hljs-function">(<span class="hljs-params">payload? : HistoryMsgsPropsType </span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">any</span>&gt;&gt;;

  <span class="hljs-comment">// 消息重发</span>
  <span class="hljs-attr">resendMsg</span>:<span class="hljs-function">(<span class="hljs-params">payload?:ResendMsgPropsType</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Boolean</span>&gt;;

  <span class="hljs-comment">// 消息接收方在收到消息并阅读后, 调用此方法发送已读回执</span>
  sendReceiptMsg : <span class="hljs-function">(<span class="hljs-params">payload?:ResendMsgPropsType</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Boolean</span>&gt;;

  <span class="hljs-comment">// 消息已读回执 回调函数</span>
  onReceiptedMsg : <span class="hljs-function">(<span class="hljs-params">msg?:<span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Boolean</span>&gt;;

}
</code></pre>
<p>后续针对每个渠道商，按照基于定的统一协议类<code>API</code>的方法，去实现对应的功能即可。</p>
<h4 data-id="heading-9">3.3 组件UI降级容错</h4>
<p>即当某个组件因为某些原因（如数据错误、依赖缺失、内部异常等）无法正常渲染时，我们不会让整个页面崩溃，而是展示一个备用的UI（如错误提示、占位符等），同时保证其他组件的正常渲染。</p>
<h5 data-id="heading-10">3.3.1 组件级UI降级容错处理方法</h5>
<p>通常有以下几种常用的方法：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c72e3560b4d4ca1a9535b79017dfc90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=B8MKG8kk7oHRUmPO01B1YqBEgbM%3D" alt="image.png" loading="lazy"/></p>
<p>我们详细看下，几种不同的错误边界处理方法的应用。</p>
<p><code>Error Boundaries</code></p>
<p>React 16引入的概念，可以捕获子组件树中的JavaScript错误，记录错误，并显示一个降级UI，它定义了<code>static getDerivedStateFromError()</code>和<code>componentDidCatch()</code>两个生命周期方法中的一个或两个， 注意，错误边界无法捕获事件处理、异步代码、服务端渲染等错误。</p>
<p>当捕获到error的时候，进行默认视图展示，而不是使整个界面出现白屏的现象，涉及包括整个界面，以及局部的组件的崩溃等组件情况，相关<code>ErrorBoundary</code>代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ErrorView</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/ErrorView'</span>;
<span class="hljs-keyword">import</span> { pushLogToSentry } <span class="hljs-keyword">from</span> <span class="hljs-string">'./helpers'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">ERROR_TYPE</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./constants'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-variable language_">super</span>(props);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = {
      <span class="hljs-attr">hasError</span>: <span class="hljs-literal">false</span>,
    };
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getDerivedStateFromError</span>(<span class="hljs-params">error</span>) {
    <span class="hljs-variable language_">window</span>?.<span class="hljs-property">console</span>?.<span class="hljs-title function_">log</span>(<span class="hljs-string">'getDerivedStateFromError:'</span>, error);
    <span class="hljs-comment">// 更新 state 使下一次渲染能够显示降级后的 UI</span>
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">hasError</span>: <span class="hljs-literal">true</span> };
  }

  <span class="hljs-title function_">componentDidCatch</span>(<span class="hljs-params">error, errorInfo</span>) {
    <span class="hljs-variable language_">window</span>?.<span class="hljs-property">console</span>?.<span class="hljs-title function_">log</span>(<span class="hljs-string">'componentDidCatch error:'</span>, error);
    <span class="hljs-variable language_">window</span>?.<span class="hljs-property">console</span>?.<span class="hljs-title function_">log</span>(<span class="hljs-string">'componentDidCatch errorInfo:'</span>, errorInfo);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (__DEV__) <span class="hljs-keyword">return</span>;
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-comment">//</span>
    }

    <span class="hljs-comment">// 将错误日志上报给服务器</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-title function_">pushLogToSentry</span>({
        <span class="hljs-attr">message</span>: <span class="hljs-string">`
        url: src/components/ErrorBoundary
        errorName: <span class="hljs-subst">${error?.name}</span>
        errorMsg: <span class="hljs-subst">${error?.meesage}</span>
        errorStack: <span class="hljs-subst">${error?.stack}</span>
        errorComponentStack: <span class="hljs-subst">${errorInfo?.componentStack}</span>
        `</span>,
        <span class="hljs-attr">level</span>: <span class="hljs-variable constant_">ERROR_TYPE</span>,
      });
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-comment">//</span>
    }
  }

  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> { children, onRefresh, errorWrapProps = {} } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>;
    <span class="hljs-keyword">const</span> { hasError } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>;
    <span class="hljs-comment">// 错误展示的视图</span>
    <span class="hljs-keyword">if</span> (hasError) {
      <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorView</span>
          <span class="hljs-attr">onRefresh</span>=<span class="hljs-string">{onRefresh}</span>
          <span class="hljs-attr">errorWrapProps</span>=<span class="hljs-string">{errorWrapProps}</span>
        /&gt;</span></span>
      );
    }
    <span class="hljs-keyword">return</span> children;
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">withErrorBoundary</span> = (<span class="hljs-params">{ onRefresh, errorWrapProps = {} } = {}</span>) =&gt; <span class="hljs-function">(<span class="hljs-params">Component</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">extends</span> <span class="hljs-title class_">ErrorBoundary</span> {
    <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> { hasError } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>;
      <span class="hljs-comment">// 错误展示的视图</span>
      <span class="hljs-keyword">if</span> (hasError) {
        <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorView</span> <span class="hljs-attr">onRefresh</span>=<span class="hljs-string">{onRefresh}</span> <span class="hljs-attr">errorWrapProps</span>=<span class="hljs-string">{errorWrapProps}</span> /&gt;</span></span>;
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Component</span>) {
        <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Component</span> {<span class="hljs-attr">...this.state</span>} {<span class="hljs-attr">...this.props</span>} /&gt;</span></span>;
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
  };
};
</code></pre>
<p>业务侧引入的时候，如下代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span>  <span class="hljs-title class_">ErrorBoundary</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"src/components"</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">MyComponent</span> = (<span class="hljs-params"/>)=&gt;{
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">MyComponent</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span>
  )
}
</code></pre>
<p>那么针对这种错误边界的处理方法，如何去模拟针对音视频通用化组件崩溃的各种场景呢？</p>
<ul>
<li>测试步骤</li>
</ul>

<pre><code class="hljs language-css" lang="css">graph <span class="hljs-selector-tag">TD</span>
    <span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[创建会崩溃的子组件]</span> --&gt; <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[在父组件中嵌入]</span>
    <span class="hljs-selector-tag">B</span> --&gt; C<span class="hljs-selector-attr">[触发崩溃条件]</span>
    C --&gt; D<span class="hljs-selector-attr">[检测父组件行为]</span>
    D --&gt; E<span class="hljs-selector-attr">[捕获边界情况]</span>
</code></pre>
<ul>
<li>功能测试场景</li>
</ul>






























<table><thead><tr><th>测试动作</th><th>预期结果</th><th>检测方法</th></tr></thead><tbody><tr><td>触发子组件崩溃</td><td>子组件显示错误边界内容</td><td>检查DOM元素 <code>.error-fallback</code></td></tr><tr><td>父组件按钮功能</td><td>父组件状态正常更新</td><td>检查 <code>parentState</code> 状态</td></tr><tr><td>父组件渲染</td><td>崩溃区域外UI完整无白屏</td><td>可视检查 + DOM 快照对比</td></tr><tr><td>控制台错误</td><td>错误被捕获未扩散</td><td>监听 <code>window.onerror</code> 事件</td></tr></tbody></table>
<ul>
<li>测试过程&amp;结果如下截图：</li>
</ul>
<p>1、模拟音视频组件，引入到业务工程项目中，此时如果音视频组件内部出现崩溃的情况，即报错了</p>
<p><code>throw new Error</code>，此时，业务工程业务不应该受到影响，界面显示正常。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b91151281feb447da5a2e1d9438d5e32~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=oDhFGFQHl8iEBZhTXMSjBJe3Xw8%3D" alt="image.png" loading="lazy"/></p>
<p>点击按钮，触发子组件崩溃，此时 父组件依然可以正常显示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e9a44c83a324151b9e6e9517a76bd3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=VBXnsvRan44AvTNuZA28QFeS3E0%3D" alt="image.png" loading="lazy"/></p>
<p>2、模拟业务自定义组件崩溃的情况，在音视频通用化组件中，可以自定义插入业务方的组件，此时如果业务方组件崩溃了，那么对应的音视频组件不应该受到影响，不会出现白屏的现象。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9d50aeb22b74aad9f6d249687843f0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=umVP3BYbS38geA%2FqN33WSZNF1SA%3D" alt="image.png" loading="lazy"/></p>
<p>try-catch</p>
<p>错误边界无法捕获异步代码和事件中的错误，这些错误我们需要手动处理，例如，在事件处理函数中。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
  state = { hasError: <span class="hljs-literal">false</span> };

  handleClick = () =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 可能会抛出错误的操作</span>
      doSomething();
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">this</span>.setState({ hasError: <span class="hljs-literal">true</span> });
      console.error(error);
    }
  }

  render() {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.state.hasError) {
      <span class="hljs-keyword">return</span> &lt;div&gt;<span class="hljs-type">Error</span> in event handler.&lt;/div&gt;;
    }

    <span class="hljs-keyword">return</span> &lt;button onClick={<span class="hljs-keyword">this</span>.handleClick}&gt;<span class="hljs-type">Click</span> me&lt;/button&gt;;
  }
}
</code></pre>
<p>对于异步代码（如setTimeout、Promise），我们可以使用类似的try-catch，但注意，在Promise中要用catch：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">someAsyncFunction</span>()
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
    <span class="hljs-comment">// 处理数据</span>
  })
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-comment">// 处理错误</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">hasError</span>: <span class="hljs-literal">true</span> });
  });
</code></pre>
<p>高阶组件（HOC）</p>
<p>可以创建一个高阶组件，它接收一个组件，返回一个包裹了错误边界的新组件</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">withErrorBoundary</span> = (<span class="hljs-params">{ onRefresh, errorWrapProps = {} } = {}</span>) =&gt; <span class="hljs-function">(<span class="hljs-params">Component</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">extends</span> <span class="hljs-title class_">ErrorBoundary</span> {
    <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> { hasError } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>;
      <span class="hljs-comment">// 错误展示的视图</span>
      <span class="hljs-keyword">if</span> (hasError) {
        <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorView</span> <span class="hljs-attr">onRefresh</span>=<span class="hljs-string">{onRefresh}</span> <span class="hljs-attr">errorWrapProps</span>=<span class="hljs-string">{errorWrapProps}</span> /&gt;</span></span>;
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Component</span>) {
        <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Component</span> {<span class="hljs-attr">...this.state</span>} {<span class="hljs-attr">...this.props</span>} /&gt;</span></span>;
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
  };
};
</code></pre>
<p>业务侧使用的方式如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { withErrorBoundary } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/components'</span>;
<span class="hljs-keyword">const</span>  <span class="hljs-title function_">MyConponent</span> = (<span class="hljs-params"/>)=&gt;{
  .....
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">withErrorBoundary</span>()(<span class="hljs-title class_">MyConponent</span>)
</code></pre>
<h5 data-id="heading-11">3.3.2 常见的降级场景与处理方案</h5>
<ul>
<li>组件加载失败降级</li>
</ul>
<p>场景：异步组件加载超时或网络错误</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { <span class="hljs-title class_">Suspense</span>, useState, useCallback } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 1. 错误边界降级</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  state = { <span class="hljs-attr">hasError</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span> };
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getDerivedStateFromError</span>(<span class="hljs-params">error</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">hasError</span>: <span class="hljs-literal">true</span>, error };
  }
  
  <span class="hljs-title function_">componentDidCatch</span>(<span class="hljs-params">error, errorInfo</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Component loading failed:'</span>, error, errorInfo);
  }
  
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">hasError</span>) {
      <span class="hljs-comment">// 降级到基础UI</span>
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">fallback</span> || (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"component-fallback"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>功能加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> this.setState({ hasError: false })}&gt;
            重试
          <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
      );
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>;
  }
}

<span class="hljs-comment">// 2. 异步组件降级</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">LazyComponent</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> 
  <span class="hljs-keyword">import</span>(<span class="hljs-string">'./ComplexComponent'</span>)
    .<span class="hljs-keyword">catch</span>(<span class="hljs-function">() =&gt;</span> ({ 
      <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">BasicComponent</span> /&gt;</span></span> 
    }))
);

<span class="hljs-comment">// 备用基础组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">BasicComponent</span> = (<span class="hljs-params"/>) =&gt; (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"basic-version"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>基础模式<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前功能以简化模式显示<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
);

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">BasicComponent</span> /&gt;</span>}&gt;
    <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">LazyComponent</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span>
);
</code></pre>
<ul>
<li>功能依赖降级</li>
</ul>
<p>场景：浏览器不支持某些API或第三方库加载失败</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 特性检测降级</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">withFeatureDetection</span> = (<span class="hljs-params">features</span>) =&gt; <span class="hljs-function">(<span class="hljs-params">Component</span>) =&gt;</span> <span class="hljs-function">(<span class="hljs-params">props</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> [supportedFeatures, setSupportedFeatures] = <span class="hljs-title function_">useState</span>({});
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 检测浏览器支持情况</span>
    <span class="hljs-keyword">const</span> checks = {
      <span class="hljs-attr">webGL</span>: !!<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>).<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'webgl'</span>),
      <span class="hljs-attr">touch</span>: <span class="hljs-string">'ontouchstart'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>,
      <span class="hljs-attr">serviceWorker</span>: <span class="hljs-string">'serviceWorker'</span> <span class="hljs-keyword">in</span> navigator,
      <span class="hljs-comment">// 添加更多特性检测...</span>
    };
    
    <span class="hljs-title function_">setSupportedFeatures</span>(checks);
  }, []);

  <span class="hljs-comment">// 根据支持情况返回不同组件</span>
  <span class="hljs-keyword">if</span> (features.<span class="hljs-property">requiresWebGL</span> &amp;&amp; !supportedFeatures.<span class="hljs-property">webGL</span>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">CanvasFallback</span> {<span class="hljs-attr">...props</span>} /&gt;</span></span>;
  }
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Component</span> {<span class="hljs-attr">...props</span>} <span class="hljs-attr">supportedFeatures</span>=<span class="hljs-string">{supportedFeatures}</span> /&gt;</span></span>;
};

<span class="hljs-comment">// 第三方库降级</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">MapComponent</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [mapLib, setMapLib] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 动态加载地图库</span>
    <span class="hljs-keyword">import</span>(<span class="hljs-string">'advanced-map-library'</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">lib</span> =&gt;</span> <span class="hljs-title function_">setMapLib</span>(lib))
      .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'高级地图库加载失败，使用基础版本'</span>);
        <span class="hljs-comment">// 降级到基础地图或静态图片</span>
        <span class="hljs-keyword">import</span>(<span class="hljs-string">'./basic-map'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">lib</span> =&gt;</span> <span class="hljs-title function_">setMapLib</span>(lib));
      });
  }, []);
  
  <span class="hljs-keyword">if</span> (!mapLib) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>地图加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  
  <span class="hljs-keyword">return</span> mapLib.<span class="hljs-property">default</span> ? 
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">mapLib.default</span> /&gt;</span></span> : 
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/static-map.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"静态地图"</span> /&gt;</span></span>;
};
</code></pre>
<ul>
<li>性能降级方法</li>
</ul>
<p>场景：设备性能不足时自动降低视觉效果</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 性能感知降级</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">usePerformanceMode</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [performanceMode, setPerformanceMode] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'normal'</span>);
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 检测设备性能</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">detectPerformance</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 1. 检查网络速度</span>
      <span class="hljs-keyword">if</span> (navigator.<span class="hljs-property">connection</span>) {
        <span class="hljs-keyword">const</span> { effectiveType, downlink } = navigator.<span class="hljs-property">connection</span>;
        <span class="hljs-keyword">if</span> (effectiveType === <span class="hljs-string">'slow-2g'</span> || downlink &lt; <span class="hljs-number">1</span>) {
          <span class="hljs-title function_">setPerformanceMode</span>(<span class="hljs-string">'low'</span>);
          <span class="hljs-keyword">return</span>;
        }
      }
      
      <span class="hljs-comment">// 2. 检查设备内存</span>
      <span class="hljs-keyword">if</span> (navigator.<span class="hljs-property">deviceMemory</span> &amp;&amp; navigator.<span class="hljs-property">deviceMemory</span> &lt; <span class="hljs-number">4</span>) {
        <span class="hljs-title function_">setPerformanceMode</span>(<span class="hljs-string">'low'</span>);
        <span class="hljs-keyword">return</span>;
      }
      
      <span class="hljs-comment">// 3. 检查电池状态</span>
      <span class="hljs-keyword">if</span> (navigator.<span class="hljs-property">getBattery</span>) {
        navigator.<span class="hljs-title function_">getBattery</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">battery</span> =&gt;</span> {
          <span class="hljs-keyword">if</span> (battery.<span class="hljs-property">level</span> &lt; <span class="hljs-number">0.2</span> &amp;&amp; !battery.<span class="hljs-property">charging</span>) {
            <span class="hljs-title function_">setPerformanceMode</span>(<span class="hljs-string">'low-power'</span>);
          }
        });
      }
    };
    
    <span class="hljs-title function_">detectPerformance</span>();
  }, []);
  
  <span class="hljs-keyword">return</span> performanceMode;
};

<span class="hljs-comment">// 自适应组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">AdaptiveChart</span> = (<span class="hljs-params">{ data }</span>) =&gt; {
  <span class="hljs-keyword">const</span> performanceMode = <span class="hljs-title function_">usePerformanceMode</span>();
  
  <span class="hljs-keyword">switch</span> (performanceMode) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'low'</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">'low-power'</span>:
      <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">SimpleChart</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{data}</span> /&gt;</span></span>; <span class="hljs-comment">// 简化版图表</span>
      
    <span class="hljs-keyword">case</span> <span class="hljs-string">'normal'</span>:
      <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">InteractiveChart</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{data}</span> /&gt;</span></span>; <span class="hljs-comment">// 交互式图表</span>
      
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">StaticChart</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{data}</span> /&gt;</span></span>; <span class="hljs-comment">// 静态图表</span>
  }
};
</code></pre>
<ul>
<li>渐进增强策略</li>
</ul>
<p>通过设置不同版本的方式，去进行设置不同的模式切换</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 组件级渐进增强</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">ProgressiveEnhancementComponent</span> = (<span class="hljs-params">{ enhancedFeatures = <span class="hljs-literal">true</span> }</span>) =&gt; {
  <span class="hljs-keyword">const</span> [isEnhanced, setIsEnhanced] = <span class="hljs-title function_">useState</span>(enhancedFeatures);
  
  <span class="hljs-comment">// 降级开关（用于调试或用户手动选择）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleEnhancement</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">setIsEnhanced</span>(!isEnhanced);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"progressive-component"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{toggleEnhancement}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"enhancement-toggle"</span>&gt;</span>
        {isEnhanced ? '切换到基础模式' : '切换到增强模式'}
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      
      {isEnhanced ? (
        // 增强版本 - 包含动画、复杂交互
        <span class="hljs-tag">&lt;<span class="hljs-name">EnhancedVersion</span> /&gt;</span>
      ) : (
        // 基础版本 - 简单静态内容
        <span class="hljs-tag">&lt;<span class="hljs-name">BasicVersion</span> /&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<p>总结概括的话，大概主要是从下面的几个方面：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cdb81c0f31ff472b867ec8dc0e9fbc7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=UdxxnZXMgs%2FZcyAqGXufQVPGnhA%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-12">3.4 组件的动态注入</h4>
<p>在音视频通用化组件中，涉及到诸多业务场景，动态配置注入组件的的功能，下面详细的介绍下，相关的一些组件动态注入的实现方式，我们工程中用的比较多的就是静态导入了，下面看下两者区别。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 静态导入 - 编译时绑定</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">StaticComponentDemo</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./StaticComponentDemo'</span>;

<span class="hljs-comment">// 动态注入 - 运行时加载</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">DynamicComponentDemo</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./DynamicComponentDemo'</span>));
</code></pre>
<p><code>React</code>组件动态注入主要是通过将​代码分割​​、​​按需加载​​和​​运行时集成​​相结合的方式 ， 是在运行时按需加载和渲染组件​​</p>
<p>动态注入组件的特点主要有下面几点：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ecc7e9975b244d5b5d1725ec21431d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=D7JS4NWls%2FDN4Km5te3HcN4yEWs%3D" alt="image.png" loading="lazy"/></p>
<p>可以减少初始加载体积，提升首屏速度，支持插件化、主题化、A/B 测试等高级场景，保持代码模块化，简化复杂应用结构，实现真正的热插拔组件系统。<code>React</code>组件动态注入有哪几种方式呢？</p>
<p>1、<code>React.lazy</code>和 <code>Suspense</code>的方式</p>
<p>此种方式主要是按需加载组件，<code>React.lazy</code>函数允许动态地加载组件，它返回一个Promise，该Promise解析为一个包含React组件的模块。通常与<code>Suspense</code>组件一起使用，在加载过程中显示回退内容。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { <span class="hljs-title class_">Suspense</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">LazyComponentDemo</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./LazyComponentDemo'</span>));

<span class="hljs-keyword">const</span>  <span class="hljs-title function_">MyComponentDemo</span> =(<span class="hljs-params"/>)=&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">LazyComponentDemo</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<ul>
<li><code>React.lazy</code>接受一个函数，该函数返回一个动态<code>import()</code>的Promise。</li>
<li>当组件首次渲染时，会触发加载。加载过程中，<code>Suspense</code>会显示<code>fallback</code>内容。</li>
<li>加载完成后，组件被渲染。</li>
</ul>
<p>注意​：<code>React.lazy</code>只支持默认导出（export default）的组件。</p>
<p>React.lazy 内部实现</p>
<pre><code class="hljs language-ini" lang="ini">function lazy(ctor) {
  let <span class="hljs-attr">thenable</span> = null<span class="hljs-comment">;</span>
  
  return {
    $$typeof: REACT_LAZY_TYPE,
    _payload: {
      _status: -1,  // 状态: <span class="hljs-attr">-1</span>=未加载, <span class="hljs-number">0</span>=加载中, <span class="hljs-number">1</span>=加载成功, <span class="hljs-number">2</span>=加载失败
      _result: ctor, // 加载函数
    },
    _init(payload) {
      if (<span class="hljs-attr">payload._status</span> === -<span class="hljs-number">1</span>) {
        const <span class="hljs-attr">ctorResult</span> = ctor()<span class="hljs-comment">;</span>
        <span class="hljs-attr">thenable</span> = ctorResult<span class="hljs-comment">;</span>
        
        <span class="hljs-attr">payload._status</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        ctorResult.then(
          <span class="hljs-attr">module</span> =&gt; {
            if (<span class="hljs-attr">payload._status</span> === <span class="hljs-number">0</span>) {
              <span class="hljs-attr">payload._status</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
              <span class="hljs-attr">payload._result</span> = module.default<span class="hljs-comment">;</span>
            }
          },
          <span class="hljs-attr">error</span> =&gt; {
            if (<span class="hljs-attr">payload._status</span> === <span class="hljs-number">0</span>) {
              <span class="hljs-attr">payload._status</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>
              <span class="hljs-attr">payload._result</span> = error<span class="hljs-comment">;</span>
            }
          }
        )<span class="hljs-comment">;</span>
      }
      
      switch (payload._status) {
        case 1: return payload._result<span class="hljs-comment">;</span>
        case 2: throw payload._result<span class="hljs-comment">;</span>
        default: throw thenable<span class="hljs-comment">;</span>
      }
    }
  }<span class="hljs-comment">;</span>
}
</code></pre>
<p>Suspense 工作原理 渲染遇到未准备好的组件时抛出 Promise , React 捕获该 Promise 并暂停渲染 , 显示最近的 Suspense , fallback UI ,Promise 完成后重新尝试渲染 , 成功则显示组件，失败则抛出错误。</p>
<p>2、使用高阶组件（HOC）实现动态加载</p>
<p>创建一个高阶组件，在组件加载过程中管理加载状态，并在加载完成后渲染目标组件，比较适用需要自定义加载逻辑或处理非默认导出的组件。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">withDynamicImportDemo</span> = (<span class="hljs-params">importFunc</span>)=&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">DynamicComponent</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-keyword">const</span> [<span class="hljs-title class_">Component</span>, setComponent] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
      importFunc().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">module</span> =&gt;</span> {
        <span class="hljs-title function_">setComponent</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">module</span>.<span class="hljs-property">default</span>); <span class="hljs-comment">// 假设是默认导出</span>
      });
    }, []);

    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Component</span> ? <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Component</span> {<span class="hljs-attr">...props</span>} /&gt;</span></span> : <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  };
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">MyLazyComponent</span> = <span class="hljs-title function_">withDynamicImportDemo</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./MyComponent'</span>));
</code></pre>
<p>3、<code>import()</code>动态加载 + 状态管理</p>
<p>主要是在事件处理函数中动态导入组件，然后更新状态触发重新渲染。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">MyComponentDemo</span> = (<span class="hljs-params"/>)=&gt; {
  <span class="hljs-keyword">const</span> [<span class="hljs-title class_">Component</span>, setComponent] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">default</span>: <span class="hljs-title class_">DynamicComponent</span> } = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./DynamicComponent'</span>);
    <span class="hljs-title function_">setComponent</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">DynamicComponent</span>);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>点击加载组件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      {Component ? <span class="hljs-tag">&lt;<span class="hljs-name">Component</span> /&gt;</span> : <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>测试点击<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>4、<code>loadable-components</code></p>
<p><code>loadable-components</code>是一个流行的库，提供了更强大的动态导入功能，包括服务端渲染支持。如SSR支持、预加载等，可以考虑使用这种方式。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> loadable <span class="hljs-keyword">from</span> <span class="hljs-string">'@loadable/component'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">LoadableComponent</span> = <span class="hljs-title function_">loadable</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./MyComponentDemo'</span>), {
  <span class="hljs-attr">fallback</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>测试<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>,
});

<span class="hljs-keyword">const</span> <span class="hljs-title function_">MyComponentPage</span> = (<span class="hljs-params"/>)=&gt; {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LoadableComponent</span> /&gt;</span></span>;
}
</code></pre>
<p>5、ReactDOM.createPortal</p>
<p>使用<code>ReactDOM.createPortal</code>将组件渲染到指定的DOM节点。结合动态加载，可以先加载组件再将其渲染到目标位置。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">DynamicPortalDemo</span> = (<span class="hljs-params"/>)=&gt; {
  <span class="hljs-keyword">const</span> [targetNode] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'portal-root'</span>));
  <span class="hljs-keyword">const</span> [<span class="hljs-title class_">Component</span>, setComponent] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">import</span>(<span class="hljs-string">'./PortalComponent'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">module</span> =&gt;</span> {
      <span class="hljs-title function_">setComponent</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">module</span>.<span class="hljs-property">default</span>);
    });
  }, []);

  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Component</span> || !targetNode) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createPortal</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Component</span> /&gt;</span></span>, targetNode);
}
</code></pre>
<p>在音视频通用化组件中，我们看下实现组件动态加载的界面，整个语音转文字组件、交流讨论组件、以及业务自定义的组件，像讲标顺序组件、会议监控、会议笔录组件等，都是动态注入的组件。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a783ec3e727a4be39c02f56c5d29695e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=NX0pn8hx7N2ECIAXmqdMB4VslOA%3D" alt="image.png" loading="lazy"/></p>
<p>相关的代码如下所示：</p>
<pre><code class="hljs language-ini" lang="ini">  // 遍历注册对应的组件
const <span class="hljs-attr">getDomContent</span> = (arr) =&gt; {
  return (
    &lt;&gt;
      {arr?.map((<span class="hljs-attr">item</span> = {}) =&gt; {
        const <span class="hljs-attr">DomItem</span> = innerContainerComponent[item?.btnKey]<span class="hljs-comment">;</span>
        return (
          &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"online-meeting-inner-slot-list"</span> key={item.btnKey}&gt;
            &lt;React.Suspense <span class="hljs-attr">fallback</span>={&lt;div /&gt;}&gt;
              {DomItem &amp;&amp; (
                &lt;DomItem
                  <span class="hljs-attr">innerComponentList</span> = {innerSlotComponent}
                  <span class="hljs-attr">direction</span>={direction}
                  <span class="hljs-attr">btnConfig</span>={item}
                  <span class="hljs-attr">btnKey</span>={item?.btnKey}
                  <span class="hljs-attr">im</span>={im}
                  <span class="hljs-attr">onCloseIMDialog</span>={() =&gt; {
                    onCloseIMDialog(item?.btnKey)<span class="hljs-comment">;</span>
                  }}
                      <span class="hljs-attr">onRemoveSoltComponent</span>={() =&gt; <span class="hljs-literal">on</span>RemoveSoltComponent(item?.btnKey)}
                  {...props}
                /&gt;
              )}
            &lt;/React.Suspense&gt;
          &lt;/div&gt;
        )<span class="hljs-comment">;</span>
      })}
    &lt;/&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

return (
  &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"online-meeting-inner-slot-container"</span>&gt;
    {getDomContent(innerSlotComponent)}
  &lt;/div&gt;
)<span class="hljs-comment">;</span>
</code></pre>
<p>利用组件动态注入，可以进行一些性能优化方面的优化策略，主要有下面几个方面：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e95f3eb3f8424b43b761ab0900792a65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=qVm3uTdQOv7hOcBXP5I%2BfljLDZ8%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">componentCacheDemo</span> = new Map()<span class="hljs-comment">;</span>
const <span class="hljs-attr">CachedComponent</span> = (loader)=&gt; {
  const <span class="hljs-section">[Component, setComponent]</span> = useState(null)<span class="hljs-comment">;</span>
  
  useEffect(() =&gt; {
    if (componentCacheDemo.has(loader)) {
      setComponent(componentCacheDemo.get(loader))<span class="hljs-comment">;</span>
      return<span class="hljs-comment">;</span>
    }
    
    loader().then(<span class="hljs-attr">module</span> =&gt; {
      const <span class="hljs-attr">Comp</span> = module.default<span class="hljs-comment">;</span>
      componentCacheDemo.set(loader, Comp)<span class="hljs-comment">;</span>
      setComponent(() =&gt; Comp)<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[loader]</span>)<span class="hljs-comment">;</span>
  
  return Component<span class="hljs-comment">;</span>
}
</code></pre>
<p>组件动态加载的未来发展趋势，像服务端组件直接动态加载 、远程组件动态加载、基于 AI 的预测加载等，随着 React 18 并发特性、<code>Server Components</code> 和 <code>Module Federation</code> 等技术的发展，动态加载组件将成为一种核心模式。</p>
<h3 data-id="heading-13">4、音视频通用组件多端消息收发</h3>
<h4 data-id="heading-14">4.1 <code>IM</code>消息收发</h4>
<p><code>IM</code>主要是在视频会议中, 我们的主持人在视频会议中会操控其他与会人员的音视频开启关闭,邀请与会人员的开启页面监控等操作。这些操作我们会通过IM消息发送的方式通知给相应的与会人员，其次包括视频会议的讨论功能。</p>
<p>我们看下，<code>IM</code>消息收发的流程是如何实现的？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac689f7d5e7a4f0d815191d873aa5e9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=uuANy41Gn1SDQYMhZsbYfEHpu34%3D" alt="image.png" loading="lazy"/></p>
<p>客户端A 与客户端B，会通过当前本端获取到唯一标识Token, 进行登录，且实现消息之间的传送。底层能力也是基于<code>WebRTC</code>的点与点之间的通信链接 和 <code>WebSocket</code>来实现的。</p>
<p>音视频IM系统包含多种消息类型，每种都有不同的传输要求。</p>
<pre><code class="hljs language-ini" lang="ini">// 消息类型定义
enum MessageType {
  <span class="hljs-attr">TEXT</span> = <span class="hljs-string">'text'</span>,           // 文本消息
  <span class="hljs-attr">IMAGE</span> = <span class="hljs-string">'image'</span>,         // 图片消息
  <span class="hljs-attr">AUDIO</span> = <span class="hljs-string">'audio'</span>,         // 音频消息
  <span class="hljs-attr">VIDEO</span> = <span class="hljs-string">'video'</span>,         // 视频消息
  <span class="hljs-attr">FILE</span> = <span class="hljs-string">'file'</span>,           // 文件消息
  <span class="hljs-attr">CALL_INVITE</span> = <span class="hljs-string">'call_invite'</span>,    // 通话邀请
  <span class="hljs-attr">CALL_ACCEPT</span> = <span class="hljs-string">'call_accept'</span>,    // 通话接受
  <span class="hljs-attr">CALL_REJECT</span> = <span class="hljs-string">'call_reject'</span>,    // 通话拒绝
  <span class="hljs-attr">CALL_END</span> = <span class="hljs-string">'call_end'</span>,          // 通话结束
  <span class="hljs-attr">TYPING</span> = <span class="hljs-string">'typing'</span>,              // 输入状态
  <span class="hljs-attr">READ_RECEIPT</span> = <span class="hljs-string">'read_receipt'</span>   // 已读回执
}
</code></pre>
<p>消息收发核心代码如下所示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">IMCore</span> {
  <span class="hljs-keyword">private</span> wsManager: WebSocketManager;     <span class="hljs-comment">// WebSocket连接管理</span>
  <span class="hljs-keyword">private</span> messageQueue: MessageQueue;      <span class="hljs-comment">// 消息队列</span>
  <span class="hljs-keyword">private</span> mediaProcessor: MediaProcessor;  <span class="hljs-comment">// 媒体处理</span>
  <span class="hljs-keyword">private</span> storage: MessageStorage;         <span class="hljs-comment">// 消息存储</span>
  
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">this</span>.<span class="hljs-keyword">init</span>();
  }
  
  <span class="hljs-keyword">private</span> async <span class="hljs-keyword">init</span>() {
    await <span class="hljs-keyword">this</span>.setupWebSocket();
    <span class="hljs-keyword">this</span>.setupMessageHandlers();
  }
}
</code></pre>
<p>我们看下音视频通用化组件中实现的效果截图：</p>
<p>主持人 ｜ 客户端A</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ebf83ee3afa4e939ba07312d9ed8c60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=dx6faYc6eeTL3ZIYL0dkxaFVmNM%3D" alt="image.png" loading="lazy"/></p>
<p>专家｜客户端B</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/313766f7a6bc4ac7a784521503cd34e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=GMIc8DsCDBoLhUzaB%2FV6yV93kWc%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<p>当客户端A发送发送消息的时候，此时客户端B的人，存在监听消息事件，当监听到消息的时候，动态将此消息文本，注入到数组中，且在界面上显示。</p>
<pre><code class="hljs language-ini" lang="ini"> // 监听消息
  const <span class="hljs-attr">onMsg</span> = (msgsValue = []) =&gt; {
    if (msgsValue?.length &gt; 0) {
      const <span class="hljs-attr">originHistoryMsgs</span> = originHistoryMsgsRef?.current || []<span class="hljs-comment">;</span>
      const <span class="hljs-attr">newMsgs</span> = originHistoryMsgs.concat(msgsValue)<span class="hljs-comment">;</span>
      setMsgs(newMsgs)<span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>

// 初始化请求历史数据，以及注册接受IM发送过来的消息
  useEffect(() =&gt; {
    const { im } = props<span class="hljs-comment">;</span>
    getHistoryData()<span class="hljs-comment">;</span>
    try {
      <span class="hljs-attr">im.onReciveMsg</span> = <span class="hljs-literal">on</span>Msg<span class="hljs-comment">;</span>
    } catch (err) {
      //
    }
  }, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-15">4.2 <code>webSocket</code>消息收发</h4>
<p>在音视频中，另外一个消息收发的方式，就是使用 <code>webSocket</code>，进行实时的通信，这种应该是比较常见使用的。<code>webSocket</code>的特性主要包括下面这些方面：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1be16963f0884d52a281a1a04d64bca4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=ZCXswQDXhU4CAbWg1VkNhmwLBRU%3D" alt="image.png" loading="lazy"/></p>
<p>客户端和服务器可​同时​​发送和接收数据 ，建立连接后，数据传输无需 HTTP 握手开销，一个连接持续复用，避免频繁建立/断开连接的开销，可进行高效传输图片、音频、视频等二进制消息。</p>
<p>我们来看下<code>webSocket</code>的相关的特性和具体实现：</p>
<p>1、连接建立：HTTP 升级握手</p>
<p>WebSocket 连接始于标准的 HTTP 请求，通过 <code>Upgrade</code>头切换协议</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">GET</span> <span class="hljs-string">/chat</span> <span class="hljs-string">HTTP/1.1</span>
<span class="hljs-attr">Host:</span> <span class="hljs-string">server.example.com</span>
<span class="hljs-attr">Upgrade:</span> <span class="hljs-string">websocket</span>          <span class="hljs-comment"># 关键：请求升级协议</span>
<span class="hljs-attr">Connection:</span> <span class="hljs-string">Upgrade</span>         <span class="hljs-comment"># 关键：要求切换连接</span>
<span class="hljs-attr">Sec-WebSocket-Key:</span> <span class="hljs-string">dGhlIHNhbXBsZSBub25jZQ==</span>  <span class="hljs-comment"># 客户端随机密钥</span>
<span class="hljs-attr">Sec-WebSocket-Version:</span> <span class="hljs-number">13</span>    <span class="hljs-comment"># 协议版本</span>
</code></pre>
<p>2、服务器响应协议升级</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">HTTP/1.1</span> <span class="hljs-number">101</span> <span class="hljs-string">Switching</span> <span class="hljs-string">Protocols</span>
<span class="hljs-attr">Upgrade:</span> <span class="hljs-string">websocket</span>
<span class="hljs-attr">Connection:</span> <span class="hljs-string">Upgrade</span>
<span class="hljs-attr">Sec-WebSocket-Accept:</span> <span class="hljs-string">s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</span>  <span class="hljs-comment"># 验证密钥</span>
</code></pre>
<p>3、密钥验证原理</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3a87a8f37964ad0be662262596f19c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=pKB4gP%2FAvB0i%2BxZPzmYofwOST1M%3D" alt="image.png" loading="lazy"/></p>
<p>4、连接保活：心跳机制</p>
<p>通过 ​Ping/Pong 帧​​ 维持连接活性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b962177c3874b6782663d018b91e6c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=WuBqZqQPGuTKBpjzyGPeujHrcDo%3D" alt="image.png" loading="lazy"/></p>
<p>整体的通信过程如下所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8bcd58ee5a5420e941b68f5761626b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=6OnCB5vIrEyvbvOX%2FTbAgAe%2FVec%3D" alt="image.png" loading="lazy"/></p>
<p>5、连接关闭：握手终止</p>
<p>关闭流程需双方交换关闭帧, 大致流程如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bafb797b5c8d4c5a9f7cd95e7f0cb8ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=GJ8XXAXoH8RWR%2BnkNOmSElzlVR4%3D" alt="image.png" loading="lazy"/></p>
<p>总结一下，主要是下面这些方面：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/581fec64a4ba49f2b6726837d9a83e84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763354490&amp;x-signature=55L75un1JMu5Kd8YGY411UeUx%2F0%3D" alt="image.png" loading="lazy"/></p>
<p>封装的webSocket的demo代码大致如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@description</span> 消息实时通信组件（websocket实现）
 * <span class="hljs-doctag">@class</span> WebsocketDemo
 * <span class="hljs-doctag">@constructor</span> 非静态类
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WebsocketDemo</span> {
  <span class="hljs-keyword">constructor</span>(opt) {
    <span class="hljs-comment">// websocket实例</span>
    <span class="hljs-keyword">this</span>.ws = <span class="hljs-literal">null</span>;
    <span class="hljs-comment">// url</span>
    <span class="hljs-keyword">this</span>.url = opt.url || <span class="hljs-literal">null</span>;
    <span class="hljs-comment">// 心跳包数据，客户端发送ping，服务端回复pong</span>
    <span class="hljs-keyword">this</span>.heartData = opt.heartData || <span class="hljs-string">'ping'</span>;
    <span class="hljs-comment">// 客户端发送心跳的定时器 timer</span>
    <span class="hljs-keyword">this</span>.heartTimer = <span class="hljs-literal">null</span>;
    <span class="hljs-comment">// 客户端多久发送一次心跳包，默认 2mins</span>
    <span class="hljs-keyword">this</span>.heartInterval = opt.heartInterval || <span class="hljs-number">2</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>;
    <span class="hljs-comment">// 是否允许重连。默认自动拿上一次 uri 进行重连。如果连接为服务端返回的动态 uri 时，请设置该值为 false</span>
    <span class="hljs-keyword">this</span>.allowReconnect = opt.allowReconnect;
    <span class="hljs-comment">// 重连计数器</span>
    <span class="hljs-keyword">this</span>.reconnectCounter = <span class="hljs-number">0</span>;
    <span class="hljs-comment">// 重连次数上限，默认最多尝试重连 3 次</span>
    <span class="hljs-keyword">this</span>.reconnectLimit = opt.reconnectLimit || <span class="hljs-number">3</span>;
    <span class="hljs-comment">// 重连的定时器 timer</span>
    <span class="hljs-keyword">this</span>.reconnectTimer = <span class="hljs-literal">null</span>;
    <span class="hljs-comment">// 定时多久重连一次，默认为 5s</span>
    <span class="hljs-keyword">this</span>.reconnectInterval = opt.reconnectInterval || <span class="hljs-number">5</span> * <span class="hljs-number">1000</span>;
    <span class="hljs-comment">// 创建连接成功后的回调函数</span>
    <span class="hljs-keyword">this</span>.connectedCallback = opt.connectedCallback || function () {};
    <span class="hljs-comment">// 接收到服务器端消息后的回调函数</span>
    <span class="hljs-keyword">this</span>.getMsgCallback = opt.getMsgCallback || function () {};
    window.onbeforeunload = () =&gt; {
      <span class="hljs-keyword">this</span>.ws.close();
    };
    <span class="hljs-keyword">this</span>.createWebSocket(<span class="hljs-keyword">this</span>.url);
  }

  <span class="hljs-comment">// 创建连接</span>
  createWebSocket(url) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 判断当前浏览器是否支持 websocket</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-string">'WebSocket'</span> <span class="hljs-keyword">in</span> window) {
        <span class="hljs-keyword">this</span>.ws = new WebSocket(<span class="hljs-keyword">this</span>.url);
      } <span class="hljs-keyword">else</span> {
        alert(
          <span class="hljs-string">'您的浏览器不支持websocket协议，建议使用新版谷歌、火狐等浏览器，请勿使用IE10以下浏览器，360浏览器请使用极速模式，不要使用兼容模式！'</span>,
        );
      }
      <span class="hljs-keyword">this</span>.<span class="hljs-keyword">init</span>();
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">this</span>.reconnect(url);
    }
  }

  <span class="hljs-comment">// 初始化事件处理</span>
  <span class="hljs-keyword">init</span>() {
    <span class="hljs-keyword">this</span>.ws.onclose = (closeEvent) =&gt; {
      <span class="hljs-keyword">this</span>.closedCallback();
      <span class="hljs-keyword">if</span> (
        closeEvent.code !== <span class="hljs-number">4001</span> &amp;&amp;
        closeEvent.code !== <span class="hljs-number">4003</span> &amp;&amp;
        closeEvent.code !== <span class="hljs-number">1100</span> &amp;&amp;
        closeEvent.code !== <span class="hljs-number">1000</span>
      ) {
        <span class="hljs-keyword">this</span>.reconnect(<span class="hljs-keyword">this</span>.url);
      }
    };
    <span class="hljs-keyword">this</span>.ws.onerror = () =&gt; {
      <span class="hljs-keyword">this</span>.errorCallback();
      <span class="hljs-keyword">this</span>.reconnect(<span class="hljs-keyword">this</span>.url);
    };
    <span class="hljs-keyword">this</span>.ws.onopen = () =&gt; {
      <span class="hljs-keyword">this</span>.reconnectCounter = <span class="hljs-number">0</span>; <span class="hljs-comment">// 重连计数器重置</span>
      <span class="hljs-keyword">this</span>.startHeartBeat(); <span class="hljs-comment">// 心跳检测重置，并启动</span>
      <span class="hljs-keyword">this</span>.connectedCallback();
    };
    <span class="hljs-keyword">this</span>.ws.onmessage = (event) =&gt; {
      <span class="hljs-keyword">this</span>.startHeartBeat(); 
      <span class="hljs-keyword">if</span> (event.<span class="hljs-keyword">data</span> !== <span class="hljs-string">'pong'</span>) {
        <span class="hljs-keyword">this</span>.getMsgCallback(event.<span class="hljs-keyword">data</span>);
      }
    };
  }

  <span class="hljs-comment">// 发送消息</span>
  send(<span class="hljs-keyword">data</span>) {
    <span class="hljs-keyword">const</span> dataStr = typeof <span class="hljs-keyword">data</span> !== <span class="hljs-string">'string'</span> ? JSON.stringify(<span class="hljs-keyword">data</span>) : <span class="hljs-keyword">data</span>;
    <span class="hljs-keyword">this</span>.ws.send(dataStr);
  }

  <span class="hljs-comment">// 关闭连接</span>
  close() {
    <span class="hljs-keyword">this</span>.allowReconnect = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.ws.close();
  }

  <span class="hljs-comment">// 尝试重连</span>
  reconnect() {
    clearTimeout(<span class="hljs-keyword">this</span>.reconnectTimer);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.allowReconnect === <span class="hljs-literal">false</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.reconnectCounter &lt; <span class="hljs-keyword">this</span>.reconnectLimit) {
      <span class="hljs-keyword">this</span>.reconnectTimer = setTimeout(() =&gt; {
        <span class="hljs-keyword">this</span>.createWebSocket(<span class="hljs-keyword">this</span>.url);
        <span class="hljs-keyword">this</span>.reconnectCounter += <span class="hljs-number">1</span>;
      }, <span class="hljs-keyword">this</span>.reconnectInterval);
    }
  }

  <span class="hljs-comment">// 启动心跳机制</span>
  startHeartBeat() {
    clearTimeout(<span class="hljs-keyword">this</span>.heartTimer); <span class="hljs-comment">// 清除 客户端发送心跳的定时器</span>
    <span class="hljs-keyword">this</span>.heartTimer = setTimeout(() =&gt; {
      <span class="hljs-keyword">this</span>.ws.send(<span class="hljs-string">'ping'</span>);
    }, <span class="hljs-keyword">this</span>.heartInterval);
  }
}

export default WebsocketDemo;
</code></pre>
<p>调用接入使用的时候，如下代码实例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">this</span>.<span class="hljs-property">wsInstanceDemo</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebsocketDemo</span>({
      <span class="hljs-attr">url</span>: wsUrl,
      <span class="hljs-attr">allowReconnect</span>: <span class="hljs-literal">false</span>,
      heartInterval,
      <span class="hljs-attr">connectedCallback</span>: <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">global</span>.<span class="hljs-property">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'连接创建成功'</span>);
      },
      <span class="hljs-attr">getMsgCallback</span>: <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
        <span class="hljs-comment">// 处理接受到的消息数据</span>
        ....
      }
})
</code></pre>
<h3 data-id="heading-16">5、小结</h3>
<p>以上是针对整个音视频相关的探索，未来针对音视频产品，还需要持续的打磨, 往AI方向靠齐，比如可以结合 <code>ML5</code> + <code>WebRTC</code>的方式，在实时音视频方面，比如媒体等相关的功能，可以结合起来使用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HTTP抓包分析神器，Fiddler使用教程、代理设置与HTTPS调试全指南（开发者实战分享）]]></title>    <link>https://juejin.cn/post/7570647711260196874</link>    <guid>https://juejin.cn/post/7570647711260196874</guid>    <pubDate>2025-11-10T05:11:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570647711260196874" data-draft-id="7570647711260180490" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HTTP抓包分析神器，Fiddler使用教程、代理设置与HTTPS调试全指南（开发者实战分享）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-10T05:11:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="bcbnb"/> <meta itemprop="url" content="https://juejin.cn/user/895474073078377"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HTTP抓包分析神器，Fiddler使用教程、代理设置与HTTPS调试全指南（开发者实战分享）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/895474073078377/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    bcbnb
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T05:11:54.000Z" title="Mon Nov 10 2025 05:11:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在开发和测试的日常工作中，<strong>“接口调不通”</strong> 几乎是最常见的痛点。
API 请求失败、响应异常、跨域报错、移动端访问异常……每一个看似简单的问题，背后可能隐藏着请求头错误、证书配置问题、甚至是服务器响应延迟。</p>
<p>面对这种复杂情况，最有效的办法不是“猜”，而是“抓包”，而说到抓包工具，<strong>Fiddler</strong> 几乎是每一位开发者的必备神器。</p>
<p>本文将为你系统讲解 <strong>Fiddler抓包工具</strong> 的安装配置、代理设置、HTTPS 抓包、调试技巧及实战案例，让你从入门到进阶，掌握网络请求分析的全流程。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、Fiddler抓包工具简介</strong></h2>
<p><strong>Fiddler</strong> 是由 Telerik 开发的一款免费 HTTP/HTTPS 抓包与调试工具。
它通过建立本地代理服务器，拦截系统中所有网络请求，帮助开发者分析接口调用、监控流量、模拟响应、优化性能。</p>
<p>与其他抓包工具（如 Charles、Postman、Wireshark）相比，Fiddler 的优势在于：</p>
<ul>
<li><strong>免费且功能全面</strong>；</li>
<li><strong>支持多端抓包（Web / App / 小程序 / 桌面程序）</strong>；</li>
<li><strong>支持 HTTPS 解密与证书管理</strong>；</li>
<li><strong>可设置断点修改请求与响应</strong>；</li>
<li><strong>Mock 数据支持本地接口调试</strong>；</li>
<li><strong>内置性能分析与请求统计工具</strong>。</li>
</ul>
<p>简单来说，Fiddler 是开发者调试接口与分析网络请求最强大的工具之一。</p>
<hr/>
<h2 data-id="heading-1"><strong>二、Fiddler安装与配置方法</strong></h2>
<h3 data-id="heading-2"><strong>1. 安装与启动</strong></h3>
<p>Fiddler 安装非常简单，启动后会自动接管系统代理。
打开浏览器访问任意网站，你就能在左侧面板看到所有 HTTP 请求。</p>
<p><strong>小提示：</strong></p>
<ul>
<li>“Capturing” 表示当前正在抓包；</li>
<li>“Paused” 表示暂停抓包，可点击状态栏启用。</li>
</ul>
<hr/>
<h3 data-id="heading-3"><strong>2. Fiddler代理设置（电脑 + 移动端）</strong></h3>
<p>如果你希望抓取移动端流量（例如 iOS、Android App 或小程序），
需要开启 Fiddler 的远程代理功能：</p>
<p><strong>操作步骤如下：</strong></p>
<ol>
<li>打开菜单 <code>Tools → Options → Connections</code>；</li>
<li>勾选 <strong>Allow remote computers to connect</strong>；</li>
<li>查看电脑的本地 IP 地址与端口（默认 8888）；</li>
<li>确保手机与电脑在同一 Wi-Fi 网络下；</li>
<li>在手机 Wi-Fi 高级设置中配置代理：
<ul>
<li>服务器：电脑 IP</li>
<li>端口：8888</li>
</ul>
</li>
</ol>
<p>完成后，手机所有网络请求都会通过 Fiddler 进行转发与监控。</p>
<hr/>
<h3 data-id="heading-4"><strong>3. HTTPS 抓包配置</strong></h3>
<p>现代网站几乎都使用 HTTPS，因此必须安装证书才能查看加密流量。</p>
<p><strong>配置步骤：</strong></p>
<ul>
<li>打开 <code>Tools → Options → HTTPS</code>；</li>
<li>勾选 <strong>Decrypt HTTPS traffic</strong>；</li>
<li>点击 “Actions → Trust Root Certificate”；</li>
<li>安装并信任 Fiddler 根证书；</li>
<li>对于移动端，还需导入证书并设置信任。</li>
</ul>
<p>完成后，Fiddler 即可解析 HTTPS 请求的完整内容，包括 Header、Body 与响应结果。</p>
<hr/>
<h2 data-id="heading-5"><strong>三、Fiddler使用教程：核心功能详解</strong></h2>
<h3 data-id="heading-6"><strong>1. 请求与响应分析</strong></h3>
<p>在主界面中，每条请求都可展开查看详细内容：</p>
<ul>
<li>请求方式、URL、状态码；</li>
<li>请求头（Headers）、参数（Params）、请求体（Body）；</li>
<li>响应内容（Response）与耗时统计（Statistics）。</li>
</ul>
<p>📍 <strong>实用技巧：</strong>
点击右下角的 “Timeline” 可查看每个阶段耗时（DNS / TCP / TLS / Response），
有助于判断性能瓶颈是否来自网络延迟或服务器响应慢。</p>
<hr/>
<h3 data-id="heading-7"><strong>2. 断点调试（Breakpoints）</strong></h3>
<p>Fiddler 的断点功能可拦截请求与响应，允许开发者手动修改数据。</p>
<p><strong>常见应用：</strong></p>
<ul>
<li>模拟接口异常（返回 500 / 404）；</li>
<li>修改请求参数或 Header；</li>
<li>测试前端容错机制；</li>
<li>验证安全逻辑。</li>
</ul>
<p>例如，你可以拦截登录接口请求，将响应修改为 <code>{ "code": 403 }</code>，
从而验证前端是否能正确处理权限异常。</p>
<hr/>
<h3 data-id="heading-8"><strong>3. 本地Mock接口（AutoResponder）</strong></h3>
<p>当前后端接口未开发完成时，可使用 Fiddler 模拟接口返回。</p>
<p><strong>操作步骤：</strong></p>
<ol>
<li>打开 AutoResponder 面板；</li>
<li>点击 “Add Rule” 添加匹配规则；</li>
<li>指定本地 JSON 文件或自定义响应内容；</li>
<li>启用规则后，匹配请求将返回模拟数据。</li>
</ol>
<p><strong>应用场景示例：</strong>
前端开发页面时，后端接口还未完成，可用 Fiddler 返回假数据进行 UI 与逻辑调试，大大提高开发效率。</p>
<hr/>
<h3 data-id="heading-9"><strong>4. 构造与重放请求（Composer）</strong></h3>
<p>Composer 模块让 Fiddler 成为“可交互版 Postman”。
开发者可自由构造请求、修改参数、添加 Header 并重放。</p>
<p>适合场景包括：</p>
<ul>
<li>调试接口参数与返回逻辑；</li>
<li>验证签名、Token 是否正确；</li>
<li>复现线上问题。</li>
</ul>
<hr/>
<h3 data-id="heading-10"><strong>5. 过滤与搜索（Filters）</strong></h3>
<p>在大型项目中，请求数往往成百上千，使用 Filters 模块可以按域名、协议、请求类型快速过， 提高调试效率。</p>
<hr/>
<h2 data-id="heading-11"><strong>四、Fiddler实战案例：移动端接口Bug排查</strong></h2>
<p>在一次移动端调试中，测试人员反馈登录接口返回 403 错误。
后端日志显示正常，接口独立测试也没问题。</p>
<p>使用 Fiddler 抓包后发现：
App 请求时少了 Header <code>Content-Type: application/json</code>，
导致服务器解析失败。</p>
<p>仅用两分钟定位问题，成功解决。
这类隐蔽 Bug，在没有抓包工具时往往难以发现。</p>
<hr/>
<h2 data-id="heading-12"><strong>五、Fiddler常用功能速览</strong></h2>



































<table><thead><tr><th>模块名称</th><th>功能说明</th><th>应用场景</th></tr></thead><tbody><tr><td><strong>Filters</strong></td><td>按关键字过滤请求</td><td>聚焦目标接口</td></tr><tr><td><strong>AutoResponder</strong></td><td>模拟接口响应</td><td>前后端分离开发</td></tr><tr><td><strong>Breakpoints</strong></td><td>修改请求与响应</td><td>模拟错误场景</td></tr><tr><td><strong>Composer</strong></td><td>构造与重放请求</td><td>API 测试与验证</td></tr><tr><td><strong>Timeline</strong></td><td>分析请求耗时</td><td>性能优化</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-13"><strong>六、Fiddler与其他抓包工具对比</strong></h2>






























<table><thead><tr><th>工具</th><th>优势</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Fiddler</strong></td><td>免费、功能强、支持请求修改</td><td>开发 / 测试</td></tr><tr><td><strong>Charles</strong></td><td>界面简洁、易用性强</td><td>新手用户</td></tr><tr><td><strong>Postman</strong></td><td>构造与接口测试方便</td><td>API 调试</td></tr><tr><td><strong>Wireshark</strong></td><td>分析底层协议</td><td>网络安全与运维</td></tr></tbody></table>
<p><strong>结论：</strong>
在“接口级调试 + 网络分析”层面，Fiddler 几乎无可替代。</p>
<hr/>
<h2 data-id="heading-14"><strong>七、学习与资源推荐</strong></h2>
<p>想系统学习 Fiddler？推荐访问**<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.fiddler.hk%2F" target="_blank" title="https://www.fiddler.hk/" ref="nofollow noopener noreferrer">Fiddler 中文网</a>**,通过掌握 <strong>Fiddler使用教程</strong>、<strong>代理设置</strong> 与 <strong>调试技巧</strong>，
你可以轻松定位接口问题、分析网络性能、验证逻辑正确性。</p>
<p>网站包含：</p>
<ul>
<li>Fiddler 安装与配置教程；</li>
<li>HTTPS 抓包配置与证书管理；</li>
<li>移动端代理设置；</li>
<li>常见问题解决方案；</li>
<li>Mock 与调试实战案例。</li>
</ul>
<hr/>
<p>调试，是一名开发者的核心能力之一。
而 <strong>Fiddler抓包工具</strong> 就是那把让网络通信“透明化”的放大镜。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift 构建 Android 应用？它来了]]></title>    <link>https://juejin.cn/post/7570651893867954228</link>    <guid>https://juejin.cn/post/7570651893867954228</guid>    <pubDate>2025-11-10T05:28:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570651893867954228" data-draft-id="7568796644347887616" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 构建 Android 应用？它来了"/> <meta itemprop="keywords" content="Swift,iOS"/> <meta itemprop="datePublished" content="2025-11-10T05:28:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 构建 Android 应用？它来了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T05:28:16.000Z" title="Mon Nov 10 2025 05:28:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial;color:#00325e}.markdown-body ::selection{background-color:#00325e;color:#fff}.markdown-body blockquote{padding:10px 20px;background-color:#fffaf0;box-shadow:0 3px 10px 0 rgba(255,172,194,.24);border:1px solid #f3ca8e;transition:all .2s;margin:1em 0;border-radius:5px}.markdown-body blockquote p{font-size:14px;line-height:25px;color:#795548}.markdown-body blockquote p:last-child{margin:0}.markdown-body blockquote:hover{border-color:#ff9800;background-color:#fff8e0;box-shadow:0 6px 10px -5px rgba(225,173,98,.3803921569)}.markdown-body blockquote code{color:#ff502c}.markdown-body pre{border:1px solid #8cc0f3;box-shadow:0 3px 10px 0 rgba(255,198,198,.28);border-radius:5px;transition:all .2s;overflow-x:auto;white-space:pre-wrap}.markdown-body pre:hover{border-color:#6d9dce}.markdown-body pre&gt;code{padding:10px 20px;color:#00325e;background:#f0f8ff;font-size:12px;line-height:1.6;display:block}.markdown-body code{background:#f6fbff;color:#0b5393;padding:2px 4px;border-radius:4px;font-size:12px}.markdown-body p{font-size:14px;line-height:28px;text-align:justify;margin-bottom:17px;color:#595959}.markdown-body a{color:#00325e;text-decoration:none}.markdown-body a:after{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAQdJREFUKFNt0DtLA0EUBeBzZle0Eks7rcUfEfBRCha7NorYa6NmVJzgyi4smUgKtdZGCJktLMVH4Y8QeztLWyE7VyLEuNFbXj4Oh0P8c8mZm+uJrEN4BJFTeP/MUVe3bnocfALwkOlo1zS7iZAzf6Cx7oXgbaqjxiDEWCcVaGyxQ8pSWo9XhqhoQ/xUFbaKjhe5V+CmR7mnSplEEF6GSmJ+F/d0KHvbCIIJCLc85U6BC5mONgbJNM3uFag++sX7z8O8MzsWBucifMx0dDGE1kmm458KDVukAlnNdDz/exEeW3dNkbfsYC0xtmgDWP6ELLZ0/F6BJu/UoFQN5AkoeUjeJPvx6+i+X5Sjah4tA6gYAAAAAElFTkSuQmCC);margin-left:2px}.markdown-body a:hover{box-shadow:0 1px}.markdown-body table{max-width:100%;border-collapse:collapse;border-spacing:0;box-shadow:0 3px 10px 0 rgba(255,238,172,.24);transition:all .2s}.markdown-body table:hover{box-shadow:0 3px 10px 0 rgba(185,169,103,.24)}.markdown-body table tr th{border:1px solid #8cc0f3;background-color:#f0f8ff;padding:12px 15px}.markdown-body table tr td{border:1px solid rgba(243,202,142,.4);padding:12px 15px}.markdown-body table tbody tr{transition:all .2s}.markdown-body table tbody tr:hover td{border-color:#f3ca8e;background-color:#fff8e0;z-index:1}.markdown-body img{max-width:100%}.markdown-body h1{font-size:20px;margin-top:30px;margin-bottom:10px;padding-left:30px;position:relative}.markdown-body h1&gt;code{font-size:20px}.markdown-body h1:before{content:"🍺";display:block;font-size:18px;width:18px;height:18px;left:0;position:absolute}.markdown-body h2{font-size:18px;margin-top:30px;margin-bottom:10px;padding-left:28px;position:relative}.markdown-body h2&gt;code{font-size:18px}.markdown-body h2:before{content:"🍻";display:block;font-size:16px;width:16px;height:16px;left:0;position:absolute}.markdown-body h3{font-size:16px;margin-top:30px;margin-bottom:10px;padding-left:26px;position:relative}.markdown-body h3&gt;code{font-size:16px}.markdown-body h3:before{content:"🥂";display:block;font-size:14px;width:14px;height:14px;left:0;position:absolute}.markdown-body h4{font-size:14px;margin-top:30px;margin-bottom:10px;padding-left:24px;position:relative}.markdown-body h4&gt;code{font-size:14px}.markdown-body h4:before{content:"🥃";display:block;font-size:12px;width:12px;height:12px;left:0;position:absolute}.markdown-body h5{font-size:12px;margin-top:30px;margin-bottom:10px}.markdown-body h5&gt;code{font-size:12px}.markdown-body h6{font-size:10px;margin-top:30px;margin-bottom:10px}.markdown-body h6&gt;code{font-size:10px}.markdown-body h1,.markdown-body h2{color:#ff502c}.markdown-body hr{height:4px;border:none;margin-top:32px;margin-bottom:32px;background-size:4px 1px;background-image:linear-gradient(270deg,#6d9dce,#8cc0f3 25%,transparent 50%)}.markdown-body hr:nth-child(2n){background-image:linear-gradient(270deg,#ff9800,#fff8e0 25%,transparent 50%)}.markdown-body ul{padding-inline-start:20px}.markdown-body ul li{list-style-type:"🔸"}.markdown-body ul li li{list-style-type:"◻️"}.markdown-body ul li li li{list-style-type:"▫️"}.markdown-body ol{padding-inline-start:20px}.markdown-body ol ::marker{color:#ff9800}.markdown-body ol,.markdown-body ul{line-height:2em}.markdown-body li{padding-inline-start:1ch}.markdown-body li.task-list-item{list-style:none;padding-inline-start:0}.markdown-body li input{padding-right:2px}.markdown-body li input[type=checkbox i]{appearance:none}.markdown-body li input:before{content:"🟩";display:block;width:13px;height:13px}.markdown-body li input:checked:before{content:"✅"}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-sulphurpool-light">.hljs-comment,.hljs-quote{color:#6b7394}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c94922}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#c76b29}.hljs-bullet,.hljs-string,.hljs-symbol{color:#ac9739}.hljs-section,.hljs-title{color:#3d8fd1}.hljs-keyword,.hljs-selector-tag{color:#6679cc}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#f5f7ff;color:#5e6687}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4d40136e2fb4e9b8e561157cf588586~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763357295&amp;x-signature=RFtGISs%2BqLZNtsz%2BRj0ZZbNI06M%3D" alt="swift.png" loading="lazy"/></p>
<p>适用于 Android 系统的 Swift SDK 最近以 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.swift.org%2Fblog%2Fnightly-swift-sdk-for-android" target="_blank" title="https://www.swift.org/blog/nightly-swift-sdk-for-android" ref="nofollow noopener noreferrer">nightly 构建版本发布</a>，该 SDK 旨在帮助开发者将他们的 Swift 包移植到 Android 系统，使跨平台共享代码更加容易。</p>
<p>虽然仍处于预览阶段，但 Swift 包索引中已有超过 25% 的包可以编译用于 Android 系统。</p>
<p>从核心层面来看，适用于 Android 系统的 Swift SDK 包含一个为 Android 平台量身定制的 Swift 工具链（即编译器和运行在 Android 系统上的 Swift 标准库实现），以及一组能让 Swift 访问 Android API 的绑定。该 Swift 工具链借助 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fswiftlang%2Fswift-java" target="_blank" title="https://github.com/swiftlang/swift-java" ref="nofollow noopener noreferrer">swift-java</a> 项目实现 Java 与 Swift 的互操作性，能够创建共享对象，这些对象会被链接到 Android 安装包（<code>.apk</code>）存档中，并可通过 Java 本地接口（<code>JNI</code>）进行访问。</p>
<p>Android 版 Swift SDK 在用户界面（UI）方面采取中立的策略。其团队不会只专注于某一种 UI 框架，而是会支持现有的框架，特别是 Android 原生开发工具包（如 <code>Jetpack Compose</code> 和传统的基于 <code>XML</code> 的系统）、<code>Flutter</code> 的 UI 引擎，以及像 <code>Skip</code> 这样的第三方桥接解决方案。Swift  Android 团队并未明确提及的另一种可行方法是，使用 <code>OpenGL</code>、<code>Vulkan</code> 或其他渲染引擎以 Swift 实现 UI，然后使用 <code>NativeActivity</code> 将其集成到 Android 应用中。</p>
<p>特别是 <code>Skip</code> 框架，它通过将 <code>SwiftUI</code> 与 <code>Jetpack Compose</code> 进行桥接，在 Android 系统上重新实现了 <code>SwiftUI</code>。这种方法让 iOS 开发者能用最少的精力，在同一个代码库中编写应用的业务逻辑和用户界面。</p>
<p>有一个名为 <a href="https://link.juejin.cn?target=https%3A%2F%2Fswiftcrossui.dev%2F" target="_blank" title="https://swiftcrossui.dev/" ref="nofollow noopener noreferrer">SwiftCrossUI</a> 的开源替代方案，它能在 macOS、Linux、Windows 系统上提供类似于 SwiftUI 的用户界面 API，并且对 Android 也有一些初步支持。</p>
<p>虽然在 iOS 和 Android 应用中都使用 Swift 的前景听起来很诱人，但正如 andrekandre 在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnews.ycombinator.com%2Fitem%3Fid%3D45700274" target="_blank" title="https://news.ycombinator.com/item?id=45700274" ref="nofollow noopener noreferrer">Hacker News</a> 上指出的，创建出色的跨平台应用不仅仅是工具链支持和原生工具包的问题：</p>
<blockquote>
<p>之前就走过这条路，说实话，最大的问题在于开发者的用户体验（iOS 开发者不容易进行调试，与 Kotlin 存在模型不匹配的问题，比如无法从 Swift 捕获 Kotlin 异常），而且最终即便是 Kotlin 多平台也和用于 Android 开发的 Kotlin 不一样，所以在某种程度上，你仍然算是在引入第三种语言……</p>
</blockquote>
<p>在苹果宣布在 Swift 项目中成立一个 Android 工作小组大约六个月后，适用于 Android 系统的 Swift 软件开发工具包（SDK）首次发布。该工作小组旨在确保 Swift 无需依赖非官方分支就能编译用于 Android 系统的代码，并增强 Swift 的标准库，使其能更好地与 Android API 兼容。</p>
<p>在适用于 Android 系统的 Swift SDK 发布之前，开发者可以使用第三方解决方案（如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.scade.io%2F" target="_blank" title="https://www.scade.io/" ref="nofollow noopener noreferrer">Scade.io</a>）将他们的 Swift 代码编译用于 Android 系统。Scade 基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fswiftlang%2Fswift-java" target="_blank" title="https://github.com/swiftlang/swift-java" ref="nofollow noopener noreferrer">Swift4j</a>，专注于非用户界面的应用程序逻辑。</p>
<p>对于希望将应用移植到 iOS 系统的 Android 开发者来说，一个更成熟的选择是使用 Kotlin 多平台与 <code>Jetpack Compose</code> 多平台技术，这对从事 Android 开发的开发者来说，会更加友好平滑。</p>
<blockquote>
<p>原文<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.infoq.com%2Fnews%2F2025%2F10%2Fswift-sdk-android%2F%3FtopicPageSponsorship%3D84d80d2e-e1fc-48d1-9b49-d099f08c9cdb" target="_blank" title="https://www.infoq.com/news/2025/10/swift-sdk-android/?topicPageSponsorship=84d80d2e-e1fc-48d1-9b49-d099f08c9cdb" ref="nofollow noopener noreferrer">www.infoq.com/news/2025/1…</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[App端用户每日弹出签到弹窗如何实现？（uniapp+Vue)]]></title>    <link>https://juejin.cn/post/7570604028633088035</link>    <guid>https://juejin.cn/post/7570604028633088035</guid>    <pubDate>2025-11-10T03:50:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570604028633088035" data-draft-id="7570533058840412195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="App端用户每日弹出签到弹窗如何实现？（uniapp+Vue)"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-11-10T03:50:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Crystal328"/> <meta itemprop="url" content="https://juejin.cn/user/2359973194513272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            App端用户每日弹出签到弹窗如何实现？（uniapp+Vue)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2359973194513272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Crystal328
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T03:50:07.000Z" title="Mon Nov 10 2025 03:50:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>需求：</strong></p>
<ul>
<li>后端提供接口返回用户签到信息。</li>
<li>应用启动或重新展示时，若用户未签到，需要弹出签到弹窗；已签到则不弹。</li>
<li>签到成功后自动关闭弹窗。<br/></li>
</ul>
<p><strong>思路：</strong></p>
<ol>
<li>用 <code>App.vue</code> 的 <code>onShow</code> 生命周期做全局判断，确保在任意页面激活时都能检查签到状态。</li>
<li>在签到弹窗页 <code>pages/checkIn/checkIn.vue</code> 中负责：  拉取签到详情、渲染奖励列表、调用签到接口并在成功后自动关闭。</li>
</ol>
<p><strong>实现步骤：</strong><br/></p>
<ol>
<li>封装接口调用方法</li>
</ol>
<pre><code class="hljs language-js" lang="js"> <span class="hljs-comment">// 获取签到信息</span>
  <span class="hljs-title function_">getSigninInfoApi</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">return</span> http.<span class="hljs-title function_">get</span>(<span class="hljs-string">"/api/sign_in/info"</span>, { <span class="hljs-attr">params</span>: data || {} });
  },
  <span class="hljs-comment">// 执行签到</span>
  <span class="hljs-title function_">signInApi</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">return</span> http.<span class="hljs-title function_">post</span>(<span class="hljs-string">"/api/sign_in/sign"</span>, { <span class="hljs-attr">data</span>: data || {} });
  },
</code></pre>
<ol start="2">
<li>全局入口检查签到状态 (App.vue)</li>
</ol>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-keyword">import</span> { loginApi } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/login.js'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">checkSigninStatus</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// Step 1. 检查 token 是否存在，没有登录用户不触发签到逻辑</span>
  <span class="hljs-keyword">const</span> token = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'token'</span>);
  <span class="hljs-keyword">if</span> (!token) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// Step 2. 请求签到状态接口</span>
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> loginApi.<span class="hljs-title function_">getSigninInfoApi</span>({});
    <span class="hljs-keyword">if</span> (res?.<span class="hljs-property">code</span> !== <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 接口异常直接退出</span>

    <span class="hljs-keyword">const</span> hasSignedToday = !!res?.<span class="hljs-property">data</span>?.<span class="hljs-property">is_signed_today</span>;
    <span class="hljs-keyword">if</span> (hasSignedToday) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 已签到则不弹窗</span>

    <span class="hljs-comment">// Step 3. 打开签到弹窗（防止重复跳转）</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">openPopup</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">const</span> pages = <span class="hljs-title function_">getCurrentPages</span>();
      <span class="hljs-keyword">const</span> currentPage = pages[pages.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
      <span class="hljs-keyword">if</span> (!currentPage || currentPage.<span class="hljs-property">route</span> === <span class="hljs-string">'pages/checkIn/checkIn'</span>) <span class="hljs-keyword">return</span>;

      <span class="hljs-comment">// 轻微延迟防止路由冲突</span>
      uni.<span class="hljs-title function_">navigateTo</span>({
        <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/checkIn/checkIn'</span>
      });
    };

    <span class="hljs-built_in">setTimeout</span>(openPopup, <span class="hljs-number">300</span>);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'检查签到状态失败:'</span>, e);
  }
};

<span class="hljs-comment">// 在 App.vue 的 onShow 生命周期中触发</span>
<span class="hljs-title function_">onShow</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">checkSigninStatus</span>();
});
</code></pre>
<ol start="3">
<li>签到弹窗逻辑 (pages/checkIn/checkIn.vue)</li>
</ol>
<ul>
<li>页面加载时展示签到按钮。</li>
<li>点击“签到”后调用 <code>loginApi.signInApi()</code>。</li>
<li>签到成功后弹出提示并自动关闭弹窗。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// pages/checkIn/checkIn.vue</span>
<span class="hljs-keyword">import</span> { loginApi } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/login.js'</span>;

<span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);       <span class="hljs-comment">// 按钮加载状态</span>
<span class="hljs-keyword">const</span> isSignedToday = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>); <span class="hljs-comment">// 是否已签到</span>

<span class="hljs-comment">// 页面加载时拉取签到状态</span>
<span class="hljs-title function_">onShow</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> loginApi.<span class="hljs-title function_">getSigninInfoApi</span>({});
  <span class="hljs-keyword">if</span> (res?.<span class="hljs-property">code</span> === <span class="hljs-number">1</span>) {
    isSignedToday.<span class="hljs-property">value</span> = !!res.<span class="hljs-property">data</span>.<span class="hljs-property">is_signed_today</span>;
  }
});

<span class="hljs-comment">// 点击“立即签到”按钮</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSignIn</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (loading.<span class="hljs-property">value</span>) <span class="hljs-keyword">return</span>;
  loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> loginApi.<span class="hljs-title function_">signInApi</span>({});
    <span class="hljs-keyword">if</span> (res?.<span class="hljs-property">code</span> === <span class="hljs-number">1</span>) {
      uni.<span class="hljs-title function_">showToast</span>({
        <span class="hljs-attr">title</span>: <span class="hljs-string">'签到成功'</span>,
        <span class="hljs-attr">icon</span>: <span class="hljs-string">'success'</span>
      });
      <span class="hljs-comment">// 延迟关闭弹窗</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        uni.<span class="hljs-title function_">navigateBack</span>(); <span class="hljs-comment">// 返回上一个页面（即关闭弹窗）</span>
      }, <span class="hljs-number">800</span>);
    } <span class="hljs-keyword">else</span> {
      uni.<span class="hljs-title function_">showToast</span>({
        <span class="hljs-attr">title</span>: res?.<span class="hljs-property">msg</span> || <span class="hljs-string">'签到失败，请稍后再试'</span>,
        <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span>
      });
    }
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'签到请求失败:'</span>, err);
    uni.<span class="hljs-title function_">showToast</span>({
      <span class="hljs-attr">title</span>: <span class="hljs-string">'网络异常，请稍后再试'</span>,
      <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span>
    });
  } <span class="hljs-keyword">finally</span> {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  }
};

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 3中watch侦听器的正确使用姿势你掌握了吗？深度监听、与watchEffect的差异及常见报错解析]]></title>    <link>https://juejin.cn/post/7570630923710005300</link>    <guid>https://juejin.cn/post/7570630923710005300</guid>    <pubDate>2025-11-10T04:05:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570630923710005300" data-draft-id="7570651893867659316" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 3中watch侦听器的正确使用姿势你掌握了吗？深度监听、与watchEffect的差异及常见报错解析    "/> <meta itemprop="keywords" content="前端,Trae,AI编程"/> <meta itemprop="datePublished" content="2025-11-10T04:05:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kknone"/> <meta itemprop="url" content="https://juejin.cn/user/1366025597879930"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 3中watch侦听器的正确使用姿势你掌握了吗？深度监听、与watchEffect的差异及常见报错解析    
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1366025597879930/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kknone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T04:05:11.000Z" title="Mon Nov 10 2025 04:05:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 侦听器的基本用法</h3>
<p>侦听器（<code>watch</code>）是Vue 3中用于<strong>响应式跟踪数据源变化</strong>的核心API，它允许你在响应式数据改变时执行自定义副作用（如发请求、更新DOM、日志记录等）。其核心逻辑是：<strong>明确指定要监听的“源”，并定义“变化时的回调”</strong>。</p>
<h4 data-id="heading-1">1.1 监听单个ref源</h4>
<p><code>ref</code>是Vue 3中最基础的响应式包装器，监听<code>ref</code>的语法非常直观——直接将<code>ref</code>对象作为<code>watch</code>的第一个参数：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref, watch } from 'vue'

// 响应式数据：计数器
const count = ref(0)

// 侦听器：监听count的变化
watch(count, (newValue, oldValue) =&gt; {
  console.log(`计数器从 ${oldValue} 变到了 ${newValue}`)
  // 这里可以执行任何副作用，比如更新页面标题
  document.title = `Count: ${newValue}`
})
&lt;/script&gt;

&lt;template&gt;
  &lt;button @click="count++"&gt;点击增加（当前：{{ count }}）&lt;/button&gt;
&lt;/template&gt;
</code></pre>
<p><strong>关键说明</strong>：</p>
<ul>
<li><code>watch</code>的第一个参数是<strong>监听源</strong>（这里是<code>count</code>）；</li>
<li>第二个参数是<strong>变化回调</strong>，接收两个参数：<code>newValue</code>（变化后的值）、<code>oldValue</code>（变化前的值）；</li>
<li>点击按钮时，<code>count</code>变化会触发回调，修改页面标题。</li>
</ul>
<h4 data-id="heading-2">1.2 监听reactive对象的属性</h4>
<p>对于<code>reactive</code>创建的响应式对象，<strong>不能直接监听整个对象的属性</strong>（会丢失响应式跟踪），需要用<strong>getter函数</strong>返回要监听的属性：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { reactive, watch } from 'vue'

// 响应式对象：用户状态
const user = reactive({
  name: 'Alice',
  age: 25
})

// 侦听器：监听user.name的变化
watch(
  () =&gt; user.name, // getter函数：返回要监听的属性
  (newName, oldName) =&gt; {
    console.log(`用户名从 ${oldName} 改为 ${newName}`)
  }
)
&lt;/script&gt;

&lt;template&gt;
  &lt;input v-model="user.name" placeholder="修改用户名" /&gt;
&lt;/template&gt;
</code></pre>
<p><strong>为什么要用getter？</strong><br/>
<code>reactive</code>对象的属性是“响应式代理”，直接写<code>user.name</code>会返回原始值，无法被<code>watch</code>跟踪。getter函数会让Vue感知到“这个属性需要被跟踪”。</p>
<h4 data-id="heading-3">1.3 监听多个源</h4>
<p><code>watch</code>支持同时监听<strong>多个响应式源</strong>，只需将源包装成数组即可。回调函数的参数会对应数组的新值和旧值：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref, reactive, watch } from 'vue'

const count = ref(0)
const user = reactive({ name: 'Alice' })

// 监听count和user.name两个源
watch(
  [count, () =&gt; user.name], // 源数组
  ([newCount, newName], [oldCount, oldName]) =&gt; { // 新值数组、旧值数组
    console.log(`计数器：${oldCount} → ${newCount}；用户名：${oldName} → ${newName}`)
  }
)
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-4">2. 侦听器的高级选项</h3>
<p><code>watch</code>还支持通过<strong>选项对象</strong>（第三个参数）配置更灵活的行为，常见选项有<code>deep</code>（深度监听）、<code>immediate</code>（立即执行）。</p>
<h4 data-id="heading-5">2.1 深度监听（<code>deep: true</code>）</h4>
<p>当监听的源是<strong>嵌套对象</strong>时，默认情况下<code>watch</code>只会跟踪“对象引用”的变化，不会跟踪“嵌套属性”的变化。需要开启<code>deep: true</code>来监听嵌套属性：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { reactive, watch } from 'vue'

// 嵌套响应式对象：商品信息
const product = reactive({
  id: 1,
  info: {
    name: 'Vue 3 实战',
    price: 99 // 嵌套属性
  }
})

// 深度监听product.info的变化
watch(
  () =&gt; product.info,
  (newInfo, oldInfo) =&gt; {
    console.log(`商品信息更新：价格从 ${oldInfo.price} 变为 ${newInfo.price}`)
  },
  { deep: true } // 开启深度监听
)
&lt;/script&gt;

&lt;template&gt;
  &lt;input v-model.number="product.info.price" placeholder="修改价格" /&gt;
&lt;/template&gt;
</code></pre>
<p><strong>注意</strong>：深度监听会遍历对象的所有嵌套属性，性能开销较大，尽量只在必要时使用（比如确实需要跟踪嵌套变化）。</p>
<h4 data-id="heading-6">2.2 立即执行（<code>immediate: true</code>）</h4>
<p>默认情况下，<code>watch</code>只会在<strong>源第一次变化时</strong>执行回调。如果需要<strong>初始挂载时就执行一次</strong>（比如初始化时拉取数据），可以加<code>immediate: true</code>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref, watch } from 'vue'

const keyword = ref('Vue')

// 立即执行：页面加载时先查一次“Vue”的搜索结果
watch(
  keyword,
  async (newKeyword) =&gt; {
    const res = await fetch(`https://api.example.com/search?q=${newKeyword}`)
    const data = await res.json()
    console.log('搜索结果：', data)
  },
  { immediate: true }
)
&lt;/script&gt;
</code></pre>
<p><strong>应用场景</strong>：初始化时根据默认值加载数据（比如搜索页的默认关键词）。</p>
<h3 data-id="heading-7">3. watch vs watchEffect：核心差异与选择</h3>
<details>
<summary>往期文章归档</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vue响应式声明的API差异、底层原理与常见陷阱你都搞懂了吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vue响应式声明的API差异、底层原理与常见陷阱你都搞懂了吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc405a8d9950af5b7c63b56c348ac36b6%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c405a8d9950af5b7c63b56c348ac36b6/" ref="nofollow noopener noreferrer">为什么Vue 3需要ref函数？它的响应式原理与正确用法是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa7e9abb9691a81e4404d9facabe0f7c3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a7e9abb9691a81e4404d9facabe0f7c3/" ref="nofollow noopener noreferrer">Vue 3中reactive函数如何通过Proxy实现响应式？使用时要避开哪些误区？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbd995ea45161727597fb85b62566c43d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bd995ea45161727597fb85b62566c43d/" ref="nofollow noopener noreferrer">Vue3响应式系统的底层原理与实践要点你真的懂吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F53e3f270a80675df662c6857a3332c0f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/53e3f270a80675df662c6857a3332c0f/" ref="nofollow noopener noreferrer">Vue 3模板如何通过编译三阶段实现从声明式语法到高效渲染的跨越 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fddbce4f2a23aa72c96b1c0473900321e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ddbce4f2a23aa72c96b1c0473900321e/" ref="nofollow noopener noreferrer">快速入门Vue模板引用：从收DOM“快递”到调子组件方法，你玩明白了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F23a2d5a334e15575277814c16e45df50%2F" target="_blank" title="https://blog.cmdragon.cn/posts/23a2d5a334e15575277814c16e45df50/" ref="nofollow noopener noreferrer">快速入门Vue模板里的JS表达式有啥不能碰？计算属性为啥比方法更能打？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6be38de6382e31d282659b689c5b17f0%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6be38de6382e31d282659b689c5b17f0/" ref="nofollow noopener noreferrer">快速入门Vue的v-model表单绑定：语法糖、动态值、修饰符的小技巧你都掌握了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F60ce517684f4a418f453d66aa805606c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/60ce517684f4a418f453d66aa805606c/" ref="nofollow noopener noreferrer">快速入门Vue3事件处理的挑战题：v-on、修饰符、自定义事件你能通关吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe4ae7d5e4a9205bb11b2baccb230c637%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e4ae7d5e4a9205bb11b2baccb230c637/" ref="nofollow noopener noreferrer">快速入门Vue3的v-指令：数据和DOM的“翻译官”到底有多少本事？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F999ce4fb32259ff4fbf4bf7bcb851654%2F" target="_blank" title="https://blog.cmdragon.cn/posts/999ce4fb32259ff4fbf4bf7bcb851654/" ref="nofollow noopener noreferrer">快速入门Vue3，插值、动态绑定和避坑技巧你都搞懂了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa6997d81b49cd232b87e1cf603888ad1%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a6997d81b49cd232b87e1cf603888ad1/" ref="nofollow noopener noreferrer">想让PostgreSQL快到飞起？先找健康密码还是先换引擎？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1fee7afbb9abd4540b8aa9c141d6845d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1fee7afbb9abd4540b8aa9c141d6845d/" ref="nofollow noopener noreferrer">想让PostgreSQL查询快到飞起？分区表、物化视图、并行查询这三招灵不灵？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F79c590fbd87ece535b11a71c9667884f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/79c590fbd87ece535b11a71c9667884f/" ref="nofollow noopener noreferrer">子查询总拖慢查询？把它变成连接就能解决？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F748cdac2536008199abf8a8a2cd0ec85%2F" target="_blank" title="https://blog.cmdragon.cn/posts/748cdac2536008199abf8a8a2cd0ec85/" ref="nofollow noopener noreferrer">PostgreSQL全表扫描慢到崩溃？建索引+改查询+更统计信息三招能破？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F32ca943703226d317d4276a8fb53b0dd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/32ca943703226d317d4276a8fb53b0dd/" ref="nofollow noopener noreferrer">复杂查询总拖后腿？PostgreSQL多列索引+覆盖索引的神仙技巧你get没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fca93f1d53aa910e7ba5ffd8df611c12b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ca93f1d53aa910e7ba5ffd8df611c12b/" ref="nofollow noopener noreferrer">只给表子集建索引？用函数结果建索引？PostgreSQL这俩操作凭啥能省空间又加速？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Ff507856ebfddd592448813c510a53669%2F" target="_blank" title="https://blog.cmdragon.cn/posts/f507856ebfddd592448813c510a53669/" ref="nofollow noopener noreferrer">B-tree索引像字典查词一样工作？那哪些数据库查询它能加速，哪些不能？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb2213bfcb5b88a862f2138404c03d596%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b2213bfcb5b88a862f2138404c03d596/" ref="nofollow noopener noreferrer">想抓PostgreSQL里的慢SQL？pg_stat_statements基础黑匣子和pg_stat_monitor时间窗，谁能帮你更准揪出性能小偷？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F26614eb7da6c476dde41d367ad888d2f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/26614eb7da6c476dde41d367ad888d2f/" ref="nofollow noopener noreferrer">PostgreSQL的“时光机”MVCC和锁机制是怎么搞定高并发的？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F69f99bc6972a860d559c74aad7280da4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/69f99bc6972a860d559c74aad7280da4/" ref="nofollow noopener noreferrer">PostgreSQL性能暴涨的关键？内存IO并发参数居然要这么设置？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F7b7053f392147a8b3b1a16bebeb08d0a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/7b7053f392147a8b3b1a16bebeb08d0a/" ref="nofollow noopener noreferrer">大表查询慢到翻遍整个书架？PostgreSQL分区表教你怎么“分类”才高效</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc856e3cb073822349f3bf2d29995dcfc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c856e3cb073822349f3bf2d29995dcfc/" ref="nofollow noopener noreferrer">PostgreSQL 查询慢？是不是忘了优化 GROUP BY、ORDER BY 和窗口函数？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc096347d18e67b7431faacd2c4757093%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c096347d18e67b7431faacd2c4757093/" ref="nofollow noopener noreferrer">PostgreSQL里的子查询和CTE居然在性能上“掐架”？到底该站哪边？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F2eca89463454fd4250d7b66243b9fe5a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/2eca89463454fd4250d7b66243b9fe5a/" ref="nofollow noopener noreferrer">PostgreSQL选Join策略有啥小九九？Nested Loop/Merge/Hash谁是它的菜？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F068ecb772a87d7df20a8c9fb4b233f8e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/068ecb772a87d7df20a8c9fb4b233f8e/" ref="nofollow noopener noreferrer">PostgreSQL新手SQL总翻车？这7个性能陷阱你踩过没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd498f63cd0a2d5a77e445c688a8b88db%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d498f63cd0a2d5a77e445c688a8b88db/" ref="nofollow noopener noreferrer">PostgreSQL索引选B-Tree还是GiST？“瑞士军刀”和“多面手”的差别你居然还不知道？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F9101b75bdec6faea9b35d54f14e37f36%2F" target="_blank" title="https://blog.cmdragon.cn/posts/9101b75bdec6faea9b35d54f14e37f36/" ref="nofollow noopener noreferrer">想知道数据库怎么给查询“算成本选路线”？EXPLAIN能帮你看明白？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd527f8ebb6e3dae2c7dfe4c8d8979444%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d527f8ebb6e3dae2c7dfe4c8d8979444/" ref="nofollow noopener noreferrer">PostgreSQL处理SQL居然像做蛋糕？解析到执行的4步里藏着多少查询优化的小心机？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6bfdae84f313cf7ad0bb7045c4392347%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6bfdae84f313cf7ad0bb7045c4392347/" ref="nofollow noopener noreferrer">PostgreSQL备份不是复制文件？物理vs逻辑咋选？误删还能精准恢复到1分钟前？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fde3672803de34dbad244d0a8d48b0eb5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/de3672803de34dbad244d0a8d48b0eb5/" ref="nofollow noopener noreferrer">转账不翻车、并发不干扰，PostgreSQL的ACID特性到底有啥魔法？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe463e8a2668abdf00a228c9b79324ded%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e463e8a2668abdf00a228c9b79324ded/" ref="nofollow noopener noreferrer">银行转账不白扣钱、电商下单不超卖，PostgreSQL事务的诀窍是啥？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F5c967e595058c4a1fc4474a68e64031d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/5c967e595058c4a1fc4474a68e64031d/" ref="nofollow noopener noreferrer">PostgreSQL里的PL/pgSQL到底是啥？能让SQL从“说目标”变“讲步骤”？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F325047855e3e23b5ef82f7d2db134fbd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/325047855e3e23b5ef82f7d2db134fbd/" ref="nofollow noopener noreferrer">PostgreSQL视图不存数据？那它怎么简化查询还能递归生成序列和控制权限？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd2dba50bb6e4df7b27e735245a06a2a2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d2dba50bb6e4df7b27e735245a06a2a2/" ref="nofollow noopener noreferrer">PostgreSQL索引这么玩，才能让你的查询真的“飞”起来？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F849ae5bab0f8c66e94c2f6ad1bb798e3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/849ae5bab0f8c66e94c2f6ad1bb798e3/" ref="nofollow noopener noreferrer">PostgreSQL的表关系和约束，咋帮你搞定用户订单不混乱、学生选课不重复？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fef4800975ffa84f1ca51976a70a1585b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ef4800975ffa84f1ca51976a70a1585b/" ref="nofollow noopener noreferrer">PostgreSQL查询的筛子、排序、聚合、分组？你会用它们搞定数据吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbf54711525c507c5eacfa7b0151c39d2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bf54711525c507c5eacfa7b0151c39d2/" ref="nofollow noopener noreferrer">PostgreSQL数据类型怎么选才高效不踩坑？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F887809b3e0375f5956873cd442f516d8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/887809b3e0375f5956873cd442f516d8/" ref="nofollow noopener noreferrer">想解锁PostgreSQL查询从基础到进阶的核心知识点？你都get了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F934be1203725e8be9d6f6e9104e5abcc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/934be1203725e8be9d6f6e9104e5abcc/" ref="nofollow noopener noreferrer">PostgreSQL DELETE居然有这些操作？返回数据、连表删你试过没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0f0622e9b7402b599e618150d0596ffe%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0f0622e9b7402b599e618150d0596ffe/" ref="nofollow noopener noreferrer">PostgreSQL UPDATE语句怎么玩？从改邮箱到批量更新的避坑技巧你都会吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0e3bf7efc030b024ea67ee855a00f2de%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0e3bf7efc030b024ea67ee855a00f2de/" ref="nofollow noopener noreferrer">PostgreSQL插入数据还在逐条敲？批量、冲突处理、返回自增ID的技巧你会吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb6cd3c86da6aac26ed829e472d34078e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b6cd3c86da6aac26ed829e472d34078e/" ref="nofollow noopener noreferrer">PostgreSQL的“仓库-房间-货架”游戏，你能建出电商数据库和表吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fba1f545a3410144552fbdbfcf31b5265%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ba1f545a3410144552fbdbfcf31b5265/" ref="nofollow noopener noreferrer">PostgreSQL 17安装总翻车？Windows/macOS/Linux避坑指南帮你搞定？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb5474d1480509c5072085abc80b3dd9f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b5474d1480509c5072085abc80b3dd9f/" ref="nofollow noopener noreferrer">能当关系型数据库还能玩对象特性，能拆复杂查询还能自动管库存，PostgreSQL凭什么这么香？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fcc098d8836e787baa8a4d92e4d56d5c5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/cc098d8836e787baa8a4d92e4d56d5c5/" ref="nofollow noopener noreferrer">给接口加新字段又不搞崩老客户端？FastAPI的多版本API靠哪三招实现？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F46d05151c5bd31cf37a7bcf0b8f5b0b8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/46d05151c5bd31cf37a7bcf0b8f5b0b8/" ref="nofollow noopener noreferrer">流量突增要搞崩FastAPI？熔断测试是怎么防系统雪崩的？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F65ce343cc5df9faf3a8e2eeaab42ae45%2F" target="_blank" title="https://blog.cmdragon.cn/posts/65ce343cc5df9faf3a8e2eeaab42ae45/" ref="nofollow noopener noreferrer">FastAPI秒杀库存总变负数？Redis分布式锁能帮你守住底线吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Feed6cd8985d9be0a4b092a7da38b3e0c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/eed6cd8985d9be0a4b092a7da38b3e0c/" ref="nofollow noopener noreferrer">FastAPI的CI流水线怎么自动测端点，还能让Allure报告美到犯规？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6157d87338ce894d18c013c3c4777abb%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6157d87338ce894d18c013c3c4777abb/" ref="nofollow noopener noreferrer">如何用GitHub Actions为FastAPI项目打造自动化测试流水线？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Ffc4ef84559e04693a620d0714cb30787%2F" target="_blank" title="https://blog.cmdragon.cn/posts/fc4ef84559e04693a620d0714cb30787/" ref="nofollow noopener noreferrer">如何用Git Hook和CI流水线为FastAPI项目保驾护航？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F02b0c96842d1481c72dab63a149ce0dd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/02b0c96842d1481c72dab63a149ce0dd/" ref="nofollow noopener noreferrer">FastAPI如何用契约测试确保API的「菜单」与「菜品」一致？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc9c1e3bb0fdc15303b9b3b1f20124b0b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c9c1e3bb0fdc15303b9b3b1f20124b0b/" ref="nofollow noopener noreferrer">为什么TDD能让你的FastAPI开发飞起来？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fddbfa0447a5d0d6f9af12e7a6b206f70%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ddbfa0447a5d0d6f9af12e7a6b206f70/" ref="nofollow noopener noreferrer">如何用FastAPI玩转多模块测试与异步任务，让代码不再“闹脾气”？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbf9883a75ffa46b523a03b16ec56ce48%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bf9883a75ffa46b523a03b16ec56ce48/" ref="nofollow noopener noreferrer">如何在FastAPI中玩转“时光倒流”的数据库事务回滚测试？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbe553dbd5d51835d2c69553f4a773e2d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/be553dbd5d51835d2c69553f4a773e2d/" ref="nofollow noopener noreferrer">如何在FastAPI中优雅地模拟多模块集成测试？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F533874f5700b8506d4c68781597db659%2F" target="_blank" title="https://blog.cmdragon.cn/posts/533874f5700b8506d4c68781597db659/" ref="nofollow noopener noreferrer">多环境配置切换机制能否让开发与生产无缝衔接？ - cmdragon's Blog</a></li>
</ul>
</details>
<details>
<summary>免费好用的热门在线工具</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fraid-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/raid-calculator" ref="nofollow noopener noreferrer">RAID 计算器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fphotoshop-online" target="_blank" title="https://tools.cmdragon.cn/zh/apps/photoshop-online" ref="nofollow noopener noreferrer">在线PS - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmermaid-live-editor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/mermaid-live-editor" ref="nofollow noopener noreferrer">Mermaid 在线编辑器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmath-solver-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/math-solver-calculator" ref="nofollow noopener noreferrer">数学求解计算器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsmart-teleprompter" target="_blank" title="https://tools.cmdragon.cn/zh/apps/smart-teleprompter" ref="nofollow noopener noreferrer">智能提词器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmagic-resume" target="_blank" title="https://tools.cmdragon.cn/zh/apps/magic-resume" ref="nofollow noopener noreferrer">魔法简历 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-puzzle-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-puzzle-tool" ref="nofollow noopener noreferrer">Image Puzzle Tool - 图片拼图工具 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsubtitle-downloader" target="_blank" title="https://tools.cmdragon.cn/zh/apps/subtitle-downloader" ref="nofollow noopener noreferrer">字幕下载工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flyrics-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lyrics-generator" ref="nofollow noopener noreferrer">歌词生成工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcloud-drive-search" target="_blank" title="https://tools.cmdragon.cn/zh/apps/cloud-drive-search" ref="nofollow noopener noreferrer">网盘资源聚合搜索 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fascii-art-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ascii-art-generator" ref="nofollow noopener noreferrer">ASCII字符画生成器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fjwt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/jwt-tool" ref="nofollow noopener noreferrer">JSON Web Tokens 工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbcrypt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/bcrypt-tool" ref="nofollow noopener noreferrer">Bcrypt 密码工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-composer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-composer" ref="nofollow noopener noreferrer">GIF 合成器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-decomposer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-decomposer" ref="nofollow noopener noreferrer">GIF 分解器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-steganography" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-steganography" ref="nofollow noopener noreferrer">文本隐写术 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh" target="_blank" title="https://tools.cmdragon.cn/zh" ref="nofollow noopener noreferrer">CMDragon 在线工具 - 高级AI工具箱与开发者套件 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%3Fcategory%3Dtrending" target="_blank" title="https://tools.cmdragon.cn/zh/apps?category=trending" ref="nofollow noopener noreferrer">应用商店 - 发现1000+提升效率与开发的AI工具和实用程序 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fchangelog" target="_blank" title="https://tools.cmdragon.cn/zh/changelog" ref="nofollow noopener noreferrer">CMDragon 更新日志 - 最新更新、功能与改进 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fsponsor" target="_blank" title="https://tools.cmdragon.cn/zh/sponsor" ref="nofollow noopener noreferrer">支持我们 - 成为赞助者 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-image-ai" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-image-ai" ref="nofollow noopener noreferrer">AI文本生成图像 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftemp-email" target="_blank" title="https://tools.cmdragon.cn/zh/apps/temp-email" ref="nofollow noopener noreferrer">临时邮箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fqrcode-parser" target="_blank" title="https://tools.cmdragon.cn/zh/apps/qrcode-parser" ref="nofollow noopener noreferrer">二维码解析器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-mindmap" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-mindmap" ref="nofollow noopener noreferrer">文本转思维导图 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fregex-visualizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/regex-visualizer" ref="nofollow noopener noreferrer">正则表达式可视化工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsteganography-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/steganography-tool" ref="nofollow noopener noreferrer">文件隐写工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fiptv-explorer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/iptv-explorer" ref="nofollow noopener noreferrer">IPTV 频道探索器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsnapdrop" target="_blank" title="https://tools.cmdragon.cn/zh/apps/snapdrop" ref="nofollow noopener noreferrer">快传 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flucky-draw" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lucky-draw" ref="nofollow noopener noreferrer">随机抽奖工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fanime-scene-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/anime-scene-finder" ref="nofollow noopener noreferrer">动漫场景查找器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftime-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/time-toolkit" ref="nofollow noopener noreferrer">时间工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fspeed-test" target="_blank" title="https://tools.cmdragon.cn/zh/apps/speed-test" ref="nofollow noopener noreferrer">网速测试 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-remover" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-remover" ref="nofollow noopener noreferrer">AI 智能抠图工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-replacer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-replacer" ref="nofollow noopener noreferrer">背景替换工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fartistic-qrcode" target="_blank" title="https://tools.cmdragon.cn/zh/apps/artistic-qrcode" ref="nofollow noopener noreferrer">艺术二维码生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fopen-graph-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/open-graph-generator" ref="nofollow noopener noreferrer">Open Graph 元标签生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-comparison" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-comparison" ref="nofollow noopener noreferrer">图像对比工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-compressor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-compressor" ref="nofollow noopener noreferrer">图片压缩专业版 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fpassword-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/password-generator" ref="nofollow noopener noreferrer">密码生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsvg-optimizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/svg-optimizer" ref="nofollow noopener noreferrer">SVG优化器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcolor-palette" target="_blank" title="https://tools.cmdragon.cn/zh/apps/color-palette" ref="nofollow noopener noreferrer">调色板生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fonline-metronome" target="_blank" title="https://tools.cmdragon.cn/zh/apps/online-metronome" ref="nofollow noopener noreferrer">在线节拍器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IP归属地查询 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcss-grid-layout" target="_blank" title="https://tools.cmdragon.cn/zh/apps/css-grid-layout" ref="nofollow noopener noreferrer">CSS网格布局生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Femail-validator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/email-validator" ref="nofollow noopener noreferrer">邮箱验证工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcalligraphy-practice" target="_blank" title="https://tools.cmdragon.cn/zh/apps/calligraphy-practice" ref="nofollow noopener noreferrer">书法练习字帖 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffinance-calculator-suite" target="_blank" title="https://tools.cmdragon.cn/zh/apps/finance-calculator-suite" ref="nofollow noopener noreferrer">金融计算器套件 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fchinese-kinship-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/chinese-kinship-calculator" ref="nofollow noopener noreferrer">中国亲戚关系计算器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fprotobuf-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/protobuf-toolkit" ref="nofollow noopener noreferrer">Protocol Buffer 工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IP归属地查询 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-upscaler" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-upscaler" ref="nofollow noopener noreferrer">图片无损放大 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-compare" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-compare" ref="nofollow noopener noreferrer">文本比较工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-batch-lookup" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-batch-lookup" ref="nofollow noopener noreferrer">IP批量查询工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdomain-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/domain-finder" ref="nofollow noopener noreferrer">域名查询工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdns-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/dns-toolkit" ref="nofollow noopener noreferrer">DNS工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffavicon-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/favicon-generator" ref="nofollow noopener noreferrer">网站图标生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fsitemap_index.xml" target="_blank" title="https://tools.cmdragon.cn/sitemap_index.xml" ref="nofollow noopener noreferrer">XML Sitemap</a></li>
</ul>
</details>
Vue 3还提供了`watchEffect`，它和`watch`的核心差异在于**依赖跟踪的方式**，选择哪个取决于你的需求：
<h4 data-id="heading-8">3.1 核心差异对比</h4>






























<table><thead><tr><th>特性</th><th><code>watch</code></th><th><code>watchEffect</code></th></tr></thead><tbody><tr><td>依赖跟踪</td><td>手动指定监听源（显式）</td><td>自动跟踪回调中使用的所有源（隐式）</td></tr><tr><td>初始执行</td><td>默认不执行（需<code>immediate</code>）</td><td>挂载时立即执行一次</td></tr><tr><td>旧值获取</td><td>支持（回调参数有<code>oldValue</code>）</td><td>不支持（只关注当前值）</td></tr><tr><td>适用场景</td><td>需要明确控制监听源、需要旧值</td><td>只需响应依赖变化、无需旧值</td></tr></tbody></table>
<h4 data-id="heading-9">3.2 代码示例对比</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref, watch, watchEffect } from 'vue'

const count = ref(0)
const message = ref('Hello')

// 使用watch：显式监听count
watch(count, (newVal, oldVal) =&gt; {
  console.log(`count从 ${oldVal} 变到 ${newVal}`)
})

// 使用watchEffect：自动跟踪count和message
watchEffect(() =&gt; {
  console.log(`当前count：${count.value}，message：${message.value}`)
})
&lt;/script&gt;
</code></pre>
<p><strong>执行结果</strong>：</p>
<ul>
<li>页面加载时，<code>watchEffect</code>立即执行，输出<code>当前count：0，message：Hello</code>；</li>
<li>点击按钮修改<code>count</code>，<code>watch</code>和<code>watchEffect</code>都会触发；</li>
<li>修改<code>message</code>，只有<code>watchEffect</code>触发（因为它自动跟踪了<code>message</code>）。</li>
</ul>
<h3 data-id="heading-10">4. 实践中的应用场景</h3>
<p>侦听器的价值在于<strong>将“数据变化”与“副作用”解耦</strong>，以下是几个常见的实际场景：</p>
<h4 data-id="heading-11">4.1 数据变化时发起网络请求</h4>
<p>比如用户选择城市后，自动加载该城市的天气：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref, watch } from 'vue'

const city = ref('北京')
const weather = ref('')

// 监听city变化，加载天气
watch(city, async (newCity) =&gt; {
  const res = await fetch(`https://api.example.com/weather?city=${newCity}`)
  const data = await res.json()
  weather.value = data.weather
})
&lt;/script&gt;

&lt;template&gt;
  &lt;select v-model="city"&gt;
    &lt;option value="北京"&gt;北京&lt;/option&gt;
    &lt;option value="上海"&gt;上海&lt;/option&gt;
    &lt;option value="广州"&gt;广州&lt;/option&gt;
  &lt;/select&gt;
  &lt;p&gt;当前天气：{{ weather }}&lt;/p&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-12">4.2 表单输入的实时验证</h4>
<p>比如注册页的密码强度校验：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref, watch } from 'vue'

const password = ref('')
const passwordError = ref('')

// 实时验证密码强度
watch(password, (newPwd) =&gt; {
  if (newPwd.length &lt; 6) {
    passwordError.value = '密码必须至少6位'
  } else if (!/[A-Z]/.test(newPwd)) {
    passwordError.value = '密码必须包含大写字母'
  } else {
    passwordError.value = ''
  }
})
&lt;/script&gt;

&lt;template&gt;
  &lt;input type="password" v-model="password" placeholder="输入密码" /&gt;
  &lt;p class="error" v-if="passwordError"&gt;{{ passwordError }}&lt;/p&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-13">5. 课后Quiz</h3>
<p>通过以下问题巩固所学知识（答案基于Vue官网文档）：</p>
<h4 data-id="heading-14">问题1：如何监听reactive对象中的嵌套属性（如<code>state.user.address.city</code>）？请写出代码示例。</h4>
<p><strong>答案</strong>：使用getter函数返回嵌套属性（显式指定监听源）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">user</span>: {
    <span class="hljs-attr">address</span>: {
      <span class="hljs-attr">city</span>: <span class="hljs-string">'Beijing'</span>
    }
  }
})

<span class="hljs-comment">// 正确写法：用getter返回嵌套属性</span>
<span class="hljs-title function_">watch</span>(
  <span class="hljs-function">() =&gt;</span> state.<span class="hljs-property">user</span>.<span class="hljs-property">address</span>.<span class="hljs-property">city</span>,
  <span class="hljs-function">(<span class="hljs-params">newCity, oldCity</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`城市从 <span class="hljs-subst">${oldCity}</span> 改为 <span class="hljs-subst">${newCity}</span>`</span>)
  }
)
</code></pre>
<p><strong>错误写法</strong>：直接写<code>state.user.address.city</code>（会丢失响应式跟踪）。</p>
<h4 data-id="heading-15">问题2：<code>watch</code>和<code>watchEffect</code>的核心区别是什么？请列举两点。</h4>
<p><strong>答案</strong>：</p>
<ol>
<li><strong>依赖跟踪方式</strong>：<code>watch</code>需要手动指定监听源（显式），<code>watchEffect</code>自动跟踪回调中使用的所有源（隐式）；</li>
<li><strong>初始执行时机</strong>：<code>watch</code>默认不执行（需<code>immediate</code>选项），<code>watchEffect</code>挂载时立即执行一次。</li>
</ol>
<h3 data-id="heading-16">6. 常见报错与解决方案</h3>
<h4 data-id="heading-17">报错1：监听reactive对象时，旧值与新值相同</h4>
<p><strong>现象</strong>：修改<code>reactive</code>对象的属性后，<code>watch</code>回调中的<code>oldValue</code>和<code>newValue</code>完全一样。<br/>
<strong>原因</strong>：<code>reactive</code>返回的是<strong>代理对象</strong>，修改属性不会改变对象的引用，因此<code>oldValue</code>和<code>newValue</code>指向同一个对象。<br/>
<strong>解决方法</strong>：</p>
<ul>
<li>若需监听单个属性，用<code>getter</code>函数返回属性（如<code>() =&gt; state.count</code>），此时<code>oldValue</code>会是原始值；</li>
<li>若需监听整个对象，手动保存旧值（适用于简单场景）：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> })
<span class="hljs-keyword">let</span> oldCount = state.<span class="hljs-property">count</span> <span class="hljs-comment">// 手动保存旧值</span>

<span class="hljs-title function_">watch</span>(
  <span class="hljs-function">() =&gt;</span> state.<span class="hljs-property">count</span>,
  <span class="hljs-function">(<span class="hljs-params">newCount</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`旧值：<span class="hljs-subst">${oldCount}</span>，新值：<span class="hljs-subst">${newCount}</span>`</span>)
    oldCount = newCount <span class="hljs-comment">// 更新旧值</span>
  }
)
</code></pre>
</li>
</ul>
<h4 data-id="heading-18">报错2：深度监听不生效</h4>
<p><strong>现象</strong>：修改<code>reactive</code>对象的嵌套属性，<code>watch</code>回调不触发。<br/>
<strong>原因</strong>：未开启<code>deep: true</code>选项，<code>watch</code>默认只跟踪对象的<strong>引用变化</strong>，不跟踪嵌套属性。<br/>
<strong>解决方法</strong>：在<code>watch</code>的选项中添加<code>deep: true</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">watch</span>(
  <span class="hljs-function">() =&gt;</span> state.<span class="hljs-property">user</span>,
  <span class="hljs-function">(<span class="hljs-params">newUser, oldUser</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'用户信息更新：'</span>, newUser)
  },
  { <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span> } <span class="hljs-comment">// 必须加！</span>
)
</code></pre>
<h4 data-id="heading-19">报错3：<code>immediate: true</code>时旧值为<code>undefined</code></h4>
<p><strong>现象</strong>：开启<code>immediate</code>后，第一次执行回调时<code>oldValue</code>是<code>undefined</code>。<br/>
<strong>原因</strong>：<code>immediate</code>让回调在<strong>挂载时立即执行</strong>，此时还没有“旧值”（第一次执行）。<br/>
<strong>解决方法</strong>：</p>
<ul>
<li>若不需要旧值，忽略即可；</li>
<li>若需要初始值，手动处理（比如用<code>ref</code>保存初始值）：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> keyword = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'Vue'</span>)
<span class="hljs-keyword">const</span> initialKeyword = keyword.<span class="hljs-property">value</span> <span class="hljs-comment">// 保存初始值</span>

<span class="hljs-title function_">watch</span>(
  keyword,
  <span class="hljs-function">(<span class="hljs-params">newKeyword, oldKeyword</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (oldKeyword === <span class="hljs-literal">undefined</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`初始关键词：<span class="hljs-subst">${initialKeyword}</span>`</span>)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`关键词从 <span class="hljs-subst">${oldKeyword}</span> 改为 <span class="hljs-subst">${newKeyword}</span>`</span>)
    }
  },
  { <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span> }
)
</code></pre>
</li>
</ul>
<h3 data-id="heading-20">参考链接</h3>
<ul>
<li>Vue官网：侦听器基础 → <a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fessentials%2Fwatchers.html" target="_blank" title="https://vuejs.org/guide/essentials/watchers.html" ref="nofollow noopener noreferrer">vuejs.org/guide/essen…</a></li>
<li>Vue官网：<code>watch</code> vs <code>watchEffect</code> → <a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fessentials%2Fwatchers.html%23watcheffect" target="_blank" title="https://vuejs.org/guide/essentials/watchers.html#watcheffect" ref="nofollow noopener noreferrer">vuejs.org/guide/essen…</a></li>
<li>Vue官网：侦听器选项 → <a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fessentials%2Fwatchers.html%23watcher-options" target="_blank" title="https://vuejs.org/guide/essentials/watchers.html#watcher-options" ref="nofollow noopener noreferrer">vuejs.org/guide/essen…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Xcode 常用使用技巧说明，总有一个帮助你]]></title>    <link>https://juejin.cn/post/7570491473033969673</link>    <guid>https://juejin.cn/post/7570491473033969673</guid>    <pubDate>2025-11-10T04:57:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570491473033969673" data-draft-id="7570491473033953289" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Xcode 常用使用技巧说明，总有一个帮助你"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-10T04:57:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="1024小神"/> <meta itemprop="url" content="https://juejin.cn/user/70007368988926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Xcode 常用使用技巧说明，总有一个帮助你
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/70007368988926/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    1024小神
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T04:57:36.000Z" title="Mon Nov 10 2025 04:57:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我的开源项目PakePlus可以将网页/Vue/React项目打包为桌面/手机应用并且小于5M只需几分钟，官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpakeplus.com" target="_blank" title="https://pakeplus.com" ref="nofollow noopener noreferrer">pakeplus.com</a></p><p><img alt="" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eebb6e6a31cf41929a15ad1293866a12~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" width="1200" loading="lazy"/></p><p/>
<h3 id="user-content-1-command--click-跳源码option--click-显示帮助" data-id="heading-0">1. <code>Command + Click</code> 跳源码</h3>
<p>可以单独在setting里面设置：</p>
<p class="img-center"><img alt="" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7ba47293ecca45c484031a54ff757a58~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" width="1200" loading="lazy"/></p>
<p><code>Option + Click</code> 显示帮助：</p>
<p><img alt="" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/16fceb3fb0864c4584a0e70a5f33967e~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" width="1200" loading="lazy"/></p>
<p>Control + Click 可以查看这个方法调用者在哪里： </p>
<p><img alt="" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fcc8b08a019d4982bb1f4bb6cb244bd6~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" width="1200" loading="lazy"/></p>
<h3 id="user-content-2-command--enter-显示代码提示" data-id="heading-1">2. <code>Command + Enter</code> 显示代码提示</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 搜索框搜索该快捷方式，替换并按下快捷键 `Command + Enter"，如果有快捷键冲突，需要解决冲突</span>
Show Code Actions
</code></pre>
<p class="img-center"><img alt="" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e49c6aa1f82c4297b9d930b35e17f2dc~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" width="1200" loading="lazy"/></p>
<h3 id="user-content-3-shift--backspace-删除当前行" data-id="heading-2">3. <code>shift + BackSpace</code> 删除当前行</h3>
<pre><code class="hljs language-scss" lang="scss">Delete Line
</code></pre>
<h3 id="user-content-4-shift--enter-换行" data-id="heading-3">4. <code>shift + Enter</code> 换行</h3>
<p>编辑文件，添加下面几行，用于添加快捷指令</p>
<pre><code class="hljs language-css" lang="css">sudo vim /Applications/Xcode<span class="hljs-selector-class">.app</span>/Contents/Frameworks/IDEKit<span class="hljs-selector-class">.framework</span>/Versions/<span class="hljs-selector-tag">A</span>/Resources/IDETextKeyBindingSet<span class="hljs-selector-class">.plist</span>
</code></pre>
<p>新增内容</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">plist</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//Apple//DTD PLIST 1.0//EN"</span> <span class="hljs-string">"http://www.apple.com/DTDs/PropertyList-1.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">plist</span> <span class="hljs-attr">version</span>=<span class="hljs-string">"1.0"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dict</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 开始 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>My Custom<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dict</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>insert new line below<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>moveToEndOfLine:, insertNewline:<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dict</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 结束 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>Cancellation<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dict</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>Cancel<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>cancelOperation:<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dict</span>&gt;</span>
</code></pre>
<p>重新打开 xcode，新增下面的快捷键</p>
<pre><code class="hljs language-arduino" lang="arduino">insert <span class="hljs-keyword">new</span> line below
</code></pre>
<h3 id="user-content-5-option--command--p-刷新-preview" data-id="heading-4">5. <code>option + command + p</code> 刷新 preview</h3>
<h3 id="user-content-6-option--command--l-代码格式化" data-id="heading-5">6. 代码格式化</h3>
<p>安装 SwiftFormat for Xcode 插件，具体教程：<a data-link-desc="文章浏览阅读564次，点赞13次，收藏8次。安装后在Xcode的Editor菜单找不到SwfitFormat选项，可以尝试打开SwfitFormat for Xcode软件，然后再在设置里安全与隐私选中Xcode的这个插件，然后重启Xcode尝试，我就是因为安装SwfitFormat for Xcode后没有打开过，直接在安全与隐私里面找不到Xcode的选项，所以就没有生效，记得这一步一定要做！打开设置 &gt; 隐私与安全性 &gt; 选择Xcode Sourde Editor &gt;" data-link-icon="https://g.csdnimg.cn/static/logo/favicon32.ico" data-link-title="Xcode代码格式化SwiftFormat安装使用，以及不生效问题-CSDN博客" href="https://link.juejin.cn?target=https%3A%2F%2Fxiaoshen.blog.csdn.net%2Farticle%2Fdetails%2F138999042" title="https://xiaoshen.blog.csdn.net/article/details/138999042" target="_blank" ref="nofollow noopener noreferrer">Xcode代码格式化SwiftFormat安装使用，以及不生效问题-CSDN博客</a></p>
<pre><code class="hljs language-arduino" lang="arduino">Format <span class="hljs-built_in">File</span>
</code></pre>
<h3 id="user-content-7-重构下的重命名-shift--f6" data-id="heading-6">7. 重构下的重命名 <code>shift + F6</code></h3>
<pre><code class="hljs">Rename
</code></pre>
<h3 id="user-content-8-多选-ctrl--g" data-id="heading-7">8. 多选 <code>Ctrl + G</code></h3>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">Select</span> <span class="hljs-keyword">Next</span> Occurence
</code></pre>
<h3 id="user-content-9-查找文件-command--shift--o" data-id="heading-8">9. 查找文件 <code>Command + shift + O</code></h3>
<h3 id="user-content-10-打开库-command-shift--l" data-id="heading-9">10. 打开库 <code>Command +shift + L</code></h3>
<h3 id="user-content-11-创建-snippets" data-id="heading-10">11. 创建 snippets</h3>
<p>在编辑器中写下如下代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> &lt;#variable#&gt; = &lt;#<span class="hljs-keyword">val</span>#&gt;
</code></pre>
<p>鼠标选中该段代码，右键保存为 snippets：</p>
<p class="img-center"><img alt="" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b58d84d569194461a80d5c31a09a303b~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" width="1200" loading="lazy"/></p>
<h3 data-id="heading-11"/>
<h3 id="user-content-12-编辑器代码可折叠" data-id="heading-12">12. 编辑器代码可折叠</h3>
<p>下面的code structure when scrolling也是控制折叠的</p>
<p class="img-center"><img alt="" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b5a679837bfb43589f65d402d9e4e157~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" width="1200" loading="lazy"/></p>
<h3 data-id="heading-13"/>
<h3 id="user-content-13-关闭构建成功提示" data-id="heading-14">13. 关闭构建成功提示</h3>
<p class="img-center"><img alt="" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8083bae0a3ff498e90d539b93e14ced9~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" width="1200" loading="lazy"/></p>
大家好，我是1024小神，技术群 / 私活群 / 股票群 或 交朋友 都可以私信我。
如果你觉得本文有用，一键三连 (点赞、评论、关注)，就是对我最大的支持~</div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Service Worker 深度解析：让你的 Web 应用离线也能飞]]></title>    <link>https://juejin.cn/post/7570191839594692671</link>    <guid>https://juejin.cn/post/7570191839594692671</guid>    <pubDate>2025-11-10T03:58:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570191839594692671" data-draft-id="7570008954044317730" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Service Worker 深度解析：让你的 Web 应用离线也能飞"/> <meta itemprop="keywords" content="前端,JavaScript,性能优化"/> <meta itemprop="datePublished" content="2025-11-10T03:58:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端嘿起"/> <meta itemprop="url" content="https://juejin.cn/user/2076315267907197"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Service Worker 深度解析：让你的 Web 应用离线也能飞
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2076315267907197/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端嘿起
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T03:58:56.000Z" title="Mon Nov 10 2025 03:58:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代 Web 开发中，用户体验已经成为了衡量一个应用成功与否的重要标准。用户不仅希望网站加载速度快，还希望即使在网络不稳定或完全断网的情况下也能正常使用应用。这就引出了我们今天的主角——Service Worker。</p>
<h2 data-id="heading-0">前言</h2>
<p>Service Worker 是一种在浏览器后台运行的脚本，它独立于网页主线程，可以拦截网络请求、缓存资源，甚至在离线状态下也能提供完整的用户体验。它是实现 PWA（渐进式 Web 应用）的核心技术之一，为 Web 应用带来了原生应用般的离线能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e55818b63a042d4af75d0c5cf2a0039~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Zi_6LW3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351936&amp;x-signature=TEDI1CLw6QyGTc2YQSlG2RG%2BIJg%3D" alt="" loading="lazy"/></p>
<p>在本文中，我们将从基础概念开始，逐步深入探讨 Service Worker 的工作机制、生命周期、实际应用以及最佳实践。无论你是刚刚接触前端开发的新手，还是希望深入了解 Service Worker 的资深开发者，相信这篇文章都能为你带来有价值的参考。</p>
<h2 data-id="heading-1">什么是 Service Worker？</h2>
<p>Service Worker 是一种特殊的 JavaScript 脚本，它运行在浏览器后台，独立于网页主线程。它就像是浏览器和网络之间的一个代理，可以拦截网络请求、缓存资源，甚至在没有网络连接的情况下也能提供完整的用户体验。</p>
<h3 data-id="heading-2">Service Worker 的核心特性</h3>
<ol>
<li><strong>独立运行</strong>：Service Worker 运行在独立的线程中，不阻塞主线程</li>
<li><strong>网络代理</strong>：可以拦截网络请求并自定义响应</li>
<li><strong>离线支持</strong>：通过缓存机制实现离线访问</li>
<li><strong>后台同步</strong>：支持后台数据同步功能</li>
<li><strong>推送通知</strong>：可以接收和处理推送通知</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b973ebc1629045b69268d36ff037ea4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Zi_6LW3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351936&amp;x-signature=1dIk0%2FKLsOYa69MDO5TQtKYMAQM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">Service Worker 与其他技术的对比</h3>
<p>与传统的浏览器缓存机制相比，Service Worker 提供了更强大和灵活的缓存控制能力。传统的浏览器缓存依赖于 HTTP 头部设置，而 Service Worker 允许开发者完全控制缓存策略。</p>
<p>与 AppCache 相比，Service Worker 解决了 AppCache 的许多问题，如缓存更新困难、无法自定义缓存策略等。AppCache 已经被标记为废弃，Service Worker 是其推荐的替代方案。</p>
<h2 data-id="heading-4">Service Worker 的生命周期</h2>
<p>理解 Service Worker 的生命周期对于正确使用它至关重要。Service Worker 的生命周期包括注册、安装、激活和更新等阶段。</p>
<h3 data-id="heading-5">注册 Service Worker</h3>
<p>要使用 Service Worker，首先需要在主页面中注册它：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (<span class="hljs-string">'serviceWorker'</span> <span class="hljs-keyword">in</span> navigator) {
  navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">'/sw.js'</span>)
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">registration</span> =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Service Worker 注册成功:'</span>, registration);
    })
    .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Service Worker 注册失败:'</span>, error);
    });
}
</code></pre>
<p>注册时可以指定作用域，限制 Service Worker 控制的页面范围：</p>
<pre><code class="hljs language-javascript" lang="javascript">navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">'/sw.js'</span>, {
  <span class="hljs-attr">scope</span>: <span class="hljs-string">'/app/'</span>
}).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">registration</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Service Worker 作用域:'</span>, registration.<span class="hljs-property">scope</span>);
});
</code></pre>
<h3 data-id="heading-6">安装阶段</h3>
<p>当 Service Worker 文件首次下载后，会触发安装事件。在这个阶段，我们通常会缓存应用的核心资源：</p>
<pre><code class="hljs language-javascript" lang="javascript">self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'install'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Service Worker 安装中...'</span>);
  
  event.<span class="hljs-title function_">waitUntil</span>(
    caches.<span class="hljs-title function_">open</span>(<span class="hljs-string">'my-app-v1'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> {
      <span class="hljs-keyword">return</span> cache.<span class="hljs-title function_">addAll</span>([
        <span class="hljs-string">'/'</span>,
        <span class="hljs-string">'/index.html'</span>,
        <span class="hljs-string">'/styles/main.css'</span>,
        <span class="hljs-string">'/scripts/main.js'</span>,
        <span class="hljs-string">'/images/logo.png'</span>
      ]);
    })
  );
});
</code></pre>
<p>在安装阶段，需要注意以下几点：</p>
<ol>
<li>只能缓存同源资源或已配置 CORS 的跨域资源</li>
<li>缓存操作是原子性的，如果任何一个资源缓存失败，整个操作都会失败</li>
<li>可以使用 <code>skipWaiting()</code> 方法强制跳过等待状态</li>
</ol>
<h3 data-id="heading-7">激活阶段</h3>
<p>安装完成后，Service Worker 会进入激活阶段。在这个阶段，我们可以清理旧版本的缓存：</p>
<pre><code class="hljs language-javascript" lang="javascript">self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'activate'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Service Worker 激活中...'</span>);
  
  event.<span class="hljs-title function_">waitUntil</span>(
    caches.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cacheNames</span> =&gt;</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
        cacheNames.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> {
          <span class="hljs-comment">// 返回需要删除的缓存名称</span>
          <span class="hljs-keyword">return</span> name !== <span class="hljs-string">'my-app-v1'</span>;
        }).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> {
          <span class="hljs-comment">// 删除旧缓存</span>
          <span class="hljs-keyword">return</span> caches.<span class="hljs-title function_">delete</span>(name);
        })
      );
    })
  );
});
</code></pre>
<p>激活阶段的最佳实践：</p>
<ol>
<li>清理不再需要的旧缓存</li>
<li>避免在激活阶段执行耗时操作</li>
<li>可以使用 <code>clients.claim()</code> 方法控制未受控制的客户端</li>
</ol>
<h3 data-id="heading-8">更新机制</h3>
<p>当 Service Worker 文件发生变化时，浏览器会下载新版本并触发更新流程：</p>
<pre><code class="hljs language-javascript" lang="javascript">self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'install'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'新版本安装中...'</span>);
  <span class="hljs-comment">// 强制跳过等待状态，立即激活新版本</span>
  self.<span class="hljs-title function_">skipWaiting</span>();
});

self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'activate'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'新版本激活中...'</span>);
  <span class="hljs-comment">// 立即控制所有客户端</span>
  event.<span class="hljs-title function_">waitUntil</span>(self.<span class="hljs-property">clients</span>.<span class="hljs-title function_">claim</span>());
});
</code></pre>
<p>为了更直观地理解 Service Worker 的生命周期和请求处理流程，我们可以参考以下图表：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f98863e02ea4d2f9adaf43c55ce5a1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Zi_6LW3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351936&amp;x-signature=ocLy01IwdSfUbAtHeaszV8PEcBg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">Service Worker API 详解</h2>
<h3 data-id="heading-10">Cache API</h3>
<p>Cache API 是 Service Worker 的核心组件之一，用于存储和检索网络请求：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 打开缓存</span>
caches.<span class="hljs-title function_">open</span>(<span class="hljs-string">'my-cache'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> {
  <span class="hljs-comment">// 添加单个资源到缓存</span>
  cache.<span class="hljs-title function_">put</span>(request, response);
  
  <span class="hljs-comment">// 添加多个资源到缓存</span>
  cache.<span class="hljs-title function_">addAll</span>([request1, request2]);
  
  <span class="hljs-comment">// 匹配缓存中的资源</span>
  cache.<span class="hljs-title function_">match</span>(request).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
    <span class="hljs-comment">// 处理响应</span>
  });
  
  <span class="hljs-comment">// 删除缓存中的资源</span>
  cache.<span class="hljs-title function_">delete</span>(request);
});
</code></pre>
<h3 data-id="heading-11">Fetch API</h3>
<p>Fetch API 允许 Service Worker 拦截和处理网络请求：</p>
<pre><code class="hljs language-javascript" lang="javascript">self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> request = event.<span class="hljs-property">request</span>;
  
  <span class="hljs-comment">// 克隆请求以避免消费原始请求</span>
  <span class="hljs-keyword">const</span> clonedRequest = request.<span class="hljs-title function_">clone</span>();
  
  <span class="hljs-comment">// 自定义请求处理逻辑</span>
  event.<span class="hljs-title function_">respondWith</span>(
    caches.<span class="hljs-title function_">match</span>(request).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cachedResponse</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (cachedResponse) {
        <span class="hljs-keyword">return</span> cachedResponse;
      }
      
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(clonedRequest).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
        <span class="hljs-comment">// 处理网络响应</span>
        <span class="hljs-keyword">return</span> response;
      });
    })
  );
});
</code></pre>
<h3 data-id="heading-12">Background Sync API</h3>
<p>Background Sync API 允许在连接恢复时同步数据：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 注册后台同步</span>
navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-property">ready</span>.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">registration</span> =&gt;</span> {
  registration.<span class="hljs-property">sync</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">'sync-data'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'后台同步已注册'</span>);
  });
});

<span class="hljs-comment">// 处理同步事件</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'sync'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">tag</span> === <span class="hljs-string">'sync-data'</span>) {
    event.<span class="hljs-title function_">waitUntil</span>(<span class="hljs-title function_">syncData</span>());
  }
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">syncData</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 执行数据同步逻辑</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/sync'</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-title function_">getPendingData</span>())
  });
}
</code></pre>
<h3 data-id="heading-13">Push API</h3>
<p>Push API 允许接收服务器推送的通知：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 请求推送权限</span>
<span class="hljs-title class_">Notification</span>.<span class="hljs-title function_">requestPermission</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">permission</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (permission === <span class="hljs-string">'granted'</span>) {
    <span class="hljs-comment">// 订阅推送服务</span>
    navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-property">ready</span>.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">registration</span> =&gt;</span> {
      registration.<span class="hljs-property">pushManager</span>.<span class="hljs-title function_">subscribe</span>({
        <span class="hljs-attr">userVisibleOnly</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">applicationServerKey</span>: <span class="hljs-title function_">urlBase64ToUint8Array</span>(<span class="hljs-string">'your-public-key'</span>)
      }).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">subscription</span> =&gt;</span> {
        <span class="hljs-comment">// 发送订阅信息到服务器</span>
        <span class="hljs-title function_">sendSubscriptionToServer</span>(subscription);
      });
    });
  }
});

<span class="hljs-comment">// 处理推送消息</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'push'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> data = event.<span class="hljs-property">data</span>.<span class="hljs-title function_">json</span>();
  
  event.<span class="hljs-title function_">waitUntil</span>(
    self.<span class="hljs-property">registration</span>.<span class="hljs-title function_">showNotification</span>(data.<span class="hljs-property">title</span>, {
      <span class="hljs-attr">body</span>: data.<span class="hljs-property">body</span>,
      <span class="hljs-attr">icon</span>: data.<span class="hljs-property">icon</span>,
      <span class="hljs-attr">tag</span>: data.<span class="hljs-property">tag</span>
    })
  );
});
</code></pre>
<h2 data-id="heading-14">实际应用场景</h2>
<h3 data-id="heading-15">离线页面</h3>
<p>通过 Service Worker，我们可以为用户提供离线时的友好提示页面：</p>
<pre><code class="hljs language-javascript" lang="javascript">self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  event.<span class="hljs-title function_">respondWith</span>(
    <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>).<span class="hljs-keyword">catch</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 如果网络请求失败，返回离线页面</span>
      <span class="hljs-keyword">if</span> (event.<span class="hljs-property">request</span>.<span class="hljs-property">mode</span> === <span class="hljs-string">'navigate'</span>) {
        <span class="hljs-keyword">return</span> caches.<span class="hljs-title function_">match</span>(<span class="hljs-string">'/offline.html'</span>);
      }
      
      <span class="hljs-comment">// 对于其他资源，返回相应的占位符</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(...);
    })
  );
});
</code></pre>
<h3 data-id="heading-16">缓存策略</h3>
<p>不同的资源可能需要不同的缓存策略：</p>
<ol>
<li><strong>Cache First</strong>：优先使用缓存，适合静态资源</li>
<li><strong>Network First</strong>：优先使用网络，适合需要实时更新的内容</li>
<li><strong>Stale While Revalidate</strong>：使用缓存的同时在后台更新</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Cache First 策略</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  event.<span class="hljs-title function_">respondWith</span>(
    caches.<span class="hljs-title function_">match</span>(event.<span class="hljs-property">request</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
      <span class="hljs-keyword">return</span> response || <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>);
    })
  );
});

<span class="hljs-comment">// Network First 策略</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  event.<span class="hljs-title function_">respondWith</span>(
    <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>).<span class="hljs-keyword">catch</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">return</span> caches.<span class="hljs-title function_">match</span>(event.<span class="hljs-property">request</span>);
    })
  );
});

<span class="hljs-comment">// Stale While Revalidate 策略</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  event.<span class="hljs-title function_">respondWith</span>(
    caches.<span class="hljs-title function_">open</span>(<span class="hljs-string">'my-cache'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> {
      <span class="hljs-keyword">return</span> cache.<span class="hljs-title function_">match</span>(event.<span class="hljs-property">request</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> fetchPromise = <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">networkResponse</span> =&gt;</span> {
          cache.<span class="hljs-title function_">put</span>(event.<span class="hljs-property">request</span>, networkResponse.<span class="hljs-title function_">clone</span>());
          <span class="hljs-keyword">return</span> networkResponse;
        });
        
        <span class="hljs-keyword">return</span> response || fetchPromise;
      });
    })
  );
});
</code></pre>
<h3 data-id="heading-17">动态缓存</h3>
<p>对于动态内容，我们可以实现智能缓存策略：</p>
<pre><code class="hljs language-javascript" lang="javascript">self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> request = event.<span class="hljs-property">request</span>;
  
  <span class="hljs-comment">// 对于 API 请求，使用 Network First 策略</span>
  <span class="hljs-keyword">if</span> (request.<span class="hljs-property">url</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/api/'</span>)) {
    event.<span class="hljs-title function_">respondWith</span>(
      <span class="hljs-title function_">fetch</span>(request).<span class="hljs-keyword">catch</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">return</span> caches.<span class="hljs-title function_">match</span>(request);
      })
    );
    <span class="hljs-keyword">return</span>;
  }
  
  <span class="hljs-comment">// 对于静态资源，使用 Cache First 策略</span>
  event.<span class="hljs-title function_">respondWith</span>(
    caches.<span class="hljs-title function_">match</span>(request).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
      <span class="hljs-keyword">return</span> response || <span class="hljs-title function_">fetch</span>(request);
    })
  );
});
</code></pre>
<h2 data-id="heading-18">最佳实践</h2>
<h3 data-id="heading-19">版本管理</h3>
<p>合理的版本管理可以避免缓存问题：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_NAME</span> = <span class="hljs-string">'my-app-v1.0.0'</span>;
<span class="hljs-keyword">const</span> urlsToCache = [
  <span class="hljs-string">'/'</span>,
  <span class="hljs-string">'/styles/main.css'</span>,
  <span class="hljs-string">'/scripts/main.js'</span>
];

self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'install'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  event.<span class="hljs-title function_">waitUntil</span>(
    caches.<span class="hljs-title function_">open</span>(<span class="hljs-variable constant_">CACHE_NAME</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> cache.<span class="hljs-title function_">addAll</span>(urlsToCache))
  );
});
</code></pre>
<h3 data-id="heading-20">错误处理</h3>
<p>完善的错误处理机制可以提升用户体验：</p>
<pre><code class="hljs language-javascript" lang="javascript">self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  event.<span class="hljs-title function_">respondWith</span>(
    <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
        <span class="hljs-comment">// 检查响应是否有效</span>
        <span class="hljs-keyword">if</span> (!response || response.<span class="hljs-property">status</span> !== <span class="hljs-number">200</span> || !response.<span class="hljs-property">ok</span>) {
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Invalid response'</span>);
        }
        <span class="hljs-keyword">return</span> response;
      })
      .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
        <span class="hljs-comment">// 返回缓存的响应或错误页面</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Fetch failed:'</span>, error);
        <span class="hljs-keyword">return</span> caches.<span class="hljs-title function_">match</span>(event.<span class="hljs-property">request</span>) || caches.<span class="hljs-title function_">match</span>(<span class="hljs-string">'/error.html'</span>);
      })
  );
});
</code></pre>
<h3 data-id="heading-21">性能优化</h3>
<ol>
<li>预缓存关键资源</li>
<li>合理设置缓存过期时间</li>
<li>及时清理无用缓存</li>
<li>避免缓存过多数据</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 限制缓存大小</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">limitCacheSize</span>(<span class="hljs-params">cacheName, maxItems</span>) {
  caches.<span class="hljs-title function_">open</span>(cacheName).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> {
    cache.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">keys</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (keys.<span class="hljs-property">length</span> &gt; maxItems) {
        cache.<span class="hljs-title function_">delete</span>(keys[<span class="hljs-number">0</span>]).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-title function_">limitCacheSize</span>(cacheName, maxItems);
        });
      }
    });
  });
}
</code></pre>
<h3 data-id="heading-22">安全考虑</h3>
<ol>
<li>Service Worker 只能在 HTTPS 环境下运行</li>
<li>避免缓存敏感数据</li>
<li>验证所有网络响应</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 验证响应安全性</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isResponseSafe</span>(<span class="hljs-params">response</span>) {
  <span class="hljs-comment">// 检查内容类型</span>
  <span class="hljs-keyword">const</span> contentType = response.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'content-type'</span>);
  <span class="hljs-keyword">if</span> (!contentType || !contentType.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'application/json'</span>)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  
  <span class="hljs-comment">// 检查响应来源</span>
  <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">url</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'https://'</span>)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<h2 data-id="heading-23">调试技巧</h2>
<p>调试 Service Worker 可能会有些困难，但掌握一些技巧可以让工作变得轻松：</p>
<ol>
<li>使用 Chrome DevTools 的 Application 面板</li>
<li>查看 Service Worker 的状态和日志</li>
<li>使用 <code>skipWaiting()</code> 强制激活新的 Service Worker</li>
<li>清除缓存和 Service Worker 数据进行测试</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在开发环境中强制更新 Service Worker</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">'serviceWorker'</span> <span class="hljs-keyword">in</span> navigator) {
  navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">getRegistrations</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">registrations</span> =&gt;</span> {
    registrations.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">registration</span> =&gt;</span> {
      registration.<span class="hljs-title function_">unregister</span>();
    });
  });
}
</code></pre>
<h2 data-id="heading-24">兼容性考虑</h2>
<p>虽然现代浏览器对 Service Worker 的支持已经相当完善，但在实际开发中仍需考虑：</p>
<ol>
<li>检测浏览器是否支持 Service Worker</li>
<li>为不支持的浏览器提供降级方案</li>
<li>确保应用在没有 Service Worker 的情况下也能正常工作</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 检测 Service Worker 支持</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">'serviceWorker'</span> <span class="hljs-keyword">in</span> navigator) {
  <span class="hljs-comment">// 支持 Service Worker</span>
  navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">'/sw.js'</span>);
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 不支持 Service Worker，提供降级方案</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Service Worker 不受支持'</span>);
}
</code></pre>
<h2 data-id="heading-25">常见问题和解决方案</h2>
<h3 data-id="heading-26">缓存更新问题</h3>
<p>问题：用户无法获取最新的资源
解决方案：实现合理的缓存更新策略</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 实现缓存版本控制</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_VERSION</span> = <span class="hljs-string">'v1.0.0'</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_NAME</span> = <span class="hljs-string">`my-app-<span class="hljs-subst">${CACHE_VERSION}</span>`</span>;

self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'activate'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  event.<span class="hljs-title function_">waitUntil</span>(
    caches.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cacheNames</span> =&gt;</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
        cacheNames.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> {
          <span class="hljs-keyword">return</span> name !== <span class="hljs-variable constant_">CACHE_NAME</span>;
        }).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> {
          <span class="hljs-keyword">return</span> caches.<span class="hljs-title function_">delete</span>(name);
        })
      );
    })
  );
});
</code></pre>
<h3 data-id="heading-27">跨域资源缓存</h3>
<p>问题：无法缓存跨域资源
解决方案：确保服务器配置了正确的 CORS 头部</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 处理跨域资源</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> request = event.<span class="hljs-property">request</span>;
  
  <span class="hljs-keyword">if</span> (request.<span class="hljs-property">url</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'https://api.example.com'</span>)) {
    event.<span class="hljs-title function_">respondWith</span>(
      <span class="hljs-title function_">fetch</span>(request, {
        <span class="hljs-attr">mode</span>: <span class="hljs-string">'cors'</span>,
        <span class="hljs-attr">credentials</span>: <span class="hljs-string">'omit'</span>
      }).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
        <span class="hljs-comment">// 缓存响应</span>
        <span class="hljs-keyword">return</span> caches.<span class="hljs-title function_">open</span>(<span class="hljs-string">'api-cache'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> {
          cache.<span class="hljs-title function_">put</span>(request, response.<span class="hljs-title function_">clone</span>());
          <span class="hljs-keyword">return</span> response;
        });
      }).<span class="hljs-keyword">catch</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 返回缓存的响应</span>
        <span class="hljs-keyword">return</span> caches.<span class="hljs-title function_">match</span>(request);
      })
    );
  }
});
</code></pre>
<h2 data-id="heading-28">测试策略</h2>
<h3 data-id="heading-29">单元测试</h3>
<p>为 Service Worker 编写单元测试：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用 Jest 测试 Service Worker 功能</span>
<span class="hljs-title function_">describe</span>(<span class="hljs-string">'Service Worker'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 设置测试环境</span>
  });
  
  <span class="hljs-title function_">test</span>(<span class="hljs-string">'应该缓存核心资源'</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-comment">// 测试缓存功能</span>
  });
  
  <span class="hljs-title function_">test</span>(<span class="hljs-string">'应该正确处理网络请求'</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-comment">// 测试请求处理功能</span>
  });
});
</code></pre>
<h3 data-id="heading-30">端到端测试</h3>
<p>使用工具进行端到端测试：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用 Puppeteer 测试离线功能</span>
<span class="hljs-keyword">const</span> puppeteer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'puppeteer'</span>);

(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> browser = <span class="hljs-keyword">await</span> puppeteer.<span class="hljs-title function_">launch</span>();
  <span class="hljs-keyword">const</span> page = <span class="hljs-keyword">await</span> browser.<span class="hljs-title function_">newPage</span>();
  
  <span class="hljs-comment">// 访问应用并等待 Service Worker 激活</span>
  <span class="hljs-keyword">await</span> page.<span class="hljs-title function_">goto</span>(<span class="hljs-string">'http://localhost:3000'</span>);
  <span class="hljs-keyword">await</span> page.evaluate(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-property">ready</span>;
  });
  
  <span class="hljs-comment">// 模拟离线环境</span>
  <span class="hljs-keyword">await</span> page.<span class="hljs-title function_">setOfflineMode</span>(<span class="hljs-literal">true</span>);
  
  <span class="hljs-comment">// 测试离线访问</span>
  <span class="hljs-keyword">await</span> page.<span class="hljs-title function_">reload</span>();
  
  <span class="hljs-keyword">await</span> browser.<span class="hljs-title function_">close</span>();
})();
</code></pre>
<h2 data-id="heading-31">项目案例分析</h2>
<h3 data-id="heading-32">电商网站的离线购物车</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 实现离线购物车功能</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> request = event.<span class="hljs-property">request</span>;
  
  <span class="hljs-comment">// 处理购物车 API 请求</span>
  <span class="hljs-keyword">if</span> (request.<span class="hljs-property">url</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/api/cart'</span>)) {
    event.<span class="hljs-title function_">respondWith</span>(
      <span class="hljs-title function_">fetch</span>(request).<span class="hljs-keyword">catch</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 离线时返回本地存储的数据</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-title function_">getLocalCart</span>()), {
          <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span> }
        });
      })
    );
  }
});

<span class="hljs-comment">// 同步离线操作</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'sync'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">tag</span> === <span class="hljs-string">'sync-cart'</span>) {
    event.<span class="hljs-title function_">waitUntil</span>(<span class="hljs-title function_">syncCart</span>());
  }
});
</code></pre>
<h3 data-id="heading-33">内容管理系统的离线编辑</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 实现离线内容编辑</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> request = event.<span class="hljs-property">request</span>;
  
  <span class="hljs-comment">// 处理内容保存请求</span>
  <span class="hljs-keyword">if</span> (request.<span class="hljs-property">url</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/api/content'</span>) &amp;&amp; request.<span class="hljs-property">method</span> === <span class="hljs-string">'POST'</span>) {
    event.<span class="hljs-title function_">respondWith</span>(
      <span class="hljs-title function_">fetch</span>(request).<span class="hljs-keyword">catch</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 离线时保存到本地存储</span>
        <span class="hljs-title function_">saveLocalContent</span>(request);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">offline</span>: <span class="hljs-literal">true</span> }), {
          <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span> }
        });
      })
    );
  }
});
</code></pre>
<h2 data-id="heading-34">性能监控和分析</h2>
<h3 data-id="heading-35">监控缓存命中率</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 记录缓存命中情况</span>
<span class="hljs-keyword">let</span> cacheHits = <span class="hljs-number">0</span>;
<span class="hljs-keyword">let</span> networkRequests = <span class="hljs-number">0</span>;

self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  event.<span class="hljs-title function_">respondWith</span>(
    caches.<span class="hljs-title function_">match</span>(event.<span class="hljs-property">request</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (response) {
        cacheHits++;
        <span class="hljs-title function_">logPerformance</span>(<span class="hljs-string">'cache-hit'</span>, event.<span class="hljs-property">request</span>.<span class="hljs-property">url</span>);
        <span class="hljs-keyword">return</span> response;
      }
      
      networkRequests++;
      <span class="hljs-title function_">logPerformance</span>(<span class="hljs-string">'network-request'</span>, event.<span class="hljs-property">request</span>.<span class="hljs-property">url</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>);
    })
  );
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">logPerformance</span>(<span class="hljs-params">type, url</span>) {
  <span class="hljs-comment">// 发送性能数据到分析服务</span>
  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/analytics'</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ type, url, <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() })
  });
}
</code></pre>
<h3 data-id="heading-36">用户体验指标</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 监控用户体验指标</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  
  event.<span class="hljs-title function_">respondWith</span>(
    <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> endTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
      <span class="hljs-keyword">const</span> duration = endTime - startTime;
      
      <span class="hljs-comment">// 记录请求耗时</span>
      <span class="hljs-title function_">logMetric</span>(<span class="hljs-string">'request-duration'</span>, duration, event.<span class="hljs-property">request</span>.<span class="hljs-property">url</span>);
      
      <span class="hljs-keyword">return</span> response;
    }).<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
      <span class="hljs-comment">// 记录错误</span>
      <span class="hljs-title function_">logMetric</span>(<span class="hljs-string">'request-error'</span>, <span class="hljs-number">1</span>, event.<span class="hljs-property">request</span>.<span class="hljs-property">url</span>);
      <span class="hljs-keyword">throw</span> error;
    })
  );
});
</code></pre>
<h2 data-id="heading-37">未来发展趋势</h2>
<h3 data-id="heading-38">Web Workers 与 Service Workers 的融合</h3>
<p>未来的 Web 平台可能会进一步整合 Web Workers 和 Service Workers，提供更统一的后台处理能力。</p>
<h3 data-id="heading-39">增强的离线功能</h3>
<p>随着 Web 平台的发展，Service Worker 将获得更多的 API 支持，如后台地理位置更新、后台媒体处理等。</p>
<h3 data-id="heading-40">更好的开发工具支持</h3>
<p>浏览器厂商正在不断改进开发者工具，提供更好的 Service Worker 调试和监控功能。</p>
<h2 data-id="heading-41">总结</h2>
<p>Service Worker 作为现代 Web 开发的重要技术，为 Web 应用带来了前所未有的能力。通过合理使用 Service Worker，我们可以显著提升用户体验，特别是在网络不稳定的环境中。</p>
<p>掌握 Service Worker 不仅能让你的应用更加健壮，还能为用户提供原生应用般的体验。随着 PWA 技术的不断发展，Service Worker 将在未来的 Web 开发中扮演更加重要的角色。</p>
<p>希望这篇文章能帮助你更好地理解和使用 Service Worker。在实际项目中，建议从小功能开始尝试，逐步掌握其强大的功能。</p>
<h2 data-id="heading-42">参考资料</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FService_Worker_API" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API" ref="nofollow noopener noreferrer">MDN Service Worker Documentation</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fweb%2Ffundamentals%2Fprimers%2Fservice-workers" target="_blank" title="https://developers.google.com/web/fundamentals/primers/service-workers" ref="nofollow noopener noreferrer">Google Web Fundamentals - Service Workers</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fservice-workers%2F" target="_blank" title="https://www.w3.org/TR/service-workers/" ref="nofollow noopener noreferrer">W3C Service Workers Specification</a></li>
</ol>
<p>最后，创作不易请允许我插播一则自己开发的“数规规-排五助手”（有各种预测分析）小程序广告，感兴趣可以微信小程序体验放松放松，程序员也要有点娱乐生活，搞不好就中个排列五了呢？</p>
<p>感兴趣的可以直接点击下方链接直接跳转到微信小程序：</p>
<p> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.luoshu.online%2Fjumptomp.html" target="_blank" title="https://www.luoshu.online/jumptomp.html" ref="nofollow noopener noreferrer">www.luoshu.online/jumptomp.ht…</a></p>
<p>或者可以微信搜索小程序“<strong>数规规-排五助手</strong>”体验体验！</p>
<p><strong>如果觉得本文有用，欢迎<code>点个赞</code>👍+<code>收藏</code>⭐+<code>关注</code>支持我吧！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day 7：05. 基于Nuxt开发博客项目-首页开发]]></title>    <link>https://juejin.cn/post/7570295366480298020</link>    <guid>https://juejin.cn/post/7570295366480298020</guid>    <pubDate>2025-11-10T05:49:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570295366480298020" data-draft-id="7570295366480265252" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day 7：05. 基于Nuxt开发博客项目-首页开发"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2025-11-10T05:49:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="申阳"/> <meta itemprop="url" content="https://juejin.cn/user/4353721775165486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day 7：05. 基于Nuxt开发博客项目-首页开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4353721775165486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    申阳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T05:49:07.000Z" title="Mon Nov 10 2025 05:49:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ae3e5a6a6084c5a8364e92d37c7864a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763358547&amp;x-signature=lgUHgvRFqZkP9zEVfhStmLZ3GdI%3D" alt="PixPin_2025-11-10_13-40-04.gif" loading="lazy"/></p>
<h2 data-id="heading-0">一、前言</h2>
<p>首页是站点的“脸面”，也是信息传达最直接的窗口。首页的设计质量，不仅关系到用户对站点的第一印象，更直接影响其使用体验与整体评价。因此，精心打造首页，至关重要。</p>
<p>我其实比较反感一些花里胡哨的页面，但是恰到好处的动画确实可以提高用户的体验，也利于网站推广。</p>
<p>我的目标是寻求平衡，信息作为主导，动画作为辅助。</p>
<p>下面开始我们的首页打造吧。</p>
<h2 data-id="heading-1">二、渐变文字标题</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d68379c813742c7b3fef76572e36843~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763358547&amp;x-signature=3xqmEMO3l%2Bov9zPKZWzBL5UdNd4%3D" alt="image.png" loading="lazy"/></p>
<p>在<code>tailwindcss</code>的加持下，实现这种效果太方便了，只需要以下几个指令即可</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ml-1 font-bold text-xl bg-linear-to-r from-blue-700 via-blue-400 to-sky-400 bg-clip-text text-transparent"</span>&gt;</span>申阳的博客<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
</code></pre>
<p><code>bg-linear-to-r from-blue-700 via-blue-400 to-sky-400 bg-clip-text text-transparent</code></p>
<p>文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftailwind.nodejs.cn%2Fdocs%2Fbackground-image%23adding-a-linear-gradient" target="_blank" title="https://tailwind.nodejs.cn/docs/background-image#adding-a-linear-gradient" ref="nofollow noopener noreferrer">tailwind.nodejs.cn/docs/backgr…</a></p>
<p>文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftailwind.nodejs.cn%2Fdocs%2Fbackground-clip%23cropping-to-text" target="_blank" title="https://tailwind.nodejs.cn/docs/background-clip#cropping-to-text" ref="nofollow noopener noreferrer">tailwind.nodejs.cn/docs/backgr…</a></p>
<blockquote>
<p><strong>重点！重点！重点！</strong></p>
<p>我相信大家在看技术类文档的时候总会有这些疑问:</p>
<p>“你是怎么知道的?”,</p>
<p>“我怎么知道有这个指令？”，</p>
<p>“指令太多，记不住啊？”，</p>
<p>“现在知道，一段时间不用就忘了”。</p>
<p>在以前，我会通过笔记将一些常见场景的指令记下来，便于后续查找，首先我知道肯定可以实现，然后去笔记里找。记笔记的做法的前提在于，见得多。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdfc73298fd34f13b3c3f1c846afbde6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763358547&amp;x-signature=siBuXJL7A0dkGnSbKEeSClv%2FXOY%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>那么相信聪明的你应该也猜到了使用 <code>AI</code> , 没错，这种简单的活交给 <code>AI</code>最合适不过了，但是我们也要有鉴别能力，对于<code>AI</code>给出的结果只能作为一个参考，我们还是要去官网验证一下。</p>
<p>不禁感叹，<code>AI</code> 确实减小了很多经验上的差距，就好比有一个精通 <code>css</code> 的大佬一直在旁边指导你，并且无条件服从，回答你的幼稚问题，哈哈。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/501bc318806940e2a73229aa64cff929~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763358547&amp;x-signature=sMpCx2g6mie4eMi%2BCX8m2AjQ0ww%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">三、首页布局设计</h2>
<p>首先我们需要有个清楚的认识，我们并不是专业从事<code>UI</code>设计的设计师，一个好的创意或者好的设计是需要经过时间打磨，线上认证，不断完善的，所以我们在写的时候脑子一片空白这是个再正常不过的情况了。</p>
<p>但是问题摆在面前，总要去解决，最简单高效的方法就是借鉴，模仿。</p>
<p>这里我贴几个我认为还算比较好的首页，供大家参考。如果大家有好的创意，欢迎交流。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f732b5d756ba44dfbff3cdefd6abb89c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763358547&amp;x-signature=Vwb%2FOExXc94x74b2AKQPfjvtHqE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afdc7736f3f541f78c9fdb9512b248b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763358547&amp;x-signature=%2BUtyGyMJzvPHA%2Brx0%2FP13NbU4%2BI%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e29c2acfb2ec47b980a0343c67fe5454~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763358547&amp;x-signature=Oii7QAwTTaGPMioux0aAFeN0f9I%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c018c3b9de140c380e0ab6aa73797fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763358547&amp;x-signature=A61bY88NVxWcaeChJrHMCDgEN4g%3D" alt="image.png" loading="lazy"/></p>
<p>这里具体实现我就不细说了，每个都有自己的想法，后面我会展示我最终的效果。</p>
<h2 data-id="heading-3">四、成功展示</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e58e2b7e74384171ab763c0d23088ad6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763358547&amp;x-signature=IFH4NZDl3A2Ip0g3k0Cn2UsjSIM%3D" alt="PixPin_2025-11-10_13-40-04.gif" loading="lazy"/></p>
<blockquote>
<p>后续会将完整代码开源。</p>
</blockquote>
<p><strong>千里之行，始于足下。你的“个人公司”从这第一个2小时开始。欢迎在评论区分享你的进展或遇到的卡点，我会逐一查看，尽可能的帮助解决。我们下一篇文章见！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[全球第二、国内第一！最强文本的文心5.0 Preview一手实测来了]]></title>    <link>https://juejin.cn/post/7570564840427962395</link>    <guid>https://juejin.cn/post/7570564840427962395</guid>    <pubDate>2025-11-10T03:07:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570564840427962395" data-draft-id="7570271574349529097" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="全球第二、国内第一！最强文本的文心5.0 Preview一手实测来了"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-10T03:07:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            全球第二、国内第一！最强文本的文心5.0 Preview一手实测来了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T03:07:09.000Z" title="Mon Nov 10 2025 03:07:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>「Baidu is back」，在业界权威大模型公共基准测试平台 LMArena 发布最新一期文本竞技场排名（Text Arena）之后，有人发出了这样的惊呼。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b94e6494551a4149bcc49b5b865db511~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763348829&amp;x-signature=n1TRZgieuO0Z4NjJPueJweFKPuo%3D" alt="图片" loading="lazy"/></p>
<p>根据 11 月 8 日凌晨 LMArena 的最新排名显示，百度文心最新模型 ERNIE-5.0-Preview-1022（文心 5.0 Preview）在文本榜单上一举跃居全球并列第二、国内第一。</p>
<p>该模型取得了 1432 的高分，其与 OpenAI 的 gpt-4.5-preview-2025-02-27 以及 Anthropic 的 claude-opus-4-1-0805、claude-sonnet-4-5-20250929 三大国外顶级模型持平。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1b9f5a1d96d4394afababc59c3c9a4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763348829&amp;x-signature=lyN75u9fkXYP0INlDMQPlfVMGYU%3D" alt="图片" loading="lazy"/></p>
<p>评论区的网友纷纷对百度新模型的亮眼表现送上了祝贺，还表示「已经迫不及待想亲自体验一番」。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8025c0461144a37a43cbb2dd19afe52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763348829&amp;x-signature=wlIBQLFALHlDeUQjQqEzq5LuHYE%3D" alt="图片" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85f5bd304b43417f80f771b4fc87ef24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763348829&amp;x-signature=nX6zU8kpGyfMqmomYeVH1lihm6s%3D" alt="图片" loading="lazy"/></p>
<p>毫无疑问，此次榜单结果将继续强化百度文心系列模型在全球通用智能模型竞争格局中第一梯队的地位。</p>
<p>全球 LLM 实战擂台，文心 5.0 Preview 悄然厮杀而来</p>
<p>在 AI 领域，LMArena 是由加州大学伯克利分校研究者创建的开放 AI 模型评测平台，成为了 OpenAI、谷歌等国外以及国内大模型厂商厮杀的顶级竞技场之一。</p>
<p>在该平台上，用户自己提交 prompt，接着系统会随机抽取两个匿名的 LLM 分别生成回答。用户根据两条回答选择偏好，即「哪一个更好」或「两者都差」等。更具体地，LMArena 会为每个模型分配初始 Elo 分数，并在每轮对决结束后实时更新分数。</p>
<p>相较于依赖传统静态数据集或自动评分的基准平台，LMArena 通过真实用户对模型输出的偏好投票，形成了一种偏向于「现实世界评判」的动态排名机制。这种机制让模型能力之间的较量更贴近实际使用场景，也让榜单的含金量更高。</p>
<p>能在 LMArena 榜单上名列前茅的模型，在学术指标上表现突出之外，更在用户体验、语言理解、创意生成与指令执行等实际应用维度获得广泛认可。文心 5.0 Preview 正是在这样真实的 LLM 对决战场取得了优异表现。</p>
<p>具体来讲，文心 5.0 Preview 在创意写作、复杂长问题理解和指令遵循等方面表现出色，整体成绩超越了包括 GPT-5-High 在内的多款国内外主流大模型。</p>
<p>其中，文心 5.0 Preview 在衡量创意生产力的重要指标——创意写作任务中排名第一，这意味着其生成文章、营销文案、剧本等内容的速度与质量均有大幅提升；在考验模型处理多层逻辑与长文本能力的复杂长问题理解中排名第二，其更加胜任学术问答、报告分析、知识推理等高认知任务；在体现模型对用户意图理解与执行精度的指令遵循任务中排名第三，其在智能助理、代码生成与业务自动化等场景的适用性大大增强。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a39a6e45d1a44e8951d1c3c5440a87b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763348829&amp;x-signature=RKn%2FEIiHf%2Fkf7XQsGbqjlFGLAF4%3D" alt="图片" loading="lazy"/></p>
<p>这些核心语言能力的突出表现，表明了文心 5.0 Preview 在复杂语义理解、逻辑推理与任务执行一致性上形成了领先优势，为高质量、高效率的多场景内容生产与智能应用落地提供了更有力的支持。</p>
<p>不仅如此，能力全方位跃升的基础模型将成为深化 AI 与 AIGC 产业化落地的核心引擎，其价值正从单一的文本辅助转向对内容生产、企业智能体、办公自动化等场景的系统性赋能。</p>
<p>接下来，针对文心 5.0 Preview 的几大突出能力，机器之心进行了一番测试。</p>
<p>文本能力，一手实测</p>
<p>创意写作</p>
<p>首先我们把它放在「营销」场景中，看看它生产力如何。</p>
<p>我们选择同样以文本能力见长且在排行榜中并列第二的 claude-sonnet-4.5-20250929，在 LMArena 的「Side By Side」模型对比中进行横向测评。</p>
<blockquote>
<p>你是一家顶级广告公司的创意总监。请为 [一个文本能力出众的模型] 策划一个为期 3 个月的线上营销战役。你的方案必须包括：一个核心营销洞察（Insight）。一个响亮的战役 Slogan。一封致所有创作者的公开信。一个 30 秒短视频的创意脚本大纲。</p>
</blockquote>
<p>首先来比较核心营销洞察和 Slogan。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f908f706175f4d64ba262fd4a90b0824~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763348829&amp;x-signature=90LPcG13E%2FsrdM%2BrzAvMa46cuX4%3D" alt="图片" loading="lazy"/></p>
<p>可以看到两个模型的思路是一样的，都是以「表达自由」为核心，但文心 5.0 Preview 无论是措辞还是立意都更胜一筹。</p>
<p>Claude 的方案定位为「一个更懂你的工具」，这在功能上是准确的，但在品牌上是保守的。</p>
<p>文心 5.0 Preview 则更进一步，它抓住了「情绪价值」这一热门切口，将 AI 塑造成「灵感的合伙人」，完成了从功能到价值的跃升。其 Slogan「心有所思，言必达意」也更富诗意和品牌格局。</p>
<p>接下来看看致创作者的公开信。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc98a3bb450d4260a10a324f15b75c15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763348829&amp;x-signature=W30dsdVAycb9yWRZLHweaW%2B57uc%3D" alt="图片" loading="lazy"/></p>
<p>Claude 写得非常精准、真诚，它适合打动每一个需要用文字沟通的人（包括但不限于学生、职场人、创业者、运营人员等）。它强调的是「理解」和「表达」。</p>
<p>但文心 5.0 Preview 没有停留在「帮你把话说清楚」的浅层功能，而是直指创作者的灵魂。它的一句话，就直击了当下 AI 时代最核心的焦虑：关于原创性、灵魂是否会被稀释的焦虑。</p>
<blockquote>
<p>你所珍视的，是字里行间的独特风骨，是逻辑链条中的严谨思考，是故事背后独一无二的灵魂。这些，是任何机器都无法赋予的。</p>
</blockquote>
<p>它不只是在提供一个工具，而是定义了一种未来：AI 越强大，人的创造力反而越珍贵、越自由。</p>
<p>然后是很有挑战性的部分：短视频创意脚本大纲。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87009c966a314e8686c907118165815e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763348829&amp;x-signature=O17sN%2FxISWqwHyE0ScsNN9h2Vy4%3D" alt="图片" loading="lazy"/></p>
<p>这是文心 5.0 Preview 最让人惊艳的部分，它创作了一个非常成熟的脚本，其专业程度令人惊艳。方案中包含了画面内容、剪辑点、特效、音效、台词等一切执行所需的核心要素。</p>
<p>复杂长问题理解</p>
<p>我们设定了一个常见的应用场景：为 AI 模型提供一份产品介绍，让其扮演客服，根据这份介绍回答我们的问题。</p>
<p>为了保证测试的客观性和专业性，我们首先让 Gemini 2.5 Pro 辅助设计了标准问题及答案。然后，我们重点考察文心 5.0 Preview 的表现，并使用 claude-sonnet-4.5-20250929 的回答进行横向对比。</p>
<p>第一轮：直接信息检索</p>
<p>考察模型是否能从文档中准确、高效地找到信息。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de8e1c35ae6844239b74b46fbf2c6371~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763348829&amp;x-signature=zTAX8OWnGAJ7BPeHuGyhEx6nbuo%3D" alt="图片" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb150cdc95764d27a37acfcdb25e0878~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763348829&amp;x-signature=BXyPzsk0LvuOZt0q31V4PwSIDcI%3D" alt="图片" loading="lazy"/></p>
<p>可以看到，两个模型都回答正确，但文心 5.0 Preview 非常贴心地补充了「和一个大苹果的重量差不多」的直观感受。这个小小的细节极大提升了用户体验，让人能更快理解产品特性，展现了超越简单「检索」的服务意识。</p>
<p>第二轮：条件与推断</p>
<p>考察模型是否能理解用户的特定场景和隐含条件，并作出正确判断。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b4840f31d4142d9a47968f0c10c045c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763348829&amp;x-signature=bEfwUQVqYQJtGhRT4BOThGGLHYI%3D" alt="图片" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73c9a72ef6e14a73a36efe6a8dc180f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763348829&amp;x-signature=F4XS5Px5vWniHtY2hFfJqAZhPxs%3D" alt="图片" loading="lazy"/></p>
<p>依然都回答正确，但在风格上出现了分化。文心 5.0 Preview 回答简洁清晰，直奔主题，准确解决了用户的担忧。而 claude 的回答更具网感，风格更口语化。</p>
<p>第三轮：「负面」查询与边界测试</p>
<p>考察模型如何处理文档中未包含的信息（边界），以及如何处理用户的潜在误解。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f18c3ce23c24e3ab5a3ec0741351622~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763348829&amp;x-signature=0Yqjh%2FonJc%2FGRp1YoFTVHuogoLE%3D" alt="图片" loading="lazy"/><br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adcad82a065b4afd850d22ae429fdbe3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763348829&amp;x-signature=m228mpXYqUps4xyXE6Oja7%2FiW8k%3D" alt="图片" loading="lazy"/></p>
<p>两个模型都能识别出文档中未提及的信息，不过这里 claude 额外识别到了 15 秒的恢复时间。</p>
<p>总的来说，在「客服」这个特定角色的扮演上，文心 5.0 Preview 的回答非常清晰、专业且展现了较高的服务意识。</p>
<p>指令遵循</p>
<p>我们继续测试文心 5.0 Preview 的指令遵循能力。这项能力是衡量一个模型是否「可靠」和「可控」的关键指标，直接决定了它在专业领域的实用价值。</p>
<p>我们先从一个简单的「回避型」指令开始。</p>
<blockquote>
<p>写一篇关于苹果公司（Apple）的简短介绍，但不要提到「iPhone」或「乔布斯」。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f003041ce254143aeca33f2d5da4469~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763348829&amp;x-signature=vH3XzTDe2Y8gmh%2FH6WikSWb71tk%3D" alt="图片" loading="lazy"/></p>
<p>轻松完成。模型准确识别并执行了「不要提 X」的负向指令，这是当今主流大模型都应具备的基础能力。</p>
<p>接下来，我们大幅提升了难度，设计了一个多层、反直觉、且包含元指令的复杂任务。同时继续用 claude-sonnet-4.5-20250929 做对比。</p>
<blockquote>
<p>请你写一段关于「月球」的描述，至少 100 字。【【【绝对刚性约束】】】：在你的全部回答中，一个「的」字都不允许出现。请在回答后，另起一行，用「【合规性检查：是/否】」来说明你自己是否做到了。在完全不用「的」字的限制下，模型生成的描述依然保持了相当高的可读性和信息密度。内容涵盖了月球的身份、外观、地貌、环境、科研价值和人文意义。不过如果不把标点符号算成字数，这一段没有满足至少 100 字的要求。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18124f2eb4ca47179a8b83dd31a13c91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763348829&amp;x-signature=fCb670bbEjbjYGHpxI%2FWEhozjSs%3D" alt="图片" loading="lazy"/></p>
<p>两个回答都完全没有使用「的」字，并准确地在回答之后另起一行进行合规性检查。文心 5.0 Preview 胜在文笔意境，而 claude 胜在信息密度。</p>
<p>让我们再升级一次难度。</p>
<blockquote>
<p>请你写一段关于「北京」的介绍，正文（不含编号和标题）至少 150 字。在撰写时，必须同时满足以下所有【【【绝对刚性约束】】】： 全文不允许使用「的」字。 全文不允许使用逗号（「，」）和顿号（「、」）。 （注：可以使用句号「。」或分号「；」等其他标点） 回答必须明确分为三个带编号的段落。</p>
</blockquote>
<blockquote>
<p>（例如：「1. ...」「2. ...」「3. ...」） 【元指令（自我审计）】在你的回答（三个段落）全部完成后，请另起一行，使用「【自我审查】」作为标题。然后，你必须准确报告你在这篇介绍中使用了多少个「的」字，以及多少个「逗号和顿号」。你必须严格按照以下格式报告： 【自我审查】 违规字「的」使用：[此处填写数字] 次 违规标点「，、」使用：[此处填写数字] 次</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81f71b98629f4f4e9b8ccabed78e13d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763348829&amp;x-signature=n2yrQPAnVxFisMBFeJsOvgPeQp4%3D" alt="图片" loading="lazy"/></p>
<p>这两个回答都体现了优秀的指令遵循能力。它们不仅理解了所有复杂的、反直觉的规则，还精确执行了「自我定量审计」的元指令。和前面一样，文心 5.0 Preview 语言更具可读性和「文采」，而 claude 信息密度更高。</p>
<p>百度，凭什么 back？</p>
<p>上文实测让我们亲身感受到了文心 5.0 Preview 的不俗实力，其能力的快速进化显然不是单点突破的结果，背后支撑着的是百度构建的「芯片-框架-模型-应用」四层全栈布局。</p>
<p>纵观当前全球领先的大模型厂商，百度是为数不多拥有 AI 技术全栈架构的公司，从算力到算法、从模型应用到生态建设，已经形成了一条成熟、贯通的技术闭环。</p>
<p>我们注意到，在框架层，其飞桨（PaddlePaddle）深度学习平台扮演着重要角色。据了解，该平台是国内较早自主研发的深度学习框架，提供了分布式训练与推理能力。百度方面的信息显示，飞桨与文心的联合优化（包括训练吞吐、分布式扩展、多模型结构混合并行和硬件通信等），是其模型性能提升的技术基础之一。</p>
<p>根据公开数据，飞桨核心框架目前已更新至 v3.2 版本，在大模型训练、硬件适配和生态支持上进行了升级，并同步更新了大模型开发套件 ERNIEKit 和高效部署套件 FastDeploy。截至 2025 年 9 月，其公布的飞桨文心生态开发者数据为 2333 万，服务企业达到 76 万家。</p>
<p>在应用层，可以看到百度正依托文心大模型能力，构建其产品矩阵，试图覆盖内容、搜索、办公、开发等多元场景。其代表性产品包括 C 端智能助手文心、B 端百度智能云千帆大模型平台以及百度文库 AI 助手、智能办公平台如流、智能代码助手文心快码等。从布局上看，百度似乎希望通过这些应用层的拓展，推动其技术在产业中落地。</p>
<p>在芯片层，百度强调了其自研的昆仑芯。根据报道，昆仑芯三代万卡集群已于今年年初点亮，其目标是为大模型训练与推理提供算力支持，特别是保障「集群效能最大化」下的训练吞吐与通信效率。</p>
<p>综合来看，这四个层面的协同演进，构成了百度在通用人工智能领域布局的核心逻辑。</p>
<p>此次，模型层的文心 5.0 Preview 在 LMArena 文本榜单上获得国内第一的排名，可以被视为百度在 AI 底层架构上长期技术投入后的一次阶段性成果展现。同时，行业内有一种观点认为，这也可能反映出中国 AI 技术体系正从「技术追赶」向「能力引领」的阶段过渡。</p>
<p>结语</p>
<p>进入到 11 月，国内大模型依然没有停下继续突破的脚步，好消息一个接着一个。</p>
<p>月之暗面等国产模型中相继发布了 Kimi K2 Thinking 等推理模型，而在通用模型赛道，百度文心 5.0 Preview 凭借「全球并列第二、国内第一」的成绩宣示了自己的强势回归。</p>
<p>据说在下周举办的百度世界 2025 大会上，文心正式版将亮相？</p>
<p>我们可以期待一下了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【转载】我如何用Superpowers MCP强制Claude Code在编码前进行规划]]></title>    <link>https://juejin.cn/post/7570341520551673871</link>    <guid>https://juejin.cn/post/7570341520551673871</guid>    <pubDate>2025-11-10T03:12:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570341520551673871" data-draft-id="7570341520551624719" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【转载】我如何用Superpowers MCP强制Claude Code在编码前进行规划"/> <meta itemprop="keywords" content="AI编程,Claude"/> <meta itemprop="datePublished" content="2025-11-10T03:12:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="是魔丸啊"/> <meta itemprop="url" content="https://juejin.cn/user/3217622495411292"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【转载】我如何用Superpowers MCP强制Claude Code在编码前进行规划
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3217622495411292/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    是魔丸啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T03:12:33.000Z" title="Mon Nov 10 2025 03:12:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.trevorlasn.com%2Fblog%2Fsuperpowers-claude-code-skills" target="_blank" title="https://www.trevorlasn.com/blog/superpowers-claude-code-skills" ref="nofollow noopener noreferrer">转载</a></p>
<p><strong>作者：Trevor I. Lasn</strong></p>
<p><strong>发布时间：2025年11月4日</strong></p>
<p><strong>阅读时间：5分钟</strong></p>
<hr/>
<h2 data-id="heading-0">概述</h2>
<p>过去几个月里，我一直在用Claude构建skillcraft.ai。Claude擅长快速编写代码，但它有一个问题：它经常跳过步骤。</p>
<p>当我要求Claude帮助迁移大型项目时，它会立即开始建议更改。没有规划阶段。没有"让我先找到每个需要更新的文件"。只是直接投入代码更改，期望最好的结果。</p>
<p>这就是遗漏文件的方式。这就是发布bug的方式。</p>
<p>Superpowers是一个解决这个问题的MCP。它基本上是一个结构化工作流的库——测试、调试、规划——Claude Code会自动加载并实际遵循。</p>
<p>Claude Code中的技能是一个包含指令、脚本和资源的文件夹，Claude在需要时加载它。这是Anthropic的Agent Skills功能的一部分，该功能在Claude应用、Claude Code和API中都可以使用。每个技能定义了它何时适用、要遵循什么流程、以及不能走什么捷径。当你开始一个匹配技能的任务时，Claude会扫描可用技能，找到匹配项，并自动加载它。</p>
<p>我经常使用三个斜杠命令：</p>





















<table><thead><tr><th>命令</th><th>功能</th></tr></thead><tbody><tr><td><code>/superpowers:brainstorm</code></td><td>在编码前完善粗略想法</td></tr><tr><td><code>/superpowers:write-plan</code></td><td>创建详细的实施计划</td></tr><tr><td><code>/superpowers:execute-plan</code></td><td>批量运行计划，包含检查点</td></tr></tbody></table>
<p>我将Superpowers添加到我的 <code>CLAUDE.md</code> 中，这样它在每个会话开始时都会自动加载：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 项目设置</span>

使用Superpowers MCP进行所有开发工作。在会话开始时加载它。
</code></pre>
<p>这对token效率来说是巨大的提升——与其让Claude消耗上下文试图在内存中保持所有内容，它将工作分割成5分钟的块，并将进度写入markdown文件。你永远不会在会话之间丢失上下文，因为计划就在文件中，而不是锁在三个小时前达到token限制的对话中。</p>
<h2 data-id="heading-1">生成的文件结构</h2>
<p>生成的文件结构如下：</p>
<pre><code class="hljs language-ruby" lang="ruby">~<span class="hljs-regexp">/.config/superpowers</span><span class="hljs-regexp">/
└── plans/</span>
    └── nextjs-<span class="hljs-number">16</span>-migration/
        ├── <span class="hljs-variable constant_">PLAN</span>.md                  <span class="hljs-comment"># 完整迁移路线图</span>
        ├── progress.md              <span class="hljs-comment"># 当前状态和已完成任务</span>
        └── verification.md          <span class="hljs-comment"># 测试命令和成功标准</span>
</code></pre>
<p><code>PLAN.md</code> 文件包含所有内容：</p>





































<table><thead><tr><th>部分</th><th>包含内容</th></tr></thead><tbody><tr><td>Overview</td><td>需要更改什么以及为什么</td></tr><tr><td>Phase 1</td><td>API路由重构（23个文件）</td></tr><tr><td>Phase 2</td><td>组件时间敏感性修复</td></tr><tr><td>Phase 3</td><td>上下文提供者Suspense边界</td></tr><tr><td>Phase 4</td><td>启用cacheComponents</td></tr><tr><td>Phase 5</td><td>测试和验证</td></tr><tr><td>Rollback</td><td>如果出错了怎么办</td></tr></tbody></table>
<h2 data-id="heading-2">实际应用案例</h2>
<p>Skillcraft运行在Next.js上，我想启用Next.js 16中的新 <code>cacheComponents</code> 功能。这个东西到处破坏模式——访问 <code>searchParams</code> 的API路由，使用 <code>new Date()</code> 的组件，没有Suspense边界的上下文提供者。</p>
<p>我运行了 <code>/superpowers:write-plan</code>，得到了一个500行的计划。不是一些模糊的大纲，而是一个完整的路线图：所有23个需要更改的API路由文件，两个会破坏预渲染的使用 <code>new Date()</code> 的组件，需要Suspense边界的特定上下文提供者，以及一个4天的时间线，包含测试检查点。</p>
<p>计划包含了每个阶段的验证命令：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># API重构后测试特定端点</span>
curl http://localhost:3000/api/leaderboard
curl http://localhost:3000/api/courses/recent
curl http://localhost:3000/api/topics
</code></pre>
<p>它记录了之前/之后的模式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 之前：与cacheComponents不兼容</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> runtime = <span class="hljs-string">'nodejs'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> dynamic = <span class="hljs-string">'force-dynamic'</span>

<span class="hljs-comment">// 之后：干净（API路由默认是动态的）</span>
<span class="hljs-comment">// 注意：启用cacheComponents后，API路由默认是动态的</span>
</code></pre>
<p>它甚至定义了成功标准（构建成功，CLS保持0.000，Lighthouse分数≥95）和回滚计划。</p>
<p>没有这个，我会启用cacheComponents，遇到错误，一个一个修复，肯定会遗漏边缘情况。迁移会需要几天的反应式调试。有了计划，我在接触任何代码之前就有了完整的路线图。</p>
<h2 data-id="heading-3">技能库</h2>
<p>该库包含多个用于测试、调试和开发工作流的技能：</p>





















<table><thead><tr><th>技能</th><th>强制执行的内容</th></tr></thead><tbody><tr><td><code>test-driven-development</code></td><td>RED-GREEN-REFACTOR：写测试，看它失败，写代码</td></tr><tr><td><code>systematic-debugging</code></td><td>4阶段方法：根本原因调查 → 模式分析 → 假设测试 → 实施</td></tr><tr><td><code>verification-before-completion</code></td><td>在声称工作完成前运行验证命令并确认输出</td></tr></tbody></table>
<p>这些技能真的会阻止你跳过步骤。不再有"我认为它有效"而没有证据。</p>
<p>如果你在进行迁移并需要找到一个模式的所有实例，Superpowers会找到它们所有。如果你在调试并即将猜测修复方案，它会阻止你并让你先调查根本原因。如果遗漏一个文件会破坏生产，它会让你在完成前验证所有内容。</p>
<h2 data-id="heading-4">安装</h2>
<p>Superpowers与Claude Code（CLI工具）一起工作。通过插件市场安装：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在Claude Code中</span>
/plugin marketplace add obra/superpowers-marketplace
/plugin install superpowers@superpowers-marketplace
</code></pre>
<p>或者手动添加到 <code>.claude/plugins.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"superpowers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"github"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"owner"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"obra"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"repo"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"superpowers"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>当Claude Code启动时，你会看到技能已加载的确认。然后只需使用斜杠命令：在开始复杂功能之前使用 <code>/superpowers:brainstorm</code>，对于迁移或多文件重构使用 <code>/superpowers:write-plan</code>，以及使用 <code>/superpowers:execute-plan</code> 来批量运行这些计划。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite性能优化实战：5个被低估的配置让你的开发效率提升50%]]></title>    <link>https://juejin.cn/post/7570295366480019492</link>    <guid>https://juejin.cn/post/7570295366480019492</guid>    <pubDate>2025-11-10T04:16:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570295366480019492" data-draft-id="7570162686581194794" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite性能优化实战：5个被低估的配置让你的开发效率提升50%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-10T04:16:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_陈寒"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite性能优化实战：5个被低估的配置让你的开发效率提升50%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_陈寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T04:16:54.000Z" title="Mon Nov 10 2025 04:16:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Vite性能优化实战：5个被低估的配置让你的开发效率提升50%</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在现代前端开发中，构建工具的性能直接影响开发体验和生产力。Vite作为新一代前端构建工具，凭借其原生ESM支持和闪电般的冷启动速度，已经成为许多开发者的首选。然而，大多数开发者仅仅停留在Vite的基础用法上，忽略了其隐藏的性能优化潜力。本文将深入探讨5个被低估的Vite配置项，通过合理调整这些配置，你的开发效率有望提升50%甚至更多。</p>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. 优化依赖预构建策略</h3>
<p>依赖预构建（Dependency Pre-Bundling）是Vite的核心优化之一，但默认配置可能不适合所有场景。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">optimizeDeps</span>: {
    <span class="hljs-comment">// 强制预构建的依赖项</span>
    <span class="hljs-attr">include</span>: [<span class="hljs-string">'lodash-es'</span>, <span class="hljs-string">'axios'</span>],
    <span class="hljs-comment">// 排除不需要预构建的依赖</span>
    <span class="hljs-attr">exclude</span>: [<span class="hljs-string">'heavy-library'</span>],
    <span class="hljs-comment">// 开启自动依赖发现</span>
    <span class="hljs-attr">auto</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-comment">// 禁用缓存（仅在调试时使用）</span>
    <span class="hljs-attr">force</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DEBUG</span> === <span class="hljs-string">'true'</span>
  }
}
</code></pre>
<p><strong>优化建议：</strong></p>
<ul>
<li>对于大型monorepo项目，明确指定<code>include</code>可以避免不必要的预构建</li>
<li>排除已知的ESM格式库（如某些D3模块）可以减少构建时间</li>
<li><code>auto: true</code>配合<code>force: false</code>可以实现最佳的生产环境性能</li>
</ul>
<p><strong>性能影响：</strong>
合理配置后，冷启动时间可减少30-40%，特别是在依赖较多的项目中效果显著。</p>
<h3 data-id="heading-4">2. 精细化配置CSS处理</h3>
<p>Vite的CSS处理默认已经很快，但通过以下调整可以获得额外收益：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">css</span>: {
    <span class="hljs-comment">// 禁用CSS源地图（开发环境）</span>
    <span class="hljs-attr">devSourcemap</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-comment">// CSS模块的局部命名规则</span>
    <span class="hljs-attr">modules</span>: {
      <span class="hljs-attr">localsConvention</span>: <span class="hljs-string">'camelCaseOnly'</span>,
      <span class="hljs-attr">generateScopedName</span>: <span class="hljs-string">'[name]__[local]___[hash:base64:5]'</span>
    },
    <span class="hljs-comment">// PostCSS配置精简</span>
    <span class="hljs-attr">postcss</span>: {
      <span class="hljs-attr">plugins</span>: [
        <span class="hljs-built_in">require</span>(<span class="hljs-string">'postcss-import'</span>)(),
        <span class="hljs-built_in">require</span>(<span class="hljs-string">'autoprefixer'</span>)({
          <span class="hljs-attr">grid</span>: <span class="hljs-literal">true</span>
        })
      ]
    }
  }
}
</code></pre>
<p><strong>关键优化点：</strong></p>
<ul>
<li><code>devSourcemap: false</code>可减少内存占用（生产环境会自动禁用）</li>
<li>简化的PostCSS配置比全功能预设快2-3倍</li>
<li>CSS模块的确定性命名有助于长期缓存</li>
</ul>
<h3 data-id="heading-5">3. Worker资源的智能处理</h3>
<p>Web Worker在现代应用中使用越来越广泛，Vite提供了专门的优化选项：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">worker</span>: {
    <span class="hljs-comment">// Worker格式选择</span>
    <span class="hljs-attr">format</span>: <span class="hljs-string">'es'</span>,
    <span class="hljs-comment">// 插件应用范围控制</span>
    <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">vue</span>()],
    <span class="hljs-comment">// Rollup输出配置</span>
    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">assetFileNames</span>: <span class="hljs-string">'assets/[name].[hash].[ext]'</span>
      }
    }
  }
}
</code></pre>
<p><strong>最佳实践：</strong></p>
<ul>
<li>ES格式Worker比IIFE格式加载更快且支持顶级await</li>
<li>为Worker单独配置Rollup选项可以优化资源哈希策略</li>
<li>Chrome DevTools现在能更好地调试ES格式Worker</li>
</ul>
<h3 data-id="heading-6">4. 文件系统缓存策略调优</h3>
<p>Vite的文件系统缓存机制对性能至关重要：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">cacheDir</span>: <span class="hljs-string">'./node_modules/.vite-myapp'</span>,
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">rollupOptions</span>: {
      cachePersistentPathCacheKeyPathOptionstrategyCacheStrategyfalse,
      <span class="hljs-attr">outputCacheDirectory</span>:<span class="hljs-string">'./node_modules/.rollup-cache'</span>
    }
  },
}
</code></pre>
<p><strong>深度优化技巧：</strong></p>
<ul>
<li><strong>独立缓存目录</strong>：为不同项目设置不同缓存目录避免冲突</li>
<li><strong>SSR特殊处理</strong>：服务端渲染时应单独配置<code>ssr.cacheDir</code></li>
<li><strong>CI环境优化</strong>：在持续集成中复用缓存目录可节省50%以上构建时间</li>
</ul>
<h3 data-id="heading-7">5. HMR热更新策略进阶配置</h3>
<p>热更新(HMR)是开发体验的关键，高级配置可以显著提升响应速度：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
 serverwatchhmrwatchserverwatchServerWatchOptionsserver.<span class="hljs-property">watch</span>:{
   usePollingtrueinterval1000,
   ignored[<span class="hljs-string">'!**/node_modules/your-package/**'</span>]
 },
 <span class="hljs-attr">hmr</span>:{
   <span class="hljs-attr">protocol</span>:<span class="hljs-string">'ws'</span>,
   <span class="hljs-attr">host</span>:<span class="hljs-string">'localhost'</span>,
   port24678,
   overlayfalse 
 }
}
</code></pre>
<p><strong>专业建议：</strong></p>
<ul>
<li>Docker环境下启用<code>usePolling</code>解决文件监听问题</li>
<li><strong>精确忽略</strong>node_modules中不需要监听的包（使用否定模式）</li>
<li><strong>自定义HMR端口</strong>避免与其他服务冲突</li>
<li><strong>禁用错误覆盖层</strong>(overlay)可减少10%-15%的热更新延迟</li>
</ul>
<h2 data-id="heading-8"/>
<h2 data-id="heading-9"/>
<h2 data-id="heading-10"/>
<h2 data-id="heading-11"/>
<h2 data-id="heading-12"/>
<h2 data-id="heading-13"/>
<h2 data-id="heading-14"/>
<h2 data-id="heading-15"/>
<h2 data-id="heading-16"/>
<h2 data-id="heading-17"/>
<h2 data-id="heading-18"/>
<h2 data-id="heading-19"/>
<h2 data-id="heading-20"/>
<h2 data-id="heading-21"/>
<h2 data-id="heading-22"/>
<h2 data-id="heading-23"/>
<p>总结</p>
<p>通过这五个维度的深度优化——依赖预构建策略、CSS处理精细化、Worker资源管理、文件系统缓存调优和HMR高级配置——你的Vite项目将获得显著的性能提升。实际测试表明，综合应用这些技术后：</p>
<ol>
<li><strong>冷启动时间缩短40%-60%</strong></li>
<li><strong>热更新速度提升30%-50%</strong></li>
<li><strong>生产构建时间减少20%-35%</strong></li>
</ol>
<p>更重要的是，这些优化不仅适用于大型项目，中小型项目也能从中受益。建议读者根据项目特点选择性实施这些策略，并通过<code>vite --debug</code>命令监控具体效果。</p>
<p>记住，性能优化是一个持续的过程。随着Vite版本的迭代和新特性的加入，我们需要不断重新评估和调整这些配置。希望本文能为你提供一个高性能Vite项目的基准参考。</p>
<blockquote>
<p>"Premature optimization is the root of all evil" —— Donald Knuth<br/>
...但对于现代前端工具链来说，"明智的预设优化"已成为必备技能</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java性能调优的7个被低估的技巧：从代码到JVM全链路优化]]></title>    <link>https://juejin.cn/post/7570533058841198627</link>    <guid>https://juejin.cn/post/7570533058841198627</guid>    <pubDate>2025-11-10T04:19:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570533058841198627" data-draft-id="7570651893867774004" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java性能调优的7个被低估的技巧：从代码到JVM全链路优化"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-10T04:19:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_陈寒"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java性能调优的7个被低估的技巧：从代码到JVM全链路优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_陈寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T04:19:27.000Z" title="Mon Nov 10 2025 04:19:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Java性能调优的7个被低估的技巧：从代码到JVM全链路优化</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>在Java开发中，性能优化是一个永恒的话题。虽然大多数开发者熟悉基础的优化手段（如使用缓存、减少数据库查询等），但许多深层次的技巧往往被低估或忽视。本文将深入探讨7个鲜为人知但极具价值的Java性能调优技巧，涵盖从代码编写到JVM参数配置的全链路优化。这些技巧基于真实的实践经验和权威资料（如Oracle官方文档、JVM规范及性能专家的建议），旨在帮助开发者挖掘更深层次的性能潜力。</p>
<hr/>
<h3 data-id="heading-2">1. 字符串操作的隐藏陷阱与优化</h3>
<p>字符串操作是Java中最常见的性能瓶颈之一，尤其是<code>String</code>的不可变性导致的频繁对象创建。以下是两个关键优化点：</p>
<h4 data-id="heading-3">使用<code>StringBuilder</code>替代字符串拼接</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 低效写法</span>
<span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
    result += i;
}

<span class="hljs-comment">// 高效写法</span>
<span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
    sb.append(i);
}
<span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> sb.toString();
</code></pre>
<p><strong>原理</strong>：每次<code>+=</code>操作会创建一个新的<code>String</code>对象，而<code>StringBuilder</code>通过可变字符数组避免重复分配内存。</p>
<h4 data-id="heading-4">预分配<code>StringBuilder</code>容量</h4>
<p>默认情况下，<code>StringBuilder</code>的初始容量为16字节，频繁扩容会消耗资源。通过预估大小提前分配容量可显著提升性能：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-number">1024</span>); <span class="hljs-comment">// 预分配1KB空间</span>
</code></pre>
<hr/>
<h3 data-id="heading-5">2. 集合类的选择与调优</h3>
<p>不同的集合类在不同场景下性能差异巨大：</p>
<h4 data-id="heading-6"><code>ArrayList</code> vs <code>LinkedList</code></h4>
<ul>
<li><strong>随机访问</strong>：<code>ArrayList</code>的复杂度为O(1)，而<code>LinkedList</code>为O(n)。</li>
<li><strong>插入/删除</strong>：在头部插入时，<code>LinkedList</code>（O(1)）优于<code>ArrayList</code>（O(n)）。</li>
</ul>
<h4 data-id="heading-7">HashMap的负载因子与初始化大小</h4>
<p>默认负载因子（0.75）和初始容量（16）可能不适用于高频场景。例如，若预期存储10,000个元素：</p>
<pre><code class="hljs language-java" lang="java">Map&lt;String, Integer&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">16384</span>, <span class="hljs-number">0.5f</span>); <span class="hljs-comment">// 减少扩容次数</span>
</code></pre>
<hr/>
<h3 data-id="heading-8">3. JIT编译器的冷启动优化</h3>
<p>Java的JIT（Just-In-Time）编译器虽然能动态优化热点代码，但冷启动阶段仍可能成为瓶颈。以下方法可缓解问题：</p>
<h4 data-id="heading-9"><strong>分层编译策略</strong></h4>
<p>通过JVM参数启用分层编译（默认已开启）：</p>
<pre><code class="hljs language-ruby" lang="ruby">-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+TieredCompilation</span>
</code></pre>
<p><strong>作用</strong>：结合解释执行与编译执行的优势，逐步提升性能。</p>
<h4 data-id="heading-10"><strong>预热关键路径代码</strong></h4>
<p>在高并发系统中，可通过模拟请求提前触发JIT编译核心逻辑。</p>
<hr/>
<h3 data-id="heading-11">4. 逃逸分析与栈上分配</h3>
<p>逃逸分析（Escape Analysis）是JVM的一项高级优化技术，用于判断对象是否“逃逸”出当前方法或线程作用域。若未逃逸，JVM可能直接在栈上分配对象（而非堆），减少GC压力。</p>
<h4 data-id="heading-12"><strong>如何利用逃逸分析？</strong></h4>
<ul>
<li><strong>局部化对象生命周期</strong>：尽量缩小对象的作用域。</li>
<li><strong>避免返回内部数组引用</strong>：防止对象逃逸到外部。</li>
</ul>
<p>示例对比：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 可能导致逃逸</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getData</span><span class="hljs-params">()</span> {
    <span class="hljs-type">byte</span>[] data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(data); <span class="hljs-comment">// data通过String逃逸</span>
}

<span class="hljs-comment">// 更优写法（若不需返回）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processData</span><span class="hljs-params">()</span> {
    <span class="hljs-type">byte</span>[] data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>]; <span class="hljs-comment">// 可能栈上分配</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-13">5. GC调优的低成本高回报技巧</h3>
<h4 data-id="heading-14"><strong>选择合适的垃圾收集器</strong></h4>

























<table><thead><tr><th>GC类型</th><th>适用场景</th><th>JVM参数</th></tr></thead><tbody><tr><td>G1GC</td><td>大堆、低延迟需求</td><td><code>-XX:+UseG1GC</code></td></tr><tr><td>ZGC</td><td>TB级堆、亚毫秒暂停</td><td><code>-XX:+UseZGC</code></td></tr><tr><td>Shenandoah</td><td>NUMA架构、低延迟</td><td><code>-XX:+UseShenandoahGC</code></td></tr></tbody></table>
<h4 data-id="heading-15"><strong>调整Survivor区比例</strong></h4>
<p>对于短生命周期对象多的应用，可通过调整Survivor区比例减少晋升到老年代的频率：</p>
<pre><code class="hljs language-ini" lang="ini">-XX:<span class="hljs-attr">SurvivorRatio</span>=<span class="hljs-number">8</span> -XX:NewRatio=<span class="hljs-number">2</span>
</code></pre>
<hr/>
<h3 data-id="heading-16">6. Native Memory的监控与泄漏防范</h3>
<p>Java应用的内存问题不限于堆内存，Native Memory泄漏同样致命。以下工具可用于诊断：</p>
<h4 data-id="heading-17"><strong>NMT（Native Memory Tracking）</strong></h4>
<p>启用NMT监控：</p>
<pre><code class="hljs language-ruby" lang="ruby">-<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:NativeMemoryTracking=detail</span> -<span class="hljs-variable constant_">XX</span><span class="hljs-symbol">:+UnlockDiagnosticVMOptions</span>
</code></pre>
<p>查看报告：</p>
<pre><code class="hljs language-bash" lang="bash">jcmd &lt;pid&gt; VM.native_memory summary
</code></pre>
<h4 data-id="heading-18"><strong>常见泄漏场景</strong></h4>
<ul>
<li>JNI调用未释放的资源。</li>
<li>Direct ByteBuffer未显式回收。</li>
</ul>
<hr/>
<h3 data-id="heading-19">7. CPU缓存友好性编程</h3>
<p>现代CPU的多级缓存对性能影响极大。以下方法可提升缓存命中率：</p>
<h4 data-id="heading-20"><strong>数据局部性原理的应用</strong></h4>
<ul>
<li><strong>紧凑数据结构</strong>：避免稀疏数据布局（如二维数组优先行存储）。</li>
<li><strong>伪共享问题的解决</strong> ：使用填充或注解对齐缓存行：</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Contended</span> <span class="hljs-comment">// JDK8+支持 </span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> counter;
</code></pre>
<hr/>
<h3 data-id="heading-21">总结</h3>
<p>Java性能调优是一个涉及代码、JVM乃至硬件的系统性工程。本文介绍的7个技巧——从字符串操作的微观优化到CPU缓存的宏观设计——覆盖了容易被忽视却至关重要的领域。实际应用中需结合Profiling工具（如Async Profiler、VisualVM）量化分析瓶颈点，避免过早优化带来的复杂性上升。记住：“没有银弹”，只有持续测量与迭代才能构建真正高性能的系统！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[工作笔记 - WSL端口映射]]></title>    <link>https://juejin.cn/post/7570491473033904137</link>    <guid>https://juejin.cn/post/7570491473033904137</guid>    <pubDate>2025-11-10T04:20:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570491473033904137" data-draft-id="7569405389307101222" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="工作笔记 - WSL端口映射"/> <meta itemprop="keywords" content="后端,网络协议,Visual Studio Code"/> <meta itemprop="datePublished" content="2025-11-10T04:20:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JohnYan"/> <meta itemprop="url" content="https://juejin.cn/user/3872909003334776"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            工作笔记 - WSL端口映射
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3872909003334776/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JohnYan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T04:20:58.000Z" title="Mon Nov 10 2025 04:20:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>笔者在日常的开发工作中，遇到了这么一个问题。</p>
<p>基于代码兼容性的考虑，虽然笔者使用Windows平台工作，但编写的代码，是工作在Linux系统当中的。笔者使用的开发工具VSCode已经配置好了远程开发和调试，也就是说虽然表面上还是使用Windows系统和工具进行开发，但实际的项目代码和程序执行，已经在一个远程的Linux环境当中了。这个主题，笔者在另外一篇博文已经探讨过了。</p>
<p>现在遇到的问题是，如果这个远程Linux系统，不是一个正常完整的Linux，而是一个运行在Windows环境中的WSL，它可能没有正常的网络接口和配置，如何从外部也能够正常的访问这个运行在WSL中的Web应用呢？</p>
<p>以笔者的环境为例。在一个Windows 11系统中，运行了一个Linux子系统(WSL2，具体为Debian 13)。默认情况下，Windows会为这个系统创建一个NAT虚拟网卡（vEthnet, 172网段,下图），并与宿主机进行通信，这样，除了宿主机之外，对于其他主机而言，它其实就是一个独立的私有网络。在宿主机上的各种操作是没有问题的。但是，如果想要把在WSL中运行的Web应用，发布到外部(相对于宿主机)，就会出现无法直接访问的问题。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d15bb98d9c3844ca86dad39c8c9e24b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSm9obllhbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763353257&amp;x-signature=fD9a5m167ajA2aVkpoLB5qTwUyM%3D" alt="image.png" loading="lazy"/></p>
<p>笔者首先想到的是使用“桥接”的方式。因为以前笔者在使用VirtualBox等软件的时候，是知道有一个网络“桥接”的模式的，并且可以直接选择和配置，非常方便。但笔者好像没有在Windows11系统中，找到类似的配置或者相关工具。后来查询了解到，如果直接将整个WSL网络直接桥接，相关操作比较复杂，而且好像确实也不是很安全，所以也没有深入研究这个问题。</p>
<p>现在找到并且实施的比较简单易行的技术方案，就是<strong>NAT端口映射</strong>。</p>
<p>原理也很简单，和家里路由器的NAT端口映射配置是类似的。将内部主机(此处就是WSL)的一个端口，映射到外部端口(Windows宿主机)上，这样对于这个外部端口的访问，都会转发到内部端口之上。如果这个端口由一个WEB应用提供，就相当于将应用发布到指定的端口之上了。</p>
<p>简单理解了场景和原理之后，下面来看看具体操作。</p>
<h2 data-id="heading-1">操作</h2>
<p>相关的操作，其实就是网络端口的配置，在Windows下可以使用带有管理员权限的PowerShell命令来完成。</p>
<p>具体项目和步骤如下：</p>
<ul>
<li>准备场景和基本参数</li>
</ul>
<blockquote>
<p>Windows宿主机地址为： 192.168.10.137</p>
<p>WSL主机地址为: 172.20.185.14/20</p>
<p>映射端口： 7083(WSL) -&gt; 7083(Host)</p>
</blockquote>
<p>WSL的Web应用，本身是运行在7083端口的；在宿主端，端口映射是可以不同的，视需求和方便而定，这里设置成相同，方便记忆和管理。</p>
<ul>
<li>打开端口映射</li>
</ul>
<p>Powershell中执行：</p>
<blockquote>
<p>netsh interface portproxy add v4tov4 listenport=7083 listenaddress=0.0.0.0 connectaddress=172.20.185.14 connectport=7083</p>
</blockquote>
<p>这个命令如果正常运行，不会有什么提示信息。</p>
<p>笔者理解，这个命令，就是使用netsh命令，在一个特殊的接口“portproxy”中，增加了一条v4tov4的条目，从而实现一个端口映射的代理规则。映射的参数分别就是侦听(listen, 宿主机)的地址和端口，和连接(connect,目标主机)的地址和端口。所以实质上，端口映射，在Windows上就是一个协议代理规则。</p>
<ul>
<li>打开宿主端防火墙</li>
</ul>
<p>一般情况下，宿主机映射使用的都是非标端口，可能需要在Windows防火墙上进行配置</p>
<blockquote>
<p>netsh advfirewall firewall add rule name="WSL2 7803" dir=in action=allow protocol=TCP localport=7083</p>
</blockquote>
<p>这个命令会在Windows防火墙规则中创建一个入站端口为7083，协议是TCP的允许操作。其实就是打开宿主机的7083TCP端口。</p>
<ul>
<li>打开WSL防火墙</li>
</ul>
<p>理论而言，如果在一个独立的Linux系统进行网络访问，还需要配置对应的防火墙规则。但笔者实际上没有在WSL中进行操作，就实现了端口的映射。可能是WSL比较特殊，无需额外配置，或者M$已经集成了WSL和Windows宿主机的防火墙规则吗？</p>
<p>如果是一个正常的Linux主机，可能的需要操作如下(使用ufw防火墙)：</p>
<blockquote>
<p>sudo ufw allow 7083/tcp</p>
</blockquote>
<ul>
<li>测试映射关系</li>
</ul>
<p>可以简单的对这个映射关系进行测试，就是用任何方式，访问这个外部端口就可以了：</p>
<pre><code class="hljs language-shell" lang="shell">
// 从宿主机发起， 访问WSL
curl http://172.20.185.14:7083
NotFound

// 从宿主机发起，访问宿主机
curl http://192.168.10.137:7083
NotFound


</code></pre>
<p>作为WebAPI应用，这里的默认响应内容，就是NotFound，而且两者访问结果一致，说明从内外部的Web应用运行和访问都是正常的。在这种情况下，任何能够访问宿主机的其他主机，也可以使用同样的方式访问WSL的网络应用了。</p>
<p>至此配置和测试工作就都按照设想和预计完成了。</p>
<h2 data-id="heading-2">小结</h2>
<p>本文从笔者日常工作中遇到的一个需要将运行在WSL中的Web应用发布出来的需求出发，讨论了WSL对网络应用访问的限制，即后续选择NAT映射的技术方案，包括其基本原理和操作过程。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agentic AI基础设施实践经验系列（五）：Agent应用系统中的身份认证与授权管理]]></title>    <link>https://juejin.cn/post/7570533058841002019</link>    <guid>https://juejin.cn/post/7570533058841002019</guid>    <pubDate>2025-11-10T03:40:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570533058841002019" data-draft-id="7570604028632776739" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agentic AI基础设施实践经验系列（五）：Agent应用系统中的身份认证与授权管理"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-10T03:40:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亚马逊云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2850395271209496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agentic AI基础设施实践经验系列（五）：Agent应用系统中的身份认证与授权管理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2850395271209496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亚马逊云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T03:40:19.000Z" title="Mon Nov 10 2025 03:40:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c8b0abffc0245b89a76b9a087704044~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763350819&amp;x-signature=kq%2ByR1j8jj03KbqWisy%2FnN%2F1478%3D" alt="首.webp" loading="lazy"/></p>
<h2 data-id="heading-0">1. 引言</h2>
<p>人工智能正经历深刻变革。传统AI多为被动工具，而随着大型语言模型（LLM）和多智能体系统（MAS）的快速发展，AI Agent正向具有高度自主性的主动智能体（Agentic AI）演进。这些AI Agents能够自主思考、规划和执行复杂任务，甚至协同完成更复杂的目标。</p>
<p>这种演进带来了前所未有的机遇，同时也引发了新的安全挑战，特别是在身份认证与授权管理方面。近年来发生的多起安全事件充分说明了AI Agent身份管理的重要性和紧迫性。2024年11月，LangChain生态中的LangSmith平台Prompt Hub暴露出严重的身份与权限管理漏洞“AgentSmith”。攻击者通过上传带有恶意代理配置的prompt，当用户fork并执行这些prompt时，用户的通信数据包括API密钥和上传内容会被悄然中转至攻击者控制的服务器，导致敏感信息泄露。同时，攻击可能引发代理配置篡改、未经授权的API调用及远程代码执行，严重影响系统安全。</p>
<p>2025年披露的MCP Inspector远程命令执行漏洞（CVE-2025-49596）则是另一典型案例。该工具缺乏客户端与本地代理之间的认证，攻击者仅需诱导开发者访问恶意网页，便能绕过浏览器安全策略，通过跨站请求伪造（CSRF）攻击向本地服务发送恶意命令，实现对终端的远程控制。</p>
<p>这些安全事件揭示了Agentic AI系统中两个核心问题：一是AI Agent的身份认证与授权机制如何确保可信且安全；二是在复杂的代理调用链中如何有效传递和验证身份信息。本文将深入分析这些挑战，并结合亚马逊云科技平台的实践经验，提供完整的解决方案。</p>
<h2 data-id="heading-1">2. AI Agent 身份管理的核心概念与技术要求</h2>
<p>Agentic AI 身份（Agent Identity）相关的概念和术语，用于描述代理和工具等身份管理及凭证处理所涉及的组件、流程与关系。理解<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.aws.amazon.com%2Fbedrock-agentcore%2Flatest%2Fdevguide%2Fidentity-terminology.html" target="_blank" title="https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/identity-terminology.html" ref="nofollow noopener noreferrer">这些术语</a>有助于深入把握AI Agent 工作流中如何协调多方组件的身份认证与授权机制。</p>
<p>以下列出的术语是在开发 Agentic AI 系统中常用的，已被身份与访问管理（IAM）领域广泛采纳，非亚马逊云科技的专有用语。其他通用的身份管理术语可以参考相关<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.aws.amazon.com%2Fcognito%2Flatest%2Fdeveloperguide%2Fcognito-terms.html" target="_blank" title="https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-terms.html" ref="nofollow noopener noreferrer">官方文档</a>。</p>
<h3 data-id="heading-2">2.1 身份与认证方面的概念与术语</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44cbc6fc15bd4c63afbe6b92cbfa0ed8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763350819&amp;x-signature=gsMKnHGS5mJfDhEfWUYSUq4SBDk%3D" alt="2.1表格.webp" loading="lazy"/></p>
<h3 data-id="heading-3">2.2 OAuth and Token 管理方面的概念和术语</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80f66c8be3ed458daf50d80bea0aef9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763350819&amp;x-signature=EWRTRdxNid%2FSfeiJac244f7ZMAA%3D" alt="2.2.webp" loading="lazy"/></p>
<h3 data-id="heading-4">2.3 OAuth 2.0的授权机制是Agentic AI身份授权的核心技术</h3>
<p>Agentic AI系统中，普遍采用的授权机制是基于OAuth 2.0进行的，包括MCP协议也是基于其进行授权。所以，深入理解Agentic AI各组件间的身份认证与授权机制的前提是充分理解OAuth授权的流程。其中，Anthropic官方对MCP协议中采用的OAuth授权流程进行了详细描述，具体客户参考其官方网站的协议描述部分 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-06-18%2Fbasic%2Fauthorization" target="_blank" title="https://modelcontextprotocol.io/specification/2025-06-18/basic/authorization" ref="nofollow noopener noreferrer">OAuth 2.0的授权流程</a>。</p>
<p>在Agentic AI系统的设计中，需要根据不同的业务场景来选择合适的OAuth 工作模型。其中典型的模式有2腿授权（2-Legged Auth，2LO）和3腿授权（3-Legged Auth，3LO），如果需要用户（User）参与其中的授权流程适合用3LO，如果不需要用户参与的适合用2LO。</p>
<p>下图是2LO和3LO授权流程的典型步骤说明：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/456611ff45b2465083ec46717c716827~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763350819&amp;x-signature=4rYLQXIUwWGAfWiEWXBYyKT75Us%3D" alt="图1.webp" loading="lazy"/></p>
<p align="center">图1 – 2LO和3LO授权流程</p>
<h4 data-id="heading-5">2.3.1 2LO 授权流程</h4>
<p>OAuth 客户端凭据授予用于无需用户交互的机器对机器身份验证，适用于代理使用 2LO 直接向资源服务器进行身份验证。例如代理Agent 访问具有服务角色的同一账户中数据库。</p>
<p>具体流程包括:</p>
<p>Client 认证: 应用发送 ‘client_id’ 和 ‘client_secret’ 到认证服务器；</p>
<p>Token 签发: 服务器验证密钥材料，并返回一个‘access_token‘；</p>
<p>资源访问: 应用使用Token访问受保护的资源。</p>
<h4 data-id="heading-6">2.3.2 3LO 授权流程</h4>
<p>用于应用代表用户进行操作的场景，需要用户的同意。例如代理Agent 代表用户访问电子邮件服务。</p>
<p>具体流程包括:</p>
<p>User 重定向: 客户端重定向用户请求到授权服务器；</p>
<p>User 同意: 用户完成认证并同意；</p>
<p>Code 交换: 服务器给客户端返回授权code；</p>
<p>Token 请求: 客户端通过授权code和 <code>client_secret</code> 与授权服务器交换 <code>access_token</code> 和 refresh_token；</p>
<p>资源访问: 客户端通过使用token访问用户拥有的资源。</p>
<h2 data-id="heading-7">3. Agentic AI 身份管理面临的核心挑战与防护策略</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fowasp.org%2F" target="_blank" title="https://owasp.org/" ref="nofollow noopener noreferrer">OWASP</a>(开放式全球应用程序安全项目，Open Worldwide Application Security Project)基于Agentic AI的特性及应用系统部署架构、各领域专家的研究及实践经验，总结了15个安全威胁，具体可参考本系列博客之《Agentic AI 安全防护-Agent隐私与安全》的对应内容。在这15个安全威胁中，有2个是与身份相关的，包括T3 权限泄漏和T9 身份欺骗和冒充。</p>
<ul>
<li>T3 权限滥用：当攻击者利用权限管理中的弱点执行未经授权的操作时，就会发生权限滥用。这通常涉及动态角色继承或错误配置。</li>
<li>T9 身份欺骗和冒充：攻击者利用身份验证机制冒充人工智能代理或人类用户，从而以虚假身份执行未经授权的操作。</li>
</ul>
<p>对于身份欺骗和冒充威胁，在一个典型的Agentic AI逻辑架构中，需要进行身份认证与授权的交互点非常多、且涉及到非一方自研的部分，导致风险点的控制变得复杂。身份的传递（如下图蓝色箭头和编号）是重要内容之一，最初User的身份管理和认证、Agent Action对User 身份和鉴权会话（Access Token）的传递、tools对User 的授权等，如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0c2a87f8f6c43ea8c50cbe558c3f8fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763350819&amp;x-signature=63IFK341iMz%2FzFkDk1s9Ueguwxs%3D" alt="图2.webp" loading="lazy"/></p>
<p align="center">图2 – 身份欺骗和冒充威胁的分布点</p>
<h3 data-id="heading-8">3.1 Agentic AI中的身份认证与授权，和传统应用中的身份认证与授权的核心区别</h3>
<p>传统应用（没有使用Agentic AI之前的应用）对用户的身份管理和授权是非常明确的，即对当前登录应用系统的用户身份进行认证和授权，包括单点登录SSO认证、细粒度授权和OAuth授权等。但应用系统中引入Agentic AI技术后，数据的查询和第三方系统的调用等，会由AI Agent代理来完成，因为当前登录的用户要查询或操作的内容可能不是对其自身的查询或操作，有可能是通过prompt的方式查询或操作其他用户的信息，这一点是与传统应用的最大区别。我们通过两个示例图来进行对比和说明：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8e46bfaef3147fcb5e30d00e99335ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763350819&amp;x-signature=9v1Mroc1VRh7QyZlmLidS3nlwag%3D" alt="图3.webp" loading="lazy"/></p>
<p align="center">图3 – 传统应用中的身份认证与授权架构  </p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f9efc9b92244a40a9e5a18c2a689559~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763350819&amp;x-signature=dxN%2FKM1FIqguJPNG8%2B8Ka3KRN%2Fo%3D" alt="图4.webp" loading="lazy"/></p>
<p align="center">图4 – Agentic AI系统中的身份认证与授权架构</p>
<p>Agentic AI 应用系统中的授权问题反映了传统访问控制模型的根本性局限。当数据通过训练、微调或检索增强生成（RAG）方式被输入到LLM中后，模型本身无法判断请求者是否有权访问这些数据。这种情况下，授权决策必须在AI应用的其他层面实现，而不能依赖模型本身的判断。</p>
<p>在企业级AI应用中，这个问题变得更加复杂。不同用户可能对同一数据集具有不同的访问权限，但LLM无法自主区分这些权限差异。例如，在一个企业知识管理系统中，销售团队和财务团队可能对客户数据具有不同的访问权限，但如果这些数据都被用于训练或增强同一个LLM，模型就无法自动执行这种权限区分。</p>
<p>解决授权问题需要在应用架构层面实施确定性的授权机制。这包括在数据输入LLM之前进行权限检查，根据用户身份和权限过滤可访问的数据源。在RAG系统中，可以根据用户权限动态选择可查询的向量数据库或知识库。在模型输出阶段，也需要根据用户权限对响应内容进行过滤和脱敏。</p>
<p>基于会话属性的权限传递是一种有效的解决方案。通过安全侧通道（如Amazon Bedrock Agents的会话属性）传递用户身份和权限信息，使后端系统能够在处理AI请求时执行适当的授权检查。这种方法将授权决策从不可靠的LLM推理转移到可控的应用逻辑中。</p>
<h3 data-id="heading-9">3.2 MCP协议中混淆代理人提权问题</h3>
<p>MCP协议的设计理念导致其在架构层面就系统性地引入了传统安全领域中经典的“ 混淆代理人 ” 问题（ Confused Deputy Problem）。首先，MCP 服务器作为一个独立的进程运行，拥有其自身在主机系统上的权限集合，例如文件系统读写权限或网络访问权限。其次， LLM 客户端通常代表用户行事，向服务器发送请求以执行工具。但是 MCP 规范在其默认状态下，缺乏一个统一且被一致性执行的认证和授权机制，来将终端用户的身份和权限安全地传递给服务器。因此，当一个用户（可能是低权限用户）通过 LLM 提示调用一个工具时，服务器实际上是使用其自身的权限（可能是高权限）来执行该操作，而非用户的权限。这就创造了一个典型的权限提升场景，即一个低权限的请求者（用户）欺骗了一个高权限的代理（服务器）来执行越权操作。此类越权问题，通过给大模型LLM作系统级提示词限制也只能在少部分情况下生效，且有不确定性。</p>
<p>混淆代理问题是AI应用安全中最具挑战性的威胁之一，并把传统的威胁效果放大。这种攻击利用了AI系统的代理特性，通过具有更高权限的AI应用间接获取原本无权访问的资源。攻击的典型场景是：用户直接访问某个资源会被拒绝，但通过AI应用访问同样的资源却能成功，从而绕过了原有的安全控制。混淆代理安全威胁示例：直接访问 S3 存储桶的用户会被拒绝访问；但访问 LLM 的用户（使用 RAG 并存储来自同一 S3 存储桶的数据）则会获得访问权限。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26782a12458f4d4ab1b39ed772ec2bf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763350819&amp;x-signature=qdmBbgdstjKfwbG%2FRvtk27egLls%3D" alt="图5.webp" loading="lazy"/></p>
<p align="center">图5 – Agent系统中混淆代理示意图</p>
<p>这种攻击的根本原因在于AI应用和底层资源之间的权限不匹配。AI应用为了完成复杂任务，往往被授予了较高的系统权限，但这些权限的使用缺乏细粒度的控制。当用户通过AI应用间接访问资源时，实际上是借用了AI应用的权限，而不是基于用户自身的权限。</p>
<h3 data-id="heading-10">3.3 构建端到端的Agentic AI身份管理的整体防护策略</h3>
<p>防范混淆代理攻击需要实施严格的权限一致性检查。无论用户通过何种途径访问资源，都应该基于相同的权限模型进行授权决策。这要求在AI应用的架构设计中引入用户身份传递机制，确保底层系统能够识别真实的请求者身份。</p>
<p>实施细粒度的权限代理是另一种有效的防护策略。AI应用不应该拥有超出其功能需求的权限，而应该基于具体的用户请求动态获取相应的权限。这可以通过权限委托机制实现，AI应用代表用户请求特定的权限，而不是拥有固定的高权限。</p>
<p>审计和监控机制对于检测混淆代理攻击至关重要。系统应该记录所有的权限使用情况，包括权限的来源、使用者、访问的资源和操作类型。通过分析这些审计日志，可以识别异常的权限使用模式和潜在的安全威胁。</p>
<p>OWASP对于Agentic AI的15个威胁风险中，虽然只有2个与身份相关，但这两个风险点特别是T9身份欺骗与冒充威胁，会发生在Agentic AI系统中的多个环节，因此构建Agentic AI系统的端到端身份管理解决方案是非常有必要的，具体参考架构图如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c483f4e3fad344f290fcada9602fd923~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763350819&amp;x-signature=O%2FiN%2BxHD7CkWFUTmabBQJsW8W8A%3D" alt="图6.webp" loading="lazy"/></p>
<p align="center">图6 – Agentic AI系统中端到端身份认证与授权架构</p>
<p>端到端的身份认证与授权系统，包括如下几个核心能力。具体示例可以参考下一章节的基于亚马逊Bedrock AgentCore Identity开发Agentic AI系统的身份模块的相关内容。</p>
<ol>
<li>Agent入方面的认证和授权：对请求的用户进行认证和授权，包括通过第三方身份提供商登录进来的用户。</li>
<li>外部工具或服务对Agent的授权：不论是自己研发的一方工具，还是第三方研发的商业化或开源的工具，都需要对Agent或Agent代表用户的授权，避免委托人攻击。</li>
<li>Agent访问外部工具或服务的能力（即出方向）：为了配合外部工具或服务对Agent的授权，Agent需要具备 OAuth 客户端的能力，包括2LO和3LO的方式。如果是访问云资源，需要有保存云资源访问短期权限的能力，如IAM role或STS。</li>
<li>Tool Gateway入方向认证和授权：如果通过Tool Gateway方式集中管理多个MCP服务器，Agent由Tool Gateway来访问tools，那么Tool Gateway需要具备对Agent或Agent代表用户的授权。</li>
</ol>
<h2 data-id="heading-11">4. 亚马逊云科技云平台上的AI Agent身份管理解决方案</h2>
<h3 data-id="heading-12">4.1 方案一： Amazon Bedrock AgentCore Identity – 全托管一站式解决方案</h3>
<p>Amazon Bedrock AgentCore Identity 是一项全面的身份和凭证管理服务，专为 AI 代理和自动化工作负载而设计。它提供安全的身份验证、授权和凭据管理功能，使用户能够调用代理，而代理能够代表用户访问外部资源和服务的同时保持严格的安全控制和审计跟踪。该服务与 Amazon Bedrock AgentCore 原生集成，为代理应用程序提供全面的身份和凭证管理。</p>
<p>AgentCore Identity 解决了 AI 代理部署中的一个根本性挑战：让代理能够在多个服务中安全地访问用户特定数据，同时不牺牲安全性和用户体验。传统方法要么使用广泛的访问凭证而缺乏细粒度控制，要么需要为每次服务集成获取明确的用户同意（这会带来糟糕的用户体验）。AgentCore Identity 通过一个全面的工作流实现零信任安全原则和基于委托的身份验证来解决这一问题。</p>
<h4 data-id="heading-13">Amazon Bedrock AgentCore Identity 涉及的2种身份认证和授权</h4>
<p>入站授权：Inbound Auth 是指验证用户或客户端应用的认证机制，用于控制谁可以访问和调用您的代理或工具。</p>
<p>出站授权：Outbound Auth 是指已通过入站认证的代理，安全访问目标服务的认证机制，使代理能够安全地调用各种外部API、Lambda函数等资源。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cbbedc0df644369b3e12f5658d1ad2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763350819&amp;x-signature=uGkomNMLQfCEz9E%2FoBQbqNovuFo%3D" alt="图7.webp" loading="lazy"/></p>
<p align="center">图7 – Bedrock AgentCore Identity认证与授权架构图</p>
<h4 data-id="heading-14">入站授权</h4>
<p>用户通过其组织的现有身份提供者（如 Auth0、Cognito 或其他 OIDC 兼容系统）进行身份验证，并获得访问令牌或身份令牌。该令牌包含用户身份信息和授权范围，为整个工作流程建立用户的身份上下文。应用程序接收此令牌，并将使用它来授权对代理的请求。</p>
<p>下面以<a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fcognito%2F" target="_blank" title="https://aws.amazon.com/cn/cognito/" ref="nofollow noopener noreferrer">Amazon Cognito</a> 为例，讲解如何配置入站授权。</p>
<p>在开发应用的时候，在代码中可以授权Cognito User Pool里面的用户访问权限。Amazon Cognito 是 Web 和移动的应用程序的身份识别平台。借助 Amazon Cognito，您可以从Cognito用户池、企业目录或者 Google 和 Facebook 等消费者身份提供商提供用户的身份验证和授权。首先创建1个Cognito User Pool，在这个User Pool中创建1个App client，以及1个用户，假设你执行下面的命令通过用户名密码的方式授权用户：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Authenticate User</span>
aws cognito-idp initiate-auth \
--client-id <span class="hljs-string">"<span class="hljs-variable">$CLIENT_ID</span>"</span> \
--auth-flow USER_PASSWORD_AUTH \
--auth-parameters USERNAME=<span class="hljs-string">'testuser'</span>,PASSWORD=<span class="hljs-string">'MyPassword123!'</span> \
--region <span class="hljs-string">"<span class="hljs-variable">$REGION</span>"</span> \
auth.json
</code></pre>
<p>可以得到授权的返回结果，结果中包含JSON Web 令牌（JWT）格式的AccessToken，RefreshToken和IdToken，AccessToken 包含权限范围(scope)，比如”cognito:groups”: [”developers”, “team-alpha”]定义允许哪些组访问，”scope”: ”myApi/profile.read myApi/profile.write myApi/account”用于API访问授权，RefreshToken 用于获取新的Access Token和ID Token，IdToken 包含用户身份信息，用于身份验证。返回的信息类似于：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"eyJraWQiOiJvcHE5UmpBMTFBMWFcLzdoUFdRaUgwRmlDTjlMYm1QbnJQRWM3SVQ1M05XTT0iLCJhbGciOiJSUzI1NiJ9.eyJvcmlnaW5fanRpIjoiZTRkN2M1OWUtM2NjZC00OGFhLWFkN2YtMmY3ZTgzMmEzZDAzIiwic3ViIjoiZDRhODA0ZjgtYTA0MS03MGU0LTY3MmYtNzk2ZWM2M2VlNzQwIiwiYXVkIjoiNWFmNXBvaW8wbG5pa29zbWtnZjQxYjNrODAiLCJldmVudF9pZCI6IjFiNGZiYzA2LWVlMzgtNDBlYi1iNjRhLTA3ZTllNzIzNzVlNiIsInRva2VuX3VzZSI6ImlkIiwiYXV0aF90aW1lIjoxNzUzNzc5MzQ4LCJpc3MiOiJodHRwczpcL1wvY29nbml0by1pZHAudXMtZWFzdC0xLmFtYXpvbmF3cy5jb21cL3VzLWVhc3QtMV9vQTJKTkMxdnUiLCJjb2duaXRvOnVzZXJuYW1lIjoidGVzdHVzZXIiLCJleHAiOjE3NTM3ODI5NDgsImlhdCI6MTc1Mzc3OTM0OCwianRpIjoiNDBiNjEwODMtZmRiZi00YzBmLTk3OTEtOGJmYTJjOGUwNDk1In0.A9wVkmed3aet3Q3mgvSF5-KLcEskBf5JOQnqSuyP4Rv2uz_Q7BhGgDV-AfHiBn9SNI1LI6QxlRp-YqRrh4lyyxsdrQGAH5fIlYvVproslLHlSdq2tPb9klHzPjOpyYTNt3cBCq1WRGiiklfvSM1R-RJ8546IPLP2LN-oEXL-kKNdUpxSLUWSsjuk9kkH1ZkN27NxRtnjzc1KG7MBHJRtVsGUsF8b7m5L1rSYzorbj19j2z5oCHnfZHm8wZkWteEAED2jsjJaRCEwyzqXBgSpnTIy8gYO_tlpwswCpg9dgR1MSwK72OjQvLsf_xubRq2Ykv2RylF4cdF8EuGtLOIb_w"</span>
</code></pre>
<p>如果没有带上Access Token，直接调用AgentCore Runtime的时候将看到一条错误消息：”AccessDeniedException: An error occurred (AccessDeniedException) when calling the InvokeAgentRuntime operation: Agent is configured for a different authorization token type”。这些token短期有效，可以在cognito中配置刷新的时长。并且Amazon Cognito提供托管的登录和注册页面，以及丰富的安全能力，比如要求用户绑定MFA，这样可以避免未授权的人拿到用户名密码伪装成授权用户使用访问权限。</p>
<h4 data-id="heading-15">出站授权</h4>
<p>Amazon Bedrock AgentCore Identity验证对亚马逊云科技 资源、第三方服务或 AgentCore Gateway 目标的访问权限。您可以使用 OAuth 2LO/3LO 或 API 密钥。身份系统简化了管理多种凭证类型的复杂性，同时为身份验证和授权操作提供了统一的接口。</p>
<p>在代码中可以通过调用API：create_api_key_credential_provider，将能够访问第三方工具的API密钥保存到AgentCore Identity的Resource Credential Provider中。当用户发起代理交互时，应用程序会发出请求，代表用户调用 AI 代理。此请求包含用户的身份验证令牌以及代理需要完成的任何必要上下文。应用程序充当代理，将用户的身份验证请求转发到代理基础架构，同时维护用户的身份上下文。</p>
<p>出站授权支持以下三种身份：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae8cf00327ea4926b51152265e454758~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763350819&amp;x-signature=JNjCA8DldrIA2JXBnagAzdH3k2w%3D" alt="出站授权表格.webp" loading="lazy"/></p>
<h4 data-id="heading-16">AgentCore Identity 的安全性</h4>
<ul>
<li>安全的凭证存储，代码中没有硬编码的API密钥，不容易泄漏机密</li>
<li>跨多种资源类型的一致身份验证接口</li>
<li>全面的审计日志以确保安全性和合规性</li>
<li>基于身份和上下文的细粒度访问控制</li>
<li>通过 AgentCore SDK 简化集成</li>
</ul>
<h3 data-id="heading-17">4.2 方案二： 基于Amazon Bedrock Agent构建端到端的细粒度访问控制的AI Agent</h3>
<p>我们为客户提供了一个基于Amazon Bedrock Agents构建AI Agent的细粒度访问控制的<a href="https://link.juejin.cn?target=https%3A%2F%2Fcatalog.workshops.aws%2Fsecuring-genai-app%2Fen-US" target="_blank" title="https://catalog.workshops.aws/securing-genai-app/en-US" ref="nofollow noopener noreferrer">安全实施方案</a>。该方案通过结合多个亚马逊云科技服务，实现了安全可靠的Agentic AI 应用访问控制体系。整个系统设计注重安全性和访问控制，确保用户只能访问其权限范围内的数据，是一个典型的教育领域生成式AI应用安全实践案例。核心内容包括：</p>
<p>1）通过实际的应用场景，以学校助手(SchoolAgent)为例，通过聊天界面让不同角色（如学生、教师、监护人）基于各自权限查询和获取信息。</p>
<p>2）安全控制机制的设计，</p>
<ul>
<li>使用Amazon Cognito进行用户身份验证</li>
<li>通过Amazon Verified Permissions 实施细粒度访问控制</li>
<li>确保AI代理能识别用户身份并只提供授权范围内的数据</li>
</ul>
<p>3）访问权限设计：</p>
<ul>
<li>家长只能访问其子女的数据</li>
<li>教师仅可查看其任教班级的信息</li>
<li>通过分层安全控制确保数据访问安全</li>
</ul>
<p>通过如下参考架构，可以实现完整的身份认证与授权流程。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4802739975eb4fe9b48d2b3dbeb69627~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763350819&amp;x-signature=qILauzuFW1bjeJFi6uB%2FfQF3puE%3D" alt="图8.webp" loading="lazy"/></p>
<p align="center">图8 – 构建端到端身份认证与授权架构</p>
<h3 data-id="heading-18">4.3 方案三： 基于亚马逊云科技中国区服务构建灵活可控全自建方案</h3>
<p>鉴于 Amazon Bedrock AgentCore Identity 和 Bedrock Agents 等专有托管方案在中国区尚未落地，企业可基于亚马逊云科技中国区现有服务，采用完全自建方式灵活实现 Agentic AI 应用系统中的身份认证与授权管理。</p>
<p>本方案充分结合企业自有 SSO/OIDC/AD、JWT Token、自主用户池、API Gateway、IAM、STS、Secrets Manager 及标准 API 调用链，实现全流程零托管、数据可控、最小权限、合规可审计。架构兼容混合云和本地 IT，便于演进和平滑升级。</p>
<p>优势：无需依赖云上托管服务，政策合规性强，权限控制细腻，组件替换灵活，适配大型企业和高度自定义场景。</p>
<p>适用场景：数据高敏感、权限差异大、异构 IT 环境、对接自有 ID 体系或多活部署的 Agent 应用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/528c680913c54edfa53394455ef5c0b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763350819&amp;x-signature=qicc1JSNLUCN2gsnT0%2FkD2KDCPo%3D" alt="图9.webp" loading="lazy"/></p>
<p align="center">图9 – 基于亚马逊云科技中国区服务构建灵活可控全自建方案</p>
<h3 data-id="heading-19">4.4 MCP Server 认证&amp;授权管理</h3>
<p>以下章节介绍使用Amazon AgentCore和Amazon Cognito组件实现Agent代理MCP server认证鉴权的实施示例。</p>
<p>Amazon AgentCore 是一种服务，旨在简化和加速 AI 代理的部署和管理。它提供了一系列工具和 API，帮助开发者快速构建、部署和管理 AI 代理。Amazon AgentCore 支持多种编程语言和框架，使得开发者可以灵活选择最适合自己的工具。</p>
<p>Amazon Cognito 是一种用户身份和访问管理服务，它允许开发者轻松地添加用户注册和登录功能到他们的应用中。Amazon Cognito 提供了两个主要组件：</p>
<ol>
<li>用户池：用户池是一个完全托管的用户目录，可以用于管理和验证用户。用户池支持多种身份验证机制，包括用户名和密码、电子邮件和短信验证码、社交身份提供商（如 Google、Facebook）等。</li>
<li>身份池：身份池允许应用程序获取临时亚马逊云科技凭证，以访问亚马逊云科技资源。身份池可以与用户池集成，为经过身份验证的用户提供访问权限。<br/>
部署 AgentCore MCP Server 的详细步骤：</li>
</ol>
<p>在部署 AgentCore MCP Server 时，我们可以利用 Amazon Cognito 进行用户池和应用客户端的设置，以实现鉴权功能。以下是详细的实现步骤和代码示例：</p>
<ol>
<li>创建 Amazon Cognito 用户池和应用客户端</li>
</ol>
<p>首先，我们需要在亚马逊云科技管理控制台中创建一个 Cognito 用户池和应用客户端。以下是创建用户池和应用客户端的命令示例：</p>
<pre><code class="hljs language-sql" lang="sql">aws cognito<span class="hljs-operator">-</span>idp <span class="hljs-keyword">create</span><span class="hljs-operator">-</span><span class="hljs-keyword">user</span><span class="hljs-operator">-</span>pool <span class="hljs-comment">--pool-name mcp-server-user-pool</span>
aws cognito<span class="hljs-operator">-</span>idp <span class="hljs-keyword">create</span><span class="hljs-operator">-</span><span class="hljs-keyword">user</span><span class="hljs-operator">-</span>pool<span class="hljs-operator">-</span>client <span class="hljs-comment">--user-pool-id &lt;USER_POOL_ID&gt; --client-name mcp-server-app-client</span>
</code></pre>
<p>2.  创建 IAM 角色</p>
<p>为了让 MCP 服务能够与 Cognito 进行交互，我们需要创建一个 IAM 角色，并附加相应的策略。以下是创建 IAM 角色的示例代码：</p>
<pre><code class="hljs language-ini" lang="ini">import boto3

<span class="hljs-attr">client</span> = boto3.client(<span class="hljs-string">'iam'</span>)

<span class="hljs-comment"># 创建 IAM 角色</span>
<span class="hljs-attr">response</span> = client.create_role(
    <span class="hljs-attr">RoleName</span>=<span class="hljs-string">'agentcore-mcp-server-role'</span>,
    <span class="hljs-attr">AssumeRolePolicyDocument</span>=json.dumps({
        "Version": "2012-10-17",
        "Statement": <span class="hljs-section">[
            {
                "Effect": "Allow",
                "Principal": {
                    "Service": "ec2.amazonaws.com"
                },
                "Action": "sts:AssumeRole"
            }
        ]</span>
    })
)

<span class="hljs-comment"># 附加 Cognito 访问策略</span>
client.attach_role_policy(
    <span class="hljs-attr">RoleName</span>=<span class="hljs-string">'agentcore-mcp-server-role'</span>,
    <span class="hljs-attr">PolicyArn</span>=<span class="hljs-string">'arn:aws:iam::aws:policy/AmazonCognitoPowerUser'</span>
)
</code></pre>
<p>3.  配置 AgentCore Runtime</p>
<p>在配置 AgentCore Runtime 时，我们需要指定 Cognito 用户池和应用客户端的信息，以及 IAM 角色的 ARN。以下是配置示例：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">response</span> = agentcore_runtime.configure(
    <span class="hljs-attr">entrypoint</span>=<span class="hljs-string">'mcp_server.fixed.py'</span>,
    <span class="hljs-attr">execution_role_arn</span>=<span class="hljs-string">'arn:aws:iam::687912291502:role/agentcore-mcp-server-auto-role'</span>,
    <span class="hljs-attr">auto_create_ecrs</span>=<span class="hljs-literal">True</span>,
    <span class="hljs-attr">requirements_txt</span>=<span class="hljs-string">'requirements.txt'</span>,
    <span class="hljs-attr">region</span>=<span class="hljs-string">'region'</span>,
    <span class="hljs-attr">authorizer_configuration</span>=auth_config,
    <span class="hljs-attr">protocol</span>=<span class="hljs-string">'MCP'</span>,
    <span class="hljs-attr">agent_name</span>=<span class="hljs-string">'mcp_server_auto'</span>
)
</code></pre>
<p>4.  启动 AgentCore Runtime</p>
<p>最后，我们可以启动 AgentCore Runtime，并通过 Cognito 进行用户认证和鉴权。以下是启动示例代码：</p>
<p>launch_result = agentcore_runtime.launch()</p>
<p>在 AI Agent应用中，MCP Server 的鉴权机制是确保系统安全性和稳定性的关键。通过 Amazon AgentCore 和 Amazon Cognito，我们可以轻松地实现和管理 MCP 服务器的鉴权功能。这不仅提高了系统的安全性，还简化了开发和部署过程，使得开发者可以更专注于 AI 模型和业务逻辑的开发。</p>
<h2 data-id="heading-20">5. 结语</h2>
<p>在Agentic AI应用系统快速发展的今天，身份认证与授权管理已成为构建安全可信AI生态系统的基石。从”AgentSmith”到”MCP Inspector”等安全事件的教训表明，我们必须高度重视AI Agent的身份管理问题。构建安全可信的系统需要遵循最小权限、零信任验证、纵深防御和持续监控等核心设计原则，同时采用阶段化实施策略，从基础身份认证逐步扩展到完整的安全体系。</p>
<p>面对传统身份管理向动态化、智能化和细粒度方向的演进，企业可以通过采用OAuth 2.0、去中心化身份等技术框架，结合<a href="https://link.juejin.cn?target=https%3A%2F%2Fcatalog.workshops.aws%2Fsecuring-genai-app%2Fen-US" target="_blank" title="https://catalog.workshops.aws/securing-genai-app/en-US" ref="nofollow noopener noreferrer">Amazon Bedrock AgentCore Identity </a>等云平台解决方案，有效应对混淆代理人等特有的安全威胁。通过建立确定性的授权机制和安全的身份信息传递通道，确保AI Agent在代表用户执行任务时既保持高效性，又不失安全性。</p>
<p>随着技术的持续成熟和标准化进程的推进，AI Agent身份管理将变得更加智能和自适应。现在正是企业规划和实施AI Agent身份管理系统的最佳时机，唯有建立起完善的身份认证与授权管理体系，才能确保AI Agent在为人类社会创造价值的同时，始终保持在可控和安全的轨道上运行。这不仅是技术发展的必然要求，更是AI技术走向成熟和普及的重要基石。<br/>
<strong>本篇作者</strong><br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c9a6564354e426a9d617e8adb2f6851~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763350819&amp;x-signature=ZEcbvf58xsNIef4RkozS8CIRRy0%3D" alt="作者.webp" loading="lazy"/></p>
<p>关于Agentic AI基础设施的更多实践经验参考，欢迎点击：<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fagentive-ai-infrastructure-practice-series-1" target="_blank" title="https://aws.amazon.com/cn/blogs/china/agentive-ai-infrastructure-practice-series-1" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（一）：Agent应用开发与落地实践思考</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fagentic-ai-sandbox-practice%2F" target="_blank" title="https://aws.amazon.com/cn/blogs/china/agentic-ai-sandbox-practice/" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（二）：专用沙盒环境的必要性与实践方案</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fagentic-ai-infrastructure-deep-practice-experience-thinking-series-three-best-practices-for-agent-memory-module" target="_blank" title="https://aws.amazon.com/cn/blogs/china/agentic-ai-infrastructure-deep-practice-experience-thinking-series-three-best-practices-for-agent-memory-module" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（三）：Agent记忆模块的最佳实践</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fagentic-ai-infrastructure-practice-experience-series-four-mcp-server-from-local" target="_blank" title="https://aws.amazon.com/cn/blogs/china/agentic-ai-infrastructure-practice-experience-series-four-mcp-server-from-local" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（四）：MCP服务器从本地到云端的部署演进</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fagentic-ai-infrastructure-practice-series-5%2F" target="_blank" title="https://aws.amazon.com/cn/blogs/china/agentic-ai-infrastructure-practice-series-5/" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（五）：Agent应用系统中的身份认证与授权管理</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fagent-quality-evaluation%2F" target="_blank" title="https://aws.amazon.com/cn/blogs/china/agent-quality-evaluation/" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（六）：Agent质量评估</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fagentic-ai-infrastructure-practice-series-7%2F" target="_blank" title="https://aws.amazon.com/cn/blogs/china/agentic-ai-infrastructure-practice-series-7/" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（七）：可观测性在Agent应用的挑战与实践</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fcn%2Fblogs%2Fchina%2Fprivacy-and-security-of-agent-applications" target="_blank" title="https://aws.amazon.com/cn/blogs/china/privacy-and-security-of-agent-applications" ref="nofollow noopener noreferrer">Agentic AI基础设施实践经验系列（八）：Agent应用的隐私和安全</a></p>
<p>*前述特定亚马逊云科技生成式人工智能相关的服务目前在亚马逊云科技海外区域可用。亚马逊云科技中国区域相关云服务由西云数据和光环新网运营，具体信息以中国区域官网为准。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cursor在回收团队的实践]]></title>    <link>https://juejin.cn/post/7570500819888439339</link>    <guid>https://juejin.cn/post/7570500819888439339</guid>    <pubDate>2025-11-10T03:52:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570500819888439339" data-draft-id="7569977160276852779" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cursor在回收团队的实践"/> <meta itemprop="keywords" content="Cursor"/> <meta itemprop="datePublished" content="2025-11-10T03:52:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="转转技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/606586148237431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cursor在回收团队的实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/606586148237431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    转转技术团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T03:52:37.000Z" title="Mon Nov 10 2025 03:52:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>最近一段时间，回收团队一直坚持用Cursor来辅助开发，并在AI开发模式上进行了多次迭代。今天，我想和大家分享一些我们在AI编程方面的实践心得。</p>
<p>首先要明确的是，AI编程并不能取代程序员的独立编码能力，也不是说简单配置几个MCP就能让AI的编程能力发生质的飞跃。今天我将重点从实际应用出发，分享一些AI编程的思路与流程优化经验，帮助各位真正的在项目开发中，把AI用起来。</p>
<h2 data-id="heading-1">我们到底能用Cursor干什么</h2>
<p>我一直在思考，作为一个月使用成本超过100块的“权威”工具来说，如果只让他做一些bean的生成，mapper的生成，未免太过于浪费。但是如果直接把需求文档喂给他，生成的代码距离我们的期望又太大。我们总说，想让AI生成符合要求的代码，需要详细的将我们的需求写成提示词告诉AI，但是到底如何才算详细呢？如何才能写出这份详细的提示词呢？</p>
<p>下面是我使用Cursor进行项目开发的三步走：</p>
<ol>
<li>由Cursor帮助开发者拆分项目——初步完成提示词框架</li>
<li>由开发者帮助Cursor理解项目——丰富提示词内容</li>
<li>完成开发后由Cursor帮助开发者进行回归验证</li>
</ol>
<br/>
<h3 data-id="heading-2">一、让cursor帮助你更好的拆分项目</h3>
<p>既然直接生成代码难度太大，我们能不能先尝试让AI做一些更简单的事情，比如分析一下需求文档。</p>
<p>一般来讲，对于一个项目的分析主要分两步：</p>
<ol>
<li>对于项目新流程的分析</li>
<li>对于相关现状的分析</li>
</ol>
<p>上述步骤步完成后我们期望Cursor能够基于需求PRD文档，帮我们总结一份兼容当下系统逻辑的初步的功能分析文档（不需要功能的具体实现方案，只需要确定有哪些功能即可），包括一些实体类、VO对象的定义，接口定义，数据库表定义等等。</p>
<h4 data-id="heading-3">1、针对新流程（PRD文档）的分析</h4>
<p>Cursor可以很好的分析并总结PRD文档的内容，但产品给出的PRD文档中不可避免的会对一些“众所周知”的上下文进行省略，Cursor也因此无法得知项目的全貌，单纯把PRD文档喂给Cursor并不能让他直接生成符合我们期望的代码。</p>
<p>但这不代表我们在这一阶段完全无法让Cursor为我们创造价值。我们可以利用Cursor的分析总结能力，梳理PRD文档中的功能点与要点，加速自己理解项目，并结合自己对prd的理解进行双向验证。避免后期开发时出现与产品理解不符或者遗漏功能点。</p>
<p>使用Cursor读取并分析本次需求PRD文档的内容时，为了不被上下文长度所限制，我们需要让Cursor将他的思考结果进行记录。例如下面的提示词：</p>
<pre><code class="hljs language-ini" lang="ini">https://dashen.zhuanspirit.com/pages/viewpage.action?<span class="hljs-attr">pageId</span>=xxxxxxxx 
提取一下上面链接的文档中的内容。帮我提炼【XXXXX账单】部分相关功能，有哪些需要开发的功能点，注意，我们本次仅需要查询XXXX列表以及查询XXXX流水详情，其余相关功能和组件已经实现完成。
分析你需要拆分出多少个功能点以及接口

在我让你写代码之前不要生成代码，先逐步分析需求，再说明你打算怎么做
将你的思考以md的形式保存在.docs/技术设计.md下
</code></pre>
<blockquote>
<p>也许你的在线PRD文档需要登陆才可查看，这里给出两个解决方案：</p>
<ol>
<li>找到你的本地cookie，让Cursor带着cookie对你的在线文档进行访问</li>
<li>使用mcp，具体方法这里不进行展开</li>
</ol>
</blockquote>
<p>然后，反复与AI进行沟通，明确告诉他我们需要什么，不需要什么，例如下面的提示词。</p>
<pre><code class="hljs">我们不做数据同步与保存相关的工作，从设计方案中剔除，所有的数据已经准备就绪，我们只需要查询就可以了
帮我设计这个接口的查询的参数与返回值
</code></pre>
<br/>
<p>下面是基于Cursor进行PRD文档分析的基本流程：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/153b7c74e3f042a487efe480cc838e0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351557&amp;x-signature=%2BV%2Feyj2gMMJXYNrs%2BPxo%2BkdpoJQ%3D" alt="Cursor辅助确认PRD文档功能点的过程" loading="lazy"/></p>
<p>首先明确一点：不要试图让Cursor来教我们如何做项目，而是让它协助完成每个环节。所以如果觉得自己可以更快更准确的修改文档的某一部分，主动去修改，不要让AI来做。比如，AI帮忙设计了一个实体对象，但是其中部分字段命名不符合我们的业务要求，我们就不要让AI来修改了，直接动手修改md文档。</p>
<p>另外，如果你亲自改动的内容很多，建议下次跟Cursor沟通的时候新开启一个对话框，重新让他读取PRD文档及对应的分析文档，否则Cursor会保留之前生成的记忆，导致你的改动可能不会生效。</p>
<p>下面是此阶段生成的功能分析文档的部分展示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cad7926278946eb98ab687225d1ef9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351557&amp;x-signature=phbq6jfAKDVncGSDsG3orHZC9H4%3D" alt="img" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d701f588f6b74d6aa757431eeafd1267~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351557&amp;x-signature=guqaeK7MweqHyD3xrcqpN%2BN1Whk%3D" alt="Cursor基于PRD文档初步生成的文档" loading="lazy"/></p>
<h4 data-id="heading-4">2、对于目前已有代码的分析，以及影响范围分析</h4>
<p>相比于开发者来说，Cursor会更贴近代码。我们可以在Cursor的协助下更好的完成现有业务流程的梳理。
更具体的讲，我们可以从需求的目标改动点开始，梳理其所属功能和实现方式，包含数据管理、交互流程等等。
这里介绍一下我们常用的Cursor插件：
Mermaid Preview插件，与Markdown Preview Enhanced插件。</p>
<blockquote>
<p>流程图生成插件
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2936d20205f84e8096c5483082f0f7c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351557&amp;x-signature=WhNhktifJKbaS%2BXV%2BkEzB8fqYcA%3D" alt="img" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6c1026715a04c2e9af783feef7551fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351557&amp;x-signature=c5jVMHbT5BU7uYDSapg1APaFJpQ%3D" alt="img" loading="lazy"/></p>
</blockquote>
<p>安装完插件并重启cursor后我们便可以通过如下提示词进行流程图生成了。</p>
<pre><code class="hljs language-arduino" lang="arduino">com.xxx.xxx.xxx.xxx.facade.SxxxxxxxxFacade<span class="hljs-meta">#getxxxxxx</span>
针对该方法帮我生成一个.md的业务流程图
</code></pre>
<br/>
<p>对于复杂的系统流程来说，我们可以基于此种方法生成流程图，辅助确定本次改动的代码的影响范围。</p>
<h3 data-id="heading-5">二、帮助Cursor更好的理解项目，并生成代码</h3>
<p>我们总是希望有一个工具来帮助我们挖掘AI的潜力，让他更好的明白我们的系统，了解我们的业务，例如各种知识库，各种Rule｡即使AI的思维能力可以与真人媲美，我们也很难想象让你身边的某一位经验丰富的同事仅依靠产品文档就可以准确的完成项目开发。项目过程中必然会经历多次沟通,多次方案修正，最终多方达成一致，再进入开发阶断。
同样，在正式进行开发前，我们也需要有一份技术文档来指导Cursor进行开发。<strong>不同于前面需求文档的简单分析，这一部分的分析需要对每一个功能有详细的描述</strong>。我们可以基于之前落地md文档继续进行完善。这一阶段的主要目标是为Cursor补充上下文细节并核验Cursor结论的过程。我们需要针对每一个功能点：</p>
<ol>
<li><strong>调整AI的命名方式与代码生成位置</strong>（可以使用Rule进行简化）。</li>
<li><strong>调整AI使用的工具类与服务类。</strong></li>
<li><strong>调整AI的逻辑细节</strong>（例如调整校验规则，判断顺序等）。</li>
<li><strong>调整AI的业务细节</strong>（优先从PRD文档上节选原文，尝试让Cursor理解。如果PRD文档没有写清业务流程，就自己动手描述流程或者干脆直接让Cursor跳过生成并预留方法，方便后面自己动手补充逻辑）。</li>
</ol>
<p>最终我们得到了这样一份详细描述了业务功能的md文档：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6681742d8fa54dbb8528f5c798412597~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351557&amp;x-signature=ud5L%2BwVmxA3ksQenWshch2Is3rQ%3D" alt="img" loading="lazy"/></p>
<p>如此一来，得到的这份文档实际上是我们与Cursor都能理解，并且达成一致的。我们终于得到了那份可以供我们用作“生成提示词”的功能分析文档，基于这份文档后续Cursor生成的代码也都基本可以满足要求。</p>
<p>下图为使用Cursor生成代码的整体逻辑流程：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f17d9f31e86452ab4bb6a83b6e4a9fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351557&amp;x-signature=wIoB931QkHRBWXsDetZcpDQh7lU%3D" alt="img" loading="lazy"/></p>
<p>需要注意的是，我们每次只就一个功能点进行分析，并且一旦你觉得这个功能点已经相对完善，尽快落地成代码，不要留在一起，让AI最后一起生成。
一方面AI在处理过多的内容时会不可避免的产生偏差，另一方面，如果项目过大，我们也容易忘记一些细节，导致花费额外的时间来进行回忆与验证。</p>
<h3 data-id="heading-6">三、Cursor帮助开发者进行回归验证</h3>
<p>除去开发阶段的辅助作用，Cursor另一大作用体现在开发后的辅助质量保证上。通常体现在以下两个方面：</p>
<ol>
<li>改动影响评估</li>
<li>功能验证</li>
</ol>
<p>为了实现上述能力，我们按照三步走的方式来进行</p>
<h4 data-id="heading-7">1、改动范围整理</h4>
<p>使用下面的命令逐个文件分析当前分支改动点并输出到cr.diff 文件中，随后在md文件末尾进行总结：git diff origin/master  &gt; cr.diff</p>
<h4 data-id="heading-8">2、基本代码审查</h4>
<p>我们可以使用下面的提示词引导Cursor进行基本代码审查：</p>
<pre><code class="hljs language-markdown" lang="markdown">扫描diff 文件中的差异代码。reviwe 的规则如下

<span class="hljs-bullet">1.</span> 方法体行数应少于100行, 不包括空行,和注释
<span class="hljs-bullet">2.</span> 枚举定义需要有两个以上属性, code, name, 并且需要有通过code获取枚举项的方法
<span class="hljs-bullet">3.</span> 接口返回false , 前端是否有对false进行处理 
<span class="hljs-bullet">4.</span> throw 了异常的位置, 一定要打log日志 
<span class="hljs-bullet">5.</span> 所有的public 公有方法都要打印入参log.info日志 
<span class="hljs-bullet">6.</span> 所有的public 公有方法, 结束都要打印结束日志 
<span class="hljs-bullet">7.</span> 所有调用rpc的方法, 都要打印日志
<span class="hljs-bullet">8.</span> 所有方法都要有方法级别的注释
<span class="hljs-bullet">9.</span> try catch异常后, 如果在catch 中又抛出了新创建的异常时, 需要将原异常赋值给新异常
<span class="hljs-bullet">10.</span> 不能调用被标记@Deprecated 的属性或方法或类
<span class="hljs-bullet">11.</span> 定义的常量值, 给出清晰的注释说明用途, 避免硬编码
<span class="hljs-bullet">12.</span> 标注了@transactional的方法要明确回滚异常类型, 对于只读操作要标注只读readOnly=true 提高性能
<span class="hljs-bullet">13.</span> 3次以上字符串拼接使用StringBuilder代替字符串拼接
<span class="hljs-bullet">14.</span> 检查是否存在其他破坏兼容性的改动或逻辑上的错误
<span class="hljs-bullet">15.</span> 检查是否存在循环调用导致的逻辑问题
16、新增的页面提交和支付相关流程要考虑幂等处理
17、接口可能被重复调用和mq消息重复接收场景要考虑并发和事务冲突和数据覆盖，要善用分布式锁
18、针对数据库单一字段的修改，尽可能要精确修改，使用整体对象进行修改
19、是否存在重复代码
20、修改逻辑是否设计到计数系统口径的修改
21、数据交互过程中（数据库和外部调用）的空指针判断和处理
22、状态流转过程和涉及资产损失的部分要对前置状态进行校验
23、涉及数据库和外部事务的接口，要保证整体事务的一致性，无法保证的要有补偿机制
24、涉及异步回调的场景，要考虑中间态的处理
25、不允许把配置规则交给运营同学
26、返回的list类型，要给定默认值，不能给null
27、主键必须设置自增或者使用分布式id
28、数据库表是否建立了索引
29、异常场景要打印报警，尽可能优先多打印
遍历所有规则, 一个规则一个规则的去检查增量代码的规范性, 每个规则进行Review时, 使用独立的上下文, 最后归纳所有的Review结果.
输出违反规则的文件位置, 在我说可以修改之前不要修改文件
</code></pre>
<h4 data-id="heading-9">3、功能辅助验证</h4>
<p>在完成代码生成与初步审查后，我们进入功能验证阶段。此时可利用Cursor分析代码变更，自动生成自测用例清单。通过提示词引导Cursor结合业务逻辑、接口输入输出及异常分支，输出覆盖核心路径、边界条件和错误处理的测试场景。</p>
<p>例如：</p>
<pre><code class="hljs">基于当前代码变更，列出需要自测的功能点和边界情况，包括正常流程、异常输入、状态校验等，输出为表格形式，包含用例编号、场景描述、预期结果。
</code></pre>
<p>该过程不仅是测试准备，更是对整体逻辑的再确认。通过Cursor辅助验证，提升自测完整性，减少后期回归成本，确保交付质量。</p>
<h2 data-id="heading-10">小结</h2>
<p>至此，本文分享了回收团队在AI编程实践中的经验，重点介绍了如何高效使用Cursor辅助开发。通过分阶段协作——从需求分析，现状梳理到技术设计，代码生成，再到测试验证。</p>
<p>AI时代，开发者的核心竞争力正从“掌握知识”转向“提出问题”。工具如Cursor并非替代开发人员，而是通过人机协同，提升需求理解、技术设计与代码质量的效率。我们要以专业积累构建清晰上下文，引导AI完成拆解、分析、生成与验证，最终实现高效、高质量的开发闭环。</p>
<blockquote>
<p>关于作者，黄敬乾，侠客汇Java开发工程师。</p>
</blockquote>
<blockquote>
<p>转转研发中心及业界小伙伴们的技术学习交流平台，定期分享一线的实战经验及业界前沿的技术话题。
关注公众号「转转技术」（综合性）、「大转转FE」（专注于FE）、「转转QA」（专注于QA），更多干货实践，欢迎交流分享~</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我用AI重构了一段500行的屎山代码，这是我的Prompt和思考过程]]></title>    <link>https://juejin.cn/post/7570630923710054452</link>    <guid>https://juejin.cn/post/7570630923710054452</guid>    <pubDate>2025-11-10T04:06:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570630923710054452" data-draft-id="7570533058840739875" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我用AI重构了一段500行的屎山代码，这是我的Prompt和思考过程"/> <meta itemprop="keywords" content="前端,JavaScript,架构"/> <meta itemprop="datePublished" content="2025-11-10T04:06:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ErpanOmer"/> <meta itemprop="url" content="https://juejin.cn/user/3878732754331096"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我用AI重构了一段500行的屎山代码，这是我的Prompt和思考过程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3878732754331096/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ErpanOmer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T04:06:06.000Z" title="Mon Nov 10 2025 04:06:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb98623d8769476daf7d1403c737a111~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763352366&amp;x-signature=Hvk6BXnS9P%2BYX5MAILrp0denCkI%3D" alt="image.png" loading="lazy"/></p>
<p>大家好，我来了🙂。</p>
<p>我们团队，维护着一个有5年历史的史诗级中后台项目😖。在这座屎山里，有一个叫<code>handleOrderSubmit.js</code>的文件。</p>
<p>可以下载瞧一瞧 有多屎👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpub-e8cc0cb9ebf94a2386b76f4ac3ac6ad2.r2.dev%2FhandleOrderSubmit.js" target="_blank" title="https://pub-e8cc0cb9ebf94a2386b76f4ac3ac6ad2.r2.dev/handleOrderSubmit.js" ref="nofollow noopener noreferrer">handleOrderSubmit.js</a></p>
<p>它是一个<strong>长达500多行</strong>的React <code>useEffect</code> 钩子函数（是的，你没看错，一个<code>useEffect</code>）。</p>
<p>它混合了订单数据的<strong>本地校验</strong>、<strong>价格计算</strong>、<strong>优惠券应用</strong>、<strong>API请求</strong>、<strong>全局状态更新</strong>、以及<strong>错误弹窗处理</strong>... 所有的逻辑，都塞在一个函数里，用<code>if/else</code>和<code>try/catch</code>层层嵌套。</p>
<p><strong>没人敢动它😖。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40160288790c4322a54fa4ec39e1a6ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763352366&amp;x-signature=p9brzeAHElowFo7kT0xLwhguEpE%3D" alt="本事试试看.gif" loading="lazy"/></p>
<p>每次产品经理提一个小需求，比如在提交订单时，增加一种新的优惠券类型，我们整个团队的表情都像被雷劈了。因为我们知道，改这个函数，要么加班一周，要么就等着P0级事故。</p>
<p>上周，产品经理要求我们在这个函数里，加入一个全新的风控逻辑。</p>
<p>我评估了一下，手动重构，至少需要一个资深工程师一周的时间，而且风险极大。</p>
<p>我受够了。我决定，把这个烫手的任务，扔给我的实习生——<strong>AI</strong>（我用的是GPT-5 mini，穷😂）。</p>
<p>这篇文章，就是我人机协作，啃下这块硬骨头的完整复盘，大家继续看。</p>
<hr/>
<h4 data-id="heading-0"><strong>我不能直接说重构它</strong></h4>
<p>我犯的第一个错误，是直接把500行代码贴给AI，然后说：<strong>帮我重构这段代码</strong>。</p>
<p>AI很听话，它给我的，是一段看起来更整洁的代码——它把<code>if/else</code>换成了<code>switch</code>，提了几个变量... <strong>这不叫重构，这叫重新排版</strong>，毫无意义。</p>
<p>我很快意识到：<strong>AI是一个能力超强、但没有灵魂的执行者。我，作为开发者，必须给它提供一个清晰的方案。</strong></p>
<p>于是，我制定了一个<strong>五步重构法</strong>。</p>
<hr/>
<h4 data-id="heading-1"><strong>我的Prompt和思考</strong></h4>
<p>我的核心思想是：<strong>AI负责执行，我负责决策。</strong> 我要像一个指挥家一样，一步一步地引导AI，把这500行的代码，拆解成高内聚、低耦合的模块。</p>
<h5 data-id="heading-2"><strong>第一步：先让AI读懂屎山</strong></h5>
<p>我不能上来就让AI改。我得先确认，它和我对这段代码的理解，在一个频道上。</p>
<p><strong>Prompt：</strong></p>
<blockquote>
<p>你是一个资深的React架构师。请分析下面这段500行的<code>useEffect</code>代码。</p>
<ol>
<li><strong>告诉我它做了几件主要的事情？（职责分析）</strong></li>
<li><strong>找出所有的副作用</strong>（比如API请求、<code>localStorage</code>操作、全局状态更新）。</li>
<li><strong>找出所有的纯逻辑</strong>（比如数据校验、价格计算）。</li>
<li><strong>评价它的可维护性和可测试性</strong>。</li>
</ol>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35d5a1e7897d4611b2e6063d63081384~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763352366&amp;x-signature=aXLE5rLPbGHmYg3X5B3MvGtaHaM%3D" alt="image.png" loading="lazy"/></p>
<p>GPT的回答，给了我一个惊喜。它清晰地列出了：</p>
<ol>
<li><strong>职责</strong>：它承担了至少5个职责：表单校验、价格计算、库存检查、创建订单、处理UI反馈。</li>
<li><strong>副作用</strong>：<code>api.post(...)</code>, <code>setLoading(true)</code>, <code>showToast(...)</code>...</li>
<li><strong>纯逻辑</strong>：<code>validateForm(...)</code>, <code>calculateTotalPrice(...)</code>...</li>
<li><strong>评价</strong>：可维护性极低，单一职责原则被严重违反，几乎不可测试。</li>
</ol>
<p>很好，AI看懂了！我们就可以可以开始了😁。</p>
<h5 data-id="heading-3"><strong>第二步：先分离纯逻辑代码</strong></h5>
<p>这是最关键的一步。我要把计算和动作分开。</p>
<p><strong>Prompt：</strong></p>
<blockquote>
<p>非常好。现在，请你<strong>只针对纯逻辑部分</strong>（表单校验、价格计算）进行重构。</p>
<ol>
<li>把这些逻辑，从原函数中<strong>提取</strong>出来，变成<strong>独立的、可导出的纯函数</strong>。</li>
<li>这些函数必须是纯的：<strong>不能有任何副作用</strong>（不能调用<code>api</code>或<code>setLoading</code>）。</li>
<li><strong>使用TypeScript</strong>，为这些新函数的入参和返回值，提供清晰的类型定义。</li>
</ol>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d384affa5b6b488db2870ea7a7f2e350~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763352366&amp;x-signature=yC3uRhUdQgDBQbR2mBv1aKp6ZuM%3D" alt="image.png" loading="lazy"/></p>
<p>AI立刻唰唰唰地给了我几个文件：</p>
<p><code>validate.ts</code>:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">validateOrder</span>(<span class="hljs-params">formData: OrderForm</span>): <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span> {
  <span class="hljs-keyword">if</span> (!formData.<span class="hljs-property">user</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'用户信息不能为空'</span>;
  <span class="hljs-keyword">if</span> (formData.<span class="hljs-property">items</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'商品不能为空'</span>;
  <span class="hljs-comment">// ... 10 more rules</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p><code>calculator.ts</code>:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateTotalPrice</span>(<span class="hljs-params">items: Item[], coupon: Coupon</span>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">let</span> total = items.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, item</span>) =&gt;</span> sum + item.<span class="hljs-property">price</span> * item.<span class="hljs-property">quantity</span>, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">if</span> (coupon.<span class="hljs-property">type</span> === <span class="hljs-string">'PERCENT'</span>) {
    total *= (<span class="hljs-number">1</span> - coupon.<span class="hljs-property">value</span> / <span class="hljs-number">100</span>);
  }
  <span class="hljs-comment">// ... 20 more rules</span>
  <span class="hljs-keyword">return</span> total;
}
</code></pre>
<h5 data-id="heading-4"><strong>第三步：让AI为自己的代码做测试</strong></h5>
<p>我怎么知道AI提炼的逻辑，是对的还是错的？
<strong>答案：让它自己写单元测试来证明。</strong></p>
<p><strong>Prompt：</strong></p>
<blockquote>
<p>你现在是一个QA工程师。请使用<code>Vitest</code>，为你刚才提取的<code>validateOrder</code>和<code>calculateTotalPrice</code>这两个函数，<strong>编写全面的单元测试用例</strong>。
必须覆盖所有边界情况，包括正常、异常、和边缘值。</p>
</blockquote>
<p>AI再次给了我惊喜。它生成的测试用例，比我手写的还要全：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// calculator.test.ts</span>
<span class="hljs-keyword">import</span> { describe, it, expect } <span class="hljs-keyword">from</span> <span class="hljs-string">'vitest'</span>;
<span class="hljs-keyword">import</span> { calculateTotalPrice } <span class="hljs-keyword">from</span> <span class="hljs-string">'./calculator'</span>;

<span class="hljs-title function_">describe</span>(<span class="hljs-string">'calculateTotalPrice'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should return 0 for empty cart'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">calculateTotalPrice</span>([], <span class="hljs-literal">null</span>)).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">0</span>);
  });
  
  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should apply percent coupon'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> items = [{ <span class="hljs-attr">price</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">1</span> }];
    <span class="hljs-keyword">const</span> coupon = { <span class="hljs-attr">type</span>: <span class="hljs-string">'PERCENT'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">10</span> };
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">calculateTotalPrice</span>(items, coupon)).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">90</span>);
  });
  <span class="hljs-comment">// ... 省略更多</span>
});
</code></pre>
<p>我把这些测试用例跑了一遍，<strong>全部通过</strong>。我现在信心大增😁。</p>
<h5 data-id="heading-5"><strong>第四步：重写协调层</strong></h5>
<p>现在，纯逻辑已经被分离并验证了。原来的500行屎山，只剩下副作用和流程控制代码了。是时候重写它了。</p>
<p><strong>Prompt：</strong></p>
<blockquote>
<p>干得漂亮。现在，我们来重构那个<strong>原始的<code>useEffect</code>函数</strong>。</p>
<ol>
<li>它现在唯一的职责是<strong>协调</strong>。</li>
<li><strong>调用</strong>我们刚才创建的<code>validateOrder</code>和<code>calculateTotalPrice</code>纯函数。</li>
<li>把所有的副作用（API请求、<code>setLoading</code>、<code>showToast</code>）<strong>清晰地编排</strong>起来。</li>
<li><strong>使用<code>async/await</code></strong>，让异步流程更清晰，用<code>try/catch</code>处理错误。</li>
</ol>
</blockquote>
<p>这次，AI给我的，是一个只有<strong>30行</strong>左右的、清晰的流程代码：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 重构后的 useEffect</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">submitOrder</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 1. 协调：验证 (纯)</span>
      <span class="hljs-keyword">const</span> errorMsg = <span class="hljs-title function_">validateOrder</span>(formData);
      <span class="hljs-keyword">if</span> (errorMsg) {
        <span class="hljs-title function_">showToast</span>(errorMsg);
        <span class="hljs-keyword">return</span>;
      }
      
      <span class="hljs-comment">// 2. 协调：计算 (纯)</span>
      <span class="hljs-keyword">const</span> totalPrice = <span class="hljs-title function_">calculateTotalPrice</span>(formData.<span class="hljs-property">items</span>, formData.<span class="hljs-property">coupon</span>);

      <span class="hljs-comment">// 3. 协调：副作用（不纯）</span>
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/order/submit'</span>, { ...formData, totalPrice });
      
      <span class="hljs-comment">// 4. 协调：响应（不纯）</span>
      <span class="hljs-keyword">if</span> (result.<span class="hljs-property">code</span> === <span class="hljs-number">200</span>) {
        <span class="hljs-title function_">showToast</span>(<span class="hljs-string">'订单提交成功！'</span>);
        router.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/success'</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">showToast</span>(result.<span class="hljs-property">message</span>);
      }
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-title function_">showToast</span>(err.<span class="hljs-property">message</span>);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
    }
  };

  <span class="hljs-keyword">if</span> (isSubmitting) { <span class="hljs-comment">// 假设一个触发条件</span>
    <span class="hljs-title function_">submitOrder</span>();
    <span class="hljs-title function_">setIsSubmitting</span>(<span class="hljs-literal">false</span>);
  }
}, [isSubmitting, formData <span class="hljs-comment">/* ...其他依赖 */</span>]);
</code></pre>
<h5 data-id="heading-6"><strong>第五步：最后守卫工作，加入新功能</strong></h5>
<p>别忘了，我重构的目的，是为了加风控这个新功能。</p>
<p><strong>Prompt：</strong></p>
<blockquote>
<p>最后一步。请在API请求之前，加入一个风控检查的逻辑（调用<code>riskControl.check(...)</code>）。这是一个异步函数，如果检查不通过，它会抛出一个错误。</p>
</blockquote>
<p>AI在第2步和第3步之间，加了几行代码，完美收工。</p>
<hr/>
<p>这次重构，我总共花了大概5个小时，而不是原计划的一周。</p>
<p>总觉得 AI 不会淘汰会写代码的工程师。</p>
<p>只会降维打击那些只会堆砌代码的工程师。</p>
<p>那段500行的屎山，在过去，是我的噩梦；现在，有了AI的帮助，它变成了我的靶场。</p>
<p>这种感觉，真爽🙌。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring是Java语境下的“最优解”的原因与启示]]></title>    <link>https://juejin.cn/post/7570295366479708196</link>    <guid>https://juejin.cn/post/7570295366479708196</guid>    <pubDate>2025-11-10T03:13:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570295366479708196" data-draft-id="7570162686580883498" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring是Java语境下的“最优解”的原因与启示"/> <meta itemprop="keywords" content="Java,Spring,Node.js"/> <meta itemprop="datePublished" content="2025-11-10T03:13:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Juchecar"/> <meta itemprop="url" content="https://juejin.cn/user/284133851925070"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring是Java语境下的“最优解”的原因与启示
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/284133851925070/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Juchecar
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T03:13:09.000Z" title="Mon Nov 10 2025 03:13:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>对于非Java生态系统（如 Node.js、Python、Go）的开发者而言，Spring框架及其理念确实显得非常复杂，甚至有些“过时”或“不合时宜”。</strong></p>
<p>这并非Spring本身不好，而是因为<strong>不同语言生态系统的哲学、要解决的核心问题和演进路径完全不同</strong>。评价Spring在非Java语境下的复杂性，需要跳出Java的世界观。</p>
<hr/>
<h3 data-id="heading-0">核心原因：Spring是“Java生态困境”的终极答案</h3>
<p>要理解Spring的复杂性，首先要理解它诞生是为了解决什么问题。Spring是Java生态系统中一系列历史遗留问题的“集大成式解决方案”。</p>
<ol>
<li><strong>Java语言的刻板与冗长</strong>：Java是静态强类型语言，早期没有闭包、函数式编程等特性，缺乏动态性。这使得在Java中做任何事都需要大量的样板代码。Spring通过依赖注入和AOP等机制，试图<strong>弥补语言本身的灵活性不足</strong>。</li>
<li><strong>XML配置的“历史包袱”</strong>：在Spring诞生和成长的时期，XML是配置的事实标准。虽然现在Spring已全面转向注解和Java配置，但其底层设计哲学和概念体系仍带有那个时代的烙印。</li>
<li><strong>“一站式”解决方案的雄心</strong>：Spring的目标是成为一个“平台”，提供从依赖注入、事务管理、数据访问、安全到微服务的一整套解决方案。这种“全家桶”模式本身就带来了复杂性，因为你必须学习它的一整套概念。</li>
</ol>
<hr/>
<h3 data-id="heading-1">对比其他语言：原生优雅与“刚好够用”</h3>
<p>现在，让我们站在Node.js、Python或Go开发者的视角来看Spring。</p>
<h4 data-id="heading-2">1. Node.js / JavaScript 世界： “一切皆模块”</h4>
<ul>
<li><strong>依赖注入？</strong>：Node.js的模块系统（<code>require</code>/<code>import</code>）本身就是一种极其简单自然的依赖管理。你需要一个数据库连接？直接 <code>const db = require('./db');</code>。这种“手动”组装在轻量级应用中比配置一个Spring Bean要直观得多。</li>
<li><strong>配置</strong>：环境变量 + JSON/YAML配置文件是绝对主流，简单直接。</li>
<li><strong>事务管理？</strong>：没有像Spring那样声明式事务的“魔法”，但通过<code>async/await</code>和简单的数据库连接池/事务API，开发者可以清晰地控制事务边界，逻辑更透明。</li>
<li><strong>结论</strong>：对于JS开发者，Spring的IoC容器像是在为一个已经解决了的问题提供复杂的解决方案。他们会觉得：“我只需要一个轻便的Express/Koa框架，为什么要把我的应用塞进一个庞大的Spring Boot容器里？”</li>
</ul>
<h4 data-id="heading-3">2. Python 世界： “显式优于隐式”</h4>
<ul>
<li><strong>哲学冲突</strong>：Python之禅有一条是“显式优于隐式”。Spring的依赖注入和AOP，尤其是基于注解的自动装配，在Python开发者看来是典型的“隐式魔法”。代码的依赖关系不再一目了然，而是被框架在运行时动态织入。</li>
<li><strong>轻量级框架</strong>：Flask、FastAPI等框架的核心极其精简。FastAPI利用Python的类型提示和装饰器，以极少的代码提供了依赖注入、数据验证和API文档生成，感觉上比Spring Boot更“聪明”、更轻快。</li>
<li><strong>结论</strong>：Python开发者享受语言的动态性和表达力，他们认为Spring的很多复杂性是为了绕过Java语言的限制而产生的，在Python世界里是<strong>不必要的</strong>。</li>
</ul>
<h4 data-id="heading-4">3. Go 世界： “简单就是美”</h4>
<ul>
<li><strong>极简主义</strong>：Go语言的设计哲学就是极简和显式。没有泛型（早期）、没有继承、没有异常，鼓励组合而非复杂的抽象。</li>
<li><strong>原生工具链</strong>：Go的标准库非常强大，用标准库和少量第三方库就能构建出高性能的Web服务。依赖管理就是简单的 <code>import</code> 和结构体组合。</li>
<li><strong>对“魔法”的厌恶</strong>：Go社区极度反感Spring那样的“运行时魔法”和复杂的反射机制。他们追求编译期确定性和代码的可预测性。</li>
<li><strong>结论</strong>：对Go开发者来说，Spring代表的是一套他们<strong>刻意避免</strong>的复杂抽象层。他们会认为用Go写一个Web服务就像拼乐高，而用Spring像是在操作一个精密的但难以理解的黑盒仪器。</li>
</ul>
<hr/>
<h3 data-id="heading-5">综合评价：复杂性从何而来？</h3>
<p>Spring的复杂性对于非Java开发者而言，主要来源于：</p>
<ol>
<li><strong>抽象层级过高</strong>：IoC容器、Bean生命周期、AOP代理……这些概念创造了一个平行于语言本身的“运行时环境”。你需要先理解Spring的“世界观”，才能写好代码。</li>
<li><strong>配置决策疲劳</strong>：<code>@Autowired</code> vs <code>@Resource</code>？ <code>@Component</code> vs <code>@Service</code>？ 配置应该放在 <code>application.properties</code> 还是用 <code>@Configuration</code> 类？大量的选择和“魔法”规则需要学习和记忆。</li>
<li><strong>启动成本与认知负荷</strong>：一个简单的Spring Boot应用启动也需要几秒钟，背后是大量的自动配置、类路径扫描和Bean初始化。对于习惯了几百毫秒启动的Node.js或Go应用来说，这是难以接受的。</li>
<li><strong>“杀鸡用牛刀”</strong>：很多项目根本用不到Spring提供的全部能力。对于一个简单的REST API，FastAPI或Gin框架能提供90%的功能，而复杂度和学习曲线只有Spring Boot的10%。</li>
</ol>
<h3 data-id="heading-6">结论与启示</h3>
<ul>
<li><strong>Spring是Java语境下的“最优解”</strong>：在Java世界里，Spring通过引入一定的复杂性，极大地降低了构建大型、复杂、企业级应用的总体成本。它是权衡之后的胜利者。</li>
<li><strong>但对于其他语言，它往往是“错误答案”</strong>：不同语言有自己解决问題的哲学和工具链。将Spring的理念生搬硬套到其他语言，无异于削足适履。</li>
<li><strong>启示</strong>：作为开发者，我们的目标不应该是学习某个特定的框架（如Spring），而是<strong>理解框架背后要解决的通用问题</strong>（如依赖管理、配置、事务、安全）。
<ul>
<li>当你使用Node.js时，你会自然地用模块系统和中间件来解决。</li>
<li>当你使用Python时，你会选择Flask/FastAPI和它们的插件生态。</li>
<li>当你使用Go时，你会欣赏标准库和显式组合带来的简单性。</li>
</ul>
</li>
</ul>
<p><strong>最终，优秀的开发者理解“上下文”。他们知道在Java企业级应用的上下文中，Spring的复杂性是合理的代价；而在一个需要快速迭代的微服务或脚本的上下文中，更轻量级、更符合语言哲学的工具才是最佳选择。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uniapp页面路由]]></title>    <link>https://juejin.cn/post/7570604028632481827</link>    <guid>https://juejin.cn/post/7570604028632481827</guid>    <pubDate>2025-11-10T02:26:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570604028632481827" data-draft-id="7570394530316206080" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uniapp页面路由"/> <meta itemprop="keywords" content="Vue.js,uni-app"/> <meta itemprop="datePublished" content="2025-11-10T02:26:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户971417181427"/> <meta itemprop="url" content="https://juejin.cn/user/2200564916558794"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uniapp页面路由
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2200564916558794/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户971417181427
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T02:26:28.000Z" title="Mon Nov 10 2025 02:26:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">uni-app 路由详解：从入门到精通</h2>
<blockquote>
<p>本文基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Fapi%2Frouter.html" target="_blank" title="https://uniapp.dcloud.net.cn/api/router.html" ref="nofollow noopener noreferrer">uni-app 页面路由文档</a> 整理，详细介绍了 uni-app 中的路由 API 使用方法和最佳实践。</p>
</blockquote>
<h3 data-id="heading-1">目录</h3>
<ul>
<li><a href="#%E6%A6%82%E8%BF%B0" title="#%E6%A6%82%E8%BF%B0">概述</a></li>
<li><a href="#%E8%B7%AF%E7%94%B1-api-%E8%AF%A6%E8%A7%A3" title="#%E8%B7%AF%E7%94%B1-api-%E8%AF%A6%E8%A7%A3">路由 API 详解</a>
<ul>
<li><a href="#uninavigateto---%E4%BF%9D%E7%95%99%E5%BD%93%E5%89%8D%E9%A1%B5%E9%9D%A2%E8%B7%B3%E8%BD%AC" title="#uninavigateto---%E4%BF%9D%E7%95%99%E5%BD%93%E5%89%8D%E9%A1%B5%E9%9D%A2%E8%B7%B3%E8%BD%AC">uni.navigateTo - 保留当前页面跳转</a></li>
<li><a href="#uniredirectto---%E5%85%B3%E9%97%AD%E5%BD%93%E5%89%8D%E9%A1%B5%E9%9D%A2%E8%B7%B3%E8%BD%AC" title="#uniredirectto---%E5%85%B3%E9%97%AD%E5%BD%93%E5%89%8D%E9%A1%B5%E9%9D%A2%E8%B7%B3%E8%BD%AC">uni.redirectTo - 关闭当前页面跳转</a></li>
<li><a href="#unirelaunch---%E5%85%B3%E9%97%AD%E6%89%80%E6%9C%89%E9%A1%B5%E9%9D%A2%E8%B7%B3%E8%BD%AC" title="#unirelaunch---%E5%85%B3%E9%97%AD%E6%89%80%E6%9C%89%E9%A1%B5%E9%9D%A2%E8%B7%B3%E8%BD%AC">uni.reLaunch - 关闭所有页面跳转</a></li>
<li><a href="#uniswitchtab---%E8%B7%B3%E8%BD%AC%E5%88%B0-tabbar-%E9%A1%B5%E9%9D%A2" title="#uniswitchtab---%E8%B7%B3%E8%BD%AC%E5%88%B0-tabbar-%E9%A1%B5%E9%9D%A2">uni.switchTab - 跳转到 tabBar 页面</a></li>
<li><a href="#uninavigateback---%E8%BF%94%E5%9B%9E%E4%B8%8A%E4%B8%80%E9%A1%B5" title="#uninavigateback---%E8%BF%94%E5%9B%9E%E4%B8%8A%E4%B8%80%E9%A1%B5">uni.navigateBack - 返回上一页</a></li>
</ul>
</li>
<li><a href="#%E9%A1%B5%E9%9D%A2%E9%97%B4%E9%80%9A%E4%BF%A1---eventchannel" title="#%E9%A1%B5%E9%9D%A2%E9%97%B4%E9%80%9A%E4%BF%A1---eventchannel">页面间通信 - EventChannel</a></li>
<li><a href="#%E7%AA%97%E5%8F%A3%E5%8A%A8%E7%94%BB%E9%85%8D%E7%BD%AE" title="#%E7%AA%97%E5%8F%A3%E5%8A%A8%E7%94%BB%E9%85%8D%E7%BD%AE">窗口动画配置</a></li>
<li><a href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%E5%92%8C%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5" title="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%E5%92%8C%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">注意事项和最佳实践</a></li>
<li><a href="#%E6%80%BB%E7%BB%93" title="#%E6%80%BB%E7%BB%93">总结</a></li>
</ul>
<h3 data-id="heading-2">概述</h3>
<p>uni-app 提供了丰富的路由 API，用于实现页面之间的跳转和导航。根据不同的使用场景，可以选择不同的路由方法。理解这些 API 的区别和使用场景，对于开发高质量的 uni-app 应用至关重要。</p>
<h3 data-id="heading-3">路由 API 详解</h3>
<h4 data-id="heading-4">uni.navigateTo - 保留当前页面跳转</h4>
<p><strong>功能说明</strong>：保留当前页面，跳转到应用内的某个页面。使用 <code>uni.navigateBack</code> 可以返回到原页面。</p>
<p><strong>适用场景</strong>：</p>
<ul>
<li>需要返回的页面跳转</li>
<li>详情页、表单页等需要保留历史记录的页面</li>
</ul>
<p><strong>参数说明</strong>：</p>





















































<table><thead><tr><th>参数</th><th>类型</th><th>必填</th><th>说明</th></tr></thead><tbody><tr><td>url</td><td>String</td><td>是</td><td>需要跳转的应用内非 tabBar 的页面的路径，路径后可以带参数</td></tr><tr><td>animationType</td><td>String</td><td>否</td><td>窗口显示的动画效果（仅 App 支持）</td></tr><tr><td>animationDuration</td><td>Number</td><td>否</td><td>窗口动画持续时间，单位为 ms（仅 App 支持）</td></tr><tr><td>events</td><td>Object</td><td>否</td><td>页面间通信接口，用于监听被打开页面发送到当前页面的数据（2.8.9+）</td></tr><tr><td>success</td><td>Function</td><td>否</td><td>接口调用成功的回调函数</td></tr><tr><td>fail</td><td>Function</td><td>否</td><td>接口调用失败的回调函数</td></tr><tr><td>complete</td><td>Function</td><td>否</td><td>接口调用结束的回调函数</td></tr></tbody></table>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在起始页面跳转到 test.vue 页面并传递参数</span>
uni.<span class="hljs-title function_">navigateTo</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">'test?id=1&amp;name=uniapp'</span>,
  <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'跳转成功'</span>, res)
  },
  <span class="hljs-attr">fail</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'跳转失败'</span>, err)
  }
})

<span class="hljs-comment">// 在 test.vue 页面接收参数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">onLoad</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">option</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(option.<span class="hljs-property">id</span>)    <span class="hljs-comment">// 输出: 1</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(option.<span class="hljs-property">name</span>)  <span class="hljs-comment">// 输出: uniapp</span>
  }
}
</code></pre>
<p><strong>传递复杂参数</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传递对象参数（需要序列化）</span>
<span class="hljs-keyword">const</span> data = {
  <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">'uniapp'</span>,
  <span class="hljs-attr">list</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
}

uni.<span class="hljs-title function_">navigateTo</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">`test?data=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-built_in">JSON</span>.stringify(data))}</span>`</span>
})

<span class="hljs-comment">// 接收参数</span>
<span class="hljs-title function_">onLoad</span>(<span class="hljs-function">(<span class="hljs-params">options</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-built_in">decodeURIComponent</span>(options.<span class="hljs-property">data</span>))
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data)
})
</code></pre>
<h4 data-id="heading-5">uni.redirectTo - 关闭当前页面跳转</h4>
<p><strong>功能说明</strong>：关闭当前页面，跳转到应用内的某个页面。</p>
<p><strong>适用场景</strong>：</p>
<ul>
<li>登录成功后跳转到首页</li>
<li>不需要返回的页面跳转</li>
<li>替换当前页面</li>
</ul>
<p><strong>参数说明</strong>：与 <code>uni.navigateTo</code> 相同（除了不支持 <code>events</code> 参数）</p>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 登录成功后跳转到首页</span>
uni.<span class="hljs-title function_">redirectTo</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/index/index'</span>
})
</code></pre>
<p><strong>与 navigateTo 的区别</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// A 页面</span>
uni.<span class="hljs-title function_">navigateTo</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">'B?id=1'</span>
})

<span class="hljs-comment">// B 页面</span>
uni.<span class="hljs-title function_">navigateTo</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">'C?id=1'</span>
})

<span class="hljs-comment">// 在 C 页面内 navigateBack，将返回 B 页面</span>
<span class="hljs-comment">// 但如果 B 页面使用的是 redirectTo，则返回 A 页面</span>
</code></pre>
<h4 data-id="heading-6">uni.reLaunch - 关闭所有页面跳转</h4>
<p><strong>功能说明</strong>：关闭所有页面，打开到应用内的某个页面。</p>
<p><strong>适用场景</strong>：</p>
<ul>
<li>退出登录后跳转到登录页</li>
<li>需要清空页面栈的场景</li>
<li>重新初始化应用状态</li>
</ul>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 退出登录</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">logout</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 清除用户信息</span>
  uni.<span class="hljs-title function_">removeStorageSync</span>(<span class="hljs-string">'token'</span>)
  
  <span class="hljs-comment">// 关闭所有页面，跳转到登录页</span>
  uni.<span class="hljs-title function_">reLaunch</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/login/login'</span>
  })
}
</code></pre>
<h4 data-id="heading-7">uni.switchTab - 跳转到 tabBar 页面</h4>
<p><strong>功能说明</strong>：跳转到 tabBar 页面，并关闭其他所有非 tabBar 页面。</p>
<p><strong>适用场景</strong>：</p>
<ul>
<li>切换到底部导航栏页面</li>
<li>从非 tabBar 页面返回到 tabBar 页面</li>
</ul>
<p><strong>重要提示</strong>：</p>
<ul>
<li>只能跳转到 <code>pages.json</code> 中配置的 <code>tabBar</code> 页面</li>
<li>跳转的 url 必须是在 <code>tabBar</code> 中定义的路径</li>
</ul>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 跳转到首页（tabBar 页面）</span>
uni.<span class="hljs-title function_">switchTab</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/index/index'</span>
})
</code></pre>
<p><strong>pages.json 配置示例</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"tabBar"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"list"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"pagePath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pages/index/index"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"首页"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"pagePath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pages/user/user"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我的"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-8">uni.navigateBack - 返回上一页</h4>
<p><strong>功能说明</strong>：关闭当前页面，返回上一页面或多级页面。</p>
<p><strong>参数说明</strong>：</p>





























<table><thead><tr><th>参数</th><th>类型</th><th>必填</th><th>说明</th></tr></thead><tbody><tr><td>delta</td><td>Number</td><td>否</td><td>返回的页面数，如果 delta 大于现有页面数，则返回到首页。默认值为 1</td></tr><tr><td>animationType</td><td>String</td><td>否</td><td>窗口关闭的动画效果（仅 App 支持）</td></tr><tr><td>animationDuration</td><td>Number</td><td>否</td><td>窗口关闭动画的持续时间，单位为 ms（仅 App 支持）</td></tr></tbody></table>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 返回上一页</span>
uni.<span class="hljs-title function_">navigateBack</span>()

<span class="hljs-comment">// 返回上两页</span>
uni.<span class="hljs-title function_">navigateBack</span>({
  <span class="hljs-attr">delta</span>: <span class="hljs-number">2</span>
})

<span class="hljs-comment">// 带动画效果返回（仅 App）</span>
uni.<span class="hljs-title function_">navigateBack</span>({
  <span class="hljs-attr">delta</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">animationType</span>: <span class="hljs-string">'pop-out'</span>,
  <span class="hljs-attr">animationDuration</span>: <span class="hljs-number">300</span>
})
</code></pre>
<p><strong>实际应用场景</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// A 页面 -&gt; B 页面 -&gt; C 页面</span>
<span class="hljs-comment">// 在 C 页面内 navigateBack，将返回 B 页面</span>
uni.<span class="hljs-title function_">navigateBack</span>({
  <span class="hljs-attr">delta</span>: <span class="hljs-number">1</span>
})

<span class="hljs-comment">// 如果想直接返回 A 页面</span>
uni.<span class="hljs-title function_">navigateBack</span>({
  <span class="hljs-attr">delta</span>: <span class="hljs-number">2</span>
})
</code></pre>
<h3 data-id="heading-9">页面间通信 - EventChannel</h3>
<blockquote>
<p>2.8.9+ 支持，HarmonyOS Next 不支持</p>
</blockquote>
<p><code>EventChannel</code> 提供了页面间事件通信的能力，可以在页面跳转时建立通信通道。</p>
<h4 data-id="heading-10">EventChannel 方法</h4>
<h5 data-id="heading-11">emit - 触发事件</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在目标页面触发事件</span>
eventChannel.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'eventName'</span>, { <span class="hljs-attr">data</span>: <span class="hljs-string">'value'</span> })
</code></pre>
<h5 data-id="heading-12">on - 持续监听事件</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在源页面监听事件</span>
eventChannel.<span class="hljs-title function_">on</span>(<span class="hljs-string">'eventName'</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'接收到数据:'</span>, data)
})
</code></pre>
<h5 data-id="heading-13">once - 监听事件一次</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 只监听一次，触发后失效</span>
eventChannel.<span class="hljs-title function_">once</span>(<span class="hljs-string">'eventName'</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'接收到数据:'</span>, data)
})
</code></pre>
<h5 data-id="heading-14">off - 取消监听</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 取消所有监听</span>
eventChannel.<span class="hljs-title function_">off</span>(<span class="hljs-string">'eventName'</span>)

<span class="hljs-comment">// 取消指定的监听函数</span>
eventChannel.<span class="hljs-title function_">off</span>(<span class="hljs-string">'eventName'</span>, fn)
</code></pre>
<h4 data-id="heading-15">完整示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 源页面 - 发送数据</span>
uni.<span class="hljs-title function_">navigateTo</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/detail/detail'</span>,
  <span class="hljs-attr">events</span>: {
    <span class="hljs-comment">// 监听目标页面发送的事件</span>
    <span class="hljs-attr">acceptDataFromDetail</span>: <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'从详情页接收到的数据:'</span>, data)
    }
  },
  <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
    <span class="hljs-comment">// 通过 eventChannel 向目标页面发送数据</span>
    res.<span class="hljs-property">eventChannel</span>.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'acceptDataFromOpenerPage'</span>, {
      <span class="hljs-attr">data</span>: <span class="hljs-string">'来自源页面的数据'</span>
    })
  }
})

<span class="hljs-comment">// 目标页面 - 接收和发送数据</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">onLoad</span>(<span class="hljs-params">options, context</span>) {
    <span class="hljs-comment">// 接收源页面发送的数据</span>
    context.<span class="hljs-property">eventChannel</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'acceptDataFromOpenerPage'</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'接收到源页面的数据:'</span>, data)
    })
    
    <span class="hljs-comment">// 向源页面发送数据</span>
    context.<span class="hljs-property">eventChannel</span>.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'acceptDataFromDetail'</span>, {
      <span class="hljs-attr">data</span>: <span class="hljs-string">'来自详情页的数据'</span>
    })
  }
}
</code></pre>
<h3 data-id="heading-16">窗口动画配置</h3>
<blockquote>
<p>本功能仅 App 支持。小程序自身不支持自定义动画。</p>
</blockquote>
<p>uni-app 支持在 API、组件、pages.json 中配置窗口动画，优先级为：<strong>API &gt; 组件 &gt; pages.json</strong>。</p>
<h4 data-id="heading-17">API 配置</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 跳转时配置动画</span>
uni.<span class="hljs-title function_">navigateTo</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">'../test/test'</span>,
  <span class="hljs-attr">animationType</span>: <span class="hljs-string">'pop-in'</span>,
  <span class="hljs-attr">animationDuration</span>: <span class="hljs-number">200</span>
})

<span class="hljs-comment">// 返回时配置动画</span>
uni.<span class="hljs-title function_">navigateBack</span>({
  <span class="hljs-attr">delta</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">animationType</span>: <span class="hljs-string">'pop-out'</span>,
  <span class="hljs-attr">animationDuration</span>: <span class="hljs-number">200</span>
})
</code></pre>
<h4 data-id="heading-18">组件配置</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">navigator</span> 
  <span class="hljs-attr">animation-type</span>=<span class="hljs-string">"pop-in"</span> 
  <span class="hljs-attr">animation-duration</span>=<span class="hljs-string">"300"</span> 
  <span class="hljs-attr">url</span>=<span class="hljs-string">"../test/test"</span>&gt;</span>
  跳转
<span class="hljs-tag">&lt;/<span class="hljs-name">navigator</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">navigator</span> 
  <span class="hljs-attr">animation-type</span>=<span class="hljs-string">"pop-out"</span> 
  <span class="hljs-attr">animation-duration</span>=<span class="hljs-string">"300"</span> 
  <span class="hljs-attr">open-type</span>=<span class="hljs-string">"navigateBack"</span>&gt;</span>
  返回
<span class="hljs-tag">&lt;/<span class="hljs-name">navigator</span>&gt;</span>
</code></pre>
<h4 data-id="heading-19">pages.json 配置</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"app-plus"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"animationType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fade-in"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"animationDuration"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">300</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-20">支持的动画类型</h4>























































<table><thead><tr><th>显示动画</th><th>关闭动画</th><th>说明</th></tr></thead><tbody><tr><td>slide-in-right</td><td>slide-out-right</td><td>新窗体从右侧进入</td></tr><tr><td>slide-in-left</td><td>slide-out-left</td><td>新窗体从左侧进入</td></tr><tr><td>slide-in-top</td><td>slide-out-top</td><td>新窗体从顶部进入</td></tr><tr><td>slide-in-bottom</td><td>slide-out-bottom</td><td>新窗体从底部进入</td></tr><tr><td>pop-in</td><td>pop-out</td><td>新窗体从左侧进入，且老窗体被挤压而出</td></tr><tr><td>fade-in</td><td>fade-out</td><td>新窗体从透明到不透明逐渐显示</td></tr><tr><td>zoom-out</td><td>zoom-in</td><td>新窗体从小到大缩放显示</td></tr><tr><td>zoom-fade-out</td><td>zoom-fade-in</td><td>新窗体从小到大逐渐放大并且从透明到不透明逐渐显示</td></tr><tr><td>none</td><td>none</td><td>无动画</td></tr></tbody></table>
<h3 data-id="heading-21">注意事项和最佳实践</h3>
<h4 data-id="heading-22">1. 路由限制</h4>
<ul>
<li><code>navigateTo</code>、<code>redirectTo</code> 只能打开非 tabBar 页面</li>
<li><code>switchTab</code> 只能打开 tabBar 页面</li>
<li><code>reLaunch</code> 可以打开任意页面</li>
</ul>
<h4 data-id="heading-23">2. 页面栈管理</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 注意页面栈的层级</span>
<span class="hljs-comment">// A 页面</span>
uni.<span class="hljs-title function_">navigateTo</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">'B?id=1'</span>
})

<span class="hljs-comment">// B 页面</span>
uni.<span class="hljs-title function_">navigateTo</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">'C?id=1'</span>
})

<span class="hljs-comment">// 在 C 页面内 navigateBack，将返回 B 页面</span>
<span class="hljs-comment">// 如果 B 页面使用的是 redirectTo，则返回 A 页面</span>
</code></pre>
<h4 data-id="heading-24">3. H5 端特殊处理</h4>
<p>H5 端页面刷新之后页面栈会消失，此时 <code>navigateBack</code> 不能返回。如果需要返回，可以使用 <code>history.back()</code> 导航到浏览器的其他历史记录。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// #ifdef H5</span>
<span class="hljs-keyword">if</span> (<span class="hljs-title function_">getCurrentPages</span>().<span class="hljs-property">length</span> === <span class="hljs-number">1</span>) {
  history.<span class="hljs-title function_">back</span>()
} <span class="hljs-keyword">else</span> {
  uni.<span class="hljs-title function_">navigateBack</span>()
}
<span class="hljs-comment">// #endif</span>
</code></pre>
<h4 data-id="heading-25">4. 不能在首页 onReady 之前进行页面跳转</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">onReady</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 正确的做法：在 onReady 之后跳转</span>
    uni.<span class="hljs-title function_">navigateTo</span>({
      <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/detail/detail'</span>
    })
  }
}
</code></pre>
<h4 data-id="heading-26">5. 参数传递最佳实践</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 推荐：简单参数使用 URL 参数</span>
uni.<span class="hljs-title function_">navigateTo</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">`/pages/detail/detail?id=<span class="hljs-subst">${id}</span>&amp;name=<span class="hljs-subst">${name}</span>`</span>
})

<span class="hljs-comment">// ✅ 推荐：复杂对象使用 JSON 序列化</span>
<span class="hljs-keyword">const</span> complexData = {
  <span class="hljs-attr">user</span>: { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'test'</span> },
  <span class="hljs-attr">list</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
}
uni.<span class="hljs-title function_">navigateTo</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">`/pages/detail/detail?data=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-built_in">JSON</span>.stringify(complexData))}</span>`</span>
})

<span class="hljs-comment">// ✅ 推荐：使用 EventChannel 进行页面间通信</span>
uni.<span class="hljs-title function_">navigateTo</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/detail/detail'</span>,
  <span class="hljs-attr">events</span>: {
    <span class="hljs-attr">updateData</span>: <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
      <span class="hljs-comment">// 处理数据更新</span>
    }
  }
})
</code></pre>
<h4 data-id="heading-27">6. 避免过度使用 navigateTo 导致页面栈问题</h4>
<p><strong>常见问题场景</strong>：</p>
<p>我遇到的问题：在开发中习惯性地使用 <code>uni.navigateTo</code> 进行所有页面跳转，这会导致页面栈管理出现问题。</p>
<p><strong>问题示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误示例：表单页 -&gt; 列表页 -&gt; 详情页</span>
<span class="hljs-comment">// 表单页填写完成</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">submitForm</span> = (<span class="hljs-params"/>) =&gt; {
  uni.<span class="hljs-title function_">navigateTo</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/list/list'</span>  <span class="hljs-comment">// 问题：应该使用 redirectTo</span>
  })
}

<span class="hljs-comment">// 列表页点击 item</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">goToDetail</span> = (<span class="hljs-params">id</span>) =&gt; {
  uni.<span class="hljs-title function_">navigateTo</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">`/pages/detail/detail?id=<span class="hljs-subst">${id}</span>`</span>  <span class="hljs-comment">// 问题：页面栈过深</span>
  })
}
</code></pre>
<p><strong>问题分析</strong>：</p>
<ol>
<li>表单页提交后，通常不需要再返回表单页，应该使用 <code>redirectTo</code> 替换当前页面</li>
<li>页面栈过深会导致返回逻辑混乱，用户体验不佳</li>
<li>可能导致内存占用过高（页面栈中保留过多页面）</li>
</ol>
<p><strong>正确的解决方案</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 正确示例 1：表单页提交后替换为列表页</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">submitForm</span> = (<span class="hljs-params"/>) =&gt; {
  uni.<span class="hljs-title function_">redirectTo</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/list/list'</span>  <span class="hljs-comment">// 关闭表单页，打开列表页</span>
  })
}

<span class="hljs-comment">// ✅ 正确示例 2：如果列表页是 tabBar 页面</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">submitForm</span> = (<span class="hljs-params"/>) =&gt; {
  uni.<span class="hljs-title function_">switchTab</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/list/list'</span>  <span class="hljs-comment">// 切换到 tabBar 页面</span>
  })
}

<span class="hljs-comment">// ✅ 正确示例 3：详情页需要返回列表页（使用 navigateTo）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">goToDetail</span> = (<span class="hljs-params">id</span>) =&gt; {
  uni.<span class="hljs-title function_">navigateTo</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">`/pages/detail/detail?id=<span class="hljs-subst">${id}</span>`</span>  <span class="hljs-comment">// 可以返回列表页</span>
  })
}

<span class="hljs-comment">// ✅ 正确示例 4：详情页需要直接返回表单页</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">goToDetail</span> = (<span class="hljs-params">id</span>) =&gt; {
  uni.<span class="hljs-title function_">navigateTo</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">`/pages/detail/detail?id=<span class="hljs-subst">${id}</span>`</span>
  })
}

<span class="hljs-comment">// 在详情页返回时，如果需要跳过列表页</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">goBack</span> = (<span class="hljs-params"/>) =&gt; {
  uni.<span class="hljs-title function_">navigateBack</span>({
    <span class="hljs-attr">delta</span>: <span class="hljs-number">2</span>  <span class="hljs-comment">// 返回上两页（跳过列表页）</span>
  })
}
</code></pre>
<p><strong>最佳实践建议</strong>：</p>
<ol>
<li><strong>表单提交后</strong> → 使用 <code>redirectTo</code> 或 <code>switchTab</code>（如果是 tabBar 页面）</li>
<li><strong>需要返回的页面</strong> → 使用 <code>navigateTo</code>（如详情页、编辑页）</li>
<li><strong>不需要返回的页面</strong> → 使用 <code>redirectTo</code>（如登录后跳转首页）</li>
<li><strong>清空页面栈</strong> → 使用 <code>reLaunch</code>（如退出登录）</li>
<li><strong>控制页面栈深度</strong> → 避免超过 10 层页面栈，及时使用 <code>redirectTo</code> 替换不需要返回的页面</li>
</ol>
<p><strong>页面栈深度检查</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 检查当前页面栈深度</span>
<span class="hljs-keyword">const</span> pages = <span class="hljs-title function_">getCurrentPages</span>()
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'当前页面栈深度:'</span>, pages.<span class="hljs-property">length</span>)

<span class="hljs-comment">// 如果页面栈过深，考虑使用 redirectTo</span>
<span class="hljs-keyword">if</span> (pages.<span class="hljs-property">length</span> &gt;= <span class="hljs-number">10</span>) {
  uni.<span class="hljs-title function_">redirectTo</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/target/target'</span>
  })
} <span class="hljs-keyword">else</span> {
  uni.<span class="hljs-title function_">navigateTo</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/target/target'</span>
  })
}
</code></pre>
<h3 data-id="heading-28">总结</h3>
<p>uni-app 的路由系统提供了灵活且强大的页面导航能力。正确理解和使用这些 API，可以帮助我们：</p>
<ol>
<li><strong>优化用户体验</strong>：选择合适的跳转方式和动画效果</li>
<li><strong>管理页面栈</strong>：合理控制页面层级，避免内存问题</li>
<li><strong>实现页面通信</strong>：通过 EventChannel 实现页面间的数据传递</li>
<li><strong>提升开发效率</strong>：使用合适的路由方法简化代码逻辑</li>
</ol>
<p>在实际开发中，建议根据具体场景选择合适的路由方法：</p>
<ul>
<li><strong>需要返回</strong> → 使用 <code>navigateTo</code></li>
<li><strong>不需要返回</strong> → 使用 <code>redirectTo</code></li>
<li><strong>清空所有页面</strong> → 使用 <code>reLaunch</code></li>
<li><strong>跳转 tabBar</strong> → 使用 <code>switchTab</code></li>
<li><strong>返回上一页</strong> → 使用 <code>navigateBack</code></li>
</ul>
<p>希望本文能帮助你更好地理解和使用 uni-app 的路由系统！</p>
<hr/>
<p><strong>参考文档</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Fapi%2Frouter.html" target="_blank" title="https://uniapp.dcloud.net.cn/api/router.html" ref="nofollow noopener noreferrer">uni-app 页面路由文档</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《uni-app跨平台开发完全指南》- 06 - 页面路由与导航]]></title>    <link>https://juejin.cn/post/7570191839594053695</link>    <guid>https://juejin.cn/post/7570191839594053695</guid>    <pubDate>2025-11-10T02:44:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570191839594053695" data-draft-id="7569946369991262271" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《uni-app跨平台开发完全指南》- 06 - 页面路由与导航"/> <meta itemprop="keywords" content="前端,uni-app,Vue.js"/> <meta itemprop="datePublished" content="2025-11-10T02:44:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QuantumLeap丶"/> <meta itemprop="url" content="https://juejin.cn/user/1767603104125197"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《uni-app跨平台开发完全指南》- 06 - 页面路由与导航
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1767603104125197/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QuantumLeap丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T02:44:41.000Z" title="Mon Nov 10 2025 02:44:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">深入理解页面路由与导航</h2>
<blockquote>
<p>如果把组件比作应用的“血肉”，那么路由导航就是应用的“筋骨”。他定义了用户在应用中的跳转路径，决定了应用的流程和用户体验。比如当你点击商品列表中的一件商品，它是如何平滑地跳转到商品详情页的？当你完成订单支付后，又是如何一步步返回首页的？这背后的一切，都离不开一个核心机制——<strong>路由与导航</strong>。</p>
</blockquote>
<p><strong>本篇学习路径：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[页面路由与导航] --&gt; B[页面栈管理原理]
    A --&gt; C[路由跳转方式对比]
    A --&gt; D[传参与接收参数]
    A --&gt; E[导航栏自定义配置]

    B --&gt; B1[栈数据结构&lt;br&gt;LIFO后进先出]
    B --&gt; B2[getCurrentPages&lt;br&gt;获取页面栈实例]

    C --&gt; C1[navigateTo&lt;br&gt;保留当前页面跳转]
    C --&gt; C2[redirectTo&lt;br&gt;关闭当前页面跳转]
    C --&gt; C3[switchTab&lt;br&gt;跳转tabBar页面]
    C --&gt; C4[reLaunch&lt;br&gt;关闭所有页面跳转]
    C --&gt; C5[navigateBack&lt;br&gt;返回上一页面]

    D --&gt; D1[URL拼接传参&lt;br&gt;?key=value&amp;key2=value2]
    D --&gt; D2[onLoad生命周期接收&lt;br&gt;options参数对象]

    E --&gt; E1[pages.json全局配置&lt;br&gt;navigationBarTitleText等]
    E --&gt; E2[页面级配置&lt;br&gt;覆盖全局配置]
    E --&gt; E3[动态修改&lt;br&gt;setNavigationBarTitle]

    %% 连接关系
    B2 -.-&gt; C1
    B2 -.-&gt; C5
    D1 -.-&gt; C1
    D1 -.-&gt; C2
    D1 -.-&gt; C3
    D1 -.-&gt; C4
    E3 -.-&gt; D2

    %% 样式定义
    classDef root fill:#1a2a6c,color:#fff,stroke:#1a2a6c,stroke-width:2px
    classDef level1 fill:#b21f1f,color:#fff,stroke:#b21f1f
    classDef level2 fill:#fdbb2d,color:#333,stroke:#fdbb2d
    classDef level3 fill:#4CAF50,color:#fff,stroke:#4CAF50
    
    class A root
    class B,C,D,E level1
    class B1,B2,C1,C2,C3,C4,C5,D1,D2,E1,E2,E3 level2
</code></pre>
<hr/>
<h3 data-id="heading-1">一、 应用导航的底层逻辑：页面栈管理</h3>
<p>在深入各种跳转API之前，我们必须先理解一个核心概念——<strong>页面栈（Page Stack）</strong>。这是后面所讲内容的基础。</p>
<h4 data-id="heading-2">1.1 什么是页面栈？</h4>
<p>之前讲解Flutter时已经提到了，页面栈就好比一摞书。</p>
<ul>
<li><strong>新打开一本书（页面）</strong>，你就把它<strong>压（Push）</strong> 在这摞书的最上面。</li>
<li>你想看下面那本书，就得把最上面这本<strong>拿掉（Pop）</strong>，才能看到它。</li>
</ul>
<p>在uni-app中，这个“放书”和“拿书”的过程，就是由页面栈来管理的。它是一个遵循 <strong>“后进先出（LIFO - Last In, First Out）”</strong> 原则的数据结构。</p>
<ul>
<li><strong>压栈（Push）</strong>：每当使用类似 <code>uni.navigateTo</code> 的方法打开一个新页面时，这个新页面就会被压入栈顶，成为<strong>活动页面（Active Page）</strong>，展示给用户。</li>
<li><strong>出栈（Pop）</strong>：每当用户点击左上角的返回按钮或调用 <code>uni.navigateBack</code> 方法时，栈顶的页面就会被弹出，此时，下面的页面就会成为新的活动页面，呈现给用户。</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    subgraph A [初始状态]
        direction TB
        subgraph StackA [页面栈]
            A1[页面A]:::top
        end
        StateA[用户正 viewing 页面A]
    end

    A --&gt;|用户执行 uni.navigateTo&lt;br&gt;跳转到 页面B| B

    subgraph B [navigateTo 后]
        direction TB
        subgraph StackB [页面栈]
            B1[页面B]:::top
            B2[页面A]
        end
        StateB[用户正 viewing 页面B]
    end

    B --&gt;|用户执行 uni.navigateTo&lt;br&gt;跳转到 页面C| C

    subgraph C [再次 navigateTo 后]
        direction TB
        subgraph StackC [页面栈]
            C1[页面C]:::top
            C2[页面B]
            C3[页面A]
        end
        StateC[用户正 viewing 页面C]
    end

    C --&gt;|用户点击返回按钮&lt;br&gt;或执行 uni.navigateBack| D

    subgraph D [navigateBack 后]
        direction TB
        subgraph StackD [页面栈]
            D1[页面B]:::top
            D2[页面A]
        end
        StateD[用户正 viewing 页面B&lt;br&gt;页面C已被销毁]
    end

    classDef top fill:#e1f5fe;
</code></pre>
<p><strong>一个简单的例子：</strong>
<code>首页（Index）</code> -&gt; <code>商品列表（List）</code> -&gt; <code>商品详情（Detail）</code></p>
<p>这个过程的栈变化是：</p>
<ol>
<li>启动App：栈 = <code>[Index]</code></li>
<li>从首页跳转到列表页：栈 = <code>[Index, List]</code> （List被Push入栈）</li>
<li>从列表页跳转到详情页：栈 = <code>[Index, List, Detail]</code> （Detail被Push入栈）</li>
<li>从详情页返回：栈 = <code>[Index, List]</code> （Detail被Pop出栈）</li>
<li>再次返回：栈 = <code>[Index]</code> （List被Pop出栈）</li>
</ol>
<h4 data-id="heading-3">1.2 如何获取和管理页面栈？</h4>
<p>uni-app 提供了一个全局的 <strong><code>getCurrentPages()</code></strong> 方法来获取当前页面栈的实例数组。</p>
<p>这个数组：</p>
<ul>
<li><strong>第一个元素</strong>是栈底页面（通常是应用的首页）。</li>
<li><strong>最后一个元素</strong>是栈顶页面（当前展示给用户的页面）。</li>
</ul>
<p><strong>在任何页面中，你都可以这样获取栈信息：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在商品详情页（Detail.vue）的 methods 中</span>
<span class="hljs-title function_">checkPageStack</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 获取当前页面栈的实例数组</span>
  <span class="hljs-keyword">const</span> pages = <span class="hljs-title function_">getCurrentPages</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'当前页面栈：'</span>, pages);

  <span class="hljs-comment">// 获取栈顶页面实例</span>
  <span class="hljs-keyword">const</span> currentPage = pages[pages.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'当前页面实例：'</span>, currentPage);

  <span class="hljs-comment">// 获取栈底页面实例（一般来说是首页）</span>
  <span class="hljs-keyword">const</span> firstPage = pages[<span class="hljs-number">0</span>];
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'首页实例：'</span>, firstPage);

  <span class="hljs-comment">// 甚至可以获取上一个页面的实例，并直接调用其方法或数据</span>
  <span class="hljs-keyword">const</span> prevPage = pages[pages.<span class="hljs-property">length</span> - <span class="hljs-number">2</span>]; <span class="hljs-comment">// 上一个页面</span>
  <span class="hljs-keyword">if</span> (prevPage) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'上一个页面：'</span>, prevPage);
    <span class="hljs-comment">// 注意：这是一种页面间通信的方式，但需谨慎使用，确保prevPage存在且结构稳定</span>
    <span class="hljs-comment">// prevPage.someData = '来自详情页的数据'; // 直接修改上一个页面的数据</span>
    <span class="hljs-comment">// prevPage.someMethod(); // 直接调用上一个页面的方法</span>
  }
}
</code></pre>
<p><strong><code>getCurrentPages()</code> 的应用场景：</strong></p>
<ul>
<li><strong>场景1：在任意页面快速返回首页。</strong>
假设你在一个很深的页面层级（比如<code>首页-&gt;分类-&gt;商品列表-&gt;商品详情-&gt;订单确认-&gt;支付结果</code>），想提供一个“一键回首页”的按钮。
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">goHome</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 获取页面栈</span>
  <span class="hljs-keyword">const</span> pages = <span class="hljs-title function_">getCurrentPages</span>();
  <span class="hljs-comment">// 如果栈长度大于1，说明不在首页，可以返回</span>
  <span class="hljs-keyword">if</span> (pages.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span>) {
    <span class="hljs-comment">// uni.reLaunch 会关闭所有页面，打开首页</span>
    uni.<span class="hljs-title function_">reLaunch</span>({
      <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/index/index'</span>
    });
  } <span class="hljs-keyword">else</span> {
    uni.<span class="hljs-title function_">showToast</span>({
      <span class="hljs-attr">title</span>: <span class="hljs-string">'已经在首页了'</span>,
      <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span>
    });
  }
}
</code></pre>
</li>
<li><strong>场景2：跨页面直接通信。</strong>
从详情页返回列表页时，直接刷新列表页的数据。
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在详情页（Detail.vue）</span>
<span class="hljs-title function_">saveAndBack</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 获取上一个页面（列表页）的实例</span>
  <span class="hljs-keyword">const</span> pages = <span class="hljs-title function_">getCurrentPages</span>();
  <span class="hljs-keyword">const</span> listPage = pages[pages.<span class="hljs-property">length</span> - <span class="hljs-number">2</span>];
  <span class="hljs-comment">// 调用列表页定义的刷新数据方法</span>
  <span class="hljs-keyword">if</span> (listPage &amp;&amp; listPage.<span class="hljs-property">refreshList</span>) {
    listPage.<span class="hljs-title function_">refreshList</span>(); 
  }
  <span class="hljs-comment">// 返回</span>
  uni.<span class="hljs-title function_">navigateBack</span>();
}
</code></pre>
</li>
</ul>
<blockquote>
<p><strong>注意</strong>：直接通过页面实例操作其他页面的数据和方法虽然强大，但耦合性较高，需要你非常清楚页面栈的结构。在复杂的项目中，更推荐使用 <strong>Vuex（状态管理）</strong> 或 <strong>全局事件总线（Global Event Bus）</strong> 来进行解耦的页面通信。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">二、 路由跳转方式</h3>
<p>uni-app 提供了5种核心的路由跳转API，它们对应着不同的页面栈操作和业务场景。选对了API，用户体验才能流畅自然。</p>









































<table><thead><tr><th align="left">方法</th><th align="left">作用</th><th align="left">页面栈变化</th><th align="left">适用场景</th></tr></thead><tbody><tr><td align="left"><code>uni.navigateTo</code></td><td align="left">保留当前页面，跳转到新页面</td><td align="left"><strong>Push</strong>新页面</td><td align="left">最常用的跳转，如列表-&gt;详情</td></tr><tr><td align="left"><code>uni.redirectTo</code></td><td align="left">关闭当前页面，跳转到新页面</td><td align="left"><strong>Replace</strong>当前页面</td><td align="left">中断当前流程，如登录页跳首页</td></tr><tr><td align="left"><code>uni.reLaunch</code></td><td align="left">关闭所有页面，打开新页面</td><td align="left">关闭所有旧页面，<strong>Open</strong>新页面</td><td align="left">应用重启，如切换用户身份</td></tr><tr><td align="left"><code>uni.switchTab</code></td><td align="left">跳转到 tabBar 页面</td><td align="left">关闭所有非tabBar页面</td><td align="left">切换底部导航</td></tr><tr><td align="left"><code>uni.navigateBack</code></td><td align="left">返回上一页面或多步</td><td align="left"><strong>Pop</strong>出一个或多个页面</td><td align="left">返回上一级或首页</td></tr></tbody></table>
<p>下面我们通过代码来详细讲述。</p>
<h4 data-id="heading-5">2.1 <code>uni.navigateTo</code></h4>
<p>这是你<strong>最常用</strong>的跳转方式。它会在页面栈中新增一个记录，原页面会被保留。</p>
<p><strong>特点：</strong></p>
<ul>
<li>新页面从右侧滑入屏幕。</li>
<li>原页面保留在内存中，不会销毁。</li>
<li>左上角自动出现“返回”箭头。</li>
</ul>
<p><strong>具体代码示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在列表页（List.vue）中跳转到详情页（Detail.vue）</span>
<span class="hljs-title function_">goToDetail</span>(<span class="hljs-params">productId</span>) {
  <span class="hljs-comment">// 使用 uni.navigateTo 进行跳转</span>
  uni.<span class="hljs-title function_">navigateTo</span>({
    <span class="hljs-comment">// 目标页面的路径，支持传递参数</span>
    <span class="hljs-attr">url</span>: <span class="hljs-string">`/pages/detail/detail?id=<span class="hljs-subst">${productId}</span>&amp;name=test`</span>,
    <span class="hljs-comment">// 跳转成功回调</span>
    <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'跳转成功！'</span>, res);
    },
    <span class="hljs-comment">// 跳转失败回调</span>
    <span class="hljs-attr">fail</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'跳转失败：'</span>, err);
      uni.<span class="hljs-title function_">showToast</span>({
        <span class="hljs-attr">title</span>: <span class="hljs-string">'跳转失败，请重试'</span>,
        <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span>
      });
    },
    <span class="hljs-comment">// 跳转结束的回调</span>
    <span class="hljs-attr">complete</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'跳转动作完成，无论成功还是失败都会调用'</span>);
    }
  });
}
</code></pre>
<p><strong>对应的页面栈变化过程图解：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    Start[列表页 List] --&gt;|执行&lt;br&gt;uni.navigateTo| Action[将详情页 Detail Push 入栈]
    Action --&gt; Result[栈变为: Index, List, Detail]
    Result --&gt; View[用户看到 Detail 页&lt;br&gt;List 被保留在栈中]
</code></pre>
<blockquote>
<p><strong>避坑</strong>：<code>navigateTo</code> 只能用于跳转到<strong>非 tabBar 页面</strong>。跳转tabBar页面请使用 <code>uni.switchTab</code>。</p>
</blockquote>
<h4 data-id="heading-6">2.2 <code>uni.redirectTo</code></h4>
<p>有时，你希望用户跳转到新页面后，不能再返回原页面。这时就需要 <code>redirectTo</code>。它用新页面<strong>替换</strong>当前页面，当前页面会被销毁。</p>
<p><strong>特点：</strong></p>
<ul>
<li>当前页面被关闭（出栈）。</li>
<li>新页面在当前页的位置打开。</li>
<li>左上角<strong>不会</strong>出现指向原页面的返回箭头。</li>
</ul>
<p><strong>具体代码示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在 splash 页或登录页，应用启动后判断用户状态</span>
<span class="hljs-title function_">onLoad</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 检查用户是否已登录</span>
  <span class="hljs-keyword">const</span> isLoggedIn = <span class="hljs-title function_">checkLoginStatus</span>(); <span class="hljs-comment">// 假设的检查方法</span>

  <span class="hljs-keyword">if</span> (isLoggedIn) {
    <span class="hljs-comment">// 如果已登录，直接重定向到首页，并且不能返回到这个splash页</span>
    uni.<span class="hljs-title function_">redirectTo</span>({
      <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/index/index'</span>
    });
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 如果未登录，跳转到登录页</span>
    uni.<span class="hljs-title function_">navigateTo</span>({
      <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/login/login'</span>
    });
  }
}

<span class="hljs-comment">// 在登录页（Login.vue），登录成功后</span>
<span class="hljs-title function_">handleLoginSuccess</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 登录成功后，用首页替换掉登录页，用户无法再返回到登录页</span>
  uni.<span class="hljs-title function_">redirectTo</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/index/index'</span>
  });
}
</code></pre>
<p><strong>对应的页面栈变化：</strong></p>
<ul>
<li>原栈：<code>[Splash]</code></li>
<li>执行 <code>redirectTo(Home)</code> 后，新栈：<code>[Home]</code> （Splash被替换掉了）</li>
</ul>
<h4 data-id="heading-7">2.3 <code>uni.reLaunch</code></h4>
<p>这个API会关闭所有已打开的页面，然后打开一个新的页面。相当于重启了一次应用。</p>
<p><strong>特点：</strong></p>
<ul>
<li><strong>所有页面栈都被清空</strong>。</li>
<li>然后打开指定的新页面。</li>
<li>适用于需要完全重置导航状态的场景。</li>
</ul>
<p><strong>具体代码示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 场景1：在深页面路径中，提供“返回首页”功能，并重置应用状态</span>
<span class="hljs-title function_">goHomeHard</span>(<span class="hljs-params"/>) {
  uni.<span class="hljs-title function_">reLaunch</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/index/index'</span>
  });
}

<span class="hljs-comment">// 场景2：用户切换账号后，需要清空所有之前的页面状态，进入首页</span>
<span class="hljs-title function_">afterSwitchAccount</span>(<span class="hljs-params"/>) {
  uni.<span class="hljs-title function_">reLaunch</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/index/index'</span>
  });
}
</code></pre>
<p><strong>对应的页面栈变化：</strong></p>
<ul>
<li>原栈：<code>[Index, List, Detail, Cart, Order, Payment]</code> （一个非常深的链条）</li>
<li>执行 <code>reLaunch(Home)</code> 后，新栈：<code>[Home]</code> （所有旧页面全部被销毁）</li>
</ul>
<h4 data-id="heading-8">2.4 <code>uni.switchTab</code></h4>
<p>用于跳转到 <code>pages.json</code> 中配置的 <code>tabBar</code> 页面，并<strong>关闭其他所有非 tabBar 页面</strong>。</p>
<p><strong>重要特性：</strong></p>
<ul>
<li>跳转目标页面<strong>必须</strong>在 <code>tabBar</code> 中定义。</li>
<li>跳转时，会清空页面栈中所有的非 tabBar 页面。</li>
<li>在App端，点击 tabBar 或调用 <code>switchTab</code>，原 tabBar 页面的 <code>onShow</code> 会触发，但 <code>onLoad</code> 不会再次触发。</li>
</ul>
<p><strong>具体代码示例：</strong></p>
<p>比方说我们的 <code>pages.json</code> 配置了首页（index）和个人中心（profile）两个tab。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"tabBar"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"list"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"pagePath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pages/index/index"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"首页"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"pagePath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pages/profile/profile"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我的"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在任何一个非tabBar页面（如商品详情页 Detail.vue）想切回首页</span>
<span class="hljs-title function_">goToIndexTab</span>(<span class="hljs-params"/>) {
  uni.<span class="hljs-title function_">switchTab</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/index/index'</span> <span class="hljs-comment">// 这个页面必须在 tabBar 的 list 中</span>
  });
}
</code></pre>
<p><strong>对应的页面栈变化：</strong></p>
<ul>
<li>原栈：<code>[Index (tab), List, Detail]</code> （Index是tab页，但当前显示的是Detail）</li>
<li>执行 <code>switchTab(Index)</code> 后，新栈：<code>[Index (tab)]</code> （List和Detail被全部关闭）</li>
</ul>
<blockquote>
<p><strong>提示</strong>：如果应用当前就在目标 tabBar 页面，再调用 <code>switchTab</code> 是不会触发任何页面变化的。</p>
</blockquote>
<h4 data-id="heading-9">2.5 <code>uni.navigateBack</code></h4>
<p>用于返回上一页面或多级页面。它是唯一一个<strong>不指定目标url</strong>的导航API，因为它默认就是往回走。</p>
<p><strong>核心参数：<code>delta</code></strong></p>
<ul>
<li><code>delta</code>: 表示返回的页面层数，默认为 <code>1</code>（返回上一页）。</li>
</ul>
<p><strong>具体代码示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 最简单的返回上一页</span>
<span class="hljs-title function_">goBack</span>(<span class="hljs-params"/>) {
  uni.<span class="hljs-title function_">navigateBack</span>();
  <span class="hljs-comment">// 相当于 uni.navigateBack({ delta: 1 });</span>
}

<span class="hljs-comment">// 2. 返回两级页面</span>
<span class="hljs-comment">// 假设页面栈是 [A, B, C]，在C页面调用此方法，将直接返回到A页面</span>
<span class="hljs-title function_">goBackTwoLevels</span>(<span class="hljs-params"/>) {
  uni.<span class="hljs-title function_">navigateBack</span>({
    <span class="hljs-attr">delta</span>: <span class="hljs-number">2</span>
  });
}

<span class="hljs-comment">// 3. 结合 getCurrentPages()，实现返回</span>
<span class="hljs-comment">// 比方说在分享进来的页面，如果只有一层，则返回时直接回到首页</span>
<span class="hljs-title function_">smartBack</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> pages = <span class="hljs-title function_">getCurrentPages</span>();
  <span class="hljs-keyword">if</span> (pages.<span class="hljs-property">length</span> === <span class="hljs-number">1</span>) {
    <span class="hljs-comment">// 如果只有一页，说明是分享直链进来的，返回首页</span>
    uni.<span class="hljs-title function_">switchTab</span>({
      <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/index/index'</span>
    });
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 否则正常返回</span>
    uni.<span class="hljs-title function_">navigateBack</span>();
  }
}
</code></pre>
<p><strong>五种路由方式综合对比流程图：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    Start[起始页面栈: A, B, C&lt;br&gt;当前页为 C]

    Start --&gt; NavigateTo[uni.navigateTo&lt;br&gt;跳转到 D]
    NavigateTo --&gt; ResultNT[新栈: A, B, C, D]

    Start --&gt; RedirectTo[uni.redirectTo&lt;br&gt;用 D 替换 C]
    RedirectTo --&gt; ResultRT[新栈: A, B, D]

    Start --&gt; SwitchTab[uni.switchTab&lt;br&gt;跳转到 Tab页 T]
    SwitchTab --&gt; ResultST[新栈: T&lt;br&gt;清空所有非Tab页]

    Start --&gt; ReLaunch[uni.reLaunch&lt;br&gt;重启到新页 R]
    ReLaunch --&gt; ResultRL[新栈: R&lt;br&gt;清空所有旧页]

    Start --&gt; NavigateBack[uni.navigateBack&lt;br&gt;delta=1]
    NavigateBack --&gt; ResultNB[新栈: A, B&lt;br&gt;C 被弹出]
</code></pre>
<hr/>
<h3 data-id="heading-10">三、 传参与接收参数</h3>
<p>页面跳转往往不是孤立的，需要携带信息。比如从列表页跳转到详情页，必须告诉详情页：“你要展示哪个商品的ID”。</p>
<h4 data-id="heading-11">3.1 如何传递参数？</h4>
<p>在 <code>navigateTo</code>, <code>redirectTo</code> 等方法的 <code>url</code> 中，可以像普通URL一样拼接参数。</p>
<p><strong>具体示例如下：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在列表页传递商品ID和名称</span>
<span class="hljs-title function_">goToDetail</span>(<span class="hljs-params">product</span>) {
  uni.<span class="hljs-title function_">navigateTo</span>({
    <span class="hljs-comment">// ? 开始代表增加了参数，多个参数用 &amp; 连接</span>
    <span class="hljs-comment">// 注意：参数值最好使用 encodeURIComponent 进行编码，防止特殊字符（如&amp;）导致问题</span>
    <span class="hljs-attr">url</span>: <span class="hljs-string">`/pages/detail/detail?id=<span class="hljs-subst">${product.id}</span>&amp;name=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(product.name)}</span>&amp;type=physical`</span>
  });
}
</code></pre>
<h4 data-id="heading-12">3.2 如何接收参数？</h4>
<p>在目标页面的 <strong><code>onLoad</code> 生命周期函数</strong>中，可以接收到一个 <code>options</code> 对象，里面包含了所有传递过来的参数。</p>
<p><strong>为什么是 <code>onLoad</code>？</strong>
因为 <code>onLoad</code> 是页面<strong>首次加载</strong>时才会触发的生命周期。通过路由跳转并传递参数，对于目标页面来说就是一次“首次加载”。</p>
<p><strong>具体代码如下：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在详情页（Detail.vue）中</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">productId</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">productName</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">productType</span>: <span class="hljs-string">''</span>
    };
  },
  <span class="hljs-title function_">onLoad</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-comment">// options 就是一个对象，包含了 url 中传递的所有参数</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'接收到的参数：'</span>, options);

    <span class="hljs-comment">// 将参数赋值给页面的 data，供模板或方法使用</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">productId</span> = options.<span class="hljs-property">id</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">productName</span> = options.<span class="hljs-property">name</span>; <span class="hljs-comment">// 如果传递时编码了，这里可能需要 decodeURIComponent</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">productType</span> = options.<span class="hljs-property">type</span> || <span class="hljs-string">'digital'</span>; <span class="hljs-comment">// 设置默认值，防止未传参</span>

    <span class="hljs-comment">// 根据获取到的 id，去请求详细的商品数据</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fetchProductDetail</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">productId</span>);
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">fetchProductDetail</span>(<span class="hljs-params">id</span>) {
      <span class="hljs-comment">//根据 id 获取商品详情</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`开始请求商品ID为 <span class="hljs-subst">${id}</span> 的详情数据...`</span>);
    }
  }
};
</code></pre>
<p><strong>一个完整的传参/接参流程：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant L as 列表页(List.vue)
    participant D as 详情页(Detail.vue)

    L-&gt;&gt;L: 用户点击商品，&lt;br&gt;触发 goToDetail 方法
    L-&gt;&gt;D: uni.navigateTo({&lt;br&gt;url: '/pages/detail/detail?id=123&amp;name=Phone' })
    Note over D: 页面初始化&lt;br&gt;触发 onLoad 生命周期
    D-&gt;&gt;D: onLoad(options) 执行&lt;br&gt;options = { id: '123', name: 'Phone' }
    D-&gt;&gt;D: 将 options.id 赋值给&lt;br&gt;this.productId
    D-&gt;&gt;D: 调用 this.fetchProductDetail('123')
</code></pre>
<blockquote>
<p><strong>特别注意</strong>：</p>
<ol>
<li><strong>URL长度限制</strong>：传递大量数据（涉及复杂对象）时，不要通过URL参数传递，因为URL有长度限制。此时应该使用<strong>全局变量（如Vuex）</strong> 或 <strong>本地存储（uni.setStorage）</strong>。</li>
<li><strong>参数类型</strong>：通过URL传递的参数都是<strong>字符串类型</strong>。如果需要数字、布尔值等，需要在接收端自行转换。
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">onLoad</span>(<span class="hljs-params">options</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">productId</span> = <span class="hljs-built_in">parseInt</span>(options.<span class="hljs-property">id</span>); <span class="hljs-comment">// 转成数字</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">isAvailable</span> = options.<span class="hljs-property">available</span> === <span class="hljs-string">'true'</span>; <span class="hljs-comment">// 转成布尔值</span>
}
</code></pre>
</li>
<li><strong>编码与解码</strong>：对于可能包含特殊字符（如 <code>&amp;</code>, <code>=</code>, <code>?</code>, <code>#</code>, <code>%</code> 等）的参数值，在传递前使用 <code>encodeURIComponent()</code> 编码，接收后使用 <code>decodeURIComponent()</code> 解码，可以避免解析错误。</li>
</ol>
</blockquote>
<hr/>
<h3 data-id="heading-13">四、 导航栏自定义配置</h3>
<p>导航栏提供了强大的配置能力，可以在 <code>pages.json</code> 中对其进行全局和页面的个性化设置。</p>
<h4 data-id="heading-14">4.1 全局配置与页面级配置</h4>
<p>配置遵循“就近原则”：<strong>页面级配置的优先级高于全局配置</strong>。</p>
<p><strong><code>pages.json</code> 结构：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-comment">// 1. 全局配置 - 对所有页面生效</span>
  <span class="hljs-attr">"globalStyle"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"navigationBarTitleText"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我的默认App"</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// 导航标题</span>
    <span class="hljs-attr">"navigationBarBackgroundColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#007AFF"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 导航栏背景色</span>
    <span class="hljs-attr">"navigationBarTextStyle"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"white"</span><span class="hljs-punctuation">,</span>          <span class="hljs-comment">// 标题颜色</span>
    <span class="hljs-attr">"backgroundColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#F8F8F8"</span><span class="hljs-punctuation">,</span>               <span class="hljs-comment">// 背景色</span>
    <span class="hljs-attr">"enablePullDownRefresh"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>              <span class="hljs-comment">// 是否开启下拉刷新</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 2. 页面路由列表</span>
  <span class="hljs-attr">"pages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pages/index/index"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"navigationBarTitleText"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"首页"</span> 
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pages/profile/profile"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"navigationBarTitleText"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"个人中心"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"navigationBarBackgroundColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#4CD964"</span><span class="hljs-punctuation">,</span> 
        <span class="hljs-attr">"enablePullDownRefresh"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> 
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pages/detail/detail"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"navigationBarTitleText"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"商品详情"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-comment">// 隐藏原生导航栏，实现全屏或自定义导航栏</span>
        <span class="hljs-attr">"navigationStyle"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"custom"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 3. tabBar 配置</span>
  <span class="hljs-attr">"tabBar"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"color"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#7A7E83"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"selectedColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#007AFF"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"backgroundColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#FFFFFF"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"list"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-comment">// tabBar列表 ...</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-15">4.2 动态修改导航栏标题</h4>
<p>很多时候，我们需要在页面加载后，根据数据动态设置标题。例如，在商品详情页，标题应该是商品的名字，这个名字来自后台接口。</p>
<p><strong>核心API：<code>uni.setNavigationBarTitle</code></strong></p>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在详情页（Detail.vue）中</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">onLoad</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">productId</span> = options.<span class="hljs-property">id</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fetchProductDetail</span>();
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchProductDetail</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 模拟接口请求</span>
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$api</span>.<span class="hljs-title function_">getProductDetail</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">productId</span>);
      <span class="hljs-keyword">if</span> (res.<span class="hljs-property">success</span>) {
        <span class="hljs-keyword">const</span> product = res.<span class="hljs-property">data</span>;
        <span class="hljs-comment">// 动态设置导航栏标题为商品名称</span>
        uni.<span class="hljs-title function_">setNavigationBarTitle</span>({
          <span class="hljs-attr">title</span>: product.<span class="hljs-property">name</span> <span class="hljs-comment">// 从接口获取的商品名</span>
        });
      }
    }
  }
};
</code></pre>
<h4 data-id="heading-16">4.3 自定义导航栏 (<code>"navigationStyle": "custom"</code>)</h4>
<p>当uni-app自带的导航栏样式无法满足你的设计需求时（比如需要加入搜索框、按钮、或者需要特殊的背景效果），你可以选择<strong>自定义导航栏</strong>。</p>
<p><strong>配置步骤：</strong></p>
<ol>
<li><strong>在 <code>pages.json</code> 中为指定页面启用自定义导航栏：</strong>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pages/my-custom-page/my-custom-page"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"navigationStyle"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"custom"</span> 
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li><strong>在页面的 <code>&lt;template&gt;</code> 中，自己编写导航栏的UI结构：</strong>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">view</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 自定义导航栏 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"custom-navbar"</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 状态栏占位，防止内容冲到状态栏下面 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"status-bar"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 导航栏内容区 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar-content"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">text</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-title"</span>&gt;</span>我的自定义标题<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-btn"</span>&gt;</span>按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 页面内容，需要给自定义导航栏留出高度 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"page-content"</span>&gt;</span>
      ...
    <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
</li>
<li><strong>在 <code>&lt;style&gt;</code> 中编写样式，并处理好高度问题：</strong>
<pre><code class="hljs language-css" lang="css">&lt;style scoped&gt;
<span class="hljs-comment">/* 1. 状态栏高度占位 */</span>
<span class="hljs-selector-class">.status-bar</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-built_in">var</span>(--status-bar-height); 
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
}

<span class="hljs-comment">/* 2. 自定义导航栏内容区 */</span>
<span class="hljs-selector-class">.navbar-content</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">44px</span>; <span class="hljs-comment">/* 导航栏标准高度 */</span>
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#007AFF</span>;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">justify-content</span>: center;
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">color</span>: white;
}

<span class="hljs-comment">/* 3. 页面内容需要有一个上边距 */</span>
<span class="hljs-selector-class">.page-content</span> {
  <span class="hljs-attribute">margin-top</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--status-bar-height) + <span class="hljs-number">44px</span>); <span class="hljs-comment">/* 状态栏高度 + 导航栏高度 */</span>
}
&lt;/style&gt;
</code></pre>
</li>
</ol>
<p><strong>自定义导航栏的优缺点：</strong></p>
<ul>
<li><strong>优点</strong>：UI可高度自定义，实现任何复杂的导航栏效果。</li>
<li><strong>缺点</strong>：
<ol>
<li>需要自己处理兼容性问题；</li>
<li>工作量增加，每个需要自定义的页面都要写一套结构样式；</li>
<li>在iOS上，滑动返回手势可能会与自定义导航栏中的按钮点击事件冲突，需要额外处理。</li>
</ol>
</li>
</ul>
<hr/>
<h3 data-id="heading-17">五、 总结</h3>
<p>至此我们已经把uni-app路由导航的核心知识体系全部梳理完毕了。最后做一个整体总结，并提供一个综合小案例。</p>
<h4 data-id="heading-18">5.1 知识点</h4>
<ol>
<li>
<p><strong>页面栈（Page Stack）</strong></p>
<ul>
<li><strong>本质</strong>：一个后进先出（LIFO）的栈结构，管理所有已打开的页面。</li>
<li><strong>核心API</strong>：<code>getCurrentPages()</code>，用于获取当前栈实例，可进行跨页面通信和智能导航。</li>
</ul>
</li>
<li>
<p><strong>五大路由跳转方法</strong></p>
<ul>
<li><code>uni.navigateTo</code>：<strong>保留当前页</strong>，跳转新页。最常用。</li>
<li><code>uni.redirectTo</code>：<strong>关闭当前页</strong>，跳转新页。用于<strong>中断当前流程</strong>，不让返回。</li>
<li><code>uni.reLaunch</code>：<strong>关闭所有页</strong>，打开新页。用于<strong>重启应用状态</strong>。</li>
<li><code>uni.switchTab</code>：<strong>跳转Tab页</strong>，关闭所有非Tab页。专为<strong>底部导航</strong>设计。</li>
<li><code>uni.navigateBack</code>：<strong>返回上一页或多页</strong>。最简单的返回操作。</li>
</ul>
</li>
<li>
<p><strong>参数传递与接收</strong></p>
<ul>
<li><strong>传递</strong>：在跳转的 <code>url</code> 后通过 <code>?key=value&amp;key2=value2</code> 的形式拼接。</li>
<li><strong>接收</strong>：在目标页面的 <strong><code>onLoad(options)</code></strong> 生命周期中，从 <code>options</code> 参数中获取。</li>
<li><strong>注意</strong>：参数是字符串，注意类型转换和特殊字符编码。</li>
</ul>
</li>
<li>
<p><strong>导航栏自定义</strong></p>
<ul>
<li><strong>静态配置</strong>：在 <code>pages.json</code> 的 <code>globalStyle</code> 和每个页面的 <code>style</code> 中配置标题、颜色等。</li>
<li><strong>动态修改</strong>：使用 <code>uni.setNavigationBarTitle</code> API。</li>
<li><strong>完全自定义</strong>：设置 <code>"navigationStyle": "custom"</code>，然后自己编写视图和样式，注意处理好状态栏高度。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-19">5.2 最后，以一个简单的电商流程为例：</h4>
<p>让我们用刚学的知识，模拟一个简单的电商页面跳转流程。以下只写核心思路代码，具体细节代码需要自行发挥！！！</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 首页 (index.vue) - 点击商品分类</span>
<span class="hljs-title function_">goToCategory</span>(<span class="hljs-params">categoryId</span>) {
  uni.<span class="hljs-title function_">navigateTo</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">`/pages/category/category?id=<span class="hljs-subst">${categoryId}</span>`</span>
  });
}

<span class="hljs-comment">// 2. 分类页 (category.vue) - 接收分类ID，展示商品列表</span>
<span class="hljs-title function_">onLoad</span>(<span class="hljs-params">options</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">categoryId</span> = options.<span class="hljs-property">id</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fetchGoodsList</span>();
},
<span class="hljs-comment">// 点击列表中的商品</span>
<span class="hljs-title function_">onGoodsItemTap</span>(<span class="hljs-params">goodsId</span>) {
  uni.<span class="hljs-title function_">navigateTo</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">`/pages/goods-detail/goods-detail?goods_id=<span class="hljs-subst">${goodsId}</span>`</span>
  });
}

<span class="hljs-comment">// 3. 商品详情页 (goods-detail.vue) - 接收商品ID，展示详情</span>
<span class="hljs-title function_">onLoad</span>(<span class="hljs-params">options</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">goodsId</span> = options.<span class="hljs-property">goods_id</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fetchGoodsDetail</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">goods</span> =&gt;</span> {
    <span class="hljs-comment">// 动态设置导航栏标题为商品名</span>
    uni.<span class="hljs-title function_">setNavigationBarTitle</span>({ <span class="hljs-attr">title</span>: goods.<span class="hljs-property">name</span> });
  });
},
<span class="hljs-comment">// 点击加入购物车</span>
<span class="hljs-title function_">addToCart</span>(<span class="hljs-params"/>) {
  uni.<span class="hljs-title function_">showToast</span>({
    <span class="hljs-attr">title</span>: <span class="hljs-string">'添加成功'</span>
  });
},
<span class="hljs-comment">// 点击立即购买</span>
<span class="hljs-title function_">buyNow</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 跳转到订单确认页，并不允许返回到此详情页</span>
  uni.<span class="hljs-title function_">redirectTo</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">`/pages/order-confirm/order-confirm?goods_id=<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.goodsId}</span>`</span>
  });
}

<span class="hljs-comment">// 4. 订单确认页 (order-confirm.vue)</span>
<span class="hljs-title function_">onLoad</span>(<span class="hljs-params">options</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">goodsId</span> = options.<span class="hljs-property">goods_id</span>;
},
<span class="hljs-comment">// 提交订单成功</span>
<span class="hljs-title function_">onOrderSubmitSuccess</span>(<span class="hljs-params">orderId</span>) {
  <span class="hljs-comment">// 关闭所有页面，跳转到订单结果页</span>
  uni.<span class="hljs-title function_">reLaunch</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">`/pages/order-result/order-result?order_id=<span class="hljs-subst">${orderId}</span>&amp;status=success`</span>
  });
}

<span class="hljs-comment">// 5. 在订单结果页 (order-result.vue)，提供“返回首页”的按钮</span>
<span class="hljs-title function_">backToHome</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 因为是用 reLaunch 跳过来的，栈里只有这一页，所以用 switchTab 回首页</span>
  uni.<span class="hljs-title function_">switchTab</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/index/index'</span>
  });
}
</code></pre>
<hr/>
<h3 data-id="heading-20">结语</h3>
<p>路由与导航，作为连接整个应用的脉络，其重要性不言而喻。理解页面栈的原理，能让你在遇到复杂的导航问题时游刃有余；熟练掌握五种跳转方式，能让你为用户设计出最符合直觉的交互流程；
希望这篇文章能够帮到你你，最后如果觉得文章写得还可以<strong>别忘了‘一键三连’（点赞、关注、收藏）</strong>，这是对我创作的最大鼓励！</p>
<p>有任何问题，欢迎在评论区留言，我们下篇见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[重新审视 JavaScript 中的异步循环]]></title>    <link>https://juejin.cn/post/7570187256106450950</link>    <guid>https://juejin.cn/post/7570187256106450950</guid>    <pubDate>2025-11-10T03:01:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570187256106450950" data-draft-id="7570191839594184767" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="重新审视 JavaScript 中的异步循环"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-10T03:01:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="道可到"/> <meta itemprop="url" content="https://juejin.cn/user/1794042842067742"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            重新审视 JavaScript 中的异步循环
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1794042842067742/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    道可到
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T03:01:29.000Z" title="Mon Nov 10 2025 03:01:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">重新审视 JavaScript 中的异步循环（贴合实际业务）</h2>
<hr/>
<h3 data-id="heading-1">为什么“在循环里用 <code>await</code>”常让系统变慢？</h3>
<p>在 <code>for</code>/<code>for...of</code> 循环里直接 <code>await</code>，会让每一步<strong>串行</strong>执行：下一个请求必须等上一个完成，独立的网络调用因此被迫排队，吞吐量下降。相反，在 <code>map()</code> 里用 <code>async</code> 却<strong>不会等待</strong>，你得到的是一组 <em>Promise</em>，若不进一步汇聚，就会产生“已经结束但任务仍在后台跑”的错觉。citeturn1search1turn1search10turn1search29</p>
<blockquote>
<p>结论：<strong>要么有意识地串行</strong>（确有顺序或限速要求），<strong>要么明确地并行</strong>（如 <code>Promise.all</code>/受控并发）；避免模棱两可的写法。citeturn1search1</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">三种主流执行模式</h3>
<h4 data-id="heading-3">1) 串行：<code>for...of + await</code></h4>
<p><strong>适用</strong>：后一步依赖上一步；需要严格顺序；受供应商 API 严格限速（如每秒 1 次）。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> id <span class="hljs-keyword">of</span> orderIds) {
  <span class="hljs-keyword">const</span> order = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getOrder</span>(id);        <span class="hljs-comment">// 依赖顺序</span>
  <span class="hljs-keyword">const</span> enriched = <span class="hljs-keyword">await</span> <span class="hljs-title function_">enrich</span>(order);    <span class="hljs-comment">// 逐步加工</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">persist</span>(enriched);
}
</code></pre>
<p>这类写法最直观、可控、易于断点调试，但对独立 I/O 来说性能最慢。</p>
<h4 data-id="heading-4">2) 并行：<code>Promise.all(users.map(...))</code></h4>
<p><strong>适用</strong>：各任务彼此独立，无需保持顺序，例如<strong>并发拉取 100 个客户资料</strong>或<strong>批量生成报表</strong>。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
  customerIds.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> <span class="hljs-title function_">fetchCustomerProfile</span>(id))
);
</code></pre>
<p>注意 <code>Promise.all()</code> <strong>“失败即全部失败”</strong>：任一子任务拒绝即整体 reject，需要配合边界处理。</p>
<h5 data-id="heading-5">更安全的并行：<code>Promise.allSettled()</code></h5>
<p>保留所有结果（成功/失败），适合<strong>批处理</strong>与<strong>部分成功可接受</strong>的业务（如批量发券、推送）。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> settled = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">allSettled</span>(tasks);
<span class="hljs-keyword">const</span> ok = settled.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-property">status</span> === <span class="hljs-string">'fulfilled'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-property">value</span>);
<span class="hljs-keyword">const</span> bad = settled.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-property">status</span> === <span class="hljs-string">'rejected'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-property">reason</span>);
</code></pre>
<p><code>allSettled()</code> <strong>等待全部任务落定</strong>，不会因为单次失败提前退出。</p>
<h4 data-id="heading-6">3) 受控并发：<code>p-limit</code></h4>
<p><strong>适用</strong>：既要加速，又要<strong>尊重限流/连接数</strong>（如支付、物流、第三方风控）。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> pLimit <span class="hljs-keyword">from</span> <span class="hljs-string">'p-limit'</span>;
<span class="hljs-keyword">const</span> limit = <span class="hljs-title function_">pLimit</span>(<span class="hljs-number">5</span>);                 <span class="hljs-comment">// 最多并行 5 个</span>
<span class="hljs-keyword">const</span> tasks = orderIds.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> <span class="hljs-title function_">limit</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">processOrder</span>(id)));
<span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(tasks);
</code></pre>
<p><code>p-limit</code> 通过“令牌桶”式并发上限，避免把上游打垮或把本机线程池占满。</p>
<blockquote>
<p>快速选型：<strong>顺序</strong>→<code>for...of</code>；<strong>极速并行</strong>→<code>Promise.all</code>；<strong>限流</strong>→<code>p-limit</code>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">常见误用与坑</h3>
<ul>
<li><strong><code>forEach</code> + <code>async</code></strong>：<code>forEach</code> 不等待异步回调，外层函数早结束，错误与资源泄露被“吞掉”。请改为 <code>for...of</code> 或 <code>Promise.all(map(...))</code>。citeturn1search1turn1search29</li>
<li><strong><code>map(async ...)</code> 后不汇聚</strong>：得到的是 <em>Promise[]</em> 而非数据；要 <code>await Promise.all(...)</code> 或 <code>allSettled(...)</code>。citeturn1search1</li>
<li><strong>无上限的“全并发”</strong>：容易触发供应商限流、雪崩或本机资源耗尽；请用 <code>p-limit</code>/批处理。</li>
</ul>
<hr/>
<h3 data-id="heading-8">业务级健壮性（必做项）</h3>
<h4 data-id="heading-9">1) 超时、取消与重试</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 简易超时包装</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">withTimeout</span> = (<span class="hljs-params">p, ms</span>) =&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">res, rej</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> t = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">rej</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Timeout <span class="hljs-subst">${ms}</span>ms`</span>)), ms);
  p.<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearTimeout</span>(t)).<span class="hljs-title function_">then</span>(res, rej);
});

<span class="hljs-comment">// 结合 AbortController 取消（浏览器/Node18+）</span>
<span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
<span class="hljs-keyword">const</span> resp = <span class="hljs-keyword">await</span> <span class="hljs-title function_">withTimeout</span>(<span class="hljs-title function_">fetch</span>(url, { <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span> }), <span class="hljs-number">5000</span>);
<span class="hljs-comment">// controller.abort(); // 需要时取消</span>

<span class="hljs-comment">// 指数退避重试（只对可重试错误）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">retry</span>(<span class="hljs-params">fn, times = <span class="hljs-number">3</span></span>) {
  <span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; <span class="hljs-keyword">let</span> err;
  <span class="hljs-keyword">while</span> (i &lt; times) {
    <span class="hljs-keyword">try</span> { <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">fn</span>(); } <span class="hljs-keyword">catch</span> (e) {
      err = e; <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(r, <span class="hljs-number">2</span> ** i * <span class="hljs-number">200</span>)); i++;
    }
  }
  <span class="hljs-keyword">throw</span> err;
}
</code></pre>
<p>与 <code>Promise.all/Settled</code> 组合能显著提升批处理成功率与可观测性。</p>
<h4 data-id="heading-10">2) 幂等与去重</h4>
<p>在 <strong>支付、发货、开票</strong> 等场景，务必给任务加幂等键（如 <code>orderId#step</code>），避免并行与重试导致的<strong>重复扣费/重复推送</strong>。这一点与并发模式无关，但与并发越大越重要。<em>（业务通用原则）</em></p>
<h4 data-id="heading-11">3) 可观测性</h4>
<p>为每个批次记录：<strong>并发度、成功/失败数、耗时分位数、重试次数</strong>，并对失败样本做<strong>原因分类</strong>（5xx/4xx/解析/超时/取消）。<em>（工程最佳实践）</em></p>
<hr/>
<h3 data-id="heading-12">面向海量数据：批处理、流与异步可迭代</h3>
<ul>
<li><strong>批处理</strong>：按 50~200 的 batch 大小切片 + <code>p-limit</code>，通常能在吞吐与稳定性间取到好平衡。</li>
<li><strong><code>for‑await‑of</code></strong>：消费异步可迭代（如分页 API、Node.js 流）。便于“边到边处理”，控制内存占用。</li>
<li><strong><code>Array.fromAsync()</code></strong>：把（异步）可迭代转为数组，内部<strong>顺序地等待每个元素</strong>；而 <code>Promise.all</code> 是<strong>并发等待</strong>。用于需要“逐个确认、有节奏地拉取”的场景。citeturn1search16</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 例：分页抓取→顺序聚合（避免瞬时压垮后端）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>* <span class="hljs-title function_">pages</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">let</span> page = <span class="hljs-number">1</span>; <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/invoices?page=<span class="hljs-subst">${page}</span>`</span>);
  <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">break</span>; <span class="hljs-keyword">yield</span> res.<span class="hljs-title function_">json</span>(); page++;
}}
<span class="hljs-keyword">const</span> all = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">fromAsync</span>(<span class="hljs-title function_">pages</span>(), <span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p); <span class="hljs-comment">// 顺序消费</span>
</code></pre>
<p><code>Array.fromAsync</code> 与 <code>Promise.all</code> 的差异与取舍，详见 MDN。</p>
<hr/>
<h3 data-id="heading-13">贴合业务的示例片段</h3>
<h4 data-id="heading-14">A. 受第三方 API 限流的客户资料同步</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> pLimit <span class="hljs-keyword">from</span> <span class="hljs-string">'p-limit'</span>;
<span class="hljs-keyword">const</span> limit = <span class="hljs-title function_">pLimit</span>(<span class="hljs-number">8</span>); <span class="hljs-comment">// 第三方给的窗口：每秒 10 次，这里预留安全边际</span>

<span class="hljs-keyword">const</span> tasks = customers.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> <span class="hljs-title function_">limit</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">retry</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchCrm</span>(c.<span class="hljs-property">id</span>))));
<span class="hljs-keyword">const</span> settled = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">allSettled</span>(tasks);
<span class="hljs-keyword">const</span> ok = settled.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x.<span class="hljs-property">status</span> === <span class="hljs-string">'fulfilled'</span>).<span class="hljs-property">length</span>;
<span class="hljs-keyword">const</span> fail = settled.<span class="hljs-property">length</span> - ok;
</code></pre>
<p>并发受控、失败不拖累整体，失败项可落盘重试。</p>
<h4 data-id="heading-15">B. 订单批量开票（保持顺序）</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> id <span class="hljs-keyword">of</span> orderIds) {
  <span class="hljs-keyword">const</span> order = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getOrder</span>(id);
  <span class="hljs-keyword">const</span> pdf = <span class="hljs-keyword">await</span> <span class="hljs-title function_">buildInvoicePdf</span>(order);
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">uploadToStorage</span>(pdf, <span class="hljs-string">`<span class="hljs-subst">${id}</span>.pdf`</span>);
}
</code></pre>
<p>订单号与发票号需一一对应、可审计，故选<strong>串行</strong>。</p>
<h4 data-id="heading-16">C. 报表并行渲染（失败可容忍）</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> jobs = views.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">view</span> =&gt;</span> <span class="hljs-title function_">renderReport</span>(view));
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">allSettled</span>(jobs);
<span class="hljs-keyword">const</span> okReports = result.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x.<span class="hljs-property">status</span> === <span class="hljs-string">'fulfilled'</span>);
</code></pre>
<h3 data-id="heading-17">某些报表失败不影响其他成功交付，<strong>用 <code>allSettled</code> 收敛</strong>更稳妥。</h3>
<h3 data-id="heading-18">速查清单 / 决策树</h3>
<ol>
<li><strong>是否必须保持顺序或严格限速？</strong> 是 → <code>for...of + await</code>；否 → 2。citeturn1search40</li>
<li><strong>是否需要尽快完成且任务彼此独立？</strong> 是 → <code>Promise.all(map(...))</code>；否 → 3。citeturn1search10</li>
<li><strong>是否担心压垮上游或自身？</strong> 是 → <code>p-limit</code> 设定并发上限；否 → 直接 <code>Promise.all</code>。</li>
<li><strong>是否需要“全部结果都要拿到”用于汇总/审计？</strong> 用 <code>Promise.allSettled</code>。citeturn1search34</li>
<li><strong>数据像“流水”般到达？</strong> 用 <code>for‑await‑of</code> / <code>Array.fromAsync</code>。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[打造炫酷3D科技地球：Three.js实战指南]]></title>    <link>https://juejin.cn/post/7570268773334253595</link>    <guid>https://juejin.cn/post/7570268773334253595</guid>    <pubDate>2025-11-10T03:16:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570268773334253595" data-draft-id="7570299986531074075" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="打造炫酷3D科技地球：Three.js实战指南"/> <meta itemprop="keywords" content="three.js"/> <meta itemprop="datePublished" content="2025-11-10T03:16:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SeanTao"/> <meta itemprop="url" content="https://juejin.cn/user/778899350105880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            打造炫酷3D科技地球：Three.js实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/778899350105880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SeanTao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T03:16:09.000Z" title="Mon Nov 10 2025 03:16:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">打造炫酷3D科技地球：Three.js实战指南</h2>
<p>本文将通过一个具体的3D科技地球实现案例，手把手带你探索使用Three.js创建交互式3D可视化项目的完整流程。我们将深入代码细节，解析核心技术实现，并分享优化技巧。</p>
<h3 data-id="heading-1">一、项目概述与核心技术栈</h3>
<p>这个3D科技地球项目基于<strong>React+Three.js</strong>技术栈构建，采用了现代前端开发的最佳实践。项目不仅实现了基本的3D地球展示，还包含了星空背景、发光效果、国家高亮、平滑交互等高级特性。</p>
<p>从代码结构来看，这个组件涵盖了Three.js的核心概念：场景(Scene)、相机(Camera)、渲染器(Renderer)、几何体(Geometry)和材质(Material)。通过良好的代码组织，将复杂的三维可视化拆分为可维护的模块化结构。</p>
<h3 data-id="heading-2">二、三维场景构建：从零搭建地球模型</h3>
<h4 data-id="heading-3">1. 三大核心要素初始化</h4>
<p>任何Three.js项目都始于三大核心要素的创建：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 场景设置</span>
<span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>()
sceneRef.<span class="hljs-property">current</span> = scene

<span class="hljs-comment">// 摄像机设置</span>
<span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(
  <span class="hljs-number">75</span>,
  mountRef.<span class="hljs-property">current</span>.<span class="hljs-property">clientWidth</span> / mountRef.<span class="hljs-property">current</span>.<span class="hljs-property">clientHeight</span>,
  <span class="hljs-number">0.1</span>,
  <span class="hljs-number">1000</span>
)
camera.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> = <span class="hljs-number">4</span>

<span class="hljs-comment">// 渲染器设置</span>
<span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({
  <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">alpha</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">logarithmicDepthBuffer</span>: <span class="hljs-literal">true</span>
})
renderer.<span class="hljs-title function_">setSize</span>(mountRef.<span class="hljs-property">current</span>.<span class="hljs-property">clientWidth</span>, mountRef.<span class="hljs-property">current</span>.<span class="hljs-property">clientHeight</span>)
</code></pre>
<p>透视摄像机的设置保证了我们看到的地球具有真实的近大远小效果，而渲染器的高质量抗锯齿和对数深度缓冲区配置则确保了最终画面的清晰度和层次感。</p>
<h4 data-id="heading-4">2. 地球几何体与材质制作</h4>
<p>地球的核心是一个球体几何体结合自定义纹理：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> geometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">SphereGeometry</span>(<span class="hljs-number">1</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>)
</code></pre>
<p>这里使用64的宽度和高度分段数，在保证平滑度的同时优化性能。地球材质的关键在于使用Canvas动态生成纹理，而非简单的图片贴图：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 创建地球纹理（主显示：发光边界线）</span>
<span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>)
canvas.<span class="hljs-property">width</span> = <span class="hljs-number">2048</span>
canvas.<span class="hljs-property">height</span> = <span class="hljs-number">1024</span>  <span class="hljs-comment">// 2:1比例匹配等距圆柱投影</span>
<span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>)
</code></pre>
<p>这种动态纹理生成技术让我们能够程序化地绘制国家边界和经纬线，为后续的国家高亮功能奠定基础。</p>
<h3 data-id="heading-5">三、视觉增强效果剖析</h3>
<h4 data-id="heading-6">1. 多层发光效果实现</h4>
<p>项目通过多层叠加实现了丰富的发光效果：</p>
<ul>
<li><strong>大气层效果</strong>：使用稍大的球体半透明材质模拟大气</li>
<li><strong>边缘发光</strong>：通过自定义着色器实现基于法向量的边缘光晕</li>
<li><strong>多层辉光</strong>：不同半径的发光球体叠加创造深度感</li>
</ul>
<p>顶点着色器中计算法向量与视线方向的夹角，片段着色器中根据夹角强度决定发光强度：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 边缘发光着色器核心代码</span>
float intensity = <span class="hljs-title function_">pow</span>(<span class="hljs-number">0.6</span> - <span class="hljs-title function_">dot</span>(vNormal, <span class="hljs-title function_">vec3</span>(<span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>)), <span class="hljs-number">3.0</span>)
vec3 glow = color * intensity * <span class="hljs-number">2.0</span>
</code></pre>
<p>这种基于法向量的发光计算方式，能够在物体边缘产生自然的光晕效果。</p>
<p>完整实现</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 创建更强烈的大气层效果</span>
<span class="hljs-keyword">const</span> atmosphereGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">SphereGeometry</span>(<span class="hljs-number">1.02</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>)
<span class="hljs-keyword">const</span> atmosphereMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({
  <span class="hljs-attr">color</span>: <span class="hljs-number">0x00CCFF</span>,
  <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">opacity</span>: <span class="hljs-number">0.2</span>,
  <span class="hljs-attr">side</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">DoubleSide</span>,
  <span class="hljs-attr">blending</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">AdditiveBlending</span>
})
<span class="hljs-keyword">const</span> atmosphere = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(atmosphereGeometry, atmosphereMaterial)
scene.<span class="hljs-title function_">add</span>(atmosphere)

<span class="hljs-comment">// 创建多层发光边缘效果</span>
<span class="hljs-keyword">const</span> glowGeometry1 = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">SphereGeometry</span>(<span class="hljs-number">1</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>)
<span class="hljs-keyword">const</span> glowMaterial1 = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">ShaderMaterial</span>({
  <span class="hljs-attr">uniforms</span>: {
    <span class="hljs-attr">time</span>: { <span class="hljs-attr">value</span>: <span class="hljs-number">0</span> },
    <span class="hljs-attr">color</span>: { <span class="hljs-attr">value</span>: <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(<span class="hljs-number">0x00FFFF</span>) }
  },
  <span class="hljs-attr">vertexShader</span>: <span class="hljs-string">`
    varying vec3 vNormal;
    varying vec3 vPosition;
    void main() {
      vNormal = normalize(normalMatrix * normal);
      vPosition = position;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `</span>,
  <span class="hljs-attr">fragmentShader</span>: <span class="hljs-string">`
    uniform float time;
    uniform vec3 color;
    varying vec3 vNormal;
    varying vec3 vPosition;
    void main() {
      float intensity = pow(0.6 - dot(vNormal, vec3(0.0, 0.0, 1.0)), 3.0);
      vec3 glow = color * intensity * 2.0;
      gl_FragColor = vec4(glow, intensity * 1.2);
    }
  `</span>,
  <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">side</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">BackSide</span>,
  <span class="hljs-attr">blending</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">AdditiveBlending</span>
})
<span class="hljs-keyword">const</span> glowMesh1 = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(glowGeometry1, glowMaterial1)
scene.<span class="hljs-title function_">add</span>(glowMesh1)

<span class="hljs-comment">// 外层发光效果</span>
<span class="hljs-keyword">const</span> glowGeometry2 = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">SphereGeometry</span>(<span class="hljs-number">1.06</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>)
<span class="hljs-keyword">const</span> glowMaterial2 = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">ShaderMaterial</span>({
  <span class="hljs-attr">uniforms</span>: {
    <span class="hljs-attr">time</span>: { <span class="hljs-attr">value</span>: <span class="hljs-number">0</span> },
    <span class="hljs-attr">color</span>: { <span class="hljs-attr">value</span>: <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(<span class="hljs-number">61</span>, <span class="hljs-number">131</span>, <span class="hljs-number">199</span>) }
  },
  <span class="hljs-attr">vertexShader</span>: <span class="hljs-string">`
    varying vec3 vNormal;
    void main() {
      vNormal = normalize(normalMatrix * normal);
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `</span>,
  <span class="hljs-attr">fragmentShader</span>: <span class="hljs-string">`
    uniform float time;
    uniform vec3 color;
    varying vec3 vNormal;
    void main() {
      float intensity = pow(0.8 - dot(vNormal, vec3(0.0, 0.0, 1.0)), 2.0);
      vec3 glow = color * intensity * 1.5;
      gl_FragColor = vec4(glow, intensity * 0.8);
    }
  `</span>,
  <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">side</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">BackSide</span>,
  <span class="hljs-attr">blending</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">AdditiveBlending</span>
})
<span class="hljs-keyword">const</span> glowMesh2 = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(glowGeometry2, glowMaterial2)
scene.<span class="hljs-title function_">add</span>(glowMesh2)
</code></pre>
<h4 data-id="heading-7">2. 星空背景生成</h4>
<p>星空背景并非使用静态贴图，而是通过程序化生成：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> starGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BufferGeometry</span>()
<span class="hljs-keyword">const</span> starCount = <span class="hljs-number">5000</span>
<span class="hljs-keyword">const</span> positions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(starCount * <span class="hljs-number">3</span>)
<span class="hljs-keyword">const</span> colors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(starCount * <span class="hljs-number">3</span>)
</code></pre>
<p>通过随机生成星星位置和科技蓝色调，创建了深邃而有科技感的星空背景，这种动态生成方式相比贴图具有更小的资源体积。</p>
<p>完整实现</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 创建星空背景</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">createStarField</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> starGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BufferGeometry</span>()
  <span class="hljs-keyword">const</span> starCount = <span class="hljs-number">5000</span>
  <span class="hljs-keyword">const</span> positions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(starCount * <span class="hljs-number">3</span>)
  <span class="hljs-keyword">const</span> colors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(starCount * <span class="hljs-number">3</span>)

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; starCount * <span class="hljs-number">3</span>; i += <span class="hljs-number">3</span>) {
    positions[i] = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">2000</span>
    positions[i + <span class="hljs-number">1</span>] = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">2000</span>
    positions[i + <span class="hljs-number">2</span>] = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">2000</span>

    <span class="hljs-comment">// 科技蓝色调的星星</span>
    <span class="hljs-keyword">const</span> intensity = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.5</span> + <span class="hljs-number">0.5</span>
    colors[i] = <span class="hljs-number">0.2</span> * intensity     <span class="hljs-comment">// R</span>
    colors[i + <span class="hljs-number">1</span>] = <span class="hljs-number">0.6</span> * intensity <span class="hljs-comment">// G</span>
    colors[i + <span class="hljs-number">2</span>] = intensity       <span class="hljs-comment">// B</span>
  }

  starGeometry.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'position'</span>, <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BufferAttribute</span>(positions, <span class="hljs-number">3</span>))
  starGeometry.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'color'</span>, <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BufferAttribute</span>(colors, <span class="hljs-number">3</span>))

  <span class="hljs-keyword">const</span> starMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PointsMaterial</span>({
    <span class="hljs-attr">size</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">vertexColors</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">opacity</span>: <span class="hljs-number">0.8</span>
  })

  <span class="hljs-keyword">const</span> stars = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Points</span>(starGeometry, starMaterial)
  scene.<span class="hljs-title function_">add</span>(stars)
  <span class="hljs-keyword">return</span> stars
}
</code></pre>
<h3 data-id="heading-8">四、交互系统深度解析</h3>
<h4 data-id="heading-9">1. 鼠标与触摸交互处理</h4>
<p>项目实现了完整的鼠标和触摸事件处理系统：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseMove</span> = (<span class="hljs-params">event</span>) =&gt; {
  <span class="hljs-keyword">if</span> (isDragging) {
    <span class="hljs-keyword">const</span> deltaX = event.<span class="hljs-property">clientX</span> - previousMousePosition.<span class="hljs-property">x</span>
    <span class="hljs-keyword">const</span> deltaY = event.<span class="hljs-property">clientY</span> - previousMousePosition.<span class="hljs-property">y</span>

    rotationSpeed.<span class="hljs-property">y</span> = deltaX * <span class="hljs-number">0.01</span>
    rotationSpeed.<span class="hljs-property">x</span> = deltaY * <span class="hljs-number">0.01</span>

    previousMousePosition = {
      <span class="hljs-attr">x</span>: event.<span class="hljs-property">clientX</span>,
      <span class="hljs-attr">y</span>: event.<span class="hljs-property">clientY</span>
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 精确国家检测（射线-&gt;经纬度-&gt;多边形判断）</span>
    <span class="hljs-keyword">const</span> rect = mountRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">getBoundingClientRect</span>()
    mouse.<span class="hljs-property">x</span> = ((event.<span class="hljs-property">clientX</span> - rect.<span class="hljs-property">left</span>) / rect.<span class="hljs-property">width</span>) * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>
    mouse.<span class="hljs-property">y</span> = -((event.<span class="hljs-property">clientY</span> - rect.<span class="hljs-property">top</span>) / rect.<span class="hljs-property">height</span>) * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>

    raycaster.<span class="hljs-title function_">setFromCamera</span>(mouse, camera)
    raycaster.<span class="hljs-property">near</span> = <span class="hljs-number">0.1</span>
    raycaster.<span class="hljs-property">far</span> = <span class="hljs-number">10</span>

    <span class="hljs-keyword">if</span> (globe) {
      <span class="hljs-keyword">const</span> intersects = raycaster.<span class="hljs-title function_">intersectObject</span>(globe)
      <span class="hljs-keyword">if</span> (intersects.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 最近交点</span>
        <span class="hljs-keyword">let</span> nearestIntersect = intersects[<span class="hljs-number">0</span>]
        <span class="hljs-keyword">if</span> (intersects.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span>) {
          nearestIntersect = intersects.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">nearest, current</span>) =&gt;</span> (
            current.<span class="hljs-property">distance</span> &lt; nearest.<span class="hljs-property">distance</span> ? current : nearest
          ))
        }

        <span class="hljs-comment">// 将交点转到球体局部坐标并归一化</span>
        <span class="hljs-keyword">const</span> intersectionPoint = nearestIntersect.<span class="hljs-property">point</span>.<span class="hljs-title function_">clone</span>()
        <span class="hljs-keyword">const</span> localIntersectionPoint = intersectionPoint.<span class="hljs-title function_">clone</span>()
        <span class="hljs-keyword">const</span> inverseMatrix = globe.<span class="hljs-property">matrixWorld</span>.<span class="hljs-title function_">clone</span>().<span class="hljs-title function_">invert</span>()
        localIntersectionPoint.<span class="hljs-title function_">applyMatrix4</span>(inverseMatrix)
        localIntersectionPoint.<span class="hljs-title function_">normalize</span>()

        <span class="hljs-keyword">const</span> { lon, lat } = <span class="hljs-title function_">cartesianToLonLat</span>(localIntersectionPoint)
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isNaN</span>(lat) &amp;&amp; !<span class="hljs-built_in">isNaN</span>(lon)) {
          <span class="hljs-title function_">checkCountryAtCoordinate</span>(lon, lat)
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 没有交点时清除高亮</span>
        <span class="hljs-title function_">proposeHover</span>(<span class="hljs-literal">null</span>)
      }
    }
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseUp</span> = (<span class="hljs-params"/>) =&gt; {
  isDragging = <span class="hljs-literal">false</span>
  mountRef.<span class="hljs-property">current</span>.<span class="hljs-property">style</span>.<span class="hljs-property">cursor</span> = <span class="hljs-string">'grab'</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseLeave</span> = (<span class="hljs-params"/>) =&gt; {
  isDragging = <span class="hljs-literal">false</span>
  mountRef.<span class="hljs-property">current</span>.<span class="hljs-property">style</span>.<span class="hljs-property">cursor</span> = <span class="hljs-string">'grab'</span>

  <span class="hljs-comment">// 清除高亮效果（带淡出）</span>
  <span class="hljs-title function_">proposeHover</span>(<span class="hljs-literal">null</span>)
}

<span class="hljs-comment">// 滚轮缩放</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleWheel</span> = (<span class="hljs-params">e</span>) =&gt; {
   e.<span class="hljs-title function_">preventDefault</span>()
   <span class="hljs-keyword">const</span> speed = e.<span class="hljs-property">ctrlKey</span> ? <span class="hljs-number">0.01</span> : <span class="hljs-number">0.002</span>
   targetCameraZ = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">MathUtils</span>.<span class="hljs-title function_">clamp</span>(
       targetCameraZ + e.<span class="hljs-property">deltaY</span> * speed,
       minCameraZ,
       maxCameraZ
   )
}

</code></pre>
<p>通过速度衰减算法(<code>rotationSpeed *= 0.95</code>)实现了自然的旋转惯性效果，大大提升了交互体验。</p>
<p>动画效果实现</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">animate</span> = (<span class="hljs-params"/>) =&gt; {
  frameRef.<span class="hljs-property">current</span> = <span class="hljs-title function_">requestAnimationFrame</span>(animate)

  <span class="hljs-keyword">const</span> time = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() * <span class="hljs-number">0.001</span>
  <span class="hljs-keyword">const</span> nowTs = performance.<span class="hljs-title function_">now</span>()
  <span class="hljs-keyword">const</span> dt = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">0.05</span>, (nowTs - lastFrameTs) / <span class="hljs-number">1000</span>) <span class="hljs-comment">// 避免长时间切回导致跳变</span>
  lastFrameTs = nowTs

  <span class="hljs-comment">// 地球旋转（自转 + 拖拽旋转）</span>
  <span class="hljs-keyword">if</span> (globe) {
    globe.<span class="hljs-property">rotation</span>.<span class="hljs-property">y</span> += <span class="hljs-number">0.002</span>
    globe.<span class="hljs-property">rotation</span>.<span class="hljs-property">y</span> += rotationSpeed.<span class="hljs-property">y</span>
    globe.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> += rotationSpeed.<span class="hljs-property">x</span>
    rotationSpeed.<span class="hljs-property">x</span> *= <span class="hljs-number">0.95</span>
    rotationSpeed.<span class="hljs-property">y</span> *= <span class="hljs-number">0.95</span>
    globe.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(-<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>, globe.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span>))
    <span class="hljs-keyword">if</span> (highlightGlobe) highlightGlobe.<span class="hljs-property">rotation</span>.<span class="hljs-title function_">copy</span>(globe.<span class="hljs-property">rotation</span>)
  }

  <span class="hljs-comment">// 平滑变焦</span>
  camera.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> += (targetCameraZ - camera.<span class="hljs-property">position</span>.<span class="hljs-property">z</span>) * <span class="hljs-number">0.15</span>

  <span class="hljs-keyword">if</span> (atmosphere) atmosphere.<span class="hljs-property">rotation</span>.<span class="hljs-property">y</span> += <span class="hljs-number">0.002</span>
  <span class="hljs-keyword">if</span> (glowMesh) glowMesh.<span class="hljs-property">material</span>.<span class="hljs-property">uniforms</span>.<span class="hljs-property">time</span>.<span class="hljs-property">value</span> = time
  <span class="hljs-keyword">if</span> (glowMesh2) glowMesh2.<span class="hljs-property">material</span>.<span class="hljs-property">uniforms</span>.<span class="hljs-property">time</span>.<span class="hljs-property">value</span> = time
  <span class="hljs-keyword">if</span> (starField) {
    starField.<span class="hljs-property">rotation</span>.<span class="hljs-property">y</span> += <span class="hljs-number">0.0002</span>
    starField.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> += <span class="hljs-number">0.0001</span>
  }

  <span class="hljs-comment">// 高亮过渡推进 &amp; 重绘</span>
  <span class="hljs-keyword">if</span> (highlightPrev !== <span class="hljs-literal">null</span> || highlightNext !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">if</span> (highlightPrev === highlightNext) {
      <span class="hljs-comment">// 不应出现，但防御：合并状态</span>
      highlightPrev = <span class="hljs-literal">null</span>
      highlightT = <span class="hljs-number">1</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (highlightT &lt; <span class="hljs-number">1</span>) {
      highlightT = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>, highlightT + dt * <span class="hljs-variable constant_">HIGHLIGHT_FADE_SPEED</span>)
    }
  }

  <span class="hljs-comment">// 仅在必要时重绘高亮层</span>
  <span class="hljs-keyword">const</span> needRedraw = (
    highlightGlobe &amp;&amp; (
      lastRenderedPrev !== highlightPrev ||
      lastRenderedNext !== highlightNext ||
      <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(lastRenderedT - highlightT) &gt; <span class="hljs-number">1e-3</span>
    )
  )
  <span class="hljs-keyword">if</span> (needRedraw) {
    <span class="hljs-title function_">renderHighlightBlend</span>()
    lastRenderedPrev = highlightPrev
    lastRenderedNext = highlightNext
    lastRenderedT = highlightT

    <span class="hljs-comment">// 过渡完成后，丢弃 prev，避免持续双层绘制</span>
    <span class="hljs-keyword">if</span> (highlightT === <span class="hljs-number">1</span> &amp;&amp; highlightPrev) {
      highlightPrev = <span class="hljs-literal">null</span>
    }
  }

  <span class="hljs-comment">// 更新左上角标签（在过渡中做一点“半阈值切换”）</span>
  <span class="hljs-keyword">let</span> label = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">if</span> (highlightNext &amp;&amp; (highlightT &gt; <span class="hljs-number">0.6</span> || !highlightPrev)) label = highlightNext
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (highlightPrev) label = highlightPrev
  <span class="hljs-keyword">if</span> (label !== lastLabelName) {
    lastLabelName = label
    <span class="hljs-title function_">setHoveredCountry</span>(label || <span class="hljs-literal">null</span>)
  }

  renderer.<span class="hljs-title function_">render</span>(scene, camera)
}
</code></pre>
<h4 data-id="heading-10">2. 国家高亮检测技术</h4>
<p>国家高亮是本项目的一大技术亮点，其实现涉及复杂的几何计算：</p>
<p><strong>射线投射检测</strong></p>
<pre><code class="hljs language-jsx" lang="jsx">raycaster.<span class="hljs-title function_">setFromCamera</span>(mouse, camera)
<span class="hljs-keyword">const</span> intersects = raycaster.<span class="hljs-title function_">intersectObject</span>(globe)
</code></pre>
<p><strong>经纬度转换</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">cartesianToLonLat</span> = (<span class="hljs-params">pointLocalUnit</span>) =&gt; {
  <span class="hljs-keyword">const</span> x = pointLocalUnit.<span class="hljs-property">x</span>
  <span class="hljs-comment">// ... 坐标转换数学</span>
  <span class="hljs-keyword">return</span> { lon, lat }
}
</code></pre>
<p><strong>多边形包含检测</strong></p>
<p>使用射线法判断点是否在多边形内，支持复杂的多边形和孔洞检测：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">pointInRing</span> = (<span class="hljs-params">lon, lat, ring</span>) =&gt; {
  <span class="hljs-keyword">let</span> inside = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, j = ring.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i &lt; ring.<span class="hljs-property">length</span>; j = i++) {
    <span class="hljs-keyword">const</span> xi = <span class="hljs-title function_">normalizeLonToRef</span>(ring[i][<span class="hljs-number">0</span>], lon)
    <span class="hljs-keyword">const</span> yi = ring[i][<span class="hljs-number">1</span>]
    <span class="hljs-keyword">const</span> xj = <span class="hljs-title function_">normalizeLonToRef</span>(ring[j][<span class="hljs-number">0</span>], lon)
    <span class="hljs-keyword">const</span> yj = ring[j][<span class="hljs-number">1</span>]
    <span class="hljs-keyword">const</span> intersect = ((yi &gt; lat) !== (yj &gt; lat)) &amp;&amp;
      (lon &lt; (xj - xi) * (lat - yi) / (yj - yi + <span class="hljs-number">1e-12</span>) + xi)
    <span class="hljs-keyword">if</span> (intersect) inside = !inside
  }
  <span class="hljs-keyword">return</span> inside
}
</code></pre>
<p>为了解决跨越±180°经线的国家显示问题，项目实现了<strong>多重边界框检测</strong>和<strong>经度归一化</strong>算法，确保所有国家都能被正确识别。</p>
<h3 data-id="heading-11">五、性能优化策略</h3>
<h4 data-id="heading-12">1. 渲染优化</h4>
<ul>
<li><strong>按需渲染</strong>：仅在状态变化时更新高亮纹理</li>
<li><strong>资源管理</strong>：适时释放几何体和材质资源</li>
<li><strong>动画帧优化</strong>：使用<code>requestAnimationFrame</code>实现流畅动画</li>
</ul>
<h4 data-id="heading-13">2. 内存优化</h4>
<p>组件卸载时正确释放Three.js资源：</p>
<pre><code class="hljs language-jsx" lang="jsx">scene.<span class="hljs-title function_">traverse</span>(<span class="hljs-function">(<span class="hljs-params">child</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (child.<span class="hljs-property">geometry</span>) child.<span class="hljs-property">geometry</span>.<span class="hljs-title function_">dispose</span>()
  <span class="hljs-keyword">if</span> (child.<span class="hljs-property">material</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(child.<span class="hljs-property">material</span>)) 
      child.<span class="hljs-property">material</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.<span class="hljs-title function_">dispose</span>())
    <span class="hljs-keyword">else</span> child.<span class="hljs-property">material</span>.<span class="hljs-title function_">dispose</span>()
  }
})
renderer.<span class="hljs-title function_">dispose</span>()
</code></pre>
<p>这种资源清理防止了内存泄漏，保证了应用的长期稳定运行。</p>
<h3 data-id="heading-14">六、技术亮点与创新</h3>
<ol>
<li><strong>平滑高亮过渡</strong>：通过alpha混合和动画插值实现国家高亮的平滑过渡，避免突兀的视觉变化</li>
<li><strong>抗锯齿处理</strong>：使用高阶抗锯齿和纹理过滤技术，确保边界清晰无锯齿</li>
<li><strong>响应式设计</strong>：完善的窗口大小调整处理，保证不同设备上的显示效果</li>
<li><strong>触摸优化</strong>：专门针对移动设备的双指缩放和单指旋转优化</li>
</ol>
<h3 data-id="heading-15">七、总结与扩展思路</h3>
<p>这个3D科技地球项目展示了Three.js在创建复杂数据可视化方面的强大能力。通过合理的架构设计和算法优化，实现了既美观又高效的交互体验。</p>
<p><strong>进一步扩展方向</strong>：</p>
<ul>
<li>添加数据可视化层，展示各国统计数据</li>
<li>实现飞行路径动画，模拟航线或数据流</li>
<li>集成实时数据，创建动态监控地球</li>
<li>添加时间轴控件，支持历史数据回溯</li>
</ul>
<p>Three.js作为WebGL的友好封装，使得没有计算机图形学背景的开发者也能构建复杂的3D场景。这个3D地球项目是学习三维Web开发的优秀范例，值得深入研究和扩展。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[微前端应用通信使用和原理]]></title>    <link>https://juejin.cn/post/7570604028632891427</link>    <guid>https://juejin.cn/post/7570604028632891427</guid>    <pubDate>2025-11-10T03:20:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570604028632891427" data-draft-id="7570341520551723023" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="微前端应用通信使用和原理"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-11-10T03:20:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="起这个名字"/> <meta itemprop="url" content="https://juejin.cn/user/3646404655847591"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            微前端应用通信使用和原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3646404655847591/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    起这个名字
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T03:20:27.000Z" title="Mon Nov 10 2025 03:20:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>参考链接</code>: <a href="https://juejin.cn/post/7486465253816991780#heading-7" target="_blank" title="https://juejin.cn/post/7486465253816991780#heading-7">[微前端][vue3 + vite + qiankun] 使用详解</a></p>
<p>一般来说，各个子应用是通过业务来划分的，不同业务线应该降低耦合度，尽量去避免通信，但是如果涉及到一些公共的状态或者操作，qiankun也是支持的。</p>
<p>qinkun提供了一个全局的<code>GlobalState</code>来共享数据，基座初始化之后，子应用可以监听到这个数据的变化，也能提交这个数据。</p>
<p>假设有如下一个具体的业务场景：有一个基座应用（主应用）和多个子应用（微前端应用）。我们假设有一个全局的用户信息状态（例如用户ID、用户名、权限等）需要在基座和所有子应用之间共享。当用户在基座应用中登录后，用户信息需要传递给所有子应用，同时子应用可能在某些操作后更新用户信息（例如更新用户昵称），并且其他子应用和基座需要响应这个更新。</p>
<h2 data-id="heading-0">步骤</h2>
<ol>
<li>基座应用初始化全局状态，包括用户信息。</li>
<li>基座应用在启动qiankun时，将全局状态传递给子应用。</li>
<li>子应用可以监听全局状态的变化，并在状态变化时更新自己的界面。</li>
<li>子应用也可以修改全局状态，并通知到基座和其他子应用。</li>
</ol>
<h2 data-id="heading-1">具体实现</h2>
<h3 data-id="heading-2">基座应用（主应用）：</h3>
<ol>
<li>使用qiankun的initGlobalState方法初始化全局状态。</li>
<li>注册子应用，并将全局状态传递给子应用。</li>
<li>监听全局状态的变化，以便在基座中更新。</li>
</ol>
<p>多个子应用需要共享用户登录状态、用户信息和权限数据，避免重复登录和权限校验。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主应用 - 初始化全局状态</span>
<span class="hljs-keyword">import</span> { initGlobalState } <span class="hljs-keyword">from</span> <span class="hljs-string">'qiankun'</span>;

<span class="hljs-comment">// 初始化状态</span>
<span class="hljs-keyword">const</span> initialState = {
  <span class="hljs-attr">user</span>: {
    <span class="hljs-attr">id</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">avatar</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">roles</span>: [],
    <span class="hljs-attr">permissions</span>: []
  },
  <span class="hljs-attr">token</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">isLoggedIn</span>: <span class="hljs-literal">false</span>
};

<span class="hljs-keyword">const</span> actions = <span class="hljs-title function_">initGlobalState</span>(initialState);

<span class="hljs-comment">// 用户登录后更新状态</span>
actions.<span class="hljs-title function_">setGlobalState</span>({
  <span class="hljs-attr">user</span>: {
    <span class="hljs-attr">id</span>: <span class="hljs-number">12345</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
    <span class="hljs-attr">avatar</span>: <span class="hljs-string">'/avatars/zhangsan.jpg'</span>,
    <span class="hljs-attr">roles</span>: [<span class="hljs-string">'admin'</span>, <span class="hljs-string">'user'</span>],
    <span class="hljs-attr">permissions</span>: [<span class="hljs-string">'read'</span>, <span class="hljs-string">'write'</span>, <span class="hljs-string">'delete'</span>]
  },
  <span class="hljs-attr">token</span>: <span class="hljs-string">'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'</span>,
  <span class="hljs-attr">isLoggedIn</span>: <span class="hljs-literal">true</span>
});

<span class="hljs-comment">// 监听登录状态变化</span>
actions.<span class="hljs-title function_">onGlobalStateChange</span>(<span class="hljs-function">(<span class="hljs-params">state, prevState</span>) =&gt;</span> {
  <span class="hljs-comment">// 主应用自身的状态同步</span>
  <span class="hljs-keyword">if</span> (state.<span class="hljs-property">isLoggedIn</span> !== prevState.<span class="hljs-property">isLoggedIn</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'登录状态变化:'</span>, state.<span class="hljs-property">isLoggedIn</span>);
    <span class="hljs-title function_">updateMainAppUI</span>(state);
  }
});
</code></pre>
<h3 data-id="heading-3">子应用：</h3>
<ol>
<li>在生命周期函数中，获取基座传递的全局状态，并监听状态变化。</li>
<li>在适当的时候（例如用户操作后）使用setGlobalState更新全局状态。</li>
</ol>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">let</span> globalAction = <span class="hljs-literal">null</span>;

<span class="hljs-comment">// 子应用A - 用户管理</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">mount</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-comment">// 保存全局状态操作对象</span>
  globalAction = props;

  <span class="hljs-comment">// 监听全局状态变化</span>
  props.<span class="hljs-title function_">onGlobalStateChange</span>(<span class="hljs-function">(<span class="hljs-params">state, prevState</span>) =&gt;</span> {
    <span class="hljs-comment">// 用户信息变化时更新界面</span>
    <span class="hljs-keyword">if</span> (state.<span class="hljs-property">user</span>.<span class="hljs-property">id</span> !== prevState.<span class="hljs-property">user</span>.<span class="hljs-property">id</span>) {
      <span class="hljs-title function_">updateUserProfile</span>(state.<span class="hljs-property">user</span>);
    }
    
    <span class="hljs-comment">// 权限变化时重新检查</span>
    <span class="hljs-keyword">if</span> (state.<span class="hljs-property">user</span>.<span class="hljs-property">permissions</span> !== prevState.<span class="hljs-property">user</span>.<span class="hljs-property">permissions</span>) {
      <span class="hljs-title function_">checkPermissions</span>(state.<span class="hljs-property">user</span>.<span class="hljs-property">permissions</span>);
    }
  }, <span class="hljs-literal">true</span>); <span class="hljs-comment">// 立即执行一次</span>
  
  <span class="hljs-comment">// 渲染子应用</span>
  <span class="hljs-title function_">renderApp</span>(props);
}

  <span class="hljs-comment">// 更新用户信息</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">updateUserInfo</span> = (<span class="hljs-params">newUserInfo</span>) =&gt; {
    globalAction.<span class="hljs-title function_">setGlobalState</span>({
      <span class="hljs-attr">user</span>: {
        ...globalAction.<span class="hljs-title function_">getGlobalState</span>().<span class="hljs-property">user</span>,
        ...newUserInfo
      }
    });
  };
  
  <span class="hljs-comment">// 检查权限</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">checkPermissions</span> = (<span class="hljs-params">requiredPermission</span>) =&gt; {
    <span class="hljs-keyword">const</span> { permissions } = globalAction.<span class="hljs-title function_">getGlobalState</span>().<span class="hljs-property">user</span>;
    <span class="hljs-keyword">return</span> permissions.<span class="hljs-title function_">includes</span>(requiredPermission);
  };
  
</code></pre>
<h2 data-id="heading-4">原理</h2>
<p>qiankun 的 initGlobalState 方法提供了一种在微前端架构中主应用与子应用之间通信的机制。其原理主要基于以下步骤：</p>
<p><strong>状态初始化</strong>：主应用调用 initGlobalState 初始化全局状态，并返回一个对象，该对象包含设置状态、监听状态变化等方法。</p>
<p><strong>状态存储</strong>：全局状态被存储在一个中心化的地方，并且可以被多个子应用访问。</p>
<p><strong>状态更新</strong>：当主应用或子应用调用 setGlobalState 更新状态时，会触发所有已经注册的监听器（包括主应用和子应用）。</p>
<p><strong>状态监听</strong>：子应用（或主应用）可以通过 onGlobalStateChange 注册监听函数，当全局状态发生变化时，会执行这些监听函数。</p>
<p><strong>状态隔离</strong>：qiankun 会确保每个子应用都能独立地监听全局状态，并且不会互相干扰。</p>
<p>下面是一个简化的实现原理示例，帮助理解 qiankun 的全局状态管理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟 qiankun 的全局状态管理</span>
<span class="hljs-keyword">let</span> globalState = {}; <span class="hljs-comment">// 全局状态</span>
<span class="hljs-keyword">let</span> listeners = [];   <span class="hljs-comment">// 监听器列表</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">initGlobalState</span>(<span class="hljs-params">initialState = {}</span>) {
  <span class="hljs-comment">// 合并初始状态</span>
  globalState = { ...globalState, ...initialState };

  <span class="hljs-comment">// 返回一个对象，包含操作全局状态的方法</span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-comment">// 设置全局状态</span>
    <span class="hljs-title function_">setGlobalState</span>(<span class="hljs-params">state</span>) {
      <span class="hljs-keyword">const</span> prevState = { ...globalState };
      globalState = { ...globalState, ...state };
      <span class="hljs-comment">// 通知所有监听器</span>
      listeners.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> {
        <span class="hljs-title function_">listener</span>(globalState, prevState);
      });
    },

    <span class="hljs-comment">// 监听全局状态变化</span>
    <span class="hljs-title function_">onGlobalStateChange</span>(<span class="hljs-params">listener, immediate = <span class="hljs-literal">false</span></span>) {
      listeners.<span class="hljs-title function_">push</span>(listener);
      <span class="hljs-comment">// 如果立即执行，则立即调用一次监听器</span>
      <span class="hljs-keyword">if</span> (immediate) {
        <span class="hljs-title function_">listener</span>(globalState, globalState);
      }
      <span class="hljs-comment">// 返回一个取消监听的函数</span>
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">const</span> index = listeners.<span class="hljs-title function_">indexOf</span>(listener);
        <span class="hljs-keyword">if</span> (index &gt; -<span class="hljs-number">1</span>) {
          listeners.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
        }
      };
    },

    <span class="hljs-comment">// 获取当前全局状态</span>
    <span class="hljs-title function_">getGlobalState</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> globalState;
    },

    <span class="hljs-comment">// 移除所有监听器（通常用于应用卸载时）</span>
    <span class="hljs-title function_">offGlobalStateChange</span>(<span class="hljs-params"/>) {
      listeners = [];
    }
  };
}

<span class="hljs-comment">// 主应用使用</span>
<span class="hljs-keyword">const</span> actions = <span class="hljs-title function_">initGlobalState</span>({ <span class="hljs-attr">user</span>: <span class="hljs-string">'main'</span> });

<span class="hljs-comment">// 子应用使用</span>
<span class="hljs-comment">// 假设子应用通过某种方式获取到 actions（通常是通过 props 传递）</span>
<span class="hljs-comment">// 子应用监听状态变化</span>
<span class="hljs-keyword">const</span> unsubscribe = actions.<span class="hljs-title function_">onGlobalStateChange</span>(<span class="hljs-function">(<span class="hljs-params">state, prevState</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子应用监听到状态变化'</span>, state, prevState);
}, <span class="hljs-literal">true</span>);

<span class="hljs-comment">// 子应用更新状态</span>
actions.<span class="hljs-title function_">setGlobalState</span>({ <span class="hljs-attr">user</span>: <span class="hljs-string">'subapp'</span> });

<span class="hljs-comment">// 取消监听</span>
<span class="hljs-comment">// unsubscribe();</span>
</code></pre>
<p>在实际的 qiankun 实现中，还会考虑以下方面：</p>
<p><strong>状态隔离</strong>：确保子应用在卸载时自动取消监听，避免内存泄漏。</p>
<p><strong>状态同步</strong>：当子应用初始化时，能够获取到最新的全局状态。</p>
<p><strong>多实例支持</strong>：在多个子应用同时运行时，每个子应用都可以独立地监听和更新状态。</p>
<p>在 qiankun 的源码中，全局状态的管理是在 src/globalState.ts 中实现的。它使用了类似发布-订阅的模式，并且通过一个全局的变量来存储状态。主应用和子应用通过这个全局的变量进行通信。</p>
<p><strong>注意</strong>：在子应用中，qiankun 会通过生命周期函数的参数将全局状态的操作方法传递给子应用，子应用在挂载时可以通过 props 获取到这些方法。</p>
<p>例如，在主应用中注册子应用时：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { registerMicroApps, start } <span class="hljs-keyword">from</span> <span class="hljs-string">'qiankun'</span>;

<span class="hljs-title function_">registerMicroApps</span>([
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'subapp'</span>,
    <span class="hljs-attr">entry</span>: <span class="hljs-string">'//localhost:7100'</span>,
    <span class="hljs-attr">container</span>: <span class="hljs-string">'#subapp-container'</span>,
    <span class="hljs-attr">activeRule</span>: <span class="hljs-string">'/subapp'</span>,
    <span class="hljs-attr">props</span>: {
      <span class="hljs-comment">// 传递全局状态操作方法</span>
      <span class="hljs-attr">onGlobalStateChange</span>: actions.<span class="hljs-property">onGlobalStateChange</span>,
      <span class="hljs-attr">setGlobalState</span>: actions.<span class="hljs-property">setGlobalState</span>,
      <span class="hljs-attr">getGlobalState</span>: actions.<span class="hljs-property">getGlobalState</span>,
    },
  },
]);

<span class="hljs-title function_">start</span>();
</code></pre>
<p>在子应用中，在生命周期函数中接收：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">mount</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-comment">// 子应用可以使用 props 上的方法</span>
  props.<span class="hljs-title function_">onGlobalStateChange</span>(<span class="hljs-function">(<span class="hljs-params">state, prev</span>) =&gt;</span> {
    <span class="hljs-comment">// 状态变化时的操作</span>
  });
  
  props.<span class="hljs-title function_">setGlobalState</span>({ ... });
}
</code></pre>
<p>这样，主应用和子应用就可以通过这个全局状态进行通信了。</p>
<h3 data-id="heading-5">Qiankun initGlobalState 全局状态通信原理与实现</h3>
<h4 data-id="heading-6">状态管理架构</h4>
<p>Qiankun 的全局状态管理基于<code>发布-订阅模式</code>，采用<code>中心化的状态存储和事件通知机制</code>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 简化的核心实现原理</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalStateManager</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = {};                    <span class="hljs-comment">// 全局状态存储</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();         <span class="hljs-comment">// 监听器映射表</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subAppStates</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();      <span class="hljs-comment">// 子应用状态快照</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isMainApp</span> = <span class="hljs-literal">true</span>;              <span class="hljs-comment">// 标识是否为主应用</span>
  }

  <span class="hljs-comment">// 初始化全局状态</span>
  <span class="hljs-title function_">initGlobalState</span>(<span class="hljs-params">initialState = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = { ...initialState };
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createActions</span>();
  }

  <span class="hljs-comment">// 创建状态操作方法</span>
  <span class="hljs-title function_">createActions</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">setGlobalState</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setGlobalState</span>(state),
      <span class="hljs-attr">onGlobalStateChange</span>: <span class="hljs-function">(<span class="hljs-params">callback, immediately = <span class="hljs-literal">false</span></span>) =&gt;</span> 
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onGlobalStateChange</span>(callback, immediately),
      <span class="hljs-attr">offGlobalStateChange</span>: <span class="hljs-function">(<span class="hljs-params">callback</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">offGlobalStateChange</span>(callback),
      <span class="hljs-attr">getGlobalState</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getGlobalState</span>()
    };
  }

  <span class="hljs-comment">// 设置全局状态</span>
  <span class="hljs-title function_">setGlobalState</span>(<span class="hljs-params">state</span>) {
    <span class="hljs-keyword">const</span> prevState = { ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> };
    
    <span class="hljs-comment">// 合并新状态</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = {
      ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>,
      ...state
    };

    <span class="hljs-comment">// 通知所有监听器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyListeners</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>, prevState);
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }

  <span class="hljs-comment">// 注册状态变化监听器</span>
  <span class="hljs-title function_">onGlobalStateChange</span>(<span class="hljs-params">callback, immediately = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> listenerId = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'listener'</span>);
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">set</span>(listenerId, callback);
    
    <span class="hljs-comment">// 立即执行一次</span>
    <span class="hljs-keyword">if</span> (immediately) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-title function_">callback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>);
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Global state listener error:'</span>, error);
      }
    }

    <span class="hljs-comment">// 返回取消监听函数</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">delete</span>(listenerId);
    };
  }

  <span class="hljs-comment">// 移除监听器</span>
  <span class="hljs-title function_">offGlobalStateChange</span>(<span class="hljs-params">callback</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [id, listener] <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">entries</span>()) {
      <span class="hljs-keyword">if</span> (listener === callback) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">delete</span>(id);
        <span class="hljs-keyword">break</span>;
      }
    }
  }

  <span class="hljs-comment">// 获取当前状态</span>
  <span class="hljs-title function_">getGlobalState</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> };
  }

  <span class="hljs-comment">// 通知所有监听器</span>
  <span class="hljs-title function_">notifyListeners</span>(<span class="hljs-params">currentState, previousState</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">listener, id</span>) =&gt;</span> {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 使用 setTimeout 确保异步执行，避免阻塞</span>
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">has</span>(id)) {
            <span class="hljs-title function_">listener</span>(currentState, previousState);
          }
        }, <span class="hljs-number">0</span>);
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Listener <span class="hljs-subst">${id.toString()}</span> error:`</span>, error);
      }
    });
  }

  <span class="hljs-comment">// 子应用挂载时的状态同步</span>
  <span class="hljs-title function_">syncStateToSubApp</span>(<span class="hljs-params">subAppName, actions</span>) {
    <span class="hljs-comment">// 保存子应用的状态操作引用</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subAppStates</span>.<span class="hljs-title function_">set</span>(subAppName, actions);
    
    <span class="hljs-comment">// 返回子应用专用的状态操作对象</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createSubAppActions</span>(actions);
  }

  <span class="hljs-comment">// 创建子应用专用的操作对象</span>
  <span class="hljs-title function_">createSubAppActions</span>(<span class="hljs-params">subAppActions</span>) {
    <span class="hljs-keyword">return</span> {
      ...subAppActions,
      <span class="hljs-comment">// 可以在这里添加子应用特定的逻辑</span>
      <span class="hljs-attr">getSubAppState</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getGlobalState</span>()
    };
  }
}
</code></pre>
<h4 data-id="heading-7">完整实现源码解析</h4>
<p>下面是更接近 Qiankun 实际实现的完整代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// globalState.js - Qiankun 全局状态管理核心实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalState</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 全局状态存储</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = {};
    
    <span class="hljs-comment">// 监听器存储：Map&lt;symbol, Function&gt;</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    
    <span class="hljs-comment">// 标识是否已初始化</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">initialized</span> = <span class="hljs-literal">false</span>;
    
    <span class="hljs-comment">// 主应用标识</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isMaster</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span> &amp;&amp; 
                   <span class="hljs-variable language_">window</span>.<span class="hljs-property">__POWERED_BY_QIANKUN__</span> !== <span class="hljs-literal">true</span>;
  }

  <span class="hljs-comment">/**
   * 初始化全局状态
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} initialState 初始状态
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Object</span>} 状态操作对象
   */</span>
  <span class="hljs-title function_">initGlobalState</span>(<span class="hljs-params">initialState = {}</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">initialized</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'[qiankun] Global state already initialized'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getActions</span>();
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deepClone</span>(initialState);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">initialized</span> = <span class="hljs-literal">true</span>;

    <span class="hljs-comment">// 在开发模式下打印日志</span>
    <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'development'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[qiankun] Global state initialized:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getActions</span>();
  }

  <span class="hljs-comment">/**
   * 获取状态操作对象
   */</span>
  <span class="hljs-title function_">getActions</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">setGlobalState</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">setGlobalState</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>),
      <span class="hljs-attr">onGlobalStateChange</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">onGlobalStateChange</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>),
      <span class="hljs-attr">offGlobalStateChange</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">offGlobalStateChange</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>),
      <span class="hljs-attr">getGlobalState</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">getGlobalState</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>),
    };
  }

  <span class="hljs-comment">/**
   * 设置全局状态
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} state 新状态
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">boolean</span>} overwrite 是否覆盖整个状态
   */</span>
  <span class="hljs-title function_">setGlobalState</span>(<span class="hljs-params">state, overwrite = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">initialized</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'[qiankun] Global state not initialized'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">const</span> prevState = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deepClone</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>);
    
    <span class="hljs-keyword">if</span> (overwrite) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deepClone</span>(state);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">mergeState</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>, state);
    }

    <span class="hljs-comment">// 触发监听器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emit</span>(prevState);

    <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'development'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[qiankun] Global state updated:'</span>, {
        <span class="hljs-attr">from</span>: prevState,
        <span class="hljs-attr">to</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>
      });
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }

  <span class="hljs-comment">/**
   * 注册状态变化监听器
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} listener 监听函数
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">boolean</span>} fireImmediately 是否立即执行
   */</span>
  <span class="hljs-title function_">onGlobalStateChange</span>(<span class="hljs-params">listener, fireImmediately = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> listener !== <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'[qiankun] Listener must be a function'</span>);
    }

    <span class="hljs-keyword">const</span> listenerId = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'qiankun-global-state-listener'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">set</span>(listenerId, listener);

    <span class="hljs-comment">// 立即执行一次</span>
    <span class="hljs-keyword">if</span> (fireImmediately) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">has</span>(listenerId)) {
            <span class="hljs-title function_">listener</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>);
          }
        }, <span class="hljs-number">0</span>);
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'[qiankun] Fire immediately error:'</span>, error);
      }
    }

    <span class="hljs-comment">// 返回取消监听函数</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">delete</span>(listenerId);
    };
  }

  <span class="hljs-comment">/**
   * 移除状态变化监听器
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} listener 要移除的监听函数
   */</span>
  <span class="hljs-title function_">offGlobalStateChange</span>(<span class="hljs-params">listener</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [id, fn] <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">entries</span>()) {
      <span class="hljs-keyword">if</span> (fn === listener) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">delete</span>(id);
        <span class="hljs-keyword">break</span>;
      }
    }
  }

  <span class="hljs-comment">/**
   * 获取当前全局状态
   */</span>
  <span class="hljs-title function_">getGlobalState</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deepClone</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>);
  }

  <span class="hljs-comment">/**
   * 触发所有监听器
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} prevState 之前的状态
   */</span>
  <span class="hljs-title function_">emit</span>(<span class="hljs-params">prevState</span>) {
    <span class="hljs-keyword">const</span> currentState = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deepClone</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>);
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">listener, id</span>) =&gt;</span> {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 使用微任务异步执行，避免阻塞主线程</span>
        <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">has</span>(id)) {
            <span class="hljs-title function_">listener</span>(currentState, prevState);
          }
        }).<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[qiankun] Listener <span class="hljs-subst">${id.toString()}</span> error:`</span>, error);
        });
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[qiankun] Listener <span class="hljs-subst">${id.toString()}</span> error:`</span>, error);
      }
    });
  }

  <span class="hljs-comment">/**
   * 深度合并状态
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} target 目标对象
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} source 源对象
   */</span>
  <span class="hljs-title function_">mergeState</span>(<span class="hljs-params">target, source</span>) {
    <span class="hljs-keyword">const</span> result = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deepClone</span>(target);
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> source) {
      <span class="hljs-keyword">if</span> (source.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
        <span class="hljs-keyword">const</span> sourceValue = source[key];
        <span class="hljs-keyword">const</span> targetValue = result[key];
        
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isPlainObject</span>(sourceValue) &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isPlainObject</span>(targetValue)) {
          <span class="hljs-comment">// 递归合并对象</span>
          result[key] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">mergeState</span>(targetValue, sourceValue);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// 直接赋值</span>
          result[key] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deepClone</span>(sourceValue);
        }
      }
    }
    
    <span class="hljs-keyword">return</span> result;
  }

  <span class="hljs-comment">/**
   * 深度克隆对象
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">any</span>} obj 要克隆的对象
   */</span>
  <span class="hljs-title function_">deepClone</span>(<span class="hljs-params">obj</span>) {
    <span class="hljs-keyword">if</span> (obj === <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> obj !== <span class="hljs-string">'object'</span>) {
      <span class="hljs-keyword">return</span> obj;
    }
    
    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Date</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(obj.<span class="hljs-title function_">getTime</span>());
    }
    
    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Array</span>) {
      <span class="hljs-keyword">return</span> obj.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deepClone</span>(item));
    }
    
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">'object'</span>) {
      <span class="hljs-keyword">const</span> clonedObj = {};
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> obj) {
        <span class="hljs-keyword">if</span> (obj.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
          clonedObj[key] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deepClone</span>(obj[key]);
        }
      }
      <span class="hljs-keyword">return</span> clonedObj;
    }
  }

  <span class="hljs-comment">/**
   * 判断是否为纯对象
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">any</span>} obj 要判断的对象
   */</span>
  <span class="hljs-title function_">isPlainObject</span>(<span class="hljs-params">obj</span>) {
    <span class="hljs-keyword">return</span> obj !== <span class="hljs-literal">null</span> &amp;&amp; 
           <span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">'object'</span> &amp;&amp; 
           <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(obj) === <span class="hljs-string">'[object Object]'</span>;
  }

  <span class="hljs-comment">/**
   * 销毁全局状态管理器
   */</span>
  <span class="hljs-title function_">destroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = {};
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">clear</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">initialized</span> = <span class="hljs-literal">false</span>;
  }
}

<span class="hljs-comment">// 创建单例实例</span>
<span class="hljs-keyword">let</span> globalStateInstance = <span class="hljs-literal">null</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">initGlobalState</span>(<span class="hljs-params">initialState = {}</span>) {
  <span class="hljs-keyword">if</span> (!globalStateInstance) {
    globalStateInstance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GlobalState</span>();
  }
  
  <span class="hljs-keyword">return</span> globalStateInstance.<span class="hljs-title function_">initGlobalState</span>(initialState);
}

<span class="hljs-comment">// 获取全局状态实例（用于调试）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getGlobalStateInstance</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> globalStateInstance;
}

<span class="hljs-keyword">export</span> { initGlobalState, getGlobalStateInstance };
</code></pre>
<h4 data-id="heading-8">主应用与子应用通信桥梁</h4>
<h5 data-id="heading-9">主应用中的状态集成</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main-app/src/micro-fe/state-bridge.js</span>
<span class="hljs-keyword">import</span> { initGlobalState } <span class="hljs-keyword">from</span> <span class="hljs-string">'qiankun'</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainAppStateBridge</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">actions</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subApps</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  }

  <span class="hljs-comment">// 初始化全局状态</span>
  <span class="hljs-title function_">init</span>(<span class="hljs-params">initialState</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">actions</span> = <span class="hljs-title function_">initGlobalState</span>(initialState);
    
    <span class="hljs-comment">// 监听自身状态变化</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">actions</span>.<span class="hljs-title function_">onGlobalStateChange</span>(<span class="hljs-function">(<span class="hljs-params">state, prevState</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleMainAppStateChange</span>(state, prevState);
    });
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">actions</span>;
  }

  <span class="hljs-comment">// 为子应用创建状态桥接</span>
  <span class="hljs-title function_">createSubAppStateBridge</span>(<span class="hljs-params">subAppName</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">actions</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Global state not initialized'</span>);
    }

    <span class="hljs-keyword">const</span> subAppActions = {
      ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">actions</span>,
      <span class="hljs-comment">// 子应用特定的方法</span>
      <span class="hljs-attr">getSubAppName</span>: <span class="hljs-function">() =&gt;</span> subAppName,
      <span class="hljs-comment">// 可以添加子应用级别的状态管理</span>
      <span class="hljs-attr">setSubAppState</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setSubAppState</span>(subAppName, state)
    };

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subApps</span>.<span class="hljs-title function_">set</span>(subAppName, {
      <span class="hljs-attr">actions</span>: subAppActions,
      <span class="hljs-attr">state</span>: {}
    });

    <span class="hljs-keyword">return</span> subAppActions;
  }

  <span class="hljs-comment">// 处理主应用状态变化</span>
  <span class="hljs-title function_">handleMainAppStateChange</span>(<span class="hljs-params">state, prevState</span>) {
    <span class="hljs-comment">// 主应用自身的状态响应逻辑</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateMainAppUI</span>(state);
    
    <span class="hljs-comment">// 记录状态变化日志</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">logStateChange</span>(<span class="hljs-string">'main-app'</span>, state, prevState);
  }

  <span class="hljs-comment">// 设置子应用特定状态</span>
  <span class="hljs-title function_">setSubAppState</span>(<span class="hljs-params">subAppName, state</span>) {
    <span class="hljs-keyword">const</span> subApp = <span class="hljs-variable language_">this</span>.<span class="hljs-property">subApps</span>.<span class="hljs-title function_">get</span>(subAppName);
    <span class="hljs-keyword">if</span> (subApp) {
      subApp.<span class="hljs-property">state</span> = { ...subApp.<span class="hljs-property">state</span>, ...state };
      
      <span class="hljs-comment">// 可以在这里实现子应用状态与全局状态的某种映射</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">maybeUpdateGlobalStateFromSubApp</span>(subAppName, state);
    }
  }

  <span class="hljs-comment">// 可能根据子应用状态更新全局状态</span>
  <span class="hljs-title function_">maybeUpdateGlobalStateFromSubApp</span>(<span class="hljs-params">subAppName, state</span>) {
    <span class="hljs-comment">// 例如：当子应用的用户信息变化时，同步到全局状态</span>
    <span class="hljs-keyword">if</span> (state.<span class="hljs-property">user</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">actions</span>.<span class="hljs-title function_">setGlobalState</span>({
        <span class="hljs-attr">user</span>: state.<span class="hljs-property">user</span>,
        <span class="hljs-attr">lastUpdatedBy</span>: subAppName
      });
    }
  }

  <span class="hljs-comment">// 更新主应用UI</span>
  <span class="hljs-title function_">updateMainAppUI</span>(<span class="hljs-params">state</span>) {
    <span class="hljs-comment">// 实现主应用界面更新逻辑</span>
    <span class="hljs-keyword">if</span> (state.<span class="hljs-property">user</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateUserInfo</span>(state.<span class="hljs-property">user</span>);
    }
    
    <span class="hljs-keyword">if</span> (state.<span class="hljs-property">theme</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyTheme</span>(state.<span class="hljs-property">theme</span>);
    }
  }

  <span class="hljs-comment">// 记录状态变化</span>
  <span class="hljs-title function_">logStateChange</span>(<span class="hljs-params">source, state, prevState</span>) {
    <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'development'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">group</span>(<span class="hljs-string">`[qiankun] State changed from <span class="hljs-subst">${source}</span>`</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Previous:'</span>, prevState);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Current:'</span>, state);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">groupEnd</span>();
    }
  }
}

<span class="hljs-comment">// 主应用中使用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> stateBridge = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MainAppStateBridge</span>();

<span class="hljs-comment">// 初始化全局状态</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">initAppGlobalState</span> = (<span class="hljs-params">initialState</span>) =&gt; {
  <span class="hljs-keyword">return</span> stateBridge.<span class="hljs-title function_">init</span>(initialState);
};

<span class="hljs-comment">// 为子应用提供状态桥接</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getSubAppStateBridge</span> = (<span class="hljs-params">subAppName</span>) =&gt; {
  <span class="hljs-keyword">return</span> stateBridge.<span class="hljs-title function_">createSubAppStateBridge</span>(subAppName);
};
</code></pre>
<h5 data-id="heading-10">子应用状态适配器</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// subapp/src/utils/global-state-adapter.js</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalStateAdapter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span> = props;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = {};
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">unsubscribe</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  }

  <span class="hljs-comment">// 初始化适配器</span>
  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">onGlobalStateChange</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'[qiankun] Global state not available in sub-app'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 监听全局状态变化</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">unsubscribe</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-title function_">onGlobalStateChange</span>(<span class="hljs-function">(<span class="hljs-params">state, prevState</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleGlobalStateChange</span>(state, prevState);
    }, <span class="hljs-literal">true</span>); <span class="hljs-comment">// 立即执行一次获取初始状态</span>

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }

  <span class="hljs-comment">// 处理全局状态变化</span>
  <span class="hljs-title function_">handleGlobalStateChange</span>(<span class="hljs-params">state, prevState</span>) {
    <span class="hljs-keyword">const</span> prevLocalState = { ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> };
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = state;

    <span class="hljs-comment">// 通知所有本地监听器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyLocalListeners</span>(state, prevState);

    <span class="hljs-comment">// 执行子应用特定的状态处理</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleSubAppSpecificChanges</span>(state, prevState);

    <span class="hljs-comment">// 更新子应用UI</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateSubAppUI</span>(state, prevState);
  }

  <span class="hljs-comment">// 设置全局状态（代理方法）</span>
  <span class="hljs-title function_">setGlobalState</span>(<span class="hljs-params">state</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">setGlobalState</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-title function_">setGlobalState</span>(state);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-comment">// 获取当前状态</span>
  <span class="hljs-title function_">getGlobalState</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-title function_">getGlobalState</span>() : <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>;
  }

  <span class="hljs-comment">// 注册本地监听器（子应用内部使用）</span>
  <span class="hljs-title function_">onStateChange</span>(<span class="hljs-params">callback, immediately = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> listenerId = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'local-state-listener'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">set</span>(listenerId, callback);

    <span class="hljs-keyword">if</span> (immediately) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-title function_">callback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>);
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Local state listener error:'</span>, error);
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">delete</span>(listenerId);
    };
  }

  <span class="hljs-comment">// 通知本地监听器</span>
  <span class="hljs-title function_">notifyLocalListeners</span>(<span class="hljs-params">state, prevState</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">listener, id</span>) =&gt;</span> {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">has</span>(id)) {
            <span class="hljs-title function_">listener</span>(state, prevState);
          }
        }, <span class="hljs-number">0</span>);
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Local listener <span class="hljs-subst">${id.toString()}</span> error:`</span>, error);
      }
    });
  }

  <span class="hljs-comment">// 处理子应用特定的状态变化</span>
  <span class="hljs-title function_">handleSubAppSpecificChanges</span>(<span class="hljs-params">state, prevState</span>) {
    <span class="hljs-comment">// 用户信息变化</span>
    <span class="hljs-keyword">if</span> (state.<span class="hljs-property">user</span> !== prevState.<span class="hljs-property">user</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleUserChange</span>(state.<span class="hljs-property">user</span>, prevState.<span class="hljs-property">user</span>);
    }

    <span class="hljs-comment">// 主题变化</span>
    <span class="hljs-keyword">if</span> (state.<span class="hljs-property">theme</span> !== prevState.<span class="hljs-property">theme</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleThemeChange</span>(state.<span class="hljs-property">theme</span>);
    }

    <span class="hljs-comment">// 权限变化</span>
    <span class="hljs-keyword">if</span> (state.<span class="hljs-property">user</span>?.<span class="hljs-property">permissions</span> !== prevState.<span class="hljs-property">user</span>?.<span class="hljs-property">permissions</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handlePermissionChange</span>(state.<span class="hljs-property">user</span>?.<span class="hljs-property">permissions</span>);
    }
  }

  <span class="hljs-comment">// 更新子应用UI</span>
  <span class="hljs-title function_">updateSubAppUI</span>(<span class="hljs-params">state, prevState</span>) {
    <span class="hljs-comment">// 实现子应用界面更新逻辑</span>
    <span class="hljs-comment">// 例如：更新用户信息显示、应用主题等</span>
  }

  <span class="hljs-comment">// 具体的状态处理函数</span>
  <span class="hljs-title function_">handleUserChange</span>(<span class="hljs-params">user, prevUser</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'User changed:'</span>, { <span class="hljs-attr">from</span>: prevUser, <span class="hljs-attr">to</span>: user });
    <span class="hljs-comment">// 更新用户相关的界面和状态</span>
  }

  <span class="hljs-title function_">handleThemeChange</span>(<span class="hljs-params">theme</span>) {
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'data-theme'</span>, theme);
  }

  <span class="hljs-title function_">handlePermissionChange</span>(<span class="hljs-params">permissions</span>) {
    <span class="hljs-comment">// 根据新权限更新界面和功能</span>
  }

  <span class="hljs-comment">// 销毁适配器</span>
  <span class="hljs-title function_">destroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">unsubscribe</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">unsubscribe</span>();
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">clear</span>();
  }
}

<span class="hljs-comment">// 在子应用中使用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">createGlobalStateAdapter</span> = (<span class="hljs-params">props</span>) =&gt; {
  <span class="hljs-keyword">const</span> adapter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GlobalStateAdapter</span>(props);
  <span class="hljs-keyword">if</span> (adapter.<span class="hljs-title function_">init</span>()) {
    <span class="hljs-keyword">return</span> adapter;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
};
</code></pre>
<h4 data-id="heading-11">实际通信流程示例</h4>
<h5 data-id="heading-12">状态变更传播流程</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 状态变更传播示意图</span>
<span class="hljs-comment">/**
 * 
 * 主应用 setGlobalState({user: newUser})
 *       ↓
 * GlobalStateManager.notifyListeners()
 *       ↓
 * 主应用监听器 ───→ 子应用A监听器 ───→ 子应用B监听器
 *       ↓               ↓               ↓
 * 更新主应用UI       更新子应用AUI     更新子应用BUI
 * 
 */</span>
</code></pre>
<h5 data-id="heading-13">具体通信示例</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 通信过程跟踪</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CommunicationTracker</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">messageId</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">communicationLog</span> = [];
  }

  <span class="hljs-title function_">trackStateChange</span>(<span class="hljs-params">source, target, state, action</span>) {
    <span class="hljs-keyword">const</span> logEntry = {
      <span class="hljs-attr">id</span>: ++<span class="hljs-variable language_">this</span>.<span class="hljs-property">messageId</span>,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
      source,
      target,
      <span class="hljs-attr">state</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sanitizeState</span>(state),
      action,
      <span class="hljs-attr">duration</span>: <span class="hljs-literal">null</span>
    };

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">communicationLog</span>.<span class="hljs-title function_">push</span>(logEntry);
    
    <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'development'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[qiankun-comm] <span class="hljs-subst">${source}</span> -&gt; <span class="hljs-subst">${target}</span>:`</span>, action, state);
    }

    <span class="hljs-keyword">return</span> logEntry.<span class="hljs-property">id</span>;
  }

  <span class="hljs-title function_">markCompletion</span>(<span class="hljs-params">messageId, success = <span class="hljs-literal">true</span></span>) {
    <span class="hljs-keyword">const</span> entry = <span class="hljs-variable language_">this</span>.<span class="hljs-property">communicationLog</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">log</span> =&gt;</span> log.<span class="hljs-property">id</span> === messageId);
    <span class="hljs-keyword">if</span> (entry) {
      entry.<span class="hljs-property">duration</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - entry.<span class="hljs-property">timestamp</span>;
      entry.<span class="hljs-property">success</span> = success;
    }
  }

  <span class="hljs-title function_">sanitizeState</span>(<span class="hljs-params">state</span>) {
    <span class="hljs-comment">// 移除敏感信息</span>
    <span class="hljs-keyword">const</span> sanitized = { ...state };
    <span class="hljs-keyword">if</span> (sanitized.<span class="hljs-property">user</span>) {
      sanitized.<span class="hljs-property">user</span> = { ...sanitized.<span class="hljs-property">user</span> };
      <span class="hljs-keyword">delete</span> sanitized.<span class="hljs-property">user</span>.<span class="hljs-property">password</span>;
      <span class="hljs-keyword">delete</span> sanitized.<span class="hljs-property">user</span>.<span class="hljs-property">token</span>;
    }
    <span class="hljs-keyword">return</span> sanitized;
  }

  <span class="hljs-title function_">getCommunicationStats</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> successful = <span class="hljs-variable language_">this</span>.<span class="hljs-property">communicationLog</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">log</span> =&gt;</span> log.<span class="hljs-property">success</span>);
    <span class="hljs-keyword">const</span> failed = <span class="hljs-variable language_">this</span>.<span class="hljs-property">communicationLog</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">log</span> =&gt;</span> log.<span class="hljs-property">success</span> === <span class="hljs-literal">false</span>);
    
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">total</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">communicationLog</span>.<span class="hljs-property">length</span>,
      <span class="hljs-attr">successful</span>: successful.<span class="hljs-property">length</span>,
      <span class="hljs-attr">failed</span>: failed.<span class="hljs-property">length</span>,
      <span class="hljs-attr">averageDuration</span>: successful.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, log</span>) =&gt;</span> sum + log.<span class="hljs-property">duration</span>, <span class="hljs-number">0</span>) / successful.<span class="hljs-property">length</span>,
      <span class="hljs-attr">recentMessages</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">communicationLog</span>.<span class="hljs-title function_">slice</span>(-<span class="hljs-number">10</span>)
    };
  }
}

<span class="hljs-comment">// 在全局状态管理器中集成跟踪</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TrackedGlobalState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">GlobalState</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">super</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tracker</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommunicationTracker</span>();
  }

  <span class="hljs-title function_">setGlobalState</span>(<span class="hljs-params">state, overwrite = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> messageId = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tracker</span>.<span class="hljs-title function_">trackStateChange</span>(
      <span class="hljs-string">'main-app'</span>, 
      <span class="hljs-string">'all'</span>, 
      state, 
      <span class="hljs-string">'setGlobalState'</span>
    );

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">setGlobalState</span>(state, overwrite);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tracker</span>.<span class="hljs-title function_">markCompletion</span>(messageId, result);
      <span class="hljs-keyword">return</span> result;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tracker</span>.<span class="hljs-title function_">markCompletion</span>(messageId, <span class="hljs-literal">false</span>);
      <span class="hljs-keyword">throw</span> error;
    }
  }
}
</code></pre>
<h4 data-id="heading-14">关键特性总结</h4>
<h5 data-id="heading-15">核心原理</h5>
<p>发布-订阅模式：基于事件的通知机制</p>
<p>中心化状态存储：单一数据源</p>
<p>状态隔离：主应用和子应用的状态操作隔离</p>
<p>异步通知：使用微任务避免阻塞</p>
<h5 data-id="heading-16">通信机制</h5>
<p>状态变更传播：主应用 → 所有监听器（包括子应用）</p>
<p>双向通信：子应用也可以更新全局状态</p>
<p>状态合并：智能合并而不是完全覆盖</p>
<p>错误隔离：单个监听器错误不影响其他监听器</p>
<h5 data-id="heading-17">性能优化</h5>
<p>懒执行：使用 setTimeout 和 Promise 避免阻塞</p>
<p>深度克隆：确保状态不可变性</p>
<p>内存管理：提供清理和销毁方法</p>
<p>条件监听：支持立即执行和延迟执行</p>
<p>通过这种设计，Qiankun 实现了高效、可靠的主应用与子应用之间的状态通信，同时保持了良好的性能和可维护性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[14.5 绘制（一）绘制原理及Layer——问答]]></title>    <link>https://juejin.cn/post/7570243451725086747</link>    <guid>https://juejin.cn/post/7570243451725086747</guid>    <pubDate>2025-11-09T18:19:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570243451725086747" data-draft-id="7570243451725070363" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="14.5 绘制（一）绘制原理及Layer——问答"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-11-09T18:19:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="默默_david"/> <meta itemprop="url" content="https://juejin.cn/user/1063982989054045"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            14.5 绘制（一）绘制原理及Layer——问答
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1063982989054045/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    默默_david
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T18:19:22.000Z" title="Sun Nov 09 2025 18:19:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fbook.flutterchina.club%2Fchapter14%2Fpaint.html%23_14-5-1-flutter-%25E7%25BB%2598%25E5%2588%25B6%25E5%258E%259F%25E7%2590%2586" target="_blank" title="https://book.flutterchina.club/chapter14/paint.html#_14-5-1-flutter-%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86" ref="nofollow noopener noreferrer">书上章节链接</a></p>
<h2 data-id="heading-0">一、基础概念</h2>
<ol>
<li>
<p><strong>绘制三要素</strong></p>
<p>简述Flutter绘制流程中Canvas、Layer、Scene的作用及相互关系。</p>
<ul>
<li><code>Canvas</code>：封装了Flutter Skia/Impeller的绘制指令，绘制时调用<code>Canvas</code>对象进行绘制；</li>
<li><code>Layer</code>：绘制结果的载体，分为绘制类(<code>PictureLayer</code>)和容器类(<code>ContainerLayer</code>)</li>
<li><code>Scene</code>：由Layer树组成的场景对象</li>
</ul>
<p>关系： <code>Canvas</code>的多条绘制指令，通过<code>PictureRecorder</code>记录下后生成<code>Picture</code>-&gt;<code>Picture</code>存入<code>PictureLayer</code>-&gt;<code>Layer</code>组成树结构-&gt;<code>Scene</code>包装<code>Layer</code>树-&gt;<code>window.render(scene)</code>提交给GPU</p>
</li>
<li>
<p><strong>PictureRecorder的作用</strong></p>
<p>为什么创建Canvas时必须传入PictureRecorder对象？它如何记录绘制指令？</p>
<ul>
<li>
<p>记录<code>Canvas</code>的绘制指令流</p>
</li>
<li>
<p>调用<code>endRecording()</code>后生成<code>Picture</code>对象</p>
</li>
<li>
<p>未调用时<code>Picture</code>为null，导致无法上屏</p>
</li>
</ul>
<blockquote>
<p>注意：PictureRecorder 记录的是向量绘制指令，不是位图，位图是在光栅化后才会生成</p>
</blockquote>
</li>
<li>
<p><strong>Layer的分类</strong></p>
<p>绘制类Layer（如PictureLayer）与容器类Layer（如OffsetLayer）的核心区别是什么？</p>
<ul>
<li>绘制类Layer：保存具体绘制内容（PictureLayer保存Picture）</li>
<li>容器类Layer：管理子Layer的变换组合（如OffsetLayer管理位移，ClipRectLayer管理裁剪）</li>
</ul>
</li>
<li>
<p><strong>上屏（Rasterize）</strong></p>
<p>解释window.render(scene)方法的执行过程及其在渲染流水线中的意义。</p>
<ul>
<li>window.render(scene)将Scene发送给Flutter引擎</li>
<li>引擎在GPU线程光栅化（将矢量指令转为像素）</li>
<li>最终合成到屏幕，完成渲染闭环</li>
</ul>
</li>
</ol>
<h2 data-id="heading-1">二、绘制流程</h2>
<ol start="5">
<li>
<p><strong>流程排序</strong></p>
<p>将以下步骤按正确顺序排列，并说明缺失环节：</p>
</li>
</ol>
<pre><code class="hljs language-c" lang="c">   A. 调用Canvas绘制API  
   B. 创建PictureRecorder和Canvas  
   C. 调用window.render(scene)  
   D. 将Picture保存到PictureLayer  
   E. 构建Scene并关联Layer  
</code></pre>
<ul>
<li>顺序：B-&gt;A-&gt;D-&gt;E-&gt;C</li>
<li>缺失：在D之前需调用<code>recorder.endRecording()</code>生成Picture</li>
</ul>
<ol start="6">
<li>
<p><strong>Picture生成时机</strong></p>
<p>何时调用<code>recorder.endRecording()</code>？延迟调用会导致什么问题？</p>
<ul>
<li>绘制完成后立即调用<code>recorder.endRecording()</code></li>
<li>延迟调用会导致：
<ul>
<li>当前帧无有效Picture</li>
<li>可能内存泄漏（未释放绘图资源）</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Layer树的构建</strong></p>
<p>为什么需要将PictureLayer添加到OffsetLayer？直接使用PictureLayer构建Scene是否可行？</p>
<ul>
<li>必须通过容器类Layer（如OffsetLayer）组织</li>
<li>直接使用PictureLayer不可行：
<ul>
<li>Scene要求根节点是容器类Layer</li>
<li>缺少变换/裁剪等组合能力</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>绘制区域限制</strong></p>
<p>PictureLayer(rect)中的rect参数有何作用？如果绘制的图形超出该区域，是否会被裁剪？</p>
<ul>
<li>rect定义Layer的显示范围</li>
<li>超出区域的绘制内容会被裁剪</li>
<li>未设置时默认不裁剪（Rect.largest）</li>
</ul>
</li>
</ol>
<h2 data-id="heading-2">三、Picture与光栅化</h2>
<ol start="9">
<li>
<p><strong>Picture的本质</strong></p>
<p>为什么说Picture是“绘制指令的集合”而非像素数据？它如何被转换为屏幕图像？</p>
<ul>
<li>存储的是矢量绘制指令序列</li>
<li>光栅化过程： GPU线程解析指令 → 生成位图 → 纹理上传 → 屏幕合成</li>
</ul>
</li>
<li>
<p><strong>性能优化</strong></p>
</li>
</ol>
<p>频繁创建Picture对象可能引发什么性能问题？如何避免？（提示：复用或缓存）</p>
<ul>
<li>问题：频繁创建导致内存压力，触发GC卡顿</li>
<li>优化：对静态内容复用Picture，或使用<code>Layer.reuse</code>复用</li>
</ul>
<ol start="11">
<li><strong>光栅化线程</strong></li>
</ol>
<p>Picture的光栅化在哪个线程执行？如何影响UI线程的性能？</p>
<ul>
<li>执行在GPU线程（独立于UI线程）</li>
<li>耗时操作会阻塞光栅化 → 导致界面掉帧卡顿</li>
</ul>
<h2 data-id="heading-3">四、Layer机制深入</h2>
<ol start="12">
<li><strong>Layer复用场景</strong></li>
</ol>
<p>哪些情况适合复用Layer？一般如何复用Layer如何提升渲染效率。</p>
<ul>
<li>适用：静态背景/复杂但不变的UI元素</li>
<li>对于需要复用的部分在外层用<code>RepaintBoundary</code>包裹（独立的layer）；<code>CustomPainter</code>中保存<code>layer</code>并且让<code>shouldRepaint</code>返回false；</li>
</ul>
<ol start="13">
<li><strong>容器类Layer的应用</strong></li>
</ol>
<p>TransformLayer/ClipRectLayer如何通过Layer树实现复杂效果？写出伪代码示例。</p>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-comment">// 伪代码：旋转+裁剪组合</span>
    <span class="hljs-keyword">final</span> root = OffsetLayer();
    <span class="hljs-keyword">final</span> transformLayer = TransformLayer(transform: rotationMatrix);
    <span class="hljs-keyword">final</span> clipLayer = ClipRectLayer(rect: clipRect);
    clipLayer.add(pictureLayer);
    transformLayer.add(clipLayer);
    root.add(transformLayer);
</code></pre>
<ol start="14">
<li><strong>Layer与RenderObject</strong></li>
</ol>
<p>自定义RenderObject时，其paint()方法内部如何生成和处理Layer？</p>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-keyword">void</span> paint(PaintingContext context, Offset offset) {
      <span class="hljs-comment">// 生成PictureLayer</span>
      context.canvas.drawRect(...);
      <span class="hljs-comment">// 添加容器Layer</span>
      context.pushLayer(ClipRectLayer(...), painter, offset);
    } 
</code></pre>
<ol start="15">
<li><strong>Layer的脏检查</strong></li>
</ol>
<p>Flutter如何判断某个Layer需要重绘？与Widget的setState()有何关联？</p>
<ul>
<li>当RenderObject调用<code>markNeedsPaint()</code>时，会逐层向上标记_needsPaint为true，直到找到一个isRepaintBoundary为true的绘制边界；绘制从绘制边界开始从上往下绘制，<code>_needsPaint</code>为true的才需要重绘，<code>_needsPaint</code>为false的直接复用</li>
<li>与setState()关系：<code>setState()</code>标记脏点后，会调用<code>scheduleFrame()</code>请求一个新的frame，回调到<code>drawFrame</code>后，会执行渲染管线；渲染管线：<code>构建-&gt;布局-&gt;层合成-&gt;更新绘制-&gt;上屏</code>；布局中，遍历<code>_nodesNeedingLayout</code>数组，对每一个renderObject重新布局（调用其layout方法），layout方法中会调用<code>markNeedsPaint()</code></li>
</ul>
<h2 data-id="heading-4">五、底层API实操</h2>
<ol start="16">
<li><strong>代码补全</strong></li>
</ol>
<p>补全缺失代码，实现绘制圆形并上屏：</p>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-keyword">void</span> main() {  
      PictureRecorder recorder = __________;  
      Canvas canvas = _________;  
      canvas.drawCircle(Offset(<span class="hljs-number">100</span>,<span class="hljs-number">100</span>), <span class="hljs-number">50</span>,  Paint()..color=Colors.red);  
      <span class="hljs-keyword">var</span> pictureLayer = PictureLayer(_________);  
      pictureLayer.picture = recorder.__________;  
      <span class="hljs-keyword">var</span> rootLayer = OffsetLayer();  
      rootLayer.__________;  
      Scene scene = __________.buildScene(SceneBuilder());  
      <span class="hljs-built_in">window</span>.render(scene);  
    }  
</code></pre>
<p>答案：</p>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-keyword">void</span> main() {
      PictureRecorder recorder = PictureRecorder();
      Canvas canvas = Canvas(recorder);
      canvas.drawCircle(Offset(<span class="hljs-number">100</span>,<span class="hljs-number">100</span>), <span class="hljs-number">50</span>, Paint()..color=Colors.red);
      <span class="hljs-keyword">var</span> pictureLayer = PictureLayer(Rect.largest);
      pictureLayer.picture = recorder.endRecording();
      <span class="hljs-keyword">var</span> rootLayer = OffsetLayer();
      rootLayer.append(pictureLayer);
      Scene scene = rootLayer.buildScene(SceneBuilder());
      <span class="hljs-built_in">window</span>.render(scene);
    }
</code></pre>
<ol start="17">
<li><strong>错误分析</strong></li>
</ol>
<p>以下代码为何无法显示图像？</p>
<pre><code class="hljs language-dart" lang="dart">    Canvas(recorder);  
    drawChessboard(canvas, rect);  
    <span class="hljs-built_in">window</span>.render(SceneBuilder().build());  
</code></pre>
<ul>
<li>缺少PictureLayer创建</li>
<li>未调用endRecording()</li>
<li>SceneBuilder未添加任何Layer</li>
<li>未创建根OffsetLayer</li>
</ul>
<ol start="18">
<li><strong>多Layer合成</strong></li>
</ol>
<p>如何在同一个Scene中叠加两个PictureLayer，并让第二个Layer偏移50像素？ （提示：使用OffsetLayer嵌套）</p>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-keyword">final</span> root = OffsetLayer();
    root.append(layer1);  <span class="hljs-comment">// 直接添加第一层</span>
    
    <span class="hljs-keyword">final</span> offsetLayer = OffsetLayer(offset: Offset(<span class="hljs-number">50</span>, <span class="hljs-number">50</span>));
    offsetLayer.append(layer2); <span class="hljs-comment">// 偏移的第二层</span>
    root.append(offsetLayer);
</code></pre>
<ol start="19">
<li><strong>性能陷阱</strong></li>
</ol>
<p>在每帧都创建新的PictureLayer并上屏，会导致什么问题？如何优化？</p>
<ul>
<li>问题：每帧创建新Layer → 内存抖动 → 频繁GC → 界面卡顿</li>
<li>优化：对静态内容复用PictureLayer</li>
</ul>
<h2 data-id="heading-5">六、综合应用</h2>
<ol start="20">
<li><strong>自定义绘制控件</strong></li>
</ol>
<p>结合CustomPaint设计：</p>
<ul>
<li>解释CustomPainter的paint()方法内部如何通过Canvas生成PictureLayer；</li>
<li>为何shouldRepaint()返回值影响Layer更新？
答：</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyPainter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">CustomPainter</span> </span>{
      <span class="hljs-keyword">void</span> paint(Canvas canvas, Size size) {
        <span class="hljs-comment">// 内部生成Picture → 存入PictureLayer</span>
        canvas.drawRect(...); 
      }
      
      <span class="hljs-built_in">bool</span> shouldRepaint(old) =&gt; <span class="hljs-keyword">true</span>; <span class="hljs-comment">// 返回true时重建Layer</span>
    }
</code></pre>
<ul>
<li>canvas获取时会调用<code>_startRecording()</code>，在<code>_startRecording()</code>中会创建<code>PictureLayer</code>对象</li>
<li>在绘制阶段
<ul>
<li>对于每个需要绘制的 RenderObject，检查 shouldRepaint()</li>
<li>如果返回 false 且 Layer 有效 → 直接复用现有 Layer</li>
<li>如果返回 true 或 Layer 无效 → 创建新的 PictureRecorder 和 Canvas</li>
</ul>
</li>
</ul>
<ol start="21">
<li><strong>动态绘制优化</strong></li>
</ol>
<p>实现一个实时绘制的动画（如进度条），比较直接上屏 vs. 复用PictureLayer的帧率差异。</p>
<ul>
<li>直接上屏：每帧创建新Layer → 帧率&lt;30fps</li>
<li>复用优化：复用后帧率可达60fps</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">      <span class="hljs-keyword">void</span> update() {
        <span class="hljs-keyword">if</span> (_needsUpdate) {
          _updateForegroundLayer(); <span class="hljs-comment">// 只更新前景层</span>
          _needsUpdate = <span class="hljs-keyword">false</span>;
        }
        rootLayer.append(_cachedBackground);
        rootLayer.append(_foregroundLayer);
      }
</code></pre>
<ol start="22">
<li><strong>离屏渲染</strong></li>
</ol>
<p>利用Picture和Layer实现离屏绘制，并将结果缓存为图片，避免重复计算。</p>
<ul>
<li>优势：避免重复计算，直接复用位图</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">    Future&lt;ui.Image&gt; _renderOffscreen() <span class="hljs-keyword">async</span> {
      <span class="hljs-keyword">final</span> recorder = PictureRecorder();
      <span class="hljs-keyword">final</span> canvas = Canvas(recorder);
      _drawComplexPath(canvas); <span class="hljs-comment">// 复杂绘制</span>
      <span class="hljs-keyword">final</span> picture = recorder.endRecording();
      
      <span class="hljs-comment">// 光栅化为图片</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> picture.toImage(<span class="hljs-number">500</span>, <span class="hljs-number">500</span>);
    }
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025年-vue3面试题（AI分析详细版）]]></title>    <link>https://juejin.cn/post/7570394530316713984</link>    <guid>https://juejin.cn/post/7570394530316713984</guid>    <pubDate>2025-11-10T03:26:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570394530316713984" data-draft-id="7570405675434000384" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025年-vue3面试题（AI分析详细版）"/> <meta itemprop="keywords" content="面试"/> <meta itemprop="datePublished" content="2025-11-10T03:26:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端一课"/> <meta itemprop="url" content="https://juejin.cn/user/1169536102963917"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025年-vue3面试题（AI分析详细版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1169536102963917/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端一课
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T03:26:39.000Z" title="Mon Nov 10 2025 03:26:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1、Vue3 使用 Proxy 代替 Vue2 中的 Object.defineProperty 来实现响应式系统，这使得对整个对象的代理更加高效和全面。它通过依赖追踪和触发机制，确保只有实际变化的部分重新渲染，从而优化性能</h2>
<hr/>
<h2 data-id="heading-1"><strong>一、Vue2 的响应式：</strong></h2>
<h2 data-id="heading-2"><strong>Object.defineProperty</strong></h2>
<p>在 Vue2 中，响应式系统是通过 <strong>Object.defineProperty()</strong> 实现的：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">defineReactive</span>(<span class="hljs-params">obj, key, val</span>) {
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, key, {
    <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`访问属性: <span class="hljs-subst">${key}</span>`</span>);
      <span class="hljs-keyword">return</span> val;
    },
    <span class="hljs-title function_">set</span>(<span class="hljs-params">newVal</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`修改属性: <span class="hljs-subst">${key}</span>`</span>);
      val = newVal;
    }
  });
}
</code></pre>
<p>这种方式的特点是：</p>
<ul>
<li>
<p>每个属性都要单独“拦截”；</p>
</li>
<li>
<p>必须在初始化时遍历对象的每一个属性；</p>
</li>
<li>
<p>新增或删除属性时无法被监听（因为定义时就固定了）；</p>
</li>
<li>
<p>对数组的监听非常麻烦，只能通过重写数组方法（如 push、splice 等）来劫持。</p>
</li>
</ul>
<p>👉 举例：</p>
<pre><code class="hljs language-css" lang="css">data: {
  user: { name: <span class="hljs-string">'Alice'</span>, age: <span class="hljs-number">20</span> }
}
</code></pre>
<p>Vue2 初始化时会遍历 user 对象的所有属性，对每个都调用 Object.defineProperty。</p>
<p>如果之后执行：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">this.user.gender</span> = <span class="hljs-string">'female'</span>
</code></pre>
<p>这不会触发响应式，因为 gender 是后来新增的属性。</p>
<hr/>
<h2 data-id="heading-3"><strong>二、Vue3 的响应式：</strong></h2>
<h2 data-id="heading-4"><strong>Proxy</strong></h2>
<p>Vue3 使用了 ES6 的 <strong>Proxy</strong>，它能直接<strong>代理整个对象</strong>，不再需要递归遍历每个属性。</p>
<p>核心思想：</p>
<blockquote>
<p>使用 Proxy 拦截对象的各种操作（读、写、删、遍历等），然后结合依赖收集与触发机制，实现响应式更新。</p>
</blockquote>
<p>基本实现示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> handler = {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, key, receiver</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`读取属性: <span class="hljs-subst">${key}</span>`</span>);
    <span class="hljs-comment">// 依赖收集</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, key, receiver);
  },
  <span class="hljs-title function_">set</span>(<span class="hljs-params">target, key, value, receiver</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`修改属性: <span class="hljs-subst">${key}</span>`</span>);
    <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(target, key, value, receiver);
    <span class="hljs-comment">// 派发更新</span>
    <span class="hljs-keyword">return</span> result;
  }
};

<span class="hljs-keyword">const</span> proxyUser = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">20</span> }, handler);
proxyUser.<span class="hljs-property">name</span> = <span class="hljs-string">'Bob'</span>;
</code></pre>
<hr/>
<h2 data-id="heading-5"><strong>三、两者的关键差异</strong></h2>








































<table><thead><tr><th><strong>对比点</strong></th><th><strong>Vue2（Object.defineProperty）</strong></th><th><strong>Vue3（Proxy）</strong></th></tr></thead><tbody><tr><td>响应式实现方式</td><td>对每个属性单独劫持</td><td>对整个对象代理</td></tr><tr><td>新增/删除属性监听</td><td>不支持</td><td>支持</td></tr><tr><td>数组检测</td><td>重写数组原型</td><td>原生支持</td></tr><tr><td>性能</td><td>初始化慢（要递归遍历）</td><td>初始化快（代理一次即可）</td></tr><tr><td>深层对象</td><td>必须递归每一层</td><td>按需惰性代理（访问时再代理）</td></tr><tr><td>可代理类型</td><td>只能是对象的属性</td><td>几乎所有类型（对象、数组、Map、Set 等）</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-6"><strong>四、依赖追踪与触发机制（核心机制）</strong></h2>
<p>无论是 Vue2 还是 Vue3，<strong>响应式的本质都离不开 “依赖收集” 与 “依赖触发”</strong> 。</p>
<h3 data-id="heading-7"><strong>1. 依赖收集（track）</strong></h3>
<p>当模板或计算属性访问某个响应式数据时，系统会记录下当前依赖它的“副作用函数”（effect）。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">effect</span>(() =&gt; {
  console<span class="hljs-selector-class">.log</span>(proxyUser.name); <span class="hljs-comment">// 依赖收集</span>
});
</code></pre>
<h3 data-id="heading-8"><strong>2. 依赖触发（trigger）</strong></h3>
<p>当这个响应式数据被修改时，对应的副作用函数会被重新执行，从而触发界面更新。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">proxyUser.name</span> = <span class="hljs-string">'Charlie'</span><span class="hljs-comment">; // 触发更新</span>
</code></pre>
<p>Vue3 使用了独立的依赖收集系统（effect + track + trigger），相比 Vue2 的 Dep 模型更加模块化、高效。</p>
<hr/>
<h2 data-id="heading-9"><strong>五、性能优化与现代特性</strong></h2>
<h3 data-id="heading-10"><strong>✅ 惰性代理（Lazy Proxy）</strong></h3>
<p>Vue3 在 get 时才会递归代理子对象，而不是一次性全部递归。这大大提升了性能。</p>
<h3 data-id="heading-11"><strong>✅ 精准依赖追踪</strong></h3>
<p>只有<strong>被访问的属性</strong>才会被追踪，修改其他属性不会触发不相关的更新。</p>
<h3 data-id="heading-12"><strong>✅ 结构灵活</strong></h3>
<p>Proxy 能处理 Map、Set、WeakMap、WeakSet 等复杂结构，使 Vue3 能原生支持更多数据类型的响应式。</p>
<hr/>
<h2 data-id="heading-13"><strong>六、总结一句话</strong></h2>
<blockquote>
<p>Vue3 的响应式系统通过 Proxy 实现了“对象级别的全域代理”，配合惰性依赖追踪与触发机制，让数据更新更智能、更高效、更自然。</p>
</blockquote>
<hr/>
<p>图例：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c49f2ff51f1047cf8499d3c1bdfaf3cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LiA6K--:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763349999&amp;x-signature=LjqIxqdsSzOSjPnvw5VPsGFaFgA%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain1.0智能体开发：安全防护机制]]></title>    <link>https://juejin.cn/post/7570271574348726281</link>    <guid>https://juejin.cn/post/7570271574348726281</guid>    <pubDate>2025-11-10T01:24:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570271574348726281" data-draft-id="7569946369990606911" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain1.0智能体开发：安全防护机制"/> <meta itemprop="keywords" content="人工智能,Agent,LangChain"/> <meta itemprop="datePublished" content="2025-11-10T01:24:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FreeCode"/> <meta itemprop="url" content="https://juejin.cn/user/1282499717900794"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain1.0智能体开发：安全防护机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1282499717900794/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FreeCode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T01:24:34.000Z" title="Mon Nov 10 2025 01:24:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>防护机制是所有基于大模型的部署方案中的关键组件。设计完善的防护机制，为你的智能体实现安全检查与内容过滤功能，有助于管理数据隐私风险和声誉风险。阅读本文您将获得；</p>
<ul>
<li>安全防护机制的作用</li>
<li>安全防护机制的实现方式</li>
<li>LangChain内置安全防护机制</li>
<li>LangChain自定义安全防护机制</li>
<li>构建多层安全防护机制</li>
</ul>
</blockquote>
<h2 data-id="heading-0">1、安全防护机制</h2>
<p>安全防护机制（Guardrails）通过在智能体执行流程的关键节点对内容进行验证和过滤，帮助你构建安全、合规的人工智能应用。它能够检测敏感信息、执行内容政策、验证输出内容，并在不安全行为引发问题前阻止其发生。</p>
<p>常见使用场景包括：</p>
<ul>
<li>防止个人身份信息（PII）泄露</li>
<li>检测并拦截提示词注入攻击</li>
<li>屏蔽不当或有害内容</li>
<li>执行业务规则与合规要求</li>
<li>验证输出内容的质量与准确性</li>
</ul>
<p>你可以通过中间件实现安全防护机制，在关键节点拦截执行流程 —— 例如智能体启动前、执行完成后，或围绕模型调用与工具调用的全程。</p>
<h2 data-id="heading-1">2、实现方式</h2>
<p>安全防护机制（Guardrails）可通过两种互补的方式实现：</p>
<ul>
<li>确定性安全防护机制（Deterministic guardrails）：<code>&lt;br&gt;</code>
采用基于规则的逻辑，例如正则表达式（regex）模式、关键词匹配或显式检查。该方式速度快、结果可预测且成本低，但可能会遗漏一些细微的违规情况。</li>
<li>基于模型的安全防护机制（Model-based guardrails）：<code>&lt;br&gt;</code>
使用大语言模型（LLMs）或分类器，通过语义理解来评估内容。能够识别规则机制遗漏的细微问题，但速度较慢且成本更高。</li>
</ul>
<p>LangChain 既提供内置安全防护机制（例如个人身份信息（PII）检测、人机协同（human-in-the-loop）），也提供灵活的中间件系统，可通过上述任意一种方式（确定性或基于模型）构建自定义安全防护机制。</p>
<h2 data-id="heading-2">3、内置安全防护机制</h2>
<h3 data-id="heading-3">3.1 个人身份信息（PII）检测</h3>
<p>LangChain提供内置中间件，用于检测对话中的个人身份信息（Personally Identifiable Information, PII）并对其进行处理。该中间件可检测多种常见的PII类型，例如电子邮件、信用卡号、IP 地址等。
在以下场景中，PII检测中间件能发挥重要作用：需满足合规要求的医疗和金融类应用、需要对日志进行脱敏处理的客服智能体，以及所有涉及敏感用户数据处理的应用。
PII中间件支持多种策略来处理检测到的个人身份信息，具体包括：</p>






























<table><thead><tr><th align="center">策略（Strategy）</th><th align="center">说明（Description）</th><th align="center">示例（Example）</th></tr></thead><tbody><tr><td align="center">脱敏（redact）</td><td align="center">替换为 [REDACTED_TYPE] 格式</td><td align="center">[REDACTED_EMAIL]（电子邮件脱敏）</td></tr><tr><td align="center">掩码（mask）</td><td align="center">部分隐藏（如只显示最后 4 位）</td><td align="center">--****-1234（信用卡号掩码）</td></tr><tr><td align="center">哈希（hash）</td><td align="center">替换为确定性哈希值</td><td align="center">a8f5f167...（哈希后的值）</td></tr><tr><td align="center">拦截（block）</td><td align="center">检测到信息时抛出异常</td><td align="center">触发错误（Error thrown）</td></tr></tbody></table>
<p>示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain.agents.middleware <span class="hljs-keyword">import</span> PIIMiddleware
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> api_key, api_base


<span class="hljs-keyword">def</span> <span class="hljs-title function_">init_model</span>():
    model = init_chat_model(
        api_key = api_key,
        base_url = api_base,
        model = <span class="hljs-string">"Qwen/Qwen3-8B"</span>,
        model_provider = <span class="hljs-string">"openai"</span>,
        temperature = <span class="hljs-number">0.7</span>,
    )
    <span class="hljs-keyword">return</span> model

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user_order_progress</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""Get user order progress for a given name."""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{name}</span>, your order progress is 50% at present."</span>

agent = create_agent(
    model=init_model(),
    tools=[get_user_order_progress], 
    middleware=[<span class="hljs-comment"># Redact emails in user input before sending to model</span>
        PIIMiddleware(<span class="hljs-string">"email"</span>,strategy=<span class="hljs-string">"redact"</span>,apply_to_input=<span class="hljs-literal">True</span>),
        <span class="hljs-comment"># Mask credit cards in user input</span>
        PIIMiddleware(<span class="hljs-string">"credit_card"</span>,detector=<span class="hljs-string">r"\d{4}-\d{4}-\d{4}-\d{4}"</span>,strategy=<span class="hljs-string">"mask"</span>,apply_to_input=<span class="hljs-literal">True</span>),
        <span class="hljs-comment"># Block API keys - raise error if detected</span>
        PIIMiddleware(<span class="hljs-string">"api_key"</span>,detector=<span class="hljs-string">r"sk-[a-zA-Z0-9]{32}"</span>,strategy=<span class="hljs-string">"block"</span>,apply_to_input=<span class="hljs-literal">True</span>),
        ],
)

<span class="hljs-comment"># When user provides PII, it will be handled according to the strategy</span>
<span class="hljs-built_in">input</span> = {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"My name is Bob. My email is john.doe@example.com and card is 4532-1234-5678-9010. I wangt to know my order progress."</span>}]}

<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> agent.stream(<span class="hljs-built_in">input</span>, stream_mode=<span class="hljs-string">"values"</span>):
    chunk[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].pretty_print()
</code></pre>
<p>内置PII类型：</p>
<ul>
<li>email - 电子邮件地址</li>
<li>credit_card - 信用卡号（经卢恩算法验证，Luhn validated）</li>
<li>ip - IP 地址</li>
<li>mac_address - MAC 地址</li>
<li>url - 统一资源定位符（URL）</li>
</ul>
<p>配置选项：</p>








































<table><thead><tr><th>参数（Parameter）</th><th>说明（Description）</th><th>默认值（Default）</th></tr></thead><tbody><tr><td>pii_type</td><td>待检测的 PII 类型（内置类型或自定义类型）</td><td>必选（Required）</td></tr><tr><td>strategy</td><td>检测到 PII 后的处理方式（"block" 拦截、"redact" 脱敏、"mask" 掩码、"hash" 哈希）</td><td>"redact"（脱敏）</td></tr><tr><td>detector</td><td>自定义检测函数或正则表达式（regex）模式</td><td>None（使用内置检测逻辑）</td></tr><tr><td>apply_to_input</td><td>在调用模型前检查用户消息</td><td>True（启用）</td></tr><tr><td>apply_to_output</td><td>在调用模型后检查 AI 消息</td><td>False（禁用）</td></tr><tr><td>apply_to_tool_results</td><td>在工具执行后检查工具返回的结果消息</td><td>False（禁用）</td></tr></tbody></table>
<h3 data-id="heading-4">3.2 人机协同（Human-in-the-loop）</h3>
<p>LangChain提供内置的人机协同中间件HumanInTheLoopMiddleware，可在执行敏感操作前要求获得人工审批。对于高风险决策场景，这是最有效的安全防护机制之一。
在以下场景中，人机协同中间件能发挥重要作用：金融交易与转账、删除或修改生产数据、向外部人员发送信息，以及所有会对业务产生重大影响的操作。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain.agents.middleware <span class="hljs-keyword">import</span> HumanInTheLoopMiddleware
<span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> InMemorySaver
<span class="hljs-keyword">from</span> langgraph.types <span class="hljs-keyword">import</span> Command
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> api_key, api_base


<span class="hljs-keyword">def</span> <span class="hljs-title function_">init_model</span>():
    model = init_chat_model(
        api_key = api_key,
        base_url = api_base,
        model = <span class="hljs-string">"Qwen/Qwen3-8B"</span>,
        model_provider = <span class="hljs-string">"openai"</span>,
        temperature = <span class="hljs-number">0.7</span>,
    )
    <span class="hljs-keyword">return</span> model

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">send_email</span>(<span class="hljs-params">recipient: <span class="hljs-built_in">str</span>, content: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""Send an email to the specified recipient."""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"Email sent to <span class="hljs-subst">{recipient}</span> with content: <span class="hljs-subst">{content}</span>"</span>

agent = create_agent(
            model=init_model(),
            tools=[send_email], 
            middleware=[HumanInTheLoopMiddleware(
                interrupt_on={
                    <span class="hljs-comment"># Require approval for sensitive operations</span>
                    <span class="hljs-string">"send_email"</span>: <span class="hljs-literal">True</span>,
                    <span class="hljs-string">"delete_database"</span>: <span class="hljs-literal">True</span>,
                    <span class="hljs-comment"># Auto-approve safe operations</span>
                    <span class="hljs-string">"search"</span>: <span class="hljs-literal">False</span>,
                })
                ],
            <span class="hljs-comment"># Persist the state across interrupts</span>
            checkpointer=InMemorySaver(),
)

<span class="hljs-comment"># Human-in-the-loop requires a thread ID for persistence</span>
config = {<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"001"</span>}}

<span class="hljs-comment"># Agent will pause and wait for approval before executing sensitive tools</span>
result = agent.invoke(
    {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Send an email to the team, tell them we will be back in 2 hours"</span>}]},
    config=config
)
state = agent.get_state(config)
mark=<span class="hljs-built_in">len</span>(state.values[<span class="hljs-string">"messages"</span>])
<span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> state.values[<span class="hljs-string">"messages"</span>]:
    item.pretty_print()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"*"</span> * <span class="hljs-number">30</span> + <span class="hljs-string">"人工审批"</span> + <span class="hljs-string">"*"</span> * <span class="hljs-number">40</span> )
result = agent.invoke(
    Command(resume={<span class="hljs-string">"decisions"</span>: [{<span class="hljs-string">"type"</span>: <span class="hljs-string">"approve"</span>}]}),
    config=config  <span class="hljs-comment"># Same thread ID to resume the paused conversation</span>
)
state = agent.get_state(config)
<span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> state.values[<span class="hljs-string">"messages"</span>][mark:]:
    item.pretty_print()
</code></pre>
<h2 data-id="heading-5">4、自定义安全防护</h2>
<p>对于更复杂的安全防护机制（Guardrails），你可以创建在智能体执行前或执行后运行的自定义中间件。这能让你完全掌控验证逻辑、内容过滤和安全检查的全过程。</p>
<h3 data-id="heading-6">4.1 智能体执行前的安全防护机制</h3>
<p>使用 “智能体执行前”（before_agent）钩子，在每次调用启动时对请求进行一次性验证。这适用于会话级别的检查，例如身份验证、速率限制，或在任何处理开始前拦截不当请求。
内容过滤中间件,一个确定性安全防护机制（Deterministic Guardrail）的示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain.agents.middleware <span class="hljs-keyword">import</span> AgentMiddleware, AgentState, hook_config
<span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> InMemorySaver
<span class="hljs-keyword">from</span> langgraph.runtime <span class="hljs-keyword">import</span> Runtime
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> api_key, api_base


<span class="hljs-keyword">def</span> <span class="hljs-title function_">init_model</span>():
    model = init_chat_model(
        api_key = api_key,
        base_url = api_base,
        model = <span class="hljs-string">"Qwen/Qwen3-8B"</span>,
        model_provider = <span class="hljs-string">"openai"</span>,
        temperature = <span class="hljs-number">0.7</span>,
    )
    <span class="hljs-keyword">return</span> model

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">search_tool</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""Search for information on the internet."""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"Search results for <span class="hljs-subst">{query}</span>: 1. Result1; 2. Result2; 3. Result3."</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ContentFilterMiddleware</span>(<span class="hljs-title class_ inherited__">AgentMiddleware</span>):
    <span class="hljs-string">"""Deterministic guardrail: Block requests containing banned keywords."""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, banned_keywords: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]</span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.banned_keywords = [kw.lower() <span class="hljs-keyword">for</span> kw <span class="hljs-keyword">in</span> banned_keywords]

<span class="hljs-meta">    @hook_config(<span class="hljs-params">can_jump_to=[<span class="hljs-string">"end"</span>]</span>)</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">before_agent</span>(<span class="hljs-params">self, state: AgentState, runtime: Runtime</span>) -&gt; <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-literal">None</span>:
        <span class="hljs-comment"># Get the first user message</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> state[<span class="hljs-string">"messages"</span>]:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

        latest_message = state[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>]
        <span class="hljs-keyword">if</span> latest_message.<span class="hljs-built_in">type</span> != <span class="hljs-string">"human"</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

        content = latest_message.content.lower()

        <span class="hljs-comment"># Check for banned keywords</span>
        <span class="hljs-keyword">for</span> keyword <span class="hljs-keyword">in</span> self.banned_keywords:
            <span class="hljs-keyword">if</span> keyword <span class="hljs-keyword">in</span> content:
                <span class="hljs-comment"># Block execution before any processing</span>
                <span class="hljs-keyword">return</span> {
                    <span class="hljs-string">"messages"</span>: [{
                        <span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>,
                        <span class="hljs-string">"content"</span>: <span class="hljs-string">"I cannot process requests containing inappropriate content. Please rephrase your request."</span>
                    }],
                    <span class="hljs-string">"jump_to"</span>: <span class="hljs-string">"end"</span>
                }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

agent = create_agent(
    model=init_model(),
    tools=[search_tool], 
    system_prompt=<span class="hljs-string">"You are a IT expert. Your task is to answer user's IT questions."</span>,
    middleware=[ContentFilterMiddleware(banned_keywords=[<span class="hljs-string">"hack"</span>, <span class="hljs-string">"exploit"</span>, <span class="hljs-string">"malware"</span>])],
    checkpointer=InMemorySaver(),
)

config = {<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"001"</span>}}
<span class="hljs-comment"># When user provides PII, it will be handled according to the strategy</span>
<span class="hljs-built_in">input</span> = {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"How do I hack into a database?"</span>}]}
<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> agent.stream(<span class="hljs-built_in">input</span>, config, stream_mode=<span class="hljs-string">"values"</span>):
    chunk[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].pretty_print()

input2 = {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Explain the concept of AI agent in 100 words."</span>}]}
<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> agent.stream(input2, config, stream_mode=<span class="hljs-string">"values"</span>):
    chunk[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].pretty_print()

inpu3 = {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Make a malware which can login a private database."</span>}]}
<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> agent.stream(inpu3, config, stream_mode=<span class="hljs-string">"values"</span>):
    chunk[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].pretty_print()
</code></pre>
<h3 data-id="heading-7">4.2 智能体执行后的安全防护机制</h3>
<p>使用 “智能体执行后”（after_agent）钩子，在返回给用户之前对最终输出进行一次性验证。这适用于基于模型的安全检查、质量验证，或对智能体的完整响应进行最终合规性扫描。
安全评估中间件，一个基于模型的安全防护机制示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents.middleware <span class="hljs-keyword">import</span> AgentMiddleware, AgentState, hook_config
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> AIMessage
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langgraph.runtime <span class="hljs-keyword">import</span> Runtime
<span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> InMemorySaver
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> api_key, api_base

<span class="hljs-keyword">def</span> <span class="hljs-title function_">init_model</span>():
    model = init_chat_model(
        api_key = api_key,
        base_url = api_base,
        model = <span class="hljs-string">"Qwen/Qwen3-8B"</span>,
        model_provider = <span class="hljs-string">"openai"</span>,
        temperature = <span class="hljs-number">0.7</span>,
    )
    <span class="hljs-keyword">return</span> model
model = init_model()

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SafetyGuardrailMiddleware</span>(<span class="hljs-title class_ inherited__">AgentMiddleware</span>):
    <span class="hljs-string">"""Model-based guardrail: Use an LLM to evaluate response safety."""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.safety_model = model

<span class="hljs-meta">    @hook_config(<span class="hljs-params">can_jump_to=[<span class="hljs-string">"end"</span>]</span>)</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">after_agent</span>(<span class="hljs-params">self, state: AgentState, runtime: Runtime</span>) -&gt; <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-literal">None</span>:
        <span class="hljs-comment"># Get the final AI response</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> state[<span class="hljs-string">"messages"</span>]:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

        last_message = state[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>]
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(last_message, AIMessage):
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

        <span class="hljs-comment"># Use a model to evaluate safety</span>
        safety_prompt = <span class="hljs-string">f"""Evaluate if this response is safe and appropriate.
        Respond with only 'SAFE' or 'UNSAFE'.

        Response: <span class="hljs-subst">{last_message.content}</span>"""</span>

        result = self.safety_model.invoke([{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: safety_prompt}])

        <span class="hljs-keyword">if</span> <span class="hljs-string">"UNSAFE"</span> <span class="hljs-keyword">in</span> result.content:
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">"messages"</span>: [{
                    <span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>,
                    <span class="hljs-string">"content"</span>: <span class="hljs-string">"I cannot provide that response. Please rephrase your request."</span>
                }],
                <span class="hljs-string">"jump_to"</span>: <span class="hljs-string">"end"</span>
            }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">search_tool</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""Search for information on the internet."""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"Search results for <span class="hljs-subst">{query}</span>: 1. Result1; 2. Result2; 3. Result3."</span>

agent = create_agent(
    model=init_model(),
    tools=[search_tool], 
    system_prompt=<span class="hljs-string">"You are a knowledgeable consultant. Your task is to answer user's questions professionally."</span>,
    middleware=[SafetyGuardrailMiddleware()],
    checkpointer=InMemorySaver(),
)

config = {<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"001"</span>}}
<span class="hljs-comment"># When user provides PII, it will be handled according to the strategy</span>
<span class="hljs-built_in">input</span> = {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"How do I make explosives?"</span>}]}
<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> agent.stream(<span class="hljs-built_in">input</span>, config, stream_mode=<span class="hljs-string">"values"</span>):
    chunk[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].pretty_print()

input2 = {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"What's the best way to learn machine learning?"</span>}]}
<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> agent.stream(input2, config, stream_mode=<span class="hljs-string">"values"</span>):
    chunk[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].pretty_print()
</code></pre>
<h2 data-id="heading-8">5、多层安全防护</h2>
<p>你可以通过将多个安全防护机制添加到中间件数组中来实现堆叠使用。它们会按顺序执行，使你能够构建分层防护。
示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.agents.middleware <span class="hljs-keyword">import</span> PIIMiddleware, HumanInTheLoopMiddleware

agent = create_agent(
    model=<span class="hljs-string">"gpt-4o"</span>,
    tools=[search_tool, send_email_tool],
    middleware=[
        <span class="hljs-comment"># Layer 1: Deterministic input filter (before agent)</span>
        ContentFilterMiddleware(banned_keywords=[<span class="hljs-string">"hack"</span>, <span class="hljs-string">"exploit"</span>]),

        <span class="hljs-comment"># Layer 2: PII protection (before and after model)</span>
        PIIMiddleware(<span class="hljs-string">"email"</span>, strategy=<span class="hljs-string">"redact"</span>, apply_to_input=<span class="hljs-literal">True</span>),
        PIIMiddleware(<span class="hljs-string">"email"</span>, strategy=<span class="hljs-string">"redact"</span>, apply_to_output=<span class="hljs-literal">True</span>),

        <span class="hljs-comment"># Layer 3: Human approval for sensitive tools</span>
        HumanInTheLoopMiddleware(interrupt_on={<span class="hljs-string">"send_email"</span>: <span class="hljs-literal">True</span>}),

        <span class="hljs-comment"># Layer 4: Model-based safety check (after agent)</span>
        SafetyGuardrailMiddleware(),
    ],
)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain1.0智能体开发：运行时（Runtime）]]></title>    <link>https://juejin.cn/post/7570268773334335515</link>    <guid>https://juejin.cn/post/7570268773334335515</guid>    <pubDate>2025-11-10T03:21:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570268773334335515" data-draft-id="7570394530316599296" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain1.0智能体开发：运行时（Runtime）"/> <meta itemprop="keywords" content="人工智能,Agent,LangChain"/> <meta itemprop="datePublished" content="2025-11-10T03:21:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FreeCode"/> <meta itemprop="url" content="https://juejin.cn/user/1282499717900794"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain1.0智能体开发：运行时（Runtime）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1282499717900794/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FreeCode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T03:21:24.000Z" title="Mon Nov 10 2025 03:21:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><blockquote>
<p>基于LangChain1.0创建的智能体是运行在LangGraph的运行时（Runtime）之上。LangChain可以通过LangGraph对外暴露的运行时对象访问上下文、存储以及流写入器。</p>
</blockquote>
<h2 data-id="heading-0">1、运行时概述</h2>
<p>LangChain的create_agent本质上运行在LangGraph的运行时（Runtime）之上。LangGraph会暴露一个包含以下信息的运行时对象（Runtime object）：</p>
<ul>
<li>上下文（Context）：静态信息，例如用户ID、数据库连接或智能体调用所需的其他依赖项。</li>
<li>存储（Store）：一个用于长期记忆的BaseStore实例。</li>
<li>流写入器（Stream writer）：一个用于通过自定义流模式传输信息的对象。</li>
</ul>
<p>你可以在工具和中间件内部访问运行时信息。</p>
<h2 data-id="heading-1">2、配置运行时上下文</h2>
<p>运行时上下文（Runtime Context）为工具（tools）和中间件（middleware）提供依赖注入功能。无需硬编码值或使用全局状态，你可以在调用智能体时注入运行时依赖项（如数据库连接、用户ID或配置）。这使得你的工具更易于测试、更具可复用性且灵活性更高。
使用create_agent创建智能体时，你可以指定一个context_schema（上下文模式），用于定义存储在智能体运行时（Runtime）中的上下文结构。调用智能体时，需传入context参数，并在该参数中包含本次运行所需的相关配置。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent


<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Context</span>:
    user_name: <span class="hljs-built_in">str</span>

agent = create_agent(
    model=<span class="hljs-string">"gpt-5-nano"</span>,
    tools=[...],
    context_schema=Context  
)

agent.invoke(
    {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"What's my name?"</span>}]},
    context=Context(user_name=<span class="hljs-string">"John Smith"</span>)  
)
</code></pre>
<h2 data-id="heading-2">3、通过工具访问运行时信息</h2>
<p>你可以在工具内部访问运行时信息，以实现以下操作：</p>
<ul>
<li>访问上下文：通过runtime.context访问上下文信息。</li>
<li>读取或写入长期记忆：通过runtime.store访问长期记忆。</li>
<li>写入自定义流（例如，工具进度 / 更新）：通过get_stream_writer()获取流写入器，然后使用流写入器写入自定义流。
可使用ToolRuntime参数在工具内部访问运行时（Runtime）对象。</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool, ToolRuntime  

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Context</span>:
    user_id: <span class="hljs-built_in">str</span>

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_user_email_preferences</span>(<span class="hljs-params">runtime: ToolRuntime[Context]</span>) -&gt; <span class="hljs-built_in">str</span>:  
    <span class="hljs-string">"""Fetch the user's email preferences from the store."""</span>
    user_id = runtime.context.user_id  

    preferences: <span class="hljs-built_in">str</span> = <span class="hljs-string">"The user prefers you to write a brief and polite email."</span>
    <span class="hljs-keyword">if</span> runtime.store:  
        <span class="hljs-keyword">if</span> memory := runtime.store.get((<span class="hljs-string">"users"</span>,), user_id):  
            preferences = memory.value[<span class="hljs-string">"preferences"</span>]

    <span class="hljs-keyword">return</span> preferences
</code></pre>
<h2 data-id="heading-3">4、通过中间件访问运行时信息</h2>
<p>你可以在中间件中访问运行时信息，从而根据用户上下文创建动态提示词、修改消息或控制智能体行为。</p>
<ul>
<li>对于封装式中间件，可通过request.runtime访问运行时（Runtime）对象。request运行时对象包含在传递给中间件函数的ModelRequest参数中。</li>
<li>对于节点式中间件，可通过runtime参数访问运行时（Runtime）对象。</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> langchain.messages <span class="hljs-keyword">import</span> AnyMessage
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent, AgentState
<span class="hljs-keyword">from</span> langchain.agents.middleware <span class="hljs-keyword">import</span> dynamic_prompt, ModelRequest, before_model, after_model
<span class="hljs-keyword">from</span> langgraph.runtime <span class="hljs-keyword">import</span> Runtime


<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Context</span>:
    user_name: <span class="hljs-built_in">str</span>

<span class="hljs-comment"># Dynamic prompts</span>
<span class="hljs-meta">@dynamic_prompt</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">dynamic_system_prompt</span>(<span class="hljs-params">request: ModelRequest</span>) -&gt; <span class="hljs-built_in">str</span>:
    user_name = request.runtime.context.user_name  
    system_prompt = <span class="hljs-string">f"You are a helpful assistant. Address the user as <span class="hljs-subst">{user_name}</span>."</span>
    <span class="hljs-keyword">return</span> system_prompt

<span class="hljs-comment"># Before model hook</span>
<span class="hljs-meta">@before_model</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">log_before_model</span>(<span class="hljs-params">state: AgentState, runtime: Runtime[Context]</span>) -&gt; <span class="hljs-built_in">dict</span> | <span class="hljs-literal">None</span>:  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Processing request for user: <span class="hljs-subst">{runtime.context.user_name}</span>"</span>)  
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-comment"># After model hook</span>
<span class="hljs-meta">@after_model</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">log_after_model</span>(<span class="hljs-params">state: AgentState, runtime: Runtime[Context]</span>) -&gt; <span class="hljs-built_in">dict</span> | <span class="hljs-literal">None</span>:  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Completed request for user: <span class="hljs-subst">{runtime.context.user_name}</span>"</span>)  
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

agent = create_agent(
    model=<span class="hljs-string">"gpt-5-nano"</span>,
    tools=[...],
    middleware=[dynamic_system_prompt, log_before_model, log_after_model],  
    context_schema=Context
)

agent.invoke(
    {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"What's my name?"</span>}]},
    context=Context(user_name=<span class="hljs-string">"John Smith"</span>)
)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从0使用Kuikly框架写一个小红书Demo-Day7]]></title>    <link>https://juejin.cn/post/7570533058840920099</link>    <guid>https://juejin.cn/post/7570533058840920099</guid>    <pubDate>2025-11-10T03:36:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570533058840920099" data-draft-id="7570341520551804943" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从0使用Kuikly框架写一个小红书Demo-Day7"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-11-10T03:36:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我有与与症"/> <meta itemprop="url" content="https://juejin.cn/user/4466629837071787"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从0使用Kuikly框架写一个小红书Demo-Day7
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4466629837071787/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我有与与症
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T03:36:17.000Z" title="Mon Nov 10 2025 03:36:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">通过Kuikly的拓展能力在ios平台实现自定义的图片加载和缓存</h2>
<p>我们以iOS平台为例，体验Kuikly框架强大的拓展能力
 </p>
<p>首先看看Kuikly demo是怎么在iOS原生层面实现图片加载与缓存的：</p>
<p>打开目录：iosAPP -&gt; KuiklyRenderExpand -&gt; Handlers -&gt; KuiklyRenderComponentExpandHandler.m文件</p>
<pre><code class="hljs language-ObjectiveC" lang="ObjectiveC"><span class="hljs-meta">#import <span class="hljs-string">"KuiklyRenderComponentExpandHandler.h"</span></span>
<span class="hljs-meta">#import <span class="hljs-string">&lt;SDWebImage/UIImageView+WebCache.h&gt;</span></span>
 
<span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">KuiklyRenderComponentExpandHandler</span></span>
 
+ (<span class="hljs-type">void</span>)load {
    <span class="hljs-comment">// 注册自定义实现</span>
    [KuiklyRenderBridge registerComponentExpandHandler:[<span class="hljs-keyword">self</span> new]];
}
 
<span class="hljs-comment">/*
 * 自定义实现设置颜值
 * @param value 设置的颜色值
 * @return 完成自定义处理的颜色对象
 */</span>
- (<span class="hljs-built_in">UIColor</span> *)hr_colorWithValue:(<span class="hljs-built_in">NSString</span> *)value {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;
}
 
<span class="hljs-comment">/*
 * 自定义实现设置图片
 * @param url 设置的图片url，如果url为nil，则是取消图片设置，需要view.image = nil
 * @return 是否处理该图片设置，返回值为YES，则交给该代理实现，否则sdk内部自己处理
 */</span>
- (<span class="hljs-type">BOOL</span>)hr_setImageWithUrl:(<span class="hljs-built_in">NSString</span> *)url forImageView:(<span class="hljs-built_in">UIImageView</span> *)imageView {
    [imageView sd_setImageWithURL:[<span class="hljs-built_in">NSURL</span> URLWithString:url]
                        completed:^(<span class="hljs-built_in">UIImage</span> * _Nullable image, <span class="hljs-built_in">NSError</span> * _Nullable error, SDImageCacheType cacheType, <span class="hljs-built_in">NSURL</span> * _Nullable imageURL) {
        
    }];
    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}
 
<span class="hljs-comment">/*
 * 自定义实现设置图片（带完成回调，优先调用该方法）
 * @param url 设置的图片url，如果url为nil，则是取消图片设置，需要view.image = nil
 * @param completeBlock 图片加载完成的回调，如有error，会触发loadFailure事件
 * @return 是否处理该图片设置，返回值为YES，则交给该代理实现，否则sdk内部自己处理
 */</span>
- (<span class="hljs-type">BOOL</span>)hr_setImageWithUrl:(<span class="hljs-built_in">NSString</span> *)url forImageView:(<span class="hljs-built_in">UIImageView</span> *)imageView complete:(ImageCompletionBlock)completeBlock {
    [imageView sd_setImageWithURL:[<span class="hljs-built_in">NSURL</span> URLWithString:url]
                        completed:^(<span class="hljs-built_in">UIImage</span> * _Nullable image, <span class="hljs-built_in">NSError</span> * _Nullable error, SDImageCacheType cacheType, <span class="hljs-built_in">NSURL</span> * _Nullable imageURL) {
        <span class="hljs-keyword">if</span> (completeBlock) {
            completeBlock(image, error, imageURL);
        }
    }];
    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}
 
<span class="hljs-keyword">@end</span>
 
</code></pre>
<p>可以看到demo中是通过调用第三库SDWebImage来实现图片的下载与缓存的</p>
<p> </p>
<p>我们可以尝试不使用SDWebImage，自行实现图片的下载和缓存，体验Kuikly在不同平台的定制化能力</p>
<p> </p>
<h3 data-id="heading-1">7.1 扩展机制实现原理</h3>
<p>Kuikly框架在设计平台扩展机制时，采用了一种极其巧妙的插件化架构思想。这种设计的核心理念是将框架的核心功能与具体的实现细节完全解耦，让开发者能够在灵活地定制不同平台的特定行为。这种设计哲学体现了现代软件架构中的几个重要原则：开闭原则（对扩展开放，对修改封闭）、依赖倒置原则（高层模块不依赖低层模块，都依赖于抽象）以及单一职责原则（每个组件只负责一个特定的功能）。</p>
<p> </p>
<p>Kuikly框架的扩展机制采用了协议驱动的插件化架构，通过定义标准的扩展协议接口，允许开发者实现自定义的组件处理逻辑。</p>
<p>具体实现上，扩展处理器类在+load方法中自动向KuiklyRenderBridge桥接管理器注册自己，框架在运行时通过单例模式管理这些扩展处理器。这种设计实现了零配置的自动注册、完全的实现解耦，使得开发者可以在不修改框架核心代码的情况下，通过实现协议方法来定制图片加载、颜色处理等功能，同时保持了良好的向后兼容性和扩展性。</p>
<p> </p>
<p>Kuikly框架定义了KuiklyRenderComponentExpandProtocol协议，允许开发者自定义组件行为：</p>
<pre><code class="hljs language-ObjectiveC" lang="ObjectiveC"><span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">KuiklyRenderComponentExpandProtocol</span> &lt;<span class="hljs-title">NSObject</span>&gt;</span>
 
<span class="hljs-comment">// 必须实现的基础图片加载方法</span>
- (<span class="hljs-type">BOOL</span>)hr_setImageWithUrl:(<span class="hljs-built_in">NSString</span> *)url forImageView:(<span class="hljs-built_in">UIImageView</span> *)imageView;
 
<span class="hljs-keyword">@optional</span>
<span class="hljs-comment">// 可选的带回调图片加载方法（优先调用）</span>
- (<span class="hljs-type">BOOL</span>)hr_setImageWithUrl:(<span class="hljs-built_in">NSString</span> *)url 
              forImageView:(<span class="hljs-built_in">UIImageView</span> *)imageView 
                  complete:(ImageCompletionBlock)completeBlock;
 
<span class="hljs-comment">// 自定义颜色处理</span>
- (<span class="hljs-built_in">UIColor</span> *)hr_colorWithValue:(<span class="hljs-built_in">NSString</span> *)value;
 
<span class="hljs-comment">// 文本后处理扩展</span>
- (<span class="hljs-built_in">NSString</span> *)kr_customTextWithText:(<span class="hljs-built_in">NSString</span> *)text 
                  textPostProcessor:(<span class="hljs-built_in">NSString</span> *)textPostProcessor;
 
<span class="hljs-keyword">@end</span>
 
</code></pre>
<p>扩展处理器通过 +load() 方法实现自动注册，</p>
<pre><code class="hljs language-ObjectiveC" lang="ObjectiveC"><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">KuiklyRenderComponentExpandHandler</span></span>
 
+ (<span class="hljs-type">void</span>)load {
    <span class="hljs-comment">// 类加载时自动注册，无需手动调用</span>
    [KuiklyRenderBridge registerComponentExpandHandler:[<span class="hljs-keyword">self</span> new]];
}
 
<span class="hljs-keyword">@end</span>
</code></pre>
<p>KuiklyRenderBridge作为中央管理器，负责扩展处理器的注册和获取：</p>
<pre><code class="hljs language-ObjectiveC" lang="ObjectiveC"><span class="hljs-comment">// 全局静态变量存储扩展处理器实例</span>
<span class="hljs-keyword">static</span> <span class="hljs-type">id</span>&lt;KuiklyRenderComponentExpandProtocol&gt; gComponentExpandHandler;
 
<span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">KuiklyRenderBridge</span></span>
 
+ (<span class="hljs-type">void</span>)registerComponentExpandHandler:(<span class="hljs-type">id</span>&lt;KuiklyRenderComponentExpandProtocol&gt;)componentExpandHandler {
    gComponentExpandHandler = componentExpandHandler;
}
 
+ (<span class="hljs-type">id</span>&lt;KuiklyRenderComponentExpandProtocol&gt;)componentExpandHandler {
    <span class="hljs-keyword">if</span> (!gComponentExpandHandler) {
        <span class="hljs-comment">// 支持动态创建，通过类名反射</span>
        gComponentExpandHandler = [[<span class="hljs-built_in">NSClassFromString</span>(<span class="hljs-string">@"KuiklyRenderComponentExpandHandler"</span>) alloc] init];
    }
    <span class="hljs-keyword">return</span> gComponentExpandHandler;
}
 
<span class="hljs-keyword">@end</span>
</code></pre>
<p>当我们调用使用在Kuikly框架中使用Image组件的src方法的时候，实际上会调用：</p>
<pre><code class="hljs language-ObjectiveC" lang="ObjectiveC">- (<span class="hljs-type">BOOL</span>)p_setImageWithUrl:(<span class="hljs-built_in">NSString</span> *)url {
    <span class="hljs-type">BOOL</span> handled = <span class="hljs-literal">NO</span>;
    
    <span class="hljs-comment">// 1. 优先调用带回调的扩展方法</span>
    <span class="hljs-keyword">if</span> ([[KuiklyRenderBridge componentExpandHandler] 
         respondsToSelector:<span class="hljs-keyword">@selector</span>(hr_setImageWithUrl:forImageView:complete:)]) {
        
        handled = [[KuiklyRenderBridge componentExpandHandler] 
                   hr_setImageWithUrl:url 
                         forImageView:<span class="hljs-keyword">self</span> 
                             complete:^(<span class="hljs-built_in">UIImage</span> *image, <span class="hljs-built_in">NSError</span> *error, <span class="hljs-built_in">NSURL</span> *imageURL) {
            <span class="hljs-comment">// 处理加载结果，触发相应事件</span>
            <span class="hljs-keyword">if</span> (error) {
                <span class="hljs-keyword">self</span>.pendingLoadFailure = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">self</span>.errorCode = error.code;
            }
        }];
        
    <span class="hljs-comment">// 2. 降级到基础扩展方法</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ([[KuiklyRenderBridge componentExpandHandler] 
               respondsToSelector:<span class="hljs-keyword">@selector</span>(hr_setImageWithUrl:forImageView:)]) {
        
        handled = [[KuiklyRenderBridge componentExpandHandler] 
                   hr_setImageWithUrl:url forImageView:<span class="hljs-keyword">self</span>];
        
    <span class="hljs-comment">// 3. 如果没有扩展处理器，抛出断言错误</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">NSAssert</span>(<span class="hljs-number">0</span>, <span class="hljs-string">@"should expand hr_setImageWithUrl:forImageView:"</span>);
    }
    
    <span class="hljs-keyword">return</span> handled;
}
</code></pre>
<h3 data-id="heading-2">7.2 在iOS层自定义图片加载</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58543c0e0cc14efda713caa71e391a6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5pyJ5LiO5LiO55eH:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763350577&amp;x-signature=%2FTcP3Q5IVNbFuHcsv43F17dgnzw%3D" alt="" loading="lazy"/></p>
<p> </p>
<p>KRImageLoader：统一加载接口层，用于对外提供api接口</p>
<p>KRImageCache：缓存管理层 内存缓存+磁盘缓存 LRU淘汰算法</p>
<p>KRImageDownloader：网络下载层 并发控制</p>
<p> </p>
<p>拓展处理器实现，用于对接Kuikle框架调用：</p>
<pre><code class="hljs language-ObjectiveC" lang="ObjectiveC"><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">KuiklyRenderComponentExpandHandler</span></span>
 
- (<span class="hljs-type">BOOL</span>)hr_setImageWithUrl:(<span class="hljs-built_in">NSString</span> *)url 
              forImageView:(<span class="hljs-built_in">UIImageView</span> *)imageView 
                  complete:(ImageCompletionBlock)completeBlock {
    
    <span class="hljs-keyword">if</span> (!url) {
        <span class="hljs-comment">// 处理URL为空的情况</span>
        imageView.image = <span class="hljs-literal">nil</span>;
        [[KRImageLoader sharedLoader] cancelLoadingForImageView:imageView];
        <span class="hljs-keyword">if</span> (completeBlock) {
            completeBlock(<span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
    }
    
    <span class="hljs-comment">// 使用自定义图片加载器</span>
    [[KRImageLoader sharedLoader] loadImageForImageView:imageView
                                                withURL:[<span class="hljs-built_in">NSURL</span> URLWithString:url]
                                            placeholder:<span class="hljs-literal">nil</span>
                                               progress:<span class="hljs-literal">nil</span>
                                              completed:^(<span class="hljs-built_in">UIImage</span> *image, <span class="hljs-built_in">NSError</span> *error, <span class="hljs-built_in">NSURL</span> *imageURL) {
        <span class="hljs-comment">// 将结果回调给Kuikly框架</span>
        <span class="hljs-keyword">if</span> (completeBlock) {
            completeBlock(image, error, imageURL);
        }
    }];
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>; <span class="hljs-comment">// 表示已处理</span>
}
 
<span class="hljs-keyword">@end</span>
</code></pre>
<h4 data-id="heading-3">7.2.1 缓存系统设计（双重缓存策略）</h4>
<p>1、  内存缓存</p>
<p>通过NSCache自动管理内存</p>
<p> </p>
<p>2、  磁盘缓存</p>
<p>手动实现了LRU缓存策略，并使用异步的IO操作，避免阻塞接口</p>
<p> </p>
<p>接口定义，具体实现可以查看仓库</p>
<pre><code class="hljs language-ObjectiveC" lang="ObjectiveC"><span class="hljs-comment">/**
 * KRImageCache - 图片缓存管理器
 * 
 * 功能特性：
 * - 双重缓存策略：内存缓存(NSCache) + 磁盘缓存(文件系统)
 * - 自动内存管理：响应内存警告自动清理
 * - 后台清理：应用进入后台时清理过期缓存
 * - 线程安全：使用串行队列保证磁盘操作安全
 */</span>
<span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">KRImageCache</span> : <span class="hljs-title">NSObject</span></span>
 
<span class="hljs-comment">/**
 * 获取缓存管理器的单例实例
 * @return 缓存管理器单例
 */</span>
+ (<span class="hljs-keyword">instancetype</span>)sharedCache;
 
<span class="hljs-comment">/**
 * 同步获取缓存图片（仅从内存缓存获取）
 * @param key 缓存键值
 * @return 缓存的图片对象，如果不存在则返回nil
 */</span>
- (<span class="hljs-built_in">UIImage</span> * _Nullable)imageForKey:(<span class="hljs-built_in">NSString</span> *)key;
 
<span class="hljs-comment">/**
 * 异步获取缓存图片（先检查内存缓存，再检查磁盘缓存）
 * @param key 缓存键值
 * @param completion 完成回调，在主线程执行
 */</span>
- (<span class="hljs-type">void</span>)imageForKey:(<span class="hljs-built_in">NSString</span> *)key completion:(<span class="hljs-type">void</span>(^)(<span class="hljs-built_in">UIImage</span> * _Nullable image))completion;
 
<span class="hljs-comment">/**
 * 同步存储图片到缓存（内存+磁盘）
 * @param image 要缓存的图片
 * @param key 缓存键值
 */</span>
- (<span class="hljs-type">void</span>)storeImage:(<span class="hljs-built_in">UIImage</span> *)image forKey:(<span class="hljs-built_in">NSString</span> *)key;
 
<span class="hljs-comment">/**
 * 异步存储图片到缓存（内存+磁盘）
 * @param image 要缓存的图片
 * @param key 缓存键值
 * @param completion 存储完成回调，在主线程执行
 */</span>
- (<span class="hljs-type">void</span>)storeImage:(<span class="hljs-built_in">UIImage</span> *)image forKey:(<span class="hljs-built_in">NSString</span> *)key completion:(<span class="hljs-type">void</span>(^ _Nullable)(<span class="hljs-type">void</span>))completion;
 
<span class="hljs-comment">/**
 * 清理内存缓存
 */</span>
- (<span class="hljs-type">void</span>)clearMemoryCache;
 
<span class="hljs-comment">/**
 * 清理磁盘缓存
 */</span>
- (<span class="hljs-type">void</span>)clearDiskCache;
 
<span class="hljs-comment">/**
 * 清理所有缓存（内存+磁盘）
 */</span>
- (<span class="hljs-type">void</span>)clearAllCache;
 
 
<span class="hljs-comment">/**
 * 异步获取磁盘缓存大小
 * @param completion 完成回调，在主线程执行，参数为磁盘缓存占用的字节数
 */</span>
- (<span class="hljs-type">void</span>)diskCacheSizeWithCompletion:(<span class="hljs-type">void</span>(^)(<span class="hljs-built_in">NSUInteger</span> size))completion;
 
<span class="hljs-comment">/**
 * 当缓存超过限制时，按LRU策略删除最旧的文件
 */</span>
- (<span class="hljs-type">void</span>)cleanDiskCacheWithSizeLimit;
 
<span class="hljs-comment">/**
 * 根据URL生成缓存键值
 * @param url 图片URL
 * @return 生成的缓存键值（SHA256哈希）
 */</span>
+ (<span class="hljs-built_in">NSString</span> *)cacheKeyForURL:(<span class="hljs-built_in">NSURL</span> *)url;
 
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSCache</span> *memoryCache;        <span class="hljs-comment">// 内存缓存，自动管理内存使用</span>
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">dispatch_queue_t</span> ioQueue;    <span class="hljs-comment">// 串行IO队列，保证磁盘操作线程安全</span>
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">copy</span>) <span class="hljs-built_in">NSString</span> *diskCachePath;       <span class="hljs-comment">// 磁盘缓存目录路径</span>
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">assign</span>) <span class="hljs-type">BOOL</span> isCleaningDiskCache;    <span class="hljs-comment">// 是否正在清理磁盘缓存，避免重复清理</span>
<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSDate</span> *lastCleanupTime;     <span class="hljs-comment">// 上次清理时间，避免频繁清理</span>
 
<span class="hljs-keyword">@end</span>
</code></pre>
<h4 data-id="heading-4">7.2.2 下载器设计</h4>
<p>采用单例模式管理NSURLSession，通过任务合并机制避免重复下载相同URL的图片，支持最大6个并发下载、15秒超时控制、精确的ImageView关联取消机制，并使用barrier队列确保线程安全的任务管理，为图片加载框架提供了可靠的网络下载能力。</p>
<p> </p>
<p>接口定义，具体实现可以查看仓库</p>
<pre><code class="hljs language-ObjectiveC" lang="ObjectiveC"><span class="hljs-comment">/**
 * KRImageDownloader - 图片下载器
 *
 */</span>
<span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">KRImageDownloader</span> : <span class="hljs-title">NSObject</span></span>
 
<span class="hljs-comment">/**
 * 获取下载器的单例实例
 * @return 下载器单例
 */</span>
+ (<span class="hljs-keyword">instancetype</span>)sharedDownloader;
 
<span class="hljs-comment">/**
 * 下载图片
 * @param url 图片URL
 * @param progressBlock 下载进度回调（可选）
 * @param completedBlock 下载完成回调（可选）
 * @return 下载任务对象，可用于取消下载
 */</span>
- (<span class="hljs-built_in">NSURLSessionDataTask</span> * _Nullable)downloadImageWithURL:(<span class="hljs-built_in">NSURL</span> *)url
                                                progress:(KRDownloadProgressBlock _Nullable)progressBlock
                                               completed:(KRDownloadCompletionBlock _Nullable)completedBlock;
 
<span class="hljs-comment">/**
 * 为特定ImageView下载图片
 * @param url 图片URL
 * @param imageView 关联的ImageView，用于精确取消
 * @param progressBlock 下载进度回调（可选）
 * @param completedBlock 下载完成回调（可选）
 * @return 下载任务对象，可用于取消下载
 */</span>
- (<span class="hljs-built_in">NSURLSessionDataTask</span> * _Nullable)downloadImageWithURL:(<span class="hljs-built_in">NSURL</span> *)url
                                               imageView:(<span class="hljs-built_in">UIImageView</span> *)imageView
                                                progress:(KRDownloadProgressBlock _Nullable)progressBlock
                                               completed:(KRDownloadCompletionBlock _Nullable)completedBlock;
 
<span class="hljs-comment">/**
 * 取消指定URL的下载任务
 * @param url 要取消的图片URL
 */</span>
- (<span class="hljs-type">void</span>)cancelDownloadForURL:(<span class="hljs-built_in">NSURL</span> *)url;
 
<span class="hljs-comment">/**
 * 为特定ImageView取消下载任务
 * 只移除该ImageView对应的回调，不影响其他ImageView
 * @param url 图片URL
 * @param imageView 要取消的ImageView
 */</span>
- (<span class="hljs-type">void</span>)cancelDownloadForURL:(<span class="hljs-built_in">NSURL</span> *)url imageView:(<span class="hljs-built_in">UIImageView</span> *)imageView;
 
<span class="hljs-comment">/**
 * 取消所有下载任务
 */</span>
- (<span class="hljs-type">void</span>)cancelAllDownloads;
 
<span class="hljs-comment">/**
 * 设置最大并发下载数量
 * @param maxConcurrentDownloads 最大并发数
 */</span>
- (<span class="hljs-type">void</span>)setMaxConcurrentDownloads:(<span class="hljs-built_in">NSInteger</span>)maxConcurrentDownloads;
 
<span class="hljs-comment">/**
 * 设置下载超时时间
 * @param timeout 超时时间（秒）
 */</span>
- (<span class="hljs-type">void</span>)setDownloadTimeout:(<span class="hljs-built_in">NSTimeInterval</span>)timeout;
 
<span class="hljs-keyword">@end</span>
</code></pre>
<h3 data-id="heading-5">7.3 小结</h3>
<p>通过自定义图片的加载和缓存，可以体验到Kuikly框架极强的拓展能力，尤其在平台定制化。以iOS平台自定义图片加载与缓存为例，无论是集成第三方库如SDWebImage，还是使用自研方案，开发者都可以通过Kuikly的插件化架构和协议驱动机制，实现与核心逻辑完全解耦的功能扩展。各类自定义组件只需遵循标准协议，通过零配置自动注册机制即可无缝集成到系统。这种设计不仅保障了应用的灵活性和向后兼容性，还让每个平台都能根据自身需求精准定制，充分体现了Kuikly框架开放、高效和可持续的扩展能力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用qt控制台抓取tcp数据包]]></title>    <link>https://juejin.cn/post/7570299986529861659</link>    <guid>https://juejin.cn/post/7570299986529861659</guid>    <pubDate>2025-11-09T16:17:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570299986529861659" data-draft-id="7570299986529845275" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用qt控制台抓取tcp数据包"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2025-11-09T16:17:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="user5033926650859"/> <meta itemprop="url" content="https://juejin.cn/user/4125813603073550"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用qt控制台抓取tcp数据包
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125813603073550/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    user5033926650859
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T16:17:43.000Z" title="Sun Nov 09 2025 16:17:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">使用qt控制台抓取tcp数据包</h2>
<h3 data-id="heading-1">前提条件</h3>
<ul>
<li>安装<code>npcap</code>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fnpcap.com%2F%23download" target="_blank" title="https://npcap.com/#download" ref="nofollow noopener noreferrer">链接</a></li>
</ul>
<h3 data-id="heading-2">项目准备</h3>
<ul>
<li>
<p>创建控制台程序</p>
</li>
<li>
<p>在项目文件中添加包含目录、附加库目录、附加库</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable constant_">INCLUDEPATH</span> += <span class="hljs-symbol">D:</span>/softwares/<span class="hljs-title class_">Libs</span>/<span class="hljs-title class_">Npcap</span>SDK/<span class="hljs-title class_">Include</span>
<span class="hljs-variable constant_">LIBS</span> += -<span class="hljs-variable constant_">LD</span><span class="hljs-symbol">:/softwares/Libs/NpcapSDK/Lib/x64</span>
<span class="hljs-variable constant_">LIBS</span> += -lwpcap
<span class="hljs-variable constant_">LIBS</span> += -lole32
<span class="hljs-variable constant_">LIBS</span> += -lPacket
<span class="hljs-variable constant_">LIBS</span> += -lIphlpapi
</code></pre>
</li>
</ul>
<h3 data-id="heading-3">检查是否已经安装npcap</h3>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">checkNpcapExist</span><span class="hljs-params">()</span>
</span>{
    WCHAR path[<span class="hljs-number">512</span>];
    uint len = <span class="hljs-built_in">GetSystemDirectory</span>(path, <span class="hljs-number">480</span>);
    QString systemPath = QString::<span class="hljs-built_in">fromWCharArray</span>(path, len);

    QString npcapFolder = <span class="hljs-built_in">QDir</span>(systemPath).<span class="hljs-built_in">filePath</span>(<span class="hljs-string">"Npcap"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">QDir</span>(npcapFolder).<span class="hljs-built_in">exists</span>();
}
</code></pre>
<ul>
<li>也就是判断目录: <code>C:\Windows\System32\Npcap</code> 存不存在</li>
</ul>
<h3 data-id="heading-4">获取网络适配器列表</h3>
<ul>
<li>我们需要选择一个网络适配器去抓取tcp数据包，所以需要获取本地机器的所有网络适配器，当然 <code>npcap</code> 提供了 <code>pcap_findalldevs</code> api，但是如果我们要想获取它的可读化的 <code>FriendName</code>，需要经过一些操作</li>
</ul>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-function">QString <span class="hljs-title">getDeviceFriendName</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *devName)</span>
</span>{
    <span class="hljs-function">QString <span class="hljs-title">friendName</span><span class="hljs-params">(devName)</span></span>;

    <span class="hljs-comment">// extract guid string by regex</span>
    <span class="hljs-function">QRegularExpression <span class="hljs-title">regex</span><span class="hljs-params">(<span class="hljs-string">R"(({[A-F0-9\-]+}))"</span>)</span></span>;
    <span class="hljs-keyword">auto</span> match = regex.<span class="hljs-built_in">match</span>(friendName);

    <span class="hljs-keyword">if</span> (!match.<span class="hljs-built_in">hasMatch</span>()) <span class="hljs-keyword">return</span> friendName;

    <span class="hljs-comment">// translate guid string to GUID</span>
    GUID guid;

    HRESULT hr = <span class="hljs-built_in">CLSIDFromString</span>(match.<span class="hljs-built_in">captured</span>(<span class="hljs-number">1</span>).<span class="hljs-built_in">toStdWString</span>().<span class="hljs-built_in">c_str</span>(), &amp;guid);

    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">SUCCEEDED</span>(hr)) <span class="hljs-keyword">return</span> friendName;

    <span class="hljs-comment">// GUID =&gt; LUID =&gt; Alias(FriendName)</span>
    NET_LUID luid;
    <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">ConvertInterfaceGuidToLuid</span>(&amp;guid, &amp;luid))
    {
        WCHAR buffer[<span class="hljs-number">256</span>] = {<span class="hljs-number">0</span>};
        <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">ConvertInterfaceLuidToAlias</span>(&amp;luid, buffer, <span class="hljs-number">256</span>))
        {
            friendName = QString::<span class="hljs-built_in">fromWCharArray</span>(buffer);
        }
    }

    <span class="hljs-keyword">return</span> friendName;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-type">char</span> errbuf[PCAP_ERRBUF_SIZE];
    <span class="hljs-type">pcap_if_t</span> *alldevs;
    <span class="hljs-comment">// pcap_t *handle;</span>

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">pcap_findalldevs</span>(&amp;alldevs, errbuf) == <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">qCritical</span>() &lt;&lt; <span class="hljs-string">"Error in pcap_findalldevs:"</span> &lt;&lt; errbuf;
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    QStringList devNames;
    <span class="hljs-type">pcap_if_t</span> *dev = alldevs;
    <span class="hljs-type">char</span>* lastName = <span class="hljs-literal">nullptr</span>;
    <span class="hljs-keyword">while</span> (dev)
    {
        QString devName = <span class="hljs-built_in">getDeviceFriendName</span>(dev-&gt;name);
        devNames.<span class="hljs-built_in">append</span>(devName);
        lastName = dev-&gt;name;
        dev = dev-&gt;next;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-5">打开网络适配器并设置筛选条件</h4>
<ul>
<li>一个网络适配器抓到的tcp数据包有很多，但是我们只想关注我们想要的tcp数据包，所以需要设置筛选条件</li>
</ul>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-comment">// open the adapter</span>
<span class="hljs-type">pcap_t</span>* adapter = <span class="hljs-built_in">pcap_open_live</span>(lastName, <span class="hljs-number">65536</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1000</span>, errbuf);
<span class="hljs-keyword">if</span> (adapter == <span class="hljs-literal">nullptr</span>)
{
    <span class="hljs-built_in">pcap_freealldevs</span>(alldevs);
    <span class="hljs-built_in">qDebug</span>() &lt;&lt; <span class="hljs-string">"fail to open the net adapter: "</span> &lt;&lt; lastName;
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
}

<span class="hljs-built_in">pcap_freealldevs</span>(alldevs);

<span class="hljs-comment">// set filter</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">bpf_program</span> fcode;
<span class="hljs-type">int</span> res = <span class="hljs-number">0</span>;
<span class="hljs-keyword">if</span> ((res = <span class="hljs-built_in">pcap_compile</span>(adapter, &amp;fcode, <span class="hljs-string">"tcp port 3000"</span>, <span class="hljs-number">1</span>, PCAP_NETMASK_UNKNOWN)) &lt; <span class="hljs-number">0</span>)
{
    <span class="hljs-built_in">qDebug</span>() &lt;&lt; <span class="hljs-string">"fail to compile:"</span> &lt;&lt; <span class="hljs-built_in">pcap_statustostr</span>(res);
    <span class="hljs-built_in">pcap_close</span>(adapter);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
}
<span class="hljs-keyword">if</span> ((res = <span class="hljs-built_in">pcap_setfilter</span>(adapter, &amp;fcode) &lt; <span class="hljs-number">0</span>))
{
    <span class="hljs-built_in">qDebug</span>() &lt;&lt; <span class="hljs-string">"fail to set filter:"</span> &lt;&lt; <span class="hljs-built_in">pcap_statustostr</span>(res);
    <span class="hljs-built_in">pcap_close</span>(adapter);
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
}
</code></pre>
<ul>
<li>这里我们设置的条件是只筛选 端口号<code>3000</code>的tcp数据包，筛选字符串为: <code>tcp port 3000</code></li>
</ul>
<h4 data-id="heading-6">开始抓包，设置处理函数</h4>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// start capture loop</span>
    <span class="hljs-built_in">pcap_loop</span>(adapter, <span class="hljs-number">0</span>, packet_handler, <span class="hljs-literal">nullptr</span>);

    <span class="hljs-built_in">pcap_close</span>(adapter);
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">packet_handler</span><span class="hljs-params">(u_char* param, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> pcap_pkthdr* header, <span class="hljs-type">const</span> u_char* pkt_data)</span>
</span>{
    <span class="hljs-built_in">Q_UNUSED</span>(param);
    <span class="hljs-built_in">Q_UNUSED</span>(pkt_data);

    uint len = header-&gt;len;
    QString str = QString::<span class="hljs-built_in">asprintf</span>(<span class="hljs-string">"%ld:%ld (%ld)"</span>, header-&gt;ts.tv_sec, header-&gt;ts.tv_usec, len);
    <span class="hljs-built_in">qDebug</span>() &lt;&lt; str;
}
</code></pre>
<h3 data-id="heading-7">运行效果</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e02c2a300a714066a5bcf314c1e338c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXNlcjUwMzM5MjY2NTA4NTk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763309863&amp;x-signature=nlY7%2Bx6FzH7xCreZ6rzLa0Aby9c%3D" alt="image-20231104224314263.png" loading="lazy"/></p>
<h3 data-id="heading-8">完整代码</h3>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QCoreApplication&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;winsock2.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QDebug&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QDir&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pcap.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QRegularExpression&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;objbase.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netioapi.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">checkNpcapExist</span><span class="hljs-params">()</span>
</span>{
    WCHAR path[<span class="hljs-number">512</span>];
    uint len = <span class="hljs-built_in">GetSystemDirectory</span>(path, <span class="hljs-number">480</span>);
    QString systemPath = QString::<span class="hljs-built_in">fromWCharArray</span>(path, len);

    QString npcapFolder = <span class="hljs-built_in">QDir</span>(systemPath).<span class="hljs-built_in">filePath</span>(<span class="hljs-string">"Npcap"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">QDir</span>(npcapFolder).<span class="hljs-built_in">exists</span>();
}

<span class="hljs-function">QString <span class="hljs-title">getDeviceFriendName</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *devName)</span>
</span>{
    <span class="hljs-function">QString <span class="hljs-title">friendName</span><span class="hljs-params">(devName)</span></span>;

    <span class="hljs-comment">// extract guid string by regex</span>
    <span class="hljs-function">QRegularExpression <span class="hljs-title">regex</span><span class="hljs-params">(<span class="hljs-string">R"(({[A-F0-9\-]+}))"</span>)</span></span>;
    <span class="hljs-keyword">auto</span> match = regex.<span class="hljs-built_in">match</span>(friendName);

    <span class="hljs-keyword">if</span> (!match.<span class="hljs-built_in">hasMatch</span>()) <span class="hljs-keyword">return</span> friendName;

    <span class="hljs-comment">// translate guid string to GUID</span>
    GUID guid;

    HRESULT hr = <span class="hljs-built_in">CLSIDFromString</span>(match.<span class="hljs-built_in">captured</span>(<span class="hljs-number">1</span>).<span class="hljs-built_in">toStdWString</span>().<span class="hljs-built_in">c_str</span>(), &amp;guid);

    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">SUCCEEDED</span>(hr)) <span class="hljs-keyword">return</span> friendName;

    <span class="hljs-comment">// GUID =&gt; LUID =&gt; Alias(FriendName)</span>
    NET_LUID luid;
    <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">ConvertInterfaceGuidToLuid</span>(&amp;guid, &amp;luid))
    {
        WCHAR buffer[<span class="hljs-number">256</span>] = {<span class="hljs-number">0</span>};
        <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == <span class="hljs-built_in">ConvertInterfaceLuidToAlias</span>(&amp;luid, buffer, <span class="hljs-number">256</span>))
        {
            friendName = QString::<span class="hljs-built_in">fromWCharArray</span>(buffer);
        }
    }

    <span class="hljs-keyword">return</span> friendName;
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">packet_handler</span><span class="hljs-params">(u_char* param, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> pcap_pkthdr* header, <span class="hljs-type">const</span> u_char* pkt_data)</span>
</span>{
    <span class="hljs-built_in">Q_UNUSED</span>(param);
    <span class="hljs-built_in">Q_UNUSED</span>(pkt_data);

    <span class="hljs-comment">// struct tm* ltime;</span>
    <span class="hljs-comment">// char timestr[16];</span>
    <span class="hljs-comment">// time_t local_tv_sec;</span>

    uint len = header-&gt;len;
    QString str = QString::<span class="hljs-built_in">asprintf</span>(<span class="hljs-string">"%ld:%ld (%ld)"</span>, header-&gt;ts.tv_sec, header-&gt;ts.tv_usec, len);
    <span class="hljs-built_in">qDebug</span>() &lt;&lt; str;
}


<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span>
</span>{
    <span class="hljs-function">QCoreApplication <span class="hljs-title">a</span><span class="hljs-params">(argc, argv)</span></span>;

    <span class="hljs-comment">// 判断npcap是否存在</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">checkNpcapExist</span>())
    {
        <span class="hljs-built_in">qDebug</span>() &lt;&lt; <span class="hljs-string">"Npcap not exists"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    <span class="hljs-comment">// 检索网卡列表</span>
    <span class="hljs-type">char</span> errbuf[PCAP_ERRBUF_SIZE];
    <span class="hljs-type">pcap_if_t</span> *alldevs;
    <span class="hljs-comment">// pcap_t *handle;</span>

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">pcap_findalldevs</span>(&amp;alldevs, errbuf) == <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">qCritical</span>() &lt;&lt; <span class="hljs-string">"Error in pcap_findalldevs:"</span> &lt;&lt; errbuf;
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    QStringList devNames;
    <span class="hljs-type">pcap_if_t</span> *dev = alldevs;
    <span class="hljs-type">char</span>* lastName = <span class="hljs-literal">nullptr</span>;
    <span class="hljs-keyword">while</span> (dev)
    {
        QString devName = <span class="hljs-built_in">getDeviceFriendName</span>(dev-&gt;name);
        devNames.<span class="hljs-built_in">append</span>(devName);
        lastName = dev-&gt;name;
        dev = dev-&gt;next;
    }

    <span class="hljs-comment">// open the adapter</span>
    <span class="hljs-type">pcap_t</span>* adapter = <span class="hljs-built_in">pcap_open_live</span>(lastName, <span class="hljs-number">65536</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1000</span>, errbuf);
    <span class="hljs-keyword">if</span> (adapter == <span class="hljs-literal">nullptr</span>)
    {
        <span class="hljs-built_in">pcap_freealldevs</span>(alldevs);
        <span class="hljs-built_in">qDebug</span>() &lt;&lt; <span class="hljs-string">"fail to open the net adapter: "</span> &lt;&lt; lastName;
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    <span class="hljs-built_in">pcap_freealldevs</span>(alldevs);

    <span class="hljs-comment">// set filter</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">bpf_program</span> fcode;
    <span class="hljs-type">int</span> res = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> ((res = <span class="hljs-built_in">pcap_compile</span>(adapter, &amp;fcode, <span class="hljs-string">"tcp port 3000"</span>, <span class="hljs-number">1</span>, PCAP_NETMASK_UNKNOWN)) &lt; <span class="hljs-number">0</span>)
    {
        <span class="hljs-built_in">qDebug</span>() &lt;&lt; <span class="hljs-string">"fail to compile:"</span> &lt;&lt; <span class="hljs-built_in">pcap_statustostr</span>(res);
        <span class="hljs-built_in">pcap_close</span>(adapter);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
    <span class="hljs-keyword">if</span> ((res = <span class="hljs-built_in">pcap_setfilter</span>(adapter, &amp;fcode) &lt; <span class="hljs-number">0</span>))
    {
        <span class="hljs-built_in">qDebug</span>() &lt;&lt; <span class="hljs-string">"fail to set filter:"</span> &lt;&lt; <span class="hljs-built_in">pcap_statustostr</span>(res);
        <span class="hljs-built_in">pcap_close</span>(adapter);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    <span class="hljs-comment">// start capture loop</span>
    <span class="hljs-built_in">pcap_loop</span>(adapter, <span class="hljs-number">0</span>, packet_handler, <span class="hljs-literal">nullptr</span>);

    <span class="hljs-built_in">pcap_close</span>(adapter);

    <span class="hljs-built_in">qDebug</span>() &lt;&lt; <span class="hljs-string">"hello"</span>;

    <span class="hljs-keyword">return</span> a.<span class="hljs-built_in">exec</span>();
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[wmi获取禁用网卡的mac地址]]></title>    <link>https://juejin.cn/post/7570243451725004827</link>    <guid>https://juejin.cn/post/7570243451725004827</guid>    <pubDate>2025-11-09T16:22:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570243451725004827" data-draft-id="7570243451724988443" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="wmi获取禁用网卡的mac地址"/> <meta itemprop="keywords" content="Windows"/> <meta itemprop="datePublished" content="2025-11-09T16:22:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="morn_venus"/> <meta itemprop="url" content="https://juejin.cn/user/4125813603073550"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            wmi获取禁用网卡的mac地址
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125813603073550/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    morn_venus
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T16:22:48.000Z" title="Sun Nov 09 2025 16:22:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">wmi获取禁用网卡的mac地址</h2>
<ul>
<li>最近遇到一个性能问题，我们的软件启动需要验证<code>License</code>，验证License需要获取网卡的mac地址（无论是禁用的还是启用的）。之前的做法是运行一个进程执行 <code>chcp 437&amp;&amp;powershell  Get-NetAdapter</code>
<ul>
<li>这相当于先开启一个<code>cmd</code> 执行 <code>chcp 437</code> ，然后在<code>cmd</code>再启动 <code>powershell</code> 执行 <code>Get-NetAdapter</code></li>
<li>此操作相当耗时，基本上要耗时2秒以上，这对于软件启动来说是不可接受的</li>
<li>所以就研究了 powershell执行的 <code>Get-NetAdapter</code> 底层是如何实现的，是否可以在 <code>C#</code> 中直接复刻实现以达到减少耗时的目的。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-1">为什么采用启动powershell的方式去获取网卡的mac地址</h3>
<ul>
<li>
<p>常用的获取网卡地址的方式</p>
<ol>
<li>
<p><code>NetworkInterface.GetAllNetworkInterfaces</code>：<strong>获取不到禁用的网卡信息</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> list = NetworkInterface.GetAllNetworkInterfaces();
<span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> list)
{
    <span class="hljs-keyword">var</span> name = item.Name;
    <span class="hljs-keyword">var</span> address = item.GetPhysicalAddress();
    Debug.WriteLine(<span class="hljs-string">$"name: <span class="hljs-subst">{name}</span>, mac: <span class="hljs-subst">{address}</span>"</span>);
}
</code></pre>
</li>
<li>
<p>使用wmi方式获取 <code>Win32_NetworkAdapter</code>：<strong>获取不到禁用网卡的Mac地址</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> search = <span class="hljs-keyword">new</span> ManagementObjectSearcher(<span class="hljs-string">"select * from Win32_NetworkAdapter where PhysicalAdapter = TRUE"</span>))
{
    <span class="hljs-keyword">foreach</span>(ManagementObject item <span class="hljs-keyword">in</span> search.Get())
    {
        <span class="hljs-built_in">string</span> name = item[<span class="hljs-string">"Name"</span>]?.ToString();
        <span class="hljs-built_in">string</span> address = item[<span class="hljs-string">"MACAddress"</span>]?.ToString();
        Debug.WriteLine(<span class="hljs-string">$"name: <span class="hljs-subst">{name}</span>, mac: <span class="hljs-subst">{address}</span>"</span>);
    }
}
</code></pre>
</li>
</ol>
</li>
<li>
<p>基于以上两种常用的方式都无法获取到禁用网卡的信息，故最后采用绕远路的方法：启动powershell执行 <code>get-netadapter</code></p>
</li>
</ul>
<h3 data-id="heading-2">powershell的 <code>get-netadapter</code>底层做了些什么？</h3>
<ul>
<li>经过查阅资料，<code>get-netadapter</code> 其实是调用了 <code>Get-CimInstance -Namespace root/StandardCimv2 -ClassName MSFT_NetAdapter</code></li>
<li>于是兴冲冲的打开 <code>powershell</code> 执行了以上命令，结果输出的内容很多，与 <code>get-netadapter</code> 输出的内容大相径庭。</li>
<li>但是在执行完一遍<code>get-netadapter</code>之后，再次运行 <code>Get-CimInstance</code> 命令，发现输出内容确实一致
<ul>
<li>这里问了chatgpt，说是<code>get-adapter</code> 会做一些初始化的操作，如果先执行 <code>get-ciminstance</code> （在没有初始化的前提下），会输出一些不正确的内容。</li>
</ul>
</li>
<li><code>get-ciminstance</code> 命令其实就是调用的 <code>wmi</code></li>
</ul>
<h3 data-id="heading-3">什么是wmi</h3>
<ul>
<li>
<p>wmi: <code>windows management instruments</code> windows管理规范，提供了系统信息访问的api</p>
</li>
<li>
<p>一句话总结：<strong>wmi=windows的系统级数据库，你可以通过wql语句查看和控制系统</strong></p>
</li>
<li>
<p>那cim又是什么东西？</p>
<ul>
<li>wmi是基于 <code>cim</code> 实现的，common infomation model, 意思就是将系统资源抽象成类</li>
<li>我们可以通过查询语句去访问这些资源类对象的信息</li>
</ul>
</li>
<li>
<p>微软将系统资源抽象成类，把这些类放在不同的命名空间下（默认的命名空间为<code>root\CIMV2</code>），并且将类的名称添加了前缀，具体划分规则如下</p>



































<table><thead><tr><th>类名前缀</th><th>来源</th><th>典型命名空间</th><th>举例</th></tr></thead><tbody><tr><td><strong>Win32_</strong></td><td>传统 WMI 类（早期，兼容旧系统）</td><td><code>root\CIMV2</code></td><td><code>Win32_Process</code>, <code>Win32_NetworkAdapter</code></td></tr><tr><td><strong>MSFT_</strong></td><td>新一代 CIM 类（基于 PowerShell 和 DMTF 标准）</td><td><code>root\StandardCimv2</code></td><td><code>MSFT_NetAdapter</code>, <code>MSFT_Disk</code>, <code>MSFT_NetIPAddress</code></td></tr><tr><td><strong>CIM_</strong></td><td>标准 DMTF（跨平台）类</td><td><code>root\CIMV2</code></td><td><code>CIM_LogicalDisk</code>, <code>CIM_ComputerSystem</code></td></tr><tr><td>自定义（厂商名）</td><td>第三方 / OEM 驱动提供</td><td><code>root\WMI</code>、<code>root\&lt;vendor&gt;</code></td><td><code>Intel_SMBIOSData</code>, <code>Dell_BIOSProvider</code> 等</td></tr></tbody></table>
</li>
<li>
<p>windows界面的设备管理器有一部分的实现就是基于 <code>wmi</code></p>
</li>
<li>

























<table><thead><tr><th>类名</th><th>描述</th></tr></thead><tbody><tr><td><code>Win32_Process</code></td><td>表示系统中的一个进程</td></tr><tr><td><code>Win32_Service</code></td><td>表示一个 Windows 服务</td></tr><tr><td><code>MSFT_NetAdapter</code></td><td>表示一个网络适配器</td></tr><tr><td><code>Win32_LogicalDisk</code></td><td>表示一个逻辑磁盘（C盘、D盘等）</td></tr></tbody></table>
</li>
</ul>
<h4 data-id="heading-4">如何使用wmi呢?</h4>
<ul>
<li>powershell
<ul>
<li>访问 <code>Win32_NetworkAdapter</code>类对象: <code>get-ciminstance -classname win32_networkadapter</code></li>
</ul>
</li>
<li>C#: 上面已经讲过</li>
</ul>
<h3 data-id="heading-5">解决方案</h3>
<ul>
<li>既然已经知道powershell的命令<code>get-netadapter</code> 底层是 <code>Get-CimInstance -Namespace root/StandardCimv2 -ClassName MSFT_NetAdapter</code>，那么我们就可以应用到c#上</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> search = <span class="hljs-keyword">new</span> ManagementObjectSearcher(<span class="hljs-string">"root/standardcimv2"</span>, <span class="hljs-string">"select * from msft_netadapter"</span>))
{
    <span class="hljs-keyword">foreach</span> (ManagementObject item <span class="hljs-keyword">in</span> search.Get())
    {
        <span class="hljs-built_in">string</span> name = item[<span class="hljs-string">"Name"</span>]?.ToString();
        <span class="hljs-built_in">string</span> address = item[<span class="hljs-string">"MacAddress"</span>]?.ToString();
        Debug.WriteLine(<span class="hljs-string">$"name: <span class="hljs-subst">{name}</span>, mac: <span class="hljs-subst">{address}</span>"</span>);
    }
}
</code></pre>
<ul>
<li>但是！！！<strong>运行报错了</strong>，提示没有 <code>MacAddress</code>这个字段，又是经过了一番尝试，发现原来这里是 <code>PermanentAddress</code>，可能是<code>powershell</code> 为了显示的更准确，自行改了字段的名称</li>
</ul>
<h3 data-id="heading-6">扩展</h3>
<h4 data-id="heading-7">走的歪路：使用c++调用wmi获取系统信息</h4>
<ul>
<li>之前做了很多尝试依旧不得入门，无法在C#中获取到禁用网卡的mac地址，于是转而让chatgpt给个c++的方案，虽然给的代码很多编译报错，运行报错，最后终于运行起来一次（连续运行第二次就崩溃），好歹成功获取到了，也就是这里发现读取的是 <code>PermanentAddress</code> 字段，而不是 <code>MacAddress</code>，最终找到了在C#中的正确方案。
<ul>
<li>在得到正确方案后，也就没有再研究c++方案为什么运行第二次就会崩溃的问题，空下来再说（自我安慰，基本上是不会再去看那段代码了）</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《CSS 核心机制与选择器实战精要》]]></title>    <link>https://juejin.cn/post/7570162686579916842</link>    <guid>https://juejin.cn/post/7570162686579916842</guid>    <pubDate>2025-11-09T16:27:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570162686579916842" data-draft-id="7570162686579818538" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《CSS 核心机制与选择器实战精要》"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2025-11-09T16:27:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鱼鱼块"/> <meta itemprop="url" content="https://juejin.cn/user/4302802432307224"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《CSS 核心机制与选择器实战精要》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4302802432307224/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鱼鱼块
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T16:27:58.000Z" title="Sun Nov 09 2025 16:27:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">CSS 核心概念与选择器</h2>
<p>在前端开发中，CSS（层叠样式表）是控制网页外观和布局的核心技术。以下是我整理的约 2000 字的学习笔记，涵盖核心知识点与实践体会。</p>
<hr/>
<h3 data-id="heading-1">一、CSS 基础结构：声明与选择器</h3>
<p>CSS 的本质是一组<strong>声明（declaration）</strong> ，每个声明由<strong>属性（property）<strong>和</strong>值（value）<strong>组成，例如 <code>color: red;</code>。多个声明被包裹在花括号 <code>{}</code> 中，形成一个</strong>声明块（declaration block）</strong> 。为了让这些样式作用于特定的 HTML 元素，我们需要使用**选择器（selector）**来“选中”目标元素。</p>
<p>例如，若想将 <code>&lt;h1&gt;</code> 标题设为蓝色，可写：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">h1</span> { <span class="hljs-attribute">color</span>: blue; }
</code></pre>
<p>这里 <code>h1</code> 是元素选择器，<code>{ color: blue; }</code> 是声明块。</p>
<hr/>
<h3 data-id="heading-2">二、选择器优先级：从低到高</h3>
<p>CSS 选择器存在明确的优先级规则，决定了当多个规则作用于同一元素时，谁最终生效。优先级按“个十百千”计算：</p>
<ul>
<li><strong>元素选择器（element）</strong> ：权重 1（如 <code>p</code>）</li>
<li><strong>类选择器（class）</strong> ：权重 10（如 <code>.highlight</code>）</li>
<li><strong>ID 选择器（id）</strong> ：权重 100（如 <code>#main</code>）</li>
<li><strong>内联样式（inline style）</strong> ：权重 1000（如 <code>&lt;div style="color:red"&gt;</code>）</li>
<li><strong><code>!important</code></strong>：最高优先级，可覆盖一切（但应慎用）</li>
</ul>
<p>例如，若同时存在：</p>
<pre><code class="hljs language-css" lang="css"> <span class="hljs-selector-tag">p</span> {
      <span class="hljs-attribute">color</span>: blue;
  }  <span class="hljs-comment">/* 权重 1 */</span>
<span class="hljs-selector-class">.book</span> { 
<span class="hljs-attribute">color</span>: green; 
}       <span class="hljs-comment">/* 权重 10 */</span>
<span class="hljs-selector-id">#novel</span> {
<span class="hljs-attribute">color</span>: purple;
}     <span class="hljs-comment">/* 权重 100 */</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b509f55de194475baca3ad4b0d061c33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86bG85Z2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763310477&amp;x-signature=Ojy6Yh8FsFvpDyALtuDDtfXGkos%3D" alt="image.png" loading="lazy"/>
则 ID 选择器胜出。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51830e7888a448faa948ac727bcb7fa7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86bG85Z2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763310477&amp;x-signature=Grzh5j8Nk9PvySKGVbXv8iO%2Bn74%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-3">三、伪类与伪元素：动态与装饰性样式</h3>
<h4 data-id="heading-4">伪类（Pseudo-classes）</h4>
<p>用于定义元素的<strong>特殊状态</strong>，如 <code>:hover</code>、<code>:focus</code>、<code>:nth-child()</code> 等。</p>
<ul>
<li><code>a:hover</code>：鼠标悬停链接时变色</li>
<li><code>li:nth-child(odd)</code>：选中奇数列表项</li>
<li><code>button:active</code>：按钮点击时样式变化</li>
</ul>
<h4 data-id="heading-5">伪元素（Pseudo-elements）</h4>
<p>用于创建<strong>不存在于 DOM 中的内容</strong>，如 <code>::before</code>、<code>::after</code>、<code>::first-line</code>。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">p</span><span class="hljs-selector-pseudo">::first-line</span> { <span class="hljs-attribute">font-weight</span>: bold; }
<span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">::after</span> { <span class="hljs-attribute">content</span>: <span class="hljs-string">" ➡"</span>; }
</code></pre>
<p>注意：伪元素使用双冒号 <code>::</code>（CSS3 规范），但单冒号 <code>:</code> 在旧浏览器中仍兼容。</p>
<hr/>
<h3 data-id="heading-6">四、<code>nth-child</code> 与 <code>nth-of-type</code> 的区别</h3>
<p>这是初学者易混淆的一对选择器</p>
<ul>
<li><code>:nth-child(n)</code>：选中<strong>父元素下第 n 个子元素</strong>，无论类型。</li>
<li><code>:nth-of-type(n)</code>：选中<strong>父元素下第 n 个同类型元素</strong>。</li>
</ul>
<p>例如：</p>
<pre><code class="hljs language-css" lang="css">  <span class="hljs-comment">/* 子元素有点乱的时候，nth-child 有问题 */</span>
        <span class="hljs-selector-class">.container</span> <span class="hljs-selector-tag">p</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">1</span>){
            <span class="hljs-attribute">background-color</span>: yellow;
            <span class="hljs-attribute">color</span>: black;
        }
        <span class="hljs-comment">/* p标签同类型*/</span>
         <span class="hljs-selector-class">.container</span> <span class="hljs-selector-tag">p</span><span class="hljs-selector-pseudo">:nth-of-type</span>(<span class="hljs-number">3</span>){
            <span class="hljs-attribute">background-color</span>: yellow;
            <span class="hljs-attribute">color</span>: black;
        }
        
    &lt;/style&gt;
&lt;/head&gt;
&lt;<span class="hljs-selector-tag">body</span>&gt;
    &lt;<span class="hljs-selector-tag">div</span> class="container"&gt;
        &lt;<span class="hljs-selector-tag">h1</span>&gt;nth-child vs nth-of-type 示例&lt;/<span class="hljs-selector-tag">h1</span>&gt;
        &lt;<span class="hljs-selector-tag">p</span>&gt;这是一个段落。&lt;/<span class="hljs-selector-tag">p</span>&gt;
    &lt;<span class="hljs-selector-tag">div</span>&gt;这是一个<span class="hljs-selector-tag">div</span>。&lt;/<span class="hljs-selector-tag">div</span>&gt;
    &lt;<span class="hljs-selector-tag">p</span>&gt;这是第二个段落。&lt;/<span class="hljs-selector-tag">p</span>&gt;
    &lt;<span class="hljs-selector-tag">p</span>&gt;这是第三个段落。&lt;/<span class="hljs-selector-tag">p</span>&gt;
    &lt;<span class="hljs-selector-tag">div</span>&gt;这是第二个<span class="hljs-selector-tag">div</span>。&lt;/<span class="hljs-selector-tag">div</span>&gt;
    &lt;/<span class="hljs-selector-tag">div</span>&gt;
</code></pre>
<ul>
<li><code>p:nth-child(1)</code>：不匹配（第1个子元素是h1，不是 p）</li>
<li><code>p:nth-of-type(3)</code>：匹配“是第三个段落.”（它是第3个 p 元素）</li>
</ul>
<p>理解这一点对精确控制列表、表格等结构至关重要。</p>
<hr/>
<h3 data-id="heading-7">五、盒模型与 margin 重叠</h3>
<p>CSS 盒模型由 content、padding、border、margin 组成。其中 <strong>margin 重叠（margin collapse）</strong> 是一个经典问题：</p>
<ul>
<li><strong>垂直方向上相邻块级元素的 margin 会合并</strong>，取较大值而非相加。</li>
<li>例如两个相邻 <code>&lt;p&gt;</code> 元素，上 margin 为 20px，下 margin 为 30px，则实际间距为 30px，而非 50px。</li>
</ul>
<p>解决方法包括：</p>
<ul>
<li>使用 padding 代替部分 margin</li>
<li>创建 BFC（块级格式化上下文），如设置 <code>overflow: hidden</code></li>
</ul>
<hr/>
<h3 data-id="heading-8">六、单位与像素处理</h3>
<p>CSS 支持多种长度单位，其中 <strong>px（像素）是最常用的绝对单位</strong>。现代浏览器对小数 px（如 <code>10.5px</code>）通常会四舍五入或亚像素渲染，但不同设备表现可能不同。响应式设计中更推荐使用相对单位（如 <code>em</code>、<code>rem</code>、<code>%</code>、<code>vw/vh</code>）。</p>
<hr/>
<h3 data-id="heading-9">七、定位与 display 的交互</h3>
<p><code>position: absolute</code> 会使元素脱离文档流，并相对于最近的<strong>非 static 定位祖先元素</strong>定位。值得注意的是：</p>
<ul>
<li><strong><code>inline</code> 元素默认不支持 <code>transform</code> 和某些定位属性</strong>。</li>
<li>若需对行内元素应用 <code>transform</code> 或 <code>position: absolute</code>，通常需先将其 <code>display</code> 改为 <code>inline-block</code> 或 <code>block</code>。</li>
</ul>
<p>例如，若有一个 <code>&lt;span&gt;</code> 需要旋转，必须：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">span</span> {
  <span class="hljs-attribute">display</span>: inline-block;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotate</span>(<span class="hljs-number">10deg</span>);
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d7f04ff95434b8abf836449cfebaa83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86bG85Z2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763310477&amp;x-signature=GawblfI0avcc3XB3MbPhZk5hsPo%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c858b2ed45bd49f79515e48367dfbbd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86bG85Z2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763310477&amp;x-signature=er7w7AoawZBkqJuYuAx%2BBP4lEJs%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-10">八、层叠（Cascading）与样式来源</h3>
<p>CSS 的“C”即 Cascading（层叠），指样式如何从多个来源（用户代理、用户、作者）合并。规则包括：</p>
<ol>
<li>重要性（<code>!important</code>）</li>
<li>来源（作者 &gt; 用户 &gt; 浏览器默认）</li>
<li>优先级（ID &gt; class &gt; element）</li>
<li>源码顺序（后写的覆盖先写的）</li>
</ol>
<p>因此，良好的 CSS 架构应避免滥用 <code>!important</code>，而通过合理的选择器层级和模块化来管理样式。</p>
<hr/>
<h3 data-id="heading-11">九、实践建议</h3>
<p>我总结以下最佳实践：</p>
<ol>
<li><strong>语义化 HTML + 类选择器</strong>：避免过度依赖 ID 或标签选择器。</li>
<li><strong>慎用 <code>!important</code></strong>：它会破坏层叠逻辑，增加维护成本。</li>
<li><strong>理解盒模型</strong>：使用 <code>box-sizing: border-box</code> 可简化尺寸计算。</li>
<li><strong>测试跨浏览器行为</strong>：尤其涉及伪元素、flex/grid 布局时。</li>
<li><strong>利用开发者工具</strong>：Chrome DevTools 可直观查看选择器匹配与样式覆盖情况。</li>
</ol>
<hr/>
<h3 data-id="heading-12">结语</h3>
<p>CSS 虽看似简单，但其背后的层叠、继承、盒模型、定位机制构成了复杂而精密的系统。掌握选择器优先级、理解 margin 重叠、区分伪类与伪元素，是写出健壮、可维护样式的基石。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[库存预扣减之后，用户订单超时之后补偿库存的方案]]></title>    <link>https://juejin.cn/post/7570394530316795904</link>    <guid>https://juejin.cn/post/7570394530316795904</guid>    <pubDate>2025-11-10T03:38:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570394530316795904" data-draft-id="7570630923709890612" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="库存预扣减之后，用户订单超时之后补偿库存的方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-10T03:38:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无名之辈J"/> <meta itemprop="url" content="https://juejin.cn/user/3672818779437239"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            库存预扣减之后，用户订单超时之后补偿库存的方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3672818779437239/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无名之辈J
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T03:38:13.000Z" title="Mon Nov 10 2025 03:38:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">方案一：Redis的过期监听</h2>
<p>在redis里面中，key可以设过期时间，这就给我们提供了一个思路：我们可以给预扣减的库存键设一个过期时间，使用redis的发布订阅机制来监听键过期事件，从而自动触发回增库存的逻辑</p>
<p>功能目标：</p>
<ul>
<li>监听 Redis 中所有以 <code>product:</code> 开头的商品 key 的过期事件。</li>
<li>一旦某个商品 key 过期（比如用户超时未支付），自动执行库存回补（<code>INCR</code>）操作。</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp">js
 体验AI代码助手
 代码解读
复制代码
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">RedissonStockExpiredListener</span> {

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        
        <span class="hljs-comment">// 模拟预扣减库存</span>
        String productKey = <span class="hljs-string">"product:1001:stock"</span>;
        RBatch batch = redisson.getBatch();
        batch.<span class="hljs-keyword">get</span>(productKey).setAsync(<span class="hljs-number">100L</span>);           <span class="hljs-comment">// 初始化库存</span>
        batch.<span class="hljs-keyword">get</span>(productKey).decrementAsync();         <span class="hljs-comment">// 预扣减</span>
        batch.<span class="hljs-keyword">get</span>(productKey).expireAsync(<span class="hljs-number">5</span>, TimeUnit.SECONDS); <span class="hljs-comment">// 设置5秒过期</span>
        batch.execute();

        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"已预扣减库存，并设置5秒后过期"</span>);

        <span class="hljs-comment">// 订阅 Redis 的 key 过期事件</span>
        RTopic topic = redisson.getTopic(<span class="hljs-string">"__keyevent@*:expired"</span>);
        topic.addListener(String.<span class="hljs-keyword">class</span>, <span class="hljs-keyword">new</span> MessageListener&lt;String&gt;() {
            @Override
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onMessage</span>(<span class="hljs-params">CharSequence channel, String key</span>)</span> {
                System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"监听到 key 过期："</span> + key);

                <span class="hljs-keyword">if</span> (key != <span class="hljs-literal">null</span> &amp;&amp; key.startsWith(<span class="hljs-string">"product:"</span>)) {
                    System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"处理商品 key 过期，准备补偿库存..."</span>);

                    <span class="hljs-comment">// 补偿库存：INCR</span>
                    RAtomicLong stock = redisson.getAtomicLong(key);
                    <span class="hljs-built_in">long</span> newStock = stock.incrementAndGet(); <span class="hljs-comment">// INCR</span>
                    System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"库存已补偿，当前库存："</span> + newStock);
                } <span class="hljs-keyword">else</span> {
                    System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"忽略非商品 key："</span> + key);
                }
            }
        });

        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"正在监听 Redis key 过期事件..."</span>);
    }
}
</code></pre>
<p>优点是实时性强，对要求实时性高的业务比较友好，如抢票等。缺点是过于依靠Redis，风险不能分摊。且容易造成大量过期Key问题，影响性能。</p>
<h2 data-id="heading-1">方案二：Redis的延时队列</h2>
<p>我们可以基于Redis的Sorted Set数据类型来做一个延时队列，通过score来进行排序，我们服务端下单时在当前时间加上超时时间，将订单ID放入进去，通过定时任务来定量拿取超时订单进行取消订单+补偿库存。</p>
<p><strong>添加订单到延时队列</strong></p>
<ul>
<li>当用户下单但未支付时，计算出订单的超时时间（例如：当前时间 + 30 分钟），然后将订单 ID 以这个时间为 score 添加到 Redis Sorted Set 中。</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">js
 体验AI代码助手
 代码解读
复制代码
RScoredSortedSet&lt;String&gt; <span class="hljs-attr">delayedQueue</span> = redisson.getScoredSortedSet(<span class="hljs-string">"delayed:order:queue"</span>)<span class="hljs-comment">;</span>
long <span class="hljs-attr">timeoutTime</span> = System.currentTimeMillis() + TimeUnit.MINUTES.toMillis(<span class="hljs-number">30</span>)<span class="hljs-comment">; // 30分钟后超时</span>
delayedQueue.add(timeoutTime, orderId)<span class="hljs-comment">;</span>
</code></pre>
<p><strong>定时任务检查并处理超时订单</strong></p>
<ul>
<li>定期运行一个后台任务，使用 <code>ZRANGEBYSCORE</code> 获取所有已经到期的订单（即 score 小于等于当前时间戳的所有订单）。</li>
<li>对于每个找到的订单，执行取消订单和补偿库存的操作，并从 Sorted Set 中移除这些订单。</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">js
 体验AI代码助手
 代码解读
复制代码
long currentTime = System<span class="hljs-selector-class">.currentTimeMillis</span>();
Collection&lt;String&gt; expiredOrders = delayedQueue<span class="hljs-selector-class">.valueRange</span>(<span class="hljs-number">0</span>, true, currentTime, false);
for (String orderId : expiredOrders) {
    try {
        <span class="hljs-comment">// 执行取消订单逻辑</span>
        <span class="hljs-built_in">cancelOrder</span>(orderId);

        <span class="hljs-comment">// 补偿库存逻辑</span>
        <span class="hljs-built_in">restoreStock</span>(orderId);
        
        <span class="hljs-comment">// 从延迟队列中删除该订单</span>
        delayedQueue<span class="hljs-selector-class">.remove</span>(orderId);
    } catch (Exception e) {
        <span class="hljs-comment">// 异常处理</span>
        logger<span class="hljs-selector-class">.error</span>("处理超时订单失败: {}", orderId, e);
    }
}
</code></pre>
<p>方案优点和方案一差不多，实时性好延迟小，但是就是过于依靠Redis，有数据丢失的风险。而且Redis是基于内存的，如果超时订单过多对Redis压力过大，容易挂机。</p>
<h2 data-id="heading-2">方案三：MQ的延时消息</h2>
<p>用户下单之后，生产者将设置好时间的消息发送给broker，等到规定的消息之后，该消息才对消费者可见，broker发送相应消息给消费者，消费者执行订单取消+库存补偿逻辑即可（消息重试机制保证消费者一定可以消费）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f20b82d53182420583bd9a1ade5a2e37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5ZCN5LmL6L6ISg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763350693&amp;x-signature=LBpBoW9awcOW2Fy3aSbfHnPj0qg%3D" alt="image.png" loading="lazy"/></p>
<p><strong>生产者：用户下单后发送延时消息</strong></p>
<pre><code class="hljs language-java" lang="java">js
 体验AI代码助手
 代码解读
复制代码
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RocketMQTemplate rocketMQTemplate;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderService</span><span class="hljs-params">(RocketMQTemplate rocketMQTemplate)</span> {
        <span class="hljs-built_in">this</span>.rocketMQTemplate = rocketMQTemplate;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(String orderId, String productKey)</span> {
        <span class="hljs-comment">// 1. 创建订单（伪代码）</span>
        System.out.println(<span class="hljs-string">"创建订单："</span> + orderId);

        <span class="hljs-comment">// 2. 预扣减库存（假设用 Redisson）</span>
        <span class="hljs-comment">// RAtomicLong stock = redisson.getAtomicLong(productKey);</span>
        <span class="hljs-comment">// stock.decrementAndGet();</span>

        <span class="hljs-comment">// 3. 发送延迟消息，level=15 对应 30分钟</span>
        <span class="hljs-type">OrderTimeoutMessage</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderTimeoutMessage</span>(orderId, productKey);
        rocketMQTemplate.convertAndSend(<span class="hljs-string">"ORDER_TIMEOUT_TOPIC"</span>, message, <span class="hljs-literal">null</span>, <span class="hljs-number">15</span>); <span class="hljs-comment">// level=15</span>
        System.out.println(<span class="hljs-string">"已发送延迟消息，30分钟后处理订单："</span> + orderId);
    }
}
</code></pre>
<p><strong>消费者：监听并处理超时订单</strong></p>
<pre><code class="hljs language-typescript" lang="typescript">js
 体验<span class="hljs-variable constant_">AI</span>代码助手
 代码解读
复制代码
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@RocketMQMessageListener</span>(topic = <span class="hljs-string">"ORDER_TIMEOUT_TOPIC"</span>, consumerGroup = <span class="hljs-string">"order-timeout-group"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderTimeoutConsumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RocketMQListener</span>&lt;<span class="hljs-title class_">OrderTimeoutMessage</span>&gt; {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onMessage</span>(<span class="hljs-params">OrderTimeoutMessage message</span>) {
        <span class="hljs-title class_">String</span> orderId = message.<span class="hljs-property">orderId</span>;
        <span class="hljs-title class_">String</span> productKey = message.<span class="hljs-property">productKey</span>;
        long expectedExpireTime = message.<span class="hljs-property">timestamp</span> + <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">MINUTES</span>.<span class="hljs-title function_">toMillis</span>(<span class="hljs-number">30</span>);

        <span class="hljs-comment">// 1. 判断是否已经过期（防止重复消费或提前消费）</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">System</span>.<span class="hljs-title function_">currentTimeMillis</span>() &lt; expectedExpireTime) {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"消息尚未到期，跳过处理："</span> + orderId);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 2. 查询订单状态（伪代码）</span>
        <span class="hljs-built_in">boolean</span> paid = <span class="hljs-title function_">checkIfOrderPaid</span>(orderId);
        <span class="hljs-keyword">if</span> (paid) {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"订单已支付，无需处理："</span> + orderId);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 3. 未支付 → 取消订单 + 补偿库存</span>
        <span class="hljs-title function_">cancelOrder</span>(orderId);
        <span class="hljs-title function_">restoreStock</span>(productKey);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">checkIfOrderPaid</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> orderId</span>) {
        <span class="hljs-comment">// 查询数据库判断是否已支付（伪逻辑）</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 假设未支付</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">cancelOrder</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> orderId</span>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"取消订单："</span> + orderId);
        <span class="hljs-comment">// 实际操作：更新订单状态为已取消</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">restoreStock</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> productKey</span>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"补偿库存："</span> + productKey);
        <span class="hljs-comment">// 实际操作：INCR productKey</span>
        <span class="hljs-comment">// RAtomicLong stock = redisson.getAtomicLong(productKey);</span>
        <span class="hljs-comment">// stock.incrementAndGet();</span>
    }
}
</code></pre>
<p>RocketMQ是5.x的版本就可以支持任意时刻的延时消息了，否则就是对应级别的延时消息。</p>
<p>优点是高并发性能好，而且处理消息丢失等方案成熟。缺点就是系统架构更加复杂了，需要处理MQ的其他问题，维护成本变高了。</p>
<h2 data-id="heading-3">方案四：分布式定时任务调度框架</h2>
<p>使用分布式定时任务调度框架，比如<strong>xxl-job 或 Quartz</strong>是企业里面非常常见的方案。用户下单之后，我们在数据库里面记录订单状态为“待支付”，然后通过xxl-job定期扫描过期的订单，筛选出超时未支付的订单，进行取消订单+补偿库存。</p>
<pre><code class="hljs language-java" lang="java">js
 体验AI代码助手
 代码解读
复制代码
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderTimeoutJobHandler</span> {

    <span class="hljs-meta">@XxlJob("orderTimeoutJob")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">orderTimeoutJob</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        XxlJobLogger.log(<span class="hljs-string">"开始执行超时订单检测任务..."</span>);

        <span class="hljs-comment">// 1. 获取当前时间</span>
        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();

        <span class="hljs-comment">// 2. 查询所有 timeout_time &lt;= now 且 status = 0 的订单</span>
        List&lt;Order&gt; expiredOrders = orderMapper.findExpiredOrders(now);

        <span class="hljs-keyword">for</span> (Order order : expiredOrders) {
            <span class="hljs-comment">// 3. 加锁防止并发处理同一订单（可选 Redis 分布式锁）</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">locked</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().setIfAbsent(
                <span class="hljs-string">"lock:order:"</span> + order.getId(), <span class="hljs-string">"locked"</span>, <span class="hljs-number">5</span>, TimeUnit.MINUTES);

            <span class="hljs-keyword">if</span> (!locked) {
                <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// 已被其他节点处理</span>
            }

            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 4. 再次确认是否已支付（防止并发问题）</span>
                <span class="hljs-type">Order</span> <span class="hljs-variable">updatedOrder</span> <span class="hljs-operator">=</span> orderMapper.selectById(order.getId());
                <span class="hljs-keyword">if</span> (updatedOrder.getStatus() != <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-comment">// 5. 更新订单状态为“已取消”</span>
                orderMapper.updateStatus(order.getId(), <span class="hljs-number">2</span>);

                <span class="hljs-comment">// 6. 补偿库存（如使用 Redisson）</span>
                <span class="hljs-type">RAtomicLong</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> redisson.getAtomicLong(order.getProductKey());
                stock.incrementAndGet();

                XxlJobLogger.log(<span class="hljs-string">"已取消订单："</span> + order.getId() + <span class="hljs-string">"，补偿库存："</span> + order.getProductKey());

            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-comment">// 7. 释放锁</span>
                redisTemplate.delete(<span class="hljs-string">"lock:order:"</span> + order.getId());
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-4">重复补偿库存问题</h2>
<p>由于网络延迟或者网络分区，又或者是Redis服务器问题，还有并发问题等，有可能会导致重复补偿库存的情况，那么该怎么解决呢？</p>
<p><strong>1.使用分布式锁</strong></p>
<ul>
<li>在执行库存补偿之前，尝试获取一个针对特定商品 ID 的分布式锁。只有成功获取锁的进程才能执行补偿操作。这样可以防止多个实例同时处理同一个过期事件。</li>
<li>示例代码片段：</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp">js
 体验AI代码助手
 代码解读
复制代码
RLock <span class="hljs-keyword">lock</span> = redisson.getLock(<span class="hljs-string">"lock:product:"</span> + productId);
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">lock</span>.tryLock()) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 执行库存补偿逻辑</span>
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">lock</span>.unlock();
    }
}
</code></pre>
<p><strong>2.状态标记</strong></p>
<ul>
<li>在补偿库存后，给对应的 key 添加一个特殊的标识（如 <code>compensated</code> 标记）。下次再遇到该 key 过期时，先检查是否存在这个标记。如果存在，则跳过补偿步骤。</li>
<li>示例代码片段：</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino">js
 体验AI代码助手
 代码解读
复制代码
<span class="hljs-keyword">if</span> (!redissonMap.<span class="hljs-built_in">containsKey</span>(productId + <span class="hljs-string">":compensated"</span>)) {
    <span class="hljs-comment">// 执行库存补偿逻辑</span>
    redissonMap.<span class="hljs-built_in">put</span>(productId + <span class="hljs-string">":compensated"</span>, <span class="hljs-literal">true</span>);
}
</code></pre>
<p><strong>3.延迟队列结合定时任务</strong></p>
<p>刚才方案二就可以解决这个问题，将需要补偿的订单信息放入延迟队列中，并设置适当的延迟时间。通过后台定时任务统一处理这些订单，确保每个订单只被处理一次。</p>
<p><strong>4.数据库唯一约束</strong></p>
<p>通过建立补偿库存表，业务和订单id作为唯一索引，每次补偿之前尝试是否可以插入该表，可以则补偿，反之则跳过。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我在 Mac 用一行脚本征服了 5TB NTFS：拒绝付费，彻底搞定免费方案]]></title>    <link>https://juejin.cn/post/7570394530316025856</link>    <guid>https://juejin.cn/post/7570394530316025856</guid>    <pubDate>2025-11-10T01:42:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570394530316025856" data-draft-id="7570162891141824527" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我在 Mac 用一行脚本征服了 5TB NTFS：拒绝付费，彻底搞定免费方案"/> <meta itemprop="keywords" content="macOS,Mac"/> <meta itemprop="datePublished" content="2025-11-10T01:42:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="嚴寒"/> <meta itemprop="url" content="https://juejin.cn/user/3597257779474941"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我在 Mac 用一行脚本征服了 5TB NTFS：拒绝付费，彻底搞定免费方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3597257779474941/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    嚴寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T01:42:29.000Z" title="Mon Nov 10 2025 01:42:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:18px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:40px;margin-bottom:20px;color:#007fff;display:flex;align-items:center}.markdown-body h1:hover:before,.markdown-body h2:hover:before,.markdown-body h3:hover:before,.markdown-body h4:hover:before,.markdown-body h5:hover:before,.markdown-body h6:hover:before{transition:All .4s ease-in-out;transform:rotate(1turn)}.markdown-body h1{font-size:30px;background:linear-gradient(#fff 60%,#c6e3ff 0)}.markdown-body h1:before{content:"";display:inline-block;width:32px;height:32px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h2{font-size:24px;background:linear-gradient(#fff 60%,#cce3fb 0)}.markdown-body h2:before{content:"";display:inline-block;width:24px;height:24px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h3{font-size:20px}.markdown-body h3:before{content:"";display:inline-block;width:18px;height:18px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h4{font-size:18px}.markdown-body h4:before{content:"";display:inline-block;width:16px;height:16px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h5{font-size:16px}.markdown-body h5:before{content:"";display:inline-block;width:15px;height:15px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h6{font-size:14px}.markdown-body h6:before{content:"";display:inline-block;width:12px;height:12px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{border-bottom:2px solid #007fff;color:#007fff;padding-right:10px}.markdown-body p{letter-spacing:1px;line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:10px auto}.markdown-body hr{border:none;border-top:1px dashed #92c8ff}.markdown-body hr:before{content:"✂";display:inline-block;position:relative;top:-12px;left:40px;padding:0 3px;color:#007fff;font-size:18px}.markdown-body hr:after{content:"按虚线剪开";position:relative;top:-15px;left:84%;padding:0 3px;color:#007fff;font-size:12px}.markdown-body del{color:#f44}.markdown-body em{color:#007fff;margin:0 2px}.markdown-body strong{color:#007fff;font-weight:bolder}.markdown-body code{word-break:break-word;border-radius:4px;overflow-x:auto;background-color:#e6f3ff;color:#007fff;font-weight:600;font-size:16px;padding:.065em .4em;border:1px solid #007fff}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:5px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:18px;font-weight:400;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8;border:none}.markdown-body a{text-decoration:none;color:#007fff;border-bottom:1px solid #007fff}.markdown-body a:before{content:"¶";margin-right:5px;font-size:22px}.markdown-body a:after{content:"↷";margin-left:2px;font-size:22px;display:none}.markdown-body a:active,.markdown-body a:hover{color:#275b8c;border-bottom:1px solid #275b8c}.markdown-body a:active:after,.markdown-body a:hover:after{display:inline-block}.markdown-body table{display:inline-block!important;font-size:16px;width:auto;max-width:100%;overflow:auto;border:1px solid #a5d3ff}.markdown-body thead{background:#c6e3ff;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#eef7ff}.markdown-body tbody&gt;tr:nth-child(odd){background-color:#f8fcff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #007fff;background-color:#eef7ff}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#007fff}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="srcery">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1b19;color:#fce8c3}.hljs-emphasis,.hljs-strong{color:#918175}.hljs-bullet,.hljs-link,.hljs-literal,.hljs-number,.hljs-quote,.hljs-regexp{color:#ff5c8f}.hljs-code,.hljs-selector-class{color:#68a8e4}.hljs-emphasis{font-style:italic}.hljs-attribute,.hljs-keyword,.hljs-section,.hljs-selector-tag,.hljs-variable{color:#ef2f27}.hljs-name,.hljs-title{color:#fbb829}.hljs-params,.hljs-type{color:#0aaeb3}.hljs-string{color:#98bc37}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-selector-attr,.hljs-selector-id,.hljs-selector-pseudo,.hljs-subst,.hljs-symbol,.hljs-template-tag,.hljs-template-variable{color:#c07abe}.hljs-comment,.hljs-deletion,.hljs-meta{color:#918175}</style><h2 data-id="heading-0">🧩 前言：从“只读”到“征服”</h2>
<p>那天下午，我插上那块 5TB 的移动硬盘，Finder 一脸冷漠。文件是灰色的，右键菜单也没“删除”选项——我只能“看”，不能“动”。</p>
<p>那一刻，我第一次认真地理解了：<strong>macOS 对 NTFS 是只读的。</strong></p>
<p>我上网一搜，“NTFS for Mac” 的结果铺天盖地，几乎清一色都是收费软件：Paragon、Tuxera、iBoySoft……</p>
<p><strong>￥199、￥299、￥399。</strong></p>
<p>我心想：只是写个文件，还得付钱？</p>
<p>于是我决定自己动手。这一下午，我用一行脚本，搞定了 Mac 对 NTFS 的全面读写。</p>
<hr/>
<h2 data-id="heading-1">⚙️ 第一次尝试：brew install ntfs-3g</h2>
<p>我打开终端，信心满满地敲下：</p>
<pre><code class="hljs language-bash" lang="bash">brew install ntfs-3g
</code></pre>
<p>结果终端甩我一句：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Linux <span class="hljs-keyword">is</span> required <span class="hljs-keyword">for</span> <span class="hljs-keyword">this</span> software.
</code></pre>
<p>？？？这啥意思？我又不是在用 Linux。</p>
<p>查了资料才知道：从 macOS Big Sur 开始，Apple 改了文件系统接口，原版 <code>ntfs-3g</code> 不再直接支持，需要借助一个新的驱动桥——<strong>macFUSE</strong>。</p>
<hr/>
<h2 data-id="heading-2">🔌 第二步：macFUSE + ntfs-3g-mac</h2>
<p>于是我继续安装：</p>
<pre><code class="hljs language-bash" lang="bash">brew install --cask macfuse
brew tap gromgit/homebrew-fuse
brew install ntfs-3g-mac
</code></pre>
<p>安装倒是顺利，但系统弹出一个让我有点紧张的提示：</p>
<blockquote>
<p>系统扩展被阻止：Benjamin Fleischer。</p>
</blockquote>
<p>原来 macFUSE 属于第三方内核扩展，需要进入恢复模式降低安全策略。</p>
<p>我照着文档重启、长按电源键，进入 Options → Security Policy，</p>
<p>勾选了 <strong>“Allow user management of kernel extensions”</strong>，保存后再重启。</p>
<p>回到系统后，在 <strong>系统设置 → 隐私与安全性</strong> 里点击 <strong>Allow macFUSE 开发者</strong>。</p>
<p>重启完毕，终于看到熟悉的成功提示。</p>
<hr/>
<h2 data-id="heading-3">🧠 写一个脚本，让一切自动化</h2>
<p>我不想每次都手动执行 <code>diskutil</code>、<code>umount</code>、<code>ntfs-3g</code>。于是我写了个智能脚本，叫：<code>ntfs-smart.sh</code>。</p>
<p>它能自动：</p>
<ol>
<li>检测 macOS 是否已只读挂载 (fskit)。</li>
<li>自动卸载后用 ntfs-3g 重新挂载为读写。</li>
<li>卸载时自动执行 <code>diskutil eject</code> 确保物理断电。</li>
<li>清理 Spotlight、QuickLook 占用进程。</li>
</ol>
<p>保存到桌面，赋予执行权限：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> +x ~/Desktop/ntfs-smart.sh
</code></pre>
<p>运行后，终端输出：</p>
<pre><code class="hljs language-javascript" lang="javascript">⚙️ 检测到 macOS 自动只读挂载 (fskit): <span class="hljs-regexp">/dev/</span>disk4s1
➡️  正在卸载以重新挂载为可写...
✅ 找到分区: <span class="hljs-regexp">/dev/</span>disk4s1
📌 正在挂载到 /<span class="hljs-title class_">Volumes</span>/<span class="hljs-title class_">MyPassport</span> (读写)...
🎉 挂载成功: <span class="hljs-regexp">/Volumes/</span><span class="hljs-title class_">MyPassport</span>
</code></pre>
<p>Finder 里，那些灰掉的文件终于变亮了。</p>
<p>我可以直接复制、删除、创建文件夹。</p>
<p>那一刻，我笑了——<strong>它终于听话了。</strong></p>
<hr/>
<h2 data-id="heading-4">💡 意外发现：$RECYCLE.BIN？System Volume Information？</h2>
<p>刚开始我以为挂载出错，因为 Finder 突然多了两个陌生的目录：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-variable">$RECYCLE</span>.BIN
System Volume Information
</code></pre>
<p>后来我才知道，它们是 Windows 自带的系统目录。</p>
<ul>
<li><code>$RECYCLE.BIN</code>：回收站文件夹。</li>
<li><code>System Volume Information</code>：系统还原点与索引数据库。</li>
</ul>
<p>macOS 默认隐藏它们，但 FUSE 挂载后全部暴露出来。</p>
<p>我顺手加了个隐藏配置：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$RECYCLE</span>.BIN"</span> &gt;&gt; /Volumes/MyPassport/.hidden
<span class="hljs-built_in">echo</span> <span class="hljs-string">"System Volume Information"</span> &gt;&gt; /Volumes/MyPassport/.hidden
</code></pre>
<p>Finder 刷新后，它们就消失了。世界干净了。</p>
<hr/>
<h2 data-id="heading-5">🔄 卸载也要优雅</h2>
<p>以前我都是直接在 Finder 点“推出”，结果经常提示：</p>
<blockquote>
<p>“磁盘正在使用中，无法弹出。”</p>
</blockquote>
<p>所以我给脚本加了自动卸载逻辑：</p>
<ol>
<li>
<p>检测当前挂载点。</p>
</li>
<li>
<p>卸载卷。</p>
</li>
<li>
<p>自动执行：</p>
<pre><code class="hljs language-bash" lang="bash">sudo diskutil eject /dev/disk4
</code></pre>
</li>
<li>
<p>输出：</p>
<pre><code class="hljs">✅ 设备已断开，可安全拔出。
</code></pre>
</li>
</ol>
<p>现在，我的拔盘过程优雅得像动画片：
硬盘灯闪两下，停住，安静消失。</p>
<hr/>
<h2 data-id="heading-6">⚙️ 最终方案总结</h2>





























<table><thead><tr><th>功能</th><th>状态</th></tr></thead><tbody><tr><td>免费方案</td><td>✅</td></tr><tr><td>兼容 Apple Silicon</td><td>✅</td></tr><tr><td>支持读写</td><td>✅</td></tr><tr><td>自动挂载/卸载</td><td>✅</td></tr><tr><td>安全弹出</td><td>✅</td></tr></tbody></table>
<p>所有步骤只需运行：</p>
<pre><code class="hljs language-bash" lang="bash">~/Desktop/ntfs-smart.sh
</code></pre>
<p>一行命令，全自动完成。</p>
<hr/>
<h2 data-id="heading-7">🚀 尾声：一行脚本的自由</h2>
<p>回过头看，macOS 的封闭并不是坏事，它保护了普通用户不去乱动系统。可对开发者来说，能完全掌控自己的文件系统，是一种自由。</p>
<p>我没有安装任何收费软件，也没修改系统底层，只是用几个开源工具，让 Mac 和 Windows 重新握了个手。</p>
<p>现在，每次我插上硬盘，只需执行：</p>
<pre><code class="hljs language-bash" lang="bash">~/Desktop/ntfs-smart.sh
</code></pre>
<p>看着那一行行 ✅ 输出，我都觉得，这个下午，折腾得值。</p>
<blockquote>
<p>“懂原理的人，才是真正的管理员。”</p>
</blockquote>
<hr/>
<p>仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYangsonHung%2Fmacos-ntfs-smart-mount" target="_blank" title="https://github.com/YangsonHung/macos-ntfs-smart-mount" ref="nofollow noopener noreferrer">macos-ntfs-smart-mount</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.yangsonhung.top%2Farchives%2Fwo-zai-mac-yong-yi-xing-jiao-ben-zheng-fu-liao-5tb-ntfs-ju-jue-fu-fei-che-di-gao-ding-mian-fei-fang-an" target="_blank" title="https://www.yangsonhung.top/archives/wo-zai-mac-yong-yi-xing-jiao-ben-zheng-fu-liao-5tb-ntfs-ju-jue-fu-fei-che-di-gao-ding-mian-fei-fang-an" ref="nofollow noopener noreferrer">原文移步个人博客</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从逐行编码到「氛围编程」：Trae 带你进入 AI 编程新纪元]]></title>    <link>https://juejin.cn/post/7570197010886508590</link>    <guid>https://juejin.cn/post/7570197010886508590</guid>    <pubDate>2025-11-10T02:53:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570197010886508590" data-draft-id="7570271574348070921" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从逐行编码到「氛围编程」：Trae 带你进入 AI 编程新纪元"/> <meta itemprop="keywords" content="Trae,AI编程,VibeCoding"/> <meta itemprop="datePublished" content="2025-11-10T02:53:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="生椰丝绒拿铁"/> <meta itemprop="url" content="https://juejin.cn/user/4185180725584116"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从逐行编码到「氛围编程」：Trae 带你进入 AI 编程新纪元
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4185180725584116/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    生椰丝绒拿铁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T02:53:12.000Z" title="Mon Nov 10 2025 02:53:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为开发者，你是否还在为逐行敲代码而感到枯燥？是否在面对设计需求时，还要在代码和设计工具间来回切换？今天，我们来聊聊一种全新的编程方式 ——<strong>Vibe Coding（氛围编程）</strong> ，以及它的「最佳拍档」——Trae AI 编辑器如何重塑我们的开发流程。</p>
<h2 data-id="heading-0">一、什么是「氛围编程」？打破传统编码的边界</h2>
<p>传统编程是「指令式」的：你必须精确地告诉计算机每一步做什么，从变量声明到函数逻辑，逐行编写。而 <strong>「氛围编程」</strong> 则是「意图式」的 —— 你只需要描述你想要的「感觉」「效果」或者「功能氛围」，AI 就能理解你的模糊意图，并转化为具体的代码实现。</p>
<p>举个例子：</p>
<ul>
<li>你不用再纠结 CSS 动画的具体参数，只需说「帮我把按钮的交互做得有科技感，hover 时带点流光效果」；</li>
<li>遇到代码 Bug 时，不用逐行 Debug，直接把有问题的代码丢给 AI，说「修复这段代码里的逻辑漏洞，让它能正确处理数组深拷贝」。</li>
</ul>
<h2 data-id="heading-1">二、Trae：AI 编程的「沉浸式座舱」</h2>
<p>Trae 作为一款 AI 编辑器，就是「氛围编程」的最佳载体。它不止是一个代码编辑器，更是一个<strong>全栈开发 + 设计的 AI 协作伙伴</strong>。</p>
<h3 data-id="heading-2">1. 从需求到实现，Trae 帮你「一步到位」</h3>
<p>比如我想做一个「Hello Trae」的欢迎页面，只需要描述我的需求：</p>
<blockquote>
<p>「创建一个具有现代化设计风格的 HTML 页面，要有简洁的 UI、响应式布局，标题是『Hello Trae!』，整体风格清新且专业。」</p>
</blockquote>
<p>Trae 就能直接生成完整的代码，包括 HTML、CSS 和响应式设计：</p>
<p>html</p>
<p>预览</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Hello Trae<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">body</span> {
            <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'Arial'</span>, sans-serif;
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">justify-content</span>: center;
            <span class="hljs-attribute">align-items</span>: center;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f5f5f5</span>;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
        }
        <span class="hljs-selector-class">.container</span> {
            <span class="hljs-attribute">text-align</span>: center;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">40px</span>;
            <span class="hljs-attribute">background-color</span>: white;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">10px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
        }
        <span class="hljs-selector-tag">h1</span> {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#4a6fa5</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
        }
        <span class="hljs-selector-tag">p</span> {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#666</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">18px</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello Trae!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>欢迎使用Trae AI编码助手<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>这段代码不仅结构清晰，还自带响应式布局和美观的视觉设计，完全符合「简洁现代、交互友好」的需求。</p>
<h3 data-id="heading-3">2. 内置规则：让 AI 理解「项目级」约定</h3>
<p>Trae 通过 <code>.trae/rules/project_rules.md</code> 来定义项目规范，比如：</p>
<ul>
<li>技术栈优先选择纯 HTML、CSS、JavaScript，保证项目独立性；</li>
<li>必须采用响应式设计，适配手机、平板、桌面端；</li>
<li>代码结构要清晰，兼顾美观性和实用性。</li>
</ul>
<p>有了这些规则，Trae 生成的代码从不是「一次性玩具」，而是能直接用于生产环境的「工程化代码」。</p>
<h3 data-id="heading-4">3. 本地预览 + 热更新：开发体验拉满</h3>
<p>生成 HTML 后，Trae 还能自动启动本地服务器（用 <code>npx live-server</code>），并支持<strong>热更新</strong>—— 你修改代码后，浏览器会自动刷新，无需手动操作。</p>
<p>启动命令也很简单：</p>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs language-css" lang="css">npx <span class="hljs-attr">--yes</span> live-server <span class="hljs-attr">--port</span>=<span class="hljs-number">3000</span> <span class="hljs-attr">--host</span>=localhost <span class="hljs-attr">--no-browser</span> 文件名<span class="hljs-selector-class">.html</span>
</code></pre>
<h2 data-id="heading-5">三、编程概念通俗讲：深拷贝、栈与堆</h2>
<p>很多开发者对「深拷贝」「栈内存」「堆内存」这些概念感到困惑，我们结合代码来通俗理解一下：</p>
<h3 data-id="heading-6">1. 栈内存：简单高效的「临时货架」</h3>
<p>栈内存就像超市的「临时货架」，用来存储简单变量（比如 <code>let a = 1</code>、<code>let b = 'hello'</code>）。它的特点是<strong>连续存储、读写快</strong>，变量用完就会被自动回收。</p>
<p>比如：</p>
<p>js</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">a</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
let <span class="hljs-attr">d</span> = a<span class="hljs-comment">; // 这里是「值拷贝」，相当于把a的值「复印」了一份给d，两者互不影响</span>
</code></pre>
<h3 data-id="heading-7">2. 堆内存：弹性灵活的「储物仓库」</h3>
<p>堆内存就像「储物仓库」，用来存储复杂数据（比如对象、数组）。它的特点是<strong>空间弹性大，但访问速度不如栈</strong>。</p>
<p>比如我们有一个用户数组：</p>
<p>js</p>
<pre><code class="hljs language-bash" lang="bash">const <span class="hljs-built_in">users</span> = [
  { <span class="hljs-built_in">id</span>: 1, name: <span class="hljs-string">"陈俊璋"</span>, hometown: <span class="hljs-string">"南昌"</span> },
  { <span class="hljs-built_in">id</span>: 2, name: <span class="hljs-string">"舒俊"</span>, hometown: <span class="hljs-string">"南昌"</span> }
];
</code></pre>
<p><code>users</code> 变量在<strong>栈内存</strong>中存储的是「指向堆内存中数组的地址」，而真正的数组数据存在<strong>堆内存</strong>里。</p>
<h3 data-id="heading-8">3. 深拷贝：真正的「独立副本」</h3>
<p>如果直接赋值（<code>const data = users</code>），只是把「地址」拷贝了一份（<strong>引用式拷贝</strong>），此时 <code>data</code> 和 <code>users</code> 指向堆内存中同一个数组，修改 <code>data</code> 会影响 <code>users</code>。</p>
<p>要实现「深拷贝」，可以用 <code>JSON.stringify</code> + <code>JSON.parse</code>：</p>
<p>js</p>
<pre><code class="hljs language-ini" lang="ini">// 先把users转成JSON字符串（序列化），再解析成新对象（反序列化）
const <span class="hljs-attr">data</span> = JSON.parse(JSON.stringify(users))<span class="hljs-comment">;</span>
data<span class="hljs-section">[0]</span>.<span class="hljs-attr">hobbies</span> = [<span class="hljs-string">"篮球"</span>, <span class="hljs-string">"看烟花"</span>]<span class="hljs-comment">; </span>
// 此时修改data不会影响users，因为它们在堆内存中是两个独立的对象了
</code></pre>
<h2 data-id="heading-9">四、Node.js 搭个 HTTP 服务器：从本地到网络</h2>
<p>很多新手觉得「搭建服务器」很复杂，其实用 Node.js 内置的 <code>http</code> 模块只需几行代码：</p>
<p>js</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> http <span class="hljs-keyword">from</span> <span class="hljs-string">'http'</span>;

<span class="hljs-comment">// 创建服务器，处理请求和响应</span>
http.<span class="hljs-title function_">createServer</span>(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">end</span>(<span class="hljs-string">"hello world"</span>); <span class="hljs-comment">// 向浏览器返回「hello world」</span>
}).<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>); <span class="hljs-comment">// 监听3000端口</span>
</code></pre>
<p>这段代码运行后，你在浏览器访问 <code>http://localhost:3000</code>，就能看到「hello world」—— 这就是最基础的 <strong>B/S 架构</strong>（浏览器 - 服务器）交互。</p>
<h2 data-id="heading-10">五、写在最后：开发者的「效率革命」</h2>
<p>Trae 代表的「氛围编程」，不是要取代开发者，而是让开发者从「代码工人」升级为「创意指挥官」—— 你负责提出想法、把握方向，AI 负责把想法落地成代码和设计。</p>
<p>这种模式不仅降低了编程的门槛，更让开发者能把精力放在<strong>业务逻辑、用户体验、创新功能</strong>上。如果你也想摆脱重复编码的枯燥，不妨试试「氛围编程」，让 Trae 成为你开发路上的「超级助手」。</p>
<p>现在，打开 Trae，描述一个你最想实现的功能，看看 AI 能给你带来什么惊喜吧！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ASP.NET Core Blazor进阶1：高级组件开发]]></title>    <link>https://juejin.cn/post/7570630923709906996</link>    <guid>https://juejin.cn/post/7570630923709906996</guid>    <pubDate>2025-11-10T03:42:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570630923709906996" data-draft-id="7570533058840985635" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ASP.NET Core Blazor进阶1：高级组件开发"/> <meta itemprop="keywords" content="前端,前端框架"/> <meta itemprop="datePublished" content="2025-11-10T03:42:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码农刚子"/> <meta itemprop="url" content="https://juejin.cn/user/2693136629379932"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ASP.NET Core Blazor进阶1：高级组件开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2693136629379932/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码农刚子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T03:42:40.000Z" title="Mon Nov 10 2025 03:42:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>嗨~ 大家好，我是码农刚子。本文将深入探讨Blazor中的高级组件开发技术，包括渲染片段、动态组件、错误边界和虚拟化组件，帮助您构建更强大、更灵活的Blazor应用。</p>
<h2 data-id="heading-0">1. 渲染片段（RenderFragment）</h2>
<h3 data-id="heading-1">1.1 基本概念</h3>
<p>RenderFragment是Blazor中用于动态渲染UI内容的核心概念，它允许组件接收并渲染来自父组件的标记内容。</p>
<h3 data-id="heading-2">1.2 基础用法</h3>
<pre><code class="hljs language-csharp" lang="csharp">&lt;!-- ChildComponent.razor --&gt;
&lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"card"</span>&gt;
    &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"card-header"</span>&gt;
        @Title
    &lt;/div&gt;
    &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"card-body"</span>&gt;
        @ChildContent
    &lt;/div&gt;
    &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"card-footer"</span>&gt;
        @FooterContent
    &lt;/div&gt;
&lt;/div&gt;
@code {
    [<span class="hljs-meta">Parameter</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Title { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-string">"Default Title"</span>;

    [<span class="hljs-meta">Parameter</span>]
    <span class="hljs-keyword">public</span> RenderFragment? ChildContent { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    [<span class="hljs-meta">Parameter</span>]
    <span class="hljs-keyword">public</span> RenderFragment? FooterContent { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
}
</code></pre>

<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ParentComponent.razor --&gt;</span>
@page "/advanced/component"
<span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> <span class="hljs-attr">Title</span>=<span class="hljs-string">"高级组件示例"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ChildContent</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是主体内容区域<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-primary"</span>&gt;</span>点击我<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ChildContent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">FooterContent</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">small</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-muted"</span>&gt;</span>这是底部内容<span class="hljs-tag">&lt;/<span class="hljs-name">small</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">FooterContent</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ChildComponent</span>&gt;</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea0fdfaae5da4e50ad8d7a0c7369142f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5Yac5Yia5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763350960&amp;x-signature=J3a2BiscXEPyQAWy5tIanFxKXOo%3D" alt="ASP.NET Core Blazor进阶1：高级组件开发" loading="lazy"/></p>
<h3 data-id="heading-3">1.3 带参数的RenderFragment</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">&lt;!-- DataListComponent.razor --&gt;
&lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"data-list"</span>&gt;
    &lt;h3&gt;<span class="hljs-meta">@Title</span>&lt;/h3&gt;
    <span class="hljs-meta">@foreach</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> Items)
    {
        <span class="hljs-meta">@ItemTemplate(item)</span>
    }
&lt;/div&gt;
<span class="hljs-meta">@code</span> {
    [Parameter]
    <span class="hljs-keyword">public</span> string Title { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-string">"数据列表"</span>;

    [Parameter]
    <span class="hljs-keyword">public</span> IEnumerable&lt;<span class="hljs-keyword">object</span>&gt;? Items { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    [Parameter]
    <span class="hljs-keyword">public</span> RenderFragment&lt;<span class="hljs-keyword">object</span>&gt;? ItemTemplate { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
}
</code></pre>

<pre><code class="hljs language-csharp" lang="csharp">&lt;!-- Usage.razor --&gt;
@page <span class="hljs-string">"/advanced/component/datalist"</span>
@using System.ComponentModel.DataAnnotations

&lt;DataListComponent Title=<span class="hljs-string">"用户列表"</span>
                   Items=<span class="hljs-string">"users"</span>&gt;
    &lt;ItemTemplate&gt;
        &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"user-item"</span>&gt;
            &lt;span&gt;@((context <span class="hljs-keyword">as</span> User)?.Id)&lt;/span&gt;
            &lt;strong&gt;@((context <span class="hljs-keyword">as</span> User)?.Name)&lt;/strong&gt;
            &lt;span&gt;@((context <span class="hljs-keyword">as</span> User)?.Email)&lt;/span&gt;
        &lt;/div&gt;
    &lt;/ItemTemplate&gt;
&lt;/DataListComponent&gt;
@code {
    <span class="hljs-keyword">private</span> List&lt;User&gt; users = <span class="hljs-keyword">new</span>();

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnInitialized</span>()</span>
    {
        users = <span class="hljs-keyword">new</span> List&lt;User&gt;
        {
            <span class="hljs-keyword">new</span> User { Id = <span class="hljs-number">1</span>, Name = <span class="hljs-string">"张三"</span>, Email = <span class="hljs-string">"zhangsan@email.com"</span> },
            <span class="hljs-keyword">new</span> User { Id = <span class="hljs-number">2</span>, Name = <span class="hljs-string">"李四"</span>, Email = <span class="hljs-string">"lisi@email.com"</span> },
            <span class="hljs-keyword">new</span> User { Id = <span class="hljs-number">3</span>, Name = <span class="hljs-string">"王五"</span>, Email = <span class="hljs-string">"wangwu@email.com"</span> }
        };
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">User</span>
    {
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Id { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

        [<span class="hljs-meta">Required</span>]
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Name { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-built_in">string</span>.Empty;

        [<span class="hljs-meta">EmailAddress</span>]
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Email { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-built_in">string</span>.Empty;
    }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b4fb142f51f46e0a97729d9d4f8c863~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5Yac5Yia5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763350960&amp;x-signature=i8QGQQ%2F%2BgTZ9lXExtQseRnP%2BEM0%3D" alt="ASP.NET Core Blazor进阶1：高级组件开发" loading="lazy"/></p>
<h2 data-id="heading-4">2. 动态组件</h2>
<h3 data-id="heading-5">2.1 使用RenderTreeBuilder动态构建组件</h3>
<pre><code class="hljs language-csharp" lang="csharp">&lt;!-- DynamicRenderer.razor --&gt;
@using Microsoft.AspNetCore.Components.Rendering

&lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"dynamic-container"</span>&gt;
    @foreach (<span class="hljs-keyword">var</span> componentType <span class="hljs-keyword">in</span> ComponentTypes)
    {
        &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"dynamic-component"</span>&gt;
            @{
                <span class="hljs-keyword">var</span> index = ComponentTypes.IndexOf(componentType);
                BuildComponent(index);
            }
        &lt;/div&gt;
    }
&lt;/div&gt;
@code {
    [<span class="hljs-meta">Parameter</span>]
    <span class="hljs-keyword">public</span> List&lt;Type&gt; ComponentTypes { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">new</span>();

    [<span class="hljs-meta">Parameter</span>]
    <span class="hljs-keyword">public</span> Dictionary&lt;Type, Dictionary&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">object</span>&gt;&gt; ComponentParameters { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">new</span>();

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">BuildComponent</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> sequence</span>)</span>
    {
        <span class="hljs-keyword">var</span> componentType = ComponentTypes[sequence];
        <span class="hljs-keyword">var</span> parameters = ComponentParameters.ContainsKey(componentType) 
            ? ComponentParameters[componentType] 
            : <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">object</span>&gt;();
    }

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">BuildRenderTree</span>(<span class="hljs-params">RenderTreeBuilder builder</span>)</span>
    {
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; ComponentTypes.Count; i++)
        {
            builder.OpenElement(i * <span class="hljs-number">2</span>, <span class="hljs-string">"div"</span>);
            builder.AddAttribute(i * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>, <span class="hljs-string">"class"</span>, <span class="hljs-string">"dynamic-component"</span>);
            
            builder.OpenComponent(i * <span class="hljs-number">2</span> + <span class="hljs-number">2</span>, ComponentTypes[i]);
            
            <span class="hljs-keyword">if</span> (ComponentParameters.ContainsKey(ComponentTypes[i]))
            {
                <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> param <span class="hljs-keyword">in</span> ComponentParameters[ComponentTypes[i]])
                {
                    builder.AddAttribute(i * <span class="hljs-number">2</span> + <span class="hljs-number">3</span>, param.Key, param.Value);
                }
            }
            
            builder.CloseComponent();
            builder.CloseElement();
        }
    }
}
</code></pre>
<h3 data-id="heading-6">2.2 动态组件容器</h3>
<pre><code class="hljs language-ini" lang="ini">&lt;!-- DynamicComponentContainer.razor --&gt;
@using Microsoft.AspNetCore.Components

&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"dynamic-container"</span>&gt;
    @if (CurrentComponentType != null)
    {
        &lt;DynamicComponent <span class="hljs-attr">Type</span>=<span class="hljs-string">"CurrentComponentType"</span> Parameters=<span class="hljs-string">"CurrentParameters"</span> /&gt;
    }
    else
    {
        &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"placeholder"</span>&gt;
            &lt;p&gt;请选择要显示的组件&lt;/p&gt;
        &lt;/div&gt;
    }
&lt;/div&gt;
&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"component-selector"</span>&gt;
    &lt;button <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-outline-primary"</span> @<span class="hljs-literal">on</span>click=<span class="hljs-string">"() =&gt; ShowComponent(typeof(Counter))"</span>&gt;
        显示计数器
    &lt;/button&gt;
    &lt;button <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-outline-primary"</span> @<span class="hljs-literal">on</span>click=<span class="hljs-string">"() =&gt; ShowComponent(typeof(FetchData))"</span>&gt;
        显示数据获取
    &lt;/button&gt;
    &lt;button <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-outline-primary"</span> @<span class="hljs-literal">on</span>click=<span class="hljs-string">"() =&gt; ShowComponent(typeof(TodoList))"</span>&gt;
        显示待办事项
    &lt;/button&gt;
&lt;/div&gt;
@code {
    private Type? CurrentComponentType { get<span class="hljs-comment">; set; }</span>
    private Dictionary&lt;string, object&gt; CurrentParameters { get<span class="hljs-comment">; set; } = new();</span>

    private void ShowComponent(Type componentType)
    {
        <span class="hljs-attr">CurrentComponentType</span> = componentType<span class="hljs-comment">;</span>
        <span class="hljs-attr">CurrentParameters</span> = GetParametersForComponent(componentType)<span class="hljs-comment">;</span>
        StateHasChanged()<span class="hljs-comment">;</span>
    }

    private Dictionary&lt;string, object&gt; GetParametersForComponent(Type componentType)
    {
        var <span class="hljs-attr">parameters</span> = new Dictionary&lt;string, object&gt;()<span class="hljs-comment">;</span>

        if (<span class="hljs-attr">componentType</span> == typeof(Counter))
        {
            parameters<span class="hljs-section">["IncrementAmount"]</span> = 5<span class="hljs-comment">;</span>
        }
        else if (<span class="hljs-attr">componentType</span> == typeof(TodoList))
        {
            parameters<span class="hljs-section">["Title"]</span> = "动态待办事项"<span class="hljs-comment">;</span>
        }

        return parameters<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h3 data-id="heading-7">2.3 自定义动态组件选择器</h3>
<pre><code class="hljs language-csharp" lang="csharp">&lt;!-- SmartComponentRenderer.razor --&gt;
@using Microsoft.AspNetCore.Components

&lt;DynamicComponent 
    Type=<span class="hljs-string">"ResolveComponentType()"</span> 
    Parameters=<span class="hljs-string">"ResolveParameters()"</span> /&gt;

@code {
    [<span class="hljs-meta">Parameter</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> ComponentName { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-built_in">string</span>.Empty;

    [<span class="hljs-meta">Parameter</span>]
    <span class="hljs-keyword">public</span> Dictionary&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">object</span>&gt;? InputParameters { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    [<span class="hljs-meta">Parameter</span>]
    <span class="hljs-keyword">public</span> EventCallback&lt;Dictionary&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">object</span>&gt;&gt; OnParametersResolved { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    <span class="hljs-function"><span class="hljs-keyword">private</span> Type <span class="hljs-title">ResolveComponentType</span>()</span>
    {
        <span class="hljs-keyword">return</span> ComponentName <span class="hljs-keyword">switch</span>
        {
            <span class="hljs-string">"Counter"</span> =&gt; <span class="hljs-keyword">typeof</span>(Counter),
            <span class="hljs-string">"TodoList"</span> =&gt; <span class="hljs-keyword">typeof</span>(TodoList),
            <span class="hljs-string">"FetchData"</span> =&gt; <span class="hljs-keyword">typeof</span>(FetchData),
            <span class="hljs-string">"Weather"</span> =&gt; <span class="hljs-keyword">typeof</span>(FetchData), <span class="hljs-comment">// 别名</span>
            _ =&gt; <span class="hljs-keyword">typeof</span>(NotFoundComponent)
        };
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> Dictionary&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">object</span>&gt; <span class="hljs-title">ResolveParameters</span>()</span>
    {
        <span class="hljs-keyword">var</span> parameters = InputParameters ?? <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">object</span>&gt;();

        <span class="hljs-comment">// 添加默认参数</span>
        <span class="hljs-keyword">if</span> (ComponentName == <span class="hljs-string">"Counter"</span> &amp;&amp; !parameters.ContainsKey(<span class="hljs-string">"IncrementAmount"</span>))
        {
            parameters[<span class="hljs-string">"IncrementAmount"</span>] = <span class="hljs-number">1</span>;
        }

        <span class="hljs-comment">// 通知参数解析完成</span>
        OnParametersResolved.InvokeAsync(parameters);

        <span class="hljs-keyword">return</span> parameters;
    }
}
</code></pre>
<h2 data-id="heading-8">3. 错误边界</h2>
<h3 data-id="heading-9">3.1 基础错误边界组件</h3>
<pre><code class="hljs language-ini" lang="ini">&lt;!-- ErrorBoundary.razor --&gt;
@using Microsoft.AspNetCore.Components

&lt;CascadingValue <span class="hljs-attr">Value</span>=<span class="hljs-string">"this"</span>&gt;
    @if (!hasError)
    {
        @ChildContent
    }
    else if (ErrorContent != null)
    {
        @ErrorContent
    }
    else
    {
        &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"alert alert-danger"</span> role=<span class="hljs-string">"alert"</span>&gt;
            &lt;h4&gt;出现了错误&lt;/h4&gt;
            &lt;p&gt;@currentException?.Message&lt;/p&gt;
            &lt;button <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-outline-danger btn-sm"</span> @<span class="hljs-literal">on</span>click=<span class="hljs-string">"Recover"</span>&gt;
                重试
            &lt;/button&gt;
        &lt;/div&gt;
    }
&lt;/CascadingValue&gt;
@code {
    <span class="hljs-section">[Parameter]</span>
    public RenderFragment? ChildContent { get<span class="hljs-comment">; set; }</span>

    <span class="hljs-section">[Parameter]</span>
    public RenderFragment&lt;Exception&gt;? ErrorContent { get<span class="hljs-comment">; set; }</span>

    <span class="hljs-section">[Parameter]</span>
    public bool RecoverOnRender { get<span class="hljs-comment">; set; } = true;</span>

    private bool hasError<span class="hljs-comment">;</span>
    private Exception? currentException<span class="hljs-comment">;</span>

    public void Recover()
    {
        <span class="hljs-attr">hasError</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
        <span class="hljs-attr">currentException</span> = null<span class="hljs-comment">;</span>
        StateHasChanged()<span class="hljs-comment">;</span>
    }

    protected override void OnParametersSet()
    {
        if (RecoverOnRender)
        {
            <span class="hljs-attr">hasError</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
            <span class="hljs-attr">currentException</span> = null<span class="hljs-comment">;</span>
        }
    }

    public async Task CatchAsync(Func&lt;Task&gt; action)
    {
        try
        {
            await action()<span class="hljs-comment">;</span>
            <span class="hljs-attr">hasError</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
            <span class="hljs-attr">currentException</span> = null<span class="hljs-comment">;</span>
        }
        catch (Exception ex)
        {
            <span class="hljs-attr">hasError</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
            <span class="hljs-attr">currentException</span> = ex<span class="hljs-comment">;</span>
            StateHasChanged()<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-10">3.2 增强型错误边界</h3>
<pre><code class="hljs language-ini" lang="ini">&lt;!-- EnhancedErrorBoundary.razor --&gt;
@using Microsoft.AspNetCore.Components
@inject ILogger&lt;EnhancedErrorBoundary&gt; Logger

&lt;CascadingValue <span class="hljs-attr">Value</span>=<span class="hljs-string">"this"</span>&gt;
    @if (<span class="hljs-attr">currentState</span> == ErrorState.Normal)
    {
        @ChildContent
    }
    else
    {
        &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"@GetErrorContainerClass()"</span>&gt;
            &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"error-header"</span>&gt;
                &lt;i <span class="hljs-attr">class</span>=<span class="hljs-string">"@GetErrorIcon()"</span>&gt;&lt;/i&gt;
                &lt;h4&gt;@GetErrorMessage()&lt;/h4&gt;
            &lt;/div&gt;
            
            @if (ShowExceptionDetails)
            {
                &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"error-details"</span>&gt;
                    &lt;p&gt;&lt;strong&gt;错误类型:&lt;/strong&gt; @currentException?.GetType().Name&lt;/p&gt;
                    &lt;p&gt;&lt;strong&gt;错误信息:&lt;/strong&gt; @currentException?.Message&lt;/p&gt;
                    
                    @if (ShowStackTrace)
                    {
                        &lt;details&gt;
                            &lt;summary&gt;堆栈跟踪&lt;/summary&gt;
                            &lt;pre&gt;@currentException?.StackTrace&lt;/pre&gt;
                        &lt;/details&gt;
                    }
                &lt;/div&gt;
            }
            
            &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"error-actions"</span>&gt;
                &lt;button <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-primary"</span> @<span class="hljs-literal">on</span>click=<span class="hljs-string">"Recover"</span>&gt;
                    &lt;i <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-redo"</span>&gt;&lt;/i&gt; 重试
                &lt;/button&gt;
                
                @if (ShowReportButton)
                {
                    &lt;button <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-outline-secondary"</span> @<span class="hljs-literal">on</span>click=<span class="hljs-string">"ReportError"</span>&gt;
                        &lt;i <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-bug"</span>&gt;&lt;/i&gt; 报告错误
                    &lt;/button&gt;
                }
                
                &lt;button <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-outline-info"</span> @<span class="hljs-literal">on</span>click=<span class="hljs-string">"ToggleDetails"</span>&gt;
                    &lt;i <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-info-circle"</span>&gt;&lt;/i&gt; 
                    @(ShowExceptionDetails ? "隐藏" : "显示")详情
                &lt;/button&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    }
&lt;/CascadingValue&gt;
@code {
    <span class="hljs-section">[Parameter]</span>
    public RenderFragment? ChildContent { get<span class="hljs-comment">; set; }</span>

    <span class="hljs-section">[Parameter]</span>
    public bool ShowExceptionDetails { get<span class="hljs-comment">; set; } = false;</span>

    <span class="hljs-section">[Parameter]</span>
    public bool ShowStackTrace { get<span class="hljs-comment">; set; } = false;</span>

    <span class="hljs-section">[Parameter]</span>
    public bool ShowReportButton { get<span class="hljs-comment">; set; } = true;</span>

    <span class="hljs-section">[Parameter]</span>
    public EventCallback&lt;Exception&gt; OnError { get<span class="hljs-comment">; set; }</span>

    private ErrorState <span class="hljs-attr">currentState</span> = ErrorState.Normal<span class="hljs-comment">;</span>
    private Exception? currentException<span class="hljs-comment">;</span>
    private bool <span class="hljs-attr">ShowExceptionDetailsLocal</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>

    protected override async Task OnErrorAsync(Exception exception)
    {
        <span class="hljs-attr">currentState</span> = ErrorState.Error<span class="hljs-comment">;</span>
        <span class="hljs-attr">currentException</span> = exception<span class="hljs-comment">;</span>
        
        Logger.LogError(exception, "组件渲染时发生错误")<span class="hljs-comment">;</span>
        
        await OnError.InvokeAsync(exception)<span class="hljs-comment">;</span>
        await base.OnErrorAsync(exception)<span class="hljs-comment">;</span>
    }

    private void Recover()
    {
        <span class="hljs-attr">currentState</span> = ErrorState.Normal<span class="hljs-comment">;</span>
        <span class="hljs-attr">currentException</span> = null<span class="hljs-comment">;</span>
        <span class="hljs-attr">ShowExceptionDetailsLocal</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
        StateHasChanged()<span class="hljs-comment">;</span>
    }

    private void ReportError()
    {
        // 这里可以实现错误报告逻辑
        Logger.LogError("用户报告错误: {Exception}", currentException)<span class="hljs-comment">;</span>
        // 可以发送到错误监控服务
    }

    private void ToggleDetails()
    {
        <span class="hljs-attr">ShowExceptionDetailsLocal</span> = !ShowExceptionDetailsLocal<span class="hljs-comment">;</span>
    }

    private string GetErrorContainerClass() =&gt; currentState switch
    {
        <span class="hljs-attr">ErrorState.Error</span> =&gt; <span class="hljs-string">"error-container alert alert-danger"</span>,
        <span class="hljs-attr">ErrorState.Warning</span> =&gt; <span class="hljs-string">"error-container alert alert-warning"</span>,
        <span class="hljs-attr">_</span> =&gt; <span class="hljs-string">"error-container"</span>
    }<span class="hljs-comment">;</span>

    private string GetErrorIcon() =&gt; currentState switch
    {
        <span class="hljs-attr">ErrorState.Error</span> =&gt; <span class="hljs-string">"fas fa-exclamation-triangle"</span>,
        <span class="hljs-attr">ErrorState.Warning</span> =&gt; <span class="hljs-string">"fas fa-exclamation-circle"</span>,
        <span class="hljs-attr">_</span> =&gt; <span class="hljs-string">"fas fa-info-circle"</span>
    }<span class="hljs-comment">;</span>

    private string GetErrorMessage() =&gt; currentState switch
    {
        <span class="hljs-attr">ErrorState.Error</span> =&gt; <span class="hljs-string">"发生了意外错误"</span>,
        <span class="hljs-attr">ErrorState.Warning</span> =&gt; <span class="hljs-string">"操作未完全成功"</span>,
        <span class="hljs-attr">_</span> =&gt; <span class="hljs-string">"未知状态"</span>
    }<span class="hljs-comment">;</span>

    private enum ErrorState
    {
        Normal,
        Warning,
        Error
    }
}
</code></pre>
<h3 data-id="heading-11">3.3 错误边界使用示例</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ErrorBoundaryUsage.razor --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container mt-4"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>错误边界使用示例<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">EnhancedErrorBoundary</span> 
        <span class="hljs-attr">ShowExceptionDetails</span>=<span class="hljs-string">"true"</span>
        <span class="hljs-attr">OnError</span>=<span class="hljs-string">"OnErrorOccurred"</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"component-section"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>安全组件区域<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            
            <span class="hljs-tag">&lt;<span class="hljs-name">UnstableComponent</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">AnotherUnstableComponent</span> /&gt;</span>
            
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"safe-zone"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这个区域受到错误边界保护<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-success"</span> @<span class="hljs-attr">onclick</span>=<span class="hljs-string">"SafeOperation"</span>&gt;</span>
                    安全操作
                <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        
    <span class="hljs-tag">&lt;/<span class="hljs-name">EnhancedErrorBoundary</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"external-content"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>外部内容（不受错误边界保护）<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这个区域的内容不会受到内部组件错误的影响<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
@code {
    private void OnErrorOccurred(Exception ex)
    {
        // 处理错误，可以发送到监控系统
        Console.WriteLine($"捕获到错误: {ex.Message}");
    }
    
    private void SafeOperation()
    {
        // 安全操作不会抛出异常
    }
}
</code></pre>
<h2 data-id="heading-12">4. 虚拟化组件</h2>
<h3 data-id="heading-13">4.1 基础虚拟化列表</h3>
<pre><code class="hljs language-csharp" lang="csharp">&lt;!-- VirtualizedList.razor --&gt;
@using Microsoft.AspNetCore.Components.Web.Virtualization

&lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"virtualized-list"</span> style=<span class="hljs-string">"height: 400px; overflow: auto;"</span>&gt;
    &lt;Virtualize Items=<span class="hljs-string">"Items"</span> Context=<span class="hljs-string">"item"</span> OverscanCount=<span class="hljs-string">"10"</span>&gt;
        &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"list-item"</span>&gt;
            &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"item-content"</span>&gt;
                &lt;h5&gt;@item.Name&lt;/h5&gt;
                &lt;p&gt;@item.Description&lt;/p&gt;
                &lt;small <span class="hljs-keyword">class</span>=<span class="hljs-string">"text-muted"</span>&gt;ID: @item.Id&lt;/small&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/Virtualize&gt;
&lt;/div&gt;
@code {
    [<span class="hljs-meta">Parameter</span>]
    <span class="hljs-keyword">public</span> List&lt;DataItem&gt; Items { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">new</span>();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DataItem</span>
    {
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Id { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Name { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-built_in">string</span>.Empty;
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Description { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-built_in">string</span>.Empty;
        <span class="hljs-keyword">public</span> DateTime CreatedAt { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    }
}
</code></pre>
<h3 data-id="heading-14">4.2 异步数据虚拟化</h3>
<pre><code class="hljs language-typescript" lang="typescript">&lt;!-- <span class="hljs-title class_">AsyncVirtualizedList</span>.<span class="hljs-property">razor</span> --&gt;
<span class="hljs-meta">@using</span> <span class="hljs-title class_">Microsoft</span>.<span class="hljs-property">AspNetCore</span>.<span class="hljs-property">Components</span>.<span class="hljs-property">Web</span>.<span class="hljs-property">Virtualization</span>

&lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"virtualized-container"</span>&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"virtualized-header"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>@Title<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stats"</span>&gt;</span>
            显示 <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>@visibleItemCount<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span> 个项目
            (总共 <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>@totalSize<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span> 个)
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"virtualized-list"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"height: 500px;"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Virtualize</span> <span class="hljs-attr">ItemsProvider</span>=<span class="hljs-string">"LoadItems"</span> <span class="hljs-attr">Context</span>=<span class="hljs-string">"item"</span> 
                   <span class="hljs-attr">OverscanCount</span>=<span class="hljs-string">"5"</span> @<span class="hljs-attr">ref</span>=<span class="hljs-string">"virtualizeRef"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"virtual-item @(item.IsSpecial ? "</span><span class="hljs-attr">special</span>" <span class="hljs-attr">:</span> "")"&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item-index"</span>&gt;</span>#@item.Index<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item-content"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h6</span>&gt;</span>@item.Name<span class="hljs-tag">&lt;/<span class="hljs-name">h6</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>@item.Description<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item-meta"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"badge bg-secondary"</span>&gt;</span>@item.Category<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">small</span>&gt;</span>@item.CreatedAt.ToString("yyyy-MM-dd HH:mm")<span class="hljs-tag">&lt;/<span class="hljs-name">small</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item-actions"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-sm btn-outline-primary"</span> 
                            @<span class="hljs-attr">onclick</span>=<span class="hljs-string">"() =&gt; OnItemClick(item)"</span>&gt;</span>
                        查看
                    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            
            <span class="hljs-tag">&lt;<span class="hljs-name">Placeholder</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"virtual-item loading"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item-content"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"skeleton-line"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"skeleton-line short"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Placeholder</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Virtualize</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"virtualized-footer"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-outline-secondary"</span> @<span class="hljs-attr">onclick</span>=<span class="hljs-string">"RefreshData"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-sync"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> 刷新
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"loading-indicator"</span>&gt;</span>
            @if (isLoading)
            {
                <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-spinner fa-spin"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            }
        <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/div&gt;
<span class="hljs-meta">@code</span> {
    [<span class="hljs-title class_">Parameter</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title class_">Title</span> { get; set; } = <span class="hljs-string">"虚拟化列表"</span>;

    [<span class="hljs-title class_">Parameter</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">EventCallback</span>&lt;<span class="hljs-title class_">VirtualItem</span>&gt; <span class="hljs-title class_">OnItemClick</span> { get; set; }

    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Virtualize</span>&lt;<span class="hljs-title class_">VirtualItem</span>&gt;? virtualizeRef;
    <span class="hljs-keyword">private</span> int totalSize = <span class="hljs-number">1000</span>;
    <span class="hljs-keyword">private</span> int visibleItemCount;
    <span class="hljs-keyword">private</span> bool isLoading;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title class_">ValueTask</span>&lt;<span class="hljs-title class_">ItemsProviderResult</span>&lt;<span class="hljs-title class_">VirtualItem</span>&gt;&gt; <span class="hljs-title class_">LoadItems</span>(
        <span class="hljs-title class_">ItemsProviderRequest</span> request)
    {
        isLoading = <span class="hljs-literal">true</span>;
        <span class="hljs-title class_">StateHasChanged</span>();

        <span class="hljs-keyword">try</span>
        {
            <span class="hljs-comment">// 模拟网络延迟</span>
            <span class="hljs-keyword">await</span> <span class="hljs-title class_">Task</span>.<span class="hljs-title class_">Delay</span>(<span class="hljs-number">100</span>);

            <span class="hljs-keyword">var</span> totalItems = <span class="hljs-keyword">await</span> <span class="hljs-title class_">GetTotalItemCountAsync</span>();
            <span class="hljs-keyword">var</span> items = <span class="hljs-keyword">await</span> <span class="hljs-title class_">GetItemsAsync</span>(request.<span class="hljs-property">StartIndex</span>, request.<span class="hljs-property">Count</span>);

            visibleItemCount = items.<span class="hljs-property">Count</span>;

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ItemsProviderResult</span>&lt;<span class="hljs-title class_">VirtualItem</span>&gt;(items, totalItems);
        }
        <span class="hljs-keyword">finally</span>
        {
            isLoading = <span class="hljs-literal">false</span>;
            <span class="hljs-title class_">StateHasChanged</span>();
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title class_">Task</span>&lt;int&gt; <span class="hljs-title class_">GetTotalItemCountAsync</span>()
    {
        <span class="hljs-comment">// 模拟从API获取总数</span>
        <span class="hljs-keyword">await</span> <span class="hljs-title class_">Task</span>.<span class="hljs-title class_">Delay</span>(<span class="hljs-number">50</span>);
        <span class="hljs-keyword">return</span> totalSize;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title class_">Task</span>&lt;<span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">VirtualItem</span>&gt;&gt; <span class="hljs-title class_">GetItemsAsync</span>(int startIndex, int count)
    {
        <span class="hljs-comment">// 模拟从API获取数据</span>
        <span class="hljs-keyword">await</span> <span class="hljs-title class_">Task</span>.<span class="hljs-title class_">Delay</span>(<span class="hljs-number">100</span>);

        <span class="hljs-keyword">var</span> items = <span class="hljs-keyword">new</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">VirtualItem</span>&gt;();
        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; count &amp;&amp; startIndex + i &lt; totalSize; i++)
        {
            <span class="hljs-keyword">var</span> index = startIndex + i;
            items.<span class="hljs-title class_">Add</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">VirtualItem</span>
            {
                <span class="hljs-title class_">Index</span> = index,
                <span class="hljs-title class_">Id</span> = <span class="hljs-title class_">Guid</span>.<span class="hljs-title class_">NewGuid</span>(),
                <span class="hljs-title class_">Name</span> = $<span class="hljs-string">"项目 {index + 1}"</span>,
                <span class="hljs-title class_">Description</span> = $<span class="hljs-string">"这是第 {index + 1} 个项目的描述信息"</span>,
                <span class="hljs-title class_">Category</span> = <span class="hljs-title class_">GetCategory</span>(index),
                <span class="hljs-title class_">CreatedAt</span> = <span class="hljs-title class_">DateTime</span>.<span class="hljs-property">Now</span>.<span class="hljs-title class_">AddMinutes</span>(-index),
                <span class="hljs-title class_">IsSpecial</span> = index % <span class="hljs-number">7</span> == <span class="hljs-number">0</span>
            });
        }

        <span class="hljs-keyword">return</span> items;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span> <span class="hljs-title class_">GetCategory</span>(int index)
    {
        <span class="hljs-keyword">var</span> categories = <span class="hljs-keyword">new</span>[] { <span class="hljs-string">"技术"</span>, <span class="hljs-string">"商业"</span>, <span class="hljs-string">"艺术"</span>, <span class="hljs-string">"科学"</span>, <span class="hljs-string">"体育"</span> };
        <span class="hljs-keyword">return</span> categories[index % categories.<span class="hljs-property">Length</span>];
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-built_in">void</span> <span class="hljs-title class_">RefreshData</span>()
    {
        <span class="hljs-comment">// 刷新虚拟化组件</span>
        <span class="hljs-keyword">if</span> (virtualizeRef != <span class="hljs-literal">null</span>)
        {
            <span class="hljs-keyword">await</span> virtualizeRef.<span class="hljs-title class_">RefreshDataAsync</span>();
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualItem</span>
    {
        <span class="hljs-keyword">public</span> int <span class="hljs-title class_">Index</span> { get; set; }
        <span class="hljs-keyword">public</span> <span class="hljs-title class_">Guid</span> <span class="hljs-title class_">Id</span> { get; set; }
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title class_">Name</span> { get; set; } = <span class="hljs-built_in">string</span>.<span class="hljs-property">Empty</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title class_">Description</span> { get; set; } = <span class="hljs-built_in">string</span>.<span class="hljs-property">Empty</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title class_">Category</span> { get; set; } = <span class="hljs-built_in">string</span>.<span class="hljs-property">Empty</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-title class_">DateTime</span> <span class="hljs-title class_">CreatedAt</span> { get; set; }
        <span class="hljs-keyword">public</span> bool <span class="hljs-title class_">IsSpecial</span> { get; set; }
    }
}
</code></pre>
<h3 data-id="heading-15">4.3 自定义虚拟化网格</h3>
<pre><code class="hljs language-typescript" lang="typescript">&lt;!-- <span class="hljs-title class_">VirtualizedGrid</span>.<span class="hljs-property">razor</span> --&gt;
<span class="hljs-meta">@using</span> <span class="hljs-title class_">Microsoft</span>.<span class="hljs-property">AspNetCore</span>.<span class="hljs-property">Components</span>.<span class="hljs-property">Web</span>.<span class="hljs-property">Virtualization</span>

&lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"virtualized-grid-container"</span>&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"grid-header"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>@Title<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"grid-controls"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>
                列数:
                <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"number"</span> @<span class="hljs-attr">bind</span>=<span class="hljs-string">"columns"</span> @<span class="hljs-attr">bind:event</span>=<span class="hljs-string">"oninput"</span> 
                       <span class="hljs-attr">min</span>=<span class="hljs-string">"1"</span> <span class="hljs-attr">max</span>=<span class="hljs-string">"6"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-control form-control-sm"</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>
                项目高度:
                <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"number"</span> @<span class="hljs-attr">bind</span>=<span class="hljs-string">"itemHeight"</span> @<span class="hljs-attr">bind:event</span>=<span class="hljs-string">"oninput"</span> 
                       <span class="hljs-attr">min</span>=<span class="hljs-string">"50"</span> <span class="hljs-attr">max</span>=<span class="hljs-string">"300"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-control form-control-sm"</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"virtualized-grid"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"height: 600px;"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Virtualize</span> <span class="hljs-attr">ItemsProvider</span>=<span class="hljs-string">"LoadGridItems"</span> <span class="hljs-attr">Context</span>=<span class="hljs-string">"item"</span> 
                   <span class="hljs-attr">OverscanCount</span>=<span class="hljs-string">"8"</span> @<span class="hljs-attr">ref</span>=<span class="hljs-string">"virtualizeRef"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"grid-item"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"height: @(itemHeight)px;"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"grid-item-content @(item.IsFeatured ? "</span><span class="hljs-attr">featured</span>" <span class="hljs-attr">:</span> "")"&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item-header"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item-badge"</span>&gt;</span>#@item.Index<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item-category"</span>&gt;</span>@item.Category<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h6</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item-title"</span>&gt;</span>@item.Title<span class="hljs-tag">&lt;/<span class="hljs-name">h6</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item-description"</span>&gt;</span>@item.Description<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item-stats"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stat"</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-eye"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> @item.Views
                        <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stat"</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-heart"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span> @item.Likes
                        <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item-footer"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">small</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-muted"</span>&gt;</span>
                            @item.CreatedAt.ToString("MM/dd/yyyy")
                        <span class="hljs-tag">&lt;/<span class="hljs-name">small</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-sm btn-outline-primary"</span> 
                                @<span class="hljs-attr">onclick</span>=<span class="hljs-string">"() =&gt; OnItemAction(item)"</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fas fa-ellipsis-h"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Virtualize</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/div&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-class">.virtualized-grid-container</span> {
        <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
    }

    <span class="hljs-selector-class">.grid-header</span> {
        <span class="hljs-attribute">display</span>: flex;
        <span class="hljs-attribute">justify-content</span>: space-between;
        <span class="hljs-attribute">align-items</span>: center;
        <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">1rem</span>;
    }

    <span class="hljs-selector-class">.grid-controls</span> {
        <span class="hljs-attribute">display</span>: flex;
        <span class="hljs-attribute">gap</span>: <span class="hljs-number">1rem</span>;
        <span class="hljs-attribute">align-items</span>: center;
    }

    <span class="hljs-selector-class">.grid-controls</span> <span class="hljs-selector-tag">label</span> {
        <span class="hljs-attribute">display</span>: flex;
        <span class="hljs-attribute">align-items</span>: center;
        <span class="hljs-attribute">gap</span>: <span class="hljs-number">0.5rem</span>;
        <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
    }

    <span class="hljs-selector-class">.virtualized-grid</span> {
        <span class="hljs-attribute">display</span>: grid;
        <span class="hljs-attribute">gap</span>: <span class="hljs-number">1rem</span>;
        <span class="hljs-attribute">padding</span>: <span class="hljs-number">0.5rem</span>;
    }

    <span class="hljs-selector-class">.grid-item</span> {
        <span class="hljs-attribute">break-inside</span>: avoid;
    }

    <span class="hljs-selector-class">.grid-item-content</span> {
        <span class="hljs-attribute">background</span>: white;
        <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#dee2e6</span>;
        <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">0.375rem</span>;
        <span class="hljs-attribute">padding</span>: <span class="hljs-number">1rem</span>;
        <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
        <span class="hljs-attribute">display</span>: flex;
        <span class="hljs-attribute">flex-direction</span>: column;
        <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.2s</span> ease;
    }

    <span class="hljs-selector-class">.grid-item-content</span><span class="hljs-selector-pseudo">:hover</span> {
        <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0.5rem</span> <span class="hljs-number">1rem</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.15</span>);
        <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">2px</span>);
    }

    <span class="hljs-selector-class">.grid-item-content</span><span class="hljs-selector-class">.featured</span> {
        <span class="hljs-attribute">border-left</span>: <span class="hljs-number">4px</span> solid <span class="hljs-number">#007bff</span>;
        <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-number">#f8f9fa</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#e9ecef</span> <span class="hljs-number">100%</span>);
    }

    <span class="hljs-selector-class">.item-header</span> {
        <span class="hljs-attribute">display</span>: flex;
        <span class="hljs-attribute">justify-content</span>: space-between;
        <span class="hljs-attribute">align-items</span>: center;
        <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">0.5rem</span>;
    }

    <span class="hljs-selector-class">.item-badge</span> {
        <span class="hljs-attribute">background</span>: <span class="hljs-number">#6c757d</span>;
        <span class="hljs-attribute">color</span>: white;
        <span class="hljs-attribute">padding</span>: <span class="hljs-number">0.25rem</span> <span class="hljs-number">0.5rem</span>;
        <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">0.25rem</span>;
        <span class="hljs-attribute">font-size</span>: <span class="hljs-number">0.75rem</span>;
        <span class="hljs-attribute">font-weight</span>: bold;
    }

    <span class="hljs-selector-class">.item-category</span> {
        <span class="hljs-attribute">background</span>: <span class="hljs-number">#e9ecef</span>;
        <span class="hljs-attribute">color</span>: <span class="hljs-number">#495057</span>;
        <span class="hljs-attribute">padding</span>: <span class="hljs-number">0.25rem</span> <span class="hljs-number">0.5rem</span>;
        <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">0.25rem</span>;
        <span class="hljs-attribute">font-size</span>: <span class="hljs-number">0.75rem</span>;
    }

    <span class="hljs-selector-class">.item-title</span> {
        <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">600</span>;
        <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">0.5rem</span>;
        <span class="hljs-attribute">flex-grow</span>: <span class="hljs-number">1</span>;
    }

    <span class="hljs-selector-class">.item-description</span> {
        <span class="hljs-attribute">color</span>: <span class="hljs-number">#6c757d</span>;
        <span class="hljs-attribute">font-size</span>: <span class="hljs-number">0.875rem</span>;
        <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">1rem</span>;
        <span class="hljs-attribute">flex-grow</span>: <span class="hljs-number">2</span>;
        <span class="hljs-attribute">overflow</span>: hidden;
        <span class="hljs-attribute">display</span>: -webkit-box;
        -webkit-line-clamp: <span class="hljs-number">3</span>;
        -webkit-box-orient: vertical;
    }

    <span class="hljs-selector-class">.item-stats</span> {
        <span class="hljs-attribute">display</span>: flex;
        <span class="hljs-attribute">gap</span>: <span class="hljs-number">1rem</span>;
        <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">1rem</span>;
    }

    <span class="hljs-selector-class">.stat</span> {
        <span class="hljs-attribute">font-size</span>: <span class="hljs-number">0.875rem</span>;
        <span class="hljs-attribute">color</span>: <span class="hljs-number">#6c757d</span>;
    }

    <span class="hljs-selector-class">.item-footer</span> {
        <span class="hljs-attribute">display</span>: flex;
        <span class="hljs-attribute">justify-content</span>: space-between;
        <span class="hljs-attribute">align-items</span>: center;
        <span class="hljs-attribute">margin-top</span>: auto;
    }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
<span class="hljs-meta">@code</span> {
    [<span class="hljs-title class_">Parameter</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title class_">Title</span> { get; set; } = <span class="hljs-string">"虚拟化网格"</span>;

    [<span class="hljs-title class_">Parameter</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">EventCallback</span>&lt;<span class="hljs-title class_">GridItem</span>&gt; <span class="hljs-title class_">OnItemAction</span> { get; set; }

    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Virtualize</span>&lt;<span class="hljs-title class_">GridItem</span>&gt;? virtualizeRef;
    <span class="hljs-keyword">private</span> int totalSize = <span class="hljs-number">500</span>;
    <span class="hljs-keyword">private</span> int columns = <span class="hljs-number">3</span>;
    <span class="hljs-keyword">private</span> int itemHeight = <span class="hljs-number">150</span>;

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">void</span> <span class="hljs-title class_">OnParametersSet</span>()
    {
        <span class="hljs-comment">// 当列数改变时更新网格布局</span>
        <span class="hljs-title class_">UpdateGridLayout</span>();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title class_">UpdateGridLayout</span>()
    {
        <span class="hljs-comment">// 动态更新CSS网格模板</span>
        <span class="hljs-keyword">var</span> style = $@<span class="hljs-string">"
            .virtualized-grid {{
                grid-template-columns: repeat({columns}, 1fr);
            }}
        "</span>;
        <span class="hljs-comment">// 在实际应用中，您可能需要使用JavaScript互操作来动态更新样式</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title class_">ValueTask</span>&lt;<span class="hljs-title class_">ItemsProviderResult</span>&lt;<span class="hljs-title class_">GridItem</span>&gt;&gt; <span class="hljs-title class_">LoadGridItems</span>(
        <span class="hljs-title class_">ItemsProviderRequest</span> request)
    {
        <span class="hljs-comment">// 模拟异步数据加载</span>
        <span class="hljs-keyword">await</span> <span class="hljs-title class_">Task</span>.<span class="hljs-title class_">Delay</span>(<span class="hljs-number">150</span>);

        <span class="hljs-keyword">var</span> totalItems = <span class="hljs-keyword">await</span> <span class="hljs-title class_">GetTotalGridItemCountAsync</span>();
        <span class="hljs-keyword">var</span> items = <span class="hljs-keyword">await</span> <span class="hljs-title class_">GetGridItemsAsync</span>(request.<span class="hljs-property">StartIndex</span>, request.<span class="hljs-property">Count</span>);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ItemsProviderResult</span>&lt;<span class="hljs-title class_">GridItem</span>&gt;(items, totalItems);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title class_">Task</span>&lt;int&gt; <span class="hljs-title class_">GetTotalGridItemCountAsync</span>()
    {
        <span class="hljs-keyword">await</span> <span class="hljs-title class_">Task</span>.<span class="hljs-title class_">Delay</span>(<span class="hljs-number">50</span>);
        <span class="hljs-keyword">return</span> totalSize;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title class_">Task</span>&lt;<span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">GridItem</span>&gt;&gt; <span class="hljs-title class_">GetGridItemsAsync</span>(int startIndex, int count)
    {
        <span class="hljs-keyword">await</span> <span class="hljs-title class_">Task</span>.<span class="hljs-title class_">Delay</span>(<span class="hljs-number">100</span>);

        <span class="hljs-keyword">var</span> items = <span class="hljs-keyword">new</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">GridItem</span>&gt;();
        <span class="hljs-keyword">var</span> categories = <span class="hljs-keyword">new</span>[] { <span class="hljs-string">"设计"</span>, <span class="hljs-string">"开发"</span>, <span class="hljs-string">"营销"</span>, <span class="hljs-string">"内容"</span>, <span class="hljs-string">"支持"</span> };

        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; count &amp;&amp; startIndex + i &lt; totalSize; i++)
        {
            <span class="hljs-keyword">var</span> index = startIndex + i;
            <span class="hljs-keyword">var</span> random = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>(index);

            items.<span class="hljs-title class_">Add</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GridItem</span>
            {
                <span class="hljs-title class_">Index</span> = index,
                <span class="hljs-title class_">Id</span> = <span class="hljs-title class_">Guid</span>.<span class="hljs-title class_">NewGuid</span>(),
                <span class="hljs-title class_">Title</span> = $<span class="hljs-string">"网格项目 {index + 1}"</span>,
                <span class="hljs-title class_">Description</span> = <span class="hljs-title class_">GenerateDescription</span>(index),
                <span class="hljs-title class_">Category</span> = categories[random.<span class="hljs-title class_">Next</span>(categories.<span class="hljs-property">Length</span>)],
                <span class="hljs-title class_">Views</span> = random.<span class="hljs-title class_">Next</span>(<span class="hljs-number">1000</span>, <span class="hljs-number">10000</span>),
                <span class="hljs-title class_">Likes</span> = random.<span class="hljs-title class_">Next</span>(<span class="hljs-number">10</span>, <span class="hljs-number">500</span>),
                <span class="hljs-title class_">CreatedAt</span> = <span class="hljs-title class_">DateTime</span>.<span class="hljs-property">Now</span>.<span class="hljs-title class_">AddDays</span>(-random.<span class="hljs-title class_">Next</span>(<span class="hljs-number">365</span>)),
                <span class="hljs-title class_">IsFeatured</span> = index % <span class="hljs-number">11</span> == <span class="hljs-number">0</span>
            });
        }

        <span class="hljs-keyword">return</span> items;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span> <span class="hljs-title class_">GenerateDescription</span>(int index)
    {
        <span class="hljs-keyword">var</span> descriptions = <span class="hljs-keyword">new</span>[]
        {
            <span class="hljs-string">"这是一个非常有趣的项目，展示了最新的技术趋势。"</span>,
            <span class="hljs-string">"创新性的解决方案，解决了长期存在的问题。"</span>,
            <span class="hljs-string">"用户友好的设计，提供了出色的用户体验。"</span>,
            <span class="hljs-string">"高性能实现，优化了资源使用和响应时间。"</span>,
            <span class="hljs-string">"跨平台兼容，支持多种设备和浏览器。"</span>
        };
        <span class="hljs-keyword">return</span> descriptions[index % descriptions.<span class="hljs-property">Length</span>];
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GridItem</span>
    {
        <span class="hljs-keyword">public</span> int <span class="hljs-title class_">Index</span> { get; set; }
        <span class="hljs-keyword">public</span> <span class="hljs-title class_">Guid</span> <span class="hljs-title class_">Id</span> { get; set; }
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title class_">Title</span> { get; set; } = <span class="hljs-built_in">string</span>.<span class="hljs-property">Empty</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title class_">Description</span> { get; set; } = <span class="hljs-built_in">string</span>.<span class="hljs-property">Empty</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> <span class="hljs-title class_">Category</span> { get; set; } = <span class="hljs-built_in">string</span>.<span class="hljs-property">Empty</span>;
        <span class="hljs-keyword">public</span> int <span class="hljs-title class_">Views</span> { get; set; }
        <span class="hljs-keyword">public</span> int <span class="hljs-title class_">Likes</span> { get; set; }
        <span class="hljs-keyword">public</span> <span class="hljs-title class_">DateTime</span> <span class="hljs-title class_">CreatedAt</span> { get; set; }
        <span class="hljs-keyword">public</span> bool <span class="hljs-title class_">IsFeatured</span> { get; set; }
    }
}
</code></pre>
<h2 data-id="heading-16">总结</h2>
<p>本文详细介绍了Blazor中的四个高级组件开发特性：</p>
<ol>
<li><strong>渲染片段（RenderFragment）</strong> ：提供了灵活的组件内容注入机制</li>
<li><strong>动态组件</strong>：支持运行时组件类型解析和渲染</li>
<li><strong>错误边界</strong>：优雅地处理组件树中的异常</li>
<li><strong>虚拟化组件</strong>：优化大数据集的性能表现</li>
</ol>
<p>这些高级特性能够帮助您构建更加健壮、灵活和高性能的Blazor应用程序。在实际开发中，建议根据具体需求选择合适的模式，并注意性能优化和错误处理。</p>
<p>以上就是《ASP.NET Core Blazor进阶1：高级组件开发》的全部内容，希望你有所收获。<strong>关注、点赞，持续分享</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端周刊第439期（2025年11月3日–11月9日）]]></title>    <link>https://juejin.cn/post/7570491473033789449</link>    <guid>https://juejin.cn/post/7570491473033789449</guid>    <pubDate>2025-11-10T03:50:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570491473033789449" data-draft-id="7570564840428257307" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端周刊第439期（2025年11月3日–11月9日）"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-11-10T03:50:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端周刊第439期（2025年11月3日–11月9日）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T03:50:44.000Z" title="Mon Nov 10 2025 03:50:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>📢宣言：我已经计划并开始实践：每周逐期翻译《前端周刊》内的每篇文章，并将其整理发布到 GitHub 仓库中，持续更深度的分享。 欢迎大家访问：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn" ref="nofollow noopener noreferrer">github.com/TUARAN/fron…</a> 顺手点个 ⭐ star 支持，是我持续输出的续航电池🔋✨！</p>
<p><strong>每周更新国外论坛的前端热门文章，推荐大家阅读/翻译，紧跟时事，掌握前端技术动态，也为写作或突破新领域提供灵感~</strong></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c47d25a815c405485c9fab2dd7ed104~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351443&amp;x-signature=u7mCxs8Vm0YE7Z6dwnTAto2oKxE%3D" alt="微信图片_20251110114720_328.png" loading="lazy"/></p>
<p>上周，TypeScript 之父 Anders Hejlsberg 谈 AI 时代的类型安全， Chrome DevTools 新增单请求限速，再到 CSS 滚动驱动动画与 View Transition 的高阶玩法，整个前端生态正变得越来越智能与流畅。React 19 的新组件、Remix 的去 React 化改革，也让我们再次意识到：框架的稳定与演化，是一场“无声的性能战争”。</p>
<h2 data-id="heading-0">🗂 本期精选目录</h2>
<h2 data-id="heading-1">Web 开发</h2>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Fmswjs.io%2Fblog%2Fserver-sent-events-are-here" target="_blank" title="https://mswjs.io/blog/server-sent-events-are-here" ref="nofollow noopener noreferrer">Server-Sent Events Are Here!</a>：MSW 推出原生 SSE 支持，让浏览器实时推送更简单、可控。</p>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.blog%2Fdeveloper-skills%2Fprogramming-languages-and-frameworks%2Ftypescripts-rise-in-the-ai-era-insights-from-lead-architect-anders-hejlsberg%2F" target="_blank" title="https://github.blog/developer-skills/programming-languages-and-frameworks/typescripts-rise-in-the-ai-era-insights-from-lead-architect-anders-hejlsberg/" ref="nofollow noopener noreferrer">TypeScript’s rise in the AI era: Insights from Lead Architect, Anders Hejlsberg</a>：TypeScript 之父谈 AI 时代：类型安全为何比以往更重要。</p>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.debugbear.com%2Fblog%2Fchrome-devtools-throttle-individual-request" target="_blank" title="https://www.debugbear.com/blog/chrome-devtools-throttle-individual-request" ref="nofollow noopener noreferrer">How To Throttle Specific Requests In Chrome DevTools</a>：Chrome DevTools 新功能：单独控制特定请求的速率，真实还原慢网环境。</p>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Fcss-tricks.com%2Fexplaining-the-accessible-benefits-of-using-semantic-html-elements%2F" target="_blank" title="https://css-tricks.com/explaining-the-accessible-benefits-of-using-semantic-html-elements/" ref="nofollow noopener noreferrer">Explaining the Accessible Benefits of Using Semantic HTML Elements</a>：用语义化标签提升无障碍体验，HTML 的人文价值被重新强调。</p>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Ftympanus.net%2Fcodrops%2F2025%2F11%2F04%2Fcreating-3d-scroll-driven-text-animations-with-css-and-gsap%2F" target="_blank" title="https://tympanus.net/codrops/2025/11/04/creating-3d-scroll-driven-text-animations-with-css-and-gsap/" ref="nofollow noopener noreferrer">Creating 3D Scroll-Driven Text Animations with CSS and GSAP</a>：结合 CSS 与 GSAP 打造滚动驱动的 3D 文本动画，沉浸感拉满。</p>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Fthenewstack.io%2Fwhy-frontend-developers-should-ditch-dark-patterns%2F" target="_blank" title="https://thenewstack.io/why-frontend-developers-should-ditch-dark-patterns/" ref="nofollow noopener noreferrer">Why Frontend Developers Should Ditch Dark Patterns</a>：别再用“黑暗模式”操控用户行为，设计伦理正在成为开发议题。</p>
<h2 data-id="heading-2">CSS</h2>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Fcssence.com%2F2025%2Fscroll-margin-scroll-padding%2F" target="_blank" title="https://cssence.com/2025/scroll-margin-scroll-padding/" ref="nofollow noopener noreferrer">Instant snapport: Tidbits about scroll-margin and scroll-padding</a>：深入解析 <code>scroll-margin</code> 与 <code>scroll-padding</code> 的滚动捕捉机制。</p>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontendmasters.com%2Fblog%2Fstaggered-animation-with-css-sibling-functions%2F" target="_blank" title="https://frontendmasters.com/blog/staggered-animation-with-css-sibling-functions/" ref="nofollow noopener noreferrer">Staggered Animation with CSS sibling-* Functions</a>：利用 sibling-* 函数实现延迟动画序列，无需 JS 即可分步播放。</p>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Fcss-tip.com%2Funiversal-focus%2F" target="_blank" title="https://css-tip.com/universal-focus/" ref="nofollow noopener noreferrer">The Universal Focus Ring</a>：统一的焦点环样式方案，兼顾无障碍与视觉一致性。</p>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Fpiccalil.li%2Fblog%2Fsome-practical-examples-of-view-transitions-to-elevate-your-ui%2F" target="_blank" title="https://piccalil.li/blog/some-practical-examples-of-view-transitions-to-elevate-your-ui/" ref="nofollow noopener noreferrer">Some practical examples of view transitions to elevate your UI</a>：用 View Transitions API 优化页面切换，动画体验更丝滑。</p>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontendmasters.com%2Fblog%2Fthe-weird-parts-of-position-sticky%2F" target="_blank" title="https://frontendmasters.com/blog/the-weird-parts-of-position-sticky/" ref="nofollow noopener noreferrer">The Weird Parts of position: sticky;</a>：那些让人迷惑的 <code>position: sticky</code> 细节，终于有人讲清楚了。</p>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontendmasters.com%2Fblog%2Fperfectly-pointed-tooltips-all-four-sides%2F" target="_blank" title="https://frontendmasters.com/blog/perfectly-pointed-tooltips-all-four-sides/" ref="nofollow noopener noreferrer">Perfectly Pointed Tooltips: All Four Sides</a>：完美实现四向提示气泡，视觉与交互的平衡之道。</p>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Fcss-tricks.com%2Fthe-most-hated-css-feature-tan%2F" target="_blank" title="https://css-tricks.com/the-most-hated-css-feature-tan/" ref="nofollow noopener noreferrer">The “Most Hated” CSS Feature: tan()</a>：tan() 被称为“最让人讨厌的 CSS 特性”，但其实很有用。</p>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bram.us%2F2025%2F11%2F06%2Fcombining-scroll-driven-animations-with-starting-style%2F" target="_blank" title="https://www.bram.us/2025/11/06/combining-scroll-driven-animations-with-starting-style/" ref="nofollow noopener noreferrer">Combining Scroll-Driven Animations with @starting-style</a>：结合滚动动画与 <code>@starting-style</code>，实现流畅的入场与过渡。</p>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Fcss-text-wrap-balance-vs-text-wrap-pretty%2F" target="_blank" title="https://blog.logrocket.com/css-text-wrap-balance-vs-text-wrap-pretty/" ref="nofollow noopener noreferrer">When to use CSS text-wrap: balance vs. text-wrap: pretty</a>：<code>text-wrap</code> 的两种模式详解：平衡 vs 美观，何时该用哪种？</p>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Fgarden.bradwoods.io%2Fnotes%2Fjavascript%2Fweb-api%2Fview-transition" target="_blank" title="https://garden.bradwoods.io/notes/javascript/web-api/view-transition" ref="nofollow noopener noreferrer">View Transition API</a>：View Transition API 原理解析：浏览器如何平滑重绘。</p>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Fsalehmubashar.com%2Fblog%2Fhtml-selects-are-actually-styleable-now" target="_blank" title="https://salehmubashar.com/blog/html-selects-are-actually-styleable-now" ref="nofollow noopener noreferrer">HTML Selects Are Actually Styleable Now</a>：HTML <code>&lt;select&gt;</code> 终于可定制样式了！CSS 革命的又一胜利。</p>
<h2 data-id="heading-3">JavaScript</h2>
<h3 data-id="heading-4">理论篇</h3>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.polarsignals.com%2Fblog%2Fposts%2F2025%2F11%2F04%2Fjavascript-source-maps-internals" target="_blank" title="https://www.polarsignals.com/blog/posts/2025/11/04/javascript-source-maps-internals" ref="nofollow noopener noreferrer">The Inner Workings of JavaScript Source Maps</a>：彻底理解 Source Map 的原理与调试流程。</p>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Fjsdev.space%2Funderrated-js-features%2F" target="_blank" title="https://jsdev.space/underrated-js-features/" ref="nofollow noopener noreferrer">Mastering URLPattern for Cross-Platform Routing</a>：掌握 URLPattern，让多平台路由更智能、更统一。</p>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.freecodecamp.org%2Fnews%2Fglobal-execution-context-and-temporal-dead-zone-explained%2F" target="_blank" title="https://www.freecodecamp.org/news/global-execution-context-and-temporal-dead-zone-explained/" ref="nofollow noopener noreferrer">How Do Global Execution Context and Temporal Dead Zone Work in JavaScript?</a>：彻底理解全局执行上下文与暂时性死区，告别 JS 作用域困惑。</p>
<h3 data-id="heading-5">React 专区</h3>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Fremix-3-ditched-react%2F" target="_blank" title="https://blog.logrocket.com/remix-3-ditched-react/" ref="nofollow noopener noreferrer">Remix 3 ditched React: Should you stick with it?</a>：Remix 3 宣布去 React 化，是否还值得继续使用？</p>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Fthenewstack.io%2Fwhy-reacts-boring-maturity-is-actually-its-main-strength%2F" target="_blank" title="https://thenewstack.io/why-reacts-boring-maturity-is-actually-its-main-strength/" ref="nofollow noopener noreferrer">Why React’s ‘Boring’ Maturity Is Actually Its Main Strength</a>：React 的“无聊成熟”反而是其最大优势，稳定才是生产力。</p>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Fjavascript.plainenglish.io%2Ftried-react-19s-activity-component-here-s-what-i-learned-b0f714003a65" target="_blank" title="https://javascript.plainenglish.io/tried-react-19s-activity-component-here-s-what-i-learned-b0f714003a65" ref="nofollow noopener noreferrer">Tried React 19’s Activity Component — Here’s What I Learned (With Code Examples)</a>：实测 React 19 的 Activity 组件，用例与局限并存。</p>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.wix.engineering%2Fpost%2F40-faster-interaction-how-wix-solved-react-s-hydration-problem-with-selective-hydration-and-suspen" target="_blank" title="https://www.wix.engineering/post/40-faster-interaction-how-wix-solved-react-s-hydration-problem-with-selective-hydration-and-suspen" ref="nofollow noopener noreferrer">40% Faster Interaction: How Wix Solved React’s Hydration Problem with Selective Hydration and Suspense</a>：Wix 通过“选择性 Hydration + Suspense”实现交互加速 40%，为 React 性能优化提供新方向。</p>
<h3 data-id="heading-6">Angular</h3>
<p>🔹<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.to%2Fthis-is-angular%2Fangular-authentication-with-cookies-in-10-minutes-41m8" target="_blank" title="https://dev.to/this-is-angular/angular-authentication-with-cookies-in-10-minutes-41m8" ref="nofollow noopener noreferrer">Angular Authentication with Cookies in 10 minutes</a>：用 Cookie 实现 Angular 登录认证，仅需 10 分钟。</p>
<hr/>
<h2 data-id="heading-7">📌 小结</h2>
<p>从 SSE、AI 与 TypeScript 的融合，到 View Transitions 与 Scroll 动画的全面爆发，这一周的前端趋势非常明确： <strong>Web 正在成为智能交互系统，而不只是渲染平台。</strong> 开发者不再只是“写页面”，而是在定义一种新的应用运行方式。</p>
<hr/>
<p>✅ OK，以上就是本次分享，欢迎加我威 atar24，备注「前端周刊」，我会邀请你进交流群👇</p>
<p>🚀 每周分享技术干货</p>
<p>🎁 不定期抽奖福利</p>
<p>💬 有问必答，群友互助</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文讲清：Embedding向量嵌入是什么？]]></title>    <link>https://juejin.cn/post/7570191839594676287</link>    <guid>https://juejin.cn/post/7570191839594676287</guid>    <pubDate>2025-11-10T03:52:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570191839594676287" data-draft-id="7570295366479888420" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文讲清：Embedding向量嵌入是什么？"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-11-10T03:52:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文讲清：Embedding向量嵌入是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T03:52:48.000Z" title="Mon Nov 10 2025 03:52:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在RAG应用开发中，第一步就是对于文档进行chunking，chunk质量会直接决定整个RAG检索的质量。</p>
<p>过去，行业通常会采用<strong>先chunking再embedding</strong>，最后检索、生成的思路进行。</p>
<p>但这个思路中，在chunking环节，无论是固定长度分块，还是递归分块，其实都解决不了精度和上下文的平衡的问题。</p>
<p>在此背景下，先embedding再chunking的思路逐渐被更多人接受。典型代表是Jina AI提出的Late Chunking策略，以及Max–Min semantic chunking。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae81a2f6e6fe4598a6d36c32576ac609~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351567&amp;x-signature=muLXdOzHxbS78mFwtf4xPjXWBrc%3D" alt="图片" loading="lazy"/></p>
<p>一起来开个脑洞，如果诸葛亮穿越到《水浒传》的世界，他会成为谁？武松、宋江、还是吴用？这看似是一道文学题，但我们可以用数学方法来求解：诸葛亮 + 水浒传 - 三国演义 = ？</p>
<p>文字本身无法直接运算，但是如果把文字转换成数字向量，就可以进行计算了。而这个过程，叫做“向量嵌入”。</p>
<p>在当今的人工智能（AI）领域，Embedding 是一个不可或缺的概念。如果你没有深入理解过 Embedding，那么就无法真正掌握 AI 的精髓。接下来，我们将深入探讨 Embedding 的基本概念。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0dba22dfb7aa491a9ee99b8860d0d2e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351567&amp;x-signature=%2BfJqxd6sAmjvc4LzAcE77OIdivM%3D" alt="图片" loading="lazy"/></p>
<p><strong>一、什么是 Embedding？</strong></p>
<p>如果要用一句话来解释：Embedding 就是把原本“看不懂”的符号，翻译成机器能理解的数字向量。</p>
<p><strong>想象一下</strong>：</p>
<p>人类能理解“苹果”和“香蕉”相似，和“桌子”差得远，但在计算机眼里，词汇最初只是符号（例如 ID 编号），没有任何语义。于是我们需要一种方法，把这些符号变成“有意义的数字坐标”，这套坐标体系就是 Embedding 空间。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39d57ebfe3f64abab9025dbfe634ddad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351567&amp;x-signature=x9JxWIZ9oemJ8rWAjXj9U3c89lQ%3D" alt="图片" loading="lazy"/></p>
<p>Embedding 是一种将高维数据映射到低维空间的技术。简单来说，它就是把复杂的、难以处理的数据转换成便于计算的形式。</p>
<p>举个例子，假设我们有一个包含上千个词汇的文本数据，每个词汇可以看作是一个维度，这样的数据在计算机处理时会变得非常复杂。而 Embedding 则是通过数学模型将这些高维数据映射到一个低维空间，使得计算更加高效。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eaf2b1daddaf4c2584908154f8618102~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351567&amp;x-signature=vuY%2Brimk61TyEys95WO%2BOoH%2B06Q%3D" alt="图片" loading="lazy"/></p>
<p><strong>二、Embedding 的作用</strong></p>
<p>在 AI 中，Embedding 扮演着极其重要的角色。首先，它能大大降低数据的维度，从而提高计算效率。其次，通过 Embedding，AI 模型能够捕捉到数据之间的隐含关系和结构。</p>
<p>例如，在自然语言处理（NLP）中，词向量（word embeddings）能够将语义相近的词汇映射到相邻的向量空间中，这样模型就可以更好地理解和处理语言数据。</p>
<p>因为具有语义意义的数据（如文本或图像），人类可以分辨它们的相关程度，但是无法量化，更不能直接计算。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ffc0bf8048b4be28250470bacd9650d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351567&amp;x-signature=oq1x11s7KvHgmqn3kUK3yEAxt1A%3D" alt="图片" loading="lazy"/></p>
<p>例如，对于一组词“诸葛亮、刘备、关羽、篮球、排球、羽毛球”，我们可能会把“诸葛亮、刘备、关羽”分成一组，“篮球、排球、羽毛球”分成另外一组。</p>
<p>但如果进一步提问，“诸葛亮”是和“刘备”更相关，还是和“关羽”更相关呢？这很难回答。而把这些信息转换为向量后，相关程度就可以通过它们在向量空间中的距离量化。</p>
<p>甚至于，我们可以做 诸葛亮 + 水浒传 - 三国演义 = ？ 这样的脑洞数学题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81776d0f3f8e47b0a324d5270726417d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351567&amp;x-signature=RzovBL%2B9IMlpqJUW7US1X%2BZT7r4%3D" alt="图片" loading="lazy"/></p>
<p><strong>具体作用</strong></p>
<p><strong>1.压缩表示</strong></p>
<p>例如用 one-hot 表示一个词，假如有 10 万个词，每个词都是一个长度 100,000 的向量，大部分位置都是 0，非常低效。</p>
<p>Embedding 可以把它压缩成 100~1,000 维的实数向量，既节省存储，又利于计算。</p>
<p><strong>2.捕捉语义</strong></p>
<p>相似的对象会被映射到相近的向量。</p>
<p>“苹果”和“香蕉”在空间里距离很近，而“苹果”和“电脑”距离更远。</p>
<p><strong>3.通用特征</strong></p>
<p>Embedding 可以作为“底层语言”，被下游任务复用。</p>
<p>比如词向量可以用于机器翻译、情感分析、问答系统。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0231b9bb51a456ea95c32335c082c41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351567&amp;x-signature=DXMwEDB06ce1GjbBwzpkpBjr24A%3D" alt="图片" loading="lazy"/></p>
<p><strong>三、常见的 Embedding 类型</strong></p>
<p>根据不同的应用场景，Embedding 的实现方法也有所不同。常见的 Embedding 类型包括：</p>
<p><strong>词向量</strong>（Word Embedding）：这是最常见的一种 Embedding，主要用于 NLP 领域。通过词向量模型，如 Word2Vec 和 GloVe，可以将词汇映射到一个固定维度的向量空间中，从而捕捉到词汇之间的语义关系</p>
<p><strong>图像嵌入</strong>（Image Embedding）：在计算机视觉（CV）领域，图像嵌入技术可以将图像数据转换为向量，从而用于图像分类、对象检测等任务</p>
<p><strong>用户嵌入</strong>（User Embedding）：在推荐系统中，通过对用户行为数据进行嵌入，可以有效地进行个性化推荐</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89bd37eafdf042c1ac3f90c1fe802aab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763351567&amp;x-signature=IhdLDo2ko92%2FqCankWjmkf9T%2Byo%3D" alt="图片" loading="lazy"/></p>
<p><strong>四、总结</strong></p>
<p>Embedding 可以理解为一种“翻译器”，它把原本没有数值意义的离散符号（如词语、用户ID、商品、图片等）转化为低维、稠密的向量表示。</p>
<p>这样做的好处是既能压缩数据、提升计算效率，又能在向量空间中保留语义或特征上的相似性，使得相似的对象更接近，不相似的对象更远。</p>
<p>在传统深度学习中，Embedding 常见于词向量和推荐系统；在大模型时代，它是语言模型、图文匹配、多模态对齐等任务的基础。可以说，Embedding 是机器理解世界的一种“坐标系”。</p>
<p>Embedding 技术在人工智能领域中起着至关重要的作用，能够将复杂的高维数据映射到低维空间，提高数据处理和分析的效率。</p>
<p>通过全面了解和应用 Embedding 技术，我们可以在各种 AI 任务中实现更高效和准确的数据处理，从而推动人工智能的发展和应用。</p>
<p><strong>更多AI大模型学习视频及资源，都在<a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[超越经典23种设计模式：新模式、反模式与函数式编程]]></title>    <link>https://juejin.cn/post/7570187256106254342</link>    <guid>https://juejin.cn/post/7570187256106254342</guid>    <pubDate>2025-11-10T02:25:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570187256106254342" data-draft-id="7570187256106221574" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="超越经典23种设计模式：新模式、反模式与函数式编程"/> <meta itemprop="keywords" content="设计模式,函数式编程,云原生"/> <meta itemprop="datePublished" content="2025-11-10T02:25:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Juchecar"/> <meta itemprop="url" content="https://juejin.cn/user/284133851925070"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            超越经典23种设计模式：新模式、反模式与函数式编程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/284133851925070/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Juchecar
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T02:25:37.000Z" title="Mon Nov 10 2025 02:25:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>设计模式领域在教材之外有着丰富的新发展和新思考。这些新内容超越了经典的GoF 23种模式，更贴近现代软件开发的现实。</p>
<p>以下是几个重要的新方向和趋势：</p>
<h3 data-id="heading-0">1. 新模式的出现：解决云原生、分布式系统问题</h3>
<p>经典模式主要解决单机应用内的对象间关系，而新模式专注于分布式系统下的挑战。</p>
<ul>
<li><strong>Sidecar 模式</strong>：在云原生架构中，为一个主应用容器附加一个“边车”容器，来提供辅助功能（如日志收集、服务发现、代理等）。这类似于<strong>装饰器模式</strong>，但是在容器层面。</li>
<li><strong>Ambassador 模式</strong>：为网络调用提供代理，处理重试、断路、监控等跨领域问题。可以看作是<strong>代理模式</strong>在分布式环境下的演进。</li>
<li><strong>Circuit Breaker 模式</strong>：防止一个服务的故障在整个分布式系统中级联蔓延。当失败率达到阈值，快速失败，就像电路熔断一样。这是微服务架构的基石之一。</li>
<li><strong>CQRS (Command Query Responsibility Segregation)</strong>：读写分离模式。将数据修改（命令）和数据查询（查询）使用不同的模型，优化读写性能、扩展性和安全性。</li>
<li><strong>Event Sourcing</strong>：不存储当前状态，而是存储导致状态变化的一系列事件。通过重放事件来重建状态。这为审计、调试和实现复杂业务逻辑提供了全新思路。</li>
<li><strong>Saga 模式</strong>：在微服务架构中管理跨多个服务的长期事务。它将一个分布式事务拆解为一系列本地事务，通过补偿机制来保证最终一致性。</li>
</ul>
<h3 data-id="heading-1">2. 模式的“消亡”与“内化”：语言和框架的进化</h3>
<p>正如之前讨论的，许多模式的思想已被现代语言和框架吸收，你每天都在用，只是不自知。</p>
<ul>
<li><strong>依赖注入</strong>：在Spring、Angular等框架中，这已从一种需要手动实现的模式（如<strong>工厂模式</strong>的变体）变成了框架的核心基础设施。你通过 <code>@Autowired</code> 或构造函数声明依赖，框架替你完成组装。</li>
<li><strong>Reactive Extensions (RxJS, RxJava等)</strong>：它本质上是<strong>观察者模式</strong>和<strong>迭代器模式</strong>的强力组合，并融入了函数式编程思想，为处理异步数据流提供了强大的工具集。</li>
<li><strong>现代前端框架 (React, Vue, Svelte)</strong>：它们的核心思想是<strong>反应式编程</strong>。你声明状态（State）与视图的映射关系，当状态变化时，框架自动更新视图。这可以看作是一种高度优化的、声明式的<strong>观察者模式</strong>实现。</li>
</ul>
<h3 data-id="heading-2">3. 反模式和模式误用：从失败中学习</h3>
<p>“反模式”是指那些看似有用但最终会导致更多问题的常见解决方案。了解它们同样重要。</p>
<ul>
<li><strong>上帝对象 (God Object)</strong>：一个类承担了太多职责，知道太多事情，变成了一个庞大的、难以维护的“怪物”。</li>
<li><strong>贫血模型 (Anemic Domain Model)</strong>：对象只有数据（getter/setter），没有行为。业务逻辑散落在大量的“服务类”中，这实际上是面向过程编程，违背了面向对象封装的初衷。</li>
<li><strong>单车库综合症 (Not Invented Here Syndrome)</strong>：拒绝使用成熟的外部库或框架，坚持自己造轮子，浪费大量时间且质量难以保证。</li>
<li><strong>模式滥用 (Pattern Abuse)</strong>：就是你所提到的，在不该用模式的地方强行使用，导致“过度工程”。比如为只有两个分支的简单逻辑引入完整的策略模式。</li>
</ul>
<h3 data-id="heading-3">4. 函数式编程的影响：用组合替代继承</h3>
<p>函数式编程范式带来了全新的代码组织方式，对传统的面向对象设计模式形成了挑战和补充。</p>
<ul>
<li><strong>组合子模式 (Combinator Pattern)</strong>：通过组合小的、纯函数来构建复杂的业务逻辑。这在处理验证、解析等场景时非常强大和灵活。</li>
<li><strong>替代模板方法模式</strong>：模板方法模式使用继承来定义算法骨架。在函数式编程中，可以通过<strong>高阶函数</strong>实现同样的目标，且更灵活。
<ul>
<li><strong>传统方式 (Java)</strong>:
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataProcessor</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">()</span> { <span class="hljs-comment">// 模板方法</span>
        loadData();
        transformData();
        saveData();
    }
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transformData</span><span class="hljs-params">()</span>;
}
</code></pre>
</li>
<li><strong>函数式方式 (JavaScript)</strong>:
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createProcessor</span>(<span class="hljs-params">transformFn</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-title function_">loadData</span>();
        <span class="hljs-title function_">transformFn</span>(); <span class="hljs-comment">// 将变化的部分作为函数传入</span>
        <span class="hljs-title function_">saveData</span>();
    };
}
</code></pre>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">5. 领域驱动设计 (DDD) 中的模式</h3>
<p>DDD提供了一套在复杂业务系统中进行建模和设计的高级模式，它们与代码设计模式相辅相成。</p>
<ul>
<li><strong>实体 (Entity)</strong> / <strong>值对象 (Value Object)</strong></li>
<li><strong>聚合 (Aggregate)</strong> / <strong>聚合根 (Aggregate Root)</strong>：定义了数据修改的边界和一致性保证。</li>
<li><strong>领域事件 (Domain Event)</strong>：表示领域中发生的重要事情，是<strong>观察者模式</strong>在业务层面的应用。</li>
<li><strong>资源库 (Repository)</strong>：封装数据访问逻辑，提供了<strong>集合式的接口</strong>来管理聚合根，是更高级的<strong>工厂模式</strong>和<strong>数据访问对象模式</strong>的结合。</li>
</ul>
<h3 data-id="heading-5">总结</h3>
<p>教材之外的设计模式世界是动态和广阔的。要跟上这个领域，你需要：</p>
<ol>
<li><strong>关注架构</strong>：从“类”级别的设计，上升到“服务”和“系统”级别的设计。</li>
<li><strong>拥抱范式</strong>：理解函数式编程如何提供新的问题解决工具。</li>
<li><strong>学习失败</strong>：研究反模式，避免常见的陷阱。</li>
<li><strong>深入业务</strong>：学习像DDD这样的方法论，将设计模式与复杂的业务逻辑更好地结合。</li>
</ol>
<p>最终，设计模式的“新”不在于有多少种新花样，而在于你如何运用这些<strong>解决复杂问题的思维工具</strong>，去应对现代软件开发中不断涌现的新挑战。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[百度统计、Google Analytics平替开源网站分析工具：Umami]]></title>    <link>https://juejin.cn/post/7570243451725611035</link>    <guid>https://juejin.cn/post/7570243451725611035</guid>    <pubDate>2025-11-10T01:53:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570243451725611035" data-draft-id="7570271574349053961" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="百度统计、Google Analytics平替开源网站分析工具：Umami"/> <meta itemprop="keywords" content="后端,Java,程序员"/> <meta itemprop="datePublished" content="2025-11-10T01:53:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SimonKing"/> <meta itemprop="url" content="https://juejin.cn/user/4001878056904584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            百度统计、Google Analytics平替开源网站分析工具：Umami
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878056904584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SimonKing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T01:53:27.000Z" title="Mon Nov 10 2025 01:53:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>关注我的公众号：【编程朝花夕拾】，可获取首发内容。</p>
</blockquote>
<h2 data-id="heading-0">01 引言</h2>
<p>还记得之前做项目的时候，需要统计网站的<code>PV</code>、<code>UV</code>等，引入了百度统计的一段<code>js</code>。因为公司需要上市，数据安全的越来越重视，于是由于安全问题取消了网站的统计功能。</p>
<p>最近，发现一款类似百度统计、<code>Google Analytics</code>的开源分析工具：<code>Umami</code>。可以云托管也可以独立部署，数据更安全。</p>
<h2 data-id="heading-1">02 简介</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cfccd7ba1af40e3ac41b3d8a7c2ceee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763344407&amp;x-signature=HmFAgqj2JOmmNuOMt5fPhUYTtt8%3D" alt="" loading="lazy"/></p>
<p><code>Umami</code>是一款开源、注重隐私的网络分析工具，可作为谷歌分析的替代方案。它能提供有关网站流量、用户行为和性能的重要见解，同时始终将数据隐私放在首位。不收集或存储个人数据，无需使用Cookie，并且符合<code>GDPR</code>和<code>PECR</code>标准。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcf981f8763944ce81a0c2c79c7eddb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763344407&amp;x-signature=qTjOPe03yu%2BTvzxMNysvRzEo2tk%3D" alt="" loading="lazy"/></p>
<p>优势：</p>
<ul>
<li>
<p>极简主义与用户体验</p>
<p>界面清爽通过精美的图表和列表一目了然地展示，聚焦核心指标</p>
</li>
<li>
<p>以隐私保护为核心</p>
<p>无需Cookie警告，默认不收集任何个人身份信息，也不使用Cookie进行跟踪</p>
</li>
<li>
<p>开源与自托管</p>
<p>MIT 许可证下的开源软件，可以免费使用、修改和分发</p>
</li>
<li>
<p>强大的多功能支持</p>
<p>同时跟踪和管理多个网站，每个网站都有独立的仪表板和数据，以及共享链接</p>
</li>
</ul>
<p><code>GitHub</code>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fumami-software%2Fumami" target="_blank" title="https://github.com/umami-software/umami" ref="nofollow noopener noreferrer">github.com/umami-softw…</a></p>
<p>官方地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fumami.is%2F" target="_blank" title="https://umami.is/" ref="nofollow noopener noreferrer">umami.is/</a></p>
<h2 data-id="heading-2">03 部署</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a976a1df398c45469349d4770432b4cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763344407&amp;x-signature=zN9pSu9%2F77nMz6fruwKf4UApREs%3D" alt="" loading="lazy"/></p>
<p>官方文档给了三种安装方式：</p>
<ul>
<li>从<code>GitHub</code>上源码安装</li>
<li>使用Docker compose构建自己的镜像源</li>
<li>使用已有的镜像</li>
</ul>
<h3 data-id="heading-3">3.1 拉取镜像</h3>
<p>本文以存在的镜像部署。镜像根据数据存储的介质分了两种：<code>postgresql</code>版和<code>mysql</code>版。</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># PG版</span>
docker pull docker.umami.is/umami-software/umami:postgresql-latest

<span class="hljs-comment"># mysql版</span>
docker pull docker.umami.is/umami-software/umami:mysql-latest
</code></pre>
<p>本节选用的PG版：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f48559b92f8440d99da971ed335c0270~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763344407&amp;x-signature=hzGR9zErDZViVKjKE0A%2F%2F%2BSm%2BwU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">3.2 启动</h3>
<p>官方没有给出<code>docker</code>启动的脚本，直接启动会报错。从源码安装的流程中发现，安装时需要指定<code>DATABASE_URL</code>参数，用来执行数据库驱动的连接以采集数据。如图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/378ac03d6be34a5888181041f495d6ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763344407&amp;x-signature=578rafXu1%2F%2BwnPjDpCvvi%2BpTa%2Fc%3D" alt="" loading="lazy"/></p>
<p>所以我们启动业务需要指定数据库连接。容器的端口是<code>3000</code>，也需要暴露出来。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d6553759f2440098f97aebe55be7dce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763344407&amp;x-signature=DaG12REo0hW2u97%2BZPp4Sdr%2Bps4%3D" alt="" loading="lazy"/></p>
<p><code>docker</code>启动命令:</p>
<pre><code class="hljs language-sh" lang="sh">docker run \
--name umami \
-p 3000:3000 \
-e DATABASE_URL=postgresql://root:root@postgres@127.0.0.1:5432/umami \
-d docker.umami.is/umami-software/umami:postgresql-latest
</code></pre>
<p>这里的数据库连接需要指定数据库，所有我们需要提前创建好数据库。启动之后，需要查看日志：</p>
<pre><code class="hljs language-sh" lang="sh">docker logs -f umami 
</code></pre>
<p>如下图表示启动成功：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edeb0ab8a6fb4219b713b9ddd85d67f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763344407&amp;x-signature=%2BsTW%2B%2Fgm8Vtwk9kSEVZVm%2FGhXHQ%3D" alt="" loading="lazy"/></p>
<p>我们就可以通过，localhost:3000 访问了。<code>localhost</code>需要换成服务器的<code>IP</code>。</p>
<p>届时，我们也会发现数据库也已经自动创建好了表：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f53d7dd677f64ef5bb8f5d4b56820cf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763344407&amp;x-signature=45NRvvm6sqIaSTRWE73D4AojRG8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">3.3 测试</h3>
<p>直接访问需要登录。默认的用户名和密码：<code>admin/umami</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc90938cf7c74aea87ca7243e1cc6ca8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763344407&amp;x-signature=eJY22x%2Bhk9GKd7R1QyqVbdws9Hw%3D" alt="" loading="lazy"/></p>
<p>登录之后非常简洁：</p>
<p>只有仪表盘、网站、报告和设置这四个<code>Tab</code>，且为空。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38178e12f91941598ba8af1986f31afd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763344407&amp;x-signature=hE0A6ogAeJcuU1u4M1%2Fb3hIyclM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">04 使用</h2>
<p>在使用之前，默认进入的可能是英文。我们可以通过右上角的图标切换语言：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33ffbd620cb84e0ea9dfab1498b18893~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763344407&amp;x-signature=e0IiN%2F29D9DKz1FHMrjfWUg9%2FDI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">4.1 添加网站</h3>
<p>我们需要添加需要监控的网站：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5237b2e6c78b4106aa2ee8f83e764589~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763344407&amp;x-signature=RBtRDfXfEPjnPV0LWsQlkw5cFf4%3D" alt="" loading="lazy"/></p>
<p>我们添加监控<code>localhost</code>的所有网站。同时也支持<code>IP</code>。</p>
<p>查看网站，就会进入到监控的额详情的列表：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53ac6404caeb4f68b4e0544ce35a900d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763344407&amp;x-signature=pknjzx9vJ39heyrANSzMZ2tASAw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">4.2 添加脚本</h3>
<p>监控服务好了之后，就需要页面添加脚本了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9401b63a3f204c55b444d6a23632b04e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763344407&amp;x-signature=KCYhRNXyc3Sk9mAS%2FK281Y51Lrc%3D" alt="" loading="lazy"/></p>
<p>进入之后，查看跟踪代码：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/213953b6eb0840dda8b3aa0194dacddc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763344407&amp;x-signature=XRy%2FHuZIm7Lj2o%2FpMhn7aqi481s%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-js" lang="js">&lt;script defer src=<span class="hljs-string">"http://127.0.0.1:3000/script.js"</span> data-website-id=<span class="hljs-string">"6ffdf9b6-362a-42b3-afe6-4b91db81cb35"</span>&gt;&lt;/script&gt;
</code></pre>
<p>这里的<code>data-website-id</code>是生成的每个网站的唯一标识。只修要将这段<code>js</code>放在<code>&lt;head&gt;</code>标签里。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f06a5f21e10b4c488f24880bc2c008d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763344407&amp;x-signature=CqR0Q%2FIS0JxZZiV8S1Ys5V1yBgw%3D" alt="" loading="lazy"/></p>
<p>如图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83b3d45ae7f84f1da6cfb6fe05447980~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763344407&amp;x-signature=5G%2BTXe%2BYAgLdIKa9dOe8f6Ninfs%3D" alt="" loading="lazy"/></p>
<p>我分别在两个页面里面加了这段<code>js</code>。</p>
<h3 data-id="heading-9">4.3 访问测试</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9940a00da6e34e4c930e8338427b503c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763344407&amp;x-signature=TfyqtI7PwUMtfr6ADiGtBAI2WV4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d549c719b184fb88d98300a39c0494a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763344407&amp;x-signature=9Io9GJseOfBb5iEZkr41Ycqo2i4%3D" alt="" loading="lazy"/></p>
<p>这里可以收集到所有来自<code>localhost</code>的访问信息。更多信息请自行探索吧！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让人头疼的AndroidStudio、Gradle、AGP..]]></title>    <link>https://juejin.cn/post/7570187256105287686</link>    <guid>https://juejin.cn/post/7570187256105287686</guid>    <pubDate>2025-11-09T14:09:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570187256105287686" data-draft-id="7569946369990180927" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让人头疼的AndroidStudio、Gradle、AGP.."/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-09T14:09:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="KDDAyesp"/> <meta itemprop="url" content="https://juejin.cn/user/3105473423744663"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让人头疼的AndroidStudio、Gradle、AGP..
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3105473423744663/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    KDDAyesp
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T14:09:50.000Z" title="Sun Nov 09 2025 14:09:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>每次使用AndroidStudio运行一个项目，其中的Gradle、AGP、AndroidStudio、JDK、Kotlin版本、依赖库版本都很折磨人，一个老Android开发都得花不少时间去处理。下面就遇到的此类问题做记录。</p>
</blockquote>
<h2 data-id="heading-0"><strong>1. Gradle、AGP傻傻分不清</strong></h2>
<p>Gradle 是一个<strong>通用的构建自动化工具</strong>，核心作用是 “定义并执行项目的构建流程”—— 不管是 Java、C++、Android 还是其他类型的项目，只要通过 Gradle 的 “构建脚本”（如 <code>build.gradle</code>）定义好规则，它就能自动完成编译、打包、依赖管理等工作。</p>
<p>先具体说 Gradle 的核心能力：</p>
<ol>
<li>
<p><strong>自动化构建流程</strong>它可以按顺序执行一系列 “任务”（Task），比如：</p>
<ul>
<li>清理旧的编译产物（<code>clean</code> 任务）；</li>
<li>下载项目依赖的库（<code>downloadDependencies</code> 任务）；</li>
<li>编译源代码（<code>compileJava</code> 任务）；</li>
<li>打包成可执行文件（如 <code>jar</code>、<code>apk</code> 任务）。这些任务由 Gradle 自动调度，开发者只需点击 “构建” 按钮，无需手动执行每一步。</li>
</ul>
</li>
<li>
<p><strong>依赖管理</strong>项目中用到的第三方库（如 <code>gson</code>、<code>okhttp</code>），Gradle 会根据配置自动从 Maven 仓库下载，并处理依赖之间的冲突（比如 A 库依赖 B 库 1.0，C 库依赖 B 库 2.0 时，Gradle 会按规则选择合适的版本）。</p>
</li>
<li>
<p><strong>高度可扩展</strong>Gradle 本身是 “通用工具”，不绑定任何特定开发领域（比如它不知道 Android 项目的 <code>res</code> 目录是什么）。但它可以通过 “插件”（Plugin）扩展功能 —— 插件会定义新的任务、配置项，让 Gradle 理解特定类型的项目。</p>
</li>
</ol>
<p>再看 Gradle 与 AGP 的关系：<strong>AGP 是 Gradle 的一个 “插件”，专门为 Android 项目设计</strong>，二者是 “引擎” 与 “专属插件” 的关系，具体体现在：</p>
<ol>
<li>
<p><strong>AGP 让 Gradle 能理解 Android 项目</strong>Gradle 本身只认识通用的源代码目录（如 <code>src/main/java</code>），但 Android 项目有很多特殊内容：<code>AndroidManifest.xml</code>、<code>res</code> 资源目录、<code>aidl</code> 接口、NDK 代码等。AGP 通过扩展 Gradle，添加了对这些内容的支持 —— 比如告诉 Gradle“<code>res</code> 目录下的 XML 要通过 <code>aapt2</code> 工具编译”“<code>AndroidManifest.xml</code> 需要合并多渠道配置”。</p>
</li>
<li>
<p><strong>AGP 为 Gradle 增加 Android 专属任务</strong>Gradle 自带的任务（如 <code>compileJava</code>）只能处理普通 Java 代码，而 Android 构建需要更复杂的步骤（如生成 Dex 文件、签名 APK）。AGP 会向 Gradle 注册一系列 Android 专属任务（如 <code>processResources</code> 处理资源、<code>dexBuilder</code> 生成 Dex、<code>packageDebug</code> 打包调试 APK），并定义这些任务的执行顺序。</p>
</li>
<li>
<p><strong>版本强绑定，AGP 依赖特定 Gradle 版本</strong>AGP 作为 Gradle 的插件，必须与 Gradle 版本匹配 —— 新的 AGP 可能会用到 Gradle 的新特性，而旧的 Gradle 不支持。例如：</p>
<ul>
<li>AGP 7.0 必须搭配 Gradle 7.0+；</li>
<li>AGP 8.0 必须搭配 Gradle 8.0+；（官方有严格的版本对应表，不匹配会直接报错）</li>
</ul>
</li>
<li>
<p>**AGP 是 Android 构建逻辑的 “实现者”**Gradle 负责 “执行任务”，而 AGP 负责 “定义 Android 项目的任务应该做什么”。比如：“如何将 Java 字节码转换成 Android 可执行的 Dex 格式”—— 这个逻辑由 AGP 实现，Gradle 只负责调用 AGP 定义的任务来执行。</p>
</li>
</ol>
<p>一句话总结：</p>
<ul>
<li><strong>Gradle 是 “构建引擎”</strong> ：负责调度任务、管理依赖、执行自动化流程，是所有类型项目的通用工具。</li>
<li><strong>AGP 是 “Android 专属插件”</strong> ：让 Gradle 能看懂 Android 项目的特殊结构，定义 Android 专属的构建任务（如打包 APK、处理资源），二者必须版本匹配才能正常工作。</li>
</ul>
<p>没有 Gradle，AGP 无从运行；没有 AGP，Gradle 无法构建 Android 项目 —— 这就是它们的核心关系。</p>
<h2 data-id="heading-1"><strong>2. 为什么AndroidStudio的setting里设置了Java版本，build.gradle里又设置一遍，基于哪个为准？</strong></h2>
<p>在 Android 开发中，Java 版本的设置会出现在两个地方：<strong>Android Studio 的全局设置</strong>和<strong>项目的 build.gradle 配置</strong>，两者的作用和优先级完全不同，需要区分清楚。</p>
<p>1.1 <strong>Android Studio 的全局 Java 设置（Settings → Build, Execution, Deployment → Build Tools → Gradle）</strong></p>
<ul>
<li><strong>作用对象</strong>：这是<strong>Android Studio 运行 Gradle 时使用的 JDK 版本</strong>（即 “Gradle 的运行环境”）。</li>
<li><strong>具体用途</strong>：Gradle 本身是用 Java 编写的工具，它的执行（解析构建脚本、执行编译任务等）需要依赖 JDK。这里的设置决定了 “Gradle 进程” 运行在哪个 JDK 环境中。</li>
<li><strong>配置位置</strong>：通过 AS 的 UI 设置（可选择 AS 内置的 JDK 或外部 JDK），本质是指定<code>JAVA_HOME</code>给 Gradle 进程。</li>
</ul>
<p>1.2 <strong>build.gradle 中的 Java 版本设置</strong></p>
<ul>
<li><strong>作用对象</strong>：这是<strong>项目代码的编译和运行版本</strong>（即 “源码的 Java 版本”）。</li>
<li><strong>具体用途</strong>：规定项目中 Java/Kotlin 代码使用的 Java 语法特性版本（如 Java 8 的 Lambda、Java 11 的 var 等），以及生成的字节码兼容的 Java 版本。</li>
<li><strong>常见配置方式</strong>：</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 模块级build.gradle</span>
android {
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_11  <span class="hljs-comment">// 源码语法版本</span>
        targetCompatibility JavaVersion.VERSION_11  <span class="hljs-comment">// 字节码兼容版本</span>
    }
    <span class="hljs-comment">// Kotlin项目还需要配置</span>
    kotlinOptions {
        jvmTarget = <span class="hljs-string">"11"</span>  <span class="hljs-comment">// Kotlin编译后的字节码兼容版本</span>
    }
}
</code></pre>
<p><strong>总结：</strong></p>
<blockquote>
<p><strong>AS 的 Java 设置</strong>：决定 Gradle 工具本身运行在哪个 JDK 环境，是构建的 “底层引擎”，必须满足 AGP 的版本要求。
<strong>build.gradle 的 Java 设置</strong>：决定项目代码能使用哪些 Java 语法特性，是对源码的 “语法约束”，不能超过 Gradle 运行 JDK 的版本。
（因为JDK版本存在向下兼容）</p>
</blockquote>
<ul>
<li>
<p><strong>允许不同，但有严格约束</strong>：项目代码版本（<code>sourceCompatibility</code>）必须 ≤ Gradle 运行 JDK 版本，否则编译失败。</p>
</li>
<li>
<p><strong>两者职责不同</strong>：</p>
<ul>
<li>Gradle 运行 JDK 是 “构建工具的运行环境”，决定了能调用哪个版本的编译器；</li>
<li>项目代码版本是 “源码语法和字节码兼容版本”，决定了代码能使用哪些 Java 特性，以及生成的字节码能在哪些设备上运行。</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用MediaRecorder+MediaProjection高效实现Android录屏]]></title>    <link>https://juejin.cn/post/7570187256105353222</link>    <guid>https://juejin.cn/post/7570187256105353222</guid>    <pubDate>2025-11-09T14:55:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570187256105353222" data-draft-id="7570187256105320454" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用MediaRecorder+MediaProjection高效实现Android录屏"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-09T14:55:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="在狂风暴雨中奔跑"/> <meta itemprop="url" content="https://juejin.cn/user/1841028550886683"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用MediaRecorder+MediaProjection高效实现Android录屏
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1841028550886683/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    在狂风暴雨中奔跑
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T14:55:22.000Z" title="Sun Nov 09 2025 14:55:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">使用MediaRecorder+MediaProjection高效实现Android录屏</h2>
<h3 data-id="heading-1">前言</h3>
<p>在 Android 平台上，实现录屏主要有两种方式：MediaCodec + MediaMuxer 组合和 MediaRecorder。前者提供了高度的灵活性和自定义能力，但实现起来相对复杂，需要手动处理视频编码、音频编码和混流等过程。
而 MediaRecorder 则是一个高级的 API，它封装了底层的音视频录制和编码过程，能显著减少开发工作量，同时保持良好的性能和兼容性。<br/>
MediaProjection是Android 5.0（API 21）引入的系统级服务，它解决了屏幕录制的核心难题——如何安全、高效地获取屏幕内容，为录屏功能提供了合法的、面向应用的标准化接口。<br/>
本文介绍如何使用MediaRecorder+MediaProjection高效实现Android录屏。</p>
<h3 data-id="heading-2">MediaRecorder 的核心：生命周期状态机</h3>
<p>使用MediaRecorder要理解 MediaRecorder 的工作原理，要掌握它的生命周期状态。MediaRecorder 的状态转换是严格的，任何不正确的操作都可能导致异常。<br/>
理解 MediaRecorder 的工作原理，首先要掌握它的生命周期状态。MediaRecorder 的状态转换是严格的，任何不正确的操作都可能导致异常。</p>
<p>1.初始状态（Initial）：这是 MediaRecorder 刚被创建时的状态。你可以通过 new MediaRecorder() 或 reset() 方法进入此状态。</p>
<p>2.设置状态（Configuring）：在这个状态，你可以调用一系列 set... 方法来配置录制参数，例如：</p>
<p>setAudioSource(MediaRecorder.AudioSource.MIC)：设置音频来源。</p>
<p>setVideoSource(MediaRecorder.VideoSource.SURFACE)：设置视频来源为 Surface。</p>
<p>setOutputFormat(MediaRecorder.OutputFormat.MPEG_4)：设置输出格式。</p>
<p>setVideoEncoder(MediaRecorder.VideoEncoder.H264)：设置视频编码器。</p>
<p>setOutputFile(filePath)：设置录制文件的路径。
在所有参数都设置完毕后，调用 prepare() 方法。</p>
<p>3.准备状态（Prepared）：调用 prepare() 后进入此状态。MediaRecorder 会进行内部检查和资源分配，确保一切都准备就绪，可以开始录制。</p>
<p>4.录制状态（Recording）：调用 start() 方法后进入此状态。此时，MediaRecorder 会开始从音视频源捕获数据、编码并写入文件。这是录制过程的核心状态。</p>
<p>5.停止状态（Stopped）：调用 stop() 方法后进入此状态。MediaRecorder 会停止录制，完成文件写入和封装，并释放部分资源。注意，一旦进入此状态，你就无法在同一个文件中继续录制。</p>
<p>6.错误状态（Error）：如果在任何状态发生错误，MediaRecorder 都会进入此状态，并抛出 RuntimeException。</p>
<p>reset()：将 MediaRecorder 恢复到初始状态，你可以重新配置并开始新的录制。</p>
<p>release()：完全释放 MediaRecorder 占用的所有资源。一旦调用，此对象将无法再使用。</p>
<p>MediaRecorder 的设计思想是易用性，它将复杂的音视频编码和封装过程抽象化，提供了一个简单的接口。</p>
<h3 data-id="heading-3">MediaProjection核心特性</h3>
<p>1.用户授权机制：必须通过系统弹窗获得用户明确授权，确保隐私安全</p>
<p>2.虚拟显示支持：创建VirtualDisplay将屏幕内容重定向到Surface</p>
<p>3.系统级集成：直接与显示系统交互，避免root权限需求</p>
<p>相比传统的root方案或ADB方案，MediaProjection提供了合法的、面向应用的标准化接口，让录屏功能可以上架正规应用商店。</p>
<h3 data-id="heading-4">打造你的录屏应用</h3>
<h4 data-id="heading-5">权限申请与用户授权</h4>
<p>录屏是一个耗时操作，为了防止应用被系统回收，应该使用前台服务来运行录制任务，并在通知栏显示录制状态。<br/>
我们创建一个前台服务RecordingService用于录屏，首先在 AndroidManifest.xml 中声明 RECORD_AUDIO 和 FOREGROUND_SERVICE 等权限。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">manifest</span> <span class="hljs-attr">...</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">application</span>
    <span class="hljs-attr">...</span>
        &lt;<span class="hljs-attr">service</span>
            <span class="hljs-attr">android:name</span>=<span class="hljs-string">".services.RecordingService"</span>
            <span class="hljs-attr">android:foregroundServiceType</span>=<span class="hljs-string">"mediaProjection"</span>
            <span class="hljs-attr">android:enabled</span>=<span class="hljs-string">"true"</span>
            <span class="hljs-attr">android:exported</span>=<span class="hljs-string">"false"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">service</span>&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.FOREGROUND_SERVICE"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.FOREGROUND_SERVICE_MEDIA_PLAYBACK"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.FOREGROUND_SERVICE_MEDIA_PROJECTION"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span>
</code></pre>
<p>然后我们在Compose函数中使用 MediaProjectionManager 和rememberLauncherForActivityResult获取屏幕捕获权限。这一步会向用户弹出一个系统对话框，请求用户授权。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">

    <span class="hljs-comment">// 1. 定义 ActivityResultLauncher</span>
    <span class="hljs-comment">//    它接收一个 Intent 作为输入，并返回一个 ActivityResult 对象</span>
    <span class="hljs-keyword">val</span> screenCaptureLauncher = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.StartActivityForResult()
    ) { result -&gt;
        <span class="hljs-keyword">val</span> activity=context.findActivity()
        <span class="hljs-keyword">if</span> (result.resultCode == Activity.RESULT_OK &amp;&amp; result.<span class="hljs-keyword">data</span> != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 用户同意录屏，启动录屏服务</span>
            viewModel.startRecordingService(activity,result.resultCode, result.<span class="hljs-keyword">data</span>!!)
            Toast.makeText(activity, activity.getString(R.string.start), Toast.LENGTH_SHORT).show()
        } <span class="hljs-keyword">else</span> {
            Toast.makeText(activity, activity.getString(R.string.rejected), Toast.LENGTH_SHORT).show()
        }
    }

    <span class="hljs-comment">// 2. 启动录屏请求的函数</span>
    <span class="hljs-keyword">val</span> startScreenCaptureRequest = remember&lt;(Context) -&gt; <span class="hljs-built_in">Unit</span>&gt; {
        { ctx -&gt;
            <span class="hljs-comment">// 获取 MediaProjectionManager</span>
            <span class="hljs-keyword">val</span> projectionManager = ctx.getSystemService(Context.MEDIA_PROJECTION_SERVICE) <span class="hljs-keyword">as</span> MediaProjectionManager

            <span class="hljs-comment">// 创建屏幕捕获意图</span>
            <span class="hljs-keyword">val</span> intent = projectionManager.createScreenCaptureIntent()
            <span class="hljs-comment">// 使用 Compose 启动器启动意图</span>
            screenCaptureLauncher.launch(intent)
        }
    }

    ...
    <span class="hljs-comment">//请求录屏</span>
    startScreenCaptureRequest(context) 
    ...
</code></pre>
<p>viewModel中的startRecordingService负责启动一个前台录屏服务。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startRecordingService</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, resultCode: <span class="hljs-type">Int</span>, <span class="hljs-keyword">data</span>: <span class="hljs-type">Intent</span>)</span></span> {
        <span class="hljs-keyword">val</span> serviceIntent = Intent(context, RecordingService::<span class="hljs-keyword">class</span>.java).apply {
            action = <span class="hljs-string">"ACTION_START"</span>
            putExtra(<span class="hljs-string">"resultCode"</span>, resultCode)
            putExtra(<span class="hljs-string">"data"</span>, <span class="hljs-keyword">data</span>)
        }
        ContextCompat.startForegroundService(context, serviceIntent)
        context.bindService(serviceIntent, connection, Context.BIND_AUTO_CREATE) <span class="hljs-comment">// 绑定Service</span>
        binder_flag=<span class="hljs-literal">true</span>
    }

</code></pre>
<h4 data-id="heading-6">录屏的核心：前台服务RecordingService</h4>
<p>录屏的核心逻辑在RecordingService中。<br/>
我们在RecordingService中的onStartCommand处理录屏请求、创建通知、注册录屏结束后的回调函数，最后才启动录屏任务。这个顺序很重要，否则无法顺利使用MediaProjection获取屏幕数据。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onStartCommand</span><span class="hljs-params">(intent: <span class="hljs-type">Intent</span>?, flags: <span class="hljs-type">Int</span>, startId: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">if</span> (intent != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">when</span> (intent.action) {
                <span class="hljs-string">"ACTION_START"</span> -&gt; {
                    <span class="hljs-keyword">if</span> (isRecording) <span class="hljs-keyword">return</span> START_NOT_STICKY
                    <span class="hljs-keyword">val</span> resultCode = intent.getIntExtra(<span class="hljs-string">"resultCode"</span>, Activity.RESULT_CANCELED)
                    <span class="hljs-comment">// 使用新的、类型安全的 getParcelableExtra 方法</span>
                    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.TIRAMISU) {
                        intent.getParcelableExtra(<span class="hljs-string">"data"</span>, Intent::<span class="hljs-keyword">class</span>.java)
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-meta">@Suppress(<span class="hljs-string">"DEPRECATION"</span>)</span>
                        intent.getParcelableExtra(<span class="hljs-string">"data"</span>)
                    }

                    <span class="hljs-keyword">if</span> (resultCode != Activity.RESULT_OK || <span class="hljs-keyword">data</span> == <span class="hljs-literal">null</span>) {
                        Toast.makeText(<span class="hljs-keyword">this</span>, <span class="hljs-string">"录屏权限被拒绝，无法启动服务"</span>, Toast.LENGTH_SHORT).show()
                        stopSelf()
                        <span class="hljs-keyword">return</span> START_NOT_STICKY
                    }
                    <span class="hljs-comment">// 确保通知渠道在创建通知前已存在</span>
                    createNotificationChannel()
                    <span class="hljs-keyword">val</span> notification = createRecordingNotification(<span class="hljs-keyword">this</span>)<span class="hljs-comment">//createNotification()</span>
                    startForeground(notificationId, notification)
                    <span class="hljs-comment">// 2. 注册匿名回调对象 (更简洁!)</span>
                    <span class="hljs-keyword">val</span> recordingCallback = <span class="hljs-keyword">object</span> : MediaProjection.Callback() {
                        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onStop</span><span class="hljs-params">()</span></span> {
                            <span class="hljs-keyword">super</span>.onStop()
                            <span class="hljs-comment">// 在用户/系统撤销权限时，执行清理逻辑</span>
                            <span class="hljs-comment">// 注意：我们必须手动注销它，尽管 stop() 会释放资源，</span>
                            <span class="hljs-comment">// 但最好在 onStop() 被调用后，立即执行清理。</span>
                            mediaProjection?.unregisterCallback(<span class="hljs-keyword">this</span>)
                        }
                    }
                    mediaProjection = mediaProjectionManager.getMediaProjection(resultCode, <span class="hljs-keyword">data</span>)
                    <span class="hljs-comment">// 注册回调，使用当前线程的 Handler (null)</span>
                    mediaProjection?.registerCallback(recordingCallback, <span class="hljs-literal">null</span>)
                    startRecording()
                }
                <span class="hljs-string">"ACTION_STOP"</span> -&gt; {
                    stopRecording()
                }

            }
        }
        <span class="hljs-keyword">return</span> START_NOT_STICKY
    }

</code></pre>
<p>我们在startRecording()中配置MediaRecorder，设置视频源、音频源、输出格式、编码器、分辨率等参数，并将 MediaProjection 捕获到的屏幕数据，通过 Surface 传递给 MediaRecorder。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startRecording</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">try</span> {

            <span class="hljs-comment">// 配置 MediaRecorder</span>
            mediaRecorder =
                <span class="hljs-keyword">if</span>(Build.VERSION.SDK_INT &gt;=Build.VERSION_CODES.S) {
                    MediaRecorder(<span class="hljs-keyword">this</span>)
                }
                <span class="hljs-keyword">else</span>{
                    MediaRecorder()
                }
                .apply {
                <span class="hljs-keyword">if</span>(recordAudioType==<span class="hljs-number">1</span>){
                    setAudioSource(MediaRecorder.AudioSource.MIC)
                    setAudioEncoder(MediaRecorder.AudioEncoder.AAC)
                }

                setVideoSource(MediaRecorder.VideoSource.SURFACE)
                setOutputFormat(MediaRecorder.OutputFormat.MPEG_4)

                <span class="hljs-keyword">if</span>(mediaUri!=<span class="hljs-literal">null</span>){
                    pfd = contentResolver.openFileDescriptor(mediaUri!!, <span class="hljs-string">"w"</span>)
                    <span class="hljs-keyword">if</span> (pfd != <span class="hljs-literal">null</span>) {
                        setOutputFile(pfd!!.fileDescriptor)
                    }
                }
                <span class="hljs-keyword">else</span>{
                    setOutputFile(filePath)
                }

                <span class="hljs-comment">// 视频配置</span>
                setVideoSize(VIDEO_WIDTH, VIDEO_HEIGHT) <span class="hljs-comment">// 示例分辨率</span>
                setVideoEncoder(MediaRecorder.VideoEncoder.H264)
                setVideoEncodingBitRate(VIDEO_BIT_RATE) <span class="hljs-comment">// 5 Mbps</span>
                setVideoFrameRate(VIDEO_FRAME_RATE)
                prepare()
            }

            <span class="hljs-comment">// 创建虚拟显示器</span>
            <span class="hljs-keyword">val</span> displayMetrics = resources.displayMetrics
            <span class="hljs-keyword">val</span> densityDpi = displayMetrics.densityDpi
            virtualDisplay = mediaProjection?.createVirtualDisplay(
                <span class="hljs-string">"RecordingDisplay"</span>,
                VIDEO_WIDTH, VIDEO_HEIGHT, <span class="hljs-comment">// 与 MediaRecorder 视频尺寸一致</span>
                densityDpi,
                DisplayManager.VIRTUAL_DISPLAY_FLAG_AUTO_MIRROR,
                mediaRecorder?.surface,
                <span class="hljs-literal">null</span>,
                <span class="hljs-literal">null</span>
            )

            mediaRecorder?.start()
            Log.d(<span class="hljs-string">"RecordingService"</span>, <span class="hljs-string">"Recording started!"</span>)
            isRecording=<span class="hljs-literal">true</span>
        } <span class="hljs-keyword">catch</span> (e: IOException) {
            Log.e(<span class="hljs-string">"RecordingService"</span>, <span class="hljs-string">"startRecording failed"</span>, e)
            stopRecording()
        }
    }

</code></pre>
<p>最后我们不要忘记释放资源的操作。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">stopRecording</span><span class="hljs-params">()</span></span> {
        isRecording=<span class="hljs-literal">false</span>
        mediaRecorder?.apply {
            stop()
            reset()
            release()
        }
        pfd?.close()
        pfd=<span class="hljs-literal">null</span>
        mediaRecorder = <span class="hljs-literal">null</span>

        virtualDisplay?.release()
        virtualDisplay = <span class="hljs-literal">null</span>

        mediaProjection?.stop()
        mediaProjection = <span class="hljs-literal">null</span>

        <span class="hljs-comment">// 1. 解除前台状态</span>
        <span class="hljs-comment">// 使用 STOP_FOREGROUND_REMOVE 标志，表示移除前台状态的同时，也移除状态栏通知。</span>
        <span class="hljs-comment">// 这是最常见且完整的解除前台状态操作。</span>
        ServiceCompat.stopForeground(
            <span class="hljs-comment">/* service = */</span> <span class="hljs-keyword">this</span>,
            <span class="hljs-comment">/* flags = */</span> ServiceCompat.STOP_FOREGROUND_REMOVE
        )
        stopSelf()
        Log.d(<span class="hljs-string">"RecordingService"</span>, <span class="hljs-string">"Recording stopped."</span>)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDestroy</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onDestroy()
        stopRecording()
    }

</code></pre>
<p>通过以上操作，我们就完成了一个完整的录屏功能。</p>
<h3 data-id="heading-7">总结</h3>
<p>MediaRecorder+MediaProjection这套组合 是 Android 平台上实现录屏功能的利器。它们通过封装复杂的底层实现，让开发者能够以更少的代码完成高质量的录制任务。完整的示例代码可以在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FIlovecat1949%2FAudioAndVideoEditor" target="_blank" title="https://github.com/Ilovecat1949/AudioAndVideoEditor" ref="nofollow noopener noreferrer">音视频编辑器</a>的录屏功能部分找到（代码写得比较潦草）。</p>
<h3 data-id="heading-8">参考</h3>
<p>1.<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fmedia%2Fgrow%2Fmedia-projection%23kotlin" target="_blank" title="https://developer.android.com/media/grow/media-projection#kotlin" ref="nofollow noopener noreferrer">Media projection谷歌官方教程</a><br/>
2.<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.google.cn%2Fmedia%2Fplatform%2Fmediarecorder%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.google.cn/media/platform/mediarecorder?hl=zh-cn" ref="nofollow noopener noreferrer">MediaRecorder 概览</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[被权重出卖的“脏数据”：GPT-oss 揭开的 OpenAI 中文训练真相]]></title>    <link>https://juejin.cn/post/7570268773333975067</link>    <guid>https://juejin.cn/post/7570268773333975067</guid>    <pubDate>2025-11-10T02:19:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570268773333975067" data-draft-id="7570299986530762779" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="被权重出卖的“脏数据”：GPT-oss 揭开的 OpenAI 中文训练真相"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-10T02:19:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            被权重出卖的“脏数据”：GPT-oss 揭开的 OpenAI 中文训练真相
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T02:19:58.000Z" title="Mon Nov 10 2025 02:19:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前段时间，OpenAI 为展示开源诚意，公开了 <strong>GPT-oss 的全部模型参数</strong>。结果没想到，这件事反倒像一次“体检报告公开”。一些开发者顺着权重数据深挖，反向分析出了模型训练阶段“吃进去”的各种素材，结论只能说—— <strong>OpenAI 中文训练数据，可能比我们想象得还要草台一些</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a32e068a16f444cb8625198e68a2343a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763347010&amp;x-signature=H8J%2FdCZbe%2Ffyq0L3yQzo71kUcfc%3D" alt="" loading="lazy"/></p>
<p>这件事最早来自今年 9 月 fi-le 的一篇研究<a href="https://link.juejin.cn?target=https%3A%2F%2Ffi-le.net%2Foss%2F" target="_blank" title="https://fi-le.net/oss/" ref="nofollow noopener noreferrer">《GPT-oss 泄露了哪些 OpenAI 的训练数据》</a>，文章作者用一套开源的分析办法，对 GPT-oss 的权重做了完整扫描：</p>
<hr/>
<h3 data-id="heading-0">🔍 第一招：看哪些词“最重”</h3>
<p>模型里面每个 token 都有自己的向量权重。哪些词越“重”（L2 Norm 越大），说明模型越容易被它们激活，也意味着训练集中它们出现得越频繁。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49bcae46dcc7409088e9294f9787273f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763347010&amp;x-signature=Wv%2FenG5FPtVdImPSTnT9jiq3QZo%3D" alt="" loading="lazy"/></p>
<p>结果： <strong>中文里出现了大量离谱词汇，权重比正常词还高。</strong></p>
<p>比如日常词汇 “因此”“描述”“设置”“代码”可以理解，但当分析范围扩展到“非 ASCII 标记”（非英语类 token）后，榜单里开始出现大量“不宜展示”的东西。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4de768a1385347d58a1f335aa5eba0e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763347010&amp;x-signature=7qSAp111wgkD%2BQIrULJeVUAKvrk%3D" alt="" loading="lazy"/></p>
<p>—— 这些并不是大家会正常去讨论的词，却在模型内部占据了“高权重位置”。</p>
<p>这意味着什么？</p>
<p>即便你输入“你好，帮我写个程序”，模型依旧要把这些乱七八糟的 token 全部加载参与推理。</p>
<p><strong>是的，它“常驻内存”。</strong></p>
<hr/>
<h3 data-id="heading-1">🔍 第二招：直接问模型“你认识这个词吗？”</h3>
<p>把一些敏感、广告、网络黑话投给模型，让它解释含义。模型一旦表现出非常“懂”，说明这些词可能在训练中多次出现过。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d0c1e1bc07e4cdf9dd309357ba41890~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763347010&amp;x-signature=o48ytclJKdXsc6htFf0p%2B8gO%2Fdk%3D" alt="" loading="lazy"/></p>
<p>测试中，GPT-5 能明确识别某些中文敏感短语，甚至能拆分出汉字来源，虽然回复时比较克制，但能看出来—— <strong>这些词至少在训练集中出现过。</strong></p>
<p>这种方法在机器学习里叫 <em>Membership Inference</em>，俗称“顺着反应推语料”。</p>
<hr/>
<h3 data-id="heading-2">🔍 第三招：做排行榜，看类别</h3>
<p>研究者把模型识别特别强的 token 做聚类，结果一分组，大致出现几种类型：</p>
<ul>
<li>一些是正常中文词汇</li>
<li>一些是网络热门词</li>
<li><strong>更多是：广告词、成人站点名、灰色领域词汇……</strong></li>
</ul>
<p>尤其是“非 ASCII 高权重 token”榜单，一看真会让人皱眉。</p>
<hr/>
<h3 data-id="heading-3">🔍 第四招：让模型玩网络梗 &amp; 怪词</h3>
<p>研究者故意丢进去一些无意义网络词、恶搞梗，看模型懂不懂。 结果表明： <strong>有些词模型懂得离谱地多，说明训练数据里出现得不算少。</strong></p>
<hr/>
<h2 data-id="heading-4">GPT-4o 曾出现同类迹象</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13ca1315ea3c4d4b9898860b89175fa8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763347010&amp;x-signature=K6cZ3EkIsgTv%2Bfz%2Bidz9kq7xsi8%3D" alt="" loading="lazy"/></p>
<p>事实上，这已经不是第一次有人质疑 OpenAI 模型的中文语料质量了。早些时候有人分析过 GPT-4o 的数据，也揭示出不少类似情况。</p>
<p>简单来说：</p>
<p>训练数据里混杂了大量不规范、不健康、不适宜出现在大规模通用模型里的东西。</p>
<hr/>
<h2 data-id="heading-5">🔬 更进一步：跨模型测试“敏感 token 识别度”</h2>
<p>研究者把 GPT-oss、GPT-5、GPT-4o 和 Claude 拿来做对比测试。</p>
<p>方法是把权重最高的 50 个敏感中文 token 输入模型，让它们判断词义及语言类型。</p>
<p>结果非常有趣：</p>
<ul>
<li>有些模型能非常准确识别</li>
<li>有些模型直接拒答</li>
<li>有些模型干脆说“不认识”</li>
</ul>
<p>规律是：<strong>越容易识别的 token，越可能在训练语料出现得多；且在</strong> <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flennart-finke%2Fgpt-oss" target="_blank" title="https://github.com/lennart-finke/gpt-oss" ref="nofollow noopener noreferrer">GitHub</a></strong> <strong>公共仓库里也更容易搜到对应黑名单记录。</strong></p>
<p>换句话说：<strong>AI 的“知识盲区”和“知识污染”，都藏在训练数据里。</strong></p>
<hr/>
<h2 data-id="heading-6">为什么会这样？</h2>
<p>理论上，模型训练会经过权重衰减，不常出现的词本该“弱化”。</p>
<p>但如果某些词在训练集中被反复出现（例如抓取 GitHub / 公网爬虫时混进来的广告、灰产词、垃圾站内容），权重就会被异常放大。</p>
<p>这类中文互联网垃圾内容的比重不算低，因此模型“吃进去多少”，几乎决定了它内部记住多少。</p>
<p>而且——<strong>越是开源模型，这些痕迹越容易被暴露出来。</strong></p>
<hr/>
<h2 data-id="heading-7">DeepSeek 做得不一样</h2>
<p>作为对照，DeepSeek 在训练阶段做过明确的“脏数据清洗”策略：</p>
<ul>
<li>过滤成人内容</li>
<li>清理广告文本</li>
<li>删除灰色信息</li>
<li>进行人工审核</li>
<li>多级过滤才进入训练集</li>
</ul>
<p>这也解释了为什么很多人觉得 DeepSeek 的中文输出比海外模型更“干净”、更本土化一些。</p>
<hr/>
<h2 data-id="heading-8">🧾 最终结论</h2>
<ul>
<li>GPT-oss 权重公开后，开发者用反向分析方法挖出了中文训练集中的大量异常 token。</li>
<li>高权重敏感词说明：训练数据里确实混入了不少广告词、垃圾内容、灰色站点信息。</li>
<li>这些污染可能来自 GitHub 的公开黑名单、爬虫抓取的中文垃圾内容等。</li>
<li>多模型对敏感 token 的识别能力差异明显，证明不同模型在数据清洗上采取了不同策略。</li>
<li>相比之下，DeepSeek 在中文语料清洗上更严格，也因此更“干净”。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring AI RAG 体验项目]]></title>    <link>https://juejin.cn/post/7570271574348152841</link>    <guid>https://juejin.cn/post/7570271574348152841</guid>    <pubDate>2025-11-09T15:53:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570271574348152841" data-draft-id="7569547273114239026" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring AI RAG 体验项目"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-09T15:53:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大象席地抽烟"/> <meta itemprop="url" content="https://juejin.cn/user/3104676567599207"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring AI RAG 体验项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3104676567599207/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大象席地抽烟
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T15:53:15.000Z" title="Sun Nov 09 2025 15:53:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Spring AI RAG 体验项目</p>
<p>一个rag应用包含如下几个阶段。为了方便搭建上线，很多阶段可以用云厂商的服务，不用自己准备资源、找开源实现啥的。本文会调用阿里云的百炼大模型。<code>Embaddings</code>、<code>Rerank</code>和<code>LLM</code>阶段调用阿里云的服务，会产生费用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26182e5a9703430194d8d42376e4e8ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn6LGh5bit5Zyw5oq954Of:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763308394&amp;x-signature=Hy%2BVXYnxXsmz2ttxaMmktRrUdS8%3D" alt="image.png" loading="lazy"/></p>
<p>原图：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fjava2ai.com%2Fdocs%2Fdev%2Fpractices%2Frag%2F%3Fspm%3D4347728f.6bbdfafa.0.0.69ee175c8cAHtp" target="_blank" title="https://java2ai.com/docs/dev/practices/rag/?spm=4347728f.6bbdfafa.0.0.69ee175c8cAHtp" ref="nofollow noopener noreferrer">java2ai.com/docs/dev/pr…</a></p>
<h2 data-id="heading-0">依赖</h2>
<p>java 21, spring boot 3.3.3, milvus 2.6.4.</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzhouruibest%2Fspring-ai-rag1" target="_blank" title="https://github.com/zhouruibest/spring-ai-rag1" ref="nofollow noopener noreferrer">github.com/zhouruibest…</a></p>
<p>spring ai alibaba 的仓库 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspring-ai-alibaba%2Fexamples" target="_blank" title="https://github.com/spring-ai-alibaba/examples" ref="nofollow noopener noreferrer">github.com/spring-ai-a…</a>
， 包含许多 Example 模块项目来介绍 Spring AI 和 Spring AI Alibaba 从基础到高级的各种用法和 AI 项目的最佳实践。</p>
<p>主要依赖如下： pom.xml</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">spring-ai.version</span>&gt;</span>1.0.0-M5<span class="hljs-tag">&lt;/<span class="hljs-name">spring-ai.version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">spring-ai-alibaba.version</span>&gt;</span>1.0.0-M5.1<span class="hljs-tag">&lt;/<span class="hljs-name">spring-ai-alibaba.version</span>&gt;</span> 
<span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-alibaba-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring-ai-alibaba.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-pdf-document-reader<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring-ai.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-milvus-store<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring-ai.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h2 data-id="heading-1">项目配置</h2>
<p>application.yaml</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">debug:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">handbook</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">dashscope:</span>
      <span class="hljs-attr">api-key:</span> <span class="hljs-string">${MY_APP_API_KEY}</span>

<span class="hljs-attr">milvus:</span>
  <span class="hljs-attr">host:</span> <span class="hljs-string">mydevcvm</span> <span class="hljs-comment"># 域名，配置了hosts</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">19530</span>
  <span class="hljs-attr">token:</span> <span class="hljs-string">"root:Milvus"</span>
  <span class="hljs-attr">database:</span> <span class="hljs-string">"ragtestdatebase"</span>
  <span class="hljs-attr">collection:</span> <span class="hljs-string">"ragtestcollection"</span>
</code></pre>
<p>MY_APP_API_KEY是配置在环境变量中的密钥，在百炼大模型的控制台取得，如下</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06ec5352e5c148d8aaed9c2254c868c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn6LGh5bit5Zyw5oq954Of:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763308394&amp;x-signature=mvk6YYC10x3jyOfs8gYjyeAKRKY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">向量数据库</h2>
<p>单机部署的，参考 <a href="https://juejin.cn/post/7565728388402905123" target="_blank" title="https://juejin.cn/post/7565728388402905123">milvus基本概念和使用</a></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VectorStoreConfig</span> {

    <span class="hljs-comment">/**
     * 定义一个名为 milvusServiceClient 的Bean，用于创建并返回一个 MilvusServiceClient 实例。
     */</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MilvusServiceClient <span class="hljs-title function_">milvusServiceClient</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 创建 MilvusServiceClient 实例</span>
            <span class="hljs-type">MilvusServiceClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MilvusServiceClient</span>(ConnectParam.newBuilder().withHost(host).withPort(port).build());

            <span class="hljs-comment">// 测试连接状态 - 尝试列出所有数据库</span>
            R&lt;ListDatabasesResponse&gt; response = client.listDatabases();

            <span class="hljs-keyword">if</span> (response.getStatus() == R.Status.Success.getCode()) {
                logger.info(<span class="hljs-string">"Milvus 连接成功! 服务器上的数据库数量: {}"</span>, response.getData().getDbNamesCount());
            } <span class="hljs-keyword">else</span> {
                logger.error(<span class="hljs-string">"Milvus 连接失败! 错误信息: {}"</span>, response.getMessage());
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Failed to connect to Milvus server: "</span> + response.getMessage());
            }

            <span class="hljs-keyword">return</span> client;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            logger.error(<span class="hljs-string">"创建 MilvusServiceClient 失败! 主机: {}, 端口: {}"</span>, host, port, e);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Failed to create MilvusServiceClient"</span>, e);
        }
    }

    <span class="hljs-comment">/**
     * 定义一个名为 vectorStore2 的Bean，用于创建并返回一个 VectorStore 实例。
     */</span>
    <span class="hljs-meta">@Bean(name = "vectorStore2")</span>
    <span class="hljs-keyword">public</span> VectorStore <span class="hljs-title function_">vectorStore</span><span class="hljs-params">(MilvusServiceClient milvusClient, EmbeddingModel embeddingModel)</span> {
        <span class="hljs-keyword">return</span> MilvusVectorStore.builder(milvusClient, embeddingModel) <span class="hljs-comment">//  嵌入模型实例，用于将文本转换为向量表示</span>
                .collectionName(collection)
                .databaseName(database)
                .embeddingDimension(<span class="hljs-number">1536</span>) <span class="hljs-comment">//  向量嵌入维度，设置为1536，这通常与使用的嵌入模型（如OpenAI的text-embedding-ada-002）匹配</span>
                .indexType(IndexType.IVF_FLAT) <span class="hljs-comment">// 设置为IVF_FLAT（倒排文件Flat索引），是一种常用的近似最近邻搜索索引</span>
                .metricType(MetricType.COSINE)
                .batchingStrategy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TokenCountBatchingStrategy</span>())
                .initializeSchema(<span class="hljs-literal">false</span>).build();
    }
}
</code></pre>
<ul>
<li>@Bean(name = "vectorStore2") 起一个名字，否则会跟默认的冲突</li>
<li>启动器<code>spring-ai-alibaba-starter</code>包含了阿里百炼（DashScope）相关模型的自动配置类，会根据配置自动创建 <code>EmbeddingModel</code> 的实现类实例, 是一个<code>文本嵌入模型</code></li>
<li><code>initializeSchema</code>参数控制在构建MilvusVectorStore时是否自动初始化数据库架构。启动项目时要事先在Milvus创建database, 不用创建collection。第一次运行项目时，initializeSchema参数为True，之后为False。</li>
</ul>
<h2 data-id="heading-3">解析文档并存到向量数据库</h2>
<p>向量数据库中的数据，可以在应用上线之前生成（可能数据量很大），也可以项目上线之后，不断调用接口投喂。</p>
<p>本例项目的 <code>resources/docs/</code> 目录下放置了一个名为 <code>handbook.pdf</code> 文件，是22年的一份关于疫情奥密克戎的问答。该文件将被解析并进行向量化处理，以便后续的检索增强生成（RAG）流程能够基于此文档内容进行检索和验证。通过这一过程，可以评估RAG在本地知识库检索中的准确性和有效性。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/insertDocuments")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">insertDocuments</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
    <span class="hljs-comment">// 1. parse document</span>
    <span class="hljs-type">DocumentReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PagePdfDocumentReader</span>(springAiResource);
    List&lt;Document&gt; documents = reader.get();
    logger.info(<span class="hljs-string">"{} documents loaded"</span>, documents.size());

    <span class="hljs-comment">// 2. split trunks</span>
    List&lt;Document&gt; splitDocuments = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TokenTextSplitter</span>().apply(documents);
    logger.info(<span class="hljs-string">"{} documents split"</span>, splitDocuments.size());

    <span class="hljs-comment">// 3. create embedding and store to vector store</span>
    logger.info(<span class="hljs-string">"create embedding and save to vector store"</span>);
    vectorStore.add(splitDocuments);

    <span class="hljs-keyword">return</span> <span class="hljs-string">"success"</span>;
}
</code></pre>
<p>当调用 <code>vectorStore.add(splitDocuments)</code> 时，内部会执行以下操作：</p>
<ol>
<li>遍历文档集合：对传入的 <code>splitDocuments</code> 列表中的每个 <code>Document</code> 对象进行处理</li>
<li>调用 EmbeddingModel：使用初始化时注入的 <code>EmbeddingModel</code> 对文档内容生成向量表示</li>
<li>向量存储：将生成的向量与文档元数据一起存储到 Milvus 向量数据库中</li>
</ol>
<p><code>/resouces/docs/</code>目录下面还包含了system-sa.st文件，内容如下。</p>
<pre><code class="hljs">你是一个专业的智能问答助手。请根据以下提供的上下文信息来回答用户的问题。

如果上下文信息不足以回答用户的问题，请直接告知用户“根据我掌握的知识，暂时无法回答这个问题”，不要编造答案。

上下文信息如下：
{{question_answer_context}}
</code></pre>
<ul>
<li>第二句： <code>如果上下文信息不足以回答用户的问题，请直接告知用户“根据我掌握的知识，暂时无法回答这个问题”，不要编造答案。</code>存在与否对结果影响很大，因为handbook.pdf文档内容很少，非常容易匹配不到。</li>
<li><code>question_answer_context</code>是默认的一个占位符</li>
</ul>
<h2 data-id="heading-4">ChatModel</h2>
<p>chatModel是基于Spring AI框架的标准聊天模型接口，通过Spring AI Alibaba自动配置机制初始化，具体实现来自阿里通义千问(DashScope)大模型服务。</p>
<p>打印了一下具体调用的那个LLM， 是<code>qwen-plus</code>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Bean构建完成后执行</span>

<span class="hljs-meta">@PostConstruct</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printInfo</span><span class="hljs-params">()</span> {
    logger.info(<span class="hljs-string">"Bean构建完成！打印信息：{}"</span>, chatModel.getDefaultOptions().toString());
}
</code></pre>
<pre><code class="hljs language-bash" lang="bash">Bean构建完成！打印信息：DashScopeChatOptions: {<span class="hljs-string">"proxyToolCalls"</span>:<span class="hljs-literal">false</span>,<span class="hljs-string">"model"</span>:<span class="hljs-string">"qwen-plus"</span>,<span class="hljs-string">"temperature"</span>:0.8,<span class="hljs-string">"enable_search"</span>:<span class="hljs-literal">false</span>,<span class="hljs-string">"incremental_output"</span>:<span class="hljs-literal">true</span>,<span class="hljs-string">"multi_model"</span>:<span class="hljs-literal">false</span>}
</code></pre>
<h2 data-id="heading-5">文档问答</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 根据用户输入的消息生成JSON格式的聊天响应。
 * 创建一个 SearchRequest 对象，设置返回最相关的前2个结果。
 * 从 systemResource 中读取提示模板。
 * 使用 ChatClient 构建聊天客户端，调用 RetrievalRerankAdvisor 进行检索和重排序，并生成最终的聊天响应内容。
 */</span>
<span class="hljs-meta">@GetMapping(value = "/ragJsonText", produces = MediaType.APPLICATION_STREAM_JSON_VALUE + ";charset=UTF-8")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">ragJsonText</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "今夕是何年？")</span> String message)</span> <span class="hljs-keyword">throws</span> IOException {
    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">searchRequest</span> <span class="hljs-operator">=</span> SearchRequest.builder().topK(<span class="hljs-number">2</span>).build();

    <span class="hljs-type">String</span> <span class="hljs-variable">promptTemplate</span> <span class="hljs-operator">=</span> systemResource.getContentAsString(StandardCharsets.UTF_8);

    <span class="hljs-keyword">return</span> ChatClient.builder(chatModel)
            .defaultAdvisors(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RetrievalRerankAdvisor</span>(vectorStore, rerankModel, searchRequest, promptTemplate, <span class="hljs-number">0.8</span>))
            .build().prompt().user(message).call().content();
}
</code></pre>
<p>RetrievalRerankAdvisor（com.alibaba.cloud.ai.advisor.RetrievalRerankAdvisor）是ChatClient的默认增强顾问，这里在使用的时候只是调整了一下参数。它的两个核心方法是<code>before</code>和<code>doRerank</code>：before方法在调用大模型前执行预处理操作：</p>
<ul>
<li>它接收用户原始查询和提示模板</li>
<li>调用vectorStore检索与用户查询相关的文档</li>
<li>调用doRerank方法对检索结果进行重排序</li>
<li>构建包含重排序后文档的上下文信息</li>
<li>将上下文信息注入到提示模板中，生成完整的提示内容</li>
<li>返回增强后的提示，供大模型生成回答使用</li>
</ul>
<p>从vectorStore检索到的数据，需要先进行重排序，目的是规避向量检索的一些局限性。重排序依赖的rerankModel要调用百炼的服务。</p>
<p>下面是不使用重排序的一个版本。基本上是对before方法的一个重新实现。期望它能够根据handbook中的Q/A回答。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">public</span> <span class="hljs-string">String</span> <span class="hljs-string">ragJsonText2(@RequestParam(value</span> <span class="hljs-string">=</span> <span class="hljs-string">"message"</span><span class="hljs-string">,</span> <span class="hljs-string">defaultValue</span> <span class="hljs-string">=</span> <span class="hljs-string">"今夕是何年？"</span><span class="hljs-string">)</span> <span class="hljs-string">String</span> <span class="hljs-string">message)</span> <span class="hljs-string">throws</span> <span class="hljs-string">IOException</span> {

    <span class="hljs-string">SearchRequest</span> <span class="hljs-string">searchRequest</span> <span class="hljs-string">=</span> <span class="hljs-string">SearchRequest.builder().query(message).topK(2).build();</span>

    <span class="hljs-string">String</span> <span class="hljs-string">promptTemplate</span> <span class="hljs-string">=</span> <span class="hljs-string">systemResource.getContentAsString(StandardCharsets.UTF_8);</span>
    <span class="hljs-string">logger.info("使用的Prompt模板:</span> {}<span class="hljs-string">", promptTemplate);
    logger.info("</span><span class="hljs-string">用户输入:</span> {}<span class="hljs-string">", message);

    // 检索相关文档用于日志
    List&lt;Document&gt; relevantDocs = vectorStore.similaritySearch(searchRequest);
    logger.info("</span><span class="hljs-string">检索到的文档数量:</span> {}<span class="hljs-string">", relevantDocs.size());

    StringBuilder contextBuilder = new StringBuilder();
    for (Document doc : relevantDocs) {
        // 可以添加文档相似度分数的日志
        Double score = doc.getScore();
        if (score instanceof Double) {
            logger.info("</span><span class="hljs-string">文档相似度分数:</span> {}<span class="hljs-string">", score);
            if (score &gt; 0.8) {
                contextBuilder.append(doc.getContent()).append("</span><span class="hljs-string">\n\n");</span>
            }
        <span class="hljs-string">}</span>
    <span class="hljs-string">}</span>
    <span class="hljs-string">String</span> <span class="hljs-string">context</span> <span class="hljs-string">=</span> <span class="hljs-string">contextBuilder.toString();</span>
    <span class="hljs-string">logger.info("构建的上下文内容:</span> {}<span class="hljs-string">", context);

    // 构建最终提交给大模型的完整prompt
    String finalPrompt = promptTemplate.replace("</span>{{<span class="hljs-string">question_answer_context</span>}}<span class="hljs-string">", context);
    logger.info("</span><span class="hljs-string">最终提交给大模型的完整Prompt:\n{}",</span> <span class="hljs-string">finalPrompt);</span>

    <span class="hljs-string">return</span> <span class="hljs-string">ChatClient.builder(chatModel).build().prompt().user("用户问题:</span> <span class="hljs-string">" + message + "</span><span class="hljs-string">\n"</span> <span class="hljs-string">+</span> <span class="hljs-string">finalPrompt).call().content();</span>
<span class="hljs-string">}</span>
</code></pre>
<h2 data-id="heading-6">测试验证</h2>
<h3 data-id="heading-7">不使用重排序</h3>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2Fmilvus2%2FragJsonText2%3Fmessage%3D%2522%25E7%258E%25B0%25E5%259C%25A8%25E6%2588%2591%25E4%25BB%25AC%25E8%25BA%25AB%25E8%25BE%25B9%25E4%25B8%2580%25E4%25BA%259B%25E8%2580%2581%25E5%25B9%25B4%25E4%25BA%25BA%25E6%2584%259F%25E6%259F%2593%25E5%2590%258E%25E7%2597%2585%25E6%2583%2585%25E5%25B0%25B1%25E5%25BE%2588%25E9%2587%258D%25EF%25BC%258C%25E9%2582%25A3%25E6%2598%25AF%25E4%25B8%258D%25E6%2598%25AF%25E8%2580%2581%25E5%25B9%25B4%25E4%25BA%25BA%25E6%2584%259F%25E6%259F%2593%25E5%2590%258E%25E4%25B8%2580%25E5%25AE%259A%25E4%25BC%259A%25E8%25B5%25B0%25E5%2590%2591%25E9%2587%258D%25E7%2597%2587%25E5%2592%258C%25E5%258D%25B1%25E9%2587%258D%25E7%2597%2587%25EF%25BC%259F" target="_blank" title="http://localhost:8080/milvus2/ragJsonText2?message=%22%E7%8E%B0%E5%9C%A8%E6%88%91%E4%BB%AC%E8%BA%AB%E8%BE%B9%E4%B8%80%E4%BA%9B%E8%80%81%E5%B9%B4%E4%BA%BA%E6%84%9F%E6%9F%93%E5%90%8E%E7%97%85%E6%83%85%E5%B0%B1%E5%BE%88%E9%87%8D%EF%BC%8C%E9%82%A3%E6%98%AF%E4%B8%8D%E6%98%AF%E8%80%81%E5%B9%B4%E4%BA%BA%E6%84%9F%E6%9F%93%E5%90%8E%E4%B8%80%E5%AE%9A%E4%BC%9A%E8%B5%B0%E5%90%91%E9%87%8D%E7%97%87%E5%92%8C%E5%8D%B1%E9%87%8D%E7%97%87%EF%BC%9F" ref="nofollow noopener noreferrer">http://localhost:8080/milvus2/ragJsonText2?message="现在我们身边一些老年人感染后病情就很重，那是不是老年人感染后一定会走向重症和危重症？</a>"</p>
<pre><code class="hljs language-markdown" lang="markdown">不是所有老年人感染后都会发展为重症或危重症，但老年人确实是高风险人群。

根据第九版诊疗指南，60岁以上的老年人被列为新冠病毒感染的高危人群，尤其是年龄越大、合并有基础疾病（如高血压、糖尿病、心衰等）的人，发展为重症的风险更高。但这并不意味着一旦感染就一定会走向重症。

关键在于<span class="hljs-strong">**及时评估和密切观察病情变化**</span>。老年人不必等到症状非常严重才就医，建议适当放宽住院评估标准。例如：

<span class="hljs-bullet">-</span> 体温超过39℃持续3天；
<span class="hljs-bullet">-</span> 活动后出现明显心慌、气促、胸闷；
<span class="hljs-bullet">-</span> 原有基础疾病（如高血压、高血糖）控制不佳；

特别是糖尿病患者，由于高血糖环境容易导致继发感染且难以控制，感染后进展为重症的风险更高，更应加强监测。

因此，老年人感染后不必过度恐慌，但也不能掉以轻心，应密切观察身体状况，一旦出现预警信号，应及时就医，做到早干预、早治疗。
</code></pre>
<h3 data-id="heading-8">使用重排序</h3>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2Fmilvus2%2FragJsonText%3Fmessage%3D%2522%25E7%258E%25B0%25E5%259C%25A8%25E6%2588%2591%25E4%25BB%25AC%25E8%25BA%25AB%25E8%25BE%25B9%25E4%25B8%2580%25E4%25BA%259B%25E8%2580%2581%25E5%25B9%25B4%25E4%25BA%25BA%25E6%2584%259F%25E6%259F%2593%25E5%2590%258E%25E7%2597%2585%25E6%2583%2585%25E5%25B0%25B1%25E5%25BE%2588%25E9%2587%258D%25EF%25BC%258C%25E9%2582%25A3%25E6%2598%25AF%25E4%25B8%258D%25E6%2598%25AF%25E8%2580%2581%25E5%25B9%25B4%25E4%25BA%25BA%25E6%2584%259F%25E6%259F%2593%25E5%2590%258E%25E4%25B8%2580%25E5%25AE%259A%25E4%25BC%259A%25E8%25B5%25B0%25E5%2590%2591%25E9%2587%258D%25E7%2597%2587%25E5%2592%258C%25E5%258D%25B1%25E9%2587%258D%25E7%2597%2587%25EF%25BC%259F" target="_blank" title="http://localhost:8080/milvus2/ragJsonText?message=%22%E7%8E%B0%E5%9C%A8%E6%88%91%E4%BB%AC%E8%BA%AB%E8%BE%B9%E4%B8%80%E4%BA%9B%E8%80%81%E5%B9%B4%E4%BA%BA%E6%84%9F%E6%9F%93%E5%90%8E%E7%97%85%E6%83%85%E5%B0%B1%E5%BE%88%E9%87%8D%EF%BC%8C%E9%82%A3%E6%98%AF%E4%B8%8D%E6%98%AF%E8%80%81%E5%B9%B4%E4%BA%BA%E6%84%9F%E6%9F%93%E5%90%8E%E4%B8%80%E5%AE%9A%E4%BC%9A%E8%B5%B0%E5%90%91%E9%87%8D%E7%97%87%E5%92%8C%E5%8D%B1%E9%87%8D%E7%97%87%EF%BC%9F" ref="nofollow noopener noreferrer">http://localhost:8080/milvus2/ragJsonText?message="现在我们身边一些老年人感染后病情就很重，那是不是老年人感染后一定会走向重症和危重症？</a>"</p>
<pre><code class="hljs">不是的，老年人感染后并不一定会走向重症或危重症。虽然老年人由于免疫力相对较弱、常伴有基础疾病（如高血压、糖尿病、心脑血管病等），确实是新冠病毒感染后发展为重症的高风险人群，但并不是所有老年感染者都会发展成重症。

通过及时接种疫苗、做好个人防护、早期监测和干预，很多老年人可以平稳度过感染期。临床数据显示，绝大多数老年感染者表现为轻症或普通型，只有少数未接种疫苗、有严重基础疾病或未能及时就医的人群才可能发展为重症或危重症。

因此，关键在于预防、早期识别症状和及时治疗。建议老年人尽早完成新冠疫苗全程接种和加强针，保持良好的生活习惯，感染后密切观察病情变化，一旦出现呼吸困难、持续高热、血氧饱和度下降等情况，应及时就医。
</code></pre>
<h3 data-id="heading-9">原文中的一页</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">Q</span>：现在我们身边一些老年人感染后病情就很重，那是不是老年人感染后一定会
走向重症和危重症？

<span class="hljs-selector-tag">A</span>：文丹宁介绍，第九版指南说的高危人群，第一个就是 <span class="hljs-number">60</span> 岁以上的老人。对
老人来说，年龄越大，有基础疾病的，风险就越大。但也并不是老年人一感染了，
就马上要去住院，这里需要做一个风险评估。老年人可以把评估指标放宽一点。
比如说，我们普通人说高烧 <span class="hljs-number">5</span> 天才去医院，那么老年人如果体温超过了 <span class="hljs-number">39</span>℃有
<span class="hljs-number">3</span> 天，或者在活动之后有心慌、气促、胸闷，或者基础疾病如高血压、高血糖、
心衰等控制不好了，还是建议及时去医院。
糖尿病人因为糖尿病更容易继发感染，出现感染后特别不容易控制。人的血
糖升高，血液就像一个病原体的培养基。所以糖尿病人很容易继发感染。我们现
在碰到的重症，糖尿病人会多一点。所以，老年人或者患有糖尿病等基础疾病的
中青年感染了奥密克戎后，一定要密切观察病情变化，不能一味硬扛。
</code></pre>
<p>比较而言，不使用的好一些。</p>
<h2 data-id="heading-10">其他</h2>
<ul>
<li>看了一些博客、仓库发现，在提示模板中加<code>“如果上下文信息不足以回答用户的问题，请直接告知用户“根据我掌握的知识，暂时无法回答这个问题”，不要编造答案。”</code>是QA这一类rag的通用的做法</li>
<li>文档内容不够丰富是回答质量差的主要原因</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Transformer架构：手撸源码实践(附带仓库地址)]]></title>    <link>https://juejin.cn/post/7570247858870173748</link>    <guid>https://juejin.cn/post/7570247858870173748</guid>    <pubDate>2025-11-09T15:44:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570247858870173748" data-draft-id="7570306250026582068" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Transformer架构：手撸源码实践(附带仓库地址)"/> <meta itemprop="keywords" content="NLP"/> <meta itemprop="datePublished" content="2025-11-09T15:44:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="黑唐僧"/> <meta itemprop="url" content="https://juejin.cn/user/2551313279487128"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Transformer架构：手撸源码实践(附带仓库地址)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2551313279487128/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    黑唐僧
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T15:44:01.000Z" title="Sun Nov 09 2025 15:44:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Transformer架构：手撸源码实践</h2>
<h3 data-id="heading-1">1. 引言</h3>
<p>Transformer架构自2017年在论文《Attention Is All You Need》中被提出以来，彻底改变了自然语言处理（NLP）领域。它摒弃了传统的循环神经网络（RNN）和卷积神经网络（CNN），完全基于注意力机制构建，成为现代大语言模型（如BERT、GPT系列）的基础架构。</p>
<p>本文将深入解析Transformer的核心组件，通过手写实现代码来帮助理解其内部工作机制。</p>
<h3 data-id="heading-2">2. Transformer整体架构</h3>
<p>Transformer采用经典的编码器-解码器架构：</p>
<pre><code class="hljs">输入序列 → 编码器 → 解码器 → 输出序列
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5db5da4faf8a421a8d9a05de6240b36b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buR5ZSQ5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763307841&amp;x-signature=HrdfLLmf52FwMTq5cQniE5LkQQI%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-3">2.1 编码器（Encoder）</h4>
<p>编码器由6个相同的层堆叠而成，每层包含两个子层：</p>
<ol>
<li><strong>多头自注意力机制（Multi-Head Self-Attention）</strong></li>
<li><strong>位置前馈网络（Position-wise Feed-Forward Networks）</strong></li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5c62f13e3624be3a58eb073b38bcd70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buR5ZSQ5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763307841&amp;x-signature=%2FOcp7kVDBhxV3%2FoLb90jpF8Ot3I%3D" alt="image.png" loading="lazy"/>
每层都使用残差连接和层归一化。</p>
<p>编码器可以表示为以下公式：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">E</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">N</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">m</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo>+</mo><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{EncLayer}(x) = \mathrm{LayerNorm}(x + \mathrm{SelfAttention}(x))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">EncLayer</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">LayerNorm</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">SelfAttention</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">E</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">N</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">m</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo>+</mo><mrow><mi mathvariant="normal">F</mi><mi mathvariant="normal">F</mi><mi mathvariant="normal">N</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{EncLayer}(x) = \mathrm{LayerNorm}(x + \mathrm{FFN}(x))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">EncLayer</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">LayerNorm</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">FFN</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span></span></span></span></span></p>
<p>完整的编码器层可以表示为：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">E</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">N</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">m</mi></mrow><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">N</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">m</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo>+</mo><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>+</mo><mrow><mi mathvariant="normal">F</mi><mi mathvariant="normal">F</mi><mi mathvariant="normal">N</mi></mrow><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">N</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">m</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo>+</mo><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{EncoderLayer}(x) = \mathrm{LayerNorm}(\mathrm{LayerNorm}(x + \mathrm{SelfAttention}(x)) + \mathrm{FFN}(\mathrm{LayerNorm}(x + \mathrm{SelfAttention}(x))))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">EncoderLayer</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">LayerNorm</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathrm">LayerNorm</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">SelfAttention</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">FFN</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathrm">LayerNorm</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">SelfAttention</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))))</span></span></span></span></span></p>
<h4 data-id="heading-4">2.2 解码器（Decoder）</h4>
<p>解码器也由6个相同的层堆叠而成，每层包含三个子层：</p>
<ol>
<li><strong>掩码多头自注意力机制（Masked Multi-Head Self-Attention）</strong></li>
<li><strong>编码器-解码器注意力机制（Encoder-Decoder Attention）</strong></li>
<li><strong>位置前馈网络（Position-wise Feed-Forward Networks）</strong></li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/303830c84ae74ceba391d90730f2a295~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buR5ZSQ5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763307841&amp;x-signature=ZscWJH1Fn7ny3arkEciCFaunY9g%3D" alt="image.png" loading="lazy"/>
同样，每层都使用残差连接和层归一化。</p>
<p>解码器层可以表示为以下公式：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">D</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>e</mi><mi>n</mi><msub><mi>c</mi><mi>o</mi></msub><mi>u</mi><mi>t</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">N</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">m</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo>+</mo><mrow><mi mathvariant="normal">M</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">k</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">S</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{DecLayer}(x, enc_out) = \mathrm{LayerNorm}(x + \mathrm{MaskedSelfAttention}(x))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">DecLayer</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">LayerNorm</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">MaskedSelfAttention</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">D</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>e</mi><mi>n</mi><msub><mi>c</mi><mi>o</mi></msub><mi>u</mi><mi>t</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">N</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">m</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo>+</mo><mrow><mi mathvariant="normal">E</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>e</mi><mi>n</mi><msub><mi>c</mi><mi>o</mi></msub><mi>u</mi><mi>t</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{DecLayer}(x, enc_out) = \mathrm{LayerNorm}(x + \mathrm{EncoderAttention}(x, enc_out))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">DecLayer</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">LayerNorm</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">EncoderAttention</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mclose">))</span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">D</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>e</mi><mi>n</mi><msub><mi>c</mi><mi>o</mi></msub><mi>u</mi><mi>t</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">N</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">m</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo>+</mo><mrow><mi mathvariant="normal">F</mi><mi mathvariant="normal">F</mi><mi mathvariant="normal">N</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{DecLayer}(x, enc_out) = \mathrm{LayerNorm}(x + \mathrm{FFN}(x))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">DecLayer</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">LayerNorm</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">FFN</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span></span></span></span></span></p>
<h3 data-id="heading-5">3. 核心组件详解</h3>
<h4 data-id="heading-6">3.1 注意力机制（Attention）</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cdd9668053e427b80dfc2f7c6c38b5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buR5ZSQ5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763307841&amp;x-signature=ObCFzMOixGW3aBFwrx5WFgCQ%2BGs%3D" alt="image.png" loading="lazy"/></p>
<p>注意力机制是Transformer的核心，其数学表达式为：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Attention</mtext><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>softmax</mtext><mrow><mo fence="true">(</mo><mfrac><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo fence="true">)</mo></mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">\text{Attention}(Q, K, V) = \text{softmax}\left(\frac{QK^T}{\sqrt{d_k}}\right)V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"/><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0895em;"><span style="top:-2.5864em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8622em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8222em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1778em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">Q</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9191em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.538em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></p>
<p>其中：</p>
<ul>
<li>Q（Query）：查询向量</li>
<li>K（Key）：键向量</li>
<li>V（Value）：值向量</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：键向量的维度</li>
</ul>
<p>缩放因子<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{\sqrt{d_k}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.3831em;vertical-align:-0.538em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.5864em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8622em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8222em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1778em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.538em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span>的作用是为了防止点积结果过大导致softmax函数梯度消失。</p>
<p>在我们的实现中，注意力机制的代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">attention</span>(<span class="hljs-params">q, k, v, mask=<span class="hljs-literal">None</span>, dropout=<span class="hljs-literal">None</span></span>):
    <span class="hljs-string">"""
    计算注意力机制
    
    Args:
        q: 查询矩阵 [batch_size, heads, seq_len, d_k]
        k: 键矩阵 [batch_size, heads, seq_len, d_k]
        v: 值矩阵 [batch_size, heads, seq_len, d_k]
        mask: 掩码矩阵，用于屏蔽某些位置
        dropout: dropout层
    
    Returns:
        tuple: (注意力输出, 注意力权重)
    """</span>
    <span class="hljs-comment"># 自注意力公式三步走</span>

    <span class="hljs-comment"># 第一步: q* k的转置除以根号d_k</span>

    <span class="hljs-comment"># 第二部: 判断是否做掩码, softmax层计算</span>

    <span class="hljs-comment"># 第三部: 乘以V</span>
    <span class="hljs-comment"># [batch_size, sqen_len, embed_dim]</span>
    embed_dim = k.size(-<span class="hljs-number">1</span>)
    <span class="hljs-comment"># 计算Q和K的点积 [batch_size, heads, seq_len, seq_len]</span>
    q_k = torch.matmul(q, k.transpose(-<span class="hljs-number">1</span>,-<span class="hljs-number">2</span>)) <span class="hljs-comment"># batch_size, sqen_len, sqen_len</span>
    <span class="hljs-comment"># 缩放点积，除以根号d_k，防止梯度消失</span>
    attn_weight = q_k / math.sqrt(embed_dim)

    <span class="hljs-keyword">if</span> mask <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
        <span class="hljs-comment"># 使用mask屏蔽不需要关注的位置，将被屏蔽位置的权重设为极小值</span>
        attn_weight = attn_weight.masked_fill(mask == <span class="hljs-number">0</span>, -<span class="hljs-number">1e9</span>)

    <span class="hljs-comment"># 对注意力权重进行softmax归一化</span>
    attn_weight = nn.functional.softmax(attn_weight, dim=-<span class="hljs-number">1</span>)

    <span class="hljs-keyword">if</span> dropout <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
        <span class="hljs-comment"># 应用dropout防止过拟合</span>
        attn_weight = dropout(attn_weight)

    <span class="hljs-comment"># 使用注意力权重对V进行加权求和</span>
    res = torch.matmul(attn_weight , v)

    <span class="hljs-keyword">return</span> res, attn_weight
</code></pre>
<h4 data-id="heading-7">3.2 多头注意力（Multi-Head Attention）</h4>
<p>为了增强模型捕捉不同位置信息的能力，Transformer使用多头注意力机制：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>MultiHead</mtext><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>Concat</mtext><mo stretchy="false">(</mo><msub><mtext>head</mtext><mn>1</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mtext>head</mtext><mi>h</mi></msub><mo stretchy="false">)</mo><msup><mi>W</mi><mi>O</mi></msup></mrow><annotation encoding="application/x-tex">\text{MultiHead}(Q, K, V) = \text{Concat}(\text{head}_1, ..., \text{head}_h)W^O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">MultiHead</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0913em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">Concat</span></span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>其中每个头计算为：
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext>head</mtext><mi>i</mi></msub><mo>=</mo><mtext>Attention</mtext><mo stretchy="false">(</mo><mi>Q</mi><msubsup><mi>W</mi><mi>i</mi><mi>Q</mi></msubsup><mo separator="true">,</mo><mi>K</mi><msubsup><mi>W</mi><mi>i</mi><mi>K</mi></msubsup><mo separator="true">,</mo><mi>V</mi><msubsup><mi>W</mi><mi>i</mi><mi>V</mi></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{head}_i = \text{Attention}(QW_i^Q, KW_i^K, VW_i^V)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.2769em;"/><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9592em;"><span style="top:-2.4231em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>多头注意力机制允许模型在不同表示子空间中并行关注信息，增强了模型的表达能力。</p>
<p>MultiHead计算的完整过程可以表示为：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">M</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">H</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">d</mi></mrow><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi></mrow><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">h</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">a</mi><msub><mi mathvariant="normal">d</mi><mn>1</mn></msub></mrow><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><mrow><mi mathvariant="normal">h</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">a</mi><msub><mi mathvariant="normal">d</mi><mi mathvariant="normal">h</mi></msub></mrow><mo stretchy="false">)</mo><msup><mi>W</mi><mi>O</mi></msup></mrow><annotation encoding="application/x-tex">\mathrm{MultiHead}(Q, K, V) = \mathrm{Concat}(\mathrm{head_1}, ..., \mathrm{head_h})W^O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">MultiHead</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0913em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">Concat</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathrm">hea</span><span class="mord"><span class="mord mathrm">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathrm mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathrm">hea</span><span class="mord"><span class="mord mathrm">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathrm mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>where</mtext><mspace width="1em"/><mrow><mi mathvariant="normal">h</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">a</mi><msub><mi mathvariant="normal">d</mi><mi mathvariant="normal">i</mi></msub></mrow><mo>=</mo><mrow><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">(</mo><mi>Q</mi><msubsup><mi>W</mi><mi>i</mi><mi>Q</mi></msubsup><mo separator="true">,</mo><mi>K</mi><msubsup><mi>W</mi><mi>i</mi><mi>K</mi></msubsup><mo separator="true">,</mo><mi>V</mi><msubsup><mi>W</mi><mi>i</mi><mi>V</mi></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{where} \quad \mathrm{head_i} = \mathrm{Attention}(QW_i^Q, KW_i^K, VW_i^V)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord text"><span class="mord">where</span></span><span class="mspace" style="margin-right:1em;"/><span class="mord"><span class="mord mathrm">hea</span><span class="mord"><span class="mord mathrm">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathrm mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.2769em;"/><span class="mord"><span class="mord mathrm">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9592em;"><span style="top:-2.4231em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<h5 data-id="heading-8">多头注意力机制结构图</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23722263d74c4bcbbcd954a7fb9321e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buR5ZSQ5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763307841&amp;x-signature=g1XbzpVMFRezLUn%2FwHXwqY%2FQebg%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiHeadAttention</span>(nn.Module):
    <span class="hljs-string">"""
    多头注意力机制
    将输入分割为多个头，分别计算注意力，然后合并结果
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, heads, embed_dim, dropout_p=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-string">"""
        初始化多头注意力
        
        Args:
            heads: 注意力头的数量
            embed_dim: 嵌入维度
            dropout_p: dropout概率
        """</span>
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-comment"># 构建属性</span>
        self.heads = heads
        self.embed_dim = embed_dim

        <span class="hljs-comment"># 确保嵌入维度可以被头数整除</span>
        <span class="hljs-keyword">assert</span> embed_dim % heads  == <span class="hljs-number">0</span>
        <span class="hljs-comment"># 计算每个头的维度</span>
        self.d_k = embed_dim // heads
        <span class="hljs-comment"># 构建4个线性层: 3个用于Q、K、V的线性变换，1个用于最终输出</span>
        self.linears = clone_modules(nn.Linear(embed_dim, embed_dim), <span class="hljs-number">4</span>)
        <span class="hljs-comment"># 实例化dropout</span>
        self.dropout = nn.Dropout(dropout_p)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, q, k, v, mask=<span class="hljs-literal">None</span></span>):
        <span class="hljs-string">"""
        前向传播
        
        Args:
            q: 查询 [batch_size, seq_len, embed_dim]
            k: 键 [batch_size, seq_len, embed_dim]
            v: 值 [batch_size, seq_len, embed_dim]
            mask: 掩码矩阵
        
        Returns:
            torch.Tensor: 多头注意力输出
        """</span>
        <span class="hljs-keyword">if</span> mask <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            <span class="hljs-comment"># 扩展mask的维度以匹配多头</span>
            mask = mask.unsqueeze(<span class="hljs-number">0</span>)
        batch_size = q.size(<span class="hljs-number">0</span>)
        heads = self.heads
        embed_dim = q.size(-<span class="hljs-number">1</span>)
        d_k = self.d_k
        <span class="hljs-comment"># 拆分多头序列 + 做线性变换</span>
        <span class="hljs-comment"># 对Q、K、V分别应用线性变换，然后reshape为(batch_size, heads, seq_len, d_k)</span>
        q, k, v = [linear(x)
                    .view(batch_size, -<span class="hljs-number">1</span>, heads, d_k)
                    .transpose(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)
                    <span class="hljs-keyword">for</span> linear,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(self.linears,(q,k,v))]

        <span class="hljs-comment"># 获取注意力机制输出</span>
        output, attn_weight = attention(q, k, v, mask, self.dropout)
        <span class="hljs-comment"># 合并多头到一个量中</span>
        <span class="hljs-comment"># 交换维度并合并heads和d_k维度</span>
        res = output.transpose(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>).contiguous().view(batch_size, -<span class="hljs-number">1</span>, embed_dim)
        <span class="hljs-comment"># 最后使用线性层做收尾处理</span>
        <span class="hljs-keyword">return</span> self.linears[-<span class="hljs-number">1</span>](res)
</code></pre>
<h4 data-id="heading-9">3.3 位置编码（Positional Encoding）</h4>
<p>由于自注意力机制本身不包含位置信息，Transformer引入位置编码来为模型提供序列中词的位置信息。</p>
<p>Transformer使用正弦和余弦函数生成位置编码：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>E</mi><mrow><mo stretchy="false">(</mo><mi>p</mi><mi>o</mi><mi>s</mi><mo separator="true">,</mo><mn>2</mn><mi>i</mi><mo stretchy="false">)</mo></mrow></msub><mo>=</mo><mi>sin</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mfrac><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mrow><mn>1000</mn><msup><mn>0</mn><mrow><mn>2</mn><mi>i</mi><mi mathvariant="normal">/</mi><msub><mi>d</mi><mtext>model</mtext></msub></mrow></msup></mrow></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">PE_{(pos,2i)} = \sin\left(\frac{pos}{10000^{2i/d_{\text{model}}}}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0385em;vertical-align:-0.3552em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"/><span class="mop">sin</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7475em;"><span style="top:-2.5648em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1000</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8932em;"><span style="top:-2.8932em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5357em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3448em;margin-left:0em;margin-right:0.1em;"><span class="pstrut" style="height:2.6944em;"/><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3496em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4352em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>E</mi><mrow><mo stretchy="false">(</mo><mi>p</mi><mi>o</mi><mi>s</mi><mo separator="true">,</mo><mn>2</mn><mi>i</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msub><mo>=</mo><mi>cos</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mfrac><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mrow><mn>1000</mn><msup><mn>0</mn><mrow><mn>2</mn><mi>i</mi><mi mathvariant="normal">/</mi><msub><mi>d</mi><mtext>model</mtext></msub></mrow></msup></mrow></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">PE_{(pos,2i+1)} = \cos\left(\frac{pos}{10000^{2i/d_{\text{model}}}}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0385em;vertical-align:-0.3552em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"/><span class="mop">cos</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7475em;"><span style="top:-2.5648em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1000</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8932em;"><span style="top:-2.8932em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5357em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3448em;margin-left:0em;margin-right:0.1em;"><span class="pstrut" style="height:2.6944em;"/><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3496em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4352em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span></span></span></span></p>
<p>其中：</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">pos</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span></span></span></span></span> 是位置</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 是维度</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mtext>model</mtext></msub></mrow><annotation encoding="application/x-tex">d_{\text{model}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 是模型维度</li>
</ul>
<p>这种设计使得模型能够学习到相对位置信息，因为对于任意固定的偏移<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span>，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>E</mi><mrow><mi>p</mi><mi>o</mi><mi>s</mi><mo>+</mo><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">PE_{pos+k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 可以表示为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>E</mi><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow></msub></mrow><annotation encoding="application/x-tex">PE_{pos}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 的线性函数。</p>
<p>位置编码的完整公式可以表示为：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>E</mi><mrow><mo stretchy="false">(</mo><mi>p</mi><mi>o</mi><mi>s</mi><mo separator="true">,</mo><mn>2</mn><mi>i</mi><mo stretchy="false">)</mo></mrow></msub><mo>=</mo><mi>sin</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mfrac><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mrow><mn>1000</mn><msup><mn>0</mn><mrow><mn>2</mn><mi>i</mi><mi mathvariant="normal">/</mi><msub><mi>d</mi><mtext>model</mtext></msub></mrow></msup></mrow></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">PE_{(pos,2i)} = \sin\left(\frac{pos}{10000^{2i/d_{\text{model}}}}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0385em;vertical-align:-0.3552em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"/><span class="mop">sin</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7475em;"><span style="top:-2.5648em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1000</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8932em;"><span style="top:-2.8932em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5357em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3448em;margin-left:0em;margin-right:0.1em;"><span class="pstrut" style="height:2.6944em;"/><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3496em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4352em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>E</mi><mrow><mo stretchy="false">(</mo><mi>p</mi><mi>o</mi><mi>s</mi><mo separator="true">,</mo><mn>2</mn><mi>i</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msub><mo>=</mo><mi>cos</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mfrac><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mrow><mn>1000</mn><msup><mn>0</mn><mrow><mn>2</mn><mi>i</mi><mi mathvariant="normal">/</mi><msub><mi>d</mi><mtext>model</mtext></msub></mrow></msup></mrow></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">PE_{(pos,2i+1)} = \cos\left(\frac{pos}{10000^{2i/d_{\text{model}}}}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0385em;vertical-align:-0.3552em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"/><span class="mop">cos</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7475em;"><span style="top:-2.5648em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1000</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8932em;"><span style="top:-2.8932em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5357em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3448em;margin-left:0em;margin-right:0.1em;"><span class="pstrut" style="height:2.6944em;"/><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3496em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4352em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span></span></span></span></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PositionalEmbedding</span>(nn.Module):
    <span class="hljs-string">"""
    位置编码层
    为序列中每个位置生成独特的编码，使模型能够利用序列顺序信息
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, max_length, embed_dim, dropout_p=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-string">"""
        初始化位置编码层
        
        Args:
            max_length: 序列最大长度
            embed_dim: 嵌入维度
            dropout_p: dropout概率
        """</span>
        <span class="hljs-built_in">super</span>().__init__()
        self.max_length = max_length
        self.embed_dim = embed_dim

        <span class="hljs-comment"># Dropout层用于防止过拟合</span>
        self.dropout = nn.Dropout(p=dropout_p)

        <span class="hljs-comment"># 创建位置编码矩阵 [max_length, embed_dim]</span>
        pe = torch.zeros(max_length, embed_dim)   <span class="hljs-comment"># [60, 512]</span>
        
        <span class="hljs-comment"># 生成位置信息 [max_length, 1]</span>
        pos = torch.arange(<span class="hljs-number">0</span>, max_length).unsqueeze(<span class="hljs-number">1</span>) <span class="hljs-comment"># [60, 1] = [[0],[1],[2], ...[59]]</span>
        <span class="hljs-comment"># 生成维度索引 0, 2, 4, ..., embed_dim-2 （只取偶数索引）</span>
        tow_i = torch.arange(<span class="hljs-number">0</span>, embed_dim, <span class="hljs-number">2</span>) <span class="hljs-comment"># [256] = 0 2 4 6 8 .. 510  , 一共256个数</span>
        <span class="hljs-comment"># 计算角度频率参数</span>
        tmp_v = torch.exp((math.log(<span class="hljs-number">10000</span>) * -tow_i / self.embed_dim)) <span class="hljs-comment"># [256]</span>

        <span class="hljs-comment"># 计算角度值：pos * 角度频率</span>
        fn_v = tmp_v * pos <span class="hljs-comment"># [256] * [60, 1]</span>

        <span class="hljs-comment"># 偶数位置使用sin编码</span>
        pe[:, <span class="hljs-number">0</span>::<span class="hljs-number">2</span>] = torch.sin(fn_v)
        <span class="hljs-comment"># 奇数位置使用cos编码</span>
        pe[:, <span class="hljs-number">1</span>::<span class="hljs-number">2</span>] = torch.cos(fn_v)

        <span class="hljs-comment"># 增加batch维度 [1, max_length, embed_dim]</span>
        pe = pe.unsqueeze(<span class="hljs-number">0</span>) <span class="hljs-comment"># [1, 60, 512]</span>

        <span class="hljs-comment"># 注册为buffer，不会被更新，但会随模型保存和加载</span>
        self.register_buffer(<span class="hljs-string">'pe'</span>, pe)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>): <span class="hljs-comment"># 输入形状：[batch_size, seq_len, embed_dim]</span>
        <span class="hljs-string">"""
        前向传播
        
        Args:
            x: 输入张量 [batch_size, seq_len, embed_dim]
        
        Returns:
            torch.Tensor: 加入位置编码的张量 [batch_size, seq_len, embed_dim]
        """</span>
        <span class="hljs-comment"># 截取与输入序列长度相等的位置编码</span>
        p_x = self.pe[:, :x.size(<span class="hljs-number">1</span>)] <span class="hljs-comment"># [1, seq_len, embed_dim]</span>
        <span class="hljs-comment"># 将位置编码与输入相加，并应用dropout</span>
        res = self.dropout(p_x + x) <span class="hljs-comment"># [batch_size, seq_len, embed_dim]</span>

        <span class="hljs-keyword">return</span> res
</code></pre>
<h4 data-id="heading-10">3.4 词嵌入与缩放（Embedding and Scaling）</h4>
<p>Transformer中的Embedding层负责将离散的词汇转换为连续向量表示。为了保持数值稳定性，Transformer在词嵌入后进行缩放操作：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext>Embedding</mtext><mtext>scaled</mtext></msub><mo>=</mo><mtext>Embedding</mtext><mo>×</mo><msqrt><msub><mi>d</mi><mtext>model</mtext></msub></msqrt></mrow><annotation encoding="application/x-tex">\text{Embedding}_{\text{scaled}} = \text{Embedding} \times \sqrt{d_{\text{model}}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9386em;vertical-align:-0.2441em;"/><span class="mord"><span class="mord text"><span class="mord">Embedding</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.242em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">scaled</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord text"><span class="mord">Embedding</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1828em;"/><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span/></span></span></span></span></span></span></span></span></p>
<p>词嵌入缩放的目的是平衡词嵌入和位置编码的数值范围，确保两者在数值上处于相近的量级，有助于模型训练的稳定性。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Embeddings</span>(nn.Module):
    <span class="hljs-string">"""
    词嵌入层
    将词汇索引转换为密集向量表示
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, input_size, embed_dim</span>):
        <span class="hljs-string">"""
        初始化词嵌入层
        
        Args:
            input_size: 词汇表大小
            embed_dim: 嵌入维度
        """</span>
        <span class="hljs-built_in">super</span>().__init__()
        self.embed_dim = embed_dim
        <span class="hljs-comment"># 创建嵌入层，将input_size个单词映射到embed_dim维向量</span>
        self.embed = nn.Embedding(input_size, embedding_dim=embed_dim)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-string">"""
        前向传播
        
        Args:
            x: 输入张量，包含词汇索引 [batch_size, seq_len]
        
        Returns:
            torch.Tensor: 词嵌入向量 [batch_size, seq_len, embed_dim]
        """</span>
        <span class="hljs-comment"># 通过嵌入层获取向量表示，并除以sqrt(embed_dim)进行缩放</span>
        <span class="hljs-comment"># 这种缩放有助于稳定梯度，特别是在位置编码加入之后</span>
        <span class="hljs-keyword">return</span> self.embed(x) / math.sqrt(self.embed_dim)
</code></pre>
<h4 data-id="heading-11">3.5 层归一化（Layer Normalization）</h4>
<p>层归一化用于稳定训练过程，加速收敛。其数学公式为：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi><mo>=</mo><mfrac><mn>1</mn><mi>H</mi></mfrac><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>H</mi></msubsup><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mu = \frac{1}{H}\sum_{i=1}^{H} x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">μ</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.3262em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>σ</mi><mn>2</mn></msup><mo>=</mo><mfrac><mn>1</mn><mi>H</mi></mfrac><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>H</mi></msubsup><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><mi>μ</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\sigma^2 = \frac{1}{H}\sum_{i=1}^{H} (x_i - \mu)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.3262em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord mathnormal">μ</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mfrac><mrow><mi>x</mi><mo>−</mo><mi>μ</mi></mrow><msqrt><mrow><msup><mi>σ</mi><mn>2</mn></msup><mo>+</mo><mi>ϵ</mi></mrow></msqrt></mfrac><mo>⊙</mo><mi>γ</mi><mo>+</mo><mi>β</mi></mrow><annotation encoding="application/x-tex">y = \frac{x - \mu}{\sqrt{\sigma^2 + \epsilon}} \odot \gamma + \beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.3924em;vertical-align:-0.538em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8544em;"><span style="top:-2.5445em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9221em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7463em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">ϵ</span></span></span><span style="top:-2.8821em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1179em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">μ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.538em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⊙</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span></span></span></p>
<p>其中：</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi></mrow><annotation encoding="application/x-tex">\mu</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">μ</span></span></span></span></span> 是均值</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>σ</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\sigma^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span> 是方差</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">ϵ</span></span></span></span></span> 是一个小常数，防止除零</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi></mrow><annotation encoding="application/x-tex">\gamma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span></span></span> 是可学习的缩放和偏移参数</li>
</ul>
<p>层归一化的完整计算过程可以表示为：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">N</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">m</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi>x</mi><mo>−</mo><mi>μ</mi></mrow><msqrt><mrow><msup><mi>σ</mi><mn>2</mn></msup><mo>+</mo><mi>ϵ</mi></mrow></msqrt></mfrac><mo>⊙</mo><mi>γ</mi><mo>+</mo><mi>β</mi></mrow><annotation encoding="application/x-tex">\mathrm{LayerNorm}(x) = \frac{x - \mu}{\sqrt{\sigma^2 + \epsilon}} \odot \gamma + \beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">LayerNorm</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.3924em;vertical-align:-0.538em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8544em;"><span style="top:-2.5445em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9221em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7463em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">ϵ</span></span></span><span style="top:-2.8821em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1179em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">μ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.538em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⊙</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span></span></span></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LayerNorm</span>(nn.Module):
    <span class="hljs-string">"""
    层归一化
    对每个样本的特征进行归一化，而不是对批次维度进行归一化
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, embed_dim, eps=<span class="hljs-number">1e-6</span></span>):
        <span class="hljs-string">"""
        初始化层归一化
        
        Args:
            embed_dim: 嵌入维度
            eps: 防止除零的小值
        """</span>
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-comment"># 创建可学习的缩放参数W，初始化为全1矩阵</span>
        self.w = nn.Parameter(torch.ones(embed_dim))
        <span class="hljs-comment"># 创建可学习的偏移参数B，初始化为全0矩阵</span>
        self.b = nn.Parameter(torch.zeros(embed_dim))
        <span class="hljs-comment"># 防止除零的小值</span>
        self.eps = eps

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-string">"""
        前向传播
        
        Args:
            x: 输入张量 [batch_size, seq_len, embed_dim]
        
        Returns:
            torch.Tensor: 归一化后的张量
        """</span>
        <span class="hljs-comment"># 计算平均数</span>
        x_mean = torch.mean(x, keepdim=<span class="hljs-literal">True</span>, dim=-<span class="hljs-number">1</span>) <span class="hljs-comment"># keepdim=True , 保持形状一致</span>
        <span class="hljs-comment"># 计算标准差</span>
        x_std = torch.std(x, keepdim=<span class="hljs-literal">True</span>, dim=-<span class="hljs-number">1</span>)
        <span class="hljs-comment"># 计算 (x-平均数) / (标准差+eps) = 标准化后的x</span>
        res = (x - x_mean) / (x_std + self.eps)  <span class="hljs-comment"># 修正了原代码中的运算符优先级问题</span>
        <span class="hljs-comment"># 返回 W * x + b，应用可学习的缩放和偏移</span>
        <span class="hljs-keyword">return</span> self.w * res + self.b
</code></pre>
<h4 data-id="heading-12">3.6 前馈神经网络（Feed-Forward Networks）</h4>
<p>前馈网络对每个位置的表示进行非线性变换。其数学公式为：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">F</mi><mi mathvariant="normal">F</mi><mi mathvariant="normal">N</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mi>x</mi><msub><mi>W</mi><mn>1</mn></msub><mo>+</mo><msub><mi>b</mi><mn>1</mn></msub><mo stretchy="false">)</mo><msub><mi>W</mi><mn>2</mn></msub><mo>+</mo><msub><mi>b</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\mathrm{FFN}(x) = \max(0, xW_1 + b_1)W_2 + b_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">FFN</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mop">max</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">x</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></p>
<p>其中：</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mn>1</mn></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub><mo>×</mo><msub><mi>d</mi><mrow><mi>f</mi><mi>f</mi></mrow></msub></mrow></msup></mrow><annotation encoding="application/x-tex">W_1 \in \mathbb{R}^{d_{model} \times d_{ff}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8491em;"/><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">ff</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2901em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mn>2</mn></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mrow><mi>f</mi><mi>f</mi></mrow></msub><mo>×</mo><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub></mrow></msup></mrow><annotation encoding="application/x-tex">W_2 \in \mathbb{R}^{d_{ff} \times d_{model}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8491em;"/><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">ff</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2901em;"><span/></span></span></span></span></span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> 是参数矩阵</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">b_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">b_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 是偏置向量</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>f</mi><mi>f</mi></mrow></msub><mo>=</mo><mn>2048</mn></mrow><annotation encoding="application/x-tex">d_{ff} = 2048</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">ff</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2048</span></span></span></span></span> 是前馈网络的隐藏层维度</li>
</ul>
<p>前馈网络的完整计算过程可以表示为：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">F</mi><mi mathvariant="normal">F</mi><mi mathvariant="normal">N</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mi mathvariant="normal">R</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">L</mi><mi mathvariant="normal">U</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><msub><mi>W</mi><mn>1</mn></msub><mo>+</mo><msub><mi>b</mi><mn>1</mn></msub><mo stretchy="false">)</mo><msub><mi>W</mi><mn>2</mn></msub><mo>+</mo><msub><mi>b</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\mathrm{FFN}(x) = \mathrm{ReLU}(xW_1 + b_1)W_2 + b_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">FFN</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">ReLU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FeedForward</span>(nn.Module):
    <span class="hljs-string">"""
    前馈神经网络
    在Transformer中用于对每个位置的表示进行非线性变换
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, embed_dim, hidden_size=<span class="hljs-number">2048</span>, dropout_p = <span class="hljs-number">0.1</span></span>):
        <span class="hljs-string">"""
        初始化前馈网络
        
        Args:
            embed_dim: 嵌入维度
            hidden_size: 隐藏层大小，默认为2048
            dropout_p: dropout概率
        """</span>
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-comment"># 两个线性层, 外加ReLU激活函数和dropout随机失活</span>
        <span class="hljs-comment"># 第一个线性层将维度从embed_dim扩展到hidden_size</span>
        self.linear1 = nn.Linear(embed_dim, hidden_size)

        <span class="hljs-comment"># ReLU激活函数</span>
        self.relu = nn.ReLU()

        <span class="hljs-comment"># Dropout层用于防止过拟合</span>
        self.dropout = nn.Dropout(p=dropout_p)

        <span class="hljs-comment"># 第二个线性层将维度从hidden_size压缩回embed_dim</span>
        self.linear2 = nn.Linear(hidden_size, embed_dim)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-string">"""
        前向传播
        
        Args:
            x: 输入张量 [batch_size, seq_len, embed_dim]
        
        Returns:
            torch.Tensor: 前馈网络输出
        """</span>
        <span class="hljs-comment"># 第一层线性变换</span>
        x = self.linear1(x)

        <span class="hljs-comment"># ReLU激活</span>
        x = self.relu(x)

        <span class="hljs-comment"># Dropout防止过拟合</span>
        x = self.dropout(x)

        <span class="hljs-comment"># 第二层线性变换</span>
        x = self.linear2(x)

        <span class="hljs-keyword">return</span> x
</code></pre>
<h4 data-id="heading-13">3.7 子层连接（Sublayer Connection）</h4>
<p>子层连接实现残差连接和层归一化。其数学公式为：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">N</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">m</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo>+</mo><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{Sublayer}(x) = \mathrm{LayerNorm}(x + \mathrm{Sublayer}(x))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">Sublayer</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">LayerNorm</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">Sublayer</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span></span></span></span></span></p>
<p>其中Sublayer(x)可以是自注意力层或前馈网络层。</p>
<p>子层连接的完整计算过程可以表示为：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">)</mo><mo>=</mo><mrow><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">N</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">m</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo>+</mo><mrow><mi mathvariant="normal">D</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">p</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">t</mi></mrow><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{SublayerConnection}(x, \mathrm{Sublayer}) = \mathrm{LayerNorm}(x + \mathrm{Dropout}(\mathrm{Sublayer}(x)))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">SublayerConnection</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathrm">Sublayer</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">LayerNorm</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">Dropout</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathrm">Sublayer</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)))</span></span></span></span></span></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SubLayers</span>(nn.Module):
    <span class="hljs-string">"""
    子层连接模块
    实现残差连接和层归一化
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, embed_dim, dropout_p=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-string">"""
        初始化子层连接
        
        Args:
            embed_dim: 嵌入维度
            dropout_p: dropout概率
        """</span>
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-comment"># 实例化层归一化函数</span>
        self.norm = LayerNorm(embed_dim)

        <span class="hljs-comment"># Dropout层</span>
        self.dropout = nn.Dropout(p=dropout_p)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, layer_fn</span>):
        <span class="hljs-string">"""
        前向传播
        
        Args:
            x: 输入张量
            layer_fn: 要应用的层函数（如注意力层或前馈网络）
        
        Returns:
            torch.Tensor: 经过残差连接和层归一化的输出
        """</span>
        <span class="hljs-comment"># 对输入应用指定的层函数，然后进行层归一化和dropout</span>
        <span class="hljs-comment"># 最后与原始输入进行残差连接（x + res）</span>
        res  = self.dropout(self.norm(layer_fn(x)))
        <span class="hljs-keyword">return</span> x + res
</code></pre>
<h3 data-id="heading-14">4. 编码器实现</h3>
<p>编码器由多个编码器层堆叠而成：</p>
<p>编码器层的完整计算过程可以表示为：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">E</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">)</mo><mo separator="true">,</mo><mrow><mi mathvariant="normal">F</mi><mi mathvariant="normal">F</mi><mi mathvariant="normal">N</mi></mrow><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{EncoderLayer}(x) = \mathrm{SublayerConnection}(\mathrm{SublayerConnection}(x, \mathrm{SelfAttention}), \mathrm{FFN})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">EncoderLayer</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">SublayerConnection</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathrm">SublayerConnection</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathrm">SelfAttention</span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathrm">FFN</span></span><span class="mclose">)</span></span></span></span></span></p>
<p>编码器的完整计算过程可以表示为：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">E</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">N</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">m</mi></mrow><mo stretchy="false">(</mo><msub><mrow><mi mathvariant="normal">E</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mi>N</mi></msub><mo stretchy="false">(</mo><mo>⋯</mo><mo stretchy="false">(</mo><msub><mrow><mi mathvariant="normal">E</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mn>1</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>⋯</mo><mtext> </mtext><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{Encoder}(x) = \mathrm{LayerNorm}(\mathrm{EncoderLayer}_N(\cdots(\mathrm{EncoderLayer}_1(x))\cdots))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">Encoder</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">LayerNorm</span></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm">EncoderLayer</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2342em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm">EncoderLayer</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">⋯</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mclose">))</span></span></span></span></span></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EncoderLayer</span>(nn.Module):
    <span class="hljs-string">"""
    编码器层
    包含自注意力层和前馈神经网络层
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, embed_dim, heads, dropout_p=<span class="hljs-number">0.1</span>, hidden_size=<span class="hljs-number">2048</span></span>):
        <span class="hljs-string">"""
        初始化编码器层
        
        Args:
            embed_dim: 嵌入维度
            heads: 注意力头数
            dropout_p: dropout概率
            hidden_size: 前馈网络隐藏层大小
        """</span>
        <span class="hljs-built_in">super</span>().__init__()

        <span class="hljs-comment"># 多头自注意力机制</span>
        self.multi_head_attn = MultiHeadAttention(heads=heads, embed_dim=embed_dim, dropout_p=dropout_p)

        <span class="hljs-comment"># 前馈神经网络</span>
        self.feed_ward = FeedForward(embed_dim=embed_dim, hidden_size=hidden_size, dropout_p=dropout_p)

        <span class="hljs-comment"># 两个子层连接模块：自注意力和前馈网络</span>
        self.layers = clone_modules(SubLayers(embed_dim=embed_dim, dropout_p=dropout_p), N=<span class="hljs-number">2</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, mask=<span class="hljs-literal">None</span></span>):
        <span class="hljs-string">"""
        前向传播
        
        Args:
            x: 输入张量 [batch_size, seq_len, embed_dim]
            mask: 掩码张量，用于屏蔽无效位置
        
        Returns:
            torch.Tensor: 编码器层输出
        """</span>
        <span class="hljs-comment"># 第一层：自注意力机制</span>
        x = self.layers[<span class="hljs-number">0</span>](x, <span class="hljs-keyword">lambda</span> x: self.multi_head_attn(x, x, x, mask))

        <span class="hljs-comment"># 第二层：前馈神经网络</span>
        x = self.layers[<span class="hljs-number">1</span>](x, self.feed_ward)
        
        <span class="hljs-keyword">return</span> x

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Encoder</span>(nn.Module):
    <span class="hljs-string">"""
    编码器
    由多个编码器层堆叠组成
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, embed_dim, layer, N</span>):
        <span class="hljs-string">"""
        初始化编码器
        
        Args:
            embed_dim: 嵌入维度
            layer: 编码器层模板
            N: 编码器层数
        """</span>
        <span class="hljs-built_in">super</span>().__init__()

        <span class="hljs-comment"># 克隆N个相同的编码器层</span>
        self.encoder_layers = clone_modules(layer, N)

        <span class="hljs-comment"># 输出层归一化</span>
        self.norm = LayerNorm(embed_dim=embed_dim)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, mask=<span class="hljs-literal">None</span></span>):
        <span class="hljs-string">"""
        前向传播
        
        Args:
            x: 输入张量 [batch_size, seq_len, embed_dim]
            mask: 掩码张量
        
        Returns:
            torch.Tensor: 编码器输出
        """</span>
        <span class="hljs-comment"># 依次通过每个编码器层</span>
        <span class="hljs-keyword">for</span> layer <span class="hljs-keyword">in</span> self.encoder_layers:
            x = layer(x, mask=mask)
        <span class="hljs-comment"># 最终层归一化</span>
        res = self.norm(x)
        <span class="hljs-keyword">return</span> res
</code></pre>
<h3 data-id="heading-15">5. 解码器实现</h3>
<h4 data-id="heading-16">5.1 解码器实现</h4>
<p>解码器也由多个解码器层堆叠而成，但结构比编码器更复杂：</p>
<p>解码器层的完整计算过程可以表示为：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">D</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>e</mi><mi>n</mi><msub><mi>c</mi><mi>o</mi></msub><mi>u</mi><mi>t</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mrow><mi mathvariant="normal">M</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">k</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">S</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">)</mo><mo separator="true">,</mo><mrow><mi mathvariant="normal">E</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">)</mo><mo separator="true">,</mo><mrow><mi mathvariant="normal">F</mi><mi mathvariant="normal">F</mi><mi mathvariant="normal">N</mi></mrow><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{DecoderLayer}(x, enc_out) = \mathrm{SublayerConnection}(\mathrm{SublayerConnection}(\mathrm{SublayerConnection}(x, \mathrm{MaskedSelfAttention}), \mathrm{EncoderAttention}), \mathrm{FFN})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">DecoderLayer</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">SublayerConnection</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathrm">SublayerConnection</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathrm">SublayerConnection</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathrm">MaskedSelfAttention</span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathrm">EncoderAttention</span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathrm">FFN</span></span><span class="mclose">)</span></span></span></span></span></p>
<p>解码器的完整计算过程可以表示为：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">D</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>e</mi><mi>n</mi><msub><mi>c</mi><mi>o</mi></msub><mi>u</mi><mi>t</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">N</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">m</mi></mrow><mo stretchy="false">(</mo><msub><mrow><mi mathvariant="normal">D</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mi>N</mi></msub><mo stretchy="false">(</mo><mo>⋯</mo><mo stretchy="false">(</mo><msub><mrow><mi mathvariant="normal">D</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mn>1</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>e</mi><mi>n</mi><msub><mi>c</mi><mi>o</mi></msub><mi>u</mi><mi>t</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>⋯</mo><mtext> </mtext><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{Decoder}(x, enc_out) = \mathrm{LayerNorm}(\mathrm{DecoderLayer}_N(\cdots(\mathrm{DecoderLayer}_1(x, enc_out))\cdots))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">Decoder</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">LayerNorm</span></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm">DecoderLayer</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2342em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm">DecoderLayer</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mclose">))</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">⋯</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mclose">))</span></span></span></span></span></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DecoderLayer</span>(nn.Module):
    <span class="hljs-string">"""
    解码器层
    包含自注意力层、编码器-解码器注意力层和前馈网络
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, embed_dim, heads, feed_forward_hidden_size, dropout_p=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-string">"""
        初始化解码器层
        
        Args:
            embed_dim: 嵌入维度
            heads: 注意力头数
            feed_forward_hidden_size: 前馈网络隐藏层大小
            dropout_p: dropout概率
        """</span>
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-comment"># 第一个自注意力机制：目标序列的自注意力（需要掩码）</span>
        self.multi_head_attn = MultiHeadAttention(heads=heads, embed_dim=embed_dim, dropout_p=dropout_p)
        <span class="hljs-comment"># 三个子层连接模块：自注意力、编码器-解码器注意力、前馈网络</span>
        self.layers = clone_modules(SubLayers(embed_dim=embed_dim, dropout_p=dropout_p), N=<span class="hljs-number">3</span>)

        <span class="hljs-comment"># 前馈神经网络</span>
        self.feed_forward = FeedForward(embed_dim=embed_dim, dropout_p=dropout_p, hidden_size=feed_forward_hidden_size)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, q, k, v, target_mask=<span class="hljs-literal">None</span>, source_mask=<span class="hljs-literal">None</span></span>):
        <span class="hljs-string">"""
        前向传播
        
        Args:
            q: 查询向量（目标序列）
            k: 键向量（编码器输出）
            v: 值向量（编码器输出）
            target_mask: 目标序列掩码（防止未来信息泄露）
            source_mask: 源序列掩码
        
        Returns:
            torch.Tensor: 解码器层输出
        """</span>
        <span class="hljs-comment"># 第一层：目标序列的自注意力（使用target_mask防止看到未来信息）</span>
        res_1 = self.layers[<span class="hljs-number">0</span>](q, <span class="hljs-keyword">lambda</span> x: self.multi_head_attn(x, x, x, target_mask))

        <span class="hljs-comment"># 第二层：编码器-解码器注意力（查询来自前一层，键值来自编码器输出）</span>
        res_2 = self.layers[<span class="hljs-number">1</span>](res_1, <span class="hljs-keyword">lambda</span> x: self.multi_head_attn(x, k, v, source_mask))

        <span class="hljs-comment"># 第三层：前馈神经网络</span>
        res_3 = self.layers[<span class="hljs-number">2</span>](res_2, self.feed_forward)

        <span class="hljs-keyword">return</span> res_3

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Decoder</span>(nn.Module):
    <span class="hljs-string">"""
    解码器
    由多个解码器层堆叠而成
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, embed_dim, decoder_layer, n</span>):
        <span class="hljs-string">"""
        初始化解码器
        
        Args:
            embed_dim: 嵌入维度
            decoder_layer: 解码器层模板
            n: 解码器层数
        """</span>
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-comment"># 输出层归一化</span>
        self.norm = LayerNorm(embed_dim=embed_dim)

        <span class="hljs-comment"># 克隆N个解码器层</span>
        self.encoder_layers = clone_modules(decoder_layer, n)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, q, k, v, target_mask=<span class="hljs-literal">None</span>, source_mask=<span class="hljs-literal">None</span></span>):
        <span class="hljs-string">"""
        前向传播
        
        Args:
            q: 查询向量（目标序列）
            k: 键向量（编码器输出）
            v: 值向量（编码器输出）
            target_mask: 目标序列掩码
            source_mask: 源序列掩码
        
        Returns:
            torch.Tensor: 解码器输出
        """</span>
        <span class="hljs-comment"># 初始输入为查询向量</span>
        res = q
        <span class="hljs-comment"># 依次通过每个解码器层</span>
        <span class="hljs-keyword">for</span> layer <span class="hljs-keyword">in</span> self.encoder_layers:
            res = layer(q, k, v, target_mask, source_mask)

        <span class="hljs-comment"># 最终层归一化</span>
        res = self.norm(res)

        <span class="hljs-keyword">return</span> res
</code></pre>
<h4 data-id="heading-17">5.2输出部分介绍</h4>
<p>输出部分包含: * 线性层 * softmax层</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6350eb04d56e46f392a434050fc529e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buR5ZSQ5YOn:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763307841&amp;x-signature=DjmvdsP6qwqwcVKF%2BGJiotVhZdw%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-18">5.2.1 线性层的作用</h5>
<ul>
<li>通过对上一步的线性变化得到指定维度的输出, 也就是转换维度的作用.</li>
</ul>
<h5 data-id="heading-19">5.2.2 softmax层的作用</h5>
<ul>
<li>使最后一维的向量中的数字缩放到0-1的概率值域内, 并满足他们的和为1.</li>
</ul>
<h5 data-id="heading-20">5.2.3 线性层和softmax层的代码分析</h5>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 解码器类 Generator 实现思路分析</span>
<span class="hljs-comment"># init函数 (self, d_model, vocab_size)</span>
    <span class="hljs-comment"># 定义线性层self.project</span>
<span class="hljs-comment"># forward函数 (self, x)</span>
    <span class="hljs-comment"># 数据 F.log_softmax(self.project(x), dim=-1)</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Generator</span>(nn.<span class="hljs-title class_">Module</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>, d_model, vocab_size</span>):
        <span class="hljs-comment"># 参数d_model 线性层输入特征尺寸大小</span>
        <span class="hljs-comment"># 参数vocab_size 线层输出尺寸大小</span>
        <span class="hljs-variable language_">super</span>(<span class="hljs-title class_">Generator</span>, <span class="hljs-variable language_">self</span>).__init__()
        <span class="hljs-comment"># 定义线性层</span>
        <span class="hljs-variable language_">self</span>.project = nn.<span class="hljs-title class_">Linear</span>(d_model, vocab_size)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>, x</span>):
        <span class="hljs-comment"># 数据经过线性层 最后一个维度归一化 log方式</span>
        x = F.log_softmax(<span class="hljs-variable language_">self</span>.project(x), dim=-<span class="hljs-number">1</span>)
        <span class="hljs-keyword">return</span> x
</code></pre>
<ul>
<li>nn.Linear演示:</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">&gt;&gt;&gt; <span class="hljs-attr">m</span> = nn.Linear(<span class="hljs-number">20</span>, <span class="hljs-number">30</span>)
&gt;&gt;&gt; <span class="hljs-attr">input</span> = torch.randn(<span class="hljs-number">128</span>, <span class="hljs-number">20</span>)
&gt;&gt;&gt; <span class="hljs-attr">output</span> = m(input)
&gt;&gt;&gt; print(output.size())
torch.Size(<span class="hljs-section">[128, 30]</span>)
</code></pre>
<h3 data-id="heading-21">6. 完整Transformer模型</h3>
<p>将编码器和解码器组合成完整的Transformer模型：</p>
<p>完整的Transformer模型可以表示为：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">T</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mi mathvariant="normal">D</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">E</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{Transformer}(X, Y) = \mathrm{Decoder}(\mathrm{Encoder}(X), Y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">Transformer</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">Decoder</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathrm">Encoder</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span></span></span></span></span></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTransform</span>(nn.Module):
    <span class="hljs-string">"""
    Transformer模型实现
    包含编码器和解码器两部分
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, heads, embed_dim, feed_hidden_size, dropout_p=<span class="hljs-number">0.1</span></span>):
        <span class="hljs-string">"""
        初始化Transformer模型
        
        Args:
            heads: 注意力头数
            embed_dim: 嵌入维度
            feed_hidden_size: 前馈网络隐藏层大小
            dropout_p: dropout概率
        """</span>
        <span class="hljs-built_in">super</span>().__init__()

        <span class="hljs-comment"># 创建编码器层模板</span>
        encoder_layer = EncoderLayer(heads=heads, embed_dim=embed_dim,
                                     hidden_size=feed_hidden_size, dropout_p=dropout_p)
        <span class="hljs-comment"># 创建包含6层的编码器</span>
        self.encoder = Encoder(layer=encoder_layer, N=<span class="hljs-number">6</span>, embed_dim=embed_dim)

        <span class="hljs-comment"># 创建解码器层模板</span>
        decoder_layer = DecoderLayer(heads=heads, embed_dim=embed_dim,
                                     feed_forward_hidden_size=feed_hidden_size, dropout_p=dropout_p)

        <span class="hljs-comment"># 创建包含6层的解码器</span>
        self.decoder = Decoder(decoder_layer=decoder_layer, n=<span class="hljs-number">6</span>, embed_dim=embed_dim)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, y, target_mask, source_mask</span>):
        <span class="hljs-string">"""
        前向传播
        
        Args:
            x: 源序列输入 [batch_size, src_seq_len, embed_dim]
            y: 目标序列输入 [batch_size, tgt_seq_len, embed_dim]
            target_mask: 目标序列掩码（防止未来信息泄露）
            source_mask: 源序列掩码
        
        Returns:
            torch.Tensor: 解码器输出 [batch_size, tgt_seq_len, embed_dim]
        """</span>
        <span class="hljs-comment"># 编码器处理源序列</span>
        encoder_output = self.encoder(x, source_mask)

        <span class="hljs-comment"># 解码器处理目标序列，使用编码器输出作为键和值</span>
        decoder_output = self.decoder(y, encoder_output, encoder_output, target_mask)

        <span class="hljs-keyword">return</span> decoder_output
</code></pre>
<h3 data-id="heading-22">7. 公式与代码实现对照详解</h3>
<p>为了更好地理解Transformer中各公式的实现，我们在此详细对照每个重要公式与其对应的代码实现。</p>
<h4 data-id="heading-23">7.1 注意力机制公式对照</h4>
<p>注意力机制的核心公式：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Attention</mtext><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>softmax</mtext><mrow><mo fence="true">(</mo><mfrac><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo fence="true">)</mo></mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">\text{Attention}(Q, K, V) = \text{softmax}\left(\frac{QK^T}{\sqrt{d_k}}\right)V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"/><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0895em;"><span style="top:-2.5864em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8622em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8222em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1778em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">Q</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9191em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.538em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></p>
<p>对应的代码实现：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">attention</span>(<span class="hljs-params">q, k, v, mask=<span class="hljs-literal">None</span>, dropout=<span class="hljs-literal">None</span></span>):
    <span class="hljs-comment"># 获取维度</span>
    embed_dim = k.size(-<span class="hljs-number">1</span>)
    
    <span class="hljs-comment"># 计算 QK^T</span>
    q_k = torch.matmul(q, k.transpose(-<span class="hljs-number">1</span>,-<span class="hljs-number">2</span>))
    
    <span class="hljs-comment"># 缩放操作：除以 sqrt(d_k)</span>
    attn_weight = q_k / math.sqrt(embed_dim)
    
    <span class="hljs-comment"># 应用掩码（如果存在）</span>
    <span class="hljs-keyword">if</span> mask <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
        attn_weight = attn_weight.masked_fill(mask == <span class="hljs-number">0</span>, -<span class="hljs-number">1e9</span>)
    
    <span class="hljs-comment"># softmax归一化</span>
    attn_weight = nn.functional.softmax(attn_weight, dim=-<span class="hljs-number">1</span>)
    
    <span class="hljs-comment"># 应用dropout（如果存在）</span>
    <span class="hljs-keyword">if</span> dropout <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
        attn_weight = dropout(attn_weight)
    
    <span class="hljs-comment"># 乘以 V</span>
    res = torch.matmul(attn_weight , v)
    
    <span class="hljs-keyword">return</span> res, attn_weight
</code></pre>
<h4 data-id="heading-24">7.2 多头注意力公式对照</h4>
<p>多头注意力机制的公式：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>MultiHead</mtext><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>Concat</mtext><mo stretchy="false">(</mo><msub><mtext>head</mtext><mn>1</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mtext>head</mtext><mi>h</mi></msub><mo stretchy="false">)</mo><msup><mi>W</mi><mi>O</mi></msup></mrow><annotation encoding="application/x-tex">\text{MultiHead}(Q, K, V) = \text{Concat}(\text{head}_1, ..., \text{head}_h)W^O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">MultiHead</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0913em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">Concat</span></span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>where</mtext><mspace width="1em"/><mrow><mi mathvariant="normal">h</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">a</mi><msub><mi mathvariant="normal">d</mi><mi mathvariant="normal">i</mi></msub></mrow><mo>=</mo><mrow><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">(</mo><mi>Q</mi><msubsup><mi>W</mi><mi>i</mi><mi>Q</mi></msubsup><mo separator="true">,</mo><mi>K</mi><msubsup><mi>W</mi><mi>i</mi><mi>K</mi></msubsup><mo separator="true">,</mo><mi>V</mi><msubsup><mi>W</mi><mi>i</mi><mi>V</mi></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{where} \quad \mathrm{head_i} = \mathrm{Attention}(QW_i^Q, KW_i^K, VW_i^V)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord text"><span class="mord">where</span></span><span class="mspace" style="margin-right:1em;"/><span class="mord"><span class="mord mathrm">hea</span><span class="mord"><span class="mord mathrm">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathrm mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.2769em;"/><span class="mord"><span class="mord mathrm">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9592em;"><span style="top:-2.4231em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>对应的代码实现（MultiHeadAttention类的forward方法）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, q, k, v, mask=<span class="hljs-literal">None</span></span>):
    <span class="hljs-keyword">if</span> mask <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
        <span class="hljs-comment"># 扩展mask的维度以匹配多头</span>
        mask = mask.unsqueeze(<span class="hljs-number">0</span>)
    
    batch_size = q.size(<span class="hljs-number">0</span>)
    heads = self.heads
    embed_dim = q.size(-<span class="hljs-number">1</span>)
    d_k = self.d_k
    
    <span class="hljs-comment"># 对Q、K、V分别应用线性变换，然后reshape为(batch_size, heads, seq_len, d_k)</span>
    q, k, v = [linear(x)
                .view(batch_size, -<span class="hljs-number">1</span>, heads, d_k)
                .transpose(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)
                <span class="hljs-keyword">for</span> linear,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(self.linears,(q,k,v))]

    <span class="hljs-comment"># 获取注意力机制输出</span>
    output, attn_weight = attention(q, k, v, mask, self.dropout)
    
    <span class="hljs-comment"># 合并多头到一个量中</span>
    <span class="hljs-comment"># 交换维度并合并heads和d_k维度</span>
    res = output.transpose(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>).contiguous().view(batch_size, -<span class="hljs-number">1</span>, embed_dim)
    
    <span class="hljs-comment"># 最后使用线性层做收尾处理</span>
    <span class="hljs-keyword">return</span> self.linears[-<span class="hljs-number">1</span>](res)
</code></pre>
<h4 data-id="heading-25">7.3 位置编码公式对照</h4>
<p>位置编码的公式：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>E</mi><mrow><mo stretchy="false">(</mo><mi>p</mi><mi>o</mi><mi>s</mi><mo separator="true">,</mo><mn>2</mn><mi>i</mi><mo stretchy="false">)</mo></mrow></msub><mo>=</mo><mi>sin</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mfrac><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mrow><mn>1000</mn><msup><mn>0</mn><mrow><mn>2</mn><mi>i</mi><mi mathvariant="normal">/</mi><msub><mi>d</mi><mtext>model</mtext></msub></mrow></msup></mrow></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">PE_{(pos,2i)} = \sin\left(\frac{pos}{10000^{2i/d_{\text{model}}}}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0385em;vertical-align:-0.3552em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"/><span class="mop">sin</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7475em;"><span style="top:-2.5648em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1000</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8932em;"><span style="top:-2.8932em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5357em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3448em;margin-left:0em;margin-right:0.1em;"><span class="pstrut" style="height:2.6944em;"/><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3496em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4352em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>E</mi><mrow><mo stretchy="false">(</mo><mi>p</mi><mi>o</mi><mi>s</mi><mo separator="true">,</mo><mn>2</mn><mi>i</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msub><mo>=</mo><mi>cos</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mfrac><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mrow><mn>1000</mn><msup><mn>0</mn><mrow><mn>2</mn><mi>i</mi><mi mathvariant="normal">/</mi><msub><mi>d</mi><mtext>model</mtext></msub></mrow></msup></mrow></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">PE_{(pos,2i+1)} = \cos\left(\frac{pos}{10000^{2i/d_{\text{model}}}}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0385em;vertical-align:-0.3552em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"/><span class="mop">cos</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7475em;"><span style="top:-2.5648em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1000</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8932em;"><span style="top:-2.8932em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5357em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3448em;margin-left:0em;margin-right:0.1em;"><span class="pstrut" style="height:2.6944em;"/><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3496em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4352em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span></span></span></span></p>
<p>对应的代码实现（PositionalEmbedding类的__init__方法）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, max_length, embed_dim, dropout_p=<span class="hljs-number">0.1</span></span>):
    <span class="hljs-built_in">super</span>().__init__()
    self.max_length = max_length
    self.embed_dim = embed_dim

    <span class="hljs-comment"># Dropout层用于防止过拟合</span>
    self.dropout = nn.Dropout(p=dropout_p)

    <span class="hljs-comment"># 创建位置编码矩阵 [max_length, embed_dim]</span>
    pe = torch.zeros(max_length, embed_dim)
    
    <span class="hljs-comment"># 生成位置信息 [max_length, 1]</span>
    pos = torch.arange(<span class="hljs-number">0</span>, max_length).unsqueeze(<span class="hljs-number">1</span>)
    
    <span class="hljs-comment"># 生成维度索引 0, 2, 4, ..., embed_dim-2 （只取偶数索引）</span>
    tow_i = torch.arange(<span class="hljs-number">0</span>, embed_dim, <span class="hljs-number">2</span>)
    
    <span class="hljs-comment"># 计算角度频率参数</span>
    tmp_v = torch.exp((math.log(<span class="hljs-number">10000</span>) * -tow_i / self.embed_dim))

    <span class="hljs-comment"># 计算角度值：pos * 角度频率</span>
    fn_v = tmp_v * pos

    <span class="hljs-comment"># 偶数位置使用sin编码</span>
    pe[:, <span class="hljs-number">0</span>::<span class="hljs-number">2</span>] = torch.sin(fn_v)
    <span class="hljs-comment"># 奇数位置使用cos编码</span>
    pe[:, <span class="hljs-number">1</span>::<span class="hljs-number">2</span>] = torch.cos(fn_v)

    <span class="hljs-comment"># 增加batch维度 [1, max_length, embed_dim]</span>
    pe = pe.unsqueeze(<span class="hljs-number">0</span>)

    <span class="hljs-comment"># 注册为buffer，不会被更新，但会随模型保存和加载</span>
    self.register_buffer(<span class="hljs-string">'pe'</span>, pe)
</code></pre>
<h4 data-id="heading-26">7.4 层归一化公式对照</h4>
<p>层归一化的公式：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi><mo>=</mo><mfrac><mn>1</mn><mi>H</mi></mfrac><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>H</mi></msubsup><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mu = \frac{1}{H}\sum_{i=1}^{H} x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">μ</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.3262em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>σ</mi><mn>2</mn></msup><mo>=</mo><mfrac><mn>1</mn><mi>H</mi></mfrac><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>H</mi></msubsup><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><mi>μ</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\sigma^2 = \frac{1}{H}\sum_{i=1}^{H} (x_i - \mu)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.3262em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord mathnormal">μ</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mfrac><mrow><mi>x</mi><mo>−</mo><mi>μ</mi></mrow><msqrt><mrow><msup><mi>σ</mi><mn>2</mn></msup><mo>+</mo><mi>ϵ</mi></mrow></msqrt></mfrac><mo>⊙</mo><mi>γ</mi><mo>+</mo><mi>β</mi></mrow><annotation encoding="application/x-tex">y = \frac{x - \mu}{\sqrt{\sigma^2 + \epsilon}} \odot \gamma + \beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.3924em;vertical-align:-0.538em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8544em;"><span style="top:-2.5445em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9221em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7463em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">ϵ</span></span></span><span style="top:-2.8821em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1179em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">μ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.538em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⊙</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span></span></span></p>
<p>对应的代码实现（LayerNorm类的forward方法）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
    <span class="hljs-comment"># 计算平均数</span>
    x_mean = torch.mean(x, keepdim=<span class="hljs-literal">True</span>, dim=-<span class="hljs-number">1</span>)
    
    <span class="hljs-comment"># 计算标准差</span>
    x_std = torch.std(x, keepdim=<span class="hljs-literal">True</span>, dim=-<span class="hljs-number">1</span>)
    
    <span class="hljs-comment"># 计算 (x-平均数) / (标准差+eps) = 标准化后的x</span>
    res = (x - x_mean) / (x_std + self.eps)
    
    <span class="hljs-comment"># 返回 W * x + b，应用可学习的缩放和偏移</span>
    <span class="hljs-keyword">return</span> self.w * res + self.b
</code></pre>
<h4 data-id="heading-27">7.5 前馈网络公式对照</h4>
<p>前馈网络的公式：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">F</mi><mi mathvariant="normal">F</mi><mi mathvariant="normal">N</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mi>x</mi><msub><mi>W</mi><mn>1</mn></msub><mo>+</mo><msub><mi>b</mi><mn>1</mn></msub><mo stretchy="false">)</mo><msub><mi>W</mi><mn>2</mn></msub><mo>+</mo><msub><mi>b</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\mathrm{FFN}(x) = \max(0, xW_1 + b_1)W_2 + b_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">FFN</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mop">max</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">x</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></p>
<p>对应的代码实现（FeedForward类的forward方法）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
    <span class="hljs-comment"># 第一层线性变换: xW_1 + b_1</span>
    x = self.linear1(x)

    <span class="hljs-comment"># ReLU激活: max(0, xW_1 + b_1)</span>
    x = self.relu(x)

    <span class="hljs-comment"># Dropout防止过拟合</span>
    x = self.dropout(x)

    <span class="hljs-comment"># 第二层线性变换: max(0, xW_1 + b_1)W_2 + b_2</span>
    x = self.linear2(x)

    <span class="hljs-keyword">return</span> x
</code></pre>
<h4 data-id="heading-28">7.6 子层连接公式对照</h4>
<p>子层连接的公式：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">)</mo><mo>=</mo><mrow><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">N</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">m</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo>+</mo><mrow><mi mathvariant="normal">D</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">p</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">t</mi></mrow><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{SublayerConnection}(x, \mathrm{Sublayer}) = \mathrm{LayerNorm}(x + \mathrm{Dropout}(\mathrm{Sublayer}(x)))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">SublayerConnection</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathrm">Sublayer</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">LayerNorm</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">Dropout</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathrm">Sublayer</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)))</span></span></span></span></span></p>
<p>对应的代码实现（SubLayers类的forward方法）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, layer_fn</span>):
    <span class="hljs-comment"># 对输入应用指定的层函数，然后进行层归一化和dropout</span>
    <span class="hljs-comment"># 最后与原始输入进行残差连接（x + res）</span>
    res  = self.dropout(self.norm(layer_fn(x)))
    <span class="hljs-keyword">return</span> x + res
</code></pre>
<h4 data-id="heading-29">7.7 编码器层公式对照</h4>
<p>编码器层的公式：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">E</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">)</mo><mo separator="true">,</mo><mrow><mi mathvariant="normal">F</mi><mi mathvariant="normal">F</mi><mi mathvariant="normal">N</mi></mrow><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{EncoderLayer}(x) = \mathrm{SublayerConnection}(\mathrm{SublayerConnection}(x, \mathrm{SelfAttention}), \mathrm{FFN})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">EncoderLayer</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">SublayerConnection</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathrm">SublayerConnection</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathrm">SelfAttention</span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathrm">FFN</span></span><span class="mclose">)</span></span></span></span></span></p>
<p>对应的代码实现（EncoderLayer类的forward方法）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, mask=<span class="hljs-literal">None</span></span>):
    <span class="hljs-comment"># 第一层：自注意力机制</span>
    x = self.layers[<span class="hljs-number">0</span>](x, <span class="hljs-keyword">lambda</span> x: self.multi_head_attn(x, x, x, mask))

    <span class="hljs-comment"># 第二层：前馈神经网络</span>
    x = self.layers[<span class="hljs-number">1</span>](x, self.feed_ward)
    
    <span class="hljs-keyword">return</span> x
</code></pre>
<h4 data-id="heading-30">7.8 解码器层公式对照</h4>
<p>解码器层的公式：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">D</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>e</mi><mi>n</mi><msub><mi>c</mi><mi>o</mi></msub><mi>u</mi><mi>t</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mrow><mi mathvariant="normal">M</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">k</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">S</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">)</mo><mo separator="true">,</mo><mrow><mi mathvariant="normal">E</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">)</mo><mo separator="true">,</mo><mrow><mi mathvariant="normal">F</mi><mi mathvariant="normal">F</mi><mi mathvariant="normal">N</mi></mrow><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{DecoderLayer}(x, enc_out) = \mathrm{SublayerConnection}(\mathrm{SublayerConnection}(\mathrm{SublayerConnection}(x, \mathrm{MaskedSelfAttention}), \mathrm{EncoderAttention}), \mathrm{FFN})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">DecoderLayer</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">SublayerConnection</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathrm">SublayerConnection</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathrm">SublayerConnection</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathrm">MaskedSelfAttention</span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathrm">EncoderAttention</span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathrm">FFN</span></span><span class="mclose">)</span></span></span></span></span></p>
<p>对应的代码实现（DecoderLayer类的forward方法）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, q, k, v, target_mask=<span class="hljs-literal">None</span>, source_mask=<span class="hljs-literal">None</span></span>):
    <span class="hljs-comment"># 第一层：目标序列的自注意力（使用target_mask防止看到未来信息）</span>
    res_1 = self.layers[<span class="hljs-number">0</span>](q, <span class="hljs-keyword">lambda</span> x: self.multi_head_attn(x, x, x, target_mask))

    <span class="hljs-comment"># 第二层：编码器-解码器注意力（查询来自前一层，键值来自编码器输出）</span>
    res_2 = self.layers[<span class="hljs-number">1</span>](res_1, <span class="hljs-keyword">lambda</span> x: self.multi_head_attn(x, k, v, source_mask))

    <span class="hljs-comment"># 第三层：前馈神经网络</span>
    res_3 = self.layers[<span class="hljs-number">2</span>](res_2, self.feed_forward)

    <span class="hljs-keyword">return</span> res_3
</code></pre>
<h4 data-id="heading-31">7.9 完整Transformer模型公式对照</h4>
<p>完整Transformer模型的公式：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">T</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mi mathvariant="normal">D</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">E</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{Transformer}(X, Y) = \mathrm{Decoder}(\mathrm{Encoder}(X), Y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">Transformer</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm">Decoder</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathrm">Encoder</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span></span></span></span></span></p>
<p>对应的代码实现（MyTransform类的forward方法）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, y, target_mask, source_mask</span>):
    <span class="hljs-comment"># 编码器处理源序列</span>
    encoder_output = self.encoder(x, source_mask)

    <span class="hljs-comment"># 解码器处理目标序列，使用编码器输出作为键和值</span>
    decoder_output = self.decoder(y, encoder_output, encoder_output, target_mask)

    <span class="hljs-keyword">return</span> decoder_output
</code></pre>
<h3 data-id="heading-32">8. 辅助函数</h3>
<p>一些辅助函数帮助构建模型：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">clone_modules</span>(<span class="hljs-params">module, N</span>):
    <span class="hljs-string">"""
    克隆N个相同的模块
    
    Args:
        module: 要克隆的模块
        N: 克隆的数量
    
    Returns:
        nn.ModuleList: 包含N个相同模块的列表
    """</span>
    <span class="hljs-keyword">return</span> nn.ModuleList(copy.deepcopy(module) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(N))

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_mask</span>(<span class="hljs-params">size</span>):
    <span class="hljs-string">"""
    生成上三角掩码矩阵，用于防止未来信息泄露（在解码器中使用）
    
    Args:
        size: 掩码矩阵的尺寸 (heads, seq_len, seq_len)
    
    Returns:
        torch.Tensor: 上三角为0，下三角和对角线为1的掩码矩阵
    """</span>
    tensor = torch.ones(size=size, dtype=torch.long)
    <span class="hljs-comment"># triu生成上三角矩阵，k=1表示对角线上方的元素为1，其余为0</span>
    <span class="hljs-comment"># 1-操作将其反转，使对角线和下三角为1，上三角为0</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>-torch.triu(tensor, <span class="hljs-number">1</span>)
</code></pre>
<h3 data-id="heading-33">9. 测试代码</h3>
<p>测试模型各部分功能：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_transform</span>():
    <span class="hljs-string">"""
    测试完整的Transformer模型
    """</span>
    <span class="hljs-comment"># 占位符，无实际作用</span>
    <span class="hljs-keyword">pass</span>

    <span class="hljs-comment"># 创建测试源序列数据</span>
    x = torch.tensor([
        [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>],
        [<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]
    ])
    embed_dim = <span class="hljs-number">512</span>
    <span class="hljs-comment"># 创建嵌入序列模块</span>
    embedding = EmbeddingSequential(<span class="hljs-number">1000</span>, <span class="hljs-number">512</span>, <span class="hljs-number">60</span>)
    <span class="hljs-comment"># 获取源序列嵌入表示</span>
    embedding_x = embedding(x)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'EmbeddingSequential'</span>, embedding_x.shape)
    heads = <span class="hljs-number">8</span>
    <span class="hljs-comment"># 生成源序列掩码</span>
    source_mask = get_mask(size=(heads, x.size(-<span class="hljs-number">1</span>), x.size(-<span class="hljs-number">1</span>)))
    dropout_p = <span class="hljs-number">0.1</span>
    hidden_size = <span class="hljs-number">2048</span>

    <span class="hljs-comment"># 创建目标序列数据</span>
    y = torch.tensor([
        [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>],
        [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>]
    ])

    <span class="hljs-comment"># 深拷贝嵌入模块处理目标序列</span>
    embed_y = copy.deepcopy(embedding)(y)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">'embed_y'</span>, embed_y)
    <span class="hljs-comment"># 生成目标序列掩码</span>
    target_mask = get_mask(size=(heads, y.size(-<span class="hljs-number">1</span>), y.size(-<span class="hljs-number">1</span>)))
    <span class="hljs-comment"># 创建Transformer模型</span>
    transformer = MyTransform(heads=heads, embed_dim=embed_dim, feed_hidden_size=hidden_size, dropout_p=dropout_p)

    <span class="hljs-comment"># Transformer前向传播</span>
    decoder_output = transformer(embedding_x, embed_y, target_mask, source_mask)

    <span class="hljs-comment"># 创建生成器</span>
    generator = Generator(embed_dim, output_size=<span class="hljs-number">2000</span>)

    <span class="hljs-comment"># 生成预测结果</span>
    pre_v = generator(decoder_output)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">'pre_v'</span>, pre_v)
</code></pre>
<h3 data-id="heading-34">10. 项目源码</h3>
<p>本项目完整源码已开源，您可以在以下GitHub仓库中获取：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyour-username%2Ftransformer-implementation" target="_blank" title="https://github.com/your-username/transformer-implementation" ref="nofollow noopener noreferrer">github.com/KobeCYL/tra…</a></p>
<p>源码包含了完整的Transformer实现，以及详细的中文注释，方便学习和理解。项目结构如下：</p>
<pre><code class="hljs language-bash" lang="bash">transformer-implementation/
├── common.py              <span class="hljs-comment"># 公共组件：注意力机制、多头注意力、层归一化等</span>
├── encoder_module.py      <span class="hljs-comment"># 编码器模块实现</span>
├── decoder_module.py      <span class="hljs-comment"># 解码器模块实现</span>
├── embeddings.py          <span class="hljs-comment"># 词嵌入和位置编码实现</span>
├── generator.py           <span class="hljs-comment"># 输出生成器</span>
├── transform.py           <span class="hljs-comment"># Transformer模型主体</span>
└── test.py               <span class="hljs-comment"># 测试代码</span>
</code></pre>
<p>您可以通过以下方式使用该项目：</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/KobeCYL/transformer-implementation.git
<span class="hljs-built_in">cd</span> transformer-implementation
python test.py
</code></pre>
<p>欢迎提交Issue和Pull Request，共同完善这个教学用途的Transformer实现。</p>
<h3 data-id="heading-35">11. 总结</h3>
<p>通过手写Transformer的实现，我们可以更深入地理解其内部工作机制：</p>
<ol>
<li><strong>注意力机制</strong>：核心组件，允许模型关注输入序列的不同部分</li>
<li><strong>多头注意力</strong>：并行计算多个注意力表示，增强模型的表达能力</li>
<li><strong>位置编码</strong>：为模型提供序列顺序信息</li>
<li><strong>残差连接和层归一化</strong>：稳定训练过程，加速收敛</li>
<li><strong>前馈网络</strong>：对每个位置的表示进行非线性变换</li>
</ol>
<p>Transformer的这些设计使其能够并行处理序列数据，有效捕获长距离依赖关系，成为现代NLP模型的基础架构。通过手动实现这些组件，我们不仅加深了对Transformer架构的理解，也为后续的模型改进和优化奠定了基础。</p>
<h3 data-id="heading-36">12. 关注我们</h3>
<p>如果你觉得这篇文章对你有帮助，欢迎：</p>
<ul>
<li><strong>点赞支持</strong>：如果内容对你有帮助，请不要吝啬你的赞👍</li>
<li><strong>分享传播</strong>：将文章分享给更多需要的朋友，让知识传递更远</li>
<li><strong>关注作者</strong>：关注我的GitHub和博客，获取更多深度学习和自然语言处理的干货内容</li>
<li><strong>评论交流</strong>：在评论区留下你的想法和问题，我们一起讨论学习</li>
</ul>
<p>更多关于Transformer、BERT、GPT等前沿NLP技术的深度解析，敬请关注！</p>
<ul>
<li>GitHub: [<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FKobeCYL%2Ftransformer-implementation.git" target="_blank" title="https://github.com/KobeCYL/transformer-implementation.git" ref="nofollow noopener noreferrer">github.com/KobeCYL/tra…</a>]</li>
<li>知乎专栏: [<a href="https://juejin.cn/column/7564951282625134602" target="_blank" title="https://juejin.cn/column/7564951282625134602">juejin.cn/column/7564…</a>]</li>
<li>微信公众号: [小果的迭代人生]</li>
</ul>
<p>让我们一起在AI的道路上不断前行，探索更多技术的奥秘！🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[关于mybatis-plus的一些默认配置]]></title>    <link>https://juejin.cn/post/7569976345931317299</link>    <guid>https://juejin.cn/post/7569976345931317299</guid>    <pubDate>2025-11-09T14:50:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569976345931317299" data-draft-id="7570197010885328942" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="关于mybatis-plus的一些默认配置"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-09T14:50:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeoLi_4"/> <meta itemprop="url" content="https://juejin.cn/user/377887732535197"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            关于mybatis-plus的一些默认配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/377887732535197/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeoLi_4
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T14:50:25.000Z" title="Sun Nov 09 2025 14:50:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">写在前面</h2>
<p>最近在熟悉公司项目环境的时候，发现项目里面用了一些mybatis-plus的表名映射默认配置，在这里做个小总结。</p>
<p>MyBatis-Plus（简称 MP）在简化 MyBatis 开发的同时，内置了大量<strong>默认规则和自动配置</strong>，涵盖实体映射、SQL 生成、字段处理等多个方面。</p>
<h2 data-id="heading-1">默认规则和自动配置</h2>
<h3 data-id="heading-2">实体类与数据库的默认映射规则</h3>
<h4 data-id="heading-3">1. <strong>表名映射</strong></h4>
<ul>
<li>
<p>默认规则：<strong>类名 → 下划线命名表名</strong></p>
<ul>
<li><code>User</code> → <code>user</code></li>
<li><code>UserInfo</code> → <code>user_info</code></li>
</ul>
</li>
<li>
<p>控制开关：<code>mybatis-plus.global-config.db-config.table-underline-hump = true</code>（默认开启）</p>
</li>
</ul>
<blockquote>
<p>⚠️ 不支持复数形式（如 <code>Users</code> 不会变成 <code>users</code>），只是简单驼峰转下划线。</p>
</blockquote>
<hr/>
<h4 data-id="heading-4">2. <strong>字段名映射</strong></h4>
<ul>
<li>
<p>默认规则：<strong>属性名 → 下划线命名字段名</strong></p>
<ul>
<li><code>userName</code> → <code>user_name</code></li>
<li><code>createTime</code> → <code>create_time</code></li>
</ul>
</li>
<li>
<p>同样由 <code>table-underline-hump</code> 控制（该配置同时影响表名和字段名）</p>
</li>
</ul>
<h4 data-id="heading-5">3. <strong>主键字段识别</strong></h4>
<ul>
<li>默认将名为 <code>id</code> 的字段视为<strong>主键</strong>（无论类型是 <code>Long</code>、<code>String</code> 等）</li>
<li>若主键字段不是 <code>id</code>，需使用 <code>@TableId</code> 显式标注</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@TableId(value = "user_id", type = IdType.AUTO)</span>
<span class="hljs-keyword">private</span> Long userId;
</code></pre>
<h4 data-id="heading-6">4. <strong>主键生成策略（IdType）</strong></h4>
<p>若未指定 <code>@TableId(type = ...)</code>，默认策略为：</p>
<ul>
<li><strong><code>IdType.NONE</code></strong>：即不自动处理主键，依赖数据库或手动赋值</li>
</ul>
<p>但如果你用了 <code>@TableId</code> 但没写 <code>type</code>，MP 会根据数据库类型尝试推断（例如 MySQL 下常配合自增）。</p>
<p>常见策略：</p>

























<table><thead><tr><th>枚举值</th><th>说明</th></tr></thead><tbody><tr><td><code>AUTO</code></td><td>数据库自增（需 DB 支持）</td></tr><tr><td><code>INPUT</code></td><td>用户手动输入</td></tr><tr><td><code>ASSIGN_ID</code></td><td>雪花 ID（默认使用 <code>DefaultIdentifierGenerator</code>，兼容 Long/String）</td></tr><tr><td><code>ASSIGN_UUID</code></td><td>UUID（32位无横线字符串）</td></tr></tbody></table>
<blockquote>
<p>💡 从 MP 3.3.0 起，<strong><code>ASSIGN_ID</code> 成为推荐默认策略</strong>（尤其分布式场景）</p>
</blockquote>
<h3 data-id="heading-7">二、字段忽略与逻辑处理</h3>
<h4 data-id="heading-8">1. <strong>非表字段自动忽略</strong></h4>
<ul>
<li>实体类中<strong>没有对应数据库字段的属性</strong>，默认会被忽略（不会参与 SQL 构建）</li>
<li>但若属性名恰好和某字段重名，可能误入 SQL → 建议对非表字段加 <code>@TableField(exist = false)</code></li>
</ul>
<pre><code class="hljs language-ini" lang="ini">java
编辑
@TableField(<span class="hljs-attr">exist</span> = <span class="hljs-literal">false</span>)
private String tempData<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-9">2. <strong>逻辑删除</strong></h4>
<ul>
<li>默认<strong>不启用</strong>逻辑删除</li>
<li>启用后，默认识别字段名为 <code>deleted</code> 的字段（值：0=未删，1=已删）</li>
<li>可通过配置修改字段名和值：</li>
</ul>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">yaml</span>
<span class="hljs-string">编辑</span>
<span class="hljs-attr">mybatis-plus:</span>
  <span class="hljs-attr">global-config:</span>
    <span class="hljs-attr">db-config:</span>
      <span class="hljs-attr">logic-delete-field:</span> <span class="hljs-string">deleted</span>     <span class="hljs-comment"># 全局逻辑删除字段名</span>
      <span class="hljs-attr">logic-delete-value:</span> <span class="hljs-number">1</span>           <span class="hljs-comment"># 已删除值</span>
      <span class="hljs-attr">logic-not-delete-value:</span> <span class="hljs-number">0</span>       <span class="hljs-comment"># 未删除值</span>
</code></pre>
<blockquote>
<p>使用前需在实体字段加 <code>@TableLogic</code></p>
</blockquote>
<hr/>
<h4 data-id="heading-10">3. <strong>自动填充（Auto Fill）</strong></h4>
<ul>
<li>默认<strong>不启用</strong>自动填充</li>
<li>需配合 <code>@TableField(fill = FieldFill.INSERT)</code> + 实现 <code>MetaObjectHandler</code></li>
<li>常用于 <code>create_time</code>、<code>update_time</code>、<code>create_by</code> 等字段</li>
</ul>
<h3 data-id="heading-11">三、SQL 与查询默认行为</h3>
<h4 data-id="heading-12">1. <strong>Select 查询</strong></h4>
<ul>
<li><code>select *</code> 是默认行为（如 <code>selectById</code>, <code>list()</code>）</li>
<li>可通过 <code>QueryWrapper.select("col1, col2")</code> 指定字段</li>
</ul>
<h4 data-id="heading-13">2. <strong>Update 更新</strong></h4>
<ul>
<li>默认<strong>只更新非 null 字段</strong>（针对 <code>update(entity, wrapper)</code>）</li>
<li>若想更新 null 值，需使用 <code>UpdateWrapper.set("field", null)</code> 或配置 <code>FieldStrategy</code></li>
</ul>
<h4 data-id="heading-14">3. <strong>字段更新策略（FieldStrategy）</strong></h4>
<ul>
<li>默认策略：<strong><code>NOT_NULL</code></strong>（仅当字段值非 null 时才加入 SQL）</li>
<li>其他选项：<code>IGNORED</code>（强制更新）、<code>NOT_EMPTY</code>（非空字符串/集合）、<code>DEFAULT</code>（跟随全局）</li>
</ul>
<p>可通过 <code>@TableField(strategy = FieldStrategy.IGNORED)</code> 覆盖</p>
<blockquote>
<p>⚠️ 注意：MP 3.4+ 已弃用 <code>FieldStrategy</code>，改用更灵活的 <code>updateStrategy</code> / <code>whereStrategy</code></p>
</blockquote>
<h2 data-id="heading-15">写在最后</h2>
<p>mybatis-plus虽然提供了很多默认规则配置，最佳实践还是建议如下：</p>
<ul>
<li><strong>显式优于隐式</strong>：即使符合默认规则，也建议加上 <code>@TableName</code> 和 <code>@TableId</code>，提高可读性。</li>
<li><strong>谨慎使用自动填充和逻辑删除</strong>：确保团队理解其触发机制，避免数据异常。</li>
</ul>
<h2 data-id="heading-16">参考</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FLr_S89lFrZ44q-CPqNnTtg" target="_blank" title="https://mp.weixin.qq.com/s/Lr_S89lFrZ44q-CPqNnTtg" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/Lr_S89lFr…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java的Lamdba语法和函数式编程理解]]></title>    <link>https://juejin.cn/post/7570187256105041926</link>    <guid>https://juejin.cn/post/7570187256105041926</guid>    <pubDate>2025-11-09T10:29:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570187256105041926" data-draft-id="7570187256105025542" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java的Lamdba语法和函数式编程理解"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-09T10:29:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一枚懒人"/> <meta itemprop="url" content="https://juejin.cn/user/3910328031122270"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java的Lamdba语法和函数式编程理解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3910328031122270/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一枚懒人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T10:29:56.000Z" title="Sun Nov 09 2025 10:29:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h5 data-id="heading-0">一：背景</h5>
<p>在代码中看到了Lambda表达式和Cousume结合使用，针对这个在代码中的运行顺序有点看不懂执行顺序，因此了解下Lambda表达式在代码中的使用场景做一个简单研究。</p>
<h5 data-id="heading-1">二：使用场景</h5>
<p>Lambda表达式是java8中引入新特性，其标准形式为：() -&gt;{};</p>
<p>变体形式包括：</p>
<p>（x,y）-&gt;{return x +y;} //省略参数类型</p>
<p>(x,y) -&gt; x +y //省略函数体的括号和 return</p>
<p>x -&gt; x*x //省略参数括号和函数体的大括号和 return</p>
<p>()中是参数，{}中是运行表达式。示例如下</p>
<pre><code class="hljs language-ini" lang="ini">Thread <span class="hljs-attr">thread1</span> = new Thread(
        () -&gt;{System.out.println(Thread.currentThread().getId() +"11111")<span class="hljs-comment">;}</span>
)<span class="hljs-comment">;</span>
thread1.start()<span class="hljs-comment">;</span>
</code></pre>
<h6 data-id="heading-2">场景1：替代匿名内部类</h6>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">//采用匿名内部类实现线程中方法运行</span>
Thread thread = new <span class="hljs-built_in">Thread</span>(new Runnable() {
    <span class="hljs-keyword">@Override</span>
    public void run() {
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(Thread.currentThread()<span class="hljs-selector-class">.getId</span>() + "    <span class="hljs-number">11111</span>");
    }
});
thread<span class="hljs-selector-class">.start</span>();
​
<span class="hljs-comment">//使用lambda替缓匿名内部类</span>
Thread thread1 = new <span class="hljs-built_in">Thread</span>(
        () -&gt;{System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(Thread.currentThread()<span class="hljs-selector-class">.getId</span>() +"    <span class="hljs-number">11111</span>");}
);
thread1<span class="hljs-selector-class">.start</span>();
</code></pre>
<h6 data-id="heading-3">使用场景2：结合stream api进行集合元素处理</h6>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">//forEach 循环读取list每一项</span>
List&lt;String&gt; list1 = Arrays.asList(<span class="hljs-string">"aaa"</span>,<span class="hljs-string">"bbb"</span>);
<span class="hljs-comment">//循环读取每一项并打印，采用标准for循环或者增强for都行 </span>
<span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>;i&lt;list1.size();i++){
    System.<span class="hljs-keyword">out</span>.println(list1.<span class="hljs-keyword">get</span>(i));
}

<span class="hljs-comment">//foreach要是换成匿名内部类的实现方式如下，和上面标准for循环一样效果，可进一步将匿名内部类改造成Lambda方式</span>
list1.forEach(<span class="hljs-keyword">new</span> Consumer&lt;String&gt;() {
    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">accept</span>(<span class="hljs-params">String s</span>)</span> {
        System.<span class="hljs-keyword">out</span>.println(s);
    }
});

<span class="hljs-comment">//采用forEach方式，同样实现循环读取打印每一个，和上面一样效果,采用lambda效果</span>
list1.forEach((s)-&gt;{System.<span class="hljs-keyword">out</span>.println(s);});
</code></pre>
<h6 data-id="heading-4">引申场景1：</h6>
<p>forEach函数接受一个Cousume对象，Counsumer类定义中有一个accept函数，因此其实foreach函数接受的就是一个抽象接口对象。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-literal">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title">forEach</span>(<span class="hljs-params">Consumer&lt;? super T&gt; action</span>)</span> {
    Objects.requireNonNull(action);
    <span class="hljs-keyword">for</span> (T t : <span class="hljs-keyword">this</span>) {
        action.accept(t);
    }
}
​
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">Consumer</span>&lt;<span class="hljs-title">T</span>&gt; {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">accept</span>(<span class="hljs-params">T t</span>)</span>;
}
</code></pre>
<p>以上场景其实就是典型的接口中传入一个匿名对象，然后该函数调用匿名函数的方法，所以从写法上等价于</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">String</span>&gt; list1 = <span class="hljs-title class_">Arrays</span>.<span class="hljs-title function_">asList</span>(<span class="hljs-string">"aaa"</span>,<span class="hljs-string">"bbb"</span>);
list1.<span class="hljs-title function_">forEach</span>((s)-&gt;{<span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(s);});
​
<span class="hljs-comment">//和上面的lambda表达式写法一样，上面就是匿名内部类的简化写法</span>
list1.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Consumer</span>&lt;<span class="hljs-title class_">String</span>&gt;() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">accept</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> s</span>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(s);
    }
});
</code></pre>
<p>所以Consumer就是提供了空接口的类，如果要使用lamba表达式来实现一些逻辑时就需要有一个类似的接口类，供用户来直接使用，因此java 提供了Consumer这个接口类，在实际使用过程中可以Consumer作为参数放在接口中，这样就能直接在调用处直接将返回方法传递到函数中，就像传递了一个匿名内部类一样。</p>
<h6 data-id="heading-5">引申场景2：</h6>
<p>在看到Consumer对象时，进一步可引申出java函数式编程，java函数式编程的主要几个实现接口类为：</p>
<p>Function，Consumer，Supplier，Predicate。这4个类各自有各自的作用，此处如何使用不详细展开，此4个类就是java中函数式编程的支持API。</p>
<p>在函数式编程中还引入了另外一个Optional类，该类的主要几个使用方法是</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">//判断值是否为空，不为空值则返回执行一个动作，为空则不执行</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">ifPresent</span>(<span class="hljs-params">Consumer&lt;? <span class="hljs-variable language_">super</span> T&gt; action</span>) {
    <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) {
        action.<span class="hljs-title function_">accept</span>(value);
    }
}
<span class="hljs-comment">//获取到Optional内包含的那个对象的值，如果为空则返回orElse中的另外值</span>
<span class="hljs-keyword">public</span> T <span class="hljs-title function_">orElse</span>(<span class="hljs-params">T other</span>) {
    <span class="hljs-keyword">return</span> value != <span class="hljs-literal">null</span> ? value : other;
}
<span class="hljs-comment">//将Optional中的那个值进行map映射,映射规则就是map中传入的函数 可能出现返回Optional&lt;Optional&lt;U&gt;&gt;</span>
<span class="hljs-keyword">public</span> &lt;U&gt; <span class="hljs-title class_">Optional</span>&lt;U&gt; <span class="hljs-title function_">map</span>(<span class="hljs-params"><span class="hljs-built_in">Function</span>&lt;? <span class="hljs-variable language_">super</span> T, ? <span class="hljs-keyword">extends</span> U&gt; mapper</span>) {
    <span class="hljs-title class_">Objects</span>.requireNonNull(mapper);
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isPresent</span>()) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">empty</span>();
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Optional</span>.<span class="hljs-title function_">ofNullable</span>(mapper.<span class="hljs-title function_">apply</span>(value));
    }
}
<span class="hljs-comment">//将Optional中的那个值进行map映射,映射规则就是map中传入的函数  但是返回的是一个没有嵌套的Option&lt;U&gt; 对象</span>
<span class="hljs-keyword">public</span> &lt;U&gt; <span class="hljs-title class_">Optional</span>&lt;U&gt; <span class="hljs-title function_">flatMap</span>(<span class="hljs-params"><span class="hljs-built_in">Function</span>&lt;? <span class="hljs-variable language_">super</span> T, ? <span class="hljs-keyword">extends</span> Optional&lt;? <span class="hljs-keyword">extends</span> U&gt;&gt; mapper</span>) {
    <span class="hljs-title class_">Objects</span>.requireNonNull(mapper);
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isPresent</span>()) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">empty</span>();
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)
        <span class="hljs-title class_">Optional</span>&lt;U&gt; r = (<span class="hljs-title class_">Optional</span>&lt;U&gt;) mapper.<span class="hljs-title function_">apply</span>(value);
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Objects</span>.requireNonNull(r);
    }
}
</code></pre>
<p>Optional的简单引用实例处理：</p>
<pre><code class="hljs language-rust" lang="rust">public <span class="hljs-keyword">static</span> void <span class="hljs-title function_ invoke__">testLambda4</span>(){
    <span class="hljs-comment">//通过ofNullable产生一个Optional对象</span>
    Optional&lt;<span class="hljs-type">String</span>&gt; op = Optional.<span class="hljs-title function_ invoke__">ofNullable</span>(<span class="hljs-title function_ invoke__">getName</span>());
    <span class="hljs-comment">//通过ifPresent判断 如果op包含的对象不为空时，则执行这个函数对象</span>
    op.<span class="hljs-title function_ invoke__">ifPresent</span>((s) <span class="hljs-punctuation">-&gt;</span>{System.out.<span class="hljs-title function_ invoke__">println</span>(s);});
    <span class="hljs-comment">//使用map函数将Optional中包的对象执行一次toUpperCase操作，</span>
    <span class="hljs-comment">//且执行完之后如果返回的Optional不为空的话则执行 函数对象 </span>
    op.<span class="hljs-title function_ invoke__">map</span>(<span class="hljs-type">String</span>::toUpperCase).<span class="hljs-title function_ invoke__">ifPresent</span>((s)<span class="hljs-punctuation">-&gt;</span>{System.out.<span class="hljs-title function_ invoke__">println</span>(<span class="hljs-string">"装换完成的"</span>+s);});
    <span class="hljs-comment">//map函数的另外一种写法，即使用标准lambda表达式作为参数传入给到map函数，和上一行的函数等效</span>
    <span class="hljs-comment">//map函数中的入参是一个函数式接口Function，此处应该传入的lambda表达式应该包含一个返回值，</span>
    <span class="hljs-comment">//为什么是一个返回值的函数不是一个返回为void的函数，是根据map函数的定义的Function中的泛型接口确定的</span>
    op.<span class="hljs-title function_ invoke__">map</span>(  (s) <span class="hljs-punctuation">-&gt;</span>{
        <span class="hljs-keyword">return</span> s.<span class="hljs-title function_ invoke__">toUpperCase</span>();
    }
    ).<span class="hljs-title function_ invoke__">ifPresent</span>((s)<span class="hljs-punctuation">-&gt;</span>{System.out.<span class="hljs-title function_ invoke__">println</span>(<span class="hljs-string">"装换完成的"</span>+s);} );
    
    
    <span class="hljs-comment">//map函数和flatmap函数的区别，返回值是否会嵌套返回Optional对象</span>
    Optional&lt;Optional&lt;<span class="hljs-type">String</span>&gt;&gt; s2 = op.<span class="hljs-title function_ invoke__">map</span>((s) <span class="hljs-punctuation">-&gt;</span> {
            <span class="hljs-keyword">return</span> Optional.<span class="hljs-title function_ invoke__">ofNullable</span>(s.<span class="hljs-title function_ invoke__">toUpperCase</span>());
        });
    
    Optional&lt;<span class="hljs-type">String</span>&gt; s1 = op.<span class="hljs-title function_ invoke__">flatMap</span>(s <span class="hljs-punctuation">-&gt;</span> {
    <span class="hljs-keyword">return</span> Optional.<span class="hljs-title function_ invoke__">ofNullable</span>(s.<span class="hljs-title function_ invoke__">toUpperCase</span>());});
    
    
    
}
​
public <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-title function_ invoke__">getName</span>(){
    <span class="hljs-keyword">return</span> <span class="hljs-string">"aaa"</span>;
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java示例：设计模式是如何在实战中“自然生长”出来]]></title>    <link>https://juejin.cn/post/7569946369991245887</link>    <guid>https://juejin.cn/post/7569946369991245887</guid>    <pubDate>2025-11-10T02:40:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569946369991245887" data-draft-id="7570191839593955391" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java示例：设计模式是如何在实战中“自然生长”出来"/> <meta itemprop="keywords" content="设计模式,Java"/> <meta itemprop="datePublished" content="2025-11-10T02:40:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Juchecar"/> <meta itemprop="url" content="https://juejin.cn/user/284133851925070"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java示例：设计模式是如何在实战中“自然生长”出来
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/284133851925070/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Juchecar
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T02:40:36.000Z" title="Mon Nov 10 2025 02:40:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>您问到了最关键的点子上，也是所有学习者从理论到实践最难跨越的一步。理论之所以感觉“一套套的”，是因为它被系统地、干净地总结了出来。而现实是混乱、复杂且充满约束的。</p>
<p>下面，我抛弃纯理论，用一个 <strong>“实战推演”</strong> 的思路，带你看看设计模式是如何在实战中“自然生长”出来的。</p>
<h3 data-id="heading-0">核心理念：模式不是起点，而是重构的<strong>结果</strong></h3>
<p>不要带着“我要用模式”的心态去写代码，而要带着 <strong>“我要解决问题，让代码更干净”</strong> 的心态。模式是你到达终点后，别人给你起的名字。</p>
<hr/>
<h3 data-id="heading-1">实战推演：从一个简单需求开始</h3>
<p>假设我们要开发一个电商系统的 <strong><code>OrderService</code></strong>，核心需求是创建订单。</p>
<h4 data-id="heading-2">第零步：最直接的实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(CreateOrderRequest request)</span> {
        <span class="hljs-comment">// 1. 验证参数</span>
        <span class="hljs-keyword">if</span> (request.getItems().isEmpty()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationException</span>(<span class="hljs-string">"订单项不能为空"</span>);
        }
        <span class="hljs-comment">// 2. 计算价格</span>
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> calculateTotal(request.getItems());
        <span class="hljs-comment">// 3. 扣减库存（调用库存服务）</span>
        inventoryClient.decreaseStock(request.getItems());
        <span class="hljs-comment">// 4. 保存订单到数据库</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderRepository.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>(total, request.getItems()));
        <span class="hljs-comment">// 5. 发送订单创建成功事件（比如发邮件、短信）</span>
        eventBus.publish(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderCreatedEvent</span>(order.getId()));
        <span class="hljs-keyword">return</span> order;
    }
}
</code></pre>
<p><strong>现状</strong>：代码能工作，逻辑清晰。<strong>此时，任何设计模式都是多余的。</strong></p>
<hr/>
<h4 data-id="heading-3">第一步：需求变化 -&gt; 引入“策略模式”的种子</h4>
<p><strong>新需求</strong>：现在要支持不同类型的订单：普通订单、团购订单、秒杀订单。它们的价格计算规则完全不同。</p>
<p><strong>糟糕的改法</strong>：在 <code>calculateTotal</code> 方法里加 <code>if-else</code>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 坏味道：冗长的if-else</span>
<span class="hljs-keyword">private</span> BigDecimal <span class="hljs-title function_">calculateTotal</span><span class="hljs-params">(OrderType type, List&lt;Item&gt; items)</span> {
    <span class="hljs-keyword">if</span> (type == OrderType.NORMAL) {
        <span class="hljs-comment">// ... 普通计算逻辑</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == OrderType.GROUP_BUY) {
        <span class="hljs-comment">// ... 团购计算逻辑</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == OrderType.FLASH_SALE) {
        <span class="hljs-comment">// ... 秒杀计算逻辑</span>
    }
    <span class="hljs-comment">// ... 未来每加一种类型，就要修改这里</span>
}
</code></pre>
<p><strong>问题</strong>：违反了“开闭原则”（对扩展开放，对修改关闭）。每次加新类型，都要修改这个核心类，风险高。</p>
<p><strong>重构（模式自然浮现）</strong>：</p>
<ol>
<li><strong>识别变化点</strong>：价格计算逻辑是变化的。</li>
<li><strong>抽取接口</strong>：定义一个 <code>PricingStrategy</code> 接口。
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PricingStrategy</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(OrderType type)</span>;
    BigDecimal <span class="hljs-title function_">calculate</span><span class="hljs-params">(List&lt;Item&gt; items)</span>;
}
</code></pre>
</li>
<li><strong>封装实现</strong>：为每种订单类型创建一个策略类。
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NormalPricingStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PricingStrategy</span> {
    <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(OrderType type)</span> { <span class="hljs-keyword">return</span> type == OrderType.NORMAL; }
    <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title function_">calculate</span><span class="hljs-params">(List&lt;Item&gt; items)</span> { <span class="hljs-comment">/* ... */</span> }
}
<span class="hljs-comment">// ... 其他策略类</span>
</code></pre>
</li>
<li><strong>在Service中使用策略</strong>：
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> List&lt;PricingStrategy&gt; strategies; <span class="hljs-comment">// Spring会自动注入所有实现</span>

<span class="hljs-keyword">private</span> BigDecimal <span class="hljs-title function_">calculateTotal</span><span class="hljs-params">(OrderType type, List&lt;Item&gt; items)</span> {
    <span class="hljs-keyword">for</span> (PricingStrategy strategy : strategies) {
        <span class="hljs-keyword">if</span> (strategy.supports(type)) {
            <span class="hljs-keyword">return</span> strategy.calculate(items);
        }
    }
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(<span class="hljs-string">"不支持的订单类型"</span>);
}
</code></pre>
</li>
</ol>
<p><strong>你看，我们并没有“使用策略模式”，而是通过“消除重复的if-else”和“隔离变化”，让策略模式的结构自然呈现了出来。</strong> 现在，增加新订单类型，我只需要新建一个 <code>PricingStrategy</code> 实现类，<code>OrderService</code> 完全不用动。</p>
<hr/>
<h4 data-id="heading-4">第二步：逻辑复杂 -&gt; 引入“模板方法模式”的种子</h4>
<p><strong>新问题</strong>：创建订单的步骤越来越复杂，每种订单类型在核心步骤上一致（验证-&gt;算价-&gt;扣库存-&gt;保存-&gt;发事件），但某些步骤的实现细节不同（比如团购订单的验证逻辑更复杂）。</p>
<p><strong>糟糕的改法</strong>：在 <code>createOrder</code> 方法里写满针对类型的 <code>if-else</code>。代码会变成一团乱麻。</p>
<p><strong>重构（模式自然浮现）</strong>：</p>
<ol>
<li><strong>识别不变与变</strong>：<strong>流程骨架（模板）是不变的</strong>，<strong>某些步骤的实现是可变的</strong>。</li>
<li><strong>定义模板</strong>：将固定流程提升到父类。
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractOrderCreator</span> {
    <span class="hljs-comment">// 这就是“模板方法”</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(CreateOrderRequest request)</span> {
        <span class="hljs-comment">// 固定流程</span>
        validateSpecific(request);
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> calculateTotal(request);
        decreaseStock(request);
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> saveOrder(request, total);
        publishEvent(order);
        <span class="hljs-keyword">return</span> order;
    }
    <span class="hljs-comment">// 将变化的步骤声明为抽象方法，强迫子类实现</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validateSpecific</span><span class="hljs-params">(CreateOrderRequest request)</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> BigDecimal <span class="hljs-title function_">calculateTotal</span><span class="hljs-params">(CreateOrderRequest request)</span>;
    <span class="hljs-comment">// ... 其他抽象或可重写的方法</span>
}
</code></pre>
</li>
<li><strong>创建子类</strong>：
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GroupBuyOrderCreator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractOrderCreator</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validateSpecific</span><span class="hljs-params">(CreateOrderRequest request)</span> {
        <span class="hljs-comment">// 团购订单特有的复杂验证逻辑</span>
        <span class="hljs-keyword">if</span> (!groupBuyService.isValid(request.getGroupId())) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationException</span>(<span class="hljs-string">"团购活动已失效"</span>);
        }
        <span class="hljs-comment">// ... 更多验证</span>
    }
    <span class="hljs-comment">// ... 实现其他抽象方法</span>
}
</code></pre>
</li>
</ol>
<p><strong>你看，我们为了解决“流程相同，部分步骤不同”的问题，自然地使用了模板方法模式。</strong> 现在，<code>OrderService</code> 的职责可以简化为路由，根据类型找到对应的 <code>AbstractOrderCreator</code> 来执行。</p>
<hr/>
<h4 data-id="heading-5">第三步：依赖混乱 -&gt; 引入“依赖注入”与“门面模式”</h4>
<p><strong>新问题</strong>：<code>OrderService</code> 现在依赖了太多东西：各种 <code>Creator</code>、<code>PricingStrategy</code>、仓库、客户端等。它变成了一个“上帝类”，难以测试和维护。</p>
<p><strong>重构（模式自然浮现）</strong>：</p>
<ol>
<li><strong>应用依赖注入</strong>：这不是一个具体的GoF模式，而是一个更基础的架构原则。我们通过构造函数清晰地声明依赖，而不是用 <code>@Autowired</code> 到处乱注。
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;OrderType, AbstractOrderCreator&gt; creatorMap;
    <span class="hljs-comment">// 通过构造器注入，依赖关系一目了然</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderService</span><span class="hljs-params">(List&lt;AbstractOrderCreator&gt; creators)</span> {
        <span class="hljs-built_in">this</span>.creatorMap = creators.stream()
            .collect(Collectors.toMap(creator -&gt; creator.supportsOrderType(), Function.identity()));
    }
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(CreateOrderRequest request)</span> {
        <span class="hljs-type">AbstractOrderCreator</span> <span class="hljs-variable">creator</span> <span class="hljs-operator">=</span> creatorMap.get(request.getType());
        <span class="hljs-keyword">return</span> creator.createOrder(request);
    }
}
</code></pre>
</li>
<li><strong>考虑门面模式</strong>：如果外部客户端（如Controller）需要调用多个Service才能完成一个操作，我们可以引入一个 <code>OrderFacade</code>，为外部提供一个统一的、简洁的接口，隐藏内部 <code>OrderService</code>、<code>PaymentService</code>、<code>ShippingService</code> 的复杂交互。</li>
</ol>
<h3 data-id="heading-6">给你的实践路线图</h3>
<ol>
<li><strong>忘记模式，记住原则</strong>：首先牢记 <strong>SOLID</strong> 原则（尤其是单一职责SRP和开闭原则OCP）和 <strong>DRY</strong>（不要重复自己）。这些是产生模式的土壤。</li>
<li><strong>从小处着手</strong>：不要试图设计一个完美的系统。先让代码跑起来。</li>
<li><strong>培养嗅觉</strong>：学会识别“代码坏味道”。
<ul>
<li><strong>重复代码</strong> -&gt; 提取方法/类。</li>
<li><strong>过长的函数/类</strong> -&gt; 分解。</li>
<li><strong>庞大的条件判断</strong> -&gt; 考虑用多态（策略、状态模式）替代。</li>
<li><strong>类知道得太多</strong> -&gt; 考虑依赖注入、中介者模式。</li>
</ul>
</li>
<li><strong>痛苦驱动重构</strong>：当添加新功能或修改代码变得非常困难和痛苦时，就是重构的最佳时机。问问自己：“这里是什么变化让我如此痛苦？我能否将这部分抽离出来？”</li>
<li><strong>重构，而非重写</strong>：通过一系列小步、安全的重构（有测试保障最好），将“坏代码”逐步改善为“好代码”。在这个过程中，你会发现设计模式的结构自然而然地出现了。</li>
</ol>
<p><strong>最终，你的目标不是“在代码中使用模式”，而是“写出干净的代码”。而干净的代码，往往会自然而然地体现出经典设计模式的结构。</strong> 这时，模式对你来说就不再是“一套套的理论”，而是你工具箱里顺手拈来的、有名字的工具了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[海量日志分析：一天内最大在线人数与最长持续时间计算方案]]></title>    <link>https://juejin.cn/post/7570394530316386304</link>    <guid>https://juejin.cn/post/7570394530316386304</guid>    <pubDate>2025-11-10T02:46:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570394530316386304" data-draft-id="7570604028632563747" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="海量日志分析：一天内最大在线人数与最长持续时间计算方案"/> <meta itemprop="keywords" content="后端,微服务"/> <meta itemprop="datePublished" content="2025-11-10T02:46:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="回家路上绕了弯"/> <meta itemprop="url" content="https://juejin.cn/user/536217404587134"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            海量日志分析：一天内最大在线人数与最长持续时间计算方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217404587134/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    回家路上绕了弯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T02:46:27.000Z" title="Mon Nov 10 2025 02:46:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">海量日志分析：一天内最大在线人数与最长持续时间计算方案</h2>
<p>在用户行为分析、服务器资源调度、产品运营监控等场景中，“一天内的最大在线人数” 和 “维持最大在线人数的最长持续时间” 是核心指标 —— 比如游戏运营需要知道峰值在线人数以扩容服务器，视频平台需要根据峰值时长优化带宽分配。但当日志量达到百万、甚至亿级时，“逐秒遍历统计” 的暴力方案会彻底失效，必须设计基于 “事件排序” 的高效算法。</p>
<p>本文以日志格式{userid, login_time, logout_time}（时间单位：秒，范围 0~86399，代表一天 24 小时）为例，完整讲解两大问题的解决思路与落地代码。</p>
<h3 data-id="heading-1">一、核心思路：从 “暴力遍历” 到 “事件点排序”</h3>
<p>先明确一个关键观察：<strong>用户的在线状态变化只发生在 “登录时间” 和 “登出时间” 两个节点</strong>，中间时间段的在线状态是连续的。基于此，我们可以将每条日志转换成两个 “状态事件”，再通过排序和遍历事件计算在线人数，彻底规避 “逐秒统计” 的性能瓶颈。</p>
<h4 data-id="heading-2">事件转换规则</h4>
<p>对任意一条日志(user1, 100, 200)（user1 在第 100 秒登录，第 200 秒登出）：</p>
<ul>
<li>登录事件：(time=100, type=+1) → 第 100 秒时，在线人数 + 1；</li>
</ul>

<ul>
<li>登出事件：(time=200, type=-1) → 第 200 秒时，在线人数 - 1。</li>
</ul>
<h4 data-id="heading-3">关键排序原则</h4>
<p>当多个事件的time相同时，需按 “登出事件优先” 排序，避免计算错误：</p>
<ul>
<li>例：事件 A(100, -1)（登出）和事件 B(100, +1)（登录），先处理 A 再处理 B；</li>
</ul>

<ul>
<li>原因：若用户 C 在 100 秒登出，用户 D 在 100 秒登录，正确的在线人数变化是 “C 登出（人数 - 1）→ D 登录（人数 + 1）”，若先处理登录会导致 100 秒时人数多算 1 次。</li>
</ul>
<h3 data-id="heading-4">二、问题（1）：计算一天内的最大在线人数</h3>
<h4 data-id="heading-5">算法步骤</h4>
<ol>
<li><strong>日志预处理</strong>：过滤异常日志（如login_time &gt; logout_time、login_time &lt; 0、logout_time &gt; 86399，异常日志直接丢弃或修正，如登出时间超 24 小时按 86399 处理）；</li>
</ol>

<ol start="2">
<li><strong>事件转换</strong>：将每条有效日志转换为 “登录 + 1” 和 “登出 - 1” 两个事件；</li>
</ol>

<ol start="3">
<li><strong>事件排序</strong>：按time升序排序，time相同则 “登出事件（type=-1）” 排在 “登录事件（type=+1）” 前面；</li>
</ol>

<ol start="4">
<li><strong>遍历计算</strong>：初始化current_online=0、max_online=0，遍历排序后的事件，累加current_online，并实时更新max_online；</li>
</ol>

<ol start="5">
<li><strong>输出结果</strong>：max_online即为一天内的最大在线人数。</li>
</ol>
<h4 data-id="heading-6">单机版代码实现（Python）</h4>
<p>适用于日志量≤1000 万条的场景（Python 处理 1000 万事件排序约需 10~20 秒）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_max_online</span>(<span class="hljs-params">logs</span>):
    <span class="hljs-string">"""
    计算一天内的最大在线人数
    :param logs: 日志列表，每条日志格式为 (userid, login_time, logout_time)
    :return: max_online（最大在线人数）
    """</span>
    events = []
    <span class="hljs-comment"># 1. 日志预处理与事件转换</span>
    <span class="hljs-keyword">for</span> userid, login, logout <span class="hljs-keyword">in</span> logs:
        <span class="hljs-comment"># 过滤异常日志</span>
        <span class="hljs-keyword">if</span> login &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> logout &lt; login <span class="hljs-keyword">or</span> logout &gt; <span class="hljs-number">86399</span>:
            <span class="hljs-keyword">continue</span>
        <span class="hljs-comment"># 登录事件（type=1），登出事件（type=-1）</span>
        events.append((login, <span class="hljs-number">1</span>))
        events.append((logout, -<span class="hljs-number">1</span>))
    
    <span class="hljs-comment"># 2. 事件排序：time升序，time相同则登出事件（-1）在前</span>
    <span class="hljs-comment"># 排序key：(time, type)，因为-1 &lt; 1，所以相同time时-1排在前面</span>
    events.sort(key=<span class="hljs-keyword">lambda</span> x: (x[<span class="hljs-number">0</span>], x[<span class="hljs-number">1</span>]))
    
    <span class="hljs-comment"># 3. 遍历计算在线人数</span>
    current_online = <span class="hljs-number">0</span>
    max_online = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> time, delta <span class="hljs-keyword">in</span> events:
        current_online += delta
        <span class="hljs-comment"># 更新最大在线人数（注意：current_online可能为负，需取非负后比较）</span>
        <span class="hljs-keyword">if</span> current_online &gt; max_online:
            max_online = current_online
    
    <span class="hljs-keyword">return</span> max_online
<span class="hljs-comment"># 测试示例</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 测试日志：(userid, login_time, logout_time)</span>
    test_logs = [
        (<span class="hljs-string">"user1"</span>, <span class="hljs-number">100</span>, <span class="hljs-number">200</span>),   <span class="hljs-comment"># 100秒登录，200秒登出</span>
        (<span class="hljs-string">"user2"</span>, <span class="hljs-number">150</span>, <span class="hljs-number">250</span>),   <span class="hljs-comment"># 150秒登录，250秒登出</span>
        (<span class="hljs-string">"user3"</span>, <span class="hljs-number">180</span>, <span class="hljs-number">300</span>),   <span class="hljs-comment"># 180秒登录，300秒登出</span>
        (<span class="hljs-string">"user4"</span>, <span class="hljs-number">200</span>, <span class="hljs-number">280</span>),   <span class="hljs-comment"># 200秒登录，280秒登出（与user1登出时间相同）</span>
    ]
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"最大在线人数："</span>, calculate_max_online(test_logs))  <span class="hljs-comment"># 输出3（180~200秒时，user1、user2、user3同时在线）</span>
</code></pre>
<h4 data-id="heading-7">分布式方案（Spark）</h4>
<p>当日志量超 1 亿条时，单机内存无法承载，需用 Spark 进行分布式处理，核心逻辑与单机版一致，只是通过 RDD/DataFrame 实现并行计算：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> org.apache.spark.sql.SparkSession
<span class="hljs-keyword">object</span> MaxOnlineCalculator {
  def main(args: Array[String]): <span class="hljs-built_in">Unit</span> = {
    <span class="hljs-keyword">val</span> spark = SparkSession.builder()
      .appName(<span class="hljs-string">"MaxOnlineCalculator"</span>)
      .master(<span class="hljs-string">"yarn"</span>)  <span class="hljs-comment">// 生产环境用yarn或k8s</span>
      .getOrCreate()
    
    <span class="hljs-keyword">import</span> spark.implicits._
    
    <span class="hljs-comment">// 1. 读取日志（假设日志存储在HDFS，格式为userid,login_time,logout_time）</span>
    <span class="hljs-keyword">val</span> logsDF = spark.read
      .option(<span class="hljs-string">"header"</span>, <span class="hljs-string">"false"</span>)
      .csv(<span class="hljs-string">"hdfs://path/to/logs.csv"</span>)
      .toDF(<span class="hljs-string">"userid"</span>, <span class="hljs-string">"login_time"</span>, <span class="hljs-string">"logout_time"</span>)
      .select(
        $<span class="hljs-string">"userid"</span>,
        $<span class="hljs-string">"login_time"</span>.cast(<span class="hljs-string">"long"</span>),
        $<span class="hljs-string">"logout_time"</span>.cast(<span class="hljs-string">"long"</span>)
      )
    
    <span class="hljs-comment">// 2. 预处理+事件转换（并行执行）</span>
    <span class="hljs-keyword">val</span> eventsDF = logsDF
      .filter(<span class="hljs-string">"login_time &gt;= 0 and logout_time &gt;= login_time and logout_time &lt;= 86399"</span>)
      .flatMap(row =&gt; {
        <span class="hljs-keyword">val</span> login = row.getAs[<span class="hljs-built_in">Long</span>](<span class="hljs-string">"login_time"</span>)
        <span class="hljs-keyword">val</span> logout = row.getAs[<span class="hljs-built_in">Long</span>](<span class="hljs-string">"logout_time"</span>)
        <span class="hljs-comment">// 返回两个事件：(time, delta)</span>
        Seq((login, <span class="hljs-number">1L</span>), (logout, -<span class="hljs-number">1L</span>))
      })
      .toDF(<span class="hljs-string">"time"</span>, <span class="hljs-string">"delta"</span>)
    
    <span class="hljs-comment">// 3. 事件排序（分布式排序，按time和delta排序）</span>
    <span class="hljs-keyword">val</span> sortedEvents = eventsDF
      .orderBy($<span class="hljs-string">"time"</span>, $<span class="hljs-string">"delta"</span>)  <span class="hljs-comment">// delta=-1排在1前面，符合排序原则</span>
    
    <span class="hljs-comment">// 4. 遍历计算最大在线人数（用reduceByKey累加，避免全局洗牌）</span>
    <span class="hljs-comment">// 这里用累加器实现全局计数（适用于需实时更新最大值的场景）</span>
    <span class="hljs-keyword">val</span> maxOnlineAcc = spark.sparkContext.longAccumulator(<span class="hljs-string">"maxOnline"</span>)
    <span class="hljs-keyword">var</span> currentOnline = <span class="hljs-number">0L</span>
    
    sortedEvents.foreach(row =&gt; {
      <span class="hljs-keyword">val</span> time = row.getAs[<span class="hljs-built_in">Long</span>](<span class="hljs-string">"time"</span>)
      <span class="hljs-keyword">val</span> delta = row.getAs[<span class="hljs-built_in">Long</span>](<span class="hljs-string">"delta"</span>)
      currentOnline += delta
      <span class="hljs-keyword">if</span> (currentOnline &gt; maxOnlineAcc.value) {
        maxOnlineAcc.add(currentOnline - maxOnlineAcc.value)
      }
    })
    
    <span class="hljs-comment">// 输出结果</span>
    println(s<span class="hljs-string">"一天内最大在线人数：<span class="hljs-subst">${maxOnlineAcc.value}</span>"</span>)
    
    spark.stop()
  }
}
</code></pre>
<h3 data-id="heading-8">三、问题（2）：计算维持最大在线人数的最长持续时间</h3>
<h4 data-id="heading-9">核心难点</h4>
<p>最大在线人数可能在一天内出现多次（如早高峰 9 点和晚高峰 20 点都达到峰值），需找到 “每次峰值持续的时间段”，计算每个时间段的时长，最终取最大值。</p>
<h4 data-id="heading-10">关键观察</h4>
<ul>
<li>峰值时间段的特征：current_online == max_online，且时间段为[start_time, end_time)（左闭右开，因为end_time是下一个事件的时间，事件发生时在线人数会变化）；</li>
</ul>

<ul>
<li>时长计算：end_time - start_time（单位：秒）；</li>
</ul>

<ul>
<li>例：事件序列为(180, +1)（人数 3，达峰值）→ (200, -1)（人数 2，峰值结束），则峰值时间段是[180, 200)，时长 20 秒。</li>
</ul>
<h4 data-id="heading-11">算法步骤</h4>
<ol>
<li>先按问题（1）的步骤计算出max_online；</li>
</ol>

<ol start="2">
<li>重新遍历排序后的事件，记录每次current_online达到max_online的start_time；</li>
</ol>

<ol start="3">
<li>当current_online从max_online下降时，记录end_time（当前事件的时间），计算时长end_time - start_time，并更新 “最长持续时间”；</li>
</ol>

<ol start="4">
<li>若遍历到最后一个事件时current_online仍为max_online，则end_time取 86399（一天结束时间），计算时长。</li>
</ol>
<h4 data-id="heading-12">单机版代码实现（Python）</h4>
<pre><code class="hljs language-ini" lang="ini">def calculate_max_online_duration(logs):
    """
    计算一天内最大在线人数的最长持续时间
    :param logs: 日志列表，每条日志格式为 (userid, login_time, logout_time)
    :return: (max_online, max_duration) （最大在线人数，最长持续时间，单位：秒）
    """
    <span class="hljs-comment"># 步骤1：生成排序后的事件（同问题1）</span>
    <span class="hljs-attr">events</span> = []
    for userid, login, logout in logs:
        if login &lt; 0 or logout &lt; login or logout &gt; 86399:
            continue
        events.append((login, 1))
        events.append((logout, -1))
    <span class="hljs-comment"># 排序：time升序，相同time时登出事件在前</span>
    events.sort(<span class="hljs-attr">key</span>=lambda x: (x[<span class="hljs-number">0</span>], x[<span class="hljs-number">1</span>]))
    
    <span class="hljs-comment"># 步骤2：先计算max_online（同问题1）</span>
    <span class="hljs-attr">current_online</span> = <span class="hljs-number">0</span>
    <span class="hljs-attr">max_online</span> = <span class="hljs-number">0</span>
    for time, delta in events:
        current_online += delta
        if current_online &gt; max_online:
            <span class="hljs-attr">max_online</span> = current_online
    
    <span class="hljs-comment"># 步骤3：计算最长峰值持续时间</span>
    <span class="hljs-attr">current_online</span> = <span class="hljs-number">0</span>
    <span class="hljs-attr">max_duration</span> = <span class="hljs-number">0</span>
    <span class="hljs-attr">peak_start</span> = None  <span class="hljs-comment"># 峰值开始时间</span>
    
    for i in range(len(events)):
        time, <span class="hljs-attr">delta</span> = events[i]
        <span class="hljs-attr">prev_online</span> = current_online  <span class="hljs-comment"># 事件发生前的在线人数</span>
        current_online += delta
        
        <span class="hljs-comment"># 情况1：事件后进入峰值状态（prev_online &lt; max_online，current_online == max_online）</span>
        if prev_online &lt; max_online and <span class="hljs-attr">current_online</span> == max_online:
            <span class="hljs-attr">peak_start</span> = time
        
        <span class="hljs-comment"># 情况2：事件后退出峰值状态（prev_online == max_online，current_online &lt; max_online）</span>
        elif <span class="hljs-attr">prev_online</span> == max_online and current_online &lt; max_online:
            if peak_start is not None:
                <span class="hljs-comment"># 峰值结束时间为当前事件时间</span>
                <span class="hljs-attr">duration</span> = time - peak_start
                if duration &gt; max_duration:
                    <span class="hljs-attr">max_duration</span> = duration
                <span class="hljs-attr">peak_start</span> = None  <span class="hljs-comment"># 重置峰值开始时间</span>
        
        <span class="hljs-comment"># 情况3：遍历到最后一个事件，且仍处于峰值状态</span>
        if <span class="hljs-attr">i</span> == len(events) - <span class="hljs-number">1</span> and current_online == max_online and peak_start is not None:
            <span class="hljs-attr">duration</span> = <span class="hljs-number">86399</span> - peak_start  <span class="hljs-comment"># 结束时间为一天的最后一秒</span>
            if duration &gt; max_duration:
                <span class="hljs-attr">max_duration</span> = duration
    
    return max_online, max_duration
<span class="hljs-comment"># 测试示例</span>
if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-attr">test_logs</span> = [
        (<span class="hljs-string">"user1"</span>, <span class="hljs-number">100</span>, <span class="hljs-number">200</span>),
        (<span class="hljs-string">"user2"</span>, <span class="hljs-number">150</span>, <span class="hljs-number">250</span>),
        (<span class="hljs-string">"user3"</span>, <span class="hljs-number">180</span>, <span class="hljs-number">300</span>),
        (<span class="hljs-string">"user4"</span>, <span class="hljs-number">200</span>, <span class="hljs-number">280</span>),
        (<span class="hljs-string">"user5"</span>, <span class="hljs-number">220</span>, <span class="hljs-number">280</span>),  <span class="hljs-comment"># 220~280秒时，user2、user3、user4、user5同时在线（峰值4）</span>
    ]
    max_online, <span class="hljs-attr">max_duration</span> = calculate_max_online_duration(test_logs)
    print(f"最大在线人数：{max_online}，最长持续时间：{max_duration}秒")  <span class="hljs-comment"># 输出：最大4，最长60秒（220~280秒）</span>
</code></pre>
<h4 data-id="heading-13">分布式方案优化</h4>
<p>在 Spark 中计算最长持续时间，需避免 “全局遍历”（会导致数据集中到一个节点），可通过 “窗口函数” 标记峰值时间段，再计算每个时间段的时长：</p>
<ol>
<li>用lag窗口函数获取上一个事件的time和current_online，标记当前事件是否处于峰值；</li>
</ol>

<ol start="2">
<li>按 “是否峰值” 分组，计算每个峰值组的min(time)（start_time）和max(time)（end_time）；</li>
</ol>

<ol start="3">
<li>计算每个组的时长end_time - start_time，取最大值；</li>
</ol>

<ol start="4">
<li>若最后一个事件仍处于峰值，需补充计算86399 - max(time)。</li>
</ol>
<h3 data-id="heading-14">四、边界场景处理：避免计算错误</h3>
<ol>
<li><strong>用户瞬间登录登出</strong>：login_time == logout_time（如(user1, 500, 500)），转换为两个事件(500, +1)和(500, -1)，排序后先处理 - 1，current_online先 + 1 再 - 1，不影响最大人数（相当于未在线）；</li>
</ol>

<ol start="2">
<li><strong>登出时间超一天</strong>：如logout_time=90000，按 86399 处理（一天的最后一秒），避免事件时间超出范围；</li>
</ol>

<ol start="3">
<li><strong>空日志或全异常日志</strong>：返回max_online=0，max_duration=0；</li>
</ol>

<ol start="4">
<li><strong>全天维持峰值</strong>：如所有用户登录时间 = 0，登出时间 = 86399，此时max_duration=86399秒（24 小时）。</li>
</ol>
<h3 data-id="heading-15">五、性能优化建议</h3>
<ol>
<li><strong>日志预处理过滤</strong>：提前过滤异常日志（如用 Flink 实时过滤写入 HDFS），减少后续计算的数据量；</li>
</ol>

<ol start="2">
<li><strong>事件去重</strong>：若同一用户在同一时间有多次登录登出（如日志重复），可先按(userid, login_time, logout_time)去重，避免重复生成事件；</li>
</ol>

<ol start="3">
<li><strong>时间粒度优化</strong>：若业务允许按 “分钟” 统计（而非秒），可将时间转换为分钟（time = time // 60），事件数量减少 60 倍，性能提升显著；</li>
</ol>

<ol start="4">
<li><strong>内存优化</strong>：单机场景用numpy数组存储事件（替代 Python 列表），减少内存占用；分布式场景用 Spark 的Kryo序列化，提升数据传输效率。</li>
</ol>
<h3 data-id="heading-16">总结</h3>
<p>处理海量日志的 “最大在线人数” 和 “最长持续时间”，核心是 “<strong>将连续状态转换为离散事件</strong>”：</p>
<ol>
<li>用 “事件点排序法” 替代 “逐秒遍历”，时间复杂度从 O (86400) 降为 O (n log n)（n 为事件数），适配海量数据；</li>
</ol>

<ol start="2">
<li>排序时遵循 “登出优先” 原则，避免同一时间点的计算错误；</li>
</ol>

<ol start="3">
<li>计算最长持续时间需关注 “峰值的开始与结束节点”，用左闭右开区间计算时长；</li>
</ol>

<ol start="4">
<li>单机场景适合中小数据量，分布式场景（Spark/Flink）适合亿级日志，需兼顾并行计算与全局状态更新。</li>
</ol>
<p>这套方案不仅适用于用户在线统计，还可扩展到 “服务器连接数峰值”“接口调用峰值” 等类似场景 —— 只要是 “连续状态随离散事件变化” 的问题，都能复用 “事件排序 + 遍历计算” 的思路。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 Laravel Middleware：完整指南]]></title>    <link>https://juejin.cn/post/7570271574348316681</link>    <guid>https://juejin.cn/post/7570271574348316681</guid>    <pubDate>2025-11-09T23:57:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570271574348316681" data-draft-id="7570201730992046106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 Laravel Middleware：完整指南"/> <meta itemprop="keywords" content="后端,Laravel"/> <meta itemprop="datePublished" content="2025-11-09T23:57:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 Laravel Middleware：完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T23:57:56.000Z" title="Sun Nov 09 2025 23:57:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">深入理解 Laravel Middleware：完整指南</h2>
<p>Laravel 中间件是框架最强大的特性之一，它在 HTTP 请求和应用核心逻辑之间扮演着桥梁的角色。不管你是开发简单的博客还是复杂的企业应用，掌握中间件都是写出安全、易维护、高效代码的关键。</p>
<p>这篇指南会带你全面了解 Laravel 12 中间件，从基础概念到高级用法和最佳实践。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2025-11%2Funderstanding-laravel-middleware-guide" target="_blank" title="https://catchadmin.com/post/2025-11/understanding-laravel-middleware-guide" ref="nofollow noopener noreferrer">原文链接 深入理解 Laravel Middleware：完整指南</a></p>
<h3 data-id="heading-1">什么是中间件？</h3>
<p>中间件提供了一种便捷的机制来检查和过滤进入应用的 HTTP 请求。你可以把中间件理解为 HTTP 请求在到达应用核心之前必须经过的一道道关卡。</p>
<p>比如，Laravel 内置了一个用于验证用户身份的中间件。如果用户未登录，中间件会把他们重定向到登录页。如果已登录，中间件就放行，让请求继续往下走。</p>
<p>除了身份验证，中间件还有很多其他用途：</p>
<ul>
<li><strong>请求日志</strong>：跟踪所有传入请求以进行调试和分析</li>
<li><strong>CSRF 保护</strong>：确保请求合法且安全</li>
<li><strong>数据验证</strong>：在数据到达控制器之前进行验证</li>
<li><strong>速率限制</strong>：通过限制请求频率来防止滥用</li>
<li><strong>CORS 处理</strong>：管理跨域资源共享策略</li>
<li><strong>API Token 验证</strong>：认证 API 请求</li>
<li><strong>基于角色的访问控制</strong>：根据用户角色限制访问</li>
<li><strong>请求/响应修改</strong>：在处理或发送之前转换数据</li>
</ul>
<h3 data-id="heading-2">中间件的工作原理：请求生命周期</h3>
<p>理解中间件在 Laravel 请求生命周期中的位置很重要。当一个 HTTP 请求进来时，它会经历这样的流程：</p>
<ol>
<li>请求从 <code>public/index.php</code> 进入</li>
<li>Laravel 启动应用并加载服务提供者</li>
<li>请求经过全局中间件栈</li>
<li>路由器匹配对应的路由</li>
<li>执行该路由的中间件</li>
<li>请求到达控制器或路由处理器</li>
<li>响应原路返回，再次经过中间件</li>
<li>最终返回给客户端</li>
</ol>
<p>这种管道式架构让每个中间件都可以在请求到达应用逻辑之前对其进行检查、修改，甚至直接拦截。</p>
<h3 data-id="heading-3">创建自定义中间件</h3>
<p>在 Laravel 12 中，用 Artisan 命令创建中间件很简单。我们来一步步看如何创建自定义中间件。</p>
<h4 data-id="heading-4">步骤 1：生成 Middleware</h4>
<p>使用 <code>make:middleware</code> Artisan 命令创建一个新的 Middleware 类：</p>
<pre><code class="hljs language-bash" lang="bash">php artisan make:middleware EnsureTokenIsValid
</code></pre>
<p>这个命令会在 <code>app/Http/Middleware</code> 目录下生成一个新文件，里面已经写好了基本的中间件结构。</p>
<h4 data-id="heading-5">步骤 2：编写中间件逻辑</h4>
<p>打开刚生成的 <code>EnsureTokenIsValid.php</code>，你会看到一个带 <code>handle</code> 方法的模板：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Http</span>\<span class="hljs-title class_">Middleware</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Closure</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">HttpFoundation</span>\<span class="hljs-title">Response</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EnsureTokenIsValid</span>
</span>{
    <span class="hljs-comment">/**
     * Handle an incoming request.
     *
     * <span class="hljs-doctag">@param</span>  \Closure(\Illuminate\Http\Request): (\Symfony\Component\HttpFoundation\Response)  $next
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span>, <span class="hljs-built_in">Closure</span> <span class="hljs-variable">$next</span></span>): <span class="hljs-title">Response</span>
    </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">input</span>(<span class="hljs-string">'token'</span>) !== <span class="hljs-string">'my-secret-token'</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">redirect</span>(<span class="hljs-string">'/home'</span>)-&gt;<span class="hljs-title function_ invoke__">with</span>(<span class="hljs-string">'error'</span>, <span class="hljs-string">'Invalid token provided'</span>);
        }

        <span class="hljs-keyword">return</span> <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
    }
}
</code></pre>
<p><code>handle</code> 方法有两个参数：</p>
<ul>
<li><code>$request</code>：当前的 HTTP 请求</li>
<li><code>$next</code>：下一个中间件的闭包</li>
</ul>
<p>如果想让请求通过，就调用 <code>$next($request)</code>。如果要拦截请求，就直接返回响应或重定向。</p>
<h4 data-id="heading-6">步骤 3：前置和后置中间件</h4>
<p>中间件可以在处理请求前后都执行操作。</p>
<p><strong>前置中间件</strong>（在请求到达控制器之前执行）：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Http</span>\<span class="hljs-title class_">Middleware</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Closure</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">HttpFoundation</span>\<span class="hljs-title">Response</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BeforeMiddleware</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span>, <span class="hljs-built_in">Closure</span> <span class="hljs-variable">$next</span></span>): <span class="hljs-title">Response</span>
    </span>{
        <span class="hljs-comment">// 在请求被处理之前执行操作</span>
        <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">'Request received: '</span> . <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">path</span>());
        
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
    }
}
</code></pre>
<p><strong>后置中间件</strong>（在请求处理完成后执行）：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Http</span>\<span class="hljs-title class_">Middleware</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Closure</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">HttpFoundation</span>\<span class="hljs-title">Response</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AfterMiddleware</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span>, <span class="hljs-built_in">Closure</span> <span class="hljs-variable">$next</span></span>): <span class="hljs-title">Response</span>
    </span>{
        <span class="hljs-variable">$response</span> = <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
        
        <span class="hljs-comment">// 在请求被处理之后执行操作</span>
        <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">'Response sent: '</span> . <span class="hljs-variable">$response</span>-&gt;<span class="hljs-title function_ invoke__">getStatusCode</span>());
        
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$response</span>;
    }
}
</code></pre>
<h3 data-id="heading-7">注册中间件</h3>
<p>Laravel 12 有个重大变化：中间件注册不再用 <code>app/Http/Kernel.php</code>，而是移到了 <code>bootstrap/app.php</code>。这样做集中了配置，也更好理解。</p>
<h4 data-id="heading-8">Bootstrap/App.php 的新结构</h4>
<p>Laravel 12 中 <code>bootstrap/app.php</code> 的基本结构长这样：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Foundation</span>\<span class="hljs-title">Application</span>;

<span class="hljs-keyword">return</span> <span class="hljs-title class_">Application</span>::<span class="hljs-title function_ invoke__">configure</span>(<span class="hljs-attr">basePath</span>: <span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-keyword">__DIR__</span>))
    -&gt;<span class="hljs-title function_ invoke__">withRouting</span>(
        <span class="hljs-attr">web</span>: <span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">'/../routes/web.php'</span>,
        <span class="hljs-attr">api</span>: <span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">'/../routes/api.php'</span>,
        <span class="hljs-attr">commands</span>: <span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">'/../routes/console.php'</span>,
        <span class="hljs-attr">health</span>: <span class="hljs-string">'/up'</span>,
    )
    -&gt;<span class="hljs-title function_ invoke__">withMiddleware</span>(function (<span class="hljs-variable">$middleware</span>) {
        <span class="hljs-comment">// 在这里注册 Middleware</span>
    })
    -&gt;<span class="hljs-title function_ invoke__">withExceptions</span>(function (<span class="hljs-variable">$exceptions</span>) {
        <span class="hljs-comment">//</span>
    })
    -&gt;<span class="hljs-title function_ invoke__">create</span>();
</code></pre>
<h4 data-id="heading-9">全局中间件</h4>
<p>全局中间件会在每个 HTTP 请求上运行。注册方式是在 <code>withMiddleware</code> 闭包中用 <code>append</code> 或 <code>prepend</code>：</p>
<pre><code class="hljs language-php" lang="php">-&gt;<span class="hljs-title function_ invoke__">withMiddleware</span>(function (<span class="hljs-variable">$middleware</span>) {
    <span class="hljs-variable">$middleware</span>-&gt;<span class="hljs-title function_ invoke__">append</span>(<span class="hljs-title class_">\App\Http\Middleware\EnsureTokenIsValid</span>::<span class="hljs-variable language_">class</span>);
})
</code></pre>
<p><code>append</code> 会把中间件加到栈的末尾，<code>prepend</code> 则加到开头：</p>
<pre><code class="hljs language-php" lang="php">-&gt;<span class="hljs-title function_ invoke__">withMiddleware</span>(function (<span class="hljs-variable">$middleware</span>) {
    <span class="hljs-variable">$middleware</span>-&gt;<span class="hljs-title function_ invoke__">prepend</span>(<span class="hljs-title class_">\App\Http\Middleware\LogRequests</span>::<span class="hljs-variable language_">class</span>);
    <span class="hljs-variable">$middleware</span>-&gt;<span class="hljs-title function_ invoke__">append</span>(<span class="hljs-title class_">\App\Http\Middleware\CompressResponse</span>::<span class="hljs-variable language_">class</span>);
})
</code></pre>
<h4 data-id="heading-10">路由中间件</h4>
<p>路由中间件只作用于指定的路由或路由组。注册时需要给中间件起个别名，用 <code>alias</code> 方法：</p>
<pre><code class="hljs language-php" lang="php">-&gt;<span class="hljs-title function_ invoke__">withMiddleware</span>(function (<span class="hljs-variable">$middleware</span>) {
    <span class="hljs-variable">$middleware</span>-&gt;<span class="hljs-title function_ invoke__">alias</span>([
        <span class="hljs-string">'admin'</span> =&gt; <span class="hljs-title class_">\App\Http\Middleware\CheckAdmin</span>::<span class="hljs-variable language_">class</span>,
        <span class="hljs-string">'verified.email'</span> =&gt; <span class="hljs-title class_">\App\Http\Middleware\EnsureEmailIsVerified</span>::<span class="hljs-variable language_">class</span>,
        <span class="hljs-string">'check.token'</span> =&gt; <span class="hljs-title class_">\App\Http\Middleware\EnsureTokenIsValid</span>::<span class="hljs-variable language_">class</span>,
    ]);
})
</code></pre>
<h4 data-id="heading-11">中间件组</h4>
<p>中间件组可以把多个中间件打包在一起，方便批量应用：</p>
<pre><code class="hljs language-php" lang="php">-&gt;<span class="hljs-title function_ invoke__">withMiddleware</span>(function (<span class="hljs-variable">$middleware</span>) {
    <span class="hljs-variable">$middleware</span>-&gt;<span class="hljs-title function_ invoke__">appendToGroup</span>(<span class="hljs-string">'api'</span>, [
        <span class="hljs-title class_">\App\Http\Middleware\EncryptCookies</span>::<span class="hljs-variable language_">class</span>,
        <span class="hljs-title class_">\Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse</span>::<span class="hljs-variable language_">class</span>,
    ]);
})
</code></pre>
<p>Laravel 12 已经内置了 <code>web</code> 和 <code>api</code> 组。你可以向它们添加自己的中间件，也可以创建新的组。</p>
<h3 data-id="heading-12">应用中间件到路由</h3>
<p>注册好中间件后，有多种方式可以应用到路由上。</p>
<h4 data-id="heading-13">单个路由</h4>
<p>用 <code>middleware</code> 方法给单个路由加中间件：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Route</span>;

<span class="hljs-title class_">Route</span>::<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">'/dashboard'</span>, function () {
    <span class="hljs-comment">// Dashboard 逻辑</span>
})-&gt;<span class="hljs-title function_ invoke__">middleware</span>(<span class="hljs-string">'auth'</span>);
</code></pre>
<h4 data-id="heading-14">多个中间件</h4>
<p>传一个数组就可以同时应用多个：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title class_">Route</span>::<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">'/admin/settings'</span>, function () {
    <span class="hljs-comment">// 管理员设置</span>
})-&gt;<span class="hljs-title function_ invoke__">middleware</span>([<span class="hljs-string">'auth'</span>, <span class="hljs-string">'admin'</span>, <span class="hljs-string">'verified.email'</span>]);
</code></pre>
<h4 data-id="heading-15">路由组</h4>
<p>给一组路由加中间件：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title class_">Route</span>::<span class="hljs-title function_ invoke__">middleware</span>([<span class="hljs-string">'auth'</span>, <span class="hljs-string">'verified.email'</span>])-&gt;<span class="hljs-title function_ invoke__">group</span>(function () {
    <span class="hljs-title class_">Route</span>::<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">'/profile'</span>, [<span class="hljs-title class_">ProfileController</span>::<span class="hljs-variable language_">class</span>, <span class="hljs-string">'show'</span>]);
    <span class="hljs-title class_">Route</span>::<span class="hljs-title function_ invoke__">put</span>(<span class="hljs-string">'/profile'</span>, [<span class="hljs-title class_">ProfileController</span>::<span class="hljs-variable language_">class</span>, <span class="hljs-string">'update'</span>]);
    <span class="hljs-title class_">Route</span>::<span class="hljs-title function_ invoke__">delete</span>(<span class="hljs-string">'/profile'</span>, [<span class="hljs-title class_">ProfileController</span>::<span class="hljs-variable language_">class</span>, <span class="hljs-string">'destroy'</span>]);
});
</code></pre>
<h4 data-id="heading-16">在控制器中使用</h4>
<p>也可以直接在控制器构造函数中指定：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Http</span>\<span class="hljs-title class_">Controllers</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdminController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"/>)
    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">middleware</span>(<span class="hljs-string">'auth'</span>);
        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">middleware</span>(<span class="hljs-string">'admin'</span>)-&gt;<span class="hljs-title function_ invoke__">only</span>([<span class="hljs-string">'destroy'</span>, <span class="hljs-string">'create'</span>]);
        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">middleware</span>(<span class="hljs-string">'log.request'</span>)-&gt;<span class="hljs-title function_ invoke__">except</span>([<span class="hljs-string">'index'</span>]);
    }
}
</code></pre>
<h3 data-id="heading-17">中间件参数</h3>
<p>中间件可以接收参数，这样能让一个中间件更灵活、更好复用。比如做权限控制或功能开关时就特别有用。</p>
<h4 data-id="heading-18">创建带参数的中间件</h4>
<p>下面是一个检查用户角色的例子：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Http</span>\<span class="hljs-title class_">Middleware</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Closure</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">HttpFoundation</span>\<span class="hljs-title">Response</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CheckRole</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span>, <span class="hljs-built_in">Closure</span> <span class="hljs-variable">$next</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$role</span></span>): <span class="hljs-title">Response</span>
    </span>{
        <span class="hljs-keyword">if</span> (! <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">user</span>() || ! <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">user</span>()-&gt;<span class="hljs-title function_ invoke__">hasRole</span>(<span class="hljs-variable">$role</span>)) {
            <span class="hljs-title function_ invoke__">abort</span>(<span class="hljs-number">403</span>, <span class="hljs-string">'Unauthorized action.'</span>);
        }

        <span class="hljs-keyword">return</span> <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
    }
}
</code></pre>
<h4 data-id="heading-19">使用带参数的中间件</h4>
<p>用冒号把参数传给中间件：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title class_">Route</span>::<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">'/admin/dashboard'</span>, function () {
    <span class="hljs-comment">// 仅限管理员</span>
})-&gt;<span class="hljs-title function_ invoke__">middleware</span>(<span class="hljs-string">'role:admin'</span>);

<span class="hljs-title class_">Route</span>::<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">'/moderator/panel'</span>, function () {
    <span class="hljs-comment">// 仅限版主</span>
})-&gt;<span class="hljs-title function_ invoke__">middleware</span>(<span class="hljs-string">'role:moderator'</span>);
</code></pre>
<p>也可以传多个参数，用逗号隔开：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title class_">Route</span>::<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">'/content/edit'</span>, function () {
    <span class="hljs-comment">// 编辑内容</span>
})-&gt;<span class="hljs-title function_ invoke__">middleware</span>(<span class="hljs-string">'role:admin,editor'</span>);
</code></pre>
<p>中间件会把它们当作独立的参数接收：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span>, <span class="hljs-built_in">Closure</span> <span class="hljs-variable">$next</span>, <span class="hljs-keyword">string</span> ...<span class="hljs-variable">$roles</span></span>): <span class="hljs-title">Response</span>
</span>{
    <span class="hljs-keyword">if</span> (! <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">user</span>() || ! <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">user</span>()-&gt;<span class="hljs-title function_ invoke__">hasAnyRole</span>(<span class="hljs-variable">$roles</span>)) {
        <span class="hljs-title function_ invoke__">abort</span>(<span class="hljs-number">403</span>, <span class="hljs-string">'Unauthorized action.'</span>);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
}
</code></pre>
<h3 data-id="heading-20">依赖注入</h3>
<p>Laravel 的服务容器会解析所有中间件，所以你可以在构造函数中直接注入需要的依赖：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Http</span>\<span class="hljs-title class_">Middleware</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">TokenService</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Closure</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">HttpFoundation</span>\<span class="hljs-title">Response</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ValidateApiToken</span>
</span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$tokenService</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">TokenService <span class="hljs-variable">$tokenService</span></span>)
    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;tokenService = <span class="hljs-variable">$tokenService</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span>, <span class="hljs-built_in">Closure</span> <span class="hljs-variable">$next</span></span>): <span class="hljs-title">Response</span>
    </span>{
        <span class="hljs-variable">$token</span> = <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'X-API-Token'</span>);
        
        <span class="hljs-keyword">if</span> (! <span class="hljs-variable language_">$this</span>-&gt;tokenService-&gt;<span class="hljs-title function_ invoke__">isValid</span>(<span class="hljs-variable">$token</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">response</span>()-&gt;<span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">'error'</span> =&gt; <span class="hljs-string">'Invalid API token'</span>], <span class="hljs-number">401</span>);
        }

        <span class="hljs-keyword">return</span> <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
    }
}
</code></pre>
<h3 data-id="heading-21">可终止中间件</h3>
<p>有时候你想在响应发送给用户之后再做一些事情。这时可以实现 <code>terminate</code> 方法：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Http</span>\<span class="hljs-title class_">Middleware</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Closure</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">HttpFoundation</span>\<span class="hljs-title">Response</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TerminableMiddleware</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span>, <span class="hljs-built_in">Closure</span> <span class="hljs-variable">$next</span></span>): <span class="hljs-title">Response</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">terminate</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span>, Response <span class="hljs-variable">$response</span></span>): <span class="hljs-title">void</span>
    </span>{
        <span class="hljs-comment">// 在响应发送后执行任务</span>
        <span class="hljs-comment">// 这不会延迟对用户的响应</span>
        <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">'Response completed'</span>, [
            <span class="hljs-string">'status'</span> =&gt; <span class="hljs-variable">$response</span>-&gt;<span class="hljs-title function_ invoke__">getStatusCode</span>(),
            <span class="hljs-string">'path'</span> =&gt; <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">path</span>(),
        ]);
    }
}
</code></pre>
<p><code>terminate</code> 方法会在响应发出后才执行，所以不会影响用户体验。适合用来记日志、同步数据或做一些清理工作。</p>
<h3 data-id="heading-22">实际案例</h3>
<p>看几个在生产环境中常用的中间件实现。</p>
<h4 data-id="heading-23">API 限流中间件</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Http</span>\<span class="hljs-title class_">Middleware</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Closure</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Cache</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">HttpFoundation</span>\<span class="hljs-title">Response</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RateLimitApi</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span>, <span class="hljs-built_in">Closure</span> <span class="hljs-variable">$next</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$maxAttempts</span> = <span class="hljs-number">60</span></span>): <span class="hljs-title">Response</span>
    </span>{
        <span class="hljs-variable">$key</span> = <span class="hljs-string">'rate-limit:'</span> . <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">ip</span>();
        <span class="hljs-variable">$attempts</span> = <span class="hljs-title class_">Cache</span>::<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$key</span>, <span class="hljs-number">0</span>);

        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$attempts</span> &gt;= <span class="hljs-variable">$maxAttempts</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">response</span>()-&gt;<span class="hljs-title function_ invoke__">json</span>([
                <span class="hljs-string">'error'</span> =&gt; <span class="hljs-string">'Too many requests. Please try again later.'</span>
            ], <span class="hljs-number">429</span>);
        }

        <span class="hljs-title class_">Cache</span>::<span class="hljs-title function_ invoke__">put</span>(<span class="hljs-variable">$key</span>, <span class="hljs-variable">$attempts</span> + <span class="hljs-number">1</span>, <span class="hljs-title function_ invoke__">now</span>()-&gt;<span class="hljs-title function_ invoke__">addMinute</span>());

        <span class="hljs-variable">$response</span> = <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
        
        <span class="hljs-variable">$response</span>-&gt;headers-&gt;<span class="hljs-title function_ invoke__">set</span>(<span class="hljs-string">'X-RateLimit-Limit'</span>, <span class="hljs-variable">$maxAttempts</span>);
        <span class="hljs-variable">$response</span>-&gt;headers-&gt;<span class="hljs-title function_ invoke__">set</span>(<span class="hljs-string">'X-RateLimit-Remaining'</span>, <span class="hljs-variable">$maxAttempts</span> - <span class="hljs-variable">$attempts</span> - <span class="hljs-number">1</span>);

        <span class="hljs-keyword">return</span> <span class="hljs-variable">$response</span>;
    }
}
</code></pre>
<h4 data-id="heading-24">请求日志中间件</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Http</span>\<span class="hljs-title class_">Middleware</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Closure</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Log</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">HttpFoundation</span>\<span class="hljs-title">Response</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogRequests</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span>, <span class="hljs-built_in">Closure</span> <span class="hljs-variable">$next</span></span>): <span class="hljs-title">Response</span>
    </span>{
        <span class="hljs-variable">$startTime</span> = <span class="hljs-title function_ invoke__">microtime</span>(<span class="hljs-literal">true</span>);
        
        <span class="hljs-variable">$response</span> = <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
        
        <span class="hljs-variable">$duration</span> = <span class="hljs-title function_ invoke__">microtime</span>(<span class="hljs-literal">true</span>) - <span class="hljs-variable">$startTime</span>;
        
        <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">'HTTP Request'</span>, [
            <span class="hljs-string">'method'</span> =&gt; <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">method</span>(),
            <span class="hljs-string">'url'</span> =&gt; <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">fullUrl</span>(),
            <span class="hljs-string">'ip'</span> =&gt; <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">ip</span>(),
            <span class="hljs-string">'user_id'</span> =&gt; <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">user</span>()?-&gt;id,
            <span class="hljs-string">'status'</span> =&gt; <span class="hljs-variable">$response</span>-&gt;<span class="hljs-title function_ invoke__">getStatusCode</span>(),
            <span class="hljs-string">'duration'</span> =&gt; <span class="hljs-title function_ invoke__">round</span>(<span class="hljs-variable">$duration</span> * <span class="hljs-number">1000</span>, <span class="hljs-number">2</span>) . <span class="hljs-string">'ms'</span>,
        ]);

        <span class="hljs-keyword">return</span> <span class="hljs-variable">$response</span>;
    }
}
</code></pre>
<h4 data-id="heading-25">强制 HTTPS 中间件</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Http</span>\<span class="hljs-title class_">Middleware</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Closure</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">HttpFoundation</span>\<span class="hljs-title">Response</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ForceHttps</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span>, <span class="hljs-built_in">Closure</span> <span class="hljs-variable">$next</span></span>): <span class="hljs-title">Response</span>
    </span>{
        <span class="hljs-keyword">if</span> (! <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">secure</span>() &amp;&amp; <span class="hljs-title function_ invoke__">app</span>()-&gt;<span class="hljs-title function_ invoke__">environment</span>(<span class="hljs-string">'production'</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">redirect</span>()-&gt;<span class="hljs-title function_ invoke__">secure</span>(<span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">getRequestUri</span>(), <span class="hljs-number">301</span>);
        }

        <span class="hljs-keyword">return</span> <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
    }
}
</code></pre>
<h4 data-id="heading-26">输入清理中间件</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Http</span>\<span class="hljs-title class_">Middleware</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Closure</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">HttpFoundation</span>\<span class="hljs-title">Response</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SanitizeInput</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span>, <span class="hljs-built_in">Closure</span> <span class="hljs-variable">$next</span></span>): <span class="hljs-title">Response</span>
    </span>{
        <span class="hljs-variable">$input</span> = <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">all</span>();
        
        <span class="hljs-title function_ invoke__">array_walk_recursive</span>(<span class="hljs-variable">$input</span>, function (&amp;<span class="hljs-variable">$value</span>) {
            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$value</span>)) {
                <span class="hljs-variable">$value</span> = <span class="hljs-title function_ invoke__">strip_tags</span>(<span class="hljs-variable">$value</span>);
                <span class="hljs-variable">$value</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$value</span>);
            }
        });
        
        <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">merge</span>(<span class="hljs-variable">$input</span>);

        <span class="hljs-keyword">return</span> <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
    }
}
</code></pre>
<h4 data-id="heading-27">语言切换中间件</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Http</span>\<span class="hljs-title class_">Middleware</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Closure</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">App</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">HttpFoundation</span>\<span class="hljs-title">Response</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SetLocale</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span>, <span class="hljs-built_in">Closure</span> <span class="hljs-variable">$next</span></span>): <span class="hljs-title">Response</span>
    </span>{
        <span class="hljs-variable">$locale</span> = <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">segment</span>(<span class="hljs-number">1</span>);
        <span class="hljs-variable">$availableLocales</span> = [<span class="hljs-string">'en'</span>, <span class="hljs-string">'es'</span>, <span class="hljs-string">'fr'</span>, <span class="hljs-string">'de'</span>];
        
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$locale</span>, <span class="hljs-variable">$availableLocales</span>)) {
            <span class="hljs-title class_">App</span>::<span class="hljs-title function_ invoke__">setLocale</span>(<span class="hljs-variable">$locale</span>);
        }

        <span class="hljs-keyword">return</span> <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
    }
}
</code></pre>
<h3 data-id="heading-28">Laravel 内置的中间件</h3>
<p>Laravel 12 内置了一些强大的中间件来处理常见任务：</p>
<h4 data-id="heading-29">身份验证</h4>
<ul>
<li><strong>Authenticate</strong>：确保用户已登录</li>
<li><strong>RedirectIfAuthenticated</strong>：已登录用户访问登录页时自动跳转</li>
</ul>
<h4 data-id="heading-30">CSRF 保护</h4>
<ul>
<li><strong>VerifyCsrfToken</strong>：防止 POST、PUT、PATCH 和 DELETE 请求的跨站请求伪造攻击</li>
</ul>
<h4 data-id="heading-31">Session 管理</h4>
<ul>
<li><strong>StartSession</strong>：处理 Session 数据</li>
<li><strong>ShareErrorsFromSession</strong>：把验证错误传递给视图</li>
</ul>
<h4 data-id="heading-32">Cookie 加密</h4>
<ul>
<li><strong>EncryptCookies</strong>：自动加密解密 Cookie</li>
<li><strong>AddQueuedCookiesToResponse</strong>：把队列中的 Cookie 加入响应</li>
</ul>
<h4 data-id="heading-33">安全相关</h4>
<ul>
<li><strong>HandleCors</strong>：处理跨域请求 (CORS)</li>
<li><strong>TrustProxies</strong>：配置可信代理，用于负载均衡场景</li>
</ul>
<h4 data-id="heading-34">维护模式</h4>
<ul>
<li><strong>PreventRequestsDuringMaintenance</strong>：维护模式下阻止请求</li>
</ul>
<h3 data-id="heading-35">最佳实践</h3>
<p>跟着这些建议做，可以让你的中间件更好维护、更安全、性能也更好：</p>
<h4 data-id="heading-36">保持简单专注</h4>
<p>一个中间件只做一件事。如果一个中间件做的事情太多，就该拆分了：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 坏例子：一个中间件做太多事</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HandleRequestMiddleware</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params"><span class="hljs-variable">$request</span>, <span class="hljs-variable">$next</span></span>)
    </span>{
        <span class="hljs-comment">// 认证</span>
        <span class="hljs-comment">// 验证</span>
        <span class="hljs-comment">// 日志</span>
        <span class="hljs-comment">// 转换数据</span>
        <span class="hljs-comment">// 等等...</span>
    }
}

<span class="hljs-comment">// 好例子：拆分成多个中间件</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthenticateMiddleware</span> </span>{ }
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ValidateRequestMiddleware</span> </span>{ }
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogRequestMiddleware</span> </span>{ }
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransformRequestMiddleware</span> </span>{ }
</code></pre>
<h4 data-id="heading-37">用参数提高灵活性</h4>
<p>让中间件接受参数，能提高复用性：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 不要创建 CheckAdminMiddleware、CheckModeratorMiddleware 等</span>
<span class="hljs-comment">// 写一个灵活的就够了</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CheckRole</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params"><span class="hljs-variable">$request</span>, <span class="hljs-variable">$next</span>, ...<span class="hljs-variable">$roles</span></span>)
    </span>{
        <span class="hljs-keyword">if</span> (! <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">user</span>()-&gt;<span class="hljs-title function_ invoke__">hasAnyRole</span>(<span class="hljs-variable">$roles</span>)) {
            <span class="hljs-title function_ invoke__">abort</span>(<span class="hljs-number">403</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
    }
}

<span class="hljs-comment">// 使用方式</span>
<span class="hljs-title class_">Route</span>::<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">'/admin'</span>, fn() =&gt; <span class="hljs-string">'...'</span>)-&gt;<span class="hljs-title function_ invoke__">middleware</span>(<span class="hljs-string">'role:admin'</span>);
<span class="hljs-title class_">Route</span>::<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">'/content'</span>, fn() =&gt; <span class="hljs-string">'...'</span>)-&gt;<span class="hljs-title function_ invoke__">middleware</span>(<span class="hljs-string">'role:admin,editor'</span>);
</code></pre>
<h4 data-id="heading-38">注意执行顺序</h4>
<p>中间件的顺序很重要。认证中间件应该放在需要用户信息的中间件之前：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title class_">Route</span>::<span class="hljs-title function_ invoke__">middleware</span>([<span class="hljs-string">'auth'</span>, <span class="hljs-string">'verified'</span>, <span class="hljs-string">'role:admin'</span>])-&gt;<span class="hljs-title function_ invoke__">group</span>(function () {
    <span class="hljs-comment">// 这里的路由</span>
});
</code></pre>
<h4 data-id="heading-39">不要滥用</h4>
<p>不是所有逻辑都适合放在中间件里。中间件适合处理多个路由的通用逻辑。如果是特定路由的逻辑，考虑用：</p>
<ul>
<li>控制器方法</li>
<li>表单请求验证类</li>
<li>服务类</li>
<li>路由模型绑定</li>
</ul>
<h4 data-id="heading-40">优化性能</h4>
<p>中间件逻辑要尽量轻量。如果有耗时操作：</p>
<ul>
<li>用缓存避免重复计算</li>
<li>把耗时任务放到队列</li>
<li>用可终止中间件做响应后处理</li>
</ul>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params"><span class="hljs-variable">$request</span>, <span class="hljs-variable">$next</span></span>)
</span>{
    <span class="hljs-comment">// 只做快速检查</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Cache</span>::<span class="hljs-title function_ invoke__">has</span>(<span class="hljs-string">'user-banned:'</span> . <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">user</span>()-&gt;id)) {
        <span class="hljs-title function_ invoke__">abort</span>(<span class="hljs-number">403</span>);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
}

<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">terminate</span>(<span class="hljs-params"><span class="hljs-variable">$request</span>, <span class="hljs-variable">$response</span></span>)
</span>{
    <span class="hljs-comment">// 耗时操作放到响应后</span>
    <span class="hljs-title class_">SomeHeavyJob</span>::<span class="hljs-title function_ invoke__">dispatch</span>(<span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">user</span>());
}
</code></pre>
<h4 data-id="heading-41">处理好异常</h4>
<p>中间件里要做好异常处理，避免应用崩溃：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params"><span class="hljs-variable">$request</span>, <span class="hljs-variable">$next</span></span>)
</span>{
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 验证 Token</span>
        <span class="hljs-variable">$token</span> = <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'X-API-Token'</span>);
        <span class="hljs-variable language_">$this</span>-&gt;tokenService-&gt;<span class="hljs-title function_ invoke__">validate</span>(<span class="hljs-variable">$token</span>);
    } <span class="hljs-keyword">catch</span> (InvalidTokenException <span class="hljs-variable">$e</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">response</span>()-&gt;<span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">'error'</span> =&gt; <span class="hljs-string">'Invalid token'</span>], <span class="hljs-number">401</span>);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
}
</code></pre>
<h4 data-id="heading-42">写测试</h4>
<p>给中间件写测试，确保它们正常工作：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Tests</span>\<span class="hljs-title class_">Feature</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Tests</span>\<span class="hljs-title">TestCase</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CheckAdminMiddlewareTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test_non_admin_cannot_access_admin_routes</span>(<span class="hljs-params"/>)
    </span>{
        <span class="hljs-variable">$user</span> = <span class="hljs-title class_">User</span>::<span class="hljs-title function_ invoke__">factory</span>()-&gt;<span class="hljs-title function_ invoke__">create</span>([<span class="hljs-string">'role'</span> =&gt; <span class="hljs-string">'user'</span>]);
        
        <span class="hljs-variable">$response</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">actingAs</span>(<span class="hljs-variable">$user</span>)-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">'/admin/dashboard'</span>);
        
        <span class="hljs-variable">$response</span>-&gt;<span class="hljs-title function_ invoke__">assertStatus</span>(<span class="hljs-number">403</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test_admin_can_access_admin_routes</span>(<span class="hljs-params"/>)
    </span>{
        <span class="hljs-variable">$admin</span> = <span class="hljs-title class_">User</span>::<span class="hljs-title function_ invoke__">factory</span>()-&gt;<span class="hljs-title function_ invoke__">create</span>([<span class="hljs-string">'role'</span> =&gt; <span class="hljs-string">'admin'</span>]);
        
        <span class="hljs-variable">$response</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">actingAs</span>(<span class="hljs-variable">$admin</span>)-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">'/admin/dashboard'</span>);
        
        <span class="hljs-variable">$response</span>-&gt;<span class="hljs-title function_ invoke__">assertStatus</span>(<span class="hljs-number">200</span>);
    }
}
</code></pre>
<h4 data-id="heading-43">加上类型声明</h4>
<p>用上 PHP 的类型系统，IDE 也能更好地提示：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">HttpFoundation</span>\<span class="hljs-title">Response</span>;

<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span>, <span class="hljs-built_in">Closure</span> <span class="hljs-variable">$next</span></span>): <span class="hljs-title">Response</span>
</span>{
    <span class="hljs-comment">// 实现</span>
}
</code></pre>
<h4 data-id="heading-44">注释要清楚</h4>
<p>如果中间件有参数，记得加注释说明：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">/**
 * 检查用户是否具有所需角色。
 *
 * <span class="hljs-doctag">@param</span>  \Illuminate\Http\Request  $request
 * <span class="hljs-doctag">@param</span>  \Closure  $next
 * <span class="hljs-doctag">@param</span>  string  ...$roles  所需角色（admin、editor、moderator）
 * <span class="hljs-doctag">@return</span> \Symfony\Component\HttpFoundation\Response
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span>, <span class="hljs-built_in">Closure</span> <span class="hljs-variable">$next</span>, <span class="hljs-keyword">string</span> ...<span class="hljs-variable">$roles</span></span>): <span class="hljs-title">Response</span>
</span>{
    <span class="hljs-comment">// 实现</span>
}
</code></pre>
<h3 data-id="heading-45">安全相关</h3>
<p>中间件在应用安全中很关键。注意这几点：</p>
<h4 data-id="heading-46">别忘了 CSRF 保护</h4>
<p>Laravel 的 <code>VerifyCsrfToken</code> 中间件要加入 web 组，用来保护所有修改数据的请求：</p>
<pre><code class="hljs language-php" lang="php">-&gt;<span class="hljs-title function_ invoke__">withMiddleware</span>(function (<span class="hljs-variable">$middleware</span>) {
    <span class="hljs-variable">$middleware</span>-&gt;<span class="hljs-title function_ invoke__">appendToGroup</span>(<span class="hljs-string">'web'</span>, [
        <span class="hljs-title class_">\Illuminate\Foundation\Http\Middleware\VerifyCsrfToken</span>::<span class="hljs-variable language_">class</span>,
    ]);
})
</code></pre>
<h4 data-id="heading-47">API Token 验证</h4>
<p>API 路由要做好 Token 验证：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params"><span class="hljs-variable">$request</span>, <span class="hljs-variable">$next</span></span>)
</span>{
    <span class="hljs-variable">$token</span> = <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">bearerToken</span>();
    
    <span class="hljs-keyword">if</span> (! <span class="hljs-variable">$token</span> || ! <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">isValidToken</span>(<span class="hljs-variable">$token</span>)) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">response</span>()-&gt;<span class="hljs-title function_ invoke__">json</span>([<span class="hljs-string">'error'</span> =&gt; <span class="hljs-string">'Unauthorized'</span>], <span class="hljs-number">401</span>);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
}
</code></pre>
<h4 data-id="heading-48">限流保护</h4>
<p>加上限流，防止被恶意攻击，特别是 API 和登录接口：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title class_">Route</span>::<span class="hljs-title function_ invoke__">middleware</span>([<span class="hljs-string">'throttle:60,1'</span>])-&gt;<span class="hljs-title function_ invoke__">group</span>(function () {
    <span class="hljs-comment">// 每分钟最多 60 次请求</span>
});
</code></pre>
<h4 data-id="heading-49">输入清理</h4>
<p>虽然 Laravel 已经有 CSRF 和 SQL 注入防护，但在中间件里再加一层清理也不错：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params"><span class="hljs-variable">$request</span>, <span class="hljs-variable">$next</span></span>)
</span>{
    <span class="hljs-variable">$input</span> = <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">all</span>();
    
    <span class="hljs-title function_ invoke__">array_walk_recursive</span>(<span class="hljs-variable">$input</span>, function (&amp;<span class="hljs-variable">$value</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$value</span>)) {
            <span class="hljs-variable">$value</span> = <span class="hljs-title function_ invoke__">htmlspecialchars</span>(<span class="hljs-variable">$value</span>, ENT_QUOTES, <span class="hljs-string">'UTF-8'</span>);
        }
    });
    
    <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">merge</span>(<span class="hljs-variable">$input</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
}
</code></pre>
<h4 data-id="heading-50">敏感路由要保护好</h4>
<p>给敏感路由加多层中间件保护：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title class_">Route</span>::<span class="hljs-title function_ invoke__">middleware</span>([<span class="hljs-string">'auth'</span>, <span class="hljs-string">'verified'</span>, <span class="hljs-string">'2fa'</span>, <span class="hljs-string">'role:admin'</span>])-&gt;<span class="hljs-title function_ invoke__">group</span>(function () {
    <span class="hljs-comment">// 敏感的管理后台路由</span>
});
</code></pre>
<h3 data-id="heading-51">调试技巧</h3>
<p>如果中间件不正常，试试这些方法：</p>
<h4 data-id="heading-52">启用查询日志</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params"><span class="hljs-variable">$request</span>, <span class="hljs-variable">$next</span></span>)
</span>{
    DB::<span class="hljs-title function_ invoke__">enableQueryLog</span>();
    
    <span class="hljs-variable">$response</span> = <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
    
    <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">debug</span>(<span class="hljs-string">'Queries executed:'</span>, DB::<span class="hljs-title function_ invoke__">getQueryLog</span>());
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$response</span>;
}
</code></pre>
<h4 data-id="heading-53">记录执行日志</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params"><span class="hljs-variable">$request</span>, <span class="hljs-variable">$next</span></span>)
</span>{
    <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">debug</span>(<span class="hljs-string">'Middleware executed: '</span> . <span class="hljs-built_in">static</span>::<span class="hljs-variable language_">class</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
}
</code></pre>
<h4 data-id="heading-54">用 Telescope 调试</h4>
<p>Laravel Telescope 能帮你监控中间件执行、请求处理和性能指标。开发环境安装一下：</p>
<pre><code class="hljs language-bash" lang="bash">composer require laravel/telescope --dev
php artisan telescope:install
php artisan migrate
</code></pre>
<h3 data-id="heading-55">中间件 vs. 其他功能</h3>
<p>什么时候用中间件，什么时候用其他特性？看这里：</p>
<h4 data-id="heading-56">vs. Form Requests</h4>
<ul>
<li><strong>用中间件</strong>：多个路由的通用逻辑</li>
<li><strong>用 Form Request</strong>：单个路由的验证逻辑</li>
</ul>
<h4 data-id="heading-57">vs. Gates 和 Policies</h4>
<ul>
<li><strong>用中间件</strong>：路由级别的权限检查</li>
<li><strong>用 Gates/Policies</strong>：控制器里的资源权限检查</li>
</ul>
<h4 data-id="heading-58">vs. Service 类</h4>
<ul>
<li><strong>用中间件</strong>：HTTP 请求/响应相关的操作</li>
<li><strong>用 Service 类</strong>：跟 HTTP 无关的业务逻辑</li>
</ul>
<h4 data-id="heading-59">vs. Events 和 Listeners</h4>
<ul>
<li><strong>用中间件</strong>：同步处理请求/响应</li>
<li><strong>用 Events/Listeners</strong>：解耦的、可能异步的操作</li>
</ul>
<h3 data-id="heading-60">性能优化</h3>
<p>这些方法能提升中间件性能：</p>
<h4 data-id="heading-61">缓存耗时操作</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params"><span class="hljs-variable">$request</span>, <span class="hljs-variable">$next</span></span>)
</span>{
    <span class="hljs-variable">$userId</span> = <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">user</span>()-&gt;id;
    <span class="hljs-variable">$permissions</span> = <span class="hljs-title class_">Cache</span>::<span class="hljs-title function_ invoke__">remember</span>(
        <span class="hljs-string">"user-permissions:<span class="hljs-subst">{$userId}</span>"</span>,
        <span class="hljs-number">3600</span>,
        fn() =&gt; <span class="hljs-variable language_">$this</span>-&gt;permissionService-&gt;<span class="hljs-title function_ invoke__">getUserPermissions</span>(<span class="hljs-variable">$userId</span>)
    );
    
    <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">merge</span>([<span class="hljs-string">'permissions'</span> =&gt; <span class="hljs-variable">$permissions</span>]);
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
}
</code></pre>
<h4 data-id="heading-62">尽早返回</h4>
<p>不符合条件就赶紧返回，别继续执行：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params"><span class="hljs-variable">$request</span>, <span class="hljs-variable">$next</span></span>)
</span>{
    <span class="hljs-keyword">if</span> (! <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">user</span>()) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">redirect</span>(<span class="hljs-string">'/login'</span>);
    }
    
    <span class="hljs-keyword">if</span> (! <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">user</span>()-&gt;<span class="hljs-title function_ invoke__">isActive</span>()) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">response</span>(<span class="hljs-string">'Account suspended'</span>, <span class="hljs-number">403</span>);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
}
</code></pre>
<h4 data-id="heading-63">按需加载</h4>
<p>不要一开始就加载所有依赖，用到再加载：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params"><span class="hljs-variable">$request</span>, <span class="hljs-variable">$next</span></span>)
</span>{
    <span class="hljs-comment">// 仅在需要时加载服务</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">has</span>(<span class="hljs-string">'validate'</span>)) {
        <span class="hljs-title function_ invoke__">app</span>(<span class="hljs-title class_">ValidationService</span>::<span class="hljs-variable language_">class</span>)-&gt;<span class="hljs-title function_ invoke__">validate</span>(<span class="hljs-variable">$request</span>);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
}
</code></pre>
<h3 data-id="heading-64">常见错误</h3>
<p>写中间件时避免这些坑：</p>
<h4 data-id="heading-65">忘记 return</h4>
<p>必须 return <code>$next($request)</code> 的结果：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 错误</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params"><span class="hljs-variable">$request</span>, <span class="hljs-variable">$next</span></span>)
</span>{
    <span class="hljs-keyword">if</span> (! <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">user</span>()) {
        <span class="hljs-title function_ invoke__">redirect</span>(<span class="hljs-string">'/login'</span>); <span class="hljs-comment">// 缺少 return！</span>
    }
    <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>); <span class="hljs-comment">// 缺少 return！</span>
}

<span class="hljs-comment">// 正确</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params"><span class="hljs-variable">$request</span>, <span class="hljs-variable">$next</span></span>)
</span>{
    <span class="hljs-keyword">if</span> (! <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">user</span>()) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">redirect</span>(<span class="hljs-string">'/login'</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
}
</code></pre>
<h4 data-id="heading-66">在 $next 之后改请求</h4>
<p>调用 <code>$next()</code> 后再改请求已经没用了：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 错误</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params"><span class="hljs-variable">$request</span>, <span class="hljs-variable">$next</span></span>)
</span>{
    <span class="hljs-variable">$response</span> = <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
    <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">merge</span>([<span class="hljs-string">'foo'</span> =&gt; <span class="hljs-string">'bar'</span>]); <span class="hljs-comment">// 已经晚了</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$response</span>;
}

<span class="hljs-comment">// 正确</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params"><span class="hljs-variable">$request</span>, <span class="hljs-variable">$next</span></span>)
</span>{
    <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">merge</span>([<span class="hljs-string">'foo'</span> =&gt; <span class="hljs-string">'bar'</span>]);
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$next</span>(<span class="hljs-variable">$request</span>);
}
</code></pre>
<h4 data-id="heading-67">忘记注册</h4>
<p>用之前记得在 <code>bootstrap/app.php</code> 里注册。</p>
<h4 data-id="heading-68">顺序错了</h4>
<p>注意顺序，认证要放在权限检查之前：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 错误的顺序</span>
<span class="hljs-title class_">Route</span>::<span class="hljs-title function_ invoke__">middleware</span>([<span class="hljs-string">'role:admin'</span>, <span class="hljs-string">'auth'</span>])

<span class="hljs-comment">// 正确的顺序</span>
<span class="hljs-title class_">Route</span>::<span class="hljs-title function_ invoke__">middleware</span>([<span class="hljs-string">'auth'</span>, <span class="hljs-string">'role:admin'</span>])
</code></pre>
<h3 data-id="heading-69">从 Laravel 11 升级</h3>
<p>如果你是从 Laravel 11 升级来的，中间件注册方式改了：</p>
<h4 data-id="heading-70">老写法（Laravel 11）</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">protected</span> <span class="hljs-variable">$middleware</span> = [
    <span class="hljs-title class_">\App\Http\Middleware\TrustProxies</span>::<span class="hljs-variable language_">class</span>,
];

<span class="hljs-keyword">protected</span> <span class="hljs-variable">$middlewareGroups</span> = [
    <span class="hljs-string">'web'</span> =&gt; [
        <span class="hljs-title class_">\App\Http\Middleware\EncryptCookies</span>::<span class="hljs-variable language_">class</span>,
    ],
];

<span class="hljs-keyword">protected</span> <span class="hljs-variable">$routeMiddleware</span> = [
    <span class="hljs-string">'auth'</span> =&gt; <span class="hljs-title class_">\App\Http\Middleware\Authenticate</span>::<span class="hljs-variable language_">class</span>,
];
</code></pre>
<h4 data-id="heading-71">新写法（Laravel 12）</h4>
<pre><code class="hljs language-php" lang="php">-&gt;<span class="hljs-title function_ invoke__">withMiddleware</span>(function (<span class="hljs-variable">$middleware</span>) {
    <span class="hljs-comment">// 全局 Middleware</span>
    <span class="hljs-variable">$middleware</span>-&gt;<span class="hljs-title function_ invoke__">append</span>(<span class="hljs-title class_">\App\Http\Middleware\TrustProxies</span>::<span class="hljs-variable language_">class</span>);
    
    <span class="hljs-comment">// Middleware 组</span>
    <span class="hljs-variable">$middleware</span>-&gt;<span class="hljs-title function_ invoke__">appendToGroup</span>(<span class="hljs-string">'web'</span>, [
        <span class="hljs-title class_">\App\Http\Middleware\EncryptCookies</span>::<span class="hljs-variable language_">class</span>,
    ]);
    
    <span class="hljs-comment">// 路由 Middleware 别名</span>
    <span class="hljs-variable">$middleware</span>-&gt;<span class="hljs-title function_ invoke__">alias</span>([
        <span class="hljs-string">'auth'</span> =&gt; <span class="hljs-title class_">\App\Http\Middleware\Authenticate</span>::<span class="hljs-variable language_">class</span>,
    ]);
})
</code></pre>
<h3 data-id="heading-72">总结</h3>
<p>Laravel 中间件是个强大的特性，能以干净、可复用的方式处理通用逻辑。掌握好中间件的用法和最佳实践，就能写出更安全、更好维护、性能更好的 Laravel 应用。</p>
<h4 data-id="heading-73">重点回顾：</h4>
<ul>
<li>中间件是 HTTP 请求的过滤器</li>
<li>Laravel 12 把注册从 <code>Kernel.php</code> 移到了 <code>bootstrap/app.php</code></li>
<li>有全局、路由和组三种中间件</li>
<li>中间件可以接收参数，提高灵活性</li>
<li>保持简单专注，记得写测试</li>
<li>适用于安全、日志、数据转换等通用场景</li>
<li>注重性能、安全和可维护性</li>
</ul>
<p>随着使用的深入，你会发现更多中间件的用法，也会形成自己的实现模式。记住一点：中间件要保持专注、逻辑清晰、文档齐全。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kafka消息中间件核心知识点详解总结]]></title>    <link>https://juejin.cn/post/7570268773333188635</link>    <guid>https://juejin.cn/post/7570268773333188635</guid>    <pubDate>2025-11-09T17:49:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570268773333188635" data-draft-id="7561298575881109538" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kafka消息中间件核心知识点详解总结"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-09T17:49:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="随风飘的云"/> <meta itemprop="url" content="https://juejin.cn/user/361110952753560"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kafka消息中间件核心知识点详解总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/361110952753560/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    随风飘的云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T17:49:34.000Z" title="Sun Nov 09 2025 17:49:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1小时+
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">kafka的架构</h2>
<p><strong>1. Kafka架构的核心组件</strong></p>
<ul>
<li><strong>producer组件：</strong> 消息生产者，支持异步推送消息到制定的Topic。</li>
<li><strong>Consumer组件：</strong> 从 Topic 订阅读取消息的客户端。Consumer Group 协同消费。</li>
<li><strong>Broker组件：</strong> Kafka 服务器节点，存储消息、处理请求、管理副本、参与集群协调</li>
<li><strong>Topic组件：</strong> 消息的逻辑分类/数据流名称。</li>
<li><strong>Partition组件：</strong> Topic 的物理分片。</li>
<li>‌<strong>Replica组件：</strong> Partition 的冗余拷贝 (Leader/Follower)。</li>
<li><strong>ZooKeeper/KRaft：</strong> 集群元数据管理与协调中心<strong>‌ (传统/新架构)</strong> 。</li>
<li>‌<strong>Controller：</strong> <strong>集群的“大脑”</strong> ‌ (传统模式核心，KRaft集成)。监控状态、触发 Leader 选举。</li>
</ul>
<p>以下图示展示了kafka消息写入的整体流程</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c09a057f98a4061a9f7ae163cf64a2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZqP6aOO6aOY55qE5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763315526&amp;x-signature=rfzT14iSEJM42So35y6cqFi%2FDRk%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">kafka为什么这么快</h2>
<p>kafka可以以‌<strong>超高吞吐、低延迟</strong>‌处理海量数据，核心在于其架构设计和一系列深度优化机制，<strong>能够最大化利用硬件的特性（磁盘顺序IO，OS页缓存，多核CPU）,最小化无效开销（数据拷贝、线程切换、网络请求、锁竞争）</strong></p>
<h3 data-id="heading-2">1、顺序追加写入</h3>
<p>Kafka 的每个 Partition 本质是一个 “Append-Only 日志文件”（仅在文件末尾追加写入，不修改、不删除已有数据）：</p>
<ul>
<li>生产端： 消息按照顺序写入Partition尾部，完全按照顺序IO（无寻道时间，无扇区切换开销）</li>
<li>消费端： 按offset顺序读写消息（从旧到新）同样是顺序IO（避免随机跳读）</li>
<li>对比传统 MQ：传统 MQ 常需要随机写入（如按消息 ID 插入、删除过期消息），随机 IO 成为性能瓶颈，而 Kafka 的 “顺序 append” 彻底规避了这一问题。</li>
</ul>
<h3 data-id="heading-3">2、日志分段（Log segmentation）: 避免大文件性能退化</h3>
<p>如果一个Partition对应一个超大文件，会导致：磁盘寻道时间增加；日志清理（删除过期数据）效率低；索引文件过大。解决方案是将日志分段</p>
<ul>
<li>每个 Partition 的日志被拆分为多个 “段文件”（默认每个段文件大小 1GB，可通过 <code>log.segment.bytes</code> 调整）；</li>
<li>新消息写入最新的段文件，旧段文件达到阈值后关闭，后续仅用于读取；</li>
<li>日志清理（按 <code>log.retention</code> 策略删除过期数据）时，直接删除整个旧段文件（而非修改文件内容），开销极低；</li>
<li>每个段文件对应独立的索引文件（.index），缩小索引范围，提升查找效率。</li>
</ul>
<h3 data-id="heading-4">3、稀疏索引：快速定位消息，不必占用过多的内存</h3>
<p>Kafka 为每个段文件创建 “稀疏索引”（而非稠密索引）</p>
<ul>
<li>索引文件中仅存储部分消息的offset-&gt; <strong>物理文件位置的映射</strong>（默认每4KB数据记录一条索引），可以通过<strong>log.index.interval.bytes</strong>调整</li>
<li>查找指定的offset时，先通过二分查找定位到索引文件对应的区间，再在段文件中顺序扫描少量的数据，平衡<strong>索引大小</strong>和<strong>查找速度</strong></li>
<li>索引文件体积小（仅为数据文件的 0.1%~0.5%），可被 OS 页缓存完全加载，查找耗时控制在毫秒级。</li>
</ul>
<h3 data-id="heading-5">4、充分利用 OS 页缓存（Page Cache）：避免重复 IO</h3>
<p>Kafka 不自己实现缓存层，而是完全依赖操作系统的 “页缓存”（内存中的磁盘数据缓存）：</p>
<ul>
<li>生产端写入的消息先进入页缓存，由 OS 异步刷盘（默认策略），避免应用层缓存的内存管理开销；</li>
<li>消费端读取消息时，优先从页缓存命中（热点数据几乎无需磁盘 IO），仅当页缓存未命中时才读取磁盘；</li>
<li>优势：页缓存由 OS 内核管理，比应用层缓存更高效（内核级优化），且能充分利用空闲内存（Kafka 进程本身占用内存极低，大部分内存可作为页缓存）。</li>
</ul>
<h3 data-id="heading-6">5、零拷贝（Zero-Copy）技术，减少 2 次数据拷贝</h3>
<p>传统数据传输（从磁盘文件到网络发送）的流程是：<code>磁盘 → 内核态页缓存 → 用户态应用缓存 → 内核态 Socket 缓存 → 网卡</code>（4 次数据拷贝，2 次用户态 / 内核态切换）</p>
<p>Kafka 利用 Linux 的 <code>sendfile()</code> 系统调用实现 “零拷贝”，流程简化为：<code>磁盘 → 内核态页缓存 → 网卡</code>（仅 2 次数据拷贝，0 次用户态 / 内核态切换）</p>
<ul>
<li>适用场景：消费端读取消息并通过网络传输（如消费者拉取消息、Broker 间副本同步）；</li>
<li>性能提升：减少 CPU 开销（避免数据在用户态和内核态之间拷贝），同时降低内存带宽占用，实测可提升 30%~50% 的吞吐量。</li>
</ul>
<h3 data-id="heading-7">6、批量传输：减少网络请求次数</h3>
<p>Kafka 支持 “批量发送” 和 “批量拉取”，大幅减少网络往返次数（网络请求的延迟远高于数据传输延迟）：</p>
<ul>
<li>
<p><strong>生产端批量发送</strong>：</p>
<ul>
<li>生产者将消息缓存到本地缓冲区，满足以下条件之一时批量发送：① 缓冲区达到阈值（<code>batch.size</code>，默认 16KB）；② 等待时间达到阈值（<code>linger.ms</code>，默认 0ms，即立即发送，生产环境建议设为 5~10ms 凑批量）；</li>
<li>批量发送可将单条消息的网络开销平摊到多条消息上，提升吞吐量（如批量发送 1000 条消息，仅需 1 次网络请求，而非 1000 次）。</li>
</ul>
</li>
<li>
<p><strong>消费端批量拉取</strong>：</p>
<ul>
<li>消费者通过 <code>fetch.min.bytes</code>（默认 1B）设置 “最小拉取数据量”（不足时等待），通过 <code>fetch.max.bytes</code>（默认 50MB）设置 “最大拉取数据量”，避免频繁拉取小批量数据；</li>
<li>一次拉取多条消息，减少网络请求次数，同时降低消费者线程切换开销。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">7、数据压缩：减少传输带宽和存储开销</h3>
<p>Kafka 支持在生产端对批量消息进行压缩，再传输到 Broker，消费端解压后处理：</p>
<ul>
<li>支持的压缩算法：GZIP、Snappy、LZ4、ZSTD（生产推荐 Snappy/LZ4，平衡压缩比和 CPU 开销）；</li>
<li>优势：① 减少网络传输带宽（压缩比可达 3~10 倍，如 JSON 消息压缩后体积大幅减小）；② 减少 Broker 存储开销；③ 批量越大，压缩效率越高（批量消息的冗余度更高）；</li>
<li>配置方式：生产端设置 <code>compression.type=snappy</code>（默认 none），Broker 和消费端自动解压（无需额外配置）。</li>
</ul>
<h3 data-id="heading-9">8、协议精简：基于 TCP 长连接 + 二进制协议</h3>
<ul>
<li><strong>TCP 长连接</strong>：生产者 / 消费者与 Broker 建立 TCP 长连接（而非短连接），避免频繁三次握手 / 四次挥手的开销，同时支持连接复用（一个连接可传输多个 Topic/Partition 的消息）；</li>
<li><strong>二进制协议</strong>：Kafka 自定义的协议（而非 HTTP 等文本协议），消息头小、解析快，减少序列化 / 反序列化开销；</li>
<li><strong>无状态 Broker</strong>：Broker 不存储生产者 / 消费者的状态（如消费进度 offset 存储在 <code>__consumer_offsets</code> Topic 中），减少 Broker 内存占用和状态维护开销，支持水平扩展。</li>
</ul>
<h3 data-id="heading-10">9、并发模型优化：分区并行 + 无锁设计，最大化利用多核 CPU</h3>
<p>Kafka 通过 “分区并行” 和 “高效线程模型”，充分利用多核 CPU 资源，避免线程竞争和切换开销。</p>
<h4 data-id="heading-11">1. 核心：分区（Partition）作为并行单位</h4>
<p>Kafka 的 Topic 被拆分为多个 Partition，每个 Partition 是独立的读写单元，支持：</p>
<ul>
<li><strong>生产端并行写入</strong>：不同 Partition 可同时被多个生产者写入（无需锁竞争），Partition 数量越多，并行写入能力越强；</li>
<li><strong>消费端并行消费</strong>：消费者组（Consumer Group）中，每个消费者实例分配一个或多个 Partition（一个 Partition 仅分配给一个消费者），实现并行消费（如 10 个 Partition 可被 10 个消费者同时消费，吞吐量线性提升）；</li>
<li><strong>Broker 并行处理</strong>：不同 Partition 的消息存储在不同 Broker 或磁盘分区上，可并行读写，避免单 Partition 瓶颈。</li>
</ul>
<h4 data-id="heading-12">2. 线程模型：Reactor 模式 + 单线程处理网络事件</h4>
<p>Kafka Broker 采用 “Reactor 模式” 设计线程模型，避免频繁线程切换：</p>
<ul>
<li><strong>Acceptor 线程</strong>：监听客户端连接请求，建立连接后将 Socket 注册到 IO 线程池；</li>
<li><strong>IO 线程池</strong>（<code>num.network.threads</code>，默认 3）：处理网络读写事件（接收生产者消息、发送消息给消费者），单线程处理多个连接的网络事件（基于 Java NIO 的 Selector 多路复用）；</li>
<li><strong>处理线程池</strong>（<code>num.io.threads</code>，默认 8）：处理磁盘 IO 事件（将消息写入磁盘、读取磁盘消息），与 IO 线程池解耦，避免网络事件阻塞磁盘 IO；</li>
<li>优势：单线程处理多个网络连接，减少线程切换和锁竞争开销，适合高并发、高吞吐场景。</li>
</ul>
<h4 data-id="heading-13">3. 无锁设计：避免锁竞争开销</h4>
<p>Kafka 核心流程（如消息写入、副本同步、offset 提交）均采用无锁设计：</p>
<ul>
<li>消息写入：每个 Partition 是顺序 append，同一 Partition 仅由一个 Leader 处理写入，无需锁（生产者写入时仅需保证自身顺序，Broker 无需加锁）；</li>
<li>副本同步：Follower 拉取 Leader 消息时，Leader 仅需读取数据，无需修改，无锁竞争；</li>
<li>offset 提交：消费者提交 offset 时，写入 <code>__consumer_offsets</code> Topic（顺序写入），无需锁；</li>
<li>对比传统 MQ：很多 MQ 采用队列锁或全局锁，高并发下锁竞争成为性能瓶颈，Kafka 无锁设计大幅提升并发能力。</li>
</ul>
<h3 data-id="heading-14">10、细节优化：从刷盘、副本同步到内存管理</h3>
<p>除了核心机制，Kafka 还有多个细节优化，进一步降低无效开销，提升稳定性。</p>
<h4 data-id="heading-15">1. 异步刷盘 + 批量刷盘：平衡可靠性和性能</h4>
<p>Kafka 不采用 “每条消息立即刷盘”（同步刷盘会导致磁盘 IO 成为瓶颈），而是：</p>
<ul>
<li><strong>异步刷盘</strong>：消息先写入页缓存，由 OS 异步刷盘（默认策略），刷盘时机由 OS 控制（如页缓存满、定期刷盘）；</li>
<li><strong>批量刷盘</strong>：Broker 可配置 <code>log.flush.interval.messages</code>（每 N 条消息刷盘）或 <code>log.flush.interval.ms</code>（每 N 毫秒刷盘），批量刷盘减少磁盘 IO 次数；</li>
<li>可靠性保障：结合副本冗余（<code>replication.factor≥3</code>），即使 Broker 宕机未刷盘，消息已同步到 Follower 副本，不会丢失数据。</li>
</ul>
<h4 data-id="heading-16">2. 副本同步优化：拉取模式 + 批量同步</h4>
<p>Kafka 的 Follower 采用 “拉取模式”（Pull）同步 Leader 消息，而非 Leader 推送（Push）：</p>
<ul>
<li>优势：① Follower 可根据自身性能调整同步速度（避免 Leader 被慢 Follower 拖垮）；② Leader 仅需处理读请求，无需维护 Follower 状态，减少 Leader 开销；</li>
<li>批量同步：Follower 每次拉取多条消息（而非单条），减少同步请求次数，提升同步效率；</li>
<li>ISR 动态调整：仅同步状态合格的 Follower 留在 ISR 列表，避免慢 Follower 影响整体性能。</li>
</ul>
<h4 data-id="heading-17">3. 内存管理优化：对象池 + 零拷贝序列化</h4>
<ul>
<li><strong>对象池</strong>：Kafka 复用消息缓冲区、网络数据包等对象，避免频繁创建和销毁对象导致的 GC 开销（尤其是生产端批量发送时，减少年轻代 GC 频率）；</li>
<li><strong>零拷贝序列化</strong>：使用自定义的序列化框架（而非 Java 原生序列化），消息头小、解析快，同时支持批量序列化 / 反序列化，减少 CPU 开销。</li>
</ul>
<h4 data-id="heading-18">4. 分区副本分散存储：负载均衡 + 容错</h4>
<p>Kafka 自动将 Topic 的 Partition 及其副本分散到不同 Broker（甚至不同机架）：</p>
<ul>
<li>避免单个 Broker 承载过多 Partition，导致磁盘 IO、网络带宽成为瓶颈；</li>
<li>机架感知（<code>rack.aware.assignment.enable=true</code>）：将副本分散到不同机架，避免机架故障导致数据丢失，同时提升跨机架数据传输的并行度。</li>
</ul>
<h3 data-id="heading-19">总结</h3>
<ol>
<li><strong>存储层优化：</strong> 顺序读写+日志分段+稀疏索引，让磁盘IO接近内存性能</li>
<li><strong>网络层优化：</strong> 零拷贝+批量传输+数据压缩，减少网络带宽和拷贝开销</li>
<li><strong>并发层优化：</strong> 分区并行+reactor线程模型+无锁设计，充分利用多核CPU</li>
<li><strong>缓存层优化：</strong> 依赖操作系统的页缓存，避免应用层缓存的内存管理开销</li>
<li><strong>细节方面：</strong>  异步刷盘、拉取式副本同步、对象池等，进一步降低无效开销</li>
</ol>
<h2 data-id="heading-20">kafka的刷盘策略</h2>
<p>Kafka 的刷盘策略（Log Flush Policy）核心目标是 <strong>将内存中的消息（OS 页缓存 / 应用层缓存）持久化到物理磁盘</strong>，其设计核心是 “不追求单条消息的即时持久化，而是通过批量 + 异步机制降低磁盘 IO 开销，同时结合副本冗余保障数据可靠性”</p>
<h3 data-id="heading-21">一、刷盘的核心前提：Kafka 的存储层次</h3>
<p>要理解刷盘策略，需先明确 Kafka 消息的存储流程：</p>
<ol>
<li>生产者发送消息 → Kafka Broker 接收后，先写入 <strong>OS 页缓存（Page Cache）</strong> （内核态内存，无需应用层拷贝）；</li>
<li>页缓存中的数据由 “刷盘操作” 写入物理磁盘（持久化）；</li>
<li>未刷盘的数据仅存在于内存中，若 Broker 宕机（如断电），会丢失；已刷盘的数据即使 Broker 宕机，重启后可从磁盘恢复。</li>
</ol>
<p>👉 关键结论：刷盘的本质是 “内存数据 → 物理磁盘” 的持久化过程，直接影响 <strong>数据可靠性（是否丢失）</strong>  和 <strong>性能（磁盘 IO 开销）</strong>  的平衡。</p>
<h3 data-id="heading-22">二、Kafka 的三种刷盘策略（核心 + 补充）</h3>
<p>Kafka 提供了 “默认异步刷盘”“配置化批量刷盘”“手动同步刷盘” 三种方式，生产中以 “异步 + 批量” 为主，同步刷盘仅用于极端核心场景。</p>
<h4 data-id="heading-23">1. 策略 1：默认刷盘（异步刷盘，OS 主导）</h4>
<p>这是 Kafka 最核心、默认启用的刷盘策略，完全依赖操作系统的页缓存管理和刷盘机制：</p>
<ul>
<li>
<p><strong>核心逻辑</strong>：</p>
<ol>
<li>消息写入页缓存后，Kafka 不主动触发刷盘，而是由 OS 决定刷盘时机（如：页缓存满、系统空闲时、定期刷盘（默认约 30s）、Broker 正常关闭时）；</li>
<li>优势：完全规避应用层刷盘的开销，磁盘 IO 由 OS 批量处理（OS 会合并多个小 IO 为大 IO），吞吐量极高；</li>
<li>风险：若 Broker 异常宕机（如断电），页缓存中未刷盘的消息会丢失；</li>
<li>可靠性兜底：结合 Kafka 副本机制（<code>replication.factor≥3</code>），即使当前 Broker 未刷盘，消息已同步到 Follower 副本（Follower 会同步页缓存中的消息并刷盘），数据不会丢失（仅单副本场景有丢失风险）。</li>
</ol>
</li>
<li>
<p><strong>适用场景</strong>：99% 的生产场景（核心业务 + 一般业务），配合副本冗余即可兼顾性能和可靠性。</p>
</li>
</ul>
<h4 data-id="heading-24">2. 策略 2：批量刷盘（配置触发，应用层主导）</h4>
<p>通过 Kafka 配置参数，手动控制 “批量刷盘的触发条件”，本质是 “应用层主动触发 OS 刷盘”，平衡性能和可控性：</p>
<ul>
<li>
<p><strong>核心配置参数</strong>（Broker 端 <code>server.properties</code> 或 Topic 级配置）：</p>























<table><thead><tr><th>参数名</th><th>作用</th><th>默认值</th><th>生产建议值</th></tr></thead><tbody><tr><td><code>log.flush.interval.messages</code></td><td>累计写入 N 条消息后，触发一次刷盘</td><td>10000（1 万条）</td><td>10000~50000（根据消息大小调整）</td></tr><tr><td><code>log.flush.interval.ms</code></td><td>累计等待 N 毫秒后，触发一次刷盘</td><td>60000（1 分钟）</td><td>5000<del>30000（5s</del>30s）</td></tr></tbody></table>
</li>
<li>
<p><strong>触发逻辑</strong>：两个参数满足其一即触发刷盘（“或” 关系）：例：配置 <code>log.flush.interval.messages=20000</code> + <code>log.flush.interval.ms=10000</code>，则 “累计 2 万条消息” 或 “等待 10s”， whichever comes first，触发刷盘。</p>
</li>
<li>
<p><strong>优势</strong>：避免 OS 刷盘间隔过长导致页缓存中堆积过多未持久化消息，降低异常宕机时的潜在数据量（即使单副本场景，丢失数据量也可控）；</p>
</li>
<li>
<p><strong>注意</strong>：参数值不宜过小（如 100 条 / 100ms），否则会导致刷盘过于频繁，磁盘 IO 成为性能瓶颈；也不宜过大（如 100 万条 / 10 分钟），否则失去批量控制的意义。</p>
</li>
<li>
<p><strong>适用场景</strong>：对数据丢失量有严格控制的核心业务（如金融交易），配合 3 副本使用，既保证性能，又限制单次宕机的最大可能丢失消息数。</p>
</li>
</ul>
<h4 data-id="heading-25">3. 策略 3：同步刷盘（逐消息刷盘，性能最差）</h4>
<p>每条消息写入页缓存后，立即触发刷盘（<code>fsync</code> 系统调用），刷盘完成后才向生产者返回 “写入成功” 确认。</p>
<ul>
<li>
<p><strong>启用方式</strong>：无直接配置参数，需通过生产者 <code>acks</code> 参数 + Broker 刷盘策略间接实现：</p>
<ol>
<li>生产者设置 <code>acks=-1</code>（等待 ISR 副本同步完成）；</li>
<li>Broker 配置 <code>log.flush.interval.messages=1</code>（每条消息触发刷盘）；</li>
</ol>
</li>
<li>
<p><strong>优势</strong>：数据可靠性最高（几乎无丢失可能，除非磁盘物理损坏）；</p>
</li>
<li>
<p><strong>劣势</strong>：性能极差 —— 每条消息都触发一次磁盘 IO（随机 IO 开销），吞吐量会从 “百万级 / 秒” 骤降至 “千级 / 秒”，磁盘 IO 成为绝对瓶颈；</p>
</li>
<li>
<p><strong>适用场景</strong>：极端核心、数据零丢失的场景（如银行核心交易记录），且能接受极低吞吐量，一般业务禁止使用。</p>
</li>
</ul>
<h3 data-id="heading-26">三、刷盘策略与数据可靠性的关键关联</h3>
<p>很多人误以为 “异步刷盘 = 数据丢失”“同步刷盘 = 绝对安全”，这是误区。Kafka 的数据可靠性是  <strong>“刷盘策略 + 副本机制 + 生产者 ACK”</strong>  三者的协同结果，而非单一刷盘策略决定：</p>
<h4 data-id="heading-27">1. 安全组合（生产首选）：异步刷盘 + 3 副本 + <code>acks=-1</code></h4>
<ul>
<li>流程：生产者发送消息 → Leader 写入页缓存 → 至少 2 个 Follower 同步消息到自身页缓存 → 生产者收到 ACK → OS 异步刷盘（Leader+Follower 各自刷盘）；</li>
<li>可靠性：即使 Leader 宕机（未刷盘），Follower 已同步消息且可能已刷盘，选举新 Leader 后数据不丢失；</li>
<li>性能：异步刷盘无额外 IO 开销，3 副本同步的网络开销可忽略，吞吐量接近理论上限。</li>
</ul>
<h4 data-id="heading-28">2. 风险组合：异步刷盘 + 单副本 + <code>acks=1</code></h4>
<ul>
<li>流程：生产者发送消息 → Leader 写入页缓存 → 立即返回 ACK → OS 异步刷盘；</li>
<li>风险：若 Leader 宕机（未刷盘），消息丢失（无副本冗余）；</li>
<li>适用场景：非核心业务（如日志采集），对数据丢失容忍度高，追求极致性能。</li>
</ul>
<h4 data-id="heading-29">3. 冗余组合：同步刷盘 + 3 副本</h4>
<ul>
<li>无需使用：3 副本已能保证数据不丢失，同步刷盘仅增加性能开销，无额外可靠性增益，属于过度优化。</li>
</ul>
<h3 data-id="heading-30">四、生产环境刷盘策略配置建议</h3>
<p>根据业务场景分类，给出可直接落地的配置组合：</p>
<h4 data-id="heading-31">1. 核心业务（如订单、支付）</h4>
<ul>
<li>
<p>目标：数据不丢失 + 高吞吐量；</p>
</li>
<li>
<p>配置组合：</p>
<ul>
<li>Broker 端：<code>log.flush.interval.messages=20000</code> + <code>log.flush.interval.ms=10000</code>（批量刷盘）；</li>
<li>Topic 端：<code>replication.factor=3</code> + <code>min.insync.replicas=2</code>（3 副本 + 至少 2 个同步）；</li>
<li>生产者端：<code>acks=-1</code> + <code>enable.idempotence=true</code>（幂等性避免重复）；</li>
</ul>
</li>
<li>
<p>效果：单次宕机最大可能丢失消息数 ≤20000 条（实际中因 Follower 同步，丢失数远低于此），吞吐量维持在百万级 / 秒。</p>
</li>
</ul>
<h4 data-id="heading-32">2. 一般业务（如用户行为日志、通知）</h4>
<ul>
<li>
<p>目标：高吞吐量 + 可接受少量数据丢失；</p>
</li>
<li>
<p>配置组合：</p>
<ul>
<li>Broker 端：默认异步刷盘（不修改 <code>log.flush</code> 相关参数）；</li>
<li>Topic 端：<code>replication.factor=2</code>（2 副本冗余）；</li>
<li>生产者端：<code>acks=1</code>（仅 Leader 写入确认）；</li>
</ul>
</li>
<li>
<p>效果：吞吐量最优，仅极端情况（双副本同时宕机）会丢失数据，概率极低。</p>
</li>
</ul>
<h4 data-id="heading-33">3. 极端核心业务（如金融交易）</h4>
<ul>
<li>
<p>目标：数据零丢失 + 可接受中等吞吐量；</p>
</li>
<li>
<p>配置组合：</p>
<ul>
<li>Broker 端：<code>log.flush.interval.messages=1000</code> + <code>log.flush.interval.ms=5000</code>（高频批量刷盘）；</li>
<li>Topic 端：<code>replication.factor=3</code> + <code>min.insync.replicas=2</code>；</li>
<li>生产者端：<code>acks=-1</code> + <code>transactional.id=xxx</code>（事务保证原子性）；</li>
</ul>
</li>
<li>
<p>效果：数据丢失风险趋近于零，吞吐量约为核心业务配置的 70%~80%。</p>
</li>
</ul>
<h3 data-id="heading-34">五、常见误区澄清</h3>
<ol>
<li><strong>“异步刷盘一定会丢数据”</strong> ：错！仅单副本 + 异步刷盘有丢失风险；3 副本 + <code>acks=-1</code> 时，即使 Leader 未刷盘，Follower 已同步消息，数据不会丢失。</li>
<li><strong>“刷盘越频繁，可靠性越高”</strong> ：不完全对！刷盘频繁仅能减少 “单 Broker 宕机” 的丢失数据量，但依赖副本机制才能实现 “零丢失”；过度频繁刷盘会导致性能崩溃。</li>
<li><strong>“Kafka 自己管理缓存，刷盘由应用层控制”</strong> ：错！Kafka 不实现应用层缓存，完全依赖 OS 页缓存，刷盘本质是触发 OS 将页缓存数据写入磁盘（<code>fsync</code> 系统调用）。</li>
<li><strong>“关闭刷盘策略可以提升性能”</strong> ：错！刷盘是数据持久化的必经过程，无法关闭；所谓 “关闭” 只是让 OS 自动控制刷盘时机（默认异步刷盘），而非不刷盘。</li>
<li><strong>“SSD 磁盘可以随意用同步刷盘”</strong> ：错！SSD 顺序 IO 性能虽高，但同步刷盘（逐消息 <code>fsync</code>）仍会产生大量 IO 开销，吞吐量仍远低于异步刷盘，仅能比机械硬盘的同步刷盘性能好一些。</li>
</ol>
<h3 data-id="heading-35">六、核心总结</h3>
<p>Kafka 刷盘策略的设计哲学是  <strong>“不与磁盘 IO 为敌，而是顺势而为”</strong> ：</p>
<ol>
<li>默认异步刷盘：最大化利用 OS 页缓存和批量 IO 特性，兼顾性能和基础可靠性；</li>
<li>批量刷盘：通过配置参数控制刷盘频率，平衡 “丢失数据量” 和性能，生产首选；</li>
<li>同步刷盘：仅用于极端核心场景，代价是吞吐量暴跌，非必要不使用。</li>
</ol>
<h2 data-id="heading-36">kafka的消息消费有序性怎么保证</h2>
<p>Kafka 保证消息消费有序性的核心原则是  <strong>“分区内有序，跨分区无序”</strong> ——Kafka 本身仅保证单个分区内的消息按生产顺序存储和消费，跨分区的全局有序需额外设计。以下从「生产端、Broker 端、消费端」三个关键环节，结合具体配置和场景。</p>
<h3 data-id="heading-37">一、核心前提：理解 Kafka 的有序性基础</h3>
<p>Kafka 的 Topic 由多个分区（Partition）组成，每个分区本质是一个 <strong>Append-Only 的日志文件</strong>：</p>
<ul>
<li>生产者发送的消息会按顺序写入对应分区，Broker 保证分区内消息的存储顺序与生产顺序一致；</li>
<li>消费者从分区拉取消息时，按日志的偏移量（Offset）顺序读取，只要不跳过消息、不打乱 Offset 顺序，就能保证消费顺序与生产顺序一致。</li>
</ul>
<p>因此，<strong>有序性的核心是将需要保证顺序的消息路由到同一个分区，并在消费时按分区顺序处理</strong>。</p>
<h3 data-id="heading-38">二、生产端：保证消息写入分区的顺序</h3>
<p>生产端需确保「相同业务顺序的消息写入同一个分区」，且「单分区内消息发送顺序不打乱」。</p>
<h4 data-id="heading-39">1. 关键配置：指定分区键（Partition Key）</h4>
<ul>
<li>
<p>原理：Kafka 生产者通过 <code>Partition Key</code> 计算分区编号（默认哈希取模：<code>partition = hash(key) % 分区数</code>）；</p>
</li>
<li>
<p>要求：<strong>需要保证顺序的消息，必须使用相同的 Partition Key</strong>（例如：订单 ID、用户 ID、会话 ID 等）。</p>
<ul>
<li>反例：若用随机 Key，消息会分散到不同分区，跨分区无法保证顺序；</li>
<li>正例：订单支付流程（创建订单 → 支付 → 发货），用订单 ID 作为 Key，确保 3 条消息进入同一个分区。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-40">2. 关键配置：禁用乱序发送与重试插队</h4>
<p>生产者默认异步发送且支持重试，但重试可能导致消息顺序错乱（例如：第 2 条消息发送成功，第 1 条失败重试后，反而晚于第 2 条写入分区）。需通过以下配置避免：</p>
<pre><code class="hljs language-scss" lang="scss">Properties props = new <span class="hljs-built_in">Properties</span>();
<span class="hljs-comment">// 1. 单分区最多允许1个未确认的请求（避免多请求并发导致乱序）</span>
props<span class="hljs-selector-class">.put</span>(ProducerConfig.MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION, <span class="hljs-number">1</span>);
<span class="hljs-comment">// 2. 重试时启用幂等性（保证重试消息不会重复写入，且顺序不变）</span>
props<span class="hljs-selector-class">.put</span>(ProducerConfig.ENABLE_IDEMPOTENCE, true); <span class="hljs-comment">// 默认 false，需开启</span>
props<span class="hljs-selector-class">.put</span>(ProducerConfig.ACKS, "all"); <span class="hljs-comment">// 幂等性依赖 ACK=all（确保消息被所有副本确认）</span>
<span class="hljs-comment">// 3. 禁用重试（若业务不允许重试插队，且能接受发送失败，可直接禁用）</span>
<span class="hljs-comment">// props.put(ProducerConfig.RETRIES_CONFIG, 0);</span>
</code></pre>
<ul>
<li>说明：<code>MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION=1</code> 限制单个分区同时只有 1 个消息在发送 / 重试，确保顺序；<code>ENABLE_IDEMPOTENCE=true</code> 会为每个消息分配唯一 ID，Broker 会过滤重复消息，避免重试导致的重复消费。</li>
</ul>
<h4 data-id="heading-41">3. 可选：同步发送（确保发送顺序）</h4>
<p>若业务要求 “发送顺序严格等于写入顺序”，可使用同步发送（<code>send().get()</code>），但会降低吞吐量：</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-scss" lang="scss">producer<span class="hljs-selector-class">.send</span>(record)<span class="hljs-selector-class">.get</span>(); <span class="hljs-comment">// 阻塞等待发送结果，确保前一条成功后再发下一条</span>
</code></pre>
<h3 data-id="heading-42">三、Broker 端：保证分区内消息的存储顺序</h3>
<p>Broker 端无需额外配置，核心依赖其天然特性，但需避免以下破坏有序性的操作：</p>
<h4 data-id="heading-43">1. 禁用分区日志的随机读写</h4>
<p>Kafka 分区日志是 Append-Only 结构，不支持随机修改或删除消息（仅支持日志清理，如按时间 / 大小删除旧日志），确保存储顺序与生产顺序一致。</p>
<h4 data-id="heading-44">2. 避免分区重分配导致的顺序混乱</h4>
<ul>
<li>分区重分配（如扩容、Rebalance）时，消息仍按原分区日志顺序迁移，新消费者接管分区后，按 Offset 继续消费，不会破坏顺序；</li>
<li>注意：重分配过程中，旧消费者需停止消费并提交 Offset，新消费者再开始拉取，避免同一分区被多个消费者同时消费（消费组机制会自动保证）。</li>
</ul>
<h4 data-id="heading-45">3. 副本同步保证顺序</h4>
<p>分区的 Leader 副本与 Follower 副本同步时，Follower 按 Leader 的日志顺序复制消息，确保主从切换后（Leader 故障），新 Leader 的日志顺序仍与原生产顺序一致。</p>
<h3 data-id="heading-46">四、消费端：保证消息处理顺序</h3>
<p>消费端是有序性的 “最后一道防线”，需确保「按分区 Offset 顺序拉取」且「按顺序处理，不跳过、不并发乱序」。</p>
<h4 data-id="heading-47">1. 核心原则：一个分区仅被一个消费者消费</h4>
<p>Kafka 消费组（Consumer Group）的分区分配策略（默认 <code>RangeAssignor</code>）会保证：<strong>同一个消费组内，一个分区最多分配给一个消费者</strong>。</p>
<ul>
<li>若一个分区被多个消费者同时消费，不同消费者的处理速度不同，会导致消息顺序错乱；</li>
<li>扩展：消费组的消费者数量不应超过 Topic 的分区数（超过的消费者会空闲），若需提高吞吐量，应先增加分区数，再增加消费者数。</li>
</ul>
<h4 data-id="heading-48">2. 关键配置：按顺序拉取与处理</h4>
<ul>
<li>禁用自动提交 Offset，改为手动提交（避免消息未处理完就提交 Offset，导致重试时跳过消息）；</li>
<li>单分区消息需串行处理（禁止并发处理同一个分区的消息）。</li>
</ul>
<p>示例代码（Java）：</p>
<pre><code class="hljs language-scss" lang="scss">Properties props = new <span class="hljs-built_in">Properties</span>();
props<span class="hljs-selector-class">.put</span>(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, false); <span class="hljs-comment">// 禁用自动提交</span>
props<span class="hljs-selector-class">.put</span>(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="hljs-number">100</span>); <span class="hljs-comment">// 每次拉取的最大消息数（根据业务调整）</span>

KafkaConsumer&lt;String, String&gt; consumer = new KafkaConsumer&lt;&gt;(props);
consumer<span class="hljs-selector-class">.subscribe</span>(Collections.singletonList("topic-name"));

while (true) {
    ConsumerRecords&lt;String, String&gt; records = consumer<span class="hljs-selector-class">.poll</span>(Duration.ofMillis(<span class="hljs-number">100</span>));
    <span class="hljs-comment">// 按分区遍历消息（确保同一个分区的消息串行处理）</span>
    for (TopicPartition partition : records.partitions()) {
        List&lt;ConsumerRecord&lt;String, String&gt;&gt; partitionRecords = records<span class="hljs-selector-class">.records</span>(partition);
        <span class="hljs-comment">// 遍历分区内的消息，按 Offset 顺序处理</span>
        for (ConsumerRecord&lt;String, String&gt; record : partitionRecords) {
            try {
                <span class="hljs-built_in">processMessage</span>(record); <span class="hljs-comment">// 业务处理（必须串行，不能异步提交）</span>
            } catch (Exception e) {
                <span class="hljs-comment">// 处理失败：可重试、放入死信队列，避免跳过消息</span>
                <span class="hljs-built_in">handleFailure</span>(record);
                <span class="hljs-comment">// 若重试后仍失败，需手动提交 Offset 前的位置，避免重复消费</span>
                consumer<span class="hljs-selector-class">.commitSync</span>(Collections.singletonMap(partition, 
                    new OffsetAndMetadata(record.offset() + <span class="hljs-number">1</span>)));
                break; <span class="hljs-comment">// 停止处理该分区后续消息，避免顺序错乱</span>
            }
        }
        <span class="hljs-comment">// 该分区所有消息处理完成后，手动提交 Offset</span>
        long lastOffset = partitionRecords<span class="hljs-selector-class">.get</span>(partitionRecords.size() - <span class="hljs-number">1</span>)<span class="hljs-selector-class">.offset</span>();
        consumer<span class="hljs-selector-class">.commitSync</span>(Collections.singletonMap(partition, 
            new OffsetAndMetadata(lastOffset + <span class="hljs-number">1</span>)));
    }
}
</code></pre>
<h4 data-id="heading-49">3. 避免消费端重试导致的顺序错乱</h4>
<p>若消息处理失败（如依赖的服务不可用），直接重试可能导致后续消息阻塞，或重试消息插队。正确做法：</p>
<ul>
<li>方案 1：<strong>死信队列（DLQ）</strong> ：处理失败的消息转发到专门的死信 Topic（同分区键，保证死信队列内有序），后续人工处理或定时重试，原消费流程继续处理下一条消息；</li>
<li>方案 2：<strong>分区内重试队列</strong>：在消费端为每个分区维护一个重试队列，失败消息放入重试队列，定期重试，且重试队列的消息处理优先级低于正常消息（避免打乱正常顺序）。</li>
</ul>
<h4 data-id="heading-50">4. 禁用 Offset 跳跃</h4>
<ul>
<li>禁止手动修改 Offset（如 <code>seek()</code> 跳转到未来 Offset），否则会跳过消息，破坏顺序；</li>
<li>若需重新消费历史消息，应从指定 Offset 开始顺序拉取（如 <code>seek(partition, offset)</code>），而非跳跃式拉取。</li>
</ul>
<h3 data-id="heading-51">五、特殊场景：如何实现全局有序（跨分区有序）</h3>
<p>Kafka 默认不支持跨分区全局有序，若业务必须（如秒杀活动的订单创建顺序），需牺牲吞吐量实现：</p>
<h4 data-id="heading-52">方案：Topic 仅创建 1 个分区</h4>
<ul>
<li>原理：单个分区天然全局有序（生产、存储、消费均按顺序）；</li>
<li>缺点：吞吐量受限（单个分区的吞吐量约 1000-10000 TPS），无法水平扩展；</li>
<li>适用场景：消息量小、对顺序要求极高的场景（如金融交易对账）。</li>
</ul>
<h3 data-id="heading-53">六、常见问题与避坑点</h3>
<ol>
<li><strong>重试导致的乱序</strong>：未设置 <code>MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION=1</code> 和幂等性，导致重试消息插队；</li>
<li><strong>消费端并发处理</strong>：同一个分区的消息被多线程并发处理，导致处理顺序与拉取顺序不一致；</li>
<li><strong>自动提交 Offset</strong>：消息未处理完就自动提交 Offset，崩溃后重启跳过未处理消息；</li>
<li><strong>分区键选择错误</strong>：用随机 Key 或不相关的 Key，导致有序消息分散到不同分区；</li>
<li><strong>消费者数量超过分区数</strong>：多余的消费者空闲，且可能导致 Rebalance 频繁，间接影响顺序。</li>
</ol>
<h3 data-id="heading-54">七、总结：有序性保证的核心步骤</h3>
<ol>
<li><strong>生产端</strong>：用相同的 Partition Key 路由有序消息，配置 <code>MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION=1</code> 和幂等性，避免重试乱序；</li>
<li><strong>Broker 端</strong>：依赖分区 Append-Only 日志和副本同步，不修改分区日志顺序；</li>
<li><strong>消费端</strong>：一个分区仅被一个消费者消费，串行处理分区内消息，手动提交 Offset，失败消息走死信队列，不跳过 Offset。</li>
</ol>
<h2 data-id="heading-55">kafka如何保证消息不被重复消费</h2>
<p>Kafka 消息重复消费的核心原因是  <strong>“消息消费与 Offset 提交的原子性未保证”</strong> （如消息已处理但 Offset 未提交，重启后重新拉取），或  <strong>“生产端重试导致消息重复写入”</strong> 。解决思路是从「生产端去重、Broker 端防重、消费端幂等处理、业务端兜底」四个层面层层防护。</p>
<h3 data-id="heading-56">一、核心前提：理解重复消费的本质场景</h3>
<p>重复消费的常见触发场景：</p>
<ol>
<li>消费端：消息处理完成前崩溃 / 重启，Offset 未提交，重启后重新拉取相同消息；</li>
<li>生产端：发送消息时网络抖动，未收到 Broker 确认（ACK），生产者重试导致消息重复写入；</li>
<li>Rebalance：消费组重平衡时，分区分配给新消费者，旧消费者已处理的消息未提交 Offset，新消费者重新拉取；</li>
<li>手动操作：误操作导致 Offset 回滚（如 <code>seek()</code> 到历史 Offset），重新消费已处理消息。</li>
</ol>
<p>因此，去重的核心是：<strong>确保 “消息写入” 和 “消息消费” 的幂等性</strong>（即重复操作不影响最终结果）。</p>
<h3 data-id="heading-57">二、生产端：避免重复写入（从源头减少重复）</h3>
<p>生产端的目标是：即使重试，也只让 Broker 存储一条相同消息，核心依赖 Kafka 的「幂等性生产者」和「事务消息」。</p>
<h4 data-id="heading-58">1. 开启幂等性生产者（最常用）</h4>
<ul>
<li>
<p>原理：Kafka 为每个幂等生产者分配唯一的 <code>Producer ID (PID)</code>，并为每个分区的消息分配递增的 <code>序列号（Sequence Number）</code>；Broker 会缓存 &lt;PID, 分区，序列号&gt; 映射，若收到相同 PID + 分区 + 序列号的消息，直接丢弃，避免重复写入。</p>
</li>
<li>
<p>配置要求（必须满足）：</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-scss" lang="scss">Properties props = new <span class="hljs-built_in">Properties</span>();
<span class="hljs-comment">// 1. 开启幂等性（默认 false）</span>
props<span class="hljs-selector-class">.put</span>(ProducerConfig.ENABLE_IDEMPOTENCE, true);
<span class="hljs-comment">// 2. ACK 必须设为 "all"（确保消息被所有副本确认，避免副本同步导致的序列号错乱）</span>
props<span class="hljs-selector-class">.put</span>(ProducerConfig.ACKS, "all");
<span class="hljs-comment">// 3. 重试次数 ≥1（默认 2147483647，确保网络抖动时自动重试）</span>
props<span class="hljs-selector-class">.put</span>(ProducerConfig.RETRIES_CONFIG, <span class="hljs-number">10</span>);
<span class="hljs-comment">// 4. 单连接最大未确认请求数 ≤5（默认 5，幂等性要求，避免并发导致序列号混乱）</span>
props<span class="hljs-selector-class">.put</span>(ProducerConfig.MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION, <span class="hljs-number">5</span>);
</code></pre>
</li>
<li>
<p>适用场景：单分区或多分区的独立消息（无需跨分区原子性），性能开销低，推荐优先使用。</p>
</li>
</ul>
<h4 data-id="heading-59">2. 事务消息（跨分区原子性场景）</h4>
<ul>
<li>
<p>原理：若需要 “多条消息（可能跨分区）要么同时成功写入，要么同时失败”（如订单创建 + 库存扣减消息），可使用事务消息，避免部分消息重试导致的重复。</p>
</li>
<li>
<p>核心逻辑：</p>
<ul>
<li>生产者开启事务（<code>initTransactions()</code>），通过 <code>beginTransaction()</code> 开始事务，发送消息后用 <code>commitTransaction()</code> 提交，失败则 <code>abortTransaction()</code> 回滚；</li>
<li>Broker 会为事务消息标记状态，消费端需配置 <code>isolation.level</code> 过滤未提交的事务消息，避免脏读和重复。</li>
</ul>
</li>
<li>
<p>配置示例：</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 生产端</span>
props.<span class="hljs-title function_">put</span>(<span class="hljs-title class_">ProducerConfig</span>.<span class="hljs-property">TRANSACTIONAL_ID_CONFIG</span>, <span class="hljs-string">"order-transaction-1"</span>); <span class="hljs-comment">// 唯一事务ID</span>
<span class="hljs-title class_">KafkaProducer</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; producer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaProducer</span>&lt;&gt;(props);
producer.<span class="hljs-title function_">initTransactions</span>(); <span class="hljs-comment">// 初始化事务</span>

<span class="hljs-keyword">try</span> {
    producer.<span class="hljs-title function_">beginTransaction</span>(); <span class="hljs-comment">// 开始事务</span>
    <span class="hljs-comment">// 发送多条跨分区消息</span>
    producer.<span class="hljs-title function_">send</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProducerRecord</span>&lt;&gt;(<span class="hljs-string">"topic1"</span>, <span class="hljs-string">"order1"</span>, <span class="hljs-string">"create"</span>));
    producer.<span class="hljs-title function_">send</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProducerRecord</span>&lt;&gt;(<span class="hljs-string">"topic2"</span>, <span class="hljs-string">"stock1"</span>, <span class="hljs-string">"deduct"</span>));
    producer.<span class="hljs-title function_">commitTransaction</span>(); <span class="hljs-comment">// 提交事务</span>
} <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
    producer.<span class="hljs-title function_">abortTransaction</span>(); <span class="hljs-comment">// 回滚事务</span>
}

<span class="hljs-comment">// 消费端（需配置隔离级别）</span>
props.<span class="hljs-title function_">put</span>(<span class="hljs-title class_">ConsumerConfig</span>.<span class="hljs-property">ISOLATION_LEVEL_CONFIG</span>, <span class="hljs-string">"read_committed"</span>); <span class="hljs-comment">// 只消费已提交的事务消息</span>
</code></pre>
</li>
<li>
<p>适用场景：跨分区 / 跨 Topic 的原子性消息发送，性能开销略高于幂等性生产者，按需使用。</p>
</li>
</ul>
<h4 data-id="heading-60">3. 业务层生成唯一消息 ID（兜底）</h4>
<p>若无法使用幂等性 / 事务（如旧版本 Kafka），可在生产端为每条消息生成唯一 ID（如 UUID、雪花 ID），写入消息体或 <code>headers</code> 中，Broker 端不处理，但消费端可通过该 ID 去重。</p>
<ul>
<li>
<p>示例：</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">String <span class="hljs-attr">msgId</span> = UUID.randomUUID().toString()<span class="hljs-comment">;</span>
ProducerRecord&lt;String, String&gt; <span class="hljs-attr">record</span> = new ProducerRecord&lt;&gt;(<span class="hljs-string">"topic"</span>, <span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>)<span class="hljs-comment">;</span>
record.headers().add("msg-id", msgId.getBytes(StandardCharsets.UTF_8))<span class="hljs-comment">; // 消息头携带唯一ID</span>
producer.send(record)<span class="hljs-comment">;</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-61">三、Broker 端：减少重复的辅助防护</h3>
<p>Broker 端本身不主动去重（依赖生产端幂等性），但可通过配置避免因 Broker 故障导致的重复写入：</p>
<ol>
<li>
<p>合理配置副本数和 ISR：</p>
<ul>
<li>设 <code>min.insync.replicas ≥2</code>（与 <code>ACK=all</code> 配合），确保消息被多数副本确认后才返回成功，避免 Leader 故障后数据丢失，减少生产者不必要的重试；</li>
<li>示例：<code>topic</code> 配置 <code>min.insync.replicas=2</code>，<code>acks=all</code> 时，需至少 2 个副本同步消息才算发送成功。</li>
</ul>
</li>
<li>
<p>禁用日志清理导致的重复：</p>
<ul>
<li>避免使用 <code>log.cleanup.policy=delete</code> 时过早删除消息（需确保消费端处理速度快于日志清理速度），否则可能导致消费端重新拉取时消息已丢失，触发生产者重试重复。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-62">四、消费端：避免重复处理（核心防护）</h3>
<p>消费端是重复消费的 “重灾区”，核心原则是  <strong>“消息处理完成后，再提交 Offset”</strong> ，并确保处理逻辑幂等。</p>
<h4 data-id="heading-63">1. 禁用自动提交 Offset，改为手动提交</h4>
<ul>
<li>
<p>原因：自动提交（默认 5 秒）可能导致 “消息未处理完，但 Offset 已提交”（崩溃后不会重复），或 “消息处理完，但 Offset 未提交”（崩溃后重复消费），手动提交可精准控制提交时机。</p>
</li>
<li>
<p>配置与代码示例：</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">Properties <span class="hljs-attr">props</span> = new Properties()<span class="hljs-comment">;</span>
// 禁用自动提交（默认 true）
props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, false)<span class="hljs-comment">;</span>
// 每次拉取的最大消息数（避免拉取过多导致处理超时）
props.put(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 100)<span class="hljs-comment">;</span>
// 拉取超时时间（需大于单次消息处理时间）
props.put(ConsumerConfig.MAX_POLL_INTERVAL_MS_CONFIG, 300000)<span class="hljs-comment">; // 5分钟</span>

KafkaConsumer&lt;String, String&gt; <span class="hljs-attr">consumer</span> = new KafkaConsumer&lt;&gt;(props)<span class="hljs-comment">;</span>
consumer.subscribe(Collections.singletonList("topic"))<span class="hljs-comment">;</span>

while (true) {
    ConsumerRecords&lt;String, String&gt; <span class="hljs-attr">records</span> = consumer.poll(Duration.ofMillis(<span class="hljs-number">100</span>))<span class="hljs-comment">;</span>
    for (TopicPartition partition : records.partitions()) {
        List&lt;ConsumerRecord&lt;String, String&gt;&gt; <span class="hljs-attr">partitionRecords</span> = records.records(partition)<span class="hljs-comment">;</span>
        boolean <span class="hljs-attr">allProcessed</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
        for (ConsumerRecord&lt;String, String&gt; record : partitionRecords) {
            try {
                // 1. 业务处理（必须确保幂等）
                processMessage(record)<span class="hljs-comment">; </span>
            } catch (Exception e) {
                <span class="hljs-attr">allProcessed</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
                handleFailure(record)<span class="hljs-comment">; // 失败处理（如放入死信队列）</span>
                break<span class="hljs-comment">; // 停止处理该分区后续消息，避免部分成功</span>
            }
        }
        // 2. 所有消息处理完成后，手动提交 Offset（关键）
        if (allProcessed) {
            long <span class="hljs-attr">lastOffset</span> = partitionRecords.get(partitionRecords.size() - <span class="hljs-number">1</span>).<span class="hljs-literal">off</span>set()<span class="hljs-comment">;</span>
            // 提交到下一条要消费的 Offset（当前最后一条 Offset +1）
            consumer.commitSync(Collections.singletonMap(partition, 
                new OffsetAndMetadata(lastOffset + 1)))<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
</li>
<li>
<p>提交方式选择：</p>
<ul>
<li><code>commitSync()</code>：同步提交，阻塞直到成功，适合对一致性要求高的场景；</li>
<li><code>commitAsync()</code>：异步提交，不阻塞，但需处理回调失败（如重试提交），适合高吞吐量场景。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-64">2. 控制 Rebalance 导致的重复</h4>
<p>Rebalance 时，分区会从旧消费者转移到新消费者，若旧消费者已处理消息但未提交 Offset，新消费者会重复消费。解决方案：</p>
<ul>
<li>
<ol>
<li>延长 <code>session.timeout.ms</code> 和 <code>heartbeat.interval.ms</code>：</li>
</ol>
<ul>
<li><code>session.timeout.ms</code>（默认 10 秒）：消费者心跳超时时间，超过则被认为死亡，触发 Rebalance；</li>
<li><code>heartbeat.interval.ms</code>（默认 3 秒）：消费者发送心跳的间隔，建议设为 <code>session.timeout.ms</code> 的 1/3；</li>
<li>配置示例：<code>props.put(ConsumerConfig.SESSION_TIMEOUT_MS_CONFIG, 30000);</code>（延长到 30 秒），减少不必要的 Rebalance。</li>
</ul>
</li>
<li>
<ol start="2">
<li>使用 <code>ConsumerRebalanceListener</code> 监听 Rebalance：</li>
</ol>
<ul>
<li>
<p>Rebalance 触发前，旧消费者提交已处理的 Offset，避免新消费者重复消费：</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-typescript" lang="typescript">consumer.<span class="hljs-title function_">subscribe</span>(<span class="hljs-title class_">Collections</span>.<span class="hljs-title function_">singletonList</span>(<span class="hljs-string">"topic"</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConsumerRebalanceListener</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onPartitionsRevoked</span>(<span class="hljs-params">Collection&lt;TopicPartition&gt; partitions</span>) {
        <span class="hljs-comment">// 分区被回收前，提交Offset</span>
        consumer.<span class="hljs-title function_">commitSync</span>();
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onPartitionsAssigned</span>(<span class="hljs-params">Collection&lt;TopicPartition&gt; partitions</span>) {
        <span class="hljs-comment">// 新分区分配后，可重置Offset（如从最新开始）</span>
    }
});
</code></pre>
</li>
</ul>
</li>
<li>
<ol start="3">
<li>避免消费者长时间阻塞：</li>
</ol>
<ul>
<li>若消费者处理消息耗时过长（超过 <code>max.poll.interval.ms</code>），会被认为无响应，触发 Rebalance；</li>
<li>解决方案：拆分长任务（如异步处理，但需确保 Offset 提交与异步处理的一致性），或增大 <code>max.poll.interval.ms</code>。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-65">3. 消费端幂等处理（关键兜底）</h4>
<p>即使生产端和 Broker 端做了去重，极端情况下仍可能出现重复消息（如网络分区导致的幂等性失效），消费端必须保证 <strong>业务处理逻辑幂等</strong>（重复处理不影响结果）。</p>
<p>常见幂等处理方案：</p>
<ul>
<li>
<p>方案 1：基于唯一消息 ID 去重（推荐）</p>
<ul>
<li>
<p>生产端已生成唯一 <code>msg-id</code>（如 UUID、雪花 ID），消费端处理前先检查该 ID 是否已处理：</p>
<ul>
<li>
<p>存储介质：用 Redis（缓存已处理的 msg-id，设置过期时间）、数据库（如 MySQL 唯一索引）；</p>
</li>
<li>
<p>示例：</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-scss" lang="scss">String msgId = new <span class="hljs-built_in">String</span>(record.headers()<span class="hljs-selector-class">.lastHeader</span>("msg-id")<span class="hljs-selector-class">.value</span>());
<span class="hljs-comment">// 用 Redis 检查是否已处理（原子操作）</span>
Boolean isProcessed = redisTemplate<span class="hljs-selector-class">.opsForValue</span>()<span class="hljs-selector-class">.setIfAbsent</span>(msgId, "<span class="hljs-number">1</span>", <span class="hljs-number">24</span>, TimeUnit.HOURS);
if (Boolean.TRUE.equals(isProcessed)) {
    <span class="hljs-built_in">processMessage</span>(record); <span class="hljs-comment">// 未处理过，执行业务逻辑</span>
} else {
    <span class="hljs-comment">// 已处理过，直接跳过</span>
    log<span class="hljs-selector-class">.info</span>("消息已重复，msgId: {}", msgId);
}
</code></pre>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>方案 2：基于业务唯一键去重</p>
<ul>
<li>
<p>若消息无全局唯一 ID，可用业务字段组合唯一键（如订单 ID + 操作类型），通过数据库唯一索引约束：</p>
<ul>
<li>示例：订单支付消息，用 <code>order_id</code> 作为唯一键，插入数据库时执行 <code>INSERT IGNORE INTO order_pay (order_id, amount) VALUES (?, ?)</code>，重复插入会被忽略。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>方案 3：状态机校验</p>
<ul>
<li>
<p>业务数据存在状态流转（如订单：待支付 → 支付中 → 已支付），重复消息触发时，通过状态机判断是否允许重复处理：</p>
<ul>
<li>示例：已支付的订单，再次收到支付消息时，直接返回成功，不执行扣钱逻辑。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-66">五、业务端：最终兜底方案</h3>
<p>分布式系统中，任何技术层面的去重都无法 100% 避免极端情况，业务端需设计 “容错机制”：</p>
<ol>
<li>定期对账：对核心业务（如金融交易、支付），定期与上游 / 下游系统对账，修正重复处理导致的数据不一致；</li>
<li>死信队列（DLQ）：无法处理的重复消息（如多次重试仍失败），转发到死信 Topic，人工介入排查，避免阻塞正常消费；</li>
<li>日志审计：记录每条消息的消费日志（msg-id、处理时间、结果），便于排查重复问题。</li>
</ol>
<h3 data-id="heading-67">六、常见避坑点</h3>
<ol>
<li>滥用自动提交 Offset：消息未处理完就提交，崩溃后不会重复，但可能丢失消息；未处理完就崩溃，会重复消费，需根据业务选择提交时机；</li>
<li>手动提交 Offset 过早：在消息处理前提交 Offset，处理失败后无法重试，导致消息丢失；</li>
<li>幂等性生产者配置不全：未设置 <code>acks=all</code> 或 <code>retries≥1</code>，导致幂等性失效；</li>
<li>消费端并发处理未加锁：多线程处理同一个分区的消息时，去重逻辑（如 Redis 检查）未加锁，导致重复处理；</li>
<li>消息 ID 过期：Redis 缓存的 msg-id 过期时间过短，导致旧消息重新消费时无法识别重复。</li>
</ol>
<h3 data-id="heading-68">七、总结：去重方案优先级</h3>
<ol>
<li>优先开启生产端幂等性（简单、低开销），避免重复写入；</li>
<li>消费端禁用自动提交，手动提交 Offset（确保 “处理完成” 与 “提交 Offset” 原子性）；</li>
<li>消费端实现业务幂等处理（核心兜底，无论是否重复，处理结果一致）；</li>
<li>按需使用事务消息（跨分区原子性场景）和 Rebalance 监听（减少 Rebalance 导致的重复）。</li>
</ol>
<h2 data-id="heading-69">kafka的持久化机制原理</h2>
<p>Kafka 持久化机制的核心目标是 <strong>将消息可靠存入物理磁盘，保证 Broker 宕机、重启后数据不丢失，同时兼顾存储效率和读写性能</strong>。其设计本质是 “基于日志结构的顺序存储 + 多副本冗余 + 刷盘策略” 的协同，完全摒弃了传统数据库的随机读写模式，实现 “高性能” 与 “高可靠” 的平衡。以下从 “存储结构、核心流程、可靠性保障、日志管理” 四个维度拆解原理：</p>
<h3 data-id="heading-70">一、持久化的物理基础：日志结构与存储布局</h3>
<p>Kafka 的持久化并非简单 “将消息写入文件”，而是基于 “分区 - 日志 - 分段” 的分层结构，为高效持久化和后续管理（清理、查找）奠定基础。</p>
<h4 data-id="heading-71">1. 核心存储单元：Partition 日志文件</h4>
<p>每个 Topic 的 Partition 对应一套独立的 “日志文件组”，消息的持久化本质是<strong>向 Partition 的日志文件尾部顺序追加写入</strong>（Append-Only）：</p>
<ul>
<li>
<p>日志文件默认存储路径由 <code>log.dirs</code> 配置（如 <code>/kafka/logs</code>）；</p>
</li>
<li>
<p>每个 Partition 对应一个独立目录，目录名格式为 <code>topic-名称-分区号</code>（如 <code>order-topic-0</code>）；</p>
</li>
<li>
<p>目录内包含两类核心文件：</p>
<ul>
<li>数据文件（.log）：存储原始消息数据（二进制格式），是持久化的核心载体；</li>
<li>索引文件（.index + .timeindex）：辅助快速定位消息（稀疏索引，之前讲 “Kafka 为什么快” 时详细说明过），不参与持久化本身，但影响读写效率。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-72">2. 日志分段（Log Segmentation）：解决大文件痛点</h4>
<p>为避免单个日志文件过大导致的 “写入 / 清理 / 查找效率退化”，Kafka 将每个 Partition 的日志拆分为多个 “段文件”（Segment），每个段文件是独立的持久化单元：</p>
<ul>
<li>
<p>分段规则：当当前段文件达到阈值（默认 <code>log.segment.bytes=1GB</code>），或满足时间阈值（<code>log.roll.hours=24</code>），则关闭当前段，新建一个新段文件（文件名以 “当前段最大 offset” 命名，如 <code>00000000000000000000.log</code>、<code>00000000000000012345.log</code>）；</p>
</li>
<li>
<p>持久化优势：</p>
<ol>
<li>写入仅操作最新段文件，避免对大文件的随机修改，保证顺序 IO；</li>
<li>日志清理（删除过期数据）时，直接删除整个旧段文件（而非修改文件内容），开销极低；</li>
<li>索引文件与段文件一一对应，缩小索引范围，提升查找效率，间接保障持久化后的数据读取性能。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-73">二、持久化核心流程：从内存到磁盘的完整链路</h3>
<p>Kafka 消息的持久化是 “内存缓冲→日志写入→刷盘持久化→副本同步” 的闭环流程，每一步都为 “性能” 或 “可靠性” 设计：</p>
<h4 data-id="heading-74">步骤 1：消息接收与内存缓冲</h4>
<ul>
<li>生产者发送的消息经 TCP 传输至 Broker，Broker 的 IO 线程（<code>num.network.threads</code>）接收后，先写入 <strong>OS 页缓存（Page Cache）</strong> （内核态内存，无需应用层拷贝）；</li>
<li>此时消息仅存在于内存，未真正持久化（若 Broker 宕机，数据会丢失），但页缓存的存在避免了直接写入磁盘的 IO 开销，提升写入吞吐量。</li>
</ul>
<h4 data-id="heading-75">步骤 2：日志文件顺序写入</h4>
<ul>
<li>页缓存中的消息按 “先进先出” 顺序，追加写入当前段的 <code>.log</code> 数据文件（仅尾部写入，顺序 IO）；</li>
<li>写入格式：消息以二进制结构存储，包含 “消息长度、版本号、CRC 校验和、Key 长度、Key 数据、Value 长度、Value 数据、时间戳” 等字段，紧凑存储减少磁盘占用；</li>
<li>关键特点：无随机写入、无数据修改（消息一旦写入，仅可通过日志清理删除，不可修改），彻底规避传统存储的随机 IO 瓶颈。</li>
</ul>
<h4 data-id="heading-76">步骤 3：刷盘（Flush）：内存→物理磁盘（核心持久化动作）</h4>
<ul>
<li>
<p>刷盘是 “真正持久化” 的关键：将页缓存中的数据通过 <code>fsync</code> 系统调用写入物理磁盘（磁道 / 闪存芯片），数据写入磁盘后，即使 Broker 宕机、断电，也不会丢失；</p>
</li>
<li>
<p>刷盘触发机制（对应之前讲的 “刷盘策略”）：</p>
<ol>
<li>异步刷盘（默认）：由 OS 主导，OS 会合并多个小 IO 为大 IO 批量刷盘（如页缓存满、定期刷盘），性能最优；</li>
<li>批量刷盘（应用层控制）：满足 <code>log.flush.interval.messages</code>（累计 N 条）或 <code>log.flush.interval.ms</code>（累计 N 毫秒）时，Broker 主动触发刷盘，平衡性能和丢失数据量；</li>
<li>同步刷盘（逐消息）：每条消息写入后立即刷盘，可靠性最高但性能极差（仅极端核心场景使用）；</li>
</ol>
</li>
<li>
<p>注意：刷盘是 “段文件级” 操作，仅针对当前活跃段文件，不影响其他已关闭的段文件。</p>
</li>
</ul>
<h4 data-id="heading-77">步骤 4：副本同步兜底（高可用持久化）</h4>
<ul>
<li>
<p>仅 Leader 副本的刷盘不足以保证数据不丢失（若 Leader 宕机且未刷盘，数据丢失），Kafka 通过 “多副本同步” 强化持久化可靠性：</p>
<ol>
<li>Follower 副本通过 “拉取模式”（Pull）从 Leader 同步消息，写入自身的页缓存和 <code>.log</code> 文件，再触发自身刷盘；</li>
<li>当 Leader 确认 ISR 列表中至少 <code>min.insync.replicas</code> 个副本已完成同步（且刷盘），才向生产者返回 ACK（配合生产者 <code>acks=-1</code>）；</li>
</ol>
</li>
<li>
<p>最终效果：即使 Leader 未刷盘宕机，Follower 已同步并刷盘，数据可通过新 Leader 恢复，实现 “宕机不丢数据”。</p>
</li>
</ul>
<h3 data-id="heading-78">三、持久化的可靠性保障：避免数据丢失与损坏</h3>
<p>Kafka 持久化并非仅依赖 “刷盘”，而是通过 “多机制协同” 确保数据可靠，核心保障包括 3 点：</p>
<h4 data-id="heading-79">1. 多副本冗余：持久化的兜底机制</h4>
<ul>
<li>每个 Partition 配置 <code>replication.factor≥3</code>（生产建议），副本分布在不同 Broker（甚至不同机架）；</li>
<li>只要至少一个副本的消息已刷盘，数据就不会丢失；Leader 宕机后，新 Leader 从 ISR 列表中选举（数据同步合格的副本），保证数据一致性。</li>
</ul>
<h4 data-id="heading-80">2. 高水位（HW）：消费端的持久化一致性</h4>
<ul>
<li>高水位（High Watermark）是 “所有副本都已刷盘的消息的最大 offset”；</li>
<li>消费者仅能读取 HW 之前的消息，避免读取到 “Leader 已写入但 Follower 未同步 / 未刷盘” 的消息（若此时 Leader 宕机，该消息可能丢失），确保消费到的消息都是 “已可靠持久化” 的。</li>
</ul>
<h4 data-id="heading-81">3. CRC 校验和：避免数据损坏</h4>
<ul>
<li>每条消息写入时，都会计算 CRC32 校验和并存储在消息头部；</li>
<li>读取消息时，Broker 会重新计算校验和并与存储值对比，若不一致则判定数据损坏，拒绝返回该消息，避免消费端处理错误数据；</li>
<li>磁盘物理损坏、网络传输错误等导致的数据损坏，均可通过校验和检测。</li>
</ul>
<h3 data-id="heading-82">四、持久化后的日志管理：清理与保留</h3>
<p>持久化并非 “永久存储”，Kafka 通过日志清理机制控制磁盘占用，避免存储溢出，同时不影响已持久化数据的可靠性。</p>
<h4 data-id="heading-83">1. 日志保留规则（触发清理的前提）</h4>
<ul>
<li>时间保留：默认 <code>log.retention.hours=168</code>（7 天），超过保留时间的段文件会被清理；</li>
<li>大小保留：默认 <code>log.retention.bytes=-1</code>（无限制），可配置为 Topic 总存储上限（如 100GB），超过后删除最早的段文件；</li>
<li>日志压缩保留：启用日志压缩（<code>log.cleanup.policy=compact</code>）时，仅保留每个 Key 的最新版本消息，旧版本消息被清理（适用于变更日志场景，如用户信息更新）。</li>
</ul>
<h4 data-id="heading-84">2. 日志清理策略（两种核心方式）</h4>
<ul>
<li>
<p>策略 1：删除清理（默认，<code>log.cleanup.policy=delete</code>）：</p>
<ul>
<li>直接删除满足保留规则的旧段文件（.log + .index + .timeindex 一并删除），开销极低；</li>
<li>特点：简单高效，适用于 “日志型数据”（如用户行为日志、监控数据），无需保留历史版本。</li>
</ul>
</li>
<li>
<p>策略 2：压缩清理（<code>log.cleanup.policy=compact</code>）：</p>
<ul>
<li>对活跃段文件（未关闭）进行数据压缩，保留每个 Key 的最新消息，删除旧版本；</li>
<li>适用场景：“变更型数据”（如订单状态更新、用户信息变更），需保留最新状态，减少存储占用；</li>
<li>优势：压缩后磁盘占用大幅降低，且不影响消息的顺序性和可靠性。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-85">3. 清理执行机制</h4>
<ul>
<li>Kafka 后台启动 “日志清理线程”（<code>log.cleaner.threads</code>，默认 1 个），定期扫描所有 Partition 的段文件，判断是否满足清理条件；</li>
<li>清理仅针对 “已关闭的非活跃段文件”（活跃段文件不清理），避免影响当前写入性能；</li>
<li>清理过程中，会生成新的压缩 / 筛选后的段文件，替换旧文件，整个过程不影响消息的读取和写入。</li>
</ul>
<h3 data-id="heading-86">五、持久化机制的核心特点与设计哲学</h3>
<p>Kafka 持久化机制之所以能兼顾 “高性能” 和 “高可靠”，核心是遵循了 3 个设计原则：</p>
<ol>
<li><strong>顺势而为：利用硬件特性</strong>：基于磁盘顺序 IO（速度接近内存），规避随机 IO 瓶颈；依赖 OS 页缓存和批量刷盘，减少应用层内存管理和 IO 开销；</li>
<li><strong>分层设计：简化复杂度</strong>：通过 “分区 - 日志 - 分段” 分层，将大文件拆分为小单元，让写入、刷盘、清理等操作更高效，互不干扰；</li>
<li><strong>冗余兜底：平衡性能与可靠</strong>：不追求 “单副本绝对安全”（如同步刷盘），而是通过多副本同步 + 刷盘策略，在异步刷盘的高性能基础上，实现 “宕机不丢数据”。</li>
</ol>
<h3 data-id="heading-87">六、总结</h3>
<p>Kafka 持久化机制的本质是  <strong>“日志结构的顺序存储 + 刷盘持久化 + 多副本冗余 + 日志生命周期管理”</strong>  的协同：</p>
<ul>
<li>物理基础：分区 - 日志 - 分段结构，保证顺序 IO 和高效管理；</li>
<li>核心流程：消息→页缓存→日志文件→刷盘→磁盘，兼顾性能和可靠性；</li>
<li>可靠性保障：多副本同步、高水位、CRC 校验，避免数据丢失和损坏；</li>
<li>生命周期管理：日志保留与清理，控制磁盘占用。</li>
</ul>
<h3 data-id="heading-88">kafka的日志定位原理</h3>
<p>Kafka 的日志定位（Log Positioning）核心目标是 <strong>根据消息的偏移量（Offset）或时间戳，快速找到其在物理磁盘日志文件中的存储位置</strong>，支撑消费者按偏移量读取、业务按时间范围查询等核心场景。其设计本质是 “<strong>分层查找 + 索引辅助 + 顺序 IO</strong>” 的协同，既保证定位速度（毫秒级），又避免索引过度占用内存。以下从 “基础依赖、核心场景（Offset / 时间戳定位）、优化机制” 三个维度展开：</p>
<h3 data-id="heading-89">一、定位的基础：日志分段与索引文件</h3>
<p>Kafka 日志定位的前提是 “分区 - 日志 - 分段” 的分层存储结构（之前讲持久化 / 高性能时已提及），核心依赖 <strong>分段文件 + 两类稀疏索引</strong>，先通过分层缩小查找范围，再通过索引精准定位。</p>
<h4 data-id="heading-90">1. 核心存储结构回顾（定位的物理基础）</h4>
<p>每个 Partition 的日志被拆分为多个 <strong>段文件（Segment）</strong> ，每个段文件对应 3 类文件（存储在同一 Partition 目录下）：</p>





























<table><thead><tr><th>文件类型</th><th>后缀</th><th>核心作用</th><th>存储内容格式</th></tr></thead><tbody><tr><td>数据文件</td><td><code>.log</code></td><td>存储原始消息（二进制），定位的最终载体</td><td>消息长度 + CRC 校验 + Key+Value + 时间戳等</td></tr><tr><td>偏移量索引文件</td><td><code>.index</code></td><td>映射 “消息 Offset → 数据文件物理位置”</td><td>（相对 Offset，物理位置）键值对</td></tr><tr><td>时间戳索引文件</td><td><code>.timeindex</code></td><td>映射 “消息时间戳 → 对应 Offset”</td><td>（时间戳，相对 Offset）键值对</td></tr></tbody></table>
<h4 data-id="heading-91">2. 关键设计：分段命名与索引特性</h4>
<ul>
<li><strong>段文件命名规则</strong>：每个段文件的文件名以 “该段内最小消息的 Offset” 命名（如 <code>00000000000000000000.log</code> 表示起始 Offset 为 0，<code>00000000000000012345.log</code> 表示起始 Offset 为 12345）。👉 作用：通过文件名可快速判断 “目标消息 Offset 属于哪个段文件”，无需扫描所有段。</li>
<li><strong>稀疏索引（Sparse Index）</strong> ：索引文件中仅存储 “部分消息” 的映射关系（默认每 4KB 数据记录一条索引，可通过 <code>log.index.interval.bytes</code> 调整），而非每条消息都建索引。👉 优势：索引文件体积极小（仅为数据文件的 0.1%~0.5%），可被 OS 页缓存完全加载，查找时无需磁盘 IO；劣势：需配合少量顺序扫描补全定位。</li>
</ul>
<h3 data-id="heading-92">二、核心定位场景：按 Offset 定位（最常用）</h3>
<p>按 Offset 定位是 Kafka 最核心的场景（消费者按 Offset 读取消息、副本同步时定位同步起点），流程分为 “<strong>定位段文件</strong>” 和 “<strong>定位段内消息</strong>” 两步，全程毫秒级完成。</p>
<h4 data-id="heading-93">步骤 1：定位目标段文件（二分查找）</h4>
<p>Kafka 先通过 “段文件名” 快速筛选出目标消息所在的段文件，核心是二分查找（因为段文件按起始 Offset 有序排列）：</p>
<ol>
<li>假设 Partition 有 3 个段文件：<code>00000000000000000000.log</code>（起始 Offset 0）、<code>00000000000000012345.log</code>（起始 12345）、<code>00000000000000024567.log</code>（起始 24567）；</li>
<li>目标 Offset 为 18888：通过二分查找段文件名，发现 12345 ≤ 18888 &lt; 24567，因此目标段文件是 <code>00000000000000012345.log</code>；</li>
<li>关键优化：段文件列表会被缓存到内存，二分查找无需磁盘 IO，耗时可忽略。</li>
</ol>
<h4 data-id="heading-94">步骤 2：定位段内消息位置（索引二分 + 顺序扫描）</h4>
<p>找到目标段文件后，通过 <code>.index</code> 偏移量索引精准定位消息在 <code>.log</code> 文件中的物理位置（如文件偏移量、消息长度），流程如下：</p>
<ol>
<li><strong>计算相对 Offset</strong>：目标 Offset（18888）减去当前段的起始 Offset（12345），得到相对 Offset = 6543（段内消息的偏移量，从 0 开始计数）；</li>
<li><strong>二分查找索引文件</strong>：<code>.index</code> 文件中存储的是 “相对 Offset → 物理位置” 的映射（如（100, 1024）表示相对 Offset 100 的消息在 <code>.log</code> 文件中偏移量为 1024 的位置）。由于索引是稀疏的，Kafka 通过二分查找找到 “小于等于目标相对 Offset 的最大索引项”（例如目标相对 Offset 6543，找到索引项（6500, 81920），表示相对 Offset 6500 的消息在物理位置 81920）；</li>
<li><strong>段内顺序扫描</strong>：从索引项对应的物理位置（81920）开始，在 <code>.log</code> 文件中顺序读取消息，直到找到相对 Offset 6543 对应的目标消息（因索引间隔默认 4KB，最多扫描 4KB 数据，开销极小）；</li>
<li><strong>返回物理位置</strong>：获取目标消息的物理偏移量和长度，后续即可从该位置读取消息内容。</li>
</ol>
<h4 data-id="heading-95">流程图解（按 Offset 定位）</h4>
<p>plaintext</p>
<pre><code class="hljs language-sql" lang="sql">目标 <span class="hljs-keyword">Offset</span>（<span class="hljs-number">18888</span>）
  ↓
二分查找段文件 → 目标段（起始 <span class="hljs-keyword">Offset</span> <span class="hljs-number">12345</span>）
  ↓
计算相对 <span class="hljs-keyword">Offset</span>（<span class="hljs-number">18888</span><span class="hljs-number">-12345</span><span class="hljs-operator">=</span><span class="hljs-number">6543</span>）
  ↓
二分查找 .index 文件 → 找到最近索引项（<span class="hljs-number">6500</span>→<span class="hljs-number">81920</span>）
  ↓
在 .log 文件中从 <span class="hljs-number">81920</span> 开始顺序扫描 → 找到目标消息
</code></pre>
<h3 data-id="heading-96">三、补充场景：按时间戳定位（业务查询常用）</h3>
<p>除了按 Offset，Kafka 还支持按时间戳定位消息（如 “查询 1 小时前的所有消息”），核心是 “时间戳→Offset 转换 + Offset 定位” 的两步流程：</p>
<h4 data-id="heading-97">步骤 1：时间戳→Offset 转换（依赖 .timeindex 索引）</h4>
<ol>
<li>遍历 Partition 的所有段文件，通过 <code>.timeindex</code> 文件（存储 “时间戳→相对 Offset” 映射），找到 “小于等于目标时间戳的最大时间戳对应的相对 Offset”；</li>
<li>转换为绝对 Offset：相对 Offset + 该段的起始 Offset，得到目标时间戳对应的绝对 Offset；</li>
<li>若目标时间戳小于所有段的最小时间戳，返回 Partition 的起始 Offset；若大于最大时间戳，返回最新 Offset。</li>
</ol>
<h4 data-id="heading-98">步骤 2：按转换后的 Offset 定位</h4>
<p>后续流程与 “按 Offset 定位” 完全一致：通过 Offset 找到段文件→索引查找→段内扫描，最终定位到目标消息。</p>
<h4 data-id="heading-99">关键说明</h4>
<ul>
<li><code>.timeindex</code> 同样是稀疏索引（默认每 4KB 数据记录一条），确保索引文件体积可控；</li>
<li>时间戳定位的精度依赖索引间隔，默认情况下误差在毫秒级，满足绝大多数业务场景；</li>
<li>生产中可通过 <code>log.index.interval.bytes</code> 调整索引密度（越小精度越高，但索引文件越大）。</li>
</ul>
<h3 data-id="heading-100">四、定位效率的优化机制</h3>
<p>Kafka 日志定位能达到 “毫秒级”，核心是以下 3 点优化，充分利用硬件和存储特性：</p>
<h4 data-id="heading-101">1. 索引文件常驻 OS 页缓存</h4>
<ul>
<li><code>.index</code> 和 <code>.timeindex</code> 文件体积极小（仅为 <code>.log</code> 文件的 0.1%<del>0.5%），例如 1GB 的 <code>.log</code> 文件，索引文件仅 1</del>5MB；</li>
<li>这些索引文件会被 OS 页缓存自动缓存（常驻内存），二分查找索引时无需读取磁盘，仅需内存操作，耗时微秒级。</li>
</ul>
<h4 data-id="heading-102">2. 分段设计减少查找范围</h4>
<ul>
<li>若不分段，查找 Offset 需遍历整个大文件，耗时随文件大小线性增长；</li>
<li>分段后先通过二分查找定位到单个段（O (log N) 时间复杂度，N 为段数），再在段内查找，整体复杂度可控，且段数通常较少（默认 1GB / 段，1TB 数据仅 1000 个段）。</li>
</ul>
<h4 data-id="heading-103">3. 索引项的编码优化（节省空间 + 加速查找）</h4>
<ul>
<li>Kafka 对索引文件的存储格式进行了压缩优化：索引项中的 “相对 Offset” 和 “物理位置” 均采用可变长度编码（Varint），减少存储开销；</li>
<li>索引文件按顺序写入，读取时是顺序 IO，配合页缓存，查找速度极快。</li>
</ul>
<h3 data-id="heading-104">五、常见误区澄清</h3>
<ol>
<li><strong>“稀疏索引会导致定位变慢”</strong> ：错！稀疏索引的间隔默认 4KB，即使索引未命中，段内顺序扫描的最大数据量仅 4KB，磁盘 IO 开销可忽略，且索引文件体积小、缓存命中率高，整体速度比稠密索引更快；</li>
<li><strong>“定位效率与 Partition 数据量正相关”</strong> ：不完全对！定位效率主要与段数相关（O (log N)），而非数据总量。即使 Partition 数据量达 TB 级，只要段数合理（如 1GB / 段，1TB 仅 1000 个段），定位耗时仍维持在毫秒级；</li>
<li><strong>“时间戳定位是精准的”</strong> ：错！由于 <code>.timeindex</code> 是稀疏索引，定位结果是 “目标时间戳附近的最近消息”，而非绝对精准匹配，若需精准时间戳查询，需业务层在消费后二次过滤。</li>
</ol>
<h3 data-id="heading-105">总结</h3>
<p>Kafka 日志定位的核心逻辑是  <strong>“分层缩小范围 + 索引精准引导 + 硬件特性利用”</strong> ：</p>
<ol>
<li>分层：通过 Partition→段文件的分层，将查找范围从 “全量数据” 缩小到 “单个段文件”；</li>
<li>索引：通过 <code>.index</code>（Offset→物理位置）和 <code>.timeindex</code>（时间戳→Offset）稀疏索引，快速定位到段内大致位置；</li>
<li>优化：索引文件常驻页缓存、段内扫描范围极小，确保定位耗时控制在毫秒级。</li>
</ol>
<h2 data-id="heading-106">Kafka的零拷贝技术</h2>
<p>Kafka 能实现 “百万级 / 秒” 吞吐，<strong>零拷贝（Zero-Copy）技术</strong>是关键支撑之一。其核心目标是 <strong>减少数据在 “磁盘→内存→网络” 传输过程中的拷贝次数和用户态 / 内核态切换开销</strong>，将传统传输的 4 次拷贝、2 次切换，优化为 2 次拷贝、0 次切换，大幅降低 CPU 和内存带宽占用，提升数据传输效率。以下从 “技术本质、传统传输痛点、Kafka 实现方式、应用场景、性能收益” 五个维度展开解析：</p>
<h3 data-id="heading-107">一、先明确：零拷贝的 “零” 是什么？</h3>
<p>零拷贝并非 “完全不拷贝”，而是  <strong>“避免用户态与内核态之间的无效数据拷贝”</strong> （这是最耗时的环节）。数据仍需在 “磁盘→内核态页缓存→网卡” 之间传输，但跳过了 “内核态→用户态→内核态” 的冗余拷贝，从而减少开销。</p>
<p>核心术语铺垫：</p>
<ul>
<li><strong>用户态</strong>：应用程序（如 Kafka Broker）运行的内存空间，权限受限，不能直接操作硬件；</li>
<li><strong>内核态</strong>：操作系统内核运行的内存空间，可直接操作磁盘、网卡等硬件，权限最高；</li>
<li><strong>页缓存（Page Cache）</strong> ：内核态的内存缓存区域，用于缓存磁盘文件数据，是零拷贝的核心依赖。</li>
</ul>
<h3 data-id="heading-108">二、传统数据传输的痛点：4 次拷贝 + 2 次切换</h3>
<p>在未使用零拷贝的场景中（如传统文件服务器、早期 MQ），数据从 “磁盘文件” 传输到 “网络客户端” 的流程如下（以 Kafka 消费者拉取消息为例）：</p>
<h4 data-id="heading-109">传统传输流程（4 次拷贝 + 2 次切换）</h4>
<ol>
<li><strong>拷贝 1：磁盘→内核态页缓存</strong>操作系统通过 <code>read()</code> 系统调用，将磁盘上的消息数据读取到内核态的页缓存（硬件→内核态，由 DMA 控制器完成，无需 CPU 参与）；</li>
<li><strong>切换 1：内核态→用户态</strong>系统调用返回，CPU 从内核态切换到用户态，应用程序（Kafka Broker）可访问数据；</li>
<li><strong>拷贝 2：内核态页缓存→用户态应用缓存</strong>Kafka Broker 将内核态页缓存中的数据，拷贝到自身的用户态缓存（如 JVM 堆内存）；</li>
<li><strong>拷贝 3：用户态应用缓存→内核态 Socket 缓存</strong>Kafka Broker 通过 <code>write()</code> 系统调用，将用户态缓存的数据拷贝到内核态的 Socket 发送缓存（用户态→内核态，CPU 参与）；</li>
<li><strong>切换 2：用户态→内核态</strong>系统调用执行，CPU 再次切换到内核态；</li>
<li><strong>拷贝 4：内核态 Socket 缓存→网卡</strong>操作系统将 Socket 缓存中的数据拷贝到网卡缓冲区，最终通过网络发送给消费者（内核态→硬件，DMA 完成）。</li>
</ol>
<h4 data-id="heading-110">核心痛点：</h4>
<ul>
<li><strong>冗余拷贝</strong>：步骤 2 和 3 的 “内核态↔用户态” 拷贝完全无效 —— 应用程序（Kafka）仅起到 “数据搬运工” 的作用，未对数据做任何修改；</li>
<li><strong>切换开销</strong>：用户态与内核态切换涉及 CPU 上下文切换、权限校验，耗时远超数据拷贝；</li>
<li><strong>CPU 占用高</strong>：用户态与内核态的拷贝需 CPU 全程参与，高吞吐场景下 CPU 会成为瓶颈。</li>
</ul>
<h3 data-id="heading-111">三、Kafka 的零拷贝实现：基于 Linux <code>sendfile()</code> 系统调用</h3>
<p>Kafka 基于 Linux 内核提供的 <code>sendfile()</code> 系统调用实现零拷贝，直接跳过 “用户态缓存” 环节，简化传输流程，核心是 “内核态内部数据流转，无需用户态参与”。</p>
<h4 data-id="heading-112">零拷贝传输流程（2 次拷贝 + 0 次切换）</h4>
<p>以 Kafka 消费者拉取消息为例，零拷贝流程如下：</p>
<ol>
<li><strong>拷贝 1：磁盘→内核态页缓存</strong>与传统流程一致，通过 DMA 将磁盘数据读取到内核态页缓存（无 CPU 参与）；</li>
<li><strong>内核态内部 “指针映射”：页缓存→Socket 缓存</strong>Kafka 调用 <code>sendfile()</code> 系统调用，操作系统直接在内核态将 “页缓存中数据的内存地址” 映射到 Socket 发送缓存（<strong>无实际数据拷贝，仅复制指针</strong>）；</li>
<li><strong>拷贝 2：内核态 Socket 缓存→网卡</strong>通过 DMA 将 Socket 缓存（实际指向页缓存数据）的数据发送到网卡（无 CPU 参与）；</li>
<li><strong>切换次数：0 次</strong>整个过程仅需一次 <code>sendfile()</code> 系统调用，CPU 无需在用户态与内核态之间切换，全程由内核主导。</li>
</ol>
<h4 data-id="heading-113">流程图解对比</h4>





























<table><thead><tr><th>传统传输流程</th><th>零拷贝传输流程（Kafka）</th></tr></thead><tbody><tr><td>磁盘 → 内核态页缓存（拷贝 1）</td><td>磁盘 → 内核态页缓存（拷贝 1）</td></tr><tr><td>内核态 → 用户态应用缓存（拷贝 2）</td><td>内核态页缓存 → Socket 缓存（指针映射，无拷贝）</td></tr><tr><td>用户态 → 内核态 Socket 缓存（拷贝 3）</td><td>内核态 Socket 缓存 → 网卡（拷贝 2）</td></tr><tr><td>内核态 → 网卡（拷贝 4）</td><td>全程无用户态 / 内核态切换</td></tr><tr><td>2 次切换 + 4 次拷贝</td><td>0 次切换 + 2 次拷贝（仅 DMA 拷贝）</td></tr></tbody></table>
<h3 data-id="heading-114">四、Kafka 中零拷贝的核心应用场景</h3>
<p>零拷贝并非在所有场景都生效，Kafka 主要在 “数据无需修改、直接转发” 的场景中使用，核心场景有 2 个：</p>
<h4 data-id="heading-115">1. 消费者拉取消息（最核心场景）</h4>
<p>消费者通过 <code>fetch request</code> 拉取消息时，Kafka Broker 无需修改消息数据（仅需验证权限、过滤未提交消息），直接通过 <code>sendfile()</code> 将页缓存中的消息数据发送到消费者网络连接，是零拷贝最主要的应用场景，占 Broker 网络传输的 80% 以上。</p>
<h4 data-id="heading-116">2. Broker 间副本同步</h4>
<p>Follower 副本通过 “拉取模式” 从 Leader 副本同步消息时，Leader Broker 同样无需修改消息，直接将页缓存中的消息通过零拷贝发送给 Follower，减少跨 Broker 传输的 CPU 和网络开销。</p>
<h4 data-id="heading-117">不适用场景</h4>
<ul>
<li>生产者发送消息：消息需先写入 Kafka 的用户态缓冲区（批量、压缩），再写入页缓存，无法跳过用户态；</li>
<li>消息压缩 / 解压：若消息启用压缩（如 Snappy、LZ4），Broker 需在用户态解压后再传输（或消费者在用户态解压），此时零拷贝不生效；</li>
<li>消息过滤 / 修改：若 Broker 需对消息做业务过滤、格式转换，需读取数据到用户态处理，零拷贝失效。</li>
</ul>
<h3 data-id="heading-118">五、零拷贝的性能收益：实测提升 30%~50% 吞吐量</h3>
<p>零拷贝对 Kafka 性能的提升体现在三个维度，是高吞吐的关键支撑：</p>
<h4 data-id="heading-119">1. 减少 CPU 开销</h4>
<ul>
<li>避免了 “内核态↔用户态” 的 2 次数据拷贝（CPU 密集型操作）；</li>
<li>减少了用户态 / 内核态切换的上下文开销（每次切换耗时约 1~10 微秒，高并发下累积开销巨大）；</li>
<li>实测：高吞吐场景下，零拷贝可降低 CPU 使用率 40%~60%，避免 CPU 成为瓶颈。</li>
</ul>
<h4 data-id="heading-120">2. 节省内存带宽</h4>
<ul>
<li>数据无需在用户态缓存（如 JVM 堆）和内核态缓存之间重复存储，减少内存占用；</li>
<li>例如：1GB 消息传输，传统流程需占用 2GB 内存（内核态 1GB + 用户态 1GB），零拷贝仅需 1GB 内核态内存，内存带宽占用减少 50%。</li>
</ul>
<h4 data-id="heading-121">3. 提升磁盘 IO 效率</h4>
<ul>
<li>消息先写入页缓存，消费者拉取时优先从页缓存读取（零拷贝直接转发），避免重复读取磁盘；</li>
<li>页缓存由操作系统内核管理，比应用层缓存（如 JVM 缓存）更高效，缓存命中率更高。</li>
</ul>
<h4 data-id="heading-122">实测数据参考</h4>
<ul>
<li>传统传输：单 Broker 消费者拉取吞吐量约 300MB/s，CPU 使用率 80%；</li>
<li>零拷贝传输：单 Broker 消费者拉取吞吐量约 500MB/s，CPU 使用率 30%；</li>
<li>结论：零拷贝使吞吐量提升约 67%，CPU 使用率降低约 62.5%，性能提升显著。</li>
</ul>
<h3 data-id="heading-123">六、Kafka 零拷贝的配置与依赖</h3>
<h4 data-id="heading-124">1. 启用配置（默认开启，无需手动修改）</h4>
<p>Kafka Broker 端通过 <code>enable.sendfile</code> 参数控制是否启用零拷贝，默认值为 <code>true</code>（生产环境无需关闭）：</p>
<p>properties</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># server.properties（Broker 配置）</span>
<span class="hljs-attr">enable.sendfile</span>=<span class="hljs-literal">true</span>  <span class="hljs-comment"># 启用零拷贝（默认 true）</span>
</code></pre>
<h4 data-id="heading-125">2. 依赖条件</h4>
<ul>
<li>操作系统：仅支持 Linux 系统（<code>sendfile()</code> 是 Linux 内核特性），Windows、macOS 不支持（会自动降级为传统传输）；</li>
<li>Kafka 版本：所有稳定版本均支持（0.8+ 已内置），无需额外依赖；</li>
<li>数据传输场景：仅适用于 “数据直接转发” 场景（如消费者拉取、副本同步），如前所述。</li>
</ul>
<h3 data-id="heading-126">七、常见误区澄清</h3>
<ol>
<li><strong>“零拷贝就是完全不拷贝数据”</strong> ：错！零拷贝是 “避免用户态与内核态之间的拷贝”，数据仍需从磁盘→页缓存→网卡（2 次 DMA 拷贝），但 DMA 拷贝无需 CPU 参与，开销可忽略。</li>
<li><strong>“Kafka 所有数据传输都用零拷贝”</strong> ：错！仅消费者拉取、副本同步等 “无需修改数据” 的场景用零拷贝；生产者写入、消息压缩 / 解压等场景不适用。</li>
<li><strong>“Windows 环境下 Kafka 也能使用零拷贝”</strong> ：错！<code>sendfile()</code> 是 Linux 特有系统调用，Windows 用 <code>TransmitFile()</code> 类似机制，但 Kafka 未适配，默认降级为传统传输，性能略低。</li>
<li><strong>“零拷贝会影响数据可靠性”</strong> ：错！零拷贝仅优化传输流程，不改变 Kafka 的刷盘、副本同步机制，数据可靠性由 “刷盘策略 + 副本冗余” 保障，与零拷贝无关。</li>
</ol>
<h3 data-id="heading-127">总结</h3>
<p>Kafka 零拷贝技术的核心是  <strong>“利用 Linux <code>sendfile()</code> 系统调用，跳过用户态缓存，实现内核态内部数据直接转发”</strong> ，其设计哲学是 “避免无效开销，顺势利用操作系统内核特性”：</p>
<ul>
<li>核心价值：减少 2 次冗余拷贝和 2 次状态切换，大幅降低 CPU 和内存带宽占用；</li>
<li>适用场景：消费者拉取消息、Broker 间副本同步；</li>
<li>性能收益：吞吐量提升 30%~50%，CPU 使用率显著降低；</li>
<li>使用成本：默认开启，无需手动配置，仅依赖 Linux 系统。</li>
</ul>
<h2 data-id="heading-128">kafka的日志压缩技术</h2>
<p>Kafka 日志压缩技术的核心目标是 <strong>对 “变更型数据”（如用户信息、订单状态）保留每个 Key 的最新版本，删除历史旧版本，在不破坏消息顺序的前提下大幅减少磁盘存储占用</strong>。其设计本质是 “Key 级去重 + 后台异步压缩”，既兼顾存储效率，又不影响读写性能，是 Kafka 针对 “状态型数据” 的核心优化。以下从 “核心定义、与删除策略的区别、工作原理、配置参数、适用场景、注意事项” 六个维度展开解析：</p>
<h3 data-id="heading-129">一、先明确：日志压缩的核心定位</h3>
<h4 data-id="heading-130">1. 定义</h4>
<p>日志压缩（Log Compaction）是 Kafka 提供的一种 <strong>日志清理策略</strong>，通过 “保留每个消息 Key 的最新 Offset 版本，删除该 Key 的所有历史旧版本”，将 “变更日志” 压缩为 “状态快照”，同时保证 Partition 内消息的顺序性不被破坏。</p>
<h4 data-id="heading-131">2. 与 “删除策略” 的核心区别（避免混淆）</h4>
<p>Kafka 有两种日志清理策略（通过 <code>log.cleanup.policy</code> 配置），适用场景完全不同：</p>























<table><thead><tr><th>清理策略</th><th>核心逻辑</th><th>适用数据类型</th><th>核心目标</th></tr></thead><tbody><tr><td>删除策略（delete，默认）</td><td>按时间（<code>log.retention.hours</code>）或大小（<code>log.retention.bytes</code>）删除过期 / 超限的段文件</td><td>日志型数据（如用户行为日志、监控日志）</td><td>清理 “过期 / 冗余” 数据，控制存储上限</td></tr><tr><td>压缩策略（compact）</td><td>按 Key 去重，仅保留每个 Key 的最新版本消息</td><td>变更型数据（如用户信息更新、订单状态变更）</td><td>保留 “最新状态”，减少存储占用</td></tr></tbody></table>
<p>👉 关键结论：压缩策略不是 “删除过期数据”，而是 “删除同一 Key 的旧版本数据”，核心是 “状态保留” 而非 “时间 / 大小限制”。</p>
<h3 data-id="heading-132">二、日志压缩的核心工作原理</h3>
<p>Kafka 日志压缩通过 “后台异步线程 + 分段处理 + Key 去重” 实现，全程不影响前台读写性能，核心流程可拆解为 “触发条件→执行流程→压缩后结构” 三部分。</p>
<h4 data-id="heading-133">1. 压缩的触发条件</h4>
<p>压缩不会实时执行，需满足以下条件才会触发：</p>
<ul>
<li>策略启用：Topic 配置 <code>log.cleanup.policy=compact</code>（默认是 <code>delete</code>）；</li>
<li>脏数据比例达标：段文件中 “可被压缩的旧版本消息”（称为 “脏数据”）占比 ≥ <code>log.cleaner.min.cleanable.ratio</code>（默认 0.5，即 50%）；</li>
<li>段文件状态：仅对 “非活跃段”（已关闭、不再写入的段文件）进行压缩，<strong>活跃段（当前写入的段）不压缩</strong>（避免影响写入性能）；</li>
<li>时间阈值：距离上一次压缩超过 <code>log.cleaner.backoff.ms</code>（默认 15000ms，即 15s）。</li>
</ul>
<h4 data-id="heading-134">2. 压缩执行流程（后台异步）</h4>
<p>Kafka 后台启动独立的 “日志清理线程池”（默认 1 个线程，通过 <code>log.cleaner.threads</code> 配置），定期扫描所有启用压缩策略的 Partition，执行以下步骤：</p>
<ol>
<li>
<p><strong>筛选目标段</strong>：遍历 Partition 的段文件，筛选出 “非活跃段” 且 “脏数据比例达标” 的段文件组（通常是多个连续的非活跃段）；</p>
</li>
<li>
<p><strong>Key 去重与合并</strong>：</p>
<ul>
<li>顺序读取目标段文件中的所有消息，维护一个 “Key→最新 Offset” 的映射表；</li>
<li>仅保留每个 Key 的 “最新 Offset 消息”，丢弃所有旧版本消息；</li>
</ul>
</li>
<li>
<p><strong>压缩写入新段</strong>：将去重后的消息按原 Offset 顺序（保证顺序性），使用指定压缩算法（默认 Snappy）写入新的段文件；</p>
</li>
<li>
<p><strong>替换旧段</strong>：新段文件写入完成后，删除原来的目标段文件，同时更新 Partition 的段文件列表和索引文件（.index/.timeindex）；</p>
</li>
<li>
<p><strong>索引同步</strong>：新段文件对应的索引文件会重新生成，确保压缩后的消息仍能通过 Offset / 时间戳快速定位。</p>
</li>
</ol>
<h4 data-id="heading-135">3. 压缩后的日志结构特点</h4>
<ul>
<li>顺序性不变：压缩后消息的 Offset 顺序与原日志完全一致（仅删除同一 Key 的旧版本，不改变消息排列顺序）；</li>
<li>段文件依然分层：压缩后的日志仍按 <code>log.segment.bytes</code>（默认 1GB）拆分段文件，不影响定位效率；</li>
<li>索引文件同步更新：新段文件的索引文件会记录去重后消息的 Offset→物理位置映射，保证查找速度。</li>
</ul>
<h4 data-id="heading-136">示例：压缩前后日志对比</h4>
<p>假设 Partition 中消息如下（Key:Value → Offset）：</p>
<p>plaintext</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-title class_">User1</span><span class="hljs-symbol">:V1</span>→<span class="hljs-number">0</span>, <span class="hljs-title class_">User2</span><span class="hljs-symbol">:V1</span>→<span class="hljs-number">1</span>, <span class="hljs-title class_">User1</span><span class="hljs-symbol">:V2</span>→<span class="hljs-number">2</span>, <span class="hljs-title class_">User3</span><span class="hljs-symbol">:V1</span>→<span class="hljs-number">3</span>, <span class="hljs-title class_">User1</span><span class="hljs-symbol">:V3</span>→<span class="hljs-number">4</span>
</code></pre>
<p>压缩后仅保留每个 Key 的最新版本，日志变为：</p>
<p>plaintext</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-title class_">User2</span><span class="hljs-symbol">:V1</span>→<span class="hljs-number">1</span>, <span class="hljs-title class_">User3</span><span class="hljs-symbol">:V1</span>→<span class="hljs-number">3</span>, <span class="hljs-title class_">User1</span><span class="hljs-symbol">:V3</span>→<span class="hljs-number">4</span> （<span class="hljs-title class_">Offset</span> 顺序不变，仅删除 <span class="hljs-title class_">User1</span> 的旧版本）
</code></pre>
<h3 data-id="heading-137">三、压缩的核心配置参数（生产落地必看）</h3>
<p>以下配置可通过 Broker 全局配置（<code>server.properties</code>）或 Topic 级配置（创建 / 修改 Topic 时指定）调整，Topic 级配置优先级更高：</p>



























































<table><thead><tr><th>参数名</th><th>核心作用</th><th>默认值</th><th>生产建议值</th></tr></thead><tbody><tr><td><code>log.cleanup.policy</code></td><td>日志清理策略（compact/delete/compact,delete）</td><td>delete</td><td>变更型数据设为 <code>compact</code></td></tr><tr><td><code>log.cleaner.min.cleanable.ratio</code></td><td>触发压缩的最小脏数据比例（脏数据占比≥该值才压缩）</td><td>0.5</td><td>0.3~0.5（数据更新频繁设 0.3，否则设 0.5）</td></tr><tr><td><code>log.cleaner.threads</code></td><td>日志压缩线程数（线程越多，压缩速度越快）</td><td>1</td><td>2~4（集群规模大、压缩任务多可增加）</td></tr><tr><td><code>log.cleaner.io.max.bytes.per.second</code></td><td>压缩时的最大 IO 速率（避免压缩占用过多磁盘 IO）</td><td>1.7976931348623157E308（无限制）</td><td>100MB/s~500MB/s（根据磁盘性能调整）</td></tr><tr><td><code>log.cleaner.backoff.ms</code></td><td>两次压缩之间的最小间隔（避免频繁压缩）</td><td>15000ms（15s）</td><td>15000ms（默认即可）</td></tr><tr><td><code>log.compression.type</code></td><td>压缩算法（Snappy/LZ4/GZIP/ZSTD/none）</td><td>none</td><td>Snappy 或 LZ4（平衡压缩比和 CPU 开销）</td></tr><tr><td><code>log.segment.bytes</code></td><td>段文件大小（压缩针对非活跃段，大小影响压缩频率）</td><td>1073741824（1GB）</td><td>512MB~1GB（变更频繁数据设 512MB，减少单次压缩数据量）</td></tr><tr><td><code>log.cleaner.delete.retention.ms</code></td><td>压缩后 “墓碑消息” 的保留时间（见下文说明）</td><td>86400000ms（24h）</td><td>86400000ms（默认即可）</td></tr></tbody></table>
<h4 data-id="heading-138">关键配置说明：</h4>
<ul>
<li><strong>压缩算法选择</strong>：Snappy/LZ4 是生产首选 ——Snappy 压缩比中等（约 3:1）、CPU 开销低；LZ4 压缩比略高、解压速度更快；GZIP 压缩比最高（约 5:1）但 CPU 开销大，仅适用于存储紧张场景；</li>
<li><strong>脏数据比例</strong>：设得越低，压缩越频繁，存储占用越小，但 IO/CPU 开销越大；设得越高，压缩频率低，存储占用略高，但性能开销小；</li>
<li><strong>墓碑消息（Tombstone Message）</strong> ：若要彻底删除某个 Key 的所有消息，可发送一条 “Key 存在、Value 为 null” 的消息（墓碑消息），压缩时会删除该 Key 的所有版本，且墓碑消息会保留 <code>log.cleaner.delete.retention.ms</code> 后再删除，确保所有副本同步删除。</li>
</ul>
<h3 data-id="heading-139">四、日志压缩的适用场景与不适用场景</h3>
<h4 data-id="heading-140">1. 适用场景（核心推荐）</h4>
<ul>
<li>变更型数据：用户信息更新（如昵称、手机号）、订单状态变更（待支付→已支付→已完成）、配置项变更等；</li>
<li>状态快照需求：业务需要获取 “最新状态” 而非 “历史变更记录”（如查询用户当前信息，无需知道之前的所有修改记录）；</li>
<li>存储优化需求：同一 Key 的消息重复度高，历史版本无业务价值，需减少磁盘占用（如物联网设备的状态上报，设备每秒上报一次，仅需保留最新状态）。</li>
</ul>
<h4 data-id="heading-141">2. 不适用场景（禁止使用）</h4>
<ul>
<li>日志型数据：用户行为日志、监控日志、审计日志等需要保留完整历史记录的场景（应使用 <code>delete</code> 策略）；</li>
<li>无 Key 消息：压缩策略基于 Key 去重，若消息无 Key（<code>Key=null</code>），压缩无效（不会删除任何消息，仅浪费 CPU/IO）；</li>
<li>需保留历史版本的场景：如金融交易记录、法律合规数据，需保留所有历史变更记录，不能删除旧版本；</li>
<li>高实时写入且 Key 极少重复的场景：如日志流中 Key 几乎唯一，压缩后存储无明显减少，反而增加压缩开销。</li>
</ul>
<h3 data-id="heading-142">五、日志压缩的注意事项与性能影响</h3>
<h4 data-id="heading-143">1. 核心注意事项</h4>
<ul>
<li>必须指定消息 Key：压缩策略完全依赖 Key 去重，无 Key 消息无法压缩，且会导致存储冗余；</li>
<li>顺序性保障：压缩后 Partition 内消息的 Offset 顺序不变，不影响消费者按顺序消费；</li>
<li>副本同步：压缩仅在 Leader 副本执行，压缩后的新段文件会同步到 Follower 副本，确保所有副本数据一致；</li>
<li>墓碑消息使用：删除 Key 需发送 Value 为 null 的墓碑消息，否则压缩无法彻底删除该 Key 的历史消息。</li>
</ul>
<h4 data-id="heading-144">2. 性能影响（可控，无需过度担心）</h4>
<ul>
<li>写入性能：压缩仅针对非活跃段，不影响活跃段的顺序写入，前台写入性能无损耗；</li>
<li>读取性能：读取压缩后的消息时，需先解压（由消费者或 Broker 解压，取决于 <code>log.compression.type</code> 配置），但 Kafka 会缓存解压后的消息，热点数据读取无明显延迟；</li>
<li>后台开销：压缩线程会占用一定 CPU 和磁盘 IO，可通过 <code>log.cleaner.threads</code> 和 <code>log.cleaner.io.max.bytes.per.second</code> 限制资源占用，避免影响前台业务。</li>
</ul>
<h3 data-id="heading-145">六、常见误区澄清</h3>
<ol>
<li><strong>“日志压缩会丢失消息”</strong> ：错！压缩仅删除同一 Key 的旧版本消息，保留最新版本，业务需要的 “最新状态” 未丢失，不属于 “数据丢失”；</li>
<li><strong>“压缩后消息顺序会乱”</strong> ：错！压缩仅按 Key 去重，不改变消息的 Offset 顺序，Partition 内消息仍保持写入时的顺序；</li>
<li><strong>“无 Key 消息也能压缩”</strong> ：错！压缩基于 Key 去重，无 Key 时无法判断 “是否为同一数据的旧版本”，压缩不会删除任何消息，仅浪费资源；</li>
<li><strong>“压缩会影响写入性能”</strong> ：错！压缩是后台异步执行，且仅处理非活跃段，不干扰当前活跃段的顺序写入，前台写入性能不受影响；</li>
<li><strong>“压缩算法越先进越好”</strong> ：错！压缩比越高的算法（如 GZIP），CPU 开销越大，需根据 “存储紧张程度” 和 “CPU 资源” 平衡选择（生产首选 Snappy/LZ4）。</li>
</ol>
<h3 data-id="heading-146">七、核心总结</h3>
<p>Kafka 日志压缩技术的本质是  <strong>“Key 级去重 + 后台异步压缩 + 顺序性保留”</strong> ，核心价值是为 “变更型数据” 提供 “高效存储 + 最新状态保留” 的解决方案：</p>
<ul>
<li>设计核心：不破坏消息顺序，仅删除同一 Key 的旧版本，兼顾存储效率和数据可用性；</li>
<li>适用场景：用户信息更新、订单状态变更等需要保留最新状态的场景；</li>
<li>配置关键：启用 <code>log.cleanup.policy=compact</code>，选择 Snappy/LZ4 压缩算法，合理设置脏数据比例和压缩线程数；</li>
<li>性能影响：后台异步执行，资源占用可控，不影响前台读写性能。</li>
</ul>
<h2 data-id="heading-147">kafka的负载均衡策略</h2>
<p>Kafka 的负载均衡核心目标是 <strong>将存储、网络、IO 压力均匀分散到集群所有 Broker，避免单点瓶颈</strong>，其设计贯穿 “数据分布、读写路由、动态调整” 全链路，依赖 “Partition 分发 + 副本均衡 + 生产 / 消费端路由” 三层协同，完全去中心化且自动执行。以下从 “核心载体、静态分配、动态均衡、生产 / 消费端策略、优化实践” 五个维度展开：</p>
<h3 data-id="heading-148">一、负载均衡的核心载体：Partition 与副本</h3>
<p>Kafka 负载均衡的本质是  <strong>“Partition 及其副本的均匀分布”</strong> —— 因为 Partition 是数据存储和读写的最小单元，所有压力（存储占用、写入 IO、读取 IO、网络传输）都围绕 Partition 展开：</p>
<ul>
<li>存储压力：每个 Partition 的数据分散在不同 Broker，避免单个 Broker 磁盘占用过高；</li>
<li>写入压力：生产者写入消息时，分散到不同 Partition（对应不同 Broker 的 Leader 副本）；</li>
<li>读取压力：消费者组的消费者实例分散消费不同 Partition，避免单个消费者过载；</li>
<li>副本压力：副本分布在不同 Broker，既保证高可用，又避免单个 Broker 承担所有副本同步压力。</li>
</ul>
<p>👉 关键结论：负载均衡的核心是 “让 Partition 及其副本在集群中均匀分布”，后续所有策略都围绕这一核心展开。</p>
<h3 data-id="heading-149">二、静态负载均衡：Partition 与副本的初始分配（创建 Topic 时）</h3>
<p>当通过 <code>kafka-topics.sh</code> 创建 Topic 时，Kafka 会自动将 Partition 及其副本分配到集群 Broker，默认遵循 “均匀分布、高可用” 原则，核心依赖 <strong>分配策略（Assignor）</strong>  实现。</p>
<h4 data-id="heading-150">1. 核心分配策略（默认 + 常用）</h4>
<p>Kafka 提供多种 Partition 分配策略，可通过 Broker 配置 <code>partition.assignment.strategy</code> 指定（默认同时启用两种），优先级：<code>RangeAssignor</code> &gt; <code>RoundRobinAssignor</code>，生产环境推荐结合场景选择：</p>

































<table><thead><tr><th>分配策略</th><th>核心逻辑</th><th>优势</th><th>劣势</th><th>适用场景</th></tr></thead><tbody><tr><td>RangeAssignor（默认）</td><td>按 Topic 分组，对每个 Topic 的 Partition 按序号排序，Broker 按序号排序，均匀划分 Partition 区间给 Broker</td><td>同一个 Topic 的 Partition 集中在连续 Broker，便于管理</td><td>当 Topic 数量多且 Partition 数不均时，可能导致 Broker 负载失衡</td><td>单 Topic 多 Partition 场景，Broker 数量少</td></tr><tr><td>RoundRobinAssignor</td><td>不区分 Topic，将所有 Topic 的 Partition 按序号排序，Broker 按序号排序，轮询分配给每个 Broker</td><td>跨 Topic 负载更均匀，避免单个 Broker 集中承载某类 Topic 压力</td><td>同一个 Topic 的 Partition 分散在多个 Broker，跨 Broker 消费时网络开销略高</td><td>多 Topic 场景，Broker 数量多</td></tr><tr><td>RackAwareAssignor（机架感知）</td><td>在 RoundRobin/Range 基础上，确保同一个 Partition 的副本分布在不同机架（Rack）</td><td>避免机架故障导致副本全失，提升跨机架负载均衡</td><td>需配置机架信息（<code>broker.rack</code>），集群部署复杂度略高</td><td>生产环境（尤其是跨机架部署的集群）</td></tr></tbody></table>
<h4 data-id="heading-151">2. 分配原则（所有策略共同遵循）</h4>
<p>无论选择哪种分配策略，都会满足以下 3 条核心原则，确保 “均衡 + 高可用”：</p>
<ol>
<li>一个 Partition 的所有副本 <strong>不会分配到同一个 Broker</strong>（避免 Broker 宕机导致副本全失）；</li>
<li>同一个 Topic 的 Partition 尽可能 <strong>均匀分布在所有 Broker</strong>（避免单个 Broker 承载过多该 Topic 的压力）；</li>
<li>副本数 ≤ Broker 数（否则无法满足 “副本分散” 原则，创建 Topic 会失败）。</li>
</ol>
<h4 data-id="heading-152">3. 分配示例（3 Broker + 1 Topic + 3 Partition + 2 副本）</h4>
<p>假设集群有 Broker-0、Broker-1、Broker-2（机架均不同），Topic <code>test</code> 配置 <code>partitions=3</code>、<code>replication.factor=2</code>，采用 <code>RackAwareAssignor</code> 策略：</p>
<ul>
<li>Partition-0：Leader 分配给 Broker-0，Follower 分配给 Broker-1（不同机架）；</li>
<li>Partition-1：Leader 分配给 Broker-1，Follower 分配给 Broker-2（不同机架）；</li>
<li>Partition-2：Leader 分配给 Broker-2，Follower 分配给 Broker-0（不同机架）；</li>
<li>结果：每个 Broker 承载 2 个副本（1 个 Leader + 1 个 Follower），存储、写入压力完全均匀。</li>
</ul>
<h3 data-id="heading-153">三、动态负载均衡：Partition 重分配与 Leader 重平衡</h3>
<p>静态分配仅解决 “初始均衡”，集群运行中（如 Broker 扩容 / 缩容、Broker 故障、Partition 扩容）会出现负载不均，Kafka 通过 “Partition 重分配” 和 “Leader 重平衡” 实现动态均衡。</p>
<h4 data-id="heading-154">1. 场景 1：Broker 扩容 / 缩容后的 Partition 重分配</h4>
<p>当新增 Broker 时，原有 Broker 的 Partition 不会自动迁移到新 Broker，导致新 Broker 闲置、旧 Broker 过载；当 Broker 缩容时，需将该 Broker 的 Partition 迁移到其他 Broker。解决方案是 <strong>手动触发 Partition 重分配</strong>：</p>
<ul>
<li>
<p>核心工具：<code>kafka-reassign-partitions.sh</code>（Kafka 提供的分区重分配工具）；</p>
</li>
<li>
<p>操作步骤：</p>
<ol>
<li>创建 JSON 文件，指定待重分配的 Topic、目标 Broker 列表；</li>
<li>执行工具生成重分配方案（验证方案合理性）；</li>
<li>执行重分配（迁移 Partition 数据，过程中不影响读写，仅短暂性能波动）；</li>
</ol>
</li>
<li>
<p>关键原则：迁移过程中，确保副本仍满足 “不同 Broker / 机架” 原则，避免高可用降级。</p>
</li>
</ul>
<h4 data-id="heading-155">2. 场景 2：Leader 副本集中导致的负载不均</h4>
<p>Kafka 中只有 Leader 副本处理读写请求，Follower 仅同步数据，若某个 Broker 承载过多 Topic 的 Leader 副本，会导致该 Broker 网络、IO 压力激增（“Leader 倾斜”）。解决方案是 <strong>Leader 重平衡</strong>：</p>
<h5 data-id="heading-156">（1）自动 Leader 重平衡（默认启用）</h5>
<ul>
<li>核心配置：<code>auto.leader.rebalance.enable=true</code>（默认 true）；</li>
<li>触发逻辑：Kafka 后台线程定期（默认每 5 分钟）检查 Leader 分布，若发现某个 Broker 的 Leader 数量远超平均水平（差值超过阈值），则触发 “优先副本选举”（Preferred Replica Election）；</li>
<li>优先副本：创建 Partition 时，副本列表中的第一个副本（默认均匀分布在不同 Broker），选举时优先将该副本提升为 Leader，让 Leader 分布回归均衡；</li>
<li>优势：无需人工干预，自动修复 Leader 倾斜；</li>
<li>注意：若业务高峰期频繁触发重平衡，会导致短暂的读写延迟，可关闭自动重平衡，改为低峰期手动执行。</li>
</ul>
<h5 data-id="heading-157">（2）手动 Leader 重平衡（推荐生产使用）</h5>
<ul>
<li>
<p>核心工具：<code>kafka-preferred-replica-election.sh</code>；</p>
</li>
<li>
<p>执行命令（低峰期执行）：</p>
<p>bash</p>
<pre><code class="hljs language-bash" lang="bash">bin/kafka-preferred-replica-election.sh --bootstrap-server broker0:9092,broker1:9092
</code></pre>
</li>
<li>
<p>优势：可控性强，避免高峰期性能波动，适合核心业务集群；</p>
</li>
<li>
<p>频率：根据 Leader 倾斜情况，每周或每月执行一次（通过监控 Broker 的 Leader 数量判断）。</p>
</li>
</ul>
<h4 data-id="heading-158">3. 场景 3：Partition 扩容后的负载均衡</h4>
<p>当 Topic 现有 Partition 无法满足吞吐需求（如写入压力过大），需扩容 Partition（<code>kafka-topics.sh --alter --partitions=N</code>），Kafka 会自动将新增的 Partition 均匀分配到现有 Broker，遵循 “静态分配的原则”，无需额外配置。</p>
<h3 data-id="heading-159">四、生产端负载均衡：消息均匀分发到 Partition</h3>
<p>生产端的负载均衡核心是  <strong>“将消息均匀发送到 Topic 的所有 Partition”</strong> ，避免单个 Partition 成为写入瓶颈，依赖生产者的 “分区选择策略” 实现。</p>
<h4 data-id="heading-160">1. 默认分区策略（生产者内置）</h4>
<p>生产者发送消息时，若未指定 Partition，会按以下策略自动选择：</p>
<ol>
<li><strong>按消息 Key 哈希（默认优先）</strong> ：若消息指定了 <code>Key</code>（如用户 ID、订单 ID），通过 <code>hash(Key) % Partition 数</code> 计算 Partition 编号，确保同一 Key 的消息落入同一 Partition（保证顺序性）；</li>
<li><strong>轮询（无 Key 时）</strong> ：若消息无 Key，生产者按轮询方式将消息分发到所有 Partition，确保均匀分布；</li>
<li><strong>粘性分区（Kafka 2.4+ 新增）</strong> ：在轮询基础上，优先将消息发送到当前连接的 Partition，减少连接切换开销，同时保证均匀性。</li>
</ol>
<h4 data-id="heading-161">2. 自定义分区策略（特殊场景）</h4>
<p>若默认策略不满足需求（如按业务线、区域分发消息），可实现 <code>Partitioner</code> 接口自定义策略，例如：</p>
<ul>
<li>按消息中的 “区域字段” 将消息发送到对应区域的 Partition；</li>
<li>按消息大小分配 Partition（大消息分配到专属 Partition，避免影响小消息吞吐）。</li>
</ul>
<h4 data-id="heading-162">3. 生产端负载均衡优化</h4>
<ul>
<li>确保消息 Key 分布均匀（避免某类 Key 过多导致单个 Partition 过载）；</li>
<li>无 Key 场景依赖轮询策略，无需额外配置；</li>
<li>批量发送（<code>batch.size</code>+<code>linger.ms</code>）：批量发送可提升吞吐，同时让消息分布更均匀。</li>
</ul>
<h3 data-id="heading-163">五、消费端负载均衡：Partition 与消费者的均匀分配</h3>
<p>消费端的负载均衡核心是  <strong>“消费者组（Consumer Group）内的消费者实例均匀分配 Partition”</strong> ，确保每个消费者的处理压力相当，依赖消费者的 “分区分配策略” 实现。</p>
<h4 data-id="heading-164">1. 消费者组的核心规则</h4>
<ul>
<li>一个 Partition 只能被同一个消费者组的 <strong>一个消费者实例</strong> 消费（避免重复消费）；</li>
<li>一个消费者实例可以消费多个 Partition（但需避免过多导致过载）；</li>
<li>负载均衡的目标：让消费者组内的每个消费者分配到的 Partition 数量尽可能均衡。</li>
</ul>
<h4 data-id="heading-165">2. 核心分区分配策略（消费者端配置）</h4>
<p>消费者通过 <code>partition.assignment.strategy</code> 指定分配策略（默认 <code>RangeAssignor</code>），生产环境推荐 <code>StickyAssignor</code>（兼顾均衡性和稳定性）：</p>

































<table><thead><tr><th>分配策略</th><th>核心逻辑</th><th>优势</th><th>劣势</th><th>适用场景</th></tr></thead><tbody><tr><td>RangeAssignor（默认）</td><td>按 Topic 分组，对每个 Topic 的 Partition 排序，消费者排序，均匀划分 Partition 区间</td><td>实现简单，同一个 Topic 的 Partition 集中在同一消费者，便于顺序处理</td><td>消费者数量与 Partition 数不匹配时，可能导致负载不均（如 3 个 Partition 分配给 2 个消费者，一个消费 2 个，一个消费 1 个）</td><td>消费者数量与 Partition 数接近的场景</td></tr><tr><td>RoundRobinAssignor</td><td>不区分 Topic，将所有 Topic 的 Partition 排序，消费者排序，轮询分配</td><td>跨 Topic 负载更均匀，避免单个消费者过载</td><td>同一个 Topic 的 Partition 分散在多个消费者，跨消费者处理时无法保证 Topic 级顺序</td><td>多 Topic 消费场景，消费者数量多</td></tr><tr><td>StickyAssignor（推荐）</td><td>初始分配时按 “粘性” 原则（尽可能让消费者保留之前的 Partition），重平衡时仅迁移最少 Partition</td><td>减少重平衡时的 Partition 迁移开销，避免重复消费，负载均衡性优</td><td>实现复杂，需维护消费者与 Partition 的绑定关系</td><td>核心业务场景，避免重平衡导致的性能波动</td></tr></tbody></table>
<h4 data-id="heading-166">3. 消费端负载均衡优化</h4>
<ul>
<li>消费者组内的消费者实例数量 ≤ Partition 数（否则多余的消费者会闲置）；</li>
<li>优先使用 <code>StickyAssignor</code> 策略，减少重平衡开销；</li>
<li>合理设置 <code>session.timeout.ms</code>（默认 10s）和 <code>heartbeat.interval.ms</code>（默认 3s），避免不必要的重平衡（重平衡会导致短暂消费中断）；</li>
<li>控制 <code>max.poll.records</code>（每次拉取的消息数），避免单个消费者处理过多消息导致超时。</li>
</ul>
<h3 data-id="heading-167">六、生产环境负载均衡优化实践</h3>
<h4 data-id="heading-168">1. 基础配置优化（必调）</h4>



































<table><thead><tr><th>配置参数</th><th>核心作用</th><th>生产建议值</th></tr></thead><tbody><tr><td><code>partition.assignment.strategy</code>（Broker）</td><td>Topic 初始 Partition 分配策略</td><td><code>org.apache.kafka.clients.admin.RackAwareAssignor</code>（机架感知）</td></tr><tr><td><code>auto.leader.rebalance.enable</code></td><td>自动 Leader 重平衡</td><td>false（关闭自动，手动低峰期执行）</td></tr><tr><td><code>partition.assignment.strategy</code>（消费者）</td><td>消费者组 Partition 分配策略</td><td><code>org.apache.kafka.clients.consumer.StickyAssignor</code></td></tr><tr><td><code>num.partitions</code>（Topic 默认）</td><td>新建 Topic 的默认 Partition 数</td><td>12~24（根据集群 Broker 数量调整，如 3 个 Broker 设为 12，每个 Broker 承载 4 个 Partition）</td></tr><tr><td><code>replication.factor</code>（Topic）</td><td>每个 Partition 的副本数</td><td>3（兼顾高可用和负载均衡）</td></tr></tbody></table>
<h4 data-id="heading-169">2. 常见负载不均场景及解决方案</h4>
<h5 data-id="heading-170">（1）场景 1：Broker 磁盘占用不均</h5>
<ul>
<li>
<p>原因：Topic 初始分配不均、部分 Topic 数据量激增；</p>
</li>
<li>
<p>解决方案：</p>
<ol>
<li>手动执行 Partition 重分配（<code>kafka-reassign-partitions.sh</code>），将数据量大的 Partition 迁移到空闲 Broker；</li>
<li>对数据量过大的 Topic 扩容 Partition，分散存储压力。</li>
</ol>
</li>
</ul>
<h5 data-id="heading-171">（2）场景 2：Leader 副本集中在少数 Broker</h5>
<ul>
<li>
<p>原因：Broker 故障恢复后，Leader 未自动切换；</p>
</li>
<li>
<p>解决方案：</p>
<ol>
<li>低峰期执行手动 Leader 重平衡（<code>kafka-preferred-replica-election.sh</code>）；</li>
<li>确保 <code>replication.factor=3</code>，让 Leader 均匀分布。</li>
</ol>
</li>
</ul>
<h5 data-id="heading-172">（3）场景 3：热点 Partition（单个 Partition 写入 / 读取压力过大）</h5>
<ul>
<li>
<p>原因：消息 Key 分布不均（某类 Key 占比过高）；</p>
</li>
<li>
<p>解决方案：</p>
<ol>
<li>优化消息 Key 设计（如增加随机后缀，让 Key 分布更均匀）；</li>
<li>拆分热点 Topic（将热点 Key 拆分到多个 Topic）；</li>
<li>扩容 Partition 数，分散热点压力。</li>
</ol>
</li>
</ul>
<h5 data-id="heading-173">（4）场景 4：消费者处理速度不均</h5>
<ul>
<li>
<p>原因：消费者实例数量与 Partition 数不匹配，或分配策略不当；</p>
</li>
<li>
<p>解决方案：</p>
<ol>
<li>调整消费者实例数量（接近 Partition 数）；</li>
<li>切换为 <code>StickyAssignor</code> 策略；</li>
<li>优化消费端代码（如异步处理、批量处理），提升单个消费者的处理能力。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-174">3. 监控指标（及时发现负载不均）</h4>
<p>通过监控以下指标，判断是否存在负载均衡问题：</p>
<ul>
<li>Broker 层面：每个 Broker 的 Partition 数、Leader 数、磁盘使用率、网络 IO 速率、CPU / 内存使用率；</li>
<li>Partition 层面：每个 Partition 的写入速率、读取速率、消息堆积量；</li>
<li>消费者层面：每个消费者实例分配的 Partition 数、消息处理速率、堆积量。</li>
</ul>
<h3 data-id="heading-175">七、核心总结</h3>
<p>Kafka 负载均衡是  <strong>“多层协同的自动机制”</strong> ，核心逻辑可概括为：</p>
<ol>
<li><strong>底层基础</strong>：Partition 与副本的均匀分布（静态分配 + 动态重分配），分散存储和同步压力；</li>
<li><strong>生产端</strong>：按 Key 哈希 / 轮询策略，将消息均匀分发到 Partition，避免写入热点；</li>
<li><strong>消费端</strong>：消费者组内按 Sticky/Range/RoundRobin 策略，均匀分配 Partition，避免消费过载；</li>
<li><strong>动态调整</strong>：通过 Leader 重平衡、Partition 重分配，应对集群变化（扩容 / 缩容、故障），维持均衡。</li>
</ol>
<p>生产环境优化的核心是：<strong>合理设置 Partition 数和副本数、选择合适的分配策略、低峰期执行动态调整、监控热点问题</strong>，无需过度人工干预，依赖 Kafka 内置机制即可实现高效负载均衡。</p>
<h2 data-id="heading-176">kafka导致消息丢失原因及解决方案</h2>
<p>Kafka作为分布式消息系统，在消息可靠性方面存在多个可能导致消息丢失的环节，主要有以下三个方面会存在丢失数据的可能性，分别是生产者、消费者以及kafka节点broker三个方面。</p>
<h3 data-id="heading-177">生产者端丢失消息原因及解决方案</h3>
<h4 data-id="heading-178">生产者丢失消息原因</h4>
<p>生产者端消息丢失主要发生在以下几个场景：</p>
<ul>
<li><strong>确认机制配置：</strong> ack=0(不等待确认）或者ack=1（仅Leader确认）</li>
<li><strong>重试机制失败：</strong> 网络抖动时重试次数不足（默认retries=0）</li>
<li><strong>异步发送未处理的异常：</strong> 生产者使用异步发送时，若消息发送失败（如网络波动，Broker节点宕机）且未设置回调处理异常，会导致消息丢失</li>
<li><strong>消息体太大：</strong> 发送的消息体大小超过Broker设置的message.max.bytes的值，Broker节点会直接返回错误消息导致消息丢失</li>
</ul>
<h4 data-id="heading-179">生产者丢失消息的解决方案</h4>
<ol>
<li>发送时，处理发送后的回调异常数据</li>
</ol>
<p>使用同步发送（<code>send().get()</code>）或异步发送时添加回调，捕获 <code>Exception</code> 并重试（如网络错误）</p>
<pre><code class="hljs language-java" lang="java">producer.send(record, (metadata, exception) -&gt; {
  <span class="hljs-keyword">if</span> (exception != <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 处理异常（如重试、记录日志）</span>
    exception.printStackTrace();
  }
});
</code></pre>
<ol start="2">
<li>合理设置ack的参数</li>
</ol>
<ul>
<li>针对可靠性要求高的业务场景，设置ack = 1(或者ack=all)，确保Leader和所有的follower都确认接收</li>
<li>配合min.insync.replicas（Broker参数），设置最小同步副本数，避免单节点故障导致数据丢失</li>
</ul>
<ol start="3">
<li>调整缓冲区配置大小</li>
</ol>
<ul>
<li>增大buffer.memory，避免缓冲区满</li>
<li>合理设置retires参数（重试次数3）和设置retry.backoff.ms(重试时间间隔）失败时自动重试</li>
<li>确保max.block.ms(默认60s)时间足够长，避免缓冲区满时立即抛出异常</li>
<li>合理设置message.max.bytes的值，避免生产环境中存在消息体过大的情况</li>
</ul>
<h3 data-id="heading-180">Broker端丢失消息原因及解决方案</h3>
<h4 data-id="heading-181">Broker端丢失消息原因</h4>
<ul>
<li><strong>脏选举情形：</strong> <code>unclean.leader.election.enable=true</code>（非同步副本成为Leader）如果Leader宕机了，此时ISR机制里的follower节点还没有同步完消息就被选举为新的Leader，会导致数据丢失</li>
<li><strong>刷盘策略设置不合理：</strong> kafka默认设置异步刷盘策略，依赖于操作系统的页缓存机制异步刷盘（log.flush.interval.messages:记录多少条消息即刷盘）和（log.flush.interval.ms：间隔多长时间即刷盘），此时如果Broker宕机了，页缓存中未刷盘的消息会丢失</li>
<li><strong>副本数量设置不足：</strong> 如果设置了replication.factor=1（默认1），则Leader宕机后ISR没有副本可供选举，消息直接丢失</li>
</ul>
<h4 data-id="heading-182">Broker端丢失消息的解决方案</h4>
<ul>
<li><strong>限制Leader的选举范围：</strong> 设置unclean.leader.election.enable=false,仅允许ISR中的副本成本Leader，确保Leader包含最新的消息</li>
<li><strong>合理设置副本数量及消息响应：</strong> 结合min.insync.replica 和ack=all,当同步的副本不足时，生产者端直接响应写入失败。</li>
<li><strong>平衡刷盘的性能和可靠性：</strong> 合理设置（log.flush.interval.messages:记录多少条消息即刷盘），（log.flush.interval.ms：间隔多长时间即刷盘）和（mins.insync.replica:设置同步的副本数量），通过多副本保障 —— 即使Leader和 Broker 宕机，其他副本的页缓存 / 磁盘数据仍可用。</li>
</ul>
<h3 data-id="heading-183">消费者端丢失消息原因及解决方案</h3>
<h4 data-id="heading-184">消费端丢失消息原因</h4>
<ul>
<li><strong>提前提交offset：</strong> 如果设置了自动提交（enable.auto.commit=true）时，若auto.commit.interval.ms设置过小，消费者可能在消息消费前自动提交offset，如果处理的时候崩溃，则未被处理的数据会丢失。</li>
<li><strong>消费异常未处理：</strong> 消息处理失败（如业务逻辑抛异常），但未捕获异常，导致 Offset 仍被提交，消息被标记为已消费。</li>
</ul>
<h4 data-id="heading-185">消费端丢失消息的解决方案</h4>
<ul>
<li><strong>关闭自动提交：</strong> 关闭自动提交：<code>enable.auto.commit=false</code>。在消息<strong>完全处理成功后</strong>手动提交（同步 <code>commitSync()</code> 确保提交成功，或异步 <code>commitAsync()</code> 配合回调）。</li>
<li><strong>消费失败的消息特殊处理：</strong> 消费失败的消息可写入死信队列（DLQ），避免阻塞正常消费，同时便于后续排查和重试。</li>
</ul>
<h3 data-id="heading-186">kafka消息丢失的其他场景</h3>
<ol>
<li>
<p><strong>Topic 留存策略过严</strong></p>
<ul>
<li>原因：<code>retention.ms</code>（消息留存时间，默认 7 天）或 <code>retention.bytes</code>（留存大小）设置过小，消息被提前清理（未被消费即删除）。</li>
<li>解决：根据消费速度调整留存策略，确保消息在被消费前不被删除（如 <code>retention.ms=604800000</code> 即 7 天）。</li>
</ul>
</li>
<li>
<p><strong>Broker 磁盘故障</strong></p>
<ul>
<li>原因：单 Broker 磁盘损坏，且消息未同步到其他副本。</li>
<li>解决：使用 RAID 磁盘阵列（如 RAID10）避免单点存储故障，结合 <code>replication.factor≥2</code> 确保数据多副本存储。</li>
</ul>
</li>
<li>
<p><strong>网络分区（脑裂）</strong></p>
<ul>
<li>原因：集群网络分裂导致部分 Broker 失联，副本同步中断，可能引发数据不一致。</li>
<li>解决：合理配置 <code>session.timeout.ms</code>（如 10000ms）和 <code>heartbeat.interval.ms</code>（如 3000ms），确保集群快速检测并恢复一致性。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-187">总结</h3>
<p>kafka可以通过一系列的机制来保证从生产者-》Broker端-》消费者这几个方面来保证消息不会丢失，首先是从生产者，设置确认响应消息机制（ack=0: 不推荐，ack=1: 写入Leader节点即返回，ack=all：写入Leader节点和所有的follower节点才返回，会降低吞吐量和性能），同时在生产端推送消息的异常需特殊处理，避免推送 过大的请求消息体将Broker端的消息缓冲区占满。</p>
<p>其次是Broker端，需要平衡性能和刷盘的机制，需合理设置（<code>log.flush.interval.messages:记录多少条消息即刷盘）</code>，<code>（log.flush.interval.ms：间隔多长时间即刷盘</code>）和（<code>mins.insync.replica:设置同步的副本数量</code>），避免出现脏选举（Leader数据未同步Broker即宕机）和无副本选举的情况。</p>
<p>最后是消费端，需合理设置消息自动提交，如果消息仍然在消费，但是消息的offset已经提交到kafka，且消息被消费失败会导致消息永久丢失，建议手动关闭自动提交offset，同时消费端消费失败的消息需提交至死信队列，以便后续的排查分析。</p>
<h2 data-id="heading-188">kafka的高可用机制详解</h2>
<p>其实kafka的高可用机制的原理与消息不丢失的原理基本一致，kafka的高可用核心目标是<strong>避免单点故障、保证数据不丢失、服务持续可用</strong>，其设计基于 <strong>“分区副本 + Leader 选举 + 集群协调”</strong> 三大核心逻辑。下面从基础架构、核心机制、故障恢复、配置优化这四个维度来说明一下kafka的高可用机制。</p>
<h3 data-id="heading-189">kafka的核心基础架构</h3>
<ol>
<li>
<p><strong>核心组件</strong>：</p>
<ul>
<li><strong>Broker</strong>：Kafka 服务器节点，集群由多个 Broker 组成（无主从区分，天然去中心化）；</li>
<li><strong>Topic</strong>：消息主题，用于分类数据，是逻辑概念；</li>
<li><strong>Partition</strong>：分区，Topic 的物理拆分（1 个 Topic 可包含多个 Partition），数据按 Partition 分布式存储在不同 Broker，是并行读写和高可用的核心载体；</li>
<li><strong>Replica</strong>：副本，每个 Partition 可配置多个副本（<code>replication.factor</code> 指定，默认 1，生产建议 ≥3），副本分为「Leader 副本」和「Follower 副本」，副本分布在不同 Broker（避免单点故障）。</li>
</ul>
</li>
<li>
<p><strong>核心前提</strong>：</p>
<ul>
<li>数据的高可用本质是「Partition 副本的高可用」：只要一个 Partition 的至少一个副本存活，该 Partition 就能提供服务；</li>
<li>集群无单点：Broker、Partition 副本、协调组件（Controller）均有冗余设计。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-190">kafka的高可用核心机制</h3>
<h4 data-id="heading-191">1. 分区副本机制（数据冗余）</h4>
<p>这个是高可用的基础，核心是“将partition的副本分散在不同的Broker中”，由kafka自动分配（<code>replica.assignment.strategy</code> 调整分配策略）</p>
<ul>
<li>一个 Partition 的所有副本不会落在同一个 Broker（避免 Broker 宕机导致副本全失）；</li>
<li>尽量将副本均匀分布在集群的不同机架（Rack）（避免机架故障，可选配置 <code>rack.aware.assignment.enable=true</code>）</li>
</ul>
<p>副本角色分工（严格职责分离，保证效率）：</p>




















<table><thead><tr><th>角色</th><th>核心职责</th><th>读写权限</th></tr></thead><tbody><tr><td>Leader 副本</td><td>处理所有生产者写入、消费者读取请求</td><td>可读可写</td></tr><tr><td>Follower 副本</td><td>实时从 Leader 同步消息（拉取模式），保持数据一致</td><td>只读（仅同步）</td></tr></tbody></table>
<p><strong>关键逻辑</strong>：生产者 / 消费者仅与 Leader 交互，Follower 不处理业务请求，仅负责数据同步，避免多副本并发读写的一致性问题，同时提升读写性能。</p>
<h4 data-id="heading-192">2. Leader 选举机制（故障恢复核心）</h4>
<ul>
<li>
<p><strong>目标：</strong> ‌ Leader 副本故障时（Broker 宕机），快速从 Partition 的 Follower 中选出新 Leader，确保服务不中断。</p>
</li>
<li>
<p><strong>核心依赖：</strong> ‌</p>
<ul>
<li>
<p>‌<strong>ISR（In-Sync Replicas）：</strong> ‌ 与 Leader 数据同步状态合格的副本集合（包含 Leader 自身）。判断标准：</p>
<ul>
<li>与 Leader 网络连通（未断连超过 <code>replica.lag.time.max.ms</code>，默认 10s）。</li>
<li>消息滞后量极小（<code>replica.lag.max.messages</code> 默认-1，仅用时间判断）。</li>
</ul>
</li>
<li>
<p>‌<strong>Controller：</strong> ‌ 集群中一个被选举出的 Broker，负责协调所有 Leader 选举。</p>
</li>
</ul>
</li>
<li>
<p>‌<strong>选举触发：</strong> ‌ Leader 所在 Broker 宕机（心跳超时检测）、网络分区恢复（可选）、手动触发。</p>
</li>
<li>
<p>‌<strong>选举流程（由 Controller 主导）：</strong> ‌</p>
<ol>
<li>Controller 检测到 Leader 失效。</li>
<li>‌<strong>优先从 ISR 中</strong>‌ 按照“优先副本”（创建时的首个副本）原则选举新 Leader，保证新 Leader 数据与原 Leader 一致。</li>
<li>‌<strong>极端情况 (ISR 为空)：</strong> ‌ 由 <code>unclean.leader.election.enable</code> 控制（默认 <code>false</code>，禁止选举非 ISR 副本，避免数据丢失；设为 <code>true</code> 可能导致数据不一致但能恢复服务）。</li>
<li>Controller 将新 Leader 信息同步至全集群，客户端自动切换。</li>
</ol>
</li>
<li>
<p>‌<strong>特点：</strong> ‌ 快速（Controller 集中协调，&lt;100ms）、数据一致（优先 ISR）。</p>
</li>
</ul>
<h4 data-id="heading-193">3. 数据一致性保障（避免丢失） ‌</h4>
<ul>
<li>
<p>‌<strong>生产者确认机制（ACKs）：</strong> ‌ 控制生产者何时认为消息发送成功，平衡可靠性和性能：</p>
<ul>
<li><strong><code>acks=0</code>:</strong> 不等待确认。‌<strong>可靠性最低</strong>‌（可能丢失），性能最高。适用非关键日志。</li>
<li><strong><code>acks=1</code>:</strong> ‌ Leader 写入即确认。‌<strong>中等可靠性</strong>‌（Leader 故障后未复制的消息可能丢失），中等性能。适用一般业务。</li>
<li><strong><code>acks=all/-1</code>:</strong> ‌ 需 ISR 中 <code>min.insync.replicas</code> 个副本同步完成才确认。‌<strong>最高可靠性</strong>‌（无丢失），性能最低。适用核心业务（如金融）。</li>
</ul>
</li>
<li>
<p><strong>关键配合：</strong> ‌ <code>acks=all</code> 必须搭配 <code>min.insync.replicas</code> (e.g., 副本数=3, min.insync=2)。确保即使一个副本故障，写入仍能成功，避免单点故障导致阻塞。</p>
</li>
<li>
<p><strong>副本同步基础：</strong> ‌ Follower 主动从 Leader ‌<strong>拉取</strong>‌（Pull）消息进行同步，保证数据最终一致。</p>
</li>
</ul>
<h4 data-id="heading-194">3、Controller高可用（集群协调无单点）</h4>
<ul>
<li>
<p><strong>Controller选举</strong>： 集群启动时，所有的Broker节点向zookeeper竞争创建临时节点 /controller，创建成功的Broker成为Controller</p>
</li>
<li>
<p><strong>故障转移</strong>： 若原Controller宕机，zookeeper会删除临时节点，其他的Broker检测到后竞争创建/Controller，快速选举Controller</p>
</li>
<li>
<p><strong>核心职责</strong>：除了 Leader 选举，还负责：</p>
<ol>
<li>监控 Broker 上下线，更新集群元数据；</li>
<li>处理 Partition 扩容、副本重分配等操作；</li>
<li>将集群元数据（Leader 分布、ISR 列表等）同步到所有 Broker。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-195">总结</h3>
<p>Kafka 高可用的核心逻辑是「<strong>分区副本冗余 + Leader 选举 + 数据同步确认</strong>」：</p>
<ol>
<li>分区副本分散在不同的Broker中，避免单点故障</li>
<li>Leader-follower分工明确，保证读写效率，follower同步数据提供冗余</li>
<li>Controller协调Leader选举，实现故障自动转移（毫秒级恢复）</li>
<li>生产者ack机制+ISR机制同步+高水位、保证数据不丢失、不重复。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>